<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêΩ ü§ï üìÜ Trabajando con recursos externos en Unity3D ‚úùÔ∏è üë©üèø‚Äçüé§ üë©üèº‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduccion 
 Hola queridos lectores, hoy hablaremos sobre trabajar con recursos externos en el entorno Unity 3d. 

 Por tradici√≥n, para comenzar, de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Trabajando con recursos externos en Unity3D</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/433366/"><h2>  Introduccion </h2><br>  Hola queridos lectores, hoy hablaremos sobre trabajar con recursos externos en el entorno Unity 3d. <br><br>  Por tradici√≥n, para comenzar, determinaremos qu√© es y por qu√© lo necesitamos.  Entonces, ¬øqu√© son exactamente estos recursos externos?  Como parte del desarrollo del juego, dichos recursos pueden ser todo lo que se requiere para que la aplicaci√≥n funcione y no deben almacenarse en la compilaci√≥n final del proyecto.  Los recursos externos se pueden ubicar tanto en el disco duro de la computadora del usuario como en un servidor web externo.  En el caso general, dichos recursos son cualquier archivo o conjunto de datos que cargamos en nuestra aplicaci√≥n que ya se est√° ejecutando.  Hablando en el marco de Unity 3d, pueden ser: <br><br><ul><li>  Archivo de texto </li><li>  Archivo de textura </li><li>  Archivo de audio </li><li>  Conjunto de bytes </li><li>  AssetBundle (archivo con activos del proyecto Unity 3d) </li></ul><br>  A continuaci√≥n, examinaremos con m√°s detalle los mecanismos integrados para trabajar con estos recursos que est√°n presentes en Unity 3d, y tambi√©n escribiremos administradores simples para interactuar con el servidor web y cargar recursos en la aplicaci√≥n. <br><br>  <b>Nota</b> : el <i>resto de este art√≠culo usa c√≥digo usando C # 7+ y est√° dise√±ado para el compilador Roslyn usado en Unity3d en las versiones 2018.3+.</i> <br><a name="habracut"></a><br><h2>  Caracter√≠sticas de la Unidad 3d </h2><br>  Antes de Unity 2017, se usaba un mecanismo (excluido el autodescrito) para trabajar con datos del servidor y recursos externos, que se inclu√≠a en el motor: esta es la clase WWW.  Esta clase permiti√≥ el uso de varios comandos http (get, post, put, etc.) en forma s√≠ncrona o as√≠ncrona (a trav√©s de Coroutine).  Trabajar con esta clase fue bastante simple y directo. <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadFromServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> www = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WWW(url); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> www; Debug.Log(www.text); }</code> </pre> <br>  Del mismo modo, puede obtener no solo datos de texto, sino tambi√©n otros: <br><br><ul><li>  Byte Array - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.bytes</a> </li><li>  Textura - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.texture</a> </li><li>  Audio - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.GetAudioClip</a> () </li><li>  Activo - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">www.assetBundle</a> </li></ul><br>  Sin embargo, a partir de la versi√≥n 2017, Unity tiene un nuevo sistema de servidor introducido por la clase <b>UnityWebRequest</b> , que se encuentra en el espacio de nombres de Redes.  Hasta Unity 2018, exist√≠a junto con <b>WWW</b> , pero en la √∫ltima versi√≥n del motor <b>WWW</b> no se recomendaba, y en el futuro se eliminar√° por completo.  Por lo tanto, adem√°s nos centraremos solo en <b>UnityWebRequest</b> (en adelante, UWR). <br><br>  Trabajar con UWR en su conjunto es similar a WWW en su n√∫cleo, pero hay diferencias, que se discutir√°n m√°s adelante.  A continuaci√≥n se muestra un ejemplo similar de carga de texto. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadFromServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityWebRequest(url); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.SendWebRequest(); Debug.Log(request.downloadHandler.text); request.Dispose(); }</code> </pre><br>  Los principales cambios que ha introducido el nuevo sistema UWR (adem√°s de los cambios en el principio de trabajar en el interior) son la capacidad de asignar controladores para cargar y descargar datos desde el servidor mismo, se pueden encontrar m√°s detalles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> .  Por defecto, estas son las clases <b>UploadHandler</b> y <b>DownloadHandler</b> .  La unidad misma proporciona un conjunto de extensiones de estas clases para trabajar con varios datos, como audio, texturas, activos, etc.  Consideremos trabajar con ellos con m√°s detalle. <br><br><h2>  Trabajar con recursos </h2><br><h3>  Texto </h3><br>  Trabajar con texto es una de las opciones m√°s f√°ciles.  El m√©todo para descargarlo ya se ha descrito anteriormente.  Lo reescribimos un poco con el uso de la creaci√≥n de una solicitud http Get directa. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadTextFromServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequest.Get(url); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.SendWebRequest(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!request.isHttpError &amp;&amp; !request.isNetworkError) { response(uwr.downloadHandler.text); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.LogErrorFormat(<span class="hljs-string"><span class="hljs-string">"error request [{0}, {1}]"</span></span>, url, request.error); response(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } request.Dispose(); }</code> </pre><br>  Como puede ver en el c√≥digo, aqu√≠ se usa el <b>DownloadHandler</b> predeterminado.  La propiedad de texto es un captador que convierte una matriz de bytes en texto codificado UTF8.  El uso principal de cargar texto desde el servidor es recibir un archivo json (representaci√≥n serializada de los datos en forma de texto).  Puede obtener estos datos utilizando la clase Unity <b>JsonUtility</b> . <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = JsonUtility.FromJson&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-comment"><span class="hljs-comment">// T  ,    .</span></span></code> </pre><br><h3>  Audio </h3><br>  Para trabajar con audio, debe usar el m√©todo especial de creaci√≥n de la solicitud <b>UnityWebRequestMultimedia.GetAudioClip</b> , y para obtener la representaci√≥n de datos en la forma necesaria para trabajar en Unity, debe usar <b>DownloadHandlerAudioClip</b> .  Adem√°s, al crear una solicitud, debe especificar el tipo de datos de audio representados por la enumeraci√≥n <b>AudioType</b> , que establece el formato (wav, aiff, oggvorbis, etc.). <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadAudioFromServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, AudioType audioType, Action&lt;AudioClip&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequestMultimedia.GetAudioClip(url, audioType); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.SendWebRequest(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!request.isHttpError &amp;&amp; !request.isNetworkError) { response(DownloadHandlerAudioClip.GetContent(request)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.LogErrorFormat(<span class="hljs-string"><span class="hljs-string">"error request [{0}, {1}]"</span></span>, url, request.error); response(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } request.Dispose(); }</code> </pre><br><h3>  Textura </h3><br>  La descarga de texturas es similar a la de los archivos de audio.  La solicitud se crea utilizando <b>UnityWebRequestTexture.GetTexture</b> .  Para obtener datos en la forma necesaria para Unity, <b>se</b> utiliza <b>DownloadHandlerTexture</b> . <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadTextureFromServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;Texture2D&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequestTexture.GetTexture(url); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.SendWebRequest(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!request.isHttpError &amp;&amp; !request.isNetworkError) { response(DownloadHandlerTexture.GetContent(request)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.LogErrorFormat(<span class="hljs-string"><span class="hljs-string">"error request [{0}, {1}]"</span></span>, url, request.error); response(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } request.Dispose(); }</code> </pre><br><h3>  Paquete de activos </h3><br>  Como se mencion√≥ anteriormente, el paquete es, de hecho, un archivo con recursos de Unity que se puede usar en un juego que ya se est√° ejecutando.  Estos recursos pueden ser cualquier activo del proyecto, incluidas las escenas.  La excepci√≥n son los scripts de C #; no se pueden pasar.  Para cargar <b>AssetBundle</b> , se utiliza una consulta que se crea utilizando <b>UnityWebRequestAssetBundle.GetAssetBundle.</b>  <b>DownloadHandlerAssetBundle se</b> utiliza para obtener datos en la forma necesaria para Unity. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadBundleFromServer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;AssetBundle&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequestAssetBundle.GetAssetBundle(url); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.SendWebRequest(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!request.isHttpError &amp;&amp; !request.isNetworkError) { response(DownloadHandlerAssetBundle.GetContent(request)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.LogErrorFormat(<span class="hljs-string"><span class="hljs-string">"error request [{0}, {1}]"</span></span>, url, request.error); response(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } request.Dispose(); }</code> </pre><br><h2>  Los principales problemas y soluciones al trabajar con un servidor web y datos externos </h2><br>  Los m√©todos simples de interacci√≥n entre una aplicaci√≥n y un servidor en t√©rminos de carga de varios recursos se han descrito anteriormente.  Sin embargo, en la pr√°ctica, las cosas son mucho m√°s complicadas.  Considere los principales problemas que acompa√±an a los desarrolladores y analice las formas de resolverlos. <br><br><h3>  No hay suficiente espacio libre </h3><br>  Uno de los primeros problemas al descargar datos del servidor es una posible falta de espacio libre en el dispositivo.  A menudo sucede que el usuario usa dispositivos antiguos para juegos (especialmente en Android), as√≠ como el tama√±o de los archivos descargados puede ser bastante grande (hola PC).  En cualquier caso, esta situaci√≥n debe procesarse correctamente y el jugador debe ser informado de antemano de que no hay suficiente espacio y cu√°nto.  Como hacerlo  Lo primero que debe saber es el tama√±o del archivo descargado, esto se hace mediante la solicitud <b>UnityWebRequest.Head ()</b> .  A continuaci√≥n se muestra el c√≥digo para obtener el tama√±o. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetConntentLength</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequest.Head(url); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.SendWebRequest(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!request.isHttpError &amp;&amp; !request.isNetworkError) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contentLength = request.GetResponseHeader(<span class="hljs-string"><span class="hljs-string">"Content-Length"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.TryParse(contentLength, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> returnValue)) { response(returnValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.LogErrorFormat(<span class="hljs-string"><span class="hljs-string">"error request [{0}, {1}]"</span></span>, url, request.error); response(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } }</code> </pre><br>  Es importante tener en cuenta una cosa aqu√≠, para que la solicitud funcione correctamente, el servidor debe poder devolver el tama√±o del contenido, de lo contrario (de hecho, para mostrar el progreso), se devolver√° el valor incorrecto. <br><br>  Despu√©s de obtener el tama√±o de los datos descargados, podemos compararlo con el tama√±o del espacio libre en disco.  Para obtener este √∫ltimo, utilizo el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">complemento gratuito de Asset Store</a> . <br><br>  <b>Nota</b> : <i>puede usar la clase <b>Cache</b> en Unity3d, puede mostrar espacio de cach√© libre y usado.</i>  <i>Sin embargo, vale la pena considerar el punto de que estos datos son relativos.</i>  <i>Se calculan en funci√≥n del tama√±o de la memoria cach√©, de forma predeterminada es de 4 GB.</i>  <i>Si el usuario tiene m√°s espacio libre que el tama√±o del cach√©, entonces no habr√° problemas, sin embargo, si esto no es as√≠, los valores pueden tomar valores incorrectos en relaci√≥n con el estado real de las cosas.</i> <br><br><h3>  Comprobaci√≥n de acceso a internet </h3><br>  Muy a menudo, antes de descargar cualquier cosa del servidor, es necesario manejar la situaci√≥n de falta de acceso a Internet.  Hay varias formas de hacer esto: desde hacer ping a una direcci√≥n, a una solicitud GET a google.ru.  Sin embargo, en mi opini√≥n, el resultado m√°s correcto y r√°pido y estable es descargar desde su propio servidor (el mismo desde donde se descargar√°n los archivos) un archivo peque√±o.  C√≥mo hacerlo se describe arriba en la secci√≥n sobre c√≥mo trabajar con texto. <br>  Adem√°s de comprobar el hecho de tener acceso a Internet, tambi√©n es necesario determinar su tipo (m√≥vil o WiFi), porque es poco probable que un jugador quiera descargar varios cientos de megabytes en el tr√°fico m√≥vil.  Esto se puede hacer a trav√©s de la propiedad <b>Application.internetReachability</b> . <br><br><h3>  Almacenamiento en cach√© </h3><br>  El siguiente, y uno de los problemas m√°s importantes, es el almacenamiento en cach√© de los archivos descargados.  ¬øPara qu√© es este almacenamiento en cach√©? <br><br><ol><li>  Ahorre tr√°fico (no descargue datos ya descargados) </li><li>  Asegurar el trabajo en ausencia de Internet (puede mostrar datos de la memoria cach√©). </li></ol><br>  ¬øQu√© necesita ser almacenado en cach√©?  La respuesta a esta pregunta es todo, todos los archivos que descargues deben estar en cach√©.  C√≥mo hacer esto, considere a continuaci√≥n y comience con archivos de texto simples. <br>  Desafortunadamente, Unity no tiene un mecanismo incorporado para almacenar texto en cach√©, as√≠ como texturas y archivos de audio.  Por lo tanto, para estos recursos, debe escribir su sistema, o no escribir, dependiendo de las necesidades del proyecto.  En el caso m√°s simple, simplemente escribimos el archivo en el cach√© y, en ausencia de Internet, tomamos el archivo de √©l.  En una versi√≥n un poco m√°s compleja (la uso en proyectos), enviamos una solicitud al servidor, que devuelve json indicando las versiones de los archivos que est√°n almacenados en el servidor.  Puede escribir y leer archivos de la memoria cach√© utilizando la clase C # de la clase <b>File</b> o de cualquier otra manera conveniente y aceptada por su equipo. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CacheText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cacheFilePath = Path.Combine(<span class="hljs-string"><span class="hljs-string">"CachePath"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}.text"</span></span>.Fmt(fileName)); File.WriteAllText(cacheFilePath, data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CacheTexture</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cacheFilePath = Path.Combine(<span class="hljs-string"><span class="hljs-string">"CachePath"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}.texture"</span></span>.Fmt(fileName)); File.WriteAllBytes(cacheFilePath, data); }</code> </pre><br>  Del mismo modo, obtener datos del cach√©. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTextFromCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cacheFilePath = Path.Combine(Utils.Path.Cache, <span class="hljs-string"><span class="hljs-string">"{0}.text"</span></span>.Fmt(fileName)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(cacheFilePath)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> File.ReadAllText(cacheFilePath); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Texture2D </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetTextureFromCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fileName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cacheFilePath = Path.Combine(Utils.Path.Cache, <span class="hljs-string"><span class="hljs-string">"{0}.texture"</span></span>.Fmt(fileName)); Texture2D texture = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(cacheFilePath)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = File.ReadAllBytes(cacheFilePath); texture = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Texture2D(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); texture.LoadImage(data, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> texture; }</code> </pre><br>  <b>Nota</b> : <i>por qu√© el mismo UWR con una URL del archivo de formulario: // no se usa para cargar texturas.</i>  <i>Por el momento, hay problemas con esto, el archivo simplemente no se carga, as√≠ que tuve que encontrar una soluci√≥n.</i> <br><br>  <b>Nota</b> : <i>No uso la carga directa de AudioClip en proyectos, almaceno todos esos datos en AssetBundle.</i>  <i>Sin embargo, si es necesario, esto se puede hacer f√°cilmente utilizando las funciones de las clases GetData y SetData de AudioClip.</i> <i><br></i> <br>  Los recursos simples de Unity para <b>AssetBundle</b> , Unity tienen un mecanismo de almacenamiento en cach√© incorporado.  Consideremos con m√°s detalle. <br><br>  B√°sicamente, este mecanismo puede usar dos enfoques: <br><br><ol><li>  Usando CRC y n√∫mero de versi√≥n </li><li>  Usar valores hash </li></ol><br>  En principio, puede usar cualquiera de ellos, pero decid√≠ por m√≠ mismo que Hash es el m√°s aceptable, ya que tengo mi propio sistema de versi√≥n y tiene en cuenta no solo la versi√≥n de <b>AssetBundle</b> , sino tambi√©n la versi√≥n de la aplicaci√≥n, ya que a menudo el paquete puede no ser compatible con la versi√≥n, presentado en tiendas. <br><br>  Entonces, ¬øc√≥mo se hace el almacenamiento en cach√©? <br><br><ol><li>  Solicitamos un archivo de paquete del servidor de manifiesto (este archivo se crea autom√°ticamente cuando se crea y contiene una descripci√≥n de los activos que contiene, as√≠ como hash, crc, tama√±o, etc.).  El archivo tiene el mismo nombre que el paquete m√°s la extensi√≥n .manifest. </li><li>  Obtenga el valor hash128 del manifiesto </li><li>  Creamos una solicitud al servidor para obtener un AssetBundle, donde adem√°s de la url, especifique el valor hash128 recibido </li></ol><br><div class="spoiler">  <b class="spoiler_title">C√≥digo para el algoritmo descrito anteriormente:</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-function">IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadAssetBundleFromServerWithCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;AssetBundle&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    while (!Caching.ready) { yield return null; } //     var request = UnityWebRequest.Get(url + ".manifest"); yield return request.SendWebRequest(); if (!request.isHttpError &amp;&amp; !request.isNetworkError) { Hash128 hash = default; // hash var hashRow = request.downloadHandler.text.ToString().Split("\n".ToCharArray())[5]; hash = Hash128.Parse(hashRow.Split(':')[1].Trim()); if (hash.isValid == true) { request.Dispose(); request = UnityWebRequestAssetBundle.GetAssetBundle(url, hash, 0); yield return request.SendWebRequest(); if (!request.isHttpError &amp;&amp; !request.isNetworkError) { response(DownloadHandlerAssetBundle.GetContent(request)); } else { response(null); } } else { response(null); } } else { response(null); } request.Dispose(); }</span></span></code> </pre><br></div></div><br>  En el ejemplo anterior, Unity, cuando consulta el servidor, primero mira para ver si hay un archivo en la cach√© con el valor hash128 especificado, de ser as√≠, se devolver√°; de lo contrario, se descargar√° el archivo actualizado.  Para administrar todos los archivos de cach√© en Unity, hay una clase de <b>almacenamiento</b> en <b>cach√©</b> , con la que podemos averiguar si hay un archivo en el cach√©, obtener todas las versiones almacenadas en cach√©, as√≠ como eliminar las innecesarias o borrarlas por completo. <br><br>  <b>Nota</b> : <i>¬øpor qu√© una forma tan extra√±a de obtener valores hash?</i>  <i>Esto se debe al hecho de que obtener hash128 de la manera descrita en la documentaci√≥n requiere cargar todo el paquete y luego recibir el activo <b>AssetBundleManifest</b> de √©l y desde all√≠ valores hash.</i>  <i>La desventaja de este enfoque es que todo el AssetBundle est√° oscilando, pero solo necesitamos que no lo sea.</i>  <i>Por lo tanto, primero descargamos solo el archivo de manifiesto del servidor, tomamos hash128 de √©l, y solo entonces, si es necesario, descargamos el archivo de paquete, y el valor hash128 debe extraerse mediante la interpretaci√≥n de las l√≠neas.</i> <br><br><h3>  Trabaja con recursos en modo editor </h3><br>  El √∫ltimo problema, o m√°s bien la cuesti√≥n de la depuraci√≥n y la conveniencia de desarrollo, es trabajar con recursos descargables en modo editor, si no hay problemas con los archivos normales, entonces las cosas no son tan simples con los paquetes.  Por supuesto, puede construir su compilaci√≥n cada vez, subirla al servidor e iniciar la aplicaci√≥n en el editor de Unity y ver c√≥mo funciona todo, pero incluso esta descripci√≥n suena como una "muleta".  Hay que hacer algo con esto y para esto la clase <b>AssetDatabase</b> nos ayudar√°. <br><br>  Para unificar el trabajo con paquetes hice un envoltorio especial: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AssetBundleWrapper</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AssetBundle _assetBundle; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AssetBundleWrapper</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AssetBundle assetBundle</span></span></span><span class="hljs-function">)</span></span> { _assetBundle = assetBundle; } }</code> </pre><br>  Ahora necesitamos agregar dos modos de trabajar con activos, dependiendo de si estamos en el editor o en la compilaci√≥n.  Para la compilaci√≥n, usamos envoltorios sobre las funciones de la clase <b>AssetBundle</b> , y para el editor usamos la clase <b>AssetDatabase</b> mencionada anteriormente. <br><br><div class="spoiler">  <b class="spoiler_title">Por lo tanto, obtenemos el siguiente c√≥digo:</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AssetBundleWrapper</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> UNITY_EDITOR private readonly List&lt;string&gt; _assets; public AssetBundleWrapper(string url) { var uri = new Uri(url); var bundleName = Path.GetFileNameWithoutExtension(uri.LocalPath); _assets = new List&lt;string&gt;(AssetDatabase.GetAssetPathsFromAssetBundle(bundleName)); } public T LoadAsset&lt;T&gt;(string name) where T : UnityEngine.Object { var assetPath = _assets.Find(item =&gt; { var assetName = Path.GetFileNameWithoutExtension(item); return string.CompareOrdinal(name, assetName) == 0; }); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!string.IsNullOrEmpty(assetPath)) { return AssetDatabase.LoadAssetAtPath&lt;T&gt;(assetPath); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { return default; } } public T[] LoadAssets&lt;T&gt;() where T : UnityEngine.Object { var returnedValues = new List&lt;T&gt;(); foreach(var assetPath in _assets) { returnedValues.Add(AssetDatabase.LoadAssetAtPath&lt;T&gt;(assetPath)); } return returnedValues.ToArray(); } public void LoadAssetAsync&lt;T&gt;(string name, Action&lt;T&gt; result) where T : UnityEngine.Object { result(LoadAsset&lt;T&gt;(name)); } public void LoadAssetsAsync&lt;T&gt;(Action&lt;T[]&gt; result) where T : UnityEngine.Object { result(LoadAssets&lt;T&gt;()); } public string[] GetAllScenePaths() { return _assets.ToArray(); } public void Unload(bool includeAllLoadedAssets = false) { _assets.Clear(); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> private readonly AssetBundle _assetBundle; public AssetBundleWrapper(AssetBundle assetBundle) { _assetBundle = assetBundle; } public T LoadAsset&lt;T&gt;(string name) where T : UnityEngine.Object { return _assetBundle.LoadAsset&lt;T&gt;(name); } public T[] LoadAssets&lt;T&gt;() where T : UnityEngine.Object { return _assetBundle.LoadAllAssets&lt;T&gt;(); } public void LoadAssetAsync&lt;T&gt;(string name, Action&lt;T&gt; result) where T : UnityEngine.Object { var request = _assetBundle.LoadAssetAsync&lt;T&gt;(name); TaskManager.Task.Create(request) .Subscribe(() =&gt; { result(request.asset as T); Unload(false); }) .Start(); } public void LoadAssetsAsync&lt;T&gt;(Action&lt;T[]&gt; result) where T : UnityEngine.Object { var request = _assetBundle.LoadAllAssetsAsync&lt;T&gt;(); TaskManager.Task.Create(request) .Subscribe(() =&gt; { var assets = new T[request.allAssets.Length]; for (var i = 0; i &lt; request.allAssets.Length; i++) { assets[i] = request.allAssets[i] as T; } result(assets); Unload(false); }) .Start(); } public string[] GetAllScenePaths() { return _assetBundle.GetAllScenePaths(); } public void Unload(bool includeAllLoadedAssets = false) { _assetBundle.Unload(includeAllLoadedAssets); } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br></div></div><br>  <b>Nota</b> : el c√≥digo usa la clase <b>TaskManager</b> , se discutir√° a continuaci√≥n, en resumen, este es un contenedor para trabajar con <b>Coroutine</b> . <br><br>  Adem√°s de lo anterior, tambi√©n es √∫til durante el desarrollo ver lo que hemos descargado y lo que est√° actualmente en el cach√©.  Para este prop√≥sito, puede aprovechar la capacidad de configurar su propia carpeta, que se utilizar√° para el almacenamiento en cach√© (tambi√©n puede escribir texto descargado y otros archivos en la misma carpeta): <br><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> UNITY_EDITOR var path = Path.Combine(Directory.GetParent(Application.dataPath).FullName, "_EditorCache"); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> var path = Path.Combine(Application.persistentDataPath, "_AppCache"); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> Caching.currentCacheForWriting = Caching.AddCache(path);</span></span></code> </pre><br><h2>  Escribimos un administrador de solicitudes de red o trabajamos con un servidor web </h2><br>  Anteriormente examinamos los aspectos principales de trabajar con recursos externos en Unity, ahora me gustar√≠a detenerme en la implementaci√≥n de la API, que generaliza y unifica todo lo anterior.  Y primero, deteng√°monos en el administrador de consultas de red. <br><br>  <b>Nota</b> : en lo <i>sucesivo, usamos el contenedor sobre <b>Coroutine</b> en forma de la clase <b>TaskManager</b> .</i>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Escrib√≠ sobre este contenedor en otro art√≠culo</a> .</i> <br><br>  Vamos a obtener la clase correspondiente: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Network</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> NetworkTypeEnum { None, Mobile, WiFi } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NetworkTypeEnum NetworkType; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> TaskManager _taskManager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TaskManager(); }</code> </pre><br>  El campo est√°tico <b>NetworkType</b> es necesario para que la aplicaci√≥n reciba informaci√≥n sobre el tipo de conexi√≥n a Internet.  En principio, este valor se puede almacenar en cualquier lugar, decid√≠ que es el lugar en la clase de <b>red</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Agregue la funci√≥n b√°sica de enviar una solicitud al servidor:</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">UnityWebRequest request, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; progress, Action&lt;UnityWebRequest&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Caching.ready) { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (progress != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { request.SendWebRequest(); _currentRequests.Add(request); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!request.isDone) { progress(request.downloadProgress); <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } progress(<span class="hljs-number"><span class="hljs-number">1f</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.SendWebRequest(); } response(request); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_currentRequests.Contains(request)) { _currentRequests.Remove(request); } request.Dispose(); }</code> </pre><br></div></div><br>  Como puede ver en el c√≥digo, el m√©todo para procesar la finalizaci√≥n de una solicitud ha cambiado en comparaci√≥n con el c√≥digo de las secciones anteriores.  Esto es para mostrar el progreso de la carga de datos.  Adem√°s, todas las solicitudes enviadas se almacenan en una lista para que, si es necesario, se puedan cancelar. <br><br><div class="spoiler">  <b class="spoiler_title">Agregue una funci√≥n de creaci√≥n de consultas basada en enlaces para AssetBundle:</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebRequestBundle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Hash128 hash, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; progress, Action&lt;UnityWebRequest&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequestAssetBundle.GetAssetBundle(url, hash, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WebRequest(request, progress, response); }</code> </pre><br></div></div><br>  Del mismo modo, las funciones se crean para textura, audio, texto, matriz de bytes. <br><br>  Ahora debe asegurarse de que el servidor env√≠e datos a trav√©s del comando Publicar.  A menudo necesita pasar algo al servidor y, dependiendo de qu√© exactamente, obtenga una respuesta.  Agregue las funciones apropiadas. <br><br><div class="spoiler">  <b class="spoiler_title">Env√≠o de datos en forma de un conjunto clave-valor:</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebRequestPost</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Dictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; formFields, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; progress, Action&lt;UnityWebRequest&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequest.Post(url, formFields); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WebRequest(request, progress, response); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Env√≠o de datos como json:</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerator </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WebRequestPost</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> data, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; progress, Action&lt;UnityWebRequest&gt; response</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UnityWebRequest(url, UnityWebRequest.kHttpVerbPOST) { uploadHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UploadHandlerRaw(Encoding.UTF8.GetBytes(data)), downloadHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DownloadHandlerBuffer() }; request.uploadHandler.contentType = <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WebRequest(request, progress, response); }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Ahora agregaremos m√©todos p√∫blicos con los que cargaremos datos, en particular AssetBundle</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Hash128 hash, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; progress, Action&lt;AssetBundle&gt; response, TaskManager.TaskPriorityEnum priority = TaskManager.TaskPriorityEnum.Default</span></span></span><span class="hljs-function">)</span></span> { _taskManager.AddTask(WebRequestBundle(url, hash, progress, (uwr) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!uwr.isHttpError &amp;&amp; !uwr.isNetworkError) { response(DownloadHandlerAssetBundle.GetContent(uwr)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Debug.LogWarningFormat(<span class="hljs-string"><span class="hljs-string">"[Netowrk]: error request [{0}]"</span></span>, uwr.error); response(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); } }), priority); }</code> </pre><br></div></div><br>  Del mismo modo, se agregan m√©todos para textura, archivo de audio, texto, etc. <br><br><div class="spoiler">  <b class="spoiler_title">Y finalmente, agregamos la funci√≥n de obtener el tama√±o del archivo descargado y la funci√≥n de limpieza para detener todas las solicitudes creadas.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Request</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; response, TaskManager.TaskPriorityEnum priority = TaskManager.TaskPriorityEnum.Default</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = UnityWebRequest.Head(url); _taskManager.AddTask(WebRequest(request, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, uwr =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contentLength = uwr.GetResponseHeader(<span class="hljs-string"><span class="hljs-string">"Content-Length"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.TryParse(contentLength, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> returnValue)) { response(returnValue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { response(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } }), priority); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Clear</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _taskManager.Clear(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _currentRequests) { request.Abort(); request.Dispose(); } _currentRequests.Clear(); }</code> </pre><br></div></div><br>  En esto, se completa nuestro gerente para trabajar con solicitudes de red.  Si es necesario, cada subsistema del juego que requiere trabajar con el servidor puede crear sus propias instancias de la clase. <br><br><h2>  Escribimos al gerente de carga de recursos externos </h2><br>  Adem√°s de la clase descrita anteriormente, para trabajar completamente con datos externos, necesitamos un administrador separado que no solo descargue los datos, sino que tambi√©n notifique a la aplicaci√≥n sobre el inicio de la descarga, finalizaci√≥n, progreso, falta de espacio libre y tambi√©n se ocupar√° de los problemas de almacenamiento en cach√©. <br><br><div class="spoiler">  <b class="spoiler_title">Comenzamos la clase correspondiente, que en mi caso es un singleton</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExternalResourceManager</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ResourceEnumType { Text, Texture, AssetBundle } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Network _network = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Network(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExternalResourceManager</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> UNITY_EDITOR var path = Path.Combine(Directory.GetParent(Application.dataPath).FullName, "_EditorCache"); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> var path = Path.Combine(Application.persistentDataPath, "_AppCache"); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!System.IO.Directory.Exists(path)) { System.IO.Directory.CreateDirectory(path); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> UNITY_IOS UnityEngine.iOS.Device.SetNoBackupFlag(path); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> } Caching.currentCacheForWriting = Caching.AddCache(path); } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como puede ver, el dise√±ador establece la carpeta para el almacenamiento en cach√©, dependiendo de si estamos en el editor o no. </font><font style="vertical-align: inherit;">Adem√°s, configuramos un campo privado para una instancia de la clase Red, que describimos anteriormente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora agregaremos funciones auxiliares para trabajar con el cach√©, as√≠ como determinar el tama√±o del archivo descargado y verificar el espacio libre para ello. </font><font style="vertical-align: inherit;">M√°s adelante, el c√≥digo se da en un ejemplo de trabajo con AssetBundle, para el resto de los recursos todo se hace por analog√≠a.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo de funci√≥n auxiliar</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClearAssetBundleCache</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileName = GetFileNameFromUrl(url); Caching.ClearAllCachedVersions(fileName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ClearAllRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _network.Clear(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AssetBundleIsCached</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; result</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> manifestFileUrl = <span class="hljs-string"><span class="hljs-string">"{0}.manifest"</span></span>.Fmt(url); _network.Request(manifestFileUrl, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> manifest) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hash = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(manifest) ? <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> : GetHashFromManifest(manifest); result(Caching.IsVersionCached(url, hash)); } , TaskManager.TaskPriorityEnum.RunOutQueue); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckFreeSpace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; result</span></span></span><span class="hljs-function">)</span></span> { GetSize(url, lengthInMb =&gt; { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> UNITY_EDITOR_WIN var logicalDrive = Path.GetPathRoot(Utils.Path.Cache); var availableSpace = SimpleDiskUtils.DiskUtils.CheckAvailableSpace(logicalDrive); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> UNITY_EDITOR_OSX var availableSpace = SimpleDiskUtils.DiskUtils.CheckAvailableSpace(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> UNITY_IOS var availableSpace = SimpleDiskUtils.DiskUtils.CheckAvailableSpace(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> UNITY_ANDROID var availableSpace = SimpleDiskUtils.DiskUtils.CheckAvailableSpace(true); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> result(availableSpace &gt; lengthInMb, lengthInMb); }); } public void GetSize(string url, Action&lt;float&gt; result) { _network.Request(url, length =&gt; result(length / 1048576f)); } private string GetFileNameFromUrl(string url) { var uri = new Uri(url); var fileName = Path.GetFileNameWithoutExtension(uri.LocalPath); return fileName; } private Hash128 GetHashFromManifest(string manifest) { var hashRow = manifest.Split("\n".ToCharArray())[5]; var hash = Hash128.Parse(hashRow.Split(':')[1].Trim()); return hash; }</span></span></code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora agreguemos funciones de carga de datos usando el ejemplo AssetBundle.</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAssetBundle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> url, Action start, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; progress, Action stop, Action&lt;AssetBundleWrapper&gt; result, TaskManager.TaskPriorityEnum taskPriority = TaskManager.TaskPriorityEnum.Default</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> DONT_USE_SERVER_IN_EDITOR start?.Invoke(); result(new AssetBundleWrapper(url)); stop?.Invoke(); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> void loadAssetBundle(Hash128 bundleHash) { start?.Invoke(); _network.Request(url, bundleHash, progress, (AssetBundle value) =&gt; { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(value != null) { _externalResourcesStorage.SetCachedHash(url, bundleHash); } result(new AssetBundleWrapper(value)); stop?.Invoke(); }, taskPriority); }; var manifestFileUrl = "{0}.manifest".Fmt(url); _network.Request(manifestFileUrl, null, (string manifest) =&gt; { var hash = string.IsNullOrEmpty(manifest) ? default : GetHashFromManifest(manifest); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!hash.isValid || hash == default) { hash = _externalResourcesStorage.GetCachedHash(url); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (!hash.isValid || hash == default) { result(new AssetBundleWrapper(null)); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { loadAssetBundle(hash); } } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (Caching.IsVersionCached(url, hash)) { loadAssetBundle(hash); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { CheckFreeSpace(url, (spaceAvailable, length) =&gt; { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (spaceAvailable) { loadAssetBundle(hash); } </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> { result(new AssetBundleWrapper(null)); NotEnoughDiskSpace.Call(); } }); } } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Entonces, ¬øqu√© sucede en esta funci√≥n? </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La directiva de precompilaci√≥n DONT_USE_SERVER_IN_EDITOR se usa para deshabilitar la carga real de paquetes desde el servidor. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El primer paso es hacer una solicitud al servidor para obtener el archivo de manifiesto para el paquete </font></font></li><li>    -    ,    ,   -   ( <b>_externalResourcesStorage</b> )  ,  ,               (  ,     ),  ,   null  </li><li>     ,     Caching      ,       ,         (   ) </li><li>  ,     ,      ,   ,             -       (   ).   ,              (     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="> </a> ) </li></ul><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es importante comprender por qu√© el valor hash se almacena por separado. </font><font style="vertical-align: inherit;">Esto es necesario para el caso cuando no hay Internet, o la conexi√≥n es inestable, o hubo alg√∫n tipo de error de red y no pudimos descargar el paquete desde el servidor, en este caso garantizamos descargar el paquete desde el cach√© si est√° presente all√≠</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De manera similar al m√©todo descrito anteriormente, en el administrador, puede / necesita obtener otras funciones para trabajar con datos: GetJson, GetTexture, GetText, GetAudio, etc.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y finalmente, necesita obtener un m√©todo que le permita descargar conjuntos de recursos. </font><font style="vertical-align: inherit;">Este m√©todo ser√° √∫til si necesitamos descargar o actualizar algo al inicio de la aplicaci√≥n.</font></font></b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Dictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, ResourceEnumType&gt; urls, Action start, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; progress, Action stop, Action&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; result</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> commonProgress = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)urls.Count; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentProgress = <span class="hljs-number"><span class="hljs-number">0f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> completeCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">progressHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { currentProgress += <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; progress?.Invoke(currentProgress / commonProgress); }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">completeHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { completeCounter++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (completeCounter == urls.Count) { stop?.Invoke(); } }; start?.Invoke(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> urls.Keys) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resourceType = urls[url]; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (resourceType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ResourceEnumType.Text: { GetText(url, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, progressHandler, completeHandler, (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, isCached) =&gt; { result(url, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, isCached); }); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ResourceEnumType.Texture: { GetTexture(url, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, progressHandler, completeHandler, (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, isCached) =&gt; { result(url, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, isCached); }); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ResourceEnumType.AssetBundle: { GetAssetBundle(url, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, progressHandler, completeHandler, (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) =&gt; { result(url, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); }); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ vale la pena comprender la peculiaridad del </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TaskManager</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que se utiliza en el administrador de solicitudes de red, por defecto funciona, realizando todas las tareas a su vez. Por lo tanto, la descarga de archivos se realizar√° en consecuencia. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : para aquellos a quienes no les gusta </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Coroutine</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , todo se puede traducir f√°cilmente a </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">async / wait</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , pero en este caso, en el art√≠culo, decid√≠ usar una opci√≥n m√°s comprensible para principiantes (como me parece).</font></font><br><br><h2>  Conclusi√≥n </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este art√≠culo, trat√© de describir el trabajo con recursos externos de aplicaciones de juegos de la manera m√°s compacta posible. </font><font style="vertical-align: inherit;">Este enfoque y este c√≥digo se utilizan en proyectos que se han lanzado y se est√°n desarrollando con mi participaci√≥n. </font><font style="vertical-align: inherit;">Es bastante simple y aplicable en juegos simples donde no hay comunicaci√≥n constante con el servidor (MMO y otros juegos complejos de f2p), pero facilita enormemente el trabajo si necesitamos descargar materiales adicionales, idiomas, implementar la validaci√≥n de compras del lado del servidor y otros datos que una vez o no se usa con demasiada frecuencia en la aplicaci√≥n. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enlaces proporcionados en el art√≠culo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">assetstore.unity.com/packages/tools/simple-disk-utils-59382 </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/post/352296 </font></font></a> <br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habr.com/post/282524</font></font></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es433366/">https://habr.com/ru/post/es433366/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es433356/index.html">Los atacantes aprendieron a evitar la autenticaci√≥n de dos factores Yahoo Mail y Gmail</a></li>
<li><a href="../es433358/index.html">Familiaridad con las pruebas en Python. Parte 1</a></li>
<li><a href="../es433360/index.html">Los cient√≠ficos han intentado predecir cu√°ndo los aviones el√©ctricos se har√°n realidad</a></li>
<li><a href="../es433362/index.html">9 principios de belleza, simplicidad y cuidado en UX</a></li>
<li><a href="../es433364/index.html">LDraw + Unidad. C√≥mo gener√© Lego</a></li>
<li><a href="../es433368/index.html">C√≥mo aplicar el pensamiento de comestibles al mundo: un ejemplo de una sudadera</a></li>
<li><a href="../es433370/index.html">Teor√≠a de fragmentaci√≥n</a></li>
<li><a href="../es433372/index.html">Bicicleta de coche</a></li>
<li><a href="../es433374/index.html">Toda la verdad sobre RTOS. Art√≠culo # 26. Canales: servicios auxiliares y estructuras de datos.</a></li>
<li><a href="../es433376/index.html">Curso MIT "Seguridad de sistemas inform√°ticos". Lecci√≥n 21: Seguimiento de datos, Parte 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>