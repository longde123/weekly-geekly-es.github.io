<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ûñ üõÇ üë®üèª‚Äçüç≥ Conex√£o MySQL ap√≥s o erro 1040: muitas conex√µes üçï üì≤ üßëüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="E novamente ERRO 1040 ... 


 O suporte t√©cnico recebe muitas reclama√ß√µes sobre esse erro not√≥rio: ERROR 1040: Too many connections - muitas conex√µes....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Conex√£o MySQL ap√≥s o erro 1040: muitas conex√µes</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/468757/"><h3 id="i-snova-error-1040">  E novamente ERRO 1040 ... </h3><br><p> O suporte t√©cnico recebe muitas reclama√ß√µes sobre esse erro not√≥rio: <code>ERROR 1040: Too many connections</code> - muitas conex√µes.  O problema √© √≥bvio: o aplicativo ou os usu√°rios criam mais conex√µes do que o servidor permite, ou seja, o n√∫mero atual de conex√µes excede o valor da vari√°vel <code>max_connections</code> . </p><br><p><img src="https://habrastorage.org/webt/sl/15/fx/sl15fxlzehxs85_njkiq1xcq79y.jpeg"></p><br><p>  A situa√ß√£o em si √© um problema para os usu√°rios finais, mas se voc√™ ainda n√£o tiver acesso ao servidor para diagnosticar e corrigir a causa, tudo ficar√° muito ruim.  Normalmente, voc√™ precisa concluir a inst√¢ncia e reinici√°-la para recuperar. </p><a name="habracut"></a><br><h3 id="root-polzovatel-tozhe-ne-mozhet-podklyuchitsya-pochemu">  O usu√°rio root tamb√©m n√£o pode se conectar!  Porqu√™ ?! </h3><br><p>  Em um ambiente configurado corretamente, um usu√°rio com o privil√©gio <code>SUPER</code> poder√° acessar a inst√¢ncia e diagnosticar a causa do erro 1040, devido √† qual n√£o h√° conex√µes suficientes.  Isso √© descrito no manual: </p><br><blockquote>  O mysqld permite <code>max_connections</code> + 1 conex√µes de clientes.  Uma conex√£o adicional √© reservada para contas com privil√©gios <code>SUPER</code> .  Quando esses privil√©gios s√£o concedidos a administradores e n√£o a usu√°rios comuns (que n√£o precisam deles), um administrador que tamb√©m tenha o privil√©gio <code>PROCESS</code> pode se conectar ao servidor e usar <code>SHOW PROCESSLIST</code> para diagnosticar problemas, mesmo se o n√∫mero m√°ximo de clientes sem privil√©gios estiver conectado. </blockquote><p>  Mas muitas pessoas d√£o privil√©gios <code>SUPER</code> aos seus usu√°rios do aplicativo ou script - por causa dos requisitos do aplicativo (perigoso!) Ou pela falta de conhecimento das consequ√™ncias, e ent√£o o usu√°rio comum ocupa a conex√£o reservada e o usu√°rio administrativo (geralmente <code>root</code> ) n√£o pode se conectar. </p><br><h3 id="kak-garantirovat-dostup-k-ekzemplyaru">  Como garantir o acesso a uma inst√¢ncia </h3><br><p>  Voc√™ pode usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conhecido hack com o GDB, que Aurimas recomendou</a> h√° 100 anos para o erro 1040, mas agora existem solu√ß√µes melhores.  √â verdade que eles devem primeiro ser ativados. <br>  Com o Percona Server 5.5.29 e superior e o MySQL 8.0.14 e superior, voc√™ pode configurar outra porta com um n√∫mero adicional de conex√µes.  O aplicativo n√£o usar√° essas interfaces.  Eles s√£o apenas para administradores de banco de dados e agentes de monitoramento e verifica√ß√£o de integridade (veja a nota abaixo). </p><br><h3 id="nastroyka-percona-server">  Configurar o servidor Percona </h3><br><p>  A partir do Percona Server 5.5.29, voc√™ pode simplesmente adicionar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>extra_port</code></a> ao <code>my.cnf</code> e, na pr√≥xima vez em que reiniciar, a porta estar√° dispon√≠vel e esperar√° dados no mesmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>bind_address</code></a> liga√ß√£o das conex√µes normais.  Se voc√™ n√£o configurar a vari√°vel <code>extra_port</code> , n√£o haver√° porta adicional por padr√£o. </p><br><p>  Voc√™ tamb√©m pode definir <code>extra_max_connections</code> para especificar o n√∫mero de conex√µes que essa porta manipular√°.  O n√∫mero padr√£o √© 1. </p><br><p>  Por exemplo, peguei todas as conex√µes com a porta de usu√°rios regulares da inst√¢ncia em que eu j√° configurei <code>extra_port</code> e <code>extra_max_connections</code> no <code>my.cnf</code> : </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">resultado</a> </p><br><p>  A prop√≥sito, extra_port foi removido no Percona Server 8.0.14 e superior, porque admin_port com as mesmas fun√ß√µes √© implementado na Comunidade MySQL.  Portanto, edite my.cnf ao atualizar para o Percona Server 8.0.14 ou superior, se voc√™ j√° definiu extra_port. </p><br><h3 id="nastroyka-v-mysql-community">  Ajustando na Comunidade MySQL </h3><br><p>  Como eu disse, isso requer o MySQL 8.0.14, onde o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WorkLog 12138 √© usado</a> . </p><br><p>  Para ativar a interface de administra√ß√£o, voc√™ precisa definir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">admin_addres</a> , que deve ser o √∫nico e √∫nico (sem curingas) endere√ßo mapeado IPv4, IPv6, IPv4 ou nome do host no qual a interface de administra√ß√£o aguardar√° a transmiss√£o dos dados.  Se essa vari√°vel n√£o estiver definida, a interface n√£o estar√° ativada. </p><br><p>  Voc√™ ainda pode definir a porta, mas isso n√£o √© necess√°rio.  Por padr√£o, essa √© a porta <code>33062</code> .  Se essa porta estiver livre, esse valor n√£o precisar√° ser configurado.  Se voc√™ configurar, coloque as duas vari√°veis ‚Äã‚Äãna se√ß√£o <code>[mysqld]</code> em <code>my.cnf</code> . </p><br><p>  Por fim, voc√™ pode configurar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>create_admin_listener_thread</code></a> (desativado por padr√£o), que cria um encadeamento separado para manipular as conex√µes de entrada.  Isso pode ser √∫til em algumas situa√ß√µes. </p><br><p>  Outra diferen√ßa √© que a documenta√ß√£o do Oracle diz que: </p><br><blockquote>  <em>O n√∫mero de conex√µes administrativas √© ilimitado.</em> </blockquote><p>  (E temos o valor padr√£o de 1).  N√£o tenho certeza do que isso significa, mas eu teria cuidado para n√£o estabelecer acidentalmente 1 milh√£o de conex√µes.  Eles, √© claro, n√£o s√£o limitados, mas ainda consomem recursos. </p><br><h3 id="ispolzovanie-dlya-monitoringa-i-proverok-rabotosposobnosti">  Use para monitoramento e verifica√ß√µes de sa√∫de </h3><br><p>  Convenientemente, n√£o apenas as pessoas podem usar uma interface ou porta adicional em uma emerg√™ncia quando alcan√ßamos <code>max_connections</code> .  Um sistema de monitoramento de descoberta de proxy / balanceador de carga / servi√ßo pode ser conectado a ele. </p><br><p>  Os scripts de monitoramento poder√£o recuperar dados para diagramas, para que mais tarde voc√™ descubra de onde v√™m tantas conex√µes.  E os scripts de verifica√ß√£o de integridade relatam o estado de deteriora√ß√£o do servidor, e certos c√≥digos podem indicar que h√° muitas conex√µes, mas o servidor est√° lidando (ou seja, ele pode descobrir isso sozinho e √© melhor esperar um pouco mais at√© que ocorra uma falha). </p><br><p>  Certifique-se de instalar apenas uma conex√£o por vez para monitoramento e verifica√ß√µes de integridade, para n√£o entupir extra_max_connections no Percona Server e n√£o criar um milh√£o de threads no MySQL.  Ou seja, os scripts n√£o devem ser conectados novamente se a solicita√ß√£o ou conex√£o anterior ao banco de dados ainda estiver ativa. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Aqui est√° o mesmo exemplo, mas com o MySQL</a> . </p><br><p>  <strong>Para o Percona Server 8.0.14 e superior, o processo ser√° o mesmo da Comunidade MySQL.</strong> </p><br><h3 id="pomogite-mne-nuzhno-voyti-no-vse-porty-zanyaty">  Ajuda!  Eu preciso entrar, mas todas as portas est√£o ocupadas! </h3><br><p>  Se esse √© o motivo pelo qual voc√™ est√° lendo esta postagem, use um hack louco com o GDB (sem ofensas, Aurimas, apenas parece arriscado :-D) ou encerre a inst√¢ncia.  Felizmente, uma inst√¢ncia quase sempre pode ser terminada ordenadamente com <code>SIGTERM</code> (-15) em vez de <code>SIGKILL</code> (-9).  Portanto, o servidor far√° uma parada limpa e os threads ter√£o a chance de desligar normalmente.  Basta seguir as instru√ß√µes: </p><br><p>  1) Obtenha o PID: </p><br><pre> <code class="plaintext hljs">marcos.albe in ~/ pgrep -x mysqld; 650</code> </pre> <br><p>  2) Envie o SIGTERM para este PID: </p><br><pre> <code class="plaintext hljs">marcos.albe in ~/ kill -15 650;</code> </pre> <br><p>  3) Verifique no log de erros como o desligamento √© realizado.  Ser√° algo parecido com isto: </p><br><pre> <code class="plaintext hljs">2019-07-11T13:43:28.421244Z 0 [Note] Giving 0 client threads a chance to die gracefully 2019-07-11T13:43:28.521238Z 0 [Note] Shutting down slave threads 2019-07-11T13:43:28.521272Z 0 [Note] Forcefully disconnecting 0 remaining clients</code> </pre> <br><p>  Isso marca o in√≠cio do processo de conclus√£o.  A inst√¢ncia ser√° conclu√≠da quando voc√™ vir uma linha semelhante: </p><br><pre> <code class="plaintext hljs">2019-07-11T13:43:31.292836Z 0 [Note] /opt/percona_server/5.7.26/bin/mysqld: Shutdown complete</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt468757/">https://habr.com/ru/post/pt468757/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt468739/index.html">Fornecendo failover de armazenamento</a></li>
<li><a href="../pt468741/index.html">Internet na cidade inteligente</a></li>
<li><a href="../pt468747/index.html">Como passei o ver√£o na VK</a></li>
<li><a href="../pt468749/index.html">Eventos do Android LiveData</a></li>
<li><a href="../pt468753/index.html">Dalt√¥nico - amigo do homem (o Minist√©rio da Sa√∫de n√£o est√° certo)</a></li>
<li><a href="../pt468759/index.html">Sobre [[trivial_abi]] em Clang</a></li>
<li><a href="../pt468761/index.html">Solu√ß√£o de problemas com pwnable.kr 24 - login simples. Sobreposi√ß√£o de quadro de pilha</a></li>
<li><a href="../pt468765/index.html">A import√¢ncia de confirmar comandos de controle usando o Delimobile como exemplo</a></li>
<li><a href="../pt468767/index.html">Brinquedos de madeira, parte dois - 1986-1988</a></li>
<li><a href="../pt468769/index.html">Xavier Noria no Rails 6, consultoria e muito mais</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>