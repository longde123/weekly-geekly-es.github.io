<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍖 😓 👵 Bot para Starcraft em Rust, C e qualquer outro idioma 👆🏽 🏷️ 🤽🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="StarCraft: Guerra da Ninhada . Quanto isso significa para mim. E para muitos de vocês. Tantos que eu duvidava em dar um link para o wiki. 


 Uma vez,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bot para Starcraft em Rust, C e qualquer outro idioma</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416743/"><p><img src="https://habrastorage.org/webt/qv/fa/ex/qvfaexsnkzmckmwrt_spqmc7nr4.png" align="left">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StarCraft: Guerra da Ninhada</a> .  Quanto isso significa para mim.  E para muitos de vocês.  Tantos que eu duvidava em dar um link para o wiki. </p><br><p>  Uma vez, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Halt</a> me bateu em um e- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">mail</a> pessoal e se ofereceu para aprender <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Rust</a> .  Como qualquer pessoa normal, decidimos começar com <del>  olá mundo </del>  escrevendo uma biblioteca dinâmica para Windows que possa ser carregada no espaço de endereço de um jogo StarCraft e gerenciar unidades. </p><br><p> O artigo descreverá o processo de encontrar soluções, usando tecnologias, técnicas que permitirão que você aprenda coisas novas na linguagem Rust e em seu ecossistema ou seja inspirado a implementar um bot em sua linguagem favorita, seja C, C ++, ruby, python, etc. </p><a name="habracut"></a><br><p>  Vale a pena ler este artigo sob o hino da Coréia do Sul: </p><br><div class="spoiler">  <b class="spoiler_title">Starcraft OST</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/pNt0iVG2VOA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><br><h2 id="bwapi">  Bwapi </h2><br><p>  Este jogo já tem 20 anos.  E ainda é <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">popular</a> , os campeonatos reúnem salas inteiras de pessoas nos EUA, mesmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em 2017</a> , onde ocorreu a batalha dos mestres Jaedong vs Bisu.  Além de jogadores ao vivo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">carros sem alma</a> também participam de batalhas!  E isso é possível graças ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BWAPI</a> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Links</a> mais úteis. </p><br><p>  Por mais de uma década, houve uma comunidade de desenvolvedores de bot em torno deste jogo.  Entusiastas escrevem bots e participam de vários campeonatos.  Muitos deles estudam IA e aprendizado de máquina.  O BWAPI é usado pelas universidades para educar seus alunos.  Existe até um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">canal de contração</a> que transmite jogos. </p><br><p>  Assim, há alguns anos, uma equipe de fãs reverteu os componentes internos do Starcraft e criou uma API C ++ que permite escrever bots, integrar-se ao processo do jogo e dominar pessoas patéticas. </p><br><p>  Como costuma acontecer antes <del>  para construir uma casa, você precisa obter minério, forjar ferramentas ... </del>  Para escrever um bot, você precisa implementar a API.  O que a Rust pode oferecer? </p><br><h2 id="ffi">  Ffi </h2><br><p>  Interagir com outros idiomas do Rust é bastante simples.  Existe <abbr title="Interface de função externa">FFI</abbr> para isso.  Deixe-me fornecer um breve trecho da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documentação</a> . </p><br><p>  Suponha que tenhamos uma biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">snappy</a> que possui um arquivo de cabeçalho <a href="">snappy-ch a</a> partir do qual copiaremos as declarações de função. </p><br><p>  Crie um projeto usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">carga</a> . </p><br><pre><code class="bash hljs">$ cargo new --bin snappy Created binary (application) `snappy` project $ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> snappy snappy$ tree . ├── Cargo.toml └── src └── main.rs 1 directory, 2 files</code> </pre> <br><p>  Cargo criou uma estrutura de arquivos padrão para o projeto. </p><br><p>  Em <code>Cargo.toml</code> especifique a dependência da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">libc</a> : </p><br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">dependencies</span></span>] libc = <span class="hljs-string"><span class="hljs-string">"0.2"</span></span></code> </pre> <br><p>  <code>src/main.rs</code> arquivo <code>src/main.rs</code> terá a seguinte aparência: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">crate</span></span> libc; <span class="hljs-comment"><span class="hljs-comment">//   C ,     size_t use libc::size_t; #[link(name = "snappy")] //       extern { //    ,    //  C  : // size_t snappy_max_compressed_length(size_t source_length); fn snappy_max_compressed_length(source_length: size_t) -&gt; size_t; } fn main() { let x = unsafe { snappy_max_compressed_length(100) }; println!("max compressed length of a 100 byte buffer: {}", x); }</span></span></code> </pre> <br><p>  Coletamos e executamos: </p><br><pre> <code class="bash hljs">snappy$ cargo build ... snappy$ cargo run Finished dev [unoptimized + debuginfo] target(s) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.02s Running `target/debug/snappy` max compressed length of a 100 byte buffer: 148</code> </pre> <br><p>  Você só pode chamar a <code>cargo run</code> , que antes do lançamento chama a <code>cargo build</code> .  Ou crie um projeto e chame o binário diretamente: </p><br><pre> <code class="bash hljs">snappy$ ./target/debug/snappy max compressed length of a 100 byte buffer: 148</code> </pre> <br><p>  O código é compilado desde que a biblioteca snappy esteja instalada (para Ubuntu, o pacote libsnappy-dev deve estar instalado). </p><br><pre> <code class="bash hljs">snappy$ ldd target/debug/snappy ... libsnappy.so.1 =&gt; /usr/lib/x86_64-linux-gnu/libsnappy.so.1 (0x00007f8de07cf000)</code> </pre> <br><p>  Como você pode ver, nosso binário está vinculado à biblioteca compartilhada libsnappy.  E a chamada <code>snappy_max_compressed_length</code> é uma chamada de função desta biblioteca. </p><br><h2 id="rust-bindgen">  ferrugem-bindgen </h2><br><p>  Seria bom se pudéssemos gerar automaticamente o FFI.  Felizmente, existe uma utilidade no arsenal de rastomanov chamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ferrugem-bindgen</a> .  Ela é capaz de gerar ligações FFI para bibliotecas C (e algumas C ++). </p><br><p>  Instalação: </p><br><pre> <code class="bash hljs">$ cargo install bindgen</code> </pre> <br><p>  Como é o uso do <strong>rust-bindgen</strong> ?  Pegamos os arquivos de cabeçalho C / C ++, configuramos o utilitário <strong>bindgen</strong> neles e obtemos o código Rust gerado com as definições das estruturas e funções da estrutura.  Aqui está a aparência da geração FFI para o snappy: </p><br><pre> <code class="rust hljs">$ bindgen /usr/include/snappy-ch | grep -C <span class="hljs-number"><span class="hljs-number">1</span></span> snappy_max_compressed_length <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">snappy_max_compressed_length</span></span></span></span>(source_length: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>; }</code> </pre> <br><p>  Acontece que o bindgen passa na frente dos cabeçalhos BWAPI, gerando toneladas de folhas de código não utilizáveis ​​(devido a funções de membro virtuais, std :: string na API pública, etc.).  A questão é que o BWAPI é escrito em C ++.  C ++ é geralmente difícil de usar, mesmo em projetos C ++.  Quando uma biblioteca compilada é melhor vincular ao mesmo vinculador (versões idênticas), os arquivos de cabeçalho são melhores para analisar com o mesmo compilador (versões idênticas).  Porque existem muitos fatores que podem afetar o resultado.  Por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">manipulação</a> , que o GNU GCC ainda <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">não pode implementar sem erros</a> .  Esses fatores são tão significativos que não puderam ser superados nem no <abbr title="Estrutura de teste C ++ do Google">gtest</abbr> , e a documentação <a href="">indicou</a> que seria melhor criar o gtest como parte do projeto com o mesmo compilador e o mesmo vinculador. </p><br><h2 id="bwapi-c">  Bwapi-c </h2><br><p>  C é a programação da lingua franca.  Se rust-bindgen funciona bem para a linguagem C, por que não implementar o BWAPI for C e depois usar sua API?  Boa ideia! </p><br><p>  Sim, é uma boa ideia até que você analise a essência da BWAPI e veja o número de classes e métodos que você precisa implementar = (Especialmente todos esses layouts de estruturas na memória, assemblers, patches de memória e outros horrores para os quais não temos tempo. É necessário usar a solução existente ao máximo. </p><br><p>  Mas devemos, de alguma forma, lidar com funções desconcertantes, de código C ++, herança e membro virtual. </p><br><p>  Em C ++, existem duas ferramentas poderosas que usaremos para resolver nosso problema: são <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ponteiros opacos</a> e <code>extern "C"</code> . </p><br><p>  <code>extern "C" {}</code> permite que o código C ++ se disfarce como C. Isso permite gerar nomes de funções puros sem confundir. </p><br><p>  Ponteiros opacos nos permitem apagar um tipo e criar um ponteiro para "algum tipo" cuja implementação não fornecemos.  Como esta é apenas uma declaração de algum tipo, e não sua implementação, é impossível usar esse tipo por valor, ele pode ser usado apenas por ponteiro. </p><br><p>  Digamos que temos esse código C ++: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> cpp { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bar; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;bar; } }; } <span class="hljs-comment"><span class="hljs-comment">// namespace cpp</span></span></code> </pre> <br><p>  Podemos transformá-lo em um cabeçalho C como este: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo_</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">//    Foo //  cpp::Foo::get_bar int Foo_get_bar(Foo* self); }</span></span></code> </pre> <br><p>  E a parte C ++, que será o link entre o cabeçalho C e a implementação C ++: </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Foo_get_bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Foo* self)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      cpp::Foo    ::get_bar return reinterpret_cast&lt;cpp::Foo*&gt;(self)-&gt;get_bar(); }</span></span></code> </pre> <br><p>  Nem todos os métodos de classe tiveram que ser tratados dessa maneira.  Existem classes no BWAPI, operações nas quais você pode se implementar usando os valores de campo dessas estruturas, por exemplo, <code>typedef struct Position { int x; int y; } Position;</code> <code>typedef struct Position { int x; int y; } Position;</code>  e métodos como <code>Position::get_distance</code> . </p><br><p>  Havia quem tivesse que ser julgado de uma maneira especial.  Por exemplo, um AIModule deve ser um ponteiro para uma classe C ++ com um conjunto específico de funções-membro virtuais.  No entanto, aqui está o <a href="">título</a> e a <a href="">implementação</a> . </p><br><p>  Assim, após vários meses de trabalho duro, <strong>554</strong> métodos e uma dúzia de classes, nasceu a biblioteca de plataforma cruzada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BWAPI-C</a> , que permite <a href="">escrever bots em C.</a>  O subproduto foi a compilação cruzada e a capacidade de implementar a API em qualquer outro idioma que suporte a FFI e a convenção de chamada cdecl. </p><br><p>  Se você estiver escrevendo uma biblioteca, escreva a API C. </p><br><p>  O recurso mais importante do BWAPI-C é a mais ampla capacidade de integração com outros idiomas.  <code>Python</code> , <code>Ruby</code> , <code>Rust</code> , <code>PHP</code> , <code>Java</code> e muitos outros sabem trabalhar com C, portanto, você também pode escrever um bot neles, se trabalhar um pouco com um arquivo e implementar seus wrappers. </p><br><h2 id="pishem-bota-na-c">  Escrevendo um bot em C </h2><br><p>  Esta parte descreve os princípios gerais do design dos módulos Starcraft. </p><br><p>  Existem 2 tipos de bots: módulo e cliente.  Veremos um exemplo de escrita de um módulo. </p><br><p>  Um módulo é uma biblioteca para download; o princípio geral de carregamento pode ser visto <a href="">aqui</a> .  O módulo deve exportar 2 funções: <code>newAIModule</code> e <code>gameInit</code> . </p><br><p>  Com <code>gameInit</code> tudo é simples, essa função é chamada para passar um ponteiro para o jogo atual.  Esse ponteiro é muito importante, porque na natureza do BWAPI vive uma variável estática global usada em algumas partes do código.  Vamos descrever <code>gameInit</code> : </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">DLLEXPORT </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gameInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* game</span></span></span><span class="hljs-function">)</span></span> { BWAPIC_setGame(game); }</code> </pre> <br><p>  <code>newAIModule</code> pouco mais complicado.  Ele deve retornar um ponteiro para uma classe C ++ que possui uma tabela de método virtual com os nomes <strong>onXXXXX</strong> chamados em determinados eventos do jogo.  Defina a estrutura do módulo: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExampleAIModule</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AIModule_vtable* vtable_; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* name; } ExampleAIModule;</code> </pre> <br><p>  O primeiro campo deve ser um ponteiro para uma tabela de métodos (mágica, todas as coisas).  Portanto, a função <code>newAIModule</code> : </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-function">DLLEXPORT </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAIModule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ExampleAIModule* <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> = (ExampleAIModule*) <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(ExampleAIModule) ); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-&gt;name = <span class="hljs-string"><span class="hljs-string">"ExampleAIModule"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-&gt;vtable_ = &amp;module_vtable; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createAIModuleWrapper( (AIModule*) <span class="hljs-keyword"><span class="hljs-keyword">module</span></span> ); }</code> </pre> <br><p>  <code>createAIModuleWrapper</code> é outra mágica que transforma um ponteiro C em um ponteiro para uma classe C ++ com virtual <del>  métodos </del>  funções de membro. </p><br><p>  <code>module_vtable</code> é uma variável estática na tabela de métodos, os valores dos métodos são preenchidos com ponteiros para funções globais: </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> AIModule_vtable module_vtable = { onStart, onEnd, onFrame, onSendText, onReceiveText, onPlayerLeft, onNukeDetect, onUnitDiscover, onUnitEvade, onUnitShow, onUnitHide, onUnitCreate, onUnitDestroy, onUnitMorph, onUnitRenegade, onSaveGame, onUnitComplete }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isWinner)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSendText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* text)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReceiveText</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Player* player, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* text)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPlayerLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Player* player)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNukeDetect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Position target)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitDiscover</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitEvade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitShow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitHide</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitMorph</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitRenegade</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSaveGame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params">* gameName)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUnitComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Unit* unit)</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre> <br><p>  Pelo nome das funções e suas assinaturas, fica claro em que condições e com quais argumentos eles são chamados.  Por exemplo, deixei todas as funções vazias, exceto </p><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStart</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(AIModule* </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">module</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ ExampleAIModule* self = (ExampleAIModule*) <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>; Game* game = BWAPIC_getGame(); Game_sendText(game, <span class="hljs-string"><span class="hljs-string">"Hello from bwapi-c!"</span></span>); Game_sendText(game, <span class="hljs-string"><span class="hljs-string">"My name is %s"</span></span>, self-&gt;name); }</code> </pre> <br><p>  Esta função é chamada quando o jogo começa.  Um ponteiro para o módulo atual é passado como argumento.  <code>BWAPIC_getGame</code> retorna um ponteiro global para o jogo que definimos chamando <code>BWAPIC_setGame</code> .  Então, mostraremos um exemplo de compilação cruzada e operação de módulo: </p><br><pre> <code class="bash hljs">bwapi-c/example$ tree . ├── BWAPIC.dll └── Dll.c 0 directories, 2 files bwapi-c/example$ i686-w64-mingw32-gcc -mabi=ms -shared -o Dll.dll Dll.c -I../include -L. -lBWAPIC bwapi-c/example$ cp Dll.dll ~/Starcraft/bwapi-data/ bwapi-c/example$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Starcraft/bwapi-data/ Starcraft$ wine bwheadless.exe -e StarCraft.exe -l bwapi-data/BWAPI.dll --headful ... ... ...</code> </pre> <br><p>  Apertamos botões e começamos o jogo.  Você pode ler mais sobre o lançamento no site da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BWAPI</a> e em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BWAPI-C</a> . </p><br><p>  O resultado do módulo: </p><br><p><img src="https://habrastorage.org/webt/cw/a-/41/cwa-41ihsyva-pj2stpef1xjn2g.png" alt="imagem"></p><br><p>  Um exemplo um pouco mais complexo de um módulo que mostra o trabalho com iteradores, controle de unidade, pesquisa mineral e estatísticas pode ser encontrado em <a href="">bwapi-c / example / Dll.c.</a> </p><br><h2 id="bwapi-sys">  bwapi-sys </h2><br><p>  No ecossistema Rasta, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">é habitual</a> chamar pacotes de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma</a> certa maneira que vinculam a bibliotecas nativas.  Qualquer pacote foo-sys tem duas funções importantes: </p><br><ul><li>  Link para a biblioteca nativa libfoo </li><li>  Fornece declarações de função da biblioteca libfoo.  Mas apenas declarações, abstrações de alto nível em caixas * -sys não são fornecidas. </li></ul><br><p>  Para que o pacote * -sys possa ser vinculado com êxito, eles integram uma <a href="">pesquisa de</a> biblioteca nativa e / ou um <a href="">conjunto de</a> bibliotecas das fontes nele. </p><br><p>  Para que o pacote * -sys forneça declarações, é necessário escrevê-las manualmente ou gerar usando bindgen.  Novamente bindgen.  Tentativa número dois =) </p><br><p>  A geração de ligantes com bwapi-c se torna obscena: </p><br><pre> <code class="bash hljs">bindgen BWAPI.h -o lib.rs \ --opaque-type <span class="hljs-string"><span class="hljs-string">".+_"</span></span> \ --blacklist-type <span class="hljs-string"><span class="hljs-string">"std.*|__.+|.+_$|Game_v(Send|Print|Draw).*|va_list|.+_t$"</span></span> \ --no-layout-tests \ --no-derive-debug \ --raw-line <span class="hljs-string"><span class="hljs-string">"#![allow(improper_ctypes, non_snake_case)]"</span></span> \ -- -I../submodules/bwapi-c/include sed -i -r -- <span class="hljs-string"><span class="hljs-string">'s/.+\s+(.+)_;/pub struct \1;/'</span></span> lib.rs</code> </pre> <br><p>  Onde <code>BWAPI.h</code> é o arquivo com as inclusões de todos os cabeçalhos de cabeçalho do BWAPI-C. </p><br><p>  Por exemplo, para funções já conhecidas, o bindgen gerou as seguintes declarações: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> { <span class="hljs-comment"><span class="hljs-comment">/// BWAPIC_setGame must be called from gameInit to initialize BWAPI::BroodwarPtr pub fn BWAPIC_setGame(game: *mut Game); } extern "C" { pub fn BWAPIC_getGame() -&gt; *mut Game; }</span></span></code> </pre> <br><p>  Existem duas estratégias: armazenar o código gerado no repositório e gerar código rapidamente durante a montagem.  Ambas as abordagens têm suas vantagens e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">desvantagens</a> . </p><br><p>  Bem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">-</a> vindo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bwapi-sys</a> , outro pequeno passo em direção ao nosso objetivo. </p><br><p>  Lembre-se, eu falei sobre plataforma cruzada?  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Nlinker se</a> juntou ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">projeto</a> e implementou uma estratégia complicada.  Se o destino for Windows, faça o download do BWAPIC já montado no github.  E para os demais alvos, coletamos o BWAPI-C a partir das fontes do OpenBW (falarei um pouco mais adiante). </p><br><h2 id="bwapi-rs">  bwapi-rs </h2><br><p>  Agora que temos os ligantes, podemos descrever abstrações de alto nível.  Temos dois tipos para trabalhar: valores puros e ponteiros opacos. </p><br><p>  Com valores puros, tudo é mais simples.  Tome a cor como exemplo.  Precisamos facilitar o uso do código Rust para que possamos usar as cores de maneira conveniente e natural: </p><br><pre> <code class="rust hljs">game.draw_line(CoordinateType::Screen, (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>), (<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">40</span></span>), Color::Red); ^^^</code> </pre> <br><p>  Portanto, para uso conveniente, será necessário definir uma enumeração idiomática para a linguagem Rust com <a href="">constantes</a> do C ++ e definir métodos de conversão em bwapi_sys :: Color usando a característica <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">std :: convert :: From</a> </p><br><pre> <code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// FFI version #[repr(C)] #[derive(Copy, Clone)] pub struct Color { pub color: ::std::os::raw::c_int, } // Idiomatic version #[derive(PartialEq, PartialOrd, Copy, Clone)] pub enum Color { Black = 0, Brown = 19, ...</span></span></code> </pre> <br><p>  Embora por conveniência, você pode usar a caixa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">enum-primitive-derivate</a> . </p><br><p>  Com ponteiros opacos, não é mais difícil.  Para fazer isso, use o padrão <a href="">Newtype</a> : </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span></span>(*<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> sys::Player);</code> </pre> <br><p>  Ou seja, o Player é uma certa estrutura com um campo privado - um ponteiro opaco bruto de C. E aqui está como você pode descrever o método Player :: color: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Player { <span class="hljs-comment"><span class="hljs-comment">//    Player::getColor  bwapi-sys //extern "C" { // pub fn Player_getColor(self_: *mut Player) -&gt; Color; //} pub fn color(&amp;self) -&gt; Color { // bwapi_sys::Player_getColor -    BWAPI-C // self.0 -   let color = unsafe { bwapi_sys::Player_getColor(self.0) }; color.into() //  bwapi_sys::Color -&gt; Color } }</span></span></code> </pre> <br><p>  Agora podemos escrever nosso primeiro bot no Rust! </p><br><h2 id="pishem-bota-na-rust">  Escrevendo um bot no Rust </h2><br><p>  Como prova de conceito, o bot parecerá um país famoso: toda a sua funcionalidade será contratar trabalhadores e coletar minerais. </p><br><p><img src="https://habrastorage.org/webt/hx/r_/jm/hxr_jmj2fbsitx-tfw96p2pa2tu.png" alt="Coreia do norte"></p><br><p><img src="https://habrastorage.org/webt/ww/gf/lr/wwgflrekcnxtv75thaurrwcm0g8.png" alt="Coreia do sul"></p><br><p>  Vamos começar com as <code>gameInit</code> necessárias <code>gameInit</code> e <code>newAIModule</code> : </p><br><pre> <code class="rust hljs"><span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gameInit</span></span></span></span>(game: *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> void) { bwapi_sys::BWAPIC_setGame(game <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> bwapi_sys::Game); } <span class="hljs-meta"><span class="hljs-meta">#[no_mangle]</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pub</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span> <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-string"><span class="hljs-string">"C"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newAIModule</span></span></span></span>() -&gt; *<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> void { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> module = ExampleAIModule { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::from(<span class="hljs-string"><span class="hljs-string">"ExampleAIModule"</span></span>) }; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = wrap_handler(<span class="hljs-built_in"><span class="hljs-built_in">Box</span></span>::new(module)); result }</code> </pre> <br><p>  <code>#[no_mangle]</code> executa a mesma função que <code>extern "C"</code> em C ++.  Dentro do <code>wrap_handler</code> , todo tipo de mágica acontece com a substituição da tabela de funções virtuais e se disfarça como uma classe C ++. </p><br><p>  A descrição da estrutura do módulo é ainda mais simples e mais bonita do que em C: </p><br><pre> <code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExampleAIModule</span></span></span></span> { name: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, }</code> </pre> <br><p>  Adicione alguns métodos para renderizar estatísticas e dar ordens: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> ExampleAIModule { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw_stat</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> game = Game::get(); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> message = <span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"Frame {}"</span></span>, game.frame_count()); game.draw_text(CoordinateType::Screen, (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), &amp;message); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">give_orders</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> player = Game::get().self_player(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> unit <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> player.units() { <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> unit.get_type() { UnitType::Terran_SCV | UnitType::Zerg_Drone | UnitType::Protoss_Probe =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !unit.is_idle() { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> unit.is_carrying_gas() || unit.is_carrying_minerals() { unit.return_cargo(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(mineral) = Game::get() .minerals() .min_by_key(|m| unit.distance_to(m)) { <span class="hljs-comment"><span class="hljs-comment">// WE REQUIRE MORE MINERALS unit.right_click(&amp;mineral, false); } } UnitType::Terran_Command_Center =&gt; { unit.train(UnitType::Terran_SCV); } UnitType::Protoss_Nexus =&gt; { unit.train(UnitType::Protoss_Probe); } UnitType::Zerg_Hatchery | UnitType::Zerg_Lair | UnitType::Zerg_Hive =&gt; { unit.train(UnitType::Zerg_Drone); } _ =&gt; {} }; } } }</span></span></code> </pre> <br><p>  Para que o tipo ExampleAIModule se transforme em um módulo real, você precisa ensiná-lo a responder a eventos <strong>onXXXX</strong> , para os quais é necessário implementar o tipo EventHandler, que é análogo à tabela virtual AIModule_vtable de C: </p><br><pre> <code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> EventHandler <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ExampleAIModule { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_start</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { Game::get().send_text(&amp;<span class="hljs-built_in"><span class="hljs-built_in">format!</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello from Rust! My name is {}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.name)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_end</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _is_winner: <span class="hljs-built_in"><span class="hljs-built_in">bool</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_frame</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.draw_stat(); <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.give_orders(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_send_text</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _text: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_receive_text</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _player: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Player, _text: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_player_left</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _player: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Player) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_nuke_detect</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _target: Position) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_discover</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_evade</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_show</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_hide</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_create</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_destroy</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_morph</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_renegade</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_save_game</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _game_name: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">on_unit_complete</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, _unit: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> Unit) {} }</code> </pre> <br><p>  Construir e iniciar o módulo é tão fácil quanto para C: </p><br><pre> <code class="bash hljs">bwapi-rs$ cargo build --example dll --target=i686-pc-windows-gnu bwapi-rs$ cp ./target/i686-pc-windows-gnu/debug/examples/dll.dll ~/Starcraft/bwapi-data/Dll.dll bwapi-rs$ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/Starcraft/bwapi-data/ Starcraft$ wine bwheadless.exe -e StarCraft.exe -l bwapi-data/BWAPI.dll --headful ... ... ...</code> </pre> <br><p>  E o vídeo do trabalho: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rACbnWpI01M" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2 id="nemnogo-o-krosskompilyacii">  Um pouco sobre compilação cruzada </h2><br><p>  Em suma, Rust é lindo!  Em dois cliques, você pode colocar muitas cadeias de ferramentas para plataformas diferentes.  Especificamente, a cadeia de ferramentas i686-pc-windows-gnu é definida pelo comando: </p><br><pre> <code class="bash hljs">rustup target add i686-pc-windows-gnu</code> </pre> <br><p>  Você também pode especificar o kofig para carga na raiz do projeto <code>.cargo/config</code> : </p><br><pre> <code class="hljs powershell">[<span class="hljs-type"><span class="hljs-type">target.i686</span></span>-<span class="hljs-type"><span class="hljs-type">pc</span></span>-<span class="hljs-type"><span class="hljs-type">windows</span></span>-<span class="hljs-type"><span class="hljs-type">gnu</span></span>] linker = <span class="hljs-string"><span class="hljs-string">"i686-w64-mingw32-gcc"</span></span> ar = <span class="hljs-string"><span class="hljs-string">"i686-w64-mingw32-ar"</span></span> runner = <span class="hljs-string"><span class="hljs-string">"wine"</span></span></code> </pre> <br><p>  E é tudo o que você precisa fazer para compilar seu projeto Rust do Linux no Windows. </p><br><h2 id="openbw">  Openbw </h2><br><p>  Esses caras foram ainda mais longe.  Eles decidiram escrever uma versão de código aberto do jogo SC: BW!  E eles se dão muito bem.  Um de seus objetivos era implementar imagens em HD, mas o SC: Remastered se adiantou a elas = (no momento, você pode usar sua API para escrever bots (sim, também em C ++). Mas o recurso mais surpreendente é a capacidade de visualizar replays <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">diretamente no navegador</a> . </p><br><h2 id="zaklyuchenie">  Conclusão </h2><br><p>  Um problema não resolvido permaneceu durante a implementação: não controlamos a exclusividade dos links, e a existência simultânea de <code>&amp;mut</code> e <code>&amp;</code> ao alterar um objeto levará a um comportamento indefinido.  Problema.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Halt</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tentou</a> implementar ligações idiomáticas, mas seu fusível desapareceu um pouco.  Além disso, para resolver esse problema, você precisará descartar qualitativamente a API C ++ e definir corretamente os qualificadores <code>const</code> . </p><br><p>  Gostei muito de trabalhar nesse projeto, assisti replays e mergulhei profundamente na atmosfera.  Este jogo deixou 믿어 믿어 않을 정도 인 um legado.  Nenhum jogo é popular no SC: BW, e seu impacto no 에게 정치 에게 era impensável.  Os jogadores profissionais da Coréia do Sul são tão populares quanto os dramas coreanos transmitidos no horário nobre.  또한, 한국 에서 게이머 라면 군대 의 특별한 에 에 입대 할 수. </p><br><p>  Viva o StarCraft! </p><br><h2 id="ssylki">  Referências </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">amargo</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bwapi-rs</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bwapi-sys</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bwapi-c</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">bwapi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">openbw</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416743/">https://habr.com/ru/post/pt416743/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416729/index.html">O programa PYCON RUSSIA está pronto: 25 relatórios e 3 workshops de palestrantes do Google, Red Hat, Yelp, Yandex</a></li>
<li><a href="../pt416731/index.html">Frost on glass: como fazer plástico metglass resistente</a></li>
<li><a href="../pt416737/index.html">A * Path Finding Algorithm em um jogo Voxel 3d Unity</a></li>
<li><a href="../pt416739/index.html">Novo ASUS na Computex 2018</a></li>
<li><a href="../pt416741/index.html">Os invasores usavam certificados D-Link roubados em seu software de roubo de senha</a></li>
<li><a href="../pt416745/index.html">Novo ASUS ROG na Computex 2018</a></li>
<li><a href="../pt416751/index.html">Coleta de informações contextuais para log</a></li>
<li><a href="../pt416753/index.html">O popular plugin Hola VPN comprometido</a></li>
<li><a href="../pt416755/index.html">Extreme Likes - Comitê de Investigação Contra</a></li>
<li><a href="../pt416757/index.html">Testes escamosos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>