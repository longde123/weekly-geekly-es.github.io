<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊🏻 ♟️ ✳️ 您在开发过程中不需要做什么的故事 💚 👩🏽‍🎓 👨🏾‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="序言：首先，我将讨论该项目，以便对我们如何进行该项目以及如何减轻痛苦产生一些想法。 

 作为一名开发人员，我在2015-2016年进入了该项目，我不记得确切，但是它在2-3年前就已经生效。 该项目在游戏服务器领域非常受欢迎。 听起来并不奇怪，但是游戏服务器上的项目一直持续到今天，最近我看到了空缺，...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>您在开发过程中不需要做什么的故事</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431786/"> <b>序言：</b>首先，我将讨论该项目，以便对我们如何进行该项目以及如何减轻痛苦产生一些想法。 <br><br> 作为一名开发人员，我在2015-2016年进入了该项目，我不记得确切，但是它在2-3年前就已经生效。 该项目在游戏服务器领域非常受欢迎。 听起来并不奇怪，但是游戏服务器上的项目一直持续到今天，最近我看到了空缺，并在同一团队工作了一段时间。 因此，由于游戏服务器是基于已经创建的游戏构建的，因此脚本语言用于内置在游戏引擎中的开发。 <br><br> 我们正在从Garry的Mod（Gmod）几乎从零开始开发一个项目，需要注意的是，在撰写本文时，Harry已经在虚幻引擎上创建了一个新的S＆Box项目。 我们仍然坐在Source上。 <br><blockquote> 通常不适合我们的服务器主题。 </blockquote><img src="https://habrastorage.org/getpro/habr/post_images/a7c/086/fef/a7c086fef0487def7d3bd7b5b50f9b8d.jpg" alt="图片"><br><a name="habracut"></a><br>  “你的故事吓人什么？”  -你问。 <br><br> 对于游戏服务器，我们有一个很强的主题，即“潜行者”，即使有角色扮演游戏（RP）的元素，也立即出现了一个问题-“每个人如何在一个服务器上实现它？” <br><br> 考虑到Source引擎较旧（2013版本也用于32位Gmod），因此您不会做大牌，对Entity，Mesh的数量有小的限制，甚至更多。 <br><blockquote> 谁在引擎上工作会明白。 </blockquote> 事实证明，要完成一个干净的多人缠扰者任务，通常是不可能完成的任务，任务包括原始任务本身的RPG元素，最好是一个小地块。 <br><br> 首先，最初的拼写很困难（类别中的许多动作：从头开始写东西，举起对象），希望继续比较容易，但是要求却越来越高。 游戏的机制已经准备就绪，剩下的只是做智力，升级和各种事情。 总的来说，所有人都尽可能地转移了。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c41/7d4/fbf/c417d4fbf4cc7ac27df898fafa43e228.png" alt="图片"><br><br> 这些问题已经在发行第一个版本的工作中开始出现，即（延迟，服务器延迟）。 <br><br> 似乎功能强大的服务器可以从容处理请求并保持整个Gamemode。 <br><br><div class="spoiler">  <b class="spoiler_title">游戏模式的简单描述</b> <div class="spoiler_text"> 这是一组描述服务器本身机制的脚本的名称。 <br> 例如：我们想要现在流行的“皇家战斗”的主题，这意味着名称也应该与游戏的机制相对应。  “玩家在飞机上产生的东西，可以捡起东西，玩家可以交流，不能戴超过1个头盔，等等。”  -所有这些都由服务器上的游戏机制来描述。 <br></div></div><br> 由于大量玩家，服务器端出现了延迟，因为一个玩家吃掉了大约80-120 mb的大量RAM（不计算库存，技能等项目），而客户端则大幅减少了第一人称射击 <br><br>  CPU能力不足以进行物理处理，因此必须使用物理属性较少的对象。 <br><br> 此外，还有我们自己编写的脚本，这些脚本根本没有进行优化。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca9/5c2/4f2/ca95c24f21b7f1011fb654065eb2b8ef.png" alt="图片"><br><br> 首先，当然，我们阅读了有关Lua中优化的文章。 即使<s>自杀</s> ，他们也想用C ++编写DLL，但是从服务器将DLL下载到客户端时出现了问题。 使用DLL的C ++，您可以编写一个安静地拦截数据的程序； Gmod开发人员为客户端的异常下载添加了扩展名（安全性，尽管实际上从未发生过）。 尽管这将使Gmod变得更加方便和灵活，但是会更加危险。 <br><br> 接下来，我们查看了事件探查器（幸运的是，聪明的人写了它），这些函数令人恐惧，注意到最初在Gmod引擎库中已经有非常慢的函数。 <br><br> 如果您尝试用Gmod编写，那么您将清楚地知道内置了一个称为math的库。 <br><br> 最慢的功能当然是math.Clamp和math.Round。 <br><br> 在人员代码中反复翻阅，人们注意到这些函数是朝不同的方向抛出的，几乎在所有地方都使用了它，但是错误地使用了它！ <br><br>  <u>让我们开始练习。</u> 例如，我们要舍入位置向量的坐标以移动实体（例如，玩家）。 <br><br><pre><code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> x = <span class="hljs-number"><span class="hljs-number">12.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> y = <span class="hljs-number"><span class="hljs-number">14.9122133</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> z = <span class="hljs-number"><span class="hljs-number">12.111</span></span> LocalPlayer():SetPos( Vector( Math.Round(x), Math.Round(y), Math.Round(z) )</code> </pre> <br>  3个复杂的舍入函数，但是没什么大不了的，除非当然是循环且不经常使用，但是Clamp更加困难。 <br><br> 以下代码经常用于项目中，没有人愿意更改任何内容。 <br><br><pre> <code class="lua hljs">self:setLocalVar(<span class="hljs-string"><span class="hljs-string">"hunger"</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.Clamp(current + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>))</code> </pre><br> 例如，自我指向玩家的对象，并且拥有一个我们发明的局部变量，当重置到服务器时，该局部变量将重置为math.Clamp本质上是作为循环进行平滑分配，他们希望在Clamp上实现平滑接口。 <br><br> 当它对访问服务器的每个玩家起作用时，就会出现问题。 极少数情况，但如果5-15（立即取决于服务器配置）在某个时间点进入服务器，并且此小而简单的功能开始对每个人都起作用，则服务器将具有良好的CPU延迟。 如果math.Clamp处于循环中，则情况更糟。 <br><br> 优化实际上非常简单，您可以将重载功能本地化。 看起来很原始，但在3游戏模式和许多附加组件中，我看到了此缓慢的代码。 <br><br> 如果您需要获取价值并在将来使用它，并且它不会改变，则无需再次获取它。 毕竟，无论如何，进入服务器的玩家都会收到等于100的饥饿感，因此此代码的速度要快许多倍。 <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> value = <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.Clamp(current + <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) self:setLocalVar(<span class="hljs-string"><span class="hljs-string">"hunger"</span></span>, value)</code> </pre><br> 一切都很好，他们开始进一步研究它的工作原理。 结果，我们开始疯狂地优化一切。 <br><br> 我们注意到循环的标准很慢，因此我们决定想出自己的自行车，速度会更快（我们并没有忘记二十一点），然后游戏开始了。 <br><br><img src="https://habrastorage.org/getpro/habr/post_images/989/1a7/d62/9891a7d62cc782069db99995886f381e.jpg" alt="图片"><br><br><div class="spoiler">  <b class="spoiler_title">扰流板</b> <div class="spoiler_text"> 我们甚至设法在Lua Gmod上进行了最快的循环，但是条件是必须有100个以上的元素。 <br></div></div><br> 从花费在循环上的时间及其在代码中的使用来判断，我们徒劳地尝试执行此操作，因为它仅在抛出并清除异常后才在异常图的生成中找到应用程序。 <br>  <u>这样的代码。</u> 例如，您需要找到所有在别名开头都带有名称的实体，我们在此类名称中存在异常。 <br><br> 这是Lua Gmod上的普通脚本： <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> anomtable = ents.FindByClass(<span class="hljs-string"><span class="hljs-string">"anom_*"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(anomtable) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> v:Remove() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br> 这是给吸烟者的： <br><br> 显而易见的是，这样的<s>g *</s>代码<s>显然</s>比标准的“成对使用”要慢，但事实证明并非如此。 <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> b, key = ents.FindByClass(<span class="hljs-string"><span class="hljs-string">"anom_*"</span></span>), <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span> key = <span class="hljs-built_in"><span class="hljs-built_in">next</span></span>(b, key) b[key]:Remove() <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> key != <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre><br><br> 为了全面分析这些循环选项，您需要将它们转换为常规的Lua脚本。 <br> 例如，omomtable将具有5个元素。 <br> 删除由通常的添加替换。 最主要的是要看到用于实现for循环的两个选项之间指令数量的差异。 <br><br> 香草周期： <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> anomtable = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> k, v <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-built_in"><span class="hljs-built_in">pairs</span></span>(anomtable) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> v = v + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br> 我们的很棒： <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> b, key = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span> }, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">repeat</span></span> key = <span class="hljs-built_in"><span class="hljs-built_in">next</span></span>(b, key) b[key] = b[key] + <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">until</span></span> key ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre><br> 让我们看一下解释器代码（ <b>就像汇编器一样，不建议将它看做是高级程序员</b> ）。 <br><br>  <u>以防万一，从屏幕上删除琼斯。</u>  <u>我警告过</u> <br><br><div class="spoiler">  <b class="spoiler_title">香草循环拆装机</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">; Name: for1.lua ; Defined at line: 0 ; #Upvalues: 0 ; #Parameters: 0 ; Is_vararg: 2 ; Max Stack Size: 7 1 [-]: NEWTABLE R0 5 0 ; R0 := {} 2 [-]: LOADK R1 K0 ; R1 := 1 3 [-]: LOADK R2 K1 ; R2 := 2 4 [-]: LOADK R3 K2 ; R3 := 3 5 [-]: LOADK R4 K3 ; R4 := 4 6 [-]: LOADK R5 K4 ; R5 := 5 7 [-]: SETLIST R0 5 1 ; R0[(1-1)*FPF+i] := R(0+i), 1 &lt;= i &lt;= 5 8 [-]: GETGLOBAL R1 K5 ; R1 := pairs 9 [-]: MOVE R2 R0 ; R2 := R0 10 [-]: CALL R1 2 4 ; R1,R2,R3 := R1(R2) 11 [-]: JMP 13 ; PC := 13 12 [-]: ADD R5 R5 K0 ; R5 := R5 + 1 13 [-]: TFORLOOP R1 2 ; R4,R5 := R1(R2,R3); if R4 ~= nil then begin PC = 12; R3 := R4 end 14 [-]: JMP 12 ; PC := 12 15 [-]: RETURN R0 1 ; return</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">自行车拆装机</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">; Name: for2.lua ; Defined at line: 0 ; #Upvalues: 0 ; #Parameters: 0 ; Is_vararg: 2 ; Max Stack Size: 6 1 [-]: NEWTABLE R0 5 0 ; R0 := {} 2 [-]: LOADK R1 K0 ; R1 := 1 3 [-]: LOADK R2 K1 ; R2 := 2 4 [-]: LOADK R3 K2 ; R3 := 3 5 [-]: LOADK R4 K3 ; R4 := 4 6 [-]: LOADK R5 K4 ; R5 := 5 7 [-]: SETLIST R0 5 1 ; R0[(1-1)*FPF+i] := R(0+i), 1 &lt;= i &lt;= 5 8 [-]: LOADNIL R1 R1 ; R1 := nil 9 [-]: GETGLOBAL R2 K5 ; R2 := next 10 [-]: MOVE R3 R0 ; R3 := R0 11 [-]: MOVE R4 R1 ; R4 := R1 12 [-]: CALL R2 3 2 ; R2 := R2(R3,R4) 13 [-]: MOVE R1 R2 ; R1 := R2 14 [-]: GETTABLE R2 R0 R1 ; R2 := R0[R1] 15 [-]: ADD R2 R2 K0 ; R2 := R2 + 1 16 [-]: SETTABLE R0 R1 R2 ; R0[R1] := R2 17 [-]: EQ 1 R1 K6 ; if R1 == nil then PC := 9 18 [-]: JMP 9 ; PC := 9 19 [-]: RETURN R0 1 ; return</code> </pre> <br></div></div><br> 没有经验的人会简单地说，由于指令较少（15 vs. 19），所以定期循环会更快。 <br><br> 但是我们一定不能忘记解释器中的每个指令都有处理器周期。 <br> 从第一个循环中的反汇编程序代码来看，有一个for循环的预先编写指令可用于处理数组，该数组已加载到内存中，成为全局数组，我们跳过了元素并添加了一个常量。 <br><br> 在第二个变体中，方法有所不同，它更多地基于内存，它接收表，更改元素，设置表，检查nil并再次调用。 <br> 我们的第二个周期很快，因为一条指令中的条件和动作太多（R4，R5：= R1（R2，R3）；如果R4〜= nil则开始PC = 12； R3：= R4结束）它吃了很多东西<s>，</s>吃了CPU时钟周期来执行代码，过去又与内存息息相关。 <br><br> 包含大量元素的forloop指令在所有元素通过的速度上都屈服于我们的周期。 这是由于以下事实：直接寻址到该地址比任何成对的好东西都快。  （我们没有否认） <br><blockquote> 通常，秘密地使用代码中的任何否定都会使它变慢；这已经通过测试和时间进行了测试。 由于处理器ALU具有独立的计算单元“反相器”，因此负逻辑的工作速度会变慢，对于一元操作数（不是！），要工作，您需要访问反相器，这将花费额外的时间。 </blockquote>  <b>结论：</b>一切标准都不会总是更好，您的自行车可能会有用，但是在实际项目中，如果发布速度对您很重要，则不应该提出建议。 结果，我们已经完成了从2014年到今天的全面开发，这是又一次“等待”。 尽管它看起来像是一台普通的游戏服务器，但在1天之内就已安装完毕，并且在2天之内已针对游戏进行了完整配置，但您仍需要能够引入一些新功能。 <br><br> 这个长期项目仍然看到了它本身的第二个版本，其中代码中有很多优化，但是我将在以下文章中讨论其他优化。 支持批评或评论，如果我弄错了，请更正。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN431786/">https://habr.com/ru/post/zh-CN431786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN431766/index.html">火星气候：回到未来</a></li>
<li><a href="../zh-CN431768/index.html">我非常想加入会议的程序委员会，现在就在这里，我们将怎么办？</a></li>
<li><a href="../zh-CN431772/index.html">如何两次单击以使用PayPal或隐私漏洞来查找电子邮件或电话号码所有者的真实姓名？</a></li>
<li><a href="../zh-CN431774/index.html">日本开始以8K格式广播</a></li>
<li><a href="../zh-CN431780/index.html">“头脑在线。” 创建人工智能的局限性</a></li>
<li><a href="../zh-CN431790/index.html">考虑到有特殊需求的用户，如何创建网站或应用程序</a></li>
<li><a href="../zh-CN431792/index.html">面向移动开发人员277的有趣材料的摘要（11月26日至12月2日）</a></li>
<li><a href="../zh-CN431796/index.html">NASA与私人公司签订了开发月球舱的合同</a></li>
<li><a href="../zh-CN431802/index.html">项目经理中的问题人士</a></li>
<li><a href="../zh-CN431804/index.html">如何在DDD中处理异常</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>