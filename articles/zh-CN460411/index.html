<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧞 🍬 🎾 疯狂的转换器GIF'ok为电报的动画贴纸 🔺 ❌ ♻️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="而不是一千个字... 


 xZibit也很高兴，因为这里将GIF插入到贴纸中，然后插入到KDPV的GIF中！ 

 现在介绍实现细节。 

 一切始于在Telegram开发人员的聊天中讨论即将推出的功能： 



 一个男人说-一个男人做到了！ Pillow和svgwrite的第一个原型是在一天...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>疯狂的转换器GIF'ok为电报的动画贴纸</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460411/">  <i>而不是一千个字...</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/z_/rg/73/z_rg73ltg3tgl4zh602urowmjps.gif"></div><br>  <i>xZibit也很高兴，因为这里将GIF插入到贴纸中，然后插入到KDPV的GIF中！</i> <br><br> 现在介绍实现细节。 <br><a name="habracut"></a><br> 一切始于在Telegram开发人员的聊天中讨论即将推出的功能： <br><br><img src="https://habrastorage.org/webt/zu/s5/x1/zus5x1ydd89sejezp98ztbnygto.png" alt="Bohdan Horbeshko，[04/04/19 20:21]嗯，但是该漫游器可能只会接受gif，然后进行转换... |维塔利[07/04/19 20:22]从gif到杰森？我会看的:)））| Bohdan Horbeshko，[04.07.19 20:22]为什么不呢？ JSON中有一个PlayCanvas模型编辑器。 |维塔利，[04/04/19 8:23 p.m。]，gif怎么样？逐像素导出？ :) | Bohdan Horbeshko，[04/04/19 20:24]当然，IT界已经看到并且不会容忍这种扭曲。"><br><br> 一个男人说-一个男人做到了！  Pillow和svgwrite的第一个原型是在一天之内完成的，该原型将GIF解析为像素并将其转换为带有SVG预览的矢量正方形。 <br><br> 有趣的事开始了…… <br><br><h3> 他们说JSON是一种开放格式。 </h3><br> 到现在为止，使用Telegram中的格式，他们一直在欺骗。 支持GIF动画-实际上，它们已转换为MP4视频。 支持贴纸-将它们上传到PNG，但转换为WebP。 这次一切都更加诚实：在入口处，然后在出口处。 <br><br> 对于动画贴纸，Telegram不使用GIF，视频，甚至不使用某些公认的矢量图形格式，例如SVG，或者上帝禁止克苏鲁！  -快闪 它使用一种新的格式，这种格式出现在Airbnb-Lottie的机翼之下。 到目前为止，他在移动开发人员中享有一定的声誉，但是由于Telegram的支持，它可能会越来越受欢迎。 <br><br> 本质上，Lottie文件是JSON序列化的Adobe After Effects项目，可最大程度地利用此程序的所有功能。 遗憾的是，有了显示器， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一切都变得不那么乐观了</a> 。 尽管有很多现成的“官方”库可用于渲染Lottie，但仅适用于Telegram涵盖的平台：Android，iOS，Qt和Web-所有格式中仅部分实现了该格式。  Telegram走得更远，并<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">限制了</a>受支持功能<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的</a>列表，并以其自身的格式“出现”，这与通常的Lottie不同，仅在于打包在GZip和<code>"tgs": 1</code>参数中<code>"tgs": 1</code> 。 我想我知道Denis Popov现在在哪里工作！  :-) <br><br> 而且，如果针对不同平台的库文档一切都很好，那么，a，至少无法找到关于格式设备的某些描述-仅在lottie-web来源中找到<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JSON</a>格式。 为了理解格式的一般概念，我不得不在现有动画中进行修改。 实际文件与方案之间也存在差异：特别是在<a href="">类型4的层中</a> ，根据方案，嵌套对象存储在<code>"it"</code>属性中-但是，在实际文件中，密钥称为<code>"shapes"</code> ，而<code>"it"</code>不起作用。 <br><br> 格式的细微差别： <br><br><ul><li> 文件由图层组成。 与GIF不同，这里的每一层可以有任意的显示开始和结束时间。 可以对图层应用各种变换（更确切地说， <b>这是必要的</b> ）：缩放，旋转，更改透明度等。 图层甚至可以是三维的（禁止电报）。 </li><li> 一层由“形状”组成。 它们有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">很多</a>类型，有些不能在Telegram中使用。 实际上，要显示一个图层，它应该包括三种形状：路径（在完成的动画中，通常是<code>"sh"</code>类型-贝塞尔曲线；到目前为止，转换器仅使用<code>"rc"</code>类型-矩形），填充（ <code>"fl"</code>类型）和变换（输入<code>"tr"</code> ）。 </li><li> 您甚至可以包括栅格元素，创建文本图层，以及通过表达式在图层和形状参数之间建立关系。  Telegram也禁止所有这些好东西。 </li></ul><br> 第一个问题从这里直接产生： <b>冗余</b> 。 尽管最近已将转换参数的默认值添加到JSON方案中，但是它们未在库中实现。 因此，明确要求他们仍然是必要的。 <br><br> 看来这根本不是问题吗？ 即使是简单的GZip，也可以很好地压缩公然重复的数据，并且1 MB的原始JSON神奇地变成了几十个千字节，悄悄地爬升到所述的64 kB限制。 在那里！ <br><br> 我加载了，这意味着胖乎乎的动画会在Telegram中平静地显示抽奖网站-在这里，代替模糊的有条件的美丽像素艺术，静态的模糊外观是这样的： <br><br><img src="https://habrastorage.org/webt/vd/10/_x/vd10_xlbyqsapibkpdsqndlplai.png"><br><br> 这是什么？！ 但是事实证明，解压缩的数据显然有<b>1 MB</b>的未指定<b>限制</b> 。  Telegram团队的代表迅速<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">确认了</a>这一点，并宣布将限制增加到2 MB。 <br><br> 即使解决了这些问题，旧版Telegram的用户也无法访问超过1 MB的未压缩数据且不包含转换的标签。 因此，将来可能必须遵守这些限制。 <br><br><h3> 透明度很重要。 </h3><br> 枕头和OpenCV一起可以称为Python中图像处理的行业标准。 此外，它在GIF功能方面也非常清晰：它支持索引颜色并可以访问调色板。 它支持将像素图转换为NumPy数组，这对于生产处理很重要。 甚至收集颜色统计信息！ 但是也有缺点： <br><br><ol><li> 没有获得透明颜色索引的记录方法。 作为临时解决方案，我不得不假设透明色是最常见的，但是在实际的GIF中，情况并非总是如此。 </li><li> 帧之间有延迟的相同之处：枕头仅将帧本身作为图像序列提供，而没有有关延迟的信息。 </li><li> 有时，部分帧会错误地叠加。 </li></ol><br> 因此，我不得不寻找替代品。  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gif2numpy</a>模块充当它。 它针对GIF功能进行了“锐化”处理，可以访问图像和单个帧（包括<abbr title="图形控件扩展">GCE）的</abbr>所有技术属性。 因此，他解决了读取延迟的问题。 <br><br> 事实证明，透明度根本不支持gif2numpy：颜色立即转换为三个通道，其位深度以字节为单位，而无需考虑位深度和保存颜色索引。 幸运的是，该模块包含一个文件，因此不难将其包含在项目中，并通过保留颜色<code>#FE00FE</code>保持透明来<code>#FE00FE</code>进行修改。 <br><br> 部分框架问题并非微不足道。  gif2numpy <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">尝试将</a>这样的帧<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">覆盖</a>在前一帧上，但是它不检查overlay参数，这就是为什么总是不能得出正确结果的原因。 为了不弄乱标记， <code>--unoptimize</code>使用带有<code>--unoptimize</code>键的<code>gifsicle</code>初步图像处理-将部分帧转换为完整帧。 同时，这导致他们使用全局调色板，从而消除了在使用自己的框架调色板时分别处理透明颜色的需要。 <br><br><h3> 用力挤压我 </h3><br> 正方形是不错的选择，但是在这样的限制下，您需要表现出更多的想象力，否则，即使是微型GIF也不会“爬行”到Telegram中。 <br><br>  <abbr title="游程编码">首先使用</abbr>类似于<abbr title="游程编码">RLE的方法</abbr> ：将水平相邻的相同颜色的正方形合并为一个矩形。 <br><br> 接下来是利用Lottie功能。 由于每一层都有一个任意的开始和结束时间，因此您可以应用一种视频编解码器早已使用的技术，部分用于GIF本身：可以将保留在同一位置几帧的正方形合并为一层，在此期间显示更改其他几个。 到目前为止，仅对成对的相邻层实施。 <br><br><h3> 发展计划 </h3><br> 可以在这里大量应用的想法： <br><br><ul><li>  <b>识别任何大小的单色区域。</b> 您可以将它们分成一组矩形，为此，有一个<a href="">很好的算法</a> 。 也建议将它们转换为轮廓，但是由于需要在Lottie中指示Bezier曲线的所有点而被遮盖了-在某些情况下，矩形可能更有益。 </li><li>  <b>识别运动。</b> 同样，该技术早已在视频编解码器中使用。 如果同一轮廓不会改变帧与帧的形状，而只是改变坐标-而不是将其复制到多个图层上，而是将其放置在具有变换的一层上。 </li><li>  <b>识别一个区域与另一个区域的“覆盖”。</b> 一个例子： <br><br><pre> <code class="plaintext hljs">...... .O..O. ...... .OOOO. ......</code> </pre><br> 不同颜色的像素叠加在一种颜色的矩形上。 不必将这个矩形分解为一堆小矩形，也可以将其转换为复杂形状的轮廓，而无需将其覆盖在整个矩形的顶部。 </li><li>  <b>曲线和椭圆的矢量化，渐变的识别。</b> 这会破坏像素的魅力，但会提高某些GIF的可压缩性几个数量级。 我保证，甚至在古老的“ Koloboks”中也有渐变！ <img src="https://habrastorage.org/getpro/habr/post_images/98f/cc9/e83/98fcc9e832a79a6a2ffeb8f7fd2a64ae.gif" alt="：D"></li><li>  <b>有损压缩。</b> 首先，消除抖动，即使在过于平滑的图像中，也不会妨碍色彩的适度。 前面提到的文章可能会解决这个问题。 </li></ul><br><h3> 参考文献 </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">资料来源</a> 。 在地方吓人。 </li><li> 我上传成功转换的GIF包<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">的渠道</a> 。 </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN460411/">https://habr.com/ru/post/zh-CN460411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN460397/index.html">WebComponents快速入门</a></li>
<li><a href="../zh-CN460399/index.html">Vue.js上的SVG加载指示器</a></li>
<li><a href="../zh-CN460403/index.html">HugePages的优缺点</a></li>
<li><a href="../zh-CN460405/index.html">为什么需要隐藏的游戏机制</a></li>
<li><a href="../zh-CN460409/index.html">Arduino和键盘（完整指南）</a></li>
<li><a href="../zh-CN460413/index.html">7个有用的英语学习网站和应用程序</a></li>
<li><a href="../zh-CN460415/index.html">Apple Watch 4（44毫米，2019年）与Pebble Steel Classic（2014年）</a></li>
<li><a href="../zh-CN460419/index.html">烟气余热回收：环保</a></li>
<li><a href="../zh-CN460421/index.html">面向服务提供商的TP-Link T2600G-28SQ光开关：详细审查</a></li>
<li><a href="../zh-CN460423/index.html">PostgreSQL中的WAL：3。检查点</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>