<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèùÔ∏è üéà üë®üèª‚Äçüé® Pisahkan metode logging di Java / logback „ÄΩÔ∏è üèß üôå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tantangan 


 Katakanlah kita ingin mencatat setiap metode kelas Java tertentu secara berbeda: 


- Setiap metode memiliki file log sendiri, 
- ... fo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pisahkan metode logging di Java / logback</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/463601/"><p><img src="https://habrastorage.org/webt/yo/jt/7_/yojt7_vw5yer5hnszjbyhljpijq.jpeg" alt="Bart menulis beberapa log"></p><br><h2 id="zadacha">  Tantangan </h2><br><p>  Katakanlah kita ingin mencatat setiap metode kelas Java tertentu secara berbeda: </p><br><ul><li>  Setiap metode memiliki file log sendiri, </li><li>  ... format log Anda, </li><li>  ... tingkat minimum penebangannya, </li><li> kami memperluas format log dengan <code>%</code> kami sendiri, </li><li>  kemampuan untuk memperbarui konfigurasi ini dengan cepat. </li></ul><a name="habracut"></a><br><p>  Artikel ini menunjukkan cara memenuhi persyaratan ini.  Untuk menjaga kesederhanaan, pemisahan penebangan hanya dilakukan dengan metode;  pada kenyataannya, Anda mungkin ingin memiliki konfigurasi kualifikasi hierarkis, seperti <code></code> ‚Üí <code></code> ‚Üí <code></code> ‚Üí <code></code> ... Tautan ke kode sumber lengkap akan berada di bawah. </p><br><h2 id="klientskiy-kod">  Kode klien </h2><br><pre> <code class="java hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThingService</span></span></span><span class="hljs-class"> </span></span>{ log = LoggerFactory.getLogger(); getThing() { log.debug(<span class="hljs-string"><span class="hljs-string">"getThing..."</span></span>); <span class="hljs-comment"><span class="hljs-comment">// =&gt; one.log } listThings() { log.debug("listThings..."); // =&gt; another.log } }</span></span></code> </pre> <br><h2 id="logback">  Logback </h2><br><p>  Untuk implementasinya, pustaka logging "logback" yang solid telah dipilih, yang memberikan kemungkinan menarik untuk kustomisasi: </p><br><pre> <code class="plaintext hljs">ch.qos.logback:logback-classic:1.2.3</code> </pre> <br><p>  Ini dikonfigurasi baik dari konfigurasi XML dan langsung dari Jawa, pendekatan dapat digabungkan: </p><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configureLogback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> JoranException </span></span>{ LoggerContext lc = LoggerFactory.getILoggerFactory(); lc.reset(); <span class="hljs-comment"><span class="hljs-comment">// reset prev config JoranConfigurator configurator = new JoranConfigurator(); configurator.setContext(lc); configurator.doConfigure("config.xml"); // any data source StatusPrinter.printInCaseOfErrorsOrWarnings(lc); //   : Logger root = LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME); root.setLevel(Level.INFO); //  }</span></span></code> </pre> <br><p>  Secara singkat tentang pencatatan: </p><br><ol><li>  Programmer menarik <em>logger</em> , </li><li>  Logger menarik <em>appenders yang</em> ditugaskan kepadanya, </li><li>  Appender berpikir dan memanggil <em>pembuat</em> kode, </li><li>  Encoder memformat tepat satu baris log, </li><li>  Untuk melakukan ini, ia menarik rantai <em>konverter</em> , yang masing-masing mengungkapkan <code>%</code> , </li><li>  Sukses </li></ol><br><p>  Untuk mempermudah, konfigurasi Java murni dipilih.  Semuanya cukup jelas di sini jika Anda mengingat konfigurasi XML.  Tugas utama adalah membuat appender / encoder Anda sendiri dan mendaftarkannya - mereka akan dipanggil oleh logback dari usus mereka.  Hampir setiap objek yang Anda buat harus diingat untuk mulai menggunakan metode <code>start()</code> .  Contoh abstrak: </p><br><pre> <code class="java hljs"> Logger rootLogger = LoggerFactory.getLogger(Logger.ROOT_LOGGER_NAME); LoggerContext lc = rootLogger.getLoggerContext(); lc.reset(); <span class="hljs-comment"><span class="hljs-comment">// reset prev config var encoder = new PatternLayoutEncoder(); encoder.setContext(lc); encoder.setPattern("%-5level %message%n"); encoder.start(); var appender = new ConsoleAppender&lt;ILoggingEvent&gt;(); appender.setContext(lc); appender.setEncoder(encoder); appender.start(); rootLogger.setLevel(Level.DEBUG); rootLogger.addAppender(appender);</span></span></code> </pre> <br><h2 id="otdelyaem-loggiruemye-metody-drug-ot-druga">  Pisahkan metode login dari satu sama lain </h2><br><p>  Agar logback dapat membedakan satu metode dari yang lain, sebelum memanggil metode tersebut, simpan namanya dalam Konteks Diagnostik <code>ThreadLocal</code> Mapped.  Lebih lanjut, selama analisis, kami tidak mendapatkan nilai-nilai ini langsung dari kelas <code>MDC</code> , karena kode logging akan dieksekusi di utas lainnya dan data ini tidak akan ada di sana - kami mendapatkannya melalui <code>ILoggingEvent.getMDCPropertyMap()</code> . </p><br><p>  Dalam kasus umum, seperti yang dicatat oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">vooft</a> dengan benar, Anda perlu mendukung tumpukan panggilan dan tidak menimpa nilai MDC, tetapi mengembalikannya ke bingkai sebelumnya, yang dilakukan melalui pengenalan <code>ThreadLocal</code> baru.  Contoh skematis: </p><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { MDC.put(MDC_KEY_METHOD, currentMethod); <span class="hljs-comment"><span class="hljs-comment">// 1.  currentMethod    // 2.    // 3.       AOP, . } finally { String previousMethod = //     MDC.put(previousMethod); }</span></span></code> </pre> <br><h2 id="svoy-log-fayl-na-kazhdyy-metod">  File log sendiri untuk setiap metode </h2><br><p>  Ayo buat dan jangan lupa untuk mendaftarkan appender Anda sendiri: </p><br><pre> <code class="java hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MultiAppender</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppenderBase</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ILoggingEvent</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">append</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ILoggingEvent event)</span></span></span><span class="hljs-function"> </span></span>{ method = event.getMDCPropertyMap().get(MDC_KEY_METHOD); Appender appender = getOrCreateAppender(method); appender.doAppend(event); }</code> </pre> <br><p>  Dia sendiri hampir tidak melakukan apa-apa, hanya delegasi yang masuk ke paket file nyata, satu untuk setiap metode.  Didelegasikan ke satu, yang paling cocok.  Appenden "asli" dibuat atas permintaan, sebagai berikut: </p><br><pre> <code class="java hljs"> fileAppender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileAppender&lt;ILoggingEvent&gt;(); fileAppender.setContext(lc); fileAppender.setAppend(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); fileAppender.setEncoder(getOrCreateEncoderByMethod(lc, method)); fileAppender.setFile(logFileByMethod.get(method)); fileAppender.start();</code> </pre> <br><h2 id="svoy-format-na-kazhdyy-metod">  Format sendiri untuk setiap metode </h2><br><p>  Untuk melakukan ini, simpan cache dari objek <code>Encoder</code> dibuat secara otomatis: </p><br><pre> <code class="java hljs"> Map&lt;String, String&gt; patternByMethod = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-comment"><span class="hljs-comment">//  ;  Encoder getOrCreateEncoderByMethod(LoggerContext lc, String method) { String pattern = patternByMethod.get(method); encoder = new PatternLayoutEncoder(); encoder.setContext(lc); encoder.setPattern(pattern); encoder.start(); return encoder; }</span></span></code> </pre> <br><h2 id="kazhdomu-metodu-svoy-uroven-loggirovaniya">  Setiap metode memiliki tingkat pencatatannya sendiri </h2><br><p>  <code>MultiAppender</code> menambahkan tanda centang ke kelas <code>MultiAppender</code> : jika tingkat peristiwa <code>MultiAppender</code> ambang yang ditentukan untuk metode ini, hanya kami yang mencatatnya: </p><br><pre> <code class="java hljs"> Map&lt;String, Level&gt; levelByMethod = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">append</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ILoggingEvent event)</span></span></span><span class="hljs-function"> </span></span>{ Level minLevel = levelByMethod.get(methodName); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (event.getLevel().levelInt &gt;= minLevel.levelInt) { appender.doAppend(event); }</code> </pre> <br><p>  Pada prinsipnya, logika ini bisa dimasukkan ke dalam filter. </p><br><h2 id="rasshirenie-formata-svoimi-peremennymi">  Memperluas format dengan variabel Anda </h2><br><p>  Agar tidak memagari taman Anda, tetapi untuk mengambil keuntungan dari infrastruktur logback yang telah terbukti, Anda perlu menentukan kelas konverter Anda sendiri, pastikan untuk sepenuhnya publik sehingga dapat dipakai dari luar.  Jika Anda membutuhkan <code>MDC</code> , ambil dari acara tersebut.  <code>%custom</code> Handler variabel <code>%custom</code> dimulai di sini: </p><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomConverter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassicConverter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ILoggingEvent event)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// mdc = event.getMDCPropertyMap(); return "variable-expanded"; } }</span></span></code> </pre> <br><p>  Selama proses konfigurasi umum, daftarkan handler: </p><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configurePatterns</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LoggerContext lc)</span></span></span><span class="hljs-function"> </span></span>{ Map&lt;String, String&gt; rules = lc.getObject(CoreConstants.PATTERN_RULE_REGISTRY); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rules == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { rules = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, String&gt;(); lc.putObject(CoreConstants.PATTERN_RULE_REGISTRY, rules); } rules.put(<span class="hljs-string"><span class="hljs-string">"custom"</span></span>, CustomConverter.class.getName()); }</code> </pre> <br><p>  Dan kita akan gunakan sebagai pembuat enkode, misalnya, <code>PatternLayoutEncoder</code> , yang akan mengambil semuanya.  Dalam kasus ini, <code>%custom</code> variabel <code>%custom</code> akan diperluas ke string <code>"variable-expanded"</code> . </p><br><h2 id="obnovlenie-konfiga-na-letu">  Konfigurasikan pembaruan dengan cepat </h2><br><p>  Ada peluang seperti itu di luar kotak: itu sudah cukup untuk memanggil fungsi konfigurator lagi, tidak lupa untuk melakukan <code>LoggerContext::reset()</code> dan menghapus cache yang terakumulasi. </p><br><h2 id="mnogopotochnost">  Multithreading </h2><br><p>  Jika metode yang dikonfigurasikan oleh kami menghidupkan kembali utas, maka, tentu saja, aturan pencatatan yang ditentukan tidak akan berlaku bagi mereka - utas lokal tidak akan muncul sendiri di utas baru.  Jadi, jika Anda ingin menerapkan pengaturan metode ke aliran baru, Anda harus menyalin <code>MDC</code> sana: </p><br><pre> <code class="java hljs"> Map&lt;String, String&gt; mdcOrig = MDC.getCopyOfContextMap(); ExecutorService es = Executors.newFixedThreadPool(<span class="hljs-number"><span class="hljs-number">1</span></span>); es.submit(() -&gt; threadWorker(mdcOrig)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">threadWorker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, String&gt; parentMdc)</span></span></span><span class="hljs-function"> </span></span>{ MDC.setContextMap(parentMdc); log.error(<span class="hljs-string"><span class="hljs-string">"expected to appear in method2*.log"</span></span>); }</code> </pre> <br><h2 id="primer-celikom">  Seluruh contoh </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/zencd/logback-setup</a> </p><br><h2 id="literatura">  Sastra </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Manual Logback Resmi</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id463601/">https://habr.com/ru/post/id463601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id463587/index.html">ConfigureAunggu, siapa yang harus disalahkan dan apa yang harus dilakukan?</a></li>
<li><a href="../id463591/index.html">BlueKeep-2 - semua versi Windows baru sekarang rentan</a></li>
<li><a href="../id463595/index.html">Kami mengontrol fokus atau sejumput C # dan STM32 untuk webcam</a></li>
<li><a href="../id463597/index.html">Menggunakan Context API in React untuk membuat desain aplikasi yang responsif</a></li>
<li><a href="../id463599/index.html">"Ini adalah mimpi buruk": para astronot berbagi pendapat tentang kesalahan yang dilakukan Hollywood ketika membuat film tentang ruang</a></li>
<li><a href="../id463605/index.html">Intelektual teknis - dari luar angkasa</a></li>
<li><a href="../id463607/index.html">Alternatif bawaan redux dengan Bereaksi Konteks dan kait</a></li>
<li><a href="../id463609/index.html">Sistem rekomendasi untuk Directum Club. Bagian Satu, Kolaboratif</a></li>
<li><a href="../id463611/index.html">Plugin yang fantastis, vol. 2. Berlatih</a></li>
<li><a href="../id463613/index.html">Gambar Docker juga dapat dibangun di werf menggunakan Dockerfile biasa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>