<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï† üçÉ ‚§µÔ∏è Virtueller Speicher in ARMv7 ü•õ ‚¨úÔ∏è üë®üèª‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo! 

 Der Artikel beschreibt die Architektur des virtuellen Speichersystems ARMv7. 

 Spoiler √úberschrift  Die Feinheiten von Caching, DMA, LPAE u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Virtueller Speicher in ARMv7</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/422385/">  Hallo! <br><br>  Der Artikel beschreibt die Architektur des virtuellen Speichersystems ARMv7. <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler √úberschrift</b> <div class="spoiler_text">  Die Feinheiten von Caching, DMA, LPAE und dergleichen werden hier nicht ber√ºcksichtigt.  Eine detailliertere Beschreibung finden Sie in der Literatur am Ende des Artikels. <br></div></div><a name="habracut"></a><br><h2>  Einf√ºhrung </h2><br>  Das virtuelle Speichersystem f√ºhrt mehrere Aufgaben aus.  Erstens k√∂nnen Sie Benutzerprozesse in getrennten, voneinander isolierten Speicherbereichen platzieren.  Auf diese Weise k√∂nnen Sie die Zuverl√§ssigkeit des Systems erh√∂hen. Fehler eines Prozesses wirken sich nicht auf den Betrieb anderer Prozesse aus.  Zweitens kann das Betriebssystem dem Prozess mehr Speicher zur Verf√ºgung stellen als das System.  Nicht verwendete Speicherseiten werden in einen permanenten Speicher verschoben, und die erforderlichen Seiten werden von dort geladen, wodurch die Illusion einer gr√∂√üeren Speichermenge entsteht, als sie tats√§chlich ist.  Drittens erleichtert der kontinuierliche virtuelle Raum das Schreiben von benutzerdefinierter Software.  Alle Prozesse werden im selben Bereich ausgef√ºhrt, das Betriebssystem verbirgt die tats√§chliche Speicherkonfiguration im System. <br><br><h2>  Definitionen </h2><br>  Die folgenden Definitionen werden im Artikel verwendet: <br>  Virtuelle Adresse - Die vom Prozessorkern verwendete Adresse.  Der Stapelzeiger, der Befehlsz√§hler und das R√ºckgaberegister verwenden eine virtuelle Adresse. <br>  Physische Adresse - Die Ausgangsadresse auf dem Prozessorbus. <br>  Eine Seite ist eine Einheit zur Adressierung des virtuellen Speichers. <br>  Abschnitt - ein Analogon der Seite, hat eine gr√∂√üere Gr√∂√üe. <br>  Ein Rahmen ist eine Adressierungseinheit f√ºr den physischen Speicher. <br>  Seitentabelle - Ein Array von Datens√§tzen zum √úbersetzen von Adressen. <br>  <abbr title="Adressraum-ID">ASID</abbr> ist die Adressraumkennung. <br>  <abbr title="√úbersetzung Lookaside Buffer">TLB</abbr> - Puffer f√ºr die schnelle √úbersetzung von Adressen. <br>  <abbr title="Speicherverwaltungseinheit">MMU</abbr> ist eine Speicherverwaltungseinheit. <br><br><h2>  TLB </h2><br>  TLB ist ein sehr schneller Hardware-Puffer, der die Ergebnisse der neuesten Adress√ºbersetzungen enth√§lt.  Die Kernelanforderung zum √úbersetzen der Seitenadresse und der aktuellen ASID kommt im TLB an.  Wenn dort ein g√ºltiger Eintrag vorhanden ist, werden die Berechtigungen zum Zugriff auf diesen Speicher √ºberpr√ºft, die Zugriffsmethode und die entsprechende Rahmenadresse an die MMU zur√ºckgegeben.  Wenn der Speicherzugriff verweigert wird, wird eine Hardware-Ausnahme ausgel√∂st.  Wenn ein TLB-Fehler aufgetreten ist (es wurde kein Datensatz gefunden), unterscheidet das weitere Verhalten von TTBCR zwischen Gro√ü- und Kleinschreibung.  Eine Suche kann in den Seitentabellen durchgef√ºhrt werden oder eine Ausnahme wird ausgel√∂st. <br><br>  Es ist wichtig zu beachten, dass Sie beim Bearbeiten von Seitentabellen den TLB korrekt zur√ºcksetzen m√ºssen, da  Dort k√∂nnen irrelevante Informationen gespeichert werden. <br><br>  Das Aktualisieren von Eintr√§gen im TLB ist f√ºr den Round-Robin-Programmierer transparent. <br>  Es ist auch m√∂glich, einige Eintr√§ge in den TLB hochzuladen und zu sichern, um deren Verdr√§ngung zu verhindern. <br><br><img src="https://habrastorage.org/webt/rt/5y/pi/rt5ypi6o5l1n8yvzl1moompfsny.png" alt="Bild"><br>  <i>Abbildung 1. TLB</i> <br><br><h2>  Seitentabellen </h2><br>  ARMv7 ist eine 32-Bit-Architektur, daher verf√ºgen wir √ºber 4 GB adressierbaren virtuellen Speicher. <br>  Die Seitentabellen sind in zwei Ebenen unterteilt - L1 und L2. <br><br>  Tabelle L1 beschreibt alle 4 GB Adressraum.  Es besteht aus 4096 32-Bit-Datens√§tzen, von denen jeder 1 MB beschreibt.  Eintr√§ge in der Tabelle werden durch die hohen 12 Bits der virtuellen Adresse ausgew√§hlt. <br><br><img src="https://habrastorage.org/webt/fi/yg/ud/fiygudienjoeqqzqayx1gjhmm9m.png" alt="Bild"><br>  <i>Abb.</i>  <i>2 Suchen Sie nach Eintr√§gen in Tabelle L1</i> <br><br>  Tabelle L1 befindet sich im physischen Speicher und ist an einem 16-KB-Rand ausgerichtet.  F√ºr diese Eintr√§ge gibt es 4 Optionen: zum Beschreiben von Seiten, Abschnitten und Unterabschnitten.  Nun, ein leerer Datensatz f√ºr Speicher, der noch nicht zugeordnet ist. <br><br><img src="https://habrastorage.org/webt/pg/25/_k/pg25_kieahrtebnqw7qtau7fdq0.png" alt="Bild"><br>  <i>Abb.</i>  <i>3 Arten von Eintr√§gen in L1</i> <br><br>  Die Bits 0 und 1 geben den Datensatztyp 00b-Fehler an, 01b ist der Seitendeskriptor, 10b ist der Abschnittsdeskriptor (und der √úberabschnitt). <br><br>  Wenn der physische Speicher paginiert ist, speichert die Tabelle L1 die Adresse der Tabelle L2 (physisch, ausgerichtet auf 1 KB).  Bit 9 wird vom Hersteller bestimmt (Implementierung definiert), Bits [8: 5] - f√ºr den Dom√§nenmechanismus (in ARMv7 veraltet), SBZ - Nullen. <br><br>  Wenn wir den Speicher in Abschnitte unterteilen m√∂chten, muss in L1 die entsprechende physikalische Adresse geschrieben werden.  Der Abschnitt bezieht sich direkt auf den ausgerichteten physischen Speicherbereich von 1 MB.  Keine Notwendigkeit f√ºr Tabelle L2.  Supersection ist ein Sonderfall der Partitionierung. Der Eintrag in der L1-Tabelle sollte 16 Mal wiederholt werden. Die Ausrichtung der zugewiesenen Bl√∂cke des physischen und virtuellen Speichers betr√§gt ebenfalls 16 MB. <br><br>  Tabelle L2 besteht aus 256 Eintr√§gen mit 32 Bit.  Es sollte auf 1 KB ausgerichtet sein. <br><br><img src="https://habrastorage.org/webt/b9/ik/bj/b9ikbjt3gsmcuekx-wofiseptwi.png" alt="Bild"><br>  <i>Abb.</i>  <i>4 Suchen Sie nach Eintr√§gen in Tabelle L2</i> <br><br>  Die Indizes in Tabelle L2 werden aus den durchschnittlichen 8 Bits [19:12] der virtuellen Adresse gebildet.  Jeder Tabelleneintrag enth√§lt die Adresse des Frames. <br><br><img src="https://habrastorage.org/webt/cd/hh/vl/cdhhvl4c4rfl3fnqrmoslorfcka.png" alt="Bild"><br>  <i>Abb.</i>  <i>5 Arten von Eintr√§gen in L2</i> <br><br>  Seiten k√∂nnen zwei Gr√∂√üen haben: 64 KB (gro√üe Seite) und 4 KB (kleine Seite). <br>  Die AP- und APX-Bits setzen Lese- / Schreibberechtigungen im privilegierten / nichtprivilegierten Modus (Kernel / Benutzer).  Die TEX-, C-, B-, S-Bits sind f√ºr den Speichertyp, dessen Caching und Lese- / Schreibpufferung verantwortlich.  Das nG - nonGlobal-Bit erm√∂glicht den Zugriff auf die Seite f√ºr alle Prozesse oder nur f√ºr eine bestimmte ASID. <br><br>  Durch die Verwendung gro√üer Seiten wird die Anzahl der Eintr√§ge im TLB reduziert.  Anstelle von 16 Eintr√§gen (4Kb * 16 = 64Kb) wird dort nur einer gespeichert.  In Tabelle L2 m√ºssen jedoch 16 identische Eintr√§ge eingetragen werden. <br><br>  Die F√§higkeit, unterschiedliche Blockgr√∂√üen zu adressieren, erm√∂glicht es einerseits, Speicher mit der gew√ºnschten Granularit√§t zuzuweisen, andererseits die Anzahl der Aufrufe von Seitentabellen in einem relativ langsamen Speicher zu reduzieren. <br><br><h2>  Register </h2><br>  Zur Steuerung des Systems (einschlie√ülich der MMU) in der ARM-Architektur wurde ein spezieller CP15-Coprozessor entwickelt.  Zur Speicherverwaltung geh√∂ren anderthalb Dutzend seiner Register.  Wir sind an mehreren interessiert - Control, TTBR0 / 1, TTBCR, ContextID. <br><br>  Im Steuerregister ist das niedrigstwertige Bit f√ºr das Ein- und Ausschalten der MMU verantwortlich, alles ist einfach. <br><br>  Das Registerpaar TTBR0 / 1 enth√§lt die physikalischen Adressen der Tabellen der ersten Ebene.  An diesen Adressen beginnt die MMU mit der Suche nach der gew√ºnschten Seite. <br><br>  Mit dem TTBCR-Register k√∂nnen Sie den gesamten Adressraum in zwei Teile zwischen TTBR0 und TTBR1 aufteilen.  Jeder von ihnen sendet seinen Teil der Adressen.  Bits [2: 0] werden zum Einstellen der Gr√∂√üe verwendet.  Die aufgezeichnete Zahl (von 0 bis 7 Dezimalstellen) maskiert den √§lteren Teil der virtuellen Adressen.  Wenn der Wert "0" ist, werden alle Adressen √ºber TTBR0 gesendet.  Wenn "1", werden 31-Bit-Adressen maskiert und die unteren 2 GB virtuellen Speicherplatzes durchlaufen TTBR0, die oberen √ºber TTBR1.  "2" - 31 und 30 Bit werden maskiert und die Aufteilung in 1 GB bzw. 3 GB wird erhalten.  Somit kann der untere Teil der Adressen f√ºr Benutzeranwendungen verwendet werden, wodurch das TTBR0-Register f√ºr einen neuen Prozess √ºberlastet wird, und der obere Teil kann f√ºr Systemanforderungen belassen werden. <br><br><img src="https://habrastorage.org/webt/yp/fp/so/ypfpsohyn943gmkrfz7fmrm1z30.png" alt="Bild"><br>  <i>Abb.</i>  <i>6 Adressraum teilen</i> <br><br>  Bits [5: 4] sind f√ºr das TLB-Fehlerverhalten verantwortlich - Suche in Seitentabellen oder eine Ausnahme. <br>  Das ContextID-Register enth√§lt das ASID-Feld f√ºr den aktuellen Prozess.  Sie muss zusammen mit dem Inhalt des Registers TTBR0 ge√§ndert werden, wenn der Kontext ge√§ndert wird. <br><br><h2>  Adress√ºbersetzung </h2><br>  Der Algorithmus zum Konvertieren virtueller Adressen in physische Adressen lautet wie folgt: <br><br><ul><li>  Suchen Sie im TLB-Puffer nach der angeforderten virtuellen Adresse und ASID </li><li>  Wenn der TLB nicht die erforderliche Adresse hat, wird in den Seitentabellen eine Hardware-Suche durchgef√ºhrt </li></ul><br>  Wenn der Kernel zuvor eine virtuelle Seite angefordert hat, wird diese im TLB gespeichert.  In diesem Fall holt die MMU es aus dem Cache und es muss nichts getan werden.  Wenn die Seite zum ersten Mal angefordert wird (oder von dort herausgedr√ºckt wurde - der TLB ist nicht sehr gro√ü), wird die Suche in den Tabellen L1-L2 durchgef√ºhrt.  Somit ist die Zuordnung der virtuellen und physischen Adressen wie folgt: <br><ul><li>  Im Register TTBR0 \ TTBR1 wird die Adresse der Tabelle L1 gesucht. </li><li>  Die oberen 10 Bits der virtuellen Adresse bilden einen Index in der Tabelle. </li><li>  a) Wenn der Datensatz dem Abschnitt (√úberabschnitt) entspricht, werden die Attribute des Abschnitts √ºberpr√ºft, und wenn alles in Ordnung ist, setzt sich die resultierende physikalische Adresse aus der Basisadresse des Abschnitts (√úberabschnitt) und den mindestens 20 (24) Bits der virtuellen Adresse zusammen. <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler √úberschrift</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/v_/ay/fk/v_ayfkww22u6szvud73uwehhmne.png" alt="Bild"><br>  <i>Abb.</i>  <i>7 Adress√ºbersetzung in Supersection</i> <br></div></div><br>  b) Wenn der Datensatz eine Tabelle L2 ist, wird die Suche darin fortgesetzt.  Der mittlere Teil der virtuellen Adresse der Seite bildet den Index der Tabelle. <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler √úberschrift</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dz/5c/j9/dz5cj9mw-p9r07bvdhxwqm_3a2a.png" alt="Bild"><br>  <i>Abb.</i>  <i>8 Adress√ºbersetzung in Tabelle L2</i> <br></div></div><br></li><li>  TLB-Update l√§uft </li></ul><br>  Insgesamt besteht das virtuelle Speichersubsystem aus folgenden Teilen: <br><br><ul><li>  Mehrere CP15-Steuerregister </li><li>  Seitentabellen mit Adress√ºbersetzungsregeln </li><li>  TLB - Cache erfolgreicher Sendungen </li><li>  MMU ist eine Adress√ºbersetzungseinheit. </li></ul><br><h2>  Literatur </h2><br>  ARM Architecture Referenzhandbuch ARMv7-A und ARMv7-R Edition <br>  Programmierhandbuch f√ºr die ARM Cortex-A-Serie </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de422385/">https://habr.com/ru/post/de422385/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de422375/index.html">Vertr√§ge sind anders oder was Sie unterschrieben haben</a></li>
<li><a href="../de422377/index.html">ESP8266 + FLProg - Benutzersystemparameter und Synchronisation mit dem genauen Zeitserver</a></li>
<li><a href="../de422379/index.html">Wie ich gegen Diebstahl gek√§mpft habe ... mit PHP</a></li>
<li><a href="../de422381/index.html">TOP 10 ICO 2018 Q3 (Abstimmung)</a></li>
<li><a href="../de422383/index.html">Es ist nicht schwer f√ºr den Roboter: Wie die Postlogistik intelligenter wird</a></li>
<li><a href="../de422389/index.html">Die vergessene Kunst des Biegens: Wie man die Wirbels√§ule in anderen Kulturen sch√ºtzt</a></li>
<li><a href="../de422395/index.html">Ein vergessenes neues: Nach Jahren kommt der Nachfolger des MikroTik RB2011 heraus</a></li>
<li><a href="../de422397/index.html">‚ÄûHauptsache, ich habe es bestanden‚Äú: Was und wie werden zuk√ºnftige IT-Spezialisten in Berlin unterrichtet?</a></li>
<li><a href="../de422399/index.html">Der Prozess der Code√ºberpr√ºfung in hh.ru.</a></li>
<li><a href="../de422401/index.html">Ein weiteres C ++ - Plugin-Framework</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>