<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéé üíÜüèΩ ü¶ó MotionLayout: les animations sont meilleures, moins de code üéÑ üßúüèæ ü§πüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Google continue d'am√©liorer nos vies en publiant de nouvelles biblioth√®ques et API pratiques. Parmi eux, le nouveau MotionLayout. Compte tenu de l'abo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MotionLayout: les animations sont meilleures, moins de code</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/458854/"><img src="https://habrastorage.org/webt/wk/q7/cq/wkq7cqwqisgnz3lof9qfobt5bte.png"><br>  <i>Google continue d'am√©liorer nos vies en publiant de nouvelles biblioth√®ques et API pratiques.</i>  <i>Parmi eux, le nouveau MotionLayout.</i>  <i>Compte tenu de l'abondance d'animations dans nos applications, mon coll√®gue C√©dric Holtz a imm√©diatement mis en ≈ìuvre l'animation la plus importante de notre application - voter dans la datation - en utilisant la nouvelle API, tout en √©conomisant une √©norme quantit√© de code.</i>  <i>Je partage la traduction de son article.</i> <br><br>  La conf√©rence Google I / O 2019 s'est r√©cemment termin√©e, au cours de laquelle des mises √† jour et les derni√®res am√©liorations de notre SDK bien-aim√© ont √©t√© annonc√©es.  Personnellement, j'ai √©t√© particuli√®rement int√©ress√© par la pr√©sentation de Nicholas Road et John Hoford sur la future fonctionnalit√© de ConstraintLayout.  Plus pr√©cis√©ment, sur son expansion sous la forme de MotionLayout. <br><br>  Apr√®s la version b√™ta, je voulais impl√©menter une animation de rencontres bas√©e sur cette biblioth√®que. <a name="habracut"></a><br><br>  D√©finissons d'abord les termes: <br><br><blockquote>  "MotionLayout est un ConstraintLayout qui vous permet d'animer des dispositions entre diff√©rents √©tats."  - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation</a> </blockquote><br><br>  Si vous n'avez pas lu une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s√©rie d'articles de</a> Nicholas Road qui explique les id√©es cl√©s de MotionLayout, je vous recommande fortement de le lire. <br><br>  Donc, avec l'introduction faite, voyons maintenant ce que nous voulons obtenir: <br><br><img src="https://habrastorage.org/webt/wm/kb/qm/wmkbqmy_ulwafy_jvkvpadfafyu.gif"><br><br><h2>  Pile de cartes </h2><br><h3>  Nous montrons la carte d√©cal√©e </h3><br>  Pour commencer, ajoutez MotionLayout au r√©pertoire de disposition, qui contient jusqu'√† pr√©sent une seule carte sup√©rieure: <br><br><pre><code class="kotlin hljs">&lt;androidx.constraintlayout.motion.widget.MotionLayout android:id=<span class="hljs-string"><span class="hljs-string">"@+id/motionLayout"</span></span>     xmlns:android=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span>     xmlns:app=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span>     android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>     android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>     app:layoutDescription=<span class="hljs-string"><span class="hljs-string">"@xml/scene_swipe"</span></span>     app:motionDebug=<span class="hljs-string"><span class="hljs-string">"SHOW_ALL"</span></span>&gt;     &lt;FrameLayout         android:id=<span class="hljs-string"><span class="hljs-string">"@+id/topCard"</span></span>         android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>         android:layout_height=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span> /&gt; &lt;/androidx.constraintlayout.motion.widget.MotionLayout&gt;</code> </pre> <br>  Faites attention √† cette ligne: app: motionDebug = "SHOW_ALL".  Il nous permet d'afficher les informations de d√©bogage, la trajectoire des objets, les √©tats avec le d√©but et la fin de l'animation, ainsi que les progr√®s en cours.  La ligne aide beaucoup au d√©bogage, mais n'oubliez pas de la supprimer avant de l'envoyer au prod: il n'y a pas de rappel pour cela. <br><br>  Comme vous pouvez le voir, nous n'avons d√©fini aucune restriction pour la vue ici.  Ils seront extraits de la sc√®ne (MotionScene), que nous d√©finissons maintenant. <br><br>  Commen√ßons par d√©finir l'√©tat initial: une carte se trouve au centre de l'√©cran, avec des retraits autour. <br><br><pre> <code class="kotlin hljs">&lt;MotionScene xmlns:android=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span>    xmlns:app=<span class="hljs-string"><span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span>&gt;    &lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>&gt;        &lt;Constraint            android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            app:layout_constraintEnd_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>            app:layout_constraintStart_toStartOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>&gt;    &lt;/ConstraintSet&gt; &lt;/MotionScene&gt;</code> </pre> <br>  Ajouter des ensembles de contraintes (ConstraintSet) pass et like.  Ils refl√©teront l'√©tat de la carte du dessus lorsqu'elle est compl√®tement d√©cal√©e vers la gauche ou la droite.  Nous voulons que la carte s'arr√™te avant de dispara√Ætre de l'√©cran pour montrer une belle animation qui confirme notre d√©cision. <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/pass"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>&gt;    &lt;Constraint        android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>        android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>        android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"80dp"</span></span>        android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"200dp"</span></span>        android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>        android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"20dp"</span></span>        app:layout_constraintEnd_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>        app:layout_constraintWidth_percent=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> /&gt; &lt;/ConstraintSet&gt; &lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;Constraint        android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>        android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>        android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"80dp"</span></span>        android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>        android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"200dp"</span></span>        android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"20dp"</span></span>        app:layout_constraintStart_toStartOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>        app:layout_constraintWidth_percent=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> /&gt; &lt;/ConstraintSet&gt;</code> </pre><br>  Ajoutez les deux ensembles de contraintes √† la sc√®ne pr√©c√©dente.  Ils sont presque identiques, ne se refl√©tant que des deux c√¥t√©s de l'√©cran. <br><br>  Maintenant, nous avons trois ensembles de restrictions - commencer, aimer et passer.  D√©finissons la transition entre ces √©tats. <br><br>  Pour ce faire, ajoutez une transition vers la gauche pour le balayage, l'autre vers la droite pour le balayage. <br><br><pre> <code class="kotlin hljs">&lt;Transition    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/pass"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"300"</span></span>&gt;    &lt;OnSwipe        app:dragDirection=<span class="hljs-string"><span class="hljs-string">"dragLeft"</span></span>        app:onTouchUp=<span class="hljs-string"><span class="hljs-string">"autoComplete"</span></span>        app:touchAnchorId=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        app:touchAnchorSide=<span class="hljs-string"><span class="hljs-string">"left"</span></span>        app:touchRegionId=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span> /&gt; &lt;/Transition&gt; &lt;Transition    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"300"</span></span>&gt;    &lt;OnSwipe        app:dragDirection=<span class="hljs-string"><span class="hljs-string">"dragRight"</span></span>        app:onTouchUp=<span class="hljs-string"><span class="hljs-string">"autoComplete"</span></span>        app:touchAnchorId=<span class="hljs-string"><span class="hljs-string">"@+id/topCard"</span></span>        app:touchAnchorSide=<span class="hljs-string"><span class="hljs-string">"right"</span></span>        app:touchRegionId=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span> /&gt; &lt;/Transition&gt;</code> </pre><br>  Donc, pour la carte du haut, nous d√©finissons l'animation de balayage √† gauche et la m√™me chose - miroir pour le balayage √† droite. <br><br>  Ces propri√©t√©s aideront √† am√©liorer l'interaction avec notre sc√®ne: <br><br><ul><li>  touchRegionId: depuis que nous avons ajout√© un remplissage autour de la carte, nous devons nous assurer que le toucher n'est reconnu que dans la zone de la carte elle-m√™me, et non dans la totalit√© de MotionLayout.  Cela peut √™tre fait en utilisant touchRegionId. <br></li><li>  onTouchUp: qu'adviendra-t-il de l'animation apr√®s la sortie de la carte?  Il doit continuer ou revenir √† son √©tat initial, donc la saisie semi-automatique est applicable. <br></li></ul><br>  Voyons ce qui s'est pass√©: <br><br><img src="https://habrastorage.org/webt/zs/zq/ox/zszqoxe4dsdpphvu3fro0_3tjtk.gif"><br><br><h3>  La carte dispara√Æt automatiquement de l'√©cran </h3><br>  Nous allons maintenant travailler sur l'animation, qui commencera lorsque la carte dispara√Ætra de l'√©cran. <br><br>  Nous ajoutons deux autres ensembles ConstraintSet pour chaque √©tat final de nos animations: la carte quitte l'√©cran √† gauche et √† droite. <br><br>  Dans les exemples suivants, je montrerai comment cr√©er l'√©tat similaire et l'√©tat de r√©ussite le r√©p√©tera en miroir.  Un exemple de travail peut √™tre enti√®rement vu dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> . <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span>&gt;    &lt;Constraint        android:id=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>        android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>        android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>        android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"80dp"</span></span>        android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>        android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"20dp"</span></span>        app:layout_constraintStart_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>        app:layout_constraintWidth_percent=<span class="hljs-string"><span class="hljs-string">"0.7"</span></span> /&gt;   &lt;/ConstraintSet&gt;</code> </pre> <br>  Maintenant, comme dans l'exemple pr√©c√©dent, vous devez d√©terminer la transition de l'√©tat de balayage √† l'√©tat final.  La transition devrait fonctionner automatiquement imm√©diatement apr√®s l'animation du balayage.  Cela peut √™tre fait en utilisant autoTransition: <br><br><pre> <code class="kotlin hljs">&lt;Transition app:autoTransition=<span class="hljs-string"><span class="hljs-string">"animateToEnd"</span></span> app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span> app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span> app:duration=<span class="hljs-string"><span class="hljs-string">"150"</span></span> /&gt;</code> </pre><br>  Nous avons maintenant une carte magn√©tique qui peut √™tre gliss√©e sur l'√©cran! <br><br><img src="https://habrastorage.org/webt/vt/ip/i0/vtipi0xzpmomh5mlkqpoytwedze.gif"><br><br><h3>  Animation de la carte inf√©rieure </h3><br><br>  Faisons maintenant la carte du bas pour cr√©er l'illusion de l'infini du jeu. <br><br>  Ajoutez une autre carte √† la mise en page, similaire √† la premi√®re: <br><br><pre> <code class="kotlin hljs">&lt;FrameLayout    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/bottomCard"</span></span>    android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>    android:layout_height=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span>    android:background=<span class="hljs-string"><span class="hljs-string">"@color/colorAccent"</span></span> /&gt;</code> </pre> <br>  Modifiez le XML pour d√©finir les restrictions qui s'appliquent √† cette carte √† chaque √©tape de l'animation: <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@id/bottomCard"</span></span>&gt;        &lt;Layout            android:layout_width=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"match_parent"</span></span>            android:layout_marginBottom=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginEnd=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginStart=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span>            android:layout_marginTop=<span class="hljs-string"><span class="hljs-string">"50dp"</span></span> /&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"0.90"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"0.90"</span></span> /&gt;    &lt;/Constraint&gt; &lt;/ConstraintSet&gt; &lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@id/like"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@id/bottomCard"</span></span>&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"1"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"1"</span></span> /&gt;    &lt;/Constraint&gt; &lt;/ConstraintSet&gt;</code> </pre> <br>  Pour ce faire, nous pouvons utiliser la propri√©t√© ConstraintSet. <br><br>  Par d√©faut, chaque nouvel ensemble prend des attributs du MotionLayout parent.  Mais en utilisant l'indicateur deriveConstraintsFrom, vous pouvez d√©finir un autre parent pour notre ensemble.  Il convient de garder √† l'esprit que si nous d√©finissons des contraintes √† l'aide de la balise de contrainte, nous red√©finissons toutes les contraintes de l'ensemble parent.  Pour √©viter cela, vous pouvez d√©finir des attributs sp√©cifiques dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">balises</a> afin que seuls ils soient remplac√©s. <br><br><img src="https://habrastorage.org/webt/vz/ff/zb/vzffzb5u7rlwpayywz7zfm6gnyk.png"><br><br>  Dans notre cas, cela signifie que dans l'ensemble de passes, nous ne d√©finissons pas la balise Layout, mais la copions √† partir du parent.  Cependant, nous rempla√ßons Transform, par cons√©quent, nous rempla√ßons tous les attributs sp√©cifi√©s dans la balise Transform par les n√¥tres, dans ce cas, un changement d'√©chelle. <br><br>  C'est √† quel point il est facile d'utiliser MotionLayout pour ajouter un nouvel √©l√©ment et l'int√©grer de mani√®re transparente aux animations de notre sc√®ne. <br><br><img src="https://habrastorage.org/webt/_-/73/jp/_-73jp-vstz02uondgcnyzwcxqe.gif"><br><br><h3>  Rendre l'animation sans fin </h3><br><br>  Une fois l'animation termin√©e, la carte du haut ne peut pas √™tre gliss√©e, car elle est maintenant devenue une carte du bas.  Pour obtenir une animation sans fin, vous devez √©changer des cartes. <br><br>  Au d√©but, je voulais le faire avec une nouvelle transition: <br><br><pre> <code class="kotlin hljs">&lt;Transition    app:autoTransition=<span class="hljs-string"><span class="hljs-string">"jumpToEnd"</span></span>    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/offScreenLike"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"0"</span></span> /&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/jb/6h/lz/jb6hlzynphpyptximrzq1wgfqfw.gif"><br><br>  L'animation enti√®re joue comme il se doit.  Nous avons maintenant une pile de cartes que vous pouvez glisser √† l'infini! <br><br>  Apr√®s un petit coup, j'ai remarqu√© quelque chose.  La transition vers la fin de l'animation du deck s'arr√™te lorsque vous touchez la carte.  M√™me si la dur√©e de l'animation est nulle, elle s'arr√™te toujours, ce qui est mauvais. <br><br><img src="https://habrastorage.org/webt/yv/nq/mo/yvnqmowevaznpjimh5kbtiplwco.gif"><br><br>  J'ai r√©ussi √† gagner d'une seule mani√®re - en modifiant par programmation la transition active dans MotionLayout. <br><br>  Pour ce faire, nous allons d√©finir un rappel √† la fin de l'animation.  D√®s que offScreenLike et offScreenPass sont termin√©s, nous r√©initialisons simplement la transition √† l'√©tat de repos et annulons la progression. <br><br><pre> <code class="kotlin hljs">motionLayout.setTransitionListener(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : TransitionAdapter() {    <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTransitionCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(motionLayout: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MotionLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, currentId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> {        <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (currentId) {            R.id.offScreenPass,            R.id.offScreenLike -&gt; {                motionLayout.progress = <span class="hljs-number"><span class="hljs-number">0f</span></span>                motionLayout.setTransition(R.id.rest, R.id.like)            }        }    }   })</code> </pre> <br>  Peu importe la transition que nous d√©finissons, passons ou aimons, lorsque nous glissons, nous passons √† la transition souhait√©e. <br><br><img src="https://habrastorage.org/webt/li/9b/yo/li9byopqw8itzxzsgj2wgwbufxm.gif"><br><br>  C'est pareil, mais l'animation ne s'arr√™te pas!  Continuons! <br><br><h3>  Liaison de donn√©es </h3><br>  Cr√©ez des donn√©es de test √† afficher sur les cartes.  Pour l'instant, nous nous limiterons √† changer la couleur d'arri√®re-plan de chaque carte. <br><br>  Nous cr√©ons un ViewModel avec une m√©thode svayp qui ne substitue que de nouvelles donn√©es.  Liez-le √† Activity de cette mani√®re: <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> viewModel = ViewModelProviders .of(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>) .<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(SwipeRightViewModel::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">viewModel</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">modelStream</span></span></span><span class="hljs-class"> .</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">observe</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, Observer { bindCard(it) }) motionLayout.setTransitionListener(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : TransitionAdapter() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTransitionCompleted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(motionLayout: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MotionLayout</span></span></span></span><span class="hljs-function"><span class="hljs-params">, currentId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (currentId) { R.id.offScreenPass, R.id.offScreenLike -&gt; { motionLayout.progress = <span class="hljs-number"><span class="hljs-number">0f</span></span> motionLayout.setTransition(R.id.rest, R.id.like) viewModel.swipe() } } } })</code> </pre><br>  Il reste √† informer ViewModel de la fin de l'animation de balayage, et il mettra √† jour les donn√©es qui sont actuellement affich√©es. <br><br><img src="https://habrastorage.org/webt/vl/j6/ar/vlj6arofcxa3lc7ny2z-ww1yxxg.gif"><br><br><h2>  Ic√¥nes contextuelles </h2><br>  Ajoutez deux vues qui, lors du balayage, apparaissent sur l'un des c√¥t√©s de l'√©cran (une seule est illustr√©e ci-dessous, la seconde est mise en miroir). <br><br><pre> <code class="kotlin hljs">&lt;ImageView android:id=<span class="hljs-string"><span class="hljs-string">"@+id/likeIndicator"</span></span> android:layout_width=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span> android:layout_height=<span class="hljs-string"><span class="hljs-string">"0dp"</span></span> /&gt;</code> </pre><br>  Maintenant, pour les cartes, vous devez d√©finir les √©tats d'animation avec ces vues. <br><br><pre> <code class="kotlin hljs">&lt;ConstraintSet android:id=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>&gt;        &lt;Layout            android:layout_width=<span class="hljs-string"><span class="hljs-string">"40dp"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"40dp"</span></span>            app:layout_constraintBottom_toBottomOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>            app:layout_constraintStart_toEndOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span>            app:layout_constraintTop_toTopOf=<span class="hljs-string"><span class="hljs-string">"parent"</span></span> /&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"0.5"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"0.5"</span></span> /&gt;        &lt;PropertySet android:alpha=<span class="hljs-string"><span class="hljs-string">"0"</span></span> /&gt;    &lt;/Constraint&gt;   &lt;/ConstraintSet&gt; &lt;ConstraintSet    android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:deriveConstraintsFrom=<span class="hljs-string"><span class="hljs-string">"@id/rest"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;Constraint android:id=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>&gt;        &lt;Layout            android:layout_width=<span class="hljs-string"><span class="hljs-string">"100dp"</span></span>            android:layout_height=<span class="hljs-string"><span class="hljs-string">"100dp"</span></span>            app:layout_constraintBottom_toBottomOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:layout_constraintEnd_toEndOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:layout_constraintStart_toStartOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:layout_constraintTop_toTopOf=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span> /&gt;        &lt;Transform            android:scaleX=<span class="hljs-string"><span class="hljs-string">"1"</span></span>            android:scaleY=<span class="hljs-string"><span class="hljs-string">"1"</span></span> /&gt;        &lt;PropertySet android:alpha=<span class="hljs-string"><span class="hljs-string">"1"</span></span> /&gt;    &lt;/Constraint&gt; &lt;/ConstraintSet&gt;</code> </pre><br>  Il n'est pas n√©cessaire de d√©finir des restrictions sur les animations qui vont au-del√† de l'√©cran, car elles sont h√©rit√©es des parents.  Et dans notre cas, c'est un √©tat de glissement. <br><br>  C'est tout ce que nous devons faire.  Vous pouvez d√©sormais ajouter tr√®s facilement des composants aux cha√Ænes d'animation. <br><br><img src="https://habrastorage.org/webt/wg/4g/1g/wg4g1grirk3zwqrfzwyahfp8i3i.gif"><br><br><h2>  Ex√©cutez l'animation par programme </h2><br><br>  Nous pouvons cr√©er deux boutons sur les cartes afin que l'utilisateur puisse non seulement glisser, mais contr√¥ler √† l'aide des boutons. <br><br>  Chaque bouton d√©marre la m√™me animation que le balayage. <br><br>  Comme d'habitude, abonnez-vous aux clics sur les boutons et d√©marrez l'animation directement sur l'objet MotionLayout: <br><br><pre> <code class="kotlin hljs">likeButton.setOnClickListener {    motionLayout.transitionToState(R.id.like) } passButton.setOnClickListener {    motionLayout.transitionToState(R.id.pass) }</code> </pre><br>  Nous devons ajouter des boutons aux cartes du haut et du bas pour que l'animation soit jou√©e en continu.  Cependant, pour la carte inf√©rieure, l'abonnement aux clics n'est pas n√©cessaire, car il n'est pas visible ou la carte sup√©rieure est anim√©e et nous ne voulons pas l'interrompre. <br><br><img src="https://habrastorage.org/webt/ic/zj/_v/iczj_vz8nrpdzlxtmjsaqc3bmiu.gif"><br><br>  Un autre excellent exemple de la fa√ßon dont MotionLayout g√®re les changements d'√©tat pour nous.  Ralentissons l√©g√®rement l'animation: <br><br><img src="https://habrastorage.org/webt/d6/bk/ne/d6bkne2bvugopppwypug25l30m8.gif"><br><br>  Regardez la transition que MotionLayout effectue lorsque pass remplace comme.  La magie! <br><br><h1>  Glissez la carte le long de la courbe </h1><br>  Supposons que nous l'aimions si la carte ne se d√©place pas en ligne droite, mais en courbe (pour √™tre honn√™te, je voulais juste essayer de le faire). <br><br>  Ensuite, vous devez d√©finir KeyPosition pour le mouvement dans les deux directions, de sorte que la trajectoire du mouvement soit courbe par un arc. <br><br>  Ajoutez ceci √† la sc√®ne de mouvement: <br><br><pre> <code class="kotlin hljs">&lt;Transition    app:constraintSetEnd=<span class="hljs-string"><span class="hljs-string">"@+id/like"</span></span>    app:constraintSetStart=<span class="hljs-string"><span class="hljs-string">"@+id/rest"</span></span>    app:duration=<span class="hljs-string"><span class="hljs-string">"300"</span></span>&gt;    &lt;!-- ... --&gt;    &lt;KeyFrameSet&gt;        &lt;KeyPosition            app:drawPath=<span class="hljs-string"><span class="hljs-string">"path"</span></span>            app:framePosition=<span class="hljs-string"><span class="hljs-string">"50"</span></span>            app:keyPositionType=<span class="hljs-string"><span class="hljs-string">"pathRelative"</span></span>            app:motionTarget=<span class="hljs-string"><span class="hljs-string">"@id/topCard"</span></span>            app:percentX=<span class="hljs-string"><span class="hljs-string">"0.5"</span></span>            app:percentY=<span class="hljs-string"><span class="hljs-string">"-0.1"</span></span> /&gt;           &lt;/KeyFrameSet&gt; &lt;/Transition&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/ij/z4/4m/ijz44micij7kdu81k4-tc-zggjc.gif"><br>  Maintenant, la carte se d√©place le long d'un chemin incurv√© non banal.  Par magie! <br><br><h1>  Conclusion </h1><br>  Lorsque vous comparez la quantit√© de code que j'ai obtenue lors de la cr√©ation de ces animations avec notre impl√©mentation actuelle d'animations similaires en production, le r√©sultat est stup√©fiant. <br><br>  MotionLayout g√®re imperceptiblement l'annulation des transitions (par exemple, au toucher), la cr√©ation de cha√Ænes d'animation, la modification des propri√©t√©s pendant les transitions, et bien plus encore.  Cet outil change fondamentalement tout, simplifiant consid√©rablement la logique de l'interface utilisateur. <br><br>  Il y a d'autres choses qui valent la peine d'√™tre travaill√©es (principalement la d√©sactivation des animations et du d√©filement bidirectionnel dans RecyclerView), mais je suis s√ªr que cela peut √™tre r√©solu. <br><br>  N'oubliez pas que la biblioth√®que est toujours en version b√™ta, mais qu'elle nous ouvre d√©j√† de nombreuses opportunit√©s int√©ressantes.  Nous attendons avec impatience la sortie de MotionLayout, qui, j'en suis s√ªr, vous sera utile plus d'une fois √† l'avenir.  Vous pouvez voir l'application pleinement fonctionnelle de cet article dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rentiel</a> . <br><br>  <i>PS: et depuis qu'ils m'ont donn√© la parole en tant que traducteur, notre √©quipe Android a une place pour un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©veloppeur</a> .</i>  <i>Merci de votre attention.</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458854/">https://habr.com/ru/post/fr458854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458842/index.html">La patience et le travail vont extraire tout le texte</a></li>
<li><a href="../fr458844/index.html">Destruction des silos gr√¢ce √† l'approche d'adaptation VeriSM ‚Ñ¢</a></li>
<li><a href="../fr458846/index.html">Comment d√©velopper un autre jeu de plateforme en utilisant Unity. Un autre tutoriel</a></li>
<li><a href="../fr458848/index.html">Version Rust 1.36.0: futur trait, stabilisation de l'allocation et MaybeUninit <T></a></li>
<li><a href="../fr458850/index.html">Apprenez l'anglais √† moindre co√ªt et efficacement. 2e partie</a></li>
<li><a href="../fr458856/index.html">Piles AAA bon march√© et ch√®res</a></li>
<li><a href="../fr458860/index.html">R√©glage des param√®tres du noyau Linux pour optimiser PostgreSQL</a></li>
<li><a href="../fr458864/index.html">Concours de d√©veloppeurs de robots pour TamTam</a></li>
<li><a href="../fr458866/index.html">Fonctionnement de l'√©quilibreur d'√©quipe dans World of Tanks Blitz</a></li>
<li><a href="../fr458868/index.html">Bruit dans les m√©gadonn√©es. Analyse d'entropie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>