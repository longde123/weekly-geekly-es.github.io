<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏿‍🤝‍👩🏻 🏳️ 🎨 Coba Micronaut atau Sayang, saya mengurangi kerangka ✍🏿 😧 👩🏼‍🏫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Coba Micronaut atau Sayang, saya mengurangi kerangka 


 Tentang kerangka kerja mikronot, saya melihat sekilas intisari buletin. Dia bertanya-tanya se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Coba Micronaut atau Sayang, saya mengurangi kerangka</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427595/"><h2 id="probuem-micronaut-ili-dorogaya-ya-umenshil-freymvork">  Coba Micronaut atau Sayang, saya mengurangi kerangka </h2><br><p>  Tentang kerangka kerja mikronot, saya melihat sekilas intisari buletin.  Dia bertanya-tanya seperti apa binatang itu.  Kerangka kerja ini kontras dengan pegas yang diisi dengan semua alat yang diperlukan. </p><br><p><img src="https://habrastorage.org/webt/eu/iq/eq/euiqeqqehjcvuto1psel_ajypw4.jpeg" alt="Micronaut"></p><br><p> Mengantisipasi konferensi yang akan datang untuk para pengembang, di mana mereka hanya akan memberi tahu dan menunjukkan cara menggunakan micronaut di layanan-mikro Anda, saya memutuskan untuk mempersiapkan setidaknya satu kali dan datang dengan setidaknya beberapa konteks di kepala saya, dengan sejumlah masalah dan pertanyaan.  Lakukan pekerjaan rumah sehingga untuk berbicara.  Saya memutuskan untuk meluncurkan beberapa proyek hewan peliharaan kecil di beberapa malam (seperti kelanjutannya).  Di akhir artikel akan ada tautan ke repositori semua sumber proyek. </p><a name="habracut"></a><br><blockquote>  Micronaut adalah kerangka kerja JVM yang mendukung tiga bahasa pengembangan: Java, Kotlin, Groovy.  Ini dikembangkan oleh OCI, perusahaan yang sama dengan yang diberikan Grails kepada kami.  Ini memiliki penyetelan dalam bentuk aplikasi cli dan satu set perpustakaan yang direkomendasikan (berbagai klien reaktif-http dan basis data) <br><br>  Ada DI yang mengimplementasikan dan mengulangi ide Spring, menambahkan sejumlah chip - asinkron, dukungan untuk AWS Lambda, Client Side Load Balancing. </blockquote><p>  <em>Gagasan layanan:</em> salah satu teman saya pada suatu waktu dengan orang bodoh membeli setengah lusin segala macam cryptocurrency, berinvestasi dalam mereka liburan yang diresapi dan simpanan dari jaket musim dingin.  Kita semua tahu bahwa volatilitas semua substansi cryptocurrency ini liar, dan topiknya sendiri pada umumnya tidak dapat diprediksi, seorang teman akhirnya memutuskan untuk mengurus sarafnya dan hanya tenggelam dalam apa yang terjadi dengan "aset" -nya.  Tapi kadang-kadang Anda masih ingin melihat, tetapi apa yang ada dengan semua ini, tiba-tiba itu sudah kaya.  Jadi ide panel sederhana (dashboard, seperti Grafana atau sesuatu yang lebih sederhana), halaman web tertentu dengan informasi kering, berapa banyak biaya dalam beberapa mata uang fiat (USD, RUR) sekarang muncul. </p><br><h3 id="disclaimers">  Penafian </h3><br><ol><li>  Kami akan meninggalkan kelayakan menulis solusi kami sendiri, kami hanya perlu mencoba kerangka kerja baru pada sesuatu yang lebih licik daripada HelloWorld. </li><li>  Algoritma perhitungan, kesalahan yang diharapkan, kesalahan, dll.  (setidaknya untuk tahap pertama produk), validitas pilihan pertukaran kripto untuk menarik informasi, portofolio "kripto" investasi teman juga akan keluar dari pertanyaan dan tidak perlu didiskusikan atau semacam analisis mendalam. </li></ol><br><p>  Jadi, satu set kecil persyaratan: </p><br><ol><li>  Layanan web (akses dari luar, melalui http) </li><li>  Menampilkan halaman di browser dengan ringkasan nilai total portofolio cryptocurrency </li><li>  Kemampuan untuk mengkonfigurasi portofolio (pilih format JSON untuk memuat dan menurunkan struktur portofolio).  API REST tertentu untuk memperbarui portofolio dan memuatnya, mis.  2 API: untuk menyimpan / memperbarui - POST, untuk bongkar - GET.  Struktur portofolio pada dasarnya adalah plat tipe sederhana <br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">BTC</span></span> –  0<span class="hljs-selector-class"><span class="hljs-selector-class">.00005</span></span> . <span class="hljs-selector-tag"><span class="hljs-selector-tag">XEM</span></span> –  4<span class="hljs-selector-class"><span class="hljs-selector-class">.5</span></span> . ...</code> </pre> </li><li>  Kami mengambil data dari cryptoexchanges dan sumber pertukaran mata uang (untuk mata uang fiat) </li><li>  Aturan untuk menghitung nilai total portofolio: <br><img src="https://habrastorage.org/webt/95/ai/fn/95aifnv4r6bngnaeqrb9tlu2hfy.png" alt="Rumus untuk menghitung nilai total portofolio"><br></li></ol><br><br><p>  Tentu saja, semua yang ditulis dalam paragraf 5 adalah subjek perselisihan dan keraguan yang terpisah, tetapi biarlah bisnis itu menginginkannya. </p><br><h2 id="start-proekta">  Proyek dimulai </h2><br><p>  Jadi, kita pergi ke situs web resmi kerangka kerja dan melihat bagaimana kita bisa mulai berkembang.  Situs resmi menawarkan untuk menginstal alat sdkman.  Sepotong yang memfasilitasi pengembangan dan pengelolaan proyek pada kerangka kerja mikronaut (dan lainnya termasuk, misalnya, Grails). <br></p><br><img src="https://habrastorage.org/webt/af/rd/3z/afrd3zhw_oodv3s1kroj5vx6bgu.png" alt="Manajer yang sama dari berbagai SDK"><br><br>  Sebuah komentar kecil: Jika Anda baru saja memulai inisialisasi proyek tanpa tombol apa pun, maka kolektor gradle dipilih secara default.  Hapus folder, coba lagi, kali ini dengan kunci: <br><pre> <code class="hljs powershell">mn create<span class="hljs-literal"><span class="hljs-literal">-app</span></span> com.room606.cryptonaut <span class="hljs-literal"><span class="hljs-literal">-b</span></span>=maven</code> </pre> <br><p>  Poin yang menarik adalah sdkman, seperti Spring Tool Suite, menawarkan Anda pada tahap membuat proyek untuk mengatur "kubus" mana yang ingin Anda gunakan di awal.  Saya tidak banyak bereksperimen dengan ini, saya juga membuatnya dengan preset default. </p><br><p>  Akhirnya, kami membuka proyek di Intellij Idea dan mengagumi kumpulan sumber dan sumber daya dan cakram bahwa kami diberi panduan untuk membuat proyek mikronaut. <br></p><br><img src="https://habrastorage.org/webt/8n/oh/ko/8nohkocdymxsv2ctnkqlvnvr1x4.png" alt="Struktur proyek telanjang"><br><br>  Eye Clings to Dockerfile <br><pre> <code class="hljs powershell">FROM openjdk:<span class="hljs-number"><span class="hljs-number">8</span></span>u171<span class="hljs-literal"><span class="hljs-literal">-alpine3</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span> RUN apk -<span class="hljs-literal"><span class="hljs-literal">-no</span></span><span class="hljs-literal"><span class="hljs-literal">-cache</span></span> add curl COPY target/cryptonaut*.jar cryptonaut.jar CMD java <span class="hljs-variable"><span class="hljs-variable">$</span></span>{JAVA_OPTS} <span class="hljs-literal"><span class="hljs-literal">-jar</span></span> cryptonaut.jar</code> </pre> <br><p>  Ya, itu menyenangkan dan patut dipuji.  Kami segera diberi alat untuk dengan cepat mengeluarkan aplikasi ke Prod / INT / QA / lingkungan apa pun.  Untuk ini, tanda tambah mental untuk proyek. </p><br><p>  Sudah cukup untuk mengumpulkan proyek oleh Maven, kemudian mengumpulkan gambar Docker dan mempublikasikannya ke registri Docker Anda, atau hanya mengekspor biner gambar sebagai opsi ke sistem CI Anda, itulah yang Anda inginkan. </p><br><p>  Di folder sumber daya, kami juga menyiapkan kosong dengan parameter konfigurasi aplikasi (analog dari application.properties di Spring), serta file konfigurasi untuk pustaka logback.  Keren! </p><br><p>  Kami pergi ke titik masuk aplikasi dan mempelajari kelas.  Kami melihat gambar yang sangat familier bagi kami dari Spring Boot.  Di sini, para pengembang kerangka kerja juga tidak mulai menciptakan dan menemukan apa pun. </p><br><pre> <code class="hljs java"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ Micronaut.run(Application.class); }</code> </pre> <br><p>  Bandingkan dengan kode Spring yang dikenal. </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String[] args</span></span></span><span class="hljs-function">)</span></span> { SpringApplication.run(Application.class, args); }</code> </pre> <br><p>  Yaitu  kami juga meningkatkan wadah IoC dengan semua biji yang termasuk dalam pekerjaan sesuai kebutuhan.  Setelah menjalankan sedikit sesuai dengan dokumentasi resmi, kami perlahan memulai pengembangan. </p><br><p>  <em>Kami akan membutuhkan:</em> </p><br><ol><li>  Model Domain </li><li>  Pengontrol untuk mengimplementasikan REST API. </li><li>  Lapisan penyimpanan data (Klien basis data atau ORM atau yang lainnya) </li><li>  Kode data konsumen dari pertukaran cryptocurrency, serta data dari pertukaran mata uang fiat.  Yaitu  kita perlu menulis klien yang paling sederhana untuk layanan pihak ke-3.  Di Spring, RestTemplate yang terkenal cocok dengan peran ini. </li><li>  Konfigurasi minimum untuk manajemen yang fleksibel dan permulaan aplikasi (mari kita pikirkan apa dan bagaimana kita akan membuat konfigurasi) </li><li>  Tes!  Ya, untuk dapat dengan aman dan aman mem-refode kode dan mengimplementasikan fungsionalitas baru, kita perlu memastikan stabilitas yang lama </li><li>  Caching.  Ini bukan persyaratan dasar, tetapi sesuatu yang menyenangkan untuk memiliki kinerja yang baik, dan dalam skenario kami ada tempat di mana caching jelas merupakan alat yang baik. <br>  Spoiler: semuanya akan menjadi sangat buruk di sini. </li></ol><br><h3 id="modeli-predmetnoy-oblasti">  Model Domain </h3><br><p>  Untuk tujuan kami, model berikut akan mencukupi: model portofolio cryptocurrency, nilai tukar sepasang mata uang fiat, harga cryptocurrency dalam mata uang fiat, dan nilai total portofolio. </p><br><p>  Di bawah ini adalah kode hanya beberapa model, sisanya dapat dilihat <a href="">di repositori</a> .  Dan ya, saya terlalu malas untuk mengacaukan <code>Lombok</code> dalam proyek ini. </p><br><pre> <code class="hljs java">Portfolio.java <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.domain; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Collections; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.TreeMap; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Portfolio</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, BigDecimal&gt; coins = Collections.emptyMap(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Map&lt;String, BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCoins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeMap&lt;&gt;(coins); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCoins</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Map&lt;String, BigDecimal&gt; coins)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.coins = coins; }</code> </pre> <br><pre> <code class="hljs cs">FiatRate.java package com.room606.cryptonaut.domain; import java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FiatRate</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String counter; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BigDecimal <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FiatRate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">base</span></span></span></span><span class="hljs-function"><span class="hljs-params">, String counter, BigDecimal </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">base</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = counter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">base</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">base</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> counter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCounter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String counter</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = counter; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BigDecimal </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Price</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Prices</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> () ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">Total</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span> ...</code> </pre> <br><h3 id="kontrollery">  Pengontrol </h3><br><p>  Kami mencoba untuk menulis controller yang mengimplementasikan API paling sederhana, mengeluarkan nilai cryptocurrency sesuai dengan kode huruf koin yang diberikan. <br>  Yaitu </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /cryptonaut/restapi/prices.json?coins=BTC&amp;coins=ETH&amp;fiatCurrency=RUR</code> </pre> <br><p>  Harus menghasilkan sesuatu seperti: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"prices"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"coin"</span></span>:<span class="hljs-string"><span class="hljs-string">"BTC"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-number"><span class="hljs-number">407924.043300000000</span></span>},{<span class="hljs-attr"><span class="hljs-attr">"coin"</span></span>:<span class="hljs-string"><span class="hljs-string">"ETH"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"value"</span></span>:<span class="hljs-number"><span class="hljs-number">13040.638266000000</span></span>}],<span class="hljs-attr"><span class="hljs-attr">"fiatCurrency"</span></span>:<span class="hljs-string"><span class="hljs-string">"RUR"</span></span>}</code> </pre> <br><p>  Menurut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi</a> , tidak ada yang rumit dan mengingatkan pendekatan dan konvensi <code>Spring</code> sama: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.rest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Price; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Prices; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.CryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.MediaType; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Stream; <span class="hljs-meta"><span class="hljs-meta">@Controller(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/cryptonaut/restapi/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MarketDataController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> CryptoMarketDataService cryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FiatExchangeRatesService fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MarketDataController(CryptoMarketDataService cryptoMarketDataService, FiatExchangeRatesService fiatExchangeRatesService) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cryptoMarketDataService = cryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fiatExchangeRatesService = fiatExchangeRatesService; } <span class="hljs-meta"><span class="hljs-meta">@Get(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/prices.json"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Prices pricesAsJson(<span class="hljs-meta"><span class="hljs-meta">@QueryValue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"coins"</span></span></span><span class="hljs-meta">)</span></span> String[] coins, <span class="hljs-meta"><span class="hljs-meta">@QueryValue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fiatCurrency"</span></span></span><span class="hljs-meta">)</span></span> String fiatCurrency) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getPrices(coins, fiatCurrency); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Prices getPrices(String[] coins, String fiatCurrency) { List&lt;Price&gt; prices = Stream.of(coins) .map(coin -&gt; new Price(coin, cryptoMarketDataService.getPrice(coin, fiatCurrency))) .collect(Collectors.toList()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> new Prices(prices, fiatCurrency); } }</code> </pre> <br><p>  Yaitu  kami dengan tenang menentukan <code>POJO</code> kami sebagai tipe yang dikembalikan, dan tanpa mengonfigurasi serializer / deserializer apa pun, bahkan tanpa menggantung anotasi tambahan, Micronaut akan membuat badan http yang benar dengan data dari kotak.  Mari kita bandingkan dengan cara <code>Spring</code> : </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@RequestMapping(value = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/prices.json"</span></span></span><span class="hljs-meta">, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ResponseEntity&lt;Prices&gt; pricesAsJson(<span class="hljs-meta"><span class="hljs-meta">@RequestParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"userId"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String[] coins, <span class="hljs-meta"><span class="hljs-meta">@RequestParam(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fiatCurrency"</span></span></span><span class="hljs-meta">)</span></span> String fiatCurrency) {</code> </pre> <br><p>  Secara umum, saya tidak punya masalah dengan controller, mereka hanya bekerja seperti yang diharapkan dari mereka, menurut dokumentasi.  Ejaan mereka intuitif dan sederhana.  Kami melanjutkan. </p><br><h3 id="sloy-hraneniya-dannyh">  Lapisan penyimpanan data </h3><br><p>  Untuk versi pertama aplikasi, kami hanya akan menyimpan portofolio pengguna.  Secara umum, kami hanya akan menyimpan satu portofolio dari satu pengguna.  Sederhananya, kami belum akan mendapat dukungan dari banyak pengguna, hanya satu pengguna utama dengan portofolio cryptocurrency-nya.  Ini luar biasa! </p><br><p>  Untuk menerapkan kegigihan data, dokumentasi menawarkan opsi dengan koneksi JPA, serta contoh terpisah menggunakan klien yang berbeda untuk membaca dari database (bagian "12.1.5 Mengkonfigurasi Postgres").  <code>JPA</code> tegas dibuang dan preferensi diberikan untuk menulis dan memanipulasi pertanyaan sendiri.  Konfigurasi database ditambahkan ke application.yml, ( <code>Postgres</code> dipilih sebagai RDBMS), sesuai dengan dokumentasi: </p><br><pre> <code class="hljs pgsql">postgres: reactive: client: port: <span class="hljs-number"><span class="hljs-number">5432</span></span> host: localhost <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>: cryptonaut <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: crypto <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: r1ch13r1ch maxSize: <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre> <br><p>  Bergantung pada pustaka <code>postgres-reactive</code> ditambahkan.  Ini adalah klien untuk bekerja dengan database baik secara asinkron maupun sinkron. </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>io.micronaut.configuration<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>postgres-reactive<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.0.M4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>compile<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Dan akhirnya, file <code>docker-compose.yml</code> ditambahkan ke <code>docker-compose.yml</code> / <code>docker-compose.yml</code> untuk menyebarkan lingkungan aplikasi kita di masa depan, di mana komponen basisdata ditambahkan: </p><br><pre> <code class="hljs pgsql">db: image: postgres:<span class="hljs-number"><span class="hljs-number">9.6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">always</span></span> environment: POSTGRES_USER: crypto POSTGRES_PASSWORD: r1ch13r1ch POSTGRES_DB: cryptonaut ports: - <span class="hljs-number"><span class="hljs-number">5432</span></span>:<span class="hljs-number"><span class="hljs-number">5432</span></span> volumes: - ${PWD}/../db/init_tables.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span>:/docker-entrypoint-initdb.d/<span class="hljs-number"><span class="hljs-number">1.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>_init_tables.<span class="hljs-keyword"><span class="hljs-keyword">sql</span></span></code> </pre> <br><p>  Di bawah ini adalah skrip inisialisasi untuk database dengan struktur tabel yang sangat sederhana: </p><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> portfolio ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> coin_amt_primary_key PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>, coin <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span>, amount <span class="hljs-built_in"><span class="hljs-built_in">NUMERIC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> );</code> </pre> <br><p>  Sekarang mari kita coba melempar kode yang memperbarui portofolio pengguna.  Komponen portofolio kami akan terlihat seperti ini: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadPortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">Optional&lt;BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateTotalValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio, String fiatCurrency)</span></span></span></span>; }</code> </pre> <br><p>  Melihat serangkaian metode <code>Postgres reactive client</code> , kami melempar kelas ini: </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.markets.CryptoMarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.context.annotation.Requires; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.reactiverse.pgclient.Numeric; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.reactiverse.reactivex.pgclient.*; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.HashMap; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.List; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Map; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioServiceImpl</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> PgPool pgPool; ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String UPDATE_COIN_AMT = <span class="hljs-string"><span class="hljs-string">"INSERT INTO portfolio (coin, amount) VALUES (?, ?) ON CONFLICT (coin) "</span></span> + <span class="hljs-string"><span class="hljs-string">"DO UPDATE SET amount = ?"</span></span>; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span><span class="hljs-function"> </span></span>{ List&lt;Tuple&gt; records = portfolio.getCoins() .entrySet() .stream() .map(entry -&gt; Tuple.of(entry.getKey(), Numeric.create(entry.getValue()), Numeric.create(entry.getValue()))) .collect(Collectors.toList()); pgPool.preparedBatch(UPDATE_COIN_AMT, records, pgRowSetAsyncResult -&gt; { <span class="hljs-comment"><span class="hljs-comment">//   pgRowSetAsyncResult.cause().printStackTrace(); }); return portfolio; } ... }</span></span></code> </pre> <br><p>  Meluncurkan lingkungan, kami mencoba memperbarui portofolio kami melalui API yang diterapkan secara hati-hati sebelumnya: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rest</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PortfolioService</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">com</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.room606</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.cryptonaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.domain</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Portfolio</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.micronaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MediaType</span></span>; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.micronaut</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.http</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.annotation</span></span>.*; <span class="hljs-selector-tag"><span class="hljs-selector-tag">import</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">javax</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.inject</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.Inject</span></span>; @<span class="hljs-keyword"><span class="hljs-keyword">Controller</span></span>("/<span class="hljs-keyword"><span class="hljs-keyword">cryptonaut</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">restapi</span></span>/") public class ConfigController { @<span class="hljs-keyword"><span class="hljs-keyword">Inject</span></span> private PortfolioService portfolioService; @<span class="hljs-keyword"><span class="hljs-keyword">Post</span></span>("/<span class="hljs-keyword"><span class="hljs-keyword">portfolio</span></span>") @Produces(MediaType.APPLICATION_JSON) @Consumes(MediaType.APPLICATION_JSON) public Portfolio savePortfolio(@Body Portfolio portfolio) { <span class="hljs-selector-tag"><span class="hljs-selector-tag">return</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">portfolioService</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.savePortfolio</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">portfolio</span></span>); }</code> </pre> <br><p>  Lakukan permintaan <code>curl</code> : </p><br><pre> <code class="hljs erlang">curl http://localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span>/cryptonaut/restapi/portfolio -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> --data '{<span class="hljs-string"><span class="hljs-string">"coins"</span></span>: {<span class="hljs-string"><span class="hljs-string">"XRP"</span></span>: <span class="hljs-string"><span class="hljs-string">"35.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"LSK"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.03"</span></span>, <span class="hljs-string"><span class="hljs-string">"XEM"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.23"</span></span>}}' -v</code> </pre> <br><p>  Dan ... tangkap kesalahan di log: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PgException</span></span>: <span class="hljs-selector-tag"><span class="hljs-selector-tag">syntax</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">error</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">or</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">near</span></span> "," <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.PrepareStatementCommand</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.handleErrorResponse</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">PrepareStatementCommand</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:74)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.codec</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decodeError</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:250)</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">at</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">io</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.reactiverse</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.pgclient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.impl</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.codec</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.decodeMessage</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">MessageDecoder</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.java</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:139)</span></span> ...</code> </pre> <br><p>  Setelah menggaruk lobak kami, kami tidak menemukan solusi apa pun di dock resmi, kami mencoba untuk google dock di perpustakaan <code>postgres-reactive</code> itu sendiri, dan ini ternyata menjadi solusi yang tepat, karena contoh dan sintaks kueri yang benar diberikan secara detail.  Itu soal parameter placeholder, ternyata, Anda perlu menggunakan label bernomor dalam bentuk <code>$x ($1, $2, etc.)</code> . <code>$x ($1, $2, etc.)</code> .  Jadi, perbaikannya adalah menulis ulang permintaan target: </p><br><pre> <code class="hljs sql">private static final String UPDATE_COIN_AMT = "<span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> portfolio (coin, amount) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ($<span class="hljs-number"><span class="hljs-number">1</span></span>, $<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> CONFLICT (coin) <span class="hljs-string"><span class="hljs-string">" + "</span></span><span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> amount = $<span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-string"><span class="hljs-string">";</span></span></code> </pre> <br><p>  Kami restart aplikasi, coba permintaan <code>REST</code> sama ... tepuk tangan.  Data ditambahkan.  Mari kita beralih ke membaca. </p><br><p>  Kami dihadapkan dengan tugas paling sederhana yaitu membaca portofolio cryptocurrency pengguna dari database dan memetakannya ke objek POJO.  Untuk tujuan ini, kami menggunakan metode pgPool.query (SELECT_COINS_AMTS, pgRowSetAsyncResult): </p><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Portfolio loadPortfolio() { Map&lt;String, BigDecimal&gt; coins = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); pgPool.query(SELECT_COINS_AMTS, pgRowSetAsyncResult -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pgRowSetAsyncResult.succeeded()) { PgRowSet <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> = pgRowSetAsyncResult.result(); PgIterator pgIterator = <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>.iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pgIterator.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> = pgIterator.next(); coins.put(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getString("coin"), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getFloat("amount"))); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("Failure: " + pgRowSetAsyncResult.cause().getMessage()); } }); Portfolio portfolio = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Portfolio(); portfolio.setCoins(coins); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; }</code> </pre> <br><p>  Kami menghubungkan semua ini bersama-sama dengan pengontrol yang bertanggung jawab atas portofolio cryptocurrency: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Controller(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/cryptonaut/restapi/"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ConfigController</span></span></span><span class="hljs-class"> </span></span>{ ... <span class="hljs-meta"><span class="hljs-meta">@Get(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/portfolio"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@Produces(MediaType.APPLICATION_JSON)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Portfolio loadPortfolio() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolioService.loadPortfolio(); } ...</code> </pre> <br><p>  Mulai ulang layanan.  Untuk pengujian, pertama-tama kami mengisi portofolio ini dengan setidaknya beberapa data: </p><br><pre> <code class="hljs erlang">curl http://localhost:<span class="hljs-number"><span class="hljs-number">8080</span></span>/cryptonaut/restapi/portfolio -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> --data '{<span class="hljs-string"><span class="hljs-string">"coins"</span></span>: {<span class="hljs-string"><span class="hljs-string">"XRP"</span></span>: <span class="hljs-string"><span class="hljs-string">"35.5"</span></span>, <span class="hljs-string"><span class="hljs-string">"LSK"</span></span>: <span class="hljs-string"><span class="hljs-string">"5.03"</span></span>, <span class="hljs-string"><span class="hljs-string">"XEM"</span></span>: <span class="hljs-string"><span class="hljs-string">"16.23"</span></span>}}' -v</code> </pre> <br><p>  Sekarang akhirnya uji pembacaan kode kami dari database: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> http://localhost:8080/cryptonaut/restapi/portfolio -v</code> </pre> <br><p>  Dan ... kita dapatkan ... sesuatu yang aneh: </p><br><pre> <code class="hljs json">{<span class="hljs-attr"><span class="hljs-attr">"coins"</span></span>:{}}</code> </pre> <br><p>  Cukup aneh bukan?  Kami memeriksa ulang permintaan sepuluh kali, mencoba melakukan permintaan <code>curl</code> lagi, bahkan memulai kembali layanan kami.  Hasilnya masih sama liar ... Setelah membaca kembali tanda tangan metode, dan juga mengingat bahwa kami memiliki <code>Reactive Pg client</code> , kami sampai pada kesimpulan bahwa kami berurusan dengan sinkronisasi.  Debag bijaksana mengkonfirmasi ini!  Itu layak sedikit santai kode, seperti voila, kami mendapat data tidak kosong! </p><br><p>  Beralih ke dok perpustakaan lagi, menggulung lengan baju kami, kami menulis ulang kode dengan kode pemblokiran yang benar, tetapi sepenuhnya dapat diprediksi: </p><br><pre> <code class="hljs pgsql">Map&lt;String, BigDecimal&gt; coins = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); PgIterator pgIterator = pgPool.rxPreparedQuery(SELECT_COINS_AMTS).blockingGet().iterator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (pgIterator.hasNext()) { <span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> <span class="hljs-keyword"><span class="hljs-keyword">row</span></span> = pgIterator.next(); coins.put(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getString("coin"), <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(<span class="hljs-keyword"><span class="hljs-keyword">row</span></span>.getValue("amount").toString())); }</code> </pre> <br><p>  Sekarang kita mendapatkan apa yang kita harapkan.  Kami memutuskan masalah ini, teruskan. </p><br><h3 id="pishem-klient-dlya-polucheniya-dannyh-po-rynkam">  Kami menulis klien untuk mendapatkan data pasar </h3><br><p>  Di sini, tentu saja, saya ingin menyelesaikan masalah dengan jumlah sepeda paling sedikit.  Hasilnya adalah dua solusi: </p><br><ul><li>  pustaka klien siap pakai untuk mengakses pertukaran kripto tertentu </li><li>  kode kecil klien sendiri untuk menerapkan nilai tukar.  Yang keluar dari kotak adalah Micronaut. </li></ul><br><p>  Dengan perpustakaan yang sudah jadi, semuanya tidak begitu menarik.  Saya hanya mencatat bahwa selama pencarian cepat, proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/knowm/XChange</a> dipilih. </p><br><p>  Pada prinsipnya, arsitektur perpustakaan sesederhana tiga sen - ada satu set antarmuka untuk menerima data, antarmuka utama dan kelas model seperti <code>Ticker</code> (Anda dapat mengetahui <code>bid</code> , <code>ask</code> , segala macam harga terbuka, harga tutup dll.), <code>CurrencyPair</code> , <code>Currency</code> .  Selanjutnya, Anda menginisialisasi implementasi itu sendiri dalam kode, setelah sebelumnya menghubungkan dependensi dengan implementasi yang merujuk pada cryptoexchange tertentu.  Dan kelas utama di mana kami beroperasi adalah <code>MarketDataService.java</code> </p><br><p>  Misalnya, untuk percobaan kami, sebagai permulaan, kami puas dengan "konfigurasi" seperti itu: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.knowm.xchange<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>xchange-core<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>4.3.10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.knowm.xchange<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>xchange-bittrex<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>4.3.10<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Di bawah ini adalah kode yang menjalankan fungsi utama - menghitung biaya cryptocurrency tertentu dalam istilah fiat (lihat Rumus yang dijelaskan di awal artikel di blok persyaratan): </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut.markets; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.exceptions.CryptonautException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.currency.Currency; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.currency.CurrencyPair; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.dto.marketdata.Ticker; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.exceptions.CurrencyPairNotValidException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.knowm.xchange.service.marketdata.MarketDataService; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CryptoMarketDataService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> FiatExchangeRatesService fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> MarketDataService marketDataService; <span class="hljs-meta"><span class="hljs-meta">@Inject</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CryptoMarketDataService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FiatExchangeRatesService fiatExchangeRatesService, MarketDataServiceFactory marketDataServiceFactory)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fiatExchangeRatesService = fiatExchangeRatesService; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.marketDataService = marketDataServiceFactory.getMarketDataService(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPrice</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String coinCode, String fiatCurrencyCode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ BigDecimal price = getPriceForBasicCurrency(coinCode, Currency.USD.getCurrencyCode()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Currency.USD.equals(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode))) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> price; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> price.multiply(fiatExchangeRatesService.getFiatPrice(Currency.USD.getCurrencyCode(), fiatCurrencyCode)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> BigDecimal </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPriceForBasicCurrency</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String coinCode, String fiatCurrencyCode)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ Ticker ticker = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ticker = marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode))); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ticker.getBid(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (CurrencyPairNotValidException e) { ticker = getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), Currency.BTC); Ticker ticker2 = getTicker(Currency.BTC, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ticker.getBid().multiply(ticker2.getBid()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptonautException(<span class="hljs-string"><span class="hljs-string">"Failed to get price for Pair "</span></span> + coinCode + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + fiatCurrencyCode + <span class="hljs-string"><span class="hljs-string">": "</span></span> + e.getMessage(), e); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Ticker </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTicker</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Currency base, Currency counter)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> CryptonautException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(base, counter)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (CurrencyPairNotValidException | IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptonautException(<span class="hljs-string"><span class="hljs-string">"Failed to get price for Pair "</span></span> + base.getCurrencyCode() + <span class="hljs-string"><span class="hljs-string">"/"</span></span> + counter.getCurrencyCode() + <span class="hljs-string"><span class="hljs-string">": "</span></span> + e.getMessage(), e); } } }</code> </pre> <br><p>  Semuanya telah dilakukan sejauh mungkin menggunakan antarmuka kita sendiri untuk sedikit mengabaikan implementasi spesifik yang disediakan oleh proyek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/knowm/XChange</a> . </p><br><p>  Mengingat fakta bahwa pada banyak, jika tidak semua pertukaran mata uang digital, hanya ada satu set mata uang fiat terbatas yang beredar (USD, EUR, mungkin itu saja ..), untuk jawaban akhir untuk pertanyaan pengguna, perlu menambahkan sumber data lain - nilai tukar mata uang fiat, dan juga merupakan konverter opsional.  Yaitu  Untuk menjawab pertanyaan, berapa biaya cryptocurrency WTF dalam RUR (mata uang target, mata uang target) sekarang, Anda harus menjawab dua sub-pertanyaan: WTF / BaseCurrency (kami menganggap USD sebagai itu), BaseCurrency / RUR, lalu gandakan kedua nilai ini dan berikan sebagai hasilnya. </p><br><p>  Untuk versi pertama layanan kami, kami hanya akan mendukung USD dan RUR sebagai mata uang target. <br>  Jadi, untuk mendukung RUR, disarankan untuk mengambil sumber yang relevan dengan lokasi geografis layanan (kami akan menyelenggarakan dan menggunakannya secara eksklusif di Rusia).  Singkatnya, kurs Bank Sentral akan sesuai untuk kita.  Sumber terbuka dari data tersebut ditemukan di Internet, yang dapat dikonsumsi sebagai JSON.  Bagus </p><br><p>  Di bawah ini adalah respons layanan terhadap permintaan nilai tukar saat ini: </p><br><pre> <code class="hljs objectivec">{ <span class="hljs-string"><span class="hljs-string">"Date"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-16T11:30:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"PreviousDate"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-13T11:30:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"PreviousURL"</span></span>: <span class="hljs-string"><span class="hljs-string">"\/\/www.cbr-xml-daily.ru\/archive\/2018\/10\/13\/daily_json.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"Timestamp"</span></span>: <span class="hljs-string"><span class="hljs-string">"2018-10-15T23:00:00+03:00"</span></span>, <span class="hljs-string"><span class="hljs-string">"Valute"</span></span>: { <span class="hljs-string"><span class="hljs-string">"AUD"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01010"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"036"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"AUD"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ђІЃ‚Ђ°»№Ѓє№ ґѕ»»°Ђ"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">46.8672</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">46.9677</span></span> }, <span class="hljs-string"><span class="hljs-string">"AZN"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01020A"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"944"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"AZN"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ђ·µЂ±°№ґ¶°ЅЃє№ ј°Ѕ°‚"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">38.7567</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">38.8889</span></span> }, <span class="hljs-string"><span class="hljs-string">"GBP"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"R01035"</span></span>, <span class="hljs-string"><span class="hljs-string">"NumCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"826"</span></span>, <span class="hljs-string"><span class="hljs-string">"CharCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"GBP"</span></span>, <span class="hljs-string"><span class="hljs-string">"Nominal"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"Name"</span></span>: <span class="hljs-string"><span class="hljs-string">"¤ѓЅ‚ Ѓ‚µЂ»ЅіѕІ ЎѕµґЅµЅЅѕіѕ єѕЂѕ»µІЃ‚І°"</span></span>, <span class="hljs-string"><span class="hljs-string">"Value"</span></span>: <span class="hljs-number"><span class="hljs-number">86.2716</span></span>, <span class="hljs-string"><span class="hljs-string">"Previous"</span></span>: <span class="hljs-number"><span class="hljs-number">87.2059</span></span> }, ...</code> </pre> <br><p>  Sebenarnya, di bawah ini adalah <code>CbrExchangeRatesClient</code> klien <code>CbrExchangeRatesClient</code> : </p><br><pre> <code class="hljs pgsql">package com.room606.cryptonaut.markets.clients; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.JsonNode; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.ObjectMapper; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.databind.ObjectReader; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.exceptions.CryptonautException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.HttpRequest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.client.Client; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.http.client.RxHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Inject; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.IOException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.*; @Singleton <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CbrExchangeRatesClient { private static final String CBR_DATA_URI = "https://www.cbr-xml-daily.ru/daily_json.js"; @Client(CBR_DATA_URI) @Inject private RxHttpClient httpClient; private final ObjectReader objectReader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ObjectMapper().reader(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Map&lt;String, BigDecimal&gt; getRates() { try { //<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ratesCache.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("fiatRates"); HttpRequest&lt;?&gt; req = HttpRequest.<span class="hljs-keyword"><span class="hljs-keyword">GET</span></span>(""); String response = httpClient.retrieve(req, String.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>).blockingSingle(); JsonNode <span class="hljs-type"><span class="hljs-type">json</span></span> = objectReader.readTree(response); String usdPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("USD").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); String eurPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("EUR").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); String gbpPrice = <span class="hljs-type"><span class="hljs-type">json</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Valute").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("GBP").<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>("Value").asText(); Map&lt;String, BigDecimal&gt; prices = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> HashMap&lt;&gt;(); prices.put("USD", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(usdPrice)); prices.put("GBP", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(gbpPrice)); prices.put("EUR", <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BigDecimal(eurPrice)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prices; } catch (IOException e) { throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> CryptonautException("Failed to obtain exchange rates: " + e.getMessage(), e); } } }</code> </pre> <br><p>  Di sini kita menyuntikkan <code>RxHttpClient</code> , komponen dari <code>Micronaut</code> .  Ini juga memberi kita pilihan untuk melakukan pemrosesan atau pemblokiran permintaan tidak sinkron.  Kami memilih pemblokiran klasik: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">httpClient</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.retrieve</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">req</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">String</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.class</span></span>)<span class="hljs-selector-class"><span class="hljs-selector-class">.blockingSingle</span></span>();</code> </pre> <br><h3 id="konfiguraciya">  Konfigurasi </h3><br><p>  Dalam sebuah proyek, Anda dapat menyoroti hal-hal yang mengubah dan memengaruhi logika bisnis atau beberapa aspek tertentu.  Mari kita membuat daftar mata uang fiat yang didukung sebagai properti dan menyuntikkannya di awal aplikasi. </p><br><p>  Kode berikut akan membuang kode mata uang yang kami belum dapat menghitung nilai portofolio: </p><br><pre> <code class="hljs javascript">public BigDecimal getFiatPrice(<span class="hljs-built_in"><span class="hljs-built_in">String</span></span> baseCurrency, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> counterCurrency) throws NotSupportedFiatException { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!supportedCounterCurrencies.contains(counterCurrency)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotSupportedFiatException(<span class="hljs-string"><span class="hljs-string">"Counter currency not supported: "</span></span> + counterCurrency); } <span class="hljs-built_in"><span class="hljs-built_in">Map</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; rates = cbrExchangeRatesClient.getRates(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rates.get(baseCurrency); }</code> </pre> <br><p>  Karenanya, tujuan kami adalah untuk menyuntikkan nilai dari <code>application.yml</code> ke dalam variabel yang <code>supportedCounterCurrencies</code> . </p><br><p>  Di versi pertama, kode tersebut ditulis, di bawah bidang kelas FiatExchangeRatesService.java: </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${cryptonaut.currencies:RUR}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String supportedCurrencies; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;String&gt; supportedCounterCurrencies = Arrays.asList(supportedCurrencies.split(<span class="hljs-string"><span class="hljs-string">"[,]"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre> <br><p>  Di sini, <code>placeholder</code> terkait dengan struktur dokumen <code>application.yml</code> : </p><br><pre> <code class="hljs pgsql">micronaut: application: <span class="hljs-type"><span class="hljs-type">name</span></span>: cryptonaut #Uncomment <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> port <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: port: <span class="hljs-number"><span class="hljs-number">8080</span></span> postgres: reactive: client: port: <span class="hljs-number"><span class="hljs-number">5432</span></span> host: localhost <span class="hljs-keyword"><span class="hljs-keyword">database</span></span>: cryptonaut <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>: crypto <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>: r1ch13r1ch maxSize: <span class="hljs-number"><span class="hljs-number">5</span></span> # app / business logic specific properties cryptonaut: currencies: "RUR"</code> </pre> <br><p>  Peluncuran aplikasi, uji asap cepat ... Kesalahan! </p><br><pre> <code class="hljs dos">Caused by: io.micronaut.context.exceptions.BeanInstantiationException: Error instantiating bean of <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> [com.room606.cryptonaut.markets.CryptoMarketDataService] <span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> Taken: new MarketDataController([CryptoMarketDataService cryptoMarketDataService],FiatExchangeRatesService fiatExchangeRatesService) --&gt; new CryptoMarketDataService([FiatExchangeRatesService fiatExchangeRatesService],MarketDataServiceFactory marketDataServiceFactory) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.doCreateBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1266</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.createAndRegisterSingleton(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1677</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBeanForDefinition(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1447</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBeanInternal(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1427</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.getBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">852</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.AbstractBeanDefinition.getBeanForConstructorArgument(AbstractBeanDefinition.java:<span class="hljs-number"><span class="hljs-number">943</span></span>) ... <span class="hljs-number"><span class="hljs-number">36</span></span> common frames omitted Caused by: java.lang.NullPointerException: null <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService.&lt;init&gt;(FiatExchangeRatesService.java:<span class="hljs-number"><span class="hljs-number">20</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> com.room606.cryptonaut.markets.$FiatExchangeRatesServiceDefinition.build(Unknown Source) <span class="hljs-built_in"><span class="hljs-built_in">at</span></span> io.micronaut.context.DefaultBeanContext.doCreateBean(DefaultBeanContext.java:<span class="hljs-number"><span class="hljs-number">1252</span></span>) ... <span class="hljs-number"><span class="hljs-number">41</span></span> common frames omitted</code> </pre> <br><p>    <code>Micronaut</code>    <code>Spring</code>        ,        <code>compile time</code> .       ,     : </p><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"</span></span><span class="hljs-subst"><span class="hljs-meta"><span class="hljs-meta-string"><span class="hljs-subst">${cryptonaut.currencies:RUR}</span></span></span></span><span class="hljs-meta"><span class="hljs-meta-string">"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String supportedCurrencies; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;String&gt; supportedCounterCurrencies; <span class="hljs-meta"><span class="hljs-meta">@PostConstruct</span></span> void <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>() { supportedCounterCurrencies = Arrays.asList(supportedCurrencies.split(<span class="hljs-string"><span class="hljs-string">"[,]"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>)); }</code> </pre> <br><p> ,    – <code>javax.annotation.PostConstruct</code> ,        ,    ,     ,        .     . </p><br><p>  , ,        Spring.    micronaut    <code>@Property</code>       <code>Map&lt;String, String&gt;</code> ,  <code>@Configuration</code>    , <code>Random Properties</code> (,      <code>ID</code>  , ,   -   )    <code>PropertySourceLoader</code> , ..   .    <code>Spring</code> –   <code>ApplicationContext</code> ( <code>xml</code> , <code>web</code> , <code>groovy</code> , <code>ClassPath</code> etc.) ,              . </p><br><h3 id="testy">  Tes </h3><br><p>       ,   micronaut.   Embedded Server feature,       <code>Groovy</code>    <code>Spock</code> .      <code>Java</code> ,  groovy-   . ,    <code>EmbeddedServer</code> + <code>HttpClient</code>   <code>Micronaut</code>      API — </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">GET</span></span> /cryptonaut/restapi/portfolio/total.json?fiatCurrency={x}</code> </pre> <br><p>  API,              . </p><br><p>    : </p><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioReportsControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> EmbeddedServer <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> HttpClient <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>; @Inject <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PortfolioService portfolioService; @BeforeClass <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> setupServer() { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> = ApplicationContext.run(EmbeddedServer.class); <span class="hljs-keyword"><span class="hljs-keyword">client</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">server</span></span> .getApplicationContext() .createBean(HttpClient.class, <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.getURL()); } @AfterClass <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> stopServer() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.stop(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.stop(); } } @Test <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> total() { <span class="hljs-comment"><span class="hljs-comment">//</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Seems like code smell. I don't like it.. portfolioService = server.getApplicationContext().getBean(PortfolioService.class); Portfolio portfolio = new Portfolio(); Map&lt;String, BigDecimal&gt; coins = new HashMap&lt;&gt;(); BigDecimal amt1 = new BigDecimal("570.05"); BigDecimal amt2 = new BigDecimal("2.5"); coins.put("XRP", amt1); coins.put("QTUM", amt2); portfolio.setCoins(coins); portfolioService.savePortfolio(portfolio); HttpRequest request = HttpRequest.GET("/cryptonaut/restapi/portfolio/total.json?fiatCurrency=USD"); HttpResponse&lt;Total&gt; rsp = client.toBlocking().exchange(request, Total.class); assertEquals(200, rsp.status().getCode()); assertEquals(MediaType.APPLICATION_JSON_TYPE, rsp.getContentType().get()); Total val = rsp.body(); assertEquals("USD", val.getFiatCurrency()); assertEquals(TEST_VALUE.toString(), val.getValue().toString()); assertEquals(amt1.toString(), val.getPortfolio().getCoins().get("XRP").toString()); assertEquals(amt2.toString(), val.getPortfolio().getCoins().get("QTUM").toString()); } }</span></span></code> </pre> <br><p>      ,       mock   <code>PortfolioService.java</code> : </p><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.room606.cryptonaut; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.room606.cryptonaut.domain.Portfolio; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io.micronaut.context.annotation.Requires; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.inject.Singleton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Optional; <span class="hljs-meta"><span class="hljs-meta">@Singleton</span></span> <span class="hljs-meta"><span class="hljs-meta">@Requires</span></span>(env=<span class="hljs-string"><span class="hljs-string">"test"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockPortfolioService</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PortfolioService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Portfolio portfolio; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BigDecimal TEST_VALUE = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"56.65"</span></span>); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">savePortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.portfolio = portfolio; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Portfolio </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loadPortfolio</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> portfolio; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Optional&lt;BigDecimal&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateTotalValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Portfolio portfolio, String fiatCurrency)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Optional.of(TEST_VALUE); } }</code> </pre> <br><p>       <code>@Requires(env="test")</code> ,        <code>Application Context</code>  . -,     micronaut     test,     ,        . ,            ,   <code>PortfolioServiceImpl</code>     <code>@Requires(notEnv="test")</code> .               –      .  <code>Micronaut</code>            . </p><br><p>  ,   –   ,     ,   –        <code>mockito</code> .       : </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">priceForUsdDirectRate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException </span></span>{ when(marketDataServiceFactory.getMarketDataService()).thenReturn(marketDataService); String coinCode = <span class="hljs-string"><span class="hljs-string">"ETH"</span></span>; String fiatCurrencyCode = <span class="hljs-string"><span class="hljs-string">"USD"</span></span>; BigDecimal priceA = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(<span class="hljs-string"><span class="hljs-string">"218.58"</span></span>); Ticker targetTicker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Ticker.Builder().bid(priceA).build(); when(marketDataService.getTicker(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CurrencyPair(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(coinCode), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Currency(fiatCurrencyCode)))).thenReturn(targetTicker); CryptoMarketDataService cryptoMarketDataService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CryptoMarketDataService(fiatExchangeRatesService, marketDataServiceFactory); assertEquals(priceA, cryptoMarketDataService.getPrice(coinCode, fiatCurrencyCode)); }</code> </pre> <br><h3 id="keshirovanie">  </h3><br><p>  ,       .            .    ,          . ,         ,      -   IP.     ,            <code>@Cacheable</code>    . <br></p><br><img src="https://habrastorage.org/webt/yz/xn/mc/yzxnmcojgibaurai_jflh202xic.jpeg" alt="Cache"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Namun, semuanya benar-benar gagal di sini. </font><font style="vertical-align: inherit;">Dokumentasi dalam aspek ini membingungkan, di mana setelah menggulir beberapa layar Anda menemukan potongan-potongan konfigurasi yang saling bertentangan ( </font></font><code>appliction.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Sebagai cache, redis dipilih, juga diangkat dalam wadah Docker di sebelahnya. </font><font style="vertical-align: inherit;">Ini konfigurasinya:</font></font><br><pre> <code class="hljs mel">redis: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: <span class="hljs-string"><span class="hljs-string">'bitnami/redis:latest'</span></span> environment: - ALLOW_EMPTY_PASSWORD=yes ports: - <span class="hljs-string"><span class="hljs-string">'6379:6379'</span></span></code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dan di sini adalah sepotong kode yang dijelaskan oleh @Cacheable: </font></font></p><br><pre> <code class="hljs vbscript">@Cacheable(<span class="hljs-string"><span class="hljs-string">"fiatRates"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Map&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; getRates() { HttpRequest&lt;?&gt; req = HttpRequest.<span class="hljs-keyword"><span class="hljs-keyword">GET</span></span>(<span class="hljs-string"><span class="hljs-string">""</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> <span class="hljs-built_in"><span class="hljs-built_in">response</span></span> = httpClient.retrieve(req, <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>).blockingSingle(); try { JsonNode json = objectReader.readTree(<span class="hljs-built_in"><span class="hljs-built_in">response</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> usdPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"USD"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> eurPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"EUR"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> gbpPrice = json.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Valute"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"GBP"</span></span>).<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(<span class="hljs-string"><span class="hljs-string">"Value"</span></span>).asText(); Map&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>, BigDecimal&gt; prices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;&gt;(); prices.put(<span class="hljs-string"><span class="hljs-string">"USD"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(usdPrice)); prices.put(<span class="hljs-string"><span class="hljs-string">"GBP"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(gbpPrice)); prices.put(<span class="hljs-string"><span class="hljs-string">"EUR"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BigDecimal(eurPrice)); return prices; } catch (IOException e) { throw <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(e); } }</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tetapi dengan </font></font><code>application.yml</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adalah misteri yang paling penting. </font><font style="vertical-align: inherit;">Saya mencoba segala macam konfigurasi. </font><font style="vertical-align: inherit;">Ini satu:</font></font></p><br><pre> <code class="hljs pgsql">caches: fiatrates: expireAfterWrite: "1h" redis: caches: fiatRates: expireAfterWrite: "1h" port: <span class="hljs-number"><span class="hljs-number">6379</span></span> <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>: localhost</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ini satu: </font></font></p><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#cache redis: uri: localhost:6379 caches: fiatRates: expireAfterWrite: </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1h"</span></span></span></span></code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dan bahkan mencoba untuk menghapus huruf besar dalam nama cache. </font><font style="vertical-align: inherit;">Tetapi sebagai hasilnya, saya mendapatkan hasil yang sama ketika memulai aplikasi - "Terjadi kesalahan tak terduga: Tidak ada cache yang dikonfigurasi untuk nama: fiatRates":</font></font></p><br><pre> <code class="hljs sql">ERROR imhsnetty.RoutingInBoundHandler - Unexpected error occurred: No <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: fiatRates io.micronaut.context.exceptions.ConfigurationException: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> configured <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>: fiatRates <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.DefaultCacheManager.getCache(DefaultCacheManager.java:<span class="hljs-number"><span class="hljs-number">67</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.interceptor.CacheInterceptor.interceptSync(CacheInterceptor.java:<span class="hljs-number"><span class="hljs-number">176</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.cache.interceptor.CacheInterceptor.intercept(CacheInterceptor.java:<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.aop.MethodInterceptor.intercept(MethodInterceptor.java:<span class="hljs-number"><span class="hljs-number">41</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> io.micronaut.aop.chain.InterceptorChain.proceed(InterceptorChain.java:<span class="hljs-number"><span class="hljs-number">147</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.markets.clients.$CbrExchangeRatesClientDefinition$Intercepted.getRates(<span class="hljs-literal"><span class="hljs-literal">Unknown</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Source</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.markets.FiatExchangeRatesService.getFiatPrice(FiatExchangeRatesService.java:<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.rest.MarketDataController.index(MarketDataController.java:<span class="hljs-number"><span class="hljs-number">34</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">at</span></span> com.room606.cryptonaut.rest.$MarketDataControllerDefinition$$exec2.invokeInternal(<span class="hljs-literal"><span class="hljs-literal">Unknown</span></span> ...</code> </pre> <br><p>     <code>GitHub</code> -   <code>SO</code>    .          .  , .          ,       .   boilerplate-,    -  <code>Redis</code> -   ,    ,   Spring Boot  ,         . </p><br><h3 id="sidim-v-kustah-s-sekundomerom">      </h3><br><p>          ,      <code>Micronaut</code> –    ,             Spring-. <br></p><br><img src="https://habrastorage.org/webt/6z/nu/h5/6znuh5vgxk7g0vueo5vs1ktkznc.jpeg" alt="Benchmarking"><br><br>        Disclaimer-:  ,    -,       ,    ( ,  , , ). <br><p> ,  : </p><br><p> <strong>OS:</strong> 16.04.1-Ubuntu x86_64 x86_64 x86_64 GNU/Linux <br> <strong>CPU:</strong> Intel® Core(TM) i7-7700HQ CPU @ 2.80GHz <br> <strong>Mem:</strong> 2   8 Gb DDR4, Speed: 2400 MHz <br> <strong>SSD Disk:</strong>   PCIe NVMe M.2, 256  </p><br><p>  <del>  </del> : </p><br><ol><li>   </li><li>   </li><li>   </li><li>          API,      </li><li>     API  – “” . </li><li>        </li></ol><br><p>             –  <code>Rest Controller</code>    –  IoC-,     . </p><br><p>    “ ”    : </p><br><table><thead><tr><th></th><th> Micronaut </th><th> Spring Boot </th></tr></thead><tbody><tr><td> Avg.(ms) </td><td> 2708.4 </td><td> 2735.2 </td></tr><tr><td>   cryptonaut    (ms) </td><td> 1082 </td><td>  - </td></tr></tbody></table><br><p>  ,         –  <strong>27</strong>    <code>Micronaut</code> . ,               . </p><br><h3 id="chto-po-itogu">   ? </h3><br><p>   .  ,   , ,      –  .            .      Groovy-,    ,    .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u="><code>SO</code></a>     Spring.  ,  ,                .         —       .           Spring. </p><br><p> <strong>   :</strong> </p><br><ul><li>      Micronaut –  service-discovery,    AWS </li><li>  </li><li>      Java.    Kotlin   Groovy. </li></ul><br><p>     <a href=""></a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id427595/">https://habr.com/ru/post/id427595/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id427585/index.html">Resep untuk game MMO yang populer dan sukses.</a></li>
<li><a href="../id427587/index.html">Jawa terkonsentrasi untuk satu setengah ribu orang. Bagaimana Joker 2018</a></li>
<li><a href="../id427589/index.html">Kami menulis obrolan online di Websockets menggunakan Swoole</a></li>
<li><a href="../id427591/index.html">Arsitektur sebagai beban</a></li>
<li><a href="../id427593/index.html">Magic Perintah Cepat di Vivaldi 2.1</a></li>
<li><a href="../id427601/index.html">Kasus 5 + 1 di mana spesifikasi REST API memainkan peran besar</a></li>
<li><a href="../id427603/index.html">Cara akhirnya mulai menulis tes dan tidak menyesalinya</a></li>
<li><a href="../id427605/index.html">Bagaimana platform crowdsourcing Yandex membantu melatih drone dan mengevaluasi kualitas layanan</a></li>
<li><a href="../id427607/index.html">Datacenter di Swiss: bekerja seperti jarum jam</a></li>
<li><a href="../id427609/index.html">Memecahkan persamaan dengan pembagian integer tanpa kekuatan kasar</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>