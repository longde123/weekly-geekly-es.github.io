<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë¶‚Äçüë¶ ‚õîÔ∏è üë©üèø‚Äçüè≠ Mega Servidor Arduino e Rel√≥gio em Tempo Real üçø üë©üèæ‚Äçü§ù‚Äçüë©üèª ü¶Å</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, voc√™ aprender√° como o Arduino Mega Server funciona com o tempo e como criar projetos no Arduino vinculados em tempo real, independenteme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mega Servidor Arduino e Rel√≥gio em Tempo Real</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/385349/"><img src="https://habrastorage.org/files/ce4/e16/81f/ce4e1681f98841af80ec3eeef2fce455.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Neste artigo, voc√™ aprender√° como o Arduino Mega Server funciona com o tempo e como criar projetos no Arduino vinculados em tempo real, independentemente de terem ou n√£o um m√≥dulo RTC "de ferro" instalado. </font><font style="vertical-align: inherit;">Todas as quest√µes relacionadas ao trabalho em tempo real no Arduino ser√£o discutidas em detalhes e, depois de ler este artigo, voc√™ se tornar√° um verdadeiro "relojoeiro".</font></font><br>
<a name="habracut"></a><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ess√™ncia da quest√£o</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Qualquer projeto mais ou menos s√©rio no Arduino deve ter uma id√©ia do tempo real atual. Por exemplo, as leituras do sensor devem ter limite de tempo (caso contr√°rio, seria imposs√≠vel criar estat√≠sticas e at√© gr√°ficos elementares), o controlador deve executar determinadas a√ß√µes, dependendo da hora atual do dia, fins de semana, feriados etc. Se o seu controlador n√£o tiver id√©ia em tempo real, ele se transforma em uma m√°quina simples que s√≥ pode executar a√ß√µes b√°sicas em um programa rigidamente definido. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Desde o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Arduino Mega Server</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">como √© um sistema poderoso e desenvolvido, esse estado de coisas (falta de trabalho em tempo real) n√£o pode ser adequado para mim e para todos os outros usu√°rios do sistema. </font><font style="vertical-align: inherit;">Portanto, a quest√£o da integra√ß√£o no sistema RTC foi uma das primeiras da agenda.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rel√≥gio virtual em tempo real</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tudo ficaria bem, mas nem eu, nem a maioria dos usu√°rios de AMS possu√≠mos o mesmo m√≥dulo RTC "de ferro", por isso foi decidido fazer um "passeio a cavalo" e, como medida tempor√°ria, organizar rel√≥gios em tempo real trabalhando dentro do sistema, sem m√≥dulo f√≠sico real. </font><font style="vertical-align: inherit;">Qual foi implementado com sucesso. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ent√£o, como organizar um RTC virtual, sem um m√≥dulo real. </font><font style="vertical-align: inherit;">Existe uma maravilhosa </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioteca do Tempo,</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que faz a maior parte do trabalho de nos fornecer um tempo preciso. </font><font style="vertical-align: inherit;">Para come√ßar a trabalhar com ele, √© necess√°rio fazer o download, descompacte-o e coloque-o no local padr√£o de todas as bibliotecas do ambiente Arduino, a saber, na pasta:</font></font><br>
<br>
<pre><code class="java hljs">\rduino\libraries\
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Depois disso, todas as possibilidades de trabalhar com o tempo que ele fornece se tornam dispon√≠veis para n√≥s.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como funciona</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O princ√≠pio √© muito simples. A biblioteca ‚Äúlan√ßa‚Äù o rel√≥gio virtual ‚Äúdentro‚Äù do controlador e fornece a capacidade de sincroniz√°-los de v√°rias maneiras, para escolher. Voc√™ pode escolher o m√©todo que melhor lhe convier. Como o Mega Server do Arduino √© um dispositivo de rede, foi escolhida a op√ß√£o de sincronizar o rel√≥gio atrav√©s da rede com a hora exata dos servidores. Podem ser servidores na Internet ou servidores na rede local na qual o servi√ßo correspondente est√° sendo executado. Por exemplo, na vers√£o b√°sica do AMS, o rel√≥gio √© sincronizado com o servidor </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MajorDoMo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , e voc√™ n√£o precisa configurar nada para isso, tudo funciona </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">imediatamente</font></a><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, para que isso funcione, voc√™ precisa conectar as bibliotecas apropriadas no in√≠cio do esbo√ßo.</font></font><br>
<br>
<pre><code class="java hljs">#include &lt;SPI.h&gt;<font></font>
#include &lt;Ethernet.h&gt;<font></font>
#include &lt;EthernetUdp.h&gt;<font></font>
#include &lt;Time.h&gt; <font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O arquivo Time.h √© realmente uma biblioteca para trabalhar com o tempo, e o restante dos arquivos √© necess√°rio para trabalhar com a rede e para sincronizar o tempo usando o protocolo NTP (a biblioteca Ethernet tamb√©m deve estar instalada no seu computador). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Em seguida, voc√™ precisa especificar o endere√ßo IP do servidor com o qual deseja sincronizar o hor√°rio</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function">IPAddress <span class="hljs-title">timeServer</span><span class="hljs-params">(<span class="hljs-number">192</span>, <span class="hljs-number">168</span>, <span class="hljs-number">2</span>, <span class="hljs-number">8</span>)</span></span>; <span class="hljs-comment">//   MajorDoMo  </span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e porta correspondente</font></font><br>
<br>
<pre><code class="java hljs">unsigned <span class="hljs-keyword">int</span> localPort = <span class="hljs-number">8888</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
mas h√° um ponto: a porta 8888 √© adequada para sincroniza√ß√£o em uma rede local e a maioria dos servidores na Internet n√£o responde a ela. Portanto, se voc√™ planeja sincronizar a hora com os servidores de hora exata na Internet, √© melhor definir a porta 123:</font></font><br>
<br>
<pre><code class="java hljs">unsigned <span class="hljs-keyword">int</span> localPort = <span class="hljs-number">123</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
resta apenas indicar o fuso hor√°rio</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> timeZone = <span class="hljs-number">4</span>;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e crie um objeto EthernetUDP</font></font><br>
<br>
<pre><code class="java hljs">EthernetUDP Udp;
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Com isso, as opera√ß√µes preparat√≥rias podem ser consideradas conclu√≠das e voc√™ pode descrever a funcionalidade necess√°ria para trabalhar com o tempo. </font><font style="vertical-align: inherit;">Fun√ß√£o de inicializa√ß√£o:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rtcInit</span><span class="hljs-params">()</span> </span>{<font></font>
  Udp.begin(localPort);<font></font>
  Serial.println(<span class="hljs-string">"Waiting for NTP sync..."</span>);<font></font>
  setSyncProvider(getNtpTime);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui voc√™ precisa prestar aten√ß√£o √† fun√ß√£o</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(getNtpTime);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esta fun√ß√£o define a fonte de sincroniza√ß√£o da hora (neste caso, sincroniza√ß√£o NTP atrav√©s da rede). Mas poderia ser qualquer outra fonte, por exemplo, o m√≥dulo RTC f√≠sico. O desempenho desta fun√ß√£o leva √† instala√ß√£o de uma fonte de sincroniza√ß√£o (para o futuro) e, ao mesmo tempo, √† pr√≥pria sincroniza√ß√£o de tempo atrav√©s dessa fonte. √â no momento de executar esta fun√ß√£o que a hora exata ‚Äúaparece‚Äù em seu sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A pr√≥pria biblioteca tem outro recurso interessante,</font></font><br>
<br>
<pre><code class="java hljs">setSyncInterval(interval);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
que permite definir o intervalo desejado entre as sincroniza√ß√µes (definido em segundos, a sincroniza√ß√£o ocorre automaticamente, sem a participa√ß√£o de sua parte). </font></font><br>
<br>
<img src="https://habrastorage.org/files/994/655/c68/994655c686114b5c897a038f300e1e61.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora voc√™ pode usar a hora exata dentro do esbo√ßo do Arduino, por exemplo, exibir eventos no monitor serial n√£o √© f√°cil, mas vinculado a uma hora exata espec√≠fica. </font><font style="vertical-align: inherit;">Isso √© feito usando a fun√ß√£o timeStamp ():</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">timeStamp</span><span class="hljs-params">()</span> </span>{<font></font>
  serialRTC();<font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
que √© um wrapper para a fun√ß√£o serialRTC ():</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">serialRTC</span><span class="hljs-params">()</span> </span>{<font></font>
  Serial.print(year()); <font></font>
  Serial.print(<span class="hljs-string">"-"</span>);<font></font>
  printDigits(month());<font></font>
  Serial.print(<span class="hljs-string">"-"</span>);<font></font>
  printDigits(day());<font></font>
  Serial.print(<span class="hljs-string">" "</span>);<font></font>
  printDigits(hour());<font></font>
  Serial.print(<span class="hljs-string">":"</span>);<font></font>
  printDigits(minute());<font></font>
  Serial.print(<span class="hljs-string">":"</span>);<font></font>
  printDigits(second());<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A an√°lise do mecanismo de transmiss√£o e exibi√ß√£o de tempo na interface da Web do AMS est√° al√©m do escopo desta hist√≥ria e √© digna de um artigo separado. Se houver interesse, podemos escrever uma sequela e explicar em detalhes como a ‚Äúm√°gica‚Äù do tempo √© exibida na interface da web do Arduino Mega. Servidor </font></font><br>
<br>
<img src="https://habrastorage.org/files/ca9/d1c/bec/ca9d1cbec3084d169566dbaa1cf2cf99.png" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Na verdade, √© tudo. </font><font style="vertical-align: inherit;">√â assim que os rel√≥gios virtuais em tempo real foram organizados no AMS at√© a vers√£o 0.12, inclusive, e voc√™ tamb√©m pode organizar o trabalho com tempo preciso em seus projetos, mesmo se voc√™ n√£o tiver um m√≥dulo f√≠sico para rel√≥gios em tempo real. </font><font style="vertical-align: inherit;">Mas este n√£o √© o fim da hist√≥ria, mas apenas o come√ßo.</font></font><br>
<br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√≥digo completo do m√≥dulo RTC do Arduino Mega Server 0.12</font></font></b><div class="spoiler_text">/*<br>
 Modul Virtual RTC<br>
 part of Arduino Mega Server project<br>
*/<br>
<br>
// Virtual RTC<br>
<br>
IPAddress timeServer(192, 168, 2, 8);<br>
unsigned int localPort = 8888; // local port to listen for UDP packets<br>
EthernetUDP Udp;<br>
<br>
const int timeZone = 4;<br>
time_t prevDisplay = 0; // when the digital clock was displayed<br>
<br>
void rtcInit() {<br>
 Udp.begin(localPort);<br>
 Serialprint(¬´Waiting for NTP sync‚Ä¶ \n¬ª);<br>
 setSyncProvider(getNtpTime);<br>
 modulRtc = 1;<br>
}<br>
<br>
void rtcWorks() {<br>
 if (timeStatus() != timeNotSet) {<br>
 if (now() != prevDisplay) { // update the display only if time has changed<br>
 setLifer();<br>
 prevDisplay = now();<br>
 //digitalClockDisplay(); <br>
 }<br>
 }<br>
}<br>
<br>
void printDigits(int digits) {<br>
 if(digits &lt; 10) {<br>
 Serial.print('0');<br>
 }<br>
 Serial.print(digits);<br>
}<br>
<br>
void serialRTC() {<br>
 Serial.print(year()); <br>
 Serial.print("-");<br>
 printDigits(month());<br>
 Serial.print("-");<br>
 printDigits(day());<br>
 Serial.print(" ");<br>
 printDigits(hour());<br>
 Serial.print(":");<br>
 printDigits(minute());<br>
 Serial.print(":");<br>
 printDigits(second());<br>
}<br>
<br>
void timeStamp() {<br>
 serialRTC();<br>
 Serial.print(" ");<br>
}<br>
<br>
void printRTC(){<br>
 serialRTC();<br>
 Serial.println();<br>
}<br>
<br>
// NTP code<br>
<br>
const int NTP_PACKET_SIZE = 48; // NTP time is in the first 48 bytes of message<br>
byte packetBuffer[NTP_PACKET_SIZE]; //buffer to hold incoming &amp; outgoing packets<br>
<br>
#ifdef RTC_FEATURE<br>
<br>
time_t getNtpTime() {<br>
 while (Udp.parsePacket() &gt; 0); // discard any previously received packets<br>
 Serialprint(¬´Transmit NTP request\n¬ª);<br>
 sendNTPpacket(timeServer);<br>
 uint32_t beginWait = millis();<br>
 while (millis() ‚Äî beginWait &lt; 1500) {<br>
 int size = Udp.parsePacket();<br>
 if (size &gt;= NTP_PACKET_SIZE) {<br>
 Serialprint(¬´Receive NTP response\n¬ª);<br>
 Udp.read(packetBuffer, NTP_PACKET_SIZE); // read packet into the buffer<br>
 unsigned long secsSince1900;<br>
 // convert four bytes starting at location 40 to a long integer<br>
 secsSince1900 = (unsigned long)packetBuffer[40] &lt;&lt; 24;<br>
 secsSince1900 |= (unsigned long)packetBuffer[41] &lt;&lt; 16;<br>
 secsSince1900 |= (unsigned long)packetBuffer[42] &lt;&lt; 8;<br>
 secsSince1900 |= (unsigned long)packetBuffer[43];<br>
 return secsSince1900 ‚Äî 2208988800UL + timeZone * SECS_PER_HOUR;<br>
 }<br>
 }<br>
 Serialprint(¬´No NTP response\n¬ª);<br>
 return 0; // return 0 if unable to get the time<br>
}<br>
<br>
// send an NTP request to the time server at the given address<br>
void sendNTPpacket(IPAddress &amp;address) {<br>
 // set all bytes in the buffer to 0<br>
 memset(packetBuffer, 0, NTP_PACKET_SIZE);<br>
 // Initialize values needed to form NTP request<br>
 // (see URL above for details on the packets)<br>
 packetBuffer[0] = 0b11100011; // LI, Version, Mode<br>
 packetBuffer[1] = 0; // Stratum, or type of clock<br>
 packetBuffer[2] = 6; // Polling Interval<br>
 packetBuffer[3] = 0xEC; // Peer Clock Precision<br>
 // 8 bytes of zero for Root Delay &amp; Root Dispersion<br>
 packetBuffer[12] = 49;<br>
 packetBuffer[13] = 0x4E;<br>
 packetBuffer[14] = 49;<br>
 packetBuffer[15] = 52;<br>
 // all NTP fields have been given values, now<br>
 // you can send a packet requesting a timestamp: <br>
 Udp.beginPacket(address, 123); //NTP requests are to port 123<br>
 Udp.write(packetBuffer, NTP_PACKET_SIZE);<br>
 Udp.endPacket();<br>
}<br>
<br>
#endif<br>
<br>
// Duration<br>
<br>
void showDuration(time_t duration) {<br>
 // prints the duration in days, hours, minutes and seconds<br>
 Serialprint(" (duration ");<br>
 if(duration &gt;= SECS_PER_DAY){<br>
 Serial.print(duration / SECS_PER_DAY);<br>
 Serialprint(" day "); <br>
 duration = duration % SECS_PER_DAY; <br>
 }<br>
 if(duration &gt;= SECS_PER_HOUR){<br>
 Serial.print(duration / SECS_PER_HOUR);<br>
 Serialprint(" hour "); <br>
 duration = duration % SECS_PER_HOUR; <br>
 }<br>
 if(duration &gt;= SECS_PER_MIN){<br>
 Serial.print(duration / SECS_PER_MIN);<br>
 Serialprint(" min "); <br>
 duration = duration % SECS_PER_MIN; <br>
 }<br>
 Serial.print(duration);<br>
 Serialprint(" sec) \n"); <br>
}<br>
<br>
void checkEvent(time_t* prevEvent) {<br>
 time_t duration = 0;<br>
 time_t timeNow = now();<br>
 <br>
 if (*prevEvent &gt; 0) {<br>
 duration = timeNow ‚Äî *prevEvent;<br>
 } <br>
 if (duration &gt; 0) {<br>
 showDuration(duration);<br>
 } <br>
 *prevEvent = timeNow;<br>
}<br>
<br>
</div></div><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uma surpresa agrad√°vel</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu n√£o estaria ocupado integrando m√≥dulos RTC ao sistema por um longo tempo (tamb√©m existem outras tarefas urgentes), mas aqui, no √¢mbito da coopera√ß√£o tecnol√≥gica com nosso projeto, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHIPSTER</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> forneceu </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">equipamentos</font></a><font style="vertical-align: inherit;"> para teste e integra√ß√£o ao AMS, entre os quais havia m√≥dulos Ethernet baseados no chip </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">W5500</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e ... o m√≥dulo de rel√≥gio em tempo real no chip </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DS3231</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que se mostrou o mais oportuno e serviu de impulso para a integra√ß√£o dos m√≥dulos RTC no sistema. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Verificou-se que a empresa CHIPSTER n√£o apenas vende equipamentos eletr√¥nicos, mas tamb√©m desenvolve seus pr√≥prios produtos para Arduino e automa√ß√£o sob a marca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Geegrow</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e tem grandes planos para o futuro nessa dire√ß√£o, em particular, ela tem um projeto para o lan√ßamento de uma vers√£o especializada do Arduino Mega 2560 com recursos avan√ßados e "aprimorados" especificamente para o Arduino Mega Server. </font><font style="vertical-align: inherit;">E, se este f√≥rum for lan√ßado, ser√° um evento muito interessante. </font><font style="vertical-align: inherit;">Mas voltando ao rel√≥gio em tempo real.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Rel√≥gio de tempo real</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como o m√≥dulo RTC estava ao meu alcance, seria pecado n√£o integr√°-lo ao sistema. Felizmente, isso acabou sendo muito simples, gra√ßas √† mesma biblioteca de tempo. Mas as primeiras coisas primeiro. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para quem n√£o sabe, existem dois tipos de m√≥dulos em tempo real - "comum" (geralmente em um chip DS1307) e "avan√ßado" (em um chip DS3231, que eu recebi). A diferen√ßa entre os dois √© que os primeiros n√£o s√£o muito precisos e podem "fugir" muito rapidamente e com muita for√ßa, e o segundo √© um rel√≥gio de alta precis√£o com atendimento normalizado de n√£o mais de dois minutos por ano, ou seja, realmente aplic√°vel na pr√°tica. E a precis√£o √© alcan√ßada gra√ßas a um projeto de circuito mais complexo e compensa√ß√£o t√©rmica integrada.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por√©m, programaticamente, ambas as vers√µes dos m√≥dulos s√£o compat√≠veis e funcionam com a biblioteca e o c√≥digo. </font><font style="vertical-align: inherit;">A diferen√ßa estar√° apenas na precis√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, √© claro, uma das principais propriedades de um rel√≥gio em tempo real √© a capacidade de trabalhar quando a energia √© desligada, devido √† bateria embutida.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conex√£o f√≠sica</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora vamos falar sobre como conectar fisicamente o m√≥dulo RTC ao Mega Server do Arduino ou ao seu projeto do Arduino. Devo dizer que isso √© muito simples e voc√™ precisar√° de apenas dois resistores e alguns fios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A conex√£o √© trivial: voc√™ precisa encontrar quatro contatos em seu m√≥dulo - GND (terra), VCC (tens√£o de alimenta√ß√£o), SCL (sinal de rel√≥gio), SDA (dados). Outros contatos s√£o usados ‚Äã‚Äãem casos raros e espec√≠ficos e voc√™ pode ignor√°-los. </font></font><br>
<br>
<img src="https://habrastorage.org/files/7ec/49a/566/7ec49a56688f40f2a824adef2f625774.jpg" alt="imagem"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, conectamos o pino GND ao terra, o pino VCC √† tens√£o de alimenta√ß√£o do controlador. Tudo √© simples aqui e nenhuma pergunta deve surgir.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O restante das conclus√µes n√£o √© muito mais complicado. </font><font style="vertical-align: inherit;">O m√≥dulo RTC se comunica com o controlador por meio da interface I2C, que possui apenas dois fios: sincroniza√ß√£o e dados, e os controladores Arduino j√° possuem contatos para conectar essa interface. </font><font style="vertical-align: inherit;">O Arduino Uno √© A4 (SDA) e A5 (SCL), enquanto o arduino Mega √© D20 (SDA) e D21 (SCL). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A √∫nica sutileza √© que os pinos SCL e SDA precisam ser "puxados" para a fonte de energia atrav√©s de resistores de 4,7 kŒ©. </font><font style="vertical-align: inherit;">Se voc√™ n√£o tiver exatamente essa classifica√ß√£o, poder√° usar resistores na faixa de 2 KOhm a 10 KOhm.</font></font><br>
<br>
<img src="https://habrastorage.org/files/490/875/26d/49087526d1544d56947ee66ed7b19150.jpg" alt="imagem"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Suporte de software</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, resta apenas adicionar suporte ao m√≥dulo no c√≥digo AMS ou no seu projeto. </font><font style="vertical-align: inherit;">Como eu disse, ser√° muito simples, porque a mesma biblioteca de tempo funcionar√° com o m√≥dulo. </font><font style="vertical-align: inherit;">√â verdade que precisaremos adicionar outra biblioteca, a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">biblioteca DS1307RTC</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tamb√©m o descompactamos e o colocamos na pasta da biblioteca padr√£o:</font></font><br>
<br>
<pre><code class="java hljs">\rduino\libraries\
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Adicione as seguintes linhas ao seu c√≥digo de esbo√ßo</font></font><br>
<br>
<pre><code class="java hljs">#include &lt;Wire.h&gt;<font></font>
#include &lt;DS1307RTC.h&gt;<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora estamos totalmente equipados e podemos come√ßar a escrever o c√≥digo para o pr√≥prio esbo√ßo, trabalhando com o m√≥dulo f√≠sico RTC. </font><font style="vertical-align: inherit;">Em fun√ß√£o</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rtcInit</span><span class="hljs-params">()</span> </span>{<font></font>
  Udp.begin(localPort);<font></font>
  Serial.println(<span class="hljs-string">"Waiting for NTP sync..."</span>);<font></font>
  setSyncProvider(getNtpTime);<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
substituir string</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(getNtpTime);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
no</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(RTC.get);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e o hor√°rio interno do Arduino Mega Server (ou do seu controlador) ser√° sincronizado com o controlador RTC "iron", e n√£o com os servidores na Internet ou na rede local. </font><font style="vertical-align: inherit;">Assim, chamando as fun√ß√µes setSyncProvider (getNtpTime) e setSyncProvider (RTC.get), voc√™ pode manipular as fontes de sincroniza√ß√£o de tempo e sincronizar o tempo como desejar, dependendo de v√°rias condi√ß√µes. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Outra fun√ß√£o que voc√™ precisa conhecer √©</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-keyword">if</span> (timeStatus() != timeNotSet) {<font></font>
<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
que permite descobrir se a hora est√° sincronizada e, dependendo dessa condi√ß√£o, executar as a√ß√µes necess√°rias.</font></font><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Momento sutil</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Voc√™ precisa distinguir entre duas coisas: o tempo que passa no m√≥dulo RTC ‚Äúferro‚Äù e o tempo que passa no seu controlador. Isto n√£o √© a mesma coisa. A coisa ‚Äúprincipal‚Äù para voc√™ √© o tempo no controlador e o tempo no m√≥dulo √© apenas uma fonte para sincroniza√ß√£o. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas! como o tempo no RTC f√≠sico tamb√©m est√° gradualmente se esgotando, ele tamb√©m precisa ser ajustado pela sincroniza√ß√£o com fontes mais precisas, por exemplo, servidores na Internet. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o algoritmo ideal deve ser este: se poss√≠vel, sincronize todos os rel√≥gios com os servidores na Internet, se a rede estiver indispon√≠vel, ent√£o come√ßaremos a sincronizar o tempo no controlador com o m√≥dulo RTC, assim que a rede aparecer, volte para a sincroniza√ß√£o pela Internet.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se voc√™ estiver em condi√ß√µes extremas, sem acesso a nenhuma fonte de sincroniza√ß√£o, poder√° ajustar manualmente o curso do rel√≥gio de ferro de tempos em tempos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos, por exemplo, considerar a fun√ß√£o de sincroniza√ß√£o do rel√≥gio interno do controlador e do m√≥dulo RTC via rede:</font></font><br>
<br>
<pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">rtcSync</span><span class="hljs-params">()</span> </span>{<font></font>
  setSyncProvider(getNtpTime);<font></font>
  Serial.println(<span class="hljs-string">"...getNtpTime..."</span>);
  <span class="hljs-keyword">if</span> (timeStatus() != timeNotSet) {<font></font>
    Serial.println(<span class="hljs-string">"...set!..."</span>);<font></font>
    time_t t = getNtpTime();<font></font>
    RTC.set(t);<font></font>
    setSyncProvider(RTC.get);<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqui, obtemos o tempo exato pela rede.</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(getNtpTime);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
se for bem-sucedido, instale-o no m√≥dulo RTC</font></font><br>
<br>
<pre><code class="java hljs">RTC.set(t);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
e, a partir deste m√≥dulo, definimos o tempo do controlador</font></font><br>
<br>
<pre><code class="java hljs">setSyncProvider(RTC.get);
</code></pre><br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lan√ßamento inicial</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mas isso n√£o √© tudo. </font><font style="vertical-align: inherit;">H√° tamb√©m o problema da inicializa√ß√£o inicial, quando o m√≥dulo RTC est√° conectado apenas, mas o tempo n√£o est√° definido e, portanto, √© imposs√≠vel sincronizar com ele. </font><font style="vertical-align: inherit;">Voc√™ precisa, de alguma forma, definir a hora certa. </font><font style="vertical-align: inherit;">H√° duas maneiras de resolver esse problema no Mega Server do Arduino: voc√™ pode sincronizar o RTC f√≠sico pela rede (se houver servidores de hor√°rio exato) ou usar o utilit√°rio Arduino Serial Commander.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para definir a hora no m√≥dulo RTC, basta ... clicar no bot√£o. </font><font style="vertical-align: inherit;">Tudo o mais ser√° feito por voc√™ por dois jovens chamados Arduino Mega Server e Arduino Serial Commander. </font><font style="vertical-align: inherit;">Se voc√™ n√£o usa o AMS, mas est√° desenvolvendo seu pr√≥prio projeto, pode pegar o c√≥digo no kit de distribui√ß√£o do Arduino Mega Server (o c√≥digo est√° dispon√≠vel e totalmente gratuito) ou procurar uma solu√ß√£o para esse problema na Internet (existem v√°rias solu√ß√µes).</font></font><br>
<br>
<img src="https://habrastorage.org/files/df7/2b1/c4b/df72b1c4b4594bd082d9a0b8c7cdc6c6.png" alt="imagem"><br>
<br>
<h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vers√£o com suporte RTC real</font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O Arduino Mega Server, come√ßando na vers√£o 0.13, suporta RTC "iron". </font><font style="vertical-align: inherit;">Voc√™ pode fazer o download da vers√£o atual mais recente no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">site oficial do projeto</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e fazer suas perguntas no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f√≥rum</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E, √© claro, expresso minha gratid√£o √† </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CHIPSTER</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> pela coopera√ß√£o e pelo equipamento fornecido para teste e integra√ß√£o ( </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;">falarei</font></a><font style="vertical-align: inherit;"> sobre o m√≥dulo W5500 e a acelera√ß√£o da opera√ß√£o da rede AMS em um dos seguintes artigos). </font></font><br>
<br>
<strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adi√ß√£o</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Um canal do Youtube est√° aberto e aqui est√° um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">v√≠deo promocional do</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Arduino Mega Server, que demonstra como trabalhar com um sistema real.</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt385349/">https://habr.com/ru/post/pt385349/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt385339/index.html">Intel introduziu o SSD mais r√°pido</a></li>
<li><a href="../pt385341/index.html">Produzido artificialmente em carne de laborat√≥rio estar√° √† venda nos pr√≥ximos 5 anos</a></li>
<li><a href="../pt385343/index.html">Um pouco de m√°gica da Apple - novo Magic Keyboard, Trackpad, Mouse e iMac</a></li>
<li><a href="../pt385345/index.html">Martelo de Thor na vida real: scanner de impress√µes digitais e √≠m√£s</a></li>
<li><a href="../pt385347/index.html">Fabricante de computadores Bitcoin 21 Bitcoin lan√ßa cursos para desenvolvedores</a></li>
<li><a href="../pt385351/index.html">–í –ù–ê–°–ê –æ—Ç–≤–µ—Ä–≥–ª–∏ –ø—Ä–æ–µ–∫—Ç –¥–æ—Å—Ç–∞–≤–∫–∏ –æ—Ä–±–∏—Ç–∞–ª—å–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –æ—Ç Lockheed Martin –∫–∞–∫ —Å–ª–∏—à–∫–æ–º —Å–ª–æ–∂–Ω—ã–π –∏ –¥–æ—Ä–æ–≥–æ–π</a></li>
<li><a href="../pt385353/index.html">Foi criado um prot√≥tipo de um m√≥dulo acelerador de micropart√≠culas com 1,5 cm de comprimento</a></li>
<li><a href="../pt385355/index.html">–û–Ω–ª–∞–π–Ω-–ø–∏—Ä–∞—Ç—Å—Ç–≤–æ –≤ –ê–≤—Å—Ç—Ä–∞–ª–∏–∏ —É–º–µ–Ω—å—à–∏–ª–æ—Å—å –±–ª–∞–≥–æ–¥–∞—Ä—è Netflix</a></li>
<li><a href="../pt385361/index.html">Windows 10 Mobile ‚Äî –±–∏–ª–¥ 10549 –¥–æ—Å—Ç—É–ø–µ–Ω –∏–Ω—Å–∞–π–¥–µ—Ä–∞–º</a></li>
<li><a href="../pt385363/index.html">V√≠deo do piloto autom√°tico Tesla sobre tr√°fego urbano</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>