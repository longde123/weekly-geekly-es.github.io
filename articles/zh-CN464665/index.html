<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â›ºï¸ â˜€ï¸ ğŸ’º åœ¨SQL Serverä¸­åˆ†åŒº ğŸ’© ğŸ¿ï¸ ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="SQL Serverä¸­çš„åˆ†åŒºï¼ˆâ€œåˆ†åŒºâ€ï¼‰çœ‹ä¼¼ç®€å•ï¼ˆâ€œåœ¨é‚£é‡Œ-æ‚¨æŒ‰æ–‡ä»¶ç»„åˆ†å¸ƒè¡¨å’Œç´¢å¼•ï¼Œå¹¶ä»ç®¡ç†å’Œæ€§èƒ½ä¸­è·åˆ©â€ï¼‰æ˜¯ä¸€ä¸ªç›¸å½“å¹¿æ³›çš„ä¸»é¢˜ã€‚ ä¸‹é¢ï¼Œæˆ‘å°†å°è¯•æè¿°å¦‚ä½•åˆ›å»ºå’Œåº”ç”¨å‡½æ•°å’Œåˆ†åŒºæ–¹æ¡ˆä»¥åŠæ‚¨å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚ é™¤äº†ä¸€ä»¶äº‹-åˆ‡æ¢éƒ¨åˆ†ï¼Œå½“æ‚¨ç«‹å³ä»è¡¨ä¸­åˆ é™¤ä¸€ä¸ªå·¨å¤§çš„æ•°æ®é›†æ—¶ï¼Œæˆ‘å°†ä¸è°ˆè¿™äº›å¥½å¤„ã€‚åä¹‹äº¦ç„¶-ç«‹å³å°†ä¸€ä¸ª...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨SQL Serverä¸­åˆ†åŒº</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464665/"> SQL Serverä¸­çš„åˆ†åŒºï¼ˆâ€œåˆ†åŒºâ€ï¼‰çœ‹ä¼¼ç®€å•ï¼ˆâ€œåœ¨é‚£é‡Œ-æ‚¨æŒ‰æ–‡ä»¶ç»„åˆ†å¸ƒè¡¨å’Œç´¢å¼•ï¼Œå¹¶ä»ç®¡ç†å’Œæ€§èƒ½ä¸­è·åˆ©â€ï¼‰æ˜¯ä¸€ä¸ªç›¸å½“å¹¿æ³›çš„ä¸»é¢˜ã€‚ ä¸‹é¢ï¼Œæˆ‘å°†å°è¯•æè¿°å¦‚ä½•åˆ›å»ºå’Œåº”ç”¨å‡½æ•°å’Œåˆ†åŒºæ–¹æ¡ˆä»¥åŠæ‚¨å¯èƒ½é‡åˆ°çš„é—®é¢˜ã€‚ é™¤äº†ä¸€ä»¶äº‹-åˆ‡æ¢éƒ¨åˆ†ï¼Œå½“æ‚¨ç«‹å³ä»è¡¨ä¸­åˆ é™¤ä¸€ä¸ªå·¨å¤§çš„æ•°æ®é›†æ—¶ï¼Œæˆ‘å°†ä¸è°ˆè¿™äº›å¥½å¤„ã€‚åä¹‹äº¦ç„¶-ç«‹å³å°†ä¸€ä¸ªåŒæ ·å·¨å¤§çš„æ•°æ®é›†åŠ è½½åˆ°è¡¨ä¸­ã€‚ <br><a name="habracut"></a><br> å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">msdn</a>æ‰€è¨€ï¼šâ€œåˆ†åŒºè¡¨å’Œç´¢å¼•çš„æ•°æ®åˆ†ä¸ºå¤šä¸ªå—ï¼Œè¿™äº›å—å¯ä»¥åˆ†å¸ƒåœ¨æ•°æ®åº“ä¸­çš„å¤šä¸ªæ–‡ä»¶ç»„ä¸­ã€‚ æ•°æ®æ˜¯æ°´å¹³åˆ†åŒºçš„ï¼Œå› æ­¤è¡Œç»„è¢«æ˜ å°„åˆ°å„ä¸ªéƒ¨åˆ†ã€‚ ç›¸åŒç´¢å¼•æˆ–è¡¨çš„æ‰€æœ‰éƒ¨åˆ†å¿…é¡»ä½äºåŒä¸€æ•°æ®åº“ä¸­ã€‚ åœ¨å¯¹æ•°æ®æ‰§è¡ŒæŸ¥è¯¢æˆ–æ›´æ–°æ—¶ï¼Œè¡¨æˆ–ç´¢å¼•è¢«è§†ä¸ºå•ä¸ªé€»è¾‘å®ä½“ã€‚â€ <br><br> æ­¤å¤„è¿˜åˆ—å‡ºäº†ä¸»è¦ä¼˜ç‚¹ï¼š <br><br><ul><li> å¿«é€Ÿé«˜æ•ˆåœ°ä¼ è¾“å’Œè®¿é—®æ•°æ®å­é›†ï¼ŒåŒæ—¶ä¿æŒæ•°æ®é›†çš„å®Œæ•´æ€§ </li><li> ä¸€ä¸ªæˆ–å¤šä¸ªéƒ¨åˆ†å¯ä»¥æ›´å¿«åœ°æ‰§è¡Œç»´æŠ¤æ“ä½œï¼› </li><li> æ‚¨å¯ä»¥æé«˜æŸ¥è¯¢æ‰§è¡Œçš„é€Ÿåº¦ï¼Œå…·ä½“å–å†³äºç¡¬ä»¶é…ç½®ä¸­ç»å¸¸æ‰§è¡Œçš„æŸ¥è¯¢ã€‚ </li></ul><br> æ¢å¥è¯è¯´ï¼Œåˆ†åŒºç”¨äºæ°´å¹³ç¼©æ”¾ã€‚ è¡¨/ç´¢å¼•ç”±ä¸åŒçš„æ–‡ä»¶ç»„â€œæ•£å¸ƒâ€ï¼Œè¿™äº›æ–‡ä»¶ç»„å¯ä»¥ä½äºä¸åŒçš„ç‰©ç†ç£ç›˜ä¸Šï¼Œè¿™æ˜¾ç€å¢åŠ äº†ç®¡ç†çš„ä¾¿åˆ©æ€§ï¼Œå¹¶ä¸”ä»ç†è®ºä¸Šè®²ï¼Œæé«˜äº†å¯¹è¯¥æ•°æ®çš„æŸ¥è¯¢æ€§èƒ½-æ‚¨å¯ä»¥åªè¯»å–æ‰€éœ€çš„éƒ¨åˆ†ï¼ˆè¾ƒå°‘çš„æ•°æ®ï¼‰ï¼Œæˆ–è€…è¯»å–æ‰€æœ‰å†…å®¹å¹¶è¡Œï¼ˆè®¾å¤‡ä¸åŒï¼Œè¯»å–é€Ÿåº¦å¿«ï¼‰ã€‚ å®é™…ä¸Šï¼Œä¸€åˆ‡éƒ½æœ‰äº›å¤æ‚ï¼Œå¹¶ä¸”ä»…å½“æŸ¥è¯¢ä½¿ç”¨åˆ†åŒºä¾æ®çš„å­—æ®µè¿›è¡Œé€‰æ‹©æ—¶ï¼Œæé«˜å¯¹åˆ†åŒºè¡¨çš„æŸ¥è¯¢çš„æ€§èƒ½æ‰èƒ½èµ·ä½œç”¨ã€‚ å¦‚æœæ‚¨è¿˜æ²¡æœ‰åˆ†åŒºè¡¨çš„ç»éªŒï¼Œè¯·è®°ä½ï¼ŒæŸ¥è¯¢çš„æ€§èƒ½å¯èƒ½ä¸ä¼šæ”¹å˜ï¼Œä½†æ˜¯åœ¨å¯¹è¡¨è¿›è¡Œåˆ†åŒºåï¼Œæ€§èƒ½å¯èƒ½ä¼šä¸‹é™ã€‚ <br><br> è®©æˆ‘ä»¬è°ˆè°ˆæ‚¨è‚¯å®šä¼šä¸åˆ†åŒºç›¸å¤„çš„ç»å¯¹ä¼˜åŠ¿ï¼ˆä½†æ˜¯æ‚¨è¿˜éœ€è¦ä½¿ç”¨åˆ†åŒºï¼‰-è¿™è‚¯å®šä¼šæé«˜ç®¡ç†æ•°æ®åº“çš„ä¾¿åˆ©æ€§ã€‚ ä¾‹å¦‚ï¼Œæ‚¨æœ‰ä¸€ä¸ªåŒ…å«åäº¿æ¡è®°å½•çš„è¡¨ï¼Œå…¶ä¸­æœ‰9äº¿æ¡æ¥è‡ªæ—§ï¼ˆâ€œå°é—­â€ï¼‰æœŸé—´ï¼Œå¹¶ä¸”æ˜¯åªè¯»çš„ã€‚ åœ¨åˆ†åŒºçš„å¸®åŠ©ä¸‹ï¼Œæ‚¨å¯ä»¥å°†æ—§æ•°æ®ä¼ è¾“åˆ°ä¸€ä¸ªå•ç‹¬çš„åªè¯»æ–‡ä»¶ç»„ä¸­ï¼Œè¿›è¡Œå¤‡ä»½ï¼Œè€Œä¸å†å°†å…¶æ‹–åˆ°æ‚¨çš„æ‰€æœ‰æ—¥å¸¸å¤‡ä»½ä¸­-åˆ›å»ºå¤‡ä»½å‰¯æœ¬çš„é€Ÿåº¦å°†å¢åŠ ï¼Œå¤§å°å°†å‡å°ã€‚ æ‚¨å¯ä»¥ä¸åœ¨æ•´ä¸ªè¡¨ä¸Šè€Œæ˜¯åœ¨é€‰å®šçš„éƒ¨åˆ†ä¸Šé‡å»ºç´¢å¼•ã€‚ æ­¤å¤–ï¼Œæ•°æ®åº“çš„å¯ç”¨æ€§æ­£åœ¨å¢é•¿-å¦‚æœåŒ…å«å…·æœ‰è¯¥éƒ¨åˆ†çš„æ–‡ä»¶ç»„çš„è®¾å¤‡ä¹‹ä¸€å‘ç”Ÿæ•…éšœï¼Œåˆ™å…¶ä»–è®¾å¤‡ä»ç„¶å¯ç”¨ã€‚ <br><br> ä¸ºäº†è·å¾—å‰©ä½™çš„å¥½å¤„ï¼ˆç«‹å³åˆ‡æ¢éƒ¨åˆ†ï¼›æé«˜ç”Ÿäº§ç‡ï¼‰-æ‚¨éœ€è¦ä¸“é—¨è®¾è®¡æ•°æ®ç»“æ„å¹¶ç¼–å†™æŸ¥è¯¢ã€‚ <br> æˆ‘æƒ³æˆ‘å·²ç»è¶³å¤Ÿä½¿è¯»è€…éš¾å ªäº†ï¼Œç°åœ¨æˆ‘å¯ä»¥ç»§ç»­ç»ƒä¹ ã€‚ <br><br> é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªåŒ…å«4ä¸ªæ–‡ä»¶ç»„çš„æ•°æ®åº“ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­è¿›è¡Œå®éªŒï¼š <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> [PartitionTest] <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> primary (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> =<span class="hljs-string"><span class="hljs-string">'PTestPrimary'</span></span>, filename = <span class="hljs-string"><span class="hljs-string">'E:\data\partitionTestPrimary.mdf'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">8092</span></span>KB, filegrowth = <span class="hljs-number"><span class="hljs-number">1024</span></span>KB) , filegroup [fg1] (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> =<span class="hljs-string"><span class="hljs-string">'PTestFG1'</span></span>, filename = <span class="hljs-string"><span class="hljs-string">'E:\data\partitionTestFG1.ndf'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">8092</span></span>KB, filegrowth = <span class="hljs-number"><span class="hljs-number">1024</span></span>KB) , filegroup [fg2] (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> =<span class="hljs-string"><span class="hljs-string">'PTestFG2'</span></span>, filename = <span class="hljs-string"><span class="hljs-string">'E:\data\partitionTestFG2.ndf'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">8092</span></span>KB, filegrowth = <span class="hljs-number"><span class="hljs-number">1024</span></span>KB) , filegroup [fg3] (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> =<span class="hljs-string"><span class="hljs-string">'PTestFG3'</span></span>, filename = <span class="hljs-string"><span class="hljs-string">'E:\data\partitionTestFG3.ndf'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">8092</span></span>KB, filegrowth = <span class="hljs-number"><span class="hljs-number">1024</span></span>KB) <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">name</span></span> = <span class="hljs-string"><span class="hljs-string">'PTest_Log'</span></span>, filename = <span class="hljs-string"><span class="hljs-string">'E:\data\partitionTest_log.ldf'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> = <span class="hljs-number"><span class="hljs-number">2048</span></span>KB, filegrowth = <span class="hljs-number"><span class="hljs-number">1024</span></span>KB); go <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> [PartitionTest] <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">recovery</span></span> simple; go <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> partitionTest;</code> </pre> <br> åˆ›å»ºä¸€ä¸ªæˆ‘ä»¬å°†æŠ˜ç£¨çš„æ¡Œå­ã€‚ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> ptest (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), dt datetime, dummy_int <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, dummy_char <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">6000</span></span>));</code> </pre> <br> å¹¶å¡«å†™ä¸€å¹´çš„æ•°æ®ï¼š <br><pre> <code class="sql hljs">;<span class="hljs-keyword"><span class="hljs-keyword">with</span></span> nums <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> all <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> ptest(dt, dummy_int, dummy_char) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">dateadd</span></span>(hh, rn<span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-string"><span class="hljs-string">'20180101'</span></span>) dt, rn dummy_int, <span class="hljs-string"><span class="hljs-string">'dummy char column #'</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">cast</span></span>(rn <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> row_number() <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> (<span class="hljs-literal"><span class="hljs-literal">null</span></span>))) rn <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> nums n1, nums n2, nums n3, nums n4 )t <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> rn &lt; <span class="hljs-number"><span class="hljs-number">8761</span></span></code> </pre> <br> ç°åœ¨pTestè¡¨åŒ…å«2018å¹´æ¯å°æ—¶çš„ä¸€æ¡è®°å½•ã€‚ <br><br> ç°åœ¨ï¼Œæ‚¨éœ€è¦åˆ›å»ºä¸€ä¸ªåˆ†åŒºå‡½æ•°ï¼Œè¯¥å‡½æ•°æè¿°å°†æ•°æ®åˆ’åˆ†ä¸ºå¤šä¸ªéƒ¨åˆ†çš„è¾¹ç•Œæ¡ä»¶ã€‚  SQL Serverä»…æ”¯æŒèŒƒå›´åˆ†åŒºã€‚ <br><br> æˆ‘ä»¬å°†æ ¹æ®dtï¼ˆæ—¥æœŸæ—¶é—´ï¼‰åˆ—å¯¹è¡¨è¿›è¡Œåˆ†åŒºï¼Œä»¥ä¾¿æ¯ä¸ªéƒ¨åˆ†åŒ…å«4ä¸ªæœˆçš„æ•°æ®ï¼ˆå®é™…ä¸Šï¼Œæˆ‘åœ¨è¿™é‡Œæç ¸äº†-å®é™…ä¸Šï¼Œç¬¬ä¸€éƒ¨åˆ†å°†åŒ…å«3çš„æ•°æ®ï¼Œç¬¬äºŒéƒ¨åˆ†åŒ…å«4çš„æ•°æ®ï¼Œç¬¬ä¸‰éƒ¨åˆ†åŒ…å«5ä¸ªæœˆçš„æ•°æ®ï¼Œä½†æ˜¯å‡ºäºæ¼”ç¤ºç›®çš„-è¿™ä¸æ˜¯é—®é¢˜ï¼‰ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest (datetime) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'20180401'</span></span>, <span class="hljs-string"><span class="hljs-string">'20180801'</span></span>)</code> </pre> <br> ä¸€åˆ‡ä¼¼ä¹éƒ½å¾ˆæ­£å¸¸ï¼Œä½†æ˜¯æˆ‘åœ¨è¿™é‡Œæ•…æ„çŠ¯äº†ä¸€ä¸ªâ€œé”™è¯¯â€ã€‚ å¦‚æœæŸ¥çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">msdn</a>ä¸­çš„è¯­æ³•ï¼Œæ‚¨å°†çœ‹åˆ°åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­å¯ä»¥æŒ‡å®šæŒ‡å®šè¾¹æ¡†æ‰€å±çš„éƒ¨åˆ†-å·¦ä¾§æˆ–å³ä¾§ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç”±äºæŸç§æœªçŸ¥çš„åŸå› ï¼ŒæŒ‡å®šçš„è¾¹æ¡†æŒ‡çš„æ˜¯â€œå·¦ä¾§â€éƒ¨åˆ†ï¼Œå› æ­¤å¯¹äºæˆ‘æ¥è¯´ï¼Œåˆ›å»ºåˆ†åŒºå‡½æ•°å¦‚ä¸‹æ˜¯æ­£ç¡®çš„ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest (datetime) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-keyword"><span class="hljs-keyword">right</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'20180401'</span></span>, <span class="hljs-string"><span class="hljs-string">'20180801'</span></span>)</code> </pre> <br> å½“æˆ‘å®é™…æ‰§è¡Œæ—¶ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest (datetime) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'20180401'</span></span>, <span class="hljs-string"><span class="hljs-string">'20180801'</span></span>)</code> </pre> <br> ä½†æ˜¯ï¼Œæˆ‘ä»¬ç¨åå°†è¿”å›åˆ°æ­¤å¹¶é‡æ–°åˆ›å»ºåˆ†åŒºåŠŸèƒ½ã€‚ åŒæ—¶ï¼Œæˆ‘ä»¬ç»§ç»­è¿›è¡Œæ‰€å‘ç”Ÿçš„äº‹æƒ…ï¼Œä»¥äº†è§£æ‰€å‘ç”Ÿçš„äº‹æƒ…ä»¥åŠä¸ºä»€ä¹ˆå®ƒå¯¹æˆ‘ä»¬ä¸æ˜¯å¾ˆå¥½ã€‚ <br><br> åˆ›å»ºåˆ†åŒºåŠŸèƒ½åï¼Œéœ€è¦åˆ›å»ºä¸€ä¸ªåˆ†åŒºæ–¹æ¡ˆã€‚ å®ƒæ¸…æ¥šåœ°å°†èŠ‚ç»‘å®šåˆ°æ–‡ä»¶ç»„ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> scheme psTest <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> pfTest <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> ([FG1], [FG2], [FG3])</code> </pre> <br> å¦‚æ‚¨æ‰€è§ï¼Œæˆ‘ä»¬çš„æ‰€æœ‰ä¸‰ä¸ªéƒ¨åˆ†éƒ½ä½äºä¸åŒçš„æ–‡ä»¶ç»„ä¸­ã€‚ ç°åœ¨æ˜¯æ—¶å€™å¯¹æˆ‘ä»¬çš„è¡¨è¿›è¡Œåˆ†åŒºäº†ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªèšé›†ç´¢å¼•ï¼Œè€Œä¸æ˜¯æŒ‡å®šåº”è¯¥ä½äºå…¶ä¸­çš„æ–‡ä»¶ç»„ï¼Œè€Œæ˜¯æŒ‡å®šåˆ†åŒºæ–¹æ¡ˆï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> cix_pTest_id <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pTest(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> psTest(dt)</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘åœ¨å½“å‰æ–¹æ¡ˆä¸­ä¹ŸçŠ¯äº†ä¸€ä¸ªâ€œé”™è¯¯â€ï¼Œæˆ‘å¾ˆå¯èƒ½åœ¨æ­¤åˆ—ä¸Šåˆ›å»ºäº†å”¯ä¸€çš„èšé›†ç´¢å¼•ï¼Œä½†æ˜¯ï¼Œå½“åˆ›å»ºå”¯ä¸€ç´¢å¼•æ—¶ï¼Œç”¨äºåˆ†åŒºçš„åˆ—åº”åŒ…æ‹¬åœ¨ç´¢å¼•ä¸­ã€‚ æˆ‘æƒ³å±•ç¤ºä¸€ä¸‹è¿™ç§é…ç½®å¯ä»¥é‡åˆ°çš„æƒ…å†µã€‚ <br><br> ç°åœ¨ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åœ¨å½“å‰é…ç½®ä¸­å¾—åˆ°äº†ä»€ä¹ˆï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯·æ±‚ä»æ­¤å¤„è·å–</a> ï¼‰ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> sc.name + N<span class="hljs-string"><span class="hljs-string">'.'</span></span> + so.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [Schema.Table], si.index_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], si.type_desc <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [Structure], si.name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>], stat.row_count <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Rows</span></span>], stat.in_row_reserved_page_count * <span class="hljs-number"><span class="hljs-number">8.</span></span>/<span class="hljs-number"><span class="hljs-number">1024.</span></span>/<span class="hljs-number"><span class="hljs-number">1024.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">In</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Row</span></span> GB], stat.lob_reserved_page_count * <span class="hljs-number"><span class="hljs-number">8.</span></span>/<span class="hljs-number"><span class="hljs-number">1024.</span></span>/<span class="hljs-number"><span class="hljs-number">1024.</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">LOB</span></span> GB], p.partition_number <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Partition</span></span> <span class="hljs-comment"><span class="hljs-comment">#], pf.name as [Partition Function], CASE pf.boundary_value_on_right WHEN 1 then 'Right / Lower' ELSE 'Left / Upper' END as [Boundary Type], prv.value as [Boundary Point], fg.name as [Filegroup] FROM sys.partition_functions AS pf JOIN sys.partition_schemes as ps on ps.function_id=pf.function_id JOIN sys.indexes as si on si.data_space_id=ps.data_space_id JOIN sys.objects as so on si.object_id = so.object_id JOIN sys.schemas as sc on so.schema_id = sc.schema_id JOIN sys.partitions as p on si.object_id=p.object_id and si.index_id=p.index_id LEFT JOIN sys.partition_range_values as prv on prv.function_id=pf.function_id and p.partition_number= CASE pf.boundary_value_on_right WHEN 1 THEN prv.boundary_id + 1 ELSE prv.boundary_id END /* For left-based functions, partition_number = boundary_id, for right-based functions we need to add 1 */ JOIN sys.dm_db_partition_stats as stat on stat.object_id=p.object_id and stat.index_id=p.index_id and stat.index_id=p.index_id and stat.partition_id=p.partition_id and stat.partition_number=p.partition_number JOIN sys.allocation_units as au on au.container_id = p.hobt_id and au.type_desc ='IN_ROW_DATA' /* Avoiding double rows for columnstore indexes. */ /* We can pick up LOB page count from partition_stats */ JOIN sys.filegroups as fg on fg.data_space_id = au.data_space_id ORDER BY [Schema.Table], [Index ID], [Partition Function], [Partition #];</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/72/qu/op/72quopaqu1glcalpur92qrwy6eo.png"><br><br> å› æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸‰ä¸ªä¸å¤ªæˆåŠŸçš„éƒ¨åˆ†-ç¬¬ä¸€ä¸ªéƒ¨åˆ†ä»æ—¶é—´å¼€å§‹å­˜å‚¨æ•°æ®ï¼Œç›´åˆ°04/01/2018 00:00:00ï¼ŒåŒ…æ‹¬ç¬¬äºŒä¸ª-ä»01/01/2018 00:00:01åˆ°08/01/2018 00:00:00ï¼ŒåŒ…æ‹¬ä»08/01/2018 00:00:01åˆ°ä¸–ç•Œæœ«æ—¥çš„ç¬¬ä¸‰ä¸ªï¼ˆæˆ‘æ•…æ„é”™è¿‡äº†å‡ åˆ†ä¹‹ä¸€ç§’ï¼Œå› ä¸ºæˆ‘ä¸è®°å¾—SQL Serverå°†è¿™äº›åˆ†æ•°å†™åˆ°å“ªä¸ªç­‰çº§ï¼Œä½†å«ä¹‰å·²æ­£ç¡®ä¼ è¾“ï¼‰ã€‚ <br> ç°åœ¨ï¼Œåœ¨dummy_intå­—æ®µä¸Šåˆ›å»ºä¸€ä¸ªéèšé›†ç´¢å¼•ï¼Œæ ¹æ®ç›¸åŒçš„åˆ†åŒºæ–¹æ¡ˆâ€œå¯¹é½â€ã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„ç´¢å¼•ï¼Ÿ</b> <div class="spoiler_text"> æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå¯¹é½çš„ç´¢å¼•ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥æ‰§è¡Œåˆ‡æ¢éƒ¨åˆ†ï¼ˆåˆ‡æ¢ï¼‰çš„æ“ä½œ-è¿™æ˜¯å…¶ä¸­çš„ä¸€é¡¹æ“ä½œï¼Œè€Œè¿™äº›æ“ä½œé€šå¸¸ä¼šå›°æ‰°äºåˆ†åŒºã€‚ å¦‚æœè¡¨ä¸­è‡³å°‘æœ‰ä¸€ä¸ªæœªå¯¹é½ç´¢å¼•ï¼Œåˆ™æ— æ³•åˆ‡æ¢è¯¥éƒ¨åˆ† <br></div></div><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> nonclustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> nix_pTest_dummyINT <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pTest(dummy_int) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> psTest(dt);</code> </pre> <br> è®©æˆ‘ä»¬çœ‹çœ‹ä¸ºä»€ä¹ˆæˆ‘è¯´è¿‡åœ¨å®ç°åˆ†æ®µåæ‚¨çš„æŸ¥è¯¢å¯èƒ½ä¼šå˜æ…¢ã€‚ è¿è¡Œè¯·æ±‚ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pTest <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dummy_int = <span class="hljs-number"><span class="hljs-number">54</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> è®©æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ï¼š <br><br><pre> <code class="sql hljs">Table 'ptest'. Scan count 3, logical reads 6, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code> </pre> <br> ä»¥åŠå®æ–½è®¡åˆ’ï¼š <br><br><img src="https://habrastorage.org/webt/-i/ey/ay/-ieyay17s-rifng9eaij7bobfes.png"><br><br> ç”±äºç´¢å¼•æ˜¯æŒ‰èŠ‚â€œå¯¹é½â€çš„ï¼Œå› æ­¤æœ‰æ¡ä»¶åœ°ï¼Œæ¯ä¸ªèŠ‚éƒ½æœ‰è‡ªå·±çš„ç´¢å¼•ï¼Œè¯¥ç´¢å¼•ä¸å…¶ä»–èŠ‚çš„ç´¢å¼•â€œä¸ç›¸è¿â€ã€‚ æˆ‘ä»¬æ²¡æœ‰åœ¨åˆ†åŒºç´¢å¼•çš„å­—æ®µä¸Šå¼ºåŠ æ¡ä»¶ï¼Œå› æ­¤SQL Serverè¢«è¿«åœ¨æ¯ä¸ªéƒ¨åˆ†ä¸­æ‰§è¡Œç´¢å¼•æŸ¥æ‰¾ï¼Œå®é™…ä¸Šæ˜¯3ä¸ªç´¢å¼•æŸ¥æ‰¾è€Œä¸æ˜¯ä¸€ä¸ªã€‚ <br><br> è®©æˆ‘ä»¬å°è¯•æ’é™¤ä¸€ä¸ªéƒ¨åˆ†ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pTest <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> dummy_int = <span class="hljs-number"><span class="hljs-number">54</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> dt &lt; <span class="hljs-string"><span class="hljs-string">'20180801'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> è®©æˆ‘ä»¬çœ‹çœ‹æ‰§è¡Œç»Ÿè®¡ä¿¡æ¯ï¼š <br><br><pre> <code class="sql hljs">Table 'ptest'. Scan count 2, logical reads 4, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code> </pre> <br> æ˜¯çš„ï¼Œæ’é™¤äº†ä¸€ä¸ªéƒ¨åˆ†ï¼Œä»…åœ¨ä¸¤ä¸ªéƒ¨åˆ†ä¸­è¿›è¡Œäº†æ‰€éœ€å€¼çš„æœç´¢ã€‚ <br> åœ¨å†³å®šåˆ†åŒºæ—¶ï¼Œå¿…é¡»è®°ä½è¿™ä¸€ç‚¹ã€‚ å¦‚æœæŸ¥è¯¢ä¸­æ²¡æœ‰å¯¹è¡¨åˆ†åŒºçš„å­—æ®µè¿›è¡Œé™åˆ¶ï¼Œåˆ™å¯èƒ½æœ‰é—®é¢˜ã€‚ <br><br> æˆ‘ä»¬ä¸å†éœ€è¦éèšé›†ç´¢å¼•ï¼Œå› æ­¤æˆ‘å°†å…¶åˆ é™¤ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> nix_pTest_dummyINT <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pTest;</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">ä¸ºä»€ä¹ˆéœ€è¦éé›†ç¾¤ç´¢å¼•ï¼Ÿ</b> <div class="spoiler_text"> æ€»çš„æ¥è¯´ï¼Œæˆ‘ä¸éœ€è¦å®ƒï¼Œæˆ‘å¯ä»¥ä½¿ç”¨é›†ç¾¤ç´¢å¼•æ˜¾ç¤ºç›¸åŒçš„å†…å®¹ï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆåˆ›å»ºå®ƒï¼Œä½†æ˜¯ç”±äºå·²ç»åˆ›å»ºå¹¶åˆ¶ä½œäº†å±å¹•æˆªå›¾ï¼Œæ‰€ä»¥è¯·ä¸è¦æ¶ˆå¤± <br></div></div><br> ç°åœ¨è€ƒè™‘ä»¥ä¸‹æƒ…å†µï¼šæˆ‘ä»¬æ¯4ä¸ªæœˆä»æ­¤è¡¨ä¸­å­˜æ¡£ä¸€æ¬¡æ•°æ®-æˆ‘ä»¬åˆ é™¤æ—§æ•°æ®å¹¶ä¸ºæ¥ä¸‹æ¥çš„4ä¸ªæœˆæ·»åŠ ä¸€ä¸ªéƒ¨åˆ†ï¼ˆâ€œæ»‘åŠ¨çª—å£â€çš„ç»„ç»‡åœ¨msdnå’Œåšå®¢å †ä¸­éƒ½æœ‰æè¿°ï¼‰ã€‚ <br><br> æˆ‘ä»¬å°†ä»»åŠ¡åˆ†ä¸ºå¯ç†è§£çš„å°å­ä»»åŠ¡ï¼š <br><br><ol><li> æ·»åŠ ä¸€èŠ‚ä»¥è·å–01/01/2019è‡³04/01/2019çš„æ•°æ® </li><li> åˆ›å»ºä¸€ä¸ªç©ºçš„èˆå°è¡¨ </li><li> åœ¨é˜¶æ®µè¡¨ä¸­åˆ‡æ¢æ•°æ®éƒ¨åˆ†ç›´åˆ°04/01/2018 </li><li> æ‘†è„±ç©ºç™½éƒ¨åˆ† </li></ol><br> å‡ºå‘ï¼š <br><br>  1.æˆ‘ä»¬å®£å¸ƒå°†åœ¨FG1æ–‡ä»¶ç»„ä¸­åˆ›å»ºæ–°éƒ¨åˆ†ï¼Œå› ä¸ºå®ƒå°†å¾ˆå¿«ä»æˆ‘ä»¬æ‰‹ä¸­é‡Šæ”¾å‡ºæ¥ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> scheme psTest <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> used [FG1];</code> </pre> <br> å¹¶é€šè¿‡æ·»åŠ æ–°è¾¹æ¡†æ¥æ›´æ”¹åˆ†åŒºåŠŸèƒ½ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest() <span class="hljs-keyword"><span class="hljs-keyword">split</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> (<span class="hljs-string"><span class="hljs-string">'20190101'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> æˆ‘ä»¬çœ‹ä¸€ä¸‹ç»Ÿè®¡æ•°æ®ï¼š <br><br><pre> <code class="sql hljs">Table 'ptest'. Scan count 1, logical reads 76171, physical reads 0, read-ahead reads 753, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'Worktable'. Scan count 1, logical reads 7440, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code> </pre> <br> è¯¥è¡¨ä¸­æœ‰8809é¡µï¼ˆé›†ç¾¤ç´¢å¼•ï¼‰ï¼Œå› æ­¤ï¼Œè¯»æ•°çš„æ•°é‡å½“ç„¶æ˜¯å¤šæœ‰å¥½å¤„ã€‚ è®©æˆ‘ä»¬åœ¨å„èŠ‚ä¸­çœ‹çœ‹ç°åœ¨æœ‰ä»€ä¹ˆã€‚ <br><br><img src="https://habrastorage.org/webt/s0/hy/yx/s0hyyxxh7iny_jc3t3k48ca83hs.png"><br><br> æ€»çš„æ¥è¯´ï¼Œä¸€åˆ‡éƒ½æŒ‰é¢„æœŸè¿›è¡Œ-å‡ºç°äº†ä¸€ä¸ªå…·æœ‰ä¸Šé™çš„æ–°éƒ¨åˆ†ï¼ˆè¯·è®°ä½æˆ‘ä»¬çš„è¾¹ç•Œæ¡ä»¶å±äºå·¦ä¾§éƒ¨åˆ†ï¼‰01/01/2019å’Œä¸€ä¸ªç©ºç™½éƒ¨åˆ†ï¼Œå…¶ä¸­å°†æœ‰å…¶ä»–æ—¥æœŸè¾ƒé•¿çš„æ•°æ®ã€‚ <br><br> ä¸€åˆ‡ä¼¼ä¹éƒ½å¾ˆå¥½ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ä¹ˆå¤šè¯»æ•°ï¼Ÿ æˆ‘ä»¬ä»”ç»†æŸ¥çœ‹ä¸Šå›¾ï¼Œå‘ç°FG3ä¸­æ¥è‡ªç¬¬ä¸‰éƒ¨åˆ†çš„æ•°æ®ä»¥FG1ç»“å°¾ï¼Œä½†ä¸‹ä¸€éƒ¨åˆ†ä¸ºFG3ã€‚ <br><br>  2.åˆ›å»ºä¸€ä¸ªé˜¶æ®µè¡¨ã€‚ <br><br> è¦å°†ä¸€ä¸ªéƒ¨åˆ†åˆ‡æ¢ï¼ˆåˆ‡æ¢ï¼‰åˆ°ä¸€ä¸ªè¡¨ï¼Œåä¹‹äº¦ç„¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªç©ºè¡¨ï¼Œåœ¨å…¶ä¸­åˆ›å»ºæ‰€æœ‰ä¸åˆ†åŒºè¡¨ç›¸åŒçš„é™åˆ¶å’Œç´¢å¼•ã€‚ è¯¥è¡¨åº”ä¸æˆ‘ä»¬è¦åœ¨å…¶ä¸­â€œåˆ‡æ¢â€çš„éƒ¨åˆ†ä½äºåŒä¸€æ–‡ä»¶ç»„ä¸­ã€‚ ç¬¬ä¸€ä¸ªï¼ˆå½’æ¡£çš„ï¼‰éƒ¨åˆ†ä½äºFG1ä¸­ï¼Œå› æ­¤æˆ‘ä»¬åœ¨åŒä¸€ä½ç½®åˆ›å»ºä¸€ä¸ªè¡¨å’Œä¸€ä¸ªç°‡ç´¢å¼•ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> stageTest (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), dt datetime, dummy_int <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, dummy_char <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">6000</span></span>)) ; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> cix_stageTest_id <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> stageTest(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> [FG1];</code> </pre> <br> æ‚¨æ— éœ€å¯¹è¯¥è¡¨è¿›è¡Œåˆ†åŒºã€‚ <br><br>  3.ç°åœ¨æˆ‘ä»¬å‡†å¤‡åˆ‡æ¢ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> pTest <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> stageTest <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> è¿™æ˜¯æˆ‘ä»¬å¾—åˆ°çš„ï¼š <br><br><pre> <code class="sql hljs"> 4947,  16,  1,  59 <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SWITCH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> failed. There <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> identical <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">'PartitionTest.dbo.pTest'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> <span class="hljs-string"><span class="hljs-string">'cix_stageTest_id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> target <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">'PartitionTest.dbo.stageTest'</span></span> .</code> </pre> <br> æœ‰è¶£çš„æ˜¯ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ç´¢å¼•ä¸­çš„å†…å®¹ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> o.name tblName, i.name indexName, c.name columnName, ic.is_included_column <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sys.indexes i <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.objects o <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> i.object_id = o.object_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.index_columns ic <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ic.object_id = i.object_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> ic.index_id = i.index_id <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> sys.columns c <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ic.column_id = c.column_id <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> o.object_id = c.object_id <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> o.name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'pTest'</span></span>, <span class="hljs-string"><span class="hljs-string">'stageTest'</span></span>)</code> </pre> <br><img src="https://habrastorage.org/webt/8e/mf/1u/8emf1uqyw18p6rghqkv3enygfx0.png"><br><br> è¿˜è®°å¾—æˆ‘å†™è¿‡çš„ï¼Œæœ‰å¿…è¦åœ¨åˆ†åŒºè¡¨ä¸Šåˆ›å»ºå”¯ä¸€çš„èšé›†ç´¢å¼•å—ï¼Ÿ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ‰å¿…è¦çš„åŸå› ã€‚ å½“åˆ›å»ºå”¯ä¸€çš„èšé›†ç´¢å¼•æ—¶ï¼ŒSQL Serverå°†è¦æ±‚æ˜¾å¼åœ°åŒ…æ‹¬åœ¨ç´¢å¼•ä¸­å¯¹è¡¨è¿›è¡Œåˆ†åŒºçš„åˆ—ï¼Œå› æ­¤ä»–è‡ªå·±æ·»åŠ äº†è¯¥åˆ—ï¼Œè€Œå¿˜è®°äº†ã€‚ æˆ‘çœŸçš„ä¸æ˜ç™½ä¸ºä»€ä¹ˆã€‚ <br> ä½†æ˜¯ï¼Œæ€»çš„æ¥è¯´ï¼Œè¿™ä¸ªé—®é¢˜æ˜¯å¯ä»¥ç†è§£çš„ï¼Œæˆ‘ä»¬åœ¨èˆå°è¡¨ä¸Šé‡æ–°åˆ›å»ºé›†ç¾¤ç´¢å¼•ã€‚ <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> cix_stageTest_id <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> stageTest(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, dt) <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> (drop_existing = <span class="hljs-keyword"><span class="hljs-keyword">on</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> [FG1];</code> </pre> <br> ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¬¡å°è¯•åˆ‡æ¢è¯¥éƒ¨åˆ†ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> pTest <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> stageTest <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> å¡”åï¼ è¯¥éƒ¨åˆ†å·²åˆ‡æ¢ï¼Œè¯·çœ‹å®ƒèŠ±äº†æˆ‘ä»¬å¤šå°‘é’±ï¼š <br><br><pre> <code class="sql hljs">SQL Server parse and compile time: CPU time = 0 ms, elapsed time = 0 ms. SQL Server Execution Times: CPU time = 0 ms, elapsed time = 0 ms. SQL Server parse and compile time: CPU time = 0 ms, elapsed time = 0 ms. SQL Server Execution Times: CPU time = 0 ms, elapsed time = 0 ms. SQL Server Execution Times: CPU time = 0 ms, elapsed time = 3 ms.</code> </pre> <br> ä½†æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰ã€‚ å°†èŠ‚åˆ‡æ¢åˆ°ç©ºè¡¨ï¼Œåä¹‹äº¦ç„¶ï¼ˆå°†æ•´ä¸ªè¡¨åˆ‡æ¢åˆ°ç©ºèŠ‚ï¼‰æ˜¯ä»…å¯¹å…ƒæ•°æ®çš„æ“ä½œï¼Œè¿™æ­£æ˜¯åˆ†åŒºæ˜¯éå¸¸éå¸¸é…·çš„äº‹æƒ…çš„åŸå› ã€‚ <br><br> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹æˆ‘ä»¬çš„éƒ¨åˆ†ï¼š <br><br><img src="https://habrastorage.org/webt/mb/7j/pl/mb7jpl32ekb7e-vgl3mjfczd1ru.png"><br><br> ä»–ä»¬çš„ä¸€åˆ‡éƒ½å¾ˆå¥½ã€‚ åœ¨ç¬¬ä¸€éƒ¨åˆ†ä¸­ï¼Œå‰©ä¸‹çš„è®°å½•ä¸ºé›¶ï¼Œå®ƒä»¬å®‰å…¨åœ°ä¿ç•™åœ¨stageTestè¡¨ä¸­ã€‚ æˆ‘ä»¬å¯ä»¥ç»§ç»­å‰è¿› <br><br>  4.æˆ‘ä»¬å‰©ä¸‹çš„å°±æ˜¯åˆ é™¤æˆ‘ä»¬ç©ºç™½çš„ç¬¬ä¸€éƒ¨åˆ†ã€‚ è®©æˆ‘ä»¬æ¥çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest() <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> (<span class="hljs-string"><span class="hljs-string">'20180401'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œè¿™ä¹Ÿæ˜¯ä»…å¯¹å…ƒæ•°æ®çš„æ“ä½œã€‚ æˆ‘ä»¬æŸ¥çœ‹ä»¥ä¸‹éƒ¨åˆ†ï¼š <br><br><img src="https://habrastorage.org/webt/ju/ce/lf/jucelfzq4upnfi3fqg_8snuurho.png"><br><br> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬åªæœ‰3ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½åœ¨è‡ªå·±çš„æ–‡ä»¶ç»„ä¸­ã€‚ ä»»åŠ¡å®Œæˆã€‚ è¿™é‡Œæœ‰ä»€ä¹ˆå¯ä»¥æ”¹è¿›çš„ï¼Ÿ å¥½å§ï¼Œé¦–å…ˆï¼Œæˆ‘å¸Œæœ›è¾¹ç•Œå€¼å¼•ç”¨â€œæ­£ç¡®çš„â€éƒ¨åˆ†ï¼Œä»¥ä¾¿è¿™äº›éƒ¨åˆ†åŒ…å«4ä¸ªæœˆçš„æ‰€æœ‰æ•°æ®ã€‚ è€Œä¸”æˆ‘å¸Œæœ›çœ‹åˆ°åˆ›å»ºæ–°éƒ¨åˆ†çš„æˆæœ¬æ›´ä½ã€‚ è¯»å–æ•°æ®çš„æ¬¡æ•°æ˜¯è¡¨æœ¬èº«çš„åå€-ç ´äº§ã€‚ <br><br> æˆ‘ä»¬ç°åœ¨æ— æ³•å¯¹ç¬¬ä¸€ä¸ªè¿›è¡Œä»»ä½•æ“ä½œï¼Œä½†æ˜¯å¯¹äºç¬¬äºŒä¸ªæˆ‘ä»¬å°†å°è¯•ã€‚ è®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°éƒ¨åˆ†ï¼Œå…¶ä¸­å°†åŒ…å«ä»01/01/2019åˆ°04/01/2019çš„æ•°æ®ï¼Œå¹¶ä¸”ç›´åˆ°æ—¶é—´ç»“æŸï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> scheme psTest <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> used [FG2]; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest() <span class="hljs-keyword"><span class="hljs-keyword">split</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> (<span class="hljs-string"><span class="hljs-string">'20190401'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°ï¼š <br><br><pre> <code class="sql hljs">SQL Server parse and compile time: CPU time = 0 ms, elapsed time = 0 ms. SQL Server Execution Times: CPU time = 0 ms, elapsed time = 0 ms. SQL Server parse and compile time: CPU time = 0 ms, elapsed time = 0 ms. SQL Server Execution Times: CPU time = 0 ms, elapsed time = 0 ms.</code> </pre> <br> å“ˆï¼ å› æ­¤ï¼Œæ­¤æ“ä½œä»…é’ˆå¯¹å…ƒæ•°æ®å—ï¼Ÿ æ˜¯çš„ï¼Œå¦‚æœæ‚¨â€œåˆ’åˆ†â€ç©ºç™½éƒ¨åˆ†-è¿™ä»…æ˜¯å¯¹å…ƒæ•°æ®çš„æ“ä½œï¼Œå› æ­¤ï¼Œä¿ç•™å·¦ä¾§å’Œå³ä¾§ä¿è¯çš„ç©ºç™½éƒ¨åˆ†éƒ½æ˜¯æ­£ç¡®çš„å†³å®šï¼Œå¹¶åœ¨å¿…è¦æ—¶é€‰æ‹©ä¸€ä¸ªæ–°éƒ¨åˆ†-ä»æ­¤å¤„â€œå‰ªåˆ‡â€å®ƒä»¬ã€‚ <br><br> ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å¦‚æœæˆ‘æƒ³å°†æ•°æ®ä»é˜¶æ®µè¡¨è¿”å›åˆ°åˆ†åŒºè¡¨ä¼šå‘ç”Ÿä»€ä¹ˆã€‚ ä¸ºæ­¤ï¼Œæˆ‘éœ€è¦ï¼š <br><br><ol><li> åœ¨å·¦ä¾§åˆ›å»ºä¸€ä¸ªæ–°éƒ¨åˆ†ä»¥è·å–æ•°æ® </li><li> å°†è¡¨æ ¼åˆ‡æ¢åˆ°æ­¤éƒ¨åˆ† </li></ol><br> æˆ‘ä»¬å°è¯•ï¼ˆå¹¶è®°ä½FG1ä¸­çš„stageTestï¼‰ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> scheme psTest <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> used [FG1]; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest() <span class="hljs-keyword"><span class="hljs-keyword">split</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> (<span class="hljs-string"><span class="hljs-string">'20180401'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> æˆ‘ä»¬çœ‹åˆ°ï¼š <br><br><pre> <code class="sql hljs">Table 'Worktable'. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'ptest'. Scan count 1, logical reads 2939, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code> </pre> <br> å¥½å§ï¼Œè¿˜ä¸é”™ã€‚ ä»…é˜…è¯»å·¦ä¾§éƒ¨åˆ†ï¼ˆæˆ‘ä»¬å°†å…¶åˆ’åˆ†ï¼‰å³å¯ã€‚ å¥½å§ è¦å°†éåˆ†åŒºçš„éç©ºè¡¨åˆ‡æ¢åˆ°åˆ†åŒºè¡¨éƒ¨åˆ†ï¼Œæºè¡¨å¿…é¡»å…·æœ‰é™åˆ¶ï¼Œä»¥ä¾¿SQL ServerçŸ¥é“ä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥ï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å¯¹å…ƒæ•°æ®çš„æ“ä½œæ¥è¿›è¡Œåˆ‡æ¢ï¼ˆè€Œä¸æ˜¯è¯»å–è¡Œä¸­çš„æ‰€æœ‰å†…å®¹å¹¶æ£€æŸ¥è¯¥éƒ¨åˆ†æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼‰ ï¼‰ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> stageTest <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> check_dt <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> (dt &lt;= <span class="hljs-string"><span class="hljs-string">'20180401'</span></span>)</code> </pre> <br> å°è¯•åˆ‡æ¢ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> stageTest <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> pTest <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> ç»Ÿè®¡èµ„æ–™ï¼š <br><br><pre> <code class="sql hljs"> SQL Server Execution Times: CPU time = 15 ms, elapsed time = 39 ms.</code> </pre> <br> åŒæ ·ï¼Œè¯¥æ“ä½œä»…é’ˆå¯¹å…ƒæ•°æ®ã€‚ æˆ‘ä»¬çœ‹ä¸€ä¸‹å„èŠ‚çš„å†…å®¹ï¼š <br><br><img src="https://habrastorage.org/webt/c2/wv/xe/c2wvxe_ex2iyvv3v7l9hvxokq70.png"><br><br> å¥½å§ ä¼¼ä¹å·²ç»æ•´ç†å¥½äº†ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å°†å°è¯•é‡æ–°åˆ›å»ºå‡½æ•°å’Œåˆ†åŒºæ–¹æ¡ˆï¼ˆæˆ‘åˆ é™¤äº†åˆ†åŒºæ–¹æ¡ˆå’Œå‡½æ•°ï¼Œä½¿ç”¨æ–°çš„åˆ†åŒºæ–¹æ¡ˆé‡æ–°åˆ›å»ºå¹¶é‡æ–°å¡«å……äº†è¡¨ï¼Œå¹¶é‡æ–°åˆ›å»ºäº†ç¾¤é›†ç´¢å¼•ï¼‰ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest (datetime) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-keyword"><span class="hljs-keyword">right</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'20180401'</span></span>, <span class="hljs-string"><span class="hljs-string">'20180801'</span></span>)</code> </pre> <br> è®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬ç°åœ¨æœ‰å“ªäº›éƒ¨åˆ†ï¼š <br><br><img src="https://habrastorage.org/webt/b6/mw/j2/b6mwj2konz7su7x_ng5eonsgukw.png"><br><br> å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬æœ‰ä¸‰ä¸ªâ€œé€»è¾‘â€éƒ¨åˆ†-ä»æ—¶é—´å¼€å§‹åˆ°04/01/2018 00:00:00ï¼ˆä¸åŒ…æ‹¬ï¼‰ï¼Œä»04/01/2018 00:00:00ï¼ˆåŒ…æ‹¬ï¼‰åˆ°08/01/2018 00:00:00ï¼ˆ ï¼ˆä¸åŒ…æ‹¬ï¼‰å’Œç¬¬ä¸‰é¡¹ï¼Œå³å¤§äºæˆ–ç­‰äº01/01/2018 00:00:00çš„æ‰€æœ‰å†…å®¹ã€‚ <br><br> ç°åœ¨ï¼Œè®©æˆ‘ä»¬å°è¯•æ‰§è¡Œä¸ä½¿ç”¨ä¸Šä¸€ä¸ªåˆ†åŒºåŠŸèƒ½æ‰§è¡Œçš„æ•°æ®å­˜æ¡£ä»»åŠ¡ç›¸åŒçš„ä»»åŠ¡ã€‚ <br><br>  1.æ·»åŠ ä¸€ä¸ªæ–°éƒ¨åˆ†ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> scheme psTest <span class="hljs-keyword"><span class="hljs-keyword">next</span></span> used [FG1]; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest() <span class="hljs-keyword"><span class="hljs-keyword">split</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> (<span class="hljs-string"><span class="hljs-string">'20190101'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> æˆ‘ä»¬çœ‹ä¸€ä¸‹ç»Ÿè®¡æ•°æ®ï¼š <br><br><pre> <code class="sql hljs">Table 'Worktable'. Scan count 0, logical reads 0, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'ptest'. Scan count 1, logical reads 3685, physical reads 0, read-ahead reads 4, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0. Table 'Worktable'. Scan count 1, logical reads 0, physical reads 0, read-ahead reads 0, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code> </pre> <br> ä¸é”™ï¼Œè‡³å°‘æ˜¯åˆç†çš„-ä»…é˜…è¯»æœ€åä¸€éƒ¨åˆ†ã€‚ æˆ‘ä»¬åœ¨ä»¥ä¸‹å„èŠ‚ä¸­ä»‹ç»ä¸€ä¸‹ï¼š <br><br><img src="https://habrastorage.org/webt/1l/yr/i9/1lyri90cqmu969imje4edli1e7m.png"><br><br> è¯·æ³¨æ„ï¼Œç°åœ¨ï¼Œå®Œæ•´çš„ç¬¬ä¸‰èŠ‚ä¿ç•™åœ¨FG3ä¸­ï¼Œè€Œæ–°çš„ç©ºç™½éƒ¨åˆ†å·²åœ¨FG1ä¸­åˆ›å»ºã€‚ <br><br>  2.æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªé˜¶æ®µè¡¨å¹¶åœ¨å…¶ä¸Šåˆ›å»ºæ­£ç¡®çš„é›†ç¾¤ç´¢å¼• <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> stageTest (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">identity</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>), dt datetime, dummy_int <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, dummy_char <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">6000</span></span>)) ; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> clustered <span class="hljs-keyword"><span class="hljs-keyword">index</span></span> cix_stageTest_id <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> stageTest(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, dt) <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> [FG1];</code> </pre> <br>  3.å¼€å…³éƒ¨åˆ† <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> pTest <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> stageTest <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> ç»Ÿè®¡æ•°æ®è¡¨æ˜ï¼Œå…ƒæ•°æ®æ“ä½œä¸ºï¼š <br><br><pre> <code class="sql hljs">SQL Server Execution Times: CPU time = 0 ms, elapsed time = 5 ms.</code> </pre> <br> ç°åœ¨ï¼Œä¸€åˆ‡éƒ½æ²¡æœ‰æƒŠå–œã€‚ <br><br>  4.åˆ é™¤ä¸å¿…è¦çš„éƒ¨åˆ† <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> pfTest() <span class="hljs-keyword"><span class="hljs-keyword">merge</span></span> <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> (<span class="hljs-string"><span class="hljs-string">'20180401'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">STATISTICS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TIME</span></span>, IO <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>;</code> </pre> <br> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªæƒŠå–œï¼š <br><br><pre> <code class="sql hljs">Table 'ptest'. Scan count 1, logical reads 27057, physical reads 0, read-ahead reads 251, lob logical reads 0, lob physical reads 0, lob read-ahead reads 0.</code> </pre> <br> æˆ‘ä»¬çœ‹ä¸€ä¸‹å„èŠ‚çš„å†…å®¹ï¼š <br><br><img src="https://habrastorage.org/webt/qn/_j/xr/qn_jxrttkmls8amaycjwxqrescu.png"><br><br> è¿™å¾ˆæ¸…æ¥šï¼šæˆ‘ä»¬çš„ç¬¬2èŠ‚ä»fg2æ–‡ä»¶ç»„ç§»åˆ°äº†fg1æ–‡ä»¶ç»„ã€‚ ç±»ã€‚ æˆ‘ä»¬å¯ä»¥åšäº›ä»€ä¹ˆå—ï¼Ÿ <br><br> ä¹Ÿè®¸æˆ‘ä»¬åªéœ€è¦å§‹ç»ˆæœ‰ä¸€ä¸ªç©ºç™½éƒ¨åˆ†ï¼Œå¹¶â€œé”€æ¯â€â€œæ°¸è¿œç©ºç™½â€çš„å·¦éƒ¨åˆ†å’Œæˆ‘ä»¬â€œåˆ‡æ¢â€åˆ°å¦ä¸€ä¸ªè¡¨çš„éƒ¨åˆ†ä¹‹é—´çš„è¾¹ç•Œã€‚ <br><br>  <b>ç»“è®ºï¼š</b> <br><br><ol><li> ä½¿ç”¨å®Œæ•´çš„è¯­æ³•åˆ›å»ºåˆ†åŒºåŠŸèƒ½ï¼Œä¸è¦ä¾èµ–é»˜è®¤å€¼-æ‚¨å¯èƒ½æ— æ³•è·å¾—æ‰€éœ€çš„å†…å®¹ã€‚ </li><li> å°†å·¦å³ä¿æŒåœ¨ç©ºç™½åŒºåŸŸ-åœ¨ç»„ç»‡â€œæ»‘åŠ¨çª—å£â€æ—¶å®ƒä»¬å°†å¯¹æ‚¨éå¸¸æœ‰ç”¨ã€‚ </li><li> æ‹†åˆ†å¹¶åˆå¹¶éç©ºéƒ¨åˆ†-æ€»æ˜¯å¾ˆéº»çƒ¦ï¼Œè¯·å°½å¯èƒ½é¿å…è¿™ç§æƒ…å†µã€‚ </li><li> æ£€æŸ¥æ‚¨çš„æŸ¥è¯¢-å¦‚æœå®ƒä»¬ä¸æŒ‰è®¡åˆ’å¯¹è¡¨è¿›è¡Œåˆ†åŒºçš„åˆ—ä½¿ç”¨ç­›é€‰å™¨ï¼Œå¹¶ä¸”æ‚¨éœ€è¦åˆ‡æ¢éƒ¨åˆ†çš„èƒ½åŠ›-å®ƒä»¬çš„æ€§èƒ½å¯èƒ½ä¼šå¤§å¤§é™ä½ã€‚ </li><li> å¦‚æœæ‚¨æƒ³åšæŸäº‹ï¼Œè¯·å…ˆè¿›è¡Œç”Ÿäº§æµ‹è¯•ã€‚ </li></ol><br> å¸Œæœ›è¯¥ææ–™å¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ã€‚ ä¹Ÿè®¸äº‹å®è¯æ˜å®ƒæ˜¯å¼„çš±çš„ï¼Œå¦‚æœæ‚¨è®¤ä¸ºæ‰€å£°æ˜çš„å†…å®¹æœªå…¬å¼€ï¼Œè¯·å†™ï¼Œæˆ‘å°†å°½åŠ›å®Œæˆå®ƒã€‚ è°¢è°¢æ‚¨çš„å…³æ³¨ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN464665/">https://habr.com/ru/post/zh-CN464665/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN464651/index.html">AVRå¾®æ§åˆ¶å™¨çš„æ±‡ç¼–ä»£ç ç”Ÿæˆå™¨åº“ã€‚ ç¬¬5éƒ¨åˆ†</a></li>
<li><a href="../zh-CN464655/index.html">åœ¨è¿‡å»çš„ä¸¤å¹´ä¸­ï¼Œç¼–ç¨‹è¯­è¨€çš„è–ªæ°´å’Œå—æ¬¢è¿ç¨‹åº¦å¦‚ä½•å˜åŒ–</a></li>
<li><a href="../zh-CN464657/index.html">é€†å‘å·¥ç¨‹ç”µåŠ¨é£æªAM82TV</a></li>
<li><a href="../zh-CN464659/index.html">åº”ç”¨ç¨‹åºå®‰å…¨æ€§ï¼Œæˆ–å¦‚ä½•åœ¨è‡ªå®šä¹‰å¼€å‘ä¸­åµŒå…¥å®‰å…¨æ€§ã€‚ åœ¨AGIMAçš„ä¸ªäººç»å†</a></li>
<li><a href="../zh-CN464661/index.html">å‘è°å§”æ‰˜æŠ€æœ¯æ”¹é€ å’Œé‡å»ºè®¾æ–½çš„è®¾è®¡</a></li>
<li><a href="../zh-CN464671/index.html">æ¥æ”¶å¸¸è§„çŸ­ä¿¡åˆ°Viberå’ŒTelegramå³æ—¶é€šè®¯ç¨‹åºï¼ˆä½¿ç”¨GoIPç½‘å…³ï¼‰</a></li>
<li><a href="../zh-CN464673/index.html">TinyFL-å¾®æ§åˆ¶å™¨æ‰‹ç”µç­’é©±åŠ¨å™¨</a></li>
<li><a href="../zh-CN464675/index.html">Splunkä¸­çš„åº”ç”¨ç¨‹åºæ¥å£æœ¬åœ°åŒ–æœºåˆ¶åˆ†æ</a></li>
<li><a href="../zh-CN464677/index.html">è¯åˆ¸äº¤æ˜“æ‰€çš„æŠ•èµ„å’Œç›¸å…³æˆæœ¬ï¼šç»çºªå…¬å¸æä¾›å¤šå°‘æœåŠ¡</a></li>
<li><a href="../zh-CN464679/index.html">Voxgun-æ— éœ€ä»»ä½•é¢å¤–åŠªåŠ›å³å¯åˆ›å»ºä¸“ä¸šè§†é¢‘å†…å®¹çš„æœåŠ¡</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>