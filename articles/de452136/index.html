<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêã üíº üçÑ Codezeptionstests f√ºr PHP-Backends üè∏ üöì üì£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits! Mein Name ist Pasha und ich bin QS-Ingenieur f√ºr das Auftragsabwicklungsteam bei Lamoda. Ich habe k√ºrzlich beim PHP Badoo Meetup ges...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Codezeptionstests f√ºr PHP-Backends</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/lamoda/blog/452136/">  Hallo allerseits!  Mein Name ist Pasha und ich bin QS-Ingenieur f√ºr das Auftragsabwicklungsteam bei Lamoda.  Ich habe k√ºrzlich beim PHP Badoo Meetup gesprochen.  Heute m√∂chte ich eine Abschrift meines Berichts vorlegen. <br><br>  Wir werden √ºber Codeception sprechen, dar√ºber, wie wir es in Lamoda verwenden und wie man Tests darauf schreibt. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rg1h7mJrU7Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  Lamoda hat viele Dienstleistungen.  Es gibt Client-Services, die direkt mit unseren Benutzern, mit Benutzern der Website und mobilen Anwendungen interagieren.  Wir werden nicht √ºber sie sprechen.  Und es gibt das, was unser Unternehmen Deep Backends nennt - dies sind unsere Back-Office-Systeme, die unsere Gesch√§ftsprozesse automatisieren.  Dazu geh√∂ren Lieferung, Lagerung, Automatisierung von Fotostudios und ein Callcenter.  Die meisten dieser Dienste werden in PHP entwickelt. <br><br>  Kurz gesagt, dies ist PHP + Symfony.  Hier und da gibt es alte Projekte auf Zend'e.  PostgreSQL und MySQL werden als Datenbanken verwendet, und Rabbit oder Kafka werden als Messagingsysteme verwendet. <br><br>  <b>Warum PHP-Backends?</b> <br><br>  Da sie normalerweise eine verzweigte API haben - es ist entweder REST, an einigen Stellen gibt es ein bisschen SOAP.  Wenn sie eine Benutzeroberfl√§che haben, handelt es sich bei dieser Benutzeroberfl√§che eher um eine zus√§tzliche Benutzeroberfl√§che, die von unseren internen Benutzern verwendet wird. <br><br>  <b>Warum brauchen wir Autotests bei Lamoda?</b> <br><br>  Als ich zu Lamoda kam, gab es im Allgemeinen einen solchen Slogan: ‚ÄûLassen Sie uns die manuelle Regression loswerden‚Äú.  Wir werden keine Regression manuell testen.  Und wir haben an dieser Aufgabe gearbeitet.  Tats√§chlich ist dies einer der Hauptgr√ºnde, warum wir Autotests ben√∂tigen, um die Regression nicht von Hand voranzutreiben.  Warum brauchen wir das?  Recht auf schnelle Freigabe.  Damit wir unsere Ver√∂ffentlichungen schmerzlos und sehr schnell herausbringen k√∂nnen und gleichzeitig eine Art Raster aus Selbsttests haben, die sie uns sagen, ob gut oder schlecht.  Dies sind wahrscheinlich die wichtigsten Ziele.  Aber es gibt ein paar Hilfsmittel, √ºber die ich auch sagen m√∂chte. <br><br>  Warum brauchen wir Autotests? <br><br><ol><li>  Testen Sie die Regression nicht mit Ihren H√§nden </li><li>  Schnellspanner </li><li>  Als Dokumentation verwenden </li><li>  Beschleunigen Sie die Aufnahme neuer Mitarbeiter </li><li>  Autotests werden (in einigen F√§llen) bequem als Dokumentation verwendet.  Manchmal ist es einfacher, in die Tests einzusteigen, zu sehen, welche F√§lle behandelt werden, wie sie funktionieren, zu verstehen, wie diese oder jene Funktionalit√§t funktioniert, und den Einstieg neuer Mitarbeiter - sowohl Entwickler als auch Tester - in ein neues Projekt zu beschleunigen.  Wenn Sie sich hinsetzen, um Autotests zu schreiben, wird sofort klar, wie das System funktioniert. </li></ol><br>  Ok, ich habe dar√ºber gesprochen, warum wir Autotests brauchen.  Lassen Sie uns nun dar√ºber sprechen, welche Tests wir in Lamoda schreiben. <br><br><img src="https://habrastorage.org/webt/qx/ci/0f/qxci0fma8tivrntsz95gv-d802e.jpeg" alt="Bild"><br><br>  Dies ist eine ziemlich standardm√§√üige Testpyramide, von Unit-Tests bis zu E2E-Tests, bei denen einige Gesch√§ftsketten bereits getestet wurden.  Ich werde nicht √ºber die unteren beiden Ebenen sprechen, es ist nicht umsonst, dass sie in solch wei√üer Farbe √ºbermalt sind.  Dies sind Tests f√ºr den Code selbst, die von unseren Entwicklern geschrieben wurden.  In extremen F√§llen kann der Tester in die Pull-Anfrage gehen, sich den Code ansehen und sagen: "Nun, etwas ist hier nicht genug, lassen Sie uns etwas anderes behandeln."  Damit ist die Arbeit des Testers f√ºr diese Tests abgeschlossen. <br><br>  Wir werden √ºber die oben genannten Ebenen sprechen, die von Entwicklern und Testern geschrieben wurden.  Beginnen wir mit Systemtests.  Dies sind Tests, die die API (REST oder SOAP) testen, interne Systemlogik, verschiedene Befehle testen, Warteschlangen in Rabbit analysieren oder mit externen Systemen austauschen.  Diese Tests sind in der Regel ziemlich atomar.  Sie √ºberpr√ºfen keine Kette, sondern eine Aktion.  Zum Beispiel eine API-Methode oder ein Befehl.  Und sie pr√ºfen so viele F√§lle wie m√∂glich, sowohl positive als auch negative. <br><br>  Fahren Sie fort, E2E-Tests.  Ich habe sie in zwei Teile geteilt.  Wir haben Tests, die eine Reihe von UI und Backend testen.  Und es gibt Tests, die wir Flusstests nennen.  Sie testen die Kette - das Leben eines Objekts von Anfang bis Ende. <br><br>  Zum Beispiel haben wir ein System zur Verwaltung der Verarbeitung unserer Bestellungen.  Innerhalb eines solchen Systems kann es einen Test geben - einen Auftrag von der Erstellung bis zur Lieferung, dh das Durchlaufen aller Status.  Bei solchen Tests ist es dann sehr einfach und unkompliziert zu beobachten, wie das System funktioniert.  Sie sehen sofort den gesamten Fluss bestimmter Objekte, mit welchen externen Systemen all dies interagiert, welche Befehle daf√ºr verwendet werden. <br><br>  Da diese Benutzeroberfl√§che von internen Benutzern verwendet wird, ist der browser√ºbergreifende Zugriff f√ºr uns nicht wichtig.  Wir f√ºhren diese Tests nicht in Farmen durch, es reicht aus, wenn wir einen Browser einchecken, und manchmal m√ºssen wir nicht einmal einen Browser verwenden. <br><br>  "Warum haben wir Codeception f√ºr die Testautomatisierung gew√§hlt?"  - Sie fragen wahrscheinlich. <br><br>  Um ehrlich zu sein, habe ich keine Antwort auf diese Frage.  Als ich zu Lamoda kam, wurde Codeception bereits als Standard f√ºr das Schreiben von Autotests ausgew√§hlt, und ich bin tats√§chlich darauf gesto√üen.  Aber nachdem ich einige Zeit mit diesem Framework gearbeitet hatte, verstand ich immer noch, warum Codeception.  Das m√∂chte ich mit Ihnen teilen. <br><br>  <b>Warum Codezeption?</b> <br><br><ol><li>  Sie k√∂nnen dieselben Tests jeder Art (Einheit, Funktion, Akzeptanz) schreiben und ausf√ºhren. </li><li>  Viele Rechen wurden bereits gel√∂st, viele Module wurden bereits geschrieben. </li><li>  In allen Projekten sehen die Tests trotz leicht unterschiedlicher Anforderungen gleich aus. </li><li>  Das Konzept der Codezeption schl√§gt vor, dass Sie alle Tests zu diesem Framework schreiben: Einheit, Integration, Funktion, Akzeptanz.  Und zumindest Sie, sie werden gleicherma√üen gestartet. </li><li>  Codeception ist ein ausreichend leistungsf√§higer Prozessor, in dem viele Probleme, viele Fragen und viele Aufgaben f√ºr Tests bereits gel√∂st wurden.  Wenn etwas nicht entschieden wird, werden Sie h√∂chstwahrscheinlich etwas von au√üen finden - ein Add-On f√ºr eine bestimmte Arbeit.  Sie m√ºssen keine Test-Wrapper f√ºr Datenbanken schreiben, f√ºr etwas anderes.  Nehmen Sie einfach Module, verbinden Sie sie mit Codeception und arbeiten Sie mit ihnen. </li><li>  Nun, ein solches Plus (wahrscheinlich ist es besser f√ºr gro√üe Unternehmen geeignet, wenn Sie viele Projekte und Dienstleistungen haben) - in allen Projekten sehen die Tests plus oder minus gleich aus.  Das ist sehr cool. </li></ol><br>  Ich werde kurz sagen, wie Codeception ist, da viele damit gearbeitet haben. <br><br><img src="https://habrastorage.org/webt/bp/ac/nt/bpacntwtc_xvl52su3nh7-vvidi.jpeg" alt="Bild"><br><br>  Codeception arbeitet an einem Akteurmodell.  Nachdem Sie es in das Projekt gezogen und initialisiert haben, wird eine solche Struktur generiert. <br><br>  Wir haben yml-Dateien, hier unten - <i>function.suite.yml</i> , <i>Integration.suit.yml</i> , <i>unit.suite.yml</i> .  Sie erstellen die Konfiguration Ihrer Tests.  Es gibt V√§ter f√ºr jede Art von Test, wo diese Tests sind, gibt es 3 Hilfsv√§ter: <br><br>  _ <i>Daten</i> - f√ºr Testdaten; <br>  _ <i>output</i> - wo Berichte abgelegt werden (xml, html); <br>  _ <i>support</i> - Hier werden einige Hilfshilfen, Funktionen und alles, was Sie schreiben, f√ºr Ihre Tests verwendet. <br><br>  Zun√§chst werde ich Ihnen sagen, was wir aus Codeception √ºbernommen haben, und es sofort verwenden, ohne etwas zu √§ndern, ohne zus√§tzliche Aufgaben oder Probleme zu l√∂sen. <br><br>  <b>Standardmodule</b> <br><br><ol><li>  Phpbrowser </li><li>  RUHE </li><li>  Db </li><li>  Cli </li><li>  AMQP </li></ol><br>  Das erste derartige Modul ist PhpBrowser.  Dieses Modul ist ein Wrapper √ºber Guzzle, mit dem Sie mit Ihrer Anwendung interagieren k√∂nnen: Seiten √∂ffnen, Formulare ausf√ºllen, Formulare senden.  Und wenn Sie sich nicht f√ºr browser- und browser√ºbergreifende Tests interessieren und pl√∂tzlich die Benutzeroberfl√§che testen, k√∂nnen Sie PhpBrowser verwenden.  In der Regel verwenden wir es in unseren UI-Tests, da wir keine komplizierte Interaktionslogik ben√∂tigen, sondern nur die Seite √∂ffnen und dort etwas Kleines tun m√ºssen. <br><br>  Das zweite Modul, das wir verwenden, ist REST.  Ich denke, der Name macht deutlich, was er tut.  F√ºr alle http-Interaktionen k√∂nnen Sie dieses Modul verwenden.  Es scheint mir, dass fast alle Interaktionen darin gel√∂st sind: Header, Cookies, Autorisierung.  Alles was du brauchst ist drin. <br><br>  Das dritte Modul, das wir sofort verwenden, ist das Db-Modul.  In neueren Versionen von Codeception wurde dort nicht nur eine, sondern mehrere Datenbanken unterst√ºtzt.  Wenn Sie pl√∂tzlich mehrere Datenbanken in Ihrem Projekt haben, funktioniert dies sofort. <br><br>  Das Cli-Modul, mit dem Sie <b>Shell-</b> und <b>Bash-</b> Befehle aus Tests ausf√ºhren k√∂nnen, und wir verwenden es auch. <br><br>  Es gibt ein AMQP-Modul, das mit allen Nachrichtenbrokern zusammenarbeitet, die auf diesem Protokoll basieren.  Ich m√∂chte darauf hinweisen, dass es offiziell auf RabbitMQ getestet wurde.  Da wir RabbitMQ verwenden, ist alles in Ordnung mit ihm. <br><br>  Tats√§chlich deckt Codeception, zumindest in unserem Fall, 80-85% aller Aufgaben ab, die wir ben√∂tigen.  Aber ich musste noch an etwas arbeiten. <br><br>  Beginnen wir mit SOAP. <br><img src="https://habrastorage.org/webt/c9/zy/bk/c9zybkm3eu-kvkxc_uvpcte_h0u.jpeg" alt="Bild"><br><br>  In unseren Diensten gibt es an einigen Stellen SOAP-Endpunkte.  Sie m√ºssen getestet, gezogen, etwas mit ihnen zu tun haben.  Sie werden jedoch sagen, dass es in Codeception ein solches Modul gibt, mit dem Sie Anfragen senden und dann etwas mit den Antworten tun k√∂nnen.  Irgendwie zu analysieren, Schecks hinzuzuf√ºgen und alles ist in Ordnung.  Das SOAP-Modul funktioniert jedoch nicht sofort mit mehreren SOAP-Endpunkten. <br><img src="https://habrastorage.org/webt/uj/s_/zv/ujs_zvshqpzmecycdggm3mys4nq.jpeg" alt="Bild"><br><br>  Zum Beispiel haben wir Monolithen mit mehreren WSDLs und mehreren SOAP-Endpunkten.  Dies bedeutet, dass es im Codeception-Modul unm√∂glich ist, dies in einer yml-Datei so zu konfigurieren, dass es mit mehreren arbeiten kann. <br><img src="https://habrastorage.org/webt/uc/z-/ab/ucz-abgapgah_r9qo6uoitkstg8.jpeg" alt="Bild"><br><br>  Codeception verf√ºgt √ºber eine dynamische Modulrekonfiguration, und Sie k√∂nnen eine Art Adapter schreiben, um beispielsweise ein SOAP-Modul zu empfangen und dynamisch neu zu konfigurieren.  In diesem Fall m√ºssen der Endpunkt und das verwendete Schema ersetzt werden.  Wenn Sie dann im Test den Endpunkt √§ndern m√ºssen, an den Sie eine Anfrage senden m√∂chten, erhalten wir unseren Adapter und √§ndern ihn in einen neuen Endpunkt, in eine neue Schaltung und senden eine Anfrage an ihn. <br><img src="https://habrastorage.org/webt/68/iu/kl/68iuklk2oherxt4ov7odgrszyli.jpeg" alt="Bild"><br><br>  In Codeception gibt es keine Arbeit mit Kafka und es gibt keine mehr oder weniger offiziellen Add-Ons von Drittanbietern, die mit Kafka zusammenarbeiten.  Es gibt keinen Grund zur Sorge, wir haben unser Modul geschrieben. <br><img src="https://habrastorage.org/webt/es/gp/eg/esgpegswio_kwmtqer7gkqvjfgi.jpeg" alt="Bild"><br><br>  Es ist also in einer yml-Datei konfiguriert.  Einige Einstellungen sind f√ºr Broker, Verbraucher und Themen festgelegt.  Diese Einstellungen k√∂nnen Sie beim Schreiben Ihres Moduls in Module mit der Initialisierungsfunktion ziehen und dieses Modul mit denselben Einstellungen initialisieren.  Tats√§chlich verf√ºgt das Modul √ºber alle anderen zu implementierenden Methoden: F√ºgen Sie die Nachricht in das Thema ein und lesen Sie sie.  Das ist alles, was Sie von diesem Modul ben√∂tigen. <br><img src="https://habrastorage.org/webt/zo/5p/bo/zo5pbox8a8xxic2n8972phohhd0.jpeg" alt="Bild"><br><br>  <b>Fazit</b> : Module f√ºr Codeception sind einfach zu schreiben. <br><br>  Mach weiter.  Wie gesagt, Codeception hat ein Cli-Modul - einen Wrapper f√ºr <i>Shell-</i> Befehle und die Arbeit mit deren Ausgabe. <br><img src="https://habrastorage.org/webt/8c/gg/yr/8cggyrxinincflxsx2ti3o4klwq.jpeg" alt="Bild"><br><br>  Manchmal muss der <i>Shell-</i> Befehl jedoch nicht in Tests, sondern in der Anwendung ausgef√ºhrt werden.  Im Allgemeinen sind Tests und Anwendungen leicht unterschiedliche Einheiten, sie k√∂nnen an verschiedenen Orten liegen.  Tests k√∂nnen an einem Ort ausgef√ºhrt werden, und die Anwendung kann sich an einem anderen Ort befinden. <br><br>  Warum m√ºssen wir <i>Shell</i> in Tests ausf√ºhren? <br><br>  Wir haben Befehle in Anwendungen, die beispielsweise Warteschlangen in RabbitMQ analysieren und Objekte nach Status verschieben.  Diese Befehle im Pro-Modus werden unter dem Supervisor gestartet.  Der Supervisor √ºberwacht deren Umsetzung.  Wenn sie fallen, startet er sie erneut und so weiter. <br><br>  Wenn wir testen, l√§uft der Supervisor nicht.  Andernfalls werden die Tests instabil und unvorhersehbar.  Wir selbst m√∂chten den Start dieser Befehle innerhalb der Anwendung steuern.  Daher m√ºssen wir diese Befehle aus den Tests in der Anwendung ausf√ºhren.  Wir verwenden zwei Optionen.  Das eine, das andere - im Prinzip ist alles gleich und alles funktioniert. <br><br>  Wie f√ºhre ich eine <i>Shell</i> in einer Anwendung aus? <br><br>  Erstens: F√ºhren Sie die Tests an derselben Stelle aus, an der sich die Anwendung befindet.  Da alle Anwendungen in Docker vorhanden sind, k√∂nnen Tests in demselben Container ausgef√ºhrt werden, in dem sich der Dienst selbst befindet. <br><br>  Die zweite Option: Erstellen Sie einen separaten Container f√ºr Tests, einige <i>Testl√§ufer</i> , aber machen Sie ihn mit der Anwendung identisch.  Das hei√üt, aus demselben Docker-Image, und dann funktioniert alles √§hnlich. <br><img src="https://habrastorage.org/webt/wm/hw/g0/wmhwg0-0xviw0be73xgrwfppsfi.jpeg" alt="Bild"><br><br>  Ein weiteres Problem, auf das wir bei den Tests gesto√üen sind, ist die Arbeit mit verschiedenen Dateisystemen.  Unten finden Sie ein Beispiel daf√ºr, womit Sie arbeiten k√∂nnen und sollten.  Die ersten drei sind f√ºr uns relevant.  Dies sind Webdav, SFTP und das Amazon-Dateisystem. <br><br>  Womit m√ºssen Sie arbeiten? <br><br><ol><li>  Webdav </li><li>  FTP / SFTP </li><li>  AWS S3 </li><li>  Lokal </li><li>  Azure, Dropbox, Google Drive </li></ol><br>  Wenn Sie in Codeception st√∂bern, finden Sie einige Module f√ºr fast jedes mehr oder weniger beliebte Dateisystem. <br><br><img src="https://habrastorage.org/webt/84/kr/ol/84krold4wqwi4ckxe4trmr8u9oq.jpeg" alt="Bild"><br><br>  Das einzige, was ich nicht gefunden habe, ist f√ºr Webdav.  Aber diese Dateisysteme, plus oder minus, sind in Bezug auf die externe Arbeit mit ihnen gleich, und wir m√∂chten mit ihnen auf die gleiche Weise arbeiten. <br><br>  Wir haben unser Modul Flysystem geschrieben.  Es liegt auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github</a> im √∂ffentlichen Bereich und unterst√ºtzt zwei Dateisysteme - SFTP und Webdav - und erm√∂glicht es Ihnen, mit beiden √ºber dieselbe API zu arbeiten. <br><img src="https://habrastorage.org/webt/5a/w5/sm/5aw5smemb1fabsbsyvt5eit70r8.jpeg" alt="Bild"><br><br>  Holen Sie sich eine Liste der Dateien, bereinigen Sie das Verzeichnis, schreiben Sie eine Datei und so weiter.  Wenn Sie dort auch das Amazon-Dateisystem hinzuf√ºgen, werden unsere Anforderungen definitiv abgedeckt. <br><br>  Der n√§chste Punkt, denke ich, ist sehr wichtig f√ºr Autotests, insbesondere auf Systemebene, ist die Arbeit mit Datenbanken.  Im Allgemeinen m√∂chte ich, dass es wie auf dem Bild - VZHUH ist und alles startet, es funktioniert, und diese Datenbanken sollten in Tests weniger unterst√ºtzt werden. <br><img src="https://habrastorage.org/webt/hb/-y/ul/hb-yulyfmetwazoatr4oukazpli.jpeg" alt="Bild"><br><br>  Was sind die Hauptaufgaben, die ich hier sehe: <br><br><ol><li>  So rollen Sie die Datenbank der gew√ºnschten Struktur aus - Db </li><li>  So f√ºllen Sie die Datenbank mit Testdaten - Db, Fixtures </li><li>  So treffen Sie Auswahlen und √úberpr√ºfungen - Db </li></ol><br>  F√ºr alle 3 Aufgaben in Codeception gibt es 2 Module - Db, √ºber die ich bereits gesprochen habe, ein anderes hei√üt Fixtures. <br><br>  Von diesen 2 Modulen und 3 Aufgaben verwenden wir nur DB f√ºr die dritte Aufgabe. <br><br>  F√ºr die erste Aufgabe k√∂nnen Sie DB verwenden.  Dort k√∂nnen Sie den SQL-Speicherauszug konfigurieren, von dem aus die Datenbank bereitgestellt wird. Nun, das Modul mit Fixtures. Ich denke, es ist klar, warum es ben√∂tigt wird. <br><br>  Es wird Fixtures in Form von Arrays geben, die in der Datenbank beibehalten werden k√∂nnen. <br><br>  Wie gesagt, die ersten beiden Aufgaben l√∂sen wir etwas anders, jetzt werde ich Ihnen sagen, wie wir das machen. <br><br>  <b>Datenbankbereitstellung</b> <br><br><ol><li>  Container mit PostgreSQL oder MySQL anheben </li><li>  Wir rollen alle Migrationen mit Doktrinmigrationen </li></ol><br>  Der erste betrifft die Bereitstellung einer Datenbank.  Wie passiert das in Tests?  Wir erh√∂hen den Container mit der gew√ºnschten Datenbank - entweder PostgreSQL oder MySQL - und rollen dann alle erforderlichen Migrationen mithilfe von <i>Doktrinmigrationen</i> .  Alles, die Datenbank der gew√ºnschten Struktur ist fertig, kann in Tests verwendet werden. <br><br>  Warum wir keine Feuchtigkeit verwenden - denn dann muss es nicht unterst√ºtzt werden.  Dies ist eine Art Speicherauszug, der bei den Tests liegt und st√§ndig aktualisiert werden muss, wenn sich etwas in der Datenbank √§ndert.  Es gibt Migrationen - es ist nicht erforderlich, einen Speicherauszug zu verwalten. <br><br>  Der zweite Punkt ist die Erstellung von Testdaten.  Wir verwenden nicht das Fixtures-Modul von Codeception, sondern das <i>Symfony-</i> Bundle f√ºr Fixtures. <br><img src="https://habrastorage.org/webt/kx/lf/m9/kxlfm9zppbdqmgj_i_ekaripjw4.jpeg" alt="Bild"><br><br>  Es gibt einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Link</a> dazu und ein Beispiel, wie Sie Fixtures in der Datenbank erstellen k√∂nnen. <br><br>  Ihr Ger√§t wird dann als ein Objekt der Dom√§ne erstellt, es kann in der Datenbank gespeichert werden und die Testdaten sind bereit. <br><br>  Warum DoctrineFixtureBundle? <br><br><ol><li>  Einfachere Erstellung von Ketten verwandter Objekte. </li><li>  Weniger Datenverdoppelung, wenn Vorrichtungen f√ºr verschiedene Tests √§hnlich sind. </li><li>  Weniger √Ñnderungen beim √Ñndern der Datenbankstruktur. </li><li>  Fixture-Klassen sind viel visueller als Arrays. </li></ol><br>  Warum benutzen wir es?  Ja, aus dem gleichen Grund - diese Ger√§te sind viel einfacher zu warten als Ger√§te von Codeception.  Es ist einfacher, Ketten verwandter Objekte zu erstellen, da sich alles im Symfony-Bundle befindet.  Es m√ºssen weniger Daten dupliziert werden, da Fixtures vererbt werden k√∂nnen. Dies sind Klassen.  Wenn sich die Datenbankstruktur √§ndert, m√ºssen diese Arrays immer bearbeitet werden und Klassen nicht immer.  Fixtures in Form von Domain-Objekten sind immer sichtbarer als Arrays. <br><br>  Wir haben √ºber Datenbanken gesprochen, lassen Sie uns ein wenig √ºber Moki sprechen. <br><br>  Da es sich um Tests auf einem ausreichend hohen Niveau handelt, die das gesamte System testen, und da unsere Systeme stark miteinander verbunden sind, ist klar, dass es einige Austausche und Interaktionen gibt.  Jetzt werden wir √ºber Mokeys √ºber die Interaktion zwischen Systemen sprechen. <br><br>  <b>Regeln f√ºr mok</b> <br><br><ol><li>  Weinen Sie alle externen http-Service-Interaktionen </li><li>  √úberpr√ºfen Sie nicht nur positive, sondern auch negative Szenarien </li></ol><br>  Interaktionen sind einige REST- oder SOAP-http-Interaktionen.  All diese Wechselwirkungen im Rahmen der Tests, die wir benetzen.  Das hei√üt, in unseren Tests gibt es nirgendwo einen wirklichen Anreiz f√ºr externe Systeme.  Dies macht die Tests stabil.  Da ein externer Dienst m√∂glicherweise funktioniert, m√∂glicherweise nicht funktioniert, m√∂glicherweise langsam reagiert, m√∂glicherweise im Allgemeinen schnell wei√ü, wie er sich verh√§lt.  Deshalb decken wir alles mit Moks ab. <br><br>  Wir haben auch eine solche Regel.  Wir befeuchten nicht nur positive Interaktionen, sondern versuchen auch, einige negative F√§lle zu √ºberpr√ºfen.  Wenn beispielsweise ein Dienst eines Drittanbieters mit einem 500. Fehler antwortet oder einen aussagekr√§ftigeren Fehler erzeugt, versuchen wir, alles zu √ºberpr√ºfen. <br><br>  Wir verwenden Wiremock f√ºr Mocks, Codeception selbst unterst√ºtzt ..., es hat ein solches offizielles Add-On Httpmock, aber wir mochten Wiremock mehr.  Wie funktioniert es <br><br><br><br>  Wiremock wird w√§hrend der Tests als separater Docker-Container erstellt, und alle Anforderungen, die an das externe System gesendet werden m√ºssen, gehen an Wiremock. <br><br><img src="https://habrastorage.org/webt/n9/cb/y8/n9cby8a1hoiicw5fqprvzsfxsae.jpeg" alt="Bild"><br><br>  Wiremock, wenn Sie sich die Folie ansehen - es gibt ein solches Feld, Anforderungszuordnung. Es enth√§lt eine Reihe solcher Zuordnungen, die besagen, dass Sie eine solche Antwort geben m√ºssen, wenn eine solche Anforderung eintrifft.  Alles ist sehr einfach: Eine Anfrage kam - erhielt einen Schein. <br><br>  Mocks k√∂nnen statisch erstellt werden, dann wird der Container, wenn bereits mit Wiremock steigt, diese Mocks verf√ºgbar sein, sie k√∂nnen f√ºr manuelle Tests verwendet werden.  Sie k√∂nnen direkt im Code in einer Art Test dynamisch erstellen. <br><br>  Hier ist ein Beispiel daf√ºr, wie man ein Modell dynamisch erstellt. Die Beschreibung ist ziemlich deklarativ. Aus dem Code geht sofort hervor, welche Art von Modell wir erstellen: ein Modell f√ºr die GET-Methode, die zu einer solchen URL kommt, und tats√§chlich, was zur√ºckgegeben werden soll. <br><br><img src="https://habrastorage.org/webt/d7/xu/2g/d7xu2gg75_-vjff1ejruhj2dvba.jpeg" alt="Bild"><br><br>  Zus√§tzlich zu der Tatsache, dass dieses Modell erstellt werden kann, hat Wiremock die M√∂glichkeit, zu √ºberpr√ºfen, welche Anforderung an dieses Modell gesendet wurde.  Dies ist auch bei Tests sehr n√ºtzlich. <br><br>  √úber Codeception selbst, wahrscheinlich alles und ein paar Worte dar√ºber, wie unsere Tests ausgef√ºhrt werden, und ein bisschen Infrastruktur. <br><br>  Was benutzen wir? <br><br><img src="https://habrastorage.org/webt/qy/my/hj/qymyhjaocwm0apzi7orjlot7hnw.jpeg" alt="Bild"><br><br>  Nun, erstens, alle Dienste, die wir in Docker haben. Wenn Sie also eine Testumgebung starten, werden die richtigen Container angehoben. <br><br>  Make wird f√ºr interne Befehle verwendet, Bamboo wird als CI verwendet. <br><br>  Wie sieht der CI-Testlauf aus? <br><br><img src="https://habrastorage.org/webt/hb/iq/jf/hbiqjftacif8wg-67x666c7l5yc.jpeg" alt="Bild"><br><br>  Zuerst erstellen wir die gew√ºnschte Version der Anwendung, dann erh√∂hen wir die Umgebung - dies ist die Anwendung, alle Dienste, die sie ben√∂tigt, wie Kafka, Rabbit, die Datenbank, und wir f√ºhren die Migration in die Datenbank durch. <br><br>  All diese Umgebungen werden mithilfe von Docker Compose erstellt.  In CI drehen sich alle Container unter Kubernetes.  F√ºhren Sie dann die Tests aus und f√ºhren Sie sie aus. <br><br>  Wie lange dauert das alles? <br><br>  Es h√§ngt alles vom jeweiligen Dienst ab, aber in der Regel betr√§gt das Erh√∂hen der Umgebung vor dem Ausf√ºhren der Tests 5 bis 10 Minuten, Tests - von 6 bis 30 Minuten. <br><br><img src="https://habrastorage.org/webt/nm/kh/n0/nmkhn0sdps-qtoowra4mrtgtu8m.jpeg" alt="Bild"><br><br>  Ich werde diese Frage sofort warnen, w√§hrend alle Tests in einem Thread ausgef√ºhrt werden. <br><br>  Nun, so eine Frage.  Wie oft sollten Tests durchgef√ºhrt werden?  Nat√ºrlich, je √∂fter, desto besser.  Je fr√ºher Sie ein Problem erkennen k√∂nnen, desto schneller k√∂nnen Sie es l√∂sen. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Wir haben 2 Hauptregeln. </font><font style="vertical-align: inherit;">Wenn eine Aufgabe getestet wird, m√ºssen alle Tests sie bestehen, sowohl Unit- als auch nicht Unit-Tests. </font><font style="vertical-align: inherit;">Wenn einige Tests fehlschlagen, ist dies eine Gelegenheit, die Aufgabe auf die Korrektur zu √ºbertragen. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nat√ºrlich, wenn wir die Ver√∂ffentlichung herausbringen. </font><font style="vertical-align: inherit;">Bei der Ver√∂ffentlichung m√ºssen alle Tests bestanden werden. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Am Ende m√∂chte ich etwas Inspirierendes sagen - Tests schreiben, gr√ºn sein lassen, Codeception verwenden, Moki machen. </font><font style="vertical-align: inherit;">Ich denke, Sie alle verstehen das perfekt.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de452136/">https://habr.com/ru/post/de452136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de452124/index.html">‚ÄûWir brauchen Wissens- und Leistungshunger‚Äú - wie ist es, Tester bei der Alfa-Bank zu sein?</a></li>
<li><a href="../de452128/index.html">Beliebte Missverst√§ndnisse √ºber die Strahlungsbest√§ndigkeit von Mikroschaltungen</a></li>
<li><a href="../de452130/index.html">Der Mond schrumpft, er verursacht Mondbeben</a></li>
<li><a href="../de452132/index.html">Freiberuflerpfad</a></li>
<li><a href="../de452134/index.html">Wie alles begann: die Geschichte des L√∂tkolbens und das Aufkommen moderner Werkzeuge</a></li>
<li><a href="../de452138/index.html">13. Check Point Erste Schritte R80.20. Lizenzierung</a></li>
<li><a href="../de452140/index.html">Warum wechseln CFOs in der IT zu einem Betriebskostenmodell?</a></li>
<li><a href="../de452142/index.html">Wie gehen wir mit dem Kopieren von Inhalten oder dem ersten gegnerischen Angriff in Prod um?</a></li>
<li><a href="../de452146/index.html">Was passiert also mit Authentifizierung und Passw√∂rtern? Teil 2 des Javelin Strong Authentication Status Report</a></li>
<li><a href="../de452152/index.html">Welche L√∂sungen hat Rostelecom f√ºr IIoT?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>