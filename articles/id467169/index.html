<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸï¸ ğŸˆ³ ğŸ“‰ Pelajaran yang diperoleh dari pengujian Lebih dari 200.000 baris Kode Infrastruktur ğŸ‘¨ğŸ¾â€ğŸŒ¾ ğŸ¤°ğŸ¼ ğŸ––ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IaC (Infrastructure as Code) adalah pendekatan modern dan saya percaya bahwa infrastruktur adalah kode. Ini berarti bahwa kita harus menggunakan filos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pelajaran yang diperoleh dari pengujian Lebih dari 200.000 baris Kode Infrastruktur</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467169/"><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"></p><br><p>  <strong>IaC</strong> (Infrastructure as Code) adalah pendekatan modern dan saya percaya bahwa infrastruktur adalah kode.  Ini berarti bahwa kita harus menggunakan filosofi yang sama untuk infrastruktur seperti untuk pengembangan perangkat lunak.  Jika kita berbicara bahwa infrastruktur adalah kode, maka kita harus menggunakan kembali praktik dari pengembangan untuk infrastruktur, yaitu pengujian unit, pemrograman pasangan, tinjauan kode.  Harap ingat ide ini saat membaca artikel. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Versi Rusia</a> </p><a name="habracut"></a><br><p>  Ini adalah terjemahan dari pidato saya ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">video RU</a> ) di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DevopsConf 2019-05-28</a> . </p><br><div class="spoiler">  <b class="spoiler_title">Slide dan video</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Versi Rusia</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Versi Rusia</a> </li><li>  Lari kering 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Video (RU) dari DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Video (RU) dari DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Slide</a> </li></ul></div></div><br><h1 id="infrastructure-as-bash-history">  Infrastruktur sebagai bash history </h1><br><p><img src="https://habrastorage.org/webt/i_/yl/fm/i_ylfms8w-9pgisnujlu-iv1u3y.png"></p><br><p>  Mari kita bayangkan bahwa Anda sedang berada dalam suatu proyek dan Anda mendengar sesuatu seperti: "Kami menggunakan <em>Infrastruktur sebagai</em> pendekatan <em>Kode</em> ".  Sayangnya, yang mereka maksud adalah <em>Infrastruktur sebagai bash history</em> atau <em>Dokumentasi sebagai bash history</em> .  Ini hampir merupakan situasi nyata.  Sebagai contoh, Denis Lysenko menggambarkan situasi ini dalam pidatonya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cara mengganti infrastruktur dan berhenti mengkhawatirkan (RU)</a> .  Denis berbagi cerita tentang bagaimana mengubah sejarah bash menjadi infrastruktur kelas atas. </p><br><p> Mari kita periksa definisi kode sumber: <code>a text listing of commands to be compiled or assembled into an executable computer program</code> .  Jika mau, kami dapat menyajikan <em>Infrastruktur sebagai</em> kode <em>bash history</em> like.  Ini adalah teks &amp; daftar perintah.  Ini menjelaskan bagaimana server dikonfigurasi.  Apalagi itu adalah: </p><br><ol><li>  <em>Reproducible</em> : Anda bisa mendapatkan bash history, menjalankan perintah dan mungkin mendapatkan infrastruktur yang berfungsi. </li><li>  <em>Versi</em> : Anda tahu siapa yang masuk, kapan dan apa yang dilakukan. <br>  Sayangnya, jika Anda kehilangan server, Anda tidak dapat melakukan apa-apa karena tidak ada bash history, Anda kehilangan itu dengan server. </li></ol><br><p>  Apa yang harus dilakukan? </p><br><h1 id="infrastructure-as-code">  Infrastruktur sebagai kode </h1><br><p><img src="https://habrastorage.org/webt/gm/3e/wf/gm3ewf7g3w72takvuffsxhcbgoy.png"></p><br><p>  Di satu sisi, kasus abnormal ini, <em>Infrastruktur sebagai bash history</em> , dapat disajikan sebagai <em>Infrastruktur sebagai Kode</em> , tetapi di sisi lain, jika Anda ingin melakukan sesuatu yang lebih kompleks daripada server LAMP, Anda harus mengelola, memelihara, dan memodifikasi kode .  Mari kita ngobrol tentang paralel antara <em>Infrastruktur sebagai</em> pengembangan <em>Kode</em> dan pengembangan perangkat lunak. </p><br><h2 id="dry">  KERING </h2><br><p><img src="https://habrastorage.org/webt/rx/qa/vf/rxqavfjxrtmtwkjzzq4prr72oao.png"></p><br><p>  Kami sedang mengembangkan SDS (penyimpanan yang ditentukan perangkat lunak).  SDS terdiri dari OS kustom distributif, server kelas atas, banyak logika bisnis, sehingga harus menggunakan perangkat keras nyata.  Secara berkala, ada sub-tugas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menginstal SDS</a> .  Sebelum menerbitkan rilis baru, kami harus menginstal dan memeriksa.  Pada awalnya, itu tampak seperti tugas yang sangat sederhana: </p><br><ul><li>  SSH menjadi tuan rumah dan menjalankan perintah. </li><li>  SCP file. </li><li>  Ubah konfigurasi. </li><li>  Jalankan layanan. </li><li>  ... </li><li>  KEUNTUNGAN! </li></ul><br><p>  Saya percaya bahwa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Make CM, bukan bash</a> adalah pendekatan yang baik.  Namun, bash hanya digunakan dalam kasus yang ekstrem dan terbatas, seperti pada awal proyek.  Jadi, bash adalah pilihan yang cukup bagus dan masuk akal di awal proyek.  Waktu terus berjalan.  Kami menghadapi berbagai permintaan untuk membuat instalasi baru dalam konfigurasi yang sedikit berbeda.  Kami SSHing ke instalasi, dan menjalankan perintah untuk menginstal semua perangkat lunak yang diperlukan, mengedit file konfigurasi dengan skrip dan, akhirnya, mengkonfigurasi SDS melalui API sisa HTTP Web.  Lagi pula instalasi itu sudah dikonfigurasi dan berfungsi.  Ini adalah praktik yang cukup umum, tetapi ada banyak skrip bash dan logika instalasi menjadi lebih kompleks setiap hari. </p><br><p>  Sayangnya, setiap skrip seperti kepingan salju kecil tergantung pada siapa yang menyalinnya.  Itu juga sangat menyakitkan ketika kami membuat atau menciptakan kembali instalasi. </p><br><p>  Saya harap Anda sudah mendapat ide utama, bahwa pada tahap ini kami harus terus-menerus mengubah logika skrip hingga layanan OK.  Tapi, ada solusi untuk itu.  Itu KERING </p><br><p><img src="https://habrastorage.org/webt/-u/ep/cv/-uepcvi1kjsnruflehy0noydk1k.png"></p><br><p>  Ada pendekatan KERING (Jangan Ulangi Diri Sendiri).  Gagasan utamanya adalah menggunakan kembali kode yang sudah ada.  Kedengarannya sangat sederhana.  Dalam kasus kami, KERING artinya: pisahkan konfigurasi dan skrip. </p><br><h2 id="solid-for-cfm">  SOLID untuk CFM </h2><br><p><img src="https://habrastorage.org/webt/kt/7f/ba/kt7fbazyy0arjwrnlwgoynqbvqg.png"></p><br><p>  Proyek itu berkembang, sebagai hasilnya, kami memutuskan untuk menggunakan Ansible.  Ada beberapa alasan untuk itu: </p><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bash seharusnya tidak mengandung logika kompleks</a> . </li><li>  Kami memiliki sejumlah keahlian dalam Ansible. </li></ol><br><p>  Ada sejumlah logika bisnis di dalam kode Ansible.  Ada pendekatan untuk meletakkan berbagai hal dalam kode sumber selama proses pengembangan perangkat lunak.  Ini disebut <em>SOLID</em> .  Dari sudut pandang saya, kita dapat menggunakan kembali <em>SOLID</em> untuk <em>Infrastruktur sebagai Kode</em> .  Biarkan saya jelaskan langkah demi langkah. </p><br><h3 id="the-single-responsibility-principle">  Prinsip Tanggung Jawab Tunggal </h3><br><p><img src="https://habrastorage.org/webt/yh/h7/kg/yhh7kgr1jal27ddvpeydqxcmzog.png"></p><br><p>  <em>Kelas seharusnya hanya memiliki satu tanggung jawab, yaitu, hanya perubahan pada satu bagian dari spesifikasi perangkat lunak yang dapat mempengaruhi spesifikasi kelas.</em> </p><br><p>  Anda tidak boleh membuat Kode Spaghetti di dalam kode infrastruktur Anda.  Infrastruktur Anda harus dibuat dari batu bata sederhana yang dapat diprediksi.  Dengan kata lain, mungkin ide yang baik untuk membagi buku pedoman Ansible yang sangat besar menjadi peran Ansible yang independen.  Akan lebih mudah dirawat. </p><br><h3 id="the-open-closed-principle">  Prinsip terbuka-tertutup </h3><br><p><img src="https://habrastorage.org/webt/g6/ym/qn/g6ymqn8vohwbewqx7hgixuiuuf8.png"></p><br><p>  <em>Entitas perangkat lunak ... harus terbuka untuk ekstensi, tetapi ditutup untuk modifikasi.</em> </p><br><p>  Pada awalnya, kami menyebarkan SDS di mesin virtual, sedikit kemudian kami menambahkan <em>penyebaran ke server bare metal</em> .  Kami telah melakukannya.  Itu semudah pie bagi kami karena kami baru saja menambahkan implementasi untuk bagian khusus bare metal tanpa memodifikasi logika instalasi SDS. </p><br><h3 id="the-liskov-substitution-principle">  Prinsip Substitusi Liskov </h3><br><p><img src="https://habrastorage.org/webt/1x/-4/am/1x-4am1tjecrhxx3jm7bfur00oy.png"></p><br><p>  <em>Objek dalam suatu program harus diganti dengan instance subtipe mereka tanpa mengubah kebenaran program itu.</em> </p><br><p>  Mari kita berpikiran terbuka.  <em>SOLID</em> mungkin digunakan dalam CFM secara umum, itu bukan proyek yang beruntung.  Saya ingin menggambarkan proyek lain.  Ini adalah solusi out of box enterprise.  Ini mendukung berbagai basis data, server aplikasi dan antarmuka integrasi dengan sistem pihak ketiga.  Saya akan menggunakan contoh ini untuk menggambarkan sisa <em>SOLID</em> </p><br><p>  Misalnya dalam kasus kami, ada kesepakatan di dalam tim infrastruktur: jika Anda menggunakan ibm java role atau oracle java atau openjdk, Anda akan memiliki java binary yang dapat dieksekusi.  Kami membutuhkannya karena tingkat atas * Peran yang dimungkinkan bergantung pada itu.  Juga, ini memungkinkan kita untuk menukar implementasi java tanpa memodifikasi logika pemasangan aplikasi. </p><br><p>  Sayangnya, tidak ada gula sintaks untuk itu di buku pedoman Ansible.  Ini berarti bahwa Anda harus mengingatnya sambil mengembangkan peran yang Mungkin. </p><br><h3 id="the-interface-segregation-principle">  Prinsip Pemisahan Antarmuka </h3><br><p><img src="https://habrastorage.org/webt/v2/9r/wa/v29rwalnqryarhrwe-_r8jvx0go.png"></p><br><p>  <em>Banyak antarmuka khusus klien lebih baik dari satu antarmuka tujuan umum.</em> </p><br><p>  Pada awalnya, kami menempatkan logika instalasi aplikasi ke dalam buku pedoman tunggal, kami mencoba untuk menutupi semua kasus dan memotong ujungnya.  Kami telah menghadapi masalah yang sulit untuk dipertahankan, jadi kami mengubah pendekatan kami.  Kami memahami bahwa klien membutuhkan antarmuka dari kami (yaitu https di port 443) dan kami dapat menggabungkan peran Ansible kami untuk setiap lingkungan spesifik. </p><br><h3 id="the-dependency-inversion-principle">  Prinsip Pembalikan Ketergantungan </h3><br><p><img src="https://habrastorage.org/webt/ee/ip/e8/eeipe8nr7hbjx18yxtoxsekwlfy.png"></p><br><p>  <em>Seseorang harus "bergantung pada abstraksi, [bukan] konkret."</em> </p><br><ul><li>  <em>Modul tingkat tinggi tidak harus bergantung pada modul tingkat rendah.</em>  <em>Keduanya harus bergantung pada abstraksi (misalnya antarmuka).</em> </li><li>  <em>Abstraksi tidak harus bergantung pada detail.</em>  <em>Detail (implementasi konkret) harus bergantung pada abstraksi.</em> </li></ul><br><p>  Saya ingin menjelaskan prinsip ini melalui anti-pola. </p><br><ol><li>  Ada pelanggan dengan cloud pribadi. </li><li>  Kami meminta VM di cloud. </li><li>  Logika penerapan kami bergantung pada hypervisor mana VM berada. </li></ol><br><p>  Dengan kata lain, kami tidak dapat menggunakan kembali IaC kami di cloud lain karena logika penggunaan tingkat atas bergantung pada implementasi tingkat yang lebih rendah.  <strong>Tolong jangan lakukan itu</strong> </p><br><h1 id="interaction">  Interaksi </h1><br><p><img src="https://habrastorage.org/webt/rd/7_/8r/rd7_8rtprcz4xjkuhctjppbkcuu.png"></p><br><p>  Infrastruktur bukan hanya kode, ini juga tentang kode interaksi &lt;-&gt; DevOps, DevOps &lt;-&gt; DevOps, IaC &lt;-&gt; orang. </p><br><h2 id="bus-factor">  Faktor bus </h2><br><p><img src="https://habrastorage.org/webt/p5/4-/wh/p54-whkhcglorvk_dlt0b1jpajy.png"></p><br><p>  Mari kita bayangkan, ada insinyur DevOps John.  John tahu segalanya tentang infrastruktur Anda.  Jika John ditabrak bus, apa yang akan terjadi dengan infrastruktur Anda?  Sayangnya, ini hampir merupakan kasus nyata.  Beberapa waktu terjadi sesuatu.  Jika itu terjadi dan Anda tidak berbagi pengetahuan tentang IaC, Infrastruktur di antara anggota tim Anda, Anda akan menghadapi banyak konsekuensi yang tidak terduga &amp; canggung.  Ada beberapa pendekatan untuk mengatasinya.  Mari kita ngobrol tentang mereka. </p><br><h2 id="pair-devopsing">  Pasangkan DevOpsing </h2><br><p><img src="https://habrastorage.org/webt/6q/0l/t0/6q0lt0afzbkpivxxp4uvryxgake.png"></p><br><p>  Ini seperti pemrograman pasangan.  Dengan kata lain, ada dua insinyur DevOps dan mereka menggunakan laptop \ keyboard tunggal untuk mengkonfigurasi infrastruktur: mengkonfigurasi server, membuat peran yang memungkinkan, dll.  Kedengarannya hebat, bagaimanapun, itu tidak berhasil untuk kita.  Ada beberapa kasus khusus ketika sebagian berfungsi. </p><br><ul><li>  <em>Onboarding</em> : Mentor &amp; orang baru mendapatkan tugas nyata dari jaminan dan bekerja bersama - mentransfer pengetahuan dari mentor ke orang tersebut. </li><li>  <em>Panggilan Insiden</em> : Selama pemecahan masalah, ada sekelompok insinyur, mereka mencari solusi.  Poin kuncinya adalah ada orang yang memimpin insiden ini.  Orang tersebut membagikan layar &amp; ide.  Orang lain dengan hati-hati mengikutinya dan memperhatikan trik bash, kesalahan, log parsing dll. </li></ul><br><h2 id="code-review">  Ulasan kode </h2><br><p><img src="https://habrastorage.org/webt/wk/u6/vn/wku6vntzzsquckgu58n1_r3tg-i.png"></p><br><p>  Dari sudut pandang saya, <em>tinjauan Kode</em> adalah salah satu cara paling efisien untuk berbagi pengetahuan di dalam tim tentang infrastruktur Anda.  Bagaimana cara kerjanya? </p><br><ul><li>  Ada repositori yang berisi deskripsi infrastruktur Anda. </li><li>  Setiap orang melakukan perubahan di cabang khusus. </li><li>  Saat permintaan penggabungan, Anda dapat meninjau delta perubahan infrastruktur Anda. </li></ul><br><p>  Yang paling menarik adalah kami memutar resensi.  Ini berarti bahwa setiap beberapa hari kami memilih resensi baru dan pengulas melihat semua permintaan penggabungan.  Akibatnya, secara teoritis, setiap orang harus menyentuh bagian baru dari infrastruktur dan memiliki pengetahuan rata-rata tentang infrastruktur kami secara umum. </p><br><h3 id="code-style">  Gaya Kode </h3><br><p><img src="https://habrastorage.org/webt/qa/fz/ju/qafzju1vc86llmvcc1m4urpfa7c.png"></p><br><p>  Waktu terus berjalan, kami terkadang berdebat selama peninjauan karena peninjau dan committer mungkin menggunakan gaya kode yang berbeda: 2 spasi atau 4, <em>camelCase</em> atau <em>snake_case</em> .  Kami menerapkannya, tapi itu bukan piknik. </p><br><ul><li>  Gagasan pertama adalah merekomendasikan menggunakan linter.  Setiap orang memiliki lingkungan pengembangannya sendiri: IDE, OS ... sulit untuk menyinkronkan &amp; menyatukan semuanya. </li><li>  Idenya berkembang menjadi bot kendur.  Setelah setiap komit, bot sedang memeriksa kode sumber &amp; mendorong ke pesan slack dengan daftar masalah.  Sayangnya, dalam sebagian besar kasus, tidak ada perubahan kode sumber setelah pesan. </li></ul><br><h3 id="green-build-master">  Tuan bangunan hijau </h3><br><p><img src="https://habrastorage.org/webt/lw/ow/xi/lwowxis0izoohgthm9db7nheih4.png"></p><br><p>  Selanjutnya, langkah paling menyakitkan adalah membatasi mendorong ke cabang master untuk semua orang.  Hanya melalui permintaan gabungan &amp; uji hijau harus ok.  Ini disebut <em>Green Build Master</em> .  Dengan kata lain, Anda 100% yakin bahwa Anda dapat menggunakan infrastruktur Anda dari cabang utama.  Ini adalah praktik yang cukup umum dalam pengembangan perangkat lunak: </p><br><ul><li>  Ada repositori yang berisi deskripsi infrastruktur Anda. </li><li>  Setiap orang melakukan perubahan di cabang khusus. </li><li>  Untuk setiap cabang, kami menjalankan tes. </li><li>  Anda tidak dapat bergabung ke cabang master jika tes gagal. </li></ul><br><p>  Itu adalah keputusan yang sulit.  Semoga, sebagai hasil selama proses peninjauan, tidak ada perdebatan tentang gaya kode dan jumlah bau kode berkurang. </p><br><h1 id="iac-testing">  Pengujian IaC </h1><br><p><img src="https://habrastorage.org/webt/ah/dg/sa/ahdgsaecxtevlwnv9ozcoiypkq8.png"></p><br><p>  Selain memeriksa gaya kode, Anda dapat memeriksa apakah Anda dapat menggunakan atau menciptakan kembali infrastruktur Anda di kotak pasir.  Untuk apa  Ini adalah pertanyaan yang rumit dan saya ingin membagikan sebuah cerita alih-alih jawaban.  Itu adalah scaler otomatis khusus untuk AWS yang ditulis dalam Powershell.  Auto-scaler tidak memeriksa edge input untuk param input, sebagai hasilnya, ia menciptakan banyak mesin virtual dan pelanggan tidak senang.  Ini adalah situasi yang canggung, mudah-mudahan, mungkin untuk menangkapnya pada tahap paling awal. </p><br><p>  Di satu sisi, dimungkinkan untuk menguji skrip &amp; infrastruktur, tetapi di sisi lain, Anda meningkatkan jumlah kode dan membuat infrastruktur lebih kompleks.  Namun, alasan sebenarnya untuk itu adalah karena Anda menempatkan pengetahuan Anda tentang infrastruktur untuk pengujian.  Anda menggambarkan bagaimana hal-hal seharusnya bekerja bersama. </p><br><h2 id="iac-testing-pyramid">  IaC Menguji Piramida </h2><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><h3 id="iac-testing-static-analysis">  Pengujian IaC: Analisis Statis </h3><br><p>  Anda dapat membuat seluruh infrastruktur dari awal untuk setiap komit, tetapi, biasanya, ada beberapa kendala: </p><br><ul><li>  Harganya stratosfer. </li><li>  Itu membutuhkan banyak waktu. </li></ul><br><p>  Semoga ada beberapa trik.  Anda harus memiliki banyak tes sederhana, cepat, primitif di yayasan Anda. </p><br><h4 id="bash-is-tricky">  Bash itu rumit </h4><br><p>  Mari kita lihat contoh yang sangat sederhana.  Saya ingin membuat skrip cadangan: </p><br><ul><li>  Dapatkan semua file dari direktori saat ini. </li><li>  Salin file ke direktori lain dengan nama yang dimodifikasi. </li></ul><br><p>  Ide pertama adalah: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp $i /some/path/$i.bak done</code> </pre> <br><p>  Cukup bagus.  Namun, bagaimana jika nama file mengandung <em>spasi</em> ?  Kami adalah orang pintar, kami menggunakan kutipan: </p><br><pre> <code class="plaintext hljs">for i in * ; do cp "$i" "/some/path/$i.bak" done</code> </pre> <br><p>  Apakah kita sudah selesai?  Tidak!  Bagaimana jika direktori tersebut kosong?  Globing gagal dalam kasus ini. </p><br><pre> <code class="plaintext hljs">find . -type f -exec mv -v {} dst/{}.bak \;</code> </pre> <br><p>  Sudahkah kita selesai?  Belum ... Kami lupa bahwa nama file mungkin mengandung <code>\n</code> karakter. </p><br><pre> <code class="plaintext hljs">touch x mv x "$(printf "foo\nbar")" find . -type f -print0 | xargs -0 mv -t /path/to/target-dir</code> </pre> <br><h4 id="static-analysis-tools">  Alat analisis statis </h4><br><p>  Anda dapat menangkap beberapa masalah dari contoh sebelumnya melalui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Shellcheck</a> .  Ada banyak alat seperti itu, mereka disebut linter dan Anda dapat menemukan yang paling cocok untuk IDE, stack, dan lingkungan Anda. </p><br><div class="scrollable-table"><table><thead><tr><th>  Bahasa </th><th>  Alat </th></tr></thead><tbody><tr><td>  bash </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Shellcheck</a> </td></tr><tr><td>  Ruby </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Rubocop</a> </td></tr><tr><td>  ular sanca </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pylint</a> </td></tr><tr><td>  Mungkin </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Serat yang memungkinkan</a> </td></tr></tbody></table></div><br><h3 id="iac-testing-unit-tests">  Pengujian IaC: Tes Unit </h3><br><p><img src="https://habrastorage.org/webt/pn/wx/av/pnwxavylqxfmvcc-oynjhjmsq-a.png"></p><br><p>  Seperti yang Anda lihat, linter tidak bisa menangkap semuanya, mereka hanya bisa memprediksi.  Jika kita terus memikirkan persamaan antara pengembangan perangkat lunak dan Infrastruktur sebagai Kode, kita harus menyebutkan uji unit.  Ada banyak sistem unit test seperti <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">shunit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">JUnit</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">RSpec</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pytest</a> .  Tetapi apakah Anda pernah mendengar tentang unit test untuk Ansible, Chef, Saltstack, CFengine? </p><br><p>  Ketika kami berbicara tentang <em>SOLID</em> untuk CFM, saya menyebutkan bahwa infrastruktur kami harus dibuat dari batu bata / modul sederhana.  Sekarang waktunya telah tiba: </p><br><ol><li>  Pisahkan infrastruktur menjadi modul / istirahat sederhana, mis. Peran yang dimungkinkan. </li><li>  Buat lingkungan yaitu Docker atau VM. </li><li>  Terapkan satu istirahat / modul sederhana Anda ke lingkungan. </li><li>  Periksa apakah semuanya baik-baik saja atau tidak. <br>  ... </li><li>  KEUNTUNGAN! </li></ol><br><h4 id="iac-testing-unit-testing-tools">  IaC Testing: Alat Unit Testing </h4><br><p>  Apa tes untuk CFM dan infrastruktur Anda?  yaitu Anda hanya dapat menjalankan skrip atau Anda dapat menggunakan solusi siap produksi seperti: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Alat </th></tr></thead><tbody><tr><td>  Mungkin </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Testinfra</a> </td></tr><tr><td>  Koki </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Inspec</a> </td></tr><tr><td>  Koki </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Serverspec</a> </td></tr><tr><td>  tumpukan garam </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Goss</a> </td></tr></tbody></table></div><br><p>  Mari kita lihat testinfra, saya ingin memeriksa bahwa pengguna <code>test1</code> , <code>test2</code> ada dan mereka adalah bagian dari kelompok <code>sshusers</code> : </p><br><pre> <code class="plaintext hljs">def test_default_users(host): users = ['test1', 'test2' ] for login in users: assert host.user(login).exists assert 'sshusers' in host.user(login).groups</code> </pre> <br><p>  Apa solusi terbaik?  Tidak ada jawaban tunggal untuk pertanyaan itu, namun, saya membuat peta panas dan membandingkan perubahan dalam proyek ini selama 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/aj/vm/0w/ajvm0wr0cno5a0kchi0z-jwyyxy.png"></p><br><h4 id="iac-testing-frameworks">  Kerangka Pengujian IaC </h4><br><p>  Setelah itu, Anda bisa menghadapi pertanyaan bagaimana menjalankannya bersama?  Di satu sisi, Anda dapat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">melakukan semuanya sendiri</a> jika Anda memiliki cukup insinyur hebat, tetapi di sisi lain, Anda dapat menggunakan solusi siap-pakai opensource: </p><br><div class="scrollable-table"><table><thead><tr><th>  CFM </th><th>  Alat </th></tr></thead><tbody><tr><td>  Mungkin </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Molekul</a> </td></tr><tr><td>  Koki </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dapur uji</a> </td></tr><tr><td>  Bentuk Terra </td><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Terratest</a> </td></tr></tbody></table></div><br><p>  Saya membuat peta panas dan membandingkan perubahan dalam proyek ini selama 2018-2019: </p><br><p><img src="https://habrastorage.org/webt/bj/lb/02/bjlb02mi6tympyzdjjxef3_8bhq.png"></p><br><h4 id="molecule-vs-testkitchen">  Molekul vs  Testkitchen </h4><br><p><img src="https://habrastorage.org/webt/vx/2e/dt/vx2edtvvuquxyw-4yf81zmk6s9c.png"></p><br><p>  Pada awalnya, kami mencoba <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menguji peran yang mungkin melalui testkitchen di dalam hyper-v</a> : </p><br><ol><li>  Buat VM. </li><li>  Terapkan peran yang Mungkin. </li><li>  Jalankan Inspec. </li></ol><br><p>  Butuh 40-70 menit untuk 25-35 Peran yang mungkin.  Itu terlalu lama bagi kami. </p><br><p><img src="https://habrastorage.org/webt/i-/9j/cl/i-9jclmr4x36ag1e8ppzk_d-_b0.png"></p><br><p>  Langkah selanjutnya adalah menggunakan Jenkins / docker / Ansible / molekul.  Itu kira-kira ide yang sama: </p><br><ol><li>  Buku pedoman Lint Ansible. </li><li>  Lint peran yang mungkin. </li><li>  Jalankan wadah buruh pelabuhan. </li><li>  Terapkan peran yang Mungkin. </li><li>  Jalankan testinfra. </li><li>  Periksa idempotensi. </li></ol><br><p><img src="https://habrastorage.org/webt/zz/je/kf/zzjekf-i8wckzdeslzlrbkmmxhg.png"></p><br><p>  Mengintip untuk 40 peran dan menguji sepuluh dari mereka membutuhkan waktu sekitar 15 menit. </p><br><p><img src="https://habrastorage.org/webt/pn/6p/qe/pn6pqelxwb7dbaapkefv80ccxra.png"></p><br><p>  Apa solusi terbaik?  Di satu sisi, saya tidak ingin menjadi otoritas terakhir, tetapi di sisi lain, saya ingin berbagi pandangan saya.  Tidak ada peluru perak yang ada, namun, jika molekul Ansible adalah solusi yang lebih cocok maka uji dapur. </p><br><h3 id="iac-testing-integration-tests">  Pengujian IaC: Tes Integrasi </h3><br><p><img src="https://habrastorage.org/webt/yt/jf/br/ytjfbruwxfanxl15sxcfyg_gz1g.png"></p><br><p>  Pada tingkat berikutnya <em>piramida uji IaC</em> , ada <em>tes integrasi</em> .  Tes integrasi untuk infrastruktur terlihat seperti tes unit: </p><br><ol><li>  Pisahkan infrastruktur menjadi modul / istirahat sederhana, mis. Peran yang dimungkinkan. </li><li>  Buat lingkungan yaitu Docker atau VM. </li><li>  Terapkan <em>kombinasi</em> istirahat sederhana / modul ke lingkungan. </li><li>  Periksa apakah semuanya baik-baik saja atau tidak. <br>  ... </li><li>  KEUNTUNGAN! </li></ol><br><p>  Dengan kata lain, selama pengujian unit, kami memeriksa satu modul sederhana (yaitu peran yang mungkin, skrip python, modul yang mungkin, dll) dari suatu infrastruktur, tetapi dalam kasus pengujian integrasi, kami memeriksa seluruh konfigurasi server. </p><br><h3 id="iac-testing-end-to-end-tests">  Pengujian IaC: Tes ujung ke ujung </h3><br><p><img src="https://habrastorage.org/webt/pn/98/jt/pn98jtnydc1wupw_jvifjjc9mpc.png"></p><br><p>  Di atas <em>piramida uji IaC</em> , ada <em>Tes ujung</em> ke <em>ujung</em> .  Dalam hal ini, kami tidak memeriksa server khusus, skrip, modul infrastruktur kami;  Kami memeriksa seluruh infrastruktur bekerja dengan baik.  Sayangnya, tidak ada solusi di luar kotak untuk itu atau saya belum pernah mendengar tentang mereka (tolong, tandai saya jika Anda tahu tentang mereka).  Biasanya, orang menemukan kembali roda, karena, ada permintaan dari ujung ke ujung tes untuk infrastruktur.  Jadi, saya ingin membagikan pengalaman saya, semoga bermanfaat bagi seseorang. </p><br><p><img src="https://habrastorage.org/webt/us/xz/rl/usxzrlzt8unudguhf9b89d83dfm.png"></p><br><p>  Pertama-tama, saya ingin menggambarkan konteksnya.  Ini adalah solusi di luar kotak perusahaan, mendukung database yang berbeda, server aplikasi dan antarmuka integrasi dengan sistem pihak ketiga.  Biasanya, klien kami adalah perusahaan besar dengan lingkungan yang sangat berbeda.  Kami memiliki pengetahuan tentang kombinasi lingkungan yang berbeda dan kami menyimpannya sebagai file pembuatan docker yang berbeda.  Juga, ada yang cocok antara file dan pengujian yang disusun oleh buruh pelabuhan, kami menyimpannya sebagai pekerjaan Jenkins. </p><br><p><img src="https://habrastorage.org/webt/an/l2/ev/anl2ev_lxlsnegrxpulghdw9jxw.png"></p><br><p>  Skema ini telah berfungsi dengan tenang saat periode log ketika selama <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penelitian openshift</a> kami mencoba untuk memigrasikannya ke dalam openshift.  Kami menggunakan wadah yang kira-kira sama (neraka KERING lagi) dan hanya mengubah lingkungan sekitarnya. </p><br><p><img src="https://habrastorage.org/webt/sh/sg/ud/shsgudbrhuqpazrpikcacxskzrm.png"></p><br><p>  Kami terus meneliti dan menemukan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">APB</a> (Ansible Playbook Bundle).  Ide utamanya adalah Anda mengemas semua barang yang dibutuhkan ke dalam wadah dan menjalankannya di dalam OpenShift.  Ini berarti bahwa Anda memiliki solusi yang dapat direproduksi dan dapat diuji. </p><br><p><img src="https://habrastorage.org/webt/l_/cw/ho/l_cwho8ftxhtnmuekhjlsfllctg.png"></p><br><p>  Semuanya baik-baik saja sampai kami menghadapi satu masalah lagi: kami harus memelihara infrastruktur yang heterogen untuk lingkungan pengujian.  Sebagai hasilnya, kami menyimpan pengetahuan kami tentang cara membuat infrastruktur dan menjalankan tes di pekerjaan Jenkins. </p><br><h1 id="conclusion">  Kesimpulan </h1><br><p><img src="https://habrastorage.org/webt/j2/pp/6q/j2pp6qs2f6qjrz5pn35wuzd0luk.png"><br>  Infrastruktur sebagai Kode itu adalah kombinasi dari: </p><br><ul><li>  Kode </li><li>  Interaksi orang. </li><li>  Pengujian infrastruktur. </li></ul><br><div class="spoiler">  <b class="spoiler_title">tautan</b> <div class="spoiler_text"><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ini lintas pos dari blog pribadi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Versi Rusia</a> </li><li>  Lari kering 2019-04-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SpbLUG</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Video (RU) dari DevopsConf 2019-05-28</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Video (RU) dari DINS DevOps EVENING 2019-06-20</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pelajaran dari Menulis Lebih Dari 300.000 Baris Kode Infrastruktur</a> &amp; <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">versi teks</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mengintegrasikan Infrastruktur sebagai Kode ke dalam Pipa Pengiriman Kontinu</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Menguji infrastruktur sebagai kode</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Pengembangan dan pemeliharaan yang efektif untuk peran yang memungkinkan</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kemungkinan bukan bash untuk Anda!</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Idempoten yang memungkinkan</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id467169/">https://habr.com/ru/post/id467169/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id467153/index.html">Bekerja dengan keberatan: analisis statis akan mengambil bagian dari waktu kerja</a></li>
<li><a href="../id467155/index.html">Praktik Terbaik untuk Kontainer Kubernet: Pemeriksaan Kesehatan</a></li>
<li><a href="../id467161/index.html">Aplikasi web di Kotlin + Spring Boot + Vue.js</a></li>
<li><a href="../id467163/index.html">Cara bermigrasi ke cloud dalam dua jam berkat Kubernetes dan otomatisasi</a></li>
<li><a href="../id467165/index.html">Mengikuti jejak gerakan Scala Rusia. Bagian 2</a></li>
<li><a href="../id467171/index.html">Apa yang saya pelajari dengan menguji 200.000 baris kode infrastruktur</a></li>
<li><a href="../id467173/index.html">Arsitek implementasi ERP yang aman</a></li>
<li><a href="../id467175/index.html">Berpikir dua kali sebelum menggunakan mesin gim</a></li>
<li><a href="../id467177/index.html">Tips Pemasaran Tarantino: Apa yang Dimainkan Kaki Peran dan Mengapa Membuat Uma Thurman Soap</a></li>
<li><a href="../id467179/index.html">Samsung Compiler Bootcamp: mengajarkan untuk membuat "program pemrograman"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>