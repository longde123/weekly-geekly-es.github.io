<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¥ üè¥ üìá Como otimizamos nosso Hospital Tem√°tico para diferentes plataformas ü§ôüèº üìÆ üòá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Project Hospital √© um jogo sobre o gerenciamento de um edif√≠cio hospitalar com todos os aspectos padr√£o do g√™nero: cenas din√¢micas criadas pelo joga...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como otimizamos nosso Hospital Tem√°tico para diferentes plataformas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459256/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d81/165/b28/d81165b28ad475a63a06e9d674be2bd7.png" alt="imagem"></div><br>  O Project Hospital √© um jogo sobre o gerenciamento de um edif√≠cio hospitalar com todos os aspectos padr√£o do g√™nero: cenas din√¢micas criadas pelo jogador, muitos personagens e objetos ativos, implementados pelo sistema da interface do usu√°rio.  Para fazer o jogo funcionar em equipamentos diferentes, tivemos que fazer muitos esfor√ßos, e esse foi um √≥timo exemplo da infame ‚Äúmorte por mil cortes‚Äù - muitos pequenos passos que resolvem v√°rios problemas muito espec√≠ficos e muito tempo gasto em cria√ß√£o de perfis. <br><br><h2>  N√≠vel de desempenho: o que quer√≠amos alcan√ßar </h2><br>  Em um est√°gio inicial de desenvolvimento, decidimos os principais par√¢metros: o tamanho m√°ximo das cenas, o n√≠vel de desempenho e os requisitos do sistema. <br><br>  N√≥s nos propusemos a tarefa de fornecer suporte para pelo menos cem caracteres ativos e totalmente animados em uma tela, trezentos caracteres ativos no total, mapas de blocos medindo aproximadamente 100x100 e at√© quatro andares no edif√≠cio. <br><br>  Est√°vamos firmemente convencidos de que o jogo deveria funcionar em 1080p com uma taxa de quadros decente mesmo em placas gr√°ficas integradas, e por si s√≥ esse objetivo n√£o era t√£o dif√≠cil de alcan√ßar: o principal fator limitante √© a CPU, especialmente com um aumento no volume do hospital.  As placas gr√°ficas integradas modernas come√ßam a ter problemas apenas em resolu√ß√µes de aproximadamente 2560 x 1440. <br><br>  Para simplificar o suporte a mods, a maioria dos dados foi aberta, ou seja, tivemos que sacrificar o desempenho alcan√ßado ao compactar os arquivos, mas isso n√£o teve um impacto particularmente forte, exceto por um tempo de download um pouco mais longo. <br><a name="habracut"></a><br><h2>  Gr√°ficos </h2><br>  O Project Hospital √© um jogo 2D isom√©trico ‚Äúcl√°ssico‚Äù, para que voc√™ possa entender que tudo √© retrocedido para a frente - no Unity, isso √© feito definindo os valores apropriados ao longo do eixo Z (ou dist√¢ncia da c√¢mera) para objetos gr√°ficos individuais.  Se poss√≠vel, objetos que n√£o interagem entre si s√£o organizados em camadas, por exemplo, os pisos s√£o independentes de objetos e caracteres. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a5/951/079/8a59510793f4c7eb1be7b2dd206c1c17.png"></div><br>  Toda geometria em uma cena renderizada isometricamente √© criada dinamicamente em C #, portanto, um dos dois aspectos mais importantes para o desempenho gr√°fico √© a frequ√™ncia da reconstru√ß√£o da geometria.  O segundo aspecto √© o n√∫mero de chamadas de empate. <br><br><h2>  Desenhar chamadas </h2><br>  O n√∫mero de objetos individuais desenhados em um quadro, independentemente de sua simplicidade, √© a principal limita√ß√£o, especialmente em equipamentos ruins (al√©m disso, o pr√≥prio mecanismo do Unity adiciona um consumo excessivo de recursos).  A solu√ß√£o √≥bvia √© agrupar (lote) o maior n√∫mero poss√≠vel de objetos gr√°ficos em uma chamada de desenho.  Assim, voc√™ pode obter alguns resultados bastante interessantes, por exemplo, agrupar objetos que est√£o √† mesma dist√¢ncia da c√¢mera para que o restante dos gr√°ficos seja renderizado corretamente atr√°s ou na frente deles. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fde/96e/f3d/fde96ef3dd1e2f0f4b6972e8b947654b.png"></div><br>  Aqui est√£o alguns n√∫meros: em um bloco de 96 x 96, voc√™ pode, teoricamente, colocar 9216 objetos, o que exigiria 9216 chamadas de desenho.  Ap√≥s o lote, esse n√∫mero cai para 192. <br><br>  No entanto, na vida real, tudo √© um pouco mais complicado, porque voc√™ s√≥ pode agrupar objetos com a mesma textura, o que torna os resultados um pouco menos ideais, mas o sistema ainda funciona muito bem. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/93d/306/134/93d3061341005108c6638c2ad67f17bd.png"></div><br>  A maioria dos lotes √© feita manualmente para ter controle sobre os resultados.  Al√©m disso, como √∫ltimo recurso, tamb√©m usamos lotes din√¢micos do Unity, mas essa √© uma faca de dois gumes - na verdade, ajuda a reduzir o n√∫mero de chamadas de empate, mas gera recursos desnecess√°rios em cada quadro e, em alguns casos, pode ser imprevis√≠vel.  Por exemplo, dois sprites sobrepostos √† mesma dist√¢ncia da c√¢mera em quadros diferentes podem ser renderizados em uma ordem diferente, o que causa oscila√ß√µes que n√£o aparecem quando o lote √© manualmente. <br><br><h2>  V√°rios andares </h2><br>  Os jogadores podem construir edif√≠cios com v√°rios andares, e isso aumenta a complexidade, mas, surpreendentemente, ajuda no desempenho.  Somente personagens no andar ativo e na rua precisam ser renderizados e animados, e tudo nos outros andares do hospital pode ser oculto. <br><br><h2>  Shaders </h2><br>  O Project Hospital usa shaders auto-escritos relativamente simples, com pequenos truques, como a troca de cores.  Suponha que um sombreador de caracteres possa substituir at√© cinco cores (dependendo das condi√ß√µes no c√≥digo do sombreador) e, portanto, bastante caro, mas isso n√£o parece causar problemas, porque os caracteres raramente ocupam muito espa√ßo na tela.  O shader justificou o esfor√ßo, porque a capacidade de usar um n√∫mero infinito de cores de roupas pode aumentar bastante a variabilidade dos personagens e do ambiente. <br><br>  Al√©m disso, aprendemos com rapidez suficiente para evitar a especifica√ß√£o de par√¢metros do shader e, em vez disso, usamos cores de v√©rtice sempre que poss√≠vel. <br><br><h2>  Qualidade da textura </h2><br>  Um fato interessante - no Project Hospital, n√£o usamos compress√£o de textura: os gr√°ficos s√£o feitos em estilo vetorial e, em algumas texturas, a compress√£o parece muito ruim. <br><br>  Para economizar mem√≥ria da CPU em sistemas com menos de 1 GB, reduzimos automaticamente o tamanho das texturas no jogo para meia resolu√ß√£o (exceto as texturas da interface do usu√°rio) - isso pode ser entendido ao se ver o par√¢metro "qualidade da textura: baixo" nas op√ß√µes.  As texturas da interface do usu√°rio mant√™m sua resolu√ß√£o original. <br><br><h2>  Otimize o desempenho da CPU - Multithreading </h2><br>  Embora a l√≥gica de script do Unity seja essencialmente de thread √∫nico, sempre temos a capacidade de executar v√°rios threads diretamente em C #.  Talvez essa abordagem n√£o seja adequada para a l√≥gica do jogo, mas geralmente existem tarefas com tempo cr√≠tico que podem ser executadas em threads separados, organizando um sistema de tarefas.  No nosso caso, os threads foram usados ‚Äã‚Äãpara duas fun√ß√µes: <br><br>  1. A tarefa de encontrar um caminho, especialmente em mapas grandes com um arranjo confuso, pode levar at√© centenas de milissegundos, portanto esse foi o principal candidato √† transfer√™ncia do fluxo principal.  Tarefas paralelas levam em considera√ß√£o o n√∫mero de threads de hardware de uma m√°quina. <br><br>  2. Os cart√µes de ilumina√ß√£o tamb√©m podem ser atualizados em um fluxo separado, mas apenas um andar de cada vez - esse n√£o √© um sistema cr√≠tico, e as l√¢mpadas autom√°ticas nas salas se apagam a uma velocidade que uma atualiza√ß√£o rara √© suficiente. <br><br><h2>  Anima√ß√µes </h2><br>  Quase no in√≠cio do desenvolvimento, decidimos usar um sistema de anima√ß√£o esquel√©tica bidimensional.  Tendo estudado v√°rios programas modernos de anima√ß√£o, finalmente decidimos modificar um sistema simples que eu criei h√° v√°rios anos (essencialmente como um projeto de hobby), adaptando-o √†s necessidades do Project Hospital - ele se assemelha a uma coluna simplificada com suporte direto para criar varia√ß√µes de caracteres.  Como o Spine, ele usa o tempo de execu√ß√£o C #, que √© obviamente mais caro que o c√≥digo nativo, portanto, durante o processo de desenvolvimento, realizamos alguns ciclos de otimiza√ß√£o.  Felizmente, nossas plataformas s√£o bastante simples, apenas cerca de 20 ossos por personagem. <br><br>  Um fato curioso: a melhoria mais √∫til na otimiza√ß√£o do acesso √† transforma√ß√£o de ossos individuais acabou sendo a transi√ß√£o da pesquisa de mapa para a simples indexa√ß√£o de matrizes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/462/f1e/440/462f1e440f6dbc3f7e77f4ff42986966.png"></div><br>  Al√©m do fato de os personagens n√£o serem animados fora da c√¢mera, h√° outro truque: os personagens escondidos atr√°s das janelas da interface principal tamb√©m n√£o precisam ser animados.  Infelizmente, na vers√£o final do jogo, mudamos para uma interface transl√∫cida, por isso n√£o pudemos us√°-la. <br><br><h2>  Armazenamento em cache </h2><br>  Se poss√≠vel, tentamos realizar os c√°lculos mais caros apenas com altera√ß√µes que afetam seus valores.  O melhor exemplo disso s√£o salas e elevadores: quando um jogador coloca um elevador ou constr√≥i paredes, executamos um algoritmo de preenchimento que marca os ladrilhos a partir dos quais elevadores e salas est√£o dispon√≠veis.  Isso acelera a busca subseq√ºente por caminhos e pode ser usado para mostrar ao jogador quais salas ainda n√£o est√£o dispon√≠veis. <br><br><h2>  Atualiza√ß√µes dispersas e adiadas </h2><br>  Em alguns casos, √© l√≥gico executar determinadas atualiza√ß√µes apenas parcialmente.  Aqui est√£o alguns exemplos: <br><br>  Algumas atualiza√ß√µes podem ser executadas em cada quadro apenas para parte dos personagens, por exemplo, os scripts de comportamento de metade dos pacientes s√£o atualizados apenas em quadros √≠mpares e para a segunda metade - em quadros pares (embora anima√ß√µes e movimentos sejam realizados sem problemas). <br><br>  Em certas condi√ß√µes, especialmente quando os caracteres est√£o no modo de espera, mas chamam partes caras do c√≥digo (por exemplo, funcion√°rios verificando o que precisa ser preenchido e procurando equipamentos desocupados), as opera√ß√µes s√£o executadas apenas em determinados intervalos, por exemplo, uma vez por segundo. <br><br>  Um dos desafios mais caros e ao mesmo tempo comuns √© verificar quais testes est√£o dispon√≠veis para cada paciente.  Ao mesmo tempo, muitos fatores precisam ser avaliados - por exemplo, qual dos funcion√°rios do departamento est√° atualmente ocupado e qual equipamento est√° reservado.  Al√©m disso, essas informa√ß√µes n√£o s√£o comuns a todos os pacientes porque s√£o afetadas, por exemplo, pelo m√©dico designado a eles e por sua capacidade de falar.  √â necess√°rio verificar dezenas de tipos de an√°lises dispon√≠veis; portanto, em um quadro, a atualiza√ß√£o √© realizada apenas para alguns e continua no seguinte. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/014/1a6/e24/0141a6e2458e7edb58a0d96072faab8e.png"></div><br><h2>  Conclus√£o </h2><br>  A otimiza√ß√£o de um gerenciador de jogos com muitas partes interagentes provou ser um processo demorado.  Eu regularmente tinha que trabalhar com o criador de perfil do Unity e corrigir os problemas mais √≥bvios, isso se tornou parte integrante do processo de desenvolvimento. <br><br>  Obviamente, sempre h√° espa√ßo para melhorias, mas estamos bastante satisfeitos com os resultados.  O jogo lida com nossas tarefas, e os jogadores constantemente criam mods para ele, excedendo significativamente o limite original do n√∫mero de personagens. <br><br>  Tamb√©m vale mencionar que, mesmo em compara√ß√£o com alguns jogos AAA em que trabalhei, no Project Hospital encontrei a l√≥gica de jogo mais complexa em minha pr√°tica, portanto muitos dos problemas eram espec√≠ficos para esse projeto.  No entanto, ainda recomendo deixar tempo suficiente em qualquer projeto para otimiza√ß√£o de acordo com a complexidade do jogo. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt459256/">https://habr.com/ru/post/pt459256/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt459246/index.html">Por que a convers√£o do site est√° diminuindo? Exemplos de 60 erros de design e usabilidade</a></li>
<li><a href="../pt459248/index.html">Eventos digitais em Moscou, de 9 a 14 de julho</a></li>
<li><a href="../pt459250/index.html">WAL no PostgreSQL: 2. Log de pr√©-registro</a></li>
<li><a href="../pt459252/index.html">Semana 28 de Seguran√ßa: invadindo uma casa inteligente</a></li>
<li><a href="../pt459254/index.html">Bomba zip ainda melhor</a></li>
<li><a href="../pt459258/index.html">14.000 milhas n√£o gancho</a></li>
<li><a href="../pt459262/index.html">Aposentado aos 22</a></li>
<li><a href="../pt459264/index.html">Saindo das redes Tarantool. Sincroniza√ß√£o de n√≥ ao filtrar o tr√°fego</a></li>
<li><a href="../pt459272/index.html">Escrevendo uma API para componentes React, parte 1: n√£o crie objetos conflitantes</a></li>
<li><a href="../pt459274/index.html">Vulnerabilidade de bloqueio de tela no Astra Linux Special Edition (Smolensk)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>