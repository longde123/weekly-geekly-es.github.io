<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëö üéß üç∑ Tornando menor o tratamento de exce√ß√µes em C ++ em x64 üöÑ üîú üçê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O Visual Studio 2019 Preview 3 apresenta um novo recurso para reduzir o tamanho bin√°rio do tratamento de exce√ß√µes em C ++ (tentativa / captura e destr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tornando menor o tratamento de exce√ß√µes em C ++ em x64</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/microsoft/blog/442996/"><img width="140" align="left" src="https://habrastorage.org/webt/gq/ke/xi/gqkexi_dekwffzpjqtx04zp7ee8.png"><p>  O Visual Studio 2019 Preview 3 apresenta um novo recurso para reduzir o tamanho bin√°rio do tratamento de exce√ß√µes em C ++ (tentativa / captura e destruidores autom√°ticos) no x64.  Apelidado de FH4 (para __CxxFrameHandler4, veja abaixo), desenvolvi nova formata√ß√£o e processamento de dados usados ‚Äã‚Äãpara tratamento de exce√ß√µes em C ++ aproximadamente <strong>60%</strong> menores que a implementa√ß√£o existente, resultando em redu√ß√£o bin√°ria geral de at√© <strong>20%</strong> para programas com uso intenso de C ++ manipula√ß√£o de exce√ß√£o. </p><br>  Este artigo no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blog</a> . <a name="habracut"></a><br><br><h2>  Como fa√ßo para ativar isso? </h2><br><p>  No momento, <strong>o</strong> FH4 est√° <strong>desativado por padr√£o,</strong> porque as altera√ß√µes de tempo de execu√ß√£o necess√°rias para os aplicativos da Loja n√£o puderam entrar na vers√£o atual.  Para ativar o FH4 ‚Äã‚Äãpara aplicativos que n√£o sejam da loja, passe o sinalizador n√£o documentado ‚Äú/ d2FH4‚Äù para o compilador MSVC no Visual Studio 2019 Preview 3 e al√©m. </p><br><p>  Planejamos ativar o FH4 ‚Äã‚Äãpor padr√£o depois que o tempo de execu√ß√£o da loja for atualizado.  Esperamos fazer isso no Visual Studio 2019 Update 1 e atualizaremos este post que sabemos mais. </p><br><h2>  Mudan√ßas nas ferramentas </h2><br><p>  Qualquer instala√ß√£o do Visual Studio 2019 Preview 3 e posterior ter√° as altera√ß√µes no compilador e no tempo de execu√ß√£o do C ++ para dar suporte ao FH4.  As altera√ß√µes do compilador existem internamente sob o sinalizador "/ d2FH4" mencionado acima.  O tempo de execu√ß√£o do C ++ possui uma nova DLL chamada vcruntime140_1.dll que √© instalada automaticamente pelo VCRedist.  Isso √© necess√°rio para expor o novo manipulador de exce√ß√µes __CxxFrameHandler4 que substitui a rotina __CxxFrameHandler3 mais antiga.  O link est√°tico e a implanta√ß√£o local do aplicativo do novo tempo de execu√ß√£o C ++ tamb√©m s√£o suportados. </p><br><p>  Agora para as coisas divertidas!  O restante deste post abordar√° os resultados internos da avalia√ß√£o do FH4 ‚Äã‚Äãno Windows, Office e SQL, seguidos de detalhes t√©cnicos mais detalhados por tr√°s dessa nova tecnologia. </p><br><h2>  Motiva√ß√£o e resultados </h2><br><p>  H√° cerca de um ano, nossos parceiros no projeto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C ++ / WinR</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">T</a> chegaram √† equipe Microsoft C ++ com um desafio: quanto poder√≠amos reduzir o tamanho bin√°rio do tratamento de exce√ß√µes em C ++ para programas que o utilizavam intensamente? </p><br><p>  No contexto de um programa usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C ++ / WinRT</a> , eles apontaram para um componente do Windows Microsoft.UI.Xaml.dll que era conhecido por possuir uma grande √°rea bin√°ria devido ao tratamento de exce√ß√µes em C ++.  Confirmei que esse era realmente o caso e gerou a divis√£o do tamanho bin√°rio com o __CxxFrameHandler3 existente, mostrado abaixo.  As porcentagens no lado direito do gr√°fico s√£o <strong>porcentagens do tamanho bin√°rio total</strong> ocupado por tabelas de metadados espec√≠ficas e c√≥digo descrito. </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/350/cf5/402/350cf5402f932176e7c40f0af3f61161.png" alt="Divis√£o de tamanho do Microsoft.UI.Xaml.dll usando __CxxFrameHandler3" width="720" height="480"></a> </h2><br><p>  N√£o discutirei neste post o que as estruturas espec√≠ficas do lado direito do gr√°fico fazem (consulte a palestra de James McNellis sobre como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">desenrolamento de pilha funciona no Windows</a> para obter mais detalhes).  Observando os metadados e c√≥digos totais, no entanto, <strong>26,4%</strong> do tamanho bin√°rio foram usados ‚Äã‚Äãpelo tratamento de exce√ß√µes em C ++.  Essa √© uma quantidade enorme de espa√ßo e estava dificultando a ado√ß√£o do C ++ / WinRT. </p><br><p>  Fizemos altera√ß√µes no passado para reduzir o tamanho do tratamento de exce√ß√µes em C ++ no compilador sem alterar o tempo de execu√ß√£o.  Isso inclui descartar metadados para regi√µes de c√≥digo que n√£o podem lan√ßar e dobrar estados logicamente id√™nticos.  No entanto, est√°vamos chegando ao fim do que poder√≠amos fazer apenas no compilador e n√£o conseguir√≠amos causar um impacto significativo em algo t√£o grande.  A an√°lise mostrou que havia vit√≥rias significativas, mas exigiam altera√ß√µes fundamentais nos dados, c√≥digo e tempo de execu√ß√£o.  Ent√£o fomos em frente e fizemos. </p><br><p>  Com o novo __CxxFrameHandler4 e seus metadados, a divis√£o do tamanho do Microsoft.UI.XAML.dll agora √© a seguinte: </p><br><h2> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e1d/a71/041/e1da71041bf442276ae15eb605a21e6a.png" alt="Divis√£o de tamanho do Microsoft.UI.Xaml.dll usando __CxxFrameHandler4" width="720" height="481"></a> </h2><br><p>  O tamanho bin√°rio usado pelo tratamento de exce√ß√µes em C ++ cai em <strong>64%,</strong> levando a uma redu√ß√£o geral do tamanho bin√°rio de <strong>18,6%</strong> nesse bin√°rio.  Todo tipo de estrutura diminuiu de tamanho em graus surpreendentes: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Eh data</strong> </td><td>  <strong>Tamanho __CxxFrameHandler3 (bytes)</strong> </td><td>  <strong>Tamanho __CxxFrameHandler4 (bytes)</strong> </td><td>  <strong>% De redu√ß√£o de tamanho</strong> </td></tr><tr><td>  Entradas Pdata </td><td>  147.864 </td><td>  118.260 </td><td>  20,0% </td></tr><tr><td>  Desenrolar c√≥digos </td><td>  224.284 </td><td>  92.810 </td><td>  58,6% </td></tr><tr><td>  Informa√ß√µes da fun√ß√£o </td><td>  255.440 </td><td>  27.755 </td><td>  89,1% </td></tr><tr><td>  Mapas do IP2State </td><td>  186.944 </td><td>  45.098 </td><td>  75,9% </td></tr><tr><td>  Descontrair mapas </td><td>  80.952 </td><td>  69.757 </td><td>  13,8% </td></tr><tr><td>  Mapas do manipulador de captura </td><td>  52.060 </td><td>  6.147 </td><td>  88,2% </td></tr><tr><td>  Experimente mapas </td><td>  51.960 </td><td>  5.196 </td><td>  90,0% </td></tr><tr><td>  Funclets Dtor </td><td>  54.570 </td><td>  45.739 </td><td>  16,2% </td></tr><tr><td>  Catch funclets </td><td>  102.400 </td><td> 4,301 </td><td>  95,8% </td></tr><tr><td>  Total </td><td>  <strong>1.156.474</strong> </td><td>  <strong>415.063</strong> </td><td>  <strong>64,1%</strong> </td></tr></tbody></table><p>  Em conjunto, a mudan√ßa para __CxxFrameHandler4 reduziu o tamanho geral do Microsoft.UI.Xaml.dll de 4,4 MB para 3,6 MB. </p><br><p>  A avalia√ß√£o do FH4 ‚Äã‚Äãem um conjunto representativo de bin√°rios do Office mostra uma redu√ß√£o de tamanho de ~ 10% nas DLLs que usam muito as exce√ß√µes.  Mesmo no Word e no Excel, projetados para minimizar o uso de exce√ß√µes, ainda h√° uma redu√ß√£o significativa no tamanho bin√°rio. </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Bin√°rio</strong> </td><td>  <strong>Tamanho antigo (MB)</strong> </td><td>  <strong>Novo tamanho (MB)</strong> </td><td>  <strong>% De redu√ß√£o de tamanho</strong> </td><td>  <strong>Descri√ß√£o do produto</strong> </td></tr><tr><td>  chart.dll </td><td>  17,27 </td><td>  15.10 </td><td>  12,6% </td><td>  Suporte para interagir com tabelas e gr√°ficos </td></tr><tr><td>  Csi.dll </td><td>  9,78 </td><td>  8.66 </td><td>  11,4% </td><td>  Suporte para trabalhar com arquivos armazenados na nuvem </td></tr><tr><td>  Mso20Win32Client.dll </td><td>  6.07 </td><td>  5,41 </td><td>  11,0% </td><td>  C√≥digo comum compartilhado entre todos os aplicativos do Office </td></tr><tr><td>  Mso30Win32Client.dll </td><td>  8,11 </td><td>  7,30 </td><td>  9,9% </td><td>  C√≥digo comum compartilhado entre todos os aplicativos do Office </td></tr><tr><td>  oart.dll </td><td>  18,21 </td><td>  16,20 </td><td>  11,0% </td><td>  Recursos gr√°ficos compartilhados entre aplicativos do Office </td></tr><tr><td>  wwlib.dll </td><td>  42,15 </td><td>  41.12 </td><td>  2,5% </td><td>  O principal bin√°rio do Microsoft Word </td></tr><tr><td>  excel.exe </td><td>  52,86 </td><td>  50,29 </td><td>  4,9% </td><td>  O principal bin√°rio do Microsoft Excel </td></tr></tbody></table><p>  A avalia√ß√£o do FH4 ‚Äã‚Äãnos bin√°rios principais do SQL mostra uma redu√ß√£o de 4-21% no tamanho, principalmente da compacta√ß√£o de metadados descrita na pr√≥xima se√ß√£o: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  <strong>Bin√°rio</strong> </td><td>  <strong>Tamanho antigo (MB)</strong> </td><td>  <strong>Novo tamanho (MB)</strong> </td><td>  <strong>% De redu√ß√£o de tamanho</strong> </td><td>  <strong>Descri√ß√£o do produto</strong> </td></tr><tr><td>  sqllang.dll </td><td>  47.12 </td><td>  44,33 </td><td>  5,9% </td><td>  Servi√ßos de n√≠vel superior: analisador de idiomas, fich√°rio, otimizador e mecanismo de execu√ß√£o </td></tr><tr><td>  sqlmin.dll </td><td>  48,17 </td><td>  45,83 </td><td>  4,8% </td><td>  Servi√ßos de baixo n√≠vel: transa√ß√µes e mecanismo de armazenamento </td></tr><tr><td>  qds.dll </td><td>  1,42 </td><td>  1,33 </td><td>  6,3% </td><td>  Funcionalidade de armazenamento de consulta </td></tr><tr><td>  SqlDK.dll </td><td>  3,19 </td><td>  3.05 </td><td>  4,4% </td><td>  Abstra√ß√µes do SQL OS: mem√≥ria, threads, agendamento, etc. </td></tr><tr><td>  autoadmin.dll </td><td>  1,77 </td><td>  1,64 </td><td>  7,3% </td><td>  L√≥gica do orientador de ajuste do banco de dados </td></tr><tr><td>  xedetours.dll </td><td>  0,45 </td><td>  0,36 </td><td>  21,6% </td><td>  Gravador de dados de voo para consultas </td></tr></tbody></table><h2>  A tecnologia </h2><br><p>  Ao analisar o que fez com que a exce√ß√£o do C ++ manipulasse os dados fosse t√£o grande no Microsoft.UI.Xaml.dll, encontrei dois culpados principais: </p><br><ol><li>  As estruturas de dados s√£o grandes: as tabelas de metadados eram de tamanho fixo, com campos de deslocamentos relativos √† imagem e n√∫meros inteiros com quatro bytes de comprimento.  Uma fun√ß√£o com uma √∫nica tentativa / captura e um ou dois destruidores autom√°ticos tinham mais de 100 bytes de metadados. </li><li>  As estruturas de dados e o c√≥digo gerado n√£o eram pass√≠veis de mesclagem.  As tabelas de metadados continham deslocamentos relativos √† imagem que impediam o dobramento COMDAT (o processo em que o vinculador pode dobrar peda√ßos de dados id√™nticos para economizar espa√ßo), a menos que as fun√ß√µes que eles representavam sejam id√™nticas.  Al√©m disso, os funclets de captura (c√≥digo descrito nos blocos de captura do programa) n√£o podiam ser dobrados, mesmo se fossem id√™nticos ao c√≥digo, porque seus metadados est√£o contidos nos pais. </li></ol><br><p>  Para resolver esses problemas, o FH4 ‚Äã‚Äãreestrutura os metadados e o c√≥digo de forma que: </p><br><ol><li>  Os valores de tamanho fixo anteriores foram compactados usando uma codifica√ß√£o de n√∫mero inteiro de comprimento vari√°vel que reduz&gt; 90% dos campos de metadados de quatro bytes para um.  As tabelas de metadados agora tamb√©m t√™m comprimento vari√°vel com um cabe√ßalho para indicar se determinados campos est√£o presentes para economizar espa√ßo na emiss√£o de campos vazios. </li><li>  Todos os deslocamentos relativos √† imagem que podem ser relativos √† fun√ß√£o foram feitos relativos √† fun√ß√£o.  Isso permite dobrar COMDAT entre metadados de diferentes fun√ß√µes com caracter√≠sticas semelhantes (instancia√ß√µes do modelo de pensamento) e permite que esses valores sejam compactados.  Os funclets de captura foram reprojetados para deixar de ter seus metadados armazenados nos pais, de modo que agora os funclets de captura id√™nticos ao c√≥digo podem ser dobrados em uma √∫nica c√≥pia no bin√°rio. </li></ol><br><p>  Para ilustrar isso, vejamos a defini√ß√£o original da tabela de metadados de informa√ß√µes da fun√ß√£o usada para __CxxFrameHandler3.  Esta √© a tabela inicial para o tempo de execu√ß√£o ao processar o EH e aponta para as outras tabelas de metadados.  Esse c√≥digo est√° dispon√≠vel publicamente em qualquer instala√ß√£o do VS, procure &lt;caminho da instala√ß√£o do VS&gt; \ VC \ Tools \ MSVC \ &lt;vers√£o&gt; \ include \ ehdata.h: </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s_FuncInfo</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> magicNumber:<span class="hljs-number"><span class="hljs-number">29</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Identifies version of compiler unsigned int bbtFlags:3; // flags that may be set by BBT processing __ehstate_t maxState; // Highest state number plus one (thus // number of entries in unwind map) int dispUnwindMap; // Image relative offset of the unwind map unsigned int nTryBlocks; // Number of 'try' blocks in this function int dispTryBlockMap; // Image relative offset of the handler map unsigned int nIPMapEntries; // # entries in the IP-to-state map. NYI (reserved) int dispIPtoStateMap; // Image relative offset of the IP to state map int dispUwindHelp; // Displacement of unwind helpers from base int dispESTypeList; // Image relative list of types for exception specifications int EHFlags; // Flags for some features. } FuncInfo;</span></span></code> </pre> <br><p>  Essa estrutura √© de tamanho fixo, contendo 10 campos a cada 4 bytes.  Isso significa que todas as fun√ß√µes que precisam de tratamento de exce√ß√£o C ++, por padr√£o, incorrem em 40 bytes de metadados. </p><br><p>  Agora, para a nova estrutura de dados (&lt;caminho de instala√ß√£o do VS&gt; \ VC \ Tools \ MSVC \ &lt;vers√£o&gt; \ include \ ehdata4_export.h): </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FuncInfoHeader</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> isCatch : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-comment"><span class="hljs-comment">// 1 if this represents a catch funclet, 0 otherwise uint8_t isSeparated : 1; // 1 if this function has separated code segments, 0 otherwise uint8_t BBT : 1; // Flags set by Basic Block Transformations uint8_t UnwindMap : 1; // Existence of Unwind Map RVA uint8_t TryBlockMap : 1; // Existence of Try Block Map RVA uint8_t EHs : 1; // EHs flag set uint8_t NoExcept : 1; // NoExcept flag set uint8_t reserved : 1; }; uint8_t value; }; }; struct FuncInfo4 { FuncInfoHeader header; uint32_t bbtFlags; // flags that may be set by BBT processing int32_t dispUnwindMap; // Image relative offset of the unwind map int32_t dispTryBlockMap; // Image relative offset of the handler map int32_t dispIPtoStateMap; // Image relative offset of the IP to state map uint32_t dispFrame; // displacement of address of function frame wrt establisher frame, only used for catch funclets };</span></span></code> </pre> <br><p>  Observe que: </p><br><ol><li>  O n√∫mero m√°gico foi removido, emitindo 0x19930522 toda vez que se torna um problema quando um programa possui milhares dessas entradas. </li><li>  O EHFlags foi movido para o cabe√ßalho enquanto dispESTypeList foi eliminado devido ao suporte abandonado das especifica√ß√µes de exce√ß√£o din√¢mica no C ++ 17.  O compilador usar√° como padr√£o o __CxxFrameHandler3 mais antigo se especifica√ß√µes de exce√ß√£o din√¢mica forem usadas. </li><li>  Os comprimentos das outras tabelas n√£o s√£o mais armazenados em "Informa√ß√µes da Fun√ß√£o 4".  Isso permite que a dobragem COMDAT dobre mais tabelas apontadas, mesmo que a tabela ‚ÄúFunction Info 4‚Äù n√£o possa ser dobrada. </li><li>  (N√£o mostrado explicitamente) Os campos dispFrame e bbtFlags agora s√£o n√∫meros inteiros de comprimento vari√°vel.  A representa√ß√£o de alto n√≠vel o deixa como um uint32_t para facilitar o processamento. </li><li>  bbtFlags, dispUnwindMap, dispTryBlockMap e dispFrame podem ser omitidos, dependendo dos campos definidos no cabe√ßalho. </li></ol><br><p>  Levando tudo isso em considera√ß√£o, o tamanho m√©dio da nova estrutura ‚ÄúFunction Info 4‚Äù agora √© de 13 bytes (cabe√ßalho de 1 byte + tr√™s deslocamentos relativos da imagem de 4 bytes em rela√ß√£o a outras tabelas) que podem ser reduzidos ainda mais se algumas tabelas n√£o forem necess√°rias.  Os tamanhos das tabelas foram removidos, mas agora esses valores s√£o compactados e 90% deles no Microsoft.UI.Xaml.dll foram encontrados para caber em um √∫nico byte.  Juntando tudo isso, isso significa que o tamanho m√©dio para representar os mesmos dados funcionais no novo manipulador √© de 16 bytes em compara√ß√£o com os 40 bytes anteriores - uma melhoria bastante dram√°tica! </p><br><p>  Para dobrar, vejamos o n√∫mero de tabelas e funclets exclusivos com o manipulador antigo e novo: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td>  Eh data </td><td>  Contagem em __CxxFrameHandler3 </td><td>  Contagem em __CxxFrameHandler4 </td><td>  % De redu√ß√£o </td></tr><tr><td>  Entradas Pdata </td><td>  12.322 </td><td>  9.855 </td><td>  20,0% </td></tr><tr><td>  Informa√ß√µes da fun√ß√£o </td><td>  6.386 </td><td>  2.747 </td><td>  57,0% </td></tr><tr><td>  Entradas do Mapa IP2State </td><td>  6.363 </td><td>  2.148 </td><td>  66,2% </td></tr><tr><td>  Descontrair entradas do mapa </td><td>  1.487 </td><td>  1.464 </td><td>  1,5% </td></tr><tr><td>  Mapas do manipulador de captura </td><td>  2.603 </td><td>  601 </td><td>  76,9% </td></tr><tr><td>  Experimente mapas </td><td>  2.598 </td><td>  648 </td><td>  75,1% </td></tr><tr><td>  Funclets Dtor </td><td>  2,301 </td><td>  1.527 </td><td>  33,6% </td></tr><tr><td>  Catch funclets </td><td>  2.603 </td><td>  84 </td><td>  <strong><em>96,8%</em></strong> </td></tr><tr><td>  Total </td><td>  <strong>36.663</strong> </td><td>  <strong>19.074</strong> </td><td>  <strong>48,0%</strong> </td></tr></tbody></table><p>  O n√∫mero de entradas de dados EH exclusivas diminui em <strong>48%</strong> ao criar oportunidades adicionais de dobragem, removendo RVAs e redesenhando os funclets de captura.  Quero especificamente chamar o n√∫mero de funclets de captura em it√°lico em verde: ele cai de 2.603 para apenas 84. Isso √© uma consequ√™ncia da convers√£o de HRESULTs em C ++ / WinRT para exce√ß√µes de C ++, que gera muitos funclets de captura id√™nticos ao c√≥digo que agora podem ser dobrado.  Certamente, uma queda dessa magnitude est√° no alto n√≠vel dos resultados, mas demonstra o potencial de economia de tamanho que a dobragem pode alcan√ßar quando as estruturas de dados s√£o projetadas com isso em mente. </p><br><h2>  Desempenho </h2><br><p>  Com o design introduzindo a compacta√ß√£o e modificando a execu√ß√£o do tempo de execu√ß√£o, houve a preocupa√ß√£o de causar impacto no desempenho do tratamento de exce√ß√µes.  O impacto, no entanto, √© <strong>positivo</strong> : o desempenho do tratamento de exce√ß√µes <strong>melhora</strong> com __CxxFrameHandler4 em oposi√ß√£o a __CxxFrameHandler3.  Testei o rendimento usando um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">programa de</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">benchmark</a> que se desdobra em 100 quadros de pilha, cada um com um try / catch e 3 objetos autom√°ticos para destruir.  Isso foi executado 50.000 vezes para perfilar o tempo de execu√ß√£o, levando a tempos gerais de execu√ß√£o de: </p><table border="2" cellspacing="10" cellpadding="5"><tbody><tr><td></td><td>  <strong>__CxxFrameHandler3</strong> </td><td>  <strong>__CxxFrameHandler4</strong> </td></tr><tr><td>  <strong>Tempo de execu√ß√£o</strong> </td><td>  4.84s </td><td>  4.25s </td></tr></tbody></table><p>  A cria√ß√£o de perfil mostrou que a descompacta√ß√£o introduz tempo de processamento adicional, mas seu custo √© superado por menos lojas para armazenar armazenamento local no novo design de tempo de execu√ß√£o. </p><br><h2>  Planos futuros </h2><br><p>  Conforme mencionado no t√≠tulo, o FH4 ‚Äã‚Äãatualmente est√° ativado apenas para bin√°rios x64.  No entanto, as t√©cnicas descritas s√£o extens√≠veis para ARM32 / ARM64 e, em menor grau, x86.  No momento, estamos procurando bons exemplos (como Microsoft.UI.Xaml.dll) para motivar a extens√£o dessa tecnologia para outras plataformas - se voc√™ acha que tem um bom caso de uso, avise-nos! </p><br><p>  O processo de integra√ß√£o das altera√ß√µes de tempo de execu√ß√£o dos aplicativos da loja para suportar o FH4 ‚Äã‚Äãest√° em andamento.  Feito isso, o novo manipulador ser√° ativado por padr√£o para que todos possam obter essas economias de tamanho bin√°rio sem nenhum esfor√ßo adicional. </p><br><h2>  Considera√ß√µes finais </h2><br><p>  Para quem acha que seus bin√°rios x64 poderiam reduzir um pouco: experimente o FH4 ‚Äã‚Äã(via '/ d2FH4') hoje!  Estamos empolgados em ver que economia isso pode proporcionar agora que esse recurso est√° dispon√≠vel.  Obviamente, se voc√™ encontrar algum problema, informe-nos nos coment√°rios abaixo, por e-mail ( <a href="">visualcpp@microsoft.com</a> ) ou atrav√©s da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Comunidade do desenvolvedor</a> .  Voc√™ tamb√©m pode encontrar-nos no Twitter ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@VisualC</a> ). </p><br><p>  Agradecemos a Kenny Kerr por nos direcionar para Microsoft.UI.Xaml.dll, Ravi Pinjala por reunir os n√∫meros no Office e Robert Roessler por testar isso no SQL. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442996/">https://habr.com/ru/post/pt442996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442984/index.html">Altera√ß√£o da fonte de alimenta√ß√£o do computador IBM 5150 modelo A 230 V</a></li>
<li><a href="../pt442986/index.html">Piloto Autopilot: Estrat√©gia de Implementa√ß√£o</a></li>
<li><a href="../pt442988/index.html">M√°quina virtual DIY</a></li>
<li><a href="../pt442992/index.html">Calculadora do Windows agora de c√≥digo aberto</a></li>
<li><a href="../pt442994/index.html">An√∫ncio da fonte aberta de calculadora do Windows</a></li>
<li><a href="../pt442998/index.html">An√°lise por baixo do tapete: uma revis√£o de 18 anos novos</a></li>
<li><a href="../pt443000/index.html">Uma atualiza√ß√£o para vers√µes de C # e ferramentas de C #</a></li>
<li><a href="../pt443002/index.html">O estado atual da ci√™ncia da consci√™ncia</a></li>
<li><a href="../pt443004/index.html">Minha namorada e o primeiro videogame. Desenvolvimento da unidade. Parte 1</a></li>
<li><a href="../pt443006/index.html">Lan√ßamento do Grafana v6 - novos recursos de uma ferramenta de visualiza√ß√£o aberta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>