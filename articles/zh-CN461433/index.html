<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤˜ğŸ¾ ğŸ· ğŸ¤ åœ¨Net Core 3.0ä¸­ä½¿ç”¨Identity Server 4 ğŸ¤³ğŸ½ ğŸ‘¨ğŸ½â€âœˆï¸ ğŸ‘ƒğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¼•è¨€ 


 æˆ‘æ‰€æ”¯æŒçš„é¡¹ç›®ä¹‹ä¸€æœ€è¿‘é¢ä¸´çš„ä»»åŠ¡æ˜¯åˆ†æåœ¨éœ€è¦é‡æ„å’Œç´¯ç§¯å¤§é‡æŠ€æœ¯å€ºåŠ¡çš„æƒ…å†µä¸‹ä».NET Framework 4.5è¿ç§»åˆ°.Net Coreçš„å¯èƒ½æ€§ã€‚ è¯¥é€‰æ‹©è½åœ¨äº†ç›®æ ‡å¹³å°.NET Core 3.0ä¸Šï¼Œå› ä¸ºæ ¹æ®Microsoftçš„å¼€å‘äººå‘˜çš„è¯´æ³•ï¼Œéšç€ç‰ˆæœ¬3.0çš„å‘å¸ƒï¼Œè¿ç§»é—ç•™ä»£ç çš„å¿…è¦æ­¥éª¤...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>åœ¨Net Core 3.0ä¸­ä½¿ç”¨Identity Server 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461433/"><h2 id="vvedenie"> å¼•è¨€ </h2><br><p> æˆ‘æ‰€æ”¯æŒçš„é¡¹ç›®ä¹‹ä¸€æœ€è¿‘é¢ä¸´çš„ä»»åŠ¡æ˜¯åˆ†æåœ¨éœ€è¦é‡æ„å’Œç´¯ç§¯å¤§é‡æŠ€æœ¯å€ºåŠ¡çš„æƒ…å†µä¸‹ä».NET Framework 4.5è¿ç§»åˆ°.Net Coreçš„å¯èƒ½æ€§ã€‚ è¯¥é€‰æ‹©è½åœ¨äº†ç›®æ ‡å¹³å°.NET Core 3.0ä¸Šï¼Œå› ä¸ºæ ¹æ®Microsoftçš„å¼€å‘äººå‘˜çš„è¯´æ³•ï¼Œéšç€ç‰ˆæœ¬3.0çš„å‘å¸ƒï¼Œè¿ç§»é—ç•™ä»£ç çš„å¿…è¦æ­¥éª¤å°†å‡å°‘æ•°å€ã€‚ å°¤å…¶æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">.Net Coreçš„</a> EntityFramework 6.3çš„é€€å‡ºè®¡åˆ’å¸å¼•äº†æˆ‘ä»¬ï¼Œå³ å¯ä»¥å°†å¤§å¤šæ•°åŸºäºEF 6.2çš„ä»£ç â€œæŒ‰åŸæ ·â€ç•™åœ¨ç½‘ç»œæ ¸å¿ƒä¸Šçš„å·²è¿ç§»é¡¹ç›®ä¸­ã€‚ </p><br><p> ä»æ•°æ®çº§åˆ«çœ‹ï¼Œä¼¼ä¹å·²ç»å¾ˆæ¸…æ¥šäº†ï¼Œä½†æ˜¯ï¼Œä»£ç ç§»æ¤çš„å¦ä¸€ä¸ªé‡è¦éƒ¨åˆ†æ˜¯å®‰å…¨çº§åˆ«ï¼Œä¸å¹¸çš„æ˜¯ï¼Œåœ¨å¿«é€Ÿå®¡æ ¸ä¹‹åï¼Œæ‚¨å°†ä¸å¾—ä¸å‡ ä¹å®Œå…¨å°†å…¶ä¸¢å¼ƒå¹¶ä»å¤´å¼€å§‹é‡å†™å®ƒã€‚ å¹¸è¿çš„æ˜¯ï¼Œè¯¥é¡¹ç›®å·²ç»ä»¥å­˜å‚¨ç”¨æˆ·å’Œé™„åŠ åœ¨ä¾§é¢çš„å…¶ä»–â€œè‡ªè¡Œè½¦â€çš„å½¢å¼ä½¿ç”¨äº†ASP NET Identityçš„ä¸€éƒ¨åˆ†ã€‚ </p><br><p> è¿™å°±æå‡ºäº†ä¸€ä¸ªé€»è¾‘é—®é¢˜ï¼šå¦‚æœå®‰å…¨æ€§éƒ¨åˆ†å¿…é¡»è¿›è¡Œå¤§é‡æ›´æ”¹ï¼Œä¸ºä»€ä¹ˆä¸ç«‹å³å®æ–½ä»¥è¡Œä¸šæ ‡å‡†å½¢å¼æ¨èçš„æ–¹æ³•ï¼Œå³ï¼šä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IdentityServer4</a>æ¡†æ¶ä½¿åº”ç”¨ç¨‹åºä½¿ç”¨Open Id connectå’ŒOAuthã€‚ </p><a name="habracut"></a><br><h2 id="problemy-i-puti-resheniya"> é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ </h2><br><p> å› æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ï¼šAngularä¸­æœ‰ä¸€ä¸ªJavaScriptåº”ç”¨ç¨‹åºï¼ˆIS4æœ¯è¯­ä¸ºClientï¼‰ï¼Œå®ƒä½¿ç”¨äº†WebAPIçš„æŸäº›å­é›†ï¼ˆèµ„æºï¼‰ï¼Œè¿˜æœ‰ä¸€ä¸ªè¿‡æ—¶çš„ASP NET Identityæ•°æ®åº“ï¼Œå…¶ç”¨æˆ·ç™»å½•åå¿…é¡»åœ¨æ›´æ–°åé‡ç”¨ï¼ˆä»¥å…å¯åŠ¨å…¶ä»–æ‰€æœ‰äººï¼‰æ—¶é—´ï¼‰ï¼Œå†åŠ ä¸Šåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæœ‰å¿…è¦æä¾›é€šè¿‡IdentityServer4ä¸€ä¾§çš„Windowsèº«ä»½éªŒè¯ç™»å½•ç³»ç»Ÿçš„æœºä¼šã€‚ å³ æœ‰æ—¶ï¼Œç”¨æˆ·ä¼šé€šè¿‡ActiveDirectoryåŸŸä¸­çš„å±€åŸŸç½‘å·¥ä½œã€‚ </p><br><p> è¿ç§»ç”¨æˆ·æ•°æ®çš„ä¸»è¦è§£å†³æ–¹æ¡ˆæ˜¯æ‰‹åŠ¨ï¼ˆæˆ–ä½¿ç”¨è‡ªåŠ¨å·¥å…·ï¼‰åœ¨æ–°æ—§çš„Identityæ•°æ®æ¶æ„ä¹‹é—´ç¼–å†™è¿ç§»è„šæœ¬ã€‚ åè¿‡æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨è‡ªåŠ¨æ•°æ®æ¨¡å¼æ¯”è¾ƒåº”ç”¨ç¨‹åºå¹¶ç”Ÿæˆäº†ä¸€ä¸ªSQLè„šæœ¬ï¼Œæ ¹æ®Identityç‰ˆæœ¬ï¼Œç›®æ ‡è¿ç§»è„šæœ¬å°†åŒ…å«ä¸åŒçš„æ›´æ–°æŒ‡ä»¤ã€‚ è¿™é‡Œçš„ä¸»è¦ç›®çš„æ˜¯ä¸è¦å¿˜è®°åè°ƒEFMigrationsHistoryè¡¨ï¼ˆå¦‚æœä»¥å‰ä½¿ç”¨è¿‡EFï¼Œå¹¶ä¸”è®¡åˆ’åœ¨å°†æ¥è¿›è¡Œè§„åˆ’ï¼‰ï¼Œä¾‹å¦‚ï¼Œå°†IdentityUserå®ä½“æ‰©å±•åˆ°å…¶ä»–å­—æ®µã€‚ </p><br><p> ä½†æ˜¯ï¼Œä¸‹é¢å°†ä»‹ç»å¦‚ä½•æ­£ç¡®é…ç½®IdentityServer4å¹¶å°†å…¶ä¸Windowså¸æˆ·ä¸€èµ·é…ç½®ã€‚ </p><br><h2 id="plan-realizacii"> å®æ–½è®¡åˆ’ </h2><br><p> å‡ºäºNDAçš„åŸå› ï¼Œæˆ‘ä¸ä¼šæè¿°æˆ‘ä»¬å¦‚ä½•åœ¨é¡¹ç›®ä¸­å®ç°IS4ï¼Œä½†æ˜¯ï¼Œåœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºä¸€ä¸ªä»å¤´å¼€å§‹åˆ›å»ºçš„ç®€å•ASP.NET Coreç½‘ç«™ï¼Œæ‚¨éœ€è¦é‡‡å–å“ªäº›æ­¥éª¤æ‰èƒ½è·å¾—å®Œå…¨é…ç½®å¹¶æ­£å¸¸è¿è¡Œçš„åº”ç”¨ç¨‹åºå®ƒä½¿ç”¨IdentityServer4è¿›è¡Œæˆæƒå’Œèº«ä»½éªŒè¯ã€‚ <br> è¦å®ç°æ‰€éœ€çš„è¡Œä¸ºï¼Œæˆ‘ä»¬å¿…é¡»é‡‡å–ä»¥ä¸‹æ­¥éª¤ï¼š </p><br><ul><li> åˆ›å»ºä¸€ä¸ªç©ºçš„ASP.Net Coreé¡¹ç›®å¹¶é…ç½®ä¸ºä½¿ç”¨IdentityServer4ã€‚ </li><li> å°†å®¢æˆ·ç«¯æ·»åŠ ä¸ºAngularåº”ç”¨ç¨‹åºã€‚ </li><li> é€šè¿‡open-id-connect googleç™»å½• </li><li> æ·»åŠ Windowsèº«ä»½éªŒè¯é€‰é¡¹ </li></ul><br><p> ä¸ºäº†ç®€æ´èµ·è§ï¼Œæ‰€æœ‰ä¸‰ä¸ªç»„ä»¶ï¼ˆIdentityServerï¼ŒWebAPIï¼ŒAngularå®¢æˆ·ç«¯ï¼‰å°†ä½äºåŒä¸€é¡¹ç›®ä¸­ã€‚ å½“å°†access_tokenä¼ é€’åˆ°æµè§ˆå™¨ä¸­çš„åº”ç”¨ç¨‹åºç«¯ï¼Œç„¶åä¸WebAPIäº¤äº’æ—¶ï¼Œå°†åœ¨å®¢æˆ·ç«¯å’ŒIdentityServerä¹‹é—´é€‰æ‹©çš„äº¤äº’ç±»å‹ä¸ºGrantTypeï¼ˆéšå¼æµï¼‰ã€‚  <em>æ ¹æ®ASP.NET Coreå­˜å‚¨åº“ä¸­çš„æ›´æ”¹ï¼Œæ›´æ¥è¿‘å‘å¸ƒï¼Œéšå¼æµå°†ç”±æˆæƒä»£ç + PKCEä»£æ›¿ã€‚ï¼‰</em> </p><br><p> åœ¨åˆ›å»ºå’Œä¿®æ”¹åº”ç”¨ç¨‹åºçš„è¿‡ç¨‹ä¸­ï¼Œ.NET Coreå‘½ä»¤è¡Œç•Œé¢å°†è¢«å¹¿æ³›ä½¿ç”¨ï¼Œå¿…é¡»å°†å…¶å®‰è£…åœ¨ç³»ç»Ÿä¸Šå…·æœ‰æœ€æ–°ç‰ˆæœ¬çš„Preview Core 3.0çš„ä½ç½®ï¼ˆæ’°å†™æœ¬æ–‡æ—¶ä¸º3.0.100-preview7-012821ï¼‰ã€‚ </p><br><h2 id="sozdanie-i-konfigurirovanie-web-proekta"> åˆ›å»ºå’Œé…ç½®Webé¡¹ç›® </h2><br><p>  IdentityServerç‰ˆæœ¬4çš„å‘å¸ƒæ ‡å¿—ç€è¯¥æ¡†æ¶ä¸­UIçš„å®Œå…¨åˆ é™¤ã€‚ ç°åœ¨ï¼Œå¼€å‘äººå‘˜æ‹¥æœ‰è‡ªè¡Œç¡®å®šæˆæƒæœåŠ¡å™¨ä¸»ç•Œé¢çš„å…¨éƒ¨æƒåˆ©ã€‚ æœ‰å‡ ç§æ–¹æ³•ã€‚ æœ€å—æ¬¢è¿çš„æ–¹æ³•ä¹‹ä¸€æ˜¯ä½¿ç”¨QuickStart UIåŒ…ä¸­çš„UIï¼Œå¯ä»¥åœ¨<a href="">github</a>ä¸Šçš„å®˜æ–¹å­˜å‚¨åº“ä¸­æ‰¾åˆ°è¯¥UIã€‚ </p><br><p> å¦ä¸€ä¸ªåŒæ ·æ–¹ä¾¿çš„æ–¹æ³•æ˜¯ä¸ASP NET Core Identity UIé›†æˆï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¼€å‘äººå‘˜éœ€è¦åœ¨é¡¹ç›®ä¸­æ­£ç¡®é…ç½®ç›¸åº”çš„ä¸­é—´ä»¶ã€‚ ç¨åå°†æè¿°è¯¥æ–¹æ³•ã€‚ </p><br><p> è®©æˆ‘ä»¬ä»åˆ›å»ºä¸€ä¸ªç®€å•çš„Webé¡¹ç›®å¼€å§‹ï¼Œä¸ºæ­¤ï¼Œè¯·åœ¨å‘½ä»¤è¡Œä¸Šæ‰§è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š </p><br><pre><code class="plaintext hljs">dotnet new webapp -n IdentityServer4WebApp</code> </pre> <br><p> æ‰§è¡Œåï¼Œè¾“å‡ºå°†æ˜¯ä¸€ä¸ªWebåº”ç”¨ç¨‹åºæ¡†æ¶ï¼Œè¯¥æ¡†æ¶å°†é€æ¸è¾¾åˆ°æˆ‘ä»¬éœ€è¦çš„çŠ¶æ€ã€‚ åœ¨è¿™é‡Œï¼Œæ‚¨éœ€è¦ä¿ç•™ä¸€ç‚¹ï¼Œå³.Net Core 3.0 for Identityä½¿ç”¨é‡é‡è½»çš„MVCè€Œä¸æ˜¯è½»é‡çº§çš„RazorPagesã€‚ <br> ç°åœ¨ï¼Œæ‚¨éœ€è¦ä¸ºæˆ‘ä»¬çš„é¡¹ç›®æ·»åŠ IdentityServeræ”¯æŒã€‚ ä¸ºæ­¤ï¼Œè¯·å®‰è£…å¿…è¦çš„è½¯ä»¶åŒ…ï¼š </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.ApiAuthorization.IdentityServer -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore -v 3.0.0-preview7.19365.7 dotnet add package Microsoft.EntityFrameworkCore.Tools -v 3.0.0-preview7.19362.6 dotnet add package Microsoft.EntityFrameworkCore.Sqlite -v 3.0.0-preview7.19362.6</code> </pre> <br><p> é™¤äº†é“¾æ¥åˆ°æˆæƒæœåŠ¡å™¨è½¯ä»¶åŒ…ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜æ·»åŠ äº†å®ä½“æ¡†æ¶æ”¯æŒï¼Œç”¨äºåœ¨èº«ä»½ç”Ÿæ€ç³»ç»Ÿä¸­å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ã€‚ ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨SQLiteæ•°æ®åº“ã€‚ </p><br><p> è¦åˆå§‹åŒ–æ•°æ®åº“ï¼Œè¯·åˆ›å»ºç”¨æˆ·æ¨¡å‹å’Œæ•°æ®åº“ä¸Šä¸‹æ–‡ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å£°æ˜ä¸¤ä¸ªApplicationUserç±»ï¼Œå®ƒä»¬ç»§æ‰¿è‡ªModelsæ–‡ä»¶å¤¹ä¸­çš„<em>IdentityUser</em>å’Œ<em>ApplicationDbContext</em> ï¼Œå®ƒä»¬ç»§æ‰¿è‡ªï¼š <em>Dataæ–‡ä»¶å¤¹ä¸­çš„ApiAuthorizationDbContextã€‚</em> <br></p><p> æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦é…ç½®EntityFrameworkä¸Šä¸‹æ–‡çš„ä½¿ç”¨å¹¶åˆ›å»ºæ•°æ®åº“ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä¸Šä¸‹æ–‡å†™å…¥Startupç±»çš„<em>ConfigureServices</em>æ–¹æ³•ä¸­ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt;options.UseSqlite(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>))); services.AddRazorPages(); }</code> </pre> <br><p> å¹¶å°†è¿æ¥å­—ç¬¦ä¸²æ·»åŠ åˆ°<em>appsettings.json</em> </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"ConnectionStrings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DefaultConnection"</span></span>: <span class="hljs-string"><span class="hljs-string">"Data Source=data.db"</span></span> },</code> </pre><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥åˆ›å»ºåˆå§‹è¿ç§»å¹¶åˆå§‹åŒ–æ•°æ®åº“æ¶æ„ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¿…é¡»å®‰è£…ç”¨äºef coreçš„å·¥å…·ï¼ˆå¯¹äºæœ‰é—®é¢˜çš„é¢„è§ˆï¼Œéœ€è¦ç‰ˆæœ¬3.0.0-preview7.19362.6ï¼‰ã€‚ </p><br><pre> <code class="plaintext hljs">dotnet ef migrations add Init dotnet ef database update</code> </pre> <br><p> å¦‚æœä»¥ä¸Šæ‰€æœ‰æ­¥éª¤å‡å·²æ­£ç¡®å®Œæˆï¼Œåˆ™SQLiteæ•°æ®æ–‡ä»¶data.dbåº”å‡ºç°åœ¨æ‚¨çš„é¡¹ç›®ä¸­ã€‚ </p><br><p> åœ¨æ­¤é˜¶æ®µï¼Œæˆ‘ä»¬å¯ä»¥å®Œå…¨é…ç½®å’Œæµ‹è¯•ä½¿ç”¨Asp.Net Core Identityçš„æˆç†ŸåŠŸèƒ½ã€‚ ä¸ºæ­¤ï¼Œè¯·æ›´æ”¹<em>Startup</em>æ–¹æ³•<em>ã€‚</em>  <em>é…ç½®</em>å’Œ<em>Startup.ConfigureServices</em> ã€‚ </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddDefaultIdentity&lt;ApplicationUser&gt;() .AddEntityFrameworkStores&lt;ApplicationDbContext&gt;(); //Startup. Configure: app.UseAuthentication(); app.UseAuthorization(); app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); });</span></span></code> </pre> <br><p> é€šè¿‡è¿™äº›è¡Œï¼Œæˆ‘ä»¬å°†èº«ä»½éªŒè¯å’Œæˆæƒçš„å¯èƒ½æ€§åµŒå…¥äº†è¯·æ±‚å¤„ç†ç®¡é“ä¸­ã€‚ å¹¶ä¸ºIdentityæ·»åŠ é»˜è®¤ç”¨æˆ·ç•Œé¢ã€‚ <br> å®ƒä»…ç”¨äºä¿®å¤UIï¼Œå°†å…¶æ·»åŠ åˆ°Pages \ Sharedä¸€ä¸ªåä¸º<em>_LoginPartial.cshtml</em>å¹¶å…·æœ‰ä»¥ä¸‹å†…å®¹çš„æ–°Razorè§†å›¾ï¼š </p><br><pre> <code class="html hljs xml">@using IdentityServer4WebApp.Models @using Microsoft.AspNetCore.Identity @inject SignInManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> SignInManager @inject UserManager<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ApplicationUser</span></span></span><span class="hljs-tag">&gt;</span></span> UserManager <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav"</span></span></span><span class="hljs-tag">&gt;</span></span> @if (SignInManager.IsSignedIn(User)) { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Manage/Index"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Manage"</span></span></span><span class="hljs-tag">&gt;</span></span>Hello @User.Identity.Name!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"form-inline"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Logout"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-route-returnUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link btn btn-link text-dark"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } else { <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Register"</span></span></span><span class="hljs-tag">&gt;</span></span>Register<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Identity"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Account/Login"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> } <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p> ä¸Šé¢çš„æ¼”ç¤ºä»£ç åº”ä½¿ç”¨å¯¼èˆªé¢æ¿ä¸­çš„å†…ç½®ç”¨æˆ·æ§ä»¶ï¼ˆç™»å½•å’Œå¯†ç ï¼Œæ³¨å†Œç­‰ï¼‰å‘èº«ä»½ç•Œé¢åŒºåŸŸæ·»åŠ é“¾æ¥ã€‚ </p><br><p> ä¸ºäº†å®ç°æ–°èœå•é¡¹çš„å‘ˆç°ï¼Œæˆ‘ä»¬åªéœ€é€šè¿‡æ·»åŠ æ­¤å±€éƒ¨è§†å›¾çš„å‘ˆç°æ¥<em>ä¿®æ”¹_Layout.cshtml</em>æ–‡ä»¶ã€‚ </p><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow-1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Index"</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-area</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">asp-page</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/Privacy"</span></span></span><span class="hljs-tag">&gt;</span></span>Privacy<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">partial</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_LoginPartial"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">!â€“â€“â€“â€“</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p> ç°åœ¨è®©æˆ‘ä»¬å°è¯•è¿è¡Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºï¼Œç„¶åå•å‡»å¤´éƒ¨æ˜¾ç¤ºçš„é“¾æ¥ <br> èœå•ï¼Œç”¨æˆ·åº”è¯¥ä¼šçœ‹åˆ°ä¸€ä¸ªå¸¦æœ‰æ¬¢è¿å’Œè¦æ±‚çš„é¡µé¢ <br> è¾“å…¥ç™»å½•åå’Œå¯†ç ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥æ³¨å†Œå¹¶ç™»å½•-å…¨éƒ¨ <br> åº”è¯¥å·¥ä½œã€‚ </p><br><p><img src="https://habrastorage.org/webt/yl/a2/yl/yla2yln6zflkftldetnacko8trm.png"></p><br><p>  IdentityServer4å¼€å‘äººå‘˜åœ¨æ”¹è¿›ASP.NET Identityå’ŒæœåŠ¡å™¨æ¡†æ¶æœ¬èº«çš„é›†æˆæ–¹é¢åšå¾—éå¸¸å‡ºè‰²ã€‚ ä¸ºäº†å¢åŠ ä½¿ç”¨OAuth2ä»¤ç‰Œçš„åŠŸèƒ½ï¼Œæ‚¨éœ€è¦åœ¨ä»£ç ä¸­è¡¥å……ä¸€äº›æ–°çš„è¯´æ˜æ¥è¡¥å……æˆ‘ä»¬çš„é¡¹ç›®ã€‚ </p><br><p> åœ¨<em>Startup.ConfigureServices</em>æ–¹æ³•çš„å€’æ•°ç¬¬äºŒè¡Œä¸­<em>ï¼Œ</em>é€šè¿‡ASP.NET Core Identityæ·»åŠ IS4çº¦å®šçš„é…ç½®ï¼š </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;();</code> </pre> <br><p>  AddApiAuthorizationæ–¹æ³•ä¸»è¦é€šè¿‡appsettings.jsonæ–‡ä»¶æŒ‡ç¤ºæ¡†æ¶ä½¿ç”¨å—æ”¯æŒçš„ç‰¹å®šé…ç½®ã€‚ ç›®å‰ï¼Œå†…ç½®çš„IS4ç®¡ç†åŠŸèƒ½è¿˜ä¸å¤Ÿçµæ´»ï¼Œåº”å°†å…¶è§†ä¸ºæ„å»ºåº”ç”¨ç¨‹åºçš„èµ·ç‚¹ã€‚ æ— è®ºå¦‚ä½•ï¼Œéƒ½å¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•çš„é‡è½½ç‰ˆæœ¬ï¼Œå¹¶é€šè¿‡å›è°ƒæ›´è¯¦ç»†åœ°é…ç½®å‚æ•°ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è°ƒç”¨helperæ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†åº”ç”¨ç¨‹åºé…ç½®ä¸ºæ£€æŸ¥æ¡†æ¶å‘å‡ºçš„JWTä»¤ç‰Œã€‚ </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddIdentityServerJwt();</code> </pre> <br><p> æœ€åï¼Œåœ¨<em>Startup.Configure</em>æ–¹æ³•ä¸­<em>ï¼Œ</em>æ·»åŠ ç”¨äº <br> æä¾›å¼€æ”¾IDè¿æ¥ç«¯ç‚¹ </p><br><pre> <code class="cs hljs">app.UseAuthentication(); app.UseAuthorization(); app.UseIdentityServer();<span class="hljs-comment"><span class="hljs-comment">//&lt;-</span></span></code> </pre> <br><p> å¦‚ä¸Šæ‰€è¿°ï¼Œæ‰€ä½¿ç”¨çš„è¾…åŠ©æ–¹æ³•å°†è¯»å–ä»¥ä¸‹å†…å®¹ä¸­çš„é…ç½® <br> åº”ç”¨ç¨‹åºè®¾ç½®æ–‡ä»¶<em>appsettings.json</em> ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å…¶ä¸­æ·»åŠ ä¸€ä¸ªæ–° <br>  <em>IdentityServer</em>éƒ¨åˆ†ã€‚ </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Clients"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"TestIdentityAngular"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Profile"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServerSPA"</span></span> } } }</code> </pre> <br><p> åœ¨æœ¬èŠ‚ä¸­ï¼Œå°†ä½¿ç”¨åç§°TestIdentityAngularå®šä¹‰å®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å°†å…¶åˆ†é…ç»™å°†æ¥çš„æµè§ˆå™¨å®¢æˆ·ç«¯å’Œç‰¹å®šçš„é…ç½®æ–‡ä»¶ã€‚ </p><br><p> åº”ç”¨ç¨‹åºé…ç½®æ–‡ä»¶æ˜¯ä¸€ä¸ªæ–°çš„IdentityServeré…ç½®å·¥å…·ï¼Œå®ƒæä¾›äº†å‡ ä¸ªé¢„å®šä¹‰çš„é…ç½®ï¼Œå¹¶å…·æœ‰å®Œå–„æŸäº›å‚æ•°çš„èƒ½åŠ›ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨<em>IdentityServerSPA</em>æ¦‚è¦æ–‡ä»¶ï¼Œè¯¥æ¦‚è¦æ–‡ä»¶æ˜¯ä¸ºæµè§ˆå™¨å®¢æˆ·ç«¯å’Œæ¡†æ¶ä½äºåŒä¸€é¡¹ç›®ä¸­ä¸”å…·æœ‰ä»¥ä¸‹å‚æ•°çš„æƒ…å†µè€Œè®¾è®¡çš„ï¼š </p><br><ul><li>  redirect_urièµ„æºè®¾ç½®ä¸º<em>/ authentication / login-callback</em> ã€‚ </li><li> èµ„æºpost_logout_redirect_uriï¼Œè®¾ç½®ä¸º<em>/èº«ä»½éªŒè¯/æ³¨é”€å›è°ƒã€‚</em> </li><li> åŒºåŸŸé›†åŒ…æ‹¬æ¯ä¸ªåº”ç”¨ç¨‹åºAPIèµ„æºçš„openidï¼Œé…ç½®æ–‡ä»¶ã€‚ </li><li> ä¸€ç»„å…è®¸çš„OIDCå“åº”ç±»å‹-id_tokenä»¤ç‰Œ </li><li> å®¢æˆ·ç«¯çš„GrantType-éšå¼ </li></ul><br><p> å…¶ä»–å¯èƒ½çš„é…ç½®æ–‡ä»¶æ˜¯<em>SPA</em> ï¼ˆæ²¡æœ‰IS4çš„åº”ç”¨ç¨‹åºï¼‰ï¼Œ <em>IdentityServerJwt</em> ï¼ˆä¸IS4å…±äº«çš„<em>API</em> ï¼‰ï¼Œ <em>API</em> ï¼ˆç‹¬ç«‹çš„APIï¼‰ã€‚ </p><br><p> å¦å¤–ï¼Œè¯¥é…ç½®æ³¨å†Œèµ„æºï¼š </p><br><ul><li>  ApiResourcesï¼šä¸€ä¸ªåä¸º&lt;&lt; appname &gt;&gt; APIçš„APIèµ„æºï¼Œå…·æœ‰æ‰€æœ‰å®¢æˆ·ç«¯ï¼ˆ*ï¼‰çš„å±æ€§ã€‚ </li><li>  IdentityServerResourcesï¼š <em>IdentityResources.OpenIdï¼ˆï¼‰</em>å’Œ<em>IdentityResources.Profileï¼ˆï¼‰</em> </li></ul><br><p> å¦‚æ‚¨æ‰€çŸ¥ï¼ŒIdentityServerä½¿ç”¨è¯ä¹¦æ¥å¯¹ä»¤ç‰Œè¿›è¡Œç­¾åï¼Œå®ƒä»¬çš„å‚æ•°ä¹Ÿå¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ï¼Œå› æ­¤åœ¨æµ‹è¯•æ—¶æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <br>  x509æµ‹è¯•è¯ä¹¦ï¼Œä¸ºæ­¤ï¼Œæ‚¨éœ€è¦åœ¨<em>appsettings.Development.json</em>æ–‡ä»¶çš„â€œå¯†é’¥â€éƒ¨åˆ†ä¸­æŒ‡å®šå®ƒã€‚ </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"IdentityServer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Key"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"Development"</span></span> } }</code> </pre> <br><p> ç°åœ¨æˆ‘ä»¬å¯ä»¥è¯´å…è®¸æ‚¨ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">IdentityServer</a>çš„åç«¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å·²ç»å‡†å¤‡å°±ç»ª</a> ï¼Œæ‚¨å¯ä»¥å¼€å§‹å®ç°æµè§ˆå™¨åº”ç”¨ç¨‹åºäº†ã€‚ </p><br><h2 id="realizaciya-klienta-na-angular">  Angularå®¢æˆ·ç«¯å®æ–½ </h2><br><p> æˆ‘ä»¬åŸºäºæµè§ˆå™¨çš„SPAå°†åœ¨Angularå¹³å°ä¸Šç¼–å†™ã€‚ è¯¥åº”ç”¨ç¨‹åºå°†åŒ…å«ä¸¤ä¸ªé¡µé¢ï¼Œä¸€ä¸ªé¡µé¢ç”¨äºæœªç»æˆæƒçš„ç”¨æˆ·ï¼Œå¦ä¸€é¡µé¢ç”¨äºç»è¿‡èº«ä»½éªŒè¯çš„ç”¨æˆ·ã€‚ ç¤ºä¾‹ä½¿ç”¨ç‰ˆæœ¬8.1.2 </p><br><p> é¦–å…ˆï¼Œåˆ›å»ºæœªæ¥çš„æ¡†æ¶ï¼š </p><br><pre> <code class="plaintext hljs">ng new ClientApp</code> </pre> <br><p> åœ¨åˆ›å»ºè¿‡ç¨‹ä¸­ï¼Œæ‚¨éœ€è¦å¯¹ææ¡ˆå›ç­”â€œæ˜¯â€ä»¥ä½¿ç”¨è·¯ç”±ã€‚ å¹¶é€šè¿‡å¼•å¯¼ç¨‹åºåº“å¯¹é¡µé¢è¿›è¡Œä¸€äº›æ ·å¼åŒ–ï¼š </p><br><pre> <code class="plaintext hljs">cd ClientApp ng add bootstrap</code> </pre> <br><p> æ¥ä¸‹æ¥ï¼Œæ‚¨éœ€è¦å‘æˆ‘ä»¬çš„ä¸»åº”ç”¨ç¨‹åºæ·»åŠ SPAæ‰˜ç®¡æ”¯æŒã€‚ é¦–å…ˆï¼Œæ‚¨éœ€è¦ä¿®å¤csprojé¡¹ç›®-æ·»åŠ æœ‰å…³æˆ‘ä»¬çš„æµè§ˆå™¨åº”ç”¨ç¨‹åºçš„ä¿¡æ¯ã€‚ </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp3.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptCompileBlocked</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span>Latest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypeScriptToolsVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">IsPackable</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span>ClientApp\<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SpaRoot</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span>$(DefaultItemExcludes);$(SpaRoot)node_modules\**<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultItemExcludes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">BuildServerSideRenderer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> â€¦ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Content</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Remove</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">None</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)**"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Exclude</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)node_modules\**"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DebugEnsureNodeEnv"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BeforeTargets</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Build"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" '$(Configuration)' == 'Debug' And !Exists('$(SpaRoot)node_modules') "</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"node --version"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ContinueOnError</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Output</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TaskParameter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ExitCode"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">PropertyName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ErrorCode"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Error</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Condition</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"'$(ErrorCode)' != '0'"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Node.js is required to build and run this project. To continue, please install Node.js from https://nodejs.org/, and then restart your command prompt or IDE."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Importance</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"high"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Restoring dependencies using 'npm'. This may take several minutes..."</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Exec</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">WorkingDirectory</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$(SpaRoot)"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Command</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"npm install"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Target</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><p> ä¹‹åï¼Œå®‰è£…ç‰¹æ®Šçš„nugetè½¯ä»¶åŒ…ä»¥æ”¯æŒæµè§ˆå™¨åº”ç”¨ç¨‹åºã€‚ </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.SpaServices.Extensions -v 3.0.0-preview7.19365.7</code> </pre> <br><p> æˆ‘ä»¬ä½¿ç”¨å…¶è¾…åŠ©æ–¹æ³•ï¼š </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup. ConfigureServices: services.AddSpaStaticFiles(configuration =&gt; { configuration.RootPath = "ClientApp/dist"; }); //Startup. Configure: app.UseSpa(spa =&gt; { spa.Options.SourcePath = "ClientApp"; if (env.IsDevelopment()) { spa.UseAngularCliServer(npmScript: "start"); } });</span></span></code> </pre><br><p> é™¤äº†è°ƒç”¨æ–°æ–¹æ³•å¤–ï¼Œè¿˜å¿…é¡»åˆ é™¤Razor <em>Index.chtml</em>å’Œ<em>_ViewStart.chtmlé¡µé¢ï¼Œ</em>ä»¥ä¾¿SPAæœåŠ¡ç°åœ¨å¯ä»¥æä¾›å†…å®¹ã€‚ </p><br><p> å¦‚æœæŒ‰ç…§è¯´æ˜è¿›è¡Œäº†æ‰€æœ‰æ“ä½œï¼Œåˆ™åœ¨åº”ç”¨ç¨‹åºå¯åŠ¨æ—¶ï¼Œé»˜è®¤é¡µé¢å°†å‡ºç°åœ¨å±å¹•ä¸Šã€‚ </p><br><p><img src="https://habrastorage.org/webt/mv/lv/j6/mvlvj6_2aqcutz9t0_9eozhoxk8.png"></p><br><p> ç°åœ¨æ‚¨éœ€è¦é…ç½®è·¯ç”±ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å…¶æ·»åŠ åˆ°é¡¹ç›®2ä¸­ <br> ç»„æˆéƒ¨åˆ†ï¼š </p><br><pre> <code class="plaintext hljs">ng generate component Home -t=true -s=true --skipTests=true ng generate component Data -t=true -s=true --skipTests=true</code> </pre> <br><p> æˆ‘ä»¬å°†å®ƒä»¬å†™åœ¨è·¯ç”±è¡¨ä¸­ï¼š </p><br><pre> <code class="plaintext hljs">const routes: Routes = [ { path: '', component: HomeComponent, pathMatch: 'full' }, { path: 'data', component: DataComponent } ];</code> </pre> <br><p> ç„¶åï¼Œæˆ‘ä»¬ä¿®æ”¹app.component.htmlæ–‡ä»¶ä»¥æ­£ç¡®æ˜¾ç¤ºèœå•é¡¹ã€‚ </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'navbar navbar-expand-sm navbar-toggleable-sm navbar-light bg-white border-bottom box-shadow mb-3'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"container"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-brand"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Client App<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-collapse collapse d-sm-inline-flex flex-sm-row-reverse"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ngClass</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{"show": isExpanded}'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"navbar-nav flex-grow"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActiveOptions</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'{ exact: true }'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Home<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/data"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Web api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">nav</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align:center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> Welcome to {{ title }}! <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"router-outlet"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">router-outlet</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p> åœ¨æ­¤æ­¥éª¤ä¸­ï¼Œæ‚¨å¯ä»¥å®Œæˆç”¨äºé€šè¿‡IdentityServerå‘è¡Œçš„ä»¤ç‰Œå®ç°äº¤äº’çš„åº”ç”¨ç¨‹åºæ¡†æ¶çš„åŸºæœ¬å‡†å¤‡ã€‚ </p><br><p> å‡†å¤‡SPAæ¡†æ¶çš„å½“å‰é˜¶æ®µå¯ä»¥ç§°ä¸ºå®Œæˆï¼Œç°åœ¨æˆ‘ä»¬åº”è¯¥å¼€å§‹ä½¿ç”¨OpenID Connectå’ŒOAuthåè®®æ¥å®ç°è´Ÿè´£ä¸æœåŠ¡å™¨éƒ¨åˆ†è¿›è¡Œäº¤äº’çš„æ¨¡å—ã€‚ å¹¸è¿çš„æ˜¯ï¼ŒMicrosoftçš„å¼€å‘äººå‘˜å·²ç»å®ç°äº†æ­¤ç±»ä»£ç ï¼Œç°åœ¨æ‚¨å¯ä»¥ç®€å•åœ°ä»ä»–ä»¬é‚£é‡Œå€Ÿç”¨æ­¤æ¨¡å—ã€‚ ç”±äºæˆ‘çš„æ–‡ç« æ˜¯åŸºäºASP.NET Core 3.0é¢„å‘å¸ƒç‰ˆæœ¬7ç¼–å†™çš„ï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨<a href="">github</a>ä¸Šçš„å‘å¸ƒæ ‡ç­¾â€œ v3.0.0-preview7.19365.7â€è·å–æ‰€æœ‰ä»£ç ã€‚ </p><br><p> åœ¨å¯¼å…¥ä»£ç ä¹‹å‰ï¼Œæ‚¨å¿…é¡»å®‰è£…<em>oidc-client</em>åº“ï¼Œè¯¥åº“ <br> æä¾›äº†è®¸å¤šç”¨äºæµè§ˆå™¨åº”ç”¨ç¨‹åºçš„ç•Œé¢ï¼Œä»¥åŠ <br> æ”¯æŒç”¨æˆ·ä¼šè¯å’Œè®¿é—®ä»¤ç‰Œçš„ç®¡ç†ã€‚ å¯¹äº <br> è¦å¼€å§‹ä½¿ç”¨å®ƒï¼Œæ‚¨éœ€è¦å®‰è£…é€‚å½“çš„è½¯ä»¶åŒ…ã€‚ </p><br><pre> <code class="plaintext hljs">npm install oidc-client@1.8.0</code> </pre> <br><p> ç°åœ¨ï¼Œåœ¨æˆ‘ä»¬çš„SPAä¸­ï¼Œæœ‰å¿…è¦å®ç°ä¸€ä¸ªæ¨¡å—ï¼Œè¯¥æ¨¡å—æ ¹æ®æ‰€éœ€åè®®å°è£…å®Œæ•´çš„äº¤äº’ã€‚ ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦ä»ä¸Šé¢çš„ASP.NET Coreå­˜å‚¨åº“æ ‡ç­¾ä¸­æå–æ•´ä¸ªApiAuthorizationModuleæ¨¡å—ï¼Œå¹¶å°†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…¶æ‰€æœ‰æ–‡ä»¶</a>æ·»åŠ åˆ°åº”ç”¨ç¨‹åºä¸­ã€‚ </p><br><p> æ­¤å¤–ï¼Œæ‚¨å¿…é¡»å°†å…¶å¯¼å…¥AppModuleåº”ç”¨ç¨‹åºçš„ä¸»æ¨¡å—ä¸­ï¼š </p><br><pre> <code class="plaintext hljs">@NgModule({ declarations: [ AppComponent, HomeComponent, DataComponent ], imports: [ BrowserModule, HttpClientModule, ApiAuthorizationModule,//&lt;- AppRoutingModule ], providers: [], bootstrap: [AppComponent] }) export class AppModule { }</code> </pre> <br><p> è¦åœ¨å¯¼å…¥çš„æ¨¡å—ä¸­æ˜¾ç¤ºæ–°èœå•é¡¹ï¼Œæœ‰ä¸€ä¸ª<em>app-login-menu</em>ç»„ä»¶ï¼Œ <br> å¯ä»¥å®Œå…¨æ›´æ”¹ä»¥é€‚åº”æ‚¨çš„éœ€æ±‚å¹¶æ·»åŠ  <br> åœ¨<em>app.component.htmlè§†å›¾</em>çš„å¯¼èˆªéƒ¨åˆ†ä¸­çš„<em>é“¾æ¥</em> ã€‚ </p><br><p> ç”¨äºé…ç½®SPAå®¢æˆ·ç«¯çš„OpenIDè¿æ¥çš„APIæˆæƒæ¨¡å—å¿…é¡»åœ¨åº”ç”¨ç¨‹åºåç«¯ä¸­ä½¿ç”¨ç‰¹æ®Šçš„ç«¯ç‚¹ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å…¶è¿›è¡Œå®ç° <br> å¿…é¡»éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š </p><br><ol><li> æ ¹æ®æˆ‘ä»¬åœ¨IdentityServerï¼šClientséƒ¨åˆ†çš„é…ç½®æ–‡ä»¶appsettings.jsonä¸­è®¾ç½®çš„å†…å®¹æ¥æ›´æ­£å®¢æˆ·ç«¯IDï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸ºTestIdentityAngularï¼Œå®ƒå†™å…¥api-authorization.constants.tså¸¸é‡é›†çš„ç¬¬ä¸€è¡Œã€‚ </li><li> æ·»åŠ ä¸€ä¸ªOidcConfigurationControlleræ§åˆ¶å™¨ï¼Œå®ƒå°†ç›´æ¥å°†é…ç½®è¿”å›ç»™æµè§ˆå™¨åº”ç”¨ç¨‹åº </li></ol><br><p> åˆ›å»ºçš„æ§åˆ¶å™¨çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">ApiController</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OidcConfigurationController</span></span>: <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IClientRequestParametersProvider _clientRequestParametersProvider; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OidcConfigurationController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IClientRequestParametersProvider clientRequestParametersProvider</span></span></span><span class="hljs-function">)</span></span> { _clientRequestParametersProvider = clientRequestParametersProvider; } [HttpGet(<span class="hljs-string"><span class="hljs-string">"_configuration/{clientId}"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetClientRequestParameters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[FromRoute]</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> clientId</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> parameters = _clientRequestParametersProvider.GetClientParameters(HttpContext, clientId); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(parameters); } }</code> </pre> <br><p> æ‚¨è¿˜éœ€è¦ä¸ºåç«¯åº”ç”¨ç¨‹åºé…ç½®ç‚¹APIæ”¯æŒã€‚ </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Startup.ConfigureServices: services.AddControllers();//&lt;-  services.AddRazorPages(); //Startup. Configure: app.UseEndpoints(endpoints =&gt; { endpoints.MapRazorPages(); endpoints.MapControllers(); });</span></span></code> </pre><br><p> ç°åœ¨è¯¥å¯åŠ¨åº”ç”¨ç¨‹åºäº†ã€‚ é¡¶éƒ¨èœå•çš„ä¸»é¡µä¸Šåº”æ˜¾ç¤ºä¸¤ä¸ªé¡¹ç›®ï¼šâ€œ <em>ç™»å½•â€</em>å’Œâ€œ <em>æ³¨å†Œâ€</em> ã€‚ åŒæ ·ï¼Œåœ¨å¯åŠ¨æ—¶ï¼Œå¯¼å…¥çš„æˆæƒæ¨¡å—å°†å‘æœåŠ¡å™¨ç«¯è¯·æ±‚å®¢æˆ·ç«¯é…ç½®ï¼Œéšåå°†åœ¨åè®®ä¸­å°†å…¶è€ƒè™‘åœ¨å†…ã€‚ é…ç½®è¾“å‡ºç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"authority"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"client_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"TestIdentityAngular"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/login-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"post_logout_redirect_uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://localhost:44367/authentication/logout-callback"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"response_type"</span></span>: <span class="hljs-string"><span class="hljs-string">"id_token token"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scope"</span></span>: <span class="hljs-string"><span class="hljs-string">"IdentityServer4WebAppAPI openid profile"</span></span> }</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼Œå®¢æˆ·ç«¯åœ¨äº¤äº’è¿‡ç¨‹ä¸­æœŸæœ›æ¥æ”¶åˆ°idä»¤ç‰Œå’Œè®¿é—®ä»¤ç‰Œï¼Œå¹¶ä¸”è¿˜é’ˆå¯¹æˆ‘ä»¬APIçš„è®¿é—®åŒºåŸŸè¿›è¡Œäº†é…ç½®ã€‚ </p><br><p> ç°åœ¨ï¼Œå¦‚æœæˆ‘ä»¬é€‰æ‹©â€œ <em>ç™»å½•â€</em>èœå•é¡¹ï¼Œåˆ™åº”è¯¥å°†æˆ‘ä»¬é‡å®šå‘åˆ°IdentityServer4çš„é¡µé¢ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬å¯ä»¥è¾“å…¥ç™»å½•åå’Œå¯†ç ï¼Œå¦‚æœæ­£ç¡®ï¼Œæˆ‘ä»¬å°†ç«‹å³è¢«è½¬ç§»å›æµè§ˆå™¨åº”ç”¨ç¨‹åºï¼Œåè€…å°†æ¥æ”¶<em>id_token</em>å’Œ<em>access_token</em> ã€‚ å¦‚ä¸‹æ‰€ç¤ºï¼Œapp-login-menuç»„ä»¶æœ¬èº«ç¡®å®šæˆæƒå·²æˆåŠŸå®Œæˆå¹¶æ˜¾ç¤ºâ€œ greetingâ€ï¼Œä»¥åŠ<em>Logout</em>çš„æŒ‰é’®ã€‚ </p><br><p><img src="https://habrastorage.org/webt/cr/l-/aa/crl-aa3ehwgdjybwkmb7nbg92pk.png"></p><br><p> å½“åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€â€œå¼€å‘äººå‘˜å·¥å…·â€æ—¶ï¼Œæ‚¨å¯ä»¥åœ¨åå°çœ‹åˆ°ä½¿ç”¨OIDC / OAuthåè®®çš„æ‰€æœ‰äº¤äº’ã€‚ è¿™æ­£åœ¨è·å–æˆæƒæœåŠ¡å™¨ä¿¡æ¯ <br> é€šè¿‡ç«¯ç‚¹<em>.well-known / openid-configuration</em>ä»¥åŠé€šè¿‡connect / checksessionè®¿é—®ç‚¹æ± åŒ–ä¼šè¯æ´»åŠ¨ã€‚ æ­¤å¤–ï¼Œæˆæƒæ¨¡å—é…ç½®ä¸ºâ€œä»¤ç‰Œçš„é™é»˜æ›´æ–°â€æœºåˆ¶ï¼Œå½“è®¿é—®ä»¤ç‰Œåˆ°æœŸæ—¶ï¼Œç³»ç»Ÿä¼šåœ¨éšè—çš„iframeä¸­ç‹¬ç«‹é€šè¿‡æˆæƒæ­¥éª¤ã€‚ æ‚¨å¯ä»¥é€šè¿‡åœ¨<em>authorize.service.ts</em>æ–‡ä»¶ä¸­å°†<em>includeIdTokenInSilentRenew</em>å‚æ•°çš„å€¼è®¾ç½®ä¸ºâ€œ falseâ€æ¥ç¦ç”¨ä»¤ç‰Œè‡ªåŠ¨æ›´æ–°ã€‚ </p><br><p> ç°åœ¨ï¼Œæ‚¨å¯ä»¥å¤„ç†é™åˆ¶ä»SPAåº”ç”¨ç¨‹åºçš„ç»„ä»¶ä»¥åŠèƒŒé¢çš„æŸäº›APIæ§åˆ¶å™¨å¯¹æœªç»æˆæƒçš„ç”¨æˆ·çš„è®¿é—®ã€‚ ä¸ºäº†æ¼”ç¤ºä¸€äº›APIï¼Œæˆ‘ä»¬å°†åœ¨Modelsæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ª<em>ExchangeRateItem</em>ç±»<em>ï¼Œ</em>å¹¶åœ¨Controlleræ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªè¿”å›ä¸€äº›éšæœºæ•°æ®çš„æ§åˆ¶å™¨ã€‚ </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//Controller: [ApiController] public class ExchangeRateController { private static readonly string[] Currencies = new[] { "EUR", "USD", "BGN", "AUD", "CNY", "TWD", "NZD", "TND", "UAH", "UYU", "MAD" }; [HttpGet("api/rates")] public IEnumerable&lt;ExchangeRateItem&gt; Get() { var rng = new Random(); return Enumerable.Range(1, 5).Select(index =&gt; new ExchangeRateItem { FromCurrency = "RUR", ToCurrency = Currencies[rng.Next(Currencies.Length)], Value = Math.Round(1.0+ 1.0/rng.Next(1, 100),2) }) .ToArray(); } } //Models: public class ExchangeRateItem { public string FromCurrency { get; set; } public string ToCurrency { get; set; } public double Value { get; set; } }</span></span></code> </pre><br><p> æ¥ä¸‹æ¥ï¼Œåœ¨å‰ç«¯ä¾§ï¼Œåˆ›å»ºä¸€ä¸ªæ–°ç»„ä»¶ï¼Œè¯¥ç»„ä»¶å°†æ¥æ”¶ <br> å¹¶æ˜¾ç¤ºåˆšåˆ›å»ºçš„æ§åˆ¶å™¨çš„æ±‡ç‡æ•°æ®ã€‚ </p><br><pre> <code class="plaintext hljs">ng generate component ExchangeRate -t=true -s=true --skipTests=true</code> </pre> <br><p> è¯¥ç»„ä»¶çš„å†…å®¹åº”å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><div class="spoiler">  <b class="spoiler_title">ä»£å·</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Component, OnInit, Input } from '@angular/core'; import { HttpClient } from '@angular/common/http'; import { Observable, of, Subject } from 'rxjs'; import { catchError } from 'rxjs/operators'; @Component({ selector: 'app-exchange-rate', template: ` &lt;div class="alert alert-danger" *ngIf="errorMessage | async as msg"&gt; {{msg}} &lt;/div&gt; &lt;table class='table table-striped'&gt; &lt;thead&gt; &lt;tr&gt; &lt;th&gt;From currency&lt;/th&gt; &lt;th&gt;To currency&lt;/th&gt; &lt;th&gt;Rate&lt;/th&gt; &lt;/tr&gt; &lt;/thead&gt; &lt;tbody&gt; &lt;tr *ngFor="let rate of rates | async"&gt; &lt;td&gt;{{ rate.fromCurrency }} &lt;/td&gt; &lt;td&gt;{{ rate.toCurrency }}&lt;/td&gt; &lt;td&gt;{{ rate.value }}&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;/table&gt; `, styles: [] }) export class ExchangeRateComponent implements OnInit { public rates: Observable&lt;ExchangeRateItem[]&gt;; public errorMessage: Subject&lt;string&gt;; @Input() public apiUrl: string; constructor(private http: HttpClient) { this.errorMessage = new Subject&lt;string&gt;(); } ngOnInit() { this.rates = this.http.get&lt;ExchangeRateItem[]&gt;("/api/"+this.apiUrl).pipe(catchError(this.handleError(this.errorMessage)) ); } private handleError(subject: Subject&lt;string&gt;): (te:any) =&gt; Observable&lt;ExchangeRateItem[]&gt; { return (error) =&gt; { let message = ''; if (error.error instanceof ErrorEvent) { message = `Error: ${error.error.message}`; } else { message = `Error Code: ${error.status}\nMessage: ${error.message}`; } subject.next(message); let emptyResult: ExchangeRateItem[] = []; return of(emptyResult); } } } interface ExchangeRateItem { fromCurrency: string; toCurrency: string; value: number; }</code> </pre> </div></div><br><p> ç°åœ¨ï¼Œåªéœ€åœ¨æ¨¡æ¿ä¸­ç¼–å†™&lt;app-exchange-rate apiUrl =â€œ ratesâ€&gt; &lt;/ app-exchange-rate&gt;è¡Œå³å¯åœ¨app-dataé¡µé¢ä¸Šå¼€å§‹ä½¿ç”¨å®ƒï¼Œæ‚¨å¯ä»¥å†æ¬¡å¯åŠ¨è¯¥é¡¹ç›®ã€‚ å½“æˆ‘ä»¬æ²¿ç€ç›®æ ‡è·¯å¾„å¯¼èˆªæ—¶ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°è¯¥ç»„ä»¶å·²æ¥æ”¶åˆ°æ•°æ®å¹¶å°†å…¶æ˜¾ç¤ºåœ¨è¡¨æ ¼ä¸­ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å°è¯•æ·»åŠ æˆæƒè®¿é—®æ§åˆ¶å™¨APIçš„è¯·æ±‚ï¼Œä¸ºæ­¤ï¼Œè¯·åœ¨<em>ExchangeRateController</em>ç±»ä¸Šæ·»åŠ <em>[Authorize]</em>å±æ€§ï¼Œç„¶åå†æ¬¡è¿è¡ŒSPAï¼Œä½†æ˜¯ï¼Œå½“æˆ‘ä»¬åˆ‡æ¢å›è°ƒç”¨APIçš„ç»„ä»¶åï¼Œä¼šçœ‹åˆ°é”™è¯¯æç¤ºæˆæƒæ ‡å¤´ã€‚ </p><br><p><img src="https://habrastorage.org/webt/fo/kv/ov/fokvovvxneeouxy0k30wuvlwj4u.png"></p><br><p> è¦å°†æˆæƒä»¤ç‰Œæ­£ç¡®æ·»åŠ åˆ°ä¼ å‡ºè¯·æ±‚ä¸­ï¼Œæ‚¨å¯ä»¥ <br> å¯ç”¨è§’åº¦æ‹¦æˆªå™¨æ‹¦æˆªå™¨æœºåˆ¶ã€‚ å¹¸è¿çš„æ˜¯ï¼Œå¯¼å…¥çš„æ¨¡å—å·²ç»åŒ…å«å¿…éœ€çš„ç±»å‹ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨åº”ç”¨ç¨‹åºçš„åŸºæœ¬æ¨¡å—ä¸­æ³¨å†Œå®ƒå³å¯ã€‚ </p><br><pre> <code class="plaintext hljs">providers: [ { provide: HTTP_INTERCEPTORS, useClass: AuthorizeInterceptor, multi: true } ],</code> </pre> <br><p> è¿™äº›æ­¥éª¤ä¹‹åï¼Œä¸€åˆ‡éƒ½åº”è¯¥æ­£å¸¸å·¥ä½œã€‚ å¦‚æœå†æ¬¡æŸ¥çœ‹å¼€å‘äººå‘˜å·¥å…·ï¼Œæµè§ˆå™¨å°†çœ‹åˆ°æ–°çš„Bearer access_tokenæˆæƒæ ‡å¤´ã€‚ åœ¨åç«¯ï¼Œæ­¤ä»¤ç‰Œå°†ç”±IdentityServeréªŒè¯ï¼Œå¹¶ä¸”è¿˜å°†æˆäºˆè°ƒç”¨å®‰å…¨APIç‚¹çš„æƒé™ã€‚ </p><br><p> åœ¨ä¸æˆæƒæœåŠ¡å™¨é›†æˆçš„ç¤ºä¾‹çš„æœ€åï¼Œæ‚¨å¯ä»¥å°†æ¿€æ´»ä¿æŠ¤ä¸SPAä¸­çš„æ±‡ç‡æ•°æ®ä¸€èµ·æ”¾åœ¨è·¯ç”±ä¸Šï¼Œè¿™å°†é˜²æ­¢ç”¨æˆ·ï¼ˆå¦‚æœä»–ä»¬å½“å‰æœªè¢«æˆæƒï¼‰åˆ‡æ¢åˆ°è¯¥é¡µé¢ã€‚ å…ˆå‰å¯¼å…¥çš„æ¨¡å—ä¸­ä¹Ÿæä¾›äº†æ­¤ä¿æŠ¤å™¨ï¼Œæ‚¨åªéœ€å°†å…¶æŒ‚åœ¨ç›®æ ‡è·¯ç”±ä¸Šå³å¯ã€‚ </p><br><pre> <code class="plaintext hljs">{ path: 'data', component: DataComponent, canActivate: [AuthorizeGuard] }</code> </pre> <br><p> ç°åœ¨ï¼Œå¦‚æœç”¨æˆ·å°šæœªç™»å½•è¯¥åº”ç”¨ç¨‹åºå¹¶é€‰æ‹©æŒ‡å‘æˆ‘ä»¬å—ä¿æŠ¤ç»„ä»¶çš„é“¾æ¥ï¼Œåˆ™è¯¥ç”¨æˆ·å°†ç«‹å³è¢«è½¬ç§»åˆ°æˆæƒé¡µé¢ï¼Œå¹¶è¦æ±‚è¾“å…¥ç™»å½•åå’Œå¯†ç ã€‚ ç”Ÿæˆçš„ä»£ç å¯åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">githubä¸Šæ‰¾åˆ°</a> ã€‚ </p><br><h2 id="podklyuchenie-vneshnego-vhoda-v-sistemu-cherez-postavschika-google"> é€šè¿‡Googleæä¾›ç¨‹åºè¿æ¥å¤–éƒ¨ç™»å½• </h2><br><p> æœ‰ä¸€ä¸ªå•ç‹¬çš„Microsoft.AspNetCore.Authentication.Google Nugetç¨‹åºåŒ…ï¼Œç”¨äºé€šè¿‡ASP.NET Core 1.1 / 2.0 +çš„Googleå¸æˆ·è¿æ¥ç™»å½•ï¼Œä½†æ˜¯ï¼Œç”±äºå…¬å¸è‡ªèº«æ”¿ç­–çš„å˜åŒ–ï¼ŒMicrosoftè®¡åˆ’ä½¿ç”¨ASP.NET Core 3.0+è®¤ä¸ºå®ƒ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å·²ç»è¿‡æ—¶äº†</a> ã€‚ ç°åœ¨ï¼Œå»ºè®®é€šè¿‡æœ¬æ–‡å°†ä½¿ç”¨çš„è¾…åŠ©æ–¹æ³•<em>OpenIdConnectExtensions</em>å’Œ<em>AddOpenIdConnect</em>è¿›è¡Œè¿æ¥ã€‚ </p><br><p> å®‰è£…OpenIdConnectæ‰©å±•ï¼š </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.AspNetCore.Authentication.OpenIdConnect -v 3.0.0-preview7.19365.7</code> </pre> <br><p> é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä»Googleè·å–ä¸¤ä¸ªå…³é”®å€¼-Id Clientå’ŒClient Secretï¼Œä¸ºæ­¤ï¼Œå»ºè®®æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š </p><br><ul><li> è·Ÿéš<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é“¾æ¥ï¼Œ</a>ç„¶åé€‰æ‹©â€œé…ç½®é¡¹ç›®â€æŒ‰é’®ã€‚ </li><li> åœ¨å‡ºç°çš„å¯¹è¯æ¡†ä¸­ï¼ŒæŒ‡å®šWebæœåŠ¡å™¨ã€‚ </li><li>     Â«Authorized redirect URIÂ»           Google (..      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://localhost:44301/</a> ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://localhost:44301/signin-google</a> ) </li><li>      ClientID  Client Secret. </li><li>         ,   ,   URL    . </li></ul><br><p>         <a href="">Secret Manager</a> .       ,    . </p><br><pre> <code class="plaintext hljs">dotnet user-secrets init dotnet user-secrets set "Authentication:Google:ClientId" "  ClientID" dotnet user-secrets set "Authentication:Google:ClientSecret" "  ClientSecret"</code> </pre> <br><p>           Google. </p><br><pre> <code class="cs hljs">services.AddAuthentication() .AddOpenIdConnect(<span class="hljs-string"><span class="hljs-string">"Google"</span></span>, <span class="hljs-string"><span class="hljs-string">"Google"</span></span>, o =&gt; { IConfigurationSection googleAuthNSection = Configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"Authentication:Google"</span></span>); o.ClientId = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientId"</span></span>]; o.ClientSecret = googleAuthNSection[<span class="hljs-string"><span class="hljs-string">"ClientSecret"</span></span>]; o.Authority = <span class="hljs-string"><span class="hljs-string">"https://accounts.google.com"</span></span>; o.ResponseType = OpenIdConnectResponseType.Code; o.CallbackPath = <span class="hljs-string"><span class="hljs-string">"/signin-google"</span></span>; }) .AddIdentityServerJwt();</code> </pre> <br><p>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>     ,    <br>      Google.     ,    ,       SPA          . </p><br><p><img src="https://habrastorage.org/webt/xi/rl/5h/xirl5hobkgfaukb4wzp5sibosj4.png"></p><br><p>  ,  ,     OAuth ,       .   Nuget        <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><h2 id="dorabotka-vozmozhnosti-vhoda-pod-polzovatelyami-windows">      Windows </h2><br><p>   ,  SPA           Microsoft,       ActiveDirectory.  ,       Html    ASP.NET, WebForms  ..,      Windows        WindowsIdentity, ,       .     Identity Server,         Windows,              claims <em>id_token</em>  <em>access_token</em> .  ,  IS4    ,        ,    <br>   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github</a> . ,             ASP.NET Core Identity 3.0. </p><br><p>          Identity,    Razor  <em>Login</em>  <em>ExternalLogin</em>    ( CLI aspnet-codegenerator    ): </p><br><pre> <code class="plaintext hljs">dotnet add package Microsoft.EntityFrameworkCore.SqlServer dotnet add package Microsoft.VisualStudio.Web.CodeGeneration.Design dotnet aspnet-codegenerator identity -dc IdentityServer4WebApp.Data.ApplicationDbContext --files "Account.Login;Account.ExternalLogin"</code> </pre> <br><p>    ,     Area   <em>Identity</em>    ,          . </p><br><p>         ,       .   ,  Identity      I <em>AuthenticationSchemeProvider. GetAllSchemesAsync()</em>   DisplayName != null,    Windows   DisplayName = null.     LoginModel    <em>OnGetAsync</em>   : </p><br><pre> <code class="cs hljs">ExternalLogins = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.GetExternalAuthenticationSchemesAsync()).ToList(); <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt; &gt;&gt; ExternalLogins =(await _schemeProvider.GetAllSchemesAsync()).Where(x =&gt; x.DisplayName != null ||(x.Name.Equals(IISDefaults.AuthenticationScheme,StringComparison.OrdinalIgnoreCase))).ToList();</span></span></code> </pre> <br><p>         <em>private readonly</em> <em>AuthenticationSchemeProvider _schemeProvider</em> .    View         <em>Login.cshtml</em> : </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @provider.DisplayName account"</span></span></span><span class="hljs-tag">&gt;</span></span>@provider.DisplayName<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;&lt; &gt;</span></span>&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn btn-primary"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@provider.Name"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Log in using your @(provider.DisplayName ??provider.Name) account"</span></span></span><span class="hljs-tag">&gt;</span></span>@(provider.DisplayName ??provider.Name)<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  ,  windows      <em>launchSettings.json</em> <br> (   IIS,       <em>web.config</em> ). </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"iisSettings"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"windowsAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"anonymousAuthentication"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"iisExpress"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"applicationUrl"</span></span>: <span class="hljs-string"><span class="hljs-string">"http://localhost:15479"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sslPort"</span></span>: <span class="hljs-number"><span class="hljs-number">44301</span></span> } },</code> </pre> <br><p>        Â«WindowsÂ»    . </p><br><p><img src="https://habrastorage.org/webt/e_/6s/-m/e_6s-m8ot5h52dv6dgvid8bgpky.png"></p><br><p>     SPA      IdentityServer     .    Â«Â»    <em>[AllowAnonymous]</em>    <em>LoginModel</em>   <em>[Authorize(AuthenticationSchemes = "Windows")]</em> ,     ,       WindowsIdentity. </p><br><p>    <em>ExternalLogin</em> ,   Identity    Windows .      <em>ProcessWindowsLoginAsync</em> . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;IActionResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessWindowsLoginAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> returnUrl</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.AuthenticateAsync(IISDefaults.AuthenticationScheme); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result?.Principal <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WindowsPrincipal wp) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redirectUrl = Url.Page(<span class="hljs-string"><span class="hljs-string">"./ExternalLogin"</span></span>, pageHandler: <span class="hljs-string"><span class="hljs-string">"Callback"</span></span>, values: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { returnUrl }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> props = _signInManager.ConfigureExternalAuthenticationProperties(IISDefaults.AuthenticationScheme, redirectUrl); props.Items[<span class="hljs-string"><span class="hljs-string">"scheme"</span></span>] = IISDefaults.AuthenticationScheme; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsIdentity(IISDefaults.AuthenticationScheme); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Subject, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(JwtClaimTypes.Name, wp.Identity.Name)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(ClaimTypes.NameIdentifier, wp.Identity.Name)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> wi = wp.Identity <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> WindowsIdentity; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> groups = wi.Groups.Translate(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(NTAccount)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hasUsersGroup = groups.Any(i =&gt; i.Value.Contains(<span class="hljs-string"><span class="hljs-string">@"BUILTIN\Users"</span></span>, StringComparison.OrdinalIgnoreCase)); id.AddClaim(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Claim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>, hasUsersGroup.ToString())); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> HttpContext.SignInAsync(IdentityConstants.ExternalScheme, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClaimsPrincipal(id), props); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Redirect(props.RedirectUri); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Challenge(IISDefaults.AuthenticationScheme); }</code> </pre> </div></div><br><p>       ,             . </p><br><p>    <em>ExternalLoginModel.OnPost</em>          : </p><br><pre> <code class="plaintext hljs">if (IISDefaults.AuthenticationScheme == provider) { return await ProcessWindowsLoginAsync(returnUrl); }</code> </pre> <br><p>    Claim  Windows      Claim Â«hasUsersGroupÂ»,       ID  access,    .      ASP.NET Identity     UserClaims.        <em>ExternalLoginModel</em> . </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateClaims</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExternalLoginInfo info, ApplicationUser user, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] claimTypes</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (claimTypes == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimTypesHash = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(claimTypes); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claims = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.GetClaimsAsync(user)).Where(c =&gt; claimTypesHash.Contains(c.Type)).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.RemoveClaimsAsync(user, claims); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> claimType <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> claimTypes) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info.Principal.HasClaim(c =&gt; c.Type == claimType)) { claims = info.Principal.FindAll(claimType).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddClaimsAsync(user, claims); } } }</code> </pre> <br><p>       <em>OnPostConfirmationAsync</em> (    <br>     ). </p><br><pre> <code class="cs hljs">result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.AddLoginAsync(user, info); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.SignInAsync(user, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>); _logger.LogInformation(<span class="hljs-string"><span class="hljs-string">"User created an account using {Name} provider."</span></span>, info.LoginProvider); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">// return LocalRedirect(returnUrl); }</span></span></code> </pre> <br><p>    <em>OnGetCallbackAsync</em> ,      . </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _signInManager.ExternalLoginSignInAsync(info.LoginProvider, info.ProviderKey, isPersistent: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, bypassTwoFactor : <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.Succeeded) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> _userManager.FindByLoginAsync(info.LoginProvider, info.ProviderKey); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> UpdateClaims(info, user, <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);<span class="hljs-comment"><span class="hljs-comment">//</span></span></code> </pre> <br><p>  ,        WebAPI   <br>  Â«hasUsersGroupÂ».      Â«ShouldHasUsersGroupÂ» </p><br><pre> <code class="cs hljs">services.AddAuthorization(options =&gt; { options.AddPolicy(<span class="hljs-string"><span class="hljs-string">"ShouldHasUsersGroup"</span></span>, policy =&gt; { policy.RequireClaim(<span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span>);}); });</code> </pre> <br><p>    <em>ExchangeRateController</em>       <br>     Policy. </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Authorize(Policy = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ShouldHasUsersGroup"</span></span></span><span class="hljs-meta">)</span></span>] [HttpGet(<span class="hljs-string"><span class="hljs-string">"api/internalrates"</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;ExchangeRateItem&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetInternalRates</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Get().Select(i=&gt;{i.Value=Math.Round(i.Value<span class="hljs-number"><span class="hljs-number">-0.02</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> i;}); }</code> </pre> <br><p>   view    . </p><br><pre> <code class="plaintext hljs">ng generate component InternalData -t=true -s=true --skipTests=true</code> </pre> <br><p>    template          . </p><br><pre> <code class="html hljs xml">//internal-data.component.ts: template: `<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">apiUrl</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"internalrates"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app-exchange-rate</span></span></span><span class="hljs-tag">&gt;</span></span> `, //app-routing.module.ts: { path: ' internaldata', component: InternalDataComponent, canActivate: [AuthorizeGuard] } //app.component.html: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-item"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLinkActive</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["link-active"]'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"nav-link text-dark"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">routerLink</span></span></span><span class="hljs-tag">]=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'["/internaldata"]'</span></span></span><span class="hljs-tag">&gt;</span></span>Internal api data<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>             <br> , ,    .   ,  accsee_token    <br>   claim   <em>hasUsersGroup</em> ,       <br>     ApiResources  .  ,    ,        <em>appsettings.json</em> ,           <em>Startup. ConfigureServices</em> . </p><br><pre> <code class="cs hljs">services.AddIdentityServer() .AddApiAuthorization&lt;ApplicationUser, ApplicationDbContext&gt;(options =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> apiResource = options.ApiResources.First(); apiResource.UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }; });</code> </pre> <br><p> ,     ,    windows      ,         . </p><br><p>       ,   â€“  Guard    claim   Â«hasUsersGroupÂ»     Â«  Â».    Guard  : </p><br><pre> <code class="plaintext hljs">ng generate guard AuthorizeWindowsGroupGuard --skipTests=true</code> </pre> <br><p>      : </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><pre> <code class="plaintext hljs">import { Injectable } from '@angular/core'; import { Observable } from 'rxjs'; import { map,tap} from 'rxjs/operators'; import { CanActivate, ActivatedRouteSnapshot, RouterStateSnapshot, Router, UrlTree } from '@angular/router'; import { AuthorizeService } from "./authorize.service"; import { ApplicationPaths, QueryParameterNames } from './api-authorization.constants'; @Injectable({ providedIn: 'root' }) export class AuthorizeWindowsGroupGuardGuard implements CanActivate{ constructor(private authorize: AuthorizeService, private router: Router) {} canActivate(route: ActivatedRouteSnapshot, state: RouterStateSnapshot): Observable&lt;boolean | UrlTree&gt; | Promise&lt;boolean | UrlTree&gt; | boolean | UrlTree { return this.authorize.getUser().pipe(map((u: any) =&gt; !!u &amp;&amp; !!u.hasUsersGroup)).pipe(tap((isAuthorized:boolean) =&gt; this.handleAuthorization(isAuthorized, state)));; } private handleAuthorization(isAuthenticated: boolean, state: RouterStateSnapshot) { if (!isAuthenticated) { window.location.href = "/Identity/Account/Login?" + QueryParameterNames.ReturnUrl + "=/"; } } }</code> </pre> </div></div><br><p> , ,         . </p><br><pre> <code class="plaintext hljs">{ path: 'internaldata', component: InternalDataComponent, canActivate: [AuthorizeWindowsGroupGuardGuard]</code> </pre> <br><p>     IdentityServer,      claims ( <em>sub</em> , <em>profile</em> ),     Â«hasUsersGroupÂ».      IdentityResource, -        IdentityResources          <em>Startup.ConfigureServices</em> . </p><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> identityResource = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IdentityResource { Name = <span class="hljs-string"><span class="hljs-string">"customprofile"</span></span>, DisplayName = <span class="hljs-string"><span class="hljs-string">"Custom profile"</span></span>, UserClaims = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"hasUsersGroup"</span></span> }, }; identityResource.Properties.Add(ApplicationProfilesPropertyNames.Clients, <span class="hljs-string"><span class="hljs-string">"*"</span></span>); options.IdentityResources.Add(identityResource);</code> </pre> <br><p> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> </a>   ,         windows    Â« Â»   SPA â€“   ,     ,    Guard    . </p><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> ,  ASP.NET Core 3.0            IdentityServer4,         .      preview ,       .   ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github</a>   . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN461433/">https://habr.com/ru/post/zh-CN461433/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN461417/index.html">æˆ‘å¦‚ä½•åœ¨å·¥ä¸šç³»ç»Ÿä¸­æ‹’ç»db4o</a></li>
<li><a href="../zh-CN461421/index.html">æŠ•èµ„äº¤æ˜“æ‰€æ—¶å¦‚ä½•ç¡®ä¿è‡ªå·±å…å—å¯èƒ½çš„æŸå¤±ï¼šç»“æ„æ€§äº§å“</a></li>
<li><a href="../zh-CN461423/index.html">11ä¸ªæŠ€å·§ï¼šå¦‚ä½•å‘â€œéè®¾è®¡äººå‘˜â€å±•ç¤ºUI / UXå·¥ä½œ</a></li>
<li><a href="../zh-CN461425/index.html">å¦‚ä½•æˆä¸ºäº§å“ç»ç†å¹¶è¿›ä¸€æ­¥å‘å±•</a></li>
<li><a href="../zh-CN461431/index.html">â€œå–œæ¬¢å’Œä¸å–œæ¬¢â€ï¼šé€šè¿‡HTTPSè¿›è¡ŒDNS</a></li>
<li><a href="../zh-CN461435/index.html">ä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œè¿›è¡Œæƒ…æ„Ÿè¯†åˆ«</a></li>
<li><a href="../zh-CN461437/index.html">370ä¸ªç¯æ³¡</a></li>
<li><a href="../zh-CN461439/index.html">å¯åŠ¨Reactå’ŒTypeScriptç»„ä»¶åº“</a></li>
<li><a href="../zh-CN461441/index.html">ä½¿ç”¨R.å¹¶è¡Œè®¡ç®—ï¼Œå›¾å½¢ï¼Œxlsxï¼Œç”µå­é‚®ä»¶å’Œæ‰€æœ‰è¿™äº›æŠ¥å‘Šå­˜å‚¨çŠ¶æ€</a></li>
<li><a href="../zh-CN461443/index.html">åˆ†æåï¼šæœ‰å…³SKS KeyserveråŠ å¯†å¯†é’¥æœåŠ¡å™¨ç½‘ç»œçš„æœ€æ–°æ”»å‡»çš„å·²çŸ¥ä¿¡æ¯</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>