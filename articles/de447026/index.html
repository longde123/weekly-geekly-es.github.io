<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÜ üò± üöç Wir schreiben den OTA-Loader f√ºr ATmega128RFA1 (als Teil des Smart Response XE-Ger√§ts) üë®üèø‚ÄçüöÄ üé≠ üïó</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alles begann mit der √úbernahme eines interessanten Ger√§ts durch den Autor auf dem Sekund√§rmarkt - Smart Response XE ( Kurzbeschreibung ). Es ist f√ºr S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir schreiben den OTA-Loader f√ºr ATmega128RFA1 (als Teil des Smart Response XE-Ger√§ts)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447026/"><img src="https://habrastorage.org/webt/ie/eb/sz/ieebszdo1m1pcoy6jx1gvxww3ao.jpeg"><br><br>  Alles begann mit der √úbernahme eines interessanten Ger√§ts durch den Autor auf dem Sekund√§rmarkt - Smart Response XE ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kurzbeschreibung</a> ).  Es ist f√ºr Schulen gedacht: Jeder Sch√ºler in der Klasse erh√§lt ein Ger√§t, das einem elektronischen Notizbuch oder √úbersetzer der neunziger Jahre √§hnelt, der Lehrer stellt eine Frage, und die Sch√ºler geben auf den Tastaturen der Ger√§te die √ºber den Funkkanal (802.15.4) empfangenen Antworten an den Empf√§nger ein, der an den PC des Lehrers angeschlossen ist. <br><br>  Die Unterst√ºtzung f√ºr diese Ger√§te wurde vor einigen Jahren eingestellt, und die Tatsache, dass Schulen f√ºr jeweils 100 bis 200 US-Dollar gekauft haben, wird jetzt bei eBay f√ºr 10 oder weniger angezeigt.  Eisen ist dort sehr gut f√ºr Geek-Experimente geeignet: <br><br><ul><li>  Tastatur mit 60 Tasten </li><li>  Display mit einer Aufl√∂sung von 384x136, 2 Bit pro Pixel - √§hnlich wie bei BK, CGA, aber 4 sind keine Farben, sondern Helligkeitsabstufungen </li><li>  ATmega128RFA1-Mikrocontroller (128 kB Flash-Speicher, 4 kB ROM, 16 kB RAM, 802.15.4 Standard-Transceiver) </li><li>  externer (in Bezug auf den Mikrocontroller und nicht das gesamte Ger√§t) Flash-Speicher f√ºr 1 Megabit (128 Kilobyte) mit SPI </li><li>  Fach f√ºr 4 AAA-Elemente. </li></ul><br>  Unter dem Namen des Mikrocontrollers ist klar, dass er zur AVR-Familie geh√∂rt, was bedeutet, dass die Herstellung eines Arduino-kompatiblen Ger√§ts eine mehr als triviale Aufgabe ist ... <a name="habracut"></a><br><br>  Aus den Nachrichten auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hackaday ging hervor, dass der</a> Autor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dies bereits getan hat</a> (derselbe Link sagt, womit er sich verbinden soll) und die M√∂glichkeit hatte, Spiele f√ºr Arduboy auszuf√ºhren: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6VqPGFtIT8Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Der Autor ist jedoch mehr an der M√∂glichkeit interessiert, nicht auf dem Ger√§t zu spielen, sondern zu studieren: <br><br><ul><li>  serieller Flash-SPI </li><li>  Downloader f√ºr AVR </li><li>  Standard 802.15.4 </li></ul><br>  Der Autor begann mit dem Schreiben einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bibliothek</a> (GPL v3), mit der Sie die Anzeige initialisieren, Text und Rechtecke anzeigen und √ºber die SPI-Schnittstelle auf den Flash-Speicher zugreifen k√∂nnen.  Dann begann er, Ideen f√ºr den praktischen Einsatz des Ger√§ts zu entwickeln: ein VT-100-kompatibles Terminal im Taschenformat, Multiplayer-Spiele.  Nachdem er die drei Ger√§te neu hergestellt hatte, beschloss er, ihnen beizubringen, wie man Skizzen ‚Äûdurch die Luft‚Äú bekommt.  Das w√§re nicht nur interessant, sondern auch sehr praktisch: Es ist schwierig, das Ger√§tegeh√§use jedes Mal zu √∂ffnen, und unter der Batterieabdeckung befinden sich nur L√∂cher, durch die Sie einen JTAG-Programmierer an die Platine anschlie√üen k√∂nnen. <br><br><img src="https://habrastorage.org/webt/ds/tb/zn/dstbzns76vsm4pfjogzjsyo9mla.jpeg"><br><br>  Dies reicht aus, um den Arduino-Bootloader zu f√ºllen, aber keine Skizze - die serielle Schnittstelle wird dort nicht ausgegeben, Sie k√∂nnen jedoch immer noch nicht auf das √ñffnen des Geh√§uses verzichten.  Au√üerdem sind die TX0- und RX0-Leitungen der ersten seriellen Schnittstelle an den Abfrageleitungen der Tastaturmatrix ausgerichtet, n√§mlich an denen, entlang derer die Funktionstasten an den Seiten des Displays abgefragt werden.  Aber was tun - der Autor hat das gebaut: <br><br><img src="https://habrastorage.org/webt/8f/xa/-q/8fxa-qo6dgerkd3ghgh4g-tbjak.jpeg"><br><br>  Dort brachte er die JTAG-Leitungen heraus, und jetzt ist es nicht notwendig, das Batteriefach zu √∂ffnen.  Und um die Skizzen ausf√ºllen zu k√∂nnen, habe ich beide seriellen Anschl√ºsse an denselben Anschluss angeschlossen und auch einen Schalter hinzugef√ºgt, da das Ger√§t bei eingelegten Batterien nicht auf andere Weise physisch ausgeschaltet werden kann. <br><br>  Die Arbeit mit einem L√∂tkolben, einem Schreibmesser und einer Klebepistole dauerte eine Weile.  Im Allgemeinen ist das Gie√üen von Skizzen √ºber die Luft viel praktischer. Es ist dringend erforderlich, etwas daf√ºr zu erfinden. <br><br>  Arduino IDE verwendet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">avrdude</a> , um Skizzen auszuf√ºllen.  Es interagiert mit dem Mikrocontroller √ºber das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">STK500-</a> Protokoll, mit dem Sie Dateien in beide Richtungen √ºbertragen k√∂nnen.  Es ist schlecht kompatibel mit Kan√§len, bei denen variable Verz√∂gerungen, Verzerrungen und Datenverluste m√∂glich sind.  Wenn im seriellen Kanal etwas losgeht oder raschelt, k√∂nnen Sie auf der Suche nach einer Ursache verr√ºckt werden.  Einmal qu√§lte der Autor einen halben Tag lang, bis er feststellte, dass das Problem im schlechten Kabel sowie im launischen Schnittstellenkonverter CP2102 lag.  Sogar ein Mikrocontroller mit einem eingebauten Schnittstellenkonverter, zum Beispiel ATmega32u4, kann manchmal so ungezogen sein.  Jeder Arduino-Benutzer hat festgestellt, dass Fehler beim Hochladen von Skizzen nicht so selten sind.  Manchmal funktioniert die Aufzeichnung einwandfrei, und beim Lesen der √úberpr√ºfung wird ein Fehler festgestellt.  Dies bedeutet nicht, dass beim Schreiben ein Fehler aufgetreten ist - der Fehler war beim Lesen.  Stellen Sie sich nun vor, dass beim Arbeiten "√ºber Funk" dasselbe passiert, jedoch viel h√§ufiger. <br><br>  Nachdem der Autor verschiedene Wege ausprobiert hatte, um dieses Problem zu l√∂sen, kam er auf Folgendes.  Das Ger√§t verf√ºgt √ºber einen 128-Kilobyte-Flash-Speicher mit SPI-Schnittstelle. Wir empfangen Daten √ºber Kabel (denken Sie daran, dass der Autor bereits ein Ger√§t mit einem Anschluss an der Seite hat), verwenden diesen Speicher als Puffer und senden Daten √ºber einen Funkkanal an ein anderes Ger√§t.  So ein Hallo von Cybiko. <br><br>  Nach dem Schreiben des Codes f√ºr die Arbeit mit dem Funkkanal sowie der Schriftart wurde der Bootloader l√§nger als 4 Kilobyte.  Daher musste der HFUSE-Wert von 0xDA auf 0xD8 ge√§ndert werden.  Jetzt kann der Bootloader bis zu 8 Kilobyte lang sein und die Startadresse ist 0x1E000 geworden.  Dies spiegelt sich im Makefile wider, sollte jedoch beim Bef√ºllen des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bootloaders</a> mit avrdude ber√ºcksichtigt werden. <br><br>  Der 802.15.4-Standardtransceiver im ATmega128RFA1 wurde urspr√ºnglich f√ºr den Betrieb mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ZigBee-</a> Protokoll entwickelt, was ziemlich kompliziert ist. Daher entschied sich der Autor, stattdessen einfach Pakete zu √ºbertragen.  Dies ist Hardware, die im ATmega128RFA1 implementiert ist, daher ist ein bisschen Code erforderlich.  Der Einfachheit halber entschied sich der Autor auch f√ºr die Verwendung eines festen Kanals, sodass er ihn nicht einmal manuell ausw√§hlen konnte.  Der 802.15.4-Standard unterst√ºtzt 16 Kan√§le mit Nummern von 11 bis 26. Sie sind ziemlich verstopft, einige √ºberlappen auch WiFi-Kan√§le (rot zeigt ZigBee-Kan√§le an, blau, gr√ºn und gelb - WiFi). <br><br><img src="https://habrastorage.org/webt/nn/vx/fn/nnvxfnxaptwvpgbllq60zkfh2bq.png"><br><br>  Es stellte sich heraus, dass die Kan√§le 15 und 26 am wenigsten anf√§llig f√ºr St√∂rungen durch WLAN sind. Der Autor w√§hlte den zweiten.  Haftungsausschluss: Der √úbersetzer wei√ü nicht, ob ZigBee so vereinfacht ist.  Vielleicht lohnt es sich, etwas mehr zu programmieren und es vollst√§ndig umzusetzen? <br><br>  Auf dem ersten Ger√§t muss eine Zustandsmaschine implementiert werden, die Daten mithilfe des STK500-Protokolls √ºbertr√§gt.  Zum gr√∂√üten Teil sind gesendete und empfangene Nachrichten autark, aber einige sind an diejenigen gebunden, die den Kanal zuvor durchlaufen haben.  Eine Beschreibung des Dialogs finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br>  Ein wichtiger Bestandteil dieses Dialogs ist die √úbertragung von Paketen zum Schreiben in den Flash-Speicher des Zielger√§ts.  Einfache Mikrocontroller der AVR-Familie haben eine Seitengr√∂√üe von 128 Byte, ATmega128RFA1 hat jedoch eine Gr√∂√üe von 256. Der Flash-Speicher, der √ºber das SPI-Protokoll eine Verbindung herstellt, hat dieselbe Gr√∂√üe.  Das Programm im ersten Ger√§t √ºbertr√§gt beim Gie√üen der Skizze diese nicht sofort auf das zweite, sondern schreibt sie in diesen Speicher.  Wenn die Arduino IDE die Richtigkeit der Aufzeichnung √ºberpr√ºft, senden sie ihr, was dort geschrieben wurde.  Jetzt m√ºssen Sie die empfangenen Daten drahtlos auf das zweite Ger√§t √ºbertragen.  Gleichzeitig erfolgt h√§ufig ein Wechsel vom Empfang zum Senden und umgekehrt.  Das STK500-Protokoll ist gegen√ºber Verz√∂gerungen gleichg√ºltig, toleriert jedoch keinen Datenverlust (seltsam, aber es wurde oben gesagt, dass Verz√∂gerungen bei der Daten√ºbertragung ebenfalls Auswirkungen haben).  Und Verluste bei der drahtlosen √úbertragung sind unvermeidlich.  ATmega128RFA1 verf√ºgt √ºber eine integrierte Hardware-Implementierung f√ºr wiederholte Anforderungen mit Zweifeln an der korrekten √úbertragung. Der Autor hat jedoch beschlossen, diese programmgesteuert selbst zu implementieren.  Er entwickelte ein Protokoll, bei dem viel mehr Daten in die eine als in die andere Richtung √ºbertragen werden. <br><br>  Es ist unvollkommen, aber alles funktioniert.  Eine 256-Byte-Seite ist in vier Segmente unterteilt, von denen jedes als Paket √ºber Funk √ºbertragen wird.  Ein Paket enth√§lt bis zu 125 Datenbytes plus eine Bytel√§nge und zwei CRC.  So werden dort 64 Byte lange Fragmente zusammen mit Seiten- und Segmentnummern (von 0 bis 3) platziert.  Auf dem empfangenden Ger√§t wird eine Variable bereitgestellt, mit der Sie verfolgen k√∂nnen, wie viele Segmente empfangen werden. Wenn alle vier eintreffen, wird eine Best√§tigung an das sendende Ger√§t gesendet, dass die gesamte Seite empfangen wurde.  Keine Best√§tigung (CRC stimmte nicht √ºberein) - Senden Sie die gesamte Seite erneut.  Die Geschwindigkeit ist gleichzeitig noch h√∂her als bei der √úbertragung √ºber Kabel.  Siehe: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/d-ObUCnRmQU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Tats√§chlich w√§re es jedoch erforderlich, eine bequeme M√∂glichkeit zum Anschlie√üen von Kabelger√§ten an die Ger√§te zum Ausf√ºllen von Skizzen und darauf bereitzustellen.  Setzen Sie beispielsweise einen solchen Schnittstellenkonverter wie auf dem Foto in CP2102 ein und kleben Sie ihn auf die Platine, damit er der Kraft beim Anschlie√üen und Trennen des Micro-USB-Kabels standh√§lt. <br><br><img src="https://habrastorage.org/webt/vd/qj/e7/vdqje7zvkvnkzoggl7nvoezzzry.jpeg"><br><br>  Es hat auch einen 3,3-Volt-Stabilisator (und wie man ihn in einem Ger√§t mit 6-Volt-Stromversorgung verwendet - wenn nur derselbe Stabilisator vorhanden ist und Sie zwei Dioden hinzuf√ºgen k√∂nnen, um automatisch auszuw√§hlen, von welcher das Ger√§t mit Strom versorgt wird).  Alle drei LEDs sollten von der Schnittstellenkonverterplatine entfernt werden, da sie sonst die Batterien zus√§tzlich laden, wenn sie von ihnen aus arbeiten, und auch die Tastaturabfrage st√∂ren und mit dem Flash-Speicher der SPI-Schnittstelle arbeiten. <br><br>  Die Verfolgung des Ziels erwies sich als noch interessanter als seine Erreichung (und Sie brauchen diesen Witz √ºber den Bus nicht).  Der Autor hat viel √ºber Bootloader f√ºr AVR, Flash-Speicher mit SPI, STK500-Protokoll und 802.15.4-Standard gelernt. <br><br>  Der gesamte andere Code neben der oben beschriebenen Bibliothek befindet sich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und befindet sich auch unter GPL v3.  Das Twitter des Autors ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de447026/">https://habr.com/ru/post/de447026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de447016/index.html">25 Jahre sp√§ter: ein Interview mit Linus Torvalds</a></li>
<li><a href="../de447018/index.html">Quantenanreicherung in einer Multi-Welt-Interpretation</a></li>
<li><a href="../de447020/index.html">Bei Produktivit√§t geht es nicht um Zeitmanagement, sondern um Aufmerksamkeitsmanagement</a></li>
<li><a href="../de447022/index.html">Zwingen Sie die Zuh√∂rer nicht zum Nachdenken</a></li>
<li><a href="../de447024/index.html">Wie kann man die Vorteile eines Laptops und eines Desktop-Computers kombinieren? Analyse des Problems und L√∂sungen</a></li>
<li><a href="../de447028/index.html">Steganographie vergangene Dateien: Wir verstecken Daten direkt in Sektoren</a></li>
<li><a href="../de447034/index.html">Mit dem neuen Fehler in Telegram Desktop k√∂nnen Sie die letzte Nachricht lesen</a></li>
<li><a href="../de447036/index.html">Ein Cocktail f√ºr eine gesunde Ern√§hrung - er wird von einem Startup des Beschleunigers der ITMO University hergestellt</a></li>
<li><a href="../de447038/index.html">In der Liste der Bedrohungen: ‚ÄûGame of Thrones‚Äú - eine der beliebtesten Deckungen f√ºr Cyberkriminelle</a></li>
<li><a href="../de447040/index.html">Forschung: Die durchschnittlichen Kosten f√ºr Switches werden reduziert - wir verstehen warum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>