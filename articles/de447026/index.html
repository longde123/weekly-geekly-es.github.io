<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐆 😱 🚍 Wir schreiben den OTA-Loader für ATmega128RFA1 (als Teil des Smart Response XE-Geräts) 👨🏿‍🚀 🎭 🕗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alles begann mit der Übernahme eines interessanten Geräts durch den Autor auf dem Sekundärmarkt - Smart Response XE ( Kurzbeschreibung ). Es ist für S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir schreiben den OTA-Loader für ATmega128RFA1 (als Teil des Smart Response XE-Geräts)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447026/"><img src="https://habrastorage.org/webt/ie/eb/sz/ieebszdo1m1pcoy6jx1gvxww3ao.jpeg"><br><br>  Alles begann mit der Übernahme eines interessanten Geräts durch den Autor auf dem Sekundärmarkt - Smart Response XE ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kurzbeschreibung</a> ).  Es ist für Schulen gedacht: Jeder Schüler in der Klasse erhält ein Gerät, das einem elektronischen Notizbuch oder Übersetzer der neunziger Jahre ähnelt, der Lehrer stellt eine Frage, und die Schüler geben auf den Tastaturen der Geräte die über den Funkkanal (802.15.4) empfangenen Antworten an den Empfänger ein, der an den PC des Lehrers angeschlossen ist. <br><br>  Die Unterstützung für diese Geräte wurde vor einigen Jahren eingestellt, und die Tatsache, dass Schulen für jeweils 100 bis 200 US-Dollar gekauft haben, wird jetzt bei eBay für 10 oder weniger angezeigt.  Eisen ist dort sehr gut für Geek-Experimente geeignet: <br><br><ul><li>  Tastatur mit 60 Tasten </li><li>  Display mit einer Auflösung von 384x136, 2 Bit pro Pixel - ähnlich wie bei BK, CGA, aber 4 sind keine Farben, sondern Helligkeitsabstufungen </li><li>  ATmega128RFA1-Mikrocontroller (128 kB Flash-Speicher, 4 kB ROM, 16 kB RAM, 802.15.4 Standard-Transceiver) </li><li>  externer (in Bezug auf den Mikrocontroller und nicht das gesamte Gerät) Flash-Speicher für 1 Megabit (128 Kilobyte) mit SPI </li><li>  Fach für 4 AAA-Elemente. </li></ul><br>  Unter dem Namen des Mikrocontrollers ist klar, dass er zur AVR-Familie gehört, was bedeutet, dass die Herstellung eines Arduino-kompatiblen Geräts eine mehr als triviale Aufgabe ist ... <a name="habracut"></a><br><br>  Aus den Nachrichten auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Hackaday ging hervor, dass der</a> Autor <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dies bereits getan hat</a> (derselbe Link sagt, womit er sich verbinden soll) und die Möglichkeit hatte, Spiele für Arduboy auszuführen: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6VqPGFtIT8Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Der Autor ist jedoch mehr an der Möglichkeit interessiert, nicht auf dem Gerät zu spielen, sondern zu studieren: <br><br><ul><li>  serieller Flash-SPI </li><li>  Downloader für AVR </li><li>  Standard 802.15.4 </li></ul><br>  Der Autor begann mit dem Schreiben einer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bibliothek</a> (GPL v3), mit der Sie die Anzeige initialisieren, Text und Rechtecke anzeigen und über die SPI-Schnittstelle auf den Flash-Speicher zugreifen können.  Dann begann er, Ideen für den praktischen Einsatz des Geräts zu entwickeln: ein VT-100-kompatibles Terminal im Taschenformat, Multiplayer-Spiele.  Nachdem er die drei Geräte neu hergestellt hatte, beschloss er, ihnen beizubringen, wie man Skizzen „durch die Luft“ bekommt.  Das wäre nicht nur interessant, sondern auch sehr praktisch: Es ist schwierig, das Gerätegehäuse jedes Mal zu öffnen, und unter der Batterieabdeckung befinden sich nur Löcher, durch die Sie einen JTAG-Programmierer an die Platine anschließen können. <br><br><img src="https://habrastorage.org/webt/ds/tb/zn/dstbzns76vsm4pfjogzjsyo9mla.jpeg"><br><br>  Dies reicht aus, um den Arduino-Bootloader zu füllen, aber keine Skizze - die serielle Schnittstelle wird dort nicht ausgegeben, Sie können jedoch immer noch nicht auf das Öffnen des Gehäuses verzichten.  Außerdem sind die TX0- und RX0-Leitungen der ersten seriellen Schnittstelle an den Abfrageleitungen der Tastaturmatrix ausgerichtet, nämlich an denen, entlang derer die Funktionstasten an den Seiten des Displays abgefragt werden.  Aber was tun - der Autor hat das gebaut: <br><br><img src="https://habrastorage.org/webt/8f/xa/-q/8fxa-qo6dgerkd3ghgh4g-tbjak.jpeg"><br><br>  Dort brachte er die JTAG-Leitungen heraus, und jetzt ist es nicht notwendig, das Batteriefach zu öffnen.  Und um die Skizzen ausfüllen zu können, habe ich beide seriellen Anschlüsse an denselben Anschluss angeschlossen und auch einen Schalter hinzugefügt, da das Gerät bei eingelegten Batterien nicht auf andere Weise physisch ausgeschaltet werden kann. <br><br>  Die Arbeit mit einem Lötkolben, einem Schreibmesser und einer Klebepistole dauerte eine Weile.  Im Allgemeinen ist das Gießen von Skizzen über die Luft viel praktischer. Es ist dringend erforderlich, etwas dafür zu erfinden. <br><br>  Arduino IDE verwendet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">avrdude</a> , um Skizzen auszufüllen.  Es interagiert mit dem Mikrocontroller über das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">STK500-</a> Protokoll, mit dem Sie Dateien in beide Richtungen übertragen können.  Es ist schlecht kompatibel mit Kanälen, bei denen variable Verzögerungen, Verzerrungen und Datenverluste möglich sind.  Wenn im seriellen Kanal etwas losgeht oder raschelt, können Sie auf der Suche nach einer Ursache verrückt werden.  Einmal quälte der Autor einen halben Tag lang, bis er feststellte, dass das Problem im schlechten Kabel sowie im launischen Schnittstellenkonverter CP2102 lag.  Sogar ein Mikrocontroller mit einem eingebauten Schnittstellenkonverter, zum Beispiel ATmega32u4, kann manchmal so ungezogen sein.  Jeder Arduino-Benutzer hat festgestellt, dass Fehler beim Hochladen von Skizzen nicht so selten sind.  Manchmal funktioniert die Aufzeichnung einwandfrei, und beim Lesen der Überprüfung wird ein Fehler festgestellt.  Dies bedeutet nicht, dass beim Schreiben ein Fehler aufgetreten ist - der Fehler war beim Lesen.  Stellen Sie sich nun vor, dass beim Arbeiten "über Funk" dasselbe passiert, jedoch viel häufiger. <br><br>  Nachdem der Autor verschiedene Wege ausprobiert hatte, um dieses Problem zu lösen, kam er auf Folgendes.  Das Gerät verfügt über einen 128-Kilobyte-Flash-Speicher mit SPI-Schnittstelle. Wir empfangen Daten über Kabel (denken Sie daran, dass der Autor bereits ein Gerät mit einem Anschluss an der Seite hat), verwenden diesen Speicher als Puffer und senden Daten über einen Funkkanal an ein anderes Gerät.  So ein Hallo von Cybiko. <br><br>  Nach dem Schreiben des Codes für die Arbeit mit dem Funkkanal sowie der Schriftart wurde der Bootloader länger als 4 Kilobyte.  Daher musste der HFUSE-Wert von 0xDA auf 0xD8 geändert werden.  Jetzt kann der Bootloader bis zu 8 Kilobyte lang sein und die Startadresse ist 0x1E000 geworden.  Dies spiegelt sich im Makefile wider, sollte jedoch beim Befüllen des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Bootloaders</a> mit avrdude berücksichtigt werden. <br><br>  Der 802.15.4-Standardtransceiver im ATmega128RFA1 wurde ursprünglich für den Betrieb mit dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ZigBee-</a> Protokoll entwickelt, was ziemlich kompliziert ist. Daher entschied sich der Autor, stattdessen einfach Pakete zu übertragen.  Dies ist Hardware, die im ATmega128RFA1 implementiert ist, daher ist ein bisschen Code erforderlich.  Der Einfachheit halber entschied sich der Autor auch für die Verwendung eines festen Kanals, sodass er ihn nicht einmal manuell auswählen konnte.  Der 802.15.4-Standard unterstützt 16 Kanäle mit Nummern von 11 bis 26. Sie sind ziemlich verstopft, einige überlappen auch WiFi-Kanäle (rot zeigt ZigBee-Kanäle an, blau, grün und gelb - WiFi). <br><br><img src="https://habrastorage.org/webt/nn/vx/fn/nnvxfnxaptwvpgbllq60zkfh2bq.png"><br><br>  Es stellte sich heraus, dass die Kanäle 15 und 26 am wenigsten anfällig für Störungen durch WLAN sind. Der Autor wählte den zweiten.  Haftungsausschluss: Der Übersetzer weiß nicht, ob ZigBee so vereinfacht ist.  Vielleicht lohnt es sich, etwas mehr zu programmieren und es vollständig umzusetzen? <br><br>  Auf dem ersten Gerät muss eine Zustandsmaschine implementiert werden, die Daten mithilfe des STK500-Protokolls überträgt.  Zum größten Teil sind gesendete und empfangene Nachrichten autark, aber einige sind an diejenigen gebunden, die den Kanal zuvor durchlaufen haben.  Eine Beschreibung des Dialogs finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . <br><br>  Ein wichtiger Bestandteil dieses Dialogs ist die Übertragung von Paketen zum Schreiben in den Flash-Speicher des Zielgeräts.  Einfache Mikrocontroller der AVR-Familie haben eine Seitengröße von 128 Byte, ATmega128RFA1 hat jedoch eine Größe von 256. Der Flash-Speicher, der über das SPI-Protokoll eine Verbindung herstellt, hat dieselbe Größe.  Das Programm im ersten Gerät überträgt beim Gießen der Skizze diese nicht sofort auf das zweite, sondern schreibt sie in diesen Speicher.  Wenn die Arduino IDE die Richtigkeit der Aufzeichnung überprüft, senden sie ihr, was dort geschrieben wurde.  Jetzt müssen Sie die empfangenen Daten drahtlos auf das zweite Gerät übertragen.  Gleichzeitig erfolgt häufig ein Wechsel vom Empfang zum Senden und umgekehrt.  Das STK500-Protokoll ist gegenüber Verzögerungen gleichgültig, toleriert jedoch keinen Datenverlust (seltsam, aber es wurde oben gesagt, dass Verzögerungen bei der Datenübertragung ebenfalls Auswirkungen haben).  Und Verluste bei der drahtlosen Übertragung sind unvermeidlich.  ATmega128RFA1 verfügt über eine integrierte Hardware-Implementierung für wiederholte Anforderungen mit Zweifeln an der korrekten Übertragung. Der Autor hat jedoch beschlossen, diese programmgesteuert selbst zu implementieren.  Er entwickelte ein Protokoll, bei dem viel mehr Daten in die eine als in die andere Richtung übertragen werden. <br><br>  Es ist unvollkommen, aber alles funktioniert.  Eine 256-Byte-Seite ist in vier Segmente unterteilt, von denen jedes als Paket über Funk übertragen wird.  Ein Paket enthält bis zu 125 Datenbytes plus eine Bytelänge und zwei CRC.  So werden dort 64 Byte lange Fragmente zusammen mit Seiten- und Segmentnummern (von 0 bis 3) platziert.  Auf dem empfangenden Gerät wird eine Variable bereitgestellt, mit der Sie verfolgen können, wie viele Segmente empfangen werden. Wenn alle vier eintreffen, wird eine Bestätigung an das sendende Gerät gesendet, dass die gesamte Seite empfangen wurde.  Keine Bestätigung (CRC stimmte nicht überein) - Senden Sie die gesamte Seite erneut.  Die Geschwindigkeit ist gleichzeitig noch höher als bei der Übertragung über Kabel.  Siehe: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/d-ObUCnRmQU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Tatsächlich wäre es jedoch erforderlich, eine bequeme Möglichkeit zum Anschließen von Kabelgeräten an die Geräte zum Ausfüllen von Skizzen und darauf bereitzustellen.  Setzen Sie beispielsweise einen solchen Schnittstellenkonverter wie auf dem Foto in CP2102 ein und kleben Sie ihn auf die Platine, damit er der Kraft beim Anschließen und Trennen des Micro-USB-Kabels standhält. <br><br><img src="https://habrastorage.org/webt/vd/qj/e7/vdqje7zvkvnkzoggl7nvoezzzry.jpeg"><br><br>  Es hat auch einen 3,3-Volt-Stabilisator (und wie man ihn in einem Gerät mit 6-Volt-Stromversorgung verwendet - wenn nur derselbe Stabilisator vorhanden ist und Sie zwei Dioden hinzufügen können, um automatisch auszuwählen, von welcher das Gerät mit Strom versorgt wird).  Alle drei LEDs sollten von der Schnittstellenkonverterplatine entfernt werden, da sie sonst die Batterien zusätzlich laden, wenn sie von ihnen aus arbeiten, und auch die Tastaturabfrage stören und mit dem Flash-Speicher der SPI-Schnittstelle arbeiten. <br><br>  Die Verfolgung des Ziels erwies sich als noch interessanter als seine Erreichung (und Sie brauchen diesen Witz über den Bus nicht).  Der Autor hat viel über Bootloader für AVR, Flash-Speicher mit SPI, STK500-Protokoll und 802.15.4-Standard gelernt. <br><br>  Der gesamte andere Code neben der oben beschriebenen Bibliothek befindet sich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> und befindet sich auch unter GPL v3.  Das Twitter des Autors ist <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de447026/">https://habr.com/ru/post/de447026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de447016/index.html">25 Jahre später: ein Interview mit Linus Torvalds</a></li>
<li><a href="../de447018/index.html">Quantenanreicherung in einer Multi-Welt-Interpretation</a></li>
<li><a href="../de447020/index.html">Bei Produktivität geht es nicht um Zeitmanagement, sondern um Aufmerksamkeitsmanagement</a></li>
<li><a href="../de447022/index.html">Zwingen Sie die Zuhörer nicht zum Nachdenken</a></li>
<li><a href="../de447024/index.html">Wie kann man die Vorteile eines Laptops und eines Desktop-Computers kombinieren? Analyse des Problems und Lösungen</a></li>
<li><a href="../de447028/index.html">Steganographie vergangene Dateien: Wir verstecken Daten direkt in Sektoren</a></li>
<li><a href="../de447034/index.html">Mit dem neuen Fehler in Telegram Desktop können Sie die letzte Nachricht lesen</a></li>
<li><a href="../de447036/index.html">Ein Cocktail für eine gesunde Ernährung - er wird von einem Startup des Beschleunigers der ITMO University hergestellt</a></li>
<li><a href="../de447038/index.html">In der Liste der Bedrohungen: „Game of Thrones“ - eine der beliebtesten Deckungen für Cyberkriminelle</a></li>
<li><a href="../de447040/index.html">Forschung: Die durchschnittlichen Kosten für Switches werden reduziert - wir verstehen warum</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>