<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§±üèø üßúüèº üë©üèº‚Äç‚úàÔ∏è Vtables C ++. Partie 2 (h√©ritage virtuel + code g√©n√©r√© par le compilateur) üéé ‚ò∫Ô∏è ‚òòÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La traduction de l'article a √©t√© pr√©par√©e sp√©cialement pour les √©tudiants du cours "D√©veloppeur C ++" . Est-il int√©ressant de se d√©velopper dans cette...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vtables C ++. Partie 2 (h√©ritage virtuel + code g√©n√©r√© par le compilateur)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/480610/"><p>  <em>La traduction de l'article a √©t√© pr√©par√©e sp√©cialement pour les √©tudiants du cours <a href="https://otus.pw/HhBg/">"D√©veloppeur C ++"</a> .</em>  <em>Est-il int√©ressant de se d√©velopper dans cette direction?</em>  <em>Regardez l'enregistrement de la classe de <a href="https://otus.pw/B2p1/">pratique de Google Test Framework</a> !</em> </p><br><p><img src="https://habrastorage.org/webt/tk/dp/8n/tkdp8nfahc7sglqks8sl_tazk1o.png"></p><br><h2 id="chast-3---virtualnoe-nasledovanie">  Partie 3 - H√©ritage virtuel </h2><br><p>  Dans les <a href="https://habr.com/ru/company/otus/blog/479802/">premi√®re et deuxi√®me parties de</a> cet article, nous avons parl√© du fonctionnement des vtables dans les cas les plus simples, puis en h√©ritage multiple.  L'h√©ritage virtuel complique encore plus la situation. <a name="habracut"></a></p><br><p>  Comme vous vous en souvenez peut-√™tre, l'h√©ritage virtuel signifie que dans une classe particuli√®re, il n'y a qu'une seule instance de la classe de base.  Par exemple: </p><br><pre><code class="plaintext hljs">class ios ... class istream : virtual public ios ... class ostream : virtual public ios ... class iostream : public istream, public ostream</code> </pre> <br><p>  Sans le mot-cl√© <code>virtual</code> ci-dessus, <code>iostream</code> fait deux instances d' <code>ios</code> qui pourraient causer des maux de t√™te pendant la synchronisation et seraient tout simplement inefficaces. </p><br><p>  Pour comprendre l'h√©ritage virtuel, nous consid√©rerons le fragment de code suivant: </p><br><pre> <code class="plaintext hljs">#include &lt;iostream&gt; using namespace std; class Grandparent { public: virtual void grandparent_foo() {} int grandparent_data; }; class Parent1 : virtual public Grandparent { public: virtual void parent1_foo() {} int parent1_data; }; class Parent2 : virtual public Grandparent { public: virtual void parent2_foo() {} int parent2_data; }; class Child : public Parent1, public Parent2 { public: virtual void child_foo() {} int child_data; }; int main() { Child child; }</code> </pre> <br><p>  Explorons l' <code>child</code> .  Je commencerai par vider une grande quantit√© de m√©moire exactement l√† o√π commence la <code>vtable Child</code> , comme nous l'avons fait dans les parties pr√©c√©dentes, puis j'analyserai les r√©sultats.  Je sugg√®re de jeter un coup d'≈ìil au r√©sultat ici et d'y revenir lorsque je divulguerai les d√©tails ci-dessous. </p><br><pre> <code class="plaintext hljs">(gdb) p child $1 = {&lt;Parent1&gt; = {&lt;Grandparent&gt; = {_vptr$Grandparent = 0x400998 &lt;vtable for Child+96&gt;, grandparent_data = 0}, _vptr$Parent1 = 0x400950 &lt;vtable for Child+24&gt;, parent1_data = 0}, &lt;Parent2&gt; = {_vptr$Parent2 = 0x400978 &lt;vtable for Child+64&gt;, parent2_data = 4195888}, child_data = 0} (gdb) x/600xb 0x400938 0x400938 &lt;vtable for Child&gt;: 0x20 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400940 &lt;vtable for Child+8&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400948 &lt;vtable for Child+16&gt;: 0x00 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400950 &lt;vtable for Child+24&gt;: 0x70 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400958 &lt;vtable for Child+32&gt;: 0xa0 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400960 &lt;vtable for Child+40&gt;: 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400968 &lt;vtable for Child+48&gt;: 0xf0 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0x400970 &lt;vtable for Child+56&gt;: 0x00 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400978 &lt;vtable for Child+64&gt;: 0x90 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400980 &lt;vtable for Child+72&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400988 &lt;vtable for Child+80&gt;: 0xe0 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0x400990 &lt;vtable for Child+88&gt;: 0x00 0x0b 0x40 0x00 0x00 0x00 0x00 0x00 0x400998 &lt;vtable for Child+96&gt;: 0x80 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x4009a0 &lt;VTT for Child&gt;: 0x50 0x09 0x40 0x00 0x00 0x00 0x00 0x00 0x4009a8 &lt;VTT for Child+8&gt;: 0xf8 0x09 0x40 0x00 0x00 0x00 0x00 0x00 0x4009b0 &lt;VTT for Child+16&gt;: 0x18 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x4009b8 &lt;VTT for Child+24&gt;: 0x98 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x4009c0 &lt;VTT for Child+32&gt;: 0xb8 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x4009c8 &lt;VTT for Child+40&gt;: 0x98 0x09 0x40 0x00 0x00 0x00 0x00 0x00 0x4009d0 &lt;VTT for Child+48&gt;: 0x78 0x09 0x40 0x00 0x00 0x00 0x00 0x00 0x4009d8: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x4009e0 &lt;construction vtable for Parent1-in-Child&gt;: 0x20 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x4009e8 &lt;construction vtable for Parent1-in-Child+8&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x4009f0 &lt;construction vtable for Parent1-in-Child+16&gt;: 0x50 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x4009f8 &lt;construction vtable for Parent1-in-Child+24&gt;: 0x70 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400a00 &lt;construction vtable for Parent1-in-Child+32&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400a08 &lt;construction vtable for Parent1-in-Child+40&gt;: 0xe0 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0x400a10 &lt;construction vtable for Parent1-in-Child+48&gt;: 0x50 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400a18 &lt;construction vtable for Parent1-in-Child+56&gt;: 0x80 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400a20 &lt;typeinfo name for Parent1&gt;: 0x37 0x50 0x61 0x72 0x65 0x6e 0x74 0x31 0x400a28 &lt;typeinfo name for Parent1+8&gt;: 0x00 0x31 0x31 0x47 0x72 0x61 0x6e 0x64 0x400a30 &lt;typeinfo name for Grandparent+7&gt;: 0x70 0x61 0x72 0x65 0x6e 0x74 0x00 0x00 0x400a38 &lt;typeinfo for Grandparent&gt;: 0x50 0x10 0x60 0x00 0x00 0x00 0x00 0x00 0x400a40 &lt;typeinfo for Grandparent+8&gt;: 0x29 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400a48: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400a50 &lt;typeinfo for Parent1&gt;: 0xa0 0x10 0x60 0x00 0x00 0x00 0x00 0x00 0x400a58 &lt;typeinfo for Parent1+8&gt;: 0x20 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400a60 &lt;typeinfo for Parent1+16&gt;: 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x400a68 &lt;typeinfo for Parent1+24&gt;: 0x38 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400a70 &lt;typeinfo for Parent1+32&gt;: 0x03 0xe8 0xff 0xff 0xff 0xff 0xff 0xff 0x400a78: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400a80 &lt;construction vtable for Parent2-in-Child&gt;: 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400a88 &lt;construction vtable for Parent2-in-Child+8&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400a90 &lt;construction vtable for Parent2-in-Child+16&gt;: 0xd0 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400a98 &lt;construction vtable for Parent2-in-Child+24&gt;: 0x90 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400aa0 &lt;construction vtable for Parent2-in-Child+32&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400aa8 &lt;construction vtable for Parent2-in-Child+40&gt;: 0xf0 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0x400ab0 &lt;construction vtable for Parent2-in-Child+48&gt;: 0xd0 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400ab8 &lt;construction vtable for Parent2-in-Child+56&gt;: 0x80 0x08 0x40 0x00 0x00 0x00 0x00 0x00 0x400ac0 &lt;typeinfo name for Parent2&gt;: 0x37 0x50 0x61 0x72 0x65 0x6e 0x74 0x32 0x400ac8 &lt;typeinfo name for Parent2+8&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400ad0 &lt;typeinfo for Parent2&gt;: 0xa0 0x10 0x60 0x00 0x00 0x00 0x00 0x00 0x400ad8 &lt;typeinfo for Parent2+8&gt;: 0xc0 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400ae0 &lt;typeinfo for Parent2+16&gt;: 0x00 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x400ae8 &lt;typeinfo for Parent2+24&gt;: 0x38 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400af0 &lt;typeinfo for Parent2+32&gt;: 0x03 0xe8 0xff 0xff 0xff 0xff 0xff 0xff 0x400af8 &lt;typeinfo name for Child&gt;: 0x35 0x43 0x68 0x69 0x6c 0x64 0x00 0x00 0x400b00 &lt;typeinfo for Child&gt;: 0xa0 0x10 0x60 0x00 0x00 0x00 0x00 0x00 0x400b08 &lt;typeinfo for Child+8&gt;: 0xf8 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400b10 &lt;typeinfo for Child+16&gt;: 0x02 0x00 0x00 0x00 0x02 0x00 0x00 0x00 0x400b18 &lt;typeinfo for Child+24&gt;: 0x50 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400b20 &lt;typeinfo for Child+32&gt;: 0x02 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400b28 &lt;typeinfo for Child+40&gt;: 0xd0 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400b30 &lt;typeinfo for Child+48&gt;: 0x02 0x10 0x00 0x00 0x00 0x00 0x00 0x00 0x400b38 &lt;vtable for Grandparent&gt;: 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x400b40 &lt;vtable for Grandparent+8&gt;: 0x38 0x0a 0x40 0x00 0x00 0x00 0x00 0x00 0x400b48 &lt;vtable for Grandparent+16&gt;: 0x80 0x08 0x40 0x00 0x00 0x00 0x00 0x00</code> </pre> <br><p>  Wow, il y a beaucoup d'informations.  Deux nouvelles questions surgissent tout de suite: qu'est-ce que le <code>VTT</code> et qu'est-ce que la construction <code>vtable for X-in-Child</code> ?  Nous leur r√©pondrons assez rapidement. <br>  Commen√ßons par la structure de la m√©moire enfant: </p><br><div class="scrollable-table"><table><thead><tr><th>  La taille </th><th>  Valeur </th></tr></thead><tbody><tr><td>  8 octets </td><td>  _vptr $ Parent1 </td></tr><tr><td>  4 octets </td><td>  parent1_data (+ 4 octets de remplissage) </td></tr><tr><td>  8 octets </td><td>  _vptr $ Parent2 </td></tr><tr><td>  4 octets </td><td>  parent2_data </td></tr><tr><td>  4 octets </td><td>  child_data </td></tr><tr><td>  8 octets </td><td>  _vptr $ Grand-parent </td></tr><tr><td>  4 octets </td><td>  grandparent_data (+ 4 octets de remplissage) </td></tr></tbody></table></div><br><p>  En effet, <code>Child</code> n'a qu'une seule instance de grand-parent.  La chose non triviale est qu'il est le dernier en m√©moire, bien qu'il soit le plus √©lev√© de la hi√©rarchie. <br>  Voici la structure de <code>vtable</code> : </p><br><div class="scrollable-table"><table><thead><tr><th>  L'adresse </th><th>  Valeur </th><th>  Table des mati√®res </th></tr></thead><tbody><tr><td>  0x400938 </td><td>  0x20 (32) </td><td>  d√©calage de la base virtuelle (nous en discuterons bient√¥t) </td></tr><tr><td>  0x400940 </td><td>  0 </td><td>  top_offset </td></tr><tr><td>  0x400948 </td><td>  0x400b00 </td><td>  typeinfo pour enfant </td></tr><tr><td>  0x400950 </td><td>  0x400870 </td><td>  Parent1 :: parent1_foo ().  Le pointeur vtable Parent1 pointe ici. </td></tr><tr><td>  0x400958 </td><td>  0x4008a0 </td><td>  Child :: child_foo () </td></tr><tr><td>  0x400960 </td><td>  0x10 (16) </td><td>  d√©calage de la base virtuelle </td></tr><tr><td>  0x400968 </td><td>  -16 </td><td>  top_offset </td></tr><tr><td>  0x4009 </td><td>  0x400b </td><td>  typeinfo pour enfant </td></tr><tr><td>  70 </td><td>  00 </td><td></td></tr><tr><td>  0x400978 </td><td>  0x400890 </td><td>  Parent2 :: parent2_foo ().  Le pointeur vtable Parent2 pointe ici. </td></tr><tr><td>  0x400980 </td><td>  0 </td><td>  d√©calage de la base virtuelle </td></tr><tr><td>  0x400988 </td><td>  -32 </td><td>  top_offset </td></tr><tr><td>  0x400990 </td><td>  0x400b00 </td><td>  typeinfo pour enfant </td></tr><tr><td>  0x400998 </td><td>  0x400880 </td><td>  Grand-parent :: grand-parent_foo ().  Le pointeur vtable Grand-parent pointe ici. </td></tr></tbody></table></div><br><p>  Ci-dessus, il y a un nouveau concept - l' <code>virtual-base offset</code> .  Bient√¥t, nous comprendrons ce qu'il fait l√†-bas. <br>  Ensuite, explorons ces <code>construction vtables</code> aspect <code>construction vtables</code> .  Voici la <code>vtable for Parent1-in-Child</code> construction <code>vtable for Parent1-in-Child</code> : </p><br><div class="scrollable-table"><table><thead><tr><th>  Valeur </th><th>  Table des mati√®res </th></tr></thead><tbody><tr><td>  0x20 (32) </td><td>  d√©calage de la base virtuelle </td></tr><tr><td>  0 </td><td>  d√©calage sup√©rieur </td></tr><tr><td>  0x400a50 </td><td>  typeinfo pour Parent1 </td></tr><tr><td>  0x400870 </td><td>  Parent1 :: parent1_foo () </td></tr><tr><td>  0 </td><td>  d√©calage de la base virtuelle </td></tr><tr><td>  -32 </td><td>  d√©calage sup√©rieur </td></tr><tr><td>  0x400a50 </td><td>  typeinfo pour Parent1 </td></tr><tr><td>  0x400880 </td><td>  Grand-parent :: grandparent_foo () </td></tr></tbody></table></div><br><p>  Pour le moment, je pense qu'il serait plus compr√©hensible de d√©crire le processus que d'empiler plus de tableaux avec des nombres al√©atoires sur vous.  Donc: </p><br><p>  Imaginez que vous √™tes un <code>Child</code> .  On vous demande de vous construire dans une nouvelle m√©moire.  Puisque vous <code>Grandparent</code> directement de <code>Parent1</code> - <code>Parent1</code> (ce que signifie l'h√©ritage virtuel), vous appellerez directement son constructeur directement (s'il ne s'agissait pas d'un h√©ritage virtuel, vous appelleriez le constructeur <code>Parent1</code> , qui √† son tour appellerait le constructeur de grand- <code>Parent1</code> ).  Vous d√©finissez <code>this += 32</code> octets, car c'est l√† que se trouvent les donn√©es des <code>Grandparent</code> et vous appelez le constructeur.  Tr√®s simple. </p><br><p>  Ensuite, il est temps de construire <code>Parent1</code> .  <code>Parent1</code> peut supposer en toute s√©curit√© qu'au moment o√π il se construit, <code>Parent1</code> a d√©j√† √©t√© cr√©√©, il peut donc, par exemple, acc√©der aux donn√©es et aux m√©thodes de grand-parent.  Mais attendez, comment peut-il savoir o√π trouver ces donn√©es?  Ils ne sont pas au m√™me endroit avec les variables <code>Parent1</code> ! </p><br><p>  La <code>construction table for Parent1-in-Child</code> entre en sc√®ne.  Ce tableau sert √† indiquer √† <code>Parent1</code> o√π trouver les √©l√©ments de donn√©es auxquels il peut acc√©der.  <code>this</code> pointe vers les donn√©es de <code>Parent1</code> .  <code>virtual-base offset</code> indique o√π vous pouvez trouver les donn√©es des grands-parents: √âtape 32 octets en avant √† partir de cela et vous trouverez la m√©moire des <code>Grandparent</code> .  Comprenez-vous?  le d√©calage de la base virtuelle est similaire √† top_offset, mais pour les classes virtuelles. </p><br><p>  Maintenant que nous comprenons cela, la construction de <code>Parent2</code> est fondamentalement la m√™me, en utilisant uniquement la <code>construction table for Parent2-in-Child</code> .  En effet, <code>Parent2-in-Child</code> a un <code>virtual-base offset</code> de <code>virtual-base offset</code> de 16 octets. </p><br><p>  Laissez les informations s'impr√©gner un peu.  √ätes-vous pr√™t √† continuer?  Bon. <br>  Revenons maintenant au <code>VTT</code> .  Voici la structure <code>VTT</code> : </p><br><div class="scrollable-table"><table><thead><tr><th>  L'adresse </th><th>  Valeur </th><th>  Symbole </th><th>  Table des mati√®res </th></tr></thead><tbody><tr><td>  0x4009a0 </td><td>  0x400950 </td><td>  vtable pour enfant + 24 </td><td>  Entr√©es Parent1 dans vtable Child </td></tr><tr><td>  0x4009a8 </td><td>  0x4009f8 </td><td>  construction vtable pour Parent1-in-Child + 24 </td><td>  M√©thodes Parent1 dans Parent1-in-Child </td></tr><tr><td>  0x4009b0 </td><td>  0x400a18 </td><td>  table de construction pour Parent1-in-Child + 56 </td><td>  M√©thodes des grands-parents pour Parent1-in-Child </td></tr><tr><td>  0x4009b8 </td><td>  0x400a98 </td><td>  construction vtable pour Parent2-in-Child + 24 </td><td>  M√©thodes Parent2 dans Parent2-in-Child </td></tr><tr><td>  0x4009c0 </td><td>  0x400ab8 </td><td>  construction vtable pour Parent2-in-Child + 56 </td><td>  `M√©thodes de grand-parent pour Parent2-in-Child </td></tr><tr><td>  0x4009c8 </td><td>  0x400998 </td><td>  vtable pour enfant + 96 </td><td>  `Entr√©es de grands-parents dans vtable Child </td></tr><tr><td>  0x4009d0 </td><td>  0x400978 </td><td>  vtable pour enfant + 64 </td><td>  `Entr√©es Parent2 dans vtable Child </td></tr></tbody></table></div><br><p>  <code>VTT</code> signifie <code>virtual-table table</code> , ce qui signifie que c'est une table virtuelle.  Il s'agit d'une table de traduction qui sait, par exemple, si le constructeur <code>Parent1</code> pour un objet individuel, pour l'objet <code>Parent1-in-Child</code> ou pour <code>Parent1-in-SomeOtherObject</code> .  Il appara√Æt toujours imm√©diatement apr√®s <code>vtable</code> , afin que le compilateur sache o√π le trouver.  Par cons√©quent, il n'est pas n√©cessaire de stocker un autre pointeur dans les objets eux-m√™mes. </p><br><p>  Fuh ... beaucoup de d√©tails, mais je pense que nous avons couvert tout ce que je voulais couvrir.  Dans la quatri√®me partie, nous parlerons des d√©tails des <code>vtables</code> niveau <code>vtables</code> .  Ne sautez pas, car c'est probablement la partie la plus importante de cet article! </p><br><h2 id="chast-4---kod-sgenerirovannyy-kompilyatorom">  Partie 4 - Code g√©n√©r√© par le compilateur </h2><br><p>  √Ä ce stade de cet article, nous avons appris comment les <code>typeinfo</code> <code>vtables</code> et <code>typeinfo</code> s'int√®grent dans nos binaires et comment le compilateur les utilise.  Nous allons maintenant comprendre la partie du travail que le compilateur fait pour nous automatiquement. </p><br><h4 id="konstruktory">  Constructeurs </h4><br><p>  Pour le constructeur de n'importe quelle classe, le code suivant est g√©n√©r√©: </p><br><ul><li>  Appel des constructions parent, le cas √©ch√©ant; </li><li>  D√©finir des pointeurs vtable, le cas √©ch√©ant; </li><li>  Initialisation des membres conform√©ment √† la liste des initialiseurs; </li><li>  Ex√©cution de code √† l'int√©rieur des crochets du constructeur. </li></ul><br><p>  Tout ce qui pr√©c√®de peut se produire sans code explicite: </p><br><ul><li>  Les constructeurs parents d√©marrent automatiquement par d√©faut, sauf indication contraire; </li><li>  Les membres sont initialis√©s par d√©faut s'ils n'ont pas de valeur ou d'entr√©es par d√©faut dans la liste d'initialisation; </li><li>  Le constructeur entier peut √™tre marqu√© = par d√©faut; </li><li>  Seule l'affectation vtable est toujours masqu√©e. </li></ul><br><p>  Voici un exemple: </p><br><pre> <code class="plaintext hljs">#include &lt;iostream&gt; #include &lt;string&gt; using namespace std; class Parent { public: Parent() { Foo(); } virtual ~Parent() = default; virtual void Foo() { cout &lt;&lt; "Parent" &lt;&lt; endl; } int i = 0; }; class Child : public Parent { public: Child() : j(1) { Foo(); } void Foo() override { cout &lt;&lt; "Child" &lt;&lt; endl; } int j; }; class Grandchild : public Child { public: Grandchild() { Foo(); s = "hello"; } void Foo() override { cout &lt;&lt; "Grandchild" &lt;&lt; endl; } string s; }; int main() { Grandchild g; }</code> </pre> <br><p>  √âcrivons un pseudo-code pour le constructeur de chaque classe: </p><br><div class="scrollable-table"><table><thead><tr><th>  Parent </th><th>  Enfant </th><th>  Petit-enfant </th></tr></thead><tbody><tr><td>  1. vtable = vtable Parent; </td><td>  1. Appelle le constructeur par d√©faut Parent; </td><td>  1. Appelle le constructeur par d√©faut Child; </td></tr><tr><td>  2. i = 0; </td><td>  2. vtable = vtable Enfant; </td><td>  2. vtable = petit-enfant vtable; </td></tr><tr><td>  3. Appelle Foo (); </td><td>  3. j = 1; </td><td>  3., Appelle le constructeur par d√©faut; </td></tr><tr><td></td><td>  4. Appelle Foo (); </td><td>  4. Appelle Foo (); </td></tr><tr><td></td><td></td><td>  5. Appelle l'op√©rateur = pour s; </td></tr></tbody></table></div><br><p>  Compte tenu de cela, il n'est pas surprenant que dans le contexte du constructeur de classe, vtable se r√©f√®re √† la vtable de cette classe elle-m√™me, et non √† sa classe sp√©cifique.  Cela signifie que les appels virtuels sont r√©solus comme s'il n'y avait pas d'h√©ritiers disponibles.  Ainsi, la conclusion </p><br><pre> <code class="plaintext hljs">Parent Child Grandchild</code> </pre> <br><p>  Qu'en est-il des fonctions virtuelles pures?  S'ils ne sont pas impl√©ment√©s (oui, vous pouvez impl√©menter des fonctions purement virtuelles, mais pourquoi en avez-vous besoin?), Vous irez probablement (et j'esp√®re) directement √† segfault.  Certains compilateurs n√©gligent l'erreur, ce qui est cool. </p><br><h4 id="destruktory">  Destructeurs </h4><br><p>  Comme vous pouvez l'imaginer, les destructeurs se comportent de la m√™me mani√®re que les constructeurs, uniquement dans l'ordre inverse. </p><br><p>  Voici un exercice rapide auquel r√©fl√©chir: pourquoi les destructeurs modifient-ils le pointeur vtable afin qu'il pointe vers sa propre classe, plut√¥t que de laisser un pointeur vers une classe sp√©cifique?  R√©ponse: puisque au moment du lancement du destructeur, toute classe h√©riti√®re √©tait d√©j√† d√©truite.  L'appel de m√©thodes de cette classe n'est pas ce que vous voulez faire. </p><br><h4 id="neyavnoe-privedenie">  Distribution implicite </h4><br><p>  Comme nous l'avons vu dans les <a href="https://habr.com/ru/company/otus/blog/479802/">deuxi√®me et troisi√®me parties</a> , un pointeur sur un objet enfant n'est pas n√©cessairement √©gal au pointeur parent de la m√™me instance (comme dans le cas de l'h√©ritage multiple). </p><br><p>  Cependant, pour vous (le d√©veloppeur), il n'y a pas de travail suppl√©mentaire pour appeler une fonction qui re√ßoit un pointeur parent.  En effet, le compilateur modifie implicitement <code>this</code> lorsque vous ajoutez des pointeurs et des r√©f√©rences aux classes parentes. </p><br><h4 id="dinamicheskoe-privedenie-rtti">  Distribution dynamique (RTTI) </h4><br><p>  Les <code>typeinfo</code> dynamiques utilisent des tables <code>typeinfo</code> , que nous avons examin√©es dans la premi√®re partie.  Ils le font au moment de l'ex√©cution, en regardant l'entr√©e <code>typeinfo</code> un pointeur avant vers quoi <code>vtable</code> pointeur <code>vtable</code> , et utilisent la classe √† partir de l√† pour v√©rifier si la conversion est possible. </p><br><p>  Cela explique le <a href="https://tinodidriksen.com/2010/04/14/cpp-dynamic-cast-performance/">co√ªt de dynamic_cast</a> lorsqu'il est utilis√© fr√©quemment. </p><br><h4 id="ukazateli-na-metody">  Pointeurs de m√©thode </h4><br><p>  Je pr√©vois d'√©crire un article complet sur les pointeurs vers les m√©thodes √† l'avenir.  Avant cela, je voudrais souligner qu'un pointeur vers une m√©thode qui pointe vers une fonction virtuelle appellera en fait une m√©thode red√©finie (par opposition aux pointeurs vers des fonctions qui ne sont pas membres). </p><br><pre> <code class="plaintext hljs">// TODO:  ,    </code> </pre> <br><h4 id="proverte-sebya">  V√©rifiez-vous! </h4><br><p>  Vous pouvez maintenant vous expliquer pourquoi le fragment de code suivant se comporte comme il se comporte: </p><br><pre> <code class="plaintext hljs">#include &lt;iostream&gt; using namespace std; class FooInterface { public: virtual ~FooInterface() = default; virtual void Foo() = 0; }; class BarInterface { public: virtual ~BarInterface() = default; virtual void Bar() = 0; }; class Concrete : public FooInterface, public BarInterface { public: void Foo() override { cout &lt;&lt; "Foo()" &lt;&lt; endl; } void Bar() override { cout &lt;&lt; "Bar()" &lt;&lt; endl; } }; int main() { Concrete c; c.Foo(); c.Bar(); FooInterface* foo = &amp;c; foo-&gt;Foo(); BarInterface* bar = (BarInterface*)(foo); bar-&gt;Bar(); //  "Foo()" - WTF? }</code> </pre> <br><p>  Ceci conclut mon article en quatre parties.  J'esp√®re que vous apprenez quelque chose de nouveau, tout comme moi. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480610/">https://habr.com/ru/post/fr480610/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480596/index.html">Ce qui vous attend dans le syst√®me d'exploitation de r√©seau innovant ArubaOS-CX</a></li>
<li><a href="../fr480598/index.html">La base de toute programmation sur ... des puzzles</a></li>
<li><a href="../fr480600/index.html">√ânum√©ration plus rapide</a></li>
<li><a href="../fr480606/index.html">Cinq autres id√©es sur la fa√ßon de mettre √† niveau vos comp√©tences en tant que d√©veloppeur frontal (d√©cembre 2019)</a></li>
<li><a href="../fr480608/index.html">Rust surpasse C ++ avec les r√©sultats du jeu Benchmarks</a></li>
<li><a href="../fr480612/index.html">Apportez ces modifications pour respecter les normes d'accessibilit√© de la conception Web.</a></li>
<li><a href="../fr480614/index.html">ENUM rapide</a></li>
<li><a href="../fr480618/index.html">Jeu √©lectronique Tic Tac Toe. O√π suis-je venu</a></li>
<li><a href="../fr480620/index.html">SD-WAN et DNA pour aider l'administrateur: caract√©ristiques des architectures et de la pratique</a></li>
<li><a href="../fr480622/index.html">Comment utiliser correctement la capacit√© de stockage disponible</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>