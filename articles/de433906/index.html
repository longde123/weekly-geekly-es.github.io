<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóÑÔ∏è ü§π üïç Probleme bei der Verwendung der NtQuerySystemInformation-Funktion mit undokumentierten Argumenten ü§öüèø üéø ü§∞üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Morgen an diesem Tag begann mit der Tatsache, dass ‚ÄûWenn‚Äú brach. Dieser Ausdruck wurde einmal von einem meiner Kollegen gepr√§gt, der demonstrierte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Probleme bei der Verwendung der NtQuerySystemInformation-Funktion mit undokumentierten Argumenten</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/infopulse/blog/433906/">  Der Morgen an diesem Tag begann mit der Tatsache, dass ‚ÄûWenn‚Äú brach.  Dieser Ausdruck wurde einmal von einem meiner Kollegen gepr√§gt, der demonstrierte, wie sein Debugger beim Durchlaufen des Codes in den if-Block gelangt, w√§hrend die Bedingung, dass das if √ºberpr√ºft wurde, genau falsch war.  Das Problem stellte sich damals als trivial heraus - er verwendete einen Release-optimierten Build, und in diesem Szenario ist das Vertrauen in das schrittweise Debuggen nat√ºrlich unm√∂glich.  Aber der Ausdruck ‚Äûwenn gebrochen‚Äú hat Wurzeln geschlagen und wird seitdem hier verwendet, um auf eine Situation hinzuweisen, in der etwas so Grundlegendes nicht mehr funktioniert, dass es kaum noch daran geglaubt wurde. <br><br>  An diesem Tag brach die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NtQuerySystemInformation-</a> Funktion zusammen - eine der wichtigsten Funktionen des Windows-Betriebssystems, die Informationen zu Prozessen, Threads, Systemdeskriptoren usw. zur√ºckgibt.  √úber die Vorteile dieser Funktion habe ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesen Artikel</a> einmal geschrieben.  Es stellte sich jedoch heraus, dass selbst solche Eckpfeiler eines Systems manchmal versagen k√∂nnen. <br><br>  Also, was ist passiert? <br><a name="habracut"></a><br>  Lange Zeit (bereits seit einigen Jahren) haben wir den Aufruf der Funktion NtQuerySystemInformation mit dem Argument SystemHandleInformation verwendet, um Informationen zu allen Deskriptoren im System abzurufen.  Ja, dieses Argument bezieht sich formal auf undokumentierte Argumente. Wenn Sie jedoch nach Informationen zum Auflisten aller Deskriptoren in allen derzeit ausgef√ºhrten Windows-Anwendungen suchen, ist die Kombination aus NtQuerySystemInformation + SystemHandleInformation die am h√§ufigsten vorgeschlagene Option.  Und es funktioniert wirklich auf allen Betriebssystemen, die mit Windows NT beginnen. <br><br>  Warum m√ºssen Sie m√∂glicherweise in allen Prozessen nach Deskriptoren suchen?  Nun, aus verschiedenen Gr√ºnden.  Dienstprogramme wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Process Hacker</a> zeigen sie nur zu Informationszwecken an.  Es gibt Programme, die dies tun, um nach einer Ressource zu suchen, die derzeit von jemandem blockiert wird (z. B. einer Datei).  Sie k√∂nnen beispielsweise einen Mutex im Prozess einer anderen Person finden, mit dem nur eine Kopie des Programms ausgef√ºhrt, geschlossen und zwei Instanzen einer solchen Anwendung gestartet werden k√∂nnen.  Oder listen Sie Deskriptoren auf, um sie zu duplizieren und die Sandbox zu organisieren.  Im Allgemeinen gibt es viele Aufgaben. <br><br>  Ich werde hier nicht die vollst√§ndige Beschreibung der Deskriptor-Aufz√§hlung geben, sondern nur sagen, dass sie im Allgemeinen g√§ngigen Beispielen wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesen</a> √§hnlich war: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((status = NtQuerySystemInformation( SystemHandleInformation, handleInfo, handleInfoSize, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> )) == STATUS_INFO_LENGTH_MISMATCH) handleInfo = (PSYSTEM_HANDLE_INFORMATION)<span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(handleInfo, handleInfoSize *= <span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-comment"><span class="hljs-comment">// NtQuerySystemInformation stopped giving us STATUS_INFO_LENGTH_MISMATCH. if (!NT_SUCCESS(status)) { printf("NtQuerySystemInformation failed!\n"); return 1; } for (i = 0; i &lt; handleInfo-&gt;HandleCount; i++) { ... }</span></span></code> </pre> <br>  Aber dann starte ich unsere Anwendung - und pl√∂tzlich stellt sich heraus, dass der Deskriptor, den ich brauche (und ich wei√ü sicher, dass er existiert!), Nicht in der Liste enthalten ist, die von der Funktion NtQuerySystemInformation () zur√ºckgegeben wird.  Das war's, sie kamen - "wenn es kaputt ist". <br><br>  Der Versuch, das Problem auf anderen Computern im B√ºro zu reproduzieren.  Bei einigen wird es reproduziert, bei der Mehrheit nicht.  Wir versuchen zu verstehen, wie sich diejenigen, auf denen es reproduziert, von denen unterscheiden, auf denen alles gut ist.  Die Windows-Version ist √ºberall gleich, Updates, der Build unseres Programms - alles ist identisch.  Pl√∂tzlich bemerkt jemand, dass alle Laptops, auf denen das Problem reproduziert wurde, vom selben Modell sind.  Hardware-Inkompatibilit√§t?  Aber warum funktionierte es jetzt pl√∂tzlich ... Au√üerdem gibt es im B√ºro andere Laptops des gleichen Modells, die jetzt funktionieren.  Sogar die Versionen der Ger√§tetreiber wurden verglichen - alles scheint gleich zu sein.  Aber auf einigen Laptops funktioniert alles, auf anderen nicht. <br><br>  Das Haarziehen am Kopf dauerte ungef√§hr einen halben Tag, bis ich versehentlich zwei Dinge bemerkte: <br><br><ol><li>  Die Prozess-PIDs, bei denen es sich aus irgendeinem Grund normalerweise um drei-, vier- oder f√ºnfstellige Zahlen auf meinem Computer handelt, sind sechsstellig geworden.  Es war seltsam genug, eine PID vom Typ 780936 zu sehen. Diese hatte ich vorher noch nicht bemerkt.  Dar√ºber hinaus war die Gesamtzahl der laufenden Prozesse v√∂llig ausreichend (bis zu hundert). </li><li>  Der Task-Manager auf der Registerkarte CPU zeigte die Gesamtzahl der Deskriptoren im System an - und es war riesig, mehr als 800.000. </li></ol><br>  F√ºr eine normale Anwendung ist es normal, hundert oder zwei Deskriptoren zu √∂ffnen.  Nun, tausend.  Bei aktiver Nutzung kann Chrome etwa 2000 √∂ffnen, Visual Studio kann 3000 bei gro√üen Projekten √∂ffnen. Aber wer hat 800 000 ge√∂ffnet?  Gl√ºcklicherweise k√∂nnen Sie mit dem zuvor erw√§hnten Process Hacker die Anzahl der Deskriptoren f√ºr jeden Prozess anzeigen und sogar die Liste der Prozesse nach der Anzahl der verwendeten Deskriptoren sortieren. <br><br>  Und was sehen wir?  Und wir sehen so etwas wie dieses Bild: <br><br><img src="https://habrastorage.org/webt/yz/zi/vt/yzzivtoy8-an-odiloby55oherc.png"><br><br>  Ich muss sagen, dass ich gerade den obigen Screenshot gemacht habe, also hat der erste in der Prozessliste "insgesamt" ungef√§hr 20.000 Deskriptoren.  Und als ich das Problem zum ersten Mal sah, waren es ungef√§hr 650.000. Und wer ist unser Held?  Bingo!  Dies ist der Prozess SynTPEnhService.exe. <br><br>  Und dann entwickelt sich das ganze R√§tsel in meinem Kopf.  SynTPEnhService.exe ist Teil des Synaptics-Touchpad-Treibers.  Es wurde nur auf Laptops eines bestimmten Modells in unserem B√ºro installiert, auf denen das Problem aufgetreten ist.  Eine kurze Beobachtung ergab, dass dieser Prozess alle 5 Sekunden den untergeordneten Prozess SynTPEnh.exe startet, der nach 1-2 Sekunden geschlossen wird.  Gleichzeitig enth√§lt der √ºbergeordnete Prozess weiterhin den Deskriptor des untergeordneten Prozesses, was zum Verlust von Deskriptoren f√ºhrt.  Einer nach dem anderen alle 5 Sekunden.  Dies sind 17.280 Deskriptoren pro Tag.  Lassen Sie den Computer eine Woche lang eingeschaltet, und jetzt haben Sie mehr als hunderttausend Hang-Deskriptoren.  Mein PC wurde l√§nger als einen Monat nicht neu gestartet - daher die PIDs neuer Prozesse mit Zahlen √ºber einer halben Million.  Dies erkl√§rt auch, warum das Problem auf einigen Laptops in unserem B√ºro reproduziert wurde, auf den anderen Laptops jedoch nicht: Einige meiner Kollegen haben ihre PCs jeden Tag neu gestartet, und jemand wie ich hat sie f√ºr die Nacht eingeschaltet gelassen . <br><br>  An dieser Stelle fiel mir √ºbrigens ein, dass ich bereits √ºber ein Problem mit den Synaptics-Touchpad-Treibern gelesen hatte.  Nach einigem Graben fand ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesen Artikel</a> von Bruce Dawson (viele √úbersetzungen seiner Artikel wurden zu unterschiedlichen Zeiten auf Habr√© ver√∂ffentlicht, aber nicht dieser spezifische).  Dort beschreibt er das Problem des Speicherverlusts aufgrund dieses endlosen Neustarts des SynTPEnh.exe-Prozesses, sagt jedoch nichts √ºber das Problem des Handle-Lecks aus, sodass sich mein Fund immer noch davon unterscheidet. <br><br><h3>  L√∂sung </h3><br>  Der Touchpad-Treiber "frisst" Hunderttausende von Deskriptoren - und was nun?  Und die Tatsache, dass die Funktion NtQuerySystemInformation (SystemHandleInformation, ...), die in den Tagen von Windows NT geschrieben wurde, einen recht begrenzten internen Puffer hatte (und hat).  Ich konnte nirgendwo einen genauen Hinweis auf seine Gr√∂√üe finden, aber offensichtlich war es nicht f√ºr eine Million Deskriptoren ausgelegt.  Infolgedessen gibt die Funktion sie "so viel wie m√∂glich" zur√ºck, was bedeutet, dass unter ihnen m√∂glicherweise die gew√ºnschte vorhanden ist oder nicht. <br><br>  Was tun?  Wie Rick aus der Zeichentrickserie ‚ÄûRick and Morty‚Äú sagte: ‚ÄûWenn Sie die Teleportation erfinden, entdecken Sie sofort eine unangenehme Sache: Sie sind die letzte Person im Universum, die sie erfunden hat.‚Äú  Wie sich herausstellte, erkannte Microsoft dieses Problem mit dem begrenzten Puffer in NtQuerySystemInformation, als es vor 20 Jahren mit dem Argument SystemHandleInformation aufgerufen wurde. Daher f√ºgten sie ab WindowsXP der Funktion NtQuerySystemInformation ein weiteres (und auch nicht dokumentiertes) Argument SystemExtendedHandleInformation hinzu.  Wenn Sie NtQuerySystemInformation (SystemExtendedHandleInformation, ...) aufrufen, werden alle Deskriptoren im System an Sie zur√ºckgegeben, unabh√§ngig davon, wie viele es gibt.  Nun, oder besser gesagt, ich wei√ü das nicht genau, vielleicht gibt es einige Einschr√§nkungen f√ºr dieses Argument, aber es ist sicher, dass er 800.000 Deskriptoren in einem Zustand zur√ºckgeben kann. <br><br>  Im Internet finden Sie Beispiele f√ºr die Verwendung von SystemExtendedHandleInformation, z. B. <a href="">dieses</a> .  Im Allgemeinen ist dort alles √§hnlich, andere Strukturen werden einfach verwendet, und das ist alles. <br><br>  Es war eine lehrreiche Geschichte √ºber die Verwendung von undokumentierten Argumenten des Widnows-Betriebssystems, die sehr n√ºtzlich sein kann, aber sorgf√§ltige Tests und die Vorbereitung auf nicht standardm√§√üige Probleme erfordert. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de433906/">https://habr.com/ru/post/de433906/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de433896/index.html">Maschinelles Lernen ist nicht schwierig. Genug daf√ºr f√ºr eine Woche ...</a></li>
<li><a href="../de433898/index.html">Digest MBLT DEV :: Ausgabe Nr. 200</a></li>
<li><a href="../de433900/index.html">ICQ ist tot. Es lebe ICQ?</a></li>
<li><a href="../de433902/index.html">Wiederholung f√ºr einen Programmierer: Warum es wichtig ist, √§hnliche Probleme zu l√∂sen</a></li>
<li><a href="../de433904/index.html">Jira DataCenter - was ist das? Wie funktioniert es Wie bereitstellen?</a></li>
<li><a href="../de433908/index.html">Tetris in C # in 100 Zeilen</a></li>
<li><a href="../de433910/index.html">Gedanken zu Rust 2019</a></li>
<li><a href="../de433912/index.html">M√∂chten Sie die besten Ingenieure gewinnen? Code √∂ffnen</a></li>
<li><a href="../de433916/index.html">Gehen Sie Gemeinschaft in Kasan und unsere Treffen</a></li>
<li><a href="../de433918/index.html">Warum ist das Web so kompliziert?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>