<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüíª ‚ùé üåî Minha Internet das Coisas: Guest Castle (Parte 2) üåé üë©‚Äçüè´ üîÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Oi GT! Tudo com a vinda e o passado! 
 Continuo a hist√≥ria de como conectei a fechadura da porta √† Internet. Comece aqui . 
 Muito obrigado a todos pe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Minha Internet das Coisas: Guest Castle (Parte 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/382677/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Oi GT! Tudo com a vinda e o passado! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Continuo a hist√≥ria de como conectei a fechadura da porta √† Internet. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comece aqui</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Muito obrigado a todos pelos coment√°rios. Realmente existem solu√ß√µes prontas, mas tamb√©m h√° v√°rias nuances que n√£o me permitiram us√°-las. Como um apartamento ainda n√£o √© um hotel, descartamos os castelos especializados imediatamente. Fechaduras com chaves, antenas para NFC, para n√£o assustar os vizinhos, tamb√©m n√£o consideramos. Nenhum cart√£o, token ou outro meio f√≠sico tamb√©m pode ser usado; entende-se que n√£o h√° como transferi-los para um h√≥spede antes que ele abra a porta.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kevo, August ou Lockitron n√£o puderam ser utilizados, porque eles s√£o baseados no tipo americano de trava (trava), que n√£o √© muito bem instalada em uma porta de a√ßo com 65 a 70 mm de espessura. Nossa escolha √© o CISA eletromec√¢nico para portas blindadas, ao pre√ßo de cerca de 500 euros (ainda n√£o comprado, porque caro). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
E o mais importante, quero fazer algo com minhas pr√≥prias m√£os, para n√£o ser ego√≠sta por causa das correntes do hobby.</font></font><br>
<img src="https://habrastorage.org/files/12f/2b5/6a3/12f2b56a3cae496d9f3717839e37cea1.JPG"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Deixe-me lembr√°-lo de que o controlador de bloqueio est√° localizado atr√°s do NAT na rede dom√©stica local e, portanto, n√£o faz sentido aumentar o servidor da web no Arduin, √© imposs√≠vel acess√°-lo pela Internet. O servidor √© escrito em Python usando a estrutura Twisted, √© executado no Linux em outro local onde existe um endere√ßo IP real, e o controlador se conecta a ele e aguarda comandos. </font></font><br>
<img src="https://habrastorage.org/files/c3a/803/92b/c3a80392b83f4a0382e764ad8afa142e.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora eu quero falar sobre a l√≥gica do trabalho e da criptografia. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
N√£o encontrei algo que criptografasse o tr√°fego da Arduina, porque as comunica√ß√µes do castelo e do servidor passar√£o por canais abertos com tr√°fego n√£o criptografado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No primeiro prot√≥tipo, usei o MD5, agora mudei para SHA-1, aqui nesta biblioteca </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cryptosuite</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Consome menos mem√≥ria e j√° existe uma fun√ß√£o HMAC pronta.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A chave √© uma senha de at√© 30 caracteres ASCII, armazenada na mem√≥ria EEPROM do controlador. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No primeiro prot√≥tipo, a mesma senha foi armazenada explicitamente no servidor, o que obviamente n√£o √© seguran√ßa. O segundo prot√≥tipo exigia duas senhas. O primeiro √© autenticar o bloqueio ao conectar-se ao servidor; voc√™ n√£o pode abrir o bloqueio com essa senha; √© necess√°rio para que apenas os bloqueios corretos possam se conectar ao servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O bloqueio se conecta ao servidor e, antes de tudo, informa seu identificador. O servidor verifica no banco de dados se existe esse bloqueio e, se houver, envia uma sequ√™ncia ASCII gerada aleatoriamente em resposta. A trava ‚Äúassina‚Äù com uma senha e envia o hash de volta. O servidor compara o hash recebido com o que calculou por si pr√≥prio e, se corresponderem, autorizar√° o controlador conectado como um "bloqueio".</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Caso contr√°rio, a conex√£o √© redefinida. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A segunda senha j√° √© uma chave digital, n√£o est√° armazenada no servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Funciona da seguinte forma: o aplicativo do usu√°rio chama pela fun√ß√£o SOAP no servidor, indica o ID do bloqueio e o comando que ele deseja enviar. Como resultado, a fun√ß√£o retorna o ID da solicita√ß√£o. O servidor encaminha esse comando ao controlador, o controlador envia uma sequ√™ncia ASCII gerada aleatoriamente em resposta e aguarda a resposta "correta" por alguns segundos. Em seguida, o aplicativo do usu√°rio precisa obt√™-lo do servidor, atrav√©s do mesmo SOAP por ID da solicita√ß√£o, assin√°-lo com uma chave digital e envi√°-lo de volta. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O controlador compara o hash recebido com o calculado por conta pr√≥pria e, se corresponderem, executa o comando recebido anteriormente, que √© relatado ao servidor.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O tempo para confirmar o comando √© limitado a 2 segundos; se nenhuma resposta for recebida durante esse per√≠odo, o controlador ignorar√° o comando recebido anteriormente. Se os hashes n√£o corresponderem, o comando tamb√©m ser√° ignorado. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Assim, tento me proteger do ataque do ‚Äúhomem do meio‚Äù, que √© muito f√°cil de organizar nos fios do meu provedor. A conex√£o √© simples, sem senhas e certificados, basta cortar o par tran√ßado no escudo, apert√°-lo nos dois lados, conect√°-lo √† rede pelo lado do apartamento com o endere√ßo IP do servidor de comando, emular a trava na outra extremidade (tamb√©m escrevi um script para emula√ß√£o no python para depura√ß√£o ), tendo organizado um "firewall" com escutas telef√¥nicas. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A este respeito, na minha opini√£o, o castelo mostrou-se bastante protegido.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Mesmo invadir o servidor de comando e roubar seu banco de dados com senhas para autoriza√ß√£o pelo bloqueio n√£o causar√° muitos problemas, porque eles n√£o podem abrir o bloqueio. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Resta apenas lidar com os convidados. Estes s√£o os requisitos n¬∫ 6-8 do primeiro artigo. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Teclados, proxies, RFID e NFC n√£o s√£o uma op√ß√£o, o que foi mencionado acima. Mas quase todo mundo tem um smartphone e todos os smartphones t√™m Bluetooth, a escolha √© √≥bvia! </font></font><br>
<img src="https://habrastorage.org/files/d2a/1bd/1b0/d2a1bd1b0a2a4f81a906fba3e2640b5e.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No primeiro prot√≥tipo, um convidado foi associado a um √∫nico c√≥digo de acesso. No banco de dados do servidor para esse c√≥digo, foi armazenado o ID do bloqueio, a data e a hora do in√≠cio e do final do acesso do convidado, bem, um campo de texto para o nome leg√≠vel por humanos do convidado.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O h√≥spede chega ao castelo, lan√ßa o aplicativo m√≥vel em seu smartphone, envia um c√≥digo de acesso via Bluetooth ao controlador, uma mensagem chega do controlador ao servidor informando que um h√≥spede o abordou com esse c√≥digo de acesso. O servidor verifica o banco de dados e, se o convidado correto chegou no momento certo e no lugar certo, envia o comando para abrir o bloqueio. De fato, em vez do c√≥digo de acesso claro, o convidado enviar√° um hash HMAC assinado com um "carimbo tempor√°rio" (uma representa√ß√£o de sequ√™ncia do tempo do Unix dividida por 30 com a parte fracion√°ria descartada). O servidor para verifica√ß√£o faz uma solicita√ß√£o ao banco de dados com uma sele√ß√£o de todos os c√≥digos de acesso atualmente v√°lidos para um determinado bloqueio, itera e calcula um HMAC semelhante para eles, se encontrar uma correspond√™ncia, envia um comando para abrir,se a pesquisa de c√≥digos de acesso terminar antes que uma correspond√™ncia seja encontrada, uma resposta negativa ser√° enviada ao bloqueio na tentativa de abri-lo.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O problema √© que a chave digital para tal autoriza√ß√£o tinha que ser armazenada no servidor. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Eu tive que complicar a autoriza√ß√£o de "convidado" para o segundo prot√≥tipo. O c√≥digo de acesso do convidado agora consiste em duas chaves, vamos cham√°-las de "servidor" e "privado". O servidor √© necess√°rio para estabelecer uma conta de convidado no servidor e privado para abrir o pr√≥prio bloqueio. A sala do servidor ser√° armazenada explicitamente no servidor e a privada ter√° apenas um hash, mas n√£o um simples, mas um HMAC com uma chave digital na fechadura. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Agora, a sess√£o de autoriza√ß√£o de convidado √© assim: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. O aplicativo convidado envia a chave "server" para o controlador (como no primeiro prot√≥tipo, seu hash) e </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. O servidor verifica da mesma maneira, mas, em vez do comando open, envia o hash da chave privada</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. O controlador compara o hash da chave privada recebida do servidor com o calculado independentemente e, se corresponder, o bloqueio ser√° aberto. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Portanto, o servidor n√£o armazena nada que possa abrir o bloqueio. N√£o funcionar√° para gerar o hash desejado sem conhecer a chave digital. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
O mesmo Bluetooth tamb√©m √© usado para acesso "principal" sem a Internet. O controlador recebe comandos atrav√©s dele, responde com um c√≥digo √∫nico, que deve ser assinado com a chave digital correta por 2 segundos.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Atrav√©s dele, quero fazer as configura√ß√µes b√°sicas do controlador. </font><font style="vertical-align: inherit;">O propriet√°rio pressiona um bot√£o especial no controlador, ap√≥s o qual ele come√ßa a aceitar um conjunto estendido de comandos, como definir o ID de bloqueio, chaves secretas, endere√ßo da porta do servidor, configura√ß√µes de rede etc. </font><font style="vertical-align: inherit;">Mas em Adruin a mem√≥ria acabou e o esbo√ßo n√£o se encaixa. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No final, uma breve demonstra√ß√£o do trabalho.</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://www.youtube.com/embed/dfSnXt631KQ%3Ffeature%3Doembed&amp;usg=ALkJrhhToxoh90eJOPIxlCOArmSXZc-Xzw" frameborder="0" allowfullscreen=""></iframe></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt382677/">https://habr.com/ru/post/pt382677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt382665/index.html">Estrat√©gias e t√°ticas de email marketing. Parte 1</a></li>
<li><a href="../pt382667/index.html">Intel anuncia o primeiro processador de notebooks Xeon</a></li>
<li><a href="../pt382669/index.html">Um limpador. Combate a softwares impuros</a></li>
<li><a href="../pt382673/index.html">Aibo Robot Dog Mortalidade</a></li>
<li><a href="../pt382675/index.html">Pregui√ßas gigantes do passado poderiam estabelecer linhas de metr√¥</a></li>
<li><a href="../pt382679/index.html">Os astr√¥nomos conseguiram tirar fotos do lago de lava na superf√≠cie de Io, o sat√©lite de J√∫piter</a></li>
<li><a href="../pt382681/index.html">5 horas da abordagem da Soyuz √† ISS - em um v√≠deo de meio minuto no YouTube</a></li>
<li><a href="../pt382685/index.html">Olhe al√©m do horizonte</a></li>
<li><a href="../pt382687/index.html">Cientistas do CERN est√£o preparando um "campo de for√ßa" para proteger os astronautas da radia√ß√£o</a></li>
<li><a href="../pt382689/index.html">Controlamos a ilumina√ß√£o do apartamento (NooLite, Raspberry Pi e WebIOPi)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>