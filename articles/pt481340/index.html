<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöò ‚òùüèø üíπ 7 dias, 15 engenheiros e 600 servidores: Yandex.Money mudou-se para um novo data center üôç ü¶ë üë©üèΩ‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, ocorreu um evento significativo no Departamento de Opera√ß√µes Yandex.Money. Nossa empresa est√° crescendo rapidamente e constatou-se que n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>7 dias, 15 engenheiros e 600 servidores: Yandex.Money mudou-se para um novo data center</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yamoney/blog/481340/"><img src="https://habrastorage.org/webt/_d/ye/aq/_dyeaqhvhl5sh0awhpgw7t70b38.jpeg"><br><br>  Recentemente, ocorreu um evento significativo no Departamento de Opera√ß√µes Yandex.Money.  Nossa empresa est√° crescendo rapidamente e constatou-se que n√£o apenas nossos cora√ß√µes, mas tamb√©m a demanda do data center mudam.  Mais precisamente, o local exigia altera√ß√µes.  E agora por tr√™s meses, como um dos data centers mora em um novo local. <br><br>  Sobre como o Yandex.Money mudou para um novo data center, vou lhe dizer, o chefe do departamento de opera√ß√µes e Ivan, o chefe do departamento de infraestrutura de TI e sistemas internos. <br><br>  Sob o corte - uma cronologia de eventos, marcos importantes do movimento, curvas inesperadas e debriefing.  Compartilhamos como sobrevivemos a isso. <br><a name="habracut"></a><br><h2>  Pr√©-requisitos para realoca√ß√£o </h2><br>  Anteriormente, um dos datacenters Yandex.Money estava localizado no sub√∫rbio de Moscou.  A realidade √© que, fora da cidade, nem todos os provedores de canais de comunica√ß√£o √≥ptica t√™m a capacidade de estabelecer rotas a cabo de forma independente - √© caro.  E a primeira raz√£o para a nossa decis√£o de mudar foi devido ao fato de que, nos antigos canais de comunica√ß√£o do data center, passavam pelas mesmas rotas, e isso trazia riscos adicionais. <br><blockquote> Dentro do anel vi√°rio de Moscou, existem muitos fornecedores e o sistema de cabos est√° bem desenvolvido.  Voc√™ pode comprar canais de diferentes fornecedores, de maneiras diferentes e que n√£o se sobrep√µem.  H√° riscos crescentes na regi√£o - por exemplo, uma escavadeira vir√° e cavar√° todas as trilhas de uma s√≥ vez. </blockquote><br>  Em segundo lugar, o data center anterior apresentava limita√ß√µes tecnol√≥gicas, incluindo periodicamente problemas de fornecimento de energia. <br><br>  Mas a principal raz√£o (= dor) √© a incapacidade de expandir.  Isso significava que o pr√©dio ficou sem espa√ßo para racks adicionais, onde foi poss√≠vel colocar novos equipamentos.  Isso est√° diretamente relacionado ao nosso ambiente produtivo, porque o Yandex.Money possui dois data centers e eles devem ser sim√©tricos em termos de capacidades. <br><br><h2>  Planejamento </h2><br>  A prepara√ß√£o para a mudan√ßa foi dividida em etapas: <br><br><ul><li>  Competi√ß√µes: DC, canais, redes, racks, PDUs, cabos; </li><li>  Transferir aplicativos e bancos de dados para o 2¬∫ DC; </li><li>  Ensinamentos - desabilitando a CD; </li><li>  Nova arquitetura de redes principais, IX; </li><li>  Configurando um novo n√∫cleo de rede no controlador de dom√≠nio. </li></ul><br><br><h4>  Sele√ß√£o de Fornecedores </h4><br>  O primeiro data center Yandex.Money est√° localizado em Moscou.  E, para evitar grandes atrasos na rede, decidimos colocar o segundo data center pr√≥ximo ao primeiro. <br><blockquote>  Dentro do MKAD, para minimizar os atrasos na rede e n√£o mais de 20 km da primeira instala√ß√£o, para garantir a independ√™ncia dos dois data centers da mesma infraestrutura urbana e poss√≠veis desastres tecnol√≥gicos ou naturais. </blockquote><br>  Ao analisar o mercado, fomos guiados por um crit√©rio t√£o importante como a certifica√ß√£o de data centers em termos de disponibilidade e confiabilidade.  O padr√£o mais comum na R√∫ssia e no mundo √© o desenvolvido pelo Uptime Institute, que audita data centers em todo o mundo.  Vale ressaltar que existem muitos data centers que certificaram apenas a documenta√ß√£o do projeto, mas isso n√£o significa que o pr√≥prio data center seja constru√≠do, testado e operado de acordo com os padr√µes. <br><blockquote>  Um caso de nossa pr√°tica: um provedor de servi√ßos de data center em Moscou nos anunciou que o projeto do data center atende ao padr√£o de N√≠vel III e se ofereceu para concluir um contrato com a promessa de 100% de disponibilidade, ou seja, 0 minutos de inatividade por ano!  Tendo visitado pessoalmente o site, percebemos que n√£o h√° certifica√ß√µes oficiais que garantam o n√≠vel de qualidade, e a infraestrutura claramente n√£o se baseia no N√≠vel III.  O data center estava localizado no t√©rreo de um pr√©dio residencial, e o √∫nico gerador-reboque ficava na rua sem nenhuma prote√ß√£o f√≠sica. </blockquote><br>  Portanto, nos requisitos para a competi√ß√£o, inclu√≠mos n√£o apenas a certifica√ß√£o do projeto, mas tamb√©m a certifica√ß√£o dos processos de implementa√ß√£o e gerenciamento. <br><br>  Al√©m disso, determinamos com fornecedores de canais de comunica√ß√£o √≥ptica entre nossos CDs e canais para pontos de troca de tr√°fego (IX) onde organizamos interfaces com fornecedores ou nossos parceiros.  O principal crit√©rio era que os canais de comunica√ß√£o √≥ptica fossem independentes, seguissem diferentes rotas. <br><br>  E, √© claro, houve outras compras - principalmente equipamentos de rede, racks (gabinetes especializados para instala√ß√£o de servidores), unidade de distribui√ß√£o de energia (unidades inteligentes de distribui√ß√£o de energia), al√©m de cabos e cabos de conex√£o. <br><br>  Vale ressaltar que selecionamos com cuidado o fornecedor que transportar√° o equipamento.  √â importante que a empresa tenha experi√™ncia no transporte de servidores, e os operadores entendam que isso n√£o √© mob√≠lia e carga, e voc√™ tamb√©m deve ter um cuidado especial ao dirigir.  Al√©m disso, asseguramos o equipamento transportado em caso de danos durante o transporte. <br><br><h4>  Atualiza√ß√£o da infraestrutura de rede </h4><br>  Em rela√ß√£o √† infraestrutura de rede, t√≠nhamos duas op√ß√µes.  O primeiro √© transportar equipamentos de rede antigos "como est√£o".  O segundo √© criar primeiro uma nova infraestrutura de rede em um novo data center e, somente ent√£o, transportar o equipamento do servidor. <br><br>  Como entendemos que j√° hav√≠amos ‚Äúencontrado‚Äù a largura de banda da rede no antigo datacenter e precis√°vamos da reserva e da capacidade de escalabilidade por pelo menos os pr√≥ximos 3-5 anos, foi decidido construir uma infraestrutura de rede no novo datacenter do zero e atualizar para uma nova gera√ß√£o de equipamentos . <br><br>  Aderimos ao modelo cl√°ssico ao construir uma rede em um novo data center.  Em cada rack, os servidores s√£o conectados a dois comutadores de acesso, que, por sua vez, s√£o conectados aos comutadores de agrega√ß√£o central (eles tamb√©m s√£o o n√∫cleo da rede). <br><br><img src="https://habrastorage.org/webt/wt/hw/mq/wthwmq0qnhd8bajvhxsu8fhzode.png"><br><br><h4>  Ensinamentos </h4><br>  Ao mudar, decidimos desligar completamente o datacenter, ao mesmo tempo para transportar tudo e ativ√°-lo em um novo local.  Para isso, a empresa precisou aprender a lidar com um dos dois data centers.  Foi necess√°ria a participa√ß√£o de quase todos os nossos administradores para que os sistemas de informa√ß√£o em plataformas diferentes, em sistemas operacionais diferentes, com bancos de dados diferentes funcionassem ininterruptamente no site restante. <br><blockquote>  Para os servi√ßos mais cr√≠ticos, foi fornecida uma reserva que permaneceu dispon√≠vel mesmo com um data center desativado. </blockquote><br>  Depois de realizar o trabalho de reserva, come√ßaram os exerc√≠cios.  Primeiro, desconectamos redes, segmentos e somente ent√£o o data center completamente.  Em 2019, realizamos um desligamento de teste do data center 10 vezes - vimos como nossos 300 sistemas de informa√ß√£o se comportam.  Verificando repetidamente a autonomia, est√°vamos convencidos de que podemos desconectar facilmente. <br><br>  E ent√£o ... <br><br><h2>  Semana X </h2><br>  Uma das sextas-feiras estava programada para desligar todos os equipamentos do data center - os √∫ltimos lan√ßamentos foram lan√ßados pela manh√£ e, em seguida, uma morat√≥ria foi anunciada neles. <br><blockquote>  O Yandex.Money pode ter 60 ou mais libera√ß√µes por dia e todas elas s√£o conduzidas para os dois data centers. </blockquote><br>  Interrompemos os lan√ßamentos, garantimos que o sistema esteja funcionando de maneira est√°vel e que nenhuma corre√ß√£o seja necess√°ria em nossos componentes.  A partir das 15:00, come√ßaram a extinguir gradualmente todos os aplicativos, bancos de dados e servidores.  Durante a noite, de sexta a s√°bado, esperamos um tempo, est√°vamos convencidos de que nada de ruim estava acontecendo, o que significa que podemos ir.  Na manh√£ de s√°bado, uma equipe de 15 pessoas come√ßou a desmontar o equipamento e transport√°-lo para o novo data center. <br><br><img src="https://habrastorage.org/webt/aw/hb/oe/awhboefkhxui5klua789j7ec3nm.png"><br><br>  Levamos o dia todo s√°bado para desmontar e transportar o equipamento.  Em seguida, iniciou o processo de instala√ß√£o do equipamento, comuta√ß√£o e conex√£o √† fonte de alimenta√ß√£o. <br><br><img src="https://habrastorage.org/webt/ry/uz/h4/ryuzh4vxihy3vqokvj_ex2_-oam.png"><br><br>  No s√°bado √† noite, montamos e conectamos o primeiro lote de servidores.  O trabalho principal come√ßou no domingo - na noite do fim de semana quase todo o equipamento foi instalado.  E terminamos a comuta√ß√£o apenas na segunda-feira √† noite. <br><br><img src="https://habrastorage.org/webt/bp/hz/ci/bphzci1xww3exwjgcnddnyhxvku.png"><br><br>  Na ter√ßa-feira de manh√£, realizamos os testes finais de redes, canais de comunica√ß√£o e est√°vamos prontos para elevar nossos sistemas.  Eles come√ßaram a aumentar o primeiro lote de servidores, mas algo deu errado ... <br><br>  Come√ßamos a receber reclama√ß√µes em massa dos administradores de que a rede n√£o funcionava nos servidores: completamente ou uma das duas interfaces.  Eles come√ßaram a procurar problemas no lado dos equipamentos de rede, nos sistemas operacionais, nas configura√ß√µes dos sistemas operacionais. <br><br>  Os sintomas eram semelhantes - eles come√ßaram a olhar para o que poderia ser o motivo.  Percebemos que vale a pena mover os cabos de conex√£o ao lado das portas do switch com mais for√ßa e alguns dos links de trabalho se apagam. <br><br><img src="https://habrastorage.org/webt/r-/l8/mx/r-l8mxy3b8vndwvgcxu_572lfny.gif"><br><br>  Tendo descoberto isso, percebemos que uma parte significativa desses cabos de conex√£o (cerca de 40% das 2.000 pe√ßas) estava com defeito.  Movemos todos os patch cords dispon√≠veis de outro fabricante confi√°vel para um novo data center e come√ßamos urgentemente a reconectar os servidores mais cr√≠ticos.  Demorou mais um dia. <br><br>  Desde a noite de quarta-feira na manh√£ de quinta-feira, a equipe come√ßou a levantar o principal bloco de sistemas de informa√ß√£o. <br><br>  Depois que levantamos os servi√ßos cr√≠ticos e lan√ßamos a reserva do sistema de pagamento, inclu√≠mos parte das bancas de testes do novo data center e da reserva dos sistemas de backoffice para que todos os nossos sistemas internos funcionem com dois data centers.  No final da semana, quase toda a infraestrutura de TI do data center transportado foi lan√ßada. <br><br>  Inicialmente, havia um plano para 5 dias, mas com uma situa√ß√£o de conting√™ncia relacionada a patch cords defeituosos, era uma semana.  Abaixo, pintamos claramente a linha do tempo de nossas a√ß√µes. <br><br>  <b>Plano de realoca√ß√£o - pendente:</b> <br><br><ul><li>  Sexta-feira - extinguimos redes e aplicativos; </li><li>  S√°bado - realizamos e iniciamos a montagem; </li><li>  Domingo - instala√ß√£o de servidores, lan√ßamento de redes; </li><li>  Segunda-feira - terminamos a rede, lan√ßamos aplicativos; </li><li>  Ter√ßa-feira - ligue tudo. </li></ul><br><br>  <b>Realidade:</b> <br><br><ul><li>  Sexta-feira - extinguimos redes e aplicativos; </li><li>  S√°bado - realizamos e iniciamos a montagem; </li><li>  Domingo - instala√ß√£o de servidores, lan√ßamento de redes; </li><li>  <font color="red">Segunda-feira - cabeamento, lan√ßamento de rede;</font> </li><li>  Ter√ßa-feira - ligue os servidores, <font color="red">mais de 100 n√£o funcionam;</font> </li><li>  Quarta-feira - <font color="red">casamento em fios, substitui√ß√£o</font> , lan√ßamento de App e DB; </li><li>  Quinta-feira - terminou a substitui√ß√£o do PS, inicie o aplicativo. </li></ul><br><br><h2>  Vida depois de se mudar </h2><br>  <b>O que conseguimos com a mudan√ßa?</b> <br>  Antes de tudo, agora os dois data centers est√£o no n√≠vel do Uptime Tier III Institute.  Os fornecedores de data centers nos garantem um n√≠vel de disponibilidade de Uptime de 99,982%, o que equivale a 1,6 horas de tempo de inatividade por ano.  Estamos confiantes na confiabilidade dos canais de comunica√ß√£o entre nossos sites.  Agora tamb√©m n√£o h√° restri√ß√µes para expandir nossa infraestrutura de TI. <br><br>  A id√©ia de mudar nos deu uma grande oportunidade de atualizar o equipamento de rede em termos de largura de banda.  Tamb√©m refatoramos fontes de alimenta√ß√£o em racks - instalamos ‚ÄúPDUs inteligentes‚Äù, servidores de energia reservados. <br><br>  E quando nos mudamos, fomos capazes de ‚Äúpentear‚Äù a comuta√ß√£o, e agora ela parece mais limpa. <br><br><img src="https://habrastorage.org/webt/si/er/bg/sierbgikqjvev60m0geubzlxjr0.png"><br><br>  Portanto, em geral, o sistema come√ßou a funcionar mais est√°vel e nossos clientes recebem um melhor servi√ßo. <br><br>  <b>Que conclus√µes voc√™ tirou para si mesmo?</b> <br>  Ao realizar grandes projetos, voc√™ precisa pensar nos riscos, imaginar quais podem ser as armadilhas.  Nosso exemplo com cabos Ethernet mostrou que n√£o √© suficiente fazer uma compra de teste e testar os produtos de cabo do fabricante selecionado.  Para reduzir os riscos, foi necess√°rio realizar testes aleat√≥rios de um lote de 2000 cabos. <br><br>  Tamb√©m vale a pena considerar que alguns servidores podem n√£o sobreviver √† mudan√ßa e simplesmente n√£o s√£o ativados por v√°rios motivos.  De uma maneira ou de outra, a estrada est√° tremendo e com um estresse mec√¢nico.  Das 600 unidades de equipamentos transportados, 6 blocos quebraram.  De um n√∫mero suficientemente grande de servidores, apenas 1% sofreu, nem um √∫nico disco travou - acreditamos que este √© um excelente resultado. <br><br><hr><br>  Foi assim que o data center Yandex.Money mudou-se para um novo local.  Esperamos que nossa experi√™ncia o ajude a evitar poss√≠veis erros e, talvez, o leve a outras solu√ß√µes interessantes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt481340/">https://habr.com/ru/post/pt481340/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt481330/index.html">O terceiro n√£o √© sup√©rfluo: como reduzimos a cadeia de listagem de produtos adicionando outro link a ela</a></li>
<li><a href="../pt481332/index.html">An√∫ncio do livro "Machine Learning Without Extra Words"</a></li>
<li><a href="../pt481334/index.html">Tarefa n√∫mero 2. Determina√ß√£o da estrutura populacional</a></li>
<li><a href="../pt481336/index.html">Como as pessoas s√£o rastreadas por conjuntos de dados "an√¥nimos"</a></li>
<li><a href="../pt481338/index.html">Explorando vulnerabilidades xss</a></li>
<li><a href="../pt481342/index.html">Enquete de sexta-feira: Falando sobre idiomas</a></li>
<li><a href="../pt481344/index.html">Equipe da plataforma IntelliJ planeja 2020</a></li>
<li><a href="../pt481346/index.html">5 grandes mudan√ßas na ind√∫stria automotiva</a></li>
<li><a href="../pt481348/index.html">Pentest Active Directory. Parte 1</a></li>
<li><a href="../pt481350/index.html">Quem trabalha no cosm√≥dromo de Plesetsk</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>