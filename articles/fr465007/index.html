<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏻‍💼 👩🏿‍🤝‍👨🏾 💋 Vérification typographique de Django et DRF 👐🏼 💙 👐🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comme vous le savez déjà, j'aime la frappe statique optionnelle. Le fait est que parfois ce n'est pas facultatif, mais impossible. Parce que nous avon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Vérification typographique de Django et DRF</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465007/"><p>  Comme vous le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">savez</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">déjà,</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">j'aime</a> la frappe statique optionnelle.  Le fait est que parfois ce n'est pas facultatif, mais impossible.  Parce que nous avons beaucoup de grands projets non typés dans l'écosystème de Python. </p><br><p> Django et Django-Rest-Framework étaient deux d'entre eux.  Étaient.  Parce que maintenant ils peuvent être tapés!  Permettez-moi de vous présenter l'organisation <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>django</code></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Django</a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>django</code></a> pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>django</code></a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>drf</code></a> . </p><br><p>  Cela va être un tutoriel concis et un guide de démarrage. </p><a name="habracut"></a><br><h2 id="kudos">  Bravo </h2><br><p>  Je tiens à dire un grand merci à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">@mkurnikov</a> pour avoir dirigé le projet et à tous les contributeurs qui ont rendu cela possible.  Vous êtes tous géniaux! </p><br><h2 id="tldr">  TLDR </h2><br><p>  Dans cet article, je montre comment les types fonctionnent avec <code>django</code> et <code>drf</code> .  Vous pouvez voir le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">résultat ici</a> . </p><br><p>  Et vous pouvez également utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>wemake-django-template</code></a> pour démarrer vos nouveaux projets avec tout ce qui est déjà configuré.  Il ressemblera exactement à l'exemple de projet. </p><br><h2 id="getting-started">  Pour commencer </h2><br><p>  Dans ce petit tutoriel, je vais vous montrer plusieurs fonctionnalités de <code>django-stubs</code> <code>djangorestframework-stubs</code> et <code>djangorestframework-stubs</code> en action.  J'espère que cela vous convaincra qu'avoir quelqu'un pour vérifier les choses après vous est une bonne chose. </p><br><p>  Vous pouvez toujours vous référer à la documentation d'origine.  Toutes les étapes y sont également abordées. </p><br><p>  Pour commencer, nous aurons besoin d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un nouveau projet</a> et d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un environnement virtuel propre</a> , afin que nous puissions installer nos dépendances: </p><br><pre> <code class="bash hljs">pip install django django-stubs mypy</code> </pre> <br><p>  Ensuite, nous devrons configurer correctement <code>mypy</code> .  Il peut être divisé en deux étapes.  Tout d'abord, nous configurons le <code>mypy</code> lui-même: </p><br><pre> <code class="plaintext hljs"># setup.cfg [mypy] # The mypy configurations: https://mypy.readthedocs.io/en/latest/config_file.html python_version = 3.7 check_untyped_defs = True disallow_any_generics = True disallow_untyped_calls = True disallow_untyped_decorators = True ignore_errors = False ignore_missing_imports = True implicit_reexport = False strict_optional = True strict_equality = True no_implicit_optional = True warn_unused_ignores = True warn_redundant_casts = True warn_unused_configs = True warn_unreachable = True warn_no_return = True</code> </pre> <br><p>  Ensuite, nous configurons le plugin <code>django-stubs</code> : </p><br><pre> <code class="plaintext hljs"># setup.cfg [mypy] # Appending to `mypy` section: plugins = mypy_django_plugin.main [mypy.plugins.django-stubs] django_settings_module = server.settings</code> </pre> <br><p>  Que faisons-nous ici? </p><br><ol><li>  Nous ajoutons un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin</a> <code>mypy</code> personnalisé pour aider le vérificateur de types à deviner les types dans certaines situations complexes spécifiques à Django (comme les modèles, le jeu de requêtes, les paramètres, etc.) </li><li>  Nous ajoutons également une configuration personnalisée pour <code>django-stubs</code> pour la pointer vers les paramètres que nous utilisons pour Django.  Il devra l'importer. </li></ol><br><p>  Le résultat final peut être trouvé <a href="">ici</a> . </p><br><p>  Nous avons maintenant tout installé et configuré.  Tapons des choses de contrôle! </p><br><h2 id="typechecking-views">  Vérification des vues </h2><br><p>  Commençons par taper les vues car c'est la chose la plus simple à faire avec ce plugin. </p><br><p>  Voici notre simple vue basée sur les fonctions: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># server/apps/main/views.py from django.http import HttpRequest, HttpResponse from django.shortcuts import render def index(request: HttpRequest) -&gt; HttpResponse: reveal_type(request.is_ajax) reveal_type(request.user) return render(request, 'main/index.html')</span></span></code> </pre> <br><p>  Courons et voyons de quels types il est au courant.  Notez que nous devrons peut-être modifier <code>PYTHONPATH</code> , afin que <code>mypy</code> puisse importer notre projet: </p><br><pre> <code class="plaintext hljs">» PYTHONPATH="$PYTHONPATH:$PWD" mypy server server/apps/main/views.py:14: note: Revealed type is 'def () -&gt; builtins.bool' server/apps/main/views.py:15: note: Revealed type is 'django.contrib.auth.models.User'</code> </pre> <br><p>  Essayons de casser quelque chose: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># server/apps/main/views.py def index(request: HttpRequest) -&gt; HttpResponse: return render(request.META, 'main/index.html')</span></span></code> </pre> <br><p>  Non, il y a une faute de frappe et <code>mypy</code> l'attrapera: </p><br><pre> <code class="plaintext hljs">» PYTHONPATH="$PYTHONPATH:$PWD" mypy server server/apps/main/views.py:18: error: Argument 1 to "render" has incompatible type "Dict[str, Any]"; expected "HttpRequest"</code> </pre> <br><p>  Ça marche!  D'accord, mais c'est assez simple.  Compliquons un peu notre exemple et créons un modèle personnalisé pour montrer comment taper des modèles et des ensembles de requêtes. </p><br><h2 id="typechecking-models-and-queryset">  Vérification des modèles et jeu de requêtes </h2><br><p>  L'ORM de Django est une fonctionnalité qui tue.  Il est très flexible et dynamique.  Cela signifie également qu'il est difficile à taper.  Voyons quelques fonctionnalités déjà couvertes par <code>django-stubs</code> . </p><br><p>  Notre définition de modèle: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># server/apps/main/models.py from django.contrib.auth import get_user_model from django.db import models User = get_user_model() class BlogPost(models.Model): author = models.ForeignKey(User, on_delete=models.CASCADE) text = models.TextField() is_published = models.BooleanField(default=False) created_at = models.DateTimeField(auto_now_add=True) def __str__(self) -&gt; str: reveal_type(self.id) # example reveal of all fields in a model reveal_type(self.author) reveal_type(self.text) reveal_type(self.is_published) reveal_type(self.created_at) return '&lt;BlogPost {0}&gt;'.format(self.id)</span></span></code> </pre> <br><p>  Et chaque domaine de ce modèle est couvert par des <code>django-stubs</code> .  Voyons quels types sont révélés: </p><br><pre> <code class="plaintext hljs">» PYTHONPATH="$PYTHONPATH:$PWD" mypy server server/apps/main/models.py:21: note: Revealed type is 'builtins.int*' server/apps/main/models.py:22: note: Revealed type is 'django.contrib.auth.models.User*' server/apps/main/models.py:23: note: Revealed type is 'builtins.str*' server/apps/main/models.py:24: note: Revealed type is 'builtins.bool*' server/apps/main/models.py:25: note: Revealed type is 'datetime.datetime*'</code> </pre> <br><p>  Tout a l'air bien!  <code>django-stubs</code> fournit un plugin <code>mypy</code> personnalisé pour convertir les champs du modèle en types d'instance corrects.  C'est pourquoi tous les types sont correctement révélés. </p><br><p>  La deuxième grande fonctionnalité du plugin <code>django-stubs</code> est que nous pouvons taper <code>QuerySet</code> : </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># server/apps/main/logic/repo.py from django.db.models.query import QuerySet from server.apps.main.models import BlogPost def published_posts() -&gt; 'QuerySet[BlogPost]': # works fine! return BlogPost.objects.filter( is_published=True, )</span></span></code> </pre> <br><p>  Et voici comment cela peut être vérifié: </p><br><pre> <code class="python hljs">reveal_type(published_posts().first()) <span class="hljs-comment"><span class="hljs-comment"># =&gt; Union[server.apps.main.models.BlogPost*, None]</span></span></code> </pre> <br><p>  Nous pouvons même annoter des ensembles de requêtes avec des <code>.values()</code> et <code>.values_list()</code> .  Ce plugin est intelligent! </p><br><p>  J'ai du mal avec les méthodes d'annotation renvoyant des <code>QuerySet</code> depuis plusieurs années.  Cette fonctionnalité résout un gros problème pour moi: plus d' <code>Iterable[BlogPost]</code> ou de <code>List[User]</code> .  Je peux maintenant utiliser de vrais types. </p><br><h2 id="typechecking-apis">  Vérification des API </h2><br><p>  Mais, taper des vues, des modèles, des formulaires, des commandes, des URL et des administrateurs n'est pas tout ce que nous avons.  TypedDjango a également des typages pour <code>djangorestframework</code> .  Installons-le et configurons-le: </p><br><pre> <code class="bash hljs">pip install djangorestframework djangorestframework-stubs</code> </pre> <br><p>  Et nous pouvons commencer à créer des sérialiseurs: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># server/apps/main/serializers.py from rest_framework import serializers from server.apps.main.models import BlogPost, User class UserSerializer(serializers.ModelSerializer): class Meta: model = User fields = ['username', 'email'] class BlogPostSerializer(serializers.HyperlinkedModelSerializer): author = UserSerializer() class Meta: model = BlogPost fields = ['author', 'text', 'is_published', 'created_at']</span></span></code> </pre> <br><p>  Vues: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># server/apps/main/views.py from rest_framework import viewsets from server.apps.main.serializers import BlogPostSerializer from server.apps.main.models import BlogPost class BlogPostViewset(viewsets.ModelViewSet): serializer_class = BlogPostSerializer queryset = BlogPost.objects.all()</span></span></code> </pre> <br><p>  Et les routeurs: </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># server/apps/main/urls.py from django.urls import path, include from rest_framework import routers from server.apps.main.views import BlogPostViewset, index router = routers.DefaultRouter() router.register(r'posts', BlogPostViewset) urlpatterns = [ path('', include(router.urls)), # ... ]</span></span></code> </pre> <br><p>  Il ne semble même pas que quelque chose ait changé, mais tout à l'intérieur est tapé: paramètres, sérialiseurs, ensembles de vues et routeurs.  Il vous permettra d'ajouter progressivement des saisies là où vous en avez le plus besoin. </p><br><p>  Essayons de changer <code>queryset = BlogPost.objects.all()</code> <br>  to <code>queryset = [1, 2, 3]</code> dans nos vues: </p><br><pre> <code class="plaintext hljs">» PYTHONPATH="$PYTHONPATH:$PWD" mypy server server/apps/main/views.py:25: error: Incompatible types in assignment (expression has type "List[int]", base class "GenericAPIView" defined the type as "Optional[QuerySet[Any]]")</code> </pre> <br><p>  Non, ça ne marchera pas!  Réparez votre code! </p><br><h2 id="conclusion">  Conclusion </h2><br><p>  Taper les interfaces du framework est une chose géniale à avoir.  Lorsqu'il est combiné avec des outils tels que les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>returns</code></a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>mappers</code></a> il permettra d'écrire une logique métier déclarative et sécurisée enveloppée dans des interfaces de framework typées.  Et pour diminuer le nombre d'erreurs dans la couche entre ces deux. </p><br><p>  La saisie statique progressive facultative vous permet également de démarrer rapidement et d'ajouter des types uniquement lorsque votre API est stabilisée ou de suivre un développement axé sur les types dès le début. </p><br><p>  Cependant, <code>django-stubs</code> et <code>djangorestframework-stubs</code> sont de nouveaux projets.  Il y a encore beaucoup de bugs, de fonctionnalités planifiées, de spécifications de type manquantes.  Nous accueillons chaque contribution de la communauté pour rendre les outils de développement en Python vraiment géniaux. </p><br><p>  Publié à l'origine sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mon blog</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr465007/">https://habr.com/ru/post/fr465007/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr464995/index.html">Envelopper des séquences dans Swift</a></li>
<li><a href="../fr464997/index.html">À propos du développement des technologies VR: où les utilisent-elles, pourquoi les entreprises VR et quels appareils utilisent</a></li>
<li><a href="../fr464999/index.html">Comment les spécificités du travail avec les serveurs d'applications changent à l'aide de l'exemple OpenLiberty</a></li>
<li><a href="../fr465001/index.html">Amazon Prime Day 2019 - Propulsé par AWS</a></li>
<li><a href="../fr465003/index.html">Intérêts pour le genre ARPG</a></li>
<li><a href="../fr465009/index.html">Vue intérieure: RFID dans le monde moderne. Partie 1: RFID à la maison</a></li>
<li><a href="../fr465011/index.html">Notations bancaires. La participation ne peut pas être fixée</a></li>
<li><a href="../fr465013/index.html">Freelance / Full Time Coefficient ou comment comprendre qu'il est temps de penser à Freelance</a></li>
<li><a href="../fr465015/index.html">Psychanalyse de l'effet d'un spécialiste méconnu. Partie 2. Comment et pourquoi résister</a></li>
<li><a href="../fr465017/index.html">Intel Use NUC - Gagnez le concours NUC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>