<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äçü§ù‚Äçüë©üèª ü§õüèæ üâê SQL Index Manager - un outil gratuit pour d√©fragmenter et maintenir les index üïâÔ∏è üÜñ üë¥üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pendant de nombreuses ann√©es, travaillant en tant que DBA SQL Server et faisant l'administration du serveur, puis l'optimisation des performances. En ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>SQL Index Manager - un outil gratuit pour d√©fragmenter et maintenir les index</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459914/">  Pendant de nombreuses ann√©es, travaillant en tant que DBA SQL Server et faisant l'administration du serveur, puis l'optimisation des performances.  En g√©n√©ral, je voulais faire quelque chose d'utile dans mon temps libre pour l'Univers et nos coll√®gues.  Donc, √† la fin, nous avons obtenu un petit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">outil de</a> maintenance d'index <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">open source</a> pour SQL Server et Azure. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/546/8b0/98e/5468b098eea90eb287427b56021c6962.png" alt="Gestionnaire d'index SQL"><br><br><a name="habracut"></a><h3>  Id√©e </h3><br>  Parfois, lorsque vous travaillez sur leurs priorit√©s, les gens peuvent ressembler √† une batterie de type doigt - il y a suffisamment de charge de motivation pour un seul flash, puis c'est tout.  Et jusqu'√† r√©cemment, je n'ai pas fait exception √† cette observation de la vie.  Souvent, j'ai √©t√© visit√© par des id√©es pour cr√©er quelque chose de moi-m√™me, mais les priorit√©s ont chang√© et rien n'a √©t√© mis au point. <br><br>  Une influence assez forte sur ma motivation et mon d√©veloppement professionnel a √©t√© apport√©e par le travail dans la soci√©t√© Kharkov Devart, qui √©tait engag√©e dans la cr√©ation de logiciels pour le d√©veloppement et l'administration de bases de donn√©es SQL Server, MySQL et Oracle. <br><br>  Avant de venir √† eux, je n'avais aucune id√©e des sp√©cificit√©s de la cr√©ation de mon propre produit, mais d√©j√† dans le processus, j'ai acquis beaucoup de connaissances sur la structure interne de SQL Server.  Ayant optimis√© les demandes de m√©tadonn√©es dans leurs gammes de produits depuis plus d'un an, j'ai progressivement commenc√© √† comprendre quelle fonctionnalit√© √©tait plus demand√©e sur le march√© que toute autre. <br><br>  √Ä un certain stade, l'id√©e est n√©e de cr√©er un nouveau produit de niche, mais en raison des circonstances, cette id√©e n'a pas d√©coll√©.  A cette √©poque, pour le nouveau projet, il n'y avait pas assez de ressources libres suffisantes et ringardes au sein de l'entreprise sans compromettre le c≈ìur de m√©tier. <br><br>  D√©j√† quand il travaillait dans un nouvel endroit et essayait de faire le projet par lui-m√™me, il devait constamment faire des compromis.  L'id√©e initiale de cr√©er un grand produit plein de fonctionnalit√©s est rapidement tomb√©e √† n√©ant et s'est progressivement transform√©e dans une direction diff√©rente - pour diviser la fonctionnalit√© pr√©vue en mini-outils s√©par√©s et les mettre en ≈ìuvre ind√©pendamment les uns des autres. <br><br>  En cons√©quence, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>SQL Index Manager est</b></a> n√© - un outil de maintenance d'index gratuit pour SQL Server et Azure.  L'id√©e principale √©tait de prendre comme base des alternatives commerciales de RedGate et Devart et d'essayer d'am√©liorer leurs fonctionnalit√©s.  Pour fournir, aux d√©butants comme aux utilisateurs exp√©riment√©s, la possibilit√© d'analyser et de maintenir facilement les index. <br><br><h3>  Impl√©mentation </h3><br>  En termes, tout semble toujours simple ... il a jet√© un coup d'≈ìil √† quelques vidosikov motivants, s'est tenu dans un rack et a commenc√© √† fabriquer un produit cool.  Mais en pratique, tout n'est pas aussi rose, car il existe de nombreux pi√®ges lors de l'utilisation de la fonction de table syst√®me sys.dm_db_index_physical_stats et, en combinaison, le seul endroit d'o√π vous pouvez obtenir des informations pertinentes sur la fragmentation d'index. <br><br>  D√®s les premiers jours de d√©veloppement, il y avait une excellente occasion de faire un chemin morne parmi les sch√©mas standard et de copier la logique d√©j√† d√©bogu√©e du travail des applications concurrentes, tout en ajoutant un petit gag.  Mais apr√®s avoir analys√© les demandes de m√©tadonn√©es, j'ai voulu faire quelque chose de plus optimis√© qui, en raison de la bureaucratie des grandes entreprises, ne serait jamais apparu dans leurs produits. <br><br>  Lors de l'analyse du gestionnaire d'index SQL de RedGate (1.1.9.1378 - 155 $), vous pouvez voir que l'application utilise une approche tr√®s simple: avec une requ√™te, nous obtenons une liste de tables et de vues utilisateur, et apr√®s la deuxi√®me requ√™te, une liste de tous les index de la base de donn√©es s√©lectionn√©e est renvoy√©e. <br><br><pre><code class="1c hljs">SELECT objects.name AS tableOrViewName , objects.object_id AS tableOrViewId , schemas.name AS schemaName , CAST(ISNULL(lobs.NumLobs, <span class="hljs-number"><span class="hljs-number">0</span></span>) AS BIT) AS ContainsLobs , o.is_memory_optimized FROM sys.objects AS objects JOIN sys.schemas AS schemas ON schemas.schema_id = objects.schema_id LEFT JOIN ( SELECT object_id , COUNT(*) AS NumLobs FROM sys.columns WITH (NOLOCK) WHERE system_type_id IN (<span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>) OR max_length = -<span class="hljs-number"><span class="hljs-number">1</span></span> GROUP BY object_id ) AS lobs ON objects.object_id = lobs.object_id LEFT JOIN sys.tables AS o ON o.object_id = objects.object_id WHERE objects.type = 'U' OR objects.type = 'V' SELECT i.object_id AS tableOrViewId , i.name AS indexName , i.index_id AS indexId , i.allow_page_locks AS allowPageLocks , p.partition_number AS partitionNumber , CAST((c.numPartitions - <span class="hljs-number"><span class="hljs-number">1</span></span>) AS BIT) AS belongsToPartitionedIndex FROM sys.indexes AS i JOIN sys.partitions AS p ON p.index_id = i.index_id AND p.object_id = i.object_id JOIN ( SELECT COUNT(*) AS numPartitions , object_id , index_id FROM sys.partitions GROUP BY object_id , index_id ) AS c ON c.index_id = i.index_id AND c.object_id = i.object_id WHERE i.index_id &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> -- ignore heaps AND i.is_disabled = <span class="hljs-number"><span class="hljs-number">0</span></span> AND i.is_hypothetical = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Ensuite, dans un cycle, pour chaque section de l'index, une demande est envoy√©e pour d√©terminer sa taille et son niveau de fragmentation.  √Ä la fin de l'analyse, les index dont le poids est inf√©rieur au seuil d'entr√©e sont ignor√©s sur le client. <br><br><pre> <code class="1c hljs">EXEC sp_executesql N' SELECT index_id, avg_fragmentation_in_percent, page_count FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)' , N'@databaseId int,@objectId int,@indexId int,@partitionNr int' , @databaseId = <span class="hljs-number"><span class="hljs-number">7</span></span>, @objectId = <span class="hljs-number"><span class="hljs-number">2133582639</span></span>, @indexId = <span class="hljs-number"><span class="hljs-number">1</span></span>, @partitionNr = <span class="hljs-number"><span class="hljs-number">1</span></span> EXEC sp_executesql N' SELECT index_id, avg_fragmentation_in_percent, page_count FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)' , N'@databaseId int,@objectId int,@indexId int,@partitionNr int' , @databaseId = <span class="hljs-number"><span class="hljs-number">7</span></span>, @objectId = <span class="hljs-number"><span class="hljs-number">2133582639</span></span>, @indexId = <span class="hljs-number"><span class="hljs-number">2</span></span>, @partitionNr = <span class="hljs-number"><span class="hljs-number">1</span></span> EXEC sp_executesql N' SELECT index_id, avg_fragmentation_in_percent, page_count FROM sys.dm_db_index_physical_stats(@databaseId, @objectId, @indexId, @partitionNr, NULL)' , N'@databaseId int,@objectId int,@indexId int,@partitionNr int' , @databaseId = <span class="hljs-number"><span class="hljs-number">7</span></span>, @objectId = <span class="hljs-number"><span class="hljs-number">2133582639</span></span>, @indexId = <span class="hljs-number"><span class="hljs-number">3</span></span>, @partitionNr = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  Lors de l'analyse de la logique de cette application, vous pouvez trouver de nombreuses lacunes.  Par exemple, si vous trouvez un probl√®me avec des bagatelles, puis avant d'envoyer une demande, aucune v√©rification n'est effectu√©e pour savoir si la section actuelle contient des cha√Ænes afin d'exclure des sections vides de l'analyse. <br><br>  Mais le probl√®me est plus aigu sous un autre aspect: le nombre de demandes de serveur sera approximativement √©gal au nombre total de lignes de sys.partitions.  √âtant donn√© que de vraies bases de donn√©es peuvent contenir des dizaines de milliers de sections, cette nuance peut conduire √† un grand nombre de requ√™tes similaires au serveur.  Dans une situation o√π la base de donn√©es est distante, le temps d'analyse deviendra encore plus long en raison de l'augmentation des retards r√©seau pour chaque demande, m√™me la plus simple. <br><br>  Contrairement √† RedGate, un produit similaire d√©velopp√© dans Devart - dbForge Index Manager pour SQL Server (1.10.38 - 99 $) re√ßoit les informations dans une grande requ√™te, puis affiche tout sur le client: <br><br><pre> <code class="1c hljs">SELECT SCHEMA_NAME(o.[schema_id]) AS [schema_name] , o.name AS parent_name , o.[type] AS parent_type , i.name , i.type_desc , s.avg_fragmentation_in_percent , s.page_count , p.partition_number , p.[rows] , ISNULL(lob.is_lob_legacy, <span class="hljs-number"><span class="hljs-number">0</span></span>) AS is_lob_legacy , ISNULL(lob.is_lob, <span class="hljs-number"><span class="hljs-number">0</span></span>) AS is_lob , CASE WHEN ds.[type] = 'PS' THEN <span class="hljs-number"><span class="hljs-number">1</span></span> ELSE <span class="hljs-number"><span class="hljs-number">0</span></span> END AS is_partitioned FROM sys.dm_db_index_physical_stats(DB_ID(), <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) s JOIN sys.partitions p ON s.[object_id] = p.[object_id] AND s.index_id = p.index_id AND s.partition_number = p.partition_number JOIN sys.indexes i ON i.[object_id] = s.[object_id] AND i.index_id = s.index_id LEFT JOIN ( SELECT c.[object_id] , index_id = ISNULL(i.index_id, <span class="hljs-number"><span class="hljs-number">1</span></span>) , is_lob_legacy = MAX(CASE WHEN c.system_type_id IN (<span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>) THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) , is_lob = MAX(CASE WHEN c.max_length = -<span class="hljs-number"><span class="hljs-number">1</span></span> THEN <span class="hljs-number"><span class="hljs-number">1</span></span> END) FROM sys.columns c LEFT JOIN sys.index_columns i ON c.[object_id] = i.[object_id] AND c.column_id = i.column_id AND i.index_id &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> WHERE c.system_type_id IN (<span class="hljs-number"><span class="hljs-number">34</span></span>, <span class="hljs-number"><span class="hljs-number">35</span></span>, <span class="hljs-number"><span class="hljs-number">99</span></span>) OR c.max_length = -<span class="hljs-number"><span class="hljs-number">1</span></span> GROUP BY c.[object_id], i.index_id ) lob ON lob.[object_id] = i.[object_id] AND lob.index_id = i.index_id JOIN sys.objects o ON o.[object_id] = i.[object_id] JOIN sys.data_spaces ds ON i.data_space_id = ds.data_space_id WHERE i.[type] IN (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) AND i.is_disabled = <span class="hljs-number"><span class="hljs-number">0</span></span> AND i.is_hypothetical = <span class="hljs-number"><span class="hljs-number">0</span></span> AND s.index_level = <span class="hljs-number"><span class="hljs-number">0</span></span> AND s.alloc_unit_type_desc = 'IN_ROW_DATA' AND o.[type] IN ('U', 'V')</code> </pre> <br>  Nous avons r√©ussi √† nous d√©barrasser du probl√®me principal avec le voile du m√™me type de requ√™tes dans un produit concurrent, mais les inconv√©nients de cette impl√©mentation sont qu'aucun param√®tre suppl√©mentaire n'est transmis √† la fonction sys.dm_db_index_physical_stats, ce qui peut limiter l'analyse des index √©videmment inutiles.  En fait, cela conduit √† obtenir des informations sur tous les indices du syst√®me et √† charger des disques suppl√©mentaires au stade de l'analyse. <br><br>  Il est important de noter que les donn√©es obtenues √† partir de sys.dm_db_index_physical_stats ne sont pas mises en cache de mani√®re permanente dans le pool de m√©moire tampon.Par cons√©quent, la minimisation des lectures physiques lors de l'obtention d'informations sur la fragmentation d'index √©tait l'une des t√¢ches prioritaires pendant le d√©veloppement. <br><br>  Apr√®s plusieurs exp√©riences, il s'est av√©r√© combiner les deux approches, divisant le scan en deux parties.  Tout d'abord, une grande requ√™te d√©termine la taille des sections, en pr√©-filtrant celles qui ne sont pas dans la plage de filtrage: <br><br><pre> <code class="1c hljs">INSERT INTO <span class="hljs-meta"><span class="hljs-meta">#AllocationUnits (ContainerID, ReservedPages, UsedPages) SELECT [container_id] , SUM([total_pages]) , SUM([used_pages]) FROM sys.allocation_units WITH(NOLOCK) GROUP BY [container_id] HAVING SUM([total_pages]) BETWEEN @MinIndexSize AND @MaxIndexSize</span></span></code> </pre> <br>  Ensuite, nous obtenons uniquement les sections qui contiennent des donn√©es afin d'√©viter des op√©rations de lecture inutiles √† partir d'index vides. <br><br><pre> <code class="1c hljs">SELECT [object_id] , [index_id] , [partition_id] , [partition_number] , [rows] , [data_compression] INTO <span class="hljs-meta"><span class="hljs-meta">#Partitions FROM sys.partitions WITH(NOLOCK) WHERE [object_id] &gt; 255 AND [rows] &gt; 0 AND [object_id] NOT IN (SELECT * FROM #ExcludeList)</span></span></code> </pre> <br>  Selon les param√®tres, seuls les types d'index sont obtenus que l'utilisateur souhaite analyser (le travail avec les segments, les index cluster / non cluster et les indicateurs de colonne est pris en charge). <br><br><pre> <code class="1c hljs">INSERT INTO <span class="hljs-meta"><span class="hljs-meta">#Indexes SELECT ObjectID = i.[object_id] , IndexID = i.index_id , IndexName = i.[name] , PagesCount = a.ReservedPages , UnusedPagesCount = a.ReservedPages - a.UsedPages , PartitionNumber = p.[partition_number] , RowsCount = ISNULL(p.[rows], 0) , IndexType = i.[type] , IsAllowPageLocks = i.[allow_page_locks] , DataSpaceID = i.[data_space_id] , DataCompression = p.[data_compression] , IsUnique = i.[is_unique] , IsPK = i.[is_primary_key] , FillFactorValue = i.[fill_factor] , IsFiltered = i.[has_filter] FROM #AllocationUnits a JOIN #Partitions p ON a.ContainerID = p.[partition_id] JOIN sys.indexes i WITH(NOLOCK) ON i.[object_id] = p.[object_id] AND p.[index_id] = i.[index_id] WHERE i.[type] IN (0, 1, 2, 5, 6) AND i.[object_id] &gt; 255</span></span></code> </pre> <br>  Apr√®s cela, un peu de magie commence: pour tous les petits indices, nous d√©terminons le niveau de fragmentation en appelant √† plusieurs reprises la fonction sys.dm_db_index_physical_stats avec une indication compl√®te de tous les param√®tres. <br><br><pre> <code class="1c hljs">INSERT INTO <span class="hljs-meta"><span class="hljs-meta">#Fragmentation (ObjectID, IndexID, PartitionNumber, Fragmentation) SELECT i.ObjectID , i.IndexID , i.PartitionNumber , r.[avg_fragmentation_in_percent] FROM #Indexes i CROSS APPLY sys.dm_db_index_physical_stats(@DBID, i.ObjectID, i.IndexID, i.PartitionNumber, 'LIMITED') r WHERE i.PagesCount &lt;= @PreDescribeSize AND r.[index_level] = 0 AND r.[alloc_unit_type_desc] = 'IN_ROW_DATA' AND i.IndexType IN (0, 1, 2)</span></span></code> </pre> <br>  Ensuite, nous renvoyons toutes les informations possibles au client, en filtrant les donn√©es exc√©dentaires: <br><br><pre> <code class="1c hljs">SELECT i.ObjectID , i.IndexID , i.IndexName , ObjectName = o.[name] , SchemaName = s.[name] , i.PagesCount , i.UnusedPagesCount , i.PartitionNumber , i.RowsCount , i.IndexType , i.IsAllowPageLocks , u.TotalWrites , u.TotalReads , u.TotalSeeks , u.TotalScans , u.TotalLookups , u.LastUsage , i.DataCompression , f.Fragmentation , IndexStats = STATS_DATE(i.ObjectID, i.IndexID) , IsLobLegacy = ISNULL(lob.IsLobLegacy, <span class="hljs-number"><span class="hljs-number">0</span></span>) , IsLob = ISNULL(lob.IsLob, <span class="hljs-number"><span class="hljs-number">0</span></span>) , IsSparse = CAST(CASE WHEN p.ObjectID IS <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN <span class="hljs-number"><span class="hljs-number">0</span></span> ELSE <span class="hljs-number"><span class="hljs-number">1</span></span> END AS BIT) , IsPartitioned = CAST(CASE WHEN dds.[data_space_id] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN <span class="hljs-number"><span class="hljs-number">1</span></span> ELSE <span class="hljs-number"><span class="hljs-number">0</span></span> END AS BIT) , FileGroupName = fg.[name] , i.IsUnique , i.IsPK , i.FillFactorValue , i.IsFiltered , a.IndexColumns , a.IncludedColumns FROM <span class="hljs-meta"><span class="hljs-meta">#Indexes i JOIN sys.objects o WITH(NOLOCK) ON o.[object_id] = i.ObjectID JOIN sys.schemas s WITH(NOLOCK) ON s.[schema_id] = o.[schema_id] LEFT JOIN #AggColumns a ON a.ObjectID = i.ObjectID AND a.IndexID = i.IndexID LEFT JOIN #Sparse p ON p.ObjectID = i.ObjectID LEFT JOIN #Fragmentation f ON f.ObjectID = i.ObjectID AND f.IndexID = i.IndexID AND f.PartitionNumber = i.PartitionNumber LEFT JOIN ( SELECT ObjectID = [object_id] , IndexID = [index_id] , TotalWrites = NULLIF([user_updates], 0) , TotalReads = NULLIF([user_seeks] + [user_scans] + [user_lookups], 0) , TotalSeeks = NULLIF([user_seeks], 0) , TotalScans = NULLIF([user_scans], 0) , TotalLookups = NULLIF([user_lookups], 0) , LastUsage = ( SELECT MAX(dt) FROM ( VALUES ([last_user_seek]) , ([last_user_scan]) , ([last_user_lookup]) , ([last_user_update]) ) t(dt) ) FROM sys.dm_db_index_usage_stats WITH(NOLOCK) WHERE [database_id] = @DBID ) u ON i.ObjectID = u.ObjectID AND i.IndexID = u.IndexID LEFT JOIN #Lob lob ON lob.ObjectID = i.ObjectID AND lob.IndexID = i.IndexID LEFT JOIN sys.destination_data_spaces dds WITH(NOLOCK) ON i.DataSpaceID = dds.[partition_scheme_id] AND i.PartitionNumber = dds.[destination_id] JOIN sys.filegroups fg WITH(NOLOCK) ON ISNULL(dds.[data_space_id], i.DataSpaceID) = fg.[data_space_id] WHERE o.[type] IN ('V', 'U') AND ( f.Fragmentation &gt;= @Fragmentation OR i.PagesCount &gt; @PreDescribeSize OR i.IndexType IN (5, 6) )</span></span></code> </pre> <br>  Apr√®s cela, les requ√™tes ponctuelles d√©terminent le niveau de fragmentation pour les grands indices. <br><br><pre> <code class="1c hljs">EXEC sp_executesql N' DECLARE @DBID INT = DB_ID() SELECT [avg_fragmentation_in_percent] FROM sys.dm_db_index_physical_stats(@DBID, @ObjectID, @IndexID, @PartitionNumber, ''LIMITED'') WHERE [index_level] = 0 AND [alloc_unit_type_desc] = ''IN_ROW_DATA''' , N'@ObjectID int,@IndexID int,@PartitionNumber int' , @ObjectId = <span class="hljs-number"><span class="hljs-number">1044198770</span></span>, @IndexId = <span class="hljs-number"><span class="hljs-number">1</span></span>, @PartitionNumber = <span class="hljs-number"><span class="hljs-number">1</span></span> EXEC sp_executesql N' DECLARE @DBID INT = DB_ID() SELECT [avg_fragmentation_in_percent] FROM sys.dm_db_index_physical_stats(@DBID, @ObjectID, @IndexID, @PartitionNumber, ''LIMITED'') WHERE [index_level] = 0 AND [alloc_unit_type_desc] = ''IN_ROW_DATA''' , N'@ObjectID int,@IndexID int,@PartitionNumber int' , @ObjectId = <span class="hljs-number"><span class="hljs-number">1552724584</span></span>, @IndexId = <span class="hljs-number"><span class="hljs-number">0</span></span>, @PartitionNumber = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  En raison de cette approche, lors de la g√©n√©ration de requ√™tes, il a √©t√© possible de r√©soudre les probl√®mes de performances de num√©risation rencontr√©s dans les applications des concurrents.  Cela pourrait √™tre termin√©, mais au cours du d√©veloppement, de nouvelles id√©es sont progressivement apparues qui ont permis d'√©largir le champ d'application de votre produit. <br><br>  Initialement, le support pour travailler avec WAIT_AT_LOW_PRIORITY a √©t√© impl√©ment√©, puis il est devenu possible d'utiliser DATA_COMPRESSION et FILL_FACTOR pour reconstruire les indices. <br><br><img src="https://habrastorage.org/webt/kd/em/xj/kdemxjo8sj0hxa4y_omvv3dph6a.png" alt="Param√®tres du gestionnaire d'index SQL"><br><br>  L'application √©tait l√©g√®rement surcharg√©e de fonctionnalit√©s auparavant non planifi√©es, telles que la maintenance des colonnes de colonnes: <br><br><pre> <code class="1c hljs">SELECT * FROM ( SELECT IndexID = [index_id] , PartitionNumber = [partition_number] , PagesCount = SUM([size_in_bytes]) / <span class="hljs-number"><span class="hljs-number">8192</span></span> , UnusedPagesCount = ISNULL(SUM(CASE WHEN [state] = <span class="hljs-number"><span class="hljs-number">1</span></span> THEN [size_in_bytes] END), <span class="hljs-number"><span class="hljs-number">0</span></span>) / <span class="hljs-number"><span class="hljs-number">8192</span></span> , Fragmentation = CAST(ISNULL(SUM(CASE WHEN [state] = <span class="hljs-number"><span class="hljs-number">1</span></span> THEN [size_in_bytes] END), <span class="hljs-number"><span class="hljs-number">0</span></span>) * <span class="hljs-number"><span class="hljs-number">100</span></span>. / SUM([size_in_bytes]) AS FLOAT) FROM sys.fn_column_store_row_groups(@ObjectID) GROUP BY [index_id] , [partition_number] ) t WHERE Fragmentation &gt;= @Fragmentation AND PagesCount BETWEEN @MinIndexSize AND @MaxIndexSize</code> </pre> <br>  Ou la possibilit√© de cr√©er des index non clusteris√©s bas√©s sur les informations de dm_db_missing_index: <br><br><pre> <code class="1c hljs">SELECT ObjectID = d.[object_id] , UserImpact = gs.[avg_user_impact] , TotalReads = gs.[user_seeks] + gs.[user_scans] , TotalSeeks = gs.[user_seeks] , TotalScans = gs.[user_scans] , LastUsage = ISNULL(gs.[last_user_scan], gs.[last_user_seek]) , IndexColumns = CASE WHEN d.[equality_columns] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AND d.[inequality_columns] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN d.[equality_columns] + ', ' + d.[inequality_columns] WHEN d.[equality_columns] IS NOT <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AND d.[inequality_columns] IS <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> THEN d.[equality_columns] ELSE d.[inequality_columns] END , IncludedColumns = d.[included_columns] FROM sys.dm_db_missing_index_groups g WITH(NOLOCK) JOIN sys.dm_db_missing_index_group_stats gs WITH(NOLOCK) ON gs.[group_handle] = g.[index_group_handle] JOIN sys.dm_db_missing_index_details d WITH(NOLOCK) ON g.[index_handle] = d.[index_handle] WHERE d.[database_id] = DB_ID()</code> </pre> <br><h3>  R√©sum√© </h3><br>  Apr√®s six mois de la phase de d√©veloppement actif, je suis heureux que les plans ne s'arr√™tent pas l√†, car je veux continuer √† d√©velopper ce produit.  L'√©tape suivante consiste √† ajouter des fonctionnalit√©s pour rechercher des index en double ou inutilis√©s, ainsi qu'√† impl√©menter une prise en charge compl√®te pour la diffusion de statistiques dans SQL Server. <br><br>  Bas√© sur le fait qu'il existe de nombreuses solutions payantes sur le march√©, je veux croire qu'en raison du positionnement libre, d'une description des m√©tadonn√©es plus optimis√©e et de la pr√©sence de diverses petites choses utiles pour quelqu'un, ce produit deviendra certainement utile dans les t√¢ches quotidiennes. <br><br>  La version actuelle de l'application peut √™tre t√©l√©charg√©e sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b>GitHub</b></a> .  Les sources sont au m√™me endroit. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr459914/">https://habr.com/ru/post/fr459914/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr459898/index.html">Le plan est revenu √† l'√©conomie</a></li>
<li><a href="../fr459900/index.html">Visualisation d'une colonne √† partir d'un DataFrame √† l'aide de la biblioth√®que Seaborn</a></li>
<li><a href="../fr459902/index.html">Carte interactive des r√©gions russes pour un d√©butant. Les erreurs que j'ai faites et que vous ne devez pas faire</a></li>
<li><a href="../fr459906/index.html">Tic Tac Toe, partie 3: Annuler / R√©tablir avec stockage des commandes</a></li>
<li><a href="../fr459910/index.html">Situation: les entreprises ne sont pas press√©es de d√©velopper des services pour les assistants vocaux - quels sont les risques</a></li>
<li><a href="../fr459918/index.html">R√©solution de probl√®mes avec pwnable.kr 03 - bof. D√©bordement de tampon sur la pile</a></li>
<li><a href="../fr459922/index.html">Suppression du bruit haute fr√©quence des signaux des capteurs de vibrations lors du diagnostic des vibrations des roulements</a></li>
<li><a href="../fr459924/index.html">Cycle d'essai complet de React. Rapport Auto.ru</a></li>
<li><a href="../fr459928/index.html">Parcours de l'√©tudiant vers le d√©veloppement d'applications mobiles</a></li>
<li><a href="../fr459930/index.html">Automatisation de l'importation Python</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>