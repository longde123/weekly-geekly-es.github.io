<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèø üèïÔ∏è üïµÔ∏è Tipos para APIs HTTP escritas em Python: experi√™ncia no Instagram üëè üöµ üêá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hoje estamos publicando o segundo material da s√©rie dedicada ao uso do Python no Instagram. Na √∫ltima vez, verificou os tipos de c√≥digo do servidor do...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Tipos para APIs HTTP escritas em Python: experi√™ncia no Instagram</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/474308/">  Hoje estamos publicando o segundo material da s√©rie dedicada ao uso do Python no Instagram.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Na √∫ltima</a> vez, verificou os tipos de c√≥digo do servidor do Instagram.  O servidor √© um mon√≥lito escrito em Python.  Consiste em v√°rios milh√µes de linhas de c√≥digo e possui v√°rios milhares de terminais do Django. <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/nn/gh/jg/nnghjgmcauejll98mv34awk3cok.jpeg"></a> <br><br>  Este artigo √© sobre como o Instagram usa tipos para documentar APIs HTTP e aplicar contratos ao trabalhar com eles. <br><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Vis√£o geral da situa√ß√£o</font> </h2><br>  Quando voc√™ abre o cliente m√≥vel do Instagram, ele, via HTTP, acessa a API JSON do nosso servidor Python (Django). <br><br>  Aqui est√£o algumas informa√ß√µes sobre o nosso sistema que permitir√£o que voc√™ tenha uma id√©ia da complexidade da API que usamos para organizar o trabalho do cliente m√≥vel.  Ent√£o aqui est√° o que temos: <br><br><ul><li>  Mais de 2000 pontos de extremidade no servidor. </li><li>  Mais de 200 campos de n√≠vel superior em um objeto de dados do cliente que representa uma imagem, v√≠deo ou hist√≥ria em um aplicativo. </li><li>  Centenas de programadores que escrevem c√≥digo do servidor (e ainda mais que lidam com o cliente). </li><li>  Centenas de confirma√ß√µes no c√≥digo do servidor feitas diariamente e na modifica√ß√£o da API.  Isso √© necess√°rio para fornecer suporte para novos recursos do sistema. </li></ul><br>  Usamos tipos para documentar nossas APIs HTTP complexas e em constante evolu√ß√£o e para impor contratos ao trabalhar com elas. <br><br><h2>  <font color="#3AC1EF">Tipos</font> </h2><br>  Vamos come√ßar do come√ßo.  A descri√ß√£o da sintaxe para anota√ß√µes de tipo no c√≥digo Python apareceu no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PEP 484</a> .  Por que adicionar anota√ß√µes de tipo ao c√≥digo? <br><br>  Considere a fun√ß√£o que baixa informa√ß√µes sobre o her√≥i de Guerra nas Estrelas: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id, calendar)</span></span></span><span class="hljs-function">:</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> id == <span class="hljs-number"><span class="hljs-number">1000</span></span>:         <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Character(             id=<span class="hljs-number"><span class="hljs-number">1000</span></span>,             name=<span class="hljs-string"><span class="hljs-string">"Luke Skywalker"</span></span>,             birth_year=<span class="hljs-string"><span class="hljs-string">"19BBY"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> calendar == Calendar.BBY <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ...         )     ...</code> </pre> <br>  Para entender essa fun√ß√£o, voc√™ precisa ler seu c√≥digo.  Feito isso, voc√™ pode descobrir o seguinte: <br><br><ul><li>  √â necess√°rio o identificador inteiro ( <code>id</code> ) do caractere. </li><li>  Ele pega o valor da enumera√ß√£o correspondente ( <code>calendar</code> ).  Por exemplo, <code>Calendar.BBY</code> significa "Antes da Batalha de Yavin", ou seja, "Antes da Batalha de Yavin". </li><li>  Ele retorna informa√ß√µes sobre o caractere na forma de uma entidade que cont√©m campos representando o identificador desse caractere, seu nome e ano de nascimento. </li></ul><br>  A fun√ß√£o possui um contrato impl√≠cito, cujo significado o programador deve restaurar toda vez que l√™ o c√≥digo da fun√ß√£o.  Mas o c√≥digo de fun√ß√£o √© escrito apenas uma vez e voc√™ deve l√™-lo v√°rias vezes; portanto, essa abordagem para trabalhar com esse c√≥digo n√£o √© particularmente boa. <br><br>  Al√©m disso, √© dif√≠cil verificar se o mecanismo que chama a fun√ß√£o adere ao contrato impl√≠cito descrito acima.  Da mesma forma, √© dif√≠cil verificar se este contrato √© respeitado no corpo da fun√ß√£o.  Em uma grande base de c√≥digo, essas situa√ß√µes podem levar a erros. <br><br>  Agora considere a mesma fun√ß√£o que declara anota√ß√µes de tipo: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: int, calendar: Calendar)</span></span></span><span class="hljs-function"> -&gt; Character:</span></span>    ...</code> </pre> <br>  As anota√ß√µes de tipo permitem que voc√™ expresse explicitamente o contrato dessa fun√ß√£o.  Para entender o que precisa ser inserido em uma fun√ß√£o e o que essa fun√ß√£o retorna, basta ler sua assinatura.  Um sistema de verifica√ß√£o de tipo pode analisar estaticamente a fun√ß√£o e verificar a conformidade com o contrato no c√≥digo.  Isso permite que voc√™ se livre de toda uma classe de erros! <br><br><h2>  <font color="#3AC1EF">Tipos para v√°rias APIs HTTP</font> </h2><br>  Vamos desenvolver uma API HTTP que permite que voc√™ receba informa√ß√µes sobre os her√≥is de Star Wars.  Para descrever o contrato expl√≠cito usado ao trabalhar com esta API, usaremos anota√ß√µes de tipo. <br><br>  Nossa API deve aceitar o identificador de caracteres ( <code>id</code> ) como um par√¢metro de URL e o valor da enumera√ß√£o de <code>calendar</code> como um par√¢metro de solicita√ß√£o.  A API deve retornar uma resposta JSON com informa√ß√µes de caracteres. <br><br>  Veja como √© a solicita√ß√£o da API e a resposta que ela retorna: <br><br><pre> <code class="plaintext hljs">curl -X GET https://api.starwars.com/characters/1000?calendar=BBY {    "id": 1000,    "name": "Luke Skywalker",    "birth_year": "19BBY" }</code> </pre> <br>  Para implementar esta API no Django, primeiro voc√™ precisa registrar o caminho da URL e a fun√ß√£o de apresenta√ß√£o respons√°vel por receber a solicita√ß√£o HTTP feita ao longo desse caminho e retornar a resposta. <br><br><pre> <code class="python hljs">urlpatterns = [    url(<span class="hljs-string"><span class="hljs-string">"characters/&lt;id&gt;/"</span></span>, get_character) ]</code> </pre> <br>  A fun√ß√£o, como entrada, aceita os par√¢metros request e URL (no nosso caso, <code>id</code> ).  Ele analisa e lan√ßa o par√¢metro de solicita√ß√£o de <code>calendar</code> , que √© o valor da enumera√ß√£o correspondente, para o tipo necess√°rio.  Ele carrega dados de caracteres da loja e retorna um dicion√°rio serializado em JSON e agrupado em uma resposta HTTP. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: IGWSGIRequest, id: str)</span></span></span><span class="hljs-function"> -&gt; JsonResponse:</span></span>    calendar = Calendar(request.GET.get(<span class="hljs-string"><span class="hljs-string">"calendar"</span></span>, <span class="hljs-string"><span class="hljs-string">"BBY"</span></span>))    character = Store.get_character(id, calendar)    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonResponse(asdict(character))</code> </pre> <br>  Embora a fun√ß√£o seja fornecida com anota√ß√µes de tipo, ela n√£o descreve explicitamente o contrato definitivo para a API HTTP.  A partir da assinatura desta fun√ß√£o, n√£o podemos descobrir os nomes ou tipos de par√¢metros de solicita√ß√£o ou campos de resposta e seus tipos. <br><br>  √â poss√≠vel tornar a assinatura da representa√ß√£o da fun√ß√£o exatamente a mesma informa√ß√£o que a assinatura da fun√ß√£o considerada anteriormente com anota√ß√µes de tipo? <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_character</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: int, calendar: Calendar)</span></span></span><span class="hljs-function"> -&gt; Character:</span></span>    ...</code> </pre> <br>  Os par√¢metros de fun√ß√£o podem ser par√¢metros de consulta (URL, consulta ou par√¢metros do corpo da consulta).  O tipo de valor retornado pela fun√ß√£o pode representar o conte√∫do da resposta.  Com essa abordagem, ter√≠amos √† disposi√ß√£o um contrato expl√≠cito e compreens√≠vel para a API HTTP, cuja observ√¢ncia poderia ser assegurada por um sistema de verifica√ß√£o de tipo. <br><br><h2>  <font color="#3AC1EF">Implementa√ß√£o</font> </h2><br>  Como implementar essa ideia? <br><br>  N√≥s usamos um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">decorador</a> para converter uma fun√ß√£o de representa√ß√£o fortemente tipada em uma fun√ß√£o de representa√ß√£o do Django.  Esta etapa n√£o requer altera√ß√µes em termos de trabalho com a estrutura do Django.  Podemos usar o mesmo middleware, as mesmas rotas e outros componentes aos quais estamos acostumados. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@api_view def get_character(id: int, calendar: Calendar) -&gt; Character:    ...</span></span></code> </pre> <br>  Considere os detalhes da <code>api_view</code> decorador <code>api_view</code> : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(view)</span></span></span><span class="hljs-function">:</span></span>    @functools.wraps(view)    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">django_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span>        params = {            param_name: param.annotation(extract(request, param))            <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> param_name, param <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> inspect.signature(view).parameters.items()        }        data = view(**params)        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonResponse(asdict(data))       <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> django_view</code> </pre> <br>  Este √© um peda√ßo dif√≠cil de c√≥digo para entender.  Vamos analisar suas caracter√≠sticas. <br>  N√≥s, como valor de entrada, pegamos uma fun√ß√£o de representa√ß√£o fortemente tipada e a envolvemos em uma fun√ß√£o de representa√ß√£o regular do Django, que retornamos: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">api_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(view)</span></span></span><span class="hljs-function">:</span></span>    @functools.wraps(view)    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">django_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span>        ...    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> django_view</code> </pre> <br>  Agora d√™ uma olhada na implementa√ß√£o da fun√ß√£o view do Django.  Primeiro, precisamos construir argumentos para uma fun√ß√£o de apresenta√ß√£o fortemente tipada.  Usamos a introspec√ß√£o e o m√≥dulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inspecionar</a> para obter a assinatura dessa fun√ß√£o e iterar sobre seus par√¢metros: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> param_name, param <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> inspect.signature(view).parameters.items()</code> </pre> <br>  Para cada par√¢metro, chamamos a fun√ß√£o <code>extract</code> , que extrai o valor do par√¢metro da solicita√ß√£o. <br><br>  Em seguida, convertemos o par√¢metro no tipo esperado especificado na assinatura (por exemplo, convertemos o <code>calendar</code> da string em um valor que √© um elemento da enumera√ß√£o do <code>Calendar</code> ). <br><br><pre> <code class="python hljs">param.annotation(extract(request, param))</code> </pre> <br>  Chamamos uma fun√ß√£o de exibi√ß√£o fortemente tipada com os argumentos que constru√≠mos: <br><br><pre> <code class="python hljs">data = view(**params)</code> </pre> <br>  A fun√ß√£o retorna um valor fortemente tipado da classe <code>Character</code> .  N√≥s pegamos esse valor, transformamos em um dicion√°rio e envolvemos em uma resposta HTTP no formato JSON: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> JsonResponse(asdict(data))</code> </pre> <br>  √ìtimo!  Agora temos uma fun√ß√£o de exibi√ß√£o do Django que envolve uma fun√ß√£o de exibi√ß√£o fortemente tipada.  Por fim, d√™ uma olhada na fun√ß√£o <code>extract</code> : <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extract</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: HttpRequest, param: Parameter)</span></span></span><span class="hljs-function"> -&gt; Any:</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> request.resolver_match.route.contains(<span class="hljs-string"><span class="hljs-string">f"&lt;</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{param}</span></span></span><span class="hljs-string">&gt;"</span></span>):        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.resolver_match.kwargs.get(param.name)    <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>:        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.GET.get(param.name)</code> </pre> <br>  Cada par√¢metro pode ser um par√¢metro de URL ou de solicita√ß√£o.  O caminho da URL de solicita√ß√£o (o caminho que registramos no in√≠cio) est√° dispon√≠vel no objeto de rota do sistema localizador de URLs do Django.  Verificamos o nome do par√¢metro no caminho.  Se houver um nome, temos um par√¢metro de URL.  Isso significa que, de alguma forma, podemos extra√≠-lo da solicita√ß√£o.  Caso contr√°rio, este √© um par√¢metro de consulta e tamb√©m podemos extra√≠-lo, mas de alguma outra maneira. <br><br>  Isso √© tudo.  Esta √© uma implementa√ß√£o simplificada, mas ilustra a ideia b√°sica de digitar uma API. <br><br><h2>  <font color="#3AC1EF">Tipos de dados</font> </h2><br>  O tipo usado para representar o conte√∫do da resposta HTTP (ou seja, <code>Character</code> ) pode ser representado por uma classe de dados ou por um dicion√°rio digitado. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Uma classe de</a> dados √© um formato de descri√ß√£o de classe compacto que representa dados. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> dataclasses <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> dataclass @dataclass(frozen=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Character</span></span></span><span class="hljs-class">:</span></span>    id: int    name: str    birth_year: str luke = Character(    id=<span class="hljs-number"><span class="hljs-number">1000</span></span>,    name=<span class="hljs-string"><span class="hljs-string">"Luke Skywalker"</span></span>,    birth_year=<span class="hljs-string"><span class="hljs-string">"19BBY"</span></span> )</code> </pre> <br>  O Instagram normalmente usa classes de dados para modelar objetos de resposta HTTP.  Aqui est√£o suas principais caracter√≠sticas: <br><br><ul><li>  Eles geram automaticamente constru√ß√µes de modelo e v√°rios m√©todos auxiliares. </li><li>  Eles s√£o compreens√≠veis para digitar sistemas de verifica√ß√£o, o que significa que os valores podem estar sujeitos a verifica√ß√£o de tipo. </li><li>  Eles mant√™m a imunidade gra√ßas √† constru√ß√£o <code>frozen=True</code> . </li><li>  Eles est√£o dispon√≠veis na biblioteca padr√£o do Python 3.7 ou como um backport no Python Package Index. </li></ul><br>  Infelizmente, o Instagram tem uma base de c√≥digo desatualizada que usa dicion√°rios grandes e sem tipo, passados ‚Äã‚Äãentre fun√ß√µes e m√≥dulos.  N√£o seria f√°cil traduzir todo esse c√≥digo de dicion√°rios para classes de dados.  Como resultado, n√≥s, usando classes de dados para o novo c√≥digo, e no c√≥digo desatualizado, usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">dicion√°rios digitados</a> . <br><br>  O uso de dicion√°rios digitados nos permite adicionar anota√ß√µes de tipo aos objetos de dicion√°rio do cliente e, sem alterar o comportamento de um sistema em funcionamento, usar os recursos de verifica√ß√£o de tipo. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mypy_extensions <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TypedDict <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Character</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(TypedDict)</span></span></span><span class="hljs-class">:</span></span>    id: int    name: str    birth_year: str luke: Character = {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>} luke[<span class="hljs-string"><span class="hljs-string">"name"</span></span>] = <span class="hljs-string"><span class="hljs-string">"Luke Skywalker"</span></span> luke[<span class="hljs-string"><span class="hljs-string">"birth_year"</span></span>] = <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-comment"><span class="hljs-comment"># type error, birth_year expects a str luke["invalid_key"] # type error, invalid_key does not exist</span></span></code> </pre> <br><h2>  <font color="#3AC1EF">Tratamento de erros</font> </h2><br>  Espera-se que a fun√ß√£o view retorne informa√ß√µes sobre caracteres na forma de uma entidade <code>Character</code> .  O que devemos fazer se precisarmos retornar um erro ao cliente? <br><br>  Voc√™ pode lan√ßar uma exce√ß√£o que ser√° capturada pela estrutura e convertida em uma resposta HTTP com informa√ß√µes de erro. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@api_view("GET") def get_character(id: str, calendar: Calendar) -&gt; Character:    try:        return Store.get_character(id)    except CharacterNotFound:        raise Http404Exception()</span></span></code> </pre> <br>  Este exemplo tamb√©m demonstra o m√©todo HTTP no decorador, que define os m√©todos HTTP permitidos para esta API. <br><br><h2>  <font color="#3AC1EF">As ferramentas</font> </h2><br>  A API HTTP √© fortemente digitada usando o m√©todo HTTP, tipos de solicita√ß√£o e tipos de resposta.  Podemos examinar essa API e determinar se ela deve aceitar uma solicita√ß√£o GET com a sequ√™ncia de <code>id</code> no caminho da URL e com o valor do <code>calendar</code> relacionado √† enumera√ß√£o correspondente na sequ√™ncia de consultas.  Tamb√©m podemos aprender que, em resposta a essa solicita√ß√£o, uma resposta JSON deve ser fornecida com informa√ß√µes sobre a natureza do <code>Character</code> . <br><br>  O que pode ser feito com todas essas informa√ß√µes? <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">OpenAPI</a> √© um formato de descri√ß√£o de API com base no qual um conjunto rico de ferramentas auxiliares √© criado.  Este √© um ecossistema inteiro.  Se escrevermos algum c√≥digo para executar a introspec√ß√£o de terminais e gerar especifica√ß√µes OpenAPI com base nos dados recebidos, isso significa que teremos os recursos dessas ferramentas. <br><br><pre> <code class="python hljs">paths:  /characters/{id}:    get:      parameters:        - <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: path          name: id          schema:            type: integer          required: true        - <span class="hljs-keyword"><span class="hljs-keyword">in</span></span>: query          name: calendar          schema:            type: string            enum: [<span class="hljs-string"><span class="hljs-string">"BBY"</span></span>]      responses:        <span class="hljs-string"><span class="hljs-string">'200'</span></span>:          content:            application/json:              schema:                type: object                ...</code> </pre> <br>  Podemos gerar documenta√ß√£o da API HTTP para a API <code>get_character</code> , que inclui nomes, tipos, informa√ß√µes de solicita√ß√£o e resposta.  Esse √© um n√≠vel de abstra√ß√£o apropriado para desenvolvedores de clientes que precisam atender a solicita√ß√µes no terminal apropriado.  Eles n√£o precisam ler o c√≥digo de implementa√ß√£o do Python para este terminal. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/673/e79/28e/673e7928eb5c55d4d6ec83c506eaf450.png"><br>  <i><font color="#999999">Documenta√ß√£o da API</font></i> <br><br>  Nesta base, voc√™ pode criar ferramentas adicionais.  Por exemplo, um meio de executar uma solicita√ß√£o de um navegador.  Isso permite que os desenvolvedores acessem as APIs HTTP de seu interesse sem precisar escrever c√≥digo.  Podemos at√© gerar c√≥digo de cliente com seguran√ßa de tipo para garantir que os tipos funcionem corretamente no cliente e no servidor.  Devido a isso, podemos ter √† nossa disposi√ß√£o uma API estritamente digitada no servidor, para as quais as chamadas s√£o realizadas usando c√≥digo de cliente estritamente digitado. <br><br>  Al√©m disso, podemos criar um sistema de verifica√ß√£o de compatibilidade com vers√µes anteriores.  O que acontece se lan√ßarmos uma nova vers√£o do c√≥digo do servidor para acessar a API em quest√£o, precisamos usar <code>id</code> , <code>name</code> e ano de <code>birth_year</code> e entendemos que n√£o sabemos os anivers√°rios de todos os caracteres?  Nesse caso, o par√¢metro <code>birth_year</code> precisar√° ser opcional, mas vers√µes antigas de clientes que esperam um par√¢metro semelhante podem simplesmente parar de funcionar.  Embora nossas APIs sejam diferentes na digita√ß√£o expl√≠cita, os tipos correspondentes podem mudar (por exemplo, a API mudar√° se o uso do ano de nascimento do personagem for primeiro obrigat√≥rio e depois se tornar opcional).  Podemos rastrear altera√ß√µes de API e avisar os desenvolvedores de API, fornecendo avisos no momento certo de que, ao fazer algumas altera√ß√µes, eles podem atrapalhar o desempenho dos clientes. <br><br><h2>  <font color="#3AC1EF">Sum√°rio</font> </h2><br>  Existe toda uma gama de protocolos de aplicativos que os computadores podem usar para se comunicar. <br><br>  Um lado desse espectro √© representado por estruturas RPC como Thrift e gRPC.  Eles diferem na medida em que geralmente definem tipos estritos para solicita√ß√µes e respostas e geram c√≥digo de cliente e servidor para organizar a opera√ß√£o de solicita√ß√µes.  Eles podem ficar sem HTTP e at√© sem JSON. <br><br>  Por outro lado, existem estruturas da Web n√£o estruturadas escritas em Python que n√£o possuem contratos expl√≠citos para solicita√ß√µes e respostas.  Nossa abordagem fornece oportunidades t√≠picas para estruturas mais claramente estruturadas, mas ao mesmo tempo permite que voc√™ continue usando o pacote HTTP + JSON e contribui para o fato de que voc√™ deve fazer um m√≠nimo de altera√ß√µes no c√≥digo do aplicativo. <br><br>  √â importante notar que essa ideia n√£o √© nova.  Existem muitas estruturas escritas em linguagens fortemente tipadas que fornecem aos desenvolvedores os recursos que descrevemos.  Se falamos sobre Python, esse √©, por exemplo, o framework <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">APIStar</a> . <br><br>  Comissionamos com √™xito o uso de tipos para a API HTTP.  Conseguimos aplicar a abordagem descrita para digitar a API em toda a nossa base de c√≥digos, devido ao fato de ser bem aplic√°vel √†s fun√ß√µes de apresenta√ß√£o existentes.  O valor do que fizemos √© √≥bvio para todos os nossos programadores.  Ou seja, estamos falando do fato de que a documenta√ß√£o gerada automaticamente se tornou um meio eficaz de comunica√ß√£o entre quem desenvolve o servidor e quem escreve o cliente do Instagram. <br><br>  <b>Caros leitores!</b>  Como voc√™ aborda o design de APIs HTTP em seus projetos Python? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/webt/-o/2e/tu/-o2etuqogwhmdnmysb9_vivc9v4.png"></a> </div><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt474308/">https://habr.com/ru/post/pt474308/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt474294/index.html">Compatibilidade bin√°ria: agora ou nunca</a></li>
<li><a href="../pt474298/index.html">Implementando opera√ß√µes de transfer√™ncia de cart√£o para cart√£o de gateway P2P</a></li>
<li><a href="../pt474300/index.html">Backup confi√°vel, seguro e vers√°til para U2F</a></li>
<li><a href="../pt474302/index.html">Como escrever um script de teste de usabilidade de aplicativo eficaz</a></li>
<li><a href="../pt474306/index.html">Diferencie os estilos de apontar, foco e estado ativo.</a></li>
<li><a href="../pt474310/index.html">Existem n√∫meros aleat√≥rios em CSS?</a></li>
<li><a href="../pt474312/index.html">Instalando a GUI no Windows Server Core</a></li>
<li><a href="../pt474316/index.html">Carro el√©trico caseiro - parte 1. Como tudo come√ßou e como obtive 1.000.000 visualiza√ß√µes no youtube</a></li>
<li><a href="../pt474318/index.html">O que √© uma mesa virtual?</a></li>
<li><a href="../pt474320/index.html">Crise da comunidade DDD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>