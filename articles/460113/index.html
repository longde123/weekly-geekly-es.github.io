<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📻 🥩 🧚🏻 Algunas historias de la vida de JSOC CERT, o análisis forense de Unbanal 🥧 🚿 🚏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nosotros en JSOC CERT estamos investigando incidentes. En general, las 170 personas en JSOC están investigando, pero los casos tecnológicamente más de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Algunas historias de la vida de JSOC CERT, o análisis forense de Unbanal</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/solarsecurity/blog/460113/"><img src="https://habrastorage.org/webt/fw/po/fk/fwpofkq5njstadcz-dktv-oeokq.jpeg"><br><br>  Nosotros en JSOC CERT estamos investigando incidentes.  En general, las 170 personas en JSOC están investigando, pero los casos tecnológicamente más desafiantes caen en manos de expertos del CERT.  ¿Cómo, por ejemplo, detectar rastros de un malware si un atacante limpió?  ¿Cómo encontrar un "asistente" que eliminó documentos comerciales importantes de un servidor de archivos en el que el registro no está configurado correctamente?  Bueno, para el postre: ¿cómo puede un atacante obtener contraseñas de docenas de cuentas de dominio no relacionadas sin penetrar en la red?  Detalles, como siempre, debajo del corte. <br><a name="habracut"></a><br><h3>  Entre semana JSOC CERT </h3><br>  A menudo tenemos que evaluar el compromiso real de la red del cliente, para esto llevamos a cabo: <br><br><ul><li>  análisis retrospectivo de discos duros e imágenes de memoria, </li><li>  ingeniería inversa de malware </li><li>  si es necesario, despliegue de emergencia de monitoreo y escaneo de hosts en busca de indicadores de compromiso y rastros de piratería. </li></ul><br>  En nuestro tiempo libre, escribimos resúmenes detallados, técnicas y libros de jugadas, esencialmente instrucciones que ayudan a escalar incluso investigaciones complejas, como  puedes actuar sobre ellos de forma semiautomática. <br><br>  A veces, durante la respuesta al incidente, justo en medio de la extinción de un "incendio", también debe actuar como un "servicio de apoyo psicológico".  Una vez fuimos invitados a ayudar a contrarrestar la infección de la subred de una gran organización.  La red fue atendida por dos contratistas que, en esta situación, se <s>arrojaron</s> desinteresadamente <s>a un ventilador y</s> se involucraron en cualquier otra cosa, pero no buscaron un gusano malicioso.  Para reducir el grado de histeria, tuve que sentarme a todos en la mesa <s>para obtener una toalla y una botella de bourbon</s> y explicar claramente que ahora no es el momento de buscar al culpable.  Determinaron el procedimiento de distribución, lanzaron una auditoría adicional y comenzaron a limpiar sistemáticamente la infección juntos y juntos. <br><br>  Durante la investigación, a menudo tenemos que elegir imágenes de disco y memoria para encontrar malware activo allí.  Para hacer que el proceso sea predecible y objetivo, formalizamos y automatizamos varios métodos para el análisis de disco retrospectivo, y tomamos como base el método <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">SANS</a> ya clásico: en la versión original es de alto nivel, pero si se usa correctamente permite la detección de infección activa con una precisión muy alta. <br><br><img src="https://habrastorage.org/webt/5f/vc/fv/5fvcfvwxumpiwrynuvlo1s48f2a.jpeg"><br><br>  Está claro que realizar comprobaciones generales requiere tiempo y un profundo conocimiento experto sobre las características de los diversos componentes de los sistemas operativos (y el software especializado necesita mucho). <br><br>  <b>¿Cómo simplificar la comprobación de una infección activa en un disco?</b>  Compartimos el truco de la vida: puede verificarse dinámicamente (como en el sandbox), para esto: <br><br><ul><li>  copie el disco duro del host sospechoso poco a poco; </li><li>  convierte la imagen dd resultante al formato VMDK usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esta</a> utilidad; </li><li>  ejecute la imagen VMDK en Virtual Box / VMware; </li><li>  y analizar como un sistema vivo, centrándose en el tráfico. </li></ul><br>  <b><i>Pero siempre habrá incidentes para los que no se escriben instrucciones detalladas y las técnicas no están automatizadas.</i></b> <br><br><h3>  Caso 1. El contador no tiene nada que ver con eso, o cómo buscamos malware </h3><br>  El cliente nos pidió que revisáramos la computadora del contador en busca de malware: alguien hizo varias órdenes de pago a una dirección desconocida.  El contador afirmó que no estaba involucrado en esto y que la computadora se había comportado de manera extraña antes: el mouse a veces literalmente se movía alrededor de la pantalla; de hecho, se nos pidió que verificaramos estas indicaciones.  El problema fue que el troyano dirigido a 1C hizo sus trucos sucios y se aclaró, y después de que la infección pasó casi un mes, durante este tiempo, el diligente enikeyschik puso un montón de software, frotando el espacio en disco no asignado y minimizando así la probabilidad de éxito en la investigación. <br><br>  En tales casos, solo un analista experimentado y meticuloso y una base de datos de inteligencia de amenazas extensa y actualizada automáticamente pueden ayudar.  Entonces, durante el escaneo de la carpeta de inicio, una etiqueta sospechosa atrajo la atención indicando una supuesta utilidad de actualización antivirus: <br><br><img src="https://habrastorage.org/webt/au/ud/av/auudav_v3jtb0vqdga1r0nlca38.png"><br><br>  Desafortunadamente, la carcasa del troyano desde el disco no se pudo restaurar, pero los hechos de iniciar la utilidad de administración remota desde la misma carpeta "hicieron alarde" en el caché <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Superfetch</a> : <br><br><img src="https://habrastorage.org/webt/a_/6s/x4/a_6sx4vlbqcgc2n51htfy_hracq.png"><br><br>  Comparándolos con el momento del incidente, demostramos que no era el contador el culpable de robar el dinero, sino un atacante externo. <br><br><h3>  Caso 2. ¿Quién borró mis archivos? </h3><br>  La mayoría de nuestras investigaciones y respuestas a incidentes están de alguna manera relacionadas con la detección de malware, ataques dirigidos utilizando utilidades de múltiples módulos e historias similares donde hay un atacante externo.  Sin embargo, a veces hay investigaciones mucho más mundanas, pero no menos interesantes. <br><br>  El cliente tenía el servidor de archivos antiguo más común, cuyas carpetas públicas eran accesibles para varios departamentos.  En el servidor hay muchos documentos comerciales muy importantes que alguien tomó y eliminó.  Nos dimos cuenta tarde, después de que la copia de seguridad se sobrecargó.  Comenzaron a buscar al culpable. <br><br>  Si alguna vez trató de buscar en Google cómo determinar qué usuario eliminó el archivo, es probable que haya encontrado consejos que aparecen en los registros de Windows, si los configura correctamente de antemano (por cierto, ya le dimos un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">par de consejos</a> sobre cómo configurar registros): <br><br><img src="https://habrastorage.org/webt/xt/jl/yv/xtjlyvwma5smm-3v3wuoxcm1kkc.png"><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><i>Fuente</i></a> <br><br>  Pero en realidad, pocas personas realizan auditorías del sistema de archivos, cursi porque hay muchas operaciones de archivos y los registros se deshilacharán rápidamente, y se necesita un servidor separado para almacenar los registros ... <br><br>  Decidimos dividir la tarea en dos: primero, determinar CUÁNDO se eliminaron los archivos;  segundo, - La OMS se estaba conectando al servidor en el momento de la eliminación.  Si tiene una idea de las características de NTFS, entonces sabe que en la mayoría de las implementaciones de este sistema de archivos, cuando elimina un archivo, el espacio que ocupaba se marca como libre y sus marcas de tiempo no cambian.  Por lo tanto, a primera vista, no se puede establecer el tiempo de eliminación. <br><br>  Sin embargo, el sistema de archivos contiene no solo archivos, sino también carpetas.  Además, las carpetas tienen un atributo especial $ INDEX_ROOT, que describe el contenido de la carpeta como un árbol B.  Naturalmente, eliminar un archivo cambia el atributo $ INDEX_ROOT de la carpeta y, por lo tanto, cambia sus marcas de tiempo, en particular, en la estructura de $ STD_INFO.  Por lo tanto, es posible determinar el tiempo aproximado para eliminar una gran cantidad de archivos y carpetas por anomalía en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MFT (tabla de archivos principal)</a> : <br><br><img src="https://habrastorage.org/webt/rr/op/uy/rropuy-nl7np57uum_rxa2zrgxw.png"><br><br>  Después de saber cuándo se eliminaron aproximadamente los archivos, puede intentar averiguar quién estaba trabajando en el norte en ese momento para reducir el círculo de sospechosos.  Me vienen a la mente los siguientes métodos: <br><br><ul><li>  Por los registros del servidor mismo: por eventos con EventID 4624/4625, es visible cuando el usuario se conecta y desconecta; </li><li>  por registros de controlador de dominio: EventID 4768 le permite determinar que un usuario específico ha solicitado acceso al servidor; </li><li>  por tráfico (netflow / registros de enrutador interno) puede averiguar quién se comunicó activamente a través de la red con este servidor a través de smb. </li></ul><br>  En nuestro caso, estos datos ya no estaban allí: había pasado demasiado tiempo, los registros giraban.  En este caso, hay otro no muy confiable, pero sigue siendo un método, o más bien la clave de registro: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://web.archive.org/web/20180427090821/">Shellbags</a> .  Almacena información, en particular, sobre qué tipo de carpeta la última vez que el usuario la visitó: tabla, lista, iconos grandes, iconos pequeños, contenidos, etc.  Y la misma clave contiene marcas de tiempo, que pueden interpretarse con gran confianza como el momento de la última visita a la carpeta. <br><br>  Se encontró un método, lo único que quedaba era recopilar los registros de los hosts necesarios y analizarlos.  Para hacer esto, necesitas: <br><br><ul><li>  determinar por grupo de dominio quién tuvo acceso a la carpeta (en nuestro caso, había aproximadamente 300 usuarios); </li><li>  recopilar registros de todos los hosts en los que trabajaron estos usuarios (simplemente no puede hacer esto, necesita una utilidad especial para trabajar con la unidad directamente, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/jschicht/RawCopy</a> ); </li><li>  "Alimente" todos los registros en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Autopsia</a> y use el complemento Shellbags; </li><li>  Beneficio! </li></ul><br><img src="https://habrastorage.org/webt/aq/cb/wj/aqcbwj76a6htvj4qj4cnyddngiw.png"><br><br>  Específicamente, en este incidente, el momento de eliminar archivos coincidió con el momento en que un usuario visitó la raíz de la carpeta eliminada, lo que nos permitió reducir el círculo de sospechosos de 300 a 1. <br><br>  Lo que sucedió después con este empleado: la historia es silenciosa.  Solo sabemos que la niña confesó que lo hizo por accidente y continúa trabajando en la empresa. <br><br><h3>  Caso 3. Contraseña maestra: "robar" en un par de segundos (e incluso más rápido) </h3><br>  Un atacante ingresó a la red de un cliente que nos pidió ayuda a través de una VPN y fue detectado de inmediato.  Lo que no es sorprendente, porque justo después de ingresar, comenzó a escanear la subred con un escáner de vulnerabilidades: el chanipot parpadeó como un árbol de Navidad. <br><br>  Después de que se bloqueó la cuenta, el personal de seguridad del cliente comenzó a analizar los registros de VPN y vio que el atacante había usado más de 20 cuentas de dominio diferentes para penetración (con la mayoría, inició sesión con éxito, pero para algunos la autenticación falló).  Y surgió la pregunta lógica: ¿cómo descubrió las contraseñas de estas cuentas?  Nuestros muchachos de JSOC CERT fueron invitados a buscar la respuesta. <br><br>  En uno de los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">artículos anteriores,</a> ya hemos dicho que en las investigaciones las hipótesis deben formarse y verificarse a medida que disminuye su probabilidad.  Así lo hicimos esta vez, comenzando a describir los típicos vectores de robo de cuentas: <br><br><ul><li>  fuga de datos del servicio externo </li><li>  Fuerza bruta </li><li>  Mimikatz o similar </li><li>  Keylogger </li><li>  Suplantación de identidad </li><li>  NTLM-hash harvesting (por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/CylanceSPEAR/SMBTrap</a> ) o ataques de red similares. </li></ul><br>  Verificamos un montón de versiones, pero en ninguna parte hubo ni siquiera un indicio de un ataque.  No es que la investigación estuviera en un punto muerto, pero la voz interior y el sentido común sugirieron que algo andaba mal: debes dar un paso atrás y mirar la imagen más ampliamente. <br><br>  De hecho, a primera vista, todas estas cuentas no están conectadas de ninguna manera.  Sus propietarios son de diferentes departamentos separados geográficamente.  Usualmente usan un conjunto no superpuesto de servicios de la compañía.  Incluso el nivel de alfabetización en TI es diferente.  Sí, un paso atrás no fue suficiente, se necesitaba uno más. <br><br>  En este momento, logramos recolectar una gran cantidad de registros de diferentes sistemas de la empresa e identificar las huellas dejadas por el atacante.  Comenzaron a analizar dónde apareció (recuerdo: escaneó activamente la red interna de la compañía).  Notamos que en el contexto de un ruido de red distribuido uniformemente debido a exploits voladores, hay un número anormalmente grande de solicitudes al servicio de recuperación de contraseña.  Un servicio accesible desde Internet.  Hmm ... <br><br><img src="https://habrastorage.org/webt/nx/b1/xk/nxb1xks2lrp7ff6p9edajqkp8fq.png"><br><br>  Si está monitoreando eventos de seguridad, probablemente sepa que analizar los intentos de atacar un servidor accesible externamente a menudo no tiene sentido debido al ruido de Internet: generalmente es difícil distinguir ataques realmente serios de numerosos intentos de script kiddie.  Pero no siempre <br><br><img src="https://habrastorage.org/webt/dj/mm/or/djmmoreaqbaebd0ecccqifgnvl4.png"><br><br><img src="https://habrastorage.org/webt/sm/eq/sn/smeqsnqlx6yodg5hytj-wr2vmts.png"><br><br>  Después de pasar algún tiempo revisando los registros del servicio web, pudimos destacar los siguientes ataques al servicio: <br><br><ul><li>  Escanear con Acunetix </li><li>  Escaneo SQLmap </li><li>  Un gran número de solicitudes a una página. </li></ul><br>  El tercer ataque, a primera vista, es similar a los inicios de sesión de usuarios brutales.  Pero esto no es así, porque el servicio está protegido de esto, al menos por el hecho de que las contraseñas se almacenan en forma hash con sal, ¿o no?  Era necesario verificarlo rápidamente. <br><br>  La siguiente imagen muestra un esquema típico del servicio de restablecimiento de contraseña: <br><br><img src="https://habrastorage.org/webt/ng/ja/pu/ngjapuquafi2dcvswqwk1knp3xi.jpeg"><br><br>  Es interesante porque las contraseñas no siempre se almacenan de forma segura, hay un momento en el que están en el dominio público, ¡inmediatamente después de que se abre la aplicación y antes de su ejecución!  Una gran cantidad de consultas a una página resultó no ser fuerza bruta y no escaneo, sino consultas de alta frecuencia con inyección SQL, cuyo propósito era extraer contraseñas en el momento de su cambio. <br><br>  Entonces, después de modelar el ataque al servicio, comparar la información de los registros del servidor web, los registros de cambio de contraseña y varios dispositivos de red, aún encontramos el punto de penetración del atacante en la empresa. <br><br>  Entonces, colegas, profundicen en datos sin procesar y que la fuerza los acompañe. <br><br><img src="https://habrastorage.org/webt/jv/vp/zn/jvvpznkwwdnlfljvwthatwb0ee0.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460113/">https://habr.com/ru/post/460113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460099/index.html">Aplicación de aprendizaje automático a redes neuronales con arquitectura de transformador</a></li>
<li><a href="../460101/index.html">Operación XSS basada en cookies | $ 2300 Bug Bounty story</a></li>
<li><a href="../460107/index.html">Sistema ISP, perdona y adiós! Por qué y cómo escribimos nuestro panel de control del servidor</a></li>
<li><a href="../460109/index.html">Angular: cuando necesita ver la aplicación, pero el backend aún no está listo</a></li>
<li><a href="../460111/index.html">Versión actualizada de SAP Business One 9.3: lo que ha cambiado</a></li>
<li><a href="../460115/index.html">Diez años de programación en Erlang</a></li>
<li><a href="../460117/index.html">¿Son los clientes más grandes de Rusia un gran premio o un dolor de cabeza? Experiencia AGIMA</a></li>
<li><a href="../460119/index.html">Errores que el análisis de código estático no encuentra porque no se usa</a></li>
<li><a href="../460121/index.html">Errores que el análisis de código estático no encuentra porque no se usa</a></li>
<li><a href="../460123/index.html">¿Una tubería de procesamiento de datos declarativa sobre los actores? Por que no</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>