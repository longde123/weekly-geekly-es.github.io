<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ข ๐ค ๐ค ุดุจูุงุช ุงูููุงููุณ ูู Kubernetes ๐๐ป ๐ฉ๐ผโ๐ซ ๐คช</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ููุงุญุธุฉ perev. : ูุคูู ุงูููุงูุฉ ุงูุฃุตููุฉ ุ ูููููุงุณ ูููุง ุ ูู ูููุฏุณ ุญููู ุณูุณูู ุงูุฐู ูุฑุฑ ุงููุดุงุฑูุฉ ูุน ุฃูุฑุงูู ุ ูููุฏุณู ุงูุดุจูุงุช ุ ููู ุชุนูู ุดุจูุฉ Kubernetes ูู ุง...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุดุจูุงุช ุงูููุงููุณ ูู Kubernetes</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/420813/" style=";text-align:right;direction:rtl"> <i><b>ููุงุญุธุฉ</b></i>  <i><b>perev.</b></i>  <i>: ูุคูู ุงูููุงูุฉ ุงูุฃุตููุฉ ุ ูููููุงุณ ูููุง ุ ูู ูููุฏุณ ุญููู ุณูุณูู ุงูุฐู ูุฑุฑ ุงููุดุงุฑูุฉ ูุน ุฃูุฑุงูู ุ ูููุฏุณู ุงูุดุจูุงุช ุ ููู ุชุนูู ุดุจูุฉ Kubernetes ูู ุงูุฏุงุฎู.</i>  <i>ููููุงู ุจุฐูู ุ ูุณุชูุดู ุฃุจุณุท ุชูููู ูู ูู ุงููุฌููุนุฉ ุ ููุณุชุฎุฏู ุจูุดุงุท ุงูุญุณ ุงูุณููู ุ ููุนุฑูุชู ุจุงูุดุจูุงุช ูุฃุฏูุงุช ููููุณ / Kubernetes ุงูููุงุณูุฉ.</i>  <i>ุงุชุถุญ ุจุดูู ูุจูุฑ ุ ูููู ูู ุงููุงุถุญ ุฌุฏุง.</i> <br><br><img src="https://habrastorage.org/webt/gr/qw/d4/grqwd4putslwaijltw9yojfzjes.png"><br><br>  ุจุงูุฅุถุงูุฉ ุฅูู ุญูููุฉ ุฃู ุฏููู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Kubersey</a> Hightower's <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Kubernetes The Hard Way</a> ูุนูู ููุท ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุญุชู ุนูู AWS!</a> ) ุ ุฃุญุจุจุช ุงูุญูุงุธ ุนูู ุงูุดุจูุฉ ูุธููุฉ ูุจุณูุทุฉ.  ููุฐู ูุฑุตุฉ ุนุธููุฉ ูููู ุฏูุฑ ูุงุฌูุฉ ุดุจูุฉ ุงูุญุงููุงุช ( <a href="">CNI</a> ) ุ ุนูู ุณุจูู ุงููุซุงู.  ุจุนุฏ ูููู ูุฐุง ุ ุณุฃุถูู ุฃู ุดุจูุฉ Kubernetes ููุณุช ุจุฏูููุฉ ุฌุฏูุง ุญููุง ุ ุฎุงุตุฉ ูููุจุชุฏุฆูู ... ููุง ุชูุณ ุฃูุถูุง ุฃูู " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจุจุณุงุทุฉ ูุง ููุฌุฏ</a> ุดูุก ูุซู ุดุจูุฉ ููุญุงููุงุช". <a name="habracut"></a><br><br>  ุนูู ุงูุฑุบู ูู ูุฌูุฏ ููุงุฏ ุฌูุฏุฉ ุจุงููุนู ุญูู ูุฐุง ุงูููุถูุน (ุงูุธุฑ ุงูุฑูุงุจุท <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> ) ุ ุฅูุง ุฃููู ูู ุฃุฌุฏ ูุซููุง ูุฃุฌูุน ุจูู ูู ูุง ูู ุถุฑูุฑู ูุน ุงุณุชูุชุงุฌุงุช ุงููุฑู ุงูุชู ูุญุจูุง ูููุฑููุง ูููุฏุณู ุงูุดุจูุงุช ุ ููุง ููุถุญ ูุง ูุญุฏุซ ุจุงููุนู ูุฑุงุก ุงูููุงููุณ.  ูุฐูู ุ ูุฑุฑุช ุฌูุน ุงููุนูููุงุช ูู ูุตุงุฏุฑ ุนุฏูุฏุฉ - ุขูู ุฃู ูุณุงุนุฏู ุฐูู ูุฃู ุชููู ุจุดูู ุฃูุถู ููู ูุฑุชุจุท ูู ุดูุก ูุน ุจุนุถูุง ุงูุจุนุถ.  ูุฐู ุงููุนุฑูุฉ ูููุฉ ููุณ ููุท ูุงุฎุชุจุงุฑ ููุณู ุ ูููู ุฃูุถูุง ูุชุจุณูุท ุนูููุฉ ุชุดุฎูุต ุงููุดููุงุช.  ููููู ุงุชุจุงุน ุงููุซุงู ูู ูุฌููุนุชู ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Kubernetes The Hard Way</a> : ูุชู ุฃุฎุฐ ุฌููุน ุนูุงููู IP ูุงูุฅุนุฏุงุฏุงุช ูู ููุงู (ุงุนุชุจุงุฑูุง ูู ุนูููุงุช ูุงูู 2018 ุ ูุจู ุงุณุชุฎุฏุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุญุงููุงุช Nabla</a> ). <br><br>  ูุณูุจุฏุฃ ูู ุงูููุงูุฉ ุ ุนูุฏูุง ูููู ูุฏููุง ุซูุงุซ ูุญุฏุงุช ุชุญูู ูุซูุงุซ ุนูุฏ ุนูู: <br><br><img src="https://habrastorage.org/webt/am/vs/6j/amvs6jnhsuxzwhyoyod6vjk8cby.png"><br><br>  ูุฏ ุชูุงุญุธ ุฃู ููุงู ุฃูุถูุง ุซูุงุซ ุดุจูุงุช ูุฑุนูุฉ ุฎุงุตุฉ ุนูู ุงูุฃูู ููุง!  ุงููููู ูู ุงูุตุจุฑ ุ ูุณูุชู ุงููุธุฑ ูููุง ุฌููุนูุง.  ุชุฐูุฑ ุฃูู ุนูู ุงูุฑุบู ูู ุฃููุง ูุดูุฑ ุฅูู ุจุงุฏุฆุงุช IP ูุญุฏุฏุฉ ููุบุงูุฉ ุ ุฅูุง ุฃููุง ูุฃุฎูุฐุฉ ุจุจุณุงุทุฉ ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Kubernetes The Hard Way</a> ุ ูุฐุง ููู ุฐุงุช ุฃูููุฉ ูุญููุฉ ููุท ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุฏูู ูุทูู</a> ุงูุญุฑูุฉ ูู ุงุฎุชูุงุฑ ุฃู ูุชูุฉ ุนูุงููู ุฃุฎุฑู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุจูุฆุชู</a> ููููุง ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">RFC 1918</a> .  ูู ุญุงูุฉ IPv6 ุ ุณูููู ููุงู ููุงูุฉ ูุฏููุฉ ูููุตูุฉ. <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุดุจูุฉ ุงููุถููุฉ (10.240.0.0/24) </h2><br>  ูุฐู ุดุจูุฉ ุฏุงุฎููุฉ ุชุดูู ุฌููุน ุงูุนูุฏ ุฌุฒุกูุง ูููุง.  ูุญุฏุฏ ุจูุงุณุทุฉ ุนูุงูุฉ <code>--private-network-ip</code> ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">GCP</a> ุฃู ุฎูุงุฑ <code>--private-ip-address</code> ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">AWS</a> ุนูุฏ ุชุฎุตูุต ููุงุฑุฏ ุงูุญูุณุจุฉ. <br><br><h3 style=";text-align:right;direction:rtl">  ุชููุฆุฉ ุนูุฏ ูุญุฏุฉ ุงูุชุญูู ูู GCP </h3><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0 1 2; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> gcloud compute instances create controller-<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> \ <span class="hljs-comment"><span class="hljs-comment"># ... --private-network-ip 10.240.0.1${i} \ # ... done</span></span></code> </pre> <br>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>controllers_gcp.sh</code></a> ) <br><br><h3 style=";text-align:right;direction:rtl">  ุชููุฆุฉ ุนูุฏ ูุญุฏุฉ ุงูุชุญูู ูู AWS </h3><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0 1 2; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">declare</span></span> controller_id<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>=`aws ec2 run-instances \ <span class="hljs-comment"><span class="hljs-comment"># ... --private-ip-address 10.240.0.1${i} \ # ... done</span></span></code> </pre> <br>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>controllers_aws.sh</code></a> ) <br><br><img src="https://habrastorage.org/webt/gt/cj/p6/gtcjp6fgkqbv1nvs2ea9d9hhueo.png"><br><br>  ุณูููู ููู ูุซูู ุนููุงููู IP: ุฎุงุต ูู ุงูุดุจูุฉ ุงููุถููุฉ (ูุญุฏุงุช ุงูุชุญูู - <code>10.240.0.1${i}/24</code> ุ ุงูุนูุงู - <code>10.240.0.2${i}/24</code> ) <code>10.240.0.2${i}/24</code> ุ ูุชู ุชุนูููู ูู ูุจู ูุฒูุฏ ุงูุณุญุงุจุฉ ุ ูุงูุฐู ุณูุชุญุฏุซ ุนูู ูุงุญููุง ููููุฉ ุงููุตูู ุฅูู <code>NodePorts</code> . <br><br><h3 style=";text-align:right;direction:rtl">  Gcp </h3><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ gcloud compute instances list NAME ZONE MACHINE_TYPE PREEMPTIBLE INTERNAL_IP EXTERNAL_IP STATUS controller-0 us-west1-c n1-standard-1 10.240.0.10 35.231.XXX.XXX RUNNING worker-1 us-west1-c n1-standard-1 10.240.0.21 35.231.XX.XXX RUNNING ...</code> </pre> <br><br><h3 style=";text-align:right;direction:rtl">  ุฃูุณ </h3><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ aws ec2 describe-instances --query <span class="hljs-string"><span class="hljs-string">'Reservations[].Instances[].[Tags[?Key==`Name`].Value[],PrivateIpAddress,PublicIpAddress]'</span></span> --output text | sed <span class="hljs-string"><span class="hljs-string">'$!N;s/\n/ /'</span></span> 10.240.0.10 34.228.XX.XXX controller-0 10.240.0.21 34.173.XXX.XX worker-1 ...</code> </pre> <br>  ูุฌุจ ุฃู ุชููู ุฌููุน ุงูุนูุฏ ูุงุฏุฑุฉ ุนูู ุชูููุฐ ุงูุฃูุฑ ping ูุจุนุถูุง ุงูุจุนุถ ุฅุฐุง ูุงูุช <a href="">ุณูุงุณุงุช ุงูุฃูุงู ุตุญูุญุฉ</a> (ูุฅุฐุง <code>ping</code> ุชุซุจูุช <code>ping</code> ุนูู ุงููุถูู). <br><br><h2 style=";text-align:right;direction:rtl">  ุดุจูุฉ ุงููููุฏ (10.200.0.0/16) </h2><br>  ูุฐู ูู ุงูุดุจูุฉ ุงูุชู ุชุนูุด ูููุง ุงููุฑูู.  ุชุณุชุฎุฏู ูู ุนูุฏุฉ ุนูู ุดุจูุฉ ูุฑุนูุฉ ูู ูุฐู ุงูุดุจูุฉ.  ูู ุญุงูุชูุง ุ <code>POD_CIDR=10.200.${i}.0/24</code> <code>worker-${i}</code> . <br><br><img src="https://habrastorage.org/webt/6i/yz/ih/6iyzihbxbzwugs4amvhfa9ysp5s.png"><br><br>  ูููู ููููุฉ ุชูููู ูู ุดูุก ุ ุชุฑุงุฌุน ุฎุทูุฉ ูููุฑุงุก ูุงูุธุฑ ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูููุฐุฌ ุดุจูุฉ Kubernetes</a> ุ ุงูุฐู ูุชุทูุจ ูุง ููู: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ูููู ูุฌููุน ุงูุญุงููุงุช ุงูุชูุงุตู ูุน ุฃู ุญุงููุงุช ุฃุฎุฑู ุฏูู ุงุณุชุฎุฏุงู NAT. </li><li style=";text-align:right;direction:rtl">  ูููู ูุฌููุน ุงูุนูุฏ ุงูุชูุงุตู ูุน ุฌููุน ุงูุญุงููุงุช (ูุงูุนูุณ ุตุญูุญ) ุฏูู ุงุณุชุฎุฏุงู NAT. </li><li style=";text-align:right;direction:rtl">  ูุฌุจ ุฃู ูููู ุนููุงู IP ุงูุฐู ุชุฑุงู ุงูุญุงููุฉ ูู ููุณู ุงูุฐู ูุฑุงู ุงูุขุฎุฑูู. </li></ul><br>  ูููู ุชูููุฐ ูู ูุฐุง ุจุนุฏุฉ ุทุฑู ุ ูููุฑุฑ Kubernetes ุฅุนุฏุงุฏ ุงูุดุจูุฉ ุฅูู <a href="">ุงููููู ุงูุฅุถุงูู CNI</a> . <br><br><blockquote style=";text-align:right;direction:rtl">  "ุฅู ุงูููููู ุงูุฅุถุงูู CNI ูุณุคูู ุนู ุฅุถุงูุฉ ูุงุฌูุฉ ุดุจูุฉ ุฅูู <b>ูุณุงุญุฉ ุงุณู ุดุจูุฉ</b> ุงูุญุงููุฉ (ุนูู ุณุจูู ุงููุซุงู ุ ุฃุญุฏ <b>ุทุฑูู ุฒูุฌ veth</b> ) ูุฅุฌุฑุงุก ุงูุชุบููุฑุงุช ุงููุงุฒูุฉ ุนูู ุงููุถูู (ุนูู ุณุจูู ุงููุซุงู ุ ุชูุตูู ุงูุทุฑู ุงูุซุงูู ูู veth ุจุฌุณุฑ).  ุซู ูุฌุจ ุนููู ุชุนููู ูุงุฌูุฉ IP ูุชูููู ุงููุณุงุฑุงุช ููููุง ููุณู ุฅุฏุงุฑุฉ ุนููุงู IP ุนู ุทุฑูู ุงุณุชุฏุนุงุก ุงูุจุฑูุงูุฌ ุงููุณุงุนุฏ IPAM ุงููุทููุจ. "  <i>(ูู <a href="">ููุงุตูุงุช ูุงุฌูุฉ ุดุจูุฉ ุงูุญุงููุงุช</a> )</i> </blockquote><br><img src="https://habrastorage.org/webt/5q/fs/vw/5qfsvwg2iuduy0q3doco11hbf-g.png"><br><br><h3 style=";text-align:right;direction:rtl">  ูุณุงุญุฉ ุงุณู ุงูุดุจูุฉ </h3><br><blockquote style=";text-align:right;direction:rtl">  "ุชูู ูุณุงุญุฉ ุงูุงุณู ููุฑุฏ ุงููุธุงู ุงูุนุงููู ุฅูู ุชุฌุฑูุฏ ูุฑุฆู ููุนูููุงุช ูู ูุณุงุญุฉ ุงูุงุณู ูุฐู ุจุญูุซ ูููู ููุง ูุซูููุง ุงููุนุฒูู ุงูุฎุงุต ุจูุง ููููุฑุฏ ุงูุนุงู.  ุชููู ุงูุชุบููุฑุงุช ูู ุงูููุฑุฏ ุงูุนุงููู ูุฑุฆูุฉ ููุนูููุงุช ุงูุฃุฎุฑู ุงููุถููุฉ ูู ูุณุงุญุฉ ุงูุงุณู ูุฐู ุ ูููููุง ุบูุฑ ูุฑุฆูุฉ ููุนูููุงุช ุงูุฃุฎุฑู. "  <i>( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูู ุตูุญุฉ ุฏููู ูุณุงุญุงุช ุงูุฃุณูุงุก</a> )</i> </blockquote><br>  ูููุฑ Linux ุณุจุนุฉ ูุณุงุญุงุช ุฃุณูุงุก ูุฎุชููุฉ ( <code>Cgroup</code> ู <code>IPC</code> ู <code>Network</code> ู <code>Mount</code> ู <code>PID</code> ู <code>User</code> ู <code>UTS</code> ).  ุชุญุฏุฏ ูุณุงุญุงุช ุฃุณูุงุก ุงูุดุจูุฉ ( <code>CLONE_NEWNET</code> ) ููุงุฑุฏ ุงูุดุจูุฉ ุงููุชุงุญุฉ ููุนูููุฉ: "ููู ูุณุงุญุฉ ุงุณู ุดุจูุฉ ุฃุฌูุฒุฉ ุดุจูุฉ ุฎุงุตุฉ ุจูุง ูุนูุงููู IP ูุฌุฏุงูู ุชูุฌูู IP ู <code>/proc/net</code> directory ูุฃุฑูุงู ุงูููุงูุฐ ููุง ุฅูู ุฐูู" <i>( ูู ููุงูุฉ " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุณุงุญุงุช ุงูุฃุณูุงุก ููุฏ ุงูุชุดุบูู</a> ")</i> . <br><br><h3 style=";text-align:right;direction:rtl">  ุฃุฌูุฒุฉ Ethernet ุงูุงูุชุฑุงุถูุฉ (Veth) </h3><br><blockquote style=";text-align:right;direction:rtl">  ูููุฑ "ุฒูุฌ ุดุจูุฉ ุธุงูุฑู (veth) ุชุฌุฑูุฏูุง ูู ุดูู" ูุงุณูุฑุฉ "" ุ ูุงูุชู ูููู ุงุณุชุฎุฏุงููุง ูุฅูุดุงุก ุงูุฃููุงู ุจูู ูุณุงุญุงุช ุฃุณูุงุก ุงูุดุจูุฉ ุฃู ูุฅูุดุงุก ุฌุณุฑ ุฅูู ุฌูุงุฒ ุดุจูุฉ ูุนูู ูู ูุณุงุญุฉ ุดุจูุฉ ุฃุฎุฑู.  ุนูุฏูุง ูุชู ุชุญุฑูุฑ ูุณุงุญุฉ ุงูุงุณู ุ ูุชู ุชุฏููุฑ ุฌููุน ุฃุฌูุฒุฉ veth ุงูููุฌูุฏุฉ ูููุง ".  <i>(ูู ุตูุญุฉ ุงูุฏููู ุงูุฎุงุตุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจูุณุงุญุงุช ุฃุณูุงุก ุงูุดุจูุฉ</a> )</i> </blockquote><br>  ุงูุฒู ุฅูู ุงูุฃุฑุถ ูุงูุธุฑ ููู ูุฑุชุจุท ูู ุฐูู ุจุงููุฌููุนุฉ.  ุฃููุงู ุ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููููุงุช ุงูุฅุถุงููุฉ ููุดุจูุฉ</a> ูู Kubernetes ูุชููุนุฉ ุ ูููููุงุช CNI ุงูุฅุถุงููุฉ ูุงุญุฏุฉ ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุงุฐุง ูุง CNMุ</a> ).  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุฎุจุฑ Kubelet</a> ูู ูู ุนูุฏุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุช ุชุดุบูู</a> ุงูุญุงููุฉ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุจุงูุดุจูุฉ ุงูุฅุถุงููุฉ ุงูุชู ูุฌุจ</a> ุงุณุชุฎุฏุงููุง.  ุชูุน ูุงุฌูุฉ ุดุจูุฉ ุงูุญุงููุงุช ( <a href="">CNI</a> ) ุจูู ููุช ุชุดุบูู ุงูุญุงููุฉ ูุชูููุฐ ุงูุดุจูุฉ.  ููููู ุงูุจุฑูุงูุฌ ุงููุณุงุนุฏ CNI ุจุงููุนู ุจุฅุนุฏุงุฏ ุงูุดุจูุฉ. <br><br><blockquote style=";text-align:right;direction:rtl">  "ุชู ุชุญุฏูุฏ ุงููููููู ุงูุฅุถุงูู CNI ุจุชูุฑูุฑ <code>--network-plugin=cni</code> ุณุทุฑ ุงูุฃูุงูุฑ <code>--network-plugin=cni</code> ุฅูู Kubelet.  ููุฑุฃ Kubelet ุงูููู ูู <code>--cni-conf-dir</code> (ุงูุงูุชุฑุงุถู ูู <code>/etc/cni/net.d</code> ) ููุณุชุฎุฏู ุชูููู CNI ูู ูุฐุง ุงูููู ูุชูููู ุงูุดุจูุฉ ููู ููู. "  <i>(ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุชุทูุจุงุช ุงูุจุฑูุงูุฌ ุงููุณุงุนุฏ ููุดุจูุฉ</a> )</i> </blockquote><br>  ุงูุซูุงุฆูุงุช ุงูุญููููุฉ <code>-- cni-bin-dir</code> ุงูุฅุถุงูู CNI ูู <code>-- cni-bin-dir</code> (ุงูุงูุชุฑุงุถู ูู <code>/opt/cni/bin</code> ). <br><br>  ูุฑุฌู ููุงุญุธุฉ ุฃู <a href=""><code>kubelet.service</code></a> ุงุณุชุฏุนุงุก <code>--network-plugin=cni</code> ุชุดูู <code>--network-plugin=cni</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">[Service] ExecStart=/usr/local/bin/kubelet \\ --config=/var/lib/kubelet/kubelet-config.yaml \\ --network-plugin=cni \\ ...</code> </pre> <br>  ุจุงุฏุฆ ุฐู ุจุฏุก ุ ุชููู Kubernetes ุจุฅูุดุงุก ูุณุงุญุฉ ุงุณู ุดุจูุฉ ูููููุฏ ุ ุญุชู ูุจู ุงุณุชุฏุนุงุก ุฃู ููููุงุช ุฅุถุงููุฉ.  ูุชู ุชูููุฐ ุฐูู ุจุงุณุชุฎุฏุงู ุญุงููุฉ <code>pause</code> ุงูุฎุงุตุฉ ุ "ุงูุชู ุชุนูู ุจูุซุงุจุฉ" ุงูุญุงููุฉ ุงูุฑุฆูุณูุฉ "ูุฌููุน ุญุงููุงุช ุงููููุฏ" <i>(ูู ููุงูุฉ " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">The Pause Almighty Pause Container</a> ")</i> .  ุซู ุชููู Kubernetes ุจุชูููุฐ ุงูุจุฑูุงูุฌ ุงููุณุงุนุฏ CNI ูุฅุฑูุงู ุญุงููุฉ <code>pause</code> ุจุงูุดุจูุฉ.  ุชุณุชุฎุฏู ุฌููุน ุญุงููุงุช pod <code>netns</code> <code>pause</code> ูุฐู. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">{ "cniVersion": "0.3.1", "name": "bridge", "type": "bridge", "bridge": "cnio0", "isGateway": true, "ipMasq": true, "ipam": { "type": "host-local", "ranges": [ [{"subnet": "${POD_CIDR}"}] ], "routes": [{"dst": "0.0.0.0/0"}] } }</code> </pre> <br>  ูุดูุฑ <a href="">ุชูููู CNI ุงููุณุชุฎุฏู</a> ุฅูู ุงุณุชุฎุฏุงู ุงูููููู ุงูุฅุถุงูู <code>bridge</code> ูุชูููู <code>bridge</code> ุจุฑูุงูุฌ Linux (L2) ูู ูุณุงุญุฉ ุงุณู ุงูุฌุฐุฑ ุงูุชู ุชุณูู <code>cnio0</code> ( <a href="">ุงูุงุณู ุงูุงูุชุฑุงุถู</a> ูู <code>cni0</code> ) ุ ูุงูุฐู ูุนูู ูุจูุงุจุฉ ( <code>"isGateway": true</code> ). <br><br><img src="https://habrastorage.org/webt/bo/to/jp/botojpqu0f7fascfrbk-gen27a8.png"><br><br>  ุณูุชู ุฃูุถูุง ุชูููู ุฒูุฌ veth ูุฑุจุท ุงููููุฏ ุจุงูุฌุณุฑ ุงูุฐู ุชู ุฅูุดุงุคู ุญุฏูุซูุง: <br><br><img src="https://habrastorage.org/webt/-6/tt/e7/-6tte7essirvuraiuypuln_syvm.png"><br><br>  ูุชุนููู ูุนูููุงุช L3 ุ ูุซู ุนูุงููู IP ุ ูุชู ุงุณุชุฏุนุงุก <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุจุฑูุงูุฌ ุงููุณุงุนุฏ IPAM</a> ( <code>ipam</code> ).  ูู ูุฐู ุงูุญุงูุฉ ุ ูุชู ุงุณุชุฎุฏุงู ููุน <code>host-local</code> ุ "ุงูุฐู ูููู ุจุชุฎุฒูู ุงูุญุงูุฉ ูุญูููุง ุนูู ูุธุงู ููู ุงููุถูู ุ ููุง ูุถูู ุชูุฑุฏ ุนูุงููู IP ุนูู ูุถูู ูุงุญุฏ" <i>(ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code> host-local</code></a> )</i> .  ูุนูุฏ ุงููููููู ุงูุฅุถุงูู IPAM ูุฐู ุงููุนูููุงุช ุฅูู ุงูููููู ุงูุฅุถุงูู ุงูุณุงุจู ( <code>bridge</code> ) ุ ุจุญูุซ ูููู ุชููุฆุฉ ุฌููุน ุงููุณุงุฑุงุช ุงููุญุฏุฏุฉ ูู ุงูุชููุฆุฉ ( <code>"routes": [{"dst": "0.0.0.0/0"}]</code> ).  ุฅุฐุง ูู <code>gw</code> ุชุญุฏูุฏ <code>gw</code> ุ <a href="">ูุชู ุฃุฎุฐู ูู ุงูุดุจูุฉ ุงููุฑุนูุฉ</a> .  ูุชู ุชูููู ุงููุณุงุฑ ุงูุงูุชุฑุงุถู ุฃูุถูุง ูู ูุณุงุญุฉ ุงุณู ุดุจูุฉ ุงููููุฏ ุ ูุดูุฑูุง ุฅูู ุงูุฌุณุฑ (ุงูุฐู ุชู ุชููููู ูุฃูู ุดุจูุฉ ูุฑุนูุฉ IP ูููููุฏ). <br><br>  ูุขุฎุฑ ุงูุชูุงุตูู ุงููููุฉ: ุทูุจูุง ุงูุชููุฑ ( <code>"ipMasq": true</code> ) ูุญุฑูุฉ ุงููุฑูุฑ ุงููุงุฏูุฉ ูู ุดุจูุฉ ุงููููุฏ.  ูุง ูุญุชุงุฌ ุฅูู NAT ุญููุง ููุง ุ ูููู ูุฐุง ูู ุงูุชูููู ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Kubernetes The Hard Way</a> .  ูุฐูู ุ ูู ุฃุฌู ุงูุงูุชูุงู ุ ูุฌุจ ุฃู ุฃุฐูุฑ ุฃู ุงูุฅุฏุฎุงูุงุช ูู <code>iptables</code> ููููู <code>bridge</code> ุงูุฅุถุงูู ุชู ุชูููููุง ููุฐุง ุงููุซุงู ุงููุญุฏุฏ.  ุฌููุน ุงูุญุฒู ูู ุงููููุฏ ุ ุงูุชู ูุง ูููู ุงููุณุชูู ุถูู ุงููุทุงู <code>224.0.0.0/4</code> ุ <a href="">ุณุชููู ุฎูู NAT</a> ุ ูุงูุชู ูุง ุชูุจู ุชูุงููุง ูุชุทูุจุงุช "ูููู ูุฌููุน ุงูุญุงููุงุช ุงูุชูุงุตู ูุน ุฃู ุญุงููุงุช ุฃุฎุฑู ุฏูู ุงุณุชุฎุฏุงู NAT."  ุญุณููุง ุ ุณูู ูุซุจุช ุณุจุจ ุนุฏู ุงูุญุงุฌุฉ ุฅูู NAT ... <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><img src="https://habrastorage.org/webt/y-/hy/ub/y-hyubecllmzx9go5ehai4shl78.jpeg"></a> <br><br><h3 style=";text-align:right;direction:rtl">  ุชูุฌูู ุงููููุฏ </h3><br>  ุงูุขู ูุญู ูุณุชุนุฏูู ูุชุฎุตูุต ุงููุฑูู.  ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ุฌููุน ูุณุงุญุงุช ุงูุดุจูุฉ ูุฃุณูุงุก ุฅุญุฏู ุนูุฏ ุงูุนูู ููุญูู ูุงุญุฏุฉ ูููุง ุจุนุฏ ุฅูุดุงุก ูุดุฑ <code>nginx</code> <a href="">ูู ููุง</a> .  ุณูุณุชุฎุฏู <code>lsns</code> ูุน ุฎูุงุฑ <code>-t</code> ูุชุญุฏูุฏ ููุน ูุณุงุญุฉ ุงูุงุณู ุงููุทููุจ (ุฃู <code>net</code> ): <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo lsns -t net NS TYPE NPROCS PID USER COMMAND 4026532089 net 113 1 root /sbin/init 4026532280 net 2 8046 root /pause 4026532352 net 4 16455 root /pause 4026532426 net 3 27255 root /pause</code> </pre> <br>  ุจุงุณุชุฎุฏุงู ุงูุฎูุงุฑ <code>-i</code> ุฅูู <code>ls</code> ูููููุง ุงูุนุซูุฑ ุนูู ุฃุฑูุงู inode ุงูุฎุงุตุฉ ุจูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ ls -1i /var/run/netns 4026532352 cni-1d85bb0c-7c61-fd9f-2adc-f6e98f7a58af 4026532280 cni-7cec0838-f50c-416a-3b45-628a4237c55c 4026532426 cni-912bcc63-712d-1c84-89a7-9e10510808a0</code> </pre> <br>  ููููู ุฃูุถูุง ุณุฑุฏ ุฌููุน ูุณุงุญุงุช ุฃุณูุงุก ุงูุดุจูุงุช ุจุงุณุชุฎุฏุงู <code>ip netns</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ ip netns cni-912bcc63-712d-1c84-89a7-9e10510808a0 (id: 2) cni-1d85bb0c-7c61-fd9f-2adc-f6e98f7a58af (id: 1) cni-7cec0838-f50c-416a-3b45-628a4237c55c (id: 0)</code> </pre> <br>  ููุดุงูุฏุฉ ุฌููุน ุงูุนูููุงุช ุงูุชู ุชุนูู ูู ูุณุงุญุฉ ุงูุดุจูุฉ <code>cni-912bcc63โ712d-1c84โ89a7โ9e10510808a0</code> ( <code>4026532426</code> ) ุ ููููู ุชุดุบูู ุงูุฃูุฑ ุงูุชุงูู ุ ุนูู ุณุจูู ุงููุซุงู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ls -l /proc/[1-9]*/ns/net | grep 4026532426 | cut -f3 -d<span class="hljs-string"><span class="hljs-string">"/"</span></span> | xargs ps -p PID TTY STAT TIME COMMAND 27255 ? Ss 0:00 /pause 27331 ? Ss 0:00 nginx: master process nginx -g daemon off; 27355 ? S 0:00 nginx: worker process</code> </pre> <br>  ูููู ููุงุญุธุฉ ุฃูู ุจุงูุฅุถุงูุฉ ุฅูู <code>pause</code> ูู ูุฐุง ุงูุฌุฑุงุจ ุ ุฃุทูููุง <code>nginx</code> .  ุชุดุชุฑู ุญุงููุฉ <code>pause</code> ูู ูุณุงุญุงุช ุฃุณูุงุก <code>net</code> ู <code>ipc</code> ูุน ุฌููุน ุญุงููุงุช pod ุงูุฃุฎุฑู.  ุชุฐูุฑ PID ูู <code>pause</code> - 27255 ุ  ุณูุนูุฏ ุฅูููุง. <br><br>  ุงูุขู ุฏุนููุง ูุฑู ูุง ููููู <code>kubectl</code> ุนู ูุฐุง ุงูุฌุฑุงุจ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl get pods -o wide | grep nginx nginx-65899c769f-wxdx6 1/1 Running 0 5d 10.200.0.4 worker-0</code> </pre> <br>  ูุฒูุฏ ูู ุงูุชูุงุตูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl describe pods nginx-65899c769f-wxdx6</code> </pre> <br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">Name: nginx-65899c769f-wxdx6 Namespace: default Node: worker-0/10.240.0.20 Start Time: Thu, 05 Jul 2018 14:20:06 -0400 Labels: pod-template-hash=2145573259 run=nginx Annotations: &lt;none&gt; Status: Running IP: 10.200.0.4 Controlled By: ReplicaSet/nginx-65899c769f Containers: nginx: Container ID: containerd://4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 Image: nginx ...</code> </pre> <br>  ูุฑู ุงุณู ุงูุฌุฑุงุจ - <code>nginx-65899c769f-wxdx6</code> - ููุนุฑูู ุฅุญุฏู <code>nginx-65899c769f-wxdx6</code> ( <code>nginx</code> ) ุ ูููู ูู ูุชู ููู ุฃู ุดูุก ุนู <code>pause</code> .  ุญูุฑ ุนูุฏุฉ ุนูู ุฃุนูู ูุชุชูุงุณุจ ูุน ุฌููุน ุงูุจูุงูุงุช.  ุชุฐูุฑ ุฃู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Kubernetes The Hard Way</a> ูุง ุชุณุชุฎุฏู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Docker</a> ุ ูุจุงูุชุงูู ููุญุตูู ุนูู ุชูุงุตูู ุญูู ุงูุญุงููุฉ ุ ูุดูุฑ ุฅูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุญุงููุฉ ุฃุฏูุงุช</a> ูุญุฏุฉ ุงูุชุญูู - ctr <i>(ุงูุธุฑ ุฃูุถูุง ุงูููุงูุฉ " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชูุงูู ุงูุญุงููุฉ ูุน Kubernetes ุ ูุงุณุชุจุฏุงู Docker ุ ุฌุงูุฒุฉ ููุฅูุชุงุฌ</a> " - <b>ููู ุชูุฑูุจูุง</b> )</i> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr namespaces ls NAME LABELS k8s.io</code> </pre> <br>  <code>k8s.io</code> ุงูุญุงููุฉ ( <code>k8s.io</code> ) ุ ููููู ุงูุญุตูู ุนูู ูุนุฑู ุญุงููุฉ <code>nginx</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers ls | grep nginx 4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 docker.io/library/nginx:latest io.containerd.runtime.v1.linux</code> </pre> <br>  ... <code>pause</code> ุฃูุถูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers ls | grep pause 0866803b612f2f55e7b6b83836bde09bd6530246239b7bde1e49c04c7038e43a k8s.gcr.io/pause:3.1 io.containerd.runtime.v1.linux 21640aea0210b320fd637c22ff93b7e21473178de0073b05de83f3b116fc8834 k8s.gcr.io/pause:3.1 io.containerd.runtime.v1.linux d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6 k8s.gcr.io/pause:3.1 io.containerd.runtime.v1.linux</code> </pre> <br>  ูุนุฑู ุญุงููุฉ <code>nginx</code> ุงูููุชูู ุจู <code>โฆ983c7</code> ูุชุทุงุจู ูุน ูุง ุญุตููุง ุนููู ูู <code>kubectl</code> .  ุฏุนูุง ูุฑู ูุง ุฅุฐุง ูุงู ุจุฅููุงููุง ูุนุฑูุฉ ุญุงููุฉ <code>pause</code> ุงูุชู ุชูุชูู ุฅูู <code>nginx</code> pod: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io task ls TASK PID STATUS ... d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6 27255 RUNNING 4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 27331 RUNNING</code> </pre> <br>  ูู ุชุชุฐูุฑ ุฃู ุงูุนูููุงุช ูุน PID 27331 ู 27355 ุชุนูู ูู ูุณุงุญุฉ ุงุณู ุงูุดุจูุฉ <code>cni-912bcc63โ712d-1c84โ89a7โ9e10510808a0</code> ุ <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers info d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6 { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6"</span></span>, <span class="hljs-string"><span class="hljs-string">"Labels"</span></span>: { <span class="hljs-string"><span class="hljs-string">"io.cri-containerd.kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"sandbox"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx-65899c769f-wxdx6"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.uid"</span></span>: <span class="hljs-string"><span class="hljs-string">"0b35e956-8080-11e8-8aa9-0a12b8818382"</span></span>, <span class="hljs-string"><span class="hljs-string">"pod-template-hash"</span></span>: <span class="hljs-string"><span class="hljs-string">"2145573259"</span></span>, <span class="hljs-string"><span class="hljs-string">"run"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx"</span></span> }, <span class="hljs-string"><span class="hljs-string">"Image"</span></span>: <span class="hljs-string"><span class="hljs-string">"k8s.gcr.io/pause:3.1"</span></span>, ...</code> </pre> <br>  ... ู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ctr -n k8s.io containers info 4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7 { <span class="hljs-string"><span class="hljs-string">"ID"</span></span>: <span class="hljs-string"><span class="hljs-string">"4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7"</span></span>, <span class="hljs-string"><span class="hljs-string">"Labels"</span></span>: { <span class="hljs-string"><span class="hljs-string">"io.cri-containerd.kind"</span></span>: <span class="hljs-string"><span class="hljs-string">"container"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.container.name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.name"</span></span>: <span class="hljs-string"><span class="hljs-string">"nginx-65899c769f-wxdx6"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.namespace"</span></span>: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, <span class="hljs-string"><span class="hljs-string">"io.kubernetes.pod.uid"</span></span>: <span class="hljs-string"><span class="hljs-string">"0b35e956-8080-11e8-8aa9-0a12b8818382"</span></span> }, <span class="hljs-string"><span class="hljs-string">"Image"</span></span>: <span class="hljs-string"><span class="hljs-string">"docker.io/library/nginx:latest"</span></span>, ...</code> </pre> <br>  ูุนุฑู ุงูุขู ุนูู ูุฌู ุงููููู ุฃู ุงูุญุงููุงุช ุชุนูู ูู ูุฐุง <code>nginx-65899c769f-wxdx6</code> ( <code>nginx-65899c769f-wxdx6</code> ) ููุณุงุญุฉ ุงุณู ุงูุดุจูุฉ ( <code>cni-912bcc63โ712d-1c84โ89a7โ9e10510808a0</code> ): <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  nginx (ุฑูู ุงูุชุนุฑูู: <code>4c0bd2e2e5c0b17c637af83376879c38f2fb11852921b12413c54ba49d6983c7</code> ) ุ </li><li style=";text-align:right;direction:rtl">  ูููุฉ (ID: <code>d19b1b1c92f7cc90764d4f385e8935d121bca66ba8982bae65baff1bc2841da6</code> ). </li></ul><br><img src="https://habrastorage.org/webt/3h/cx/qq/3hcxqqv-mwlrm8ax9lu9jl0fixy.png"><br><br>  ููู ูุชู ุชูุตูู ูุฐุง ุชุญุช ( <code>nginx-65899c769f-wxdx6</code> ) ุจุงูุดุจูุฉุ  ูุณุชุฎุฏู PID 27255 ุงูุฐู ุชู ุชูููู ูุณุจููุง ูู <code>pause</code> ูุชุดุบูู ุงูุฃูุงูุฑ ูู ูุณุงุญุฉ ุงุณู ุดุจูุชูุง ( <code>cni-912bcc63โ712d-1c84โ89a7โ9e10510808a0</code> ): <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ip netns identify 27255 cni-912bcc63-712d-1c84-89a7-9e10510808a0</code> </pre> <br>  ููุฐู ุงูุฃุบุฑุงุถ ุ ุณูู ูุณุชุฎุฏู <code>nsenter</code> ูุน ุงูุฎูุงุฑ <code>-t</code> ุงูุฐู ูุญุฏุฏ PID ุงููุณุชูุฏู ุ ู <code>-n</code> ุฏูู ุชุญุฏูุฏ ููู ููุฏุฎูู ุฅูู ูุณุงุญุฉ ุงุณู ุงูุดุจูุฉ ููุนูููุฉ ุงููุณุชูุฏูุฉ (27255).  ุฅููู ูุง ุณููููู <code>ip link show</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo nsenter -t 27255 -n ip link show 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00 3: eth0@if7: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP mode DEFAULT group default link/ether 0a:58:0a:c8:00:04 brd ff:ff:ff:ff:ff:ff link-netnsid 0</code> </pre> <br>  ... ู <code>ifconfig eth0</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo nsenter -t 27255 -n ifconfig eth0 eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt; mtu 1500 inet 10.200.0.4 netmask 255.255.255.0 broadcast 0.0.0.0 inet6 fe80::2097:51ff:fe39:ec21 prefixlen 64 scopeid 0x20&lt;link&gt; ether 0a:58:0a:c8:00:04 txqueuelen 0 (Ethernet) RX packets 540 bytes 42247 (42.2 KB) RX errors 0 dropped 0 overruns 0 frame 0 TX packets 177 bytes 16530 (16.5 KB) TX errors 0 dropped 0 overruns 0 carrier 0 collisions 0</code> </pre> <br>  ูุฐุง ูุคูุฏ ุฃู ุนููุงู IP ุงูุฐู ุชู ุงูุญุตูู ุนููู ุณุงุจููุง ูู ุฎูุงู <code>kubectl get pod</code> ุชู ุชููููู ุนูู ูุงุฌูุฉ <code>eth0</code> .  ุชุนุฏ ูุฐู ุงููุงุฌูุฉ ุฌุฒุกูุง ูู <b>ุฒูุฌ veth</b> ุ ุฃุญุฏ ุทุฑููู ูู ุงููููุฏ ุ ูุงูุขุฎุฑ ูู ูุณุงุญุฉ ุงุณู ุงูุฌุฐุฑ.  ููุนุฑูุฉ ูุงุฌูุฉ ุงูุทุฑู ุงูุซุงูู ุ ูุณุชุฎุฏู <code>ethtool</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> cni-912bcc63-712d-1c84-89a7-9e10510808a0 ethtool -S eth0 NIC statistics: peer_ifindex: 7</code> </pre> <br>  ูุฑู ุฃู <code>ifindex</code> ุงูุนูุฏ ูู 7. ุชุฃูุฏ ูู ุฃูู ูู ูุณุงุญุฉ ุงุณู ุงูุฌุฐุฑ.  ูููู ุงูููุงู ุจุฐูู ุจุงุณุชุฎุฏุงู <code>ip link</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ ip link | grep <span class="hljs-string"><span class="hljs-string">'^7:'</span></span> 7: veth71f7d238@if3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master cnio0 state UP mode DEFAULT group default</code> </pre> <br>  ููุชุฃูุฏ ูู ุฐูู ุฃุฎูุฑูุง ุ ุฏุนูุง ูุฑู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo cat /sys/class/net/veth71f7d238/ifindex 7</code> </pre> <br>  ุฑุงุฆุน ุ ุงูุขู ูู ุดูุก ูุงุถุญ ูุน ุงูุฑุงุจุท ุงูุงูุชุฑุงุถู.  ุจุงุณุชุฎุฏุงู <code>brctl</code> ุฏุนูุง ูุฑู ูู ูุชุตู ุจุฌุณุฑ Linux: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ brctl show cnio0 bridge name bridge id STP enabled interfaces cnio0 8000.0a580ac80001 no veth71f7d238 veth73f35410 vethf273b35f</code> </pre> <br>  ูุฐุง ุ ุงูุตูุฑุฉ ููุง ููู: <br><br><img src="https://habrastorage.org/webt/yu/gc/t6/yugct6efi7ztep277en4msjuzv4.png"><br><br><h3 style=";text-align:right;direction:rtl">  ูุญุต ุงูุชูุฌูู </h3><br>  ููู ููุฌู ุญุฑูุฉ ุงููุฑูุฑ ุจุงููุนูุ  ุฏุนููุง ูููู ูุธุฑุฉ ุนูู ุฌุฏูู ุงูุชูุฌูู ูู ููุญุฉ ูุณุงุญุฉ ุงุณู ุงูุดุจูุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo ip netns <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> cni-912bcc63-712d-1c84-89a7-9e10510808a0 ip route show default via 10.200.0.1 dev eth0 10.200.0.0/24 dev eth0 proto kernel scope link src 10.200.0.4</code> </pre> <br>  ุนูู ุงูุฃูู ูุญู ูุนุฑู ููููุฉ ุงููุตูู ุฅูู ูุณุงุญุฉ ุงุณู ุงูุฌุฐุฑ ( <code>default via 10.200.0.1</code> ).  ุงูุขู ุฏุนูุง ูุฑู ุฌุฏูู ุชูุฌูู ุงููุถูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ ip route list default via 10.240.0.1 dev eth0 proto dhcp src 10.240.0.20 metric 100 10.200.0.0/24 dev cnio0 proto kernel scope link src 10.200.0.1 10.240.0.0/24 dev eth0 proto kernel scope link src 10.240.0.20 10.240.0.1 dev eth0 proto dhcp scope link src 10.240.0.20 metric 100</code> </pre> <br>  ูุญู ูุนุฑู ููููุฉ ุฅุนุงุฏุฉ ุชูุฌูู ุงูุญุฒู ุฅูู ุฌูุงุฒ ุชูุฌูู VPC ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุญุชูู</a> VPC <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุนูู</a> ุฌูุงุฒ ุชูุฌูู "ุถููู" ุ ูุงูุฐู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ูุญุชูู ุนุงุฏุฉู ุนูู ุนููุงู ุซุงูู</a> ูู ูุณุงุญุฉ ุนููุงู IP ุงูุฑุฆูุณูุฉ ููุดุจูุฉ ุงููุฑุนูุฉ).  ุงูุขู: ูู ูุนุฑู ุฌูุงุฒ ุชูุฌูู VPC ููููุฉ ุงููุตูู ุฅูู ุดุจูุฉ ูู ูููุฏุ  ูุง ุ ูู ููุนู ุฐูู ุ ูุฐูู ูููุชุฑุถ ุฃูู ุณูุชู ุชูููู ุงููุณุงุฑุงุช ุจูุงุณุทุฉ ูููู CNI ุงูุฅุถุงูู ุฃู <a href="">ูุฏูููุง</a> (ููุง ูู ุงูุฏููู).  ูุจุฏู ุฃู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูููููู ุงูุฅุถุงูู AWS CNI</a> ููุนู ุฐูู ููุง ูู AWS.  ุชุฐูุฑ ุฃู ููุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุงูุนุฏูุฏ ูู ุงูููููุงุช ุงูุฅุถุงููุฉ ูู CNI</a> ุ ููุญู ูููุฑ ูู ูุซุงู <b>ูุชูููู ุดุจูุฉ ุจุณูุท</b> : <br><br><img src="https://habrastorage.org/webt/cn/v7/v_/cnv7v_qjfkidbtuljkbgkuzuaag.png"><br><br><h3 style=";text-align:right;direction:rtl">  ุงูุบูุฑ ุงูุนููู ูู NAT </h3><br>  <code>kubectl create -f busybox.yaml</code> ุจุฅูุดุงุก <code>kubectl create -f busybox.yaml</code> ูุชุทุงุจููู ูุน ูุญุฏุฉ ุชุญูู ุงููุณุฎ ุงููุชูุงุซู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">apiVersion: v1 kind: ReplicationController metadata: name: busybox0 labels: app: busybox0 spec: replicas: 2 selector: app: busybox0 template: metadata: name: busybox0 labels: app: busybox0 spec: containers: - image: busybox command: - sleep - "3600" imagePullPolicy: IfNotPresent name: busybox restartPolicy: Always</code> </pre> <br>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>busybox.yaml</code></a> ) <br><br>  ูุญุตู ุนูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE busybox0-g6pww 1/1 Running 0 4s 10.200.1.15 worker-1 busybox0-rw89s 1/1 Running 0 4s 10.200.0.21 worker-0 ...</code> </pre> <br>  ูุฌุจ ุฃู ุชููู ุงูุฃุตูุงุช ูู ุญุงููุฉ ุฅูู ุฃุฎุฑู ูุงุฌุญุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it busybox0-rw89s -- ping -c 2 10.200.1.15 PING 10.200.1.15 (10.200.1.15): 56 data bytes 64 bytes from 10.200.1.15: seq=0 ttl=62 time=0.528 ms 64 bytes from 10.200.1.15: seq=1 ttl=62 time=0.440 ms --- 10.200.1.15 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.440/0.484/0.528 ms</code> </pre> <br>  ูููู ุญุฑูุฉ ุญุฑูุฉ ุงููุฑูุฑ ุ ููููู ุฅููุงุก ูุธุฑุฉ ุนูู ุงูุญุฒู ุจุงุณุชุฎุฏุงู <code>tcpdump</code> ุฃู <code>conntrack</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo conntrack -L | grep 10.200.1.15 icmp 1 29 src=10.200.0.21 dst=10.200.1.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1280 src=10.200.1.15 dst=10.240.0.20 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1280 mark=0 use=1</code> </pre> <br>  ุชุชู ุชุฑุฌูุฉ ุนููุงู IP ุงููุตุฏุฑ ูู pod 10.200.0.21 ุฅูู ุนููุงู IP ุงูุฎุงุต ุจุงููุถูู 10.240.0.20. <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-1:~$ sudo conntrack -L | grep 10.200.1.15 icmp 1 28 src=10.240.0.20 dst=10.200.1.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1280 src=10.200.1.15 dst=10.240.0.20 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1280 mark=0 use=1</code> </pre> <br>  ูู iptables ุ ููููู ุฃู ุชุฑู ุฃู ุงูุฃุนุฏุงุฏ ูู ุชุฒุงูุฏ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo iptables -t nat -Z POSTROUTING -L -v Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes) pkts bytes target prot opt <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> out <span class="hljs-built_in"><span class="hljs-built_in">source</span></span> destination ... 5 324 CNI-be726a77f15ea47ff32947a3 all -- any any 10.200.0.0/24 anywhere /* name: <span class="hljs-string"><span class="hljs-string">"bridge"</span></span> id: <span class="hljs-string"><span class="hljs-string">"631cab5de5565cc432a3beca0e2aece0cef9285482b11f3eb0b46c134e457854"</span></span> */ Zeroing chain `POSTROUTING<span class="hljs-string"><span class="hljs-string">'</span></span></code> </pre> <br>  ูู ูุงุญูุฉ ุฃุฎุฑู ุ ุฅุฐุง ููุช ุจุฅุฒุงูุฉ <code>"ipMasq": true</code> ูู ุชูููู ุงููููู ุงูุฅุถุงูู CNI ุ ููููู ูุดุงูุฏุฉ ูุง ููู (ูุชู ุชูููุฐ ูุฐู ุงูุนูููุฉ ุญุตุฑููุง ููุฃุบุฑุงุถ ุงูุชุนููููุฉ - ูุง ููุตู ุจุชุบููุฑ ุงูุชูููู ุนูู ูุฌููุนุฉ ุนูู!): <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl get pods -o wide NAME READY STATUS RESTARTS AGE IP NODE busybox0-2btxn 1/1 Running 0 16s 10.200.0.15 worker-0 busybox0-dhpx8 1/1 Running 0 16s 10.200.1.13 worker-1 ...</code> </pre> <br>  ูุฌุจ ุฃู ููุฑ Ping: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it busybox0-2btxn -- ping -c 2 10.200.1.13 PING 10.200.1.6 (10.200.1.6): 56 data bytes 64 bytes from 10.200.1.6: seq=0 ttl=62 time=0.515 ms 64 bytes from 10.200.1.6: seq=1 ttl=62 time=0.427 ms --- 10.200.1.6 ping statistics --- 2 packets transmitted, 2 packets received, 0% packet loss round-trip min/avg/max = 0.427/0.471/0.515 ms</code> </pre> <br>  ููู ูุฐู ุงูุญุงูุฉ - ุจุฏูู ุงุณุชุฎุฏุงู NAT: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo conntrack -L | grep 10.200.1.13 icmp 1 29 src=10.200.0.15 dst=10.200.1.13 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1792 src=10.200.1.13 dst=10.200.0.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1792 mark=0 use=1</code> </pre> <br>  ูุฐุง ุ ุชุญูููุง ูู ุฃู "ุฌููุน ุงูุญุงููุงุช ูููููุง ุงูุชูุงุตู ูุน ุฃู ุญุงููุงุช ุฃุฎุฑู ุฏูู ุงุณุชุฎุฏุงู NAT." <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-1:~$ sudo conntrack -L | grep 10.200.1.13 icmp 1 27 src=10.200.0.15 dst=10.200.1.13 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=8 code=0 id=1792 src=10.200.1.13 dst=10.200.0.15 <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>=0 code=0 id=1792 mark=0 use=1</code> </pre> <br><h2 style=";text-align:right;direction:rtl">  ุงูุดุจูุฉ ุงูุนูููุฏูุฉ (10.32.0.0/24) </h2><br>  ูุฏ ุชููู ูุงุญุธุช ูู ูุซุงู <code>busybox</code> ุฃู ุนูุงููู IP ุงููุนููุฉ ูู <code>busybox</code> ูุงูุช ูุฎุชููุฉ ูู ูู ุญุงูุฉ.  ูุงุฐุง ูู ุฃุฑุฏูุง ุฌุนู ูุฐู ุงูุญุงููุงุช ูุชุงุญุฉ ููุงุชุตุงู ูู ุงููุฏุงุฎู ุงูุฃุฎุฑูุ  ูููู ูููุฑุก ุฃู ูุฃุฎุฐ ุนูุงููู IP ุงูุญุงููุฉ ูู ุฌุฑุงุจ ุ ููููุง ุณุชุชุบูุฑ.  ููุฐุง ุงูุณุจุจ ุ ุชุญุชุงุฌ ุฅูู ุชูููู ููุฑุฏ <code>Service</code> ุ ูุงูุฐู ุณูุฑุณู ุทูุจุงุช ุงููููู ุฅูู ุงูุนุฏูุฏ ูู ุงููุฏุงุฎู ูุตูุฑุฉ ุงูุนูุฑ. <br><br><blockquote style=";text-align:right;direction:rtl">  "ุงูุฎุฏูุฉ ูู Kubernetes ุนุจุงุฑุฉ ุนู ุชุฌุฑูุฏ ูุญุฏุฏ ุงููุฌููุนุฉ ุงูููุทููุฉ ูููุฏุงุฎู ูุงูุณูุงุณุงุช ุงูุชู ูููู ูู ุฎูุงููุง ุงููุตูู ุฅูููุง."  <i>(ูู ูุซุงุฆู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฎุฏูุงุช Kubernetes</a> )</i> </blockquote><br>  ููุงู ุทุฑู ูุฎุชููุฉ ููุดุฑ ุงูุฎุฏูุฉ ุ  ุงูููุน ุงูุงูุชุฑุงุถู ูู <code>ClusterIP</code> ุ ุงูุฐู ูููู ุจุชุนููู ุนููุงู IP ูู ูุชูุฉ CIDR ูููุชูุฉ (ุนูู ุณุจูู ุงููุซุงู ุ ูููู ุงููุตูู ุฅููู ููุท ูู ุงููุฌููุนุฉ).  ุฃุญุฏ ุงูุฃูุซูุฉ ุนูู ุฐูู ูู ุฅุถุงูุฉ ูุฌููุนุฉ DNS ุงูุชู ุชู ุชูููููุง ูู Kubernetes The Hard Way. <br><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># ... apiVersion: v1 kind: Service metadata: name: kube-dns namespace: kube-system labels: k8s-app: kube-dns kubernetes.io/cluster-service: "true" addonmanager.kubernetes.io/mode: Reconcile kubernetes.io/name: "KubeDNS" spec: selector: k8s-app: kube-dns clusterIP: 10.32.0.10 ports: - name: dns port: 53 protocol: UDP - name: dns-tcp port: 53 protocol: TCP # ...</code> </pre> <br>  ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u="><code>kube-dns.yaml</code></a> ) <br><br>  ููุถุญ <code>kubectl</code> ุฃู <code>Service</code> ุชุชุฐูุฑ ููุงุท ุงูููุงูุฉ ูุชุฑุฌูุชูุง: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl -n kube-system describe services ... Selector: k8s-app=kube-dns Type: ClusterIP IP: 10.32.0.10 Port: dns 53/UDP TargetPort: 53/UDP Endpoints: 10.200.0.27:53 Port: dns-tcp 53/TCP TargetPort: 53/TCP Endpoints: 10.200.0.27:53 ...</code> </pre> <br>  ููู ุจุงูุถุจุทุ .. <code>iptables</code> ูุฑุฉ ุฃุฎุฑู.  ุฏุนูุง ูุฐูุจ ุนุจุฑ ุงูููุงุนุฏ ุงูุชู ุชู ุฅูุดุงุคูุง ููุฐุง ุงููุซุงู.  ูููู ุฑุคูุฉ ุงููุงุฆูุฉ ุงููุงููุฉ ุจุงุณุชุฎุฏุงู ุงูุฃูุฑ <code>iptables-save</code> . <br><br>  ุจูุฌุฑุฏ ุฅูุดุงุก ุงูุญุฒู ุจูุงุณุทุฉ ุงูุนูููุฉ ( <code>OUTPUT</code> ) ุฃู ุงููุตูู ุฅูู ูุงุฌูุฉ ุงูุดุจูุฉ ( <code>PREROUTING</code> ) ุ ูุฅููุง ุชูุฑ ุนุจุฑ ุณูุงุณู <code>iptables</code> ุงูุชุงููุฉ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">-A PREROUTING -m comment --comment <span class="hljs-string"><span class="hljs-string">"kubernetes service portals"</span></span> -j KUBE-SERVICES -A OUTPUT -m comment --comment <span class="hljs-string"><span class="hljs-string">"kubernetes service portals"</span></span> -j KUBE-SERVICES</code> </pre> <br>  ุชุชูุงูู ุงูุฃูุฏุงู ุงูุชุงููุฉ ูุน ุญุฒู TCP ุงููุฑุณูุฉ ุฅูู ุงููููุฐ 53 ุนูุฏ 10.32.0.10 ุ ููุชู ุฅุฑุณุงููุง ุฅูู ุงููุณุชูู 10.200.0.27 ุจุงุณุชุฎุฏุงู ุงููููุฐ 53: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">-A KUBE-SERVICES -d 10.32.0.10/32 -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns-tcp cluster IP"</span></span> -m tcp --dport 53 -j KUBE-SVC-ERIFXISQEP7F7OF4 -A KUBE-SVC-ERIFXISQEP7F7OF4 -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns-tcp"</span></span> -j KUBE-SEP-32LPCMGYG6ODGN3H -A KUBE-SEP-32LPCMGYG6ODGN3H -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns-tcp"</span></span> -m tcp -j DNAT --to-destination 10.200.0.27:53</code> </pre> <br>  ููุณ ุงูุดูุก ูุญุฒู UDP (ุงููุณุชูู 10.32.0.10:53 โ 10.200.0.27:53): <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">-A KUBE-SERVICES -d 10.32.0.10/32 -p udp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns cluster IP"</span></span> -m udp --dport 53 -j KUBE-SVC-TCOU7JCQXEZGVUNU -A KUBE-SVC-TCOU7JCQXEZGVUNU -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns"</span></span> -j KUBE-SEP-LRUTK6XRXU43VLIG -A KUBE-SEP-LRUTK6XRXU43VLIG -p udp -m comment --comment <span class="hljs-string"><span class="hljs-string">"kube-system/kube-dns:dns"</span></span> -m udp -j DNAT --to-destination 10.200.0.27:53</code> </pre> <br>  ููุงู ุฃููุงุน ุฃุฎุฑู ูู <code>Services</code> ูู Kubernetes.  ุนูู ูุฌู ุงูุฎุตูุต ุ ุชุชุญุฏุซ Kubernetes The Hard Way ุนู <code>NodePort</code> - ุฑุงุฌุน <a href="">ุงุฎุชุจุงุฑ ุงูุฏุฎุงู: ุงูุฎุฏูุงุช</a> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">kubectl expose deployment nginx --port 80 --<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> NodePort</code> </pre> <br>  ููุดุฑ <code>NodePort</code> ุงูุฎุฏูุฉ ุนูู ุนููุงู IP ููู ุนูุฏุฉ ุ <code>NodePort</code> ุนูู ูููุฐ ุซุงุจุช (ูุทูู ุนููู <code>NodePort</code> ).  ูููู <code>NodePort</code> ุงููุตูู ุฅูู <code>NodePort</code> ูู ุฎุงุฑุฌ ุงููุชูุฉ.  ููููู ุงูุชุญูู ูู ุงููููุฐ ุงููุฎุตุต (ูู ูุฐู ุงูุญุงูุฉ - 31088) ุจุงุณุชุฎุฏุงู <code>kubectl</code> : <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">$ kubectl describe services nginx ... Type: NodePort IP: 10.32.0.53 Port: &lt;<span class="hljs-built_in"><span class="hljs-built_in">unset</span></span>&gt; 80/TCP TargetPort: 80/TCP NodePort: &lt;<span class="hljs-built_in"><span class="hljs-built_in">unset</span></span>&gt; 31088/TCP Endpoints: 10.200.1.18:80 ...</code> </pre> <br>  ุชุญุช ูุชุงุญ ุงูุขู ูู ุงูุฅูุชุฑูุช ูู <code>http://${EXTERNAL_IP}:31088/</code> .  ููุง <code>EXTERNAL_IP</code> ูู ุนููุงู IP ุงูุนุงู <b>ูุฃู ูุณุฎุฉ ุนุงููุฉ</b> .  ูู ูุฐุง ุงููุซุงู ุ ุงุณุชุฎุฏูุช ุนููุงู IP ุงูุนุงู <b>ููุนุงูู -0</b> .  ูุชู ุงุณุชูุงู ุงูุทูุจ ูู ูุจู ูุถูู ุจุนููุงู IP ุฏุงุฎูู 10.240.0.20 (ูุนูู ูุฒูุฏ ุงูุณุญุงุจุฉ ูู NAT ุงูุนุงูุฉ) ุ ููุน ุฐูู ุ ูุชู ุจุฏุก ุงูุฎุฏูุฉ ุจุงููุนู ุนูู ูุถูู ุขุฎุฑ ( <b>ุงูุนุงูู 1</b> ุ ูุงูุฐู ูููู ุฑุคูุชู ุจูุงุณุทุฉ ุนููุงู IP ูููุทุฉ ุงูููุงูุฉ - 10.200.1.18): <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-0:~$ sudo conntrack -L | grep 31088 tcp 6 86397 ESTABLISHED src=173.38.XXX.XXX dst=10.240.0.20 sport=30303 dport=31088 src=10.200.1.18 dst=10.240.0.20 sport=80 dport=30303 [ASSURED] mark=0 use=1</code> </pre> <br>  ูุชู ุฅุฑุณุงู ุงูุญุฒูุฉ ูู <b>worker-0</b> ุฅูู <b>worker-1</b> ุ ุญูุซ ุชุฌุฏ ุงููุณุชูู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">ubuntu@worker-1:~$ sudo conntrack -L | grep 80 tcp 6 86392 ESTABLISHED src=10.240.0.20 dst=10.200.1.18 sport=14802 dport=80 src=10.200.1.18 dst=10.240.0.20 sport=80 dport=14802 [ASSURED] mark=0 use=1</code> </pre> <br>  ูู ูุฐู ุงูุฏุงุฆุฑุฉ ูุซุงููุฉุ  ุฑุจูุง ูุง ุ ููููุง ุชุนูู.  ูู ูุฐู ุงูุญุงูุฉ ุ ุชููู ููุงุนุฏ <code>iptables</code> ุงููุจุฑูุฌุฉ ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">-A KUBE-NODEPORTS -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/nginx:"</span></span> -m tcp --dport 31088 -j KUBE-SVC-4N57TFCL4MD7ZTDA -A KUBE-SVC-4N57TFCL4MD7ZTDA -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/nginx:"</span></span> -j KUBE-SEP-UGTFMET44DQG7H7H -A KUBE-SEP-UGTFMET44DQG7H7H -p tcp -m comment --comment <span class="hljs-string"><span class="hljs-string">"default/nginx:"</span></span> -m tcp -j DNAT --to-destination 10.200.1.18:80</code> </pre> <br>  ุจูุนูู ุขุฎุฑ ุ ูุชู ุจุซ ุนููุงู ูุณุชูู ุงูุญุฒู ุฐุงุช ุงููููุฐ 31088 ุนูู 10.200.1.18.  ููุง ูุจุซ ุงููููุงุก ูู 31088 ุฅูู 80. <br><br>  ูู <code>LoadBalancer</code> ุฅูู ููุน ุขุฎุฑ ูู ุงูุฎุฏูุฉ - <code>LoadBalancer</code> - ููุง ูุฌุนู ุงูุฎุฏูุฉ ูุชุงุญุฉ ููุฌูููุฑ ุจุงุณุชุฎุฏุงู ููุงุฒู ุชุญููู ูููุฑ ุงูุณุญุงุจุฉ ุ ูููู ุชุจูู ุฃู ุงูููุงูุฉ ูุจูุฑุฉ ุจุงููุนู. <br><br><h2 style=";text-align:right;direction:rtl">  ุงูุฎูุงุตุฉ </h2><br>  ูุฏ ูุจุฏู ุฃู ููุงู ุงููุซูุฑ ูู ุงููุนูููุงุช ุ ููููุง ููุณูุง ููุท ููุฉ ุฌุจู ุงูุฌููุฏ.  ูู ุงููุณุชูุจู ุณุฃุชุญุฏุซ ุนู IPv6 ู IPVS ู eBPF ูุงุซููู ูู ููููุงุช CNI ุงูุฅุถุงููุฉ ุงููุซูุฑุฉ ููุงูุชูุงู. <br><br><h2 style=";text-align:right;direction:rtl">  ููุงุญุธุฉ ูู ุงููุชุฑุฌู </h2><br>  ุงูุฑุฃ ุฃูุถุง ูู ูุฏููุชูุง: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุฏููู ูุตูุฑ ููุดุจูุงุช ูู Kubernetes</a> " ุ </li><li style=";text-align:right;direction:rtl">  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุงุฑูุฉ ุฃุฏุงุก ุงูุดุจูุฉ ูู Kubernetes</a> " ุ </li><li style=";text-align:right;direction:rtl">  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุฌุงุฑุจ ูุน ูููู kube ูุฅููุงููุฉ ูุตูู ุงููุถูู ูู Kubernetes</a> " ุ </li><li style=";text-align:right;direction:rtl">  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ุชุญุณูู ููุซูููุฉ Kubernetes: ููููุฉ ููุงุญุธุฉ ุณููุท ุงูุนูุฏุฉ ุจุณุฑุนุฉ</a> " ุ </li><li style=";text-align:right;direction:rtl"> ยซ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Play with Kubernetes โ      K8s</a> ยป; </li><li style=";text-align:right;direction:rtl"> ยซ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">   Kubernetes   </a> ยป <i>( ,        Kubernetes)</i> ; </li><li style=";text-align:right;direction:rtl"> ยซ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">Container Networking Interface (CNI) โ      Linux-</a> ยป. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar420813/">https://habr.com/ru/post/ar420813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar420799/index.html">MPS 2018.2: ุงุฎุชุจุงุฑุงุช ุงููููุฏุงุช ุ GitHub Plugin ุ VCS Aspect ุ ุฅุนูุงูุงุช ุงูุชุฑุญูู ุ ูุงููุฒูุฏ</a></li>
<li><a href="../ar420803/index.html">ุฏุฑูุณ ุงูุทุจุงุนุฉ ุซูุงุซูุฉ ุงูุฃุจุนุงุฏ. ุญูุธ ุงูุจูุงุณุชูู ุนูุฏ ุทุจุงุนุฉ ุงูููุงุฐุฌ ุบูุฑ ุงููุธูููุฉ ูู 3Dtool</a></li>
<li><a href="../ar420805/index.html">[ุชุฑุฌูุฉ] ูุชู ุชุณุชุฎุฏู ุชูุงุฑุงุช ูุชูุงุฒูุฉ</a></li>
<li><a href="../ar420809/index.html">ุฃุณุจูุน ุงูุฃูู 31: ุฎูุณูู ุฏุฑุฌุฉ ูู ุนุฏู ุงูุฃูุงู ุนูู Android</a></li>
<li><a href="../ar420811/index.html">ุงูุฌูู ุงูุฌุฏูุฏ ูู ุดุจูุฉ ุงููุฑุงุณูุฉ ูุงููุงุชู ุงููุงูุฑูุฒูุฉ</a></li>
<li><a href="../ar420815/index.html">ููู ูุฌุฑ "ูู ุชุฑููุฒ ุงูุนุงูู ุงูุฑููู" ุงููุงุนุฉ: ุฃุนูู 10 ุชูุงุฑูุฑ ูู DotNext 2018 Piter</a></li>
<li><a href="../ar420819/index.html">ุฃูุถู 10 ุฃุฏูุงุช Python ููุชุนูู ุงูุขูู ูุนููู ุงูุจูุงูุงุช</a></li>
<li><a href="../ar420821/index.html">ุงููุงุนุฏุฉ 10: 1 ูู ุงูุจุฑูุฌุฉ ูุงููุชุงุจุฉ</a></li>
<li><a href="../ar420825/index.html">ุงูููู ุณุชููู ุงููุจุงุฑุงุฉ ุงูุฃููู ุจูู ูุญุชุฑูู OpenAI ู Dota 2 (ูุงุฒ ุงููุงุณ). ูุญู ูููู ููู ูุนูู ุงูุจูุช</a></li>
<li><a href="../ar420827/index.html">ูู ุจุฅูุดุงุก ูุดุฑูุน ูุฎุถุฑู ุจุณูุท ุจุงุณุชุฎุฏุงู Java EE + WildFly10 + JPA (Hibernate) + Postgresql + EJB + IntelliJ IDEA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>