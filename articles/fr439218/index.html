<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💆🏼 ⛓️ 🧝🏻 VK bot sur son genou, ou comment faire plaisir aux gens le 14 février 👩🏿‍🤝‍👩🏼 🛷 🛠️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bien sûr, chacun de nous aime les cadeaux, mais surtout nous aimons les souhaits qui les accompagnent. Et, jusqu'à récemment, nous n'avons pas eu l'oc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>VK bot sur son genou, ou comment faire plaisir aux gens le 14 février</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439218/">  Bien sûr, chacun de nous aime les cadeaux, mais surtout nous aimons les souhaits qui les accompagnent.  Et, jusqu'à récemment, nous n'avons pas eu l'occasion de surprendre agréablement une personne avec des mots chaleureux jusqu'à ce que l'idée lui vienne à l'esprit: et si nous donnions aux gens la possibilité d'échanger des valentines (sur leur nez le 14 février, tout de même) sans quitter le cadre de la manière habituelle communication - salon de discussion sur les réseaux sociaux? <br><br>  Mot pour mot, et le voici - un plan d'affaires prêt à l'emploi pour créer l'atmosphère de la fête de la Saint-Valentin!  Allons-nous rendre les gens heureux? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/dl/mp/13/dlmp134rko91zu7m-evwm5mlhem.jpeg" width="70%"></div><br><a name="habracut"></a><h2>  Pour l'idée de la lune! </h2><br>  Bien sûr, il a d'abord fallu élaborer un plan d'action et décrire l'idée.  Étant donné que les gens sont devenus plus timides et ne sont pas toujours prêts à faire confiance à personne, le choix s'est porté sur l'écriture d'un bot à la mode et pratique pour VK, qui a une interface familière, sera toujours à portée de main, et l'anonymat des messages sera codé en dur dans le code du programme. <br>  Malheureusement, en plus de tous les avantages ci-dessus, les communautés ont deux inconvénients: une faible bande passante (nombre de messages par seconde) et une interdiction de commencer un dialogue avec un utilisateur aléatoire (l'utilisateur doit d' <b>abord</b> et <b>explicitement</b> accepter de recevoir des messages au nom de la communauté). <br><br>  Nous avons donc un utilisateur qui est prêt à envoyer une carte Valentine à son âme soeur, un destinataire et un intermédiaire sous la forme d'un chat bot.  Le schéma d'interaction est simple, le bot doit: proposer l'envoi → reconnaître le destinataire → économiser jusqu'au 14 février → livrer → répéter. <br><br>  Mais cela, bien sûr, n'était pas suffisant pour l'imagination vorace de l'esprit, et, afin d'augmenter l'activité et l'implication du public, un schéma d'une autre interaction a été pensé, permettant aux gens de se familiariser avec le système, d'envoyer des messages à des personnes aléatoires.  Ces «valentines aléatoires» peuvent être appréciées, et si les valentines de deux personnes s'aiment, nous leur donnons la possibilité de discuter. <br><br><h4>  Clause de non-responsabilité </h4><br>  <i>Ce projet a été créé uniquement par l'enthousiasme de deux personnes, un programmeur à <s>moitié instruit</s> (moi) et un inspirateur idéologique (Stepan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">sadfun</a> Popov), n'a pas pour objectif de vous enseigner quelque chose (bien qu'il puisse vous aider à comprendre l'essence de l'univers), racontez simplement une histoire intéressante de la création et suivez le chemin d'une idée à une implémentation naïve.</i> <br><br><hr><br><h2>  Apprendre à parler avec VK </h2><br>  Après <b>avoir</b> parcouru 3-4 bibliothèques différentes à la demande de <b>"NodeJS VK API"</b> , je me suis rendu compte qu'il n'y avait pas de bibliothèques simples et fonctionnelles qui nous permettent d'utiliser des promesses, ainsi que de travailler par exécution.  Rappelez-vous l'un des problèmes décrits ci-dessus?  Oui, l'exécution des demandes à VKontakte n'est pas directement, mais en lots de 25 vous permet <b>d'</b> augmenter <b>considérablement le</b> débit. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/v3/fl/bp/v3flbpnqymqn0wy51ohjddwenmo.png" width="70%"></div><br>  <i>Capacité comparative de diverses méthodes de demandes à VKontakte</i> <br><br>  Par conséquent, il a été décidé d'écrire quelque chose qui leur soit propre, une solution fiable et pas très béquille, basée sur la bibliothèque <b>node-fetch</b> . <br><br>  Afin de ne pas donner tout le code ici, je décrirai simplement la logique du travail. <br><br>  Étant donné que les demandes du programme doivent être regroupées en une seule exécution, elles sont collectées dans la file d'attente LIFO, puis envoyées si: <br><br><ul><li>  Appels de 25 ou plus (exécution maximale) </li><li>  Assez de temps s'est écoulé depuis la dernière expédition, pas moins de 50 millisecondes, mais pas plus de 150 (pour que la file d'attente se déplace, malgré la petite taille) </li></ul><br>  Les demandes de la file d'attente sont intégrées dans le code de script VK, qui (dans cette implémentation) ressemble à ceci: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> returnables = []; returnables[<span class="hljs-number"><span class="hljs-number">0</span></span>] = API.messages.send({<span class="hljs-string"><span class="hljs-string">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">", !"</span></span>, <span class="hljs-string"><span class="hljs-string">"peer_id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"random_id"</span></span>: <span class="hljs-number"><span class="hljs-number">561427</span></span>}); returnables[<span class="hljs-number"><span class="hljs-number">1</span></span>] = API.users.get({<span class="hljs-string"><span class="hljs-string">"user_ids"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"fields"</span></span>: <span class="hljs-string"><span class="hljs-string">"sex"</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> returnables;</code> </pre> <br>  Une fois que le code est exécuté par une demande à VK, le résultat de chaque demande (par l'index des éléments <i>retournables</i> ) revient à son rappel, magnifiquement enveloppé dans Promise.  L'efficacité de l'approche est écrasante - <b>plus il y a d'</b> utilisateurs (et, par conséquent, plus il y a de demandes d'envoi à VKontakte), <b>moins il y a de</b> retard dans la réponse.  Pour garder la limite sous contrôle, le système d'envoi dispose d'un compteur indiquant le nombre de demandes restantes pour cette seconde, ce qui vous permet de traiter rapidement une vague de visiteurs. <br><br><h2>  Apprendre à écouter VK </h2><br>  Il existe deux façons de recevoir des notifications sur les événements de VKontakte: les <b>requêtes Longpoll</b> et le <b>serveur de</b> <b>rappel</b> .  Votre serveur est pratique car il ne nécessite pas de gestes spéciaux à utiliser et vous permet également de recevoir des notifications manquées (par exemple, lorsque vous redémarrez le serveur).  Un tel serveur peut être écrit sur plusieurs lignes en utilisant la classe native <b>http.Server</b> . <br><br>  Tout cela crée un écosystème idéal pour la logique du programme, qui est pratique à utiliser. <br><br><h2>  Tout se termine </h2><br>  Étant donné que l'utilisateur est libre de faire quoi que ce soit dans le chat et que nous ne pouvons pas l'arrêter, nous devons le limiter à un montant raisonnable.  La machine d'état fait un excellent travail en faisant cela, en définissant toutes les transitions possibles dans le système, et en utilisant les boutons (paramètre du <b>clavier</b> dans messages.send) rendra l'utilisation du bot aussi simple qu'une simple pression sur l'écran. <br><br>  Voici l'interaction de l'utilisateur avec le bot: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/sz/1o/fw/sz1ofwuethupwaiet4syf6ahl4u.png"></div><br>  Tout cela se transforme en un ensemble d'états ("Menu principal", "Entrée Saint-Valentin" et ainsi de suite), dont les transitions entre elles sont définies et transmises par boutons, ou sont connues initialement et ne changent pas. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cq/dz/ml/cqdzmlalb1t2o-xpdet5mvfnnek.png"></div><br>  Soit dit en passant, sur les boutons.  Leur gamme de couleurs est non invariante ( <b>4 couleurs</b> pour toutes les occasions), mais ce sont les boutons qui permettent de minimiser le nombre d'erreurs utilisateur.  Sur leur base, vous pouvez construire absolument n'importe quel système non linéaire, c'est pourquoi ils sont utilisés partout.  Et dans ce projet aussi. <br><br>  Mais vous devez comprendre: si vous visez un large public, vous devriez envisager une autre façon d'interagir, car quelqu'un peut avoir une ancienne application ( <b>VK pour iPad</b> , par exemple, n'a pas été mis à jour depuis très longtemps, je ne mentirai pas, mais il semble que plus d'un an, et le clavier n'est pas là).  Et il arrive (oui, ça arrive, j'ai vérifié) que les gens, ne réalisant pas que les boutons peuvent être cliqués, réécrivent simplement leur contenu (et ensuite le paramètre du bouton de charge utile, bien sûr, n'est pas transmis, et tout peut casser). <br><br>  Il convient de noter que tout ne se passe pas aussi bien que décrit dans le diagramme, et parfois des cas curieux se produisent.  Par exemple, le système de détermination du lien VKontakte a mal traité les utilisateurs dont les liens courts ont commencé avec <b>id</b> et les ont coupés.  La surprise des gens qui ont rencontré ce bug ne peut pas être décrite, car ils ont écrit Valentine Valentine, mais il s'est avéré que Olezhka. <br><blockquote>  <b>Quel olezhka ????</b> </blockquote><h2>  Les accidents ne sont pas accidentels </h2><br>  Donc, si tout est clair avec les valentines ordinaires, il y a un destinataire et un expéditeur, alors comment réduire deux étrangers?  Vous devez échanger leurs valentines, et si les gens aiment les valentines les uns des autres, alors ils devraient être présentés!  Voilà, la formule de l'amour! <br><br>  Bien que cela semble pathétique, cela fonctionne et il devient plus intéressant pour les gens de travailler avec le bot - ils obtiendront une réponse positive s'il y a au moins une personne (dont, bien sûr, le bot prendra soin). <br><br>  Cela conduit à un gros plus - plus les gens saisissent cette opportunité, plus ils ont de chances de se connaître, et donc, comme un jeu, cela maintient une personne dans une conversation.  Il vaut la peine d’avouer que la session moyenne d’un utilisateur dure environ 7 minutes, mais il est possible de resserrer une personne de <b>10</b> à <b>15</b> uniquement pour le plaisir de cette fonctionnalité. <br><br>  La distribution même des messages a forcé un schéma séparé, car il existe plusieurs options pour utiliser ce bot, l'utilisateur peut perdre de vue quelque chose, et le bot le lui rappellera soigneusement. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pj/8a/bw/pj8abwsu2zjmkhotgiffi0jldse.jpeg"></div><br>  Il est intéressant de voir comment le deuxième problème a été résolu, avec l'incapacité de la communauté à engager un dialogue avec l'utilisateur en premier: ce problème est maintenant résolu par un tel message. <br><blockquote>  Mais j'ai une condition!  Pour que le destinataire reçoive votre Valentin, il doit également m'écrire.  Votre tâche consiste maintenant à le persuader de m'écrire quelque chose.  Ceci est fait pour que vous n'ayez pas peur de lui parler! </blockquote>  En général, le traditionnel "Pas un bug, mais une fonctionnalité!" <br><br><h2>  Feux d'artifice à la fin </h2><br>  C'est tout!  Si vous ne tenez pas compte de certaines difficultés pour comprendre la logique de l'API VK, ainsi que pour confirmer le compte auprès de l'un des fournisseurs, tout s'est encore trop bien déroulé. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/-7/gb/yt/-7gbythuuwaf87k6c-v4k5-shok.png"></div><br>  <i>Exemple de chat avec un bot</i> <br><br>  Le bot fonctionne et ravira les gens avec des valentines, les rendant heureux.  Ceci est fait pour aider les gens à être plus gentils les uns envers les autres.  Vous pouvez évaluer tout cela vous-même dans la communauté <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Valentinych - vk.com/verylovebot</a> , si vous le souhaitez.  Merci de votre attention! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439218/">https://habr.com/ru/post/fr439218/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439204/index.html">Amélioration de l'efficacité de la photosynthèse par modification génétique des plantes</a></li>
<li><a href="../fr439206/index.html">Comment avons-nous résolu le problème de la poursuite des listes de lecture au RecSys Challenge et avons pris la 3e place</a></li>
<li><a href="../fr439208/index.html">Oh, mon code: comment fonctionne MAPS.ME</a></li>
<li><a href="../fr439210/index.html">Java après une éruption volcanique</a></li>
<li><a href="../fr439216/index.html">pudge 500 ligne de base de données intégrable sur Golang</a></li>
<li><a href="../fr439220/index.html">Grande ville pour les appareils mobiles sur Unity. Expérience en développement et optimisation</a></li>
<li><a href="../fr439222/index.html">Qu'est-ce que la gestion des API?</a></li>
<li><a href="../fr439224/index.html">Encore une fois sur les diagrammes de Voronoi</a></li>
<li><a href="../fr439226/index.html">Scala + MXNet = Microservice avec neurone en prod</a></li>
<li><a href="../fr439232/index.html">JAMstack: Comment créer votre propre blog en utilisant Gatsby + Contentful + Netlify</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>