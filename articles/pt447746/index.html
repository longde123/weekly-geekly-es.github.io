<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤ üîÄ üë®üèª‚Äçüé§ L√≥gica de neg√≥cios do banco de dados com o SchemaKeeper ‚ÜñÔ∏è üßòüèº ‚ùé</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O objetivo do artigo √© usar a biblioteca de guardi√µes de esquema como um exemplo para mostrar ferramentas para simplificar o desenvolvimento de bancos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>L√≥gica de neg√≥cios do banco de dados com o SchemaKeeper</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447746/"><p>  O objetivo do artigo √© usar a biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">guardi√µes de esquema</a> como um exemplo para mostrar ferramentas para simplificar o desenvolvimento de bancos de dados em projetos PHP usando DBMSs do PostgreSQL. </p><br><p>  Os seguintes problemas ser√£o abordados: </p><br><ol><li>  De que forma armazenar um despejo da estrutura do banco de dados no sistema de controle de vers√£o (daqui em diante - VCS) </li><li>  Como rastrear altera√ß√µes na estrutura do banco de dados ap√≥s salvar o dump </li><li>  Como transferir altera√ß√µes na estrutura do banco de dados para outros ambientes sem conflitos e arquivos de migra√ß√£o gigantes </li><li>  Como estabelecer um processo de trabalho paralelo em um projeto por v√°rios desenvolvedores </li><li>  Como implantar com seguran√ßa mais altera√ß√µes na estrutura do banco de dados no ambiente de produ√ß√£o </li></ol><br><p>  As informa√ß√µes deste artigo ser√£o √∫teis principalmente para desenvolvedores que desejam aproveitar ao m√°ximo os recursos do PostgreSQL, mas enfrentam problemas para manter a l√≥gica de neg√≥cios no banco de dados. </p><br><p>  O artigo n√£o descrever√° as vantagens ou desvantagens de armazenar a l√≥gica de neg√≥cios em um banco de dados.  Sup√µe-se que a escolha j√° tenha sido feita pelo leitor. </p><a name="habracut"></a><br><blockquote>  <strong>O SchemaKeeper foi desenvolvido</strong> para trabalhar com procedimentos armazenados escritos em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PL / pgSQL</a> .  O teste com outros idiomas n√£o foi realizado, portanto, o uso pode n√£o ser t√£o eficaz ou imposs√≠vel. </blockquote><br><h2 id="v-kakom-vide-hranit-damp-struktury-bd-v-vcs">  De que forma armazenar um despejo da estrutura do banco de dados no VCS </h2><br><p>  A biblioteca do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">guardi√£o de esquema</a> fornece a fun√ß√£o <a href="">saveDump</a> , que salva a estrutura dos objetos do banco de dados como arquivos de texto separados.  A sa√≠da cria um diret√≥rio que cont√©m a estrutura do banco de dados, dividida em arquivos agrupados que s√£o f√°ceis de adicionar ao VCS. </p><br><p>  Considere converter objetos de um banco de dados em arquivos com alguns exemplos: </p><br><div class="scrollable-table"><table><thead><tr><th>  Tipo de objeto </th><th>  Esquema </th><th>  T√≠tulo </th><th>  Caminho relativo do arquivo </th></tr></thead><tbody><tr><td>  Quadro </td><td>  p√∫blico </td><td>  contas </td><td><code>./public/tables/accounts.txt</code> </td> </tr><tr><td>  Procedimento armazenado </td><td>  p√∫blico </td><td>  auth (hash bigint) </td><td> <code>./public/functions/auth(int8).sql</code> </td> </tr><tr><td>  Submiss√£o </td><td>  reserva </td><td>  tarifas </td><td> <code>./booking/views/tariffs.txt</code> </td> </tr></tbody></table></div><br><p>  O conte√∫do do arquivo √© uma representa√ß√£o textual da estrutura de um objeto de banco de dados espec√≠fico.  Por exemplo, para procedimentos armazenados, o conte√∫do do arquivo ser√° a defini√ß√£o completa do procedimento armazenado, come√ßando com o bloco <code>CREATE OR REPLACE FUNCTION</code> . </p><br><p>  Como pode ser visto na tabela acima, o caminho do arquivo armazena informa√ß√µes sobre o tipo, esquema e nome do objeto.  Essa abordagem facilita a navega√ß√£o pelas altera√ß√µes de despejo e revis√£o de c√≥digo no banco de dados. </p><br><blockquote>  A <code>.sql</code> para arquivos com c√≥digo-fonte para procedimentos armazenados √© selecionada para que o IDE forne√ßa automaticamente ferramentas para interagir com o banco de dados ao abrir o arquivo. </blockquote><br><h2 id="kak-otslezhivat-izmeneniya-v-strukture-bd-posle-sohraneniya-dampa">  Como rastrear altera√ß√µes na estrutura do banco de dados ap√≥s salvar o dump </h2><br><p>  Depois de salvar um despejo da estrutura atual do banco de dados no VCS, temos a oportunidade de verificar se foram feitas altera√ß√µes na estrutura do banco de dados ap√≥s a cria√ß√£o do despejo.  A biblioteca do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">detentor de esquema</a> fornece uma fun√ß√£o <a href="">CheckerDump</a> para detectar altera√ß√µes na estrutura do banco de dados, que retorna informa√ß√µes sobre diferen√ßas sem efeitos colaterais. </p><br><p>  Uma maneira alternativa de verificar √© chamar a fun√ß√£o <code>saveDump</code> , especificando o mesmo diret√≥rio e verificar altera√ß√µes no VCS.  Como os objetos do banco de dados s√£o armazenados em arquivos separados, o VCS mostrar√° apenas objetos alterados.  A principal desvantagem desse m√©todo √© a necessidade de substituir arquivos para ver as altera√ß√µes. </p><br><h2 id="kak-perenosit-izmeneniya-v-strukture-bd-na-drugie-okruzheniya-bez-konfliktov-i-gigantskih-faylov-migraciy">  Como transferir altera√ß√µes na estrutura do banco de dados para outros ambientes sem conflitos e arquivos de migra√ß√£o gigantes </h2><br><p>  Gra√ßas √† fun√ß√£o <a href="">deployDump, o</a> c√≥digo fonte dos procedimentos armazenados √© editado como o restante do c√≥digo fonte do aplicativo.  A modifica√ß√£o do procedimento armazenado ocorre fazendo altera√ß√µes no arquivo correspondente, o que √© refletido automaticamente no sistema de controle de vers√£o. </p><br><p>  Por exemplo, para criar um novo procedimento armazenado no esquema <code>public</code> , basta criar um novo arquivo com a extens√£o <code>.sql</code> no diret√≥rio <code>public/functions</code> , colocar nele o c√≥digo fonte do procedimento armazenado, incluindo o bloco <code>CREATE OR REPLACE FUNCTION</code> , e chamar a fun√ß√£o <code>deployDump</code> .  Da mesma forma, um procedimento armazenado √© modificado e exclu√≠do.  Assim, o c√≥digo entra simultaneamente no VCS e no banco de dados. </p><br><p>  Se um erro aparecer no c√≥digo-fonte do procedimento armazenado, o <code>deployDump</code> falhar√°, lan√ßando uma exce√ß√£o.  A incompatibilidade de procedimentos armazenados entre o dump e o banco de dados atual n√£o √© poss√≠vel usando <code>deployDump</code> . </p><br><blockquote>  Ao criar um novo procedimento armazenado, n√£o h√° necessidade de inserir manualmente o nome do arquivo correto.  √â suficiente que o arquivo tenha a extens√£o <code>.sql</code> .  O nome correto pode ser obtido no valor de retorno da fun√ß√£o <code>deployDump</code> e usado para renomear o arquivo. </blockquote><p>  <code>deployDump</code> altera os par√¢metros da fun√ß√£o ou do tipo de retorno sem a√ß√µes adicionais, enquanto na abordagem cl√°ssica seria necess√°rio executar a <code>DROP FUNCTION</code> e somente ent√£o <code>CREATE OR REPLACE FUNCTION</code> . </p><br><p>  Infelizmente, em algumas situa√ß√µes, <code>deployDump</code> falha ao aplicar automaticamente as altera√ß√µes.  Por exemplo, se uma fun√ß√£o de gatilho usada por pelo menos um gatilho for exclu√≠da.  Tais situa√ß√µes s√£o resolvidas manualmente usando arquivos de migra√ß√£o. </p><br><p>  Se o respons√°vel pelo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">esquema</a> for respons√°vel pela transfer√™ncia de altera√ß√µes nos procedimentos armazenados, os arquivos de migra√ß√£o ser√£o usados ‚Äã‚Äãpara transferir outras altera√ß√µes na estrutura.  Por exemplo, a biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">doutrinas / migra√ß√µes</a> √© adequada. </p><br><p>  As migra√ß√µes devem ser aplicadas antes da execu√ß√£o do <code>deployDump</code> para fazer altera√ß√µes na estrutura e resolver poss√≠veis situa√ß√µes problem√°ticas. </p><br><p>  O trabalho com migra√ß√µes ser√° descrito em mais detalhes nas se√ß√µes a seguir. </p><br><h2 id="kak-naladit-process-parallelnoy-raboty-nad-proektom-neskolkih-razrabotchikov">  Como estabelecer um processo de trabalho paralelo em um projeto por v√°rios desenvolvedores </h2><br><p>  Vamos criar um script para a inicializa√ß√£o completa do banco de dados, que os desenvolvedores executam em m√°quinas locais para alinhar a estrutura dos bancos de dados locais com o dump armazenado no VCS.  Dividimos a inicializa√ß√£o do banco de dados local em 3 etapas: </p><br><ol><li>  Importe um arquivo com uma estrutura b√°sica, que ser√° chamada, por exemplo, <code>base.sql</code> </li><li>  Aplica√ß√£o de migra√ß√µes </li><li>  Chamada <code>deployDump</code> </li></ol><br><blockquote>  <code>base.sql</code> √© o ponto de partida sobre o qual as migra√ß√µes s√£o aplicadas e o <code>deployDump</code> √© <code>deployDump</code> , ou seja, <code>base.sql +  + deployDump =   </code> .  Utilizado pelo <code>base.sql</code> exclusivamente ao inicializar o banco de dados do zero.  Esse arquivo √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gerado</a> usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">pg_dump</a> . </blockquote><p>  Chamamos o script para a inicializa√ß√£o completa do banco de dados <code>refresh.sh</code> .  O fluxo de trabalho do desenvolvedor √© o seguinte: </p><br><ol><li>  Executando <code>refresh.sh</code> em seu ambiente para obter a estrutura atual do banco de dados </li><li>  O in√≠cio do trabalho na tarefa, a modifica√ß√£o do banco de dados local de acordo com as necessidades da nova funcionalidade ( <code>ALTER TABLE ... ADD COLUMN</code> , etc.) </li><li>  Ap√≥s concluir a tarefa, chame a fun√ß√£o <code>saveDump</code> para confirmar as altera√ß√µes feitas no banco de dados no VCS </li><li>  <code>refresh.sh</code> <code>verifyDump</code> e <code>verifyDump</code> para exibir uma lista de altera√ß√µes a serem inclu√≠das na migra√ß√£o </li><li>  A transfer√™ncia de altera√ß√µes de estrutura no arquivo de migra√ß√£o, executando <code>verifyDump</code> e <code>verifyDump</code> , e se a migra√ß√£o estiver <code>verifyDump</code> corretamente, <code>verifyDump</code> mostrar√° que n√£o h√° diferen√ßas entre o banco de dados local e o dump salvo. </li></ol><br><p>  O processo descrito acima √© compat√≠vel com os princ√≠pios do <code>gitflow</code> .  Cada filial no VCS cont√©m sua pr√≥pria vers√£o do despejo e, quando as ramifica√ß√µes se fundem, os despejos se fundem.  As fus√µes s√£o executadas sem a√ß√µes adicionais, mas se forem feitas altera√ß√µes nas ramifica√ß√µes, por exemplo, na mesma tabela, √© poss√≠vel um conflito. </p><br><p>  Considere uma situa√ß√£o de conflito usando o exemplo de uma ramifica√ß√£o de <em>desenvolvimento</em> , da qual <em>ramifica√ß√£o1</em> e <em>ramifica√ß√£o2 s√£o ramificadas</em> , que n√£o conflitam com o <em>desenvolvimento</em> , mas conflitam entre si.  A tarefa √© mesclar <em>branch1</em> e <em>branch2</em> no desenvolvimento.  Nesse caso, √© recomend√°vel mesclar <em>branch1</em> no <em>desenvolvimento</em> e depois mesclar o <em>desenvolvimento</em> no <em>branch2</em> , resolvendo conflitos no <em>branch2</em> e, em seguida, mesclar o <em>branch2</em> no desenvolvimento.  No est√°gio da resolu√ß√£o de conflitos, talvez seja necess√°rio corrigir o arquivo de migra√ß√£o no <em>branch2</em> para que ele corresponda ao dump final, que inclui os resultados das fus√µes. </p><br><h2 id="kak-bezopasno-deploit-bolshee-kolichestvo-izmeneniy-v-strukture-bd-na-production-okruzhenie">  Como implantar com seguran√ßa mais altera√ß√µes na estrutura do banco de dados no ambiente de produ√ß√£o </h2><br><p>  A presen√ßa no despejo VCS da estrutura atual do banco de dados permite verificar a base de produ√ß√£o quanto √† conformidade exata com a estrutura necess√°ria.  Isso garante que todas as altera√ß√µes pretendidas pelos desenvolvedores foram transferidas para a base de produ√ß√£o. </p><br><p>  Como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">DDL</a> no PostgreSQL √© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">transacional</a> , √© recomend√°vel seguir a ordem de implanta√ß√£o para que, no caso de um erro inesperado, o <code>ROLLBACK</code> "indolor": </p><br><ol><li>  Iniciar transa√ß√£o </li><li>  Executar todas as migra√ß√µes em uma transa√ß√£o </li><li>  Na mesma transa√ß√£o, execute <code>deployDump</code> </li><li>  Sem concluir a transa√ß√£o, execute <code>verifyDump</code> .  Se n√£o houver erros, execute <code>COMMIT</code> .  Se houver erros, execute <code>ROLLBACK</code> </li></ol><br><p>  Essas etapas s√£o bastante f√°ceis de integrar √†s abordagens existentes para implantar aplicativos, incluindo tempo de inatividade zero. </p><br><h1 id="zaklyuchenie">  Conclus√£o </h1><br><p>  Gra√ßas aos m√©todos descritos acima, voc√™ pode reduzir o desempenho m√°ximo dos projetos "PHP + PostgreSQL", sacrificando uma quantidade relativamente pequena de conveni√™ncia de desenvolvimento em compara√ß√£o com a implementa√ß√£o de toda l√≥gica de neg√≥cios no c√≥digo principal do aplicativo.  Al√©m disso, o processamento de dados no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">PL / pgSQL</a> geralmente parece mais transparente e requer menos c√≥digo do que a mesma funcionalidade escrita em PHP. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447746/">https://habr.com/ru/post/pt447746/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447734/index.html">Por que o front-end deve entender os princ√≠pios da interface do usu√°rio</a></li>
<li><a href="../pt447736/index.html">V√≠deo Drone - uma nova tend√™ncia nas redes sociais</a></li>
<li><a href="../pt447738/index.html">Julian Assange preso pela pol√≠cia brit√¢nica</a></li>
<li><a href="../pt447742/index.html">Qual √© a metodologia DevOps e quem precisa dela</a></li>
<li><a href="../pt447744/index.html">Escalada Elbrus - Reconhecimento em batalha. Parte t√©cnica 2. Interrup√ß√µes, exce√ß√µes, temporizador do sistema</a></li>
<li><a href="../pt447748/index.html">Sistemas de arquivos virtuais Linux: por que eles s√£o necess√°rios e como eles funcionam? Parte 2</a></li>
<li><a href="../pt447750/index.html">Novos processadores para data centers - analisamos os an√∫ncios dos √∫ltimos meses</a></li>
<li><a href="../pt447752/index.html">Como fizemos o overclock do CAD COMPASS-3D ‚Üí Parte 3</a></li>
<li><a href="../pt447754/index.html">Aplicativo da barra de menus para o macOS</a></li>
<li><a href="../pt447756/index.html">Novo quadrante da Gartner para solu√ß√µes de monitoramento de aplicativos (APM)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>