<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤴🏻 👎🏼 🤛🏾 Gestion de la mémoire déclarative 🕝 ❎ ⏮️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(une traduction plutôt gratuite d'un énorme article émotionnel qui, dans la pratique, fait le pont entre les possibilités de C et de Rust en termes de...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gestion de la mémoire déclarative</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/470129/"><p>  (une <em>traduction plutôt gratuite d'un énorme article émotionnel qui, dans la pratique, fait le pont entre les possibilités de C et de Rust en termes de résolution de problèmes commerciaux et de résolution de bugs liés à la gestion manuelle de la mémoire. Il devrait également être utile pour les personnes ayant une expérience dans la collecte des ordures - il existe de nombreuses différences en termes de sémantique moins qu'il n'y paraît - environ.</em> ) </p><br><p> À partir du moment où je me suis intéressé à Rust, cela m'a semblé une éternité.  Néanmoins, je me souviens clairement d'avoir fait la connaissance de l'analyseur d'emprunt ( <em><strong>vérificateur d'emprunt</strong> , ci <strong>-</strong> après <strong>dénommé</strong> <strong>BC</strong> - environ Per.</em> ), Accompagné d'un mal de tête et de désespoir.  Bien sûr, je ne suis pas le seul à souffrir - il existe de nombreux articles sur Internet sur le thème de la communication avec les ogives.  Cependant, je voudrais me démarquer et mettre en évidence dans cet article l'ogive du point de vue des <em>avantages pratiques</em> , et pas seulement un générateur de maux de tête. </p><br><p>  De temps en temps, je trouve des opinions que dans Rust - gestion manuelle de la mémoire ( <em>probablement juste pas automatique avec GC, alors quoi d'autre? - environ Per.</em> ), Cependant, je ne partage absolument pas ce point de vue.  La méthode utilisée dans Rust, j'appelle le terme « <strong>gestion déclarative de la mémoire</strong> ».  Pourquoi donc - maintenant je vais montrer. </p><a name="habracut"></a><br><h2 id="pravila-oformleniya">  Règles d'inscription </h2><br><p>  Au lieu de théoriser, écrivons quelque chose d'utile. </p><br><p>  Rencontrez <strong>Overbook</strong> - Fiction Publishing House! </p><br><p>  Comme tout éditeur, Overbook a des règles de conception.  Plus précisément, il n'y a qu'une seule règle, aussi simple que les portes - <u>pas de virgule</u> .  Overbuk croit sincèrement que les virgules sont une conséquence de la paresse du droit d'auteur et - citation - «devraient être exterminées en tant que phénomène».  Par exemple, l'expression "Elle a lu et ri" - bonne, convenable.  "Elle a lu, puis a ri" - nécessite une correction. </p><br><p><img src="https://habrastorage.org/webt/t8/ai/et/t8aietskoagxn7dczmydkaml3jo.png"></p><br><p>  Cela ne semble plus simple nulle part, cependant, les auteurs attrapent <em>régulièrement</em> Overbuk sur le non-respect pathologique de cette règle!  Comme si une telle règle n'existait pas du tout, scandaleux!  Nous devons tout revérifier.  Manuellement.  De plus, si un brouillon est demandé par l'éditeur pour être édité, l'auteur peut envoyer une version qui a été corrigée en un, mais corrompue en un autre endroit, et donc tout doit être revérifié dès le début.  Les entreprises ne tolèrent pas une attitude aussi négligente à l'égard du temps de travail, et le besoin s'est fait sentir d'automatiser le processus de capture de la «paresse de l'auteur» par lui-même.  Par exemple, un programme informatique.  Oui oui </p><br><h2 id="robin-speshit-na-vyruchku">  Robin se précipite à la rescousse </h2><br><p>  Robin est l'un des employés de la maison d'édition qui s'est porté volontaire pour aider à la rédaction du programme, car il connaissait la programmation - c'est de la chance!  Il est vrai que tout le monde à l'université, y compris Robin, a appris le C et Java, et Java VM a été déraisonnablement interdit d'installer Java à partir de la maison d'édition - c'est le tour!  Eh bien, que ce soit C, beaucoup a été écrit en C, le langage est sûr et vérifié.  Tout se passera comme il se doit, à 100%. </p><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt;</span></span></span></span>

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"."</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
}</code></pre><br>
<p>   .        ,   Makefile:</p><br>
<pre><code class="plaintext hljs">.PHONY: all

all:
    gcc -Wall -O0 -g main.c -o main
    ./main</code></pre><br>
<p> :</p><br>
<ul>
<li> </li>
<li> </li>
<li> </li>
<li>  </li>
</ul><br>
<p>   :</p><br>
<pre><code class="bash hljs">$ make
gcc -Wall -O0 -g main.c -o main
./main
.</code></pre><br>
<p> . "       !"</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// : #include directives</span></span>

<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class"> {</span></span>
    <span class="hljs-comment"><span class="hljs-comment">// -  :</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *message;
};
<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> {</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *path;

    <span class="hljs-comment"><span class="hljs-comment">// NULL     </span></span>
    <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mistake</span></span></span><span class="hljs-class">;</span></span>
};
<span class="hljs-function"><span class="hljs-function">struct CheckResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">;</span></span>
    result.path = path;
    result.mistake = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;

    <span class="hljs-comment"><span class="hljs-comment">// TODO(Robin):  </span></span>
    <span class="hljs-comment"><span class="hljs-comment">// TODO(Robin):  </span></span>

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;
}

<span class="hljs-comment"><span class="hljs-comment">// : main()</span></span></code></pre><br>
<p>"  " —   — "     ,  256 <em></em> ".</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> BUF_SIZE 256 * 1024</span></span>

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_SIZE];

    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check</span></span></span><span class="hljs-class">("</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sample</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">);</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.mistake != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) {
        <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"  !"</span></span>);
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;
    }

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>;
}</code></pre><br>
<p>    ,  ,      ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>:</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">struct CheckResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">;</span></span>
    result.path = path;
    result.mistake = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;

    FILE *f = fopen(path, <span class="hljs-string"><span class="hljs-string">"r"</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, BUF_SIZE - <span class="hljs-number"><span class="hljs-number">1</span></span>, f);
    fclose(f);
    <span class="hljs-comment"><span class="hljs-comment">//    -  ,   , .</span></span>
    buf[len] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>;

    <span class="hljs-comment"><span class="hljs-comment">// TODO(Robin):  </span></span>

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;
}</code></pre><br>
<p>        ,      *<strong>.txt</strong>,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">  </a>  .   -     ,     ,        ...</p><br>
<p>,      TODO —      ?     .       :</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   malloc</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdlib.h&gt;</span></span></span></span>

<span class="hljs-comment"><span class="hljs-comment">// : structs, etc.</span></span>

<span class="hljs-function"><span class="hljs-function">struct CheckResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">;</span></span>
    result.path = path;
    result.mistake = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;

    FILE *f = fopen(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"r"</span></span>);
    <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len = fread(buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, BUF_SIZE - <span class="hljs-number"><span class="hljs-number">1</span></span>, f);
    fclose(f);
    buf[len] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>;

    <span class="hljs-comment"><span class="hljs-comment">//    C99,      </span></span>
    <span class="hljs-comment"><span class="hljs-comment">//  ,  ,    ,</span></span>
    <span class="hljs-comment"><span class="hljs-comment">//   .</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buf[i] == <span class="hljs-string"><span class="hljs-string">','</span></span>) {
            <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">malloc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class">));</span></span>
            m-&gt;message = <span class="hljs-string"><span class="hljs-string">" !"</span></span>;
            result.mistake = m;
            <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
        }
    }

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;
}</code></pre><br>
<p>           "" (<em>     — ..</em>)   <code>sample.txt</code>:</p><br>
<pre><code class="plaintext hljs">',  , !</code></pre><br>
<p>   :</p><br>
<pre><code class="bash hljs">$ make
gcc -Wall -O0 -g main.c -o main
./main
  !</code></pre><br>
<p>  <code>sample2.txt</code>     —   :</p><br>
<pre><code class="plaintext hljs">     .</code></pre><br>
<p> :</p><br>
<pre><code class="bash hljs">$ make
gcc -Wall -O0 -g main.c -o main
./main</code></pre><br>
<p>  !                    .</p><br>
<h2 id="a-cherez-nedelyu">  ...</h2><br>
<p>              :</p><br>
<blockquote>  , ,     .         ,  , <strong>     </strong> .<br>
,   ,                .           ?</blockquote><p>     . ".     Mistake  , , .".  — :</p><br>
<pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class"> {</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *message;

    <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *location;
}
<span class="hljs-comment"><span class="hljs-comment">// ...</span></span>
<span class="hljs-function"><span class="hljs-function">struct CheckResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">// :  'result' </span></span>
    <span class="hljs-comment"><span class="hljs-comment">// :  </span></span>

   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buf[i] == <span class="hljs-string"><span class="hljs-string">','</span></span>) {
            <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">malloc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class">));</span></span>

            <span class="hljs-comment"><span class="hljs-comment">// :  </span></span>
            m-&gt;location = &amp;buf[i];

            m-&gt;message = <span class="hljs-string"><span class="hljs-string">" !"</span></span>;
            result.mistake = m;
            <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
        }
    }

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;
}</code></pre><br>
<p>    :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct CheckResult result)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>);
    <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"~ %s ~\n"</span></span>, result.path);
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.mistake == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) {
        <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">" !!\n"</span></span>);
    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-comment"><span class="hljs-comment">// : "%s"   .</span></span>
        <span class="hljs-comment"><span class="hljs-comment">//       12  ,  ,</span></span>
        <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(
            <span class="hljs-string"><span class="hljs-string">": %s: '%.12s'\n"</span></span>,
            result.mistake-&gt;message,
            result.mistake-&gt;location
        );
    }
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_SIZE];
    {
        <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check</span></span></span><span class="hljs-class">("</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sample</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">);</span></span>
        report(result);
    }
    {
        <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check</span></span></span><span class="hljs-class">("</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sample2</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">);</span></span>
        report(result);
    }
}</code></pre><br>
<p>«», —  . :</p><br>
<pre><code class="bash hljs">$ make
gcc -Wall -O0 -g main.c -o main
./main

~ sample.txt ~
:  !: <span class="hljs-string"><span class="hljs-string">',  '</span></span>

~ sample2.txt ~
 !!</code></pre><br>
<p>.  ,           ,      ?</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_RESULTS 128</span></span>

<span class="hljs-comment"><span class="hljs-comment">// : ,   </span></span>

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_SIZE];

    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bad_results</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAX_RESULTS</span></span></span><span class="hljs-class">];</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num_results = <span class="hljs-number"><span class="hljs-number">0</span></span>;

    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *paths[] = { <span class="hljs-string"><span class="hljs-string">"sample2.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> };
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; paths[i] != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; i++) {
        <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *path = paths[i];
        <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">path</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">);</span></span>
        bad_results[num_results++] = result;
    }

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; num_results; i++) {
        report(bad_results[i]);
    }
}</code></pre><br>
<p> .        —     ,    .      .</p><br>
<pre><code class="bash hljs">$ make
gcc -Wall -O0 -g main.c -o main
./main

~ sample2.txt ~
 !!

~ sample.txt ~
:  !: <span class="hljs-string"><span class="hljs-string">',  '</span></span></code></pre><br>
<h2 id="priklyucheniya-prodolzhayutsya"> </h2><br>
<p>     :</p><br>
<blockquote>, ,<br>
   ,       ,    ,       !      -  —    . ?</blockquote><p>"!" —   — "    !"<br>
     .   ,    ,   :</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">// :  </span></span>

    <span class="hljs-comment"><span class="hljs-comment">//   "sample2.txt", "sample.txt"</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *paths[] = { <span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"sample2.txt"</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> };

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; paths[i] != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; i++) {
        <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    }

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; num_results; i++) {
        report(results[i]);
    }
}
```bash
$ make
gcc -Wall -O0 -g main.c -o main
./main

~ sample.txt ~
:  !: <span class="hljs-string"><span class="hljs-string">'   '</span></span>

~ sample2.txt ~
 !!</code></pre><br>
<p> -      . ,   ,   :</p><br>
<p> —   , .        !      ,  -    — !</p><br>
<p>     - ,  ,   ,   ,         ,     :</p><br>
<p> — , .         .  .</p><br>
<p>   .         —    .      —             .</p><br>
<p>"       -?" —  .</p><br>
<pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,  memcpy</span></span>
<span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string.h&gt;</span></span></span></span>

<span class="hljs-function"><span class="hljs-function">struct CheckResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *path, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *buf)</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">// : ,  </span></span>

    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) {
        <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buf[i] == <span class="hljs-string"><span class="hljs-string">','</span></span>) {
            <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">malloc</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sizeof</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span><span class="hljs-class">));</span></span>

            <span class="hljs-comment"><span class="hljs-comment">//   12   "m-&gt;location"</span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> location_len = len - i;
            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (location_len &gt; <span class="hljs-number"><span class="hljs-number">12</span></span>) {
                location_len = <span class="hljs-number"><span class="hljs-number">12</span></span>;
            }
            m-&gt;location = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(location_len + <span class="hljs-number"><span class="hljs-number">1</span></span>);
            <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(m-&gt;location, &amp;buf[i], location_len);
            m-&gt;location[location_len] = <span class="hljs-string"><span class="hljs-string">'\0'</span></span>;

            m-&gt;message = <span class="hljs-string"><span class="hljs-string">" !"</span></span>;
            result.mistake = m;
            <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;
        }
    }

    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result;
}</code></pre><br>
<p> ,   <em>   </em>,     , <code>sample3.txt</code>:</p><br>
<pre><code class="plaintext hljs">   ,    </code></pre><br>
<p>, !</p><br>
<pre><code class="bash hljs">$ make
gcc -Wall -O0 -g main.c -o main
./main

~ sample.txt ~
:  !: <span class="hljs-string"><span class="hljs-string">',  '</span></span>

~ sample2.txt ~
 !!

~ sample3.txt ~
mistake:  : <span class="hljs-string"><span class="hljs-string">',    '</span></span></code></pre><br>
<h2 id="koresh-direktora"> </h2><br>
<p>,      —       :</p><br>
<blockquote>, .   ,<br>
     .   ,   ,     . ,      ,      ,       ,   ?</blockquote><p>"  ",      . ,  ,     <code>malloc()</code>,      <code>free()</code>  .         ,   ?      ,    100%,          - ,  - -    .   ,  .</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_SIZE];

    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">results</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAX_RESULTS</span></span></span><span class="hljs-class">];</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num_results = <span class="hljs-number"><span class="hljs-number">0</span></span>;

    <span class="hljs-comment"><span class="hljs-comment">// : ,  </span></span>

    <span class="hljs-comment"><span class="hljs-comment">//   !</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; num_results; i++) {
        <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(results[i].mistake);
    }
}</code></pre><br>
<p>  .  — <code>buf</code>  <code>results</code>         .    ,      .</p><br>
<p> — ,  ?<br>
 — ,   ?<br>
 —  ,  .     .<br>
 — , , ! . ,    .       .<br>
 — .   ?</p><br>
<p>.  .     ,      .  ,   .    :</p><br>
<p> —  .     <code>free()</code>,  ,       .</p><br>
<p>  ,  ,  -     ,   ,  ,      " ",   /    ,     .</p><br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-comment"><span class="hljs-comment">//   ...</span></span>

    <span class="hljs-comment"><span class="hljs-comment">//      !</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; num_results; i++) {
        <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(results[i].mistake-&gt;location);
        <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(results[i].mistake);
    }
}</code></pre><br>
<p> —  ,  .  <code>free()</code>  ,   ,     ,   ,    .</p><br>
<p>-     ,   ,  .    .      -,  , ,  , .    :</p><br>
<p> — ,     <code>free()</code>.   .</p><br>
<p>     ,     ,  ,   ,          ,   ,      .  .    .     .</p><br>
<p> — -, , , , .</p><br>
<h2 id="spustya-god"> </h2><br>
<p>   .  ,  ,  ,  .      ,       . ,   ,      .<br>
,     .</p><br>
<p> — ,  .  ,    .</p><br>
<p>   ,     .    .  - . ,   ?</p><br>
<p> —   , , ?<br>
 —    .   ,   .</p><br>
<p>            .       (  !)    .  ,     ,   .    . </p><br>
<p>    .       ,      .   , .   .</p><br>
<p> — , —     , —       ?<br>
 —    ,   130   .</p><br>
<p>,  .</p><br>
<pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MAX_RESULTS 128</span></span>

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{
    <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_SIZE];

    <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckResult</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">results</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MAX_RESULTS</span></span></span><span class="hljs-class">];</span></span>

    <span class="hljs-comment"><span class="hljs-comment">// ...</span></span>
}</code></pre><br>
<p>  ,  ,   ,          .   <code>results</code>     (   ,     ).           ,     <code>results</code>      <code>results</code>.  <code>buf</code>  ,   <code>results</code>    ,     ,      <code>buf</code>  ,        .    .        <code>MAX_RESULTS</code>  256.      .</p><br>
<p> — …  .     .       ,     .   ,    -  ,  ,  .   .  .</p><br>
<p>      .        256   ,  ,   .   .     .</p><br>
<p>" ." —    , — "  Rust."</p><br>
<h2 id="knigoy-spustya"> </h2><br>
<p>(<em>,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> — ..</em>)</p><br>
<p>    <code>cargo new checker</code>   <code>src/main.rs</code>. .      :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fs::read_to_string;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = read_to_string(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>);
}</code></pre><br>
<p>",   Ruby!" —    , -     .  .  , ,   Ruby.     . </p><br>
<p>",       ?"</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = read_to_string(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>);
    s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>);
}</code></pre><br>
<p> ,     :</p><br>
<pre><code class="plaintext hljs">error[E0599]: no method named `find` found for type `std::result::Result&lt;std::string::String, std::io::Error&gt;` in the current scope
 --&gt; src\main.rs:5:7
  |
5 |     s.find(",");
  |       ^^^^</code></pre><br>
<p>.       —   <code>Result&lt;String, Error&gt;</code>  <code>find()</code> ,     <code>String</code>.  <strong></strong>   .</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = read_to_string(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>)?;
    s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>);

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<p>  ,  <code>main()</code>   ,    <code>read_to_string()</code>    <code>main()</code>,     .    ,    ,        .     ,   <code>find()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = read_to_string(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>)?;

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>);
    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"Result: {:?}"</span></span>, result);

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<pre><code class="bash hljs">$ cargo run --quiet
Result: Some(22)</code></pre><br>
<p>.   - ,  <code>Option::Some(index)</code>,   ,  <code>Option::None</code>.       ( ,    — ..):</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> path = <span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = read_to_string(path)?;

    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"~ {} ~"</span></span>, path);
    <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">":  :  №{}"</span></span>, index);
        },
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">" !!"</span></span>),
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<pre><code class="bash hljs">$ cargo run --quiet
~ sample.txt ~
:  :  №22</code></pre><br>
<p>     ,  ,            ,     .      .</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> path = <span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = read_to_string(path)?;

    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"~ {} ~"</span></span>, path);
    <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-comment"><span class="hljs-comment">// ,      ,</span></span>
            <span class="hljs-comment"><span class="hljs-comment">//    12 ,</span></span>
            <span class="hljs-comment"><span class="hljs-comment">//     </span></span>
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> slice = &amp;s[index..];
            <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">":  : {:?}"</span></span>, slice);
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">" !!"</span></span>),
    }
    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<pre><code class="bash hljs">$ cargo run --quiet
~ sample.txt ~
:  : <span class="hljs-string"><span class="hljs-string">',  , !'</span></span></code></pre><br>
<p>     .  <code>malloc()</code>!  <code>memcpy()</code>!        (  Go   ,  — ..)!      <code>{:?}</code>,   ,   ,    . ,  <code>free()</code>   .    ,      ,         —   <code>s</code>    <code>match</code>.  (<code>&amp;s[index..]</code>)      ,       ,   .    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a>  ,  ,     .</p><br>
<h2 id="sokraschaem-razryv"> </h2><br>
<p>   <code>main()</code>       ,     ,     <code>check()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    check(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>)?;

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> s = read_to_string(path)?;

    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"~ {} ~"</span></span>, path);
    <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> slice = &amp;s[index..];
            <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">":  : {:?}"</span></span>, slice);
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">" !!"</span></span>),
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<p> ,       .   .<br>
  ,          ,     .      :</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::with_capacity(<span class="hljs-number"><span class="hljs-number">256</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>);

    check(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s)?;

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fs::File;
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io::Read;

    s.clear();
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"~ {} ~"</span></span>, path);
    <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> slice = &amp;s[index..];
            <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">":  : {:?}"</span></span>, slice);
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">" !!"</span></span>),
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<p>     :</p><br>
<ul>
<li>     <code>s</code>  256 ,      .</li>
<li>      —  ,      :   ,     .</li>
<li>,    <code>#include</code>,  <code>use</code>  ,    :  <code>Read</code>    <code>read_to_string</code>    <code>check()</code>.</li>
</ul><br>
<p>, ,   .    <code>check()</code>  <code>CheckResult</code>,   <em> </em> <code>Mistake</code>.   Rust      <code>CheckResult</code> ,    <code>Option&lt;Mistake&gt;</code>. , <code>Mistake</code>   .   :</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span> {
    location: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,
}</code></pre><br>
<p> .     .</p><br>
<pre><code class="bash hljs">$ cargo run --quiet
error[E0106]: missing lifetime specifier
  --&gt; src\main.rs:10:15
   |
10 |     location: &amp;str,
   |               ^ expected lifetime parameter</code></pre><br>
<p>"",  , "    !",             ,    .           ,  ,     —    <strong> </strong> (<em>   — <strong></strong> — ..</em>).   ,      :</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; {
    location: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,
}</code></pre><br>
<p> ,     ,   ,         ,              .    ,     ,   .<br>
 ,  <code>check()</code>  <code>Option&lt;Mistake&gt;</code>  <code>()</code> (<em>,  ,       — ..</em>):</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;, std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fs::File;
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io::Read;

    s.clear();
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"~ {} ~"</span></span>, path);

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> location = &amp;s[index..];
            <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { location })
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">None</span></span>,
    })
}</code></pre><br>
<p>      ,       .   —    ,     . <code>match</code> — ,  <code>Ok(match ...)</code> .    ,       <code>main()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::with_capacity(<span class="hljs-number"><span class="hljs-number">256</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>);

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = check(<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s)?;

    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(mistake) = result {
        <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">":  : {:?}"</span></span>, mistake.location);
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<p>"  ,  <code>result</code>     ",      , "      ".  -     <code>if let</code>,   ,     <code>match</code>,    !<br>
 !</p><br>
<pre><code class="rust hljs">$ cargo run --quiet
error[E0106]: missing lifetime specifier
  --&gt; src\main.rs:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">55</span></span>
   |
<span class="hljs-number"><span class="hljs-number">17</span></span> | <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;, std::io::Error&gt; {
   |                                                       ^^^^^^^ expected lifetime parameter</code></pre><br>
<p>     ,        .  ,       :</p><br>
<blockquote>:       ,     ,     <code>path</code>   <code>s</code>.</blockquote><p>? ,  <code>Mistake</code>  <code>location: &amp;'a str</code> — .    <code>s</code> —   .         :</p><br>
<pre><code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">//         :</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io::Error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> E;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
    <span class="hljs-comment"><span class="hljs-comment">// ...</span></span>
}</code></pre><br>
<p>,  .     <code>'a</code>?   .      ?       , ?  ,  ?     , .</p><br>
<pre><code class="rust hljs">error[E0261]: <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> of undeclared lifetime name `<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>`
  --&gt; src\main.rs:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span>
   |
<span class="hljs-number"><span class="hljs-number">19</span></span> | <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
   |                          ^^ undeclared lifetime

error[E0261]: <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> of undeclared lifetime name `<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>`
  --&gt; src\main.rs:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">66</span></span>
   |
<span class="hljs-number"><span class="hljs-number">19</span></span> | <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
   |                                                                  ^^ undeclared lifetime</code></pre><br>
<p> .    ?    :</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; {
    location: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,
}</code></pre><br>
<p>,  ,    <code>'a</code>  <code>location: &amp;'a str</code>   <code>'a</code>   <code>Mistake&lt;'a&gt;</code>,          Java. .       Java       Rust?</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
    <span class="hljs-comment"><span class="hljs-comment">// ...</span></span>
}</code></pre><br>
<p>  , !</p><br>
<pre><code class="rust hljs">$ cargo run --quiet
~ sample.txt ~
:  : <span class="hljs-string"><span class="hljs-string">",  , !"</span></span></code></pre><br>
<h2 id="bolshe-struktur"> !</h2><br>
<p> ,    :</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::with_capacity(<span class="hljs-number"><span class="hljs-number">256</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>);

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> path = <span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = check(path, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s)?;

    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"~ {} ~"</span></span>, path);
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(mistake) = result {
        <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">":  : {:?}"</span></span>, mistake.location);
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}

<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; {
    location: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,
}

<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io::Error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> E;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fs::File;
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io::Read;

    s.clear();
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> location = &amp;s[index..];
            <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { location })
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">None</span></span>,
    })
}</code></pre><br>
<p> <code>'a</code>    ,       ,      . ,   .  <code>report()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::with_capacity(<span class="hljs-number"><span class="hljs-number">256</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>);

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> path = <span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>;
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = check(path, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s)?;
    report(path, result);

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span></span>(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, result: <span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;) {
    <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"~ {} ~"</span></span>, path);
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(mistake) = result {
        <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">":  : {:?}"</span></span>, mistake.location);
    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">" !!"</span></span>);
    }
}</code></pre><br>
<p>,       <code>Mistake</code>,        <code>Display</code>     .</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; {
    <span class="hljs-comment"><span class="hljs-comment">// !</span></span>
    path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,
    location: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,
}</code></pre><br>
<p>  ,   ,    ,      <code>'static</code>.      ,  —       .    <code>check()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;(path: &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fs::File;
    <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io::Read;

    s.clear();
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> location = &amp;s[index..];
            <span class="hljs-comment"><span class="hljs-comment">// !</span></span>
            <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { path, location })
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">None</span></span>,
    })
}</code></pre><br>
<p>    :</p><br>
<pre><code class="bash hljs">$ cargo run --quiet
error[E0621]: explicit lifetime required <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of `path`
  --&gt; src\main.rs:37:28
   |
27 | fn check&lt;<span class="hljs-string"><span class="hljs-string">'a&gt;(path: &amp;str, s: &amp;'</span></span>a mut String) -&gt; Result&lt;Option&lt;Mistake&lt;<span class="hljs-string"><span class="hljs-string">'a&gt;&gt;, E&gt; {
   |                    ---- help: add explicit lifetime `'</span></span>static` to the <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> of `path`: `&amp;<span class="hljs-string"><span class="hljs-string">'static str`
...
37 |             Some(Mistake { path, location })
   |                            ^^^^ lifetime `'</span></span>static` required</code></pre><br>
<pre><code class="rust hljs"><span class="hljs-comment"><span class="hljs-comment">// new: &amp;'static</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;(path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
    <span class="hljs-comment"><span class="hljs-comment">// ...</span></span>
}</code></pre><br>
<p>  <code>Display</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fmt;

<span class="hljs-keyword"><span class="hljs-keyword">impl</span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; fmt::Display <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, f: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> fmt::Formatter) -&gt; fmt::<span class="hljs-built_in"><span class="hljs-built_in">Result</span></span> {
        <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(
            f,
            <span class="hljs-string"><span class="hljs-string">"{}:  : {:?}"</span></span>,
            <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.location
        )
    }
}</code></pre><br>
<p>     <code>report()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span></span>(result: <span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(mistake) = result {
        <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, mistake);
    }
}</code></pre><br>
<p>,    :)</p><br>
<pre><code class="bash hljs">$ cargo run --quiet
sample.txt:  : <span class="hljs-string"><span class="hljs-string">",  , !"</span></span></code></pre><br>
<p>50  ,     ,      .    ,   ?</p><br>
<h2 id="srazu-neskolko-tekstov">  </h2><br>
<p>,  .  !</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::with_capacity(<span class="hljs-number"><span class="hljs-number">256</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>);

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> paths = [<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"sample2.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"sample3.txt"</span></span>];
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;paths {
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = check(path, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s)?;
        report(result);
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<pre><code class="bash hljs">$ cargo run --quiet
sample.txt:  : <span class="hljs-string"><span class="hljs-string">",  , !"</span></span>
sample3.txt:  :  <span class="hljs-string"><span class="hljs-string">",    "</span></span></code></pre><br>
<p>   .    ,          ,      .  .</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s = <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>::with_capacity(<span class="hljs-number"><span class="hljs-number">256</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>);

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> paths = [<span class="hljs-string"><span class="hljs-string">"sample.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"sample2.txt"</span></span>, <span class="hljs-string"><span class="hljs-string">"sample3.txt"</span></span>];

    <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> results = <span class="hljs-built_in"><span class="hljs-built_in">vec!</span></span>[];
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;paths {
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = check(path, &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> s)?;
        results.push(result);
    }

    <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> results {
        report(result);
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}</code></pre><br>
<p>     ...</p><br>
<pre><code class="bash hljs">$ cargo run --quiet
error[E0499]: cannot borrow `s` as mutable more than once at a time
 --&gt; src\main.rs:9:34
  |
9 |         <span class="hljs-built_in"><span class="hljs-built_in">let</span></span> result = check(path, &amp;mut s)?;
  |                                  ^^^^^^ mutable borrow starts here <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> previous iteration of loop</code></pre><br>
<p>. -?   <code>s</code>     ??</p><br>
<p>  -   . ,  ,    <code>s</code>,   <code>&amp;s</code>.    — , , <code>&amp;mut s</code>.        ? ,   <code>s</code>      :</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;(path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt;&gt;, E&gt; {
    <span class="hljs-comment"><span class="hljs-comment">//     `s` - </span></span>
    s.clear();

    <span class="hljs-comment"><span class="hljs-comment">//       `s` -  !</span></span>
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-comment"><span class="hljs-comment">//  .</span></span>
}</code></pre><br>
<p>,        .   , ...</p><br>
<p><strong> Rust.<br>
  .<br>
 ,       !<br>
        ,  Rust   !!</strong></p><br>
<p> .<br>
. ,    ,  .   <code>memcpy()</code>, -.</p><br>
<p>       <code>Mistake</code>. <code>location</code>      ,          .       <code>Mistake</code> <em></em>  ,     .      Rust?</p><br>
<p>       —   <code>String</code>, ,    <code>&amp;str</code>    .      ,       ,      .    .</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span>&lt;<span class="hljs-symbol"><span class="hljs-symbol">'a</span></span>&gt; {
    <span class="hljs-comment"><span class="hljs-comment">//    ,   </span></span>
    path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,

    <span class="hljs-comment"><span class="hljs-comment">//      Mistake</span></span>
    location: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>,
}</code></pre><br>
<p>,      , :</p><br>
<pre><code class="bash hljs">error[E0392]: parameter `<span class="hljs-string"><span class="hljs-string">'a` is never used
  --&gt; src\main.rs:27:16
   |
27 | struct Mistake&lt;'</span></span>a&gt; {
   |                ^^ unused parameter
   |
   = <span class="hljs-built_in"><span class="hljs-built_in">help</span></span>: consider removing `<span class="hljs-string"><span class="hljs-string">'a` or using a marker such as `std::marker::PhantomData`</span></span></code></pre><br>
<p>"-,   ",   ,  <code>&lt;'a&gt;</code>  .     <code>'a</code>  <code>Display</code>  <code>check()</code>:</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span> {
    <span class="hljs-comment"><span class="hljs-comment">//    ,   </span></span>
    path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,

    <span class="hljs-comment"><span class="hljs-comment">//      Mistake</span></span>
    location: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>,
}
<span class="hljs-comment"><span class="hljs-comment">// ...</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> fmt::Display <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, f: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> fmt::Formatter) -&gt; fmt::<span class="hljs-built_in"><span class="hljs-built_in">Result</span></span> {
        <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(
            f,
            <span class="hljs-string"><span class="hljs-string">"{}:  : {:?}"</span></span>,
            <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.location
        )
    }
}
<span class="hljs-comment"><span class="hljs-comment">// ...</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;, E&gt; {
    s.clear();
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> location = &amp;s[index..];
            <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { path, location })
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">None</span></span>,
    })
}</code></pre><br>
<p>, ,  :</p><br>
<pre><code class="rust hljs">error[E0308]: mismatched types
  --&gt; src\main.rs:<span class="hljs-number"><span class="hljs-number">43</span></span>:<span class="hljs-number"><span class="hljs-number">34</span></span>
   |
<span class="hljs-number"><span class="hljs-number">43</span></span> |             <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { path, location })
   |                                  ^^^^^^^^
   |                                  |
   |                                  expected <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> `</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span></span>::string::<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>`, found &amp;<span class="hljs-built_in"><span class="hljs-built_in">str</span></span>
   |                                  help: try using a conversion method: `location: location.to_string()`
   |
   = note: expected <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> `</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">std</span></span></span></span>::string::<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>`
              found <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> `&amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">str</span></span></span></span>`</code></pre><br>
<p>. <code>location</code>    <em></em>  <code>s</code>.   ,        .                ,        . ,   ,       "Rust"  "",           .            —     ?</p><br>
<p>"    <code>malloc()</code>.    ,  -  !   ?"       ,    .     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>   :</p><br>
<p><img src="https://habrastorage.org/webt/qy/cp/l7/qycpl7yr-boibdoi5rlqrsg-rc8.png"></p><br>
<p>"      .  <code>ToString</code>     ,  <code>ToOwned</code> —         ,   .     :</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;, E&gt; {
    s.clear();
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">match</span></span> s.find(<span class="hljs-string"><span class="hljs-string">","</span></span>) {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(index) =&gt; {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> location = s[index..].to_string();
            <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { path, location })
        }
        <span class="hljs-literal"><span class="hljs-literal">None</span></span> =&gt; <span class="hljs-literal"><span class="hljs-literal">None</span></span>,
    })
}</code></pre><br>
<pre><code class="rust hljs">```bash
$ cargo run --quiet
sample.txt:  : <span class="hljs-string"><span class="hljs-string">",  , !"</span></span>
sample3.txt:  :  <span class="hljs-string"><span class="hljs-string">",    "</span></span></code></pre><br>
<p>    .      ,  ,   ,     ,     .</p><br>
<h2 id="proshlo-pyat-let">  </h2><br>
<p>   Rust-     ,       .  ,       ,   .     ,      , ,     ,      .       —     !</p><br>
<blockquote> ,<br>
  .    ,       ,      ,  ,     ,     ,   .         ,           ,    .</blockquote><p>". .          ."</p><br>
<p>    . ,   , ,   ...</p><br>
<p>"   ..."      ,   . -,   -   ,   -  ,      ,    .  ,      ,        ,       ,         .</p><br>
<p>".  .   ."</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span> {
    path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,
    locations: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">String</span></span>&gt;,
}</code></pre><br>
<p>,       (   ,   !).       ,  , ,   ,   ,      ,      ,  ,   ,      -.       ,  ,    <code>find()</code>     .</p><br>
<p>",     <code>find</code>  ,          .   -  .    ?"</p><br>
<p>     <code>'str</code>   :<br>
<img src="https://habrastorage.org/webt/fl/o6/wu/flo6wujzw9yxuhdzmb5ljxemobo.png"></p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>, s: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;, E&gt; {
    s.clear();
    File::open(path)?.read_to_string(s)?;

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> locations: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;_&gt; = s
        .match_indices(<span class="hljs-string"><span class="hljs-string">","</span></span>)
        .map(|(index, slice)| slice.to_string())
        .collect();

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> locations.is_empty() {
        <span class="hljs-literal"><span class="hljs-literal">None</span></span>
    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { path, locations })
    })
}</code></pre><br>
<p>", <code>if</code>      !"      ,    ,    .   ,      <em></em>     <em></em>  ,       .     <code>map()</code>  <code>collect()</code>. </p><br>
<p>  <code>Display</code>,  :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> fmt::Display <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, f: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> fmt::Formatter) -&gt; fmt::<span class="hljs-built_in"><span class="hljs-built_in">Result</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.locations {
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{}:  : {:?}\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path, location)?;
        }
        <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
    }
}</code></pre><br>
<p>     <code>sample.txt</code>     :</p><br>
<pre><code class="plaintext hljs">,  , !
    !
  ́ ́  —
 !

   ,    
  .
    
  .</code></pre><br>
<p>"   ,     ,   ",     . ,  .</p><br>
<pre><code class="bash hljs">$ cargo run --quiet
sample4.txt:  : <span class="hljs-string"><span class="hljs-string">","</span></span>
sample4.txt:  : <span class="hljs-string"><span class="hljs-string">","</span></span>
sample4.txt:  : <span class="hljs-string"><span class="hljs-string">","</span></span></code></pre><br>
<p>.    . .  .  . "   <code>location</code>   ,         ?"</p><br>
<pre><code class="rust hljs">    <span class="hljs-comment"><span class="hljs-comment">// check():</span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> locations: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;_&gt; = s
        .match_indices(<span class="hljs-string"><span class="hljs-string">","</span></span>)
        .map(|(index, _)| {
            <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::cmp::{max, min};
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> start = max(<span class="hljs-number"><span class="hljs-number">0</span></span>, index - <span class="hljs-number"><span class="hljs-number">12</span></span>);
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> end = min(index + <span class="hljs-number"><span class="hljs-number">12</span></span>, s.len());
            s[start..end].to_string()
        })
        .collect();</code></pre><br>
<blockquote>.:       <strong></strong>. ,      ,     ASCII,   21    UTF-         .</blockquote><p>(<em>.:  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>,  .</em>)</p><br>
<pre><code class="bash hljs">$ cargo run --quiet
sample4.txt:  : <span class="hljs-string"><span class="hljs-string">",  "</span></span>
sample4.txt:  : <span class="hljs-string"><span class="hljs-string">" , !"</span></span>
sample4.txt:  : <span class="hljs-string"><span class="hljs-string">"   ,    "</span></span></code></pre><br>
<p>"  ,  -  ."  . "    , -,    ,  ,    .          <code>check()</code>,     <code>report()</code>.  -  —  ,         ,   ."</p><br>
<p>" ,    ,  ,  <u>  </u>, ."</p><br>
<h2 id="plan"></h2><br>
<p> .<br>
 . <code>check()</code>    <em></em>  ,  <code>report()</code> —    .<br>
 .  —     ,    .<br>
   :</p><br>
<pre><code class="rust hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span> {
    path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,

    text: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>,
    locations: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>&gt;,
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;, E&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> text = std::fs::read_to_string(path)?;

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> locations: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;_&gt; = text.match_indices(<span class="hljs-string"><span class="hljs-string">","</span></span>).map(|(index, _)| index).collect();

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> locations.is_empty() {
        <span class="hljs-literal"><span class="hljs-literal">None</span></span>
    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake { path, text, locations })
    })
}</code></pre><br>
<p>          .      ,       ,        <code>Mistake</code>,      (   ?).<br>
(<em>       UTF-8? — ..</em>)</p><br>
<p>     —       <code>Mistake</code>.</p><br>
<pre><code class="bash hljs">$ cargo run --quiet
warning: field is never used: `text`
  --&gt; src\main.rs:28:5
   |
28 |     text: String,
   |     ^^^^^^^^^^^^
   |
   = note: <span class="hljs-comment"><span class="hljs-comment">#[warn(dead_code)] on by default</span></span>

sample4.txt:  : 1
sample4.txt:  : 19
sample4.txt:  : 83</code></pre><br>
<p>, -   .          .    :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">line_bounds</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, index: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; (<span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> len = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text.len();

        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> before = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[..index];
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> start = before.rfind(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>).map(|x| x + <span class="hljs-number"><span class="hljs-number">1</span></span>).unwrap_or(<span class="hljs-number"><span class="hljs-number">0</span></span>);

        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> after = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[index + <span class="hljs-number"><span class="hljs-number">1</span></span>..];
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> end = after.find(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>).map(|x| x + index + <span class="hljs-number"><span class="hljs-number">1</span></span>).unwrap_or(len);

        (start, end)
    }
}</code></pre><br>
<p>"    <code>rfind()</code>. ,       ,          ,       <code>unwrap_or()</code>."</p><br>
<p>   ,    :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> fmt::Display <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, f: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> fmt::Formatter) -&gt; fmt::<span class="hljs-built_in"><span class="hljs-built_in">Result</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> &amp;location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.locations {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (start, end) = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.line_bounds(location);
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> line = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[start..end];
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{}:  :\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path)?;
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>)?;
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"      | {}"</span></span>, line)?;
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>)?;
        }
        <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
    }
}</code></pre><br>
<pre><code class="bash hljs">$ cargo run --quiet
sample4.txt:  :

      | ,  , !

sample4.txt:  :

      | ,  , !

sample4.txt:  :

      |    ,    </code></pre><br>
<p>     .  ! </p><br>
<p>  ,  -  :</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> fmt::Display <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, f: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> fmt::Formatter) -&gt; fmt::<span class="hljs-built_in"><span class="hljs-built_in">Result</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> &amp;location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.locations {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (start, end) = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.line_bounds(location);
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> line = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[start..end];

            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> line_number = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[..start].matches(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>).count() + <span class="hljs-number"><span class="hljs-number">1</span></span>;

            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{}:  :\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path)?;
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>)?;
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{:&gt;8} | {}"</span></span>, line_number, line)?;
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"\n\n"</span></span>)?;
        }
        <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
    }
}</code></pre><br>
<pre><code class="bash hljs">$ cargo run --quiet
sample4.txt:  :

      1 | ,  , !

sample4.txt:  :

      1 | ,  , !

sample4.txt:  :

      6 |    ,    </code></pre><br>
<p>(  ,       Rust    ?)</p><br>
<p>  — ,       .   ,        Rust,           <code>^</code>.      —  <code>Display</code>,    ,     , ,   ,    .   11  (      8  +  <code>|</code>,  3 ):<br>
(<em>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">technic93</a>,     utf-8,    ,   ,    ,   .      ,  — ..</em>)</p><br>
<pre><code class="rust hljs"><span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> fmt::Display <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, f: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> fmt::Formatter) -&gt; fmt::<span class="hljs-built_in"><span class="hljs-built_in">Result</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> &amp;location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.locations {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (start, end) = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.line_bounds(location);
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> line = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[start..end];

            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> line_number = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[..start].matches(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>).count() + <span class="hljs-number"><span class="hljs-number">1</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> comma_index = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[start..location].chars().count();

            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{}:  :\n\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path)?;

            <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{:&gt;8} | {}\n"</span></span>, line_number, line)?;

            <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{}^\n\n"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>.repeat(<span class="hljs-number"><span class="hljs-number">11</span></span> + comma_index))?;
        }
        <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
    }
}</code></pre><br>
<pre><code class="bash hljs">$ cargo run --quiet
sample4.txt:  :

      1 | ,  , !
           ^

sample4.txt:  :

      1 | ,  , !
                             ^

sample4.txt:  :

      6 |    ,    
                        ^</code></pre><br>
<p><strong>.</strong></p><br>
<p>    . 85 .</p><br>
<pre><code class="rust hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span></span>() -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;(), std::io::Error&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> paths = [<span class="hljs-string"><span class="hljs-string">"sample4.txt"</span></span>];

    <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> results = <span class="hljs-built_in"><span class="hljs-built_in">vec!</span></span>[];
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> path <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;paths {
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = check(path)?;
        results.push(result);
    }

    <span class="hljs-comment"><span class="hljs-comment">//   </span></span>
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> results {
        report(result);
    }

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">report</span></span></span></span>(result: <span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;) {
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(mistake) = result {
        <span class="hljs-built_in"><span class="hljs-built_in">println!</span></span>(<span class="hljs-string"><span class="hljs-string">"{}"</span></span>, mistake);
    }
}

<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mistake</span></span></span></span> {
    path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>,

    text: <span class="hljs-built_in"><span class="hljs-built_in">String</span></span>,
    locations: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>&gt;,
}

<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::io::Error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> E;

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">check</span></span></span></span>(path: &amp;<span class="hljs-symbol"><span class="hljs-symbol">'static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Result</span></span>&lt;<span class="hljs-built_in"><span class="hljs-built_in">Option</span></span>&lt;Mistake&gt;, E&gt; {
    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> text = std::fs::read_to_string(path)?;

    <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> locations: <span class="hljs-built_in"><span class="hljs-built_in">Vec</span></span>&lt;_&gt; = text.match_indices(<span class="hljs-string"><span class="hljs-string">","</span></span>).map(|(index, _)| index).collect();

    <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> locations.is_empty() {
        <span class="hljs-literal"><span class="hljs-literal">None</span></span>
    } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
        <span class="hljs-literal"><span class="hljs-literal">Some</span></span>(Mistake {
            path,
            text,
            locations,
        })
    })
}

<span class="hljs-keyword"><span class="hljs-keyword">use</span></span> std::fmt;

<span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">line_bounds</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, index: <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) -&gt; (<span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">usize</span></span>) {
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> len = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text.len();

        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> before = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[..index];
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> start = before.rfind(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>).map(|x| x + <span class="hljs-number"><span class="hljs-number">1</span></span>).unwrap_or(<span class="hljs-number"><span class="hljs-number">0</span></span>);

        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> after = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[index + <span class="hljs-number"><span class="hljs-number">1</span></span>..];
        <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> end = after.find(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>).map(|x| x + index + <span class="hljs-number"><span class="hljs-number">1</span></span>).unwrap_or(len);

        (start, end)
    }
}

<span class="hljs-keyword"><span class="hljs-keyword">impl</span></span> fmt::Display <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Mistake {
    <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fn</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fmt</span></span></span></span>(&amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>, f: &amp;<span class="hljs-keyword"><span class="hljs-keyword">mut</span></span> fmt::Formatter) -&gt; fmt::<span class="hljs-built_in"><span class="hljs-built_in">Result</span></span> {
        <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> &amp;location <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.locations {
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> (start, end) = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.line_bounds(location);
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> line = &amp;<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[start..end];

            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> line_number = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[..start].matches(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>).count() + <span class="hljs-number"><span class="hljs-number">1</span></span>;
            <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> comma_index = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.text[start..location].chars().count();

            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{}:  :\n\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.path)?;

            <span class="hljs-comment"><span class="hljs-comment">//    </span></span>
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{:&gt;8} | {}\n"</span></span>, line_number, line)?;

            <span class="hljs-comment"><span class="hljs-comment">//  </span></span>
            <span class="hljs-built_in"><span class="hljs-built_in">write!</span></span>(f, <span class="hljs-string"><span class="hljs-string">"{}^\n\n"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>.repeat(<span class="hljs-number"><span class="hljs-number">11</span></span> + comma_index))?;
        }
        <span class="hljs-literal"><span class="hljs-literal">Ok</span></span>(())
    }
}</code></pre><br>
<h2 id="zaklyuchenie"></h2><br>
<p>     ,       . </p><br>
<p>            .    ,   Rust.      " Rust   ", ,     ,      .        ,     <em></em>  ,    ,          ,       .</p><br>
<p>(   ,      FFI.)</p></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr470129/">https://habr.com/ru/post/fr470129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr470117/index.html">Se préparer pour combiner</a></li>
<li><a href="../fr470121/index.html">Écoles de programmation d'entreprise ou comment entrer en informatique</a></li>
<li><a href="../fr470123/index.html">Piège financier Yandex.Money</a></li>
<li><a href="../fr470125/index.html">Ne jugez pas strictement le code de quelqu'un d'autre</a></li>
<li><a href="../fr470127/index.html">Compositeur avec une longue mémoire à court terme</a></li>
<li><a href="../fr470133/index.html">Comment collecter des métriques non déformées par référence temporelle avec Prometheus</a></li>
<li><a href="../fr470135/index.html">Une application web interactive sans programmation? C'est facile! Mavo dans tes bras</a></li>
<li><a href="../fr470145/index.html">"Attention, SAF!": Pourquoi le ticket militaire est-il dangereux dans la publicité, pourquoi est-il important de connaître les mathématiques et si la vérité nue est toujours nécessaire</a></li>
<li><a href="../fr470149/index.html">Il n'y aura pas de collections immuables en Java - ni maintenant ni jamais</a></li>
<li><a href="../fr470153/index.html">Dictionnaire du modèle de données</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>