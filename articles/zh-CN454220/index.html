<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐣 🏄 🐎 两位数温度计 🌺 ⬆️ 👚</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="作者用这个两位数的LED温度计作为生日礼物送给朋友的儿子。 他只有两岁，已经在阅读数字，但字母却不在。 现在，他可以自己找出窗外的温度。 温度计中的传感器是根据1-Wire协议运行的DS18B20芯片，而微控制器是ATtiny84类型的。 棋盘是正方形的，侧面为25毫米，大小相当于50便士的硬币。 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>两位数温度计</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454220/"><img src="https://habrastorage.org/webt/i0/jr/au/i0jrauutpm6rrsutydyvv7hxb_c.jpeg"><br><br> 作者用这个两位数的LED温度计作为生日礼物送给朋友的儿子。 他只有两岁，已经在阅读数字，但字母却不在。 现在，他可以自己找出窗外的温度。 温度计中的传感器是根据1-Wire协议运行的DS18B20芯片，而微控制器是ATtiny84类型的。 棋盘是正方形的，侧面为25毫米，大小相当于50便士的硬币。 作者计划将板子放在防水盒中，然后放在窗户外面。 指示灯每24秒短暂亮起一次，CR2032电池可持续使用大约一年。 <a name="habracut"></a><br> 温度计的工作温度范围是-19至+99°C。 如有必要，减号和减号同时以高顺序显示。 超出范围时，将显示字母Lo或Hi。 您可以通过使用带点为负的线段来“教导”设备显示低于-19°C的温度。 <br><br> 根据此方案，该设备先前已组装在面包板上： <br><br><img src="https://habrastorage.org/webt/1u/e7/aj/1ue7aju6otdv_qjhwdjabjxejf8.gif"><br><br> 涉及微控制器的所有输出，使用内置的8 MHz时钟发生器。 原型如下： <br><br><img src="https://habrastorage.org/webt/qf/91/nd/qf91ndinrn_16xfcxellk_lxzuq.jpeg"><br><br> 原型使用TO-92封装的DS18B20，PDIP封装的ATtiny84和3.6英寸的3621AS指示器。 然后作者在Eagle中开发了该板，并在PCBway中订购了它。 这里的微控制器已经在SOIC情况下，传感器在µSOP情况下，电阻，电容器和显示器的尺寸为0805。除显示器外的所有部件均由Youyue 858D +吹风机在250°C的温度下焊接。 <br><br> 原型和印刷电路板都具有带有公共阳极的指示器。 该设备有两种版本，带有红色和黄色指示器。 红色-在KDPV上，黄色-在这里： <br><br><img src="https://habrastorage.org/webt/qc/i9/wv/qci9wvs7mdqulra36wldskfg6sc.jpeg"><br><br> 背面焊接20毫米锂电池的支架（名称以20开头的任何一个，即2016、2025或2032）： <br><br><img src="https://habrastorage.org/webt/3i/ic/kx/3iickx0nahv0rh325lvawiebzdq.jpeg"><br><br> 写入固件后，微控制器大部分时间处于睡眠模式，并在看门狗定时器中断后唤醒。 在实现1-Wire接口时，涉及同一作者的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">工作时间</a> 。 以1 MHz的频率运行的微控制器的16位计时器非常耗时： <br><br><pre><code class="plaintext hljs">void OneWireSetup () { TCCR1A = 0&lt;&lt;WGM10; // Normal mode TCCR1B = 0&lt;&lt;WGM12 | 2&lt;&lt;CS10; // Normal mode, divide clock by 8 }</code> </pre> <br> 基于OCR0A输出比较寄存器，DelayMicros（）子例程提供指定的微秒延迟： <br><br><pre> <code class="plaintext hljs">void DelayMicros (unsigned int micro) { TCNT1 = 0; TIFR1 = 1&lt;&lt;OCF1A; OCR1A = micro; while ((TIFR1 &amp; 1&lt;&lt;OCF1A) == 0); }</code> </pre> <br>  DisplayTemperature（）例程从传感器读取温度值并显示。 由于总线上只有一个传感器，因此您可以忽略序列号，而只给出“跳过ROM”命令，然后将以下所有命令发送到任何设备： <br><br><pre> <code class="plaintext hljs">void DisplayTemperature () { cli(); // No interrupts if (OneWireReset() != 0) { sei(); DisplayError(0); // Device not found } else { OneWireWrite(SkipROM); OneWireWrite(ConvertT); while (OneWireRead() != 0xFF); OneWireReset(); OneWireWrite(SkipROM); OneWireWrite(ReadScratchpad); OneWireReadBytes(9); sei(); // Interrupts if (OneWireCRC(9) == 0) { int temp = DataWords[0]; Display((temp+8)&gt;&gt;4); // Round to nearest degree } else DisplayError(1); // CRC error } }</code> </pre> <br> 响应该请求，传感器以16位有符号整数的形式返回温度值，单位为1/16度。 该数字将四舍五入到最接近的整数度，并通过调用Display（）例程进行显示。 <br><br>  DisplayError（）子例程显示微控制器与1-Wire总线上的传感器交互时的错误： <br><br><pre> <code class="plaintext hljs">void DisplayError (int no) { Buffer[0] = Error; Buffer[1] = no; }</code> </pre> <br>  E0-未检测到传感器，E1-CRC错误。 <br><br> 用于动态指示的数据取自Buffer []数组。 例如，要显示数字20，您必须执行以下操作： <br><br><pre> <code class="plaintext hljs">Buffer[0]=2; Buffer[1]=0;</code> </pre> <br> 计时器计数器0产生频率为125 Hz的中断，足以消除闪烁。 首先，在setup（）中配置计时器 <br><br><pre> <code class="plaintext hljs">TCCR0A = 2&lt;&lt;WGM00; // CTC mode; count up to OCR0A TCCR0B = 0&lt;&lt;WGM02 | 4&lt;&lt;CS00; // Divide by 256 OCR0A = 250-1; // Compare match at 125Hz TIMSK0 = 0; // Interrupts initially off</code> </pre> <br> 比较期间匹配的中断处理例程将调用DisplayNextDigit（）例程，然后以相反的方向进行计数： <br><br><pre> <code class="plaintext hljs">ISR(TIM0_COMPA_vect) { DisplayNextDigit(); Ticks--; }</code> </pre> <br>  DisplayNextDigit（）子例程从Buffer []数组中的相应单元读取数据，并在相应的显示位中包含所需的段。 该程序使用#define在具有公共阴极或阳极的指示器之间进行选择。 如果加电后所有段均立即点亮，则显示类型与固件中指定的类型不匹配。 对于公共阴极，子例程必须替换为以下内容： <br><br><pre> <code class="plaintext hljs">void DisplayNextDigit () { PORTB = PORTB | 1&lt;&lt;digit; // Turn old digit off digit = digit ^ 1; // Toggle between 0 and 1 char segs = charArray[Buffer[digit]]; PORTA = segs; // Lit segments high PORTB = PORTB &amp; ~(1&lt;&lt;digit); // Turn new digit on }</code> </pre> <br> 最后，Display（）例程产生一个两位数以写入Buffer []数组： <br><br><pre> <code class="plaintext hljs">void Display (int n) { int units = n % 10; int tens = n / 10; int temp0 = tens; int temp1 = abs(units); if (tens &lt; -1) {temp0 = Lo; temp1 = Lo+1; } else if (tens &gt; 9) {temp0 = Hi; temp1 = Hi+1; } else if (tens == -1) temp0 = Minus1; else if ((tens == 0) &amp;&amp; (units &gt;= 0)) temp0 = Blank; else if ((tens == 0) &amp;&amp; (units &lt; 0)) temp0 = Minus; Buffer[0] = temp0; Buffer[1] = temp1; }</code> </pre> <br> 它还考虑了将负号与高单位显示一起显示的情况，以及有关温度超出范围的消息。 <br><br> 为了最大程度地节能，禁用了ADC，USI和ADC时钟发生器，并启用了PWR_DOWN睡眠模式： <br><br><pre> <code class="plaintext hljs"> ADCSRA &amp;= ~(1&lt;&lt;ADEN); // Disable ADC to save power PRR = 1&lt;&lt;PRUSI | 1&lt;&lt;PRADC; // Turn off clocks to USI &amp; ADC to save power set_sleep_mode(SLEEP_MODE_PWR_DOWN);</code> </pre> <br> 主程序显示温度达十分之一秒，然后打开睡眠模式。 原来，这是最短的显示时间，方便阅读。 温度显示前两秒钟，该点短暂闪烁： <br><br><pre> <code class="plaintext hljs">void loop () { Buffer[0] = DP; Buffer[1] = Blank; DisplayOn(12); WDDelay(6); // Sleep for 1 second Buffer[0] = Blank; Buffer[1] = DP; DisplayOn(12); WDDelay(6); // Sleep for 1 second DisplayTemperature(); DisplayOn(12); WDDelay(9); // Sleep for 8 seconds WDDelay(9); // Sleep for 16 seconds WDDelay(9); // Sleep for 24 seconds }</code> </pre> <br> 由于三个看门狗呼叫，每个持续8秒，因此显示屏保持关闭状态24秒钟。 指示器运行时，电流消耗为6.6 mA，在睡眠模式下为4.7μA，平均电流消耗为1/240 * 6.6 mA。  CR2032电池的典型容量为225 mAh，因此足以用于（225 / 6.6）x 240/24 = 340天-不到一年。 <br><br> 组件的温度范围如下：微控制器和指示器--40至+ 85°C，电阻器和电容器--55至+125°C，电池--20至+70°C。 扩展温度范围BR2032的元件将在-30至+85°C的温度范围内工作。 <br><br> 该Spence Konde开发使该微控制器与Arduino兼容。 在IDE中，在Board菜单的ATTinyCore部分中选择ATtiny24 / 44/84。 然后，您需要设置以下选项，而不关注其余部分： <br><br><pre> <code class="plaintext hljs">Chip: "ATtiny84" Clock: "8 MHz (internal)" BOD: "BOD Disabled" Pin Mapping: "Clockwise (like damellis core)"</code> </pre> <br> 该程序使用Pomona测试夹上传，并置于微控制器顶部并连接至SparkFun Tiny AVR编程器。 首先，您需要选择Burn Bootloader，然后选择Upload。 <br><br> 链接：该<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">程序的全文</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">董事会和GitHub上的程序</a> ，以及<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">OSHpark</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">上</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">董事会</a> 。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN454220/">https://habr.com/ru/post/zh-CN454220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN454206/index.html">PH第9天：AI CTF解析</a></li>
<li><a href="../zh-CN454208/index.html">从头开始RISC-V</a></li>
<li><a href="../zh-CN454210/index.html">被遗忘的enchantjs +新的1C-Bitrix =激励客户的游戏</a></li>
<li><a href="../zh-CN454214/index.html">我讨厌几乎所有软件</a></li>
<li><a href="../zh-CN454216/index.html">找到的证据表明所有变化都是有序和偶然的混合</a></li>
<li><a href="../zh-CN454222/index.html">使用PCIe 1.0-2.0总线升级旧服务器的磁盘子系统</a></li>
<li><a href="../zh-CN454224/index.html">Okko的建议：如何通过乘以两个矩阵来赚取数亿美元</a></li>
<li><a href="../zh-CN454226/index.html">圆柱磁域上的内存。 第1部分。工作原理</a></li>
<li><a href="../zh-CN454232/index.html">图形化编程语言中的OOP。 第2部分MOS和OOP</a></li>
<li><a href="../zh-CN454240/index.html">小波分析。 第三部分</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>