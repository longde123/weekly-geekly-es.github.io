<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë©‚Äçüëß üèáüèø üïå Ombres r√©alistes pour roguelike ü•ä üíÜüèæ üë®‚Äçüîß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bon moment, communaut√© Habr. 

 Il y a plusieurs ann√©es, je suis tomb√© sur un post (1) . Ensuite, j'ai √©t√© intrigu√© par l'opportunit√© de cr√©er des √©l√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ombres r√©alistes pour roguelike</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430438/"><img src="https://habrastorage.org/webt/it/n0/_j/itn0_jvk5dkjqc4db9ipac5f5fs.png" alt="image"><br><br>  Bon moment, communaut√© Habr. <br><br>  Il y a plusieurs ann√©es, je suis tomb√© sur un post <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(1)</a> .  Ensuite, j'ai √©t√© intrigu√© par l'opportunit√© de cr√©er des √©l√©ments int√©ressants pour le gameplay dans roguelike <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(2)</a> .  Supposons que l'ennemi puisse √™tre derri√®re le mur, nous ne le voyons pas tant que nous ne le rencontrons pas en ligne de mire.  Mais je pr√©f√®re la situation o√π nous, voyageant le long des couloirs du donjon, r√©v√©lons progressivement les caract√©ristiques de la localisation des objets en fonction de la port√©e. <br><a name="habracut"></a><br>  Plus tard dans les articles: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(3)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(4)</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(5)</a> , les questions de la projection d'ombres dans les jeux 2D ont √©t√© examin√©es.  Comme l'ont not√© les auteurs eux-m√™mes et dans les commentaires, le calcul des ombres est assez volumineux et n'est pas une t√¢che facile, √† la fois pour la calculatrice et pour la conception. <br><br>  D'une mani√®re ou d'une autre, j'ai eu quelques jours libres et j'ai d√©cid√© de revenir sur la question des ombres plus prometteuses.  Il est clair que la carte vid√©o g√®re les ombres avec succ√®s et rapidement, mais dans ce cas, je voulais traiter les ombres pour un jeu 2D, et il semblait superflu de transf√©rer les calculs sur la carte vid√©o.  Oui, et la puissance du processeur ces derni√®res ann√©es dans son ensemble a augment√©, en fait un article sur ce qui s'est finalement pass√©. <br><br>  Le programme a √©t√© √©crit en Pascal, simplement parce que je le connais bien, et Lazarus est un IDE ouvert avec une large gamme de composants. <br><br>  L'id√©e originale √©tait de tracer des lignes, de l'observateur √† travers chacun des coins de la tuile, puis d'assombrir la figure r√©sultante. <br><br><img src="https://habrastorage.org/webt/1l/gv/wz/1lgvwzunexn88op34oew0fiwfgg.png" alt="image"><br><br>  Cependant, une telle ombre semble quelque peu artificielle lorsque l'angle de vue change.  Les ombres sont maintenant plus larges, maintenant plus √©troites. <br><br><img src="https://habrastorage.org/webt/b8/h0/fo/b8h0fobism0heacye71gua3xv_0.png" alt="image"><br><br>  L'ombre d'un objet rond est bien meilleure.  Pour construire une telle ombre, vous devez dessiner deux tangentes du point d'observation au cercle et aux bordures de l'√©cran.  Le diam√®tre du cercle correspondra √† la taille de la tuile. <br><br>  Dans mon programme, j'ai utilis√© la fonction suivante: <br><br><pre><code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//       function tangent_to_circle(x1,y1,x2,y2,r:Single; var x3,y3,x4,y4:Single):Boolean; var l,dx,dy,i,ii,ij:Single; begin dx := x1 - x2; dy := y1 - y2; l := Sqrt(dx*dx + dy*dy); if l&lt;=r then begin tangent_to_circle:=false; exit; end; i := r/l; ii := i*i; ij := i * Sqrt(1 - ii); x3 := x2 + dx*ii - dy*ij; y3 := y2 + dx*ij + dy*ii; x4 := x2 + dx*ii + dy*ij; y4 := y2 - dx*ij + dy*ii; tangent_to_circle:=true; end;</span></span></code> </pre> <br>  O√π (x1, y1) est le point d'observation, (x2, y2) est le centre du cercle, ¬Æ est son rayon, et (x3, y3) et (x4, y4) sont les points d'intersection des lignes et du cercle.  La fonction ne renvoie true que lorsque l'observateur est en dehors du cercle. <br><br>  Comme le processeur n'est pas tr√®s amical avec la trigonom√©trie, j'ai essay√© de l'utiliser au minimum.  S'appuyant en fait sur une r√®gle simple (mod√®le approximatif), les experts vous expliqueront pourquoi. <br><br>  <b>(Mauvais) SIN, COS ..&gt; '/', SQRT&gt; 'DIV', 'MOD'&gt; 'SHR', 'SHL'&gt; '*'&gt; ': =', '+', '-', 'AND ',' XOR '.. (Bon)</b> <br><br>  C‚Äôest un plaisir d‚Äôimpl√©menter la partie graphique des primitives sur la toile, il existe de nombreuses biblioth√®ques et moteurs qui facilitent le travail.  Lors du d√©veloppement sur Delphi, j'ai d√ª utiliser la biblioth√®que Agg2D, sur Lazarus il y a son port <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(6)</a> , et sur celui-ci j'ai d√©cid√© de r√©aliser l'id√©e.  En fait, le gain de la biblioth√®que est qu'un canal alpha est ajout√© aux couleurs RVB, et les primitives sont liss√©es, et en raison de l'acc√®s direct aux pixels et √† diverses astuces, le traitement est beaucoup plus rapide que le canevas. <br><br>  Lors du dessin de l'ombre de la tuile, j'allais √† l'origine remplir le secteur avec de l'ombre, mais l'image √† l'int√©rieur de la tuile √©tait √† peine reconnaissable (le secteur en question sur la figure 3. est rempli de vert).  Apr√®s avoir exp√©riment√© diff√©rentes options, je me suis arr√™t√© √† s√©lectionner un secteur dans la zone d'ombre. <br><br>  Pour dessiner le secteur, nous avons besoin d'un angle en radians, mais la trigonom√©trie ne pouvait toujours pas le faire.  (arctan2 - fonction de biblioth√®que du module math√©matique) <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//     function alpha_angle(x1,y1,x2,y2:Single):Single; begin alpha_angle := arctan2(y1 - y2, x1 - x2); end;</span></span></code> </pre><br>  En fait, tout est pr√™t pour l'assemblage d'images.  Nous prenons une carte de tuiles et sur une couche distincte, nous appliquons s√©quentiellement les ombres, une par une.  Pour les arbres, les ombres sont plus sombres, pour les autres objets, les ombres sont plus transparentes. <br><br><img src="https://habrastorage.org/webt/uc/wx/uc/ucwxucbzum2mqeexhvhx1nfoz74.png" alt="image"><br><br>  L'image finie est appliqu√©e sur la couche principale de carreaux.  Un peu de design d'arri√®re-plan et choisissez des ensembles de tuiles plus g√©n√©riques.  En fait, il m'a fallu deux jours pour rechercher des tuiles appropri√©es, celles qui sont dans le domaine public ou de tr√®s mauvaise qualit√© ou co√ªtent cher.  En cons√©quence, il a lui-m√™me dessin√© les arbres et emprunt√© d'autres √©l√©ments √† l'utilisateur Joe Williamson <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">(7)</a> (excellent style). <br><br><img src="https://habrastorage.org/webt/fi/np/nz/finpnzmqhc_jx9qhwgubnx8x9sa.png" alt="image"><br><br>  Ce serait fini, mais il y avait du s√©diment dans la performance.  Avec le nombre d'objets, environ cinq cents rabattements commencent.  Diverses m√©thodes d'optimisation ont √©t√© envisag√©es, et en se divisant en noyaux et en restreignant la zone de dessin √† un certain rayon, en changeant la forme de l'ombre (√† moins cher que les arcs), j'ai m√™me pens√© √† transf√©rer le calcul en vid√©o. <br><br>  En cons√©quence, je suis arriv√© √† la conclusion que la meilleure option serait de r√©duire l'√©chantillonnage de l'image servant de masque d'ombre.  Car le nombre de calculs est consid√©rablement r√©duit, ainsi que l'effet inattendu de pixellisation des contours d'ombres, ce qui donne un certain charme old-school. <br><br><img src="https://habrastorage.org/webt/ue/uv/rl/ueuvrlwsgp9zfa82re0upf8s-dm.png" alt="image"><br><br>  J'ai tellement aim√© l'effet que j'ai d√ª faire de la mise √† l'√©chelle un processus dynamique, √† travers un param√®tre de multiplicit√© donn√©. <br><br><img src="https://habrastorage.org/webt/dr/nz/nj/drnznjjm9iqbsxstlso17uh8kuo.png" alt="image"><br><br>  Il ne restait plus qu'√† cr√©er des murs opaques et √† pr√©senter le r√©sultat √† la communaut√©. <br><br><img src="https://habrastorage.org/webt/61/ai/wf/61aiwfqtgba4k2cyvmgc1atua5k.png" alt="image"><br><br>  J'attends avec impatience de nouveaux jeux utilisant cet effet ou son d√©veloppement. <br>  Je vous remercie! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">D√©mo</a> o√π vous pouvez toucher les poign√©es (exe pour les fen√™tres). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Partie 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">partie 3</a> <br><br><div class="spoiler">  <b class="spoiler_title">R√©f√©rences:</b> <div class="spoiler_text">  1) habr.com/post/16927/ <br>  2) en.wikipedia.org/wiki/Roguelike <br>  3) habr.com/post/204782/ <br>  4) habr.com/post/305252/ <br>  5) habr.com/post/319530/ <br>  6) wiki.freepascal.org/BGRABitmap <br>  7) twitter.com/joecreates <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr430438/">https://habr.com/ru/post/fr430438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr430428/index.html">Le site "Escher II" dans la nomination "Projet Internet du Peuple" Prix Runet 2018</a></li>
<li><a href="../fr430430/index.html">Fullstack - pourquoi est-ce cool ou comment profiter du travail</a></li>
<li><a href="../fr430432/index.html">La fen√™tre modale que vous attendiez. Ou comment appeler une fen√™tre contextuelle √† partir de diff√©rents boutons sur JS pur</a></li>
<li><a href="../fr430434/index.html">Lancement de la visionneuse d'images √† partir de Windows XP sur Windows moderne</a></li>
<li><a href="../fr430436/index.html">Vers QUIC: ce qui sous-tend HTTP / 3</a></li>
<li><a href="../fr430446/index.html">Encore une fois sur les avantages de "l'esclavage mobile"</a></li>
<li><a href="../fr430448/index.html">Ce qui donne l'apprentissage automatique au d√©tail: un exemple de projet</a></li>
<li><a href="../fr430450/index.html">Mod√®le de d√©veloppement utilisant un processeur bas√© sur la pile comme exemple</a></li>
<li><a href="../fr430452/index.html">Feu, eau et fine pulv√©risation. Comment les r√©sidents et les visiteurs du centre de Lakhta seront prot√©g√©s contre les incendies</a></li>
<li><a href="../fr430454/index.html">Je suis entour√© d'idiots ou comment travailler en √©quipe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>