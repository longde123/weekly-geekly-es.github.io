<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèΩ‚Äçü§ù‚Äçüë®üèø üêò üëåüèº Prise en charge de la file d'attente Hangfire üë®‚Äç‚úàÔ∏è ü§ûüèø üë©üèæ‚Äçü§ù‚Äçüë©üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hangfire est une biblioth√®que pour .net (core), qui permet l'ex√©cution asynchrone de certains codes sur le principe du "feu et oublie". Un exemple d'u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Prise en charge de la file d'attente Hangfire</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434364/"><p>  Hangfire est une biblioth√®que pour .net (core), qui permet l'ex√©cution asynchrone de certains codes sur le principe du "feu et oublie".  Un exemple d'un tel code peut √™tre l'envoi d'e-mails, le traitement vid√©o, la synchronisation avec un autre syst√®me, etc.  En plus de "tirer et oublier", il existe un support pour les t√¢ches diff√©r√©es, ainsi que les t√¢ches planifi√©es au format Cron. </p><br><p>  Actuellement, il existe de nombreuses biblioth√®ques de ce type.  Voici quelques-uns des avantages de Hangfire: </p><br><ul><li>  Configuration simple, API pratique </li><li>  Fiabilit√©  Hangfire garantit que la t√¢che cr√©√©e sera ex√©cut√©e au moins une fois </li><li>  Capacit√© √† effectuer des t√¢ches en parall√®le et d'excellentes performances </li><li>  Extensibilit√© (ici, nous allons l'utiliser ci-dessous) </li><li>  Documentation assez compl√®te et compr√©hensible </li><li>  Tableau de bord sur lequel vous pouvez voir toutes les statistiques sur les t√¢ches </li></ul><br><p>  Je n'entrerai pas dans trop de d√©tails, car il existe de nombreux bons articles sur Hangfire et comment l'utiliser.  Dans cet article, je vais expliquer comment utiliser la prise en charge de plusieurs files d'attente (ou pools de t√¢ches), comment corriger la fonctionnalit√© de nouvelle tentative standard et faire en sorte que chaque file d'attente ait une configuration individuelle. </p><a name="habracut"></a><br><h3 id="suschestvuyuschaya-podderzhka-psevdo-ocheredey">  Prise en charge existante des (pseudo) files d'attente </h3><br><p>  Remarque importante: dans le titre, j'ai utilis√© le terme pseudo-file d'attente car Hangfire ne garantit pas que les t√¢ches seront ex√©cut√©es dans un ordre sp√©cifique.  C'est-√†-dire  le principe du ¬´premier entr√©, premier sorti¬ª ne s'applique pas et nous ne nous y fierons pas.  De plus, l'auteur de la biblioth√®que recommande de rendre les t√¢ches idempotentes, c'est-√†-dire  stable contre l'ex√©cution multiple impr√©vue.  De plus, je n'utiliserai que le mot "queue", car  Hangfire utilise le terme "file d'attente". </p><br><p>  Hangfire a un support simple de file d'attente.  Bien qu'il n'offre pas la flexibilit√© des syst√®mes Message Queue tels que rabbitMQ ou Azure Service Bus, il est souvent suffisant pour r√©soudre un large √©ventail de t√¢ches. </p><br><p>  Chaque t√¢che a la propri√©t√© "Queue", c'est-√†-dire le nom de la file d'attente dans laquelle elle doit √™tre ex√©cut√©e.  Par d√©faut, la t√¢che est envoy√©e √† la file d'attente avec le nom "default", sauf indication contraire.  La prise en charge de plusieurs files d'attente est n√©cessaire afin de g√©rer s√©par√©ment l'ex√©cution de t√¢ches de diff√©rents types.  Par exemple, nous pouvons souhaiter que les t√¢ches de traitement vid√©o tombent dans la file d'attente "video_queue" et envoient des e-mails √† la file d'attente "email_queue".  Ainsi, nous sommes en mesure d'effectuer ind√©pendamment ces deux types de t√¢ches.  Si nous voulons d√©placer le traitement vid√©o vers un serveur d√©di√©, nous pouvons facilement le faire en ex√©cutant un serveur Hangfire s√©par√© en tant qu'application console qui traitera la file d'attente "video_queue". </p><br><h3 id="pereydem-k-praktike">  Passons √† la pratique </h3><br><p>  La configuration du serveur Hangfire dans le noyau asp.net est la suivante: </p><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IApplicationBuilder app</span></span></span><span class="hljs-function">)</span></span> { app.UseHangfireServer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BackgroundJobServerOptions { WorkerCount = <span class="hljs-number"><span class="hljs-number">2</span></span>, Queues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-string"><span class="hljs-string">"email_queue"</span></span>, <span class="hljs-string"><span class="hljs-string">"video_queue"</span></span> } }); }</code> </pre> <br><h3 id="problema-1---zadachi-pri-povtore-popadayut-v-ochered-default">  Probl√®me 1 - Les t√¢ches de relecture tombent dans la file d'attente par d√©faut </h3><br><p>  Comme je l'ai mentionn√© ci-dessus, il y a une file d'attente par d√©faut dans Hangfire appel√©e "par d√©faut".  Si une t√¢che plac√©e dans la file d'attente, par exemple, "video_queue", a √©chou√© et doit √™tre r√©essay√©e, elle sera √† nouveau envoy√©e dans la file d'attente "par d√©faut" et non "video_queue" et, par cons√©quent, notre t√¢che ne sera pas ex√©cut√©e du tout l'instance du serveur Hangfire que nous aimerions, le cas √©ch√©ant.  Ce comportement a √©t√© √©tabli par moi exp√©rimentalement et est probablement un bogue dans Hangfire lui-m√™me. </p><br><h4 id="job-filters">  Filtres de travail </h4><br><p>  Hangfire nous offre la possibilit√© d'√©tendre la fonctionnalit√© √† l'aide de filtres dits ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">filtres de travaux</a> ), qui sont similaires en principe aux filtres d'actions dans ASP.NET MVC.  Le fait est que la logique interne de Hangfire est impl√©ment√©e comme une machine d'√©tat.  Il s'agit d'un moteur qui transf√®re s√©quentiellement les t√¢ches du pool d'un √©tat √† un autre (par exemple, cr√©√© -&gt; mis en file d'attente -&gt; traitement -&gt; r√©ussi), et les filtres nous permettent "d'intercepter" la t√¢che qui est ex√©cut√©e √† chaque fois que son √©tat change et de la manipuler.  Un filtre est impl√©ment√© en tant qu'attribut qui peut √™tre appliqu√© √† une seule m√©thode, classe ou globalement. </p><br><h4 id="job-parameters">  Param√®tres du travail </h4><br><p>  L'objet ElectStateContext est transmis en tant qu'argument √† la m√©thode de filtrage.  Cet objet contient des informations compl√®tes sur la t√¢che en cours.  Entre autres choses, il a les m√©thodes GetJobParameter &lt;&gt; (...) et SettJobParameter &lt;&gt; (...).  Les param√®tres de travail vous permettent d'enregistrer des informations relatives √† une t√¢che dans une base de donn√©es.  C'est dans les param√®tres du travail que le nom de la file d'attente √† laquelle la t√¢che a √©t√© envoy√©e √† l'origine est stock√©, mais pour une raison quelconque, ces informations sont ignor√©es lors d'une r√©p√©tition ult√©rieure. </p><br><h3 id="reshenie">  Solution </h3><br><p>  Nous avons donc une t√¢che qui s'est termin√©e par erreur et doit √™tre envoy√©e pour √™tre r√©ex√©cut√©e dans la file d'attente de droite (dans la m√™me qui lui a √©t√© affect√©e au moment de la cr√©ation initiale).  La r√©p√©tition d'une t√¢che qui s'est termin√©e avec une erreur est une transition de l'√©tat "√©chou√©" √† l'√©tat "mis en file d'attente".  Pour r√©soudre le probl√®me, cr√©ez un filtre qui, lorsque la t√¢che entrera dans l'√©tat "en file d'attente", v√©rifiera dans quelle file d'attente la t√¢che a √©t√© envoy√©e initialement et mettra le param√®tre "QueueName" dans la valeur souhait√©e: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HangfireUseCorrectQueueFilter</span></span> : <span class="hljs-title"><span class="hljs-title">JobFilterAttribute</span></span>, <span class="hljs-title"><span class="hljs-title">IElectStateFilter</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStateElection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ElectStateContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.CandidateState <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> EnqueuedState enqueuedState) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> queueName = context.GetJobParameter&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"QueueName"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(queueName)) { context.SetJobParameter(<span class="hljs-string"><span class="hljs-string">"QueueName"</span></span>, enqueuedState.Queue); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { enqueuedState.Queue = queueName; } } } }</code> </pre> <br><p>  Afin d'appliquer le filtre par d√©faut √† toutes les t√¢ches (c'est-√†-dire globalement), ajoutez le code suivant √† notre configuration: </p><br><pre> <code class="cs hljs">GlobalJobFilters.Filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireUseCorrectQueueFilter { Order = <span class="hljs-number"><span class="hljs-number">1</span></span> });</code> </pre> <br><p>  Un autre petit inconv√©nient est que la collection GlobalJobFilters contient par d√©faut une instance de la classe AutomaticRetryAttribute.  Il s'agit d'un filtre standard charg√© de r√©ex√©cuter les t√¢ches ayant √©chou√©.  Il envoie √©galement la t√¢che √† la file d'attente "par d√©faut", ignorant la file d'attente d'origine.  Pour que notre v√©lo roule, vous devez retirer ce filtre de la collection et laisser notre filtre prendre la responsabilit√© des t√¢ches r√©p√©t√©es.  Par cons√©quent, le code de configuration ressemblera √† ceci: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> defaultRetryFilter = GlobalJobFilters.Filters .FirstOrDefault(f =&gt; f.Instance <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> AutomaticRetryAttribute); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (defaultRetryFilter != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; defaultRetryFilter.Instance != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { GlobalJobFilters.Filters.Remove(defaultRetryFilter.Instance); } GlobalJobFilters.Filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireUseCorrectQueueFilter { Order = <span class="hljs-number"><span class="hljs-number">1</span></span> });</code> </pre> <br><p>  Il convient de noter que AutomaticRetryAttribute impl√©mente la logique d'augmenter automatiquement l'intervalle entre les tentatives (l'intervalle augmente √† chaque tentative suivante), et en supprimant AutomaticRetryAttribute de la collection GlobalJobFilters, nous abandonnons cette fonctionnalit√© (voir la mise en ≈ìuvre de la m√©thode <a href="">ScheduleAgainLater</a> ) </p><br><p>  Ainsi, nous avons r√©alis√© que nos t√¢ches peuvent √™tre effectu√©es dans diff√©rentes files d'attente, ce qui nous permet de g√©rer ind√©pendamment leur ex√©cution, y compris le traitement de diff√©rentes files d'attente sur diff√©rentes machines.  Seulement maintenant, nous ne savons pas combien de fois et √† quel intervalle nos t√¢ches seront r√©p√©t√©es en cas d'erreur, car nous avons supprim√© AutomaticRetryAttribute de la collection de filtres. </p><br><h3 id="problema-2---individualnye-nastroyki-dlya-kazhdoy-ocheredi">  Probl√®me 2 - Param√®tres individuels pour chaque file d'attente </h3><br><p>  Nous voulons pouvoir configurer l'intervalle et le nombre de r√©p√©titions s√©par√©ment pour chaque file d'attente, et aussi, si pour une file d'attente nous n'avons pas sp√©cifi√© de valeurs explicitement, nous voulons que les valeurs par d√©faut soient appliqu√©es.  Pour ce faire, nous impl√©mentons un autre filtre et l'appelons <code>HangfireRetryJobFilter</code> . </p><br><p>  Id√©alement, le code de configuration devrait ressembler √† ceci: </p><br><pre> <code class="cs hljs">GlobalJobFilters.Filters.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireRetryJobFilter { Order = <span class="hljs-number"><span class="hljs-number">2</span></span>, [<span class="hljs-string"><span class="hljs-string">"email_queue"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireQueueSettings { DelayInSeconds = <span class="hljs-number"><span class="hljs-number">120</span></span>, RetryAttempts = <span class="hljs-number"><span class="hljs-number">3</span></span> }, [<span class="hljs-string"><span class="hljs-string">"video_queue"</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireQueueSettings { DelayInSeconds = <span class="hljs-number"><span class="hljs-number">60</span></span>, RetryAttempts = <span class="hljs-number"><span class="hljs-number">5</span></span> } });</code> </pre> <br><h3 id="reshenie-1">  Solution </h3><br><p>  Pour ce faire, ajoutez d'abord la classe <code>HangfireQueueSettings</code> , qui servira de conteneur pour nos param√®tres. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HangfireQueueSettings</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> RetryAttempts { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DelayInSeconds { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br><p>  Ensuite, nous ajoutons l'impl√©mentation du filtre lui-m√™me qui, lorsque les t√¢ches sont r√©p√©t√©es apr√®s une erreur, appliquera les param√®tres en fonction de la configuration de la file d'attente et surveillera le nombre de tentatives: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HangfireRetryJobFilter</span></span> : <span class="hljs-title"><span class="hljs-title">JobFilterAttribute</span></span>, <span class="hljs-title"><span class="hljs-title">IElectStateFilter</span></span>, <span class="hljs-title"><span class="hljs-title">IApplyStateFilter</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> HangfireQueueSettings _defaultQueueSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HangfireQueueSettings { RetryAttempts = <span class="hljs-number"><span class="hljs-number">3</span></span>, DelayInSeconds = <span class="hljs-number"><span class="hljs-number">10</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IDictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, HangfireQueueSettings&gt; _settings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, HangfireQueueSettings&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HangfireQueueSettings <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> queueName] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _settings.TryGetValue(queueName, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> HangfireQueueSettings queueSettings) ? queueSettings : _defaultQueueSettings; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { _settings[queueName] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnStateElection</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ElectStateContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!(context.CandidateState <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> FailedState failedState)) { <span class="hljs-comment"><span class="hljs-comment">// This filter accepts only failed job state. return; } var retryAttempt = context.GetJobParameter&lt;int&gt;("RetryCount") + 1; var queueName = context.GetJobParameter&lt;string&gt;("QueueName"); if (retryAttempt &lt;= this[queueName].RetryAttempts) { ScheduleAgainLater(context, retryAttempt, failedState, queueName); } else { TransitionToDeleted(context, failedState, queueName); } } public void OnStateApplied( ApplyStateContext context, IWriteOnlyTransaction transaction) { if (context.NewState is ScheduledState &amp;&amp; context.NewState.Reason != null &amp;&amp; context.NewState.Reason.StartsWith("Retry attempt")) { transaction.AddToSet("retries", context.BackgroundJob.Id); } } public void OnStateUnapplied( ApplyStateContext context, IWriteOnlyTransaction transaction) { if (context.OldStateName == ScheduledState.StateName) { transaction.RemoveFromSet("retries", context.BackgroundJob.Id); } } private void ScheduleAgainLater( ElectStateContext context, int retryAttempt, FailedState failedState, string queueName) { context.SetJobParameter("RetryCount", retryAttempt); var delay = TimeSpan.FromSeconds(this[queueName].DelayInSeconds); const int maxMessageLength = 50; var exceptionMessage = failedState.Exception.Message.Length &gt; maxMessageLength ? failedState.Exception.Message.Substring(0, maxMessageLength - 1) + "‚Ä¶" : failedState.Exception.Message; // If attempt number is less than max attempts, we should // schedule the job to run again later. var reason = $"Retry attempt {retryAttempt} of {this[queueName].RetryAttempts}: {exceptionMessage}"; context.CandidateState = delay == TimeSpan.Zero ? (IState)new EnqueuedState { Reason = reason } : new ScheduledState(delay) { Reason = reason }; } private void TransitionToDeleted( ElectStateContext context, FailedState failedState, string queueName) { context.CandidateState = new DeletedState { Reason = this[queueName].RetryAttempts &gt; 0 ? "Exceeded the maximum number of retry attempts." : "Retries were disabled for this job." }; } }</span></span></code> </pre> <br><blockquote>  Remarque sur le code: lors de l'impl√©mentation de la classe <code>HangfireRetryJobFilter</code> , la classe <code>AutomaticRetryAttribute</code> de <code>HangfireRetryJobFilter</code> √©t√© prise comme base, par cons√©quent, l'impl√©mentation de certaines m√©thodes co√Øncide partiellement avec les m√©thodes correspondantes de cette classe. </blockquote><br><h3 id="problema-3---kak-otpravit-zadachu-na-vypolnenie-v-konkretnuyu-ochered">  Probl√®me 3 - Comment envoyer une t√¢che √† une file d'attente sp√©cifique? </h3><br><p>  J'ai r√©ussi √† trouver deux fa√ßons d'affecter la t√¢che √† la file d'attente: document√©e et - non. </p><br><p>  <strong>1√®re m√©thode</strong> - accrochez l'attribut correspondant √† la m√©thode </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Queue(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"video_queue"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } BackgroundJob.Enqueue(() =&gt; SomeMethod());</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://docs.hangfire.io/en/latest/background-processing/configuring-queues.html</a> </p><br><p>  <strong>2√®me m√©thode</strong> (non document√©e) - utilisez la classe <code>BackgroundJobClient</code> </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BackgroundJobClient(); client.Create(() =&gt; MyMethod(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EnqueuedState(<span class="hljs-string"><span class="hljs-string">"video_queue"</span></span>));</code> </pre> <br><p>  L'avantage de la deuxi√®me m√©thode est qu'elle ne cr√©e pas de d√©pendances inutiles sur Hangfire et vous permet de d√©cider pendant quel processus la t√¢che doit aller.  Malheureusement, dans la documentation officielle, je n'ai trouv√© aucune mention de la classe <code>BackgroundJobClient</code> et comment l'appliquer.  J'ai utilis√© la deuxi√®me m√©thode dans ma solution, elle est donc test√©e en pratique. </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  Dans cet article, nous avons utilis√© la prise en charge de plusieurs files d'attente dans Hangfire pour s√©parer le traitement de diff√©rents types de t√¢ches.  Nous avons impl√©ment√© notre m√©canisme pour r√©p√©ter les t√¢ches termin√©es sans succ√®s avec la possibilit√© d'une configuration individuelle pour chaque file d'attente, √©largissant les fonctionnalit√©s de Hangfire √† l'aide des filtres de travaux, et avons √©galement appris comment envoyer des t√¢ches pour ex√©cution √† la file d'attente souhait√©e. </p><br><p>  J'esp√®re que cet article sera utile √† quelqu'un.  Je me ferai un plaisir de commenter. </p><br><h3 id="poleznye-ssylki">  Liens utiles </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Documentation Hangfire</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Code source de Hangfire</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Scott Hanselman - Comment ex√©cuter des t√¢ches d'arri√®re-plan dans ASP.NET</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr434364/">https://habr.com/ru/post/fr434364/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr434354/index.html">Cr√©ation d'un mod√®le de reconnaissance faciale √† l'aide du deep learning en Python</a></li>
<li><a href="../fr434356/index.html">Python Stiller avec e-mail</a></li>
<li><a href="../fr434358/index.html">Substitution d'importation de syst√®mes d'exploitation. Comment puis-je voir le syst√®me d'exploitation national</a></li>
<li><a href="../fr434360/index.html">Discussion expliqu√©e sur la programmation asynchrone en Javascript</a></li>
<li><a href="../fr434362/index.html">PAS pr√©vu pour 2019</a></li>
<li><a href="../fr434368/index.html">Apprentissage automatique pour trouver des erreurs dans le code: comment j'ai effectu√© un stage chez JetBrains Research</a></li>
<li><a href="../fr434370/index.html">Un autre conqu√©rant de l'ombre √† Phaser, ou l'utilisation de v√©los</a></li>
<li><a href="../fr434374/index.html">V√©rification de RBAC dans Kubernetes</a></li>
<li><a href="../fr434380/index.html">Bases de l'injection de d√©pendance</a></li>
<li><a href="../fr434382/index.html">Portage d'Alpine Linux vers RISC-V</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>