<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•£ üÜó ‚è∏Ô∏è C√≥mo ahorrar dinero en un terapeuta usando el desarrollo basado en pruebas ‚ôíÔ∏è üëø ü•¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øAlguna vez has tenido esta condici√≥n? 


 Quiero mostrarle c√≥mo TDD puede mejorar la calidad del c√≥digo utilizando un ejemplo espec√≠fico. 
 Porque to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo ahorrar dinero en un terapeuta usando el desarrollo basado en pruebas</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/leroy_merlin/blog/456662/">  ¬øAlguna vez has tenido esta condici√≥n? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/bl/td/so/bltdsone5ewlnnqa_aamnii9rl8.jpeg" alt="imagen"></div><br>  Quiero mostrarle c√≥mo TDD puede mejorar la calidad del c√≥digo utilizando un ejemplo espec√≠fico. <br>  Porque todo lo que conoc√≠ mientras estudiaba el tema fue bastante te√≥rico. <br>  Dio la casualidad de que escrib√≠ dos aplicaciones casi id√©nticas: una escrita en el estilo cl√°sico, ya que no conoc√≠a TDD en ese momento, y la segunda, solo usando TDD. <br><br>  A continuaci√≥n, mostrar√© d√≥nde estaban las mayores diferencias. <br><br>  Personalmente, esto era importante para m√≠, porque cada vez que alguien encontraba un error en mi c√≥digo, me pon√≠a un fuerte inconveniente por la autoestima.  S√≠, entend√≠ que los errores son normales, todos los escriben, pero el sentimiento de inferioridad no desapareci√≥.  Adem√°s, en el proceso de evoluci√≥n del servicio, a veces me di cuenta de que yo mismo escrib√≠ uno que me picaba las manos para tirar todo y volver a escribirlo.  Y c√≥mo sucedi√≥ es incomprensible.  De alguna manera, todo estaba bien al principio, pero despu√©s de un par de caracter√≠sticas y despu√©s de un tiempo no se puede mirar la arquitectura sin l√°grimas.  Aunque parece que cada paso del cambio fue l√≥gico.  La sensaci√≥n de que no me gustaba el producto de mi propio trabajo fluy√≥ suavemente en la sensaci√≥n de que el programador era m√≠o, lo siento, como una bala de mierda. <br><br>  Result√≥ que no soy el √∫nico y muchos de mis colegas tienen sensaciones similares.  Y luego decid√≠ que aprender√≠a a escribir normalmente o que era hora de cambiar de profesi√≥n.  Intent√© el desarrollo basado en pruebas en un intento de cambiar algo en mi enfoque de programaci√≥n. <br><br>  Mirando hacia el futuro, seg√∫n los resultados de varios proyectos, puedo decir que TDD proporciona una arquitectura m√°s limpia, pero ralentiza el desarrollo.  Y no siempre es adecuado y no para todos. <br><a name="habracut"></a><br><h1>  ¬øQu√© es TDD nuevamente? </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f39/01c/4ed/f3901c4ed2fee96d90b1a40fc30e9270.jpg" alt="imagen"></div><br><br>  TDD: desarrollo a trav√©s de pruebas.  Art√≠culo de Wiki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br>  El enfoque cl√°sico es primero escribir una aplicaci√≥n, luego cubrirla con pruebas. <br><br>  Enfoque TDD: primero escribimos pruebas para la clase, luego la implementaci√≥n.  Nos movemos a trav√©s de los niveles de abstracci√≥n, desde el m√°s alto hasta el aplicado, al mismo tiempo dividiendo la aplicaci√≥n en capas-clases a partir de las cuales <b>ordenamos</b> el comportamiento que necesitamos, al estar libres de una implementaci√≥n espec√≠fica. <br><br>  Y si tuviera que leer esto por primera vez, tampoco entender√≠a nada. <br>  Demasiadas palabras abstractas: veamos un ejemplo. <br>  Escribiremos una aplicaci√≥n de primavera real en Java, la escribiremos en TDD, e intentar√© mostrar mi proceso de pensamiento durante el proceso de desarrollo y al final sacar conclusiones si tiene sentido pasar tiempo en TDD o no. <br><br><h1>  Tarea pr√°ctica </h1><br>  Supongamos que somos tan afortunados de tener los t√©rminos de referencia de lo que necesitamos desarrollar.  Por lo general, los analistas no se molestan con eso, y se ve m√°s o menos as√≠: <br><br>  <i>Es necesario desarrollar un microservicio que calcule la posibilidad de vender productos con entrega posterior al cliente en el hogar.</i>  <i>La informaci√≥n sobre esta funci√≥n debe enviarse a un sistema de DATOS de terceros.</i> <br><br>  La l√≥gica de negocios es la siguiente: un art√≠culo est√° disponible para la venta con entrega si: <br><br><ul><li>  El producto esta en stock </li><li>  El contratista (por ejemplo, la empresa DostavchenKO) tiene la oportunidad de llevarlo al cliente. </li><li>  Color del producto: no azul (no nos gusta el azul) </li></ul><br>  Nuestro microservicio ser√° notificado de un cambio en la cantidad de productos en el estante de la tienda a trav√©s de una solicitud http. <br><br>  Esta notificaci√≥n es un disparador para calcular la disponibilidad. <br><br>  Adem√°s, para que la vida no parezca miel: <br><br><ul><li>  El usuario deber√≠a poder desactivar manualmente ciertos productos. </li><li>  Para no enviar spam a los DATOS, solo necesita enviar datos de disponibilidad para aquellos productos que han cambiado. </li></ul><br>  Le√≠mos un par de veces TK, y nos vamos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/10/xa/vc/10xavc46--r-thnqp--lbfzw4co.png"></div><br><br><h1>  Prueba de integraci√≥n </h1><br>  En TDD, una de las preguntas m√°s importantes que tiene que hacer a todo lo que escribe es: "¬øQu√© quiero de ...?" <br><br>  Y la primera pregunta que hacemos es solo para toda la aplicaci√≥n. <br>  Entonces la pregunta es: <br><br>  <i>¬øQu√© quiero de mi microservicio?</i> <br><br>  La respuesta es: <br><br>  En realidad muchas cosas.  Incluso una l√≥gica tan simple ofrece muchas opciones, un intento de escribir que, y a√∫n m√°s para crear pruebas para todos ellos, puede ser una tarea imposible.  Por lo tanto, para responder la pregunta a nivel de aplicaci√≥n, elegiremos solo los casos de prueba principales. <br><br>  Es decir, suponemos que todos los datos de entrada tienen un formato v√°lido, los sistemas de terceros responden normalmente y anteriormente no hab√≠a informaci√≥n sobre el producto. <br><br>  <i>Entonces quiero:</i> <br><br><ul><li>  Ha llegado un evento de que no hay productos en el estante.  Notifique que la entrega no est√° disponible. </li><li>  Lleg√≥ el caso de que el producto amarillo est√° en stock, DostavchenKO est√° listo para tomarlo.  Notificar sobre la disponibilidad de bienes. </li><li>  Dos mensajes llegaron seguidos, ambos con una cantidad positiva de productos en la tienda.  Enviado solo un mensaje. </li><li>  Llegaron dos mensajes: en el primero hay un producto en la tienda, en el segundo, ya no est√° all√≠.  Enviamos dos mensajes: primero - disponible, luego - no. </li><li>  Puedo desactivar el producto manualmente y ya no se env√≠an notificaciones. </li><li>  ... </li></ul><br>  Lo principal aqu√≠ es detenerse a tiempo: como ya escrib√≠, hay demasiadas opciones, y no tiene sentido describirlas todas aqu√≠, solo las <b>m√°s</b> b√°sicas.  En el futuro, cuando escribamos pruebas para la l√≥gica de negocios, es probable que su combinaci√≥n cubra todo lo que se nos ocurre aqu√≠.  La motivaci√≥n principal aqu√≠ es asegurarse de que si pasan estas pruebas, la aplicaci√≥n funciona como lo necesitamos. <br><br>  Toda esta lista de deseos ahora la destilaremos en pruebas.  Adem√°s, dado que esta es la Lista de Deseos a nivel de aplicaci√≥n, tendremos pruebas para elevar el contexto de primavera, es decir, bastante pesado. <br>  Y esto, desafortunadamente, para muchos fines de TDD, porque para escribir una prueba de integraci√≥n de este tipo, se necesita un gran esfuerzo que la gente no siempre est√° dispuesta a gastar.  Y s√≠, este es el paso m√°s dif√≠cil, pero, cr√©ame, despu√©s de que lo revise, el c√≥digo casi se escribir√° solo, y estar√° seguro de que su aplicaci√≥n funcionar√° de la manera que desee. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/r2/hg/db/r2hgdbqezd8esoynflanwv-so8e.jpeg"></div><br>  En el proceso de responder la pregunta, ya puede comenzar a escribir c√≥digo en la clase spring initializr generada.  Los nombres de las pruebas son solo nuestra lista de deseos.  Por ahora, solo cree m√©todos vac√≠os: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductQuantityIsZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyAvailableYellowProductIfPositiveQuantityAndDostavchenkoApproved</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyOnceOnSeveralEqualProductMessages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyFirstAvailableThenNotIfProductQuantityMovedFromPositiveToZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noNotificationOnDisabledProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{}</code> </pre> <br>  En cuanto a la denominaci√≥n de los m√©todos: le recomiendo encarecidamente que los haga informativos, en lugar de test1 (), test2 (), porque m√°s tarde, cuando olvide qu√© clase escribi√≥ y de qu√© es responsable, tendr√° la oportunidad en lugar de intente analizar directamente el c√≥digo, simplemente abra la prueba y lea el m√©todo de contrato que satisface la clase. <br><br><h2>  Comience a completar las pruebas </h2><br>  La idea principal es emular todo lo externo para verificar lo que sucede dentro. <br><br>  "Externo" en relaci√≥n con nuestro servicio es todo lo que NO es el microservicio en s√≠, sino que se comunica directamente con √©l. <br><br>  En este caso, lo externo es: <br><br><ul><li>  El sistema que nuestro servicio notificar√° sobre cambios en la cantidad de bienes. </li><li>  Cliente que desconectar√° bienes manualmente </li><li>  Sistema de dostavchenKO de terceros </li></ul><br>  Para emular las solicitudes de los dos primeros, utilizamos MockMvc el√°stico. <br>  Para emular DostavchenKO utilizamos wiremock o MockRestServiceServer. <br><br>  Como resultado, nuestra prueba de integraci√≥n se ve as√≠: <br><br><div class="spoiler">  <b class="spoiler_title">Prueba de integraci√≥n</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureWireMock</span></span>(port = <span class="hljs-number"><span class="hljs-number">8090</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TddExampleApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockMvc mockMvc; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ WireMock.reset(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductQuantityIsZero</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ stubNotification( <span class="hljs-comment"><span class="hljs-comment">// language=JSON "{\n" + " \"productId\": 111,\n" + " \"available\": false\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 111,\n" + " \"color\" : \"red\", \n" + " \"productQuantity\": 0\n" + "}"); verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyAvailableYellowProductIfPositiveQuantityAndDostavchenkoApproved() throws Exception { stubDostavchenko("112"); stubNotification( // language=JSON "{\n" + " \"productId\": 112,\n" + " \"available\": true\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 112,\n" + " \"color\" : \"Yellow\", \n" + " \"productQuantity\": 10\n" + "}"); verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyOnceOnSeveralEqualProductMessages() throws Exception { stubDostavchenko("113"); stubNotification( // language=JSON "{\n" + " \"productId\": 113,\n" + " \"available\": true\n" + "}"); for (int i = 0; i &lt; 5; i++) { performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 113,\n" + " \"color\" : \"Yellow\", \n" + " \"productQuantity\": 10\n" + "}"); } verify(1, postRequestedFor(urlEqualTo("/notify"))); } @Test public void notifyFirstAvailableThenNotIfProductQuantityMovedFromPositiveToZero() throws Exception { stubDostavchenko("114"); stubNotification( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"available\": true\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": 10\n" + "}"); stubNotification( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"available\": false\n" + "}"); performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 114,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": 0\n" + "}"); verify(2, postRequestedFor(urlEqualTo("/notify"))); } @Test public void noNotificationOnDisabledProduct() throws Exception { stubNotification( // language=JSON "{\n" + " \"productId\": 115,\n" + " \"available\": false\n" + "}"); disableProduct(115); for (int i = 0; i &lt; 5; i++) { performQuantityUpdateRequest( // language=JSON "{\n" + " \"productId\": 115,\n" + " \"color\" : \"Yellow\",\n" + " \"productQuantity\": " + i + "\n" + "}"); } verify(1, postRequestedFor(urlEqualTo("/notify"))); } private void disableProduct(int productId) throws Exception { mockMvc.perform( post("/disableProduct?productId=" + productId) ).andDo( print() ).andExpect( status().isOk() ); } private void performQuantityUpdateRequest(String content) throws Exception { mockMvc.perform( post("/product-quantity-update") .contentType(MediaType.APPLICATION_JSON) .content(content) ).andDo( print() ).andExpect( status().isOk() ); } private void stubNotification(String content) { stubFor(WireMock.post(urlEqualTo("/notify")) .withHeader("Content-Type", equalTo(MediaType.APPLICATION_JSON_UTF8_VALUE)) .withRequestBody(equalToJson(content)) .willReturn(aResponse().withStatus(HttpStatus.OK_200))); } private void stubDostavchenko(final String productId) { stubFor(get(urlEqualTo("/isDeliveryAvailable?productId=" + productId)) .willReturn(aResponse().withStatus(HttpStatus.OK_200).withBody("true"))); } }</span></span></code> </pre> </div></div><br><h1>  ¬øQu√© acaba de pasar? </h1><br>  Escribimos una prueba de integraci√≥n, cuyo paso nos garantiza la operabilidad del sistema de acuerdo con las principales historias de usuarios.  Y lo hicimos ANTES de comenzar a implementar el servicio. <br><br>  Una de las ventajas de este enfoque es que durante el proceso de escritura tuve que ir al DostavchenKO <b>real</b> y obtener una respuesta <b>real</b> desde all√≠ a la solicitud <b>real</b> que hicimos en nuestro trozo.  Es muy bueno que nos hayamos ocupado de esto al comienzo del desarrollo, y no despu√©s de todo el c√≥digo est√° escrito.  Y aqu√≠ resulta que el formato no es el especificado en los TOR, o el servicio generalmente no est√° disponible, o algo m√°s. <br><br>  Tambi√©n me gustar√≠a se√±alar que no solo no hemos escrito <b>una sola</b> l√≠nea de c√≥digo que luego ir√° al producto, sino que ni siquiera hemos hecho <b>una</b> suposici√≥n sobre c√≥mo se organizar√° nuestro microservicio en el interior: qu√© capas habr√°, si utilizamos la base, si es as√≠, cu√°l, etc. En el momento de escribir la prueba, estamos abstra√≠dos de la implementaci√≥n y, como veremos m√°s adelante, esto puede dar una serie de ventajas arquitect√≥nicas. <br><br>  A diferencia del TDD can√≥nico, donde la implementaci√≥n se escribe inmediatamente despu√©s de la prueba, la prueba de integraci√≥n no tomar√° mucho tiempo.  De hecho, no se volver√° verde hasta el final del desarrollo, hasta que se haya escrito absolutamente todo, incluidos los archivos. <br>  Vamos m√°s lejos <br><br><h1>  Controlador </h1><br>  Despu√©s de que escribimos la prueba de integraci√≥n y ahora estamos seguros de que despu√©s de pasar la tarea, podemos dormir tranquilos por la noche, es hora de comenzar a programar las capas.  Y la primera capa que implementaremos es el controlador.  ¬øPor qu√© exactamente √©l?  Porque este es el punto de entrada al programa.  Necesitamos pasar de arriba a abajo, desde la primera capa con la que interactuar√° el usuario, hasta la √∫ltima. <br>  Esto es importante <br><br>  Y nuevamente, todo comienza con la misma pregunta: <br><br>  <i>¬øQu√© quiero del controlador?</i> <br><br>  La respuesta es: <br><br>  Sabemos que el controlador se dedica a la comunicaci√≥n con el usuario, la validaci√≥n y la conversi√≥n de los datos de entrada y no contiene l√≥gica empresarial.  Entonces la respuesta a esta pregunta podr√≠a ser algo como esto: <br><br>  <i>Quiero:</i> <br><br><ul><li>  BAD_REQUEST devuelto al usuario cuando intenta desconectar un producto con una identificaci√≥n no v√°lida </li><li>  BAD_REQUEST al intentar notificar sobre un cambio de mercanc√≠as con una identificaci√≥n no v√°lida </li><li>  BAD_REQUEST al intentar notificar una cantidad negativa </li><li>  INTERNAL_SERVER_ERROR si DostavchenKO no est√° disponible </li><li>  INTERNAL_SERVER_ERROR, si no puede enviar a DATA </li></ul><br>  Dado que queremos ser f√°ciles de usar, para todos los elementos anteriores, adem√°s del c√≥digo http, debe mostrar un mensaje personalizado que describa el problema para que el usuario comprenda cu√°l es el problema. <br><br><ul><li>  200 si el procesamiento fue exitoso </li><li>  INTERNAL_SERVER_ERROR con un mensaje predeterminado en todos los dem√°s casos, para no brillar stackrace </li></ul><br>  Hasta que comenc√© a escribir en TDD, lo √∫ltimo en lo que estaba pensando era en lo que mi sistema aportar√≠a al usuario en alg√∫n caso especial y, a primera vista, poco probable.  No pens√© por una simple raz√≥n: es muy dif√≠cil escribir una implementaci√≥n, para tener en cuenta absolutamente todos los casos extremos, a veces no hay suficiente RAM en el cerebro.  Y despu√©s de la implementaci√≥n por escrito, analizar el c√≥digo en busca de algo que quiz√°s no haya considerado de antemano sigue siendo un placer: todos pensamos que estamos escribiendo el c√≥digo perfecto de inmediato).  Si bien no hay implementaci√≥n, no hay necesidad de pensarlo, y no hay dolor para cambiarlo, si eso es as√≠.  Una vez escrita la prueba primero, no tiene que esperar hasta que las estrellas converjan, y despu√©s de retirarse al producto, un cierto n√∫mero de sistemas fallar√°, y el cliente acudir√° a usted con una solicitud para arreglar algo.  Y esto se aplica no solo al controlador. <br><br><h2>  Comienza a escribir ex√°menes </h2><br>  Todo est√° claro con los primeros tres: utilizamos la validaci√≥n de primavera, si llega una solicitud no v√°lida, la aplicaci√≥n arrojar√° una excepci√≥n, que atraparemos en un controlador de excepciones.  Aqu√≠, como dicen, todo funciona por s√≠ solo, pero ¬øc√≥mo sabe el controlador que alg√∫n sistema de terceros no est√° disponible? <br><br>  Est√° claro que el controlador en s√≠ no deber√≠a saber nada acerca de los sistemas de terceros, porque  qu√© sistema preguntar y cu√°l es la l√≥gica de negocios, es decir, debe haber alg√∫n tipo de intermediario.  Este intermediario es el servicio.  Y escribiremos pruebas en el controlador utilizando la simulaci√≥n de este servicio, emulando su comportamiento en ciertos casos.  Por lo tanto, el servicio debe informar de alguna manera al controlador que el sistema no est√° disponible.  Puede hacerlo de diferentes maneras, pero es la forma m√°s f√°cil de lanzar una ejecuci√≥n personalizada.  Escribiremos una prueba para este comportamiento del controlador. <br><br><div class="spoiler">  <b class="spoiler_title">Prueba de error de comunicaci√≥n con un sistema de datos de terceros</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@WebMvcTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnServerErrorOnDataCommunicationError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataCommunicationException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( <span class="hljs-comment"><span class="hljs-comment">//language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Can't communicate with Data system\"\n" + " }\n" + " ]\n" + "}") ); } }</span></span></code> </pre><br></div></div><br>  En esta etapa, varias cosas aparecieron por s√≠ mismas: <br><br><ul><li>  Un servicio que se inyectar√° en el controlador y al que se le delegar√° el procesamiento de un mensaje entrante para una nueva cantidad de bienes. </li><li>  El m√©todo de este servicio y, en consecuencia, su firma, que llevar√° a cabo este procesamiento. </li><li>  La constataci√≥n de que el m√©todo deber√≠a arrojar una ejecuci√≥n personalizada cuando el sistema no est√° disponible. </li><li>  Esta ejecuci√≥n personalizada en s√≠. </li></ul><br>  ¬øPor qu√© por s√≠ mismos?  Porque, como recordar√°n, todav√≠a no hemos escrito una implementaci√≥n.  Y todas estas entidades aparecieron en el proceso de c√≥mo programamos las pruebas.  Para que el compilador no jure, en c√≥digo real, tendremos que crear todo lo descrito anteriormente.  Afortunadamente, casi cualquier IDE nos ayudar√° a generar las entidades necesarias.  Por lo tanto, escribimos una prueba, y la aplicaci√≥n est√° llena de clases y m√©todos. <br><br>  En total, las pruebas para el controlador son las siguientes: <br><br><div class="spoiler">  <b class="spoiler_title">Pruebas</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@WebMvcTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@AutoConfigureMockMvc</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControllerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@InjectMocks</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Controller controller; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MockMvc mvc; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnBadRequestOnDisableWithInvalidProductId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ mvc.perform( post(<span class="hljs-string"><span class="hljs-string">"/disableProduct?productId=-443"</span></span>) ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json(getInvalidProductIdJsonContent()) ); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnBadRequestOnNotifyWithInvalidProductId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ performUpdate( <span class="hljs-comment"><span class="hljs-comment">//language=JSON "{\n" + " \"productId\": -1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 0\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json(getInvalidProductIdJsonContent()) ); } @Test public void returnBadRequestOnNotifyWithNegativeProductQuantity() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": -10\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"productQuantity is invalid\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnServerErrorOnDostavchenkoCommunicationError() throws Exception { doThrow(new DostavchenkoException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"DostavchenKO communication exception\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnServerErrorOnDataCommunicationError() throws Exception { doThrow(new DataCommunicationException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Can't communicate with Data system\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void return200OnSuccess() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isOk() ); } @Test public void returnServerErrorOnUnexpectedException() throws Exception { doThrow(new RuntimeException()).when(updateProcessorService).processUpdate(any(Update.class)); performUpdate( //language=JSON "{\n" + " \"productId\": 1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": 10\n" + "}" ).andDo( print() ).andExpect( status().isInternalServerError() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"Internal Server Error\"\n" + " }\n" + " ]\n" + "}") ); } @Test public void returnTwoErrorMessagesOnInvalidProductIdAndNegativeQuantity() throws Exception { performUpdate( //language=JSON "{\n" + " \"productId\": -1,\n" + " \"color\": \"red\",\n" + " \"productQuantity\": -10\n" + "}" ).andDo( print() ).andExpect( status().isBadRequest() ).andExpect( content().json("{\n" + " \"errors\": [\n" + " { \"message\": \"productQuantity is invalid\" },\n" + " { \"message\": \"productId is invalid\" }\n" + " ]\n" + "}") ); } private ResultActions performUpdate(String jsonContent) throws Exception { return mvc.perform( post("/product-quantity-update") .contentType(MediaType.APPLICATION_JSON_UTF8_VALUE) .content(jsonContent) ); } private String getInvalidProductIdJsonContent() { return //language=JSON "{\n" + " \"errors\": [\n" + " {\n" + " \"message\": \"productId is invalid\"\n" + " }\n" + " ]\n" + "}"; } }</span></span></code> </pre> </div></div><br>  Ahora podemos escribir la implementaci√≥n y asegurarnos de que todas las pruebas pasen con √©xito: <br><div class="spoiler">  <b class="spoiler_title">Implementaci√≥n</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Validated</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/product-quantity-update"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateQuantity</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestBody @Valid Update update)</span></span></span><span class="hljs-function"> </span></span>{ updateProcessorService.processUpdate(update); } <span class="hljs-meta"><span class="hljs-meta">@PostMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/disableProduct"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@RequestParam(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"productId"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> @</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Min</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> Long productId) </span></span>{ updateProcessorService.disableProduct(Long.valueOf(productId)); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Controlador de excepciones</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@ControllerAdvice</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApplicationExceptionHandler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(ConstraintViolationException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.BAD_REQUEST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onConstraintViolationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ConstraintViolationException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"Constraint Violation"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(exception.getConstraintViolations().stream() .map(constraintViolation -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message( ((PathImpl) constraintViolation.getPropertyPath()).getLeafNode().toString() + <span class="hljs-string"><span class="hljs-string">" is invalid"</span></span>)) .collect(Collectors.toList())); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(value = MethodArgumentNotValidException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(value = HttpStatus.BAD_REQUEST) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMethodArgumentNotValidException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodArgumentNotValidException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.info(exception.getMessage()); List&lt;ErrorResponse.Message&gt; fieldErrors = exception.getBindingResult().getFieldErrors().stream() .map(fieldError -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(fieldError.getField() + <span class="hljs-string"><span class="hljs-string">" is invalid"</span></span>)) .collect(Collectors.toList()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(fieldErrors); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(DostavchenkoException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDostavchenkoCommunicationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DostavchenkoException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(DataCommunicationException.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDataCommunicationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataCommunicationException exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"DostavchenKO communication exception"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(<span class="hljs-string"><span class="hljs-string">"Can't communicate with Data system"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@ExceptionHandler</span></span>(Exception.class) <span class="hljs-meta"><span class="hljs-meta">@ResponseBody</span></span> <span class="hljs-meta"><span class="hljs-meta">@ResponseStatus</span></span>(HttpStatus.INTERNAL_SERVER_ERROR) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ErrorResponse </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception exception)</span></span></span><span class="hljs-function"> </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">"Error while processing"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse(Collections.singletonList( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorResponse.Message(HttpStatus.INTERNAL_SERVER_ERROR.getReasonPhrase()))); } }</code> </pre> <br></div></div><br><h1>  ¬øQu√© acaba de pasar? </h1><br>  <b>En TDD, no tiene que tener todo el c√≥digo en su cabeza.</b> <br><br>  De nuevo: no mantengamos toda la arquitectura en RAM.  Solo mira una capa.  El es simple. <br><br>  En el proceso habitual, el cerebro no es suficiente, porque hay muchas implementaciones.  Si eres un superh√©roe que puede tener en cuenta todos los matices de un gran proyecto en tu cabeza, entonces TDD no es necesario.  No se como.  Cuanto m√°s grande es el proyecto, m√°s me equivoco. <br><br>  Despu√©s de darse cuenta de que solo necesita comprender lo que necesita la siguiente capa, la iluminaci√≥n cobra vida.  El hecho es que este enfoque le permite no hacer cosas innecesarias.  Aqu√≠ est√°s hablando con una chica.  Ella dice algo sobre un problema en el trabajo.  Y si piensas c√≥mo resolverlo, te encoges el cerebro.  Y ella no necesita resolverlo, solo necesita decirlo.  Y eso es todo.  Ella solo quer√≠a compartir algo.  Aprender sobre esto en la primera etapa de listen () no tiene precio.  Para todo lo dem√°s ... bueno, ya sabes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qx/bk/fb/qxbkfb93hkn7folrvbn1pjd8hxm.png"></div><br><h1>  Servicio </h1><br>  A continuaci√≥n implementamos el servicio. <br><br>  <i>¬øQu√© queremos del servicio?</i> <br><br>  Queremos que se ocupe de la l√≥gica empresarial, es decir: <br><br><ol><li>  Sab√≠a c√≥mo desconectar bienes, <u>y tambi√©n notific√≥ sobre</u> : </li><li>  La disponibilidad, si el producto no est√° desconectado, est√° en stock, el color del producto es amarillo y DostavchenKO est√° listo para realizar la entrega. </li><li>  Inaccesibilidad, si los bienes no est√°n disponibles independientemente de nada. </li><li>  Inaccesibilidad, si el producto es azul. </li><li>  Inaccesibilidad si DostavchenKO se niega a llevarlo. </li><li>  Inaccesibilidad si las mercanc√≠as se desconectan manualmente. </li><li>  A continuaci√≥n, queremos que el servicio ejecute la ejecuci√≥n si alguno de los sistemas no est√° disponible. </li><li>  Y tambi√©n, para no enviar spam a los DATOS, debe organizar el env√≠o diferido de mensajes, a saber: </li><li>  Si sol√≠amos enviar bienes disponibles para bienes y ahora hemos calculado lo que est√° disponible, entonces no enviamos nada. </li><li>  Y si antes no estaba disponible, pero ahora est√° disponible, lo enviamos. </li><li>  Y necesitas escribirlo en alguna parte ... </li></ol><br>  <b>¬°ALTO!</b> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/if/ek/y1/ifeky128w2kgpc2gw2jcxwvzkia.jpeg"></div><br>  ¬øNo crees que nuestro servicio est√° empezando a hacer demasiado? <br><br>  A juzgar por nuestra lista de deseos, sabe c√≥mo desactivar los productos, considera la accesibilidad y se asegura de no enviar mensajes enviados anteriormente.  Esto no es alta cohesi√≥n.  Es necesario mover funcionalidades heterog√©neas a diferentes clases y, por lo tanto, ya deber√≠a haber tres servicios: uno se ocupar√° de la desconexi√≥n de los bienes, el otro calcular√° la posibilidad de entrega y lo pasar√° a un servicio que decidir√° si enviarlo o no.  Por cierto, de esta manera, el servicio de l√≥gica de negocios no sabr√° nada sobre el sistema DATA, que tambi√©n es una ventaja definitiva. <br><br>  En mi experiencia, con bastante frecuencia, habiendo ido de frente a la implementaci√≥n, es f√°cil pasar por alto los momentos arquitect√≥nicos.  Si escribi√©ramos el servicio de inmediato, sin pensar en lo que deber√≠a hacer y, lo que es m√°s importante, de lo que NO deber√≠a, aumentar√≠a la probabilidad de que se superpongan √°reas de responsabilidad.  Me gustar√≠a agregar en mi propio nombre que fue este ejemplo el que me sucedi√≥ en la pr√°ctica real y la diferencia cualitativa entre los resultados de TDD y los enfoques de programaci√≥n secuencial que me inspiraron a escribir esta publicaci√≥n. <br><br><h1>  L√≥gica de negocios </h1><br>  Pensando en el servicio de l√≥gica de negocios por las mismas razones que la alta cohesi√≥n, entendemos que necesitamos un nivel m√°s de abstracci√≥n entre √©l y el verdadero DostavchenKO.  Y, dado que <b>primero</b> dise√±amos el servicio, podemos exigirle al cliente de DostavchenKO el contrato interno que queremos.  En el proceso de redacci√≥n de una prueba de l√≥gica empresarial, entenderemos lo que queremos del cliente con la siguiente firma: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isAvailableForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre><br>  A nivel de servicio, no nos importa c√≥mo responda el verdadero DostavchenKO: en el futuro, la tarea del cliente de alguna manera le sacar√° esta informaci√≥n.  Una vez puede ser simple, pero en alg√∫n momento ser√° necesario hacer varias solicitudes: en este momento estamos abstra√≠dos de esto. <br><br>  Queremos una firma similar de un servicio que se ocupe de productos desconectados: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProductEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{...}</code> </pre><br>  Entonces, las preguntas "¬øQu√© quiero del servicio de l√≥gica de negocios?" Registrado en las pruebas son las siguientes: <br><br><div class="spoiler">  <b class="spoiler_title">Pruebas de servicio</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(MockitoJUnitRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateProcessorServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@InjectMocks</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateProcessorService updateProcessorService; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionService manualExclusionService; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DostavchenkoClient dostavchenkoClient; <span class="hljs-meta"><span class="hljs-meta">@Mock</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyAvailableIfYellowProductIsEnabledAndReadyForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsAbsent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">0L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(manualExclusionService); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsBlue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Blue"</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(manualExclusionService); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); verifyNoMoreInteractions(dostavchenkoClient); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyNotAvailableIfProductIsNotReadyForTransportation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); verify(availabilityNotifier, only()).notify(eq(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(testProduct.getProductId(), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span>(expected = DostavchenkoException.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">throwCustomExceptionIfDostavchenkoCommunicationFailed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Update testProduct = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Update(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-number"><span class="hljs-number">10L</span></span>, <span class="hljs-string"><span class="hljs-string">"Yellow"</span></span>); when(dostavchenkoClient.isAvailableForTransportation(testProduct.getProductId())) .thenThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestClientException(<span class="hljs-string"><span class="hljs-string">"Something's wrong"</span></span>)); when(manualExclusionService.isProductEnabled(testProduct.getProductId())).thenReturn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); updateProcessorService.processUpdate(testProduct); } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En esta etapa, nacieron solos: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cliente DostavchenKO con singatura amigable con el servicio </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un servicio en el que ser√° necesario implementar la l√≥gica del env√≠o diferido, a quien el servicio dise√±ado transmitir√° los resultados de su trabajo. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Servicio de bienes desconectados y su firma. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implementaci√≥n </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RequiredArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateProcessorService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> DostavchenkoClient dostavchenkoClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ManualExclusionService manualExclusionService; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Update update)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (update.getProductQuantity() &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"Blue"</span></span>.equals(update.getColor())) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!manualExclusionService.isProductEnabled(update.getProductId())) { availabilityNotifier.notify(getNotAvailableProduct(update.getProductId())); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> availableForTransportation = dostavchenkoClient.isAvailableForTransportation(update.getProductId()); availabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(update.getProductId(), availableForTransportation)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception exception) { log.warn(<span class="hljs-string"><span class="hljs-string">"Problems communicating with DostavchenKO"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DostavchenkoException(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ProductAvailability </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNotAvailableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(productId, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } }</code> </pre><br></div></div><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Productos deshabilitantes </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ha llegado el momento de una de las fases inevitables de TDD: la refactorizaci√≥n. </font><font style="vertical-align: inherit;">Si recuerda, despu√©s de la implementaci√≥n del controlador, el contrato de servicio se ve√≠a as√≠:</font></font><br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId)</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y ahora decidimos mover la l√≥gica de desconexi√≥n a un servicio separado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De este servicio en esta etapa queremos lo siguiente:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> La capacidad de apagar bienes. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Queremos que regrese que los bienes se desconectan si se desconect√≥ antes. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Queremos que regrese que los productos est√°n disponibles si no hubo desconexi√≥n antes. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En cuanto a la lista de deseos, que son una consecuencia directa del contrato entre el servicio de l√≥gica de negocios y el proyectado, me gustar√≠a se√±alar lo siguiente: </font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En primer lugar, puede ver de inmediato que la aplicaci√≥n puede tener problemas si alguien quiere apagar el producto desconectado, porque en este momento este servicio simplemente no sabe c√≥mo hacerlo. </font><font style="vertical-align: inherit;">Y esto significa que quiz√°s valga la pena discutir este tema con el analista que estableci√≥ la tarea para el desarrollo. </font><font style="vertical-align: inherit;">Entiendo que en este caso esta pregunta deber√≠a haber surgido justo despu√©s de la primera lectura de los T√©rminos de Referencia, pero estamos dise√±ando un sistema bastante simple, en proyectos m√°s grandes esto podr√≠a no ser tan obvio. </font><font style="vertical-align: inherit;">Adem√°s, no sab√≠amos que tendr√≠amos una entidad que se encargara solo de la funcionalidad de desconectar los productos: recuerdo que nacimos solo en el proceso de desarrollo.</font></font></li><li> -,       .           ‚Äî   ,         .  ,  , ,       ,      ,      , . . ProductAvailability.    ,      . . .,  ,   god object,    ,        ,      ,     TDD,          ,     .   ,  , ¬´¬ª ‚Äî     : ¬´    ...¬ª     , ,  TDD,     . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Las pruebas y la implementaci√≥n son muy simples: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pruebas</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManualExclusionServiceTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionService service; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ManualExclusionRepository manualExclusionRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ manualExclusionRepository.deleteAll(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableItem</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Long productId = <span class="hljs-number"><span class="hljs-number">100L</span></span>; service.disableProduct(productId); assertThat(service.isProductEnabled(productId), is(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returnEnabledIfProductWasNotDisabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ assertThat(service.isProductEnabled(<span class="hljs-number"><span class="hljs-number">100L</span></span>), is(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); assertThat(service.isProductEnabled(<span class="hljs-number"><span class="hljs-number">200L</span></span>), is(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)); } }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Service</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ManualExclusionService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ManualExclusionRepository manualExclusionRepository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProductEnabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Long productId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !manualExclusionRepository.exists(productId); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">disableProduct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productId)</span></span></span><span class="hljs-function"> </span></span>{ manualExclusionRepository.save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ManualExclusion(productId)); } }</code> </pre><br></div></div><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Servicio de presentaci√≥n diferida </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Entonces, llegamos al √∫ltimo servicio, lo que garantizar√° que el sistema de DATOS no sea spam con los mismos mensajes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Perm√≠tame recordarle que el resultado del trabajo del servicio de l√≥gica de negocios, es decir, el objeto ProductAvailability, en el que solo hay dos campos: productId y isAvailable, ya se ha transferido a √©l. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">De acuerdo con la buena tradici√≥n, comenzamos a pensar en lo que queremos de este servicio:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enviar una notificaci√≥n por primera vez de todos modos. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Enviar una notificaci√≥n si la disponibilidad del producto ha cambiado. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No enviamos nada si no. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si el env√≠o a un sistema de terceros termin√≥ con una excepci√≥n, la notificaci√≥n que caus√≥ la excepci√≥n no debe incluirse en la base de datos de notificaciones enviadas. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Adem√°s, cuando se ejecuta desde el lado DATOS, el servicio debe lanzar su DataCommunicationException. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo aqu√≠ es relativamente simple, pero me gustar√≠a se√±alar un punto: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">necesitamos informaci√≥n sobre lo que enviamos anteriormente, lo que significa que tendremos un repositorio en el que guardaremos los c√°lculos anteriores sobre la disponibilidad de bienes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El objeto ProductAvailability no es adecuado para guardar, porque al menos no hay un identificador, lo que significa que es l√≥gico crear otro. </font><font style="vertical-align: inherit;">Lo principal aqu√≠ es no asustarse y no agregar este identificador, junto con @Document (usaremos MongoDb como base) e √≠ndices en ProductAvailability en s√≠.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debe comprender que el objeto ProductAvailability con todos los pocos campos se cre√≥ en la etapa de dise√±o de clases que son m√°s altas en la jerarqu√≠a de llamadas que la que estamos dise√±ando ahora. Estas clases no necesitan saber nada sobre los campos espec√≠ficos de la base de datos, ya que esta informaci√≥n no era necesaria al dise√±ar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero todo esto es hablar.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Curiosamente, debido al hecho de que ya hemos escrito un mont√≥n de pruebas con la Disponibilidad del producto que estamos transfiriendo al servicio ahora, agregar nuevos campos significar√° que estas pruebas tambi√©n deber√°n ser refactorizadas, lo que puede requerir un poco de esfuerzo. </font><font style="vertical-align: inherit;">Esto significa que habr√° muchas menos personas que quieran hacer un objeto divino de ProductAvailability que si escribieran la implementaci√≥n de inmediato: all√≠, por el contrario, agregar un campo a un objeto existente ser√≠a m√°s f√°cil que crear otra clase.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pruebas</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(SpringRunner.class) <span class="hljs-meta"><span class="hljs-meta">@SpringBootTest</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyAvailabilityNotifierTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LazyAvailabilityNotifier lazyAvailabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@MockBean</span></span> <span class="hljs-meta"><span class="hljs-meta">@Qualifier</span></span>(<span class="hljs-string"><span class="hljs-string">"dataClient"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AvailabilityRepository availabilityRepository; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearDb</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ availabilityRepository.deleteAll(); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyIfFirstTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sendNotificationAndVerifyDataBase(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyIfAvailabilityChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability oldProductAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); sendNotificationAndVerifyDataBase(oldProductAvailability); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability newProductAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); sendNotificationAndVerifyDataBase(newProductAvailability); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNotNotifyIfAvailabilityDoesNotChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ProductAvailability productAvailability = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); sendNotificationAndVerifyDataBase(productAvailability); verify(availabilityNotifier, only()).notify(eq(productAvailability)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doNotSaveIfSentWithException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException()).when(availabilityNotifier).notify(anyObject()); <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> exceptionThrown = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { availabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RuntimeException exception) { exceptionThrown = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } assertTrue(<span class="hljs-string"><span class="hljs-string">"Exception was not thrown"</span></span>, exceptionThrown); assertThat(availabilityRepository.findAll(), hasSize(<span class="hljs-number"><span class="hljs-number">0</span></span>)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span>(expected = DataCommunicationException.class) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapDataException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ doThrow(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RestClientException(<span class="hljs-string"><span class="hljs-string">"Something wrong"</span></span>)).when(availabilityNotifier).notify(anyObject()); lazyAvailabilityNotifier.notify(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductAvailability(<span class="hljs-number"><span class="hljs-number">1L</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendNotificationAndVerifyDataBase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ lazyAvailabilityNotifier.notify(productAvailability); verify(availabilityNotifier).notify(eq(productAvailability)); assertThat(availabilityRepository.findAll(), hasSize(<span class="hljs-number"><span class="hljs-number">1</span></span>)); assertThat(availabilityRepository.findAll().get(<span class="hljs-number"><span class="hljs-number">0</span></span>), hasProperty(<span class="hljs-string"><span class="hljs-string">"productId"</span></span>, is(productAvailability.getProductId()))); assertThat(availabilityRepository.findAll().get(<span class="hljs-number"><span class="hljs-number">0</span></span>), hasProperty(<span class="hljs-string"><span class="hljs-string">"availability"</span></span>, is(productAvailability.isAvailable()))); } }</code> </pre> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Implementaci√≥n</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-meta"><span class="hljs-meta">@AllArgsConstructor</span></span> <span class="hljs-meta"><span class="hljs-meta">@Slf</span></span>4j <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LazyAvailabilityNotifier</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AvailabilityNotifier</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityRepository availabilityRepository; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityNotifier availabilityNotifier; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvailabilityPersistenceObject persistedProductAvailability = availabilityRepository .findByProductId(productAvailability.getProductId()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persistedProductAvailability == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { notifyWith(productAvailability); availabilityRepository.save(createObjectFromProductAvailability(productAvailability)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (persistedProductAvailability.isAvailability() != productAvailability.isAvailable()) { notifyWith(productAvailability); persistedProductAvailability.setAvailability(productAvailability.isAvailable()); availabilityRepository.save(persistedProductAvailability); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyWith</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { availabilityNotifier.notify(productAvailability); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (RestClientException exception) { log.error(<span class="hljs-string"><span class="hljs-string">"Couldn't notify"</span></span>, exception); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataCommunicationException(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> AvailabilityPersistenceObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createObjectFromProductAvailability</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProductAvailability productAvailability)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AvailabilityPersistenceObject(productAvailability.getProductId(), productAvailability.isAvailable()); } }</code> </pre> <br></div></div><br><h1>  Conclusi√≥n </h1><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/eq/cq/u-/eqcqu-xh6fu5mybs440rhhfob-g.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una aplicaci√≥n similar tuvo que ser escrita en la pr√°ctica. Y result√≥ que al principio se escribi√≥ sin TDD, luego el negocio dijo que no era necesario, y despu√©s de seis meses los requisitos cambiaron, y se decidi√≥ volver a escribirlo desde cero (el beneficio es la arquitectura de microservicios, y no fue tan aterrador desechar algo) . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al escribir la misma aplicaci√≥n usando diferentes t√©cnicas, puedo apreciar sus diferencias. En mi pr√°ctica, vi c√≥mo TDD ayuda a construir la arquitectura, me parece, m√°s correctamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puedo suponer que la raz√≥n de esto no es la creaci√≥n de pruebas antes de la implementaci√≥n, sino que, despu√©s de haber escrito las pruebas al principio, primero pensamos en lo que har√° la clase creada. Adem√°s, aunque no hay implementaci√≥n, realmente podemos "ordenar" en los objetos llamados el contrato exacto que necesita el objeto que los llama, sin la tentaci√≥n de agregar r√°pidamente algo en alg√∫n lugar y obtener una entidad que se encargar√° de muchas tareas al mismo tiempo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, una de las principales ventajas de TDD para m√≠, puedo resaltar que realmente me sent√≠ m√°s seguro en el producto que produzco. Esto puede deberse al hecho de que el c√≥digo promedio escrito en TDD probablemente est√© mejor cubierto por las pruebas, pero fue despu√©s de que comenc√© a escribir en TDD que mi n√∫mero de ediciones al c√≥digo se redujo despu√©s de que di su prueba casi a cero. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y en general, hab√≠a una sensaci√≥n de que, como desarrollador, mejor√©. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo de la aplicaci√≥n se puede encontrar </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para aquellos que quieran comprender c√≥mo se cre√≥ en pasos, les recomiendo prestar atenci√≥n al historial de confirmaciones, luego de analizar cu√°l, espero, el proceso de creaci√≥n de una aplicaci√≥n TDD t√≠pica ser√° m√°s comprensible. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay un muy √∫til</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">un video</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que recomiendo ver a cualquiera que quiera sumergirse en el mundo de TDD. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El c√≥digo de la aplicaci√≥n reutiliza una cadena formateada como json. </font><font style="vertical-align: inherit;">Esto es necesario para verificar c√≥mo la aplicaci√≥n analizar√° json en objetos POJO. </font><font style="vertical-align: inherit;">Si usa IDEA, entonces, de forma r√°pida y sin problemas, se puede lograr el formato necesario utilizando inyecciones de lenguaje JSON.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬øCu√°les son las desventajas del enfoque? </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es mucho tiempo para desarrollarse. Programando en el paradigma est√°ndar, mi colega pod√≠a permitirse el lujo de poner el servicio a los probadores para que lo probaran sin pruebas en absoluto, agreg√°ndolos en el camino. Fue muy rapido. En TDD esto no funcionar√°. Si tiene plazos ajustados, sus gerentes no estar√°n contentos. Aqu√≠ el intercambio entre hacerlo bien de inmediato, pero durante mucho tiempo y no muy bueno, pero r√°pido. Elijo el primero para m√≠, porque el segundo como resultado es m√°s largo. Y con grandes nervios. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seg√∫n mis sentimientos, TDD no es adecuado si necesita hacer muchas refactorizaciones: porque a diferencia de una aplicaci√≥n creada desde cero, no es obvio qu√© forma de abordar y qu√© comenzar a hacer primero. Puede resultar que est√© trabajando en una prueba de clase, que, como resultado, la elimina.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TDD no es una bala de plata. </font><font style="vertical-align: inherit;">Esta es una historia sobre c√≥digo claro y legible que puede crear problemas de rendimiento. </font><font style="vertical-align: inherit;">Por ejemplo, cre√≥ N clases, que, como en Fowler, cada una hace lo suyo. </font><font style="vertical-align: inherit;">Y luego resulta que para hacer su trabajo, necesitan que todos vayan a la base. </font><font style="vertical-align: inherit;">Y tendr√° N consultas en la base de datos. </font><font style="vertical-align: inherit;">En lugar de hacer, por ejemplo, 1 objeto de dios y pasar 1 vez. </font><font style="vertical-align: inherit;">Si lucha por milisegundos, entonces, usando TDD, debe tener esto en cuenta: el c√≥digo legible no siempre es el m√°s r√°pido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y, por √∫ltimo, es bastante dif√≠cil cambiar a esta metodolog√≠a: debe aprender a pensar de manera diferente. </font><font style="vertical-align: inherit;">La mayor parte del dolor est√° en la primera etapa. </font><font style="vertical-align: inherit;">La primera prueba de integraci√≥n que escrib√≠ 1.5 d√≠as. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bueno, el ultimo. </font><font style="vertical-align: inherit;">Si usa TDD y su c√≥digo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a√∫n no es muy</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, entonces el asunto puede no estar en la metodolog√≠a. </font><font style="vertical-align: inherit;">Pero me ayud√≥.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/je/ix/2n/jeix2nwpo0ui_ehjeisprshkrvk.jpeg"></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/456662/">https://habr.com/ru/post/456662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../456650/index.html">Elecci√≥n de un osciloscopio de bolsillo econ√≥mico</a></li>
<li><a href="../456652/index.html">El tiempo no espera: que Windows 10 Timeline puede ser √∫til para el criminalista</a></li>
<li><a href="../456654/index.html">Proyecto ERP no tan aterrador como pintado</a></li>
<li><a href="../456656/index.html">Lecciones sobre SDL 2: Lecci√≥n 4 - Estirando PNG</a></li>
<li><a href="../456658/index.html">Crecimiento: c√≥mo evaluamos las habilidades en un equipo</a></li>
<li><a href="../456664/index.html">A qui√©n demandar cuando un robot pierde tu dinero</a></li>
<li><a href="../456666/index.html">WebTotem o c√≥mo queremos que Internet sea m√°s seguro</a></li>
<li><a href="../456668/index.html">Microsoft ML Spark: una extensi√≥n de Spark que hace que SparkML sea m√°s humano y LightGBM como un bono</a></li>
<li><a href="../456670/index.html">Sobre el m√©todo de autenticaci√≥n muy esp√≠a</a></li>
<li><a href="../456672/index.html">Recetas Nginx: notificaciones as√≠ncronas de PostgreSQL a websocket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>