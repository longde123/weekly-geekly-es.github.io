<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐴 🤛🏽 💆🏾 TON测试客户端（电报开放网络）和用于智能合约的新Fift语言 🧕🏿 🏨 🕌</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="一年多以前，人们已经知道Telegram Messenger计划发布自己的去中心化网络Telegram Open Network 。 然后，大量的技术文档可供使用，大概是Nikolai Durov撰写的，描述了未来网络的结构。 对于那些错过的人，我建议您阅读我对本文档的重述（ 第1 部分 ， 第2部...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>TON测试客户端（电报开放网络）和用于智能合约的新Fift语言</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453714/"><p> 一年多以前，人们已经知道Telegram Messenger计划发布自己的去中心化网络<strong>Telegram Open Network</strong> 。 然后，大量的技术文档可供使用，大概是Nikolai Durov撰写的，描述了未来网络的结构。 对于那些错过的人，我建议您阅读我对本文档的重述（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第1</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">部分</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">第2部分</a> ；第三部分，a，仍在草稿中收集灰尘）。 </p><br><p>从那时起，就没有关于TON的发展状况的重大新闻，直到几天前（在一个<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">非官方渠道中</a> ）出现了指向页面<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://test.ton.org/download.html</a>的链接，其中： </p><br><p>  <a href="">◦ton-test-liteclient-full.tar.xz-</a> TON测试网络的轻客户端资源； <br>  <a href="">ton-lite-client-test1.config.json-</a>用于连接到测试网络的配置文件； <br>  ◦ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">自述文件</a> -有关构建和启动客户端的信息； <br>  ◦HOWTO-有关使用客户端创建智能合约的分步说明； <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ton.pdf-</a>更新的文件（2019年3月2日），其中包含TON网络的技术概述; <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">◦tvm.pdf</a> -TVM（TON虚拟机，TON虚拟机）的技术说明； <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">◦tblkch.pdf</a> -TON <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">区块</a>链的技术说明; <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">◦fiftbase.pdf-</a>对新的Fift语言的描述，旨在在TON中创建智能合约。 </p><br><p> 我再说一遍，Telegram没有对该页面和所有这些文件的官方确认，但是这些材料的数量使它们看起来很合理。 运行已发布的客户需要<strong>您自担风险</strong> 。 </p><a name="habracut"></a><br><h2 id="sborka-testovogo-klienta"> 测试客户端版本 </h2><br><p> 首先，让我们尝试构建和运行测试客户端-幸运的是， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">自述文件</a>详细描述了此简单过程。 我将在macOS 10.14.5的示例中执行此操作，我无法保证其他系统上的汇编成功。 </p><br><ol><li><p>  <a href="">使用源代码</a>下载<a href="">存档文件</a>并解<a href="">压缩</a> 。 重要的是下载最新版本，因为在此阶段不能保证向后兼容。 </p><br></li><li><p> 我们确保在系统上安装了最新版本的make，cmake（版本3.0.2或更高版本），OpenSSL（包括C头文件），g ++或clang。 我不必重新安装任何东西，一切都立即收集到。 </p><br></li><li><p>假设将源文件解压缩到<code>~/lite-client</code>文件夹中。 另外，我们为组装后的项目创建一个空文件夹（例如<code>~/liteclient-build</code> ），然后从其中（ <code>cd ~/liteclient-build</code> ） <code>cd ~/liteclient-build</code>命令： </p><br><pre> <code class="bash hljs">cmake ~/lite-client cmake --build . --target <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client</code> </pre> <br><p><img src="https://habrastorage.org/webt/sr/lx/j8/srlxj8au48yus3uuddlpenvika0.png" alt="成功的客户建立"><br><br> 为了构建用于智能合约的Fift语言解释器（请参见下文），我们还调用 </p><br><pre> <code class="plaintext hljs">cmake --build . --target fift</code> </pre> <br></li><li><p> 下载当前的<a href="">配置文件</a>以连接到测试网络，并将其放入组装好的客户端的文件夹中。 </p><br></li><li><p>  <strong>完成</strong> ，您可以启动客户端： </p><br><pre> <code class="plaintext hljs">./test-lite-client -C ton-lite-client-test1.config.json</code> </pre> <br></li></ol><br><p> 如果一切都正确完成，那么您应该会看到类似以下内容： </p><br><p><img src="https://habrastorage.org/webt/gl/gg/d3/glggd35dzg4vwogf9woibu43zrk.png" alt="客户启动"></p><br><p> 如您所见，几乎没有可用的命令： </p><br><p>  ◦ <strong><code>help</code></strong> -显示此命令列表； <br>  ◦ <strong><code>quit</code></strong> -退出; <br>  ◦ <strong><code>time</code></strong> -显示服务器上的当前时间； <br>  <strong><code>status</code></strong> ：显示连接和本地数据库的状态； <br>  ◦last-更新区块链的状态（加载最后一块）。 在执行任何请求之前执行此命令很重要，以确保您准确看到网络的当前状态。 <br>  <strong><code>sendfile</code></strong> <code>&lt;filename&gt;</code> -将本地文件上传到TON网络。 这是与网络的交互-包括例如创建新的智能合约以及在账户之间转移资金的请求； <br>  <strong><code>getaccount</code></strong> <code>&lt;address&gt;</code> -显示具有指定地址的当前（执行<strong><code>last</code></strong>命令时）帐户状态； <br>  <strong><code>privkey</code></strong> <code>&lt;filename&gt;</code> -从本地文件加载私钥。 </p><br><p> 如果在客户端启动时，使用<code>-D</code>选项将文件夹传递给它，则它将在其中添加主链的最后一块： </p><br><pre> <code class="bash hljs">./<span class="hljs-built_in"><span class="hljs-built_in">test</span></span>-lite-client -C ton-lite-client-test1.config.json -D ~/ton-db-dir</code> </pre> <br><p> 现在，我们可以继续进行更有趣的事情-学习Fift语言，尝试编译智能合约（例如，创建测试钱包），将其上传到网络，并尝试在帐户之间转移资金。 </p><br><h2 id="yazyk-fift"> 五十种语言 </h2><br><p> 从文件<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">fiftbase.pdf中，</a>您可以发现，要创建智能合约，Telegram团队创建了一种新的堆栈语言<strong>Fift</strong> （显然，从<em>第五个</em>数字开始，类似于Forth，Fift与该语言有很多共同点）。 </p><br><p> 该文档篇幅巨大，有87页，在本文的框架中，我不会详细讲述其内容（至少因为我本人还没有读完它：）。 我将重点介绍这些语言，并给出一些使用该语言的代码示例。 </p><br><p> 在基本级别上，Fift的语法非常简单：其代码由<em>单词</em>组成，通常由空格或换行符分隔（特殊情况：某些单词本身不需要分隔符）。 任何<em>单词</em>都是对应于某些<em>定义</em>的区分大小写的字符序列（大致来说，解释器在遇到该单词时必须执行的操作）。 如果没有该词的定义，则解释器尝试将其解析为数字并将其放入堆栈中。 顺便说一下，这里的数字-突然是257位整数，但是根本没有小数-更准确地说，它们立即变成一对整数，形成有理数的分子和分母。 </p><br><p> 单词通常与堆栈顶部的含义相互作用。 单词的另一种类型- <em>前缀</em> -不使用堆栈，而是使用源文件中的后续字符。 例如，字符串文字是通过这种方式实现的：“引号”（ <code>"</code> ）字符是一个前缀单词，它搜索下一个（结束）引号并将字符串放在它们之间的堆栈中。单行（ <code>//</code> ）和多行（ <code>/*</code> ）的行为方式相同评论。 </p><br><p> 至此，语言的几乎整个内部结构结束了。 其他所有内容（包括控制结构）都定义为单词（内部，例如算术运算和新单词的定义；或者在“标准库” <code>Fift.fif</code>定义，该<code>crypto/fift</code>位于源代码的<code>crypto/fift</code>中）。 </p><br><p> 一个Fift程序的简单示例： </p><br><pre> <code class="plaintext hljs">{ dup =: x dup * =: y } : setxy 3 setxy x . y . xy + . 7 setxy x . y . xy + .</code> </pre> <br><p> 第一行定义了新单词<code>setxy</code> （请注意前缀<code>{</code> ，它在结束<code>setxy</code> <code>}</code>之前创建了块，而前缀<code>:</code>实际上定义了该词）。  <code>setxy</code>从堆栈的顶部获取一个数字，将其定义（或重新定义）为全局<em>常量</em> <code>x</code> ，并将该数字的平方定义为常量<code>y</code> （假设可以重新定义常量的值，我宁愿称它们为变量，但我遵循该语言的命名方式）。 </p><br><p> 在接下来的两行中，将一个数字放在堆栈上， <code>setxy</code> ，然后显示常数<code>x</code> ， <code>y</code>的值（该单词用于输出<code>.</code> ），将两个常数都压入堆栈，相加并显示结果。 结果，我们将看到： </p><br><pre> <code class="plaintext hljs">3 9 12 ok 7 49 56 ok</code> </pre> <br><p>  （解释器在交互式输入模式下完成对当前行的处理后，将其打印为“ ok”） </p><br><p> 好吧，一个完整的代码示例： </p><br><pre> <code class="plaintext hljs">"Asm.fif" include -1 constant wc // create a wallet in workchain -1 (masterchain) // Create new simple wallet &lt;{ SETCP0 DUP IFNOTRET INC 32 THROWIF // return if recv_internal, fail unless recv_external 512 INT LDSLICEX DUP 32 PLDU // sign cs cnt c4 PUSHCTR CTOS 32 LDU 256 LDU ENDS // sign cs cnt cnt' pubk s1 s2 XCPU // sign cs cnt pubk cnt' cnt EQUAL 33 THROWIFNOT // ( seqno mismatch? ) s2 PUSH HASHSU // sign cs cnt pubk hash s0 s4 s4 XC2PU // pubk cs cnt hash sign pubk CHKSIGNU // pubk cs cnt ? 34 THROWIFNOT // signature mismatch ACCEPT SWAP 32 LDU NIP DUP SREFS IF:&lt;{ 8 LDU LDREF // pubk cnt mode msg cs s0 s2 XCHG SENDRAWMSG // pubk cnt cs ; ( message sent ) }&gt; ENDS INC NEWC 32 STU 256 STU ENDC c4 POPCTR }&gt;c // code &lt;b 0 32 u, newkeypair swap dup constant wallet_pk "new-wallet.pk" B&gt;file B, b&gt; // data // no libraries &lt;bb{00110} s, rot ref, swap ref, b&gt; // create StateInit dup ."StateInit: " &lt;s csr. cr dup hash dup constant wallet_addr ."new wallet address = " wc . .": " dup x. cr wc over 7 smca&gt;$ type cr 256 u&gt;B "new-wallet.addr" B&gt;file &lt;b 0 32 u, b&gt; dup ."signing message: " &lt;s csr. cr dup hash wallet_pk ed25519_sign_uint rot &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, b{000010} s, swap &lt;ss, b{0} s, swap B, swap &lt;ss, b&gt; dup ."External message for initialization is " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "new-wallet-query.boc" tuck B&gt;file ."(Saved to file " type .")" cr</code> </pre> <br><p> 这个看起来很吓人的文件旨在创建智能合约-执行后将放置在<code>new-wallet-query.boc</code> 。 请注意，这里使用了TON虚拟机的另一种汇编语言（我将不对其进行详细介绍），其说明将放在区块链上。 </p><br><p> 因此，TVM的汇编器用Fift编写-该汇编器的源代码在<code>crypto/fift/Asm.fif</code>文件中，并在上述代码的开头连接。 </p><br><p> 我可以说什么，显然，Nikolai Durov只喜欢创建新的编程语言:) </p><br><h2 id="sozdanie-smart-kontrakta-i-vzaimodeystvie-s-ton"> 创建智能合约并与TON交互 </h2><br><p> 因此，假设如上所述，我们将TON客户端和Fift解释器放在一起，并熟悉了该语言。 现在如何创建智能合约？ 在源附带的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">HOWTO</a>文件中对此进行了描述。 </p><br><h3 id="akkaunty-v-ton">  TON帐户 </h3><br><p> 正如我在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">TON评论</a>中<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">所述</a> ，该网络包含多个区块链-有一个常见的所谓的  “主链”，以及由32位数字标识的任意数量的其他“工作链”。 主链的标识符为-1，除此之外，还可以使用标识符为0的“基本”工作链​​，每个工作链可以具有自己的配置。 在内部，每个工作组都被分成多个分链，但这已经是实现的细节，不必牢记。 </p><br><p> 许多帐户存储在一个工作链中，它们具有自己的account_id标识符。 对于主链和零工作链，它们的长度为256位。 因此，帐户标识符的编写方式如下： </p><br><pre> <code class="plaintext hljs">-1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p> 这是一种“原始”格式：首先是工作链标识符，然后是冒号，以及以十六进制表示法的帐户标识符。 </p><br><p> 此外，还有一种缩短的格式-工作链号和帐户地址以二进制形式编码，向其添加校验和，所有这些都以Base64编码： </p><br><pre> <code class="plaintext hljs">Ef+BVndbeTJeXWLnQtm5bDC2UVpc0vH2TF2ksZPAPwcODSkb</code> </pre> <br><p> 了解了这种记录格式后，我们可以使用以下命令通过测试客户端请求帐户的当前状态： </p><br><pre> <code class="plaintext hljs">getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p> 我们得到这样的答案： </p><br><pre> <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> -client.cpp： <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code>为-1：8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D相对于块（-1,8000000000000000,72355）：F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296：1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F和 <code class="plaintext hljs">[ 3][t 2][1558746708.815218925][test-lite-client.cpp:631][!testnode] requesting account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D [ 3][t 2][1558746708.858564138][test-lite-client.cpp:652][!testnode] got account state for -1:8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D with respect to blocks (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F and (-1,8000000000000000,72355):F566005749C1B97F18EDE013EBA7A054B9014961BC1AD91F475B9082919A2296:1BD5DE54333164025EE39D389ECE2E93DA2871DA616D488253953E52B50DC03F account state is (account addr:(addr_std anycast:nothing workchain_id:-1 address:x8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D) storage_stat:(storage_info used:(storage_used cells:(var_uint len:1 value:3) bits:(var_uint len:2 value:539) public_cells:(var_uint len:0 value:0)) last_paid:0 due_payment:nothing) storage:(account_storage last_trans_lt:74208000003 balance:(currencies grams:(nanograms amount:(var_uint len:7 value:999928362430000)) other:(extra_currencies dict:hme_empty)) state:(account_active ( split_depth:nothing special:nothing code:(just value:(raw@^Cell x{} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} )) data:(just value:(raw@^Cell x{} x{0000000D} )) library:hme_empty)))) x{CFF8156775B79325E5D62E742D9B96C30B6515A5CD2F1F64C5DA4B193C03F070E0D2068086C000000000000000451C90E00DC0E35B7DB5FB8C134_} x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p> 我们看到了存储在指定工作链的DHT中的结构。 例如，在<code>storage.balance</code>字段中是当前帐户余额，在<code>storage.state.code</code>是智能合约代码，在<code>storage.state.data</code>是当前数据。 请注意，TON数据存储区-单元格，单元格-是一棵树，每个单元格可以拥有自己的数据以及子单元格。 这在最后几行中显示为缩进。 </p><br><h3 id="sborka-smart-kontrakta"> 智能合约组装 </h3><br><p> 现在，让我们使用Fift语言自己创建一个这样的结构（称为BOC- <em>cell of bag</em> ）。 幸运的是，您不必自己编写智能合约-源归档文件中的<code>crypto/block</code>文件夹中有一个<code>new-wallet.fif</code>文件，可帮助我们创建新的钱包。 将其复制到具有组装好的客户端的文件夹中（如果<code>~/liteclient-build</code>说明，则为<code>~/liteclient-build</code> ）。 我在上面引用了其内容作为Fift上的代码示例。 </p><br><p> 我们按以下方式执行此文件： </p><br><pre> <code class="plaintext hljs">./crypto/fift -I"&lt;source-directory&gt;/crypto/fift" new-wallet.fif</code> </pre> <br><p> 在这里， <code>&lt;source-directory&gt;</code>必须替换为已解压缩的源的路径（不幸的是，您需要完整的路径，此处不能使用符号“〜”）。 您可以定义<code>FIFTPATH</code>环境<code>FIFTPATH</code>并将此路径放入其中， <code>FIFTPATH</code>使用<code>-I</code> 。 </p><br><p> 自从我们以文件名<code>new-wallet.fif</code>启动Fift以来，它将执行并完成。 如果省略文件名，则可以在交互模式下使用解释器。 </p><br><p> 执行后，应在控制台中显示以下内容： </p><br><pre> <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> } <code class="plaintext hljs">StateInit: x{34_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} new wallet address = -1 : 4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ signing message: x{00000000} External message for initialization is x{89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001_} x{FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED54} x{0000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B} B5EE9C724104030100000000D60002CF89FEE120E20C7E953E31546F64C23CD654002C1AA919ADD24DB12DDF85C6F3B58AE41198A28AD8DAF3B9588E7A629252BA3DB88F030D00BC1016110B2073359EAC3C13823C53245B65D056F2C070B940CDA09789585935C7ABA4D2AD4BED139281CFA1200000001001020084FF0020DDA4F260810200D71820D70B1FED44D0D31FD3FFD15112BAF2A122F901541044F910F2A2F80001D31F3120D74A96D307D402FB00DED1A4C8CB1FCBFFC9ED5400480000000055375F730EDC2292E8CB15C42E8036EE9C25AA958EE002D2DE48A205E3A3426B6290698B (Saved to file new-wallet-query.boc)</code> </pre> <br><p> 这意味着标识符为<code>-1:4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code>的钱包<code>-1:4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> （或者就是<code>0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ</code>创建<code>0f9PzVILj8yglrVn1zS-NSjtxr7QBfaTCp7JrBqnFPIR8nhZ</code> 。 与之对应的代码将<code>new-wallet-query.boc</code>在<code>new-wallet-query.boc</code> ，其地址出现在<code>new-wallet.addr</code> ，私钥出现在<code>new-wallet.pk</code> （请注意-重新启动脚本将覆盖这些文件）。 </p><br><p> 当然，TON网络尚不知道此钱包，它仅以这些文件的形式存储。 现在，您需要将其上传到网络。 没错，问题是要创建智能合约，您需要支付佣金，而帐户余额仍为零。 </p><br><p> 在工作模式下，此问题将通过在交易所购买克（或通过从其他钱包进行转账）来解决。 好吧，在当前的测试模式下，已经建立了一种特殊的智能合约，您可以从中索取最多20克的重量。 </p><br><h3 id="formirovanie-zaprosa-k-chuzhomu-smart-kontraktu"> 形成对他人智能合约的请求 </h3><br><p> 要求一份智能合约，左右分配克，这样做。 在相同的<code>crypto/block</code>文件夹中，我们找到文件<code>testgiver.fif</code> ： </p><br><pre> <code class="plaintext hljs">// "testgiver.addr" file&gt;B 256 B&gt;u@ 0x8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d dup constant wallet_addr ."Test giver address = " x. cr 0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2 constant dest_addr -1 constant wc 0x00000011 constant seqno 1000000000 constant Gram { Gram swap */ } : Gram*/ 6.666 Gram*/ constant amount // bx --&gt; b' ( serializes a Gram amount ) { -1 { 1+ 2dup 8 * ufits } until rot over 4 u, -rot 8 * u, } : Gram, // create a message (NB: 01b00.., b = bounce) &lt;bb{010000100} s, wc 8 i, dest_addr 256 u, amount Gram, 0 9 64 32 + + 1+ 1+ u, "GIFT" $, b&gt; &lt;b seqno 32 u, 1 8 u, swap ref, b&gt; dup ."enveloping message: " &lt;s csr. cr &lt;bb{1000100} s, wc 8 i, wallet_addr 256 u, 0 Gram, b{00} s, swap &lt;ss, b&gt; dup ."resulting external message: " &lt;s csr. cr 2 boc+&gt;B dup Bx. cr "wallet-query.boc" B&gt;file</code> </pre> <br><p> 我们还将其保存在与已组装的客户端一起的文件夹中，但修复了第五行-在“ <code>constant dest_addr</code> ”行之前。 将其替换为之前创建的钱包地址（完整，不缩写）。  “ -1：”不需要在开头写，而是在开头写“ 0x”。 </p><br><p> 您还可以更改行<code>6.666 Gram*/ constant amount</code> -这是您要求的克量（不超过20）。 即使您指定整数，也要保留小数点。 </p><br><p> 最后，您需要更正行<code>0x00000011 constant seqno</code> 。 这里的第一个数字是当前的序列号，该序列号存储在发出克的帐户中。 从哪里得到的？ 如上所述，启动客户端并运行： </p><br><pre> <code class="plaintext hljs">last getaccount -1:8156775b79325e5d62e742d9b96c30b6515a5cd2f1f64c5da4b193c03f070e0d</code> </pre> <br><p> 最终，智能合约的数据将是 </p><br><pre> <code class="plaintext hljs">... x{FF0020DDA4F260D31F01ED44D0D31FD166BAF2A1F80001D307D4D1821804A817C80073FB0201FB00A4C8CB1FC9ED54} x{0000000D}</code> </pre> <br><p> 数字0000000D（您将拥有更多）是序列号，必须在<code>testgiver.fif</code>中<code>testgiver.fif</code> 。 </p><br><p> 就这样，保存文件并运行（ <code>./crypto/fift testgiver.fif</code> ）。 输出将是<code>wallet-query.boc</code> 。 这是给别人的智能合约的格式<em>消息</em> -请求是“将如此多的克转入这样的账户”。 </p><br><p> 使用客户端，我们将其上传到网络： </p><br><pre> <code class="plaintext hljs">&gt; sendfile wallet-query.boc [ 1][t 1][1558747399.456575155][test-lite-client.cpp:577][!testnode] sending query from file wallet-query.boc [ 3][t 2][1558747399.500236034][test-lite-client.cpp:587][!query] external message status is 1</code> </pre> <br><p> 如果现在我们呼叫<code>last</code> ，然后再次请求我们要克的帐户的状态，那么我们应该看到其序列号增加了一个-这意味着它向我们的帐户汇了款。 </p><br><p> 最后一步仍然是-我们加载钱包的代码（其余额已被补充，但是如果没有智能合约代码，我们将无法对其进行管理）。  <code>sendfile new-wallet-query.boc</code>就是这样，您在TON网络中拥有自己的钱包（尽管目前只有一个测试）。 </p><br><h3 id="sozdanie-ishodyaschih-tranzakciy"> 创建外向交易 </h3><br><p> 要从已创建帐户的余额中转移资金，有一个<code>crypto/block/wallet.fif</code> ，该<code>crypto/block/wallet.fif</code>也需要与收集到的客户一起放在文件夹中。 </p><br><p> 与前面的步骤类似，您需要更正转账金额，收件人的地址（dest_addr）和钱包的seqno（初始化钱包后为1，在每次付款交易后增加1-您可以通过请求帐户状态来查看它） 。 对于测试，您可以使用我的钱包<code>0x4fcd520b8fcca096b567d734be3528edc6bed005f6930a9ec9ac1aa714f211f2</code> 。 </p><br><p> 当您运行（ <code>./crypto/fift wallet.fif</code> ）时，脚本将从文件<code>new-wallet.addr</code>和<code>new-wallet.pk</code>中获取您的钱包地址（从中进行转移）和其私钥，并将接收到的消息写入<code>new-wallet-query.boc</code> 。 </p><br><p> 和以前一样，要直接执行事务，我们在客户端中调用<code>sendfile new-wallet-query.boc</code> 。 之后，不要忘记更新区块链的状态（ <code>last</code> ），并检查我们钱包的余额和seqno是否已更改（ <code>getaccount &lt;account_id&gt;</code> ）。 </p><br><p><img src="https://habrastorage.org/webt/fp/d1/is/fpd1is8dlh4_iz9rdbakflyeq5s.png" alt="帐户说明"></p><br><p> 就是这样，现在我们可以在TON中创建智能合约并将请求发送给他们。 如您所见，当前功能已经足够，例如，通过图形界面制作一个更友好的钱包（但是，预计它将作为Messenger的一部分提供）。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN453714/">https://habr.com/ru/post/zh-CN453714/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN453700/index.html">有关SDL 2的课程：第1课-您好，SDL 2</a></li>
<li><a href="../zh-CN453706/index.html">我如何通过Google Cloud Professional数据工程师认证考试</a></li>
<li><a href="../zh-CN453708/index.html">在BASCOM AVR环境中用于MK AVR的AQUA RTOS实时操作系统</a></li>
<li><a href="../zh-CN453710/index.html">大型项目的开发实践：mitp SberPractice iOS＃1</a></li>
<li><a href="../zh-CN453712/index.html">eBay如何在WebAssembly上进行条形码扫描仪</a></li>
<li><a href="../zh-CN453716/index.html">家庭IT人员的国家/地区合作-有人吗？</a></li>
<li><a href="../zh-CN453720/index.html">C＃中Lambda表达式的精妙之处</a></li>
<li><a href="../zh-CN453722/index.html">关于非平稳过程的研究</a></li>
<li><a href="../zh-CN453728/index.html">巨星之战</a></li>
<li><a href="../zh-CN453730/index.html">现代牙科：通过技术总监的眼睛同时进行牙齿植入和颌骨延伸</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>