<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÆ üí∫ üñ§ Especifica√ß√µes sobre ester√≥ides üîï üõ∏ üõ§Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O tema das abstra√ß√µes e todos os tipos de padr√µes encantadores √© um bom terreno para o desenvolvimento de hol√≠voros e disputas eternas: por um lado, s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Especifica√ß√µes sobre ester√≥ides</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/singularis/blog/485328/">  O tema das abstra√ß√µes e todos os tipos de padr√µes encantadores √© um bom terreno para o desenvolvimento de hol√≠voros e disputas eternas: por um lado, seguimos o mainstream, todos os tipos de palavras da moda e c√≥digos limpos, por outro lado, temos pr√°tica e realidade que sempre ditam suas pr√≥prias regras. <br><br>  O que fazer se as abstra√ß√µes come√ßarem a "vazar", como usar os chips de linguagem e o que voc√™ pode extrair do padr√£o de "especifica√ß√£o" - veja abaixo. <br><a name="habracut"></a><br>  Ent√£o, vamos ao que interessa.  O artigo conter√° as seguintes se√ß√µes: para iniciantes, examinaremos qual √© o padr√£o de ‚Äúespecifica√ß√£o‚Äù e por que sua aplica√ß√£o a amostras do banco de dados em sua forma pura causa dificuldades. <br><br>  Em seguida, voltamos √†s √°rvores de express√£o, que s√£o uma ferramenta muito poderosa, e vemos como elas podem nos ajudar. <br><br>  no final, demonstrarei minha implementa√ß√£o da "especifica√ß√£o" em ester√≥ides. <br><br>  Vamos come√ßar com as coisas b√°sicas.  Eu acho que todo mundo j√° ouviu falar sobre o padr√£o de "especifica√ß√£o", mas para quem n√£o ouviu, aqui est√° sua defini√ß√£o da <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D0%25BF%25D0%25B5%25D1%2586%25D0%25B8%25D1%2584%25D0%25B8%25D0%25BA%25D0%25B0%25D1%2586%25D0%25B8%25D1%258F_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">Wikipedia</a> : <br><br><blockquote>  Uma ‚Äúespecifica√ß√£o‚Äù na programa√ß√£o √© um padr√£o de design pelo qual a representa√ß√£o das regras da l√≥gica de neg√≥cios pode ser transformada em uma cadeia de objetos conectados por opera√ß√µes da l√≥gica booleana. <br><br>  Este modelo destaca essas especifica√ß√µes (regras) na l√≥gica de neg√≥cios que s√£o adequadas para o "acoplamento" com outras pessoas.  Um objeto de l√≥gica comercial herda sua funcionalidade da classe agregada abstrata CompositeSpecification, que cont√©m apenas um m√©todo IsSatisfiedBy que retorna um valor booleano.  Ap√≥s a instancia√ß√£o, o objeto √© encadeado com outros objetos.  Como resultado, sem perder a flexibilidade na configura√ß√£o da l√≥gica de neg√≥cios, podemos facilmente adicionar novas regras. </blockquote><br>  Em outras palavras, uma especifica√ß√£o √© um objeto que implementa a seguinte interface (descartando m√©todos para construir cadeias): <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> candidate</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br>  Tudo √© simples e claro aqui.  Mas agora vamos ver um exemplo do mundo real, no qual, al√©m do dom√≠nio, existe uma infraestrutura que tamb√©m √© uma pessoa cruel: vamos ao caso do uso do ORM, um DBMS e especifica√ß√µes para filtrar dados em um banco de dados. <br><br>  Para n√£o ser infundado e n√£o apontar o dedo, tomamos como exemplo a seguinte √°rea de assunto: suponha que estamos desenvolvendo MMORPGs, temos usu√°rios, cada usu√°rio tem 1 ou mais caracteres e cada caractere tem um conjunto de itens ( assumimos que os itens s√£o exclusivos para cada usu√°rio) e runas de melhoria podem ser aplicadas a cada um dos itens, por sua vez.  No total, na forma de um diagrama (consideraremos a classe ReadCharacter um pouco mais tarde, quando falarmos sobre consultas aninhadas): <br><br><img src="https://habrastorage.org/webt/k5/bx/iw/k5bxiwkvgl5vghoog71-9w6vqdo.png" alt="imagem"><br><br>  Esse modelo est√° pouco conectado ao mundo real e tamb√©m cont√©m campos que refletem alguma conex√£o com o ORM usado, mas isso ser√° suficiente para demonstrar o trabalho. <br><br>  Suponha que desejemos filtrar todos os caracteres criados ap√≥s a data especificada. <br>  Para fazer isso, escrevemos uma especifica√ß√£o do seguinte formul√°rio: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedAfter</span></span>: <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DateTime _target; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { _target = target; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsSatisfiedBy</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> candidate</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> character = candidate <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Character; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(character == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> character.CreatedAt &gt; target; } }</code> </pre><br>  Bem, ent√£o, para aplicar esta especifica√ß√£o, fazemos o seguinte (daqui em diante considerarei o c√≥digo baseado no NHibernate): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> characters = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> session.Query&lt;Character&gt;().ToListAsync(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> filter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newCharacters = characters.Where(x =&gt; filter.IsSatisfiedBy(x)).ToArray();</code> </pre><br>  Contanto que nossa base seja pequena, tudo funcionar√° lindamente e rapidamente, mas se nosso jogo se tornar mais ou menos popular e ganhar dezenas de milhares de usu√°rios, todo esse encanto consumir√° mem√≥ria, tempo e dinheiro, e √© melhor atirar nessa fera imediatamente porque  ele n√£o √© um inquilino.  Nesta triste nota, adiaremos a especifica√ß√£o e voltaremos um pouco √† minha pr√°tica. <br><br>  Era uma vez, em um projeto muito, muito distante, eu tinha classes no meu c√≥digo que continham l√≥gica para recuperar dados do banco de dados.  Eles pareciam algo assim: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ICharacterDal</span></span> { <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedBefore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime date</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;Character&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCharactersCreatedBetween</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">from</span></span></span></span><span class="hljs-function"><span class="hljs-params">, DateTime to</span></span></span><span class="hljs-function">)</span></span>; ... }</code> </pre><br>  e seu uso: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CharacterDal(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createdCharacters = dal.GetCharactersCreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre><br>  Dentro das classes havia a l√≥gica para trabalhar com o DBMS (na √©poca era o ADO.NET). <br><br>  Tudo parecia bom, mas com a expans√£o do projeto, essas classes tamb√©m cresceram, transformando-se em objetos de dif√≠cil manuten√ß√£o.  Al√©m disso, houve um sabor desagrad√°vel - parece ser uma regra de neg√≥cios, mas eles foram armazenados no n√≠vel da infraestrutura, porque estavam vinculados a uma implementa√ß√£o espec√≠fica. <br><br>  Essa abordagem foi substitu√≠da pelo reposit√≥rio <i>IQueryable &lt;T&gt;</i> , que permitiu levar todas as regras diretamente para a camada de dom√≠nio. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IRepository</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">IQueryable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">List</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T obj</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br>  que foi usado mais ou menos assim: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Repository(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> targetDate = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> createdUsers = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> repository.List().Where(x =&gt; x.CreatedAd &gt; targetDate).ToListAsync();</code> </pre><br>  Um pouco melhor, mas o problema √© que as regras se arrastam ao longo do c√≥digo, e a mesma verifica√ß√£o pode ocorrer em centenas de lugares, e √© f√°cil imaginar o que isso pode resultar na altera√ß√£o de requisitos. <br><br>  Essa abordagem oculta outro problema - se voc√™ n√£o materializar a consulta, ou seja, uma chance de realizar v√°rias consultas ao banco de dados, em vez de uma, o que, obviamente, afeta adversamente o desempenho do sistema. <br><br>  E aqui em um dos projetos, um colega sugeriu o uso de uma <a href="https://github.com/rjperes/DevelopmentWithADot.NHibernateSpecifications">biblioteca</a> que sugerisse a implementa√ß√£o do padr√£o de "especifica√ß√£o" com base em √°rvores de express√£o. <br><br>  Em resumo, com base nesta biblioteca, filmamos especifica√ß√µes que nos permitiram criar filtros para entidades e criar filtros mais complexos com base em concatena√ß√µes de regras simples.  Por exemplo, temos uma especifica√ß√£o para caracteres criados ap√≥s o novo ano e h√° uma especifica√ß√£o para escolher caracteres com um determinado item - ent√£o, combinando essas regras, podemos criar uma solicita√ß√£o para uma lista de caracteres criados ap√≥s o novo ano e com o item especificado.  E se, no futuro, alterarmos a regra para determinar novos caracteres (por exemplo, usaremos a data do ano novo chin√™s), a corrigiremos apenas na pr√≥pria especifica√ß√£o e n√£o ser√° necess√°rio procurar todos os usos dessa l√≥gica por c√≥digo! <br><br>  Este projeto foi conclu√≠do com √™xito e a experi√™ncia de usar essa abordagem foi muito bem-sucedida.  Mas eu n√£o queria ficar parado e houve alguns problemas na implementa√ß√£o, a saber: <br><br><ul><li>  operador de colagem OU n√£o funcionou; </li><li>  a uni√£o funciona apenas para consultas que cont√™m filtros do tipo Where, mas eu queria regras mais ricas (consultas aninhadas, ignorar / obter, obter proje√ß√µes); <br></li><li>  o c√≥digo de especifica√ß√£o dependia do ORM selecionado; </li><li>  n√£o foi poss√≠vel usar os recursos do ORM, pois  isso levou √† inclus√£o de depend√™ncias na camada de l√≥gica de neg√≥cios (por exemplo, era imposs√≠vel buscar). <br></li></ul><br>  O resultado da solu√ß√£o desses problemas foi a mini-estrutura <i>Singularis.Secification</i> , que consiste em v√°rias montagens: <br><br><ul><li>  Singularis.Specification.Definition - define o objeto de especifica√ß√£o e tamb√©m cont√©m a interface IQuery com a qual a regra √© formada. </li><li>  Singularis.Specification.Executor. * - implementa um reposit√≥rio e um objeto para executar especifica√ß√µes para ORMs espec√≠ficos (atualmente suportados pelo ef.core e NHibernate, como parte dos experimentos, tamb√©m fiz uma implementa√ß√£o para o mongodb, mas esse c√≥digo n√£o foi produzido). </li></ul><br>  Vamos dar uma olhada na implementa√ß√£o. <br><br>  A interface de especifica√ß√£o define a propriedade p√∫blica que a regra de especifica√ß√£o cont√©m: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { IQuery Query { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } Type ResultType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpefication</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt;: <span class="hljs-title"><span class="hljs-title">ISpecification</span></span> { }</code> </pre><br>  Al√©m disso, a interface cont√©m a propriedade <i>ResultType</i> , que retorna o tipo de entidade obtida como resultado da consulta. <br><br>  Sua implementa√ß√£o est√° contida na classe <i>Specification &lt;T&gt;</i> , que implementa a propriedade <i>ResultType</i> , calculando-a com base na regra armazenada no Query, al√©m de dois m√©todos: <i>Source ()</i> e <i>Source &lt;TSource&gt; ()</i> .  Esses m√©todos servem para formar a fonte da regra.  <i>Source ()</i> cria uma regra com um tipo que corresponde ao argumento da classe de especifica√ß√£o, e <i>Source &lt;TSource&gt; ()</i> permite criar uma regra para uma classe arbitr√°ria (usada ao gerar consultas aninhadas). <br><br>  Al√©m disso, h√° tamb√©m a classe <i>SpecificationExtension</i> , que cont√©m m√©todos de extens√£o para encadear solicita√ß√µes. <br><br>  Dois tipos de jun√ß√£o s√£o suportados: concatena√ß√£o (pode ser considerada como jun√ß√£o pela condi√ß√£o "AND") e jun√ß√£o pela condi√ß√£o "OR". <br><br>  Vamos voltar ao nosso exemplo e implementar nossas duas regras: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedAfter</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Character</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedAfter</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { Query = Source().Where(x =&gt; x.CreatedAt &gt; target); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreatedBefore</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Character</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreatedBefore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime target</span></span></span><span class="hljs-function">)</span></span> { Query = Source().Where(x =&gt; x.CreatedAt &lt; target); } }</code> </pre><br>  e encontre todos os usu√°rios que atendem √†s duas regras: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> specification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2019</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).Combine(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedBefore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = repository.List(specification);</code> </pre><br>  A combina√ß√£o com o m√©todo <i>Combine</i> suporta regras arbitr√°rias.  O principal √© que o tipo resultante do lado esquerdo coincide com o tipo de entrada do lado direito.  Assim, voc√™ pode criar regras contendo proje√ß√µes, pular / receber para pagina√ß√£o, regras de classifica√ß√£o, busca, etc. <br><br>  A regra Ou √© mais restritiva - suporta apenas cadeias que cont√™m condi√ß√µes de filtragem Where.  Considere o uso de um exemplo: encontramos todos os personagens criados antes de 2000 ou depois de 2020: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> specification = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedAfter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2020</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>).Or(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreatedBefore(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> users = repository.List(specification );</code> </pre><br>  A interface <i>IQuery</i> repete amplamente a interface <i>IQueryable</i> ; portanto, n√£o deve haver perguntas especiais.  Vamos nos concentrar apenas em m√©todos espec√≠ficos: <br><br>  <i>Buscar / ThenFetch</i> - permite incluir dados relacionados na consulta gerada para fins de otimiza√ß√£o.  √â claro que isso √© um pouco torto quando temos caracter√≠sticas da implementa√ß√£o da infraestrutura que afetam as regras de neg√≥cios, mas, como eu disse, a realidade √© abstra√ß√£o dura e pura - isso √© algo te√≥rico. <br><br>  <i>Onde</i> - o <i>IQuery</i> declara duas sobrecargas desse m√©todo, uma <i>utiliza</i> apenas uma express√£o lambda para filtrar na forma de <i>Express√£o &lt;Func &lt;T, bool &gt;&gt;</i> , e a segunda tamb√©m <i>utiliza</i> par√¢metros adicionais <i>IQueryContext</i> , que permitem executar subconsultas aninhadas.  Vejamos um exemplo. <br><br>  Temos a classe ReadCharacter no modelo - suponha que nosso modelo seja apresentado como uma parte de leitura que cont√©m dados desnormalizados e serve para feedback r√°pido e uma parte de grava√ß√£o que cont√©m links, dados normalizados etc.  Queremos exibir todos os caracteres para os quais o usu√°rio possui correio em um dom√≠nio espec√≠fico. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CharactersForUserWithEmailDomain</span></span>: <span class="hljs-title"><span class="hljs-title">Specification</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ReadCharacter</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CharactersForUserWithEmailDomain</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> domain</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> usersQuery = Source&lt;User&gt;(x =&gt; x.Email.Contains(domain)).Projection(x =&gt; x.Id); Query = Source().Where((x, ctx) =&gt; ctx.GetQueryResult&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(usersQuery).Contains(x.Id)); } }</code> </pre><br>  Como resultado da execu√ß√£o, a seguinte consulta sql ser√° gerada: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> readcharac0_.id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> id1_3_, readcharac0_.UserId <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> userid2_3_, readcharac0_.Name <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> name3_3_ <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ReadCharacters readcharac0_ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> readcharac0_.UserId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> user1_.Id <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Users</span></span> user1_ <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> user1_.Email <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> (<span class="hljs-string"><span class="hljs-string">'%'</span></span>+@p0+<span class="hljs-string"><span class="hljs-string">'%'</span></span>) ); @p0 = '@inmagna.ca' [Type: String (4000:0:0)]</code> </pre><br>  Para cumprir todas essas regras maravilhosas, √© <i>definida a</i> interface <i>IRepository</i> , que permite receber itens por identificador, receber um (o primeiro adequado) ou uma lista de objetos de acordo com a especifica√ß√£o e tamb√©m salvar e excluir itens do reposit√≥rio. <br>  Com a defini√ß√£o de consultas, descobrimos, agora resta ensinar a nossa ORM a entender isso. <br>  Para fazer isso, analisaremos a montagem do <i>Singularis.Infrastructure.NHibernate</i> (para ef.core tudo parece igual, apenas com as especificidades do ef.core). <br><br>  O ponto de acesso a dados √© o objeto Repository, que implementa a interface <i>IRepository</i> .  No caso de receber um objeto pelo identificador, bem como de modificar o armazenamento (salvar / excluir), essa classe encerra uma sess√£o e oculta uma implementa√ß√£o espec√≠fica da camada de neg√≥cios.  No caso de trabalhar com especifica√ß√µes, ele forma um objeto <i>IQueryable</i> que reflete nossa consulta em termos de <i>IQuery</i> e depois a executa no objeto de sess√£o. <br><br>  A principal m√°gica e o c√≥digo mais feio est√£o na classe respons√°vel pela convers√£o do <i>IQuery</i> para <i>IQueryable</i> - SpecificationExecutor.  Essa classe cont√©m muita reflex√£o, que chama m√©todos Queryable ou m√©todos de extens√£o de um ORM espec√≠fico (EagerFetchingExtensionsMethods for NHiberante). <br><br>  Essa biblioteca √© usada ativamente em nossos projetos (para ser honesto, uma biblioteca j√° atualizada √© usada para nossos projetos, mas gradualmente todas essas altera√ß√µes ser√£o definidas em dom√≠nio p√∫blico) est√° constantemente passando por altera√ß√µes.  Apenas algumas semanas atr√°s, a pr√≥xima vers√£o foi lan√ßada, que passou para m√©todos ass√≠ncronos, os bugs foram corrigidos no executor'e para ef.core, testes e amostras foram adicionados.  √â prov√°vel que a biblioteca contenha erros e centenas de lugares para otimiza√ß√£o - ela nasceu como um projeto paralelo no √¢mbito do trabalho nos principais projetos, por isso terei o prazer de sugerir sugest√µes de melhoria.  Al√©m disso, voc√™ n√£o deve se apressar em us√°-lo - √© prov√°vel que, no seu caso particular, isso seja desnecess√°rio ou inaplic√°vel. <br><br>  Quando vale a pena usar a solu√ß√£o descrita?  Provavelmente √© mais f√°cil come√ßar com a pergunta "quando n√£o deveria": <br><br><ul><li>  highload - se voc√™ precisar de alto desempenho, o uso do pr√≥prio ORM levanta uma quest√£o.  Embora, √© claro, ningu√©m pro√≠ba a implementa√ß√£o de um executor que traduza consultas para SQL e as execute ... </li><li>  projetos muito pequenos - isso √© muito subjetivo, mas, voc√™ deve admitir, puxar o ORM e todo o zool√≥gico que o acompanha para o projeto "lista de tarefas" parece disparar pardais de um canh√£o. </li></ul><br>  De qualquer forma, quem dominou a leitura at√© o fim - obrigado pelo seu tempo.  Espero feedback para o desenvolvimento futuro! <br><br>  Eu quase esqueci - o c√≥digo do projeto est√° dispon√≠vel no GitHub'e - <a href="https://github.com/SingularisLab/singularis.specification">https://github.com/SingularisLab/singularis.specification</a> <br><br><div class="spoiler">  <b class="spoiler_title">Assemblies est√£o dispon√≠veis para download via nuget</b> <div class="spoiler_text"><ul><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Definition/">https://www.nuget.org/packages/Singularis.Specification.Definition/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.EntityFramework/">https://www.nuget.org/packages/Singularis.Specification.Executor.EntityFramework/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.Common/">https://www.nuget.org/packages/Singularis.Specification.Executor.Common/</a> </li><li>  <a href="https://www.nuget.org/packages/Singularis.Specification.Executor.Nhibernate/">https://www.nuget.org/packages/Singularis.Specification.Executor.Nhibernate/</a> </li></ul></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485328/">https://habr.com/ru/post/pt485328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485316/index.html">Todas as SERPs do Google agora parecem an√∫ncios</a></li>
<li><a href="../pt485318/index.html">Adicionando beleza e interatividade aos notebooks Jupyter</a></li>
<li><a href="../pt485322/index.html">Fale sobre o PostgreSQL. Entrevista com Alexei Lesovsky no podcast Zinc Prod. Parte um</a></li>
<li><a href="../pt485324/index.html">Multithreading em Qt Widgets</a></li>
<li><a href="../pt485326/index.html">Criando Micro Frontends Usando Elementos Angulares: Guia para Iniciantes</a></li>
<li><a href="../pt485330/index.html">Como vencer aleatoriamente sem alma em jogos roguelike</a></li>
<li><a href="../pt485334/index.html">Enquete de sess√£o</a></li>
<li><a href="../pt485336/index.html">O que h√° na Universidade ITMO: palestras, workshops, concursos e entretenimento</a></li>
<li><a href="../pt485338/index.html">Como superar o medo e come√ßar a usar o Azure Machine Learning</a></li>
<li><a href="../pt485342/index.html">Como foi o ano de 2019 no campo da matem√°tica e da ci√™ncia da computa√ß√£o?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>