<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ∂ üìô üë©üèº‚Äçüíº D√©sol√©, j'ai cass√© votre recovery.conf üçØ üîè üö£üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans PostgreSQL depuis des temps tr√®s anciens d√©j√† la version 8.0 qui a √©t√© publi√©e en 2005, un fichier de configuration recovery.conf sp√©cial a √©t√© u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>D√©sol√©, j'ai cass√© votre recovery.conf</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432918/"><img src="https://habrastorage.org/webt/fa/rt/zs/fartzsjcnmws2vzxpx4qhiw5ykq.jpeg" alt="je vous casse la r√©cup√©ration" align="left">  Dans PostgreSQL depuis des temps tr√®s anciens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©j√† la version 8.0 qui a √©t√©</a> publi√©e en 2005, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">fichier de configuration recovery.conf</a> sp√©cial a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©t√©</a> utilis√© pour restaurer √† un moment pr√©cis.  Le m√™me fichier a ensuite commenc√© √† √™tre utilis√© pour le mode veille et la r√©plication en streaming. <br><br>  Cependant, depuis la prochaine version de PostgreSQL 12, recovery.conf ne fonctionnera plus: je l'ai cass√©. <br>  Mais pourquoi? <br><a name="habracut"></a><br>  Recovery.conf avait une caract√©ristique: il √©tait en lecture seule au d√©but du SGBD.  Et si la r√©cup√©ration ponctuelle, qui est n√©cessaire moins d'une fois par an, peut toujours √™tre r√©concili√©e, la n√©cessit√© de red√©marrer la base de donn√©es enti√®re pour modifier l'adresse du serveur de r√©plication en amont est quelque peu d√©primante.  J'ai vu diff√©rentes fa√ßons de perversions pour contourner cette restriction, comme l'utilisation du routage L3, des sch√©mas de r√©plication en cascade (de sorte que pas toutes les r√©pliques, mais au moins seulement une partie, respectivement) et m√™me (m√™me si je ne l'ai pas vu en production) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">walbouncer</a> . <br><br>  Apr√®s le prochain red√©marrage planifi√© des r√©pliques, juste en raison de la n√©cessit√© de modifier les param√®tres de r√©plication, j'ai d√©cid√© de le r√©cup√©rer, mais combien cela co√ªterait-il d'apprendre √† PostgreSQL √† relire primary_conninfo dans SIGHUP?  <s>Tout s'est mal pass√©.</s>  En principe, vous devez modifier une seule variable dans le processus de d√©marrage et √† partir de l√† demander un red√©marrage de WalReceiver - et c'est tout, la r√©plication se poursuivra correctement avec la nouvelle adresse.  Reste √† l'impl√©menter correctement.  Quelques semaines plus tard, j'ai termin√© le correctif avec l'impl√©mentation de la relecture de recovery.conf sur le signal SIGHUP, alors que ce correctif n'a pas bris√© le comportement de la base de donn√©es existante. <br><br>  Puis, ayant le courage, l' <a href="">envoya</a> sur la liste de diffusion des d√©veloppeurs PostgreSQL.  Ce que Michael Paquier a r√©pondu assez rapidement: <br><blockquote>  Avant de rendre certains d'entre eux rechargeables, changeons-les d'abord en GUC et ne r√©inventons pas la gestion SIGHUP des param√®tres comme le fait votre patch. </blockquote>  Oups, il s'est av√©r√© que j'ai pos√© la mauvaise question au moteur de recherche.  La question n'√©tait pas de relire recovery.conf, mais de convertir les param√®tres d'un recovery.conf s√©par√© en infrastructure GUC (grande configuration unifi√©e) utilis√©e pour tous les autres param√®tres du SGBD.  C'est-√†-dire, certainement pas, nous n'avons pas besoin d'un tel patch, nous n'en voulons pas.  Commen√ßons par transf√©rer tous ces param√®tres de recovery.conf vers notre infrastructure de param√®tres standard. <br><br>  Sur cette sombre nouvelle, j'ai br√ªl√© et pens√©: "Mais transf√©rons!".  J'ai lu les discussions archiv√©es sur la requ√™te de recherche correcte, ouvert la derni√®re <a href="">discussion</a> trouv√©e <a href="">sur le transfert des param√®tres</a> (le lien a √©t√© aimablement fourni par Michael Paquier dans sa r√©ponse, pour laquelle je le remercie s√©par√©ment, ainsi que pour la r√©ponse rapide).  √Ä cette √©poque, en mai 2018, le patch a √©t√© abandonn√© pendant plus d'un an.  Donc, nous commen√ßons ici.  Ou est-il plus correct de dire ¬´continuer¬ª?  Selon le plan de divertissement: <br><br><ol><li>  lire et r√©pertorier les modifications apport√©es √† la derni√®re version publi√©e du correctif </li><li>  analyser les modifications dans le patch et transf√©rer le n√©cessaire dans la version actuelle de la base de code </li><li>  corriger toutes les r√©f√©rences √† recovery.conf et ses param√®tres dans la documentation </li><li>  tests de r√©paration </li><li>  envoyer un nouveau patch √† la liste de diffusion </li><li>  obtenir des commentaires </li><li>  corriger quelque chose selon les souhaits et revenir au paragraphe 5 </li><li>  recevoir un refus d'accepter √† nouveau le patch (dans un an et demi) </li></ol><br>  Cela ressemble √† un plan d'action?  Eh bien, c'est parti! <br><br>  Combien de temps, bri√®vement, je suis arriv√© au point cinq et le 21 juin 2018, j'ai publi√© une nouvelle version du patch <a href="">dans un nouveau fil de discussion</a> .  Puis 3 mois dans le silence oppressant du silence effrayant du poisson Baskerville.  Fin septembre, Peter Eisentraut, l'un des d√©veloppeurs Core ayant le droit de s'engager, a soudainement montr√© de l'int√©r√™t pour le patch.  Apr√®s plusieurs it√©rations de corrections, alors que je m'√©loignais tranquillement pendant quelques jours pour faire un tour √† Budapest et voir les sites touristiques, une lettre d√©courageante de Peter Eisentraut arrive: <br><blockquote>  J'ai parcouru le patch et fait un tas de petits raffinements.  J'ai √©galement mis √† jour la documentation de mani√®re plus approfondie.  Le patch ci-joint est valable pour moi. </blockquote>  C'est-√†-dire que Peter Eisentraut a corrig√© quelques petites choses √† sa discr√©tion, a mis √† jour la documentation, a br√ªl√© toute la section recovery-config.sgml et pense que sous cette forme, le correctif peut d√©j√† √™tre accept√©.  Oh, et je pensais que cela ne se produirait que pour postgresql 13, m√™me s'il est si chanceux que le patch atteigne g√©n√©ralement un √©tat de pr√©paration pour la validation. <br><br>  Et quelques jours plus tard, √† savoir le 25 novembre de ce 2018, Peter Eisentraut <a href="">accepte</a> vraiment <a href="">ce patch</a> : <br><blockquote>  Les param√®tres recovery.conf sont d√©sormais d√©finis dans postgresql.conf (ou dans d'autres sources GUC).  Actuellement, tous les param√®tres affect√©s sont PGC_POSTMASTER;  cela pourrait √™tre affin√© dans le futur au cas par cas. <br>  La r√©cup√©ration est maintenant lanc√©e par un fichier recovery.signal.  Le mode veille est initi√© par un fichier standby.signal.  Le param√®tre standby_mode a disparu.  Si un fichier recovery.conf est trouv√©, une erreur est g√©n√©r√©e. <br>  Le param√®tre trigger_file a √©t√© renomm√© pour promouvoir_fichier_trigger dans le cadre du d√©placement. <br>  Le chapitre de documentation "Configuration de r√©cup√©ration" a √©t√© int√©gr√© dans "Configuration du serveur". <br>  pg_basebackup -R ajoute maintenant les param√®tres √† postgresql.auto.conf et cr√©e un fichier standby.signal. <br>  Auteur: Fujii Masao &lt;masao (dot) fujii (at) gmail (dot) com&gt; <br>  Auteur: Simon Riggs &lt;simon (at) 2ndquadrant (dot) com&gt; <br>  Auteur: Abhijit Menon-Sen &lt;ams (at) 2ndquadrant (dot) com&gt; <br>  Auteur: Sergei Kornilov &lt;sk (at) zsrv (dot) org&gt; </blockquote>  Deux semaines se sont √©coul√©es et cet engagement n'a pas √©t√© annul√©.  Incroyable  Et il semble qu'ils ne le feront m√™me pas.  C‚Äôest incroyable.  On ne sait pas si la communaut√© d√©cidera de modifier √† nouveau le comportement dans n'importe quelle direction, d'autant plus qu'il reste encore un peu de temps avant la sortie du gel des fonctionnalit√©s de postgresql 12 en avril.  Mais il semble que nous n'aurons plus de recovery.conf. <br><br><h3>  Alors qu'est-ce qui a chang√© </h3><br>  D'abord et avant tout, le SGBD refusera de d√©marrer s'il trouve un fichier recovery.conf - cela a √©t√© fait sp√©cifiquement pour que l'utilisateur, en utilisant l'une des nombreuses anciennes instructions, ne soit pas surpris que la base de donn√©es ignore la configuration de ce fichier. <br><br>  L'ancien param√®tre standby_mode a disparu.  Maintenant, il, ainsi que le fait m√™me de l'existence de recovery.conf pour activer le mode de r√©cup√©ration, est remplac√© par deux fichiers (de tout contenu, g√©n√©ralement vide): <br><br><ul><li>  $ PGDATA / recovery.signal - successeur id√©ologique standby_mode = off, la restauration √† partir de l'archive sera effectu√©e au point sp√©cifi√© dans les configurations; </li><li>  $ PGDATA / standby.signal - respectivement, standby_mode = on.  Nous verrons ce fichier sur toutes les r√©pliques. </li></ul><br>  Si le processus de d√©marrage de la base de donn√©es a trouv√© les deux fichiers, nous consid√©rons que nous sommes en mode veille. <br><br>  Si, pour plus de clart√©, pour r√©duire les changements de param√®tres sur une plaque: <br><table><tbody><tr><th>  ancien recovery.conf <br></th><th>  PostgreSQL 12+ postgresql.conf <br></th></tr><tr><td>  primary_conninfo <br></td><td>  primary_conninfo <br></td></tr><tr><td>  primary_slot_name <br></td><td>  primary_slot_name <br></td></tr><tr><td>  trigger_file <br></td><td>  Promote_trigger_file <br></td></tr><tr><td>  recovery_min_apply_delay <br></td><td>  recovery_min_apply_delay <br></td></tr><tr><td>  recovery_target <br></td><td>  recovery_target <br></td></tr><tr><td>  recovery_target_name <br></td><td>  recovery_target_name <br></td></tr><tr><td>  recovery_target_time <br></td><td>  recovery_target_time <br></td></tr><tr><td>  recovery_target_xid <br></td><td>  recovery_target_xid <br></td></tr><tr><td>  recovery_target_lsn <br></td><td>  recovery_target_lsn <br></td></tr><tr><td>  recovery_target_inclusive <br></td><td>  recovery_target_inclusive <br></td></tr><tr><td>  recovery_target_timeline <br></td><td>  recovery_target_timeline <br></td></tr><tr><td>  recovery_target_action <br></td><td>  recovery_target_action <br></td></tr><tr><td>  restore_command <br></td><td>  restore_command <br></td></tr><tr><td>  archive_cleanup_command <br></td><td>  archive_cleanup_command <br></td></tr><tr><td>  recovery_end_command <br></td><td>  recovery_end_command <br></td></tr></tbody></table><br>  Vous pouvez voir qu'un peu moins que rien n'a √©t√© chang√©.  Pour le moment (√† la seule exception du pr√©fixe de promotion_ pour le fichier de promotion_fichier), tous les nouveaux param√®tres sont nomm√©s comme les anciens et prennent les m√™mes valeurs possibles.  Bien qu'en fait il y ait encore un changement concernant les param√®tres de la cible de r√©cup√©ration.  Je ne sais pas si quelqu'un l'a utilis√© auparavant, mais c'√©tait un comportement document√© et il √©tait possible de sp√©cifier plusieurs recovery_target, recovery_target_lsn, recovery_target_name, recovery_target_time ou recovery_target_xid en m√™me temps.  Par exemple <br><br><pre><code class="plaintext hljs">recovery_target_lsn = '1/1D9FEA00' recovery_target_xid = '5238954'</code> </pre> <br>  La derni√®re ligne de recovery.conf a √©t√© utilis√©e pour la r√©cup√©ration.  Ce n'est plus possible, l'objectif de r√©cup√©ration doit √™tre indiqu√© au maximum par un.  Cependant, en raison de la logique de l'infrastructure GUC, vous pouvez toujours sp√©cifier le param√®tre du m√™me nom plusieurs fois: <br><br><pre> <code class="plaintext hljs">recovery_target_lsn = '1/1D9FEA00' recovery_target_lsn = '1/16AC7D0'</code> </pre> <br>  Ceci est acceptable, nous reviendrons √† la valeur des param√®tres sp√©cifi√©e en dernier. <br><br>  Et, en g√©n√©ral, c'est tout ce qu'il faut dire sur les changements visibles depuis l'ext√©rieur de PostgreSQL.  pg_basebackup -R (--write-recovery-conf) est rest√© √† sa place et fait ce √† quoi il est destin√©, seulement maintenant il ajoutera des param√®tres √† postgresql.auto.conf au lieu de recovery.conf et cr√©era un fichier standby.signal <br><br>  Malheureusement, quand je dis que ce sont tous les changements qui sont actuellement visibles, c'est exactement ce que je veux dire.  Tous les nouveaux param√®tres sont toujours d√©finis comme PGC_POSTMASTER, c'est-√†-dire qu'ils ne peuvent √™tre modifi√©s qu'au d√©marrage de PostgreSQL.  Comme d√©j√† mentionn√©, c'√©tait une exigence de la part de la communaut√© des d√©veloppeurs: tout d'abord, transf√©rez tous les param√®tres, puis voyez s'ils peuvent √™tre modifi√©s sur la base de donn√©es en cours d'ex√©cution.  Alors maintenant, PostgreSQL est dans une merveilleuse phase de d√©veloppement, lorsque l'ancien comportement a d√©j√† √©t√© rompu et que des changements pour le mieux n'ont pas encore √©t√© apport√©s. <br><br>  J'ai d√©j√† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">publi√© un patch</a> qui permettra de changer √† la vol√©e primary_conninfo et primary_slot_name.  Voyons ce qui se passe. <br><br>  D√©sol√©, j'ai cass√© votre recovery.conf <br><br><h3>  UPD 7 avril 2019 </h3><br>  Au cours de la derni√®re journ√©e avant le gel des fonctionnalit√©s de la version 12, vous pouvez r√©sumer.  La modification des param√®tres de r√©plication n'√©tait pas incluse dans la version.  Bien s√ªr, c'est aussi une histoire curieuse.  Il √©tait une fois, le patch Simon Riggs que je prenais comme base contenait d√©j√† des modifications pour red√©marrer walreceiver lors de la modification des param√®tres de connexion.  Je les ai s√©lectionn√©s dans un correctif distinct compl√©tant la documentation et les tests.  Et apr√®s 6 mises √† jour de correctifs et quelques mois de discussion, le fait √©vident appara√Æt que si vous red√©marrez walreceiver, la base de donn√©es essaiera de basculer vers la restauration des fichiers √† partir de restore_command.  Un comportement de machine d'√©tat tout √† fait simple, d√©clench√© par l'arr√™t de Walreceiver pour une raison quelconque.  Mais cela s'av√®re √™tre ¬´quelque chose que nous ne voulons pas¬ª.  Eh bien, plus t√¥t, c'√©tait impossible √† dire?  Ok, je l'ai refait d'une mani√®re ou d'une autre, mais le calendrier avait d√©j√† le commitfest final pour la version 12 et personne n'a regard√© ici.  En g√©n√©ral, ce n'est pas une chose rapide, comme le font les correctifs dans PostgreSQL.  Mais j'ai tout √† fait le droit de m'inclure dans la liste des personnes, gr√¢ce √† qui le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">REINDEX</a> le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plus √©pique inachev√© et inachev√© A √âT√â CONCURRENT√âMENT</a> inclus dans la version 12! <br><br>  Il convient de mentionner √† la fin qu'un certain nombre de param√®tres ont <a href="">la possibilit√©</a> de changer √† la vol√©e: archive_cleanup_command, promotion_trigger_file, recovery_end_command, recovery_min_apply_delay </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr432918/">https://habr.com/ru/post/fr432918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr432906/index.html">Modification des fichiers CSV pour ne pas casser les donn√©es</a></li>
<li><a href="../fr432908/index.html">En Russie, ils pr√©voient d'introduire un contr√¥le suppl√©mentaire sur les paiements sur Internet</a></li>
<li><a href="../fr432910/index.html">Il est dangereux de consid√©rer la r√©alit√© virtuelle comme une machine d'empathie</a></li>
<li><a href="../fr432912/index.html">Comment obtenir un stage chez Google</a></li>
<li><a href="../fr432914/index.html">Un bot de chat tr√®s simple pour Telegram pour les plus petits</a></li>
<li><a href="../fr432920/index.html">Le facteur humain dans l'entreprise: est-ce dangereux?</a></li>
<li><a href="../fr432922/index.html">Comment nous avons chass√© pendant deux semaines le bogue NFS dans le noyau Linux</a></li>
<li><a href="../fr432924/index.html">Run, Gecko, run: un m√©canisme de mouvement de l'eau hybride gecko</a></li>
<li><a href="../fr432926/index.html">24 recettes sur la fa√ßon dont une startup peut r√©ussir dans une grande exposition mondiale, en utilisant le Web Summit 2018 comme exemple</a></li>
<li><a href="../fr432928/index.html">Ce qui se passe chez Intel et pourquoi Amazon ne transf√®rera pas enti√®rement AWS sur ses puces malgr√© les gros titres</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>