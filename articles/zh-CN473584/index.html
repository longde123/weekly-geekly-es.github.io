<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍆 👋🏾 🤶🏻 基于Ubuntu 18.04和透明Squid在学校进行内容过滤，并且不仅集成到MikroTik上的网络中 👨🏽‍🎨 🤷🏼 🚵🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1.简介 
 学校中的内容过滤这一主题颇具技巧性，并充满了信息，但是由于许多站点向安全HTTPS协议的过渡，该内容已经过时了，大多数提议的解决方案都无法使用该协议。 因此，我决定写从A到Z的最完整的文章，收集我在Google扩展中发现的所有信息。 本文专为管理领域的基础知识而设计，适合计算机科学教师...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>基于Ubuntu 18.04和透明Squid在学校进行内容过滤，并且不仅集成到MikroTik上的网络中</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473584/"><img src="https://habrastorage.org/webt/sl/bc/ta/slbctarcmoniq1q3aotimy8oiv8.jpeg"><br><br><h3>  1.简介 </h3><br> 学校中的内容过滤这一主题颇具技巧性，并充满了信息，但是由于许多站点向安全HTTPS协议的过渡，该内容已经过时了，大多数提议的解决方案都无法使用该协议。 因此，我决定写从A到Z的最完整的文章，收集我在Google扩展中发现的所有信息。 本文专为管理领域的基础知识而设计，适合计算机科学教师使用。 <br><br><h3>  2.职权范围 </h3><br>  <b>给定的：</b> 436-FZ和一所学校，其中许多计算机通过MikroTik路由器或任何其他路由器进行联网并连接到Internet。 <br><br>  <b>目标：</b>通过白名单对除您心爱的学校管理人员之外的所有人进行HTTP和HTTPS内容过滤。 <br><a name="habracut"></a><br><br><h3>  3.解决问题 </h3><br> 发现未使用的台式计算机具有双核Intel-ohm，1 GB RAM和80 GB硬磁盘。 <br> 为了解决这个问题，将执行以下操作： <br><br><ol><li> 已安装Linux Ubuntu Server 18.04 LTS </li><li> 透明代理Squid已在服务器上安装和配置，并通过具有HTTPS支持的源代码进行编译。 </li><li> 通过将请求重定向到Proxy或其他选项（最后），将服务器集成到子网中 </li></ol><br> 让我们开始吧。 <br><br><h4>  3.1。 安装和配置Ubuntu 18.04 </h4><br> 安装过程很简单。 从官方站点下载Ubuntu Server 18.04发行版。 我建议使用旧的安装程序进行下载，因为新的安装程序（是我本人亲自安装的）在安装过程中会无休止地下载。 我们以任何方便的方式将图像写入USB闪存驱动器/磁盘。 对于在USB闪存驱动器上进行录制，我建议使用Rufus，并在录制开始时选择“录制DD图像”。 接下来，按照屏幕上的信息，安装系统。 我们只讨论组件的选择，您可以在其中立即选择OpenSSH就是这样。 我们不需要太多，但是我们需要安装所需的东西。 <br><br> 因此，已安装Ubuntu。 如果您有DHCP，则网络已配置。 我们将进入超级用户模式，这样每次我们都不会在命令中添加sudo。 <br><br><pre><code class="javascript hljs">sudo -s</code> </pre> <br> 输入密码并更新系统。 <br><br><pre> <code class="javascript hljs">apt-get update apt-get upgrade</code> </pre> <br> 安装文本编辑器和文件管理器。 <br><br><pre> <code class="javascript hljs">apt-get install nano mc</code> </pre> <br> 要将文件保存在<i><b>nano中</b></i> ，必须按<i>Ctrl + O，</i>然后按<i>Y。</i> 按下<i>Ctrl + X</i>退出编辑器<i>。</i> 您可以在退出前按<i>Ctrl + X，</i>然后按<i>Y</i> ，以立即保存文件。 <br> 要打开文件管理器，请输入<i><b>mc</b></i> 。 典型的NortonCommander DOS或Windows TotalCommander / FAR带有两个面板。 尽管我习惯于使用控制台，但文件管理器有时还可以帮助例如更快地找到所需的文件。 <br><br> 如果您没有DHCP或想要一个服务器的单独IP地址（如我所愿），那么我们将继续进行配置。 <br><br><div class="spoiler">  <b class="spoiler_title">配置静态IP地址</b> <div class="spoiler_text"> 与以前版本的Ubuntu不同，在新的18.04中，不再在通常的<i>/ etc / network / interfaces中</i>配置<i>网络</i> ，而是通过<i><b>/etc/netplan/*.yaml</b></i>文件中的<i><b>netplan进行配置</b></i> 。 该文件的名称可能不同，但仅此名称而已。  / etc / network / interfaces本身给我们写了以下内容： <br><br><img src="https://habrastorage.org/webt/ye/m5/xr/yem5xrromrmumjbg5gcjyb_qkte.jpeg"><br><br> 另外，如果您想从18.04之前的版本升级，网络设置将保持原样。  Netplan仅与18.04的全新安装有关。 <br><br> 让我们开始建立网络。 <br><br> 首先，让我们看一下分配给OS的网络接口的名称，并记住它。 <br><br><pre> <code class="javascript hljs">ifconfig</code> </pre> <br> 现在打开设置文件。 <br><br><pre> <code class="javascript hljs">nano /etc/netplan<span class="hljs-comment"><span class="hljs-comment">/*.yaml</span></span></code> </pre> <br> 它应该已经有一个DHCP设置。 让我们将文件转换为以下格式。 <br><br><pre> <code class="javascript hljs"># This file describes the network interfaces available on your system # For more information, see netplan(<span class="hljs-number"><span class="hljs-number">5</span></span>). network: version: <span class="hljs-number"><span class="hljs-number">2</span></span> renderer: networkd ethernets:   : dhcp4: no dhcp6: no addresses: [/<span class="hljs-number"><span class="hljs-number">24</span></span>] gateway4:  nameservers: addresses: [<span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span>, <span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>]</code> </pre><br> 输入您的界面，地址和网关。  DNS建议不要使用这些内容-Yandex.DNS Children将作为附加保护。 在我的路由器中配置了相同的DNS。 无论如何，您都必须指定路由器分发的DNS。 <br><br> 在这里，您需要注意空格（即空格，而不是制表符）。 每个段落都与前一个空格分开。 例如，如果在名称服务器之后地址行不是由空格隔开，而是与上面的行对齐，那么当您尝试应用设置时，netplan将给出错误。 <br><br> 应用设置。 <br><br><pre> <code class="javascript hljs">netplan apply</code> </pre> <br> 重新启动服务器，以防万一。 <br><br><pre> <code class="javascript hljs">reboot</code> </pre> <br></div></div><br> 此外，如果netplan不适合，他还为DHCP和静态IP添加了备用网络配置选项。 <br><div class="spoiler">  <b class="spoiler_title">备用网络设置</b> <div class="spoiler_text"> 在Ubuntu 18.04中，您可以通过<i>/ etc / network / interfaces</i>返回熟悉的网络配置选项。 为此，文件本身指示您需要安装<i>ifupdown</i>实用程序。 安装它： <br><pre> <code class="javascript hljs">apt-get install ifupdown</code> </pre> <br> 现在在netplan中打开初始设置文件 <br><pre> <code class="javascript hljs">nano /etc/netplan<span class="hljs-comment"><span class="hljs-comment">/*.yaml</span></span></code> </pre> <br> 并注释掉其所有内容，以免发生冲突。 <br> 接下来，打开网络设置文件 <br><pre> <code class="javascript hljs">nano /etc/network/interfaces</code> </pre> <br> 并添加到它： <br> 用于静态IP <br><pre> <code class="javascript hljs">auto ___ iface ___ inet <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> address IP- netmask  gateway  dns-nameservers <span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.7</span></span> <span class="hljs-number"><span class="hljs-number">77.88</span></span><span class="hljs-number"><span class="hljs-number">.8</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span></code> </pre> <br> 用于动态（DHCP） <br><pre> <code class="javascript hljs">auto ___ iface ___ inet dhcp</code> </pre> <br> 重新启动服务器 <br><pre> <code class="javascript hljs">reboot</code> </pre> <br> 如果您将此选项用于网络设置，则可以在“防火墙”设置中完全选择退出Webmin，并使用扰流板下的配置选项（尽管带有Webmin的变体也可以使用） <br></div></div><br><br> 现在，您需要启用通过我们服务器的数据包传递。 打开文件<i>/etc/sysctl.conf</i> <br><pre> <code class="javascript hljs">nano /etc/sysctl.conf</code> </pre> <br> 我们在其中<i><b>寻找</b></i>字符串<i><b>net.ipv4.ip_forward = 1</b></i>并取消注释。 如果值为<i>0</i> ，则更改为<i>1</i> 。 <br> 输入命令以应用设置 <br><pre> <code class="javascript hljs">sysctl -p /etc/sysctl.conf</code> </pre> <br><br> 设置网络后，建议您直接进入终端并继续操作。 为此，如果在安装阶段未选择OpenSSH，请安装它。 <br><br><pre> <code class="javascript hljs">apt-get install ssh</code> </pre> <br> 默认情况下，SSH已经配置为在端口22上用于用户/密码登录，但是您可以通过（例如）授权密钥和其他端口为自己配置SSH，以保护服务器免受外部攻击。 如何做到这一点充满了Internet上的信息。 <br><br> 作为终端，我使用XShell。 您可以使用自己喜欢的一种。 <br><br> 我们不需要DHCP服务器和第二个网卡，因为我们将使用路由器本身将用户请求重定向到代理。 <br><br> 奠定基础。 现在，让我们继续安装和配置Squid。 <br><br><h4>  3.2。 使用HTTPS支持和列表过滤安装和配置Squid </h4><br>  <b>3.2.1。</b>  <b>编译并安装Squid</b> <br><br> 由于在存储库中没有现成的具有SSL支持的Squid软件包，因此您将不得不从源代码中手动组装它。 首先，使用存储库打开文件。 <br><br><pre> <code class="javascript hljs">nano /etc/apt/sources.list</code> </pre> <br> 在其中，我们取消注释（在开头删除＃）以<i><b>deb-src</b></i>开头的行。 <br><br> 之后，我们将更新软件包。 <br><br><pre> <code class="javascript hljs">apt-get update</code> </pre> <br> 接下来，安装组装工具。 <br><br><pre> <code class="javascript hljs">apt-get install fakeroot build-essential devscripts</code> </pre> <br> 并添加所有必需的程序包。 <br><br><pre> <code class="javascript hljs">apt-get build-dep squid3</code> </pre> <br> 安装该库以获得SSL支持。 <br><br><pre> <code class="javascript hljs">apt-get install libssl1<span class="hljs-number"><span class="hljs-number">.0</span></span>-dev</code> </pre> <br> 让我们转到主文件夹并为程序集创建一个文件夹，立即为其设置必要的权限。 <br><br><pre> <code class="javascript hljs">cd ~ mkdir build chown _apt:root build</code> </pre> <br> 转到创建的文件夹并下载Squid源。 <br><br><pre> <code class="javascript hljs">cd build apt-get source squid3</code> </pre> <br> 一个文件夹将出现在构建文件夹中，名称为squid3和发行版号。 在Ubuntu 18.04.3上为3.5.27。 让我们开始吧。 <br><br><pre> <code class="javascript hljs">cd squid3<span class="hljs-number"><span class="hljs-number">-3.5</span></span><span class="hljs-number"><span class="hljs-number">.27</span></span></code> </pre> <br> 组装之前，必须指定选项。 与他们一起打开文件。 <br><br><pre> <code class="javascript hljs">nano debian/rules</code> </pre> <br> 我们正在寻找选项列表，如图所示 <br><br><img src="https://habrastorage.org/webt/w3/1a/xn/w31axng0b2nuqhjipuqc84sey78.jpeg"><br> 添加以下选项。 <br><br><pre> <code class="javascript hljs">--enable-ssl \ --enable-ssl-crtd \ --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-openssl</code> </pre> <br> 请注意，图片中已经添加了选项，并且<b>除最后</b>一行<b>外，</b>选项中的每行之后均应出现<b>“ \”</b>字符。 <br><br> 因此，一切准备就绪。 现在让我们继续进入Squid源文件夹，尽管您应该已经在其中了。 <br><br><pre> <code class="javascript hljs">cd ~<span class="hljs-regexp"><span class="hljs-regexp">/build/</span></span>squid3<span class="hljs-number"><span class="hljs-number">-3.5</span></span><span class="hljs-number"><span class="hljs-number">.27</span></span></code> </pre> <br> 并输入要构建的命令。 <br><br><pre> <code class="javascript hljs">debuild -d</code> </pre> <br> 组装将花费很长时间，平均花了我2到4个小时。 取决于计算机的速度。 在程序集的末尾，您将看到程序包签名错误。 这是正常现象-忽略该错误。 <br><br> 现在转到Build文件夹。 <br><br><pre> <code class="javascript hljs">cd ~<span class="hljs-regexp"><span class="hljs-regexp">/build</span></span></code> </pre> <br> 并安装Squid。 <br><br><pre> <code class="javascript hljs">dpkg -i squid*.deb</code> </pre> <br> 立即遇到关于不满足的依赖关系的错误，并输入命令 <br><br><pre> <code class="javascript hljs">apt-get install -f</code> </pre> <br> 安装后，我们会标记软件包，以使它们在更新系统后不会被覆盖。 <br><br><pre> <code class="javascript hljs">apt-mark hold squid apt-mark hold squid-common apt-mark hold squidclient</code> </pre> <br>  <b>3.2.2。</b>  <b>配置鱿鱼和过滤</b> <br><br> 因此，已经安装了Squid，仍然可以根据需要配置它。 <br><br> 所有设置都在<i><b>/etc/squid/squid.conf</b></i>文件中。 它包含许多评论，乍一看似乎很复杂，但实际上没有什么超级复杂的。 首先，如果您突然想更详细地研究它，我们将通过首先复制原件将其从注释中清除。 为了方便起见，我们将直接转到带有Squid的文件夹。 <br><br><pre> <code class="javascript hljs">cd /etc/squid cp squid.conf squid.conf.backup cat squid.conf.backup | egrep <span class="hljs-string"><span class="hljs-string">"^[^#]"</span></span> &gt; squid.conf</code> </pre> <br> 现在打开squid.conf <br><br><pre> <code class="javascript hljs">nano squid.conf</code> </pre> <br> 如您所见，他清除了评论，不再像看起来那样笨重。 <br> 在“破坏者”下，我将使用可以完美工作的设置来发布文件，在下面我将逐块描述内容和方式。 <br><br><div class="spoiler">  <b class="spoiler_title">Squid.conf配置</b> <div class="spoiler_text"><pre> <code class="javascript hljs">acl localnet src <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> acl worktime time <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-15</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> acl SSL_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> acl Safe_ports port <span class="hljs-number"><span class="hljs-number">80</span></span> # http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">21</span></span> # ftp acl Safe_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> # https acl Safe_ports port <span class="hljs-number"><span class="hljs-number">70</span></span> # gopher acl Safe_ports port <span class="hljs-number"><span class="hljs-number">210</span></span> # wais acl Safe_ports port <span class="hljs-number"><span class="hljs-number">1025</span></span><span class="hljs-number"><span class="hljs-number">-65535</span></span> # unregistered ports acl Safe_ports port <span class="hljs-number"><span class="hljs-number">280</span></span> # http-mgmt acl Safe_ports port <span class="hljs-number"><span class="hljs-number">488</span></span> # gss-http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">591</span></span> # filemaker acl Safe_ports port <span class="hljs-number"><span class="hljs-number">777</span></span> # multiling http acl CONNECT method CONNECT acl blacklist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist"</span></span> acl whitelist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist"</span></span> http_access allow localhost http_access deny manager http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow CONNECT http_access deny blacklist http_access allow whitelist http_access deny all worktime http_access allow all http_port <span class="hljs-number"><span class="hljs-number">3128</span></span> http_port <span class="hljs-number"><span class="hljs-number">3129</span></span> intercept https_port <span class="hljs-number"><span class="hljs-number">3130</span></span> intercept ssl-bump options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off cert=<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>squid/squid.pem always_direct allow all sslproxy_cert_error allow all sslproxy_flags DONT_VERIFY_PEER acl blacklist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist_ssl"</span></span> acl whitelist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist_ssl"</span></span> acl step1 at_step SslBump1 ssl_bump peek step1 ssl_bump terminate blacklist_ssl ssl_bump splice whitelist_ssl ssl_bump terminate all worktime ssl_bump splice all sslcrtd_program /usr/lib/squid/ssl_crtd -s /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/ssl_db -M <span class="hljs-number"><span class="hljs-number">4</span></span>MB # cache_mem <span class="hljs-number"><span class="hljs-number">512</span></span> MB maximum_object_size_in_memory <span class="hljs-number"><span class="hljs-number">512</span></span> KB memory_replacement_policy lru cache_dir aufs /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid <span class="hljs-number"><span class="hljs-number">2048</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> # access_log daemon:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>log/squid/access.log squid logfile_rotate <span class="hljs-number"><span class="hljs-number">1</span></span> coredump_dir /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid refresh_pattern ^ftp: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">10080</span></span> refresh_pattern ^gopher: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">1440</span></span> refresh_pattern -i (<span class="hljs-regexp"><span class="hljs-regexp">/cgi-bin/</span></span>|\?) <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">0</span></span> refresh_pattern (Release|Packages(.gz)*)$ <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">2880</span></span> refresh_pattern . <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">4320</span></span></code> </pre> <br></div></div><br>  <i><b>第一个块</b></i>如下。 <br><br><pre> <code class="javascript hljs">acl localnet src <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> acl worktime time <span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span><span class="hljs-number"><span class="hljs-number">-15</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> acl SSL_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> acl Safe_ports port <span class="hljs-number"><span class="hljs-number">80</span></span> # http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">21</span></span> # ftp acl Safe_ports port <span class="hljs-number"><span class="hljs-number">443</span></span> # https acl Safe_ports port <span class="hljs-number"><span class="hljs-number">70</span></span> # gopher acl Safe_ports port <span class="hljs-number"><span class="hljs-number">210</span></span> # wais acl Safe_ports port <span class="hljs-number"><span class="hljs-number">1025</span></span><span class="hljs-number"><span class="hljs-number">-65535</span></span> # unregistered ports acl Safe_ports port <span class="hljs-number"><span class="hljs-number">280</span></span> # http-mgmt acl Safe_ports port <span class="hljs-number"><span class="hljs-number">488</span></span> # gss-http acl Safe_ports port <span class="hljs-number"><span class="hljs-number">591</span></span> # filemaker acl Safe_ports port <span class="hljs-number"><span class="hljs-number">777</span></span> # multiling http acl CONNECT method CONNECT</code> </pre> <br> 他负责标准acl参数。 在其中，我们在localnet中将本地网络更改为我们自己的网络，并且还添加了acl的工作时间（可选）。 考虑到教师经常来找我抱怨他们找不到任何东西，一切都无法访问，我增加了工作时间。 当然，我很高兴一切都能正常运行，但是，坦白地说，我已经厌倦了听这些。 现在，我向他们报告他们的主张：15:00之后，过滤功能已关闭，他们可以自由地（几乎）找到所需的信息。 您可以添加时间，也可以全天候进行过滤，而无需添加此ACL。 <br><br>  <i><b>第二个块</b></i>定义了HTTP允许和禁止站点的列表，如下所示。 <br><br><pre> <code class="javascript hljs">acl blacklist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist"</span></span> acl whitelist url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist"</span></span></code> </pre><br> 稍后，我们将添加允许和禁止站点的列表，并将它们放置在acl中指定的文件中。 <br><br>  <i><b>第三块</b></i>通过HTTP确定访问参数，如下所示 <br><br><pre> <code class="javascript hljs">http_access allow localhost http_access deny manager http_access deny !Safe_ports http_access deny CONNECT !SSL_ports http_access allow CONNECT http_access deny blacklist http_access allow whitelist http_access deny all worktime http_access allow all</code> </pre> <br> 这里的<i>http_access allow CONNECT项是</i>必需的，因为没有它，Squid不会允许互联网上的任何人。 接下来是黑白名单上的规则。  <i>deny</i>和<i>allow</i>参数分别<i>拒绝</i>和<i>允许</i>访问。 在它们出现之后，该规则将完全禁止在工作时间内使用所有HTTP通信。 如果您未设置工作时间，请删除<i>worktime</i> ，并且该禁令将是永久性的。 重要的一点是规则的顺序，因为Squid从上到下读取它们 <br>  <i><b>第四个块</b></i>定义了Squid的端口设置。 <br><br><pre> <code class="javascript hljs">http_port <span class="hljs-number"><span class="hljs-number">3128</span></span> http_port <span class="hljs-number"><span class="hljs-number">3129</span></span> intercept https_port <span class="hljs-number"><span class="hljs-number">3130</span></span> intercept ssl-bump options=ALL:NO_SSLv3:NO_SSLv2 connection-auth=off cert=<span class="hljs-regexp"><span class="hljs-regexp">/etc/</span></span>squid/squid.pem</code> </pre> <br> 第一个参数是必需的，以便“错误：未配置正向代理端口”错误不会无限出现在日志中。 它填充日志，并因此填充内存。 这是一个常见的错误，但是由于某种原因，在我们的细分市场中，我没有找到解决方法，外国论坛对此有所帮助。 第二个参数定义HTTP协议端口。  <i>拦截</i>意味着代理透明，也就是说，无需在每台计算机上规定设置。 <br> 第三个参数定义HTTPS端口及其选项。 这是一条长线。  <i>squid.pem</i>文件是我们的证书，我们将在以后创建。 <br><br>  <i><b>第五块</b></i>定义与Squid的SSL连接的参数。 他特别指出，所有流量都应立即引导到Internet，而不使用更高的缓存，并且后两者即使出现证书验证错误也允许连接，因为访问此类资源的决定必须由用户而非服务器决定。 看起来像这样。 <br><br><pre> <code class="javascript hljs">always_direct allow all sslproxy_cert_error allow all sslproxy_flags DONT_VERIFY_PEER</code> </pre> <br>  <i><b>第六块</b></i>设置“黑名单”和“白名单”的acl参数（稍后将创建）以及HTTPS流量的拦截深度。 <br><br><pre> <code class="javascript hljs">acl blacklist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/blacklist_ssl"</span></span> acl whitelist_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist_ssl"</span></span> acl step1 at_step SslBump1</code> </pre> <br>  <i><b>第七块</b></i>使用HTTPS协议确定访问参数。 在这里，禁令和许可已经分别负责<i>终止</i>和<i>拼接</i> 。 同样，如果您没有指定的工作时间，请不要忘记删除工作时间。 <br><br><pre> <code class="javascript hljs">ssl_bump peek step1 ssl_bump terminate blacklist_ssl ssl_bump splice whitelist_ssl ssl_bump terminate all worktime ssl_bump splice all sslcrtd_program /usr/lib/squid/ssl_crtd -s /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/ssl_db -M <span class="hljs-number"><span class="hljs-number">4</span></span>MB</code> </pre><br>  <i><b>第八块</b></i>设置鱿鱼的缓存和日志。 此处仅值得注意<i>logfile_rotate</i>参数，该参数指示存储日志的天数。 <br><br><pre> <code class="javascript hljs"># cache_mem <span class="hljs-number"><span class="hljs-number">512</span></span> MB maximum_object_size_in_memory <span class="hljs-number"><span class="hljs-number">512</span></span> KB memory_replacement_policy lru cache_dir aufs /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid <span class="hljs-number"><span class="hljs-number">2048</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">256</span></span> # access_log daemon:<span class="hljs-regexp"><span class="hljs-regexp">/var/</span></span>log/squid/access.log squid logfile_rotate <span class="hljs-number"><span class="hljs-number">1</span></span> coredump_dir /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/spool/squid refresh_pattern ^ftp: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">10080</span></span> refresh_pattern ^gopher: <span class="hljs-number"><span class="hljs-number">1440</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">1440</span></span> refresh_pattern -i (<span class="hljs-regexp"><span class="hljs-regexp">/cgi-bin/</span></span>|\?) <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>% <span class="hljs-number"><span class="hljs-number">0</span></span> refresh_pattern (Release|Packages(.gz)*)$ <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">2880</span></span> refresh_pattern . <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>% <span class="hljs-number"><span class="hljs-number">4320</span></span></code> </pre> <br> 这样就完成了squid.conf的设置。 我们保存文件并继续创建证书和列表。 <br><br> 让我们用鱿鱼去文件夹 <br><br><pre> <code class="javascript hljs">cd /etc/squid/</code> </pre> <br> 并输入以下命令来创建证书 <br><br><pre> <code class="javascript hljs">openssl req -<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> -newkey rsa:<span class="hljs-number"><span class="hljs-number">1024</span></span> -days <span class="hljs-number"><span class="hljs-number">36500</span></span> -nodes -x509 -keyout squid.pem -out squid.pem</code> </pre> <br> 接下来，您将需要输入证书数据。 该证书的有效期为100年，可长时间忘记。 仅代理服务器才需要。 <br><br> 现在创建我们的列表文件。 <br><br><pre> <code class="javascript hljs">touch blacklist touch whitelist cp whitelist whitelist_ssl cp blacklist blacklist_ssl</code> </pre> <br> 网站以正则表达式的形式列出。 例如，要解锁mail.ru，请打开<i>白名单</i> <br><br><pre> <code class="javascript hljs">nano whitelist</code> </pre> <br> 并添加以下表达式。 <br><br><pre> <code class="javascript hljs">mail\.ru</code> </pre> <br> 现在阻止Games.Mail.ru。 打开<i>黑名单</i> <br><br><pre> <code class="javascript hljs">nano blacklist</code> </pre> <br> 并将以下表达式写入其中 <br><br><pre> <code class="javascript hljs">games\.mail\.ru</code> </pre> <br> 由于通常情况下，黑名单阻止程序位于我们的白名单上方，因此当您切换到mail.ru时，该站点将按预期方式打开（图片除外，但稍后会更多），如果您尝试切换到游戏，请乌贼不会放手。 <br><br> 一些站点具有许多子域，子域等。 例如，mail.ru将其图像存储在imgsmail.ru上。 对于其他类似的网站，您需要在任何浏览器（我使用Chrome）中打开所需的网站，然后在开发人员工具中打开（在Chrome中，按F12即可调用它们）。 <br><br><img src="https://habrastorage.org/webt/ie/43/a7/ie43a7r-zkjhouxldavryxg0kjg.jpeg"><br><br> 转到“源”选项卡，查看网站从哪些其他资源加载信息。 <br><br> 添加站点后，将它们复制到HTTPS列表中。 <br><br><pre> <code class="javascript hljs">cp whitelist whitelist_ssl cp blacklist blacklist_ssl</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">列表填充提示</b> <div class="spoiler_text"> 在您的计算机上创建一个纯文本文件，找到并将允许的站点列表复制到其中，然后将其添加到您的计算机中。 然后，在常规笔记本中，用斜杠（\。）自动替换该点，并使用相同的自动替换（www，http，“ /”字符等）删除不必要的点。 然后，可以使用终端将此类文件立即复制到服务器上的工作表中。 <br></div></div><br> 现在检查配置。 <br><br><pre> <code class="javascript hljs">squid -k check</code> </pre> <br> 如果一切正常，请停止鱿鱼。 <br><br><pre> <code class="javascript hljs">/etc/init.d/squid stop</code> </pre> <br> 重建缓存 <br><br><pre> <code class="javascript hljs">squid -z</code> </pre> <br> 再次运行乌贼 <br><br><pre> <code class="javascript hljs">/etc/init.d/squid start</code> </pre> <br> 对列表或Squid配置进行任何更改后，必须使用以下命令重新加载它 <br><br><pre> <code class="javascript hljs">/etc/init.d/squid restart</code> </pre> <br> 您还可以在路径<i><b>/ usr / share / squid / errors /〜Russian-1251</b></i>下更改访问限制页面（仅在HTTP上有效）。 在文件夹中查找<i><b>ERR_ACCESS_DENIED</b></i>文件并进行编辑。 文件语法为HTML。 <br><br><h4>  3.3。 监视服务器状态并配置防火墙 </h4><br> 要监视服务器的状态，请安装<b>Webmin</b>实用程序，并借助它配置防火墙。 此外，通过它，您可以监视CPU，RAM等的状态，更新软件包，添加和配置组件等等。 它有自己的终端，尽管笨拙。 该实用程序可通过任何浏览器运行，因此，您可以从网络上的任何计算机连接到我们的服务器，这虽然不安全，但也很方便。 如果需要，可以将连接仅限制为Webmin本身的“ IP访问控制”中的各个IP地址。 <br><br> 开始安装之前，请添加Webmin存储库。 打开sources.list。 <br><br><pre> <code class="javascript hljs">nano /etc/apt/sources.list</code> </pre> <br> 并在下面添加行。 <br><br><pre> <code class="javascript hljs">deb http:<span class="hljs-comment"><span class="hljs-comment">//download.webmin.com/download/repository sarge contrib</span></span></code> </pre> <br> 现在，在Webmin资源库中安装用于签名软件包的GPG密钥 <br><br><pre> <code class="javascript hljs">cd /root wget http:<span class="hljs-comment"><span class="hljs-comment">//www.webmin.com/jcameron-key.asc apt-key add jcameron-key.asc</span></span></code> </pre> <br> 接下来，我们更新软件包列表并安装实用程序 <br><br><pre> <code class="javascript hljs">apt-get update apt-get install webmin</code> </pre> <br> 您可以通过输入地址栏在任何浏览器中连接到服务器 <br><br><pre> <code class="javascript hljs">IP__:<span class="hljs-number"><span class="hljs-number">10000</span></span></code> </pre> <br> 默认情况下，Webmin通过SSL连接，并且大多数浏览器都会给出不受信任的证书错误。 为了不每次都选择信任，请禁用SSL。 为此，请打开文件<i>/etc/webmin/miniserv.conf</i> <br><br><pre> <code class="javascript hljs">nano /etc/webmin/miniserv.conf</code> </pre> <br> 在其中找到字符串<i><b>ssl = 1并将其</b></i>替换为<i><b>ssl = 0</b></i> 。 在同一文件中，您可以更改连接端口。 默认情况下为10000。您可以放置​​任意一个。 <br><br> 连接到Webmin后，转到<i>Webmin-&gt; Webmin配置</i> ，然后将语言切换为俄语。 然后转到<i>网络-&gt;防火墙</i> 。 默认情况下，我们的防火墙是干净的。 我们转到最底部，在“ <i>启动时启用”</i>对面选择<i>“是”</i> 。 单击<i>“应用配置”</i> 。 现在，我们的防火墙设置已在<i><b>/etc/webmin/firewall/iptables.save</b></i>文件中指定，并随系统一起启动。 如果没有这样的文件，请查看Webmin中“防火墙”选项卡上“带有规则的文件”行中写的内容。 让我们在终端中打开它。 <br><br><pre> <code class="javascript hljs">nano /etc/webmin/firewall/iptables.save</code> </pre> <br> 我们转到<i><b>* nat</b></i>块，最后在<i>COMMIT</i>之前添加以下规则。 <br><br><pre> <code class="javascript hljs">-A PREROUTING -p tcp -m tcp -i _ --dport <span class="hljs-number"><span class="hljs-number">80</span></span> -j DNAT --to-destination ip_:<span class="hljs-number"><span class="hljs-number">3129</span></span> -A PREROUTING -p tcp -m tcp -i _ --dport <span class="hljs-number"><span class="hljs-number">443</span></span> -j REDIRECT --to-ports <span class="hljs-number"><span class="hljs-number">3130</span></span></code> </pre> <br> 这些规则将流向服务器端口80（HTTP）和443（HTTPS）的流量定向到我们的Squid端口。 在这里，我介绍了DNAT和REDIRECT规则的两种变体。 您可以同时使用它们，也可以通过放置适当的端口来选择一个选项。 <br><br><div class="spoiler">  <b class="spoiler_title">配置FIrewall以进行备用网络设置</b> <div class="spoiler_text"> 如果您使用了上述替代网络设置，则此选项适用。 <br> 首先，使用防火墙规则创建一个文件，并赋予其执行权。 <br><pre> <code class="javascript hljs">touch /etc/nat chmod +x /etc/nat</code> </pre> <br> 打开它 <br><pre> <code class="javascript hljs">nano /etc/nat</code> </pre> <br> 并添加以下内容 <br><pre> <code class="javascript hljs"><span class="hljs-meta"><span class="hljs-meta">#!/bin/sh #Firewall iptables -t nat -A PREROUTING -p tcp -m tcp -i _ --dport 80 -j DNAT --to-destination ip_:3129 iptables -t nat -A PREROUTING -p tcp -m tcp -i _ --dport 443 -j REDIRECT --to-ports 3130</span></span></code> </pre> <br> 与Webmin一样，我用DNAT和REDIRECT提出了规则的两个变体。 您可以同时使用它们，也可以通过放置适当的端口来选择一个选项。 <br> 现在，在启动网络后立即将我们的文件添加到下载文件中。 打开网络设置文件 <br><pre> <code class="javascript hljs">nano /etc/network/interfaces</code> </pre> <br> 并在文件底部添加该行 <br><pre> <code class="javascript hljs">post-up /etc/nat</code> </pre> <br>  PS：该选项的优点是将来您可以通过编辑/ etc / nat文件来添加自己的规则。  Webmin有点复杂。 <br></div></div><br> 这样就完成了服务器设置。 重新启动它。 <br><br><pre> <code class="javascript hljs">reboot</code> </pre> <br> 让我们继续设置MikroTik路由器。 <br><br><h4>  3.4。 配置MikroTik路由器以将流量重定向到代理 </h4><br> 我们假设您已经下载了<b>WinBox</b>实用程序进行远程控制，已配置Internet和本地网络，路由器上的防火墙是干净的。 您知道LAN接口的名称（可以在<i>IP-DHCP Server-DHCP中</i>看到它）。 <br><br>  <b>a）</b>转到WinBox，转到<i><b>IP-DHCP服务器-租赁</b></i> 。 在列表中，我们寻找无法进行过滤的IP计算机（导演，管理），右键单击它们，然后在菜单中选择“ <i><b>设为静态</b></i> ”。 在它们旁边，字母“ D”应消失，表示动态。 现在，无论租用时间长短，这些地址都将立即通过MAC地址静态分配给这些计算机。 如果通过Wi-Fi和电缆使用笔记本电脑，则必须在两个MAC地址上选择“设为静态”。 <br><br>  <b>b）</b>接下来，转到<i><b>IP-防火墙-地址列表</b></i> ，然后单击蓝色<i><b>加</b></i>号<i><b>“ +”</b></i> 。 在<i><b>名称</b></i>字段中，为我们的一组<s>明亮的</s>未过滤地址指定名称，例如“ Admins”。 在<i><b>地址</b></i>字段中，从已分配静态IP地址的<i><b>地址</b></i>中指定一个IP地址。 我们对每个地址重复此操作，在带有箭头的“名称”字段中选择我们的组。 <br><br>  <b>c）</b>转到同一<i><b>IP-防火墙中</b></i>的<i><b>Mangle</b></i>选项卡，然后单击<i><b>“ +”</b></i> 。 将打开一个选项卡式窗口。 在“ <i><b>常规”</b></i>选项卡上，填写以下字段： <br><br><pre> <code class="javascript hljs">Chain - Prerouting Src. Address - __proxy Protocol - <span class="hljs-number"><span class="hljs-number">6</span></span> (tcp) Dst. Port - <span class="hljs-number"><span class="hljs-number">80</span></span> In. Interface - __</code> </pre><br> 在“ <b><i>操作”</i></b>选项卡上，检查值“ <i><b>接受”</b></i> ，然后单击“确定”。 <br><br> 重复该过程，但在<i>Dst</i>字段中<i>。</i>  <i>端口</i>将值设置为<i>443</i> 。 <br><br>  <b>d）</b>再次单击“ +”，然后在“ <i><b>常规”</b></i>选项卡上再次填写以下字段： <br><br><pre> <code class="javascript hljs">Chain - Prerouting Protocol - <span class="hljs-number"><span class="hljs-number">6</span></span> (tcp) Dst. Port - <span class="hljs-number"><span class="hljs-number">80</span></span> In. Interface - __</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转到“ </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">高级”</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项卡，</font><font style="vertical-align: inherit;">然后在“ </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">源代码”</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">字段中</font><i><b><font style="vertical-align: inherit;">。</font></b></i><i><b><font style="vertical-align: inherit;">地址列表</font></b></i><font style="vertical-align: inherit;">选择我们的“ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">管理员</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ” </font><font style="vertical-align: inherit;">管理地址列表</font><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">确保单击列表旁边出现的框。</font><font style="vertical-align: inherit;">将会出现一个感叹号</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">“！”。</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，表示逻辑非或负逻辑。</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转到“ </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">操作”</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">标签，</font><font style="vertical-align: inherit;">然后填写以下字段：</font></font><br><br><pre> <code class="javascript hljs">Action - mark routing New Routing Mark - to_proxy Passthrough -  </code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单击“确定”并执行相同的操作，但在“目标”字段中</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">端口</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">指定值</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">443</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">最后，添加最后一条规则。</font><font style="vertical-align: inherit;">单击加号，然后在“ </font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">常规”</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">选项卡上填写以下字段</font><font style="vertical-align: inherit;">：</font></font><br><br><pre> <code class="javascript hljs">Chain - Prerouting In. Interface - __ Routing Mark - to_proxy</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">结果，您的参数将发生以下情况。</font><font style="vertical-align: inherit;">订单很重要！</font></font><br><br><img src="https://habrastorage.org/webt/tp/vw/zi/tpvwzizj0x_x4hg5quooe1t8bpo.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">f）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们进入</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP-路由</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，然后按“ +”。</font><font style="vertical-align: inherit;">填写以下字段：</font></font><br><br><pre> <code class="javascript hljs">Dst. Address - <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> Gateway - __proxy Routing Mark - to_proxy</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">单击确定，仅此而已。</font><font style="vertical-align: inherit;">打开服务器后，所有HTTP和HTTPS流量都将通过我们的Squid。</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.5。</font><font style="vertical-align: inherit;">MikroTik和其他路由器的替代设置</font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此选项既适用于MikroTik路由器，也适用于任何其他路由器，即使是最简单的路由器也适用（除了租用的提供商，您自己知道什么）。</font><font style="vertical-align: inherit;">在这种情况下，我们不是在路由器上而是在Squid本身上实现Internet访问共享。</font></font>因此，让我们开始吧。 <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">a）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们将假定您已完成上述所有步骤，包括在MikroTik中设置重定向到代理的位置，从而达到了这一点。为了使所描述的选项无故障运行，我们需要取消</font><font style="vertical-align: inherit;">本文</font><font style="vertical-align: inherit;">第</font><i><b><font style="vertical-align: inherit;">3.4</font></b></i><font style="vertical-align: inherit;">段的</font></font><b><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e）</font></font></i></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">项</font><font style="vertical-align: inherit;">。您可以取消整个点3.4（也许保留</font><i><font style="vertical-align: inherit;">a</font></i><font style="vertical-align: inherit;">子节，</font><font style="vertical-align: inherit;">这样我们的IP不会改变），但这是可选的-对我们来说取消路由本身很重要。为此，请转到</font><i><b><font style="vertical-align: inherit;">IP-路线</font></b></i><font style="vertical-align: inherit;">，查找我们的路线，选择它并单击</font><b><i><font color="#cc0000"><font style="vertical-align: inherit;">红叉</font></font></i></b><font style="vertical-align: inherit;">（不是加号，而是复选标记旁边的叉）。该路线将变为灰色=&gt;禁用。过滤功能也已关闭，现在所有客户端都直接通过路由器进入Internet。</font><b><font style="vertical-align: inherit;">b）</font></b></font><i><b><font style="vertical-align: inherit;"></font></b></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><i><b><font style="vertical-align: inherit;"></font></b></i><font style="vertical-align: inherit;"></font><b><i><font color="#cc0000"><font style="vertical-align: inherit;"></font></font></i></b><font style="vertical-align: inherit;"></font><br><br> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 现在转到我们的服务器，并转到包含Squid的文件夹 </font></font><br><pre> <code class="javascript hljs">cd /etc/squid/</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 打开配置文件 </font></font><br><pre> <code class="javascript hljs">nano squid.conf</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后在块中添加：</font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> acl localnet行之后的</font><i><b><font style="vertical-align: inherit;">第一个块中</font></b></i><font style="vertical-align: inherit;"> ...</font></font><br><pre> <code class="javascript hljs">acl admins src <span class="hljs-string"><span class="hljs-string">"/etc/squid/admins-ip"</span></span> # IP   acl students src <span class="hljs-string"><span class="hljs-string">"/etc/squid/students-ip"</span></span> # IP  </code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们不需要教师计算机的清单，因为据了解其他所有人都是教师。</font><font style="vertical-align: inherit;">但是您可以自己添加其他块中的相应规则。</font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第二块</font></font></b></i> <br><pre> <code class="javascript hljs">acl whitelist-stud url_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist-stud"</span></span> #     </code> </pre> <br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> http_access之后</font><i><b><font style="vertical-align: inherit;">的第三个区块中</font></b></i><font style="vertical-align: inherit;">拒绝黑名单</font></font><br><pre> <code class="javascript hljs">http_access allow admins #      http_access allow students whitelist-stud #       http_access deny students #       </code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">此外，由于教师（所有其他IP）紧随其后，按白名单和在工作时间（如果有）进行过滤，因此该块保持不变。</font><font style="vertical-align: inherit;">您还可以通过将禁止规则设置为禁止规则之上，或将单独的IP（例如，您自己的IP）添加到单独的ACL中，并将其放入黑名单之上的规则中，来让管理员组绕过黑名单。</font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">第四和第五块</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">保持不变。</font></font><br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第六块中，</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加</font></font><br><pre> <code class="javascript hljs">acl whitelist-stud_ssl ssl::server_name_regex -i <span class="hljs-string"><span class="hljs-string">"/etc/squid/whitelist-stud_ssl"</span></span></code> </pre> <br> <i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在第七块中，</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在ssl_bump终止blacklist_ssl后添加</font></font><br><pre> <code class="javascript hljs">ssl_bump splice admins ssl_bump splice students whitelist-stud_ssl ssl_bump terminate students</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">原理与第三块相同。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">其余的保持不变。</font><font style="vertical-align: inherit;">保存并退出</font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">现在创建我们的IP地址列表。</font></font><br><pre> <code class="javascript hljs">touch admins-ip touch students-ip</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 以及学生的白名单。 </font></font><br><pre> <code class="javascript hljs">touch whitelist-stud cp whitelist-stud whitelist-stud_ssl</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">将所需的IP地址和站点添加到适当的列表。</font><font style="vertical-align: inherit;">在学生站点列表中，您可以通过删除学生不需要的站点来复制教师列表。</font><font style="vertical-align: inherit;">在Linux上复制文件由以下命令完成</font></font><br><pre> <code class="javascript hljs">cp &lt;    &gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name"></span></span></span></span><span class="xml"><span class="hljs-tag">    &gt;</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 重启鱿鱼 </font></font><br><pre> <code class="javascript hljs">/etc/init.d/squid restart</code> </pre> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">d）</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">我们谈到了最重要的事情，即如何使客户通过我们的代理服务器上网。我们需要将DHCP服务器的网关从路由器的地址更改为服务器的地址。当然，为此，服务器地址必须是静态的或绑定到MAC。</font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在MikroTik中：</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">转到</font></font><i><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IP-DHCP服务器-网络，</font></font></b></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">然后双击我们的网络。在“网关”字段中，将路由器的地址更改为代理服务器的地址。单击确定，仅此而已。您可以重新启动路由器，以便为所有活动客户端正确更新设置。此后，客户端可能会将网络类型更改为公共网络（如果是私有网络）。</font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在普通路由器中：</font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在</font><b><font style="vertical-align: inherit;">路由器</font></b><font style="vertical-align: inherit;">的手册中查找更改DHCP服务器网关的位置，但我会说一下其设置：)</font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">底线：</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">作为此替代解决方案的结果，我们能够按IP和列表微调访问权限，并在Squid日志中获取客户端的常规IP地址。</font><font style="vertical-align: inherit;">如果您需要一些客户端通过路由器绕过Proxy来联机，请阅读破坏者。</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">互联网绕过代理</font></font></b> <div class="spoiler_text">   ,  -      Squid ,        ,   , <br></div></div><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4.结论 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">因此，总结以上所有内容。</font><font style="vertical-align: inherit;">我们设法从头开始安装和配置Linux Ubuntu 18.04 LTS，构建并安装具有HTTPS支持的Squid，配置白名单过滤，将代理服务器集成到我们的网络中，而无需安装其他DHCP服务器。</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 5.来源清单 </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">创建文章时，使用</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">了Interface LLC技术博客</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Web安全</font></font></a><font style="vertical-align: inherit;"><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">专家的</font></a><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><font style="vertical-align: inherit;">站点-Web Filter for Your Network的</font></a><font style="vertical-align: inherit;">各种材料</font><font style="vertical-align: inherit;">以及个人知识和经验。</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在编辑和补充本文时，以下用户提供了很多帮助：</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Kanlas</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">，</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PetRiot</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">和</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Barsook</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">。</font><font style="vertical-align: inherit;">非常感谢他们的帮助和帮助。</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6.作者的评论 </font></font></h3><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">必须在超级用户模式下完成服务器的任何工作，方法是在</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">前</font><font style="vertical-align: inherit;">添加</font><i><font style="vertical-align: inherit;">sudo</font></i><font style="vertical-align: inherit;">或一次输入</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sudo -s</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令</font><font style="vertical-align: inherit;">。</font></font></li><li> Squid \     ,    , ,     .          . </li><li>    , .    ,        1000 . </li><li> <s> ,           IP-  Squid.   Squid   IP- —  Mikrotik.    ,      DHCP    ,      . ,    ,    ,     IP .</s> —     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">Barsook</a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">为了使Squid与大量客户端（超过50个）一起使用，至少需要1 GB的RAM。</font><font style="vertical-align: inherit;">更优选地，因为鱿鱼吞噬了记忆。</font><font style="vertical-align: inherit;">您可以通过输入</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">top</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">命令来检查内存状态</font><font style="vertical-align: inherit;">。</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 我建议同时使用这两个选项来配置路由器，因为如果您在网络设置（路由器本身）中明确指定了其他网关，则可以绕过锁定。 </font></font></li></ol><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD1：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加了备用网络配置，而防火墙</font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD2：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">添加了备用路由器配置选项，解决了在Squid日志中显示地址的问题。</font></font><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UPD3：</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">在3.1中添加了一个修复程序-使数据包能够通过服务器，而他最初忘记添加该数据包。</font><font style="vertical-align: inherit;">否则，Internet无法正常工作。</font><font style="vertical-align: inherit;">感谢</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dmitry1986</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">对文章的测试。</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN473584/">https://habr.com/ru/post/zh-CN473584/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN473570/index.html">10小时内搜寻314平方公里-搜索工程师与森林的最后一战</a></li>
<li><a href="../zh-CN473572/index.html">将重述“扎克罗马玛·罗迪娜”：德国将通过新方法确定战略储备</a></li>
<li><a href="../zh-CN473574/index.html">在TSD上的应用以及通过HTTP服务与1C：Enterprise 8.3的通信。 第三部分（BroadcastReceiver获取条形码）</a></li>
<li><a href="../zh-CN473576/index.html">开发人员实验基础架构</a></li>
<li><a href="../zh-CN473578/index.html">为Nginx构建动态模块</a></li>
<li><a href="../zh-CN473586/index.html">FortiConverter或轻松移动</a></li>
<li><a href="../zh-CN473588/index.html">侵入性ace：蓝蝇“反向”着陆的运动学</a></li>
<li><a href="../zh-CN473590/index.html">我如何在计算机奥林匹克竞赛上赢得4枚金牌中的3枚</a></li>
<li><a href="../zh-CN473592/index.html">Raiffeisenbank的Scrum社区聚会+广播</a></li>
<li><a href="../zh-CN473596/index.html">Python v3.x：协程和同步函数的异常处理程序。 总的来说</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>