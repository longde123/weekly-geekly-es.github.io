<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¼â€âš•ï¸ ğŸ¸ ğŸ›¶ å¯»æ‰¾LD_PRELOAD ğŸ’ƒğŸ» ğŸ‘§ğŸ¼ ğŸš¶ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¿™ä»½ç¬”è®°å†™äº2014å¹´ï¼Œä½†æˆ‘åªæ˜¯åœ¨æ¢çº½å—åˆ°å‹åˆ¶ï¼Œå¥¹æ²¡æœ‰çœ‹åˆ°å…‰æ˜ã€‚ åœ¨ç¦ä»¤æœŸé—´ï¼Œæˆ‘å¿˜è®°äº†å®ƒï¼Œä½†æ˜¯ç°åœ¨æˆ‘åœ¨è‰ç¨¿ä¸­æ‰¾åˆ°äº†å®ƒã€‚ ä»¥ä¸ºæ˜¯åˆ é™¤ï¼Œä½†ä¹Ÿè®¸æœ‰äººæ´¾ä¸Šäº†ç”¨åœºã€‚ 



 é€šå¸¸ï¼Œæ˜ŸæœŸäº”çš„å°å‹ç®¡ç†å‘˜é˜…è¯»æœ‰å…³æœç´¢â€œ includedâ€ LD_PRELOADçš„ä¸»é¢˜ã€‚ 

 1.å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰å‡½æ•°æ›¿æ¢çš„äººæ¥è¯´æœ‰ç‚¹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¯»æ‰¾LD_PRELOAD</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479858/"> è¿™ä»½ç¬”è®°å†™äº2014å¹´ï¼Œä½†æˆ‘åªæ˜¯åœ¨æ¢çº½å—åˆ°å‹åˆ¶ï¼Œå¥¹æ²¡æœ‰çœ‹åˆ°å…‰æ˜ã€‚ åœ¨ç¦ä»¤æœŸé—´ï¼Œæˆ‘å¿˜è®°äº†å®ƒï¼Œä½†æ˜¯ç°åœ¨æˆ‘åœ¨è‰ç¨¿ä¸­æ‰¾åˆ°äº†å®ƒã€‚ ä»¥ä¸ºæ˜¯åˆ é™¤ï¼Œä½†ä¹Ÿè®¸æœ‰äººæ´¾ä¸Šäº†ç”¨åœºã€‚ <br><br><img src="https://habrastorage.org/webt/o1/8i/wf/o18iwf72_dlx0j9-qjr8zni5unq.png"><br><br> é€šå¸¸ï¼Œæ˜ŸæœŸäº”çš„å°å‹ç®¡ç†å‘˜é˜…è¯»æœ‰å…³æœç´¢â€œ includedâ€ <i>LD_PRELOAD</i>çš„ä¸»é¢˜ã€‚ <br><a name="habracut"></a><br><h2>  1.å¯¹äºé‚£äº›ä¸ç†Ÿæ‚‰å‡½æ•°æ›¿æ¢çš„äººæ¥è¯´æœ‰ç‚¹ç¦»é¢˜ </h2><br> å…¶ä½™çš„å¯ä»¥ç›´æ¥è½¬åˆ°<b>æ­¥éª¤2</b> ã€‚ <br><br> è®©æˆ‘ä»¬ä»ç»å…¸ç¤ºä¾‹å¼€å§‹ï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;time.h&gt; int main() { srand (time(NULL)); for(int i=0; i&lt;5; i++){ printf ("%d\n", rand()%100); } }</span></span></span></span></code> </pre> <br> ç¼–è¯‘æ—¶ä¸å¸¦ä»»ä½•æ ‡å¿—ï¼š <br><br><pre> <code class="plaintext hljs">$ gcc ./ld_rand.c -o ld_rand</code> </pre><br> è€Œä¸”ï¼Œæ­£å¦‚é¢„æœŸçš„é‚£æ ·ï¼Œæˆ‘ä»¬å¾—åˆ°5ä¸ªå°äº100çš„éšæœºæ•°ï¼š <br><br><pre> <code class="plaintext hljs">$ ./ld_rand 53 93 48 57 20</code> </pre><br> ä½†æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬æ²¡æœ‰ç¨‹åºçš„æºä»£ç ï¼Œåˆ™éœ€è¦æ›´æ”¹è¡Œä¸ºã€‚ <br><br> è®©æˆ‘ä»¬ç”¨æˆ‘ä»¬è‡ªå·±çš„å‡½æ•°åŸå‹åˆ›å»ºæˆ‘ä»¬è‡ªå·±çš„åº“ï¼Œä¾‹å¦‚ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">rand</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span>; }</code> </pre><br><pre> <code class="plaintext hljs">$ gcc -shared -fPIC ./o_rand.c -o ld_rand.so</code> </pre><br> ç°åœ¨æˆ‘ä»¬çš„éšæœºé€‰æ‹©æ˜¯å¯ä»¥é¢„æµ‹çš„ï¼š <br><br><pre> <code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ./ld_rand 42 42 42 42 42</code> </pre><br> å¦‚æœæˆ‘ä»¬é¦–å…ˆé€šè¿‡ä»¥ä¸‹æ–¹å¼å¯¼å‡ºåº“ï¼Œåˆ™æ­¤æŠ€å·§çœ‹èµ·æ¥ä¼šæ›´åŠ ä»¤äººå°è±¡æ·±åˆ»ï¼š <br><br><pre> <code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so</code> </pre><br> æˆ–é¢„å…ˆæ‰§è¡Œ <br><br><pre> <code class="plaintext hljs"># echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload</code> </pre><br> ç„¶ååœ¨æ­£å¸¸æ¨¡å¼ä¸‹è¿è¡Œè¯¥ç¨‹åºã€‚ æˆ‘ä»¬æ²¡æœ‰åœ¨ç¨‹åºæœ¬èº«çš„ä»£ç ä¸­æ›´æ”¹ä»»ä½•ä¸€è¡Œï¼Œä½†æ˜¯å®ƒçš„è¡Œä¸ºç°åœ¨å–å†³äºæˆ‘ä»¬åº“ä¸­çš„ä¸€ä¸ªå¾®å°å‡½æ•°ã€‚ è€Œä¸”ï¼Œåœ¨æ’°å†™æœ¬æ–‡æ—¶ï¼Œä¼ª<i>å…°ç‰¹</i>ç”šè‡³ä¸å­˜åœ¨ã€‚ <br><br> æ˜¯ä»€ä¹ˆä½¿æˆ‘ä»¬çš„ç¨‹åºä½¿ç”¨å‡å†’<i>å…°ç‰¹</i> ï¼Ÿ è®©æˆ‘ä»¬é€æ­¥è¿›è¡Œã€‚ <br> å¯åŠ¨åº”ç”¨ç¨‹åºæ—¶ï¼Œå°†åŠ è½½æŸäº›åº“ï¼Œå…¶ä¸­åŒ…å«è¯¥ç¨‹åºæ‰€éœ€çš„åŠŸèƒ½ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨<i>ldd</i>çœ‹åˆ°å®ƒä»¬ï¼š <br><br><pre> <code class="plaintext hljs"># ldd ./ld_rand linux-vdso.so.1 (0x00007ffc8b1f3000) libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007fe3da8af000) /lib64/ld-linux-x86-64.so.2 (0x00007fe3daa7e000)</code> </pre><br> è¯¥åˆ—è¡¨å¯èƒ½å› æ“ä½œç³»ç»Ÿç‰ˆæœ¬è€Œå¼‚ï¼Œä½†æ˜¯é‚£é‡Œå¿…é¡»æœ‰ä¸€ä¸ª<i>libc.so</i>æ–‡ä»¶ã€‚ è¿™ä¸ªåº“æä¾›ç³»ç»Ÿè°ƒç”¨å’ŒåŸºæœ¬åŠŸèƒ½ï¼Œä¾‹å¦‚<i>open</i> ï¼Œ <i>malloc</i> ï¼Œ <i>printf</i>ç­‰ã€‚æˆ‘ä»¬çš„<i>rand</i>ä¹Ÿæ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚ ç¡®ä¿è¿™ä¸€ç‚¹ï¼š <br><br><pre> <code class="plaintext hljs"># nm -D /lib/x86_64-linux-gnu/libc.so.6 | grep " rand$" 000000000003aef0 T rand</code> </pre><br> è®©æˆ‘ä»¬çœ‹çœ‹ä½¿ç”¨<i>LD_PRELOAD</i>æ—¶åº“é›†æ˜¯å¦ä¼šæ›´æ”¹ <br><br><pre> <code class="plaintext hljs"># LD_PRELOAD=$PWD/ld_rand.so ldd ./ld_rand linux-vdso.so.1 (0x00007ffea52ae000) /scripts/c/ldpreload/ld_rand.so (0x00007f690d3f9000) libc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007f690d230000) /lib64/ld-linux-x86-64.so.2 (0x00007f690d405000)</code> </pre><br> äº‹å®è¯æ˜ï¼Œå³ä½¿ç¨‹åºæœ¬èº«ä¸éœ€è¦å®ƒï¼Œè®¾ç½®å˜é‡<i>LD_PRELOAD</i> <i>ä¹Ÿä¼š</i>å¼ºåˆ¶<i>ld_rand.so</i>åŠ è½½ã€‚ è€Œä¸”ï¼Œç”±äºæˆ‘ä»¬çš„<i>rand</i>å‡½æ•°è¦æ¯”<i>libc.soçš„</i> <i>rand</i>æ—©åŠ è½½ï¼Œå› æ­¤å®ƒå¯ä»¥æ§åˆ¶çƒã€‚ <br><br> å¥½çš„ï¼Œæˆ‘ä»¬è®¾æ³•æ›¿æ¢äº†æœ¬æœºåŠŸèƒ½ï¼Œä½†æ˜¯å¦‚ä½•ç¡®ä¿ä¿ç•™å…¶åŠŸèƒ½å¹¶æ·»åŠ äº†ä¸€äº›æ“ä½œã€‚ æˆ‘ä»¬ä¿®æ”¹éšæœºæ•°ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;dlfcn.h&gt; #include &lt;stdio.h&gt; typedef int (*orig_rand_f_type)(void); int rand() { /*    */ printf("Evil injected code\n"); orig_rand_f_type orig_rand; orig_rand = (orig_rand_f_type)dlsym(RTLD_NEXT,"rand"); return orig_rand(); }</span></span></span></span></code> </pre><br> åœ¨è¿™é‡Œï¼Œä½œä¸ºâ€œæ·»åŠ å‰‚â€ï¼Œæˆ‘ä»¬åªæ‰“å°ä¸€è¡Œæ–‡æœ¬ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªæŒ‡å‘åŸå§‹<i>rand</i>å‡½æ•°çš„æŒ‡é’ˆã€‚ è¦è·å–æ­¤å‡½æ•°çš„åœ°å€ï¼Œæˆ‘ä»¬éœ€è¦<i>dlsym-</i>è¿™æ˜¯<i>libdl</i>åº“ä¸­çš„ä¸€ä¸ªå‡½æ•°ï¼Œå®ƒå°†åœ¨åŠ¨æ€åº“å †æ ˆä¸­æ‰¾åˆ°æˆ‘ä»¬çš„<i>rand</i> ã€‚ ä¹‹åï¼Œæˆ‘ä»¬å°†è°ƒç”¨æ­¤å‡½æ•°å¹¶è¿”å›å…¶å€¼ã€‚ å› æ­¤ï¼Œåœ¨æ„å»ºæ—¶ï¼Œæˆ‘ä»¬å°†éœ€è¦æ·»åŠ <i>â€œ -ldlâ€</i> ï¼š <br><br><pre> <code class="plaintext hljs">$ gcc -ldl -shared -fPIC ./o_rand_evil.c -o ld_rand_evil.so</code> </pre><br><pre> <code class="plaintext hljs">$ LD_PRELOAD=$PWD/ld_rand_evil.so ./ld_rand Evil injected code 66 Evil injected code 28 Evil injected code 93 Evil injected code 93 Evil injected code 95</code> </pre><br> å¹¶ä¸”æˆ‘ä»¬çš„ç¨‹åºåœ¨æ‰§è¡Œäº†ä¸€äº›ä¸é›…è¡Œä¸ºåä½¿ç”¨äº†â€œæœ¬æœºâ€ <i>å…°ç‰¹</i> ã€‚ <br><br><h2>  2.é¢ç²‰æœç´¢ </h2><br> äº†è§£æ½œåœ¨å¨èƒåï¼Œæˆ‘ä»¬å¸Œæœ›å‘ç°<i>é¢„åŠ è½½</i>å·²æ‰§è¡Œã€‚ æ˜¾ç„¶ï¼Œæœ€å¥½çš„æ£€æµ‹æ–¹æ³•æ˜¯å°†å…¶æ¨å…¥å†…æ ¸ï¼Œä½†æ˜¯æˆ‘å¯¹ç”¨æˆ·ç©ºé—´ä¸­çš„å®šä¹‰å¾ˆæ„Ÿå…´è¶£ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæ£€æµ‹è§£å†³æ–¹æ¡ˆåŠå…¶åé©³å°†æˆå¯¹è¿›è¡Œã€‚ <br><br><h2>  2.1ã€‚ è®©æˆ‘ä»¬ä»ä¸€ä¸ªç®€å•çš„å¼€å§‹ </h2><br> å¦‚å‰æ‰€è¿°ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨<i>LD_PRELOAD</i>å˜é‡æˆ–é€šè¿‡å°†å…¶å†™å…¥<i>/etc/ld.so.preload</i>æ–‡ä»¶æ¥æŒ‡å®šè¦åŠ è½½çš„åº“ã€‚ è®©æˆ‘ä»¬åˆ›å»ºä¸¤ä¸ªæœ€ç®€å•çš„æ£€æµ‹å™¨ã€‚ <br><br> é¦–å…ˆæ˜¯æ£€æŸ¥è®¾ç½®çš„ç¯å¢ƒå˜é‡ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;fcntl.h&gt; int main() { char* pGetenv = getenv("LD_PRELOAD"); pGetenv != NULL ? printf("LD_PRELOAD (getenv) [+]\n"): printf("LD_PRELOAD (getenv) [-]\n"); }</span></span></span></span></code> </pre><br> ç¬¬äºŒç§æ˜¯æ£€æŸ¥æ–‡ä»¶çš„æ‰“å¼€æƒ…å†µï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;fcntl.h&gt; int main() { open("/etc/ld.so.preload", O_RDONLY) != -1 ? printf("LD_PRELOAD (open) [+]\n"): printf("LD_PRELOAD (open) [-]\n"); }</span></span></span></span></code> </pre><br> åŠ è½½åº“ï¼š <br><br><pre> <code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_rand.so $ echo "$PWD/ld_rand.so" &gt; /etc/ld.so.preload $ ./detect_base_getenv LD_PRELOAD (getenv) [+] $ ./detect_base_open LD_PRELOAD (open) [+]</code> </pre><br> åœ¨ä¸‹æ–‡ä¸­ï¼Œ[+]è¡¨ç¤ºæ£€æµ‹æˆåŠŸã€‚ <br> å› æ­¤ï¼Œ[-]è¡¨ç¤ºæ—è·¯æ£€æµ‹ã€‚ <br><br> è¿™ç§æ¢æµ‹å™¨çš„æ•ˆèƒ½å¦‚ä½•ï¼Ÿ é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ç¯å¢ƒå˜é‡ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;dlfcn.h&gt; char* (*orig_getenv)(const char *) = NULL; char* getenv(const char *name) { if(!orig_getenv) orig_getenv = dlsym(RTLD_NEXT, "getenv"); if(strcmp(name, "LD_PRELOAD") == 0) return NULL; return orig_getenv(name); }</span></span></span></span></code> </pre><br><pre> <code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_getenv.c -o ./ld_undetect_getenv.so $ LD_PRELOAD=./ld_undetect_getenv.so ./detect_base_getenv LD_PRELOAD (getenv) [-]</code> </pre><br> åŒæ ·ï¼Œæˆ‘ä»¬æ‘†è„±äº†<i>å¼€æ”¾</i>æ£€æŸ¥ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;string.h&gt; #include &lt;stdlib.h&gt; #include &lt;dlfcn.h&gt; #include &lt;errno.h&gt; int (*orig_open)(const char*, int oflag) = NULL; int open(const char *path, int oflag, ...) { char real_path[256]; if(!orig_open) orig_open = dlsym(RTLD_NEXT, "open"); realpath(path, real_path); if(strcmp(real_path, "/etc/ld.so.preload") == 0){ errno = ENOENT; return -1; } return orig_open(path, oflag); }</span></span></span></span></code> </pre><br><pre> <code class="plaintext hljs">$ gcc -shared -fpic -ldl ./ld_undetect_open.c -o ./ld_undetect_open.so $ LD_PRELOAD=./ld_undetect_open.so ./detect_base_open LD_PRELOAD (open) [-]</code> </pre><br> æ˜¯çš„ï¼Œè¿™é‡Œå¯ä»¥ä½¿ç”¨å…¶ä»–è®¿é—®æ–‡ä»¶çš„æ–¹æ³•ï¼Œä¾‹å¦‚<i>open64</i> ï¼Œ <i>stat</i>ç­‰ï¼Œä½†æ˜¯å®é™…ä¸Šï¼Œéœ€è¦ç›¸åŒçš„5-10è¡Œä»£ç æ¥æ¬ºéª—å®ƒä»¬ã€‚ <br><br><h2>  2.2ã€‚ ç»§ç»­å‰è¿› </h2><br> ä¸Šé¢æˆ‘ä»¬ä½¿ç”¨<i>getenvï¼ˆï¼‰</i>æ¥è·å–<i>LD_PRELOAD</i>çš„å€¼ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€ç§æ›´â€œä½çº§â€çš„æ–¹æ³•æ¥è·å–<i>ENV</i>å˜é‡ã€‚ æˆ‘ä»¬å°†ä¸ä½¿ç”¨ä¸­é—´å‡½æ•°ï¼Œè€Œæ˜¯å¼•ç”¨<i>**ç¯å¢ƒ</i>æ•°ç»„ï¼Œåœ¨å…¶ä¸­å­˜å‚¨ç¯å¢ƒçš„å‰¯æœ¬ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;string.h&gt; extern char **environ; int main(int argc, char **argv) { int i; char env[] = "LD_PRELOAD"; if (environ != NULL) for (i = 0; environ[i] != NULL; i++) { char * pch; pch = strstr(environ[i],env); if(pch != NULL) { printf("LD_PRELOAD (**environ) [+]\n"); return 0; } } printf("LD_PRELOAD (**environ) [-]\n"); return 0; }</span></span></span></span></code> </pre><br> ç”±äºåœ¨è¿™é‡Œæˆ‘ä»¬ç›´æ¥ä»å†…å­˜è¯»å–æ•°æ®ï¼Œå› æ­¤æ— æ³•æ‹¦æˆªæ­¤ç±»è°ƒç”¨ï¼Œå¹¶ä¸”æˆ‘ä»¬çš„<i>undetect_getenv</i>ä¸å†å¹²æ‰°ç¡®å®šå…¥ä¾µã€‚ <br><br><pre> <code class="plaintext hljs">$ LD_PRELOAD=./ld_undetect_getenv.so ./detect_environ LD_PRELOAD (**environ) [+]</code> </pre><br> çœ‹æ¥é—®é¢˜å·²ç»è§£å†³äº†ï¼Ÿ ä»åªæ˜¯å¼€å§‹ã€‚ <br><br> ç¨‹åºå¯åŠ¨åï¼Œè§£å¯†ç¨‹åºä¸å†éœ€è¦å†…å­˜ä¸­<i>LD_PRELOAD</i>å˜é‡çš„å€¼ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨å¯ä»¥åœ¨æ‰§è¡Œä»»ä½•æŒ‡ä»¤ä¹‹å‰å…ˆå°†å…¶è¯»å–å¹¶åˆ é™¤ã€‚ å½“ç„¶ï¼Œåœ¨å†…å­˜ä¸­ç¼–è¾‘æ•°ç»„è‡³å°‘æ˜¯ä¸€ç§ä¸å¥½çš„ç¼–ç¨‹é£æ ¼ï¼Œä½†æ˜¯è¿™çœŸçš„å¯ä»¥é˜»æ­¢é‚£äº›ä¸å¸Œæœ›æˆ‘ä»¬è¿‡å¾—å¾ˆå¥½çš„äººå—ï¼Ÿ <br><br> ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºè‡ªå·±çš„ä¼ªå‡½æ•°<i>initï¼ˆï¼‰</i> ï¼Œåœ¨å…¶ä¸­æˆ‘ä»¬æ‹¦æˆªå·²å®‰è£…çš„<i>LD_PRELOAD</i>å¹¶å°†å…¶ä¼ é€’ç»™é“¾æ¥å™¨ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;dlfcn.h&gt; #include &lt;stdlib.h&gt; extern char **environ; char *evil_env; int (*orig_execve)(const char *path, char *const argv[], char *const envp[]) = NULL; //    init //       //   -  void evil_init() { //     LD_PRELOAD static const char *ldpreload = "LD_PRELOAD"; int len = strlen(getenv(ldpreload)); evil_env = (char*) malloc(len+1); strcpy(evil_env, getenv(ldpreload)); int i; char env[] = "LD_PRELOAD"; if (environ != NULL) for (i = 0; environ[i] != NULL; i++) { char * pch; pch = strstr(environ[i],env); if(pch != NULL) { //    LD_PRELOAD unsetenv(env); break; } } } int execve(const char *path, char *const argv[], char *const envp[]) { int i = 0, j = 0, k = -1, ret = 0; char** new_env; if(!orig_execve) orig_execve = dlsym(RTLD_NEXT,"execve"); //       LD_PRELOAD for(i = 0; envp[i]; i++){ if(strstr(envp[i], "LD_PRELOAD")) k = i; } //  LD_PRELOAD     ,    if(k == -1){ k = i; i++; } //    new_env = (char**) malloc((i+1)*sizeof(char*)); //   ,   LD_PRELOAD for(j = 0; j &lt; i; j++) { //    LD_PRELOAD if(j == k) { new_env[j] = (char*) malloc(256); strcpy(new_env[j], "LD_PRELOAD="); strcat(new_env[j], evil_env); } else new_env[j] = (char*) envp[j]; } new_env[i] = NULL; ret = orig_execve(path, argv, new_env); free(new_env[k]); free(new_env); return ret; }</span></span></span></span></code> </pre><br> æˆ‘ä»¬æ‰§è¡Œæ£€æŸ¥ï¼š <br><br><pre> <code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init ./ld_undetect_environ.c -o ./ld_undetect_environ.so $ LD_PRELOAD=./ld_undetect_environ.so ./detect_environ LD_PRELOAD (**environ) [-]</code> </pre><br><h2>  2.3ã€‚  / proc /è‡ªæˆ‘/ </h2><br> ä½†æ˜¯ï¼Œå†…å­˜å¹¶ä¸æ˜¯æ‚¨å¯ä»¥æ£€æµ‹åˆ°<i>LD_PRELOAD</i>æ¬ºéª—çš„æœ€åä¸€ä¸ªåœ°æ–¹ï¼Œè¿˜æœ‰<i>/ proc /</i> ã€‚ è®©æˆ‘ä»¬ä»æ˜¾è€Œæ˜“è§çš„<i>/ proc / {PID} / environå¼€å§‹</i> ã€‚ <br><br> å®é™…ä¸Šï¼Œæœ‰ä¸€ä¸ªé€šç”¨çš„è§£å†³æ–¹æ¡ˆå¯ä»¥<i>æ£€æµ‹</i> <i>**ç¯å¢ƒ</i>å’Œ<i>/ proc / self / environ</i> ã€‚ é—®é¢˜æ˜¯<i>unsetenvï¼ˆenvï¼‰</i>çš„â€œé”™è¯¯â€è¡Œä¸ºã€‚ <br><br><div class="spoiler">  <b class="spoiler_title">æ­£ç¡®çš„é€‰æ‹©</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">evil_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     LD_PRELOAD static const char *ldpreload = "LD_PRELOAD"; int len = strlen(getenv(ldpreload)); evil_env = (char*) malloc(len+1); strcpy(evil_env, getenv(ldpreload)); int i; char env[] = "LD_PRELOAD"; if (environ != NULL) for (i = 0; environ[i] != NULL; i++) { char * pch; pch = strstr(environ[i],env); if(pch != NULL) { //    LD_PRELOAD //unsetenv(env); //  unset     for(int j = 0; environ[i][j] != '\0'; j++) environ[i][j] = '\0'; break; } } }</span></span></code> </pre><br><br><pre> <code class="plaintext hljs">$ gcc -shared -fpic -ldl -Wl,-init,evil_init ./ld_undetect_environ_2.c -o ./ld_undetect_environ_2.so $ (LD_PRELOAD=./ld_undetect_environ_2.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD $</code> </pre><br></div></div><br> ä½†æ˜¯ï¼Œå‡è®¾æˆ‘ä»¬æ²¡æœ‰æ‰¾åˆ°å®ƒï¼Œå¹¶ä¸”<i>/ proc / self / environ</i>åŒ…å«â€œæœ‰é—®é¢˜çš„â€æ•°æ®ã€‚ <br><br> é¦–å…ˆï¼Œå°è¯•ä½¿ç”¨æˆ‘ä»¬ä»¥å‰çš„â€œä¼ªè£…â€ï¼š <br><br><pre> <code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD LD_PRELOAD=./ld_undetect_environ.so</code> </pre><br>  <i>cat</i>ä½¿ç”¨ç›¸åŒçš„<i>openï¼ˆï¼‰</i>æ‰“å¼€æ–‡ä»¶ï¼Œå› æ­¤è§£å†³æ–¹æ¡ˆä¸ç¬¬2.1èŠ‚ä¸­å·²å®Œæˆçš„æ“ä½œç±»ä¼¼ï¼Œä½†æ˜¯ç°åœ¨æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å¤åˆ¶çœŸå®çš„å†…å­˜å€¼ï¼Œè€Œæ— éœ€åŒ…å«<i>LD_PRELOADçš„</i>è¡Œã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;dlfcn.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;fcntl.h&gt; #include &lt;sys/stat.h&gt; #include &lt;unistd.h&gt; #include &lt;limits.h&gt; #include &lt;errno.h&gt; #define BUFFER_SIZE 256 int (*orig_open)(const char*, int oflag) = NULL; char *soname = "fakememory_preload.so"; char *sstrstr(char *str, const char *sub) { int i, found; char *ptr; found = 0; for(ptr = str; *ptr != '\0'; ptr++) { found = 1; for(i = 0; found == 1 &amp;&amp; sub[i] != '\0'; i++){ if(sub[i] != ptr[i]) found = 0; } if(found == 1) break; } if(found == 0) return NULL; return ptr + i; } void fakeMaps(char *original_path, char *fake_path, char *pattern) { int fd; char buffer[BUFFER_SIZE]; int bytes = -1; int wbytes = -1; int k = 0; pid_t pid = getpid(); int fh; if ((fh=orig_open(fake_path,O_CREAT|O_WRONLY))==-1) { printf("LD: Cannot open write-file [%s] (%d) (%s)\n", fake_path, errno, strerror(errno)); exit (42); } if((fd=orig_open(original_path, O_RDONLY))==-1) { printf("LD: Cannot open read-file.\n"); exit(42); } do { char t = 0; bytes = read(fd, &amp;t, 1); buffer[k++] = t; //printf("%c", t); if(t == '\0') { //printf("\n"); if(!sstrstr(buffer, "LD_PRELOAD")) { if((wbytes = write(fh,buffer,k))==-1) { //printf("write error\n"); } else { //printf("writed %d\n", wbytes); } } k = 0; } } while(bytes != 0); close(fd); close(fh); } int open(const char *path, int oflag, ...) { char real_path[PATH_MAX], proc_path[PATH_MAX], proc_path_0[PATH_MAX]; pid_t pid = getpid(); if(!orig_open) orig_open = dlsym(RTLD_NEXT, "open"); realpath(path, real_path); snprintf(proc_path, PATH_MAX, "/proc/%d/environ", pid); if(strcmp(real_path, proc_path) == 0) { snprintf(proc_path, PATH_MAX, "/tmp/%d.fakemaps", pid); realpath(proc_path_0, proc_path); fakeMaps(real_path, proc_path, soname); return orig_open(proc_path, oflag); } return orig_open(path, oflag); }</span></span></span></span></code> </pre><br> åˆ°æ­¤é˜¶æ®µå·²ç»å®Œæˆï¼š <br><br><pre> <code class="plaintext hljs">$ (LD_PRELOAD=./ld_undetect_proc_environ.so cat /proc/self/environ; echo) | tr "\000" "\n" | grep -F LD_PRELOAD $</code> </pre><br> ä¸‹ä¸€ä¸ªæ˜æ˜¾çš„åœ°æ–¹æ˜¯<i>/ proc / self / maps</i> ã€‚ åšæŒä¸‹å»æ˜¯æ²¡æœ‰é“ç†çš„ã€‚ è¯¥è§£å†³æ–¹æ¡ˆä¸å…ˆå‰çš„è§£å†³æ–¹æ¡ˆå®Œå…¨ç›¸åŒï¼šä»æ–‡ä»¶ä¸­å¤åˆ¶æ•°æ®ï¼Œå‡å»<i>libc.so</i>å’Œ<i>ld.so</i>ä¹‹é—´çš„è¡Œã€‚ <br><br><h2>  2.4ã€‚  Chokepointçš„é€‰é¡¹ </h2><br> ç”±äºå…¶ç®€å•æ€§ï¼Œæˆ‘ç‰¹åˆ«å–œæ¬¢æ­¤è§£å†³æ–¹æ¡ˆã€‚ æ¯”è¾ƒç›´æ¥ä»<i>libc</i>åŠ è½½çš„å‡½æ•°çš„åœ°å€å’Œâ€œ NEXTâ€åœ°å€ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;dlfcn.h&gt; #define LIBC "/lib/x86_64-linux-gnu/libc.so.6" int main(int argc, char *argv[]) { void *libc = dlopen(LIBC, RTLD_LAZY); // Open up libc directly char *syscall_open = "open"; int i; void *(*libc_func)(); void *(*next_func)(); libc_func = dlsym(libc, syscall_open); next_func = dlsym(RTLD_NEXT, syscall_open); if (libc_func != next_func) { printf("LD_PRELOAD (syscall - %s) [+]\n", syscall_open); printf("Libc address: %p\n", libc_func); printf("Next address: %p\n", next_func); } else { printf("LD_PRELOAD (syscall - %s) [-]\n", syscall_open); } return 0; }</span></span></span></span></code> </pre><br> æˆ‘ä»¬ä½¿ç”¨æ‹¦æˆª<i>â€œ openï¼ˆï¼‰â€</i>åŠ è½½åº“å¹¶æ£€æŸ¥ï¼š <br><br><pre> <code class="plaintext hljs">$ export LD_PRELOAD=$PWD/ld_undetect_open.so $ ./detect_chokepoint LD_PRELOAD (syscall - open) [+] Libc address: 0x7fa86893b160 Next address: 0x7fa868a26135</code> </pre><br> äº‹å®è¯æ˜åé©³æ›´ä¸ºç®€å•ï¼š <br><br><pre> <code class="plaintext hljs">#define _GNU_SOURCE #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;dlfcn.h&gt; extern void * _dl_sym (void *, const char *, void *); void * dlsym (void * handle, const char * symbol) { return _dl_sym (handle, symbol, dlsym); }</code> </pre><br><pre> <code class="plaintext hljs"># LD_PRELOAD=./ld_undetect_chokepoint.so ./detect_chokepoint LD_PRELOAD (syscall - open) [-]</code> </pre><br><h2>  2.5ã€‚ ç³»ç»Ÿè°ƒç”¨ </h2><br> çœ‹èµ·æ¥å°±è¿™ä¹ˆå¤šï¼Œä½†ä»ç„¶æ¯”æ¯”çš†æ˜¯ã€‚ å¦‚æœæˆ‘ä»¬ç›´æ¥å°†ç³»ç»Ÿè°ƒç”¨å®šå‘åˆ°å†…æ ¸ï¼Œåˆ™å°†ç»•è¿‡æ•´ä¸ªæ‹¦æˆªè¿‡ç¨‹ã€‚ å½“ç„¶ï¼Œä»¥ä¸‹è§£å†³æ–¹æ¡ˆ<i>å–å†³äº</i>ä½“ç³»ç»“æ„ï¼ˆ <i>x86_64</i> ï¼‰ã€‚ è®©æˆ‘ä»¬å°è¯•å®ç°<i>ld.so.preload</i>æ¥æ£€æµ‹æ‰“å¼€ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #define BUFFER_SIZE 256 int syscall_open(char *path, long oflag) { int fd = -1; __asm__ ( "mov $2, %%rax;" // Open syscall number "mov %1, %%rdi;" // Address of our string "mov %2, %%rsi;" // Open mode "mov $0, %%rdx;" // No create mode "syscall;" // Straight to ring0 "mov %%eax, %0;" // Returned file descriptor :"=r" (fd) :"m" (path), "m" (oflag) :"rax", "rdi", "rsi", "rdx" ); return fd; } int main() { syscall_open("/etc/ld.so.preload", O_RDONLY) &gt; 0 ? printf("LD_PRELOAD (open syscall) [+]\n"): printf("LD_PRELOAD (open syscall) [-]\n"); }</span></span></span></span></code> </pre><br><pre> <code class="plaintext hljs">$ ./detect_syscall LD_PRELOAD (open syscall) [+]</code> </pre><br> è€Œè¿™ä¸ªé—®é¢˜æœ‰ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚  <i>ç”·å­</i>æ‘˜å½•ï¼š <br><blockquote>  ptraceæ˜¯ä¸€ä¸ªå·¥å…·ï¼Œå…è®¸çˆ¶è¿›ç¨‹è§‚å¯Ÿå’Œæ§åˆ¶å¦ä¸€ä¸ªè¿›ç¨‹çš„æµï¼ŒæŸ¥çœ‹å’Œæ›´æ”¹å…¶æ•°æ®å’Œå¯„å­˜å™¨ã€‚ é€šå¸¸ï¼Œæ­¤å‡½æ•°ç”¨äºåœ¨è°ƒè¯•ç¨‹åºä¸­åˆ›å»ºæ–­ç‚¹å¹¶è·Ÿè¸ªç³»ç»Ÿè°ƒç”¨ã€‚ <br><br> çˆ¶è¿›ç¨‹å¯ä»¥é€šè¿‡é¦–å…ˆè°ƒç”¨forkï¼ˆ2ï¼‰å‡½æ•°æ¥å¼€å§‹è·Ÿè¸ªï¼Œç„¶åç”Ÿæˆçš„å­è¿›ç¨‹å¯ä»¥æ‰§è¡ŒPTRACE_TRACEMEï¼Œç„¶åï¼ˆé€šå¸¸ï¼‰æ‰§è¡Œexecï¼ˆ3ï¼‰ã€‚ å¦ä¸€æ–¹é¢ï¼Œçˆ¶è¿›ç¨‹å¯ä»¥ä½¿ç”¨PTRACE_ATTACHå¼€å§‹è°ƒè¯•ç°æœ‰è¿›ç¨‹ã€‚ <br><br> è·Ÿè¸ªæ—¶ï¼Œå³ä½¿å¿½ç•¥è¯¥ä¿¡å·ï¼Œå­è¿›ç¨‹ä¹Ÿä¼šåœ¨æ¯æ¬¡æ¥æ”¶åˆ°ä¿¡å·æ—¶åœæ­¢ã€‚  ï¼ˆSIGKILLæ˜¯ä¸€ä¸ªä¾‹å¤–ï¼Œå®ƒä»¥é€šå¸¸çš„æ–¹å¼å·¥ä½œã€‚ï¼‰åœ¨è°ƒç”¨waitï¼ˆ2ï¼‰æ—¶ï¼Œå°†å‘çˆ¶è¿›ç¨‹é€šçŸ¥æ­¤æƒ…å†µï¼Œä¹‹åå®ƒå¯ä»¥åœ¨å¯åŠ¨ä¹‹å‰æŸ¥çœ‹å’Œä¿®æ”¹å­è¿›ç¨‹çš„å†…å®¹ã€‚ ä¹‹åï¼Œçˆ¶è¿›ç¨‹å…è®¸å­©å­ç»§ç»­å·¥ä½œï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¿½ç•¥äº†å‘é€ç»™ä»–çš„ä¿¡å·æˆ–å‘é€å¦ä¸€ä¸ªä¿¡å·ï¼‰ã€‚ <br></blockquote><br> å› æ­¤ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯è·Ÿè¸ªè¿›ç¨‹ï¼Œåœ¨æ¯æ¬¡ç³»ç»Ÿè°ƒç”¨ä¹‹å‰å°†å…¶åœæ­¢ï¼Œå¹¶åœ¨å¿…è¦æ—¶å°†çº¿ç¨‹é‡å®šå‘åˆ°trapå‡½æ•°ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _GNU_SOURCE #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;fcntl.h&gt; #include &lt;stdlib.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;errno.h&gt; #include &lt;limits.h&gt; #include &lt;sys/ptrace.h&gt; #include &lt;sys/wait.h&gt; #include &lt;sys/reg.h&gt; #include &lt;sys/user.h&gt; #include &lt;asm/unistd.h&gt; #if defined(__x86_64__) #define REG_SYSCALL ORIG_RAX #define REG_SP rsp #define REG_IP rip #endif long NOHOOK = 0; long evil_open(const char *path, long oflag, long cflag) { char real_path[PATH_MAX], maps_path[PATH_MAX]; long ret; pid_t pid; pid = getpid(); realpath(path, real_path); if(strcmp(real_path, "/etc/ld.so.preload") == 0) { errno = ENOENT; ret = -1; } else { NOHOOK = 1; // Entering NOHOOK section ret = open(path, oflag, cflag); } // Exiting NOHOOK section NOHOOK = 0; return ret; } void init() { pid_t program; //    program = fork(); if(program != 0) { int status; long syscall_nr; struct user_regs_struct regs; //     if(ptrace(PTRACE_ATTACH, program) != 0) { printf("Failed to attach to the program.\n"); exit(1); } waitpid(program, &amp;status, 0); //   SYSCALLs ptrace(PTRACE_SETOPTIONS, program, 0, PTRACE_O_TRACESYSGOOD); while(1) { ptrace(PTRACE_SYSCALL, program, 0, 0); waitpid(program, &amp;status, 0); if(WIFEXITED(status) || WIFSIGNALED(status)) break; else if(WIFSTOPPED(status) &amp;&amp; WSTOPSIG(status) == SIGTRAP|0x80) { //     syscall_nr = ptrace(PTRACE_PEEKUSER, program, sizeof(long)*REG_SYSCALL); if(syscall_nr == __NR_open) { //       NOHOOK = ptrace(PTRACE_PEEKDATA, program, (void*)&amp;NOHOOK); //   if(!NOHOOK) { //     //   regs  ptrace(PTRACE_GETREGS, program, 0, &amp;regs); // Push return address on the stack regs.REG_SP -= sizeof(long); //       ptrace(PTRACE_POKEDATA, program, (void*)regs.REG_SP, regs.REG_IP); //  RIP   evil_open regs.REG_IP = (unsigned long) evil_open; //     ptrace(PTRACE_SETREGS, program, 0, &amp;regs); } } ptrace(PTRACE_SYSCALL, program, 0, 0); waitpid(program, &amp;status, 0); } } exit(0); } else { sleep(0); } }</span></span></span></span></code> </pre><br> æˆ‘ä»¬æ£€æŸ¥ï¼š <br><br><pre> <code class="plaintext hljs">$ ./detect_syscall LD_PRELOAD (open syscall) [+] $ LD_PRELOAD=./ld_undetect_syscall.so ./detect_syscall LD_PRELOAD (open syscall) [-]</code> </pre><br>  <b>+ 0-0 = 5</b> <br><br> éå¸¸æ„Ÿè°¢ä½  <br><br>  <a href="https://github.com/haxelion" rel="nofollow">æŸ¥å°”æ–¯Â·èƒ¡æœ¬</a> <br>  <a href="https://github.com/chokepoint" rel="nofollow">æ‰¼æµç‚¹</a> <br>  <a href="https://habr.com/ru/users/valdikss/">ç“¦å°”è¿ªå…‹æ–¯</a> <br>  <a href="https://github.com/doegox" rel="nofollow">è²åˆ©æ™®Â·ç‰¹æ–‡</a> <br>  <a href="https://stackoverflow.com/users/2327517/derhass" rel="nofollow">å¾·å“ˆæ–¯</a> <br><br> ä»–ä»¬çš„æ–‡ç« ï¼Œæºä»£ç å’Œæ³¨é‡Šä½¿æˆ‘çš„æ–‡ç« æ¯”æˆ‘åšçš„è¦å¤šå¾—å¤šã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN479858/">https://habr.com/ru/post/zh-CN479858/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN479844/index.html">å¬é›†ä¸€ä¸ªUXè®¾è®¡å¸ˆå›¢é˜Ÿï¼Œç”±äºé›‡ç”¨é”™è¯¯è€ŒæŸå¤±700ä¸‡</a></li>
<li><a href="../zh-CN479848/index.html">æˆ‘ä»¬çš„2019å¹´è±¡é™ï¼ Gartner Meeting Solutionsè§†é¢‘ä¼šè®®åˆ†ææŠ¥å‘Šåœ¨è¿‡å»äº”å¹´ä¸­å‘ç”Ÿäº†æ€æ ·çš„å˜åŒ–</a></li>
<li><a href="../zh-CN479850/index.html">åœ¨Windows Server Core 2019ä¸Šå®‰è£…Exchange 2019</a></li>
<li><a href="../zh-CN479852/index.html">å¹•åè§†é¢‘é€šè¯ï¼šæ¯å¤©ä»æ•°ç™¾ä¸‡åˆ°ä¸€æ¬¡ä¼šè®®çš„100ä½å‚ä¸è€…</a></li>
<li><a href="../zh-CN479854/index.html">12æœˆ12æ—¥ä¸ŠåˆJavaæ‘˜è¦</a></li>
<li><a href="../zh-CN479860/index.html">ç”Ÿæ´»å»ºæ¨¡ä¸»é¢˜çš„å˜ä½“ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN479862/index.html">æ³¨å†Œè½¯ä»¶æ—¶å¦‚ä½•èŠ‚çœ15000å¢å¸ƒ</a></li>
<li><a href="../zh-CN479864/index.html">16å¹´å†…åœ¨WinForms + Cï¼ƒä¸Šè¿›è¡Œæ¸¸æˆï¼ˆç¬¬2éƒ¨åˆ†ï¼‰</a></li>
<li><a href="../zh-CN479870/index.html">æˆ‘ä»¬ä¸ä»…å¯ä»¥éšæ—¶éšåœ°æ›´æ”¹æ¡†æ¶å’Œå·¥ä½œèµ„æ–™ã€‚ PHP NNçš„ç¬¬äºŒä¸ªmitapä¼šå‘ç”Ÿä»€ä¹ˆ</a></li>
<li><a href="../zh-CN479874/index.html">æˆ‘æ˜¯å¦‚ä½•è¿›å…¥ThoughtWorksæˆ–è¿›è¡Œå…¸å‹é¢è¯•çš„</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>