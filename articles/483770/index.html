<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üì∑ üèè üåâ Hacia la automatizaci√≥n SSL ‚òîÔ∏è üçÆ üó®Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Muy a menudo tenemos que trabajar con certificados SSL. Recordemos el proceso de creaci√≥n e instalaci√≥n de un certificado (en el caso general para la ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hacia la automatizaci√≥n SSL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483770/"><p>  Muy a menudo tenemos que trabajar con certificados SSL.  Recordemos el proceso de creaci√≥n e instalaci√≥n de un certificado (en el caso general para la mayor√≠a). </p><br><ul><li>  Encuentre un proveedor (un sitio en el que podamos comprar SSL). </li><li>  Generar CSR. </li><li>  Env√≠elo a su proveedor. </li><li>  Verificar la propiedad del dominio. </li><li>  Obtenga un certificado </li><li>  Convierta el certificado a la forma deseada (opcional).  Por ejemplo, de pem a PKCS # 12. </li><li>  Instale el certificado en el servidor web. </li></ul><br><p> Relativamente r√°pido, no complicado y comprensible.  Esta opci√≥n es bastante adecuada si tenemos un m√°ximo de una docena de proyectos.  ¬øY si hay m√°s y tienen al menos tres entornos?  Desarrollo cl√°sico - puesta en escena - producci√≥n.  En este caso, debe pensar en automatizar este proceso.  Le sugiero que profundice en el problema y encuentre una soluci√≥n que minimice el tiempo requerido para crear y mantener certificados en el futuro.  El art√≠culo presentar√° un an√°lisis del problema y una peque√±a gu√≠a para la repetici√≥n. </p><br><p>  Har√© una reserva por adelantado: la especializaci√≥n principal de nuestra empresa es .net y, en consecuencia, IIS y otros Windows derivados.  Por lo tanto, el cliente ACME y todas sus acciones tambi√©n se describir√°n en t√©rminos de uso de Windows. </p><br><h2>  Para qui√©n es esto relevante y algunos datos fuente </h2><a name="habracut"></a><br><p>  Empresa K representada por el autor.  URL (por ejemplo): company.tld </p><br><p>  El Proyecto X es uno de nuestros proyectos, con el cual llegu√© a la conclusi√≥n de que, de todos modos, debemos avanzar hacia el m√°ximo ahorro de tiempo cuando trabajamos con certificados.  Este proyecto tiene cuatro entornos: desarrollo, prueba, puesta en escena y producci√≥n.  Dev y test est√°n de nuestro lado, la puesta en escena y la producci√≥n est√°n del lado del cliente. </p><br><p>  Una caracter√≠stica del proyecto es que tiene una gran cantidad de m√≥dulos que est√°n disponibles como subdominios. </p><br><p>  Es decir, tenemos la siguiente imagen: </p><br><div class="scrollable-table"><table><thead><tr><th>  Dev </th><th>  Prueba </th><th>  Puesta en escena </th><th>  Producci√≥n </th></tr></thead><tbody><tr><td>  projectX.dev.company.tld </td><td>  projectX.test.company.tld </td><td>  staging.projectX.tld </td><td>  projectX.tld </td></tr><tr><td>  module1.projectX.dev.company.tld </td><td>  module1.projectX.test.company.tld </td><td>  module1.staging.projectX.tld </td><td>  module1.projectX.tld </td></tr><tr><td>  module2.projectX.dev.company.tld </td><td>  module2.projectX.test.company.tld </td><td>  module2.staging.projectX.tld </td><td>  module2.projectX.tld </td></tr><tr><td>  ... </td><td>  ... </td><td>  ... </td><td>  ... </td></tr><tr><td>  moduleN.projectX.dev.company.tld </td><td>  moduleN.projectX.test.company.tld </td><td>  moduleN.staging.projectX.tld </td><td>  moduleN.projectX.tld </td></tr></tbody></table></div><br><p>  Para la producci√≥n, se utiliza el certificado comod√≠n comprado, no hay preguntas.  Pero cubre solo el primer nivel del subdominio.  En consecuencia, si hay un certificado para * .projectX.tld, entonces funcionar√° para staging.projectX.tld, pero para module1.staging.projectX.tld ya no funciona.  Pero no tengo ganas de comprar uno por separado. </p><br><p>  Y este es solo un ejemplo de un proyecto de una compa√±√≠a.  Y el proyecto, por supuesto, no es uno. </p><cut></cut><br><p>  Las razones comunes para que todos aborden este problema se parecen a esto: </p><br><ul><li>  M√°s recientemente, <a href="https://habr.com/ru/company/globalsign/news/t/464159/">Google ha propuesto reducir el per√≠odo de validez m√°ximo de los certificados SSL</a> .  Con todas las consecuencias. </li><li>  Facilitar el proceso de emisi√≥n y mantenimiento de SSL para las necesidades internas de los proyectos y la empresa en su conjunto. </li><li>  Almacenamiento centralizado de entradas de certificados, que resuelve parcialmente el problema de la verificaci√≥n del dominio utilizando DNS y las actualizaciones autom√°ticas posteriores, y tambi√©n resuelve el problema de la confianza del cliente.  Sin embargo, CNAME genera m√°s confianza en el servidor de la empresa asociada / contratista que en un recurso de terceros. </li><li>  Bueno, finalmente, en este caso, la frase "mejor tener que no" encaja perfectamente. </li></ul><br><h2 id="vybor-provaydera-ssl-i-podgotovitelnye-shagi">  Elecci√≥n de un proveedor de SSL y pasos preparatorios </h2><br><p>  De las opciones disponibles para certificados SSL gratuitos, se consideraron cloudflare y letsencrypt.  El DNS para este (y algunos otros proyectos) est√° alojado en cloudflare, pero no soy fan√°tico de usar sus certificados.  Por lo tanto, se decidi√≥ usar letsencrypt. <br>  Para crear un certificado SSL comod√≠n, debe confirmar la propiedad del dominio.  Este procedimiento implica la creaci√≥n de alg√∫n registro DNS (TXT o CNAME), con su posterior verificaci√≥n al emitir un certificado.  Linux tiene una utilidad <a href="https://certbot.eff.org/" rel="nofollow">llamada certbot</a> , que le permite automatizar parcialmente (o completamente para algunos proveedores de DNS) este proceso.  Para Windows, de las opciones de cliente ACME <a href="https://letsencrypt.org/docs/client-options/" rel="nofollow">encontradas y probadas</a> , me <a href="https://pkisharp.github.io/win-acme/" rel="nofollow">decid√≠</a> por <a href="https://pkisharp.github.io/win-acme/" rel="nofollow">WinACME</a> . </p><br><p>  Y se crea el registro para el dominio, procedemos a la creaci√≥n del certificado: </p><br><p><img src="https://habrastorage.org/webt/xb/8a/ay/xb8aayklmjtj7l5mda_oq7o_wvy.png" alt="imagen"></p><br><p>  Estamos interesados ‚Äã‚Äãen la √∫ltima conclusi√≥n, a saber, las opciones disponibles para verificar la propiedad del dominio para emitir un certificado comod√≠n: </p><br><ol><li>  Crear registros DNS manualmente (no se admite la actualizaci√≥n autom√°tica) </li><li>  Creaci√≥n de registros DNS usando el servidor acme-dns (puede encontrar m√°s detalles <a href="https://habr.com/ru/post/350202/">aqu√≠</a> . </li><li>  Crear registros DNS utilizando su propio script (an√°logo del complemento cloudflare para certbot). </li></ol><br><p>  A primera vista, el tercer punto es bastante adecuado, pero si el proveedor de DNS no es compatible con esta funcionalidad?  Y necesitamos un caso general.  Y el caso general son los registros CNAME, todos ellos los admiten.  Por lo tanto, nos detenemos en el punto 2 y vamos a configurar nuestro servidor ACME-DNS. </p><br><h2 id="nastroyka-acme-dns-servera-i-process-vypuska-sertifikata">  Configuraci√≥n del servidor ACME-DNS y el proceso de emisi√≥n de certificados </h2><br><p>  Por ejemplo, cre√© el dominio 2nd.pp.ua, y en el futuro lo usar√©. </p><br><p>  <a href="https://github.com/joohoi/acme-dns" rel="nofollow">Un requisito previo</a> para el correcto funcionamiento del servidor es la creaci√≥n de registros NS y A para su dominio.  Y el primer momento desagradable que encontr√©: cloudflare (al menos en modo de uso libre) no le permite crear simult√°neamente un registro NS y A para el mismo host.  No es que fuera un problema, pero en enlace es posible.  El soporte respondi√≥ que su panel no lo permite.  No importa, crea dos entradas: </p><br><pre><code class="plaintext hljs">acmens.2nd.pp.ua. IN A 35.237.128.147 acme.2nd.pp.ua. IN NS acmens.2nd.pp.ua.</code> </pre> <br><p>  En esta etapa, el host <code>acmens.2nd.pp.ua</code> deber√≠a resolverse. </p><br><pre> <code class="plaintext hljs">$ ping acmens.2nd.pp.ua PING acmens.2nd.pp.ua (35.237.128.147) 56(84) bytes of data</code> </pre> <br><p>  Pero <code>acme.2nd.pp.ua</code> no se resolver√°, ya que el servidor DNS que lo atiende a√∫n no se est√° ejecutando. </p><br><p>  Se crean registros, vaya a configurar y ejecutar el servidor ACME-DNS.  Lo tendr√© en vivo en el servidor ubuntu en el contenedor <a href="https://docs.docker.com/install/linux/docker-ce/ubuntu/" rel="nofollow">docker</a> , pero puedes ejecutarlo donde sea que haya golang.  Windows tambi√©n est√° bien, pero todav√≠a prefiero un servidor Linux. </p><br><p>  Cree los directorios y archivos necesarios: </p><br><pre> <code class="bash hljs">$ mkdir config $ mkdir data $ touch config/config.cfg</code> </pre> <br><p>  Aprovecha <del>  vim </del>  su editor de texto favorito e inserte una <a href="https://github.com/joohoi/acme-dns" rel="nofollow">configuraci√≥n de</a> muestra en config.cfg. </p><br><p>  Para tener √©xito, solo modifique las secciones general y api: </p><br><pre> <code class="plaintext hljs">[general] listen = "0.0.0.0:53" protocol = "both" domain = "acme.2nd.pp.ua" nsname = "acmens.2nd.pp.ua" nsadmin = "admin.2nd.pp.ua" records = "acme.2nd.pp.ua. A 35.237.128.147", "acme.2nd.pp.ua. NS acmens.2nd.pp.ua.", ] ... [api] ... tls = "letsencrypt" ‚Ä¶</code> </pre> <br><p>  Adem√°s, si lo desea, cree un archivo docker-compose en el directorio principal del servicio: </p><br><pre> <code class="plaintext hljs">version: '3.7' services: acmedns: image: joohoi/acme-dns:latest ports: - "443:443" - "53:53" - "53:53/udp" - "80:80" volumes: - ./config:/etc/acme-dns:ro - ./data:/var/lib/acme-dns</code> </pre> <br><p>  Listo  Puedes correr </p><br><pre> <code class="bash hljs">$ docker-compose up -d</code> </pre> <br><p>  En esta etapa, el host <code>acme.2nd.pp.ua</code> deber√≠a comenzar a <code>acme.2nd.pp.ua</code> , y 404 deber√≠a aparecer en <code>https://acme.2nd.pp.ua</code> </p><br><pre> <code class="bash hljs">$ ping acme.2nd.pp.ua PING acme.2nd.pp.ua (35.237.128.147) 56(84) bytes of data. $ curl https://acme.2nd.pp.ua 404 page not found</code> </pre> <br><p>  Si esto no apareciera - <code>docker logs -f &lt;container_name&gt;</code> para ayudar, afortunadamente, los registros son bastante legibles. </p><br><p>  Podemos comenzar a crear un certificado.  Abra powershell como administrador y ejecute winacme.  Estamos interesados ‚Äã‚Äãen la elecci√≥n: </p><br><ul><li>  M: Crear nuevo certificado (opciones completas) </li><li>  2: entrada manual </li><li>  2: [dns-01] Cree registros de verificaci√≥n con acme-dns ( <a href="https://github.com/joohoi/acme-dns" rel="nofollow">https://github.com/joohoi/acme-dns</a> ) </li><li>  Cuando se nos pregunt√≥ sobre el enlace al servidor ACME-DNS, ingresamos la URL del servidor creado (https) en respuesta.  URL del servidor acme-dns: <a href="https://acme.2nd.pp.ua/" rel="nofollow">https://acme.2nd.pp.ua</a> </li></ul><br><p>  En el servidor, el cliente emite una entrada que debe agregarse al servidor DNS existente (procedimiento √∫nico): </p><br><pre> <code class="plaintext hljs">[INFO] Creating new acme-dns registration for domain 1nd.pp.ua Domain: 1nd.pp.ua Record: _acme-challenge.1nd.pp.ua Type: CNAME Content: c82a88a5-499f-464f-96e4-be7f606a3b47.acme.2nd.pp.ua. Note: Some DNS control panels add the final dot automatically. Only one is required.</code> </pre> <br><p><img src="https://habrastorage.org/webt/v9/fa/2g/v9fa2gnoq7c5cfjqapys5ta0agg.png" alt="imagen"></p><br><p>  Creamos el registro necesario y nos aseguramos de que se haya creado correctamente: </p><br><p><img src="https://habrastorage.org/webt/lj/pa/qn/ljpaqnz56dj9kynsb-7cb44eqvc.png" alt="imagen"></p><br><pre> <code class="plaintext hljs">$ dig CNAME _acme-challenge.1nd.pp.ua +short c82a88a5-499f-464f-96e4-be7f606a3b47.acme.2nd.pp.ua.</code> </pre> <br><p>  Confirmamos que creamos la entrada necesaria en winacme y continuamos el proceso de creaci√≥n del certificado: </p><br><p><img src="https://habrastorage.org/webt/6y/zk/2y/6yzk2y9n4-mcboxlhhwlqngem28.png" alt="imagen"></p><br><p>  Aqu√≠ se describe c√≥mo usar certbot como cliente. </p><br><p>  Esto completa el proceso de creaci√≥n de un certificado, puede instalarlo en un servidor web y usarlo.  Si, al crear un certificado, tambi√©n se crea una tarea en el planificador, en el futuro el proceso de renovaci√≥n del certificado se realizar√° autom√°ticamente. </p></div></div><p>Source: <a href="https://habr.com/ru/post/483770/">https://habr.com/ru/post/483770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../483756/index.html">Hacemos solicitudes HTTP, degradamos con gracia (y no una sola brecha)</a></li>
<li><a href="../483758/index.html">Las 10 nuevas empresas de desarrollo de aplicaciones m√≥viles pueden asociarse en 2020</a></li>
<li><a href="../483762/index.html">GitLab 12.6 lanzado con calificaciones de seguridad del proyecto y materiales de lanzamiento</a></li>
<li><a href="../483766/index.html">Los tribunales como una herramienta de pirater√≠a social o un poco sobre la fiabilidad de la informaci√≥n en las bases de datos de WHOIS</a></li>
<li><a href="../483768/index.html">MVCC en PostgreSQL-5. Vac√≠o en la p√°gina y actualizaciones CALIENTES</a></li>
<li><a href="../483774/index.html">El resumen de eventos para profesionales de recursos humanos en TI para enero de 2020</a></li>
<li><a href="../483776/index.html">Introducci√≥n al m√©todo diferencial sem√°ntico en 5 minutos.</a></li>
<li><a href="../483778/index.html">Semana de la seguridad 03: Principios responsables del informe de errores</a></li>
<li><a href="../483780/index.html">¬øQu√© es la holgura y c√≥mo funciona?</a></li>
<li><a href="../483784/index.html">C√≥mo hacer una aplicaci√≥n multiinquilino a partir de una aplicaci√≥n no inquilina</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>