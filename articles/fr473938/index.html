<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🛌🏼 🤦🏼 👌🏼 Stockez universellement les paramètres d'application via IConfiguration 💆🏻 🅾️ 🕰️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans le cadre du développement du produit Docs Security Suit, nous avons été confrontés à la tâche de stocker de nombreux types de paramètres d'applic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Stockez universellement les paramètres d'application via IConfiguration</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/crosstech/blog/473938/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/tf/6j/vp/tf6jvphlyvlsfqvz9bt4bwyec9c.jpeg" alt="image"></div><br>  Dans le cadre du développement du produit Docs Security Suit, nous avons été confrontés à la tâche de stocker de nombreux types de paramètres d'application différents à la fois dans la base de données et dans les configurations.  Et aussi pour qu'ils puissent être lus et écrits facilement.  Ici, l'interface IConfiguration nous aidera, d'autant plus qu'elle est universelle et pratique à utiliser, ce qui vous permettra de stocker toutes sortes de paramètres en un seul endroit <br><a name="habracut"></a><br><h3>  Définition des tâches </h3><br>  Les applications ASP.Net Core ont désormais la possibilité de travailler avec les paramètres d'application via l'interface IConfiguration.  De nombreux articles ont été écrits pour travailler avec lui.  Cet article présentera l'expérience de l'utilisation d'IConfiguration pour stocker les paramètres de notre application, tels que les paramètres de connexion à un serveur LDAP, à un serveur SMTP, etc.  L'objectif est de configurer le mécanisme existant pour travailler avec les configurations d'application afin de travailler avec la base de données.  Dans cet article, vous ne trouverez pas de description de l'approche standard pour l'utilisation de l'interface. <br><br>  L'architecture d'application est construite sur DDD en collaboration avec CQRS.  De plus, nous savons que l'objet d'interface IConfiguration stocke tous les paramètres sous forme de paire clé-valeur.  Par conséquent, nous avons d'abord décrit une certaine essence des paramètres du domaine sous cette forme: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Settings</span></span>: <span class="hljs-title"><span class="hljs-title">Entity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Key { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Settings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Settings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { Key = key; SetValue(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { Value = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre> <br>  Le projet utilise EF Core comme ORM.  Et la migration est responsable de FluentMigrator. <br>  Ajoutez une nouvelle entité à notre contexte: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptions options</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DbSet&lt;Settings&gt; Settings { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } … }</code> </pre><br>  Ensuite, pour notre nouvelle entité, nous devons décrire la configuration d'EF: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SettingsConfiguration</span></span> : <span class="hljs-title"><span class="hljs-title">IEntityTypeConfiguration</span></span>&lt;<span class="hljs-title"><span class="hljs-title">Settings</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configure</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EntityTypeBuilder&lt;Settings&gt; builder</span></span></span><span class="hljs-function">)</span></span> { builder.ToTable(<span class="hljs-string"><span class="hljs-string">"Settings"</span></span>); } }</code> </pre><br>  Et écrivez une migration pour cette entité: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Migration(2019020101)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddSettings</span></span>: <span class="hljs-title"><span class="hljs-title">AutoReversingMigration</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Up</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Create.Table(<span class="hljs-string"><span class="hljs-string">"Settings"</span></span>) .WithColumn(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Settings.Id)).AsInt32().PrimaryKey().Identity() .WithColumn(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Settings.Key)).AsString().Unique() .WithColumn(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Settings.Value)).AsString(); } }</code> </pre><br>  Et où est la IConfiguration mentionnée? <br><br><h3>  Nous utilisons l'interface IConfigurationRoot </h3><br>  Notre projet a une application api basée sur ASP.NET Core MVC.  Et par défaut, nous utilisons IConfiguration pour le stockage standard des paramètres d'application, par exemple pour la connexion à la base de données: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Startup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfiguration configuration</span></span></span><span class="hljs-function">)</span></span> { Configuration = configuration; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IConfiguration Configuration { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OptionsAction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbContextOptionsBuilder options</span></span></span><span class="hljs-function">)</span></span> =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"MyDatabase"</span></span>)); services.AddDbContext&lt;MyContext&gt;(OptionsAction); ... }</code> </pre><br>  Ces paramètres sont stockés par défaut dans des variables d'environnement: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IWebHostBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateWebHostBuilder</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> =&gt; WebHost.CreateDefaultBuilder(args) .ConfigureAppConfiguration((hostingContext, config) =&gt; { config.AddEnvironmentVariables(); })</code> </pre><br>  Et selon l'idée, nous pouvons utiliser cet objet pour stocker les paramètres prévus, mais ils se recouperont ensuite avec les paramètres généraux de l'application elle-même (comme mentionné ci-dessus - connexion à la base de données) <br><br>  Afin de séparer les objets connectés dans la DI, nous avons décidé d'utiliser l'interface enfant IConfigurationRoot: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddScoped&lt;IConfigurationRoot&gt;(); ... }</code> </pre><br>  Lorsque vous le connectez au conteneur de notre service, nous pouvons travailler en toute sécurité avec un objet de paramètres configuré séparément, sans interférer avec les paramètres de l'application elle-même. <br><br>  Cependant, notre objet dans le conteneur ne sait rien de notre essence dans le domaine et comment travailler avec la base de données. <br><br><img src="https://habrastorage.org/webt/ar/yq/7u/aryq7ut198vmkakyvr9rzule5fc.jpeg" alt="image"><br><br><h3>  Nous décrivons le nouveau fournisseur de configuration </h3><br>  Rappelons que notre tâche consiste à stocker les paramètres dans la base de données.  Et pour cela, vous devez décrire le nouveau fournisseur de configuration IConfigurationRoot, hérité de ConfigurationProvider.  Pour que le nouveau fournisseur fonctionne correctement, nous devons décrire la méthode de lecture à partir de la base de données - Load () et la méthode d'écriture dans la base de données - Set (): <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EFSettingsProvider</span></span> : <span class="hljs-title"><span class="hljs-title">ConfigurationProvider</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EFSettingsProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyContext myContext</span></span></span><span class="hljs-function">)</span></span> { _myContext = myContext; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MyContext _myContext; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Data = _myContext.Settings.ToDictionary(c =&gt; c.Key, c =&gt; c.Value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Set</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.Set(key, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; { { key, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> } }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> val = _myContext.Settings.FirstOrDefault(v =&gt; v.Key == key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (val != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; val.Value.Any()) val.SetValue(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> _myContext.Settings.AddRange(configValues .Select(kvp =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Settings(kvp.Key, kvp.Value)) .ToArray()); _myContext.SaveChanges(); } }</code> </pre><br>  Ensuite, vous devez décrire une nouvelle source pour notre configuration qui implémente IConfigurationSource: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EFSettingsSource</span></span> : <span class="hljs-title"><span class="hljs-title">IConfigurationSource</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DssContext _dssContext; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">EFSettingSource</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyContext myContext</span></span></span><span class="hljs-function">)</span></span> { _myContext = myContext; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IConfigurationProvider </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Build</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationBuilder builder</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EFSettingsProvider(_myContext); } }</code> </pre><br>  Et pour plus de simplicité, ajoutez l'extension à IConfigurationBuilder: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IConfigurationBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddEFConfiguration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IConfigurationBuilder builder, MyContext myContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> builder.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EFSettingSource(myContext)); }</code> </pre><br>  Maintenant, nous pouvons spécifier le fournisseur décrit par nous à l'endroit où nous connectons l'objet à la DI: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConfigureServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IServiceCollection services</span></span></span><span class="hljs-function">)</span></span> { services.AddScoped&lt;IConfigurationRoot&gt;(provider =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myContext = provider.GetService&lt;MyContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configurationBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationBuilder(); configurationBuilder.AddEFConfiguration(myContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configurationBuilder.Build(); }); ... }</code> </pre><br>  Que nous ont apporté nos manipulations avec le nouveau fournisseur? <br><br><h3>  IConfigurationRoot Exemples </h3><br>  Tout d'abord, définissons un certain modèle Dto qui sera diffusé au client de notre application, par exemple, pour stocker les paramètres de connexion à ldap: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LdapSettingsDto</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> UserName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Password { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Address { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Depuis la «boîte», IConfiguration peut bien écrire et lire une instance d'un objet.  Et pour travailler avec la collection, de petites améliorations sont nécessaires. <br><br>  Pour stocker plusieurs objets du même type, nous avons écrit une extension pour IConfigurationRoot: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetDataFromObjectProperties</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IConfigurationRoot config, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> indexProperty = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"Id"</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   var type = obj.GetType(); int id; try { //   id = int.Parse(type.GetProperty(indexProperty).GetValue(obj).ToString()); } catch (Exception ex) { throw new Exception($"   {indexProperty}  {type.Name}", ex.InnerException); } //   0,            indexProperty if (id == 0) { var maxId = config.GetSection(type.Name) .GetChildren().SelectMany(x =&gt; x.GetChildren()); var mm = maxId .Where(c =&gt; c.Key == indexProperty) .Select(v =&gt; int.Parse(v.Value)) .DefaultIfEmpty() .Max(); id = mm + 1; try { type.GetProperty(indexProperty).SetValue(obj, id); } catch (Exception ex) { throw new Exception($"   {indexProperty}  {type.Name}", ex.InnerException); } } //         foreach (var field in type.GetProperties()) { var key = $"{type.Name}:{id.ToString()}:{field.Name}"; if (!string.IsNullOrEmpty(field.GetValue(obj)?.ToString())) { config[key] = field.GetValue(obj).ToString(); } } }</span></span></code> </pre><br>  Ainsi, nous pouvons travailler avec plusieurs instances de nos paramètres. <br><br><h3>  Exemple d'écriture des paramètres dans la base de données </h3><br>  Comme mentionné ci-dessus, notre projet utilise l'approche CQRS.  Pour écrire les paramètres, nous décrivons une commande simple: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddLdapSettingsCommand</span></span> : <span class="hljs-title"><span class="hljs-title">IRequest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">ICommandResult</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> LdapSettingsDto LdapSettings { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddLdapSettingsCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">LdapSettingsDto ldapSettings</span></span></span><span class="hljs-function">)</span></span> { LdapSettings = ldapSettings; } }</code> </pre><br>  Et puis le gestionnaire de notre équipe: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddLdapSettingsCommandHandler</span></span> : <span class="hljs-title"><span class="hljs-title">IRequestHandler</span></span>&lt;<span class="hljs-title"><span class="hljs-title">AddLdapSettingsCommand</span></span>, <span class="hljs-title"><span class="hljs-title">ICommandResult</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IConfigurationRoot _settings; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddLdapSettingsCommandHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationRoot settings</span></span></span><span class="hljs-function">)</span></span> { _settings = settings; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;ICommandResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">AddLdapSettingsCommand request, CancellationToken cancellationToken</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _settings.SetDataFromObjectProperties(request.LdapSettings); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CommandResult.Exception(ex.Message, ex); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Run(() =&gt; CommandResult.Success, cancellationToken); } }</code> </pre><br>  Par conséquent, nous pouvons écrire les données de nos paramètres LDAP dans la base de données sur une seule ligne conformément à la logique décrite. <br><br>  Dans la base de données, nos paramètres ressemblent à ceci: <br><br><img src="https://habrastorage.org/webt/lu/fl/nr/luflnrdj-uf4dh4vwpgx_vu53_a.png" alt="image"><br><br><h3>  Exemple de lecture des paramètres de la base de données </h3><br>  Pour lire les paramètres LDAP, nous écrirons une requête simple: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GetLdapSettingsByIdQuery</span></span> : <span class="hljs-title"><span class="hljs-title">IRequest</span></span>&lt;<span class="hljs-title"><span class="hljs-title">LdapSettingsDto</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLdapSettingsByIdQuery</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> { Id = id; } }</code> </pre><br>  Et puis le gestionnaire de notre demande: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GetLdapSettingsByIdQueryHandler</span></span> : <span class="hljs-title"><span class="hljs-title">IRequestHandler</span></span>&lt;<span class="hljs-title"><span class="hljs-title">GetLdapSettingsByIdQuery</span></span>, <span class="hljs-title"><span class="hljs-title">LdapSettingsDto</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IConfigurationRoot _settings; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLdapSettingsByIdQueryHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IConfigurationRoot settings</span></span></span><span class="hljs-function">)</span></span> { _settings = settings; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;LdapSettingsDto&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Handle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GetLdapSettingsByIdQuery request, CancellationToken cancellationToken</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ldapSettings = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;LdapSettingsDto&gt;(); _settings.Bind(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(LdapSettingsDto), ldapSettings); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ldapSettingsDto = ldapSettings.FirstOrDefault(ls =&gt; ls.Id == request.Id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task.Run(() =&gt; ldapSettingsDto, cancellationToken); } }</code> </pre><br>  Comme nous le voyons dans l'exemple, en utilisant la méthode Bind, nous remplissons notre objet ldapSettings avec des données de la base de données - par le nom LdapSettingsD, nous déterminons la clé (section) par laquelle nous devons recevoir les données, puis la méthode Load décrite dans notre fournisseur est appelée. <br><br><h3>  Et ensuite? </h3><br>  Et puis nous prévoyons d'ajouter toutes sortes de paramètres dans l'application à notre référentiel partagé. <br><br>  Nous espérons que notre solution vous sera utile et vous partagerez vos questions et commentaires avec nous. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr473938/">https://habr.com/ru/post/fr473938/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr473924/index.html">Non seulement SMS et jeton: authentification multifacteur basée sur le service d'authentification SafeNet</a></li>
<li><a href="../fr473928/index.html">Extinction de fichiers informatiques</a></li>
<li><a href="../fr473930/index.html">HTTP / 3: briser les fondations et un nouveau monde courageux</a></li>
<li><a href="../fr473932/index.html">Comment fonctionne une IA de jeu hybride et quels sont ses avantages</a></li>
<li><a href="../fr473936/index.html">Performances audio interactives - Une nouvelle ère de jeux d'assistant vocal</a></li>
<li><a href="../fr473940/index.html">Test de résistance: nanomécanique de la nacre noble nacre</a></li>
<li><a href="../fr473944/index.html">Conseils du créateur de RimWorld: distorsions cognitives pour prédire un fan du jeu</a></li>
<li><a href="../fr473946/index.html">Journalisation et suivi distribués pour les microservices</a></li>
<li><a href="../fr473948/index.html">Operon: accélère les performances d'Ansible</a></li>
<li><a href="../fr473950/index.html">Mettre en œuvre, évoluer: l'expérience de l'utilisation des autotests dans VTB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>