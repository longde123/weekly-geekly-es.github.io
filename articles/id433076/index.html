<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêπ üéí ü§∑ Bagaimana kami membuat pustaka Galeri Android kami untuk melihat konten media üö± üë®‚Äçüé® ü§∞üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo, Habr! Belum lama ini, dalam mencari petualangan, proyek dan teknologi baru, saya  menjadi robot  menetap di Redmadrobot. Saya mendapatkan kursi,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana kami membuat pustaka Galeri Android kami untuk melihat konten media</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redmadrobot/blog/433076/"><p><img src="https://habrastorage.org/webt/fl/a3/rh/fla3rh2hkzl_guxybjkro7f8hua.png"><br><br>  Halo, Habr!  Belum lama ini, dalam mencari petualangan, proyek dan teknologi baru, saya <del>  menjadi robot </del>  menetap di Redmadrobot.  Saya mendapatkan kursi, monitor dan macbook, dan proyek internal kecil untuk pemanasan.  Itu perlu untuk menyelesaikan dan menerbitkan perpustakaan yang ditulis sendiri untuk melihat konten media yang kami gunakan dalam proyek kami.  Dalam artikel ini, saya akan memberi tahu Anda cara memahami acara sentuh dalam seminggu, menjadi sumber terbuka, menemukan bug di Android SDK dan menerbitkan perpustakaan. </p><a name="habracut"></a><br><h2 id="nachalo">  Mulai </h2><br><p>  Salah satu fitur penting dari aplikasi toko kami adalah kemampuan untuk melihat video dan foto barang dan jasa di dekat dan dari semua sisi.  Kami tidak ingin menemukan kembali roda dan mencari perpustakaan yang sudah jadi yang cocok untuk kami. </p><br><p>  Kami berencana untuk menemukan solusi seperti itu sehingga pengguna dapat: </p><br><ul><li>  lihat foto; </li><li>  Skala foto menggunakan pinch to zoom dan double tap; </li><li>  Tonton video </li><li>  membalik konten media; </li><li>  tutup kartu foto dengan sapuan vertikal (gesek untuk menghilangkan). </li></ul><br><p>  Inilah yang kami temukan: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">FrescoImageViewer</a> - mendukung melihat dan menggulir foto dan gerakan dasar, tetapi tidak mendukung menonton video dan ditujukan untuk perpustakaan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Fresco</a> . </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PhotoView</a> - mendukung melihat foto, sebagian besar gerakan kontrol utama, kecuali menggulir, menggesek untuk mengabaikan, tidak mendukung menonton video. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">PhotoDraweeView</a> - fungsionalitasnya mirip dengan PhotoView, tetapi ditujukan untuk Fresco. </li></ul><br><p>  Karena tidak ada perpustakaan yang sepenuhnya memenuhi persyaratan, kami harus menulis sendiri. </p><br><h2 id="realizuem-biblioteku">  Kami menyadari perpustakaan </h2><br><p>  Untuk mendapatkan fungsionalitas yang diperlukan, kami menyelesaikan solusi yang ada dari perpustakaan lain.  Mereka memutuskan untuk memberikan nama sederhana <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Galeri Android untuk</a> apa yang terjadi. </p><br><h3 id="realizuem-funkcionalnost">  Kami menerapkan fungsionalitas </h3><br><p>  <strong>Lihat dan perbesar foto</strong> <br>  Untuk melihat foto, kami mengambil perpustakaan PhotoView, yang mendukung penskalaan di luar kotak. </p><br><p>  <strong>Tonton video</strong> <br>  Untuk menonton video, mereka mengambil <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ExoPlayer</a> , yang digunakan kembali di <a href="">MediaPagerAdapter</a> .  Saat pengguna membuka video untuk pertama kalinya, ExoPlayer dibuat.  Saat beralih ke elemen lain, ia di-antri, jadi saat Anda memulai video berikutnya, instance ExoPlayer yang sudah dibuat akan digunakan.  Ini membuat transisi antar elemen lebih lancar. </p><br><p> <strong>Menggulir Konten Media</strong> <br>  Di sini kami menggunakan <a href="">MultiTouchViewPager</a> dari FrescoImageViewer, yang tidak mencegat acara multi-sentuh, jadi kami dapat menambahkan gerakan untuk skala gambar. </p><br><p>  <strong>Geser untuk mengabaikan</strong> <br>  PhotoView tidak mendukung gesek untuk menghilangkan dan melonggarkan (mengembalikan ukuran gambar asli ketika gambar ditingkatkan atau turun). <br>  Beginilah cara kami menanganinya. </p><br><h3 id="izuchaem-touch-events-dlya-realizacii-swipe-to-dismiss">  Mempelajari acara sentuh untuk menerapkan gesek untuk menghilangkan </h3><br><p> Sebelum melanjutkan untuk mendukung swipe untuk diberhentikan, Anda harus memahami cara kerja sentuh.  Ketika pengguna menyentuh layar, metode <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> dipanggil dalam Aktivitas saat ini, di mana <code>MotionEvent.ACTION_DOWN</code> dapat <code>MotionEvent.ACTION_DOWN</code> .  Metode ini menentukan nasib acara.  Anda dapat meneruskan <code>motionEvent</code> ke <code>onTouchEvent(motionEvent: MotionEvent)</code> untuk pemrosesan sentuh, atau membiarkannya melangkah lebih jauh, dari atas ke bawah, dalam hierarki tampilan.  Lihat, yang tertarik pada suatu acara dan / atau acara berikutnya sebelum <code>ACTION_UP</code> , mengembalikan true. </p><br><p>  Setelah itu, semua peristiwa gerakan saat ini akan jatuh ke tampilan ini sampai gerakan berakhir dengan acara <code>ACTION_UP</code> atau orang tua yang ViewGroup mengambil kendali (maka acara <code>ACTION_CANCELED</code> akan datang ke <code>ACTION_CANCELED</code> ).  Jika acara berjalan di sekitar seluruh hierarki Tampilan dan tidak ada yang tertarik, itu kembali ke Activity di <code>onTouchEvent(motionEvent: MotionEvent)</code> . <br><br><img src="https://habrastorage.org/webt/yz/np/jd/yznpjdfaodnwmd3tzy_wldagyak.png"><br><br>  Di perpustakaan Galeri Android kami, acara <code>ACTION_DOWN</code> pertama mencapai <code>dispatchTouchEvent()</code> di PhotoView, di mana <code>motionEvent</code> diteruskan ke implementasi <code>onTouch()</code> , yang mengembalikan true.  Selanjutnya, semua acara melalui rantai yang sama sampai salah satu dari: </p><br><ul><li>  <code>ACTION_UP</code> ; </li><li>  ViewPager akan mencoba mencegat acara untuk bergulir; </li><li>  <a href="">VerticalDragLayout</a> akan mencoba untuk mencegat acara agar swipe untuk diberhentikan </li></ul><br><p>  Hanya ViewGroup di metode <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> yang dapat mencegat acara.  Bahkan jika View tertarik pada MotionEvent apa pun, acara itu sendiri akan melalui <code>dispatchTouchEvent(motionEvent: MotionEvent)</code> seluruh ViewGroup sebelumnya.  Karenanya, orang tua selalu "mengawasi" anak-anak mereka.  Setiap induk ViewGroup dapat mencegat acara dan mengembalikan true dalam metode <code>onInterceptTouchEvent(motionEvent: MotionEvent)</code> , maka semua <code>MotionEvent.ACTION_CANCEL</code> anak akan menerima <code>MotionEvent.ACTION_CANCEL</code> di <code>onTouchEvent(motionEvent: MotionEvent)</code> . </p><br><p>  Contoh: pengguna memegang jari pada elemen dalam RecyclerView, lalu acara diproses dalam elemen yang sama.  Tetapi begitu dia mulai menggerakkan jarinya ke atas / bawah, RecyclerView akan mencegat acara, dan gulir akan dimulai, dan Tampilan akan menerima acara <code>ACTION_CANCEL</code> . <br><br><img src="https://habrastorage.org/webt/yp/x9/kf/ypx9kf8alvwtag0jfihj-jrzjmo.png"><br><br>  Di Galeri Android, VerticalDragLayout dapat mencegat acara untuk dihapus atau ViewPager untuk digulir.  Tetapi View dapat mencegah orang tua dari <code>requestDisallowInterceptTouchEvent(true)</code> peristiwa dengan memanggil metode <code>requestDisallowInterceptTouchEvent(true)</code> .  Ini mungkin diperlukan jika Tampilan perlu melakukan tindakan yang intersepsi oleh orang tua tidak diinginkan untuk kita. </p><br><p>  Misalnya, ketika pengguna dalam pemain melompati trek ke waktu tertentu.  Jika ViewPager induk mencegat gulir horizontal, akan ada transisi ke trek berikutnya. </p><br><p>  Untuk menangani gesek untuk menghilangkan, kami menulis VerticalDragLayout, tetapi tidak menerima acara sentuh dari PhotoView.  Untuk memahami mengapa ini terjadi, saya harus mencari tahu bagaimana acara sentuh diproses dalam PhotoView. </p><br><p>  Memproses pesanan: </p><br><ol><li>  Ketika MotionEvent.ACTION_DOWN di VerticalDragLayout, <code>interceptTouchEvent()</code> dipicu, yang mengembalikan false, karena  ViewGroup ini hanya tertarik pada ACTION_MOVE vertikal.  Arah ACTION_MOVE didefinisikan dalam <code>dispatchTouchEvent()</code> , setelah peristiwa dilewatkan ke metode <code>super.dispatchTouchEvent()</code> di ViewGroup, di mana acara diteruskan ke implementasi <code>interceptTouchEvent()</code> di VerticalDragLayout. <br><br><img src="https://habrastorage.org/webt/le/zg/xb/lezgxbf8n-_tnhdpqc96drpjqvm.png"><br><br></li><li>  Ketika acara <code>ACTION_DOWN</code> mencapai metode <code>onTouch()</code> di PhotoView, tampilan menghilangkan kemampuan untuk mencegat manajemen acara.  Semua peristiwa gerakan berikutnya tidak termasuk dalam metode <code>interceptTouchEvent()</code> .  Kemampuan untuk mencegat kontrol diberikan kepada orang tua hanya jika gerakan selesai atau jika <code>ACTION_MOVE</code> horizontal <code>ACTION_MOVE</code> di batas kanan / kiri gambar. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScrollEdge == EDGE_BOTH || (mScrollEdge == EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mScrollEdge == EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p><img src="https://habrastorage.org/webt/kk/s3/pj/kks3pjkovqsyiyiaif64bc_qh3e.png"><br><br>  Karena PhotoView memungkinkan orang tua untuk mengambil kendali hanya dalam kasus horisontal <code>ACTION_MOVE</code> , dan gesek untuk mengabaikan adalah <code>ACTION_MOVE</code> vertikal, maka VerticalDragLayout tidak dapat mencegat kontrol acara untuk menerapkan gerakan.  Untuk memperbaikinya, Anda perlu menambahkan kemampuan untuk mencegat kontrol jika <code>ACTION_MOVE</code> vertikal. <br></p><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mAllowParentInterceptOnEdge &amp;&amp; !mScaleDragDetector.isScaling() &amp;&amp; !mBlockParentIntercept) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mHorizontalScrollEdge == HORIZONTAL_EDGE_BOTH || (mHorizontalScrollEdge == HORIZONTAL_EDGE_LEFT &amp;&amp; dx &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mHorizontalScrollEdge == HORIZONTAL_EDGE_RIGHT &amp;&amp; dx &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>) || mVerticalScrollEdge == VERTICAL_EDGE_BOTH || (mVerticalScrollEdge == VERTICAL_EDGE_TOP &amp;&amp; dy &gt;= <span class="hljs-number"><span class="hljs-number">1f</span></span>) || (mVerticalScrollEdge == VERTICAL_EDGE_BOTTOM &amp;&amp; dy &lt;= -<span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parent != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { parent.requestDisallowInterceptTouchEvent(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } }</code> </pre> <br><p>  Sekarang, dalam kasus vertikal <code>ACTION_MOVE</code> pertama akan memberikan kesempatan untuk mencegat induk: <br><br><img src="https://habrastorage.org/webt/j7/ea/_z/j7ea_zwmamtooghpppzcyxl-bne.png"><br><br>  <code>ACTION_MOVE</code> berikut akan dicegat di VerticalDragLyout, dan acara <code>ACTION_CANCEL</code> akan terbang ke tampilan anak: <br><br><img src="https://habrastorage.org/webt/jb/ag/tz/jbagtzmul81dakmf0nujxzumw6u.png"><br><br>  Semua <code>ACTION_MOVE</code> lainnya akan terbang ke VerticalDragLayout di sepanjang rantai standar.  Adalah penting bahwa setelah ViewGroup mengendalikan acara dari Tampilan anak, Tampilan anak tidak dapat mendapatkan kembali kontrol. <br><br><img src="https://habrastorage.org/webt/ud/ql/yv/udqlyv7d4-aigffi5hdwypwfy5u.png"><br><br>  Jadi kami menerapkan gesek untuk mengabaikan dukungan untuk perpustakaan PhotoView.  Di perpustakaan kami, kami menggunakan sumber PhotoView yang dimodifikasi yang diambil dalam modul terpisah, dan membuat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">permintaan penggabungan</a> dalam repositori PhotoView asli. <br><br></p><h3 id="realizuem-debauns-v-photoview">  Kami menerapkan debind di PhotoView </h3><br><p>  Ingat bahwa debounce adalah pemulihan animasi dari skala yang dapat diterima ketika gambar diskalakan melampaui batasnya. <br><br><img src="https://habrastorage.org/webt/op/rv/wb/oprvwbemhg9ikmrm1zfv45w6fvo.gif"><br><br>  Tidak ada kemungkinan seperti itu di PhotoView.  Tetapi karena kami mulai menggali sumber terbuka orang lain, mengapa berhenti di situ?  Di PhotoView, Anda dapat mengatur batas zoom.  Awalnya, ini adalah minimum - x1 dan maksimum - x3.  Gambar tidak dapat melampaui batas ini. </p><br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> scaleFactor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusX, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> focusY)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((getScale() &lt; mMaxScale || scaleFactor &lt; <span class="hljs-number"><span class="hljs-number">1f</span></span>) &amp;&amp; (getScale() &gt; mMinScale || scaleFactor &gt; <span class="hljs-number"><span class="hljs-number">1f</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mScaleChangeListener != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mScaleChangeListener.onScaleChange(scaleFactor, focusX, focusY); } mSuppMatrix.postScale(scaleFactor, scaleFactor, focusX, focusY); <span class="hljs-comment"><span class="hljs-comment">//      checkAndDisplayMatrix(); } }</span></span></code> </pre> <br><p>  Untuk mulai dengan, kami memutuskan untuk menghapus kondisi "larangan penskalaan setelah mencapai minimum": kami cukup membuang kondisi <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code>  <code>getScale() &gt; mMinScale || scaleFactor &gt; 1f</code> .  Lalu tiba-tiba ... <br><br><img src="https://habrastorage.org/webt/z_/ra/xg/z_raxgeezaf7o0h0zprufgrtggq.jpeg"><br><br>  Debun diterima!  Rupanya, ini terjadi karena fakta bahwa pembuat perpustakaan memutuskan untuk memainkannya dengan aman dua kali, membuat debounce dan pembatasan penskalaan.  Dalam implementasi acara onTouch, yaitu dalam kasus <code>MotionEvent.ACTION_UP</code> , jika pengguna telah menskala lebih / kurang dari maksimum / minimum, <a href="">AnimatedZoomRunnable</a> diluncurkan, yang mengembalikan gambar ke ukuran aslinya. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(View v, MotionEvent ev)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> handled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (ev.getAction()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> MotionEvent.ACTION_UP: <span class="hljs-comment"><span class="hljs-comment">// If the user has zoomed less than min scale, zoom back // to min scale if (getScale() &lt; mMinScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMinScale, rect.centerX(), rect.centerY())); handled = true; } } else if (getScale() &gt; mMaxScale) { RectF rect = getDisplayRect(); if (rect != null) { v.post(new AnimatedZoomRunnable(getScale(), mMaxScale, rect.centerX(), rect.centerY())); handled = true; } } break; } }</span></span></code> </pre> <br><p>  Seperti halnya dengan swipe untuk mengabaikan, kami menyelesaikan PhotoView di sumber perpustakaan kami dan membuat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">permintaan tarik</a> dengan "penambahan" debounce ke PhotoView asli. </p><br><h3 id="ispravlyaem-vnezapnyy-bag-v-photoview">  Perbaiki bug yang tiba-tiba di PhotoView </h3><br><p>  PhotoView memiliki bug yang sangat jahat.  Saat pengguna ingin memperbesar gambar dengan ketuk dua kali dan <del>  dia memiliki serangan epilepsi </del>  gambar mulai skala, dapat membalik 180 derajat secara vertikal.  Bug ini dapat ditemukan bahkan di aplikasi populer dari Google Play, misalnya, di Cyan. <br><br><img src="https://habrastorage.org/webt/m7/y1/hm/m7y1hmgkwqachpwst660vkrilwa.gif"><br><br>  Setelah pencarian yang panjang, kami masih melokalkan bug ini: kadang-kadang scaleFactor negatif dimasukkan ke dalam transformasi gambar matriks untuk penskalaan, yang menyebabkan gambar terbalik. </p><br><p>  <a href="">CustomGestureDetector</a> </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ScaleGestureDetector detector)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  -   scaleFactor &lt; 0 //      float scaleFactor = detector.getScaleFactor(); if (Float.isNaN(scaleFactor) || Float.isInfinite(scaleFactor)) return false; //    scaleFactor   callback //      mListener.onScale(scaleFactor, detector.getFocusX(), detector.getFocusY()); return true; }</span></span></code> </pre> <br><p>  Untuk skala dari Android ScaleGestureDetector, <a href="">kami</a> mendapatkan scaleFactor, yang dihitung sebagai berikut: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getScaleFactor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (inAnchoredScaleMode()) { <span class="hljs-comment"><span class="hljs-comment">// Drag is moving up; the further away from the gesture // start, the smaller the span should be, the closer, // the larger the span, and therefore the larger the scale final boolean scaleUp = (mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &lt; mPrevSpan)) || (!mEventBeforeOrAboveStartingGestureEvent &amp;&amp; (mCurrSpan &gt; mPrevSpan)); final float spanDiff = (Math.abs(1 - (mCurrSpan / mPrevSpan)) * SCALE_FACTOR); return mPrevSpan &lt;= 0 ? 1 : scaleUp ? (1 + spanDiff) : (1 - spanDiff); } return mPrevSpan &gt; 0 ? mCurrSpan / mPrevSpan : 1; }</span></span></code> </pre> <br><p>  Jika Anda menimpa metode ini dengan log debug, Anda dapat melacak di mana nilai-nilai tertentu dari variabel scaleFactor negatif diperoleh: </p><br><pre> <code class="plaintext hljs">mEventBeforeOrAboveStartingGestureEvent is true; SCALE_FACTOR is 0.5; mCurrSpan: 1075.4398; mPrevSpan 38.867798; scaleUp: false; spanDiff: 13.334586; eval result is -12.334586</code> </pre> <br><p>  Ada kecurigaan bahwa mereka mencoba menyelesaikan masalah ini dengan mengalikan spanDiff dengan SCALE_FACTOR == 0,5.  Tetapi solusi ini tidak akan membantu jika perbedaan antara mCurrSpan dan mPrevSpan lebih dari tiga kali.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Tiket</a> sudah dimulai untuk bug ini, tetapi belum diperbaiki. <br><del>  Kruk </del>  Solusi termudah untuk masalah ini adalah dengan hanya melewatkan nilai scaleFactor negatif.  Dalam praktiknya, pengguna tidak akan melihat bahwa gambar terkadang diperbesar dengan sedikit kurang lancar dari biasanya. </p><br><h1 id="vmesto-zaklyucheniya">  Alih-alih sebuah kesimpulan </h1><br><h3 id="sudba-pull-rekvestov">  Nasib permintaan tarik </h3><br><p>  Kami membuat perbaikan lokal dan membuat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Permintaan Tarik</a> terakhir di PhotoView.  Terlepas dari kenyataan bahwa beberapa PR telah bertahan di sana selama setahun, PR kami telah ditambahkan ke cabang utama dan bahkan rilis baru PhotoView telah dirilis.  Setelah itu kami memutuskan untuk memotong modul lokal dari Galeri Android dan menarik sumber PhotoView resmi.  Untuk melakukan ini, saya harus menambahkan dukungan untuk AndroidX, yang telah ditambahkan ke PhotoView di versi <a href="">2.1.3</a> . </p><br><h3 id="gde-nayti-biblioteku">  Di mana menemukan perpustakaan </h3><br><p>  Cari kode sumber pustaka Galeri Android di sini - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://github.com/redmadrobot-spb/android-gallery</a> , bersama dengan instruksi untuk digunakan.  Dan untuk mendukung proyek yang masih menggunakan Perpustakaan Dukungan, kami membuat versi terpisah dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">galeri-android yang sudah tidak digunakan lagi</a> .  Tapi hati-hati, karena dalam setahun Perpustakaan Dukungan akan berubah menjadi labu! </p><br><h3 id="chto-dalshe">  Apa selanjutnya </h3><br><p>  Sekarang perpustakaan benar-benar cocok untuk kita, tetapi dalam proses pengembangan ide-ide baru muncul.  Inilah beberapa di antaranya: </p><br><ul><li>  kemampuan untuk menggunakan perpustakaan dalam tata letak apa pun, dan bukan hanya FragmentDialog yang terpisah; </li><li>  kemampuan untuk menyesuaikan UI; </li><li>  kemampuan untuk mengganti Gilde dan ExoPlayer; </li><li>  kemampuan untuk menggunakan sesuatu, bukan ViewPager. </li></ul><br><h3 id="ssylki">  Referensi </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sistem sentuh Android dari perspektif yang sedikit berbeda</a> - artikel yang sangat bagus tentang topik tersebut dengan tautan ke artikel dan video hebat lainnya, yang merinci cara kerja Sistem Sentuh Android. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Penguasaan gerakan di Android</a> - artikel tentang Android Touch System di Rusia. </li></ul><br><h3 id="upd">  UPD </h3><br><p>  Saat menulis artikel, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">perpustakaan</a> serupa dari pengembang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">FrescoImageViewer keluar</a> .  Mereka menambahkan dukungan untuk <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">animasi transisi</a> , tetapi sejauh ini kami hanya memiliki dukungan video.  :) </p></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id433076/">https://habr.com/ru/post/id433076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id433064/index.html">Manajemen insiden: "Anda tidak bisa menyerah" atau seni menempatkan koma</a></li>
<li><a href="../id433066/index.html">HighLoad Cup # 2. Kejuaraan untuk pengembang backend kembali beroperasi</a></li>
<li><a href="../id433070/index.html">Bagaimana membedakan sampo dari sampanye, dan tusuk sate dari sampanye ... Elasticsearch - mencari produk di database toko</a></li>
<li><a href="../id433072/index.html">Cara meretas perlindungan salinan konsol Sega Dreamcast</a></li>
<li><a href="../id433074/index.html">Beralih ke Kotlin dalam proyek Android: Kiat dan Trik</a></li>
<li><a href="../id433078/index.html">Kami menulis robot perdagangan menggunakan kerangka kerja grafis StockSharp. Bagian 2</a></li>
<li><a href="../id433082/index.html">Memompa akun orang lain telah menjadi pelanggaran pidana di Korea Selatan</a></li>
<li><a href="../id433084/index.html">Buka pelajaran "Rekayasa Fitur pada contoh dataset Titanic klasik"</a></li>
<li><a href="../id433086/index.html">Tinkoff dan segalanya, segalanya, segalanya: IoT, analitik, dan pengawasan bank</a></li>
<li><a href="../id433088/index.html">Bagaimana Anda menyukainya, Elon Musk: BMW dan Porsche telah mengembangkan pengisian daya yang menambahkan 100 km perjalanan dalam 3 menit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>