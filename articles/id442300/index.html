<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéØ üè≠ üêí Saya melihat dan mendengarkan di mana saya inginkan. Mengintegrasikan Chromecast ke dalam Aplikasi Android üë©üèº‚Äçüéì üêà üö¥üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Di jalan, saya sering mendengarkan buku audio dan podcast dari telepon pintar. Ketika saya tiba di rumah, saya ingin terus mendengarkan mereka di TV A...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Saya melihat dan mendengarkan di mana saya inginkan. Mengintegrasikan Chromecast ke dalam Aplikasi Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mobileup/blog/442300/"><p><img src="https://habrastorage.org/webt/bq/i8/s9/bqi8s9jzjckcmyylz2djxicszli.png"></p><br><p>  Di jalan, saya sering mendengarkan buku audio dan podcast dari telepon pintar.  Ketika saya tiba di rumah, saya ingin terus mendengarkan mereka di TV Android atau Google Home.  Tetapi tidak semua aplikasi mendukung Chromecast.  Dan itu akan nyaman. </p><br><p>  Menurut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">statistik</a> Google selama 3 tahun terakhir, jumlah perangkat di Android TV telah meningkat 4 kali lipat, dan jumlah mitra manufaktur telah melebihi seratus: televisi, speaker, kotak set-top "pintar".  Semuanya mendukung Chromecast.  Tetapi masih ada banyak aplikasi di pasar yang jelas kurang integrasi dengan itu. </p><br><p>  Pada artikel ini, saya ingin berbagi pengalaman mengintegrasikan Chromecast ke aplikasi Android untuk memutar konten media. </p><a name="habracut"></a><br><h1 id="kak-eto-rabotaet">  Bagaimana cara kerjanya </h1><br><p>  Jika ini pertama kalinya Anda mendengar kata "Chromecast," saya akan mencoba memberi tahu Anda secara singkat.  Dalam hal penggunaan, tampilannya seperti ini: </p><br><ol><li>  Pengguna mendengarkan musik atau menonton video melalui aplikasi atau situs web. </li><li>  Perangkat Chromecast muncul di jaringan lokal. </li><li>  Tombol yang sesuai akan muncul di antarmuka pemain. </li><li>  Dengan mengkliknya, pengguna memilih perangkat yang diinginkan dari daftar.  Ini bisa menjadi Nexus Player, Android TV atau speaker pintar. </li><li>  Pemutaran lebih lanjut berlanjut dengan perangkat ini. </li></ol><br><p><img src="https://habrastorage.org/webt/qc/eb/pu/qcebpuhqkjtb7hcjpzvkm73pzyk.jpeg"></p><br><p>  Secara teknis, sesuatu seperti yang berikut ini terjadi: </p><br><ol><li>  Layanan Google memantau keberadaan perangkat Chromecast di jaringan lokal melalui Penyiaran. </li><li>  Jika <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">MediaRouter</a> terhubung ke aplikasi Anda, maka Anda akan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">menerima</a> acara tentang ini. </li><li>  Saat pengguna memilih perangkat Cast dan menghubungkannya, sesi media baru (CastSession) terbuka. </li><li>  Sudah di sesi yang dibuat, kami akan mentransfer konten untuk diputar. <br>  Kedengarannya sangat sederhana. </li></ol><br><h1 id="integraciya">  Integrasi </h1><br><p>  Google memiliki Chromecast <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SDK</a> sendiri, tetapi tidak tercakup dalam dokumentasi dan kodenya dikaburkan.  Karena itu, banyak hal yang harus diperiksa dengan mengetik.  Mari kita bereskan semuanya. </p><br><h2 id="inicializaciya">  Inisialisasi </h2><br><p>  Pertama, kita perlu menghubungkan Cast Application Framework dan MediaRouter: </p><br><pre><code class="java hljs">implementation <span class="hljs-string"><span class="hljs-string">"com.google.android.gms:play-services-cast-framework:16.1.0"</span></span> implementation <span class="hljs-string"><span class="hljs-string">"androidx.mediarouter:mediarouter:1.0.0"</span></span></code> </pre> <br><p>  Maka Cast Framework harus mendapatkan pengenal aplikasi (lebih lanjut tentang itu nanti), dan jenis konten media yang didukung.  Artinya, jika aplikasi kita hanya memutar video, maka casting ke kolom Beranda Google tidak akan mungkin, dan itu tidak akan ada dalam daftar perangkat.  Untuk melakukan ini, buat implementasi OptionsProvider: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CastOptionsProvider</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">OptionsProvider { override fun getCastOptions</span></span></span></span>(context: Context): CastOptions { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CastOptions.Builder() .setReceiverApplicationId(BuildConfig.CHROMECAST_APP_ID) .build() } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAdditionalSessionProviders</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(context: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Context</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: MutableList&lt;SessionProvider&gt;? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> } }</code> </pre> <br><p>  Dan nyatakan dalam Manifest: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta-data</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.google.android.gms.cast.framework.OPTIONS_PROVIDER_CLASS_NAME"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"your.app.package.CastOptionsProvider"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><h2 id="registriruem-prilozhenie">  Daftarkan aplikasi </h2><br><p>  Agar Chromecast berfungsi dengan aplikasi kami, itu harus didaftarkan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Google Cast SDK Developers Console</a> .  Ini memerlukan akun pengembang Chromecast (jangan bingung dengan akun pengembang Google Play).  Saat mendaftar, Anda harus membayar biaya satu kali sebesar $ 5.  Setelah menerbitkan Aplikasi ChromeCast, Anda perlu menunggu sedikit. <br>  Di konsol, Anda dapat mengubah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tampilan</a> pemain Cast untuk perangkat dengan layar dan melihat analitik casting dalam aplikasi. </p><br><h2 id="mediarouter">  Router media </h2><br><p>  MediaRouteFramework adalah mekanisme yang memungkinkan Anda menemukan semua perangkat pemutaran jarak jauh di dekat pengguna.  Ini tidak hanya Chromecast, tetapi juga display jarak jauh dan speaker menggunakan protokol pihak ketiga.  Tetapi yang menarik bagi kami adalah Chromecast. </p><br><p><img src="https://habrastorage.org/webt/nb/tb/hn/nbtbhnq7266gmh_2ntfqjhign_m.png"></p><br><p>  MediaRouteFramework memiliki Tampilan yang mencerminkan keadaan skuter media.  Ada dua cara untuk menghubungkannya: </p><br><p>  1) Melalui menu: </p><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">menu</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:android</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res/android"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:app</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.android.com/apk/res-auto"</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/menu_media_route"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@string/cast"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:actionProviderClass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"androidx.mediarouter.app.MediaRouteActionProvider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">app:showAsAction</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"always"</span></span></span><span class="hljs-tag">/&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">menu</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  2) Melalui tata letak: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">androidx.mediarouter.app.MediaRouteButton</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/mediaRouteButton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:layout_height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wrap_content"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:mediaRouteTypes</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"user"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre> <br><p>  Dan dari kode Anda hanya perlu mendaftarkan tombol di CastButtonFactory.  maka keadaan saat ini dari skuter media akan dilemparkan ke dalamnya: </p><br><pre> <code class="kotlin hljs">CastButtonFactory.setUpMediaRouteButton(applicationContext, view.mediaRouteButton)</code> </pre> <br><p>  Sekarang setelah aplikasi terdaftar dan MediaRouter dikonfigurasi, Anda dapat terhubung ke perangkat ChromeCast dan membuka sesi untuk mereka. </p><br><h1 id="kasting-mediakontenta">  Casting Konten Media </h1><br><p>  ChromeCast mendukung tiga jenis konten utama: </p><br><ul><li>  Audio </li><li>  Video </li><li>  Foto </li></ul><br><p>  Bergantung pada pengaturan pemutar, seperti konten media dan perangkat transmisi, antarmuka pemain dapat bervariasi. </p><br><h2 id="castsession">  Castsession </h2><br><p>  Jadi, pengguna memilih perangkat yang diinginkan, CastFramework membuka sesi baru.  Sekarang tugas kita adalah merespons ini dan meneruskan informasi ke perangkat untuk diputar. <br>  Untuk mengetahui keadaan sesi saat ini dan mendaftar untuk memperbarui keadaan ini, gunakan objek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SessionManager</a> : </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mediaSessionListener = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : SessionManagerListener&lt;CastSession&gt; { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSessionStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CastSession</span></span></span></span><span class="hljs-function"><span class="hljs-params">, sessionId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { currentSession = session <span class="hljs-comment"><span class="hljs-comment">//  ,      checkAndStartCasting() } override fun onSessionEnding(session: CastSession) { stopCasting() } override fun onSessionResumed(session: CastSession, wasSuspended: Boolean) { currentSession = session checkAndStartCasting() } override fun onSessionStartFailed(session: CastSession, p1: Int) { stopCasting() } override fun onSessionEnded(session: CastSession, p1: Int) { // do nothing } override fun onSessionResumeFailed(session: CastSession, p1: Int) { // do nothing } override fun onSessionSuspended(session: CastSession, p1: Int) { // do nothing } override fun onSessionStarting(session: CastSession) { // do nothing } override fun onSessionResuming(session: CastSession, sessionId: String) { // do nothing } } val sessionManager = CastContext.getSharedInstance(context).sessionManager sessionManager.addSessionManagerListener(mediaSessionListener, CastSession::class.java)</span></span></code> </pre> <br><p>  Dan kita juga bisa mencari tahu apakah ada sesi terbuka saat ini: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> currentSession: CastSession? = sessionManager.currentCastSession</code> </pre> <br><p>  Kami memiliki dua kondisi utama di mana kami dapat mulai melakukan casting: </p><br><ol><li>  Sesi sudah terbuka. </li><li>  Ada konten untuk casting. </li></ol><br><p>  Di masing-masing dari dua peristiwa ini, kita dapat memeriksa statusnya, dan jika semuanya sudah beres, maka mulai casting. </p><br><h2 id="kasting">  Casting </h2><br><p>  Sekarang kita memiliki apa yang harus dilemparkan dan ke mana harus dilemparkan, kita dapat beralih ke hal yang paling penting.  Antara lain, CastSession memiliki objek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">RemoteMediaClient</a> yang bertanggung jawab untuk keadaan pemutaran konten media.  Kami akan bekerja dengannya. </p><br><p>  Mari kita buat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">MediaMetadata</a> , di mana informasi tentang penulis, album, dll akan disimpan. Ini sangat mirip dengan apa yang kita transfer ke MediaSession ketika kita memulai pemutaran lokal. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mediaMetadata = MediaMetadata(MediaMetadata.MEDIA_TYPE_MUSIC_TRACK ).apply { putString(MediaMetadata.KEY_TITLE, ‚ÄúIn C‚Äù) putString(MediaMetadata.KEY_ARTIST, ‚ÄúTerry Riley‚Äù) mediaContent?.metadata?.posterUrl?.let { poster -&gt; addImage(WebImage(Uri.parse(‚Äúhttps:<span class="hljs-comment"><span class="hljs-comment">//habrastorage.org/webt/wk/oi/pf/wkoipfkdyy2ctoa5evnd8vhxtem.png‚Äù))) } }</span></span></code> </pre> <br><p>  MediaMetadata memiliki banyak parameter, dan lebih baik melihatnya di dokumentasi.  Saya terkejut bahwa Anda dapat menambahkan gambar bukan melalui bitmap, tetapi hanya dengan tautan di dalam WebImage. </p><br><p>  Objek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">MediaInfo</a> membawa informasi tentang metadata konten dan akan berbicara tentang dari mana konten media berasal, apa jenisnya, bagaimana cara memainkannya: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mediaInfo = MediaInfo.Builder(‚Äúhttps:<span class="hljs-comment"><span class="hljs-comment">//you-address.com/in_c.mp3‚Äù) .setContentType(‚Äúaudio/mp3‚Äù) .setStreamType(MediaInfo.STREAM_TYPE_BUFFERED) .setMetadata(mediaMetadata) .build()</span></span></code> </pre> <br><p>  Biarkan saya mengingatkan Anda bahwa contentType adalah jenis konten sesuai dengan spesifikasi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">MIME</a> . <br>  Anda juga dapat mentransfer sisipan iklan ke MediaInfo: </p><br><ul><li>  setAdBreakClips - menerima daftar iklan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">AdBreakClipInfo</a> dengan tautan ke konten, judul, waktu, dan waktu dilewati iklan. </li><li>  setAdBreaks - informasi tentang tata letak dan waktu pemasangan iklan. </li></ul><br><p>  Dalam MediaLoadOptions kami menjelaskan bagaimana kami akan memproses aliran media (kecepatan, posisi awal).  Dokumentasi juga mengatakan bahwa melalui setCredentials Anda dapat melewati tajuk permintaan untuk otorisasi, tetapi permintaan saya dari Chromecast tidak menyertakan bidang yang dinyatakan untuk otorisasi. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mediaLoadOptions = MediaLoadOptions.Builder() .setPlayPosition(position!!) .setAutoplay(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .setPlaybackRate(playbackSpeed) .setCredentials(context.getString(R.string.bearer_token, authGateway.authState.accessToken!!)) .setCredentialsType(context.getString(R.string.authorization_header_key)) .build()</code> </pre> <br><p>  Setelah semuanya siap, kami dapat memberikan semua data ke RemoteMediaClient, dan Chromecast akan mulai diputar.  Penting untuk menjeda pemutaran lokal. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> remoteMediaClient = currentSession!!.remoteMediaClient remoteMediaClient.load(mediaInfo, mediaLoadOptions)</code> </pre> <br><h2 id="obrabotka-sobytiy">  Penanganan acara </h2><br><p>  Video mulai diputar, lalu apa?  Bagaimana jika pengguna menjeda TV?  Untuk mempelajari tentang acara dari sisi Chromecast, RemoteMediaClient memiliki panggilan balik: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> castStatusCallback = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : RemoteMediaClient.Callback() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStatusUpdated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// check and update current state } } remoteMediaClient.registerCallback(castStatusCallback)</span></span></code> </pre> <br><p>  Untuk mengetahui kemajuan saat ini juga sederhana: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> periodMills = <span class="hljs-number"><span class="hljs-number">1000L</span></span> remoteMediaClient.addProgressListener( RemoteMediaClient.ProgressListener { progressMills, durationMills -&gt; <span class="hljs-comment"><span class="hljs-comment">// show progress in your UI }, periodMills )</span></span></code> </pre> <br><h1 id="opyt-integracii-s-suschestvuyuschim-pleerom">  Pengalaman berintegrasi dengan pemain yang ada </h1><br><p>  Aplikasi yang sedang saya kerjakan sudah memiliki media player yang sudah jadi.  Tujuannya adalah untuk mengintegrasikan dukungan Chromecast ke dalamnya.  Media player didasarkan pada State Machine, dan pemikiran pertama adalah menambahkan status baru: "CastingState".  Tetapi ide ini langsung ditolak, karena setiap negara pemain mencerminkan keadaan pemutaran, dan tidak masalah apa yang berfungsi sebagai implementasi dari ExoPlayer atau ChromeCast. <br>  Kemudian muncul ide untuk membuat sistem delegasi tertentu dengan memprioritaskan dan memproses "siklus hidup" pemain.  Semua delegasi dapat menerima acara status pemain: Putar, Jeda, dll.  - tetapi hanya delegasi pemimpin yang akan memutar konten media. </p><br><p><img src="https://habrastorage.org/webt/bq/3d/ha/bq3dhavugibyob-itbb6zmlxt1o.png"></p><br><p>  Kami memiliki sesuatu seperti antarmuka pemain ini: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> isPlaying: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> isReleased: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> duration: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> positionInMillis: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> speed: <span class="hljs-built_in"><span class="hljs-built_in">Float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> volume: <span class="hljs-built_in"><span class="hljs-built_in">Float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> loop: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(listener: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">PlayerCallback</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(listener: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">PlayerCallback</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getListeners</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: MutableSet&lt;PlayerCallback&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(mediaContent: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MediaContent</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">play</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pause</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">release</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerCallback</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPlaying</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentPosition: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPaused</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentPosition: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPreparing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPrepared</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoadingChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(isLoading: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDurationChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(duration: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSetSpeed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(speed: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Float</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSeekTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fromTimeInMillis: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, toTimeInMillis: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onWaitingForNetwork</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(error: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReleased</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPlayerProgress</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(currentPosition: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> } }</code> </pre> <br><p>  Di dalamnya akan menjadi Mesin Negara dengan begitu banyak negara: </p><br><ul><li>  Kosong - keadaan awal sebelum inisialisasi. </li><li>  Mempersiapkan - pemain memulai pemutaran konten media. </li><li>  Disiapkan - Media diunggah dan siap dimainkan. </li><li>  Bermain </li><li>  Dijeda </li><li>  Menunggu jaringan </li><li>  Kesalahan </li></ul><br><p><img src="https://habrastorage.org/webt/vo/bf/pj/vobfpjedi8xqla3huav88k0xrdw.png"></p><br><p>  Sebelumnya, setiap negara selama inisialisasi mengeluarkan perintah di ExoPlayer.  Sekarang ia akan mengeluarkan perintah ke daftar delegasi Playing, dan delegasi "Lead" akan dapat memprosesnya.  Karena delegasi mengimplementasikan semua fungsi pemain, ia juga dapat diwarisi dari antarmuka pemain dan digunakan secara terpisah jika perlu.  Maka delegasi abstrak akan terlihat seperti ini: </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayingDelegate</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> playerCallback: Player.PlayerCallback, <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isLeading: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span> ) : Player { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIsLeading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(isLeading: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">, positionMills: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-function"><span class="hljs-params">, isPlaying: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.isLeading = isLeading <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isLeading) { onLeading(positionMills, isPlaying) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { onDormant() } } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addListener</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(listener: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Player</span></span></span></span><span class="hljs-function"><span class="hljs-params">.</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">PlayerCallback</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// do nothing } final override fun removeListener(listener: Player.PlayerCallback): Boolean { return false } final override fun getListeners(): MutableSet&lt;Player.PlayerCallback&gt; { return mutableSetOf() } /** *    */ open fun netwarkIsRestored() { // do nothing } /** *      */ abstract fun onLeading(positionMills: Long, isPlaying: Boolean) /** *      */ abstract fun onIdle() /** *     . *      , *       . */ abstract fun readyForLeading(): Boolean }</span></span></code> </pre> <br><p>  Sebagai contoh, saya menyederhanakan antarmuka.  Pada kenyataannya, ada sedikit lebih banyak peristiwa. <br>  Mungkin ada banyak delegasi karena ada sumber reproduksi.  Delegasi Chromecast mungkin terlihat seperti ini: </p><br><div class="spoiler">  <b class="spoiler_title">ChromeCastDelegate.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChromeCastDelegate</span></span></span></span>( <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> context: Context, <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> castCallback: ChromeCastListener, playerCallback: Player.PlayerCallback ) : PlayingDelegate(playerCallback) { <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> CONTENT_TYPE_VIDEO = <span class="hljs-string"><span class="hljs-string">"videos/mp4"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> CONTENT_TYPE_AUDIO = <span class="hljs-string"><span class="hljs-string">"audio/mp3"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> PROGRESS_DELAY_MILLS = <span class="hljs-number"><span class="hljs-number">500L</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChromeCastListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCastStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCastStopped</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sessionManager: SessionManager? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentSession: CastSession? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mediaContent: MediaContent? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentPosition: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> mediaSessionListener = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : SessionManagerListener&lt;CastSession&gt; { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSessionStarted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CastSession</span></span></span></span><span class="hljs-function"><span class="hljs-params">, sessionId: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { currentSession = session castCallback.onCastStarted() } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSessionEnding</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CastSession</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { currentPosition = session.remoteMediaClient?.approximateStreamPosition ?: currentPosition stopCasting() } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSessionResumed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CastSession</span></span></span></span><span class="hljs-function"><span class="hljs-params">, wasSuspended: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { currentSession = session castCallback.onCastStarted() } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSessionStartFailed</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CastSession</span></span></span></span><span class="hljs-function"><span class="hljs-params">, p1: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { stopCasting() } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSessionEnded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CastSession</span></span></span></span><span class="hljs-function"><span class="hljs-params">, p1: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">// do nothing } override fun onSessionResumeFailed(session: CastSession, p1: Int) { // do nothing } override fun onSessionSuspended(session: CastSession, p1: Int) { // do nothing } override fun onSessionStarting(session: CastSession) { // do nothing } override fun onSessionResuming(session: CastSession, sessionId: String) { // do nothing } } private val castStatusCallback = object : RemoteMediaClient.Callback() { override fun onStatusUpdated() { if (currentSession == null) return val playerState = currentSession!!.remoteMediaClient.playerState when (playerState) { MediaStatus.PLAYER_STATE_PLAYING -&gt; playerCallback.onPlaying(positionInMillis) MediaStatus.PLAYER_STATE_PAUSED -&gt; playerCallback.onPaused(positionInMillis) } } } private val progressListener = RemoteMediaClient.ProgressListener { progressMs, durationMs -&gt; playerCallback.onPlayerProgress(progressMs) } // Playing delegate override val isReleased: Boolean = false override var loop: Boolean = false override val isPlaying: Boolean get() = currentSession?.remoteMediaClient?.isPlaying ?: false override val duration: Long get() = currentSession?.remoteMediaClient?.streamDuration ?: 0 override var positionInMillis: Long get() { currentPosition = currentSession?.remoteMediaClient?.approximateStreamPosition ?: currentPosition return currentPosition } set(value) { currentPosition = value checkAndStartCasting() } override var speed: Float = SpeedProvider.default() set(value) { field = value checkAndStartCasting() } override var volume: Float get() = currentSession?.volume?.toFloat() ?: 0F set(value) { currentSession?.volume = value.toDouble() } override fun prepare(mediaContent: MediaContent) { sessionManager = CastContext.getSharedInstance(context).sessionManager sessionManager?.addSessionManagerListener(mediaSessionListener, CastSession::class.java) currentSession = sessionManager?.currentCastSession this.mediaContent = mediaContent playerCallback.onPrepared() } override fun play() { if (isLeading) { currentSession?.remoteMediaClient?.play() } } override fun pause() { if (isLeading) { currentSession?.remoteMediaClient?.pause() } } override fun release() { stopCasting(true) } override fun onLeading(positionMills: Long, isPlaying: Boolean) { currentPosition = positionMills checkAndStartCasting() } override fun onIdle() { // TODO } override fun readyForLeading(): Boolean { return currentSession != null } // internal private fun checkAndStartCasting() { if (currentSession != null &amp;&amp; mediaContent?.metadata != null &amp;&amp; isLeading) { val mediaMetadata = MediaMetadata(getMetadataType(mediaContent!!.type)).apply { putString(MediaMetadata.KEY_TITLE, mediaContent?.metadata?.title.orEmpty()) putString(MediaMetadata.KEY_ARTIST, mediaContent?.metadata?.author.orEmpty()) mediaContent?.metadata?.posterUrl?.let { poster -&gt; addImage(WebImage(Uri.parse(poster))) } } val mediaInfo = MediaInfo.Builder(mediaContent!!.contentUri.toString()) .setContentType(getContentType(mediaContent!!.type)) .setStreamType(MediaInfo.STREAM_TYPE_BUFFERED) .setMetadata(mediaMetadata) .build() val mediaLoadOptions = MediaLoadOptions.Builder() .setPlayPosition(currentPosition) .setAutoplay(true) .setPlaybackRate(speed.toDouble()) .build() val remoteMediaClient = currentSession!!.remoteMediaClient remoteMediaClient.unregisterCallback(castStatusCallback) remoteMediaClient.load(mediaInfo, mediaLoadOptions) remoteMediaClient.registerCallback(castStatusCallback) remoteMediaClient.addProgressListener(progressListener, PROGRESS_DELAY_MILLS) } } private fun stopCasting(removeListener: Boolean = false) { if (removeListener) { sessionManager?.removeSessionManagerListener(mediaSessionListener, CastSession::class.java) } currentSession?.remoteMediaClient?.unregisterCallback(castStatusCallback) currentSession?.remoteMediaClient?.removeProgressListener(progressListener) currentSession?.remoteMediaClient?.stop() currentSession = null if (isLeading) { castCallback.onCastStopped() } } private fun getContentType(mediaType: MediaContent.Type) = when (mediaType) { MediaContent.Type.AUDIO -&gt; CONTENT_TYPE_AUDIO MediaContent.Type.VIDEO -&gt; CONTENT_TYPE_VIDEO } private fun getMetadataType(mediaType: MediaContent.Type) = when (mediaType) { MediaContent.Type.AUDIO -&gt; MediaMetadata.MEDIA_TYPE_MUSIC_TRACK MediaContent.Type.VIDEO -&gt; MediaMetadata.MEDIA_TYPE_MOVIE } }</span></span></code> </pre> </div></div><br><p>  Sebelum memberikan perintah tentang reproduksi, kita perlu memutuskan delegasi terkemuka.  Untuk melakukan ini, mereka ditambahkan dalam urutan prioritas ke pemain, dan masing-masing dari mereka dapat memberikan kesiapan dalam metode readyForLeading ().  Kode sampel lengkap dapat dilihat di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GitHub</a> . </p><br><h1 id="est-li-zhizn-posle-chromecast">  Apakah ada kehidupan setelah ChromeCast </h1><br><p><img src="https://habrastorage.org/webt/zo/pj/sk/zopjsk1u1rzsmxfucmf6dfkntv8.png"></p><br><p>  Setelah saya mengintegrasikan dukungan Chromecast ke dalam aplikasi, saya lebih senang pulang dan menikmati buku audio tidak hanya melalui headphone, tetapi juga melalui Google Home.  Sedangkan untuk arsitektur, implementasi pemain dalam aplikasi yang berbeda dapat bervariasi, sehingga pendekatan ini tidak akan sesuai di mana-mana.  Tetapi untuk arsitektur kita, itu muncul.  Saya harap artikel ini bermanfaat, dan dalam waktu dekat akan ada lebih banyak aplikasi yang dapat diintegrasikan dengan lingkungan digital! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id442300/">https://habr.com/ru/post/id442300/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id442288/index.html">Radiasi: sumber</a></li>
<li><a href="../id442290/index.html">Membuat ST-Link V2.1 dari Bahasa Cina ST-Link V2</a></li>
<li><a href="../id442292/index.html">Magang Sberseason: Python, UX / UI, Data dan banyak lagi untuk siswa</a></li>
<li><a href="../id442294/index.html">Apa Oleg Artamonov sedikit salah</a></li>
<li><a href="../id442298/index.html">Gatsby.js secara detail</a></li>
<li><a href="../id442304/index.html">Lipat smartphone: bagaimana dengan aplikasi?</a></li>
<li><a href="../id442306/index.html">Cara vendor git ke git lain</a></li>
<li><a href="../id442310/index.html">Firmware Sonoff Basic melalui Raspberry Pi</a></li>
<li><a href="../id442312/index.html">DoT untuk distribusi RPZ</a></li>
<li><a href="../id442316/index.html">Pustaka C ++ yang ringkas untuk memprogram metode perbedaan terbatas ala operator. Bagian 1. Semantik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>