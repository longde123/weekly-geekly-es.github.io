<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèΩ ü§Ωüèº ‚§µÔ∏è An√°lise do Bootkit üëäüèø üçö üë¶üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal! Em conex√£o com o lan√ßamento do curso ‚ÄúEngenharia Reversa‚Äù, realizamos uma li√ß√£o aberta planejada. Desmontou o algoritmo de opera√ß√£o do ki...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>An√°lise do Bootkit</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/482086/"> <i>Ol√° pessoal!</i>  <i>Em conex√£o com o lan√ßamento do curso <a href="https://otus.pw/1uOJ/">‚ÄúEngenharia Reversa‚Äù,</a> realizamos uma li√ß√£o aberta planejada.</i>  <i>Desmontou <b>o algoritmo de opera√ß√£o do kit de inicializa√ß√£o</b> em diferentes est√°gios de carregamento.</i> <br><br><img src="https://habrastorage.org/webt/do/x7/rb/dox7rbq794sk5rkgvwrpq42lq6g.jpeg"><br><br>  Professor - <a href="https://otus.pw/G9ih/">Arthur Pakulov</a> , analista de v√≠rus da Kaspersky Lab. <br><br>  <b><i>O artigo a seguir √© introdut√≥rio e √© uma vers√£o em texto de apenas parte da li√ß√£o, dedicada ao instalador do bootkit.</i></b>  <b><i>Uma an√°lise detalhada do pr√≥prio kit de inicializa√ß√£o, veja o v√≠deo.</i></b> <a name="habracut"></a><br><br>  Um kit de inicializa√ß√£o √© um programa malicioso que modifica o Master Boot Record, o primeiro setor do primeiro disco f√≠sico ou setor de inicializa√ß√£o, o VBR.  Programas desse tipo, basicamente, t√™m uma funcionalidade Trojan e s√£o usados ‚Äã‚Äãpara executar qualquer a√ß√£o oculta no sistema.  Em nosso exemplo, o kit de inicializa√ß√£o executa a escala√ß√£o de privil√©gios para o n√≠vel do processo, cujo nome come√ßa com uma sequ√™ncia de letras: ‚Äúinte‚Äù.  De fato, um kit de inicializa√ß√£o √© um rootkit que come√ßa a funcionar no anel de prote√ß√£o 0, que √© iniciado antes mesmo do sistema operacional come√ßar a carregar.  √â por isso que ele √© de grande interesse para a pesquisa. <br><br>  Para desenvolver esse programa, as habilidades usuais de engenharia reversa n√£o s√£o suficientes.  N√£o basta apenas ler a listagem, voc√™ tamb√©m precisa entender coisas como arquitetura do processador, endere√ßamento de mem√≥ria etc. Examinamos os principais locais do kit de inicializa√ß√£o em uma li√ß√£o aberta. <br><br>  Para o trabalho, foi preparado um exemplo especial de bootkit-xp.exe, funcionando no Windows XP.  Portanto, al√©m de estudar o kit de inicializa√ß√£o, √©ramos um pouco nost√°lgicos para esse sistema operacional.  Mas, em geral, o OS XP foi escolhido para facilitar a revers√£o, pois o XP √© uma boa visualiza√ß√£o e a aus√™ncia de complica√ß√µes desnecess√°rias.  Bem, a amostra foi escrita especificamente para este SO, a julgar pelo seu c√≥digo. <br><br>  Aqui <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D425">est√° a apar√™ncia do instalador do bootkit</a> : <br><br><img src="https://habrastorage.org/webt/f4/-4/lr/f4-4lrdezgkdeeokbuyk9w0-4jy.png"><br><br>  Apenas olhando para ele, voc√™ pode tirar certas conclus√µes.  Por exemplo, √© imediatamente evidente que esse arquivo tem um peso pequeno.  Se voc√™ observar o ponto de entrada, poder√° ver que o c√≥digo est√° recebendo um descritor de arquivo com o nome de um link simb√≥lico para o primeiro disco f√≠sico - "PhysicalDrive0": <br><br><img src="https://habrastorage.org/webt/qy/3k/ug/qy3kugjvk78hnhogjugvfcf2ggc.png"><br><br>  Al√©m disso, para maior conveni√™ncia da percep√ß√£o do c√≥digo, <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D612">mudamos para a IDA</a> .  Torna-se claro que, para um cavalo de Troia t√≠pico, a funcionalidade dispon√≠vel √© bastante pequena.  At√© a tabela de importa√ß√£o √© suspeitamente pequena: <br><br><img src="https://habrastorage.org/webt/fa/jw/pm/fajwpmunsgdiuiicltttrjuum-q.png"><br><br>  Essa imagem geralmente surge ao analisar amostras empacotadas.  Mas, no nosso caso, o arquivo n√£o parece compactado.  Acontece que a amostra √© coberta por algum protetor / criptor e, no processo de seu trabalho, recebe os endere√ßos das fun√ß√µes de forma din√¢mica, ap√≥s o que chama o funcional desejado, ou est√° tudo bem, e a amostra est√° como est√°. <br><br>  Continuamos a explorar o c√≥digo. <br><br><img src="https://habrastorage.org/webt/dd/ap/6r/ddap6rpjjwbfz3zzamn_0folqro.png"><br><br>  Como vimos no HIEW, a fun√ß√£o <b>CreateFileA</b> √© chamada com um argumento interessante como o primeiro par√¢metro.O que exatamente est√° sendo feito aqui?  Aqui √© apropriado relembrar <b>objetos do kernel</b> .  Eles n√£o podem ser manipulados diretamente do modo de usu√°rio, s√£o controlados pelo kernel do sistema operacional.  No modo de usu√°rio, um programa s√≥ pode fazer uma solicita√ß√£o para receber / alterar o estado de qualquer objeto do kernel.  Para indicar ao sistema com qual objeto de kernel espec√≠fico o programa funcionar√°, √© necess√°rio obter o identificador do objeto de kernel necess√°rio.  Mediante solicita√ß√£o de recebimento, se todas as verifica√ß√µes forem aprovadas, o sistema operacional retornar√° o <b>identificador do</b> OA solicitado.  E j√° usando o handle, podemos trabalhar com o OA associado. <br><br>  Portanto, na imagem acima, usando CreateFile, um link simb√≥lico √© acessado no primeiro disco r√≠gido f√≠sico conectado.  Se o acesso for concedido, voc√™ poder√° trabalhar com um "arquivo" como em qualquer outro arquivo simples.  Ou seja, todo o disco r√≠gido ser√° apresentado como um √∫nico arquivo grande. <br><br>  Ent√£o, vamos continuar.  Handle est√° de volta, e nos encontramos aqui: <br><br><img src="https://habrastorage.org/webt/zr/1e/1x/zr1e1xk7dhetlxfyumiqyrfnvn4.png"><br><br>  O que acontece depois?  E a fun√ß√£o <b>ReadFile</b> l√™ os primeiros 0x200 bytes.  E n√≥s temos l√° o primeiro setor do primeiro disco f√≠sico. <br><br><img src="https://habrastorage.org/webt/ev/p8/sc/evp8sct8igaytj9d3ardoecem3u.png"><br><br>  Como voc√™ deve ter adivinhado, esse √© o MBR ( <a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25B3%25D1%2580%25D1%2583%25D0%25B7%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">Master Boot Record</a> ).  O MBR consiste em 3 partes: parte do c√≥digo, tabela de parti√ß√£o e assinatura.  Em uma situa√ß√£o normal, o BIOS l√™ o MBR na mem√≥ria no endere√ßo 0: 0x7c00h, passando o controle para ele.  Portanto, a parte do c√≥digo do MBR come√ßa a ser executada.  Durante a execu√ß√£o, ele analisa a tabela de parti√ß√£o, localiza o setor de inicializa√ß√£o e o carrega.  No caso de um kit de inicializa√ß√£o, se o MBR for substitu√≠do, seu c√≥digo agora receber√° controle. <br><br>  Ok, o MBR √© lido e o <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D1832">que vem a seguir</a> ?  E o bootkit abre o PhysicalDrive0 novamente, mas com o modo de acesso de grava√ß√£o. <br><br><img src="https://habrastorage.org/webt/dx/ca/sd/dxcasdk2lmaimniy-ghxtmpwfmc.png"><br><br>  Em seguida, um ponteiro √© definido no 600¬∫ deslocamento.  Ou seja, o <b>setor original √© lido e copiado para o terceiro setor</b> . <br><br>  Por que fazer backup de um setor?  Obviamente, isso √© necess√°rio para o fato de que ser√° necess√°rio no futuro. <br><br>  Ent√£o o ciclo come√ßa.  Naturalmente, olhando o c√≥digo, n√£o se pode deixar de prestar aten√ß√£o a constantes como var_1C, <b>1BEh</b> e outras.  E, ao mesmo tempo, a estrutura MBR localizada acima deve ser atualizada na mem√≥ria.  Em particular, estamos interessados ‚Äã‚Äãna coluna "Deslocamento". <br><br><img src="https://habrastorage.org/webt/rq/jl/ac/rqjlacxma7m_0m_ldqqbomiqhfa.png"><br><br>  Veja, o buffer de leitura do primeiro setor est√° no <b>lpBuffer</b> .  Em seguida, <b>√©</b> adicionado <b>1BEh</b> e, de fato, o ponteiro vai para o in√≠cio da tabela de parti√ß√£o.  Todos os dados da tabela at√© o final do setor s√£o inseridos em <b>_marked_bytes</b> , iniciando no mesmo deslocamento - 1BE. <br><br><img src="https://habrastorage.org/webt/yj/en/ot/yjenotuk4hp061oe0qldeeu0j98.png"><br><br>  Ou seja, a segunda e a terceira parte do MBR original s√£o inseridas em <b>_marked_bytes</b> . <br><br>  O que acontece depois?  E <b>ent√£o SetFilePointer</b> define o ponteiro para o in√≠cio do nosso "arquivo", ou seja, para o MBR. <br><br><img src="https://habrastorage.org/webt/eb/7z/vb/eb7zvba8zitins67gn2vtiiu8gs.png"><br><br>  Depois, h√° uma grava√ß√£o (WriteFile) formada <i>_marked_bytes</i> e liberando mem√≥ria.  Com isso, a funcionalidade do instalador do kit de inicializa√ß√£o termina. <br><br>  Mas seria bom <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2429">ver o que exatamente</a> est√° na primeira parte de <b>_marked_bytes</b> .  Para fazer isso, despeje-o em disco e analise-o.  A primeira coisa que chama sua aten√ß√£o √© uma diminui√ß√£o de 2 do conte√∫do da vari√°vel no endere√ßo 0x413. <br><br><img src="https://habrastorage.org/webt/pq/_w/3k/pq_w3kqifhqcrnmjtebzseacgpu.png"><br><br>  Se voc√™ examinar a documenta√ß√£o t√©cnica, poder√° descobrir que a vari√°vel em 0X413 cont√©m a quantidade de mem√≥ria f√≠sica instalada em kilobytes.  Assim, o c√≥digo do kit de inicializa√ß√£o "corta" dois kilobytes de mem√≥ria: <br><br><img src="https://habrastorage.org/webt/gc/ks/kb/gckskbwy16b2m0k8sgwv6lg__zk.png"><br><br>  Agora, para n√£o ser feito mais, ser√° considerado que h√° 2 kilobytes de mem√≥ria a menos do que era.  Por que - ainda n√£o est√° claro. <br><br>  <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2734">Em seguida, o</a> endere√ßo f√≠sico <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2734">√©</a> calculado para a parte da mem√≥ria "bit off" usando um deslocamento √† esquerda de 6 bits, bit a bit: <br><br><img src="https://habrastorage.org/webt/9i/ve/qb/9iveqb9zzdser14szx1vnercz20.png"><br><br>  Um deslocamento de 6 executa duas a√ß√µes ao mesmo tempo - converte kilobytes em bytes (multiplicando o valor da vari√°vel por 2 ^ 10), obtendo assim o endere√ßo f√≠sico da parte da mem√≥ria removida e extrai o n√∫mero do segmento, dividindo o resultado por 0x10 (2 ^ 4). <br><br>  Depois disso, seu corpo ser√° copiado sobre esse peda√ßo de mem√≥ria e, como o c√≥digo do kit de inicializa√ß√£o est√° no peda√ßo "pouco", <b>ningu√©m ir√° perturb√°-lo ainda mais</b> .  Al√©m disso, nenhuma interrup√ß√£o n√£o mudar√° o que est√° escrito nesta √°rea de mem√≥ria.  Podemos dizer que o <b>c√≥digo se torna praticamente invis√≠vel para o sistema</b> , como se n√£o houvesse mem√≥ria l√°. <br><br>  Este √© apenas o come√ßo do kit de inicializa√ß√£o.  Haver√° intercepta√ß√£o de interrup√ß√£o, rastreamento de assinatura ntldr, modifica√ß√£o do m√≥dulo do kernel do SO, etc. <br><br>  Portanto, n√£o vamos estragar tudo, √© melhor <a href="https://otus.pw/1uOJ/">assistir ao webinar</a> at√© o fim para n√£o perder nada. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt482086/">https://habr.com/ru/post/pt482086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt482070/index.html">Cinco h√°bitos que ajudam a manter o desempenho do c√©rebro</a></li>
<li><a href="../pt482076/index.html">Clientes, confie em asoshnikov</a></li>
<li><a href="../pt482078/index.html">Riscos de projetos de TI e equipes de TI</a></li>
<li><a href="../pt482080/index.html">Gateway para UDP entre Wi-Fi e LoRa</a></li>
<li><a href="../pt482084/index.html">O que ler nos feriados</a></li>
<li><a href="../pt482088/index.html">Abra√ßo para desenvolvedores, ou como eu fui ao KotlinConf</a></li>
<li><a href="../pt482092/index.html">Do que os cegos precisam? Revis√£o do especialista surdo-cego Sergei Fleitin</a></li>
<li><a href="../pt482094/index.html">Arquiteto de software: por que √© necess√°rio e qual √© a sua maldi√ß√£o</a></li>
<li><a href="../pt482096/index.html">VR e criatividade: como as esta√ß√µes de trabalho Dell Precision ajudam os alunos da British Graduate School of Design</a></li>
<li><a href="../pt482100/index.html">Tecnologia AMP em e-mails: pr√≥s, contras e poss√≠veis usos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>