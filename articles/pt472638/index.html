<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçü§ù‚Äçüë®üèº ü§æüèø üõÄüèΩ Construa um andador de ferro fundido no Spring Boot e no AppCDS üïå üëÇüèæ üòâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Compartilhamento de dados de classe de aplicativo (AppCDS) - recurso JVM para acelerar a inicializa√ß√£o e economizar mem√≥ria. Tendo aparecido em sua in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Construa um andador de ferro fundido no Spring Boot e no AppCDS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472638/"><p><img src="https://habrastorage.org/webt/se/py/8z/sepy8zdhkojsr-xiqs-lwdtyegy.jpeg"></p><br><p> <strong>Compartilhamento de dados de classe de aplicativo (AppCDS)</strong> - recurso JVM para acelerar a inicializa√ß√£o e economizar mem√≥ria.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tendo aparecido</a> em sua inf√¢ncia no HotSpot em JDK 1.5 (2004), <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">permaneceu por</a> muito tempo muito limitado e at√© parcialmente comercial.  Somente com o OpenJDK 10 (2018) ele foi disponibilizado a meros mortais, ao mesmo tempo em que ampliava o escopo.  E o Java 13, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">lan√ßado</a> recentemente, tentou tornar esse aplicativo mais simples. </p><br><p>  A id√©ia do AppCDS √© "compartilhar" uma vez carregadas as classes entre inst√¢ncias da mesma JVM no mesmo host.  Parece que isso deve ser √≥timo para microsservi√ßos, especialmente os "broilers" no Spring Boot com milhares de classes de bibliotecas, porque agora essas classes n√£o precisam ser carregadas (analisadas e verificadas) a cada in√≠cio de cada inst√¢ncia da JVM e n√£o ser√£o duplicadas na mem√≥ria.  Isso significa que o lan√ßamento deve se tornar mais r√°pido e o consumo de mem√≥ria deve ser menor.  Maravilhoso, n√£o √©? </p><br><p>  Tudo √© assim, tudo √© assim.  Mas se voc√™, o odnokhabryanin, costumava acreditar n√£o nos sinais da avenida, mas em n√∫meros e exemplos espec√≠ficos, ent√£o seja bem-vindo ao kat - vamos tentar descobrir como realmente √© ... </p><a name="habracut"></a><br><h2 id="vmesto-disclaimera">  Em vez de isen√ß√£o de responsabilidade </h2><br><p>  Antes voc√™ n√£o √© um guia para usar o AppCDS, mas um resumo dos resultados de um pequeno estudo.  Eu estava interessado em entender como essa fun√ß√£o da JVM √© aplic√°vel em meu projeto de trabalho e tentei avali√°-la da perspectiva de um desenvolvedor corporativo, estabelecendo o resultado neste artigo.  Isso n√£o incluiu t√≥picos como o uso do AppCDS no caminho do m√≥dulo, a implementa√ß√£o do AppCDS em outras m√°quinas virtuais (n√£o o HotSpot) e os meandros do uso de cont√™ineres.  Mas h√° uma parte te√≥rica para explorar o t√≥pico, bem como uma parte experimental escrita para que voc√™ possa repetir a experi√™ncia por conta pr√≥pria.  Nenhum dos resultados ainda foi aplicado na produ√ß√£o, mas quem sabe como ser√° o amanh√£ ... </p><br><h2 id="teoriya">  Teoria </h2><br><h3 id="kratkoe-vvedenie-v-appcds">  Uma breve introdu√ß√£o ao AppCDS </h3><br><p>  O conhecimento deste t√≥pico pode ter ocorrido a voc√™ em v√°rias fontes, por exemplo: </p><br><ul><li>  em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> de Nikolai Parlog (incluindo Java 13 p√£es, mas sem Spring Boot) </li><li>  em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> de Volker Simonis (sem Java 13, mas com detalhes) </li><li>  em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio do</a> autor dessas linhas (sem Java 13, mas com √™nfase no Spring Boot) </li></ul><br><p>  Para n√£o participar da recontagem, destacarei apenas alguns pontos importantes para este artigo. </p><br><p>  Em primeiro lugar, o AppCDS √© uma extens√£o do recurso CDS que aparece h√° muito tempo no HotSpot, cuja ess√™ncia √© a seguinte: </p><br><p><img src="https://habrastorage.org/webt/gi/kg/ro/gikgrobp0s_hbnr5ox8z6d1ziqc.png"></p><br><p>  Para dar vida √†s duas id√©ias, fa√ßa o seguinte (em termos gerais): </p><br><ol><li>  Obtenha uma lista de classes que voc√™ deseja compartilhar entre inst√¢ncias de aplicativos </li><li>  Mesclar essas classes em um arquivo adequado para mapeamento de mem√≥ria </li><li>  Conecte o arquivo morto a cada inst√¢ncia do aplicativo na inicializa√ß√£o </li></ol><br><p>  Parece que o algoritmo tem apenas 3 etapas - pegue e fa√ßa.  Mas aqui as not√≠cias come√ßam, todo tipo de coisa. </p><br><p>  O ruim √© que, na pior das hip√≥teses, cada um desses itens se transforma em pelo menos um lan√ßamento da JVM com suas pr√≥prias op√ß√µes espec√≠ficas, o que significa que todo o algoritmo √© um malabarismo sutil do mesmo tipo de op√ß√µes e arquivos.  Isso n√£o parece muito promissor, n√£o √©? </p><br><p>  Mas h√° boas not√≠cias: o trabalho para melhorar esse algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° em andamento</a> e, a cada vers√£o do Java, seu aplicativo se torna mais f√°cil.  Ent√£o, por exemplo: </p><br><ul><li> No OpenJDK <strong>10 e 11,</strong> voc√™ pode pular a etapa <strong>1</strong> se desejar compartilhar apenas as principais classes JDK, pois elas j√° foram compiladas para n√≥s e colocadas em <code>$JAVA_HOME\lib\classlist</code> (‚âà1200 unidades.). </li><li>  No OpenJDK <strong>12,</strong> voc√™ pode pular a <strong>etapa 2</strong> porque, junto com a lista de classes, o arquivo de distribui√ß√£o tamb√©m inclui um arquivo pronto, que √© usado imediatamente e n√£o requer uma conex√£o expl√≠cita. </li><li>  Caso voc√™ queira compartilhar todo o resto (e geralmente apenas deseja) <br>  O OpenJDK <strong>13</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fornece</a> arquivos Dynamic CDS - arquivos que s√£o coletados durante a opera√ß√£o do aplicativo e salvos quando ele √© ocupado.  Isso permite recolher os <strong>pontos 1 e 2</strong> em um ponto n√£o muito confuso (embora nem tudo seja t√£o simples, mas mais adiante). </li></ul><br><p>  Portanto, n√£o importa qual seja o processo de prepara√ß√£o do AppCDS, as tr√™s etapas listadas acima est√£o sempre por tr√°s, apenas em alguns casos elas s√£o veladas. </p><br><p>  Como voc√™ provavelmente notou, com o advento do AppCDS, muitas classes de aplicativos come√ßam uma vida dupla: elas vivem simultaneamente em seus lugares anteriores (na maioria das vezes, arquivos JAR) e em um novo arquivo compartilhado.  Ao mesmo tempo, o desenvolvedor continua a alter√°-los / remov√™-los / suplement√°-los no mesmo local, e a JVM os retira do novo quando est√£o trabalhando.  N√£o √© preciso ser um adivinho para ver o perigo de tal situa√ß√£o: se nada for feito, mais cedo ou mais tarde c√≥pias das classes v√£o corroer, e teremos muitos encantos do t√≠pico "inferno JAR".  √â claro que a JVM n√£o pode impedir altera√ß√µes de classe, mas deve ser capaz de detectar uma discrep√¢ncia no tempo.  No entanto, fazer isso comparando classes aos pares, mesmo por somas de verifica√ß√£o, √© uma id√©ia;  pode negar o restante dos ganhos de produtividade.  Provavelmente, √© por isso que os engenheiros da JVM n√£o selecionaram as classes individuais como objeto de compara√ß√£o, mas o caminho de classe inteiro e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">declararam</a> na documenta√ß√£o do AppCDS: ‚ÄúO caminho de classe ao criar um archive compartilhado deve ser o mesmo (ou pelo menos um prefixo) das ativa√ß√µes subsequentes do aplicativo‚Äù. </p><br><blockquote>  Observe que o caminho de classe usado no momento da cria√ß√£o do arquivo morto deve ser o mesmo (ou um prefixo) do caminho de classe usado no tempo de execu√ß√£o. </blockquote><p>  Mas essa n√£o √© uma afirma√ß√£o inequ√≠voca, porque, como voc√™ se lembra, um caminho de classe pode ser formado de diferentes maneiras, como: </p><br><ul><li>  lendo arquivos <code>.class</code> de diret√≥rios de pacotes compilados, <br>  por exemplo, <code>java com.example.Main</code> </li><li>  varrendo diret√≥rios com arquivos JAR ao usar curinga, <br>  por exemplo, <code>java -cp mydir/* com.example.Main</code> </li><li>  lista expl√≠cita de arquivos JAR e / ou ZIP, <br>  por exemplo, <code>java -cp lib1.jar;lib2.jar com.example.Main</code> </li></ul><br><p>  (isso n√£o inclui o fato de que o caminho da classe tamb√©m pode ser configurado de maneira diferente, por exemplo, pelas op√ß√µes da JVM <code>-cp/-classpath/--class-path</code> , pela vari√°vel de ambiente <code>CLASSPATH</code> ou pelo atributo do arquivo JAR do <code>Class-Path</code> da <code>Class-Path</code> a ser ativado) </p><br><p>  Desses m√©todos, apenas um √© suportado no AppCDS - enumera√ß√£o expl√≠cita de arquivos JAR.  Aparentemente, os engenheiros da HotSpot JVM achavam que comparar caminhos de classe no arquivo AppCDS e no aplicativo iniciado seria r√°pido o suficiente e confi√°vel apenas se fossem especificados da maneira <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mais</a> clara <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">poss√≠vel</a> - com uma lista exaustiva usual. </p><br><blockquote>  O CDS / AppCDS suporta classes de arquivamento apenas de arquivos JAR. </blockquote><p>  √â importante observar aqui que esta afirma√ß√£o n√£o √© recursiva, ou seja,  n√£o se aplica a arquivos JAR dentro de arquivos JAR (a menos que se trate de CDS din√¢mico, veja abaixo).  Isso significa que os bonecos JAR habituais emitidos pelo Spring Boot n√£o funcionar√£o exatamente como no AppCDS comum; voc√™ precisar√° se sentar. </p><br><p>  Outro problema no trabalho do CDS √© que os arquivos compartilhados s√£o projetados na mem√≥ria com endere√ßos fixos (geralmente come√ßando em <code>0x800000000</code> ).  Isso por si s√≥ n√£o √© ruim, mas como a ASLR (Address Space Layout Randomization) √© ativada por padr√£o na maioria dos sistemas operacionais, o intervalo de mem√≥ria necess√°rio pode estar parcialmente ocupado.  O que a JVM do HotSpot faz nesse caso √© a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">op√ß√£o</a> especial <code>-Xshare</code> que suporta tr√™s valores: </p><br><ul><li>  <code>-Xshare:on</code> CDS / AppCDS <code>-Xshare:on</code> vigor;  se o intervalo estiver ocupado, a JVM sair√° com um erro.  Este modo <strong>n√£o</strong> √© <strong>recomendado para uso em produ√ß√£o</strong> , pois isso pode causar falhas espor√°dicas ao iniciar aplicativos. </li><li>  <code>-Xshare:off</code> - (voc√™) alterna o CDS / AppCDS;  desativa completamente o uso de dados compartilhados (incluindo arquivos incorporados) </li><li>  <code>-Xshare:auto</code> - o comportamento padr√£o da JVM quando, em caso de impossibilidade de alocar o intervalo de mem√≥ria necess√°rio, se entrega silenciosamente e carrega as classes normalmente. </li></ul><br><p>  No momento da reda√ß√£o deste artigo, a Oracle estava <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">trabalhando</a> apenas para amenizar esses problemas, mas um n√∫mero de release ainda n√£o foi atribu√≠do. </p><br><p>  Essas op√ß√µes s√£o parcialmente √∫teis para n√≥s mais tarde, mas, por enquanto, vejamos ... </p><br><h3 id="varianty-primeneniya-appcds">  Aplicativos AppCDS </h3><br><p>  Existem v√°rias maneiras de usar o AppCDS. <del>  arruinar sua vida </del>  otimizar o trabalho dos microsservi√ßos.  Eles variam muito em complexidade e lucro potencial, por isso √© importante decidir imediatamente qual deles ser√° discutido mais tarde. </p><br><p>  O mais simples √© usar nem mesmo o AppCDS, mas apenas o CDS - √© quando apenas as classes da plataforma entram no arquivo compartilhado (consulte "Uma Breve Introdu√ß√£o ao AppCDS").  Excluiremos essa op√ß√£o imediatamente porque, quando aplicada a microsservi√ßos no Spring Boot, ela gera muito pouco lucro.  Isso pode ser visto pela propor√ß√£o do n√∫mero de classes compartilhadas em sua distribui√ß√£o geral usando o exemplo de um microsservi√ßo real (consulte o segmento verde): </p><br><p><img src="https://habrastorage.org/webt/lz/7x/9l/lz7x9lodfzwv4ihwjjifjyxsf_a.png"></p><br><p>  Mais complexo, mas promissor, √© o uso do AppCDS completo, ou seja, a inclus√£o de classes de biblioteca e aplicativo no mesmo arquivo.  Essa √© uma fam√≠lia inteira de op√ß√µes derivada de combina√ß√µes do n√∫mero de aplicativos participantes e do n√∫mero de inst√¢ncias.  A seguir, s√£o apresentadas avalia√ß√µes subjetivas dos autores sobre os benef√≠cios e dificuldades de v√°rias aplica√ß√µes do AppCDS. </p><br><div class="scrollable-table"><table><thead><tr><th>  N√£o. </th><th>  Aplica√ß√µes </th><th>  Inst√¢ncias </th><th>  Lucro da CPU </th><th>  Lucro RAM </th><th>  Dificuldade </th></tr></thead><tbody><tr><td>  1 </td><td>  Um </td><td>  Um </td><td>  + </td><td>  ¬± </td><td>  Baixo </td></tr><tr><td>  <strong>2</strong> </td><td>  <strong>Um</strong> </td><td>  <strong>Alguns</strong> </td><td>  <strong>++</strong> </td><td>  <strong>++</strong> </td><td>  <strong>Baixo</strong> </td></tr><tr><td>  3 </td><td>  Alguns </td><td>  Um de cada vez </td><td>  ++ </td><td>  ++ </td><td>  Alta </td></tr><tr><td>  4 </td><td>  Alguns </td><td>  Alguns </td><td>  +++ </td><td>  +++ </td><td>  Alta </td></tr></tbody></table></div><br><p>  Preste aten√ß√£o: </p><br><ul><li>  No aplicativo para um aplicativo em uma inst√¢ncia (N¬∫ 1), o lucro da mem√≥ria pode ser zero ou at√© negativo (especialmente ao medir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no Windows</a> ) </li><li>  Criar o arquivo compartilhado correto requer a√ß√µes, cuja complexidade n√£o depende de quantas c√≥pias o aplicativo ser√° iniciado (compare pares de op√ß√µes n¬∫s 1-2 e 3-4) </li><li>  Ao mesmo tempo, a transi√ß√£o de uma inst√¢ncia para v√°rias, obviamente, aumenta o lucro para ambos os indicadores, mas n√£o afeta a complexidade da prepara√ß√£o. </li></ul><br><p>  Neste artigo, <strong>alcan√ßaremos apenas a op√ß√£o n ¬∞ 2</strong> (at√© o n ¬∞ 1), uma vez que √© simples o suficiente para um conhecimento pr√≥ximo do AppCDS e, somente para isso, sem truques extras, podemos usar os recentemente lan√ßados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JEP-350</a> Dynamic CDS Archives, que quero sentir em a√ß√£o. </p><br><h3 id="dynamic-cds-archives">  Arquivos CDS din√¢micos </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Os</a> arquivos Dynamic CDS do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JEP-350</a> , uma das principais inova√ß√µes do Java 13, foram projetados para simplificar o uso do AppCDS.  Para sentir a simplifica√ß√£o, voc√™ deve primeiro entender a complexidade.  Deixe-me lembr√°-lo de que o algoritmo cl√°ssico de aplicativo ‚Äúlimpo‚Äù do AppCDS consiste em 3 etapas: (1) obtenha uma lista de classes compartilhadas, (2) crie um arquivo a partir delas e (3) execute o aplicativo com o arquivo conectado.  Destas etapas, apenas a terceira √© realmente √∫til, o restante √© apenas uma prepara√ß√£o para isso.  E embora a obten√ß√£o de uma lista de classes (etapa 1) possa parecer muito simples (em alguns casos, √© opcional), na verdade, ao trabalhar com aplicativos n√£o triviais, acaba sendo a mais dif√≠cil, especialmente no que diz respeito ao Spring Boot.  Portanto, o JEP-350 √© necess√°rio apenas para eliminar essa etapa, ou melhor, automatiz√°-la.  A id√©ia √© que a pr√≥pria JVM elabore uma lista das classes de que o aplicativo precisa e, em seguida, forme a partir delas o chamado arquivo ‚Äúdin√¢mico‚Äù.  Concordo, parece bom.  Mas o problema √© que agora fica claro em que ponto parar de acumular classes e continuar a coloc√°-las no arquivo.  Anteriormente, no AppCDS cl√°ssico, escolhemos esse momento por conta pr√≥pria e podemos at√© alternar entre essas a√ß√µes para alterar algo na lista de classes antes de transform√°-lo em um arquivo.  Agora, isso est√° acontecendo automaticamente e apenas em um momento, para o qual os engenheiros da JVM escolheram, talvez, a √∫nica op√ß√£o de comprometimento - o desligamento regular da JVM.  Isso significa que o arquivo morto n√£o ser√° criado at√© que o aplicativo pare.  Esta solu√ß√£o tem algumas consequ√™ncias importantes: </p><br><ul><li>  No caso de uma falha na JVM, o archive n√£o ser√° criado, por mais maravilhosa que seja a lista de classes acumuladas at√© ent√£o (n√£o √© poss√≠vel extra√≠-la posteriormente usando meios regulares). </li><li>  O arquivo morto ser√° criado apenas a partir das classes que conseguiram carregar durante a sess√£o do aplicativo.  Para aplicativos da Web, isso significa que a cria√ß√£o de um arquivo morto iniciando e parando n√£o √© correta, pois muitas classes importantes n√£o ser√£o inseridas no arquivo morto.  √â necess√°rio executar pelo menos uma solicita√ß√£o HTTP no aplicativo (e √© melhor execut√°-lo adequadamente em todos os cen√°rios) para que todas as classes que ele realmente usa sejam carregadas. </li></ul><br><p>  Uma diferen√ßa importante entre os arquivos est√°ticos e din√¢micos √© que eles sempre constituem um "complemento" sobre os arquivos est√°ticos b√°sicos, que podem ser arquivos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">embutidos</a> no kit de distribui√ß√£o Java ou criados separadamente, em uma maneira cl√°ssica de tr√™s etapas. </p><br><p>  Sintaticamente, o uso de Dynamic CDS Archives se resume a dois lan√ßamentos da JVM com duas op√ß√µes: </p><br><ol><li>  Execu√ß√£o de avalia√ß√£o com a op√ß√£o <code>-XX:ArchiveClassesAtExit=archive.jsa</code> , no final do qual um archive din√¢mico ser√° criado (voc√™ pode especificar qualquer caminho e nome) </li><li>  Lan√ßamento √∫til com a op√ß√£o <code>-XX:SharedArchiveFile=archive.jsa</code> , que usar√° o archive criado anteriormente </li></ol><br><p>  A segunda op√ß√£o n√£o √© diferente de conectar um arquivo est√°tico regular.  Mas se de repente o arquivo est√°tico b√°sico n√£o estiver no local padr√£o (dentro do JDK), essa op√ß√£o tamb√©m poder√° incluir uma indica√ß√£o do caminho para ele, por exemplo: </p><br><pre> <code class="bash hljs">-XX:SharedArchiveFile=base.jsa:dynamic.jsa</code> </pre> <br><p>  <em>(no Windows, o separador de caminho deve ser o caractere ";")</em> </p><br><p>  Agora voc√™ conhece o AppCDS o suficiente para poder v√™-lo em a√ß√£o. </p><br><h2 id="praktika">  Pr√°tica </h2><br><h3 id="podopytnyy-krolik">  Coelho experimental </h3><br><p>  Para que nossa aplica√ß√£o do AppCDS na pr√°tica n√£o se limite a um HelloWorld t√≠pico, tomaremos como base a aplica√ß√£o real no Spring Boot.  Meus colegas e eu geralmente temos que assistir logs de aplicativos em servidores de teste remotos e assistir ao vivo, exatamente como eles s√£o gravados.  Para usar isso, um agregador de logs completo (como o ELK) geralmente n√£o √© apropriado;  baixar arquivos de log infinitamente - por um longo tempo, e olhar para a sa√≠da cinza do console √© deprimente.  Portanto, criei um aplicativo da web que pode gerar quaisquer logs em tempo real diretamente para o navegador, colorir linhas por n√≠vel de import√¢ncia (ao mesmo tempo em que formata XML), agregar v√°rios logs em um e outros truques.  √â chamado <strong>ANALOG</strong> (como um "analisador de log", embora isso n√£o seja verdade) e est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no GitHub</a> .  Clique na imagem para ampliar: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/q3/lo/m_/q3lom_x6c9wghlerm1g9oa9-yfw.png"></a> </p><br><p>  Tecnicamente, esse √© um aplicativo no Spring Boot + Spring Integration, sob o cap√¥ do qual <code>tail</code> , <code>docker</code> e <code>kubectl</code> (para oferecer suporte a logs de arquivos, cont√™ineres do Docker e recursos do Kubernetes, respectivamente).  Ele vem na forma do arquivo JAR cl√°ssico "grosso" do Spring Boot.  No tempo de execu√ß√£o, <strong>as classes de K10K est√£o suspensas</strong> na mem√≥ria do aplicativo, das quais a grande maioria s√£o classes Spring e JDK.  Obviamente, essas classes mudam muito raramente, o que significa que podem ser colocadas em um arquivo compartilhado e reutilizadas em todas as inst√¢ncias do aplicativo, economizando mem√≥ria e CPU. </p><br><h3 id="odinochnyy-eksperiment">  Experi√™ncia √∫nica </h3><br><p>  Agora vamos aplicar o conhecimento existente do Dynamic AppCDS ao coelho experimental.  Como tudo √© conhecido em compara√ß√£o, precisaremos de um ponto de refer√™ncia - o estado do programa com o qual compararemos os resultados obtidos durante o experimento. </p><br><h4 id="vvodnye-zamechaniya">  Observa√ß√µes introdut√≥rias </h4><br><ul><li>  Todos os comandos adicionais s√£o para Linux.  As diferen√ßas para Windows e macOS n√£o s√£o fundamentais. </li><li>  A compila√ß√£o JIT pode afetar visivelmente os resultados e, em teoria, pela pureza do experimento, ele pode ser desativado (com a op√ß√£o <code>-Xint</code> , como foi feito no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> mencionado), mas por uma quest√£o de m√°xima credibilidade, decidiu-se n√£o fazer isso. </li><li>  Os seguintes n√∫meros sobre a hora de in√≠cio foram obtidos em um servidor de teste r√°pido.  Em m√°quinas de trabalho, n√∫meros semelhantes, em regra, s√£o mais modestos, mas como n√£o estamos interessados ‚Äã‚Äãem valores absolutos, mas em incrementos percentuais, consideramos essa diferen√ßa insignificante. </li><li>  Para n√£o entrar prematuramente na complexidade de medir a mem√≥ria compartilhada, por enquanto, omitiremos obter leituras precisas em bytes.  Em vez disso, introduzimos o conceito de " <strong>potencial CDS</strong> " <strong>,</strong> expresso como uma porcentagem do n√∫mero de classes compartilhadas no n√∫mero total de classes carregadas.  √â claro que isso √© uma quantidade abstrata, mas, por outro lado, afeta diretamente o consumo real de mem√≥ria;  al√©m disso, sua defini√ß√£o n√£o depende do sistema operacional e, para seu c√°lculo, apenas os logs s√£o suficientes. </li></ul><br><h4 id="referentnaya-tochka">  Ponto de refer√™ncia </h4><br><p>  Deixe este ponto ser o estado de um aplicativo baixado recentemente, ou seja,  sem o uso expl√≠cito de qualquer AppCDS'ov e outros.  Para avali√°-lo, precisamos de: </p><br><ol><li><p>  Instale o OpenJDK 13 (por exemplo, a distribui√ß√£o dom√©stica do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Liberica</a> , mas n√£o a vers√£o lite). <br>  Ele tamb√©m precisa ser inclu√≠do na vari√°vel de ambiente PATH ou em <code>JAVA_HOME</code> , por exemplo, assim: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_HOME=~/tools/jdk-13</code> </pre> <br></li><li><p>  <a href="">Fa√ßa o download do</a> ANALOG (no momento da reda√ß√£o, a vers√£o mais recente era a v0.12.1). </p><br><p>  Se necess√°rio, voc√™ pode especificar no arquivo <code>config/application.yaml</code> no par√¢metro <code>server.address</code> o nome do host externo para acessar o aplicativo (por padr√£o, <code>localhost</code> √© especificado l√°). </p><br></li><li><p>  Ative o log de carregamento de classe da JVM. <br>  Para fazer isso, voc√™ pode <code>JAVA_OPTS</code> a vari√°vel de ambiente <code>JAVA_OPTS</code> com este valor: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=-Xlog:class+load=info:file=<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/class-load.log</code> </pre> <br><p>  Essa op√ß√£o ser√° passada para a JVM e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">instruir√° a</a> fonte de cada classe. </p><br></li><li><p>  Execute um teste: </p><br><ol><li>  Execute o aplicativo com o script <code>bin/analog</code> </li><li>  Abra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http: // localhost: 8083</a> no navegador, aperte bot√µes e daws </li><li>  Pare o aplicativo pressionando <code>Ctrl+C</code> no console de scripts <code>bin/analog</code> </li></ol><br></li><li><p>  Pegue o resultado (dos arquivos no diret√≥rio <code>log/</code> ) </p><br><ul><li><p>  N√∫mero total de classes carregadas (por <code>class-load.log</code> ): </p><br><pre> <code class="bash hljs">cat class-load.log | wc -l 10463</code> </pre> <br></li><li><p>  Quantos deles s√£o baixados de um arquivo compartilhado (de acordo com ele): </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'source: shared'</span></span> - class-load.log 1146</code> </pre> <br></li><li><p>  Tempo m√©dio de in√≠cio (ap√≥s v√°rias s√©ries; por <code>analog.log</code> ): </p><br><pre> <code class="bash hljs">grep -oE <span class="hljs-string"><span class="hljs-string">'\(JVM running for .+\)'</span></span> analog.log | grep -oE <span class="hljs-string"><span class="hljs-string">'[0-9]\.[0-9]+'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span></span> 4.5225</code> </pre> <br></li></ul><br></li></ol><br><p>  Portanto, nesta etapa, o potencial do CDS era <code>1146/10463=0,1095</code> <strong>¬± 11%</strong> .  Se voc√™ est√° surpreso de onde vieram as classes compartilhadas (afinal, ainda n√£o inclu√≠mos nenhum AppCDS), lembro que a partir da 12¬™ vers√£o, o JDK <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">inclui o</a> arquivo final do CDS <code>$JAVA_HOME/lib/server/classes.jsa</code> , constru√≠do por n√£o menos do que lista pronta de classes: </p><br><pre> <code class="bash hljs">cat <span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/lib/classlist | wc -l 1170</code> </pre> <br><p>  Agora, depois de avaliar o estado inicial do aplicativo, podemos aplicar o AppCDS a ele e, por compara√ß√£o, entender o que isso oferece. </p><br><h4 id="osnovnoy-opyt">  Experi√™ncia central </h4><br><p>  Como a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> nos foi fornecida, para criar um archive din√¢mico do AppCDS, voc√™ precisa executar apenas uma execu√ß√£o de avalia√ß√£o do aplicativo com a op√ß√£o <code>-XX:ArchiveClassesAtExit</code> .  A partir do pr√≥ximo lan√ßamento, o arquivo pode ser usado e obter lucro.  Para verificar isso no mesmo coelho experimental (AnaLog), voc√™ precisa: </p><br><ol><li><p>  Adicione a op√ß√£o especificada ao comando run: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -XX:ArchiveClassesAtExit=work/classes.jsa"</span></span></code> </pre> <br></li><li><p>  Estender o log: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -Xlog:cds=debug:file=log/cds.log"</span></span></code> </pre><br><p>  Esta op√ß√£o for√ßar√° o processo de constru√ß√£o de um arquivo CDS a ser registrado quando o aplicativo for parado. </p><br></li><li><p>  Execute o mesmo teste que o ponto de refer√™ncia: </p><br><ol><li>  Execute o aplicativo com o script <code>bin/analog</code> </li><li>  Abra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http: // localhost: 8083</a> no navegador, aperte bot√µes e daws </li><li>  Pare o aplicativo pressionando <code>Ctrl+C</code> no console de scripts <code>bin/analog</code> <br>  Depois disso, um tremendo cal√ßado com todos os tipos de aviso deve cair no console e o <code>log/cds.log</code> deve ser preenchido com detalhes;  eles ainda n√£o nos interessam. </li></ol><br></li><li><p>  Alterne o modo de inicializa√ß√£o de teste para √∫til: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"-XX:SharedArchiveFile=work/classes.jsa -Xlog:class+load=info:file=log/class-load.log -Xlog:class+path=debug:file=log/class-path.log"</span></span></code> </pre><br><p>  Aqui n√£o suplementamos a vari√°vel <code>JAVA_OPTS</code> , mas a apagamos com novos valores que incluem (1) usando um arquivo compartilhado, (2) fontes de classe de log e (3) verifica√ß√£o de caminho de classe de log. </p><br></li><li><p>  Execute um lan√ßamento √∫til do aplicativo de acordo com o esquema do par√°grafo 3. </p><br></li><li><p>  Pegue o resultado (dos arquivos no diret√≥rio <code>log/</code> ) </p><br><ul><li><p>  Verificando se o AppCDS realmente foi aplicado (pelo <code>class-path.log</code> ): </p><br><pre> <code class="plaintext hljs">[0.011s][info][class,path] type=BOOT [0.011s][info][class,path] Expecting BOOT path=/home/upc/tools/jdk-13/lib/modules [0.011s][info][class,path] ok [0.011s][info][class,path] type=APP [0.011s][info][class,path] Expecting -Djava.class.path=/home/upc/tmp/analog/lib/analog.jar [0.011s][info][class,path] ok</code> </pre><br><p>  As marcas <code>ok</code> ap√≥s as linhas <code>type=BOOT</code> e <code>type=APP</code> indicam a abertura, verifica√ß√£o e carregamento bem-sucedidos dos arquivos CDS embutidos e aplicados, respectivamente. </p><br></li><li><p>  N√∫mero total de classes carregadas (por <code>class-load.log</code> ): </p><br><pre> <code class="bash hljs">cat class-load.log | wc -l 10403</code> </pre><br></li><li><p>  Quantos deles s√£o baixados de um arquivo compartilhado (de acordo com ele): </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'source: shared'</span></span> -c class-load.log 6910</code> </pre><br></li><li><p>  Tempo m√©dio de in√≠cio (ap√≥s v√°rias s√©ries; por arquivo <code>analog.log</code> ): </p><br><pre> <code class="bash hljs">grep -oE <span class="hljs-string"><span class="hljs-string">'\(JVM running for .+\)'</span></span> analog.log | grep -oE <span class="hljs-string"><span class="hljs-string">'[0-9]\.[0-9]+'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{ total += $1; count++ } END { print total/count }'</span></span> 4.04167</code> </pre><br></li></ul><br></li></ol><br><p>  Mas nesta etapa, o potencial do CDS j√° era <code>6910/10403‚âà0,66</code> <strong>= 66%</strong> , ou seja, aumentou <strong>55% em</strong> compara√ß√£o com o ponto de refer√™ncia.  Ao mesmo tempo, o tempo m√©dio de inicializa√ß√£o foi reduzido em <code>(4,5225-4,04167)=0,48</code> segundos, ou seja,  O in√≠cio √© mais r√°pido em <strong>¬± 10,6%</strong> do valor inicial. </p><br><h4 id="analiz-rezultatov">  An√°lise de Resultados </h4><br><p>  <em>O t√≠tulo de trabalho do item √©: "Por que t√£o pouco?"</em> </p><br><p>  Fizemos tudo de acordo com as instru√ß√µes, mas nem todas as classes estavam no arquivo.  O n√∫mero deles afeta o tempo de lan√ßamento n√£o menos que o poder computacional da m√°quina do experimentador, portanto, nos concentraremos nesse n√∫mero. </p><br><p>  Se voc√™ se lembra, <code>log/cds.log</code> arquivo <code>log/cds.log</code> criado durante a parada do aplicativo experimental ap√≥s a execu√ß√£o da avalia√ß√£o.  Nesse arquivo HotSpot, a JVM gentilmente notava classes de aviso para cada classe que n√£o aparecia no arquivo CDS.  Aqui est√° o n√∫mero total de tais marcas: </p><br><pre> <code class="bash hljs">grep -o <span class="hljs-string"><span class="hljs-string">'[warning]'</span></span> cds.log -c 3591</code> </pre><br><p>  Considerando que apenas 10K + classes s√£o mencionadas no log de <code>class-load.log</code> e 66% delas s√£o carregadas do archive, n√£o √© dif√≠cil entender que as 3600 classes listadas no <code>cds.log</code> s√£o os 44% "ausentes" do potencial do CDS.  Agora voc√™ precisa descobrir por que eles foram ignorados. </p><br><p>  Se voc√™ olhar para o log cds.log, verifica-se que existem apenas 4 raz√µes exclusivas para ignorar as classes.  Aqui est√£o exemplos de cada um deles: </p><br><pre> <code class="plaintext hljs">Skipping org/springframework/web/client/HttpClientErrorException: Not linked Pre JDK 6 class not supported by CDS: 49.0 org/jrobin/core/RrdUpdater Skipping java/util/stream/Collectors$$Lambda$554: Unsafe anonymous class Skipping ch/qos/logback/classic/LoggerContext: interface org/slf4j/ILoggerFactory is excluded</code> </pre><br><p>  Entre todas as 3591 aulas perdidas, esses motivos s√£o encontrados aqui com tanta frequ√™ncia: </p><br><p><img src="https://habrastorage.org/webt/sp/f6/6k/spf66kzmkajvdxki1xdiwjyx9lg.png"></p><br><p>  D√™ uma olhada neles: </p><br><ul><li><p> <code>Unsafe anonymous class</code> <br>   JVM   ‚Äú‚Äù   ,       -,         . </p><br></li><li><p> <code>Not linked</code> <br>      , ‚Äú‚Äù     ,  ,   .      ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">StackOverflow </a>    . , ,       ‚Äú‚Äù () JAR-  ,   AppCDS.       ,     (  ). </p><br></li><li><p> <code>Pre JDK 6 class</code> <br>  ,   CDS    Java 5.        class-   ,   CDS    .    ,    ,  6,  Java,       .       -   ,      runtime- (, slf4j). </p><br></li><li><p> <code>Skipping ... : super class/interface ... is excluded</code> <br>   ,  ‚Äú‚Äù     .          CDS',    .  Por exemplo: </p><br><pre> <code class="plaintext hljs">[warning][cds] Pre JDK 6 class not supported by CDS: 49.0 org/slf4j/spi/MDCAdapter [warning][cds] Skipping ch/qos/logback/classic/util/LogbackMDCAdapter: interface org/slf4j/spi/MDCAdapter is excluded</code> </pre><br></li></ul><br><p>  <strong>Conclus√£o</strong> </p><br><blockquote>  CDS       100%. </blockquote><p> ,     ,  ,         ,  ,     .      . </p><br><h3 id="mnozhestvennyy-eksperiment">   </h3><br><p>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JEP-310</a> , AppCDS                         JDK.   .       ,     .    CDS (, ,     )       . </p><br><div class="spoiler"> <b class="spoiler_title"> </b> <div class="spoiler_text"><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para clonar o coelho experimental (execute o AnaLog em v√°rias inst√¢ncias), precisamos alterar algo nas configura√ß√µes; </font><font style="vertical-align: inherit;">isso permitir√° que os processos levantados n√£o "cotovelem". </font><font style="vertical-align: inherit;">Gra√ßas ao Spring Boot, voc√™ pode fazer isso sem editar ou copiar nenhum arquivo; </font><font style="vertical-align: inherit;">quaisquer configura√ß√µes podem ser substitu√≠das pelas op√ß√µes da JVM. </font><font style="vertical-align: inherit;">O encaminhamento dessas op√ß√µes a partir de uma vari√°vel de ambiente </font></font><code>ANALOG_OPTS</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fornece um script de inicializa√ß√£o, gentilmente gerado por Gradle.</font></font></p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"-Djavamelody.enabled=false -Dlogging.config=classpath:logging/logback-console.xml"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ANALOG_OPTS</span></span></span><span class="hljs-string"> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span></span></code> </pre><br><p>      JavaMelody,             ,        ,       .     TCP-    ;       . </p><br><p>  ,    ,   JVM      AppCDS    .         <code>JAVA_OPTS</code>    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JVM Unified Logging Framework</a> : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"-Xlog:class+load=info:file=log/class-load-%p.log -Xlog:class+path=debug:file=log/class-path-%p.log"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$JAVA_OPTS</span></span></span><span class="hljs-string"> -XX:SharedArchiveFile=work/classes.jsa"</span></span></code> </pre><br><p>        <code>%p</code> ,    JVM      (PID).   AppCDS  ,     (         ). </p></div></div><br><h4 id="osnovnoy-opyt-1">   </h4><br><p>  ,          .                  .     : </p><br><ol><li><p>      <code>server.port</code>  <code>nodes.this.agentPort</code> ,      : </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">export</span></span> ANALOG_OPTS=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$ANALOG_OPTS</span></span></span><span class="hljs-string"> -Dnodes.this.agentPort=7801 -Dserver.port=8091"</span></span></code> </pre><br><p> ,       (    ). </p><br></li><li><p>    <code>bin/analog</code> </p><br><p> <em>()</em>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://localhost:8091</a>  ,     </p><br></li><li><p>  PID  (  ), : </p><br><pre> <code class="bash hljs">pgrep -f analog 13792</code> </pre><br></li><li><p>      <code>pmap</code> (    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a> ): </p><br><pre> <code class="bash hljs">pmap -XX 13792 | sed -n -e <span class="hljs-string"><span class="hljs-string">'2p;$p'</span></span> Address Perm Offset Device Inode Size KernelPageSize MMUPageSize Rss Pss Shared_Clean Shared_Dirty Private_Clean Private_Dirty Referenced Anonymous LazyFree AnonHugePages ShmemPmdMapped Shared_Hugetlb Private_Hugetlb Swap SwapPss Locked ProtectionKey VmFlagsMapping 3186952 1548 1548 328132 325183 3256 0 10848 314028 212620 314024 0 0 0 0 0 0 0 325183 0 KB</code> </pre><br><p>           ;   . </p><br></li><li><p>   1-4     (,  ). </p><br></li></ol><br><h4 id="analiz-rezultatov-1">   </h4><br><p>    <code>pmap</code>             .        CDS'    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">   </a> .    ,  ,        PSS: </p><br><blockquote> The "proportional set size" (PSS) of a process is the count of pages it has in memory, where each page is divided by the number of processes sharing it. So if a process has 1000 pages all to itself, and 1000 shared with one other process, its PSS will be 1500. </blockquote><p>  ,   ,  ‚Äú ‚Äù .        ,      . </p><br><p>    PSS       ,    : </p><br><div class="scrollable-table"><table><thead><tr><th> Iteration: </th><th>  1 </th><th>  2 </th><th>  3 </th><th>  4 </th><th>  5 </th></tr></thead><tbody><tr><td> PSS of inst#1: </td><td> 339 088 </td><td> 313 778 </td><td> 305 517 </td><td> 301 153 </td><td> 298 604 </td></tr><tr><td> PSS of inst#2: </td><td></td><td> 314 904 </td><td> 306 567 </td><td> 302 555 </td><td> 299 919 </td></tr><tr><td> PSS of inst#3: </td><td></td><td></td><td> 314 914 </td><td> 311 008 </td><td> 308 691 </td></tr><tr><td> PSS of inst#4: </td><td></td><td></td><td></td><td> 306 563 </td><td> 304 495 </td></tr><tr><td> PSS of inst#5: </td><td></td><td></td><td></td><td></td><td> 294 686 </td></tr><tr><td> <em>Average:</em> </td><td> 339 088 </td><td> 314 341 </td><td> 308 999 </td><td> 305 320 </td><td> 301 279 </td></tr></tbody></table></div><br><p>         ,      - : </p><br><ul><li>        ‚Äú‚Äù  </li><li>     , PSS   </li><li>  ‚Äú‚Äù ,     PSS      </li></ul><br><p>    ,      .         AppCDS.        ,       <code>-XX:SharedArchiveFile=work/classes.jsa</code>   <code>-Xshare:off</code> ,    CDS .              ,    . </p><br><p><img src="https://habrastorage.org/webt/vq/4s/n6/vq4sn66zppmcyl5aovqj6xpkwyq.png"></p><br><p>       : </p><br><ul><li><p>  PSS  AppCDS      CDS. <br>          <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a> .  ,  ,    HelloWorld- JVM   CDS   2   ,   CDS.      PSS            CDS,     .        : </p><br></li><li><p>    PSS   AppCDS    2-  ; 3-      . <br>        ,      ,    ,     .  ,        AppCDS,   ,   ,      3-    . <br>  :    ,    CDS?      : </p><br></li><li><p>    CDS/AppCDS  JVM      ,  PSS       .  ,    ,      <code>pmap</code> ,   ‚Äú‚Äù   <code>sed</code> '.              : </p><br><pre> <code class="bash hljs">pmap -X `pgrep -f analog` 14981: <span class="hljs-comment"><span class="hljs-comment"># ... Address Perm Offset Device Inode Size Rss Pss ... Mapping # ... ... 7faf5e31a000 r-xp 00000000 08:03 269427 17944 14200 14200 ... libjvm.so # ... ... 7faf5f7f9000 r-xp 00000000 08:03 1447189 1948 1756 25 ... libc-2.27.so</span></span></code> </pre><br><p>       ( <code>Mapping</code> )  , ‚Äú‚Äù      .       JVM  ( <code>libjvm.so</code>   ),     ( <code>libc-2.27.so</code>  ).    <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="></a>        : </p><br><blockquote> For the Java VM, the read-only parts of the loaded shared libraries (ie <code>libjvm.so</code> ) can be shared between all the VM instances running at the same time. This explains why, taking together, the two VM's consume less memory (ie have a smaller memory footprint) than the simple sum of their single resident set sizes when running alone. </blockquote><br></li></ul><br><p>           .     ,  , .  ,          ,         JVM     ,    Java-    .       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">  </a>  GeekOut: </p><br><p><img src="https://habrastorage.org/webt/wp/ia/qo/wpiaqom-2teiw_iegjacskkt3sm.png"></p><br><p> , , ,      AppCDS    , ..     Java-.   ,             JVM,  , -      . </p><br><p>       VisualVM      Metaspace    AppCDS  ,      : </p><br><p> <strong> AppCDS</strong> </p><br><p><img src="https://habrastorage.org/webt/pt/wv/6r/ptwv6rmyk8j7f7yzgxrjkqrsvww.png"></p><br><p> <strong> AppCDS</strong> </p><br><p><img src="https://habrastorage.org/webt/dt/jn/0m/dtjn0mdpcgykbfynjbwdma2vmqm.png"></p><br><p>   ,         128     Metaspace   AppCDS    <code>64.2 MiB / 8.96 MiB</code> <strong>‚âà7,2  </strong> ,   CDS .            (.  )       <code>66.4 MiB / 13.9 MiB</code> <strong>‚âà4,8 </strong> .      ,    AppCDS      ,       Metaspace.            Metaspace,    ,    CDS . </p><br><h2 id="vmesto-zaklyucheniya">  Em vez de uma conclus√£o </h2><br><p>            Spring Boot  AppCDS ‚Äì  JVM,        . </p><br><ul><li>            JEP-350 Dynamic CDS Archives ‚Äì    JDK 13. </li><li>    Spring Boot  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√≥</a>          CDS (  ). ,           100%   -   <strong>66%</strong> .      ,      <strong>‚âà11%</strong> (    15%,      ). </li><li>     ,       5-     PSS (      ).  ,  AppCDS     ,   <strong>  </strong>           , <strong> 8%</strong> (PSS).       ,    CDS,     ,     .        AppCDS  <strong> </strong> . </li><li>          Metaspace,  ,         AppCDS  <strong> 5  </strong> ,   CDS. </li></ul><br><p> ,    , AppCDS,  ,    ‚Äúkiller feature‚Äù.           Spring Boot.   ,   ,    AppCDS      .  , ,        AppCDS   <em></em>   Spring Boot.              ,      ‚Ä¶ </p><br><p> <em>  by <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nick Fewings</a> on <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Unsplash</a></em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472638/">https://habr.com/ru/post/pt472638/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472620/index.html">Museum DataArt. Inspe√ß√£o do terminal de v√≠deo Mera CM 7209</a></li>
<li><a href="../pt472622/index.html">Plano de nivelamento para a profiss√£o Data Engineer</a></li>
<li><a href="../pt472626/index.html">An√°lise da placa-m√£e ASRock Z390 Phantom Gaming 7: prepara√ß√£o para 9900KS</a></li>
<li><a href="../pt472628/index.html">Codifica√ß√µes, shift cipher, hashes brutos e cria√ß√£o de imagens usando python PIL. Solu√ß√£o de problemas com o r0ot-mi Cryto. Parte 1</a></li>
<li><a href="../pt472636/index.html">Vis√£o geral do programa DotNext 2019 em Moscou: quem lhe dir√° o qu√™?</a></li>
<li><a href="../pt472640/index.html">O que aprendi em 6 anos ajudando startups a crescer</a></li>
<li><a href="../pt472642/index.html">Webdev freelance - como e com quem voc√™ N√ÉO deve trabalhar</a></li>
<li><a href="../pt472644/index.html">Est√°gios em empresas internacionais: como n√£o preencher a entrevista e receber a cobi√ßada oferta</a></li>
<li><a href="../pt472650/index.html">Medo, dor e √≥dio ao suporte t√©cnico</a></li>
<li><a href="../pt472658/index.html">Quase tudo sobre o futuro HolyJS 2019 Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>