<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë©‚Äçüëß‚Äçüëß üëãüèæ üêê Funciones de renderizado en Metro: trazado de rayos Exodus c üë©üèª‚Äçüé§ üö± ü•Ä</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√≥logo 
 Despu√©s del lanzamiento del √∫ltimo juego de la serie Metro, pas√© varias horas estudiando su trabajo interno y decid√≠ compartir algo que podr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Funciones de renderizado en Metro: trazado de rayos Exodus c</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447194/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b6c/122/9f2/b6c1229f21aaaefc416b180a41759690.jpg" alt="imagen"></div><br><h3>  Pr√≥logo </h3><br>  Despu√©s del lanzamiento del √∫ltimo juego de la serie Metro, pas√© varias horas estudiando su trabajo interno y decid√≠ compartir algo que podr√≠a parecer interesante desde un punto de vista tecnol√≥gico.  No realizar√© un an√°lisis detallado ni estudiar√© el c√≥digo desarmado de los sombreadores, pero mostrar√© las decisiones de alto nivel tomadas por los desarrolladores en el proceso de creaci√≥n del juego. <br><br>  Por el momento, los desarrolladores a√∫n no han hablado sobre las t√©cnicas de renderizado utilizadas en el juego.  La √∫nica fuente oficial de informaci√≥n es el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noreferrer noopener">informe de GDC</a> , que no se puede encontrar en ning√∫n otro lugar en Internet.  Y esto es molesto, porque el juego se ejecuta en un motor propietario muy interesante que ha evolucionado desde juegos anteriores en la serie Metro.  Este es uno de los primeros juegos en usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">DXR</a> . <br><br>  Nota: este art√≠culo no es una descripci√≥n completa y volver√© sobre √©l si encuentro algo que valga la pena agregar.  Quiz√°s me perd√≠ algo, porque algunos aspectos aparecen solo en las siguientes etapas del juego, o simplemente mir√© los detalles. <br><br><h3>  Primeros pasos </h3><br>  Me llev√≥ varios d√≠as encontrar un entorno capaz de trabajar con este juego.  Despu√©s de probar varias versiones de RenderDoc y PIX, decid√≠ estudiar los resultados del trazado de rayos con Nvidia NSight.  Quer√≠a aprender renderizado sin trazado de rayos, pero NSight me permiti√≥ explorar tambi√©n los detalles de esta funci√≥n, as√≠ que decid√≠ dejarla activada.  Para el resto de la representaci√≥n, PIX es un buen ajuste.  Se tomaron capturas de pantalla usando ambas aplicaciones. <br><a name="habracut"></a><br>  NSight tiene un inconveniente: no admite guardar la captura en un archivo, por lo que no pude volver a los cuadros que estaba estudiando. <br><br>  Al comienzo de mi trabajo, tambi√©n me encontr√© con otro problema que no ten√≠a nada que ver con las aplicaciones de depuraci√≥n de marcos: las funciones de trazado de rayos requer√≠an instalar la √∫ltima actualizaci√≥n de Windows, pero el juego permiti√≥ que se incluyeran en las opciones sin instalar la actualizaci√≥n.  En este caso, la inclusi√≥n de funciones hizo que el juego se bloqueara al inicio.  La Experiencia GeForce tampoco dijo nada sobre la necesidad de la versi√≥n correcta de Windows para habilitar estas funciones.  Este problema debe abordarse en ambos lados. <br><br>  En aras de la exhaustividad, hice capturas de un juego que se ejecuta con los par√°metros m√°ximos posibles, pero sin DLSS. <br><br><h3>  An√°lisis de trama </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/541/f12/e34/541f12e34559d73faa7eb743915e5cdd.png"></div><br>  <i>Marco terminado</i> <br><br>  Un breve an√°lisis de la representaci√≥n demuestra un conjunto bastante est√°ndar de funciones, con la excepci√≥n de la iluminaci√≥n global realizada por el trazado de rayos (GI trazado de rayos). <br><br>  Antes de renderizar la imagen, la escala del cuadro anterior se reduce en la cola de c√°lculo y se calcula el brillo promedio. <br><br>  La cola gr√°fica comienza con la representaci√≥n de part√≠culas de distorsi√≥n (gotas en la c√°mara), que se aplican en la etapa de postprocesamiento.  Luego, un r√°pido paso preliminar de las profundidades crea una parte de las profundidades frente al Gbuffer;  parece que solo representa un alivio. <br><br>  El pase GBuffer llena 4 objetivos de renderizado de acuerdo con el siguiente diagrama, y ‚Äã‚Äãtambi√©n completa el llenado de la memoria intermedia de profundidad. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a67/9ef/332/a679ef3320584af81cc4d3c6970fecd1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/97b/c7d/d77/97bc7dd7753e655aec4a8279851e78be.png"></div><br>  <i>1. Objetivo en formato RGBA8 con albedo y, posiblemente, oclusi√≥n ambiental en el canal alfa;</i>  <i>En algunas superficies se ve muy oscuro.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ff/a5f/972/8ffa5f972989ecb5104c92cf1e56ddc0.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/580/93a/6e158093ac061f9c993fc5d954d3a383.png"></div><br>  <i>2. Objetivo en formato RGB10A2 con normales y, posiblemente, una m√°scara de dispersi√≥n subsuperficial en el canal alfa.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aed/cab/600/aedcab600ed86cab9d6fff32d005365b.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9e/7e8/64e/d9e7e864ecc5794d64a9f0923153f673.png"></div><br>  <i>3. Objetivo en formato RGBA8 con otros par√°metros de material, probablemente metalidad y rugosidad en el canal alfa.</i>  <i>Curiosamente, los canales RGB en este caso contienen exactamente los mismos datos.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ae/aaf/aa7/2aeaafaa75ea48daa6c9671ef02024e4.png"></div><br>  <i>4. Objetivo en formato RG16F con vectores de movimiento 2D.</i> <br><br>  Una vez que las profundidades est√°n completamente llenas, se construye un buffer de profundidad lineal y su escala disminuye.  Todo esto se hace en la cola de c√≥mputo.  En la misma cola, el b√∫fer se llena con algo similar a la iluminaci√≥n direccional sin usar sombras. <br><br>  En la cola de gr√°ficos, la GPU traza los rayos de iluminaci√≥n global, pero hablar√© m√°s sobre esto a continuaci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/205/368/6b1/2053686b1cb719229dc0ccce1540e5c1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/879/607/0ab/8796070abae27e9695fb82d6f5789375.png"></div><br>  La cola de c√≥mputo calcula la oclusi√≥n ambiental, los reflejos y algo similar al reconocimiento de bordes. <br><br>  En la cola gr√°fica, se representa un mapa de sombra de cuatro etapas en un mapa de profundidad de 32 bits de tama√±o 6k * 6k.  M√°s sobre esto a continuaci√≥n.  Despu√©s de completar el mapa de sombras dirigidas, la resoluci√≥n de la tercera cascada por razones desconocidas disminuye a 768 * 768. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a85/203/3e2/a852033e230487f7be913e94ee87a7fa.png"></div><br>  En medio del proceso de representaci√≥n de sombras, hay un momento curioso: el atlas de impostores se complementa con algunos objetos antes de generar sombras locales a partir de la iluminaci√≥n (sobre qu√© impostores se pueden encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ).  Tanto los buffers impostores como los buffers de sombra de iluminaci√≥n local tambi√©n tienen texturas de 6k * 6k. <br><br>  Despu√©s de completar todas las sombras, comienza el c√°lculo de la iluminaci√≥n.  Esta parte de la representaci√≥n es bastante incomprensible, porque hay muchas representaciones que realizan algunas acciones misteriosas y, por lo tanto, requieren un estudio adicional. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e07/838/016/e078380165142b63cce7e340155e4aef.png"></div><br>  La representaci√≥n de la escena finaliza con objetos iluminados frontalmente (ojos, part√≠culas).  Los efectos visuales se procesan en un b√∫fer de media resoluci√≥n, despu√©s de lo cual se componen con objetos opacos utilizando el zoom. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d95/88c/66e/d9588c66ecb2dbd09b0386fc481771c1.png"></div><br>  La imagen final se logra mediante la correcci√≥n tonal y el c√°lculo de la floraci√≥n (disminuye y luego aumenta la resoluci√≥n del cuadro con la correcci√≥n tonal).  Finalmente, la interfaz de usuario se representa en un b√∫fer separado y, junto con la composici√≥n de floraci√≥n, se superpone en la parte superior de la escena. <br><br>  No encontr√© la parte en la que se realiza el suavizado, as√≠ que lo dejar√© para m√°s adelante. <br><br><h3>  Rastreo global de rayos de luz </h3><br>  Alguna informaci√≥n sobre la iluminaci√≥n global realizada por GI con trazado de rayos.  Esta estructura acelerada cubre una gran √°rea del mundo del juego, probablemente varios cientos de metros, mientras que mantiene detalles muy altos en todas partes.  Parece que se est√° transmitiendo de alguna manera.  La escena de la estructura de aceleraci√≥n no coincide con la escena rasterizada, por ejemplo, los edificios en la imagen a continuaci√≥n no son visibles en la forma rasterizada. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e98/f99/6d9/e98f996d9c2ad589d81fb6c5abac1208.png"></div><br>  <i>Vista superior</i> <br><br>  Aqu√≠ podemos ver cuatro fichas que rodean la posici√≥n del jugador.  Tambi√©n es evidente la falta de geometr√≠a que se est√° probando en el canal alfa.  Los √°rboles tienen troncos, pero no hay follaje, ni hierba, ni arbustos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/500/53a/089/50053a0898f262725ade46d2b5dadb88.png"></div><br>  <i>Vista cercana</i> <br><br>  En la vista de primer plano, se ven mejor los detalles y la densidad de los objetos.  Cada objeto de un color diferente tiene su propia estructura aceleradora del nivel inferior.  Solo en esta imagen hay varios cientos de ellos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83e/5e8/dff/83e5e8dfff1709a0d38b1f4c5d012282.png"></div><br>  <i>Art√≠culos del jugador bajo los pies</i> <br><br>  Curiosamente, los art√≠culos del jugador tambi√©n son parte de la estructura de aceleraci√≥n, pero por alguna raz√≥n se encuentran debajo de sus pies. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/969/c2b/203/969c2b203e8abecbd7718e061db99984.png"></div><br>  <i>Rotura de la piel?</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/366/620/78d/36662078d0930dfb66fb3bf1d928f022.png"></div><br>  <i>¬øDesollado de nuevo?</i> <br><br>  Algunos de los objetos con aspecto desollado se ven rotos en la estructura de aceleraci√≥n.  Uno de los problemas observados es estirar la malla (en las piernas del ni√±o).  Otro problema lleva al hecho de que diferentes partes del personaje con desuello est√°n en diferentes posiciones.  No hay estiramiento, pero las partes est√°n separadas entre s√≠.  Parece que nada de esto es visible en la iluminaci√≥n global de trazado de rayos, o al menos no he podido notar esto en el juego. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/647/c7c/c2b/647c7cc2beab467af7223ed97f80fa08.png"></div><br>  <i>Una gran cantidad de objetos</i> <br><br>  En un plano m√°s general, puede ver cu√°ntos objetos diferentes hay en la estructura de aceleraci√≥n.  La mayor√≠a de ellos no contribuir√° realmente a los resultados de los c√°lculos de la iluminaci√≥n global.  Tambi√©n se ve aqu√≠ que no hay un esquema LOD.  Todos los objetos se agregan con todo detalle.  Ser√≠a interesante saber si esto tiene alg√∫n efecto sobre el trazado de rayos (supongo que s√≠). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/11b/0ec/64f11b0ec3d0882a84503875c5a1cb20.png"></div><br>  <i>LOD ultra alto, cada escala y conmutador totalmente modelados</i> <br><br>  Otra captura de pantalla muestra un gran detalle de objetos incluso lejos del jugador.  Cada interruptor y cada escala en esta imagen son claramente legibles incluso sin texturas.  El lugar donde mov√≠ la c√°mara para tomar esta captura de pantalla se encuentra a decenas de metros del reproductor y eliminar estos detalles no habr√≠a empeorado la calidad de la imagen.  Quiz√°s actualizar la estructura de aceleraci√≥n usando LOD ser√≠a demasiado costoso, pero existe una alta probabilidad de que esta actualizaci√≥n se pueda realizar de forma asincr√≥nica.  Definitivamente vale la pena explorar este punto con m√°s detalle. <br><br><h3>  Renderizado de sombras direccionales </h3><br>  La parte principal de renderizar sombras es simple y no requiere menci√≥n especial, pero aqu√≠ hay puntos interesantes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/016/0ea/d160160ea9d4dc571c97440f77d103a0.png"></div><br>  <i>Mallas para las cuales es improbable la proyecci√≥n de sombras</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/369/857/cb1/369857cb17bf6baeaae52295930b4ac5.png"></div><br>  <i>Enormes detalles en mapas de sombras</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e0/708/9ba/0e07089ba7b63f9c055a95a8ed783f09.png"></div><br>  <i>Mallas que parecen usar el b√∫fer de √≠ndice incorrecto</i> <br><br>  Parece que, como las estructuras de aceleraci√≥n, el renderizado de sombras incluye absolutamente todo.  Hay objetos que casi no contribuyen al mapa de sombras, pero a√∫n as√≠ se representan.  Me pregunto si esto sucede debido a un permiso, o ¬øno hay una manera f√°cil en el motor de excluirlos? <br><br>  Hay objetos que son dif√≠ciles de notar incluso con sombras en el espacio de la pantalla.  No toma mucho tiempo renderizarlos, pero ser√≠a interesante ver si pueden eliminarse para ahorrar un poco de tiempo. <br><br>  Al estudiar la malla, parece que algunas de las mallas renderizadas en el mapa de sombras tienen b√∫feres de √≠ndice rotos, pero despu√©s del sombreador de v√©rtices se ven correctos (los resultados son los mismos en PIX y NSight).  Este es el mejor ejemplo que logr√© encontrar, pero est√° lejos de ser el √∫nico.  ¬øTal vez esta es una especie de posici√≥n de empaque especial? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/079/80b/5d907980beab8411086ae95a3cd1069e.png"></div><br>  <i>Las mallas parecen tener poca piel</i> <br><br>  El desollado parece estar causando problemas no solo en las estructuras de aceleraci√≥n.  Curiosamente, no conduce a artefactos visibles en la pantalla. <br><br><h2>  Parte 2 </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png" alt="imagen"></div><br><h3>  Enmienda menor </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/177/37b/efe17737bab902e3b3d1e4ae2a29edbf.png"></div><br>  En la parte anterior, escrib√≠ que el tercer objetivo de renderizado del b√∫fer GBuffer probablemente contenga metalidad, pero parece que en realidad contiene color especular.  Al principio no vi ning√∫n color y no entend√≠ por qu√© los tres canales RGB contienen los mismos datos, pero probablemente fue porque no hab√≠a reflejos de color en la escena.  Para esta arma, el b√∫fer contiene muchos m√°s colores diferentes. <br><br>  Tambi√©n se me olvid√≥ agregar mi textura favorita, que encontr√© en el proceso de investigaci√≥n de la representaci√≥n del juego.  Definitivamente vale la pena mencionarlo porque demuestra la naturaleza ca√≥tica del desarrollo del juego cuando no siempre es posible limpiarlo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bb/5b4/288/7bb5b428878a0be20dbe80d599256d80.png"></div><br>  <i>"¬°Mejorame!"</i> <br><br><h3>  Composici√≥n de transparencia y anti-aliasing </h3><br>  Intentando descubrir c√≥mo aumenta la resoluci√≥n del b√∫fer de transparencia de tama√±o medio y c√≥mo el juego realiza antialiasing, not√© algo interesante.  Necesitaba una escena donde hubiera mucho m√°s contraste para que fuera claramente visible lo que estaba sucediendo.  Afortunadamente, logr√© capturar un cuadro en el que el arma del jugador se mueve ligeramente entre cuadros. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0c/974/612/a0c9746122e45a19786bdf51521015a9.png"></div><br>  <i>Antes de renderizar transparencia</i> <br><br>  Parece que antes de componer el b√∫fer de transparencia, el b√∫fer ya contiene una imagen completamente renderizada, y dado que no hay bordes afilados en este marco, es l√≥gico suponer que estos son los datos del marco anterior. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c56/bd5/b89/c56bd5b8938a315f97def63dc7b8b214.png"></div><br>  <i>Despu√©s de componer la transparencia del marco actual</i> <br><br>  Al agregar transparencia al marco actual, podemos notar bordes rotos individuales.  Sucedi√≥ porque el arma se movi√≥ ligeramente a la derecha.  Algunas nubes se vuelven transparentes, pero se recortan en el horizonte (que es opaco), por lo que la composici√≥n no cambia la parte inferior, sino que ya se representa sobre la malla del arma del cuadro anterior utilizando el b√∫fer de profundidad del cuadro actual. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/7a1/e93/64f7a1e9340dfe180e4807cf7c4da5be.png"></div><br>  <i>Despu√©s de agregar opacidad al marco actual</i> <br><br>  Despu√©s de varias llamadas de sorteo, se realizan mallas de composici√≥n y opacas.  Parece que no hay ninguna raz√≥n particular para hacer esto en este orden.  Es l√≥gico componer el b√∫fer de transparencia en los datos de los objetos opacos del marco actual, pero esto no sucede, y ser√≠a interesante saber por qu√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/963/bce/f23/963bcef23544573444acf29bf7a83a87.png"></div><br>  <i>Despu√©s de TAA</i> <br><br>  Despu√©s de completar el fotograma completo, el paso TAA (suavizado temporal) suaviza los bordes.  Ya estaba interesado en esto antes, porque no ve√≠a d√≥nde tiene lugar el alisado.  Pero me salte√© esto porque inmediatamente despu√©s de esta llamada de sorteo comienza la disminuci√≥n de resoluci√≥n para el pase de floraci√≥n y pierdo esta llamada de sorteo. <br><br><h3>  Destello de lente </h3><br>  Por lo general, no quiero analizar los efectos individuales, pero hay muchas formas de implementar el destello de la lente, por lo que ten√≠a curiosidad sobre qu√© desarrolladores eligieron. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png"></div><br>  <i>Destello de lente en composici√≥n preparada</i> <br><br>  En la mayor√≠a de los casos, el destello de la lente apenas se nota, pero este es un efecto hermoso.  Es dif√≠cil de mostrar en la captura de pantalla, por lo que no pondr√© mucho esfuerzo en esto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a32/554/efc/a32554efc67afb79416b6ce2fe337148.png"></div><br>  <i>Destello de lente en buffer de floraci√≥n</i> <br><br>  Despu√©s de buscar, encontr√© una llamada de sorteo que agrega este efecto, y result√≥ que era una llamada despu√©s de la √∫ltima etapa de elevar la resoluci√≥n de floraci√≥n.  En este b√∫fer, el efecto es mucho m√°s notable. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a3/f38/078/8a3f38078dc5d6c6451030ee3eb5c53b.png"></div><br>  <i>Destello de lente de geometr√≠a</i> <br><br>  Si nos fijamos en la geometr√≠a, el destello de la lente es bastante simple.  Al menos 6 cuadr√°ngulos est√°n involucrados en la creaci√≥n del resultado final en la pantalla, pero no hay una serie de cuadr√°ngulos m√°s peque√±os que se acerquen a la posici√≥n del sol.  Podemos concluir que esta es una soluci√≥n bastante est√°ndar, aunque algunos desarrolladores procesan el destello de la lente directamente en la escena del renderizado, mientras que otros calculan el efecto como postprocesamiento. <br><br><h3>  Representaci√≥n del terreno </h3><br>  En todos los juegos de mundo abierto, una de las dificultades m√°s interesantes es renderizar terreno.  Decid√≠ que podr√≠a parecer interesante estudiar este aspecto, pero, francamente, un poco decepcionado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/125/7a6/89b/1257a689b93f0f7a0239b5514ce911af.png"></div><br>  A primera vista, un fragmento del relieve parece que se est√° realizando alg√∫n tipo de teselaci√≥n.  La forma en que se deforma el relieve durante el movimiento hace que sea l√≥gico suponer que existe un desplazamiento adicional.  Adem√°s, en una PC, el juego usa activamente teselaci√≥n, por lo que ser√≠a l√≥gico usarlo en relieve. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99d/214/a4d/99d214a4dc8c15862b7e385edda0c25e.png"></div><br>  Tal vez ten√≠a los par√°metros incorrectos establecidos, pero el juego muestra todos los fragmentos del relieve sin teselaci√≥n.  Para cada fragmento del relieve, ella usa esta cuadr√≠cula uniforme de 32 * 32.  Tampoco hay LOD. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/744/aa8/4bc/744aa84bce83c87e8c2a49338f7c8c13.png"></div><br>  Al observar un fragmento del relieve despu√©s del sombreador de v√©rtices, puede ver que la mayor√≠a de los pares de v√©rtices se fusionaron para formar una cuadr√≠cula casi perfecta de 16 * 16, con la excepci√≥n de algunos lugares que requieren m√°s precisi√≥n (probablemente debido a la curvatura del relieve).  La deformaci√≥n mencionada anteriormente probablemente surge debido a la lectura de las texturas mip del mapa de elevaci√≥n del relieve cuando el relieve est√° lejos de la c√°mara. <br><br><h3>  Trucos de seguimiento de rayos </h3><br>  Y ahora sobre lo que todos esperaban. <br><br><h4>  Streaming de datos </h4><br>  Uno de los aspectos m√°s interesantes de cualquier implementaci√≥n de DXR en este momento es la forma en que trabaja con los datos.  Lo m√°s importante es c√≥mo se cargan los datos en las estructuras de aceleraci√≥n y c√≥mo se actualizan.  Para probar esto, tom√© dos capturas y compar√© las estructuras de aceleraci√≥n en NSight. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3fc/7b7/0d2/3fc7b70d22199c5be429417fd6ed92a9.png"></div><br>  <i>El jugador est√° dentro de la nave.</i> <br><br>  En la primera captura, me par√© dentro de una nave rota, que es visible en el centro de esta imagen.  Solo se cargan los objetos m√°s cercanos, excepto las rocas grandes en el borde del mapa. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc4/e41/2fa/dc4e412fa02b74f7ca4384a53e1b8100.png"></div><br>  <i>El jugador se ha movido a la esquina superior izquierda de esta imagen.</i> <br><br>  En la segunda captura, me alej√© del borde del mapa y me acerqu√© al borde superior izquierdo de la imagen.  La nave y todo lo que la rodea todav√≠a est√° cargada, pero tambi√©n se han cargado nuevos objetos.  Curiosamente, no puedo definir ninguna estructura de mosaico.  Los objetos se pueden cargar / eliminar de la estructura de aceleraci√≥n en funci√≥n de la distancia y la visibilidad (¬øposiblemente limitando el paralelogramo?).  Adem√°s, el borde superior derecho se ve m√°s detallado, aunque se ha alejado de √©l.  Ser√≠a interesante saber m√°s sobre esto. <br><br><h4>  Alivio y lo que hay debajo </h4><br>  Se pueden mencionar varios aspectos de la implementaci√≥n de DXR en Metro: Exodus con respecto al terreno. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e97/386/8bf/e973868bf7b0bd40cfc58c0d94678acf.png"></div><br>  En primer lugar, es interesante que las estructuras de aceleraci√≥n no contengan ninguna malla de alivio (con la excepci√≥n de casos especiales).  Estos monstruos realmente corren en el juego en el suelo, pero a juzgar por los datos en NSight, podr√≠as pensar que est√°n volando.  Esto plantea una pregunta interesante para nosotros: ¬øla implementaci√≥n de la iluminaci√≥n global puede tener en cuenta el terreno (posiblemente usando un mapa de altura y material de relieve) o no? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7a/03e/860/a7a03e8601a37c6459eff55cc7dda39f.png"></div><br>  Al momento siguiente, nunca me habr√≠a dado cuenta si el alivio estuviera en su lugar.  Al observar el comienzo del nivel en la estructura acelerada en NSight, not√© algunas mallas debajo del relieve. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/458/b77/ec3/458b77ec37a3db2b1d8ca0b3f1694dd8.png"></div><br>  Los artistas a menudo, por varias razones, colocan mallas de depuraci√≥n debajo del nivel, pero generalmente se eliminan antes de que se lance el juego.  En este caso, estas mallas no solo sobrevivieron hasta el lanzamiento, sino que tambi√©n se convirtieron en parte de la estructura de aceleraci√≥n. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/27d/64a/15d/27d64a15df609c55b8742d77637fca22.png"></div><br>  Adem√°s de los mencionados anteriormente, encontr√© otras mallas dispersas debajo del relieve.  B√°sicamente, no merecen mucha menci√≥n, pero este fue muy interesante: este es un personaje que se encuentra justo debajo del punto de partida del nivel.  Incluso tiene su propia piscina. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/53f/5dd/66c/53f5dd66c2b959793151e3a59d1309a5.png"></div><br>  Finalmente, el √∫ltimo elemento curioso de la estructura de aceleraci√≥n son las mallas unilaterales que miran hacia afuera del nivel.  A menos que se consideren bilaterales, hay muy pocas posibilidades de que hagan alguna contribuci√≥n a la imagen del juego.  Incluso si las mallas son de dos lados, est√°n tan lejos del √°rea jugable que probablemente solo estiren la estructura de aceleraci√≥n.  Es interesante ver que no est√°n filtrados.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esta imagen tambi√©n muestra uno de los casos especiales de la "malla de relieve" en la esquina inferior derecha, entre el tren y el edificio. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Decapitaci√≥n con desuello </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ya habl√© sobre los problemas de desollar mallas, pero a este nivel not√© algo m√°s. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d1/0dd/a8c/1d10dda8c75112713b51c32771bb8ecb.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En primer lugar, este monstruo muestra ambos errores en una imagen, lo cual not√© anteriormente. </font><font style="vertical-align: inherit;">Todav√≠a me pregunto qu√© los caus√≥.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/523/265/dd7/523265dd72a9613800831592706bd510.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Tambi√©n not√© que estas peque√±as criaturas, como los murci√©lagos, no tienen cabezas en la estructura acelerada. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fd/1a9/801/6fd1a9801d440a719602ab30eb33a88e.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otro ejemplo. </font><font style="vertical-align: inherit;">Observe el agujero donde deber√≠a estar la cabeza. </font><font style="vertical-align: inherit;">No he visto un solo caso donde la cabeza fuera visible.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e7f/51e/741/e7f51e74194bf8cccf8e430e6ec8513d.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El mismo tipo de criaturas en modo rasterizaci√≥n. </font><font style="vertical-align: inherit;">Tenga en cuenta que la cabeza es claramente visible.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebd/d67/2ea/ebdd672ea50f7717c4b66afeb20b4cf8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y aqu√≠ est√° la estructura met√°lica de la cabeza. </font></font><br><br><h3>  En conclusi√≥n </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eso es todo por hoy. </font><font style="vertical-align: inherit;">Espero que hayas disfrutado este vistazo al interior de Metro: Exodus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Continuar√© explorando la representaci√≥n del juego, pero no publicar√© nuevas partes del art√≠culo a menos que encuentre algunas partes especiales que sean interesantes para las personas, o encuentre algo que valga la pena compartir.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447194/">https://habr.com/ru/post/447194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447182/index.html">Sistemas operativos: tres piezas f√°ciles. Parte 3: API de proceso (traducci√≥n)</a></li>
<li><a href="../447184/index.html">¬øQu√© es la Oferta de intercambio inicial (IEO) y en qu√© se diferencia de ICO?</a></li>
<li><a href="../447186/index.html">C√≥mo lanzar un prototipo de ML en un d√≠a. Informe Yandex.Taxi</a></li>
<li><a href="../447190/index.html">Predicciones de matem√°ticos. Analizamos los principales m√©todos para detectar anomal√≠as.</a></li>
<li><a href="../447192/index.html">¬øQu√© papel puede jugar la tecnolog√≠a en el antiguo arte de mezclar especias?</a></li>
<li><a href="../447196/index.html">7. Check Point Getting Started R80.20. Control de acceso</a></li>
<li><a href="../447198/index.html">Misi√≥n lunar "Bereshit": aterrizaje-accidente-ca√≠da en la luna</a></li>
<li><a href="../447204/index.html">17 de abril: Conferencia abierta "El camino del desarrollador del juego: desde la idea hasta el lanzamiento" y una biblioteca de juegos en la Escuela Superior de Derecho</a></li>
<li><a href="../447208/index.html">SQA Days Review de la UE</a></li>
<li><a href="../447210/index.html">@Pythonetc compilaci√≥n marzo de 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>