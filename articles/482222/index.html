<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÆ üëø ü§üüèº Aplicaci√≥n web en Kotlin + Spring Boot + Vue.js (complemento) üç¨ üë∏ üìÜ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬°Buenas tardes, queridos habitantes de Habr! 

 Como su nombre lo indica, este art√≠culo es una adici√≥n a la aplicaci√≥n web previamente escrita en Kotl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aplicaci√≥n web en Kotlin + Spring Boot + Vue.js (complemento)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482222/">  ¬°Buenas tardes, queridos habitantes de Habr! <br><br>  Como su nombre lo indica, este art√≠culo es una adici√≥n a la <a href="https://habr.com/ru/post/467161/">aplicaci√≥n web</a> previamente escrita <a href="https://habr.com/ru/post/467161/">en Kotlin + Spring Boot + Vue.js</a> , que nos permite mejorar el esqueleto de una aplicaci√≥n futura y hacer que sea m√°s f√°cil trabajar con ella. <br><a name="habracut"></a><br>  Antes de comenzar la historia, perm√≠tanme agradecer a todos los que comentaron en el art√≠culo anterior. <br><br><h3>  Contenido </h3><br><ul><li>  <a href="https://habr.com/ru/post/482222/">Configuraci√≥n de CI / CD (Heroku)</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Protecci√≥n de bot (reCAPTCHA)</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Env√≠o de correo electr√≥nico</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Gradle Migration</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Almacenar token JWT en cookies</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Confirmaci√≥n de registro por correo electr√≥nico</a> </li><li>  <a href="https://habr.com/ru/post/482222/">Enlaces utiles</a> </li></ul><br><a name="cicd"></a><br><h2>  Configuraci√≥n de CI / CD (Heroku) </h2><br>  Considere la implementaci√≥n de la integraci√≥n continua y la entrega utilizando la plataforma <a href="https://www.heroku.com/" rel="nofollow">Heroku</a> cloud PaaS como ejemplo. <br><br>  Lo primero que debemos hacer es poner el c√≥digo de la aplicaci√≥n en el repositorio en <a href="https://github.com/" rel="nofollow">GitHub</a> .  Para que no haya nada superfluo en el repositorio, recomiendo los siguientes contenidos del archivo <i>.gitignore</i> : <br><br><div class="spoiler">  <b class="spoiler_title">.gitignore</b> <div class="spoiler_text"><pre><code class="plaintext hljs">*.class # Help # backend/*.md # Package Files # *.jar *.war *.ear # Eclipse # .settings .project .classpath .studio target # NetBeans # backend/nbproject/private/ backend/nbbuild/ backend/dist/ backend/nbdist/ backend/.nb-gradle/ backend/build/ # Apple # .DS_Store # Intellij # .idea *.iml *.log # logback logback.out.xml backend/src/main/resources/public/ backend/target backend/.mvn backend/mvnw frontend/dist/ frontend/node/ frontend/node_modules/ frontend/npm-debug.log frontend/target !.mvn/wrapper/maven-wrapper.jar</code> </pre> <br></div></div><br>  <u>Importante:</u> antes de comenzar a trabajar con Heroku, agregue un archivo llamado <i>Procfile</i> (sin ninguna extensi√≥n) al directorio ra√≠z con la l√≠nea: <br>  <code>web: java -Dserver.port=$PORT -jar backend/target/backend-0.0.1-SNAPSHOT.jar</code> , donde <i>backend-0.0.1-SNAPSHOT.jar</i> es el nombre del archivo JAR de <i>ensamblaje</i> .  Y aseg√∫rese de <u>comprometerse y empujar</u> . <br><br>  <u>Nota:</u> tambi√©n puede agregar el archivo travis.yaml al directorio ra√≠z para reducir el tiempo de compilaci√≥n y despliegue de la aplicaci√≥n en Heroku: <br><br><div class="spoiler">  <b class="spoiler_title">travis.yaml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">language: java jdk: - oraclejdk8 script: mvn clean install jacoco:report coveralls:report cache: directories: - node_modules</code> </pre> <br></div></div><br>  Entonces: <br><br>  <b># 1</b> Registrarse en <a href="https://www.heroku.com/" rel="nofollow">Heroku</a> . <br><br>  <b># 2</b> Crea una nueva aplicaci√≥n: <br><br><div class="spoiler">  <b class="spoiler_title">Crea una nueva aplicaci√≥n</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/u3/ml/bx/u3mlbx0w2ho3uezsrl75nyse2m4.png"><br></div></div><br>  <b># 3</b> Heroku le permite conectar recursos adicionales a la aplicaci√≥n, por ejemplo, la base de datos PostreSQL.  Para hacer esto, haga: <i>Aplicaci√≥n -&gt; Recursos -&gt; Complementos -&gt; Heroku Postgres</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Heroku postgres</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/k5/l8/ht/k5l8htgji3kaxmqyznbdqhyeuki.png"><br></div></div><br>  <b># 4</b> Elige un plan: <br><br><div class="spoiler">  <b class="spoiler_title">Selecci√≥n de plan</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/id/jv/vd/idjvvdwyyk9ou_wbes00mxvfdac.png"><br></div></div><br>  <b># 5</b> Ahora puede ver el recurso conectado: <br><br><div class="spoiler">  <b class="spoiler_title">Recurso conectado</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/l2/mx/mf/l2mxmf3itjef2-1lpiwmltrtadq.png"><br></div></div><br>  <b># 6</b> Mire las credenciales, ser√°n necesarias para configurar las variables de entorno: <i>Configuraci√≥n -&gt; Ver credenciales</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Ver credenciales</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gh/xl/v9/ghxlv99r9m2mgrr6ceemgpn-hjg.png"><br></div></div><br>  <b># 7</b> Establecer variables de entorno: <i>Aplicaci√≥n -&gt; Configuraci√≥n -&gt; Revelar valores de configuraci√≥n</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Variables de entorno</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xr/uj/q8/xrujq8lynqi6kqoqtqiklpwbaxu.png"><br></div></div><br>  <b># 8</b> Establezca las variables de entorno para la conexi√≥n en el siguiente formato: <br><br><pre> <code class="plaintext hljs">SPRING_DATASOURCE_URL = jdbc:postgresql://&lt;i&gt;hostname:port&lt;/i&gt;/&lt;i&gt;db_name&lt;/i&gt; SPRING_DATASOURCE_USERNAME = &lt;i&gt;username&lt;/i&gt; SPRING_DATASOURCE_PASSWORD = &lt;i&gt;password&lt;/i&gt;</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Como se ve</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/me/jr/ne/mejrnecja54rgwchq6peumbc6w0.png"><br></div></div><br>  <b># 9</b> Cree todas las tablas necesarias en la nueva base de datos. <br><br>  <b># 10</b> El archivo application.properties, respectivamente, deber√≠a verse as√≠: <br><br><div class="spoiler">  <b class="spoiler_title">application.properties</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">spring.datasource.url=${SPRING_DATASOURCE_URL} spring.datasource.username=${SPRING_DATASOURCE_USERNAME} spring.datasource.password=${SPRING_DATASOURCE_PASSWORD} spring.jpa.generate-ddl=true spring.jpa.properties.hibernate.temp.use_jdbc_metadata_defaults = false spring.jpa.database-platform=org.hibernate.dialect.PostgreSQL9Dialect spring.jpa.properties.hibernate.jdbc.lob.non_contextual_creation=true</code> </pre><br></div></div><br>  <b># 11</b> Crear una <i>nueva tuber√≠a</i> - <i>Crear nueva tuber√≠a</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Crear nueva tuber√≠a</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/dh/sg/wb/dhsgwbhgaz9arzl4lgwkdoykeda.png"><br></div></div><br>  <b># 12</b> M√©todo de implementaci√≥n: <i>GitHub</i> (haga clic en <i>Conectar a GitHub</i> y siga las instrucciones en una nueva ventana). <br><br>  <b># 13</b> <i>Habilitar implementaciones autom√°ticas</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Habilitar implementaciones autom√°ticas</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/8e/fb/ui/8efbuinhnr0y1j7eggqkhbjae2s.png"><br></div></div><br>  <b># 14</b> Implementaci√≥n manual: haga clic en <i>Implementar rama</i> para la primera implementaci√≥n.  Directamente en el navegador ver√° la salida de la l√≠nea de comandos. <br><br><div class="spoiler">  <b class="spoiler_title">Despliegue manual</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/7i/5m/tz/7i5mtzam___vhonxjbtuogrg-ay.png"><br></div></div><br>  <b># 15</b> Haga clic en <i>Ver</i> despu√©s de una compilaci√≥n exitosa para abrir la aplicaci√≥n implementada: <br><br><div class="spoiler">  <b class="spoiler_title">Vista</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/cp/p-/fr/cpp-frnkeudluh4bm1ir-f4oi10.png"><br></div></div><br><a name="recaptcha"></a><br><h2>  Protecci√≥n de bot (reCAPTCHA) </h2><br>  El primer paso para habilitar la verificaci√≥n reCAPTCHA en nuestra aplicaci√≥n es crear un nuevo reCAPTCH en <a href="https://www.google.com/recaptcha/intro/v3.html" rel="nofollow">el panel de administraci√≥n de Google</a> .  All√≠ creamos un nuevo sitio (Agregar nuevo sitio / Crear) y establecemos la siguiente configuraci√≥n: <br><br><div class="spoiler">  <b class="spoiler_title">Configuraciones de ReCAPTCHA</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/xi/eh/rp/xiehrpgngjvxqvd1dq-4wp5gfqc.png"><br></div></div><br>  En la secci√≥n <i>Dominios</i> , debe especificar, adem√°s de la direcci√≥n donde vivir√° la aplicaci√≥n, debe especificar <code>localhost</code> , de modo que durante la depuraci√≥n evite problemas en la forma de la imposibilidad de iniciar sesi√≥n en su aplicaci√≥n. <br><br>  <b>Backend</b> <br><br>  Guarde la <i>clave</i> del <i>sitio</i> y la <i>clave secreta</i> ... <br><br><div class="spoiler">  <b class="spoiler_title">clave del sitio / clave secreta</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/hs/re/-t/hsre-ttxpgbhgau9q4fsvtdqxq0.png"><br></div></div><br>  ... luego para asignarlos a las variables de entorno y los nombres de las variables, a su vez, para asignar a las nuevas propiedades de <i>application.properties</i> : <br><br><pre> <code class="plaintext hljs">google.recaptcha.key.site=${GOOGLE_RECAPTCHA_KEY_SITE} google.recaptcha.key.secret=${GOOGLE_RECAPTCHA_KEY_SECRET}</code> </pre><br>  Agregue una nueva dependencia en <i>pom.xml</i> para la verificaci√≥n en el lado de Google de los tokens reCAPTCHA que el cliente nos enviar√°: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.mashape.unirest<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>unirest-java<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.4.9<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Ahora es el momento de actualizar las entidades que utilizamos para autorizar y registrar usuarios agregando un campo de cadena para el mismo token reCAPTCHA: <br><br><div class="spoiler">  <b class="spoiler_title">LoginUser.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.JsonProperty <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoginUser</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Serializable { @JsonProperty</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"username"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> username: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"password"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"recapctha_token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> recaptchaToken: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() {} <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(username: String, password: String, recaptchaToken: String) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password = password <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.recaptchaToken = recaptchaToken } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">1764970284520387975L</span></span> } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">NewUser.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.fasterxml.jackson.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.JsonProperty <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.Serializable <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NewUser</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Serializable { @JsonProperty</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"username"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> username: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"firstName"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> firstName: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"lastName"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastName: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"email"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> email: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"password"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> password: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@JsonProperty(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"recapctha_token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> recaptchaToken: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() {} <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(username: String, firstName: String, lastName: String, email: String, password: String, recaptchaToken: String) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.firstName = firstName <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastName = lastName <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.email = email <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password = password <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.recaptchaToken = recaptchaToken } <span class="hljs-keyword"><span class="hljs-keyword">companion</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serialVersionUID = -<span class="hljs-number"><span class="hljs-number">1764970284520387975L</span></span> } }</code> </pre><br></div></div><br>  Agregue un peque√±o servicio que transmitir√° el token reCAPTCHA a un servicio especial de Google e informar√° en respuesta si el token pas√≥ la verificaci√≥n: <br><br><div class="spoiler">  <b class="spoiler_title">ReCaptchaService.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Service <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.client.RestOperations <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Autowired <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mashape.unirest.http.HttpResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mashape.unirest.http.JsonNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.mashape.unirest.http.Unirest <span class="hljs-meta"><span class="hljs-meta">@Service(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"captchaService"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReCaptchaService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> BASE_VERIFY_URL: String = <span class="hljs-string"><span class="hljs-string">"https://www.google.com/recaptcha/api/siteverify"</span></span> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> restTemplate: RestOperations? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${google.recaptcha.key.site}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keySite: String <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${google.recaptcha.key.secret}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> keySecret: String <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateCaptcha</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> url: String = String.format(BASE_VERIFY_URL + <span class="hljs-string"><span class="hljs-string">"?secret=%s&amp;response=%s"</span></span>, keySecret, token) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jsonResponse: HttpResponse&lt;JsonNode&gt; = Unirest.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(url) .header(<span class="hljs-string"><span class="hljs-string">"accept"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>).queryString(<span class="hljs-string"><span class="hljs-string">"apiKey"</span></span>, <span class="hljs-string"><span class="hljs-string">"123"</span></span>) .asJson() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (jsonResponse.getStatus() == <span class="hljs-number"><span class="hljs-number">200</span></span>) } }</code> </pre><br></div></div><br>  Este servicio se debe utilizar en el controlador de registro y autorizaci√≥n de usuarios: <br><br><div class="spoiler">  <b class="spoiler_title">AuthController.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.ReCaptchaService ‚Ä¶ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> captchaService: ReCaptchaService ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(loginRequest.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">if</span></span>]... ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(newUser.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>...</code> </pre><br></div></div><br>  <b>Frontend</b> <br><br>  El primer paso es instalar y guardar el paquete <code>reCAPTHA</code> : <br><br><pre> <code class="plaintext hljs">$ npm install --save vue-recaptcha</code> </pre> <br>  Luego, con√©ctese al script en <i>index.html</i> : <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://www.google.com/recaptcha/api.js onload=vueRecaptchaApiLoaded&amp;render=explicit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">defer</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Agregue cualquier captcha a cualquier espacio libre en la p√°gina: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">vue-recaptcha</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"recaptcha"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"invisible"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:sitekey</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sitekey"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">verify</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onCapthcaVerified"</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">expired</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"onCaptchaExpired"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  Y el bot√≥n para la acci√≥n objetivo (autorizaci√≥n o registro) ahora llamar√° primero al m√©todo de validaci√≥n: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b-button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">v-on:click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"validateCaptcha"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">variant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"primary"</span></span></span><span class="hljs-tag">&gt;</span></span>Login<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b-button</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Agregue la dependencia a los componentes: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> VueRecaptcha <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue-recaptcha'</span></span></code> </pre> <br>  Editar <i>exportaci√≥n por defecto</i> : <br><br><pre> <code class="javascript hljs">components: { VueRecaptcha }, ‚Ä¶ data() { ‚Ä¶ siteKey: <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">i</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">  </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">i</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ‚Ä¶ }</code> </pre><br>  Y agregue nuevos m√©todos: <br><br><ul><li>  <code>validateCaptcha()</code> - que se llama haciendo clic en el bot√≥n </li><li>  <code>onCapthcaVerified(recaptchaToken)  onCaptchaExpired()</code> , que el propio captcha llama </li></ul><br><div class="spoiler">  <b class="spoiler_title">Nuevos m√©todos</b> <div class="spoiler_text"><pre> <code class="javascript hljs">validateCaptcha() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$refs.recaptcha.execute() }, onCapthcaVerified(recaptchaToken) { AXIOS.post(<span class="hljs-string"><span class="hljs-string">`/auth/signin`</span></span>, {<span class="hljs-string"><span class="hljs-string">'username'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$data.username, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$data.password, <span class="hljs-string"><span class="hljs-string">'recapctha_token'</span></span>: recaptchaToken}) .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">response</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$store.dispatch(<span class="hljs-string"><span class="hljs-string">'login'</span></span>, {<span class="hljs-string"><span class="hljs-string">'token'</span></span>: response.data.accessToken, <span class="hljs-string"><span class="hljs-string">'roles'</span></span>: response.data.authorities, <span class="hljs-string"><span class="hljs-string">'username'</span></span>: response.data.username}); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$router.push(<span class="hljs-string"><span class="hljs-string">'/home'</span></span>) }, error =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showAlert(error.response.data.message); }) .catch(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(e); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.showAlert(<span class="hljs-string"><span class="hljs-string">'Server error. Please, report this error website owners'</span></span>); }) }, onCaptchaExpired() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$refs.recaptcha.reset() }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Resultado</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/m0/rc/w9/m0rcw9xjgqjqpgiuwdib16_mur8.png"><br></div></div><br><a name="email"></a><br><h2>  Env√≠o de correo electr√≥nico </h2><br>  Considere la posibilidad de enviar cartas a nuestra aplicaci√≥n a trav√©s de un servidor de correo p√∫blico, como Google o Mail.ru. <br><br>  El primer paso, respectivamente, ser√° crear una cuenta en el servidor de correo seleccionado, si a√∫n no lo est√°. <br><br>  El segundo paso es que debemos agregar las siguientes dependencias en <i>pom.xml</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Dependencias</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-mail<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-thymeleaf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>commons-io<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>commons-io<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.4<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Tambi√©n debe agregar nuevas propiedades a <i>application.properties</i> : <br><br><div class="spoiler">  <b class="spoiler_title">Propiedades de SMTP</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">spring.mail.host=${SMTP_MAIL_HOST} spring.mail.port=${SMTP_MAIL_PORT} spring.mail.username=${SMTP_MAIL_USERNAME} spring.mail.password=${SMTP_MAIL_PASSWORD} spring.mail.properties.mail.smtp.auth=true spring.mail.properties.mail.smtp.starttls.enable=true spring.mail.properties.mail.smtp.ssl.enable=true spring.mail.properties.mail.smtp.connectiontimeout=5000 spring.mail.properties.mail.smtp.timeout=5000 spring.mail.properties.mail.smtp.writetimeout=5000</code> </pre><br></div></div><br>  Puede especificar la configuraci√≥n de SMTP aqu√≠: <a href="https://support.google.com/mail/answer/7126229%3Fhl%3Dru" rel="nofollow">Google</a> y <a href="https://help.mail.ru/mail-help/mailer/popsmtp" rel="nofollow">Mail.ru</a> <br><br>  Cree una interfaz donde declaremos varios m√©todos: <br><br><ul><li>  Para enviar un mensaje de texto regular </li><li>  Para enviar un correo electr√≥nico HTML </li><li>  Para enviar un correo electr√≥nico usando una plantilla </li></ul><br><div class="spoiler">  <b class="spoiler_title">EmailService.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.email <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.SimpleMailMessage <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailService</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, text: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessageUsingTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, template: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, params:</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MutableMap</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Any&gt;)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHtmlMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, htmlMsg: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre><br></div></div><br>  Ahora creemos una implementaci√≥n de esta interfaz: el servicio de env√≠o de correos electr√≥nicos: <br><br><div class="spoiler">  <b class="spoiler_title">EmailServiceImpl.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.email <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Autowired <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.io.FileSystemResource <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.MailException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.SimpleMailMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.javamail.JavaMailSender <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.mail.javamail.MimeMessageHelper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.stereotype.Component <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.thymeleaf.spring5.SpringTemplateEngine <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.thymeleaf.context.Context <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.File <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.mail.MessagingException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.mail.internet.MimeMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.apache.commons.io.IOUtils <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.core.env.Environment <span class="hljs-meta"><span class="hljs-meta">@Component</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EmailServiceImpl</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">EmailService { @Value</span></span></span></span>(<span class="hljs-string"><span class="hljs-string">"\${spring.mail.username}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sender: String <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> environment: Environment <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emailSender: JavaMailSender? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> templateEngine: SpringTemplateEngine <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, text: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> message = SimpleMailMessage() message.setTo(to) message.setFrom(sender) message.setSubject(subject) message.setText(text) emailSender!!.send(message) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (exception: MailException) { exception.printStackTrace() } } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleMessageUsingTemplate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, template: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, params:</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">MutableMap</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, Any&gt;)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> message = emailSender!!.createMimeMessage() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> helper = MimeMessageHelper(message, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context: Context = Context() context.setVariables(params) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> html: String = templateEngine.process(template, context) helper.setTo(to) helper.setFrom(sender) helper.setText(html, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) helper.setSubject(subject) emailSender!!.send(message) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHtmlMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(to: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, subject: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, htmlMsg: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> message = emailSender!!.createMimeMessage() message.setContent(htmlMsg, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> helper = MimeMessageHelper(message, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>) helper.setTo(to) helper.setFrom(sender) helper.setSubject(subject) emailSender!!.send(message) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (exception: MailException) { exception.printStackTrace() } } }</code> </pre><br></div></div><br><ul><li>  Utilizamos JavaMailSender configurado autom√°ticamente por Spring para enviar correos electr√≥nicos </li><li>  Enviar cartas regulares es extremadamente simple: solo necesita agregar texto al cuerpo de la carta y enviarla </li><li>  Los correos electr√≥nicos HTML se definen como mensajes de tipo Mime y su contenido como <code>text/html</code> </li><li>  Para procesar la plantilla de mensaje HTML, usamos Spring Template Engine </li></ul><br>  Creemos una plantilla simple para escribir usando el marco <a href="https://www.thymeleaf.org/" rel="nofollow">Thymeleaf</a> coloc√°ndola en <i>src / main / resources / templates /</i> : <br><br><div class="spoiler">  <b class="spoiler_title">emailTemplate.html</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"en"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/1999/xhtml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:th</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.thymeleaf.org"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"UTF-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Hello<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"font-family: Arial, Helvetica, sans-serif;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Hello!<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"margin-top: 20px; margin-bottom: 30px; margin-left: 20px;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>Hello, dear: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">th:text</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${addresseeName}"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">b</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">img</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">th:src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"${signatureImage}"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"200px;"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br></div></div><br>  Los elementos cambiantes de la plantilla (en nuestro caso, el nombre del destinatario y la ruta de la imagen para la firma) se declaran utilizando marcadores de posici√≥n. <br><br>  Ahora cree o actualice un controlador que enviar√° cartas: <br><br><div class="spoiler">  <b class="spoiler_title">BackendController.kt</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.email.EmailServiceImpl <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.web.response.ResponseMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.ResponseEntity <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.HttpStatus ‚Ä¶ <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emailService: EmailService <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${spring.mail.username}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> addressee: String ‚Ä¶ <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/sendSimpleEmail"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hasRole('USER')"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendSimpleEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { emailService.sendSimpleMessage(addressee, <span class="hljs-string"><span class="hljs-string">"Simple Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello! This is simple email"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Error while sending message"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email has been sent"</span></span>), HttpStatus.OK) } <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/sendTemplateEmail"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hasRole('USER')"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendTemplateEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params:MutableMap&lt;String, Any&gt; = mutableMapOf() params[<span class="hljs-string"><span class="hljs-string">"addresseeName"</span></span>] = addressee params[<span class="hljs-string"><span class="hljs-string">"signatureImage"</span></span>] = <span class="hljs-string"><span class="hljs-string">"https://coderlook.com/wp-content/uploads/2019/07/spring-by-pivotal.png"</span></span> emailService.sendSimpleMessageUsingTemplate(addressee, <span class="hljs-string"><span class="hljs-string">"Template Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"emailTemplate"</span></span>, params) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Error while sending message"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email has been sent"</span></span>), HttpStatus.OK) } <span class="hljs-meta"><span class="hljs-meta">@GetMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/sendHtmlEmail"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-meta"><span class="hljs-meta">@PreAuthorize(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"hasRole('USER')"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendHtmlEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { emailService.sendHtmlMessage(addressee, <span class="hljs-string"><span class="hljs-string">"HTML Email"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;h1&gt;Hello!&lt;/h1&gt;&lt;p&gt;This is HTML email&lt;/p&gt;"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Error while sending message"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email has been sent"</span></span>), HttpStatus.OK) }</code> </pre><br></div></div><br>  <u>Nota:</u> Para asegurarnos de que todo funcione, primero nos enviaremos cartas a nosotros mismos. <br><br>  Adem√°s, para asegurarnos de que todo funcione, podemos crear una modesta interfaz web que simplemente extraiga los m√©todos del servicio web: <br><br><div class="spoiler">  <b class="spoiler_title">Email.vue</b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;template&gt; &lt;div id="email"&gt; &lt;b-button v-on:click="sendSimpleMessage" variant="primary"&gt;Simple Email&lt;/b-button&gt;&lt;br/&gt; &lt;b-button v-on:click="sendEmailUsingTemplate" variant="primary"&gt;Template Email&lt;/b-button&gt;&lt;br/&gt; &lt;b-button v-on:click="sendHTMLEmail" variant="primary"&gt;HTML Email&lt;/b-button&gt;&lt;br/&gt; &lt;/div&gt; &lt;/template&gt; &lt;script&gt; import {AXIOS} from './http-common' export default { name: 'EmailPage', data() { return { counter: 0, username: '', header: {'Authorization': 'Bearer ' + this.$store.getters.getToken} } }, methods: { sendSimpleMessage() { AXIOS.get('/sendSimpleEmail', { headers: this.$data.header }) .then(response =&gt; { console.log(response); alert("OK"); }) .catch(error =&gt; { console.log('ERROR: ' + error.response.data); }) }, sendEmailUsingTemplate() { AXIOS.get('/sendTemplateEmail', { headers: this.$data.header }) .then(response =&gt; { console.log(response); alert("OK") }) .catch(error =&gt; { console.log('ERROR: ' + error.response.data); }) }, sendHTMLEmail() { AXIOS.get('/sendHtmlEmail', { headers: this.$data.header }) .then(response =&gt; { console.log(response); alert("OK") }) .catch(error =&gt; { console.log('ERROR: ' + error.response.data); }) } } } &lt;/script&gt; &lt;style&gt; #email { margin-left: 38%; margin-top: 50px; } button { width: 150px; } &lt;/style&gt;</code> </pre><br></div></div><br>  <u>Nota:</u> no olvide actualizar <code>router.js</code> y agregue el enlace a la <code>App.vue</code> navegaci√≥n de <code>App.vue</code> si est√° creando un nuevo componente. <br><br><a name="gradle"></a><br><h2>  Gradle Migration </h2><br>  Aclarar√© de inmediato: si este art√≠culo se considera una mejora, deje que todos decidan por su propio proyecto.  Solo miramos c√≥mo hacer esto. <br><br>  En general, puede usar la instrucci√≥n <a href="http://www.rationaljava.com/2016/02/moving-from-maven-to-gradle-in-under-5.html" rel="nofollow">Mudarse de Maven a Gradle en menos de 5 minutos</a> , pero es poco probable que el resultado <a href="http://www.rationaljava.com/2016/02/moving-from-maven-to-gradle-in-under-5.html" rel="nofollow">cumpla</a> con las expectativas.  Todav√≠a recomendar√≠a hacer la migraci√≥n manualmente, no tomar√° mucho m√°s tiempo. <br><br>  Lo primero que debemos hacer es <a href="https://gradle.org/install/" rel="nofollow">instalar Gradle</a> . <br><br>  Luego, debemos realizar el siguiente procedimiento para ambos subproyectos: <code>backend</code> y <code>fronted</code> : <br><br>  <b># 1</b> Eliminar archivos Maven - <i>pom.xml</i> , <i>.mvn</i> . <br><br>  <b># 2</b> En el directorio de subproyectos, ejecute gradle init y responda las preguntas: <br><br><ul><li>  <i>Seleccione el tipo de proyecto a generar:</i> <b>b√°sico</b> </li><li>  <i>Seleccionar idioma de implementaci√≥n:</i> <b>Kotlin</b> </li><li>  <i>Seleccione el script de compilaci√≥n DSL:</i> <b>Kotlin</b> (ya que estamos escribiendo un proyecto en Kotlin) </li></ul><br>  <b># 3</b> Eliminar <i>settings.gradle.kts</i> : este archivo solo es necesario para el proyecto ra√≠z. <br><br>  <b># 4</b> Ejecute el <code>gradle wrapper</code> . <br><br>  Ahora pasemos a nuestro proyecto ra√≠z.  Para ello, debe seguir los pasos 1, 2 y 4 descritos anteriormente para subproyectos: todo es igual <u>excepto eliminar <i>settings.gradle.kts</i></u> . <br><br>  La configuraci√≥n de compilaci√≥n para el proyecto de fondo se ver√° as√≠: <br><br><div class="spoiler">  <b class="spoiler_title">build.gradle.kts</b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.jetbrains.kotlin.gradle.tasks.KotlinCompile plugins { id(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot"</span></span>) version <span class="hljs-string"><span class="hljs-string">"2.1.3.RELEASE"</span></span> id(<span class="hljs-string"><span class="hljs-string">"io.spring.dependency-management"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.0.8.RELEASE"</span></span> kotlin(<span class="hljs-string"><span class="hljs-string">"jvm"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.3.50"</span></span> kotlin(<span class="hljs-string"><span class="hljs-string">"plugin.spring"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.3.50"</span></span> id(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin.plugin.jpa"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.3.50"</span></span> } group = <span class="hljs-string"><span class="hljs-string">"com.kotlin-spring-vue"</span></span> version = <span class="hljs-string"><span class="hljs-string">"0.0.1-SNAPSHOT"</span></span> java.sourceCompatibility = JavaVersion.VERSION_1_8 repositories { mavenCentral() maven { url = uri(<span class="hljs-string"><span class="hljs-string">"https://plugins.gradle.org/m2/"</span></span>) } } dependencies { runtimeOnly(project(<span class="hljs-string"><span class="hljs-string">":frontend"</span></span>)) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-actuator:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-web:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-data-jpa:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-mail:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-security:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.postgresql:postgresql:42.2.5"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-thymeleaf:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"commons-io:commons-io:2.4"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"io.jsonwebtoken:jjwt:0.9.0"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"io.jsonwebtoken:jjwt-api:0.10.6"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"com.mashape.unirest:unirest-java:1.4.9"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"com.fasterxml.jackson.module:jackson-module-kotlin:2.9.8"</span></span>) runtimeOnly(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-devtools:2.1.3.RELEASE"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-reflect"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-stdlib-jdk8"</span></span>) implementation(<span class="hljs-string"><span class="hljs-string">"org.jetbrains.kotlin:kotlin-noarg:1.3.50"</span></span>) testImplementation(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-starter-test"</span></span>) { exclude(group = <span class="hljs-string"><span class="hljs-string">"org.junit.vintage"</span></span>, module = <span class="hljs-string"><span class="hljs-string">"junit-vintage-engine"</span></span>) } } tasks.withType&lt;KotlinCompile&gt; { kotlinOptions { freeCompilerArgs = listOf(<span class="hljs-string"><span class="hljs-string">"-Xjsr305=strict"</span></span>) jvmTarget = <span class="hljs-string"><span class="hljs-string">"1.8"</span></span> } }</code> </pre><br></div></div><br><ul><li>  Se deben especificar todos los complementos requeridos de Kotlin y Spring. </li><li>  No se olvide del complemento <i>org.jetbrains.kotlin.plugin.jpa</i> : es necesario conectarse a la base de datos </li><li>  En las dependencias, debe especificar <code>runtimeOnly(project(":frontend"))</code> ; primero debemos crear el proyecto <i>frontend</i> </li></ul><br>  Configuraci√≥n de compilaci√≥n para proyecto <i>frontend</i> : <br><br><div class="spoiler">  <b class="spoiler_title">build.gradle.kts</b> <div class="spoiler_text"><pre> <code class="kotlin hljs">plugins { id(<span class="hljs-string"><span class="hljs-string">"org.siouan.frontend"</span></span>) version <span class="hljs-string"><span class="hljs-string">"1.2.1"</span></span> id(<span class="hljs-string"><span class="hljs-string">"java"</span></span>) } group = <span class="hljs-string"><span class="hljs-string">"com.kotlin-spring-vue"</span></span> version = <span class="hljs-string"><span class="hljs-string">"0.0.1-SNAPSHOT"</span></span> java { targetCompatibility = JavaVersion.VERSION_1_8 } buildscript { repositories { mavenCentral() maven { url = uri(<span class="hljs-string"><span class="hljs-string">"https://plugins.gradle.org/m2/"</span></span>) } } } frontend { nodeVersion.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"10.16.0"</span></span>) cleanScript.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"run clean"</span></span>) installScript.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"install"</span></span>) assembleScript.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(<span class="hljs-string"><span class="hljs-string">"run build"</span></span>) } tasks.named(<span class="hljs-string"><span class="hljs-string">"jar"</span></span>, Jar::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">) </span></span>{ dependsOn(<span class="hljs-string"><span class="hljs-string">"assembleFrontend"</span></span>) from(<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$buildDir</span></span></span><span class="hljs-string">/dist"</span></span>) into(<span class="hljs-string"><span class="hljs-string">"static"</span></span>) }</code> </pre><br></div></div><br><ul><li>  En mi ejemplo, el complemento <code>org.siouan.frontend</code> se usa para construir el proyecto </li><li>  En la secci√≥n <code>frontend {...}</code> debe indicar la versi√≥n de Node.js, as√≠ como los comandos que invocan los scripts de limpieza, instalaci√≥n y ensamblaje especificados en <code>package.json</code> </li><li>  Ahora empaquetamos nuestro subproyecto frontend en un archivo JAR y lo usamos como una dependencia ( <code>runtimeOnly(project(":frontend"))</code> en el <i>back-end</i> ), por lo que debemos describir una tarea que copie los archivos del directorio de ensamblado a <i>/ p√∫blico</i> y crea un archivo jar </li></ul><br>  <u>Nota:</u> <br><br><ul><li>  Edite <code>vue.config.js</code> , cambiando el directorio de <i>compilaci√≥n</i> a <i>build / dist</i> . </li><li>  En el archivo de <i>script de compilaci√≥n</i> <code>package.json</code> , especifique <code>vue-cli-service build</code> o aseg√∫rese de que est√© especificado </li></ul><br>  El archivo settings.gradle.kts en el proyecto ra√≠z debe contener el siguiente c√≥digo: ... <br><br><pre> <code class="kotlin hljs">rootProject.name = <span class="hljs-string"><span class="hljs-string">"demo"</span></span> include(<span class="hljs-string"><span class="hljs-string">":frontend"</span></span>, <span class="hljs-string"><span class="hljs-string">":backend"</span></span>)</code> </pre><br>  ... es el nombre del proyecto y los subproyectos. <br><br>  Y ahora podemos construir el proyecto ejecutando el comando: <code>./gradlew build</code> <br><br>  <u>Nota:</u> si para los marcadores de posici√≥n especificados en <i>application.properties</i> (por ejemplo, <code>${SPRING_DATASOURCE_URL}</code> ) no hay variables de entorno correspondientes, el ensamblado fallar√°.  Para evitar esto, use <code><b>/gradlew build -x</b></code> <br><br>  Puede verificar la estructura de los proyectos utilizando el <code>gradle -q projects</code> , el resultado deber√≠a ser similar a este: <br><br><pre> <code class="plaintext hljs">Root project 'demo' +--- Project ':backend' \--- Project ':frontend'</code> </pre> <br>  Y finalmente, para ejecutar la aplicaci√≥n, debe ejecutar <code>./gradlew bootRun</code> . <br><br><h4>  .gitignore </h4><br>  Los siguientes archivos y carpetas deben agregarse al archivo <i>.gitignore</i> : <br><br><ul><li>  backend / build / </li><li>  frontend / build / </li><li>  construir </li><li>  .gradle </li></ul><br>  <u>Importante:</u> no debe agregar archivos <code>gradlew</code> a <i>.gitignore</i> ; no hay nada peligroso en ellos, pero son necesarios para un ensamblado exitoso en un servidor remoto. <br><br><h4>  Despliegue en Heroku </h4><br>  Veamos los cambios que necesitamos hacer para que la aplicaci√≥n se implemente de manera segura en Heroku. <br><br>  <b># 1 Procfile</b> <br><br>  Necesitamos pedirle a Heroku nuevas instrucciones para iniciar la aplicaci√≥n: <br><br><pre> <code class="plaintext hljs">web: java -Dserver.port=$PORT -jar backend/build/libs/backend-0.0.1-SNAPSHOT.jar</code> </pre> <br>  <b># 2 variables de entorno</b> <br><br>  Heroku puede rehacer el tipo de aplicaci√≥n (por ejemplo, la aplicaci√≥n Spring Boot) y seguir las instrucciones de ensamblaje apropiadas.  Pero nuestra aplicaci√≥n (el proyecto ra√≠z) no se parece a una aplicaci√≥n Spring Boot para Heroku.  Si dejamos todo como est√°, Heroku nos pedir√° que definamos la <code>stage</code> .  Honestamente, no s√© d√≥nde termina este camino, porque no lo segu√≠.  Es m√°s f√°cil definir una variable <code>GRADLE_TASK</code> con un valor de <code>build</code> : <br><br><img src="https://habrastorage.org/webt/5j/xz/o2/5jxzo2ukto8lyakkxajjg5rrvtg.png"><br><br>  <b># 3 reCAPTCHA</b> <br><br>  Al colocar la aplicaci√≥n en un nuevo dominio, no olvide actualizar el captcha, las variables de entorno <code>GOOGLE_RECAPTCHA_KEY_SITE</code> y <code>GOOGLE_RECAPTCHA_KEY_SECRET</code> , y tambi√©n actualizar la clave del sitio en el subproyecto de interfaz. <br><br><a name="cookies"></a><br><h2>  Almacenar token JWT en cookies </h2><br>  En primer lugar, le recomiendo que lea el art√≠culo <a href="https://www.rdegges.com/2018/please-stop-using-local-storage/" rel="nofollow">Por favor, deje de usar el almacenamiento local</a> , especialmente la secci√≥n <i>Por qu√© el almacenamiento local es inseguro y no debe usarlo para almacenar datos confidenciales</i> . <br><br>  Veamos c√≥mo puede almacenar el token JWT en un lugar m√°s seguro: cookies en el indicador <code>httpOnly</code> , donde no estar√° disponible para leer / cambiar usando JavaScript. <br><br>  <b># 1</b> Eliminando toda la l√≥gica relacionada con JWT de la interfaz: <br>  Dado que el token a√∫n no es accesible con JavaScript con el nuevo m√©todo de almacenamiento, puede eliminar de forma segura todas las referencias a √©l de nuestro subproyecto. <br><br>  Pero el rol del usuario sin referencia a ning√∫n otro dato no es una informaci√≥n tan importante, a√∫n puede almacenarse en el Almacenamiento local y determinar si el usuario est√° autorizado o no, dependiendo de si este rol est√° definido. <br><br><div class="spoiler">  <b class="spoiler_title">store / index.js</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vue <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vue'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Vuex <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'vuex'</span></span>; Vue.use(Vuex); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> state = { <span class="hljs-attr"><span class="hljs-attr">role</span></span>: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'user-name'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">authorities</span></span>: localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'authorities'</span></span>) || <span class="hljs-string"><span class="hljs-string">''</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getters = { <span class="hljs-attr"><span class="hljs-attr">isAuthenticated</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.role != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; state.role != <span class="hljs-string"><span class="hljs-string">''</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, <span class="hljs-attr"><span class="hljs-attr">isAdmin</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state.role === <span class="hljs-string"><span class="hljs-string">'admin'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }, <span class="hljs-attr"><span class="hljs-attr">getUsername</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.username; }, <span class="hljs-attr"><span class="hljs-attr">getAuthorities</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state.authorities; } }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mutations = { <span class="hljs-attr"><span class="hljs-attr">auth_login</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state, user</span></span></span><span class="hljs-function">) =&gt;</span></span> { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-name'</span></span>, user.username); localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-authorities'</span></span>, user.roles); state.username = user.username; state.authorities = user.roles; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isUser = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isAdmin = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; user.roles.length; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.roles[i].authority === <span class="hljs-string"><span class="hljs-string">'ROLE_USER'</span></span>) { isUser = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (user.roles[i].authority === <span class="hljs-string"><span class="hljs-string">'ROLE_ADMIN'</span></span>) { isAdmin = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isUser) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>, <span class="hljs-string"><span class="hljs-string">'user'</span></span>); state.role = <span class="hljs-string"><span class="hljs-string">'user'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isAdmin) { localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>, <span class="hljs-string"><span class="hljs-string">'admin'</span></span>); state.role = <span class="hljs-string"><span class="hljs-string">'admin'</span></span>; } }, <span class="hljs-attr"><span class="hljs-attr">auth_logout</span></span>: <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { state.token = <span class="hljs-string"><span class="hljs-string">''</span></span>; state.role = <span class="hljs-string"><span class="hljs-string">''</span></span>; state.username = <span class="hljs-string"><span class="hljs-string">''</span></span>; state.authorities = []; localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'user-role'</span></span>); localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'user-name'</span></span>); localStorage.removeItem(<span class="hljs-string"><span class="hljs-string">'user-authorities'</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> actions = { <span class="hljs-attr"><span class="hljs-attr">login</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context, user</span></span></span><span class="hljs-function">) =&gt;</span></span> { context.commit(<span class="hljs-string"><span class="hljs-string">'auth_login'</span></span>, user) }, <span class="hljs-attr"><span class="hljs-attr">logout</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">context</span></span></span><span class="hljs-function">) =&gt;</span></span> { context.commit(<span class="hljs-string"><span class="hljs-string">'auth_logout'</span></span>); } }; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> store = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vuex.Store({ state, getters, mutations, actions });</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenga cuidado al refactorizar </font></font><code>store/index.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: si la autorizaci√≥n y la desautorizaci√≥n no funcionan correctamente, los mensajes de error molestar√°n persistentemente en la consola. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Devuelva el JWT como una cookie en el controlador de autorizaci√≥n ( </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no en el cuerpo de la respuesta</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ):</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AuthController.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.authCookieName}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authCookieName: String <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.isCookieSecure}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isCookieSecure: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-meta"><span class="hljs-meta">@PostMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/signin"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticateUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Valid</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loginRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LoginUser</span></span></span></span><span class="hljs-function"><span class="hljs-params">, response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpServletResponse</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userCandidate: Optional &lt;User&gt; = userRepository.findByUsername(loginRequest.username!!) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(loginRequest.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userCandidate.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User = userCandidate.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authentication = authenticationManager.authenticate( UsernamePasswordAuthenticationToken(loginRequest.username, loginRequest.password)) SecurityContextHolder.getContext().setAuthentication(authentication) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jwt: String = jwtProvider.generateJwtToken(user.username!!) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cookie: Cookie = Cookie(authCookieName, jwt) cookie.maxAge = jwtProvider.jwtExpiration!! cookie.secure = isCookieSecure cookie.isHttpOnly = <span class="hljs-literal"><span class="hljs-literal">true</span></span> cookie.path = <span class="hljs-string"><span class="hljs-string">"/"</span></span> response.addCookie(cookie) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authorities: List&lt;GrantedAuthority&gt; = user.roles!!.stream().map({ role -&gt; SimpleGrantedAuthority(role.name)}).collect(Collectors.toList&lt;GrantedAuthority&gt;()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity.ok(SuccessfulSigninResponse(user.username, authorities)) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"User not found!"</span></span>), HttpStatus.BAD_REQUEST) } }</code> </pre><br></div></div><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Por favor, nota que puse opciones </font></font><code>authCookieName</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>isCookieSecure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application.properties</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - el env√≠o de cookies para la bandera </font></font><code>secure</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">s√≥lo puede https, lo que hace que sea extremadamente dif√≠cil de depurar con localhost. </font><font style="vertical-align: inherit;">PERO en producci√≥n, por supuesto, es mejor usar cookies con esta bandera. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Adem√°s, ahora es aconsejable que las respuestas del controlador usen una entidad sin un campo especial para JWT. </font><font style="vertical-align: inherit;">Actualizaci√≥n n </font><font style="vertical-align: inherit;">. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬∞ 3</font></font></b><font style="vertical-align: inherit;"></font><code>JwtAuthTokenFilter</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sol√≠amos tomar un token del encabezado de la solicitud, ahora lo tomamos de las cookies:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">JwtAuthTokenFilter.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.authCookieName}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authCookieName: String ... <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getJwt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpServletRequest</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String? { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (cookie <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.cookies) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cookie.name == authCookieName) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> cookie.value } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> }</code> </pre><br></div></div><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Habilitaci√≥n de </font></font><a href="https://ru.wikipedia.org/wiki/Cross-origin_resource_sharing" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CORS</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Si en mi art√≠culo anterior a√∫n pudieras saltarte esta pregunta, ahora ser√≠a extra√±o proteger el token JWT sin tener que habilitar CORS en el lado del backend. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Puedes arreglar esto editando </font></font><code>WebSecurityConfig.kt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WebSecurityConfig.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Bean</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">corsConfigurationSource</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: CorsConfigurationSource { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> configuration = CorsConfiguration() configuration.allowedOrigins = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080"</span></span>, <span class="hljs-string"><span class="hljs-string">"http://localhost:8081"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://kotlin-spring-vue-gradle-demo.herokuapp.com"</span></span>) configuration.allowedHeaders = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"*"</span></span>) configuration.allowedMethods = Arrays.asList(<span class="hljs-string"><span class="hljs-string">"GET"</span></span>, <span class="hljs-string"><span class="hljs-string">"POST"</span></span>, <span class="hljs-string"><span class="hljs-string">"PUT"</span></span>, <span class="hljs-string"><span class="hljs-string">"DELETE"</span></span>, <span class="hljs-string"><span class="hljs-string">"OPTIONS"</span></span>) configuration.allowCredentials = <span class="hljs-literal"><span class="hljs-literal">true</span></span> configuration.maxAge = <span class="hljs-number"><span class="hljs-number">3600</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> source = UrlBasedCorsConfigurationSource() source.registerCorsConfiguration(<span class="hljs-string"><span class="hljs-string">"/**"</span></span>, configuration) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> source } <span class="hljs-meta"><span class="hljs-meta">@Throws(Exception::class)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(http: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpSecurity</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { http .cors().and() .csrf().disable().authorizeRequests() .antMatchers(<span class="hljs-string"><span class="hljs-string">"/**"</span></span>).permitAll() .anyRequest().authenticated() .and() .exceptionHandling().authenticationEntryPoint(unauthorizedHandler).and() .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS) http.addFilterBefore(authenticationJwtTokenFilter(), UsernamePasswordAuthenticationFilter::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">http</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">headers</span></span></span></span>().cacheControl().disable() }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y ahora puede eliminar todas las anotaciones </font></font><code>@CrossOrigin</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de los controladores. </font></font><br><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el par√°metro </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AllowCredentials es</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> necesario para enviar solicitudes desde el frontend. </font><font style="vertical-align: inherit;">Lea m√°s sobre esto </font></font><a href="https://stackoverflow.com/questions/45004354/when-should-i-really-set-access-control-allow-credentials-to-true-in-my-resp" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">aqu√≠</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Actualizaci√≥n de encabezados en el lado frontal:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http-commons.js</font></font></b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> AXIOS = axios.create({ <span class="hljs-attr"><span class="hljs-attr">baseURL</span></span>: <span class="hljs-string"><span class="hljs-string">`/api`</span></span>, <span class="hljs-attr"><span class="hljs-attr">headers</span></span>: { <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Origin'</span></span>: [<span class="hljs-string"><span class="hljs-string">'http://localhost:8080'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://localhost:8081'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://kotlin-spring-vue-gradle-demo.herokuapp.com'</span></span>], <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Methods'</span></span>: <span class="hljs-string"><span class="hljs-string">'GET,POST,DELETE,PUT,OPTIONS'</span></span>, <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Headers'</span></span>: <span class="hljs-string"><span class="hljs-string">'*'</span></span>, <span class="hljs-string"><span class="hljs-string">'Access-Control-Allow-Credentials'</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } })</code> </pre><br></div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cheque </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Intentemos iniciar sesi√≥n en la aplicaci√≥n iniciando sesi√≥n desde un host que no est√° en la lista permitida </font></font><code>WebSecurityConfig.kt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para hacer esto, ejecute el back-end en el puerto </font></font><code>8080</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y la interfaz, por ejemplo, en </font></font><code>8082</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">e intente iniciar sesi√≥n:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/sw/ce/hk/swcehkifaph10nqjveh17sv1w88.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solicitud de autorizaci√≥n rechazada por la pol√≠tica de CORS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora veamos c√≥mo funcionan las cookies de marca en general </font></font><code>httpOnly</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Para hacer esto, vamos, por ejemplo, al sitio </font></font><a href="https://kotlinlang.org/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://kotlinlang.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y ejec√∫telo en la consola del navegador:</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.cookie</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/4o/s7/ct/4os7ctztsejgbzclio8ci8nloky.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Las </font></font><code>httpOnly</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cookies </font><font style="vertical-align: inherit;">no </font><font style="vertical-align: inherit;">relacionadas con este sitio </font><font style="vertical-align: inherit;">aparecer√°n en la consola </font><font style="vertical-align: inherit;">, que, como vemos, son accesibles a trav√©s de JavaScript. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora entremos a nuestra aplicaci√≥n, </font></font><u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inicie sesi√≥n</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (para que el navegador </font><font style="vertical-align: inherit;">guarde la cookie </font><font style="vertical-align: inherit;">con JWT) y repita lo mismo:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/fh/_b/zh/fh_bzh9ytv6rf_xn40fjf3c83ag.png"><br></div></div><br> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nota:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> este m√©todo de almacenar un token JWT es m√°s confiable que usar el Almacenamiento local, pero debe comprender que no es una panacea.</font></font><br><br><a name="confirmation"></a><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Confirmaci√≥n de registro por correo electr√≥nico </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Un breve algoritmo para realizar esta tarea es el siguiente: </font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para todos los usuarios nuevos, el atributo </font></font><code>isEnabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la base de datos se establece en</font></font><code>false</code> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Se genera un token de cadena a partir de caracteres arbitrarios, que servir√° como clave para confirmar el registro. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> El token se env√≠a al usuario por correo como parte del enlace. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El atributo </font></font><code>isEnabled</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">se establece en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">verdadero</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si el usuario sigue el enlace durante un per√≠odo de tiempo establecido.</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora considere este proceso con m√°s detalle. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Necesitamos una tabla para almacenar el token para confirmar el registro:</font></font><br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.verification_token ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">serial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, token <span class="hljs-built_in"><span class="hljs-built_in">character</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varying</span></span>, expiry_date <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> zone, user_id <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) ); <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> public.verification_token <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> verification_token_users_fk <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (user_id) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> public.users (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">MATCH</span></span> SIMPLE <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASCADE</span></span>;</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y, en consecuencia, una nueva entidad para el mapeo relacional de objetos ...: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VerificationToken.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.jpa <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.persistence.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.Calendar <span class="hljs-meta"><span class="hljs-meta">@Entity</span></span> <span class="hljs-meta"><span class="hljs-meta">@Table(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"verification_token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerificationToken</span></span></span></span>( <span class="hljs-meta"><span class="hljs-meta">@Id</span></span> <span class="hljs-meta"><span class="hljs-meta">@GeneratedValue(strategy = GenerationType.AUTO)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> id: <span class="hljs-built_in"><span class="hljs-built_in">Long</span></span>? = <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-meta"><span class="hljs-meta">@Column(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"token"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> token: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-meta"><span class="hljs-meta">@Column(name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"expiry_date"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> expiryDate: Date, <span class="hljs-meta"><span class="hljs-meta">@OneToOne(targetEntity = User::class, fetch = FetchType.EAGER, cascade = [CascadeType.PERSIST])</span></span> <span class="hljs-meta"><span class="hljs-meta">@JoinColumn(nullable = false, name = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"user_id"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User ) { <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(token: String?, user: User) : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, token, calculateExpiryDate(<span class="hljs-number"><span class="hljs-number">1440</span></span>), user) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">calculateExpiryDate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(expiryTimeInMinutes: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Date { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cal = Calendar.getInstance() cal.time = Timestamp(cal.time.time) cal.add(Calendar.MINUTE, expiryTimeInMinutes) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Date(cal.time.time) }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... y el repositorio: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">VerificationTokenRepository.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.repository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.jpa.VerificationToken <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span>.jpa.repository.JpaRepository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.* <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">VerificationTokenRepository</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">JpaRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">VerificationToken, Long</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findByToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Optional&lt;VerificationToken&gt; }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora necesitamos implementar herramientas para administrar tokens: crear, verificar y enviar por correo electr√≥nico. </font><font style="vertical-align: inherit;">Para hacer esto, modificamos </font></font><code>UserDetailsServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">agregando m√©todos para crear y verificar el token:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">UserDetailsServiceImpl.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createVerificationTokenForUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">, user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { tokenRepository.save(VerificationToken(token, user)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">validateVerificationToken</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(token: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: String { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> verificationToken: Optional&lt;VerificationToken&gt; = tokenRepository.findByToken(token) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (verificationToken.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User = verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().user <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cal: Calendar = Calendar.getInstance() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>().expiryDate.time - cal.time.time) &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { tokenRepository.delete(verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TOKEN_EXPIRED } user.enabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span> tokenRepository.delete(verificationToken.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>()) userRepository.save(user) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TOKEN_VALID } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TOKEN_INVALID } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora agregue un m√©todo para enviar un correo electr√≥nico con un enlace de confirmaci√≥n a </font></font><code>EmailServiceImpl</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EmailServiceImpl.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"> <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${host.url}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> hostUrl: String <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userDetailsService: UserDetailsServiceImpl ... <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendRegistrationConfirmationEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> token = UUID.randomUUID().toString() userDetailsService.createVerificationTokenForUser(token, user) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> link = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$hostUrl</span></span></span><span class="hljs-string">/?token=</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$token</span></span></span><span class="hljs-string">&amp;confirmRegistration=true"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> msg = <span class="hljs-string"><span class="hljs-string">"&lt;p&gt;Please, follow the link to complete your registration:&lt;/p&gt;&lt;p&gt;&lt;a href=\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$link</span></span></span><span class="hljs-string">\"&gt;</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$link</span></span></span><span class="hljs-string">&lt;/a&gt;&lt;/p&gt;"</span></span> user.email?.let{sendHtmlMessage(user.email!!, <span class="hljs-string"><span class="hljs-string">"KSVG APP: Registration Confirmation"</span></span>, msg)} }</code> </pre><br></div></div><br>  <u>Nota:</u> <br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Recomendar√≠a almacenar la URL del host en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">application.properties</font></font></i> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En nuestro enlace, pasamos dos par√°metros GET ( </font></font><code>token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>confirmRegistration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) a la direcci√≥n donde se implementa la aplicaci√≥n. </font><font style="vertical-align: inherit;">M√°s adelante explicar√© por qu√©.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Modificamos el controlador de registro de la siguiente manera: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos los nuevos usuarios establecer√°n el valor </font></font><code>false</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">del campo.</font></font><code>isEnabled</code> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Despu√©s de crear una nueva cuenta, le enviaremos un correo electr√≥nico para confirmar el registro </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crear un controlador de validaci√≥n de token separado </font></font></li><li> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> durante la autorizaci√≥n verificaremos si la cuenta est√° verificada:</font></font></li></ul><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">AuthController.kt</font></font></b> <div class="spoiler_text"><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.kotlinspringvue.backend.controller <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.email.EmailService <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.validation.Valid <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.util.stream.Collectors <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Autowired <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.HttpStatus <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.http.ResponseEntity <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.authentication.AuthenticationManager <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.context.SecurityContextHolder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.crypto.password.PasswordEncoder <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.GrantedAuthority <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.security.core.authority.SimpleGrantedAuthority <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.ui.Model <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.model.LoginUser <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.model.NewUser <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.web.response.SuccessfulSigninResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.web.response.ResponseMessage <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.jpa.User <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.repository.UserRepository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.repository.RoleRepository <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.jwt.JwtProvider <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.ReCaptchaService <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsService <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.beans.factory.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.Value <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.context.ApplicationEventPublisher <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.bind.<span class="hljs-keyword"><span class="hljs-keyword">annotation</span></span>.* <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.springframework.web.context.request.WebRequest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.io.UnsupportedEncodingException <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.Cookie <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletRequest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> javax.servlet.http.HttpServletResponse <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsServiceImpl.Companion.TOKEN_VALID <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsServiceImpl.Companion.TOKEN_INVALID <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> com.kotlinspringvue.backend.service.UserDetailsServiceImpl.Companion.TOKEN_EXPIRED <span class="hljs-meta"><span class="hljs-meta">@RestController</span></span> <span class="hljs-meta"><span class="hljs-meta">@RequestMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/api/auth"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthController</span></span></span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.authCookieName}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authCookieName: String <span class="hljs-meta"><span class="hljs-meta">@Value(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\${ksvg.app.isCookieSecure}"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isCookieSecure: <span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span> = <span class="hljs-literal"><span class="hljs-literal">true</span></span> <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authenticationManager: AuthenticationManager <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userRepository: UserRepository <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> roleRepository: RoleRepository <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> encoder: PasswordEncoder <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jwtProvider: JwtProvider <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> captchaService: ReCaptchaService <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userService: UserDetailsService <span class="hljs-meta"><span class="hljs-meta">@Autowired</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> emailService: EmailService <span class="hljs-meta"><span class="hljs-meta">@PostMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/signin"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">authenticateUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Valid</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loginRequest: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">LoginUser</span></span></span></span><span class="hljs-function"><span class="hljs-params">, response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">HttpServletResponse</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userCandidate: Optional &lt;User&gt; = userRepository.findByUsername(loginRequest.username!!) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(loginRequest.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (userCandidate.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User = userCandidate.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!user.enabled) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Account is not verified yet! Please, follow the link in the confirmation email."</span></span>), HttpStatus.UNAUTHORIZED) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authentication = authenticationManager.authenticate( UsernamePasswordAuthenticationToken(loginRequest.username, loginRequest.password)) SecurityContextHolder.getContext().setAuthentication(authentication) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> jwt: String = jwtProvider.generateJwtToken(user.username!!) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> cookie: Cookie = Cookie(authCookieName, jwt) cookie.maxAge = jwtProvider.jwtExpiration!! cookie.secure = isCookieSecure cookie.isHttpOnly = <span class="hljs-literal"><span class="hljs-literal">true</span></span> cookie.path = <span class="hljs-string"><span class="hljs-string">"/"</span></span> response.addCookie(cookie) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> authorities: List&lt;GrantedAuthority&gt; = user.roles!!.stream().map({ role -&gt; SimpleGrantedAuthority(role.name)}).collect(Collectors.toList&lt;GrantedAuthority&gt;()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity.ok(SuccessfulSigninResponse(user.username, authorities)) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"User not found!"</span></span>), HttpStatus.BAD_REQUEST) } } <span class="hljs-meta"><span class="hljs-meta">@PostMapping(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/signup"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">registerUser</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@Valid</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-params"><span class="hljs-meta">@RequestBody</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newUser: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">NewUser</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: ResponseEntity&lt;*&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userCandidate: Optional &lt;User&gt; = userRepository.findByUsername(newUser.username!!) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!captchaService.validateCaptcha(newUser.recaptchaToken!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Validation failed (ReCaptcha v2)"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!userCandidate.isPresent) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (usernameExists(newUser.username!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Username is already taken!"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (emailExists(newUser.email!!)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ResponseEntity(ResponseMessage(<span class="hljs-string"><span class="hljs-string">"Email is already in use!"</span></span>), HttpStatus.BAD_REQUEST) } <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Creating user's account val user = User( 0, newUser.username!!, newUser.firstName!!, newUser.lastName!!, newUser.email!!, encoder.encode(newUser.password), false ) user.roles = Arrays.asList(roleRepository.findByName("ROLE_USER")) val registeredUser = userRepository.save(user) emailService.sendRegistrationConfirmationEmail(registeredUser) } catch (e: Exception) { return ResponseEntity(ResponseMessage("Server error. Please, contact site owner"), HttpStatus.SERVICE_UNAVAILABLE) } return ResponseEntity(ResponseMessage("Please, follow the link in the confirmation email to complete the registration."), HttpStatus.OK) } else { return ResponseEntity(ResponseMessage("User already exists!"), HttpStatus.BAD_REQUEST) } } @PostMapping("/registrationConfirm") @CrossOrigin(origins = ["*"]) @Throws(UnsupportedEncodingException::class) fun confirmRegistration(request: HttpServletRequest, model: Model, @RequestParam("token") token: String): ResponseEntity&lt;*&gt; { when(userService.validateVerificationToken(token)) { TOKEN_VALID -&gt; return ResponseEntity.ok(ResponseMessage("Registration confirmed")) TOKEN_INVALID -&gt; return ResponseEntity(ResponseMessage("Token is invalid!"), HttpStatus.BAD_REQUEST) TOKEN_EXPIRED -&gt; return ResponseEntity(ResponseMessage("Token is invalid!"), HttpStatus.UNAUTHORIZED) } return ResponseEntity(ResponseMessage("Server error. Please, contact site owner"), HttpStatus.SERVICE_UNAVAILABLE) } @PostMapping("/logout") fun logout(response: HttpServletResponse): ResponseEntity&lt;*&gt; { val cookie: Cookie = Cookie(authCookieName, null) cookie.maxAge = 0 cookie.secure = isCookieSecure cookie.isHttpOnly = true cookie.path = "/" response.addCookie(cookie) return ResponseEntity.ok(ResponseMessage("Successfully logged")) } private fun emailExists(email: String): Boolean { return userRepository.findByUsername(email).isPresent } private fun usernameExists(username: String): Boolean { return userRepository.findByUsername(username).isPresent } }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora trabajemos en la interfaz: </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 1</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Crear componente </font></font><code>RegistrationConfirmPage.vue</code> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 2</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Agregue una nueva ruta </font></font><code>router.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">con el par√°metro </font></font><code>:token</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">path</span></span>: <span class="hljs-string"><span class="hljs-string">'/registration-confirm/:token'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'RegistrationConfirmPage'</span></span>, <span class="hljs-attr"><span class="hljs-attr">component</span></span>: RegistrationConfirmPage }</code> </pre><br> <b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actualizaci√≥n n </font></font><code>SignUp.vue</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><b><font style="vertical-align: inherit;">¬∞ 3</font></b><font style="vertical-align: inherit;"> : despu√©s de enviar correctamente los datos de los formularios, les informaremos que para completar el registro, debe seguir el enlace en la carta. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 4 </font></font></b> <u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Importante:</font></font></u><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> lamentablemente, no podemos proporcionar un enlace fijo a un componente separado que valide el token e informe el √©xito o el fracaso. </font><font style="vertical-align: inherit;">De todos modos, los enlaces con barras diagonales nos llevar√°n a la p√°gina original de la aplicaci√≥n. </font><font style="vertical-align: inherit;">Pero podemos decirle a nuestra aplicaci√≥n sobre la necesidad de confirmar el registro utilizando el par√°metro GET transmitido </font></font><code>confirmRegistration</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="javascript hljs">methods: { confirmRegistration() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$route.query.confirmRegistration === <span class="hljs-string"><span class="hljs-string">'true'</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$route.query.token != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$router.push({<span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'RegistrationConfirmPage'</span></span>, <span class="hljs-attr"><span class="hljs-attr">params</span></span>: { <span class="hljs-attr"><span class="hljs-attr">token</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.$route.query.token}}); } }, ... mounted() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.confirmRegistration(); }</code> </pre><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"># 5</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Creemos un componente que realice la validaci√≥n de token e informe sobre el resultado de la validaci√≥n:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RegistrationConfirmPage.vue</font></font></b> <div class="spoiler_text"><pre> <code class="javascript hljs">&lt;template&gt; &lt;div id="registration-confirm"&gt; &lt;div class="confirm-form"&gt; &lt;b-card title="Confirmation" tag="article" style="max-width: 20rem;" class="mb-2" &gt; &lt;div v-if="isSuccess"&gt; &lt;p class="success"&gt;Account is successfully verified!&lt;/p&gt; &lt;router-link to="/login"&gt; &lt;b-button variant="primary"&gt;Login&lt;/b-button&gt; &lt;/router-link&gt; &lt;/div&gt; &lt;div v-if="isError"&gt; &lt;p class="fail"&gt;Verification failed:&lt;/p&gt; &lt;p&gt;{{ errorMessage }}&lt;/p&gt; &lt;/div&gt; &lt;/b-card&gt; &lt;/div&gt; &lt;/div&gt; &lt;/template&gt; &lt;script&gt; import {AXIOS} from './http-common' export default { name: 'RegistrationConfirmPage', data() { return { isSuccess: false, isError: false, errorMessage: '' } }, methods: { executeVerification() { AXIOS.post(`/auth/registrationConfirm`, null, {params: { 'token': this.$route.params.token}}) .then(response =&gt; { this.isSuccess = true; console.log(response); }, error =&gt; { this.isError = true; this.errorMessage = error.response.data.message; }) .catch(e =&gt; { console.log(e); this.errorMessage = 'Server error. Please, report this error website owners'; }) } }, mounted() { this.executeVerification(); } } &lt;/script&gt; &lt;style scoped&gt; .confirm-form { margin-left: 38%; margin-top: 50px; } .success { color: green; } .fail { color: red; } &lt;/style&gt;</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resultado</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/0n/vj/os/0nvjosmit-f6n538uae6rsvwujo.png"><br></div></div><br><h3>  En lugar de una conclusi√≥n </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En conclusi√≥n de este material, me gustar√≠a hacer una digresi√≥n y decir que el concepto mismo de la aplicaci√≥n discutida en este y en el art√≠culo anterior no era nuevo al momento de la redacci√≥n. </font><font style="vertical-align: inherit;">Tarea crear r√°pidamente una pila completa de aplicaciones en la primavera de arranque utilizando modernas JavaScript marcos angular / React / Vue.js resuelve elegantemente </font></font><a href="https://www.jhipster.tech/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">inconformista</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, las ideas descritas en este art√≠culo bien pueden implementarse incluso utilizando JHipster, por lo que espero que los lectores que vengan a este lugar encuentren este material √∫til incluso como alimento para el pensamiento.</font></font><br><br><a name="links"></a><br><h2>  Enlaces utiles </h2><br><ul><li> <a href="https://github.com/DrLeprechaun/kotlin-spring-vue" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositorio de GitHub (hasta el paso "Migrar a Gradle")</font></font></a> </li><li> <a href="https://github.com/DrLeprechaun/kotlin-spring-vue-gradle" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repositorio de GitHub (despu√©s del paso "Migrar a Gradle")</font></font></a> </li><li> <a href="https://kotlin-spring-vue-demo.herokuapp.com/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n (hasta el paso "Migrar a Gradle")</font></font></a> </li><li> <a href="https://kotlin-spring-vue-gradle-demo.herokuapp.com/" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aplicaci√≥n (despu√©s del paso "Migraci√≥n a Gradle")</font></font></a> </li><li> <a href="https://vaadimblog.blogspot.com/p/kotlin-spring-boot-vuejs.html" rel="nofollow">  ,   ,    </a> </li><li> <a href="https://itnext.io/how-to-use-google-recaptcha-with-vuejs-7756244400da" rel="nofollow">How to use Google reCaptcha with Vuejs</a> </li><li> <a href="https://vuejsexamples.com/google-recaptcha-component-for-vue-js/" rel="nofollow">Google ReCAPTCHA component for Vue.js</a> </li><li> <a href="https://www.baeldung.com/spring-email" rel="nofollow">Guide to Spring Email</a> </li><li> <a href="https://medium.com/%40raviswapna1/send-email-using-spring-boot-and-thymeleaf-b0f62786bd8e" rel="nofollow">Send Email using Spring Boot and Thymeleaf</a> </li><li> <a href="https://docs.gradle.org/5.6.3/userguide/migrating_from_maven.html" rel="nofollow">Migrating Builds From Apache Maven</a> </li><li> <a href="https://guides.gradle.org/migrating-build-logic-from-groovy-to-kotlin/" rel="nofollow">Migrating build logic from Groovy to Kotlin</a> </li><li> <a href="https://ordina-jworks.github.io/architecture/2018/10/12/spring-boot-angular-gradle.html" rel="nofollow">Integrate Angular in Spring Boot Using Gradle</a> </li><li> <a href="https://devcenter.heroku.com/articles/getting-started-with-gradle-on-heroku" rel="nofollow">Getting Started with Gradle on Heroku</a> </li><li> <a href="https://devcenter.heroku.com/articles/deploying-gradle-apps-on-heroku" rel="nofollow">Deploying Gradle Apps on Heroku</a> </li><li> <a href="https://devcenter.heroku.com/articles/deploying-gradle-apps-on-heroku" rel="nofollow">Deploying multi-project builds</a> </li><li> <a href="https://www.rdegges.com/2018/please-stop-using-local-storage/" rel="nofollow">Please Stop Using Local Storage</a> </li><li> <a href="https://medium.com/%40jcbaey/authentication-in-spa-reactjs-and-vuejs-the-right-way-e4a9ac5cd9a3" rel="nofollow">Authentication in SPA (ReactJS and VueJS) the right way</a> </li><li> <a href="https://www.ninjadevcorner.com/2018/09/stateless-authentication-jwt-secure-spring-boot-rest-api.html" rel="nofollow">Stateless Authentication using JWT to secure a Spring Boot REST API</a> </li><li> <a href="https://www.baeldung.com/registration-verify-user-by-email" rel="nofollow">Registration ‚Äì Activate a New Account by Email</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/482222/">https://habr.com/ru/post/482222/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../482210/index.html">Bot para Tetris y animaci√≥n de ingenier√≠a inversa. An√°lisis de la pista m√≥vil del segundo campeonato de programaci√≥n.</a></li>
<li><a href="../482212/index.html">Hablar de ... queso?</a></li>
<li><a href="../482216/index.html">23 respuestas a la depresi√≥n de un psiquiatra profesional Maxim Malyavin (dpmmax)</a></li>
<li><a href="../482218/index.html">Java Digest para el 27 de diciembre</a></li>
<li><a href="../482220/index.html">Localizaci√≥n de marcador de Aruco</a></li>
<li><a href="../482224/index.html">Cuando un dise√±ador necesita ser un peque√±o programador</a></li>
<li><a href="../482226/index.html">Las 20 mejores aplicaciones que un proveedor de atenci√≥n m√©dica no puede perderse</a></li>
<li><a href="../482228/index.html">Escribimos una "calculadora" en C #. Parte I. C√°lculo del valor, derivada, simplificaci√≥n y otros gansos.</a></li>
<li><a href="../482230/index.html">La batalla de los servidores WEB. Parte 2: escenario realista de HTTPS:</a></li>
<li><a href="../482232/index.html">StackOverflow es m√°s que un simple dep√≥sito de respuestas a preguntas est√∫pidas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>