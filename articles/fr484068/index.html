<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìØ üëáüèΩ ‚úçüèª gRPC comme protocole de communication interservices. Rapport Yandex üôåüèΩ ‚§¥Ô∏è üàöÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="gRPC est un framework open source pour l'appel de proc√©dure √† distance. Dans Yandex.Market, gRPC est utilis√© comme une alternative plus pratique √† RES...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>gRPC comme protocole de communication interservices. Rapport Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/484068/"> gRPC est un framework open source pour l'appel de proc√©dure √† distance.  Dans Yandex.Market, gRPC est utilis√© comme une alternative plus pratique √† REST.  Sergey Fedoseenkov, qui dirige le service de d√©veloppement d'outils pour les partenaires du march√©, a partag√© son exp√©rience de l'utilisation de gRPC comme protocole pour cr√©er des int√©grations entre Java et les services C ++.  √Ä partir du rapport, vous apprendrez comment √©viter les probl√®mes courants si vous commencez √† utiliser gRPC apr√®s REST, comment renvoyer les erreurs, impl√©menter le tra√ßage, d√©boguer les requ√™tes et tester les appels des clients.  <a href="https://habr.com/ru/company/yandex/blog/484068">√Ä la fin,</a> il y a un enregistrement non officiel du rapport. <br><br>  - Tout d'abord, je voudrais vous pr√©senter quelques faits sur Yandex.Market, ils seront utiles dans le cadre du rapport.  Premier fait: nous √©crivons des services dans diff√©rentes langues.  Cela impose aux clients des exigences en mati√®re de services. <br><a name="habracut"></a><br>  Et si nous avons un service en Java, ce serait bien si le client √©tait, par exemple, √©galement un plus ou un petit. <br><br><img src="https://habrastorage.org/webt/fk/km/ek/fkkmekzj1zv6uobtlxcypvjb5bq.jpeg"><br><br>  Tous les services que nous avons sont ind√©pendants, il n'y a pas de grandes sorties pr√©vues de l'ensemble du march√©.  Les microservices seront publi√©s ind√©pendamment, et la compatibilit√© descendante est importante pour nous ici, afin que le protocole le prenne en charge. <br><br>  Le troisi√®me fait: nous avons une int√©gration synchrone et asynchrone.  Dans le rapport, je parlerai principalement de synchrone. <br><br>  Qu'avons-nous utilis√©?  Maintenant, bien s√ªr, la base de nos int√©grations est REST ou des services de type REST qui √©changent XML / JSON sur HTTP 1.1.  Il existe √©galement XML-RPC - nous l'utilisons principalement lors de l'int√©gration avec du code Python, c'est-√†-dire que Python a un serveur XML-RPC int√©gr√©.  Il est suffisamment pratique pour le d√©ployer l√†-bas, et nous le soutenons. <br><br>  Nous avions une fois CORBA.  Heureusement, nous l'avons abandonn√©.  D√©sormais principalement REST et XML / JSON sur HTTP. <br><br><img src="https://habrastorage.org/webt/mw/we/q6/mwweq653dwqkzn9afcvtqt3temm.jpeg"><br><br>  Les int√©grations synchrones ont des probl√®mes avec les protocoles existants.  Nous rencontrons de tels probl√®mes et essayons de les traiter avec gRPC.  Quels sont ces probl√®mes?  Comme je l'ai dit, je veux avoir des clients dans diff√©rentes langues.  Il est conseill√© de ne pas encore les r√©diger par nous-m√™mes.  Et, en g√©n√©ral, ce serait cool si le client pouvait √™tre √† la fois synchrone et asynchrone - selon les objectifs de l'utilisateur du service. <br><br>  Je voudrais √©galement que le protocole que nous utilisons pour prendre en charge la r√©trocompatibilit√© soit assez bien: c'est tr√®s important avec les versions ind√©pendantes parall√®les.  Toutes nos versions sont r√©trocompatibles, nous ne cassons pas les commentaires.  Si vous l'avez cass√©, c'est un bug, et il vous suffit de le corriger le plus t√¥t possible. <br><br>  Une approche coh√©rente de la gestion des erreurs est √©galement n√©cessaire: tous ceux qui ont cr√©√© des services REST savent que vous ne pouvez pas simplement utiliser le statut HTTP.  Ils ne permettent g√©n√©ralement pas une description d√©taill√©e du probl√®me, vous devez entrer certains de leurs statuts, leurs d√©tails.  Dans les services REST, chacun introduit sa propre impl√©mentation de ces erreurs, chaque fois que vous devez travailler diff√©remment avec cela.  Ce n'est pas toujours pratique. <br><br>  J'aimerais √©galement avoir la gestion des d√©lais d'attente c√¥t√© client.  Encore une fois, ceux qui travaillent avec HTTP comprennent que si nous d√©finissons un d√©lai d'expiration c√¥t√© client et qu'il expire, le client cessera d'attendre la fin de la demande, mais le serveur n'en saura rien et continuera √† l'ex√©cuter.  De plus, au milieu, il existe plusieurs procurations qui d√©finissent des d√©lais globaux.  Et le client peut tout simplement ne rien savoir √† leur sujet et les configurer n'est pas toujours trivial. <br><br>  Et enfin, le probl√®me de la documentation.  Il n'est pas toujours clair o√π obtenir la documentation pour les ressources REST ou pour certaines m√©thodes, quels param√®tres ils acceptent, quel corps peut √™tre transf√©r√© et comment communiquer cette documentation avec les consommateurs du service.  Il est clair qu'il y a Swagger, mais avec lui aussi, tout n'est pas anodin. <br><br><h3>  gRPC  Th√©orie </h3><br>  Je voudrais parler de la partie th√©orique de gRPC - ce que c'est, quelles sont les id√©es.  Et puis nous passerons √† la pratique. <br><br><img src="https://habrastorage.org/webt/4t/ly/cn/4tlycnzym8eeecxp8_-j2fwedwe.jpeg"><br><br>  En g√©n√©ral, gRPC est une sp√©cification abstraite.  Il d√©crit un RPC abstrait (appel de proc√©dure distante), c'est-√†-dire un appel de proc√©dure distante qui poss√®de certaines propri√©t√©s.  Nous allons maintenant les √©num√©rer.  La premi√®re propri√©t√© est la prise en charge des appels uniques et du streaming.  Autrement dit, tous les services qui impl√©mentent cette sp√©cification prennent en charge les deux options.  L'√©l√©ment suivant est la disponibilit√© des m√©tadonn√©es, c'est-√†-dire que, avec la charge utile, vous pouvez transmettre une sorte de m√©tadonn√©es - conditionnellement, les en-t√™tes.  Et - prise en charge de l'annulation d'une demande et des d√©lais d'attente hors de la bo√Æte. <br><br>  Il suppose √©galement que la description des messages et des services eux-m√™mes est effectu√©e via un certain langage de d√©finition d'interface ou IDL.  La sp√©cification d√©crit √©galement le protocole filaire sur HTTP / 2, c'est-√†-dire que gRPC suppose qu'il ne fonctionne que sur HTTP / 2. <br><br><img src="https://habrastorage.org/webt/e0/s9/5n/e0s95ncgptmoczazqnei0yns3b4.jpeg"><br><br>  Il existe une impl√©mentation gRPC typique qui est utilis√©e dans la plupart des cas.  Nous l'utilisons √©galement, et maintenant nous le verrons.  Le format proto est utilis√© comme IDL.  Le plugin gRPC pour le compilateur proto vous permet d'obtenir les sources des services g√©n√©r√©s √† partir de la description proto.  Et il existe des biblioth√®ques d'ex√©cution dans diff√©rents langages - Java, C ++, Python.  En g√©n√©ral, presque toutes les langues populaires sont prises en charge, des biblioth√®ques d'ex√©cution existent pour elles.  Et comme les messages √©chang√©s entre les services, un message proto est utilis√©, des messages stylis√©s selon le sch√©ma protobuf. <br><br><img src="https://habrastorage.org/webt/wy/zp/bh/wyzpbhu3uhozqntsux32nyvpejw.jpeg"><br><br>  Je veux plonger un peu dans certaines fonctionnalit√©s sp√©cifiques.  Les voici.  Un typage fort, c'est-√†-dire un message proto, est un message fortement typ√©.  Ceux qui ont d√©j√† travaill√© avec protobuf savent que vous pouvez d√©crire les champs de votre message avec des types.  Les types existent √† la fois des tableaux d'octets primitifs et de cha√Æne.  Ils peuvent √™tre scalaires, vectoriels.  Et, en fait, les messages peuvent, en tant que champ, contenir d'autres messages, ce qui est assez pratique, en g√©n√©ral, n'importe quel mod√®le peut √™tre repr√©sent√©. <br><br><img src="https://habrastorage.org/webt/29/oz/e6/29oze6gv_s9vazqemxztvqyrrbs.jpeg"><br><br>  √Ä propos de la compatibilit√© descendante.  Je voudrais noter que proto IDL est un format dans lequel la compatibilit√© descendante est mise en place, c'est-√†-dire qu'il a √©t√© con√ßu avec un arri√©r√© de compatibilit√© descendante, et Google a publi√© une version de proto3, qui, par rapport √† proto2, am√©liore encore plus la compatibilit√© descendante.  L√†, en plus, il y a toutes sortes de sp√©cifications, comment et ce qui peut √™tre chang√© pour que la compatibilit√© ascendante soit pr√©serv√©e dans certains cas non triviaux. <br><br>  Il existe une possibilit√© de valeurs par d√©faut, vous pouvez ajouter de nouveaux champs et le consommateur n'a en fait rien √† changer.  Tous les champs de proto3 sont facultatifs et, par exemple, peuvent √™tre supprim√©s, et l'acc√®s au champ distant ne provoque pas d'erreurs sur le client. <br><br><img src="https://habrastorage.org/webt/dl/ws/kh/dlwskhpcodspqbqkwe-q1ihxaas.jpeg"><br><br>  Une autre fonctionnalit√© gRPC est que le client et le serveur sont g√©n√©r√©s √† l'aide du compilateur proto et du plugin gRPC bas√© sur la description proto.  Il est possible au moment de l'√©criture du code de choisir le client √† utiliser.  Autrement dit, choisissez un client asynchrone ou synchrone, selon le type de code que vous √©crivez.  Par exemple, un client asynchrone convient tr√®s bien au code r√©actif.  Et cette opportunit√© est pour n'importe quelle langue.  Autrement dit, une fois que vous √©crivez une proto-description, apr√®s cela, vous pouvez g√©n√©rer un client pour n'importe quelle langue, et vous n'avez pas besoin de les d√©velopper s√©par√©ment d'une mani√®re ou d'une autre.  Vous pouvez distribuer l'interface de votre service simplement comme une proto-description.  Tout consommateur peut g√©n√©rer un client pour lui-m√™me. <br><br><img src="https://habrastorage.org/webt/ny/at/qr/nyatqr7l4jcnnxrzwudubg0u_wc.jpeg"><br><br>  Concernant l'annulation de la demande et les d√©lais, je voudrais noter que la demande peut √™tre annul√©e sur le serveur et sur le client.  Si nous comprenons que tout, nous n'avons plus besoin de r√©pondre √† la demande, nous pouvons l'annuler.  Il est possible de d√©finir un d√©lai d'attente sur demande.  Dans gRPC, la plupart des biblioth√®ques d'ex√©cution utilisent un d√©lai comme concept de d√©lai d'expiration.  Mais en fait c'est la m√™me chose.  Autrement dit, c'est le moment o√π la demande doit se terminer. <br><br>  Et la chose la plus int√©ressante est que le serveur peut se renseigner √† la fois sur l'annulation de la demande et sur l'expiration du d√©lai d'attente et arr√™ter d'ex√©cuter la demande de son c√¥t√©.  C'est tr√®s cool, il me semble qu'il n'y a pas grand-chose ailleurs. <br><br>  Concernant la documentation, je voulais noter que puisque le format proto est utilis√© dans l'IDL pour gRPC, c'est du code normal.  Vous pouvez y r√©diger des commentaires, y compris des commentaires tr√®s d√©taill√©s.  Et vous devez comprendre que pour s'int√©grer √† votre service, vos utilisateurs doivent avoir ce proto-format chez eux, et il les recevra avec des commentaires, ils ne mentiront pas ailleurs.  C'est tr√®s pratique.  Et vous pouvez d√©velopper cette description, c'est-√†-dire que c'est une fonctionnalit√© si pratique que la documentation va √† c√¥t√© du code, tout comme elle peut se trouver √† c√¥t√© des m√©thodes sous la forme de javadoc ou de tout autre commentaire. <br><br><h3>  Appel unaire gRPC.  Pratique </h3><br>  Passons √† autre chose, regardons un peu de pratique.  Et l'exemple le plus √©l√©mentaire de l'utilisation de gRPC est le soi-disant appel unaire, ou appel unique.  Il s'agit d'un sch√©ma classique - nous envoyons une demande au serveur et obtenons une r√©ponse du serveur.  Il semble que cela fonctionne en HTTP. <br><br><img src="https://habrastorage.org/webt/dd/lh/kd/ddlhkdqueihh4_s65obi4t9qxns.jpeg"><br><br>  Prenons l'exemple du service d'√©cho que nous faisons.  Le serveur sera √©crit en plus, le client en Java.  Le circuit d'√©quilibrage classique a √©t√© utilis√© ici.  Autrement dit, le client adresse l'√©quilibreur, puis l'√©quilibreur s√©lectionne d√©j√† un backend sp√©cifique pour traiter la demande. <br><br>  Je voulais faire attention - puisque gRPC fonctionne sur HTTP / 2, une connexion TCP est utilis√©e.  Et en outre, divers flux la traversent.  Ici, vous pouvez voir que la connexion entre le client et l'√©quilibreur est √©tablie une fois et reste persistante, puis l'√©quilibreur √©quilibre la charge sur diff√©rents backends pour chaque appel.  Si vous regardez, √ßa se passe comme √ßa et comme √ßa si les messages sont distribu√©s. <br><br><img src="https://habrastorage.org/webt/yc/tn/fe/yctnfe9-06tb1-en3lvbxlmqbsu.jpeg"><br><br>  Voici un exemple de code pour notre fichier proto.  Vous pouvez remarquer que nous d√©crivons d'abord le message, c'est-√†-dire que nous avons EchoRequest et EchoResponse.  Il n'a qu'un seul champ de cha√Æne qui stocke le message. <br><br>  La deuxi√®me √©tape, nous d√©crivons notre proc√©dure.  La proc√©dure d'entr√©e accepte EchoRequest, renvoie EchoResponse comme r√©sultat, tout est assez trivial.  Il s'agit de la description du service gRPC et des messages qui seront poursuivis. <br><br><br><img src="https://habrastorage.org/webt/yo/ti/mi/yotimiyugzrzit8vy2xdfn-yely.jpeg"><br><br>  Voyons comment cela se passe dans le cas des avantages, par exemple.  Il est assembl√© en trois √©tapes.  Dans un premier temps, notre t√¢che est de g√©n√©rer des sources de messages.  Ici, nous le faisons avec cette √©quipe.  Nous appelons le compilateur de proto, passons le proto-fichier √† l'entr√©e, indiquons o√π placer les fichiers de sortie. <br><br>  La deuxi√®me √©quipe.  Nous g√©n√©rons √©galement des services de la m√™me mani√®re.  La seule diff√©rence avec la commande pr√©c√©dente est que nous passons le plugin, et sur la base de la description, qui est au format proto, il g√©n√®re des services. <br><br>  La troisi√®me √©tape - nous collectons tout cela en un seul binaire afin que notre serveur puisse √™tre lanc√©. <br><br>  Un indicateur suppl√©mentaire est pass√© √† l'√©diteur de liens, il est appel√© r√©flexion grpc ++ _.  Je veux noter - le serveur gRPC a une telle fonctionnalit√©, la r√©flexion du serveur.  Il vous permet d'explorer le type de services, d'appels RPC et de messages du service.  Par d√©faut, il est d√©sactiv√© et vous ne pouvez acc√©der au service que si vous disposez d'un proto-format.  Mais, par exemple, pour le d√©bogage, c'est tr√®s pratique, sans le proto-format √† port√©e de main, allumez simplement le serveur avec la fonction de r√©flexion et recevez imm√©diatement les informations. <br><br><br><img src="https://habrastorage.org/webt/yl/h-/fw/ylh-fw1j3sykaipf5_4c3zvvhgi.jpeg"><br><br>  Voyons maintenant l'impl√©mentation.  La mise en ≈ìuvre est √©galement minimaliste.  Autrement dit, notre t√¢che principale est de mettre en ≈ìuvre le service d'√©cho g√©n√©r√©.  Il a une m√©thode getEcho.  Il g√©n√®re simplement des messages et les renvoie.  √âtat OK - √©tat de r√©ussite. <br><br>  Ensuite, nous cr√©ons ServerBuilder, y enregistrons notre service, que nous avons construit un peu plus haut. <br><br><br><img src="https://habrastorage.org/webt/u8/6l/yz/u86lyzlselt_gi1khgl7l5umzw8.jpeg"><br><br>  Maintenant, nous commen√ßons et attendons les demandes entrantes. <br><br><br><img src="https://habrastorage.org/webt/bd/v9/bl/bdv9blqsyc3gbw-atarolnny0ha.jpeg"><br><br><br>  Voyons maintenant le client en Java.  Nous collectons gradle.  Notre t√¢che consiste √† connecter le plugin protobuf en premier. <br><br>  Il existe un ensemble de d√©pendances de base que nous devons faire glisser pour notre service, elles sont n√©cessaires au stade de la compilation. <br><br>  Je tiens √©galement √† noter qu'il existe une biblioth√®que d'ex√©cution.  Pour Java, il utilise netty comme serveur et client, il prend en charge HTTP / 2, il est assez pratique et performant. <br><br>  Ensuite, nous configurons le compilateur de prototypes.  Le compilateur lui-m√™me n'a pas besoin d'√™tre install√© localement pour Java; il peut √™tre extrait d'artefacts. <br><br>  M√™me chose avec les plugins.  Localement pour Java, ce n'est pas n√©cessaire.  Vous pouvez faire glisser un artefact.  Et il est important de simplement le configurer de sorte que pour tous les shuffles, il soit √©galement appel√©, afin que les stubs soient g√©n√©r√©s. <br><br><br><img src="https://habrastorage.org/webt/iu/n7/v6/iun7v66-lubn0f1qrwb1napvw6s.jpeg"><br><br><br>  Passons au code Java.  Ici, nous sommes les premiers √† cr√©er le talon de notre service.  C'est notre t√¢che pour Java de fournir Channel.  Il y a un ChannelBuilder dans la biblioth√®que d'ex√©cution avec lequel nous pouvons construire ce canal.  Ici, nous avons activ√© manuellement le texte brut pour plus de simplicit√©, mais HTTP2 et gRPC chiffrent tout par d√©faut et utilisent TLS. <br><br>  Nous avons un talon de notre client, un client synchrone est g√©n√©r√© ici.  De la m√™me mani√®re, vous pouvez g√©n√©rer un client asynchrone, il existe d'autres options. <br><br>  Ensuite, nous cr√©ons notre requ√™te protobuff, c'est-√†-dire que nous construisons un message protobuff. <br><br><br><img src="https://habrastorage.org/webt/kn/qo/1u/knqo1uengqboh-vagqyfyipqvrs.jpeg"><br><br><br>  C'est tout, envoyez-le, sur notre client, nous appelons getEcho et imprimons le r√©sultat.  Tout est simple.  Comme vous pouvez le voir, un peu de code est n√©cessaire et l'int√©gration est construite. <br><br><h3>  Streaming gRPC.  Pratique </h3><br>  Voyons maintenant une chose plus avanc√©e, c'est le streaming.  Je vais vous expliquer comment cela fonctionne et plus tard, je vais vous expliquer comment l'utiliser. <br><br><img src="https://habrastorage.org/webt/ly/pu/15/lypu157vtebmx4q8sw11d70gemo.jpeg"><br><br>  Le client-serveur en streaming a une architecture similaire.  Autrement dit, nous avons une connexion persistante entre le client et l'√©quilibreur.  Alors les diff√©rences commencent.  L'essence du streaming est que le client est attach√© √† un backend final et que la connexion est enregistr√©e.  Autrement dit, cela continue comme √ßa.  Et ainsi.  Ici, je voudrais noter s√©par√©ment que l'utilisation d'un √©quilibreur n'est pas typique pour le streaming, c'est-√†-dire que vous devez comprendre que les requ√™tes de streaming peuvent √™tre assez longues.  Autrement dit, vous pouvez les ouvrir et √©changer des messages pendant longtemps.  Et ces messages passeront par l'√©quilibreur, mais, en fait, iront toujours au m√™me backend.  Et on ne sait pas tr√®s bien pourquoi cela est n√©cessaire. <br><br>  Une pratique courante est lorsqu'un service, par exemple, est purement en streaming, ou principalement en streaming, alors la d√©couverte de service est utilis√©e.  GRPC a un point d'extension o√π la d√©couverte de service peut √™tre int√©gr√©e. <br><br><img src="https://habrastorage.org/webt/dm/5f/lq/dm5flqilbfrmpdwlz-xi-0dn9nw.jpeg"><br><br>  De quoi avons-nous besoin pour mettre en ≈ìuvre des services de streaming?  Nous avons le m√™me format de proto.  Nous ajoutons un autre RPC, et ici vous pouvez remarquer que nous avons ajout√© deux mots cl√©s avant la demande et avant la r√©ponse.  Ainsi, nous d√©clarons les flux EchoRequest et EchoResponse. <br><br><br><img src="https://habrastorage.org/webt/y7/ji/8i/y7ji8idykqbfsumuuj91t1fwwde.jpeg"><br><br>  Le plus int√©ressant commence.  Notre compilation ne change en aucune fa√ßon pour que les services de streaming puissent le faire.  Notre prochaine t√¢che consiste √† remplacer notre nouvelle m√©thode dans notre service Echo, qui fonctionnera avec les flux.  Dans le cas du serveur, tout cela est un peu plus facile.  Autrement dit, nous pouvons constamment lire dans le flux et r√©pondre √† quelque chose.  Nous pouvons r√©pondre de mani√®re asynchrone.  Autrement dit, ils sont ind√©pendants, stream pour √©crire et stream pour lire, et ici tout est simple pour un sc√©nario simple. <br><br><img src="https://habrastorage.org/webt/vv/ih/as/vvihasd7g8s9s8jfxte2lgdkae0.jpeg"><br><br>  Voici la lecture maintenant, voici l'enregistrement. <br><br><br><img src="https://habrastorage.org/webt/v_/rb/l_/v_rbl_m4pyxndxrkveev_ibze2q.jpeg"><br><br>  Dans les clients Java, les choses sont un peu plus compliqu√©es.  L√†, vous ne pouvez pas utiliser d'API synchrone, c'est-√†-dire qu'elle ne fonctionne tout simplement pas avec les flux.  Et l√†, l'API asynchrone est utilis√©e.  Autrement dit, notre t√¢che consiste √† impl√©menter le mod√®le Observer.  Il y a une interface StreamObserver l√†-bas.  Il contient trois m√©thodes: onNext, onCompleted et onError.  Ici, pour plus de simplicit√©, j'ai impl√©ment√© uniquement onNext.  Il ne tremble que lorsque la r√©ponse nous vient du serveur. <br><br><br><img src="https://habrastorage.org/webt/o5/ma/2r/o5ma2rsuawum-empf1enylvayos.jpeg"><br><br>  Ici, je viens de mettre dans une file d'attente pour la messagerie entre les threads. <br><br><img src="https://habrastorage.org/webt/wt/pu/zd/wtpuzdzh5dlmkgdxqpkieddlegg.jpeg"><br><br>  Quelle est la diff√©rence?  Au lieu de blockingStub, nous cr√©ons simplement newStub.  Il s'agit d'une impl√©mentation asynchrone qui peut fonctionner uniquement avec Observer.  En fait, vous pouvez faire des appels unaires sur Observer, mais pas si pratique.  Nous, au moins, nous l'utilisons moins activement. <br><br>  Ensuite, nous construisons notre Observateur. <br><br>  Et nous faisons notre appel RPC.  Nous passons ResponseObserver √† l'entr√©e et √† la sortie, il nous envoie RequestObserver.  De plus, nous pouvons effectuer des appels sur RequestObserver, transmettant ainsi des messages au serveur.  Et notre ResponseObserver va contracter et traiter les messages. <br><br>  Voici un exemple.  Nous faisons juste un appel.  Appelez ensuite, passez la demande l√†-bas. <br><br>  Plus loin de la file d'attente, nous attendons que le serveur r√©ponde et s'imprime. <br><br><br><img src="https://habrastorage.org/webt/bg/ta/hq/bgtahqaqbyqbzp72lhix4tzsmii.jpeg"><br><br><br>  Je veux attirer l'attention sur le fait que notre t√¢che ici, en tant que personnes responsables de la mise en ≈ìuvre du streaming, est de g√©rer correctement la fermeture de ce RequestObserver.  Autrement dit, en cas d'erreur, nous devons y appeler la m√©thode onError, et en cas de r√©ussite, lorsque nous pensons que le flux peut √™tre ferm√©, nous devons appeler la m√©thode onCompleted. <br><br><img src="https://habrastorage.org/webt/js/4a/ze/js4aze1vr9sb4t9clbpq0obdywy.jpeg"><br><br>  Nous continuons.  Quelles sont les applications de streaming?  C'est une chose plus avanc√©e, pas le fait qu'elle soit directement utile √† tout le monde, mais est parfois utilis√©e.  Autrement dit, la premi√®re consiste √† t√©l√©charger et √† t√©l√©charger de grandes quantit√©s de donn√©es.  Le serveur ou le client peut produire des donn√©es dans certaines parties.  Ces portions peuvent d√©j√† en quelque sorte √™tre regroup√©es sur le client ou sur le serveur.  Autrement dit, vous pouvez d√©j√† effectuer des optimisations suppl√©mentaires ici. <br><br>  En outre, le sch√©ma de streaming est bien adapt√© pour la pouss√©e du serveur.  Vous devez comprendre que j'ai consid√©r√© l'option la plus extr√™me lorsque nous avons un streaming bidirectionnel.  Et peut-√™tre en streaming dans une seule direction.  Par exemple, du client au serveur ou du serveur au client.  Dans le cas d'un serveur √† un client, nous pouvons nous connecter √† un serveur, et il nous enverra des pushies, et pour cela, nous n'aurons pas besoin d'interroger r√©guli√®rement. <br><br>  Le prochain avantage du streaming est li√© √† une seule machine.  Comme je l'ai d√©j√† dit, une connexion de bout en bout sera √©tablie pour tous les messages √† l'int√©rieur du flux, et cette connexion sera li√©e √† une machine, et elle ne basculera certainement nulle part.  Par cons√©quent, il est possible, premi√®rement, de simplifier quelque chose, une sorte de synchronisation interserveur, et en plus, vous pouvez faire des choses transactionnelles. <br><br>  Et le streaming bidirectionnel, juste un exemple que j'ai montr√©, est la possibilit√© de cr√©er certains de mes propres protocoles.  Chose assez int√©ressante.  Nous avons des files d'attente internes dans Yandex qui utilisent simplement le streaming bidirectionnel.  Et si soudain quelqu'un a de telles t√¢ches, alors une bonne occasion de l'utiliser. <br><br>  Je veux aussi faire attention, j'ai parl√© des m√©tadonn√©es plus t√¥t.            .            . ,     -   ,      ,      .      .  gRPC    . <br><br><h3>   </h3><br>  ,      gRPC. <br><br><img src="https://habrastorage.org/webt/wl/un/lo/wlunloh9hz1t6cklr4zaqzketmm.jpeg"><br><br>     ,   .   -  .   gRPC    . , ,  ,   , ,   .   ,    runtime- .  ,   .      ,   OK,       runtime- . <br><br> ,  Java      .                    .  google.rpc.Status  3 :  ,   .     ,   .        ,    .  ‚Äî  ,      ,    . <br><br>      error details,   ,   .   : ,   , , stack traces,      .   ,    . <br><br>    ‚Äî   ,  HTTP   ,     ?       .     BadRequest   .   ,     ,      error details,   . <br><br>   .   , , BadRequest  -  (   ),     - error detail.       , ,      ,   - .    ,    . <br><br><img src="https://habrastorage.org/webt/dk/dn/zl/dkdnzlcnav_kpnc7e29mv7j5hqa.jpeg"><br><br>       .  .   ,    , ,     .   - -   ,  - - ,     ,  .       .  , , Zipkin.   ,  HTTP    ,  ‚Äî  metadata.         . <br><br>       ,   .       ,        - ,    ,    ,     . <br><br>     runtime-,           - ,   .  Java  ClientInterceptor  ServerInterceptor.  ,    ,   . ,   ,  ,       ,    ,   - . ,  - API - .    ,  ,  , ,   - .  ,     gRPC,      ,  - .       ,  ,   - , ,  ,  . <br><br><img src="https://habrastorage.org/webt/fy/8u/iz/fy8uiztm6gwxntcvzc8m0qdcply.jpeg"><br><br>   -   .     -.   Java  .       ,       ,    -  .   -  ,     . <br><br><img src="https://habrastorage.org/webt/sb/zx/th/sbzxthmnnf_fh8iyxl9ghv02s4y.jpeg"><br><br>  .   gRPC ‚Äî  . HTTP/2  .   -   ,   ?    : , .    .   ,    gRPC   grpc_cli,  curl.   ,      . , -,  .    ,    gRPC    ,       . <br><br>    ,  evans.   ,    CLI:   ,     ,  ,  .  ,   .  - , ,  ,   , ,  . <br><br>  -  UI ‚Äî ,   Postman, ‚Äî  BloomRPC.     Postman .  Postman, , ,    .   , BloomRPC ,   . <br><br>  -  ,   .  , ,     grpc_cli.          .   ,   .  ,   ,  .       ,       .  , - -  .    ‚Äî . <br><br><img src="https://habrastorage.org/webt/7y/oe/w3/7yoew3fwgydkvdgiaxm1acueyki.jpeg"><br><br> ,     ,    gRPC.       . -    , -  ,  .  Swagger. ,    HTTP/1    .     OpenAPI   ,        .       . ,        HTTP/2,  Swagger ‚Äî   . <br><br> WSDL ‚Äî  ,  .   .       Swagger,     ,   .    .   -. <br><br>  ,  , ,       ,  JAX-RS,   Java  .    . <br><br>     Twirp.  Qu'est ce que c'est     Go,     .     . ,  ,   Go ,   gRPC  Twirp.   ?  ,  gRPC ‚Äî   ,   , ,  IDL .     proto-  ,        gRPC-.      protoc,       ,       . <br><br>  Twirp     .   proto-      ,    HTTP/1.1    ,   JSON.    ,  Twirp      Go.       ,    ,   Java      Jetty.    ,    . <br><br><img src="https://habrastorage.org/webt/fn/p3/bi/fnp3bihwdt68ttten4_mpx7qal4.jpeg"><br><br>     ? gRPC ‚Äî    REST   .    ,     ,   , ,  HTTP/2 balancer.   service discovery,    . gRPC ,   .    . <br><br>      gRPC ‚Äî  ,  .   CLI,   UI. ,        . <br><br>    ,      gRPC.  inter-process-. , sidecar pattern.  ,          .      ,    . ,   -.    -     ,              ,     -.              .      ,  , ,    ,     - . <br><br> ,       .  gRPC    .   ,  .    ,   unary-.         ,      . <br><br>   : <br> ‚Äî <a href="https://grpc.io/">C  gRPC</a> ‚Äî   , .  ,    , ,      . <br> ‚Äî <a href="https://github.com/grpc-ecosystem/awesome-grpc">Awesome gRPC</a> ‚Äî   GitHub      .      ,    ,   , .  .    ‚Äî  ,  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez trouver de nombreuses autres ressources sur Internet, sur quelques diapositives. </font><font style="vertical-align: inherit;">Mais c'est ce que j'ai le plus aim√©. </font><font style="vertical-align: inherit;">Le code l√©g√®rement modifi√© de la pr√©sentation est </font></font><a href="https://github.com/homer-j/grpc-examples"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font> Je vous remercie! <br><br><a name="video1"></a><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enregistrement de rapport informel</font></font></b> <div class="spoiler_text"><iframe width="560" height="315" src="https://www.youtube.com/embed/AciUs4Yq7oU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr484068/">https://habr.com/ru/post/fr484068/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr484052/index.html">T√¢ches pour la base lunaire</a></li>
<li><a href="../fr484056/index.html">Votre projet a-t-il vraiment besoin de tests?</a></li>
<li><a href="../fr484062/index.html">Apprendre l'anglais par MEMASICS</a></li>
<li><a href="../fr484064/index.html">Comment pr√©parer un jeu pour la localisation? 10 r√®gles de base</a></li>
<li><a href="../fr484066/index.html">L'argent contre l'√©quipe. Pas les aspects les plus √©vidents de la relation entre entrepreneurs, fondateurs et investisseurs</a></li>
<li><a href="../fr484070/index.html">Comment nous avons √©crit un syst√®me antifraude √† quatre mains et trois t√™tes</a></li>
<li><a href="../fr484072/index.html">5. Mise en route de Fortinet v6.0. NAT</a></li>
<li><a href="../fr484076/index.html">O√π stocker les crypto-monnaies: taxation des crypto-monnaies dans diff√©rents pays</a></li>
<li><a href="../fr484084/index.html">1C-Bitrix et une tentative de l'introduire</a></li>
<li><a href="../fr484088/index.html">D√©fil√© de mots de passe (analyse d'environ 5 milliards de mots de passe de fuites)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>