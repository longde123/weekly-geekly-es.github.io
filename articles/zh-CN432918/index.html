<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏽‍🤝‍👨🏼 🆗 🤦🏾 抱歉，我打断了您的recovery.conf 📋 🙏🏽 👰🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在PostgreSQL中，自从很早以前就已经在2005年发布了8.0版本 ，所以使用了一个特殊的配置文件recovery.conf来还原到特定的时间点。 随后，该文件开始用于待机模式和流复制。 

 但是，自PostgreSQL 12的下一个发行版以来，recovery.conf不再起作用：我破坏了...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>抱歉，我打断了您的recovery.conf</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432918/"><img src="https://habrastorage.org/webt/fa/rt/zs/fartzsjcnmws2vzxpx4qhiw5ykq.jpeg" alt="我让你康复" align="left"> 在PostgreSQL中，自从很早以前就<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">已经</a>在2005年发布了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">8.0版本</a> ，所以使用了一个特殊的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">配置文件recovery.conf</a>来还原到特定的时间点。 随后，该文件开始用于待机模式和流复制。 <br><br> 但是，自PostgreSQL 12的下一个发行版以来，recovery.conf不再起作用：我破坏了它。 <br> 但是为什么呢？ <br><a name="habracut"></a><br>  Recovery.conf具有一个特殊性：它仅在DBMS开始时才被读取。 而且，如果仍然可以协调每年需要少于一次的时间点恢复，那么重新启动整个数据库以更改上游复制服务器的地址的需求就会有些沮丧。 我看到了不同的变态方法来规避此限制，例如使用L3路由，级联复制方案（以便分别复制所有副本，但至少只复制一部分），甚至（即使在生产中我没有看到它）。 <br><br> 在下一次计划的副本重新启动后，由于需要更改复制参数，我决定选择它，但是教PostgreSQL重新读取SIGHUP中的primary_conninfo会花费什么呢？  <s>一切都变糟了。</s> 原则上，您只需要在启动过程中更改一个变量，然后从那里请求重新启动WalReceiver-就这样，复制将正确地继续使用新地址。 仍然需要正确地实现它。 几周后，我完成了该补丁，并重新读取了SIGHUP信号上的recovery.conf，而该补丁并未破坏现有的数据库行为。 <br><br> 然后，鼓起勇气， <a href="">将他发送</a>到PostgreSQL开发人员邮件列表。 迈克尔·帕奎尔很快回答了一下： <br><blockquote> 在使其中一些可重载之前，让我们先将它们切换为GUC，而不要像补丁一样重新发明SIGHUP参数处理。 </blockquote> 糟糕，事实证明我向搜索引擎提出了错误的问题。 问题不是关于重新读取recovery.conf，而是关于将参数从单独的recovery.conf转换为用于所有其他DBMS参数的GUC基础结构（大统一配置）的问题。 也就是说，绝对不是，我们不需要这样的补丁，我们也不需要。 首先让我们将所有这些设置从recovery.conf转移到我们的标准设置基础结构中。 <br><br> 对于这个令人沮丧的消息，我发火并想到：“但是让我们转移！”。 我阅读了有关正确搜索查询的存档讨论，打开了<a href="">有关转移设置</a>的最后一个<a href="">讨论</a> （该链接由Michael Paquier在他的回答中提供，我对此表示感谢，并感谢他的快速回答）。 当时，在2018年5月，该补丁被放弃了一年多。 因此，我们从这里开始。 还是说“继续”更正确？ 根据娱乐计划： <br><br><ol><li> 阅读并列出对补丁程序最新发布版本的更改 </li><li> 解析补丁中的更改并将必要的内容转移到代码库的当前版本 </li><li> 修复文档中对recovery.conf及其参数的所有引用 </li><li> 维修测试 </li><li> 发送新补丁到邮件列表 </li><li> 得到任何反馈 </li><li> 根据意愿改正某些内容并返回第5段 </li><li> 拒绝再次接受补丁（一年半） </li></ol><br> 听起来像是一项行动计划？ 好吧，我们继续吧！ <br><br> 简短地说，我指出了多长时间，并于2018年6月21日<a href="">在新的讨论线程中</a>发布了补丁的新版本。 然后3个月，巴斯克维尔斯（Baskervilles）鱼类的寒冷使人无法忍受。  9月底，拥有承诺权的Core开发人员之一Peter Eisentraut突然对补丁产生了兴趣。 经过数次更正之后，尽管我安静地走了几天，去散步看看布达佩斯，看看风景，但彼得·艾森特劳特（Peter Eisentraut）发出了令人沮丧的信： <br><blockquote> 我浏览了补丁，做了很多小改进。 我还更广泛地更新了文档。 随附的补丁对我来说是可提交的。 </blockquote> 也就是说，Peter Eisentraut自行决定更正了一些小问题，更新了文档，刻录了整个recovery-config.sgml部分，并认为以这种形式可以接受该补丁。 哦，我认为只有在postgresql 13上才会发生，即使幸运的是该补丁通常会达到提交准备就绪的状态。 <br><br> 几天后，也就是2018年11月25日，Peter Eisentraut真正<a href="">接受了此补丁</a> ： <br><blockquote> 现在在postgresql.conf（或其他GUC来源）中设置了recovery.conf设置。 当前，所有受影响的设置均为PGC_POSTMASTER； 将来可以根据情况进行细化。 <br> 现在，恢复是通过文件recovery.signal启动的。 待机模式由文件standby.signal启动。 待机模式设置消失了。 如果找到了recovery.conf文件，则会发出错误。 <br> 作为移动的一部分，trigger_file设置已重命名为promove_trigger_file。 <br> 文档章节“恢复配置”已集成到“服务器配置”中。 <br>  pg_basebackup -R现在将设置附加到postgresql.auto.conf并创建一个standby.signal文件。 <br> 作者：藤井正雄&lt;masao（dot）fujii（at）gmail（dot）com&gt; <br> 作者：西蒙·里格斯&lt;simon（at）2ndquadrant（dot）com&gt; <br> 作者：Abhijit Menon-Sen &lt;ams（at）2ndquadrant（dot）com&gt; <br> 作者：Sergei Kornilov &lt;sk（at）zsrv（dot）org&gt; </blockquote> 两个星期过去了，此提交尚未回滚。 好厉害 看来他们甚至都不会去。 太神奇了 目前尚不知道社区是否会决定再次朝任何方向改变行为，特别是因为距离4月postgresql 12的功能冻结发布尚有一段时间。 但是似乎我们将没有更多的recovery.conf。 <br><br><h3> 所以发生了什么变化 </h3><br> 首先，最重要的是，DBMS如果找到了recovery.conf文件，则将拒绝启动-这是专门为使用户使用许多旧指令之一而感到惊讶的原因，数据库为什么会忽略此文件中的配置。 <br><br> 旧的standby_mode设置已消失。 现在，它以及存在用于启用恢复模式的recovery.conf的事实，被两个文件（任何内容，通常为空）替换： <br><br><ul><li>  $ PGDATA / recovery.signal-意识形态后继standby_mode = off，将从归档恢复到配置中指定的位置； </li><li>  $ PGDATA / standby.signal-分别为standby_mode = on。 我们将在所有副本上看到此文件。 </li></ul><br> 如果数据库的启动过程找到了两个文件，则我们认为我们处于待机模式。 <br><br> 为了清楚起见，如果为了减少参数而更改板块： <br><table><tbody><tr><th> 旧的recovery.conf <br></th><th>  PostgreSQL 12+ postgresql.conf <br></th></tr><tr><td>  primary_conninfo <br></td><td>  primary_conninfo <br></td></tr><tr><td>  primary_slot_name <br></td><td>  primary_slot_name <br></td></tr><tr><td>  trigger_file <br></td><td>  Promotion_trigger_file <br></td></tr><tr><td>  recovery_min_apply_delay <br></td><td>  recovery_min_apply_delay <br></td></tr><tr><td>  recovery_target <br></td><td>  recovery_target <br></td></tr><tr><td>  recovery_target_name <br></td><td>  recovery_target_name <br></td></tr><tr><td>  recovery_target_time <br></td><td>  recovery_target_time <br></td></tr><tr><td>  recovery_target_xid <br></td><td>  recovery_target_xid <br></td></tr><tr><td>  recovery_target_lsn <br></td><td>  recovery_target_lsn <br></td></tr><tr><td>  recovery_target_inclusive <br></td><td>  recovery_target_inclusive <br></td></tr><tr><td>  recovery_target_timeline <br></td><td>  recovery_target_timeline <br></td></tr><tr><td>  recovery_target_action <br></td><td>  recovery_target_action <br></td></tr><tr><td>  restore_command <br></td><td>  restore_command <br></td></tr><tr><td>  archive_cleanup_command <br></td><td>  archive_cleanup_command <br></td></tr><tr><td>  recovery_end_command <br></td><td>  recovery_end_command <br></td></tr></tbody></table><br> 您会看到几乎没有改变。 此刻（除了promove_trigger_file的promote_前缀唯一例外），所有新参数的命名都与旧参数一样，并且采用相同的可能值。 尽管实际上恢复目标的设置仍然存在变化。 我不知道以前是否有人使用过，但这是有记录的行为，可以同时指定多个recovery_target，recovery_target_lsn，recovery_target_name，recovery_target_time或recovery_target_xid。 举个例子 <br><br><pre><code class="plaintext hljs">recovery_target_lsn = '1/1D9FEA00' recovery_target_xid = '5238954'</code> </pre> <br> 实际上，来自recovery.conf的最后一行用于恢复。 这已不再可能，恢复目标应以最大值1表示。 但是，由于GUC基础结构的逻辑，您仍然可以多次指定相同名称的参数： <br><br><pre> <code class="plaintext hljs">recovery_target_lsn = '1/1D9FEA00' recovery_target_lsn = '1/16AC7D0'</code> </pre> <br> 这是可以接受的，我们将恢复到最后指定的设置值。 <br><br> 而且，一般而言，这就是从PostgreSQL外部可见的更改所需要说明的全部内容。  pg_basebackup -R（--write-recovery-conf）保持原样并按预期进行，只是现在它将向postgresql.auto.conf中添加参数，而不是recovery.conf并创建一个standby.signal文件 <br><br> 不幸的是，当我说这些都是当前可见的所有更改时，这正是我的意思。 所有新参数仍设置为PGC_POSTMASTER，即只能在PostgreSQL启动时更改。 如前所述，这是开发人员社区的要求：首先，转移所有设置，然后再查看是否可以在运行的数据库上对其进行更改。 因此，现在PostgreSQL处在一个奇妙的发展阶段，旧的行为已经被打破，并且还没有带来更好的改变。 <br><br> 我已经<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">发布了一个补丁</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">该补丁</a>将允许动态更改primary_conninfo和primary_slot_name。 让我们看看会发生什么。 <br><br> 抱歉，我打断了您的recovery.conf <br><br><h3>  UPD 2019年4月7日 </h3><br> 在功能冻结版本12的最后一天，您可以进行总结。 发行版中不包括更改复制设置。 当然，这也是一个奇怪的故事。 很久以前，我作为基础的Simon Riggs补丁已经包含了在更改连接设置时重新启动walreceiver的编辑。 我在单独的补丁中选择了它们，并补充了文档和测试。 经过6个补丁更新和几个月的讨论之后，一个显而易见的事实突然出现：如果重新启动walreceiver，数据库将尝试切换为从restore_command恢复文件。 由任何原因关闭walreceiver触发的状态机行为都非常简单。 但是事实证明这是“我们不想要的东西”。 好吧，更早之前无法说？ 好的，我以某种方式对其进行了重做，但是日历已经具有版本12的最终commitfest，因此没有人看到。 通常，这不是一件快速的事情，PostgreSQL中的修补程序确实可以做到。 但是，我有权利将自己包括在人员列表中，这要感谢在版本12 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">中</a>包括了<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">史诗级的未完成的未完成的REINDEX</a> ！ <br><br> 最后值得一提的是，有许多设置可以随时更改：archive_cleanup_command，promote_trigger_file，recovery_end_command，recovery_min_apply_delay </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN432918/">https://habr.com/ru/post/zh-CN432918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN432906/index.html">编辑CSV文件以免破坏数据</a></li>
<li><a href="../zh-CN432908/index.html">在俄罗斯，他们计划对互联网上的付款实行额外的控制</a></li>
<li><a href="../zh-CN432910/index.html">将虚拟现实视为换位思考的机器很危险</a></li>
<li><a href="../zh-CN432912/index.html">如何在Google实习</a></li>
<li><a href="../zh-CN432914/index.html">一个用于Telegram的非常简单的聊天机器人，最小</a></li>
<li><a href="../zh-CN432920/index.html">公司的人为因素：危险吗？</a></li>
<li><a href="../zh-CN432922/index.html">我们如何在Linux内核中寻找两周的NFS错误</a></li>
<li><a href="../zh-CN432924/index.html">跑步，壁虎，跑步：壁虎混合水运动机制</a></li>
<li><a href="../zh-CN432926/index.html">以2018年Web Summit为例，介绍24家创业公司如何在巨大的世界展览中取得成功的秘诀</a></li>
<li><a href="../zh-CN432928/index.html">英特尔正在发生什么？为何尽管头条新闻，亚马逊仍不会将AWS完全转移到其芯片上</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>