<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïµüèº üà≤ üë®üèª Sorpresa fsync () PostgreSQL ü•ß üë®üèº‚Äçüéì üéø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los desarrolladores de DBMS, por necesidad, est√°n preocupados de que los datos caigan de forma segura en un almacenamiento permanente. Por lo tanto, c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sorpresa fsync () PostgreSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472684/"><img width="50%" align="left" src="https://habrastorage.org/webt/oz/ps/ut/ozpsutp44sz5dvmpfteszdiba5o.png">  Los desarrolladores de DBMS, por necesidad, est√°n preocupados de que los datos caigan de forma segura en un almacenamiento permanente.  Por lo tanto, cuando la comunidad PostgreSQL descubri√≥ que la forma en que el n√∫cleo maneja los errores de E / S puede conducir a la p√©rdida de datos sin que se informe ning√∫n error al espacio del usuario, surgi√≥ un gran descontento.  El problema, que se ve agravado por el hecho de que PostgreSQL realiza E / S con b√∫fer, no es exclusivo de Linux y no ser√° f√°cil de resolver incluso all√≠. <br><br>  Craig Ringer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">inform√≥ por</a> primera <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">vez el problema</a> a la lista de correo pgsql-hackers a fines de marzo.  En resumen, PostgreSQL supone que una llamada <code>fsync()</code> exitosa indica que todos los datos grabados desde la √∫ltima llamada exitosa se transfirieron de forma segura al almacenamiento persistente.  Cuando falla un registro de E / S almacenado debido a un error de hardware, los sistemas de archivos reaccionan de manera diferente, pero este comportamiento generalmente implica eliminar datos en las p√°ginas correspondientes y marcarlos como limpios.  Por lo tanto, los bloques de lectura que se acaban de escribir probablemente devolver√°n algo m√°s, pero no datos grabados. <br><a name="habracut"></a><br>  ¬øQu√© pasa con el informe de errores?  Hace un a√±o, la cumbre de Linux Filesystem, Storage and Memory-Management Summit (LSFMM) incluy√≥ una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sesi√≥n de</a> informe de errores en la que todo se llam√≥ un "desastre";  los errores pueden perderse f√°cilmente, por lo que ninguna aplicaci√≥n los ver√° nunca.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Algunos parches</a> incluidos en 4.13 mejoraron un poco la situaci√≥n durante el ciclo de desarrollo (y en 4.16 hubo algunos cambios para mejorarlo a√∫n m√°s), sin embargo, hay formas de perder notificaciones de error, como se describe a continuaci√≥n.  Si esto sucede en un servidor PostgreSQL, puede provocar da√±os autom√°ticos en la base de datos. <br><br>  Los desarrolladores de PostgreSQL no estaban contentos.  Tom Lane <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">describi√≥</a> esto como " <b>da√±o cerebral al n√∫cleo</b> " <b>,</b> mientras que Robert Haas lo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">llam√≥</a> " <b>100% est√∫pido</b> ".  Al comienzo de la discusi√≥n, los desarrolladores de PostgreSQL entendieron muy claramente c√≥mo, en su opini√≥n, el n√∫cleo deber√≠a funcionar: las p√°ginas que no pod√≠an escribirse deber√≠an almacenarse en la memoria en un estado "sucio" (para intentos posteriores), y el descriptor de archivo correspondiente deber√≠a traducirse a Estado de error permanente para que el servidor PostgreSQL no pueda omitir el problema. <br><br><h4>  ¬øD√≥nde sali√≥ algo mal? </h4><br>  Sin embargo, incluso antes de que la comunidad del n√∫cleo entrara en la discusi√≥n, qued√≥ claro que la situaci√≥n no era tan simple como podr√≠a parecer.  Thomas Munro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dijo</a> que Linux no es √∫nico en este comportamiento;  OpenBSD y NetBSD tampoco pueden informar errores de escritura en el espacio del usuario.  Y, como result√≥, la forma en que PostgreSQL maneja las operaciones de E / S almacenadas en b√∫fer complica enormemente la imagen. <br><br>  Este mecanismo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><u>ha sido descrito en detalle por</u></a> Haas.  Un servidor PostgreSQL funciona como un conjunto de procesos, muchos de los cuales pueden realizar E / S en archivos de base de datos.  Sin embargo, el <code>fsync()</code> llamada <code>fsync()</code> se maneja en un solo proceso de puntero de verificaci√≥n (proceso de "puntero de verificaci√≥n"), que consiste en mantener el almacenamiento en disco en un estado consistente para recuperarse de las fallas.  Checkpointer generalmente no mantiene abiertos todos los archivos relevantes, por lo que a menudo tiene que abrir el archivo antes de llamar a <code>fsync()</code> .  Aqu√≠ es donde surge el problema: incluso en los n√∫cleos 4.13 y versiones posteriores, el puntero de control no ver√° ning√∫n error antes de que se abriera el archivo.  Si sucede algo malo antes de llamar a <code>open()</code> checkpointer-a, la siguiente llamada a <code>fsync()</code> devolver√° el √©xito.  Hay varias formas de causar un error de E / S fuera de <code>fsync()</code> ;  por ejemplo, el kernel puede encontrar uno de ellos mientras realiza una reescritura en segundo plano.  Alguien que llama a <code>sync()</code> tambi√©n puede encontrar un error de E / S y "absorber" el estado de error resultante. <br><br>  Haas describi√≥ este comportamiento como incapaz de cumplir con las expectativas de PostgreSQL: <br><blockquote>  Todo lo que usted (o alguien) tiene es b√°sicamente una suposici√≥n no comprobada de que <br>  qu√© descriptores de archivo pueden ser relevantes para un error en particular, pero sucedi√≥ que PostgreSQL nunca coincidi√≥.  Puede continuar diciendo que el problema est√° en nuestras conjeturas, pero me parece err√≥neo suponer que somos el √∫nico programa que los ha hecho. </blockquote><br>  Como resultado, Joshua Drake <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">traslad√≥ la conversaci√≥n</a> a la lista de desarrollo para ext4, incluida parte de la comunidad de desarrollo del kernel.  Dave Chinner <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">describi√≥</a> r√°pidamente este comportamiento como "una <b>receta para el desastre, especialmente en el c√≥digo multiplataforma, donde cada plataforma del sistema operativo se comporta de manera diferente y casi nunca coincide con lo que se esperaba</b> ".  En cambio, Ted Tso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">explic√≥</a> por qu√© las p√°ginas afectadas se marcan como limpias despu√©s de un error de E / S;  en resumen, la causa m√°s com√∫n de errores de E / S es cuando el usuario no retira la unidad USB a tiempo.  Si un proceso copi√≥ una gran cantidad de datos en este disco, el resultado ser√° la acumulaci√≥n de p√°ginas sucias en la memoria, posiblemente hasta el punto de que el sistema no tenga suficiente memoria para otras tareas.  Por lo tanto, estas p√°ginas no se pueden guardar y se borrar√°n si el usuario desea que el sistema siga siendo utilizable despu√©s de tal evento. <br><br>  Tanto Chinner como Tso, junto con otros, dijeron que PostgreSQL ten√≠a la soluci√≥n correcta: cambiar a E / S directa (DIO).  El uso de DIO proporciona un mayor nivel de control sobre la reescritura y la E / S en general;  Esto incluye el acceso a la informaci√≥n sobre las operaciones de E / S que pueden haber fallado.  Andres Freund, como otros desarrolladores de PostgreSQL, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reconoci√≥</a> que DIO es la mejor soluci√≥n a largo plazo.  Pero tambi√©n se√±al√≥ que no se debe esperar que los desarrolladores se sumerjan profundamente en la implementaci√≥n de esta tarea.  Mientras tanto, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dijo</a> que hay otros programas (mencion√≥ dpkg) que tambi√©n son propensos a este comportamiento. <br><br><h4>  Hacia una soluci√≥n a corto plazo </h4><br>  Durante la discusi√≥n, se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">prest√≥</a> considerable <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">atenci√≥n</a> a la idea de que una falla de escritura deber√≠a conducir al hecho de que las p√°ginas afectadas se almacenar√°n en la memoria en su estado sucio.  Pero los desarrolladores de PostgreSQL se alejaron r√°pidamente de esta idea y no la exigieron.  Lo que realmente necesitan es, en √∫ltima instancia, una forma confiable de averiguar si algo sali√≥ mal.  Con esto en mente, los mecanismos habituales de manejo de errores de PostgreSQL pueden manejar esto;  Sin embargo, poco se puede hacer en su ausencia. <br><br>  En alg√∫n momento de la discusi√≥n, Tso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mencion√≥</a> que Google tiene su propio mecanismo de manejo de errores de E / S.  El kernel recibi√≥ instrucciones de informar errores de E / S a trav√©s del socket de enlace de red;  El proceso dedicado recibe estas notificaciones y responde en consecuencia.  Sin embargo, este mecanismo nunca hizo esto en la entrada.  Freind <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se√±al√≥</a> que este mecanismo ser√≠a "ideal" para PostgreSQL, por lo que podr√≠a aparecer en el dominio p√∫blico en un futuro pr√≥ximo. <br><br>  Mientras tanto, Jeff Leighton estaba <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pensando</a> en otra idea: establecer un indicador en el superbloque del sistema de archivos cuando se produce un error de E / S.  Una llamada a <code>syncfs()</code> borrar√° este indicador y devolver√° un error si se configur√≥.  El <code>syncfs()</code> PostgreSQL puede llamar peri√≥dicamente a <code>syncfs()</code> para sondear los errores en el sistema de archivos que contiene la base de datos.  Freund <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estuvo de acuerdo en</a> que esta podr√≠a ser una soluci√≥n viable al problema. <br><br>  Por supuesto, cualquier mecanismo de este tipo aparecer√° solo en los nuevos n√∫cleos;  Mientras tanto, las instalaciones de PostgreSQL generalmente se ejecutan en n√∫cleos m√°s antiguos compatibles con distribuciones empresariales.  En estos n√∫cleos, parece que ni siquiera hay mejoras que se incluyeron en 4.13.  Para estos sistemas, se puede hacer poco para ayudar a PostgreSQL a detectar errores de E / S.  Puede ser suficiente iniciar un demonio que escanee el registro del sistema y busque mensajes de error de E / S all√≠.  No es la soluci√≥n m√°s elegante, y es complicado por el hecho de que diferentes controladores de bloques y sistemas de archivos, como regla, informan errores de diferentes maneras, pero esta puede ser la mejor opci√≥n disponible. <br><br>  Es probable que el pr√≥ximo paso sea una discusi√≥n en el evento LSFMM 2018 el 23 de abril.  Si tiene suerte, habr√° alg√∫n tipo de soluci√≥n que funcione para las partes interesadas.  Sin embargo, una cosa que no cambiar√° es el simple hecho de que el manejo de errores es dif√≠cil de hacer correctamente. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472684/">https://habr.com/ru/post/472684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472670/index.html">Limely oto√±o, Limely invierno ...</a></li>
<li><a href="../472672/index.html">El t√≠tulo "Leer art√≠culos para usted". Julio - septiembre 2019</a></li>
<li><a href="../472674/index.html">Variables de entorno para proyectos de Python</a></li>
<li><a href="../472676/index.html">Creamos el departamento de jones para ayudar a los equipos principales, utilizando solo Slack, Jira y la cinta aislante azul.</a></li>
<li><a href="../472682/index.html">Retrasando el envejecimiento con sinergias de drogas en C. elegans</a></li>
<li><a href="../472686/index.html">Video Studio basado en i486</a></li>
<li><a href="../472688/index.html">C√≥mo funciona la renderizaci√≥n de juegos en 3D: procesamiento de v√©rtices</a></li>
<li><a href="../472690/index.html">Novedades de Zabbix 4.4</a></li>
<li><a href="../472694/index.html">M√°s que Ceph: MCS Block Cloud Storage</a></li>
<li><a href="../472702/index.html">JH Rainwater "C√≥mo pastar gatos": razas de programadores y caracter√≠sticas de su cr√≠a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>