<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëéüèΩ ‚õé üôèüèº Megapack: c√≥mo los desarrolladores de Factorio lograron resolver el problema con el modo multijugador de 200 jugadores üßôüèæ üé¨ üèáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En mayo de este a√±o, particip√© como jugador en el evento KatherineOfSky MMO . Not√© que cuando el n√∫mero de jugadores alcanza un cierto n√∫mero, cada po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Megapack: c√≥mo los desarrolladores de Factorio lograron resolver el problema con el modo multijugador de 200 jugadores</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466135/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0b7/35a/156/0b735a15617cf15740ddb733b0cff066.jpg" alt="imagen"></div><br>  En mayo de este a√±o, particip√© como jugador en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">evento KatherineOfSky MMO</a> .  Not√© que cuando el n√∫mero de jugadores alcanza un cierto n√∫mero, cada pocos minutos algunos de ellos "se caen".  Afortunadamente para ti (pero no para m√≠), fui uno de esos jugadores que se desconectaba <b>todo el tiempo</b> , incluso con una buena conexi√≥n.  Tom√© esto como un desaf√≠o personal y comenc√© a buscar las causas del problema.  Despu√©s de tres semanas de depuraci√≥n, prueba y reparaci√≥n, el error finalmente se solucion√≥, pero este viaje no fue tan simple. <br><br>  Los problemas de los juegos multijugador son muy dif√≠ciles de localizar.  Por lo general, surgen en condiciones muy espec√≠ficas de par√°metros de red y en condiciones muy espec√≠ficas del juego (en este caso, la presencia de m√°s de 200 jugadores).  E incluso cuando es posible reproducir el problema, no se puede depurar correctamente, porque la inserci√≥n de puntos de control detiene el juego, confunde los temporizadores y generalmente conduce a la terminaci√≥n de la conexi√≥n debido a que excede el tiempo de espera.  Pero gracias a la terquedad y la maravillosa herramienta llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">torpe,</a> logr√© entender lo que estaba sucediendo. <br><br>  En resumen: debido a un error y una implementaci√≥n incompleta de la simulaci√≥n del estado de retraso, el cliente a veces se encuentra en una situaci√≥n en la que tiene que enviar un paquete de red en un ciclo de reloj, que consiste en las acciones del jugador para seleccionar alrededor de 400 entidades de juego (lo llamamos un "megapaquete").  Despu√©s de eso, el servidor no solo debe recibir correctamente todas estas acciones de entrada, sino tambi√©n enviarlas a todos los dem√°s clientes.  Si tiene 200 clientes, esto se convierte r√°pidamente en un problema.  El canal hacia el servidor se obstruye r√°pidamente, lo que conduce a la p√©rdida de paquetes y a una cascada de paquetes solicitados nuevamente.  Posponer acciones de entrada lleva al hecho de que incluso m√°s clientes comienzan a enviar megapaquetes, y su avalancha se vuelve a√∫n m√°s fuerte.  Los clientes exitosos logran recuperarse, todo lo dem√°s "se cae". <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f21/a49/50e/f21a4950e42bd555a91ad923e5067ea6.jpg" alt="imagen"></div><br>  El problema era bastante fundamental, y me tom√≥ 2 semanas solucionarlo.  Es bastante t√©cnico, as√≠ que a continuaci√≥n explicar√© los detalles t√©cnicos jugosos.  Pero primero debe saber que desde la versi√≥n 0.17.54, lanzada el 4 de junio, ante problemas de conexi√≥n temporales, el modo multijugador se ha vuelto m√°s estable, y la ocultaci√≥n de retrasos es mucho menos problem√°tica (menos frenado y teletransportaci√≥n).  Adem√°s, cambi√© la forma de ocultar los retrasos en el combate y espero que gracias a esto sean un poco m√°s suaves. <br><br><h3>  Megapack multiusuario - Detalles t√©cnicos </h3><br>  En t√©rminos simples, el multijugador en el juego funciona de la siguiente manera: todos los clientes simulan el estado del juego, recibiendo y enviando solo la entrada del jugador (llamada "Acciones de entrada", <i>Acciones de entrada</i> ).  La tarea principal del servidor es transmitir <i>acciones de entrada</i> y controlar que todos los clientes realicen las mismas acciones en un ciclo.  Lea m√°s sobre esto en el post <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">FFF-149</a> . <br><br>  Dado que el servidor debe tomar decisiones sobre qu√© acciones realizar, las acciones del jugador se mueven a lo largo de este camino: acci√≥n del jugador -&gt; cliente del juego -&gt; red -&gt; servidor -&gt; red -&gt; cliente del juego.  Esto significa que la acci√≥n de cada jugador se realiza solo despu√©s de que realiza un recorrido de ida y vuelta a trav√©s de la red.  Debido a esto, el juego parecer√≠a terriblemente lento, por lo que casi inmediatamente despu√©s de que apareciera el modo multijugador, se introdujo un mecanismo para ocultar los retrasos.  Ocultar un retraso imita la aportaci√≥n de un jugador sin tener en cuenta las acciones de otros jugadores y las decisiones del servidor. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/8u/2f/ui/8u2fuieagsu2fokkbdny-hxi1cc.png"></div><br>  Factorio tiene un estado de juego llamado <i>Game State</i> : este es el estado completo del mapa, jugador, entidades y todo lo dem√°s.  Se simula determin√≠sticamente en todos los clientes en funci√≥n de las acciones recibidas del servidor.  El estado del juego es sagrado, y si alguna vez comienza a diferir del servidor o cualquier otro cliente, se produce la desincronizaci√≥n. <br><br>  Adem√°s de <i>Game State</i> , tenemos un <i>estado de</i> latencia.  Contiene un peque√±o subconjunto del estado fundamental.  <i>El estado de latencia</i> no <i>es</i> sagrado y simplemente presenta una imagen de c√≥mo se ver√° el estado del juego en el futuro en funci√≥n de las <i>acciones de entrada</i> introducidas por el jugador. <br><br>  Para hacer esto, almacenamos una copia de las <i>acciones de entrada</i> creadas en la cola de retraso. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gf/m4/bo/gfm4bo81-iluah40eus3cxjxvjm.png"></div><br>  Es decir, al final del proceso en el lado del cliente, la imagen se ve as√≠: <br><br><ol><li>  Aplique las <i>acciones de entrada de</i> todos los jugadores al estado del <i>juego,</i> ya que estas acciones de entrada se recibieron del servidor. </li><li>  Eliminamos de la cola de retrasos todas las <i>acciones de entrada</i> que, seg√∫n el servidor, ya se han aplicado al <i>estado del juego</i> . </li><li>  Elimine el <i>estado de latencia</i> y rein√≠cielo para que se vea exactamente igual al estado del <i>juego</i> . </li><li>  Aplique todas las acciones de la cola de retraso al <i>estado de latencia</i> . </li><li>  En base a los datos del <i>estado</i> del <i>juego</i> y el <i>estado de</i> <i>latencia, presentamos</i> el juego al jugador. </li></ol><br>  Todo esto se repite en cada medida. <br><br>  Demasiado complicado?  No te relajes, eso no es todo.  Para compensar las conexiones de Internet poco confiables, creamos dos mecanismos: <br><br><ul><li>  Ticks perdidos: cuando el servidor decide que las <i>acciones de entrada</i> se realizar√°n en el ritmo del juego, si no recibe las <i>acciones de entrada de</i> algunos jugadores (por ejemplo, debido al aumento de la demora), no esperar√°, pero le dir√° a este cliente "No tuve en cuenta sus <i>acciones de entrada</i> , intentar√© agregarlas a la siguiente medida ".  Esto se hace para que, debido a problemas con la conexi√≥n (o con la computadora) de un jugador, la actualizaci√≥n del mapa no disminuya para todos los dem√°s.  Vale la pena se√±alar que las <i>acciones de entrada</i> no se ignoran, sino que simplemente se posponen. </li><li>  Retraso de ida y vuelta: el servidor est√° tratando de adivinar cu√°l es el retraso de ida y vuelta entre el cliente y el servidor para cada cliente.  Cada 5 segundos, si es necesario, discute con el cliente un nuevo retraso (dependiendo de c√≥mo se haya comportado la conexi√≥n en el pasado) y, en consecuencia, aumenta o disminuye el retraso en la transferencia de datos de un lado a otro. </li></ul><br>  Por s√≠ mismos, estos mecanismos son bastante simples, pero cuando se usan juntos (lo que a menudo ocurre con problemas de conexi√≥n), la l√≥gica del c√≥digo se vuelve dif√≠cil de administrar y con un mont√≥n de casos l√≠mite.  Adem√°s, cuando estos mecanismos entran en <i>juego</i> , el servidor y la cola de retraso deben implementar correctamente una <i>acci√≥n de entrada</i> especial llamada <i>StopMovementInTheNextTick</i> .  Debido a esto, con problemas con la conexi√≥n, el personaje no se ejecutar√° solo (por ejemplo, debajo del tren). <br><br>  Ahora debe explicarle c√≥mo funciona la selecci√≥n de entidades.  Uno de los tipos de <i>acci√≥n</i> de <i>entrada</i> aprobada es el cambio en el estado de la selecci√≥n de entidad.  Les dice a todos sobre qu√© entidad se cern√≠a el jugador.  Como puede comprender, esta es una de las acciones de entrada m√°s frecuentes enviadas por los clientes, por lo que para ahorrar ancho de banda, la optimizamos para que ocupe el menor espacio posible.  Esto se implementa de la siguiente manera: al elegir cada entidad, en lugar de preservar las coordenadas absolutas y de alta precisi√≥n del mapa, el juego conserva un desplazamiento relativo de baja corriente de la elecci√≥n anterior.  Esto funciona bien porque la selecci√≥n del mouse generalmente ocurre muy cerca de la selecci√≥n anterior.  Debido a esto, surgen dos requisitos importantes: las <i>acciones de entrada</i> nunca deben omitirse y deben realizarse en el orden correcto.  Estos requisitos se cumplen para <i>Game State</i> .  Pero dado que la tarea del <i>estado de Latencia</i> es "verse lo suficientemente bien" para el jugador, no est√° satisfecho con el estado de los retrasos.  <i>El estado de latencia</i> no tiene en cuenta <a href="">muchos casos l√≠mite</a> asociados con saltos de ciclos y cambios en los retrasos de ida y vuelta. <br><br>  Ya puedes adivinar a d√≥nde va todo.  Finalmente, comenzamos a ver las causas del problema del megapaquete.  La ra√≠z del problema es que al decidir si pasar la acci√≥n del cambio de selecci√≥n, la l√≥gica de selecci√≥n de entidad se basa en el <i>estado de latencia</i> , y este estado no siempre contiene la informaci√≥n correcta.  Por lo tanto, se genera un megapaquete como este: <br><br><ol><li>  El jugador tiene un problema de conexi√≥n. </li><li>  Los mecanismos para omitir relojes y regular el retraso de ida y vuelta entran en juego. </li><li>  Los retrasos del estado en cola no tienen en cuenta estos mecanismos.  Esto hace que algunas acciones se eliminen prematuramente o se realicen en el orden incorrecto, lo que da como resultado un <i>estado de latencia</i> incorrecto. </li><li>  El jugador tiene un problema con la conexi√≥n y √©l, para ponerse al d√≠a con el servidor, simula hasta 400 ciclos de reloj. </li><li>  En cada ciclo de reloj, se genera una nueva acci√≥n, que cambia la selecci√≥n de una entidad, y se prepara para enviarla al servidor. </li><li>  El cliente env√≠a al servidor un megapaquete de m√°s de 400 cambios en la elecci√≥n de entidades (y con otras acciones: el estado de disparar, caminar, etc., tambi√©n sufri√≥ este problema). </li><li>  El servidor recibe 400 acciones de entrada.  Como no se le permite omitir una sola acci√≥n de entrada, ordena a todos los clientes que realicen estas acciones y las env√≠a a trav√©s de la red. </li></ol><br>  La iron√≠a es que un mecanismo dise√±ado para ahorrar ancho de banda del canal cre√≥ grandes paquetes de red como resultado. <br><br>  Resolvimos este problema corrigiendo todos los casos l√≠mite de actualizaci√≥n y apoyando la cola de demoras.  Aunque tom√≥ bastante tiempo, al final vali√≥ la pena implementar todo correctamente y no confiar en hacks r√°pidos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/466135/">https://habr.com/ru/post/466135/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../466113/index.html">Definici√≥n de codificaci√≥n de texto en PHP en lugar de mb_detect_encoding</a></li>
<li><a href="../466121/index.html">Generaci√≥n de sonido en microcontroladores AVR por el m√©todo de tablas de ondas con soporte de polifon√≠a.</a></li>
<li><a href="../466123/index.html">Crecimiento. Peso. Tres vecinos</a></li>
<li><a href="../466127/index.html">Central nuclear de Kola o de pie en el reactor</a></li>
<li><a href="../466129/index.html">Eficiencia del transporte de gasolina, bater√≠as e hidr√≥geno.</a></li>
<li><a href="../466137/index.html">System.IO. Pipelines: una herramienta poco conocida para los amantes del alto rendimiento</a></li>
<li><a href="../466139/index.html">Tecnolog√≠a aplicada en las ruinas de la fiebre blockchain o los beneficios pr√°cticos de la asignaci√≥n de recursos.</a></li>
<li><a href="../466143/index.html">¬øC√≥mo hicimos el c√≥digo de cart√≥n o la versi√≥n Scratch del juego de mesa Golem Battle</a></li>
<li><a href="../466147/index.html">Administrador de visualizaci√≥n de datos reactivos. Introduccion</a></li>
<li><a href="../466149/index.html">Crear un s√≠mbolo de conector con texto "din√°mico" en OrCAD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>