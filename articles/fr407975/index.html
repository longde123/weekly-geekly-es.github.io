<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∞üèº ü§ûüèΩ üåπ Contr√¥leur domestique intelligent Arduino Mega 2560 opensource avec prise en charge de MQTT, DMX-512, 1 fil, Modbus et Openhab ü§±üèø üéâ üóª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, j'ai d√©cid√© de pr√©senter au public un projet sur lequel je travaillais depuis quelques ann√©es: LightHub . Ce qui s'est finalement av√©r√© p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Contr√¥leur domestique intelligent Arduino Mega 2560 opensource avec prise en charge de MQTT, DMX-512, 1 fil, Modbus et Openhab</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/407975/"><img src="https://habrastorage.org/webt/bn/nt/mx/bnntmx1wnvytzqt3cgoxigc2mvu.jpeg" width="400" hspace="1" vspace="1" align="right">  Aujourd'hui, j'ai d√©cid√© de pr√©senter au public un projet sur lequel je travaillais depuis quelques ann√©es: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LightHub</a> .  Ce qui s'est finalement av√©r√© peut √™tre appel√© la solution la moins ch√®re pour cr√©er une maison intelligente, qui peut n√©anmoins: <br><br><ul><li>  Contr√¥ler les dispositifs d'√©clairage et d'alimentation (relais, gradateurs DMX-512 et Modbus RTU) </li><li>  G√©rer le chauffage au sol (une douzaine et demi de DS18B20 bon march√© dilu√©s dans l'appartement sont utilis√©s comme capteurs de temp√©rature) </li><li>  Actionner les vannes de ventilation / climatisation </li><li>  G√©rez un syst√®me de ventilation de fortune. </li><li>  Beaucoup de choses auxquelles je n'avais pas pens√© au d√©but, simplement parce que le contr√¥leur s'est av√©r√© √™tre compl√®tement ouvert, configurable de mani√®re flexible et parfaitement compl√©mentaire aux solutions OpenSource Openhab + Mosquitto + NodeRed </li></ul><br>  Les commutateurs, boutons, capteurs de contact, capteurs de fuite, etc. conventionnels, qui peuvent contr√¥ler √† la fois les charges locales et les appareils connect√©s √† d'autres m√™mes contr√¥leurs ou √† tout ce qui comprend le protocole MQTT, sont connect√©s √† l'entr√©e du contr√¥leur.  Par exemple, j'ai un interrupteur √† lames install√© dans le bo√Ætier de la porte avant.  Lorsque je ferme la serrure de trois tours, les lumi√®res s'√©teignent, le chauffage au sol, les chaudi√®res, le r√©cepteur AV.  √Ä mon retour, l'√©tat de ces appareils est r√©tabli tel qu'il √©tait avant de partir. <br><br>  √Ä la sortie - par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ces modules de relais</a> , DMX, p√©riph√©riques Modbus. <br><br>  Les contr√¥leurs sont configur√©s √† l'aide de fichiers JSON, qui sont charg√©s via http au d√©marrage du contr√¥leur (en outre, la configuration peut √™tre enregistr√©e dans NVRAM via la Serial CLI).  Et, bien s√ªr, tout cela est contr√¥l√© par le syst√®me Openhab 2, via une application mobile r√©guli√®re. <br>  Les t√¢ches de "petite automatisation" sont r√©solues √† la fois √† l'aide des r√®gles normales d'Openhab (pas tr√®s pratiques) et √† l'aide de NodeRed.  (Concernant NodeRed, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">voici un article</a> qui d√©crit parfaitement un exemple d'automatisation.) <br><br>  Les sources, ainsi que des exemples de configurations, sont publi√©es sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GIThub</a> , une petite partie de la description est publi√©e sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le site Web du projet.</a>  En cons√©quence, une histoire plus compl√®te sous la coupe. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">MISE √Ä JOUR: Six mois se sont √©coul√©s depuis la publication, et voici √† quoi ressemble le prototype industriel de l'appareil lors de son installation dans une armoire √©lectrique.</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/e2/yw/lg/e2ywlg3lx4xk7ln3vlpk4omjuik.jpeg"><br>  La carte Arduino DUE est install√©e sur la carte m√®re. <br><img src="https://habrastorage.org/webt/zq/k4/52/zqk452ibyvxpxo9mga5p-ne7yvm.jpeg"><br>  La carte est retir√©e, isolation optique visible, protection d'entr√©e, DMX, Modbus, pilotes 1 fil, un transistor puissant (par exemple) pour contr√¥ler le relais. <br><img src="https://habrastorage.org/webt/mw/rb/nb/mwrbnbepfer6az_kb8p_gxqrcum.jpeg"><br>  Et voici √† quoi ressemble le contr√¥leur sur un rail DIN (le couvercle est retir√©), √† c√¥t√© d'un bloc de relais typique.  (Comme je l'ai √©crit, je ne mets d√©lib√©r√©ment pas d'√©l√©ments de puissance √† l'int√©rieur du bo√Ætier du contr√¥leur) <br></div></div><br>  Tout a commenc√© par des r√©parations dans l'appartement, au cours desquelles j'ai d√©cid√© de rendre la maison d√©cemment plus intelligente. <br>  En m√™me temps, franchement, je ne voulais pas d√©penser de l'argent s√©rieux pour la solution ¬´Marque¬ª de la Smart House.  De plus, de nombreuses solutions ¬´s√©rieuses¬ª utilisent des normes ferm√©es et s'int√®grent les unes aux autres √† l'aide de b√©quilles. <br><br>  En cons√©quence, je me suis fix√© pour t√¢che d'assembler une maison intelligente √† partir des composants les plus pr√™ts √† l'emploi et les moins chers. <br><br>  En tant que mat√©riel pour le contr√¥leur, j'ai choisi le blindage Ethernet Arduino Mega 2560 +. <br>  Mise √† jour: Apr√®s avoir √©cout√© les commentaires ci-dessous, j'ai port√© le projet sur Atmel SAM3X8E ARM Cortex-M3 (Arduino DUE), une carte qui, au m√™me prix bon march√©, a des performances sup√©rieures d'un ordre de grandeur, et surtout, de la RAM.  J'ai d√ª bricoler avec la biblioth√®que DMX, mais maintenant les DMX-IN et DMX-OUT fonctionnent √† l'aide d'un seul mat√©riel USART, sans prendre les ressources du processeur.  Le projet se trouve d√©j√† sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> et est compil√© automatiquement pour la plateforme souhait√©e. <br><br>  Un prix d'un centime, un grand nombre de ports d'entr√©e / sortie, 4 UART mat√©riels, une taille d√©cente de NVRAM, que j'ai r√©ussi √† occuper jusqu'√† pr√©sent √† seulement 30% du firmware et qui correspondent √† l'ensemble de la configuration avec une marge, et directement au format JSON a confirm√© le caract√®re raisonnable du choix. <br><br>  Apr√®s avoir mis √† jour le Bootloader et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ajust√© la biblioth√®que Ethernet, j'ai</a> pu utiliser avec succ√®s le Watchdog mat√©riel du processeur, ce qui a ajout√© √† la d√©cision de "l'industrie" et j'ai toujours la tranquillit√© d'esprit, m√™me si le firmware n'a pas √©t√© remarqu√© m√™me sans lui. <br><br>  L'absence de tout syst√®me d'exploitation sur le contr√¥leur nous permet de le consid√©rer comme un ¬´syst√®me en temps r√©el¬ª, ce qui permet, par exemple, de g√©n√©rer par programmation le m√™me signal DMX. <br>  Le goulot d'√©tranglement est la taille de la RAM.  Et cela ne permet pas d'utiliser toute la vaste p√©riph√©rie du contr√¥leur.  Bien que, plus de 30 canaux diff√©rents (√©l√©ments, en termes de configuration) s'int√®grent parfaitement dans la m√©moire.  Et se connecter autant que le permet la carte Arduino Mega est une t√¢che, n√©anmoins, non li√©e √† la r√©alit√©. <br>  (sur ARM - il n'y a plus de goulot d'√©tranglement) <br><br>  De plus, l'√©volutivit√© est obtenue en augmentant le nombre d'appareils.  Par exemple, j'ai deux contr√¥leurs impliqu√©s.  Ils sont espac√©s autour de l'appartement (cela vous permet √©galement de ne pas tirer tous les fils en un seul point).  Pour l'interaction entre eux, ainsi qu'avec les syst√®mes Openhab et NodeRed, le courtier MQTT Mosquitto est utilis√©. <br><br>  En tant que pilote de bus √† 1 fil, j'ai utilis√© une puce <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ds2482-100</a> (pilote I2C) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avec Aliexpress</a> , qui au prix de 60 roubles garantit un fonctionnement stable avec un bus jusqu'√† 100M. <br><br>  Pour une configuration flexible de l'appareil, j'ai modifi√© la biblioth√®que AJSON pour Arduino, afin qu'elle puisse √† la fois charger un objet via http, lire et √©crire un objet depuis / vers le contr√¥leur NVRAM.  Fork est disponible <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sur Github</a> . <br><br>  CLI s√©rie lors de la cr√©ation d'un nouveau contr√¥leur, vous devez enregistrer une adresse MAC unique dans la NVRAM.  Ce MAC est la cl√© par laquelle la configuration du serveur http est initialement charg√©e. <br><br>  En tant que logiciel de gestion, j'ai pris Openhab 2, qui poss√®de toutes les fonctionnalit√©s dont j'ai besoin, plus une application mobile, plus Cloud, dont le r√¥le, cependant, est seulement de fournir un acc√®s √† l'infrastructure domestique de l'ext√©rieur, sans rediriger les ports sur le routeur et sans avoir IP fixe.  De plus, Openhab a une int√©gration avec HomeKit d'Apple, qui vous permet de contr√¥ler les appareils √† la maison avec l'iPhone, sans installer d'application du tout.  (L'occasion est int√©ressante, mais j'utilise principalement l'application "native"). <br><br><div class="spoiler">  <b class="spoiler_title">Quelques captures d'√©cran d'Openhab</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/bd/in/lz/bdinlz0d2isemsr_fov8orjjbbk.png" width="400" hspace="1" vspace="1"><br><br><img src="https://habrastorage.org/webt/mp/wc/id/mpwcidb2l-bses2xwbzpx3vufoi.png" width="400" hspace="1" vspace="1"><br></div></div><br>  La pr√©sence d'un grand nombre d'√©clairage LED dans le projet d'appartement a √©galement n√©cessit√© une gestion raisonnable. <br><br><div class="spoiler">  <b class="spoiler_title">D√©tails d'√©clairage LED</b> <div class="spoiler_text">  Les solutions trouv√©es sur le march√© √©taient soit des ¬´choses en soi¬ª ferm√©es, soit un co√ªt insuffisant, tout en prenant en charge peu de canaux.  Souvent, les fabricants √©taient limit√©s √† trois canaux (RVB), bien que l'option RGBW permette l'utilisation de bandes LED comme √©clairage principal, et pas seulement pour l'√©clairage couleur. <br><br>  En pensant, j'ai command√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">quelques cartes</a> sur AliExpress, chacune pouvant contr√¥ler 30 canaux LED avec un courant nominal allant jusqu'√† 2A par canal. <br><br>  Afin d'augmenter la puissance maximale d'un canal, je suis pass√© de bandes LED √† des bandes 12V √† 24V.  Dans ce cas, illuminez compl√®tement la pi√®ce d'environ 16 √† 18 m√®tres carr√©s.  m √©tait possible avec 4 touches.  Les plus grands locaux devaient √™tre zon√©s - dans le salon, je connectais ind√©pendamment 4 bandes de 5 m chacune, en utilisant 16 canaux. <br><br>  Pour un contr√¥le synchrone de toute la pi√®ce, je devais trouver le type de canal "groupe" <br><br>  Voici la description du salon dans la configuration JSON: <br><br><pre><code class="hljs powershell"><span class="hljs-string"><span class="hljs-string">"kuh"</span></span>:[<span class="hljs-number"><span class="hljs-number">7</span></span>,[<span class="hljs-string"><span class="hljs-string">"kuhline"</span></span>,<span class="hljs-string"><span class="hljs-string">"kuhfre"</span></span>,<span class="hljs-string"><span class="hljs-string">"kuhwork"</span></span>,<span class="hljs-string"><span class="hljs-string">"kuhwin"</span></span>]], <span class="hljs-string"><span class="hljs-string">"kuhwin"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">5</span></span>], <span class="hljs-string"><span class="hljs-string">"kuhline"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">13</span></span>], <span class="hljs-string"><span class="hljs-string">"kuhfre"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">25</span></span>], <span class="hljs-string"><span class="hljs-string">"kuhwork"</span></span>:[<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>],</code> </pre> <br>  Le premier √©l√©ment du tableau est le type de canal, le second est le param√®tre du canal, qui peut √™tre un tableau. <br><br>  Pour un √©l√©ment de type 7 (groupe), l'argument est un tableau d'√©l√©ments dans le groupe. <br>  La r√©cursivit√©, bien s√ªr, est prise en charge. <br><br>  Pour un √©l√©ment de type 1 (bande RGBW), l'argument est l'adresse DMX de base du canal. <br><br>  Avec la biblioth√®que standard EasyDMX, les cartes ne fonctionnaient pas tout de suite.  Il s'est av√©r√© que le contr√¥leur LED chinois n'a pas dig√©r√© le d√©lai de 2 ms entre les trames DMX (d√©lai intertrame).  Une simple modification du code de la biblioth√®que (r√©duction de moiti√© du cycle) a aid√©. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Biblioth√®ques Fork</a> sur github <br>  √Ä la demande des lecteurs, ajout de photos sur le th√®me "L'√©clairage LED en action" <br><img src="https://habrastorage.org/webt/6c/08/dk/6c08dkziy1zslvk2aml37fywnfi.jpeg"><br>  Il s'agit d'un d√©codeur DMX alternatif de la cat√©gorie ¬´cher et riche¬ª <br><br>  De plus, une ¬´s√©ance photo¬ª, sur laquelle vous pouvez comprendre √† quel point la pi√®ce change lorsque l'√©clairage change, ainsi que le fait qu'en utilisant uniquement la couleur blanche dans les rubans RGBW, vous pouvez obtenir un √©clairage diffus qui est agr√©able √† l'≈ìil. <br>  Je recommande les bandes exclusivement avec une lumi√®re blanche chaude (2700K) <br><br><img src="https://habrastorage.org/webt/lg/w-/ai/lgw-aiucdfmfabohe_xym8naw4g.jpeg"><br><br><img src="https://habrastorage.org/webt/ku/od/ra/kuodraad1vqhwr-eeovc4rifp74.jpeg"><br><br><img src="https://habrastorage.org/webt/0n/kb/gk/0nkbgk68234xqhwewigqydltdr0.jpeg"><br><br><img src="https://habrastorage.org/webt/6u/bw/cu/6ubwcuoondmfls25twqwso_6zjq.jpeg"><br><br><img src="https://habrastorage.org/webt/17/3z/lv/173zlvbmplrk4hfnc91kpbjqxsy.jpeg"><br><br><img src="https://habrastorage.org/webt/ks/xo/e8/ksxoe8gssobhbrrob7httuovgtm.jpeg"><br><br><img src="https://habrastorage.org/webt/pz/pl/tp/pzpltpjgk2gqwepbotu9vdxhuy4.jpeg"><br><br><img src="https://habrastorage.org/webt/ff/i-/12/ffi-12cpc6ikejgwihjuefh6wt4.jpeg"><br><br>  Et puis, quelques exemples de la combinaison de projecteurs et de LED: <br><img src="https://habrastorage.org/webt/6b/_o/ks/6b_oksc6q2wm-dtjml2znpmxu3s.jpeg"><br><br><img src="https://habrastorage.org/webt/pe/eo/tm/peeotmfppeyllnqs9wn4l95kshy.jpeg"><br><br><img src="https://habrastorage.org/webt/ri/ku/6n/riku6nkypopnnucs2xvo4sr2sf0.jpeg"><br><br><img src="https://habrastorage.org/webt/47/wr/d7/47wrd79finps2vlh4rdydkot9pa.jpeg"><br><br></div></div><br>  √âclairage AC 220V ordinaire, j'ai r√©ussi √† contr√¥ler les gradateurs chinois avec Aliexpress qui prennent en charge Modbus RTU (protocole de contr√¥le industriel standard sur RS-485).  Ces gradateurs sont parfaitement contr√¥l√©s localement (par des commutateurs sans verrouillage), en m√™me temps, le contr√¥leur a la capacit√© de lire la luminosit√© et de les contr√¥ler via Modbus (mis en ≈ìuvre jusqu'√† pr√©sent pour un appareil √† deux canaux). <br><br>  Au moment de la publication de l'article, il manquait des gradateurs sur Aliexpress, mais j'ai trouv√© un fabricant chinois par √©tiquette sur le circuit imprim√© de l'appareil.  Voici un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien vers leur site asc√©tique</a> .  Nous r√©pondons avec impatience aux questions par e-mail, m√™me envoy√© une documentation limit√©e. <br><br>  Une autre option pour contr√¥ler l'√©clairage 220V consiste √† utiliser un gradateur AC DMX-512.  Sur e-bay comme dans l'assortiment, tout facteur de forme - une carte ou sur un rail DIN.  Un √† huit canaux. <br>  Au d√©but, j'ai fait attention √† cette option, car le contr√¥leur √©tait encore dans une forme tr√®s exp√©rimentale et, pour la fiabilit√©, je voulais garder un contr√¥le local autonome.  Mais maintenant, j'utiliserais d√©j√† cette option. <br><br>  Ensuite - j'ai install√© un climatiseur √† canal, qui est capable de chauffer et de refroidir tout l'appartement.  Afin de r√©partir le froid et la chaleur dans les chambres, j'ai install√© des servos avec contr√¥le de signal 0-10V.  L'angle d'ouverture de la vanne est automatiquement ajust√© √† l'aide de NodeRed, dans lequel un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">contr√¥leur PID pratique a</a> √©t√© trouv√© pour cela. <br><br><div class="spoiler">  <b class="spoiler_title">D√©tails sur la climatisation</b> <div class="spoiler_text">  Malheureusement, il n'√©tait pas possible de trouver des entra√Ænements de registre d'air avec un PWM ou une entr√©e num√©rique, donc 4 convertisseurs PWM en un signal analogique standard 0..10V ont √©t√© achet√©s sur le m√™me AliExpress. <br><br>  Malheureusement, je ne vois pas ces appareils sur Aliexpress, mais sur e-bay - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s'il vous pla√Æt</a> <br><br>  Les convertisseurs fonctionnaient tr√®s bien tout de suite, je devais juste reprogrammer la minuterie de sortie PWM afin de r√©gler la fr√©quence appropri√©e. <br><br>  Ci-dessous, un exemple de reprogrammation des temporisateurs 3 et 4 (responsables des broches 2, 3, 5, 6, 7, 8 Arduino Mega √† une fr√©quence de 4000 Hz). <br><br><pre> <code class="hljs pgsql"> pinMode(iaddr,OUTPUT); //timer <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> //timer <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> //timer <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> //timer <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> //timer <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> tval = <span class="hljs-number"><span class="hljs-number">7</span></span>; // <span class="hljs-number"><span class="hljs-number">111</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> binary - used <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> an eraser TCCR4B &amp;= ~tval; // <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> the three bits <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> TCCR2B <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> TCCR3B &amp;= ~tval; tval=<span class="hljs-number"><span class="hljs-number">2</span></span>; //prescaler = <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">---&gt; PWM frequency is 4000 Hz TCCR4B|=tval; TCCR3B|=tval; analogWrite(iaddr,k=map(Value,0,100,0,255));</span></span></code> </pre><br></div></div><br>  Ensuite, j'ai commenc√© √† chercher des contr√¥leurs de chauffage par le sol WiFi.  J'ai trouv√©, en g√©n√©ral, un bon appareil d'une valeur d'environ 6 000 roubles de Teplolux, mais il avait des inconv√©nients importants pour moi. <br><br>  Malgr√© la pr√©sence d'une application mobile, le protocole de contr√¥le a √©t√© ferm√©.  J'ai fait de l'ing√©nierie inverse, qui a montr√© que, th√©oriquement, le protocole peut √™tre d√©crypt√©.  J'aurais peut-√™tre fait cela, mais j'ai constat√© que sans r√©installer les sockets, ce p√©riph√©rique n'est pas install√© dans la m√™me rang√©e avec les commutateurs.  Cela a d√©termin√© le sort de l'appareil: l'ayant vendu, j'ai impl√©ment√© la fonctionnalit√© d'un simple thermostat sur mon contr√¥leur, √©conomisant pr√®s de 30 mille roubles sur 5 √©tages chauds. <br><br><div class="spoiler">  <b class="spoiler_title">Il s'est av√©r√© ce qui suit:</b> <div class="spoiler_text"><ul><li>  Toute la gestion - localement sur le contr√¥leur et ind√©pendamment de l'infrastructure informatique domestique </li><li>  Les mesures des capteurs de temp√©rature √† 1 fil sont utilis√©es.  Si le capteur ne peut pas √™tre interrog√© pendant une longue p√©riode, le chauffage s'√©teint. </li><li>  Gr√¢ce √† MQTT, vous pouvez activer / d√©sactiver le plancher chaud et r√©gler sa temp√©rature.  En cons√©quence, les sols sont contr√¥l√©s via des interfaces et l'application mobile Openhab </li><li>  Je n'ai pas impl√©ment√© de scripts et de plannings d√©licats sur le contr√¥leur.  Si vous le souhaitez, cela est facilement impl√©ment√© par les r√®gles Openhab ou Node-Red.  Je me suis limit√© √† √©teindre les appareils lorsque les gens quittent la maison. </li></ul><br>  Voici un exemple de configuration pour un plancher chaud: <br><br><pre> <code class="hljs powershell"><span class="hljs-string"><span class="hljs-string">"ow"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"2807FFD503000036"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"t_bath1"</span></span>,<span class="hljs-string"><span class="hljs-string">"item"</span></span>:<span class="hljs-string"><span class="hljs-string">"h_bath1"</span></span>} }, <span class="hljs-string"><span class="hljs-string">"items"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"h_bath1"</span></span>:[<span class="hljs-number"><span class="hljs-number">5</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>,<span class="hljs-number"><span class="hljs-number">33</span></span>], },</code> </pre><br>  Lors de l'interrogation d'un thermom√®tre OneWire avec l'adresse sp√©cifi√©e, il est transf√©r√© au bus MQTT dans la rubrique t_bath1, et √©galement, √† l'int√©rieur du contr√¥leur, √† l'objet h_bath de type n ¬∞ 5 (thermostat), le relais est connect√© √† la broche # 24 du contr√¥leur, le r√©glage est de 33 degr√©s (peut √™tre ajust√© par MQTT ) <br></div></div><br>  <b>Entr√©es de l'appareil</b> <br><br>  Dans la configuration de chaque entr√©e, vous pouvez sp√©cifier comment la commande est envoy√©e √† l'objet local et la commande est √©mise dans la rubrique MQTT.  De plus, s√©par√©ment pour le "pressage" conditionnel du bouton et le "rel√¢chement". <br><br><div class="spoiler">  <b class="spoiler_title">Exemples:</b> <div class="spoiler_text"><pre> <code class="hljs objectivec"><span class="hljs-string"><span class="hljs-string">"in"</span></span>:{ <span class="hljs-string"><span class="hljs-string">"41"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/in/all"</span></span>,<span class="hljs-string"><span class="hljs-string">"scmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"HALT"</span></span>,<span class="hljs-string"><span class="hljs-string">"rcmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"REST"</span></span>}, <span class="hljs-string"><span class="hljs-string">"38"</span></span>:{<span class="hljs-string"><span class="hljs-string">"item"</span></span>:<span class="hljs-string"><span class="hljs-string">"spots_en"</span></span>}, <span class="hljs-string"><span class="hljs-string">"37"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/in/light"</span></span>,<span class="hljs-string"><span class="hljs-string">"scmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"ON"</span></span>,<span class="hljs-string"><span class="hljs-string">"rcmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"OFF"</span></span>}, <span class="hljs-string"><span class="hljs-string">"40"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/in/gstall"</span></span>,<span class="hljs-string"><span class="hljs-string">"scmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"TOGGLE"</span></span>,<span class="hljs-string"><span class="hljs-string">"rcmd"</span></span>:<span class="hljs-string"><span class="hljs-string">"TOGGLE"</span></span>}, <span class="hljs-string"><span class="hljs-string">"35"</span></span>:{<span class="hljs-string"><span class="hljs-string">"emit"</span></span>:<span class="hljs-string"><span class="hljs-string">"/myhome/s_out/water_leak"</span></span>} }</code> </pre><br>  Broche 41: interrupteur Reed sur le verrou de la porte avant - lorsqu'il est verrouill√© - √©mettez la commande HALT vers le sujet / myhome / in / all, lorsqu'il est d√©verrouill√© - la commande REST. <br><br>  Pour moi, cela m√®ne √† ¬´s'endormir¬ª et √† ¬´se r√©veiller¬ª √† la maison.  Soit dit en passant - les commandes ne sont pas incluses dans l'ensemble OpenHab standard, mais cela s'est av√©r√© extr√™mement pratique - HALT - √©teint l'appareil, REST - restaure les param√®tres de l'appareil √† la derni√®re valeur (couleur, luminosit√©, temp√©rature), mais uniquement pour l'appareil qui a √©t√© √©teint par la commande HALT et non OFF  Cela vous permet de ne pas inclure ce qui a √©t√© d√©sactiv√© au moment de quitter la maison. <br><br>  Broche 38: juste un interrupteur d'√©clairage ordinaire.  Lorsqu'il est ferm√©, il √©met (par d√©faut) la commande ON, lorsqu'il est ouvert, la commande OFF.  Ces valeurs sont transmises √† l'objet spots_en.  Il est clair que l'√©tat d'un objet peut √™tre modifi√© √† partir d'une application mobile.  Dans ce cas, l'interrupteur, pour ainsi dire, reste, par exemple, en position marche, mais le voyant est √©teint. <br><br>  Pour les amateurs de commutateurs classiques, la syntaxe de la broche 40 convient: √† la fois lorsqu'elle est activ√©e et d√©sactiv√©e, la commande TOGGLE est √©mise (√©galement, accessoirement, une nouvelle, par rapport √† OpenHab), qui modifie la position On-Off de l'appareil (dans cet exemple, la lampe n'est pas contr√¥l√©e localement, mais via MQTT un autre contr√¥leur). <br><br>  Si ce n'est pas un interrupteur √† bascule mais un bouton, ajustez simplement "rcmd": "" - il ne donnera une commande de commutateur que lorsque vous appuyez dessus. <br></div></div><br>  Ah, eh bien, j'ai presque oubli√© de d√©crire DMX-IN - l'entr√©e pour laquelle, pourrait-on dire, j'ai commenc√© ce d√©veloppement. <br><br>  Il existe sur le march√© de nombreux contr√¥leurs de bande DMX LED ergonomiques et r√©ussis par les concepteurs. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">J'ai achet√©</a> l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un d'entre eux (√©cran tactile)</a> au tout d√©but pour exp√©rimenter le DMX.  Tout va bien, mais l'architecture DMX ne fournit aucun contr√¥le depuis plus d'un endroit.  Il y a un ma√Ætre, qui se traduit constamment par le canal de luminosit√© des canaux.  Mais dans ce projet, ce probl√®me est r√©solu.  Le contr√¥leur LightHub surveille les changements de canaux DMX √† l'entr√©e connect√©e √† l'√©cran tactile.  S'ils changent, il traduit les changements dans la sortie (avec mappage sur les appareils configur√©s, y compris les groupes de bandes LED). <br><br>  Jusqu'√† pr√©sent, rien n'a chang√© - les appareils sont normalement contr√¥l√©s √† distance.  Il vaut la peine que l'√©cran tactile modifie les valeurs de luminosit√© des canaux - ces changements sont transmis aux sorties DMX. <br><br>  Curieusement, cette b√©quille s'est av√©r√©e assez ergonomique.  Bien que, comme l'exp√©rience l'a montr√©, nous sommes de moins en moins susceptibles d'utiliser l'√©cran tactile et de plus en plus les smartphones pour contr√¥ler les appareils. <br><br>  <b>Conclusion</b> <br><br>  Malheureusement, dans un article, il est impossible de d√©crire toutes les nuances inh√©rentes au d√©veloppement. <br>  Par exemple, le sujet de la connexion des appareils Modbus, leur extraction et synchronisation de l'√©tat local de l'appareil avec le syst√®me Smart Home, l'int√©gration avec une simple installation d'alimentation sont rest√©s compl√®tement dans les coulisses.  Eh bien, et peut-√™tre une comparaison avec les syst√®mes existants de classes connexes, tels que, par exemple, MegaD-328, AMS et, m√™me, WirenBoard.  Peut-√™tre qu'en cas d'int√©r√™t, je continuerai. <br><br>  De plus, en coulisses, en utilisant NodeRed, nous avons pu int√©grer le syst√®me √† Telegram.  Bien que cela fonctionne pour recevoir des alertes, mais vous pouvez cr√©er un bot complet. <br><br>  En ce qui concerne le projet LightHub - malgr√© son bon march√©, les contr√¥leurs se sont av√©r√©s √™tre une solution compl√®tement fonctionnelle.  Honn√™tement, je ne croyais pas moi-m√™me que sur la base d'Arduino, vous pouvez cr√©er un syst√®me de travail stable, mais, √† mon avis, c'√©tait possible. <br><br>  Bien s√ªr, il reste encore beaucoup √† faire: s'√©loigner compl√®tement du code dur (juste un peu √† gauche), nettoyer et refactoriser un peu le code, documenter soigneusement le projet, ouvrir la carte de circuit imprim√© (maintenant les Shields d'interface sont soud√©s simplement sur la base de maquettes et contiennent trois MAX-485 - (DMX-IN, DMX-OUT, Modbus) et 1-Wire bridge) - et cela deviendra, en fait, une solution cl√© en main tr√®s peu co√ªteuse. <br><br>  Attention: je vous rappelle que le projet est toujours au niveau de la maquette.  En ouvrant le spoiler suivant, vous pouvez endommager vos sens esth√©tiques. <br><div class="spoiler">  <b class="spoiler_title">Quelques photos</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/kg/jd/qo/kgjdqoi6_mqq5hj5_tcgvflkm-y.jpeg"><br>  Le premier contr√¥leur qui contr√¥le la LED (60 canaux DMX-512), Modbus (gradateurs, entr√©e), volets; <br><br><img src="https://habrastorage.org/webt/m4/qs/dv/m4qsdvcfcjydoqszeq1uptpvooy.jpeg"><br>  Il s'agit d'un d√©codeur DMX-512, qui est pratique √† placer l√† o√π la bande LED vient aux transformateurs.  J'ai - sous le faux plafond dans le garde-manger. <br><br><img src="https://habrastorage.org/webt/np/ib/7_/npib7_bsnhtyjoza0dwxdtt1uq0.jpeg"><br><br>  Et c'est le deuxi√®me contr√¥leur desservant 1 fil, des interrupteurs / capteurs et un module relais.  (Le module relais lui-m√™me √©tait situ√© juste dans la bo√Æte de jonction, o√π il appartient aux trois phases. J'ai √©radiqu√© le voisinage de 380V et des courants faibles dans la mesure du possible apr√®s un incident infructueux) <br></div></div><br><br>  Il est clair qu'il est n√©cessaire d'√©tendre la fonctionnalit√©.  Au minimum, vers des capteurs / appareils sans fil.  (Bien que, par exemple, ZWave puisse d√©sormais √™tre utilis√© via des classeurs Openhab standard). <br><br>  La possibilit√© de connecter, par exemple, le budget NooLight est probablement une bonne id√©e.  Je penserai peut-√™tre √† migrer vers l'ESP-8266 pour √©tendre la RAM, bien que je n'aime pas quitter le Wi-Fi √† partir d'une connexion LAN filaire en termes de fiabilit√©.  Oui, et ESP n'a pas une p√©riph√©rie aussi riche que Arduino Mega.  Je pr√©vois √©galement de faire la mesure de l'√©lectricit√© √† travers des capteurs de courant et de connecter le codeur rotatif √† l'entr√©e. <br><br>  En outre, il serait utile de rendre la configuration et le d√©marrage du contr√¥leur plus conviviaux (configurateurs visuels, etc.).  En m√™me temps, je ne veux pas d√©lib√©r√©ment transformer le contr√¥leur en serveur Web avec des fichiers / images, AJAX, etc. √Ä mon avis, cela devrait d√©j√† √™tre la pr√©rogative du serveur.  Au moins bas√© sur la framboise. <br><br>  Mais comme le projet est absolument open-source - diff√©rentes options sont possibles, rejoignez-nous. <br>  Aussi, je me r√©jouis de vos commentaires. <br><br><h3>  MISE √Ä JOUR: </h3><br>  Apr√®s la publication de l'article, apr√®s avoir uni nos forces avec l'un des habitants de Habr et dessin√© un diagramme sch√©matique du bouclier LighthHub, nous avons commenc√© √† disposer le circuit imprim√©, en tenant compte de toute l'exp√©rience et des commentaires significatifs <br><br><ul><li>  La carte sera compatible avec Arduino Mega (5v) et Arduino DUE (ARM 3.3V) </li><li>  Interface Ethernet int√©gr√©e bas√©e sur Wiznet5500 </li><li>  8 entr√©es TOR optocoupl√©es, 8 entr√©es / sorties TOR avec protection tension / courant </li><li>  8 entr√©es analogiques avec protection tension / courant.  √Ä l'avenir, je propose d'utiliser des entr√©es analogiques pour contr√¥ler la consommation d'√©nergie (capteurs de courant) et pour connecter des potentiom√®tres externes (gradateurs) </li><li>  8 sorties PWM, dont 4 avec touches de sortie puissantes (jusqu'√† 500 mA / 50V) + 4 sorties puissantes discr√®tes.  Ils vous permettront de vous connecter localement au contr√¥leur, par exemple, plusieurs d√©marreurs ou m√™me une bande LED RGBW pas tr√®s longue. </li><li>  Un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">connecteur au</a> format UEXT, qui vous permettra par la suite de connecter un p√©riph√©rique compatible au contr√¥leur - par exemple, des modules radio suppl√©mentaires pour la connexion √† des appareils sans fil. </li><li>  Les entr√©es / sorties restantes seront sorties sans protection vers les connecteurs RJ45 pour connecter les appareils locaux (cartes relais, DAC, etc.) </li><li>  Bien s√ªr, il reste des interfaces 1-Wire pour connecter des capteurs de temp√©rature, une entr√©e et une sortie DMX-512 pour le contr√¥le de l'√©clairage, Modbus RTU pour tout le reste </li></ul><br><br>  Vous pouvez laisser des commentaires sur la fonctionnalit√©, ainsi que le d√©sir de rejoindre la commande du premier lot de planches, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> <br><br>  Le prochain point du programme sera le d√©veloppement d'une carte contr√¥leur avec un module ESP32 int√©gr√© (cela vous permettra de vous √©loigner du facteur de forme Arduino) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr407975/">https://habr.com/ru/post/fr407975/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr407959/index.html">Accueillons nos nouveaux propri√©taires - robots - chapitre deux</a></li>
<li><a href="../fr407961/index.html">Antiportfolio: des opportunit√©s d'investissement que nous avons perdues</a></li>
<li><a href="../fr407963/index.html">Plusieurs ast√©ro√Ødes ont fait une "photobombe" pour Hubble, les emp√™chant de photographier des galaxies lointaines</a></li>
<li><a href="../fr407965/index.html">Multilat√©ration - Technologie de surveillance num√©rique du trafic a√©rien</a></li>
<li><a href="../fr407967/index.html">√Ä propos de la mati√®re noire, du nombre de Pi et des anciens Grecs</a></li>
<li><a href="../fr407977/index.html">√Ä propos de la collecte de donn√©es. Comment collecter, analyser et voler des donn√©es</a></li>
<li><a href="../fr407979/index.html">Vuln√©rabilit√©s dans les syst√®mes d'exploitation. Partie I</a></li>
<li><a href="../fr407981/index.html">D√©tails du d√©veloppement de la th√©rapie g√©nique pour le vieillissement dans une interview avec Fight Aging!</a></li>
<li><a href="../fr407983/index.html">Les astronomes ont commenc√© √† travailler sur le cinqui√®me miroir du t√©lescope magellanique g√©ant</a></li>
<li><a href="../fr407985/index.html">Souvenirs de Rocket Mail</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>