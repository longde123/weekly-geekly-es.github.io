<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèø üçã üôèüèæ RobotDyn atinge o dobro: Mega + ESP8266 ü§® üë©üèΩ‚Äçüöí ü•õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O que um desenvolvedor faz em raras horas de lazer? √â isso mesmo, navegando pelas listas de pre√ßos das lojas de ferro. Houve um minuto gr√°tis e decidi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RobotDyn atinge o dobro: Mega + ESP8266</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/402429/"><img src="https://habrastorage.org/files/07a/66b/52f/07a66b52ff5d4326bcef6a7fd2749aef.jpg" alt="RobotDyn Mega + ESP8266"><br>  O que um desenvolvedor faz em raras horas de lazer?  √â isso mesmo, navegando pelas listas de pre√ßos das lojas de ferro.  Houve um minuto gr√°tis e decidi procurar nas p√°ginas das lojas on-line populares - t√©dio, nada de interessante, j√° vimos tudo isso ... e de repente meus olhos caem no pr√≥ximo Mega.  Bah!  Sim, n√£o √© apenas o Mega, mas combinado com o amado ESP8266 de todos e cuidadosamente equipado com switches para que dois controladores trabalhem juntos - com fio (usando Ethernet Shield) com muitos GPIO e Wi-Fi para comunica√ß√£o sem fio. <br><br>  Nada mal!  Pensei e me lembrei do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">AMS</a> - l√° voc√™ pode instalar dois servidores - com e sem fio e conect√°-los em um sistema - o ESP8266 receber√° 54 pinos digitais e 16 anal√≥gicos, e o Mega receber√° controle sem fio via Wi-Fi e todos os p√£es ESP8266.  H√° muito tempo, n√£o encontrei um conselho t√£o interessante. <br><br>  Ol√°!  Voc√™ tem uma placa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Mega + ESP8266</a> ? <br>  - Sim, mas temos apenas um. <br>  "Por que apenas um?" <br>  - O resto foi desmontado. <br>  "Reserve-a, por favor, para mim." <br><a name="habracut"></a><br><h2>  Algumas palavras sobre a empresa </h2><br>  Gostei do RobotDyn de duas coisas: a primeira - com suas solu√ß√µes tecnol√≥gicas.  N√£o h√° necessidade de ir longe, um excelente exemplo √© a placa Mega + ESP8266 em considera√ß√£o.  Algo assim n√£o vi em nossas (e n√£o na nossa, mas n√£o procurei aqui) nas lojas on-line.  E este n√£o √© o √∫nico exemplo, ainda existe a op√ß√£o Uno + ESP8266 e a empresa claramente n√£o vai parar por a√≠, aparentemente ainda existem muitos dispositivos interessantes esperando por n√≥s. <br><br>  E o segundo √© sua pol√≠tica de pre√ßos.  N√£o vou me debru√ßar sobre essa quest√£o aqui em detalhes, mas direi que os pre√ßos me surpreenderam agradavelmente - o lema da empresa √© "Os pre√ßos s√£o como no Aliexpress". <br><br>  Em poucas palavras, descrevi o pano de fundo em que todos os eventos subseq√ºentes se desenrolam; agora vamos diretamente aos detalhes t√©cnicos e uma descri√ß√£o do quadro e como trabalhar com ele. <br><br><h2>  O pr√≥prio quadro </h2><br>  Em geral, uma placa comum, n√£o muito diferente de outras similares, se n√£o uma pequena parte, a saber, o chip ESP8266EX integrado √† placa.  Isso transfere imediatamente o conselho para a categoria de solu√ß√µes extraordin√°rias.  Quero chamar sua aten√ß√£o para mais um detalhe - n√£o um m√≥dulo padr√£o do tipo ESP-12 est√° integrado √† placa, mas o chip e toda a fia√ß√£o s√£o feitos na pr√≥pria placa, o que indica de maneira transparente o n√≠vel dos desenvolvedores.  Tamb√©m quero observar que a placa possui uma antena impressa e um conector para conectar uma antena externa, o que em muitos casos pode ser muito √∫til. <br><img src="https://habrastorage.org/files/1d1/cee/155/1d1cee155967488581228289df3b6f28.jpg" alt="RobotDyn Mega + ESP8266"><br>  Existem conectores de pinos na placa para conectar aos terminais ESP8266 e v√°rios switches, que vale a pena mencionar um pouco mais.  A principal id√©ia de usar a placa √© que, usando os comutadores, voc√™ pode configurar a intera√ß√£o de seus tr√™s componentes de maneiras diferentes: o chip Atmega2560, o chip ESP8266EX e o conversor CH340G USB-TTL.  S√£o poss√≠veis conex√µes √∫nicas e complexas, que permitem organizar muitas op√ß√µes para a intera√ß√£o de todas as partes do quadro.  Isso abre grandes oportunidades para a constru√ß√£o de v√°rios dispositivos, mas mais sobre isso mais tarde. <br><br><img src="https://habrastorage.org/files/cb4/2f4/819/cb42f4819ba940369ad71818bbc7ff03.jpg" alt="Pinos ESP8266"><br><br>  Tamb√©m quero observar a capacidade de carga decente da placa.  A julgar pelas inscri√ß√µes, ele √© capaz de fornecer uma corrente de carga de 1,6 A em um canal de 5 volts e 1 A em um 3,3 volts.  O que √© muito bom, especialmente no conjunto. <br><br>  N√£o h√° mais nada a dizer sobre o conselho, passamos a instalar o software e test√°-lo. <br><br><h2>  Teste de placa </h2><br>  Como a placa est√° integrada e praticamente n√£o h√° espa√ßo livre, e a fia√ß√£o da parte de alta frequ√™ncia do ESP8266EX √© feita nela, a princ√≠pio surgiram d√∫vidas sobre a opera√ß√£o correta e sem problemas de toda essa economia. <br><br>  No futuro, direi que, apesar das minhas preocupa√ß√µes, tudo funciona de forma est√°vel e conforme o esperado.  Conectamos os comutadores na placa Atmega2560 ao USB - obtemos o Arduino Mega, conectamos o ESP8266EX ao USB - obtemos o ESP8266, mudamos para o modo de conex√£o do Atmega2560 com o ESP8266EX, obtemos a conex√£o entre os chips via interface serial.  Tudo funciona exatamente como descrito na documenta√ß√£o e exatamente como √© esperado intuitivamente. <br><br>  Uma grande vantagem dessa solu√ß√£o √© que os desenvolvedores cuidaram de combinar os n√≠veis de sinal l√≥gico de todos os componentes do sistema.  Qualquer pessoa que tente manualmente configurar o m√≥dulo ESP8266 e conectar corretamente todos os resistores pull-up me entender√°.  N√£o existem problemas, todo o seu trabalho √© reduzido a clicar nos interruptores na placa, de acordo com as instru√ß√µes do fabricante. <br><br><h2>  Teste de carga </h2><br>  Como testar o quadro?  Voc√™ pode fazer o download de algum esbo√ßo padr√£o, mas ser√° um teste sobre nada.  Essa op√ß√£o pode funcionar bem e, em condi√ß√µes de combate, o sistema falhar√°.  Portanto, o trabalho de ambas as partes sob o controle das vers√µes correspondentes do Arduino Mega Server foi escolhido como um teste de carga pesada.  Para Mega - Arduino Mega Server para Mega e ESP8266 - Arduino Mega Server para ESP8266 na vers√£o M1. <br><br>  O kit de distribui√ß√£o M1 foi escolhido devido ao fato de apenas 1 MB de mem√≥ria flash do ESP8266 estar instalado na placa.  Na minha opini√£o, esse √© quase o √∫nico erro dos desenvolvedores - em futuras revis√µes da placa, eu recomendaria que eles colocassem chips de mem√≥ria de 4 MB.  A diferen√ßa de pre√ßo √© pequena e as possibilidades de uso da vers√£o com 4 MB s√£o muito maiores.  Mas como existe uma vers√£o AMS para sistemas com 1 MB, n√£o prestei muita aten√ß√£o a esse ponto e continuei testando. <br><br>  O que dizer?  Ativamos o quadro, preenchemos o software e obtemos dois servidores independentes.  Um conectado via Ethernet Shield e um sem fio via Wi-Fi.  Beleza! <br><br>  Tamb√©m gostaria de observar que mesmo a adi√ß√£o de um Ethernet Shield com um leitor de cart√£o a este sistema j√° sofisticado n√£o causou conflitos ou falhas - tudo funcionou da maneira que deveria funcionar.  E, em alguns casos, √© ainda melhor do que o habitual - esta √© a primeira placa na qual o firmware ESP8266 no ar passou com √™xito em 100% dos casos; em todas as outras placas e m√≥dulos, h√° falhas peri√≥dicas com essa intermit√™ncia. <br><br>  E dois servidores est√£o girando, carregando o quadro, cumprindo suas obriga√ß√µes e ... isso √© tudo.  Tudo simplesmente funciona, n√£o h√° nada a dizer, mas este √© provavelmente o melhor elogio para qualquer sistema t√©cnico. <br><br><h2>  Mais interessante </h2><br>  O que descrevi aqui √© interessante do ponto de vista puramente acad√™mico: um quadro interessante, uma solu√ß√£o t√©cnica interessante, mas √© claro que estamos interessados ‚Äã‚Äãem sua aplica√ß√£o pr√°tica.  Qual √© o seu destaque pr√°tico e aplicado? <br><br>  O fato √© que, com um interruptor na placa, voc√™ pode conectar duas de suas partes (Mega e ESP) em uma √∫nica unidade e, assim, primeiro obter um novo sistema de qualidade e, em segundo lugar, compensar as falhas inerentes a cada uma de suas partes individuais. <br><br>  Vamos come√ßar com o ESP8266.  A principal desvantagem dessa solu√ß√£o geralmente excelente √© a falta catastr√≥fica de pinos GPIO.  Como se costuma dizer, um, dois e calculou mal.  √â dif√≠cil dizer o que os desenvolvedores deste chip pensavam, mas antes do lan√ßamento do ESP32 eles tinham um pouco mais de tempo para pensar e corrigiram essa falha no novo chip.  Mas estamos lidando especificamente com o 8266. <br><br>  Esta placa permite que voc√™ fa√ßa um cavalo se mover e usar toda a pot√™ncia do Mega, e isso, entre outras coisas, 54 sa√≠das digitais e 16 anal√≥gicas no ESP8266.  Ou seja, de repente, nosso prec√°rio ESP obt√©m excelentes oportunidades para trabalhar com sensores, atuadores e outros perif√©ricos.  Acontece, por assim dizer, beb√™ ESP em ester√≥ides. <br><br>  Essa √© apenas uma das op√ß√µes poss√≠veis para o uso da placa, deitada na superf√≠cie. <br><br>  Agora vamos dar uma olhada no Mega.  Ela n√£o interfere na interface sem fio e na capacidade de interagir com dispositivos Wi-Fi, o que pode lhe proporcionar integra√ß√£o com a parte ESP do sistema.  E, ao mesmo tempo, resta a possibilidade de opera√ß√£o paralela por meio de uma interface Ethernet com fio. <br><br>  E essa tamb√©m √© apenas uma das aplica√ß√µes poss√≠veis para esta placa, deitada na superf√≠cie. <br><br>  Bem, v√°rias op√ß√µes de pontes: Ethernet - Wi-Fi, nRF24 - Ethernet, nRF24 - Wi-Fi, nRF24 (1) - nRF24 (2), nooLite - Wi-Fi, nooLite - Ethernet, nooLite (1) - nooLite (2) ), etc., etc. at√© o infinito.  Voc√™ pode rotear sinais de dezenas de subsistemas com os quais o Mega Server do Arduino trabalha entre as duas partes da placa e as interfaces conectadas a elas. <br><br>  Eu nem sei o que dizer.  Muito legal <br><br><h2>  Detalhes t√©cnicos </h2><br>  Agora um pouco sobre os detalhes t√©cnicos.  Voc√™ v√™ uma tabela na qual todos os modos poss√≠veis de opera√ß√£o do quadro s√£o apresentados e todas as posi√ß√µes poss√≠veis dos interruptores nele.  Vamos considerar brevemente cada modo. <br><br><img src="https://habrastorage.org/files/a51/cc7/874/a51cc7874a274215b06fc93c7d7dbd4d.png" alt="Tabela de modos operacionais da placa RobotDyn"><br><br><h4>  Arduino Mega 2560 </h4><br>  O modo mais simples de opera√ß√£o da placa, na tabela, √© designado como modo 3. Se voc√™ colocar os interruptores 3 e 4 na posi√ß√£o ON e o restante na posi√ß√£o OFF, obteremos o habitual Arduino Mega 2560. Nada interessante, pelo fato de n√£o valer a pena comprar esta placa, voc√™ pode era comprar o Mega habitual. <br><br><h4>  ESP8266 </h4><br>  Tamb√©m n√£o √© um modo de opera√ß√£o muito interessante.  Na tabela, ele √© dividido em dois submodos, designados como 1 (carregando o esbo√ßo no ESP) e 2 (modo de conex√£o ESP para USB).  Essa √© toda a funcionalidade do ESP8266 padr√£o e, para esse uso, tamb√©m n√£o valia a pena comprar esta placa, voc√™ poderia se dar bem com o habitual m√≥dulo ESP. <br><br><h4>  Todos s√£o independentes </h4><br>  Tamb√©m n√£o consideramos essa op√ß√£o no n√∫mero 6, porque todas as conex√µes entre as partes da placa est√£o quebradas e, definitivamente, n√£o pode ser √∫til para nada. <br><br><h4>  A conex√£o entre Mega e ESP </h4><br>  Nesse modo, designado como 5, a comunica√ß√£o √© estabelecida entre o Mega e o ESP por meio de uma interface serial, mas n√£o h√° comunica√ß√£o com o conversor USB-TTL.  O ESP usa o Serial padr√£o, enquanto o Mega n√£o usa menos o Serial3 padr√£o.  A conex√£o funciona de maneira est√°vel e cont√≠nua a uma velocidade de 115200. Esse √© um modo de opera√ß√£o bastante espec√≠fico quando nenhum controlador possui conex√£o USB.  E ent√£o ele tamb√©m n√£o √© muito interessante para n√≥s. <br><br><h4>  Comunica√ß√£o entre Mega e ESP e Mega e USB ao mesmo tempo </h4><br>  Mas isso √© chamado de trunfo.  Conseguimos tudo de uma vez - a conex√£o Mega USB e a capacidade de fazer upload de esbo√ßos para Mega e controlar sua opera√ß√£o atrav√©s do mesmo USB, a possibilidade de comunica√ß√£o entre Mega e ESP e a capacidade de fazer upload de esbo√ßos para o ESP8266 e controlar sua opera√ß√£o na interface USB ... Mega!  Ou seja, enchimento cheio, n√£o saindo diretamente da caixa registradora. <br><br>  Este √© o √∫nico modo correto de opera√ß√£o listado na tabela.  Lembre-se do n√∫mero vencedor, que √© quatro.  Na configura√ß√£o dos interruptores na placa, tamb√©m fica bonito - 1, 2, 3, 4 est√£o na posi√ß√£o LIGADO, o restante est√° DESLIGADO. <br><br>  Um leitor atento perguntar√°: como podemos enviar esbo√ßos para o ESP8266 se a porta USB estiver ocupada conectando-se √† mega parte do sistema?  E esta √© a pergunta certa, a resposta n√£o √© poss√≠vel.  E por que, ent√£o, voc√™ est√° escrevendo que nesta configura√ß√£o podemos enviar esbo√ßos para o ESP8266?  Como o Mega Server do Arduino tem a capacidade de baixar esbo√ßos no ar diretamente do IDE do Arduino pressionando alguns bot√µes, √© isso mesmo - temos o preenchimento total, tudo funciona imediatamente. <br><br>  Mas e aqueles que querem usar o quadro sem o Arduino Mega Server?  Existem apenas duas op√ß√µes: clique constantemente nos comutadores ou adicione a capacidade de fazer o download de esbo√ßos no ar em seus projetos.  Pessoalmente, gosto mais da segunda op√ß√£o. <br><br><h2>  Configura√ß√µes do IDE do Arduino </h2><br>  As configura√ß√µes do IDE do Arduino para o Mega n√£o levantam d√∫vidas, tudo √© padr√£o l√° e, para o ESP8266, darei uma captura de tela do menu com as configura√ß√µes para uma implementa√ß√£o espec√≠fica da parte do ESP na placa RobotDyn.  Voc√™ deve definir os mesmos par√¢metros, com exce√ß√£o do n√∫mero da porta - em seu sistema, provavelmente ter√° um valor diferente. <br><br><img src="https://habrastorage.org/files/e1f/d98/bac/e1fd98bacc664b7e931699cb65b1c6ae.png" alt="Configura√ß√µes do ESP8266 no IDE do Arduino"><br><br><h2>  Arduino Mega Server para RobotDyn Mega + ESP8266 </h2><br>  Para esta placa, foi lan√ßada uma vers√£o dual especial do Arduino Mega Server, que cont√©m dois servidores ao mesmo tempo, otimizados especificamente para esta placa.  Isso √© o que est√° fora de quest√£o, pois esses dois servidores cont√™m funcionalidade padr√£o e podem ser usados ‚Äã‚Äãpara qualquer um dos seus projetos. <br><br>  Voc√™ pode usar esses dois servidores independentemente na mesma placa ou adicionar a funcionalidade necess√°ria e us√°-los no modo tandem e bridge entre duas redes e quaisquer interfaces conectadas aos servidores. <br><br>  O primeiro conjunto do Mega Servidor Arduino da placa RobotDyn Mega + ESP8266 cont√©m um exemplo de teste da intera√ß√£o de dois controladores por meio de uma interface serial.  Esta √© uma demonstra√ß√£o dos recursos da tecnologia com base nos quais voc√™ pode desenvolver suas pr√≥prias solu√ß√µes. <br><br>  Agora um pouco mais sobre o desenvolvimento de um protocolo para a intera√ß√£o de dois controladores via interface serial em geral e nesta placa em particular. <br><br><h2>  Desenvolvimento de Protocolo </h2><br>  O que devemos construir uma casa?  Precisa desenvolver um protocolo de intera√ß√£o entre as duas partes do sistema atrav√©s da interface serial?  - vamos desenvolver, aqui o principal √© definir a tarefa de forma clara e correta.  Para demonstrar a opera√ß√£o em conjunto do sistema, exibimos os indicadores de opera√ß√£o "parceiro" no painel de instrumentos de cada servidor. <br><br>  <em><strong>Um pouco sobre terminologia.</strong></em>  <em>Para Mega, o "parceiro" √© ESP8266, para ESP8266, respectivamente, Mega.</em> <br><br>  Quando o parceiro estiver trabalhando, o indicador acender√° esverdeado, quando n√£o estiver trabalhando, vermelho e cinza quando o estado estiver indefinido.  Isso √© muito conveniente - durante a opera√ß√£o, voc√™ ver√° imediatamente o estado do alter ego do seu sistema. <br><br>  Para uma solu√ß√£o pr√°tica para esse problema, existem exatamente um milh√£o de maneiras, escolheremos o seguinte: os blocos de comunica√ß√£o de ambas as partes do sistema ser√£o id√™nticos, a intera√ß√£o ocorrer√° no modo full duplex, os blocos de informa√ß√µes ter√£o um formato simples e claro: <br><br><pre><code class="java hljs">?=</code> </pre> <br>  ou <br><br><pre> <code class="java hljs">?</code> </pre><br>  Este √© apenas um exemplo de teste para resolver a tarefa, voc√™ pode modificar esse protocolo de intera√ß√£o ou escrever seu pr√≥prio, adequado para suas tarefas.  Mas no protocolo j√° implementado, voc√™ pode n√£o apenas monitorar o status do parceiro, mas tamb√©m us√°-lo para muitos outros fins, por exemplo, transmitir o status dos pinos do controlador, o status dos sensores ou enviar comandos de controle ao parceiro. <br><br>  Especificamente, em nosso sistema, as equipes ter√£o esta apar√™ncia: <br><br>  <strong>? mega = 1</strong> - Mega envia dados sobre seu desempenho.  Par√¢metro "mega", valor "1". <br><br>  <strong>? esp = 1</strong> - ESP8266 envia dados sobre sua sa√∫de.  O par√¢metro √© "esp", o valor √© "1". <br><br>  Ent√£o, por exemplo, considere a implementa√ß√£o do protocolo para a mega parte do sistema. <br><br>  Da maneira padr√£o, inicializamos o m√≥dulo AMS e o hardware Serial3 Mega a uma velocidade de 115200. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynInit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Serial3.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); modulRobotdyn = MODUL_ENABLE; started(<span class="hljs-string"><span class="hljs-string">"RobotDyn"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre><br>  Verificamos o status da porta Serial3 e, no caso de dados do parceiro, formamos a vari√°vel de sequ√™ncia serialReq que cont√©m os dados ou comandos recebidos. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkSerial</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Serial3.available() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sFlag) { serialReq = <span class="hljs-string"><span class="hljs-string">""</span></span>; sFlag = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = Serial3.read(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">10</span></span>) { sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; parseSerialStr(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-number"><span class="hljs-number">13</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial()</span></span></code> </pre><br>  Analisamos os comandos e os dados e, no caso de informa√ß√µes sobre o estado do parceiro, tomamos medidas na forma de alterar o estado da vari√°vel esp. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">parseSerialCmd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String command, parameter; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pBegin = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"?"</span></span>)) + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> pParam = serialReq.indexOf(F(<span class="hljs-string"><span class="hljs-string">"="</span></span>)); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { command = serialReq.substring(pBegin); parameter = <span class="hljs-string"><span class="hljs-string">""</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command != F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { Serial.print(F(<span class="hljs-string"><span class="hljs-string">"command/parameter: "</span></span>)); Serial.print(command); Serial.print(F(<span class="hljs-string"><span class="hljs-string">"/"</span></span>)); Serial.println(parameter); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } } <span class="hljs-comment"><span class="hljs-comment">// if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd()</span></span></code> </pre><br>  Voc√™ pode adicionar facilmente o processamento de qualquer outro comando alterando e adicionando √† se√ß√£o de c√≥digo correspondente. <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command == F(<span class="hljs-string"><span class="hljs-string">"esp"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (parameter == F(<span class="hljs-string"><span class="hljs-string">"1"</span></span>)) { esp = <span class="hljs-number"><span class="hljs-number">1</span></span>; espTimer = millis(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br>  Se voc√™ usar muitos comandos e dados em seus pr√≥prios projetos e an√°lises, √© melhor projetar esta se√ß√£o de c√≥digo na forma das fun√ß√µes correspondentes. <br><br>  Resta apenas considerar a fun√ß√£o padr√£o do m√≥dulo AMS, respons√°vel por seu trabalho.  Primeiro, o status da porta √© verificado e, a cada quatro segundos, um comando √© enviado ao parceiro que Mega est√° ativo e funcionando, e o tempo decorrido desde a √∫ltima verifica√ß√£o dos dados do parceiro √© verificado e, se exceder 8 segundos, conclui-se que o parceiro n√£o est√° funcionando. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">robotdynWork</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ checkSerial(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cycle4s) { Serial3.println(F(<span class="hljs-string"><span class="hljs-string">"?mega=1"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (millis() - espTimer &gt; <span class="hljs-number"><span class="hljs-number">8000</span></span>) { esp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } } }</code> </pre><br>  Isso √© tudo m√°gico.  Verdade, nada complicado? <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo completo do m√≥dulo respons√°vel pelas comunica√ß√µes intersistema entre Mega 2560 e ESP8266</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/* Modul RobotDyn part of Arduino Mega Server project */</span></span> #ifdef ROBOTDYN_FEATURE bool sFlag = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; unsigned <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> espTimer = millis(); <span class="hljs-comment"><span class="hljs-comment">// Serial request #define MAX_SERIAL_REQ 32 String serialReq = ""; void robotdynInit() { Serial3.begin(115200); modulRobotdyn = MODUL_ENABLE; started("RobotDyn", true); } void printSerialStr() { Serial.print("["); Serial.print(serialReq); Serial.println("]"); } void parseSerialCmd() { String command, parameter; if (serialReq.indexOf(F("?")) &gt;= 0) { int pBegin = serialReq.indexOf(F("?")) + 1; if (serialReq.indexOf(F("=")) &gt;= 0) { int pParam = serialReq.indexOf(F("=")); command = serialReq.substring(pBegin, pParam); parameter = serialReq.substring(pParam + 1); } else { command = serialReq.substring(pBegin); parameter = ""; } // if (command != F("esp")) { Serial.print(F("command/parameter: ")); Serial.print(command); Serial.print(F("/")); Serial.println(parameter); //} if (command == F("esp")) { if (parameter == F("1")) { esp = 1; espTimer = millis(); } else { esp = 0; } } } // if (request.indexOf(F("?")) &gt;= 0) } // parseSerialCmd() void parseSerialStr() { if (serialReq[0] == '?') { parseSerialCmd(); } else { printSerialStr(); } } void checkSerial() { while (Serial3.available() &gt; 0) { if (sFlag) { serialReq = ""; sFlag = false; } char c = Serial3.read(); if (c == 10) { sFlag = true; parseSerialStr(); } else if (c == 13) { // skip } else { if (serialReq.length() &lt; MAX_SERIAL_REQ) { serialReq += c; } } // if } // while (Serial3.available() &gt; 0) } // checkSerial() void robotdynWork() { checkSerial(); if (cycle4s) { Serial3.println(F("?mega=1")); if (millis() - espTimer &gt; 8000) { esp = 0; } } } #endif // ROBOTDYN_FEATURE</span></span></code> </pre><br></div></div><br><h2>  Como √© a sa√≠da no monitor serial </h2><br>  No Mega 2560 Serial Monitor, a sa√≠da, os dados e os comandos da parte ESP do sistema s√£o exatamente iguais aos seus.  Para distinguir a sa√≠da do parceiro da sa√≠da da Mega, seus dados s√£o colocados entre aspas quadradas.  Nesse caso, voc√™ pode ver a reinicializa√ß√£o do ESP8266 e o ‚Äã‚Äãlog de inicializa√ß√£o do AMS no monitor serial da Mega. <br><br><img src="https://habrastorage.org/files/a03/904/3b8/a039043b86d442d7a54e10bb73b314c7.png" alt="Sa√≠da ESP8266 para o monitor da s√©rie Mega 2560"><br><br>  E o log da troca real de comandos entre as duas partes do sistema via interface serial.  Voc√™ v√™ a sa√≠da do ESP8266 com informa√ß√µes sobre a decodifica√ß√£o de dados de status do Mega na interface serial do Mega, entre aspas quadradas. <br><br><img src="https://habrastorage.org/files/b5f/444/6cf/b5f4446cf54c4c048fa568f1e3418823.png" alt="Sa√≠da ESP8266 na decodifica√ß√£o de mega comando"><br><h2>  Beleza na interface </h2><br>  Agora, um pouco sobre como tudo fica na interface do Arduino Mega Server.  Para come√ßar, darei capturas de tela de ambas as partes do sistema em funcionamento. <br><br><img src="https://habrastorage.org/files/774/faf/c92/774fafc92eb54ba29905a6ec201501da.png" alt="Arduino Mega Server para RobotDyn Mega + ESP8266"><br><br>  Elipses s√£o circulados em torno de inscri√ß√µes que identificam o controlador e a parte do sistema com a qual voc√™ est√° trabalhando atualmente.  Os c√≠rculos s√£o circulados em torno de indicadores que mostram o status do parceiro.  No momento, tudo est√° em ordem, ambas as partes do sistema funcionam normalmente e interagem normalmente entre si atrav√©s da interface interna.  Se algo der errado, voc√™ saber√° disso depois de 8 segundos no m√°ximo. <br><br><img src="https://habrastorage.org/files/f49/7ef/a1f/f497efa1ff1f427a860d4e61cdc5e13d.png" alt="Algo deu errado"><br><br>  Algo deu errado.  O ESP8266 recebeu uma atualiza√ß√£o de firmware pelo ar e a mega parte do sistema registrou o momento de sua reinicializa√ß√£o.  Ap√≥s alguns segundos, a parte ESP do sistema ser√° retomada e o indicador apagar√° em vermelho. <br><br>  Por conveni√™ncia, quando voc√™ passa o mouse sobre o indicador de status do parceiro, uma dica √© exibida e a capacidade de clicar nele e em uma janela separada a interface da segunda parte do sistema, nesse caso, a parte ESP, √© aberta.  Isso √© feito por conveni√™ncia, voc√™ pode a qualquer momento, com um clique, abrir a interface da segunda parte do sistema. <br><br><img src="https://habrastorage.org/files/d00/a61/a28/d00a61a28c6b439086a42e4510e896cb.png" alt="Dica para o AMS"><br><br><h2>  Id√©ias do projeto </h2><br>  Agora, um pouco sobre o que voc√™ pode fazer com tudo isso, tendo um pouco de imagina√ß√£o.  A prancha habitual, completamente discreta √† primeira vista, permite fazer muitas coisas completamente incomuns e interessantes.  Isto √© especialmente verdade na combina√ß√£o com o Arduino Mega Server. <br><br>  Ent√£o, a primeira coisa que vem √† mente: <br><br>  <strong>Encaminhar dados dos sensores entre os controladores.</strong>  Em ambos os lados e em quantidades ilimitadas.  Este √© um sistema que possui as vantagens de ambas as partes e as possibilidades n√£o se somam, mas o que √© chamado de efeito sin√©rgico √© observado. <br><br>  <strong>A ponte entre as interfaces.</strong>  O Arduino Mega Server pode trabalhar com muitas interfaces e este sistema permite rotear dados e comandos entre quaisquer interfaces com e sem fio conectadas. <br><br>  <strong>Trabalhe na mesma rede</strong> quando o Mega via Ethernet Shield e o ESP8266 via Wi-Fi se comunicarem com dispositivos com e sem fio na mesma rede. <br><br>  <strong>Trabalhe em redes diferentes</strong> quando o Mega estiver conectado √† Ethernet com fio e o ESP8266 via Wi-Fi para outra rede e o sistema roteia comandos e dados de uma rede para outra. <br><br>  <strong>A sa√≠da de uma parte do sistema na interface de outra.</strong>  Via Ethernet usando feeds da Web padr√£o ou atrav√©s de uma conex√£o serial interna. <br><br>  <strong>Depura√ß√£o</strong>  Uma parte do sistema pode atuar como depurador e testador de outra parte do sistema, de acordo com o seu programa. <br><br>  <strong>Temporizador de vigil√¢ncia.</strong>  Cada controlador pode atuar como um tipo de c√£o de guarda em rela√ß√£o a outro. <br><br>  <strong>Falhas de log.</strong>  Cada controlador pode manter registros do trabalho de seu parceiro, compilar estat√≠sticas e relatar situa√ß√µes alarmantes. <br><br>  <strong>Banco de dados para ESP8266.</strong>  Usando esse sistema, voc√™ pode organizar algo como um banco de dados SQL no Mega para ESP8266.  O ESP faz seu trabalho e o Mega atua como um sistema de armazenamento (at√© 32 GB). <br><br>  <strong>Piscando um ao outro.</strong>  Os controladores podem fazer a atualiza√ß√£o din√¢mica entre si de acordo com a l√≥gica incorporada ou com a chegada de um comando de controle externo. <br><br>  <strong>M√≥dulos de conex√£o.</strong>  Os controladores podem se conectar a v√°rios perif√©ricos que t√™m problemas para se conectar a qualquer parte do sistema. <br><br>  E assim por diante, e assim por diante, acho que um leitor curioso ser√° capaz de apresentar de maneira independente muitas maneiras n√£o menos interessantes de usar esse sistema. <br><br><h2>  Conclus√£o </h2><br>  Na minha opini√£o, esta √© uma solu√ß√£o muito interessante, e devemos agradecer muito ao RobotDyn por uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">taxa</a> t√£o interessante.  Eu, pelo menos, digo isso sinceramente. <br><br>  Fa√ßa o download do kit de distribui√ß√£o do Arduino Mega Server para o RobotDyn Mega + ESP8266 e verifique pessoalmente a validade de tudo o que est√° escrito aqui. Voc√™ pode acessar o site oficial do projeto Arduino Mega Server na se√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">downloads</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt402429/">https://habr.com/ru/post/pt402429/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt402417/index.html">O ciclista passou despercebido</a></li>
<li><a href="../pt402419/index.html">Analisando o novo Nintendo Switch</a></li>
<li><a href="../pt402421/index.html">Semana de V√™nus no Hemisf√©rio Norte</a></li>
<li><a href="../pt402423/index.html">Pr√°tica de idiomas offline</a></li>
<li><a href="../pt402425/index.html">Qu√≠micos s√£o os primeiros a apreciar os benef√≠cios dos computadores qu√¢nticos</a></li>
<li><a href="../pt402431/index.html">ONYX BOOX Vasco Da Gama: mais inteligente que um livro, mais simples que um tablet</a></li>
<li><a href="../pt402433/index.html">Hist√≥ria dos arranha-c√©us</a></li>
<li><a href="../pt402435/index.html">Digest "World Hi-Fi": √°udio port√°til, software, formatos e vinil</a></li>
<li><a href="../pt402437/index.html">IPTV mais fino que o RMB</a></li>
<li><a href="../pt402439/index.html">Geolocaliza√ß√£o comercial: a privacidade √© barata</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>