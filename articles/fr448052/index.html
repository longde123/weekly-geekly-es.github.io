<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏üèæ üöò üéø Mikrotik. VPN IPSEC pour NAT en tant que client ü¶è üëâ üíáüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonne journ√©e √† tous! 

 Il se trouve que dans notre entreprise au cours des deux derni√®res ann√©es, nous nous sommes lentement tourn√©s vers la microti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mikrotik. VPN IPSEC pour NAT en tant que client</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/448052/"> Bonne journ√©e √† tous! <br><br>  Il se trouve que dans notre entreprise au cours des deux derni√®res ann√©es, nous nous sommes lentement tourn√©s vers la microtique.  Les n≈ìuds principaux sont construits sur CCR1072 et les points de connexion locaux pour les ordinateurs sur les appareils sont plus simples.  Bien s√ªr, il y a une union de r√©seaux via le tunnel IPSEC, dans ce cas la configuration est assez simple et ne pose pas de difficult√©s, car il y a beaucoup de mat√©riaux sur le r√©seau.  Mais il y a certaines difficult√©s avec la connexion mobile des clients, le wiki du fabricant vous indique comment utiliser le client VPN soft Shrew (tout semble clair avec ce param√®tre) et ce client particulier utilise 99% des utilisateurs d'acc√®s √† distance, et 1% est moi, je suis juste devenu paresseux tous les entrez simplement le nom d'utilisateur et le mot de passe dans le client et je voulais un arrangement paresseux sur le canap√© et une connexion pratique aux r√©seaux de travail.  Instructions pour configurer Mikrotik pour des situations o√π il n'est m√™me pas derri√®re l'adresse grise, mais compl√®tement derri√®re l'adresse noire et peut-√™tre m√™me plusieurs NAT sur le r√©seau, je n'ai pas trouv√©.  Parce que j'ai d√ª improviser, et donc je propose de regarder le r√©sultat. <br><br>  Il y a: <br><br><ol><li>  CCR1072 comme p√©riph√©rique principal.  version 6.44.1 </li><li>  CAP ac comme point de connexion domestique.  version 6.44.1 </li></ol><br>  La principale caract√©ristique de la configuration est que le PC et Mikrotik doivent √™tre sur le m√™me r√©seau avec le m√™me adressage, qui est √©mis par le 1072 principal. <br><a name="habracut"></a><br>  Acc√©dez au param√®tre: <br><br>  1. Bien s√ªr, activez Fasttrack, mais comme fasttrack n'est pas compatible avec VPN, vous devez r√©duire son trafic. <br><br><pre><code class="plaintext hljs">/ip firewall mangle add action=mark-connection chain=forward comment="ipsec in" ipsec-policy=\ in,ipsec new-connection-mark=ipsec passthrough=yes add action=mark-connection chain=forward comment="ipsec out" ipsec-policy=\ out,ipsec new-connection-mark=ipsec passthrough=yes /ip firewall filter add action=fasttrack-connection chain=forward connection-mark=!ipsec</code> </pre> <br>  2. Ajoutez la redirection r√©seau de / vers la maison et le travail <br><br><pre> <code class="plaintext hljs">/ip firewall raw add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.76.0/24 add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.98.0/24 add action=accept chain=prerouting dst-address=10.7.76.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=10.7.77.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=10.7.98.0/24 src-address=\ 192.168.33.0/24 add action=accept chain=prerouting dst-address=192.168.33.0/24 src-address=\ 10.7.77.0/24</code> </pre><br>  3. Cr√©ez une description de connexion utilisateur <br><br><pre> <code class="plaintext hljs">/ip ipsec identity add auth-method=pre-shared-key-xauth notrack-chain=prerouting peer=CO secret=\   xauth-login=username xauth-password=password</code> </pre><br>  4. Cr√©er une proposition IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec proposal add enc-algorithms=3des lifetime=5m name="prop1" pfs-group=none</code> </pre><br>  5. Cr√©ez une strat√©gie IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec policy add dst-address=10.7.76.0/24 level=unique proposal="prop1" \ sa-dst-address=&lt;white IP 1072&gt; sa-src-address=0.0.0.0 src-address=\ 192.168.33.0/24 tunnel=yes add dst-address=10.7.77.0/24 level=unique proposal="prop1" \ sa-dst-address=&lt;white IP 1072&gt; sa-src-address=0.0.0.0 src-address=\ 192.168.33.0/24 tunnel=yes</code> </pre><br>  6. Cr√©ez un profil IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec profile set [ find default=yes ] dpd-interval=disable-dpd enc-algorithm=\ aes-192,aes-128,3des nat-traversal=no add dh-group=modp1024 enc-algorithm=aes-192,aes-128,3des name=profile_1 add name=profile_88 add dh-group=modp1024 lifetime=4h name=profile246</code> </pre><br>  7. Cr√©ez un homologue IPSEC <br><br><pre> <code class="plaintext hljs">/ip ipsec peer add address=&lt;white IP 1072&gt;/32 local-address=&lt;  &gt; name=CO profile=\ profile_88</code> </pre><br>  Et maintenant un peu de magie simple.  Comme je ne voulais pas vraiment modifier les param√®tres sur tous les appareils du r√©seau domestique, j'ai d√ª en quelque sorte raccrocher DHCP sur le m√™me r√©seau, mais il est raisonnable que Mikrotik ne permette pas de suspendre plus d'un pool d'adresses sur un pont, j'ai donc trouv√© une solution de contournement, √† savoir J'ai simplement cr√©√© un bail DHCP pour l'ordinateur portable avec une indication manuelle des param√®tres, et comme le masque de r√©seau, la passerelle et le DNS ont √©galement des num√©ros d'option dans DHCP, il a √©galement √©t√© sp√©cifi√© manuellement. <br><br>  1. Option DHCP <br><br><pre> <code class="plaintext hljs">/ip dhcp-server option add code=3 name=option3-gateway value="'192.168.33.1'" add code=1 name=option1-netmask value="'255.255.255.0'" add code=6 name=option6-dns value="'8.8.8.8'"</code> </pre><br>  2. Bail DHCP <br><br><pre> <code class="plaintext hljs">/ip dhcp-server lease add address=192.168.33.4 dhcp-option=\ option1-netmask,option3-gateway,option6-dns mac-address=&lt;MAC  &gt;</code> </pre><br>  Dans le m√™me temps, le r√©glage 1072 est presque basique, uniquement lors de la d√©livrance d'une adresse IP au client dans les param√®tres, il est indiqu√© que pour lui donner l'adresse IP saisie manuellement, et non √† partir du pool.  Pour les clients ordinaires utilisant des ordinateurs personnels, le sous-r√©seau est le m√™me que dans la configuration avec Wiki 192.168.55.0/24. <br><br>  Et j'ajouterai un peu, sur le serveur de connexion principal 1072, vous devez √©galement ajouter des r√®gles pour le transfert de r√©seau sym√©trique vers IP-Firewall-RAW.  Lors de l'ajout d'une nouvelle redirection r√©seau, il est n√©cessaire d'ajouter des r√®gles √† la politique IPSEC sur le client, le serveur, ainsi que sur le serveur IP-Firewall-RAW et la liste des coupures NAT. <br><br>  Ce param√®tre vous permet de ne pas vous connecter au PC via un logiciel tiers et le tunnel lui-m√™me soul√®ve le routeur selon les besoins.  La charge ca du client CAP est presque minimale, 8-11% √† une vitesse de 9-10MB / s dans le tunnel. <br><br>  Tous les param√®tres ont √©t√© d√©finis via Winbox, mais avec le m√™me succ√®s, cela peut √™tre fait via la console. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr448052/">https://habr.com/ru/post/fr448052/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr448040/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 294 (du 8 au 14 avril)</a></li>
<li><a href="../fr448044/index.html">Quelques aspects de la surveillance de MS SQL Server. Recommandations pour d√©finir des indicateurs de trace</a></li>
<li><a href="../fr448046/index.html">Radio Day: brevets Marconi et Popov</a></li>
<li><a href="../fr448048/index.html">Comprendre le lierre angulaire: DOM incr√©mentiel et DOM virtuel</a></li>
<li><a href="../fr448050/index.html">Holographie amateur - mat√©riaux aux halog√©nures d'argent</a></li>
<li><a href="../fr448054/index.html">SciPy, optimisation sous conditions</a></li>
<li><a href="../fr448056/index.html">Que sont les contrats intelligents?</a></li>
<li><a href="../fr448058/index.html">D√©velopper un hexapode √† partir de z√©ro (partie 5) - √©lectronique</a></li>
<li><a href="../fr448060/index.html">√âcriture d'un client NTP simple</a></li>
<li><a href="../fr448068/index.html">Des scientifiques am√©ricains ont appris aux robots √† utiliser des outils auxiliaires</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>