<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêæ üöü üë©üèø React + IndexDb + mise √† jour automatique = presque AsyncRedux üîè üò± üëéüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans cet article, je vais vous expliquer √©tape par √©tape comment pr√©parer IndexDB (une base de donn√©es int√©gr√©e √† tout navigateur moderne) pour une ut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>React + IndexDb + mise √† jour automatique = presque AsyncRedux</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472246/"><img width="300" align="right" src="https://habrastorage.org/webt/ak/5r/t4/ak5rt4e4mavxwvxlaidpfgiie0g.jpeg">  Dans cet article, je vais vous expliquer √©tape par √©tape comment pr√©parer IndexDB (une base de donn√©es int√©gr√©e √† tout navigateur moderne) pour une utilisation dans des projets √©crits en ReactJS.  Par cons√©quent, vous pouvez utiliser les donn√©es d'IndexDB aussi facilement que si elles se trouvaient dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">magasin Redux de</a> votre application. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">IndexDB</a> est un SGBD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">orient√©</a> document, un outil pratique pour le stockage temporaire d'une quantit√© relativement petite (unit√©s et dizaines de m√©gaoctets) de donn√©es structur√©es c√¥t√© navigateur.  La t√¢che standard pour laquelle je dois utiliser IndexDB comprend la mise en cache des donn√©es des r√©pertoires d'entreprises c√¥t√© client (noms de pays, villes, devises par code, etc.).  Apr√®s les avoir copi√©s c√¥t√© client, vous ne pouvez t√©l√©charger qu'occasionnellement des mises √† jour √† partir de ces r√©pertoires depuis le serveur (ou l'ensemble - ils sont petits) et ne pas le faire √† chaque fois que vous ouvrez la fen√™tre du navigateur. <br><a name="habracut"></a><br>  Il existe des m√©thodes non standard, tr√®s controvers√©es, mais efficaces pour utiliser IndexDB: <br><br><ul><li>  la mise en cache des donn√©es sur <b>tous</b> les objets m√©tier de sorte que du c√¥t√© du navigateur, utilisez les capacit√©s de tri et de filtrage √©tendues </li><li>  stockage de l'√©tat de l'application dans IndexDB au lieu de Redux Store </li></ul><br>  Trois diff√©rences cl√©s entre IndexDB et Redux Store sont importantes pour nous: <br><br><ol><li>  IndexDB est un stockage externe qui n'est pas effac√© lorsque vous quittez la page.  De plus, il en va de m√™me pour plusieurs onglets ouverts (ce qui conduit parfois √† un comportement quelque peu inattendu) </li><li>  IndexDB est un SGBD compl√®tement asynchrone.  Toutes les op√©rations - ouverture, lecture, √©criture, recherche - asynchrone. </li><li>  IndexDB ne peut pas (de mani√®re triviale) √™tre stock√© dans JSON et utiliser des techniques de lavage de cerveau Redux pour cr√©er des instantan√©s, faciliter le d√©bogage et voyager dans le pass√©. </li></ol><br><h2>  √âtape 0: liste des t√¢ches </h2><br>  D√©j√† un exemple classique avec une liste de t√¢ches.  Variante avec stockage d'√©tat dans l'√©tat du composant actuel et unique <br><br><div class="spoiler">  <b class="spoiler_title">Impl√©mentation d'un composant de liste de t√¢ches stockant la liste dans un √©tat de composant</b> <div class="spoiler_text"><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Button <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Button'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> counter <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'common/counter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Form <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Form'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Table'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step0</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'Sample task'</span></span> }, ], }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ ...state.tasks, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: state.newTaskText } ], <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, } ) ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDeleteF = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idToDelete</span></span></span><span class="hljs-function"> =&gt;</span></span> () =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: state.tasks.filter( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> { id } </span></span></span><span class="hljs-function">) =&gt;</span></span> id !== idToDelete ), } ) ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleNewTaskTextChange = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> { target: { value } } </span></span></span><span class="hljs-function">) =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: value || <span class="hljs-string"><span class="hljs-string">''</span></span>, } ); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Table</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">bordered</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">hover</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">striped</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">#</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Text</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { this.state.tasks.map( task =&gt; </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{task.id}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{task.id}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">{task.text}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleDeleteF(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">task.id</span></span></span></span><span class="xml"><span class="hljs-tag"> )} </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">variant</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"danger"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ) } </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"+1"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Form.Control</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleNewTaskTextChange}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">placeholder</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"  "</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.state.newTaskText</span></span></span></span><span class="xml"><span class="hljs-tag"> || ''} /&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onClick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleAdd}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">variant</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"primary"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Table</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">; } }</span></span></code> </pre>  ( <a href="" rel="nofollow">code source github</a> ) </div></div><br>  Jusqu'√† pr√©sent, toutes les op√©rations avec des t√¢ches sont synchrones.  Si l'ajout d'une t√¢che prend 3 secondes, le navigateur se fige juste pendant 3 secondes.  Bien s√ªr, alors que nous gardons tout en m√©moire, nous ne pouvons pas y penser.  Lorsque nous incluons le traitement avec un serveur ou avec une base de donn√©es locale, nous devrons √©galement nous occuper du beau traitement de l'asynchronie.  Par exemple, bloquer le travail avec une table (ou des √©l√©ments individuels) lors de l'ajout ou de la suppression d'√©l√©ments. <br><br>  Afin de ne pas r√©p√©ter la description de l'interface utilisateur √† l'avenir, nous la placerons dans un composant TaskList distinct, dont la seule t√¢che g√©n√©rera le code HTML de la liste des t√¢ches.  Dans le m√™me temps, nous remplacerons les boutons habituels par un wrapper sp√©cial autour du bouton d'amor√ßage, qui bloquera le bouton jusqu'√† ce que le gestionnaire de boutons termine son ex√©cution, m√™me si ce gestionnaire est une fonction asynchrone. <br><br><div class="spoiler">  <b class="spoiler_title">Impl√©mentation d'un composant stockant une liste de t√¢ches en √©tat r√©actif</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> counter <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'common/counter'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> TaskList <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/TaskList'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step01</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'Sample task'</span></span> }, ] }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">newTaskText</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: [ ...state.tasks, { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ], } ) ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDelete = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">idToDelete</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: state.tasks.filter( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> { id } </span></span></span><span class="hljs-function">) =&gt;</span></span> id !== idToDelete ), } ) ); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;&gt; &lt;h1&gt;      &lt;/h1&gt; &lt;h2&gt;       &lt;/h2&gt; &lt;TaskList onAdd={this.handleAdd} onDelete={this.handleDelete} tasks={this.state.tasks} /&gt; &lt;/&gt;; } }</code> </pre>  ( <a href="" rel="nofollow">code source github</a> ) </div></div><br><div class="spoiler">  <b class="spoiler_title">Impl√©mentation d'un composant qui affiche une liste de t√¢ches et contient un formulaire pour en ajouter une nouvelle</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Button <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./AutoDisableButtonWithSpinner'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Form <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Form'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Table <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-bootstrap/Table'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TaskList</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">newTaskAdding</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">newTaskText</span></span>: <span class="hljs-string"><span class="hljs-string">''</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">newTaskAdding</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//   ,     await this.props.onAdd( this.state.newTaskText ); this.setState( { newTaskText: '' } ); } finally { this.setState( { newTaskAdding: false } ); } }; this.handleDeleteF = idToDelete =&gt; async() =&gt; await this.props.onDelete( idToDelete ); this.handleNewTaskTextChange = ( { target: { value } } ) =&gt; this.setState( { newTaskText: value || '', } ); } render() { return &lt;Table bordered hover striped&gt; &lt;thead&gt;&lt;tr&gt; &lt;th&gt;#&lt;/th&gt;&lt;th&gt;Text&lt;/th&gt;&lt;th /&gt; &lt;/tr&gt;&lt;/thead&gt; &lt;tbody&gt; { this.props.tasks.map( task =&gt; &lt;tr key={task.id}&gt; &lt;td&gt;{task.id}&lt;/td&gt; &lt;td&gt;{task.text}&lt;/td&gt; &lt;td&gt;&lt;Button onClick={this.handleDeleteF( task.id )} type="button" variant="danger"&gt;&lt;/Button&gt;&lt;/td&gt; &lt;/tr&gt; ) } &lt;tr key="+1"&gt; &lt;td /&gt; &lt;td&gt;&lt;Form.Control disabled={this.state.newTaskAdding} onChange={this.handleNewTaskTextChange} placeholder="  " type="text" value={this.state.newTaskText || ''} /&gt;&lt;/td&gt; &lt;td&gt;&lt;Button onClick={this.handleAdd} type="button" variant="primary"&gt;&lt;/Button&gt;&lt;/td&gt; &lt;/tr&gt; &lt;/tbody&gt; &lt;/Table&gt;; } }</span></span></code> </pre>  ( <a href="" rel="nofollow">code source github</a> ) </div></div><br>  D√©j√† dans l'exemple de code, vous pouvez voir les mots-cl√©s async / wait.  Les constructions asynchrones / attendent peuvent r√©duire consid√©rablement la quantit√© de code qui fonctionne avec Promises.  Le mot-cl√© wait vous permet d'attendre une r√©ponse d'une fonction renvoyant Promise, comme s'il s'agissait d'une fonction r√©guli√®re (au lieu d'attendre un r√©sultat dans then ()).  Bien s√ªr, une fonction asynchrone ne se transforme pas par magie en une fonction synchrone et, par exemple, le thread d'ex√©cution sera interrompu lorsque l'attente est utilis√©e.  Mais alors le code devient plus concis et compr√©hensible, et wait peut √™tre utilis√© √† la fois dans les boucles et dans les constructions try / catch / finally. <br><br>  Par exemple, <a href="" rel="nofollow"><code> TaskList</code> appelle</a> non seulement le gestionnaire <code>this.props.onAdd</code> , mais le fait √† l'aide du mot cl√© <code>this.props.onAdd</code> .  Dans ce cas, si le gestionnaire est une fonction normale qui ne renverra rien ou ne renverra aucune valeur autre que <code>Promise</code> , le composant <code>TaskList</code> continuera simplement la m√©thode <code>handleAdd</code> de la mani√®re habituelle.  Mais si le gestionnaire renvoie <code>Promise</code> (y compris si le gestionnaire est d√©clar√© en tant que fonction asynchrone), alors la <code>TaskList</code> attendra la fin de l'ex√©cution du gestionnaire, et ce n'est <code>newTaskAdding</code> les valeurs des <code>newTaskText</code> <code>newTaskAdding</code> et <code>newTaskText</code> seront r√©initialis√©es. <br><br><h2>  √âtape 1: ajouter IndexDB au composant React </h2><br>  Pour simplifier notre travail, nous allons d'abord √©crire un composant simple qui impl√©mente les m√©thodes Promise pour: <br><br><ul><li>  ouverture d'une base de donn√©es avec gestion des erreurs triviale </li><li>  rechercher des √©l√©ments dans la base de donn√©es </li><li>  ajout d'√©l√©ments √† la base de donn√©es </li></ul><br>  Le premier est le plus ¬´non trivial¬ª - jusqu'√† 5 gestionnaires d'√©v√©nements.  Cependant, pas de science fus√©e: <br><br><div class="spoiler">  <b class="spoiler_title">openDatabasePromise () - ouvre une base de donn√©es</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">openDatabasePromise</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> keyPath </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> resolve, reject </span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dbOpenRequest = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.indexedDB.open( DB_NAME, <span class="hljs-string"><span class="hljs-string">'1.0.0'</span></span> ); dbOpenRequest.onblocked = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { reject( <span class="hljs-string"><span class="hljs-string">'    ,    , '</span></span> + <span class="hljs-string"><span class="hljs-string">'      .'</span></span> ); }; dbOpenRequest.onerror = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-string"><span class="hljs-string">'Unable to open indexedDB '</span></span> + DB_NAME ); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( err ); reject( <span class="hljs-string"><span class="hljs-string">'   ,       .'</span></span> + <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> err.message ? </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">' : '</span></span></span></span><span class="hljs-function"><span class="hljs-params"> + err.message : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span></span><span class="hljs-function">) ); }; </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dbOpenRequest</span></span></span><span class="hljs-function">.</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onupgradeneeded</span></span></span><span class="hljs-function"> = </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> db = event.target.result; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { db.deleteObjectStore( OBJECT_STORE_NAME ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> ( err ) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( err ); } db.createObjectStore( OBJECT_STORE_NAME, { keyPath } ); }; dbOpenRequest.onsuccess = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info( <span class="hljs-string"><span class="hljs-string">'Successfully open indexedDB connection to '</span></span> + DB_NAME ); resolve( dbOpenRequest.result ); }; dbOpenRequest.onerror = reject; } ); }</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">getAllPromise / getPromise / putPromise - encapsule les appels IndexDb dans Promise</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ObjectStore,   IDBRequest //     Promise function wrap( methodName ) { return function() { const [ objectStore, ...etc ] = arguments; return new Promise( ( resolve, reject ) =&gt; { const request = objectStore[ methodName ]( ...etc ); request.onsuccess = () =&gt; resolve( request.result ); request.onerror = reject; } ); }; } const deletePromise = wrap( 'delete' ); const getAllPromise = wrap( 'getAll' ); const getPromise = wrap( 'get' ); const putPromise = wrap( 'put' ); }</span></span></code> </pre></div></div><br>  Mettre tout cela ensemble dans une classe IndexedDbRepository <br><br><div class="spoiler">  <b class="spoiler_title">IndexedDbRepository - wrapper autour d'IDBDatabase</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> DB_NAME = <span class="hljs-string"><span class="hljs-string">'objectStore'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> OBJECT_STORE_NAME = <span class="hljs-string"><span class="hljs-string">'objectStore'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IndexedDbRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( keyPath ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.error = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.keyPath = keyPath; <span class="hljs-comment"><span class="hljs-comment">//     async //      this.openDatabasePromise = this._openDatabase(); } async _openDatabase( keyPath ) { try { this.dbConnection = await openDatabasePromise( keyPath ); } catch ( error ) { this.error = error; throw error; } } async _tx( txMode, callback ) { await this.openDatabasePromise; // await db connection const transaction = this.dbConnection.transaction( [ OBJECT_STORE_NAME ], txMode ); const objectStore = transaction.objectStore( OBJECT_STORE_NAME ); return await callback( objectStore ); } async findAll() { return this._tx( 'readonly', objectStore =&gt; getAllPromise( objectStore ) ); } async findById( key ) { return this._tx( 'readonly', objectStore =&gt; getPromise( objectStore, key ) ); } async deleteById( key ) { return this._tx( 'readwrite', objectStore =&gt; deletePromise( objectStore, key ) ); } async save( item ) { return this._tx( 'readwrite', objectStore =&gt; putPromise( objectStore, item ) ); } }</span></span></code> </pre>  ( <a href="" rel="nofollow">code source github</a> ) </div></div><br>  Vous pouvez maintenant acc√©der √† IndexDB √† partir du code: <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-comment"><span class="hljs-comment">// ,     await db.save( { id: 42, text: 'Task text' } ); const item = await db.findById( 42 ); const items = await db.findAll();</span></span></code> </pre><br>  Connectez ce ¬´r√©f√©rentiel¬ª √† notre composant.  Selon les r√®gles de react, un appel au serveur doit √™tre dans la m√©thode componentDidMount (): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IndexedDbRepository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'../common/IndexedDbRepository'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-comment"><span class="hljs-comment">//     this.repository.findAll().then( tasks =&gt; this.setState( { tasks } ) ); }</span></span></code> </pre><br>  Th√©oriquement, la fonction <code>componentDidMount()</code> peut √™tre d√©clar√©e async, puis les constructions async / attendent peuvent √™tre utilis√©es √† la place de then ().  Mais <code>componentDidMount()</code> n'est toujours pas ¬´notre¬ª fonction, mais appel√© par React.  Qui sait comment la biblioth√®que react 17.x se comportera en r√©ponse √† une tentative de retour de <code>Promise</code> au lieu d'√™tre <code>undefined</code> ? <br><br>  Maintenant, dans le constructeur, au lieu de le remplir avec un tableau vide (ou un tableau avec des donn√©es de test), nous le remplirons avec null.  Et dans le rendu, il traitera ce null comme la n√©cessit√© d'attendre le traitement des donn√©es.  Ceux qui souhaitent, en principe, peuvent mettre cela dans des drapeaux s√©par√©s, mais pourquoi produire des entit√©s? <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> render() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.tasks === <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;&gt;&lt;Spinner animation="border" aria-hidden="true" as="span" role="status" /&gt;&lt;span&gt;  ...&lt;/span&gt;&lt;/&gt;; /* ... */ }</code> </pre><br>  Il reste √† impl√©menter les <code>handleAdd</code> / <code>handleDelete</code> : <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( newTaskText ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.save( { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.findAll() } ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDelete = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( idToDelete ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.deleteById( idToDelete ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.findAll() } ); }; }</code> </pre><br>  Dans les deux gestionnaires, nous nous tournons d'abord vers le r√©f√©rentiel pour ajouter ou supprimer un √©l√©ment, puis nous effa√ßons l'√©tat du composant actuel et demandons √† nouveau une nouvelle liste au r√©f√©rentiel.  Il semble que les appels √† setState () se feront l'un apr√®s l'autre.  Mais le mot-cl√© wait dans les derni√®res lignes des gestionnaires provoquera le deuxi√®me appel setState () uniquement apr√®s la r√©solution de Promise () obtenue √† partir de la m√©thode findAll (). <br><br><h2>  √âtape 2. √âcoutez les changements </h2><br>  Un gros d√©faut dans le code ci-dessus est que, premi√®rement, le r√©f√©rentiel est connect√© dans chaque composant.  Deuxi√®mement, si un composant modifie le contenu du r√©f√©rentiel, l'autre composant n'en est pas inform√© jusqu'√† ce qu'il relise l'√©tat suite √† des actions de l'utilisateur.  C'est g√™nant. <br><br>  Pour lutter contre cela, nous allons introduire le nouveau composant RepositoryListener et le laisser faire deux choses.  Ce composant, dans un premier temps, pourra s'abonner aux modifications du r√©f√©rentiel.  Deuxi√®mement, RepositoryListener informera le composant qui l'a cr√©√© de ces modifications. <br><br>  Tout d'abord, en ajoutant la possibilit√© d'enregistrer des gestionnaires dans IndexedDbRepository: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IndexedDbRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>( keyPath ) { <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> } <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> addListener( listener ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.add( listener ); } onChange() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stamp++; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.forEach( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">listener</span></span></span><span class="hljs-function"> =&gt;</span></span> listener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.stamp ) ); } removeListener( listener ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.listeners.delete( listener ); } }</code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br><br>  Nous passerons un tampon aux gestionnaires, qui changera √† chaque appel √† onChange ().  Et nous modifions la m√©thode _tx pour que <code>onChange()</code> appel√© pour chaque appel dans une transaction en mode <code>readwrite</code> : <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> _tx( txMode, callback ) { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.openDatabasePromise; <span class="hljs-comment"><span class="hljs-comment">// await db connection try { const transaction = this.dbConnection.transaction( [ OBJECT_STORE_NAME ], txMode ); const objectStore = transaction.objectStore( OBJECT_STORE_NAME ); return await callback( objectStore ); } finally { if ( txMode === 'readwrite' ) this.onChange(); // notify listeners } }</span></span></code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br><br>  Si nous utilisions toujours <code>then()</code> / <code>catch()</code> pour travailler avec Promise, nous devrions soit dupliquer l'appel √† <code>onChange()</code> , soit utiliser des polyfills sp√©ciaux pour Promise () qui prennent en charge <code>final()</code> .  Heureusement, async / wait vous permet de le faire simplement et sans code inutile. <br><br>  Le composant RepositoryListener lui-m√™me connecte un √©couteur d'√©v√©nements dans les m√©thodes componentDidMount et componentWillUnmount: <br><br><div class="spoiler">  <b class="spoiler_title">Code RepositoryListener</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> IndexedDbRepository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./IndexedDbRepository'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RepositoryListener</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repositoryStamp</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.onChange( repositoryStamp ); } componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentDidUpdate() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentWillUnmount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unsubscribe(); } subscribe() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { repository } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( repository <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> IndexedDbRepository &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository !== repository ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository.removeListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener ); } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository = repository; repository.addListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener ); } } unsubscribe( ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository.removeListener( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repositoryListener ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevRepository = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.children || <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } }</code> </pre>  ( <a href="" rel="nofollow">code source github</a> ) </div></div><br>  Nous allons maintenant inclure le traitement des modifications du r√©f√©rentiel dans notre composant principal et, guid√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">par le principe DRY</a> , nous supprimerons le code correspondant du <code>handleDelete</code> <code>handleAdd</code> / <code>handleDelete</code> : <br><br><pre> <code class="javascript hljs"> <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleAdd = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( newTaskText ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.save( { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleDelete = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>( idToDelete ) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.deleteById( idToDelete ); }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepositoryChanged = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span>() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.findAll() } ); }; } componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepositoryChanged(); <span class="hljs-comment"><span class="hljs-comment">// initial load }</span></span></code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br><br>  Et nous ajoutons un appel √† handleRepositoryChanged √† partir du RepositoryListener connect√©: <br><br><pre> <code class="javascript hljs"> render() { <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleRepoChanged}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.repository}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">TaskList</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onAdd</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleAdd}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onDelete</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleDelete}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">tasks</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.state.tasks}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">; }</span></span></code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br><br><h2>  √âtape 3. Retirez le chargement des donn√©es et leur mise √† jour dans un composant distinct </h2><br>  Nous avons √©crit un composant qui peut recevoir des donn√©es du r√©f√©rentiel, peut changer des donn√©es dans le r√©f√©rentiel.  Mais si vous imaginez un grand projet avec plus de 100 composants, il s'av√®re que <b>chaque</b> composant qui affiche des donn√©es du r√©f√©rentiel sera oblig√© de: <br><br><ul><li>  Assurez-vous que le r√©f√©rentiel est correctement connect√© √† partir d'un seul point </li><li>  Fournir le chargement initial des donn√©es dans la m√©thode <code>componentDidMount()</code> </li><li>  Connectez le composant <code>RepositoryListener</code> , qui fournit un appel de gestionnaire pour recharger les modifications </li></ul><br>  Y a-t-il trop d'actions en double?  Il semble que non.  Et si quelque chose est oubli√©?  Se perdre avec le copier-coller? <br><br>  Ce serait formidable de s'assurer en quelque sorte que nous √©crivons une fois la r√®gle pour obtenir la liste des t√¢ches du r√©f√©rentiel, et quelque chose de magique ex√©cute ces m√©thodes, nous donne des donn√©es, traite les changements dans le r√©f√©rentiel, et pour le tas, il peut √©galement connecter ce r√©f√©rentiel. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doFindAllTasks = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> repo </span></span></span><span class="hljs-function">) =&gt;</span></span> repo.findAll(); <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> &lt;DataProvider doCalc={ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doFindAllTasks }&gt; {(data) =&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">...   -,   data...</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">span</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>} &lt;<span class="hljs-regexp"><span class="hljs-regexp">/DataProvider&gt;</span></span></code> </pre><br>  Le seul moment non trivial dans l'impl√©mentation de ce composant est que doFindAllTasks () est Promise.  Pour faciliter notre travail, nous allons cr√©er un composant distinct qui attend l'ex√©cution de Promise et appelle un descendant avec une valeur calcul√©e: <br><br><div class="spoiler">  <b class="spoiler_title">PromiseComponent Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { PureComponent } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PromiseComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = { <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } componentDidMount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentDidUpdate( ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.subscribe(); } componentWillUnmount() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.unsubscribe(); } subscribe() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { cleanOnPromiseChange, promise } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( promise <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise !== promise ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( cleanOnPromiseChange ) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise = promise; promise.then( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">value</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise === promise ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, value } ); } } ) .catch( <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">error</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise === promise ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.setState( { error, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span> } ); } } ); } } unsubscribe( ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.prevPromise = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } render() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { children, fallback } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { error, value } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( error !== <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> error; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( value === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || value === <span class="hljs-literal"><span class="hljs-literal">null</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> fallback || <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> children( value ); } }</code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br></div></div><br>  Ce composant dans sa logique et sa structure interne est tr√®s similaire √† RepositoryListener.  Parce que l'un et l'autre doivent ¬´signer¬ª, ¬´√©couter¬ª les √©v√©nements et les traiter d'une mani√®re ou d'une autre.  Et gardez √©galement √† l'esprit que les √©v√©nements dont vous devez √©couter peuvent changer. <br><br>  De plus, le composant tr√®s magique DataProvider semble jusqu'√† pr√©sent tr√®s simple: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> repository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RepositoryHolder'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepoChanged = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.forceUpdate(); } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleRepoChanged}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{repository}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromiseComponent</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">promise</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.props.doCalc(</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag"> )}&gt;</span></span></span><span class="xml"> {data =&gt; this.props.children( data )} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromiseComponent</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } }</code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br><br>  En effet, nous avons pris le r√©f√©rentiel (et un RepositoryHolder singlenton s√©par√©, qui est maintenant en importation), appel√© doCalc, cela vous permettra de transf√©rer des donn√©es de t√¢che vers this.props.children, et donc de dresser une liste de t√¢ches.  Singlenton a aussi l'air simple: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> repository = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> IndexedDbRepository( <span class="hljs-string"><span class="hljs-string">'id'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> repository;</code> </pre><br>  Remplacez maintenant l'appel de base de donn√©es du composant principal par l'appel DataProvider: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> repository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RepositoryHolder'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step3</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.doFindAllTasks = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repository</span></span></span><span class="hljs-function"> =&gt;</span></span> repository.findAll(); <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> } render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &lt;DataProvider doCalc={this.doFindAllTasks} fallback={&lt;&gt;&lt;Spinner animation="border" aria-hidden="true" as="span" role="status" /&gt;&lt;span&gt;  ...&lt;/span&gt;&lt;/&gt;}&gt; { tasks =&gt; &lt;TaskList onAdd={this.handleAdd} onDelete={this.handleDelete} tasks={tasks} /&gt; } &lt;/DataProvider&gt;; } }</code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br><br>  Cela pourrait s'arr√™ter.  Cela s'est plut√¥t bien pass√©: nous d√©crivons la r√®gle de r√©ception des donn√©es, et un composant s√©par√© surveille la r√©ception r√©elle de ces donn√©es, ainsi que la mise √† jour.  Il y avait litt√©ralement quelques petites choses: <br><br><ul><li>  Pour chaque demande de donn√©es, quelque part dans le code (mais pas dans la m√©thode <code>render()</code> vous devez d√©crire la fonction d'acc√®s au r√©f√©rentiel, puis transmettre cette fonction au DataProvider </li><li>  L'appel au DataProvider est grand et tout √† fait dans l'esprit de React, mais tr√®s moche du point de vue de JSX.  Si vous avez plusieurs composants, deux ou trois niveaux d'imbrication de diff√©rents DataProviders vous embrouilleront beaucoup. </li><li>  Il est regrettable que la r√©ception des donn√©es se fasse dans un composant (DataProvider) et que leur modification se fasse dans un autre (composant principal).  Je voudrais le d√©crire avec le m√™me m√©canisme. </li></ul><br><h2>  √âtape 4. connect () </h2><br>  Familier avec react-redux par le titre du titre d√©j√† devin√©.  Je ferai le conseil suivant au reste: ce serait bien si, au lieu d'appeler children () avec des param√®tres, le composant de service DataProvider remplirait les propri√©t√©s de notre composant en fonction des r√®gles.  Et si quelque chose a chang√© dans le r√©f√©rentiel, cela changerait simplement les propri√©t√©s avec le m√©canisme React standard. <br><br>  Pour cela, nous utiliserons le composant d'ordre sup√©rieur.  En fait, ce n‚Äôest rien de compliqu√©, c‚Äôest juste une fonction qui prend une classe de composants comme param√®tre et donne un autre composant plus complexe.  Par cons√©quent, notre fonction que nous √©crivons sera: <br><br><ul><li>  Prenez comme argument la classe de composants o√π passer les param√®tres </li><li>  Acceptez un ensemble de r√®gles, comment obtenir des donn√©es du r√©f√©rentiel et dans quelles propri√©t√©s les mettre </li><li>  Dans son utilisation, elle sera similaire √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">la fonction connect () de react-redux</a> . </li></ul><br>  L'appel √† cette fonction ressemblera √† ceci: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mapRepoToProps = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repository</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">tasks</span></span>: repository.findAll(), } ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mapRepoToActions = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">repository</span></span></span><span class="hljs-function"> =&gt;</span></span> ( { <span class="hljs-attr"><span class="hljs-attr">doAdd</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> newTaskText </span></span></span><span class="hljs-function">) =&gt;</span></span> repository.save( { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: counter(), <span class="hljs-attr"><span class="hljs-attr">text</span></span>: newTaskText } ), <span class="hljs-attr"><span class="hljs-attr">doDelete</span></span>: <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> idToDelete </span></span></span><span class="hljs-function">) =&gt;</span></span> repository.deleteById( idToDelete ), } ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Step4Connected = connect( mapRepoToProps, mapRepoToActions )( Step4 );</code> </pre><br>  Les premi√®res lignes <code>Step4</code> mappage entre le nom de propri√©t√© du composant <code>Step4</code> et les valeurs qui seront charg√©es √† partir du r√©f√©rentiel.  Vient ensuite le mappage des actions: que se passera-t-il si <code>Step4</code> appelez <code>this.props.doAdd(...)</code> ou <code>this.props.doDelete(...)</code> partir du composant <code>Step4</code> .  Et la derni√®re ligne rassemble tout et appelle la fonction de connexion.  Le r√©sultat est un nouveau composant (c'est pourquoi cette technique est appel√©e composant d'ordre sup√©rieur).  Et nous n'exporterons plus du fichier le composant Step4 d'origine, mais le wrapper qui l'entoure: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step4</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> } <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Step4Connected = connect( <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> )( Step4 ); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Step4Connected;</code> </pre><br>  Et le composant de travail avec TaskList ressemble maintenant √† un simple wrapper: <br><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Step4</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ render() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.tasks === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.tasks === <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? &lt;&gt;&lt;Spinner animation="border" aria-hidden="true" as="span" role="status" /&gt;&lt;span&gt;  ...&lt;/span&gt;&lt;/&gt; : &lt;TaskList onAdd={this.props.doAdd} onDelete={this.props.doDelete} tasks={this.props.tasks} /&gt;; } }</code> </pre><br>  ( <a href="" rel="nofollow">code source github</a> ) <br><br>  Et c'est tout.  Aucun constructeur, aucun gestionnaire suppl√©mentaire - tout est plac√© par la fonction connect () dans les accessoires du composant. <br><br>  Reste √† voir √† quoi devrait ressembler la fonction connect (). <br><br><div class="spoiler">  <b class="spoiler_title">Code Connect ()</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> repository <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./RepositoryHolder'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* ... */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Connected</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PureComponent</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>( ...arguments ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.handleRepoChanged = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.forceUpdate(); } render() { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { childClass, childProps, mapRepoToProps, mapRepoToActions } = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> promises = mapRepoToProps( repository, childProps ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> actions = mapRepoToActions( repository, childProps ); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onChange</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{this.handleRepoChanged}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">repository</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{repository}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromisesComponent</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">promises</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{promises}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> { values =&gt; React.createElement( childClass, { ...childProps, ...values, ...actions, } )} </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">PromisesComponent</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">RepositoryListener</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> mapRepoToProps, mapRepoToActions </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">childClass</span></span></span><span class="hljs-function"> =&gt;</span></span> props =&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">Connected</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">childClass</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{childClass}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">childProps</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{props}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mapRepoToActions</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{mapRepoToActions}</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">mapRepoToProps</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{mapRepoToProps}</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">; }</span></span></code> </pre>  ( <a href="" rel="nofollow">code source github</a> ) </div></div><br>  Le code ne semble pas non plus tr√®s compliqu√© ... bien que si vous commencez √† plonger, des questions se poseront.  Vous devez lire depuis la fin.  C'est l√† que la fonction <code>connect()</code> est d√©finie.  Il prend deux param√®tres, puis renvoie une fonction qui renvoie ... encore une fonction?  Pas vraiment.  La derni√®re construction d' <code>props =&gt; &lt;Connected...</code> renvoie non seulement une fonction, mais un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">composant fonctionnel React</a> .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ainsi, lorsque nous int√©grerons ConnectedStep4 dans une arborescence virtuelle, cela inclura: </font></font><br><br><ul><li> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">parent -&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> composant fonctionnel anonyme -&gt; Connect -&gt; RepositoryListener -&gt; PromisesComponent -&gt; Step4</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jusqu'√† 4 classes interm√©diaires, mais chacune remplit sa fonction. Un composant sans nom prend les param√®tres pass√©s √† la fonction </font></font><code>connect()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, la classe du composant imbriqu√©, les propri√©t√©s qui sont transf√©r√©es au composant lui-m√™me lorsqu'il est appel√© (props) et les transmet d√©j√† au composant </font></font><code>Connect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Le composant </font></font><code>Connect</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est charg√© d'obtenir un ensemble √† partir des param√®tres transmis </font></font><code>Promise</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(un objet dictionnaire avec des cl√©s de ligne et des valeurs de promesse). </font></font><code>PromisesComponent</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">fournit le calcul des valeurs, en les renvoyant au composant Connect, qui, avec les propri√©t√©s transf√©r√©es d'origine (accessoires), les propri√©t√©s calcul√©es (valeurs) et les propri√©t√©s-actions (actions), les transmet au composant </font></font><code>Step4</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(via un appel </font></font><code>React.createElement(...)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). Eh bien, le composant</font></font><code>RepositoryListener</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">met √† jour le composant, for√ßant √† recalculer promis'y si quelque chose a chang√© dans le r√©f√©rentiel. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par cons√©quent, si l'un des composants souhaite utiliser le r√©f√©rentiel depuis IndexDb, il lui suffira de connecter une fonction </font></font><code>connect()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, de d√©terminer le mappage entre les propri√©t√©s et les fonctions d'obtention de propri√©t√©s du r√©f√©rentiel et de les utiliser sans aucun mal de t√™te suppl√©mentaire.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√âtape 5. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@ vlsergey / react-indexdb-repo</font></font></a> </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Enfin, nous organisons tout cela sous la forme d'une biblioth√®que afin que d'autres d√©veloppeurs puissent l'utiliser dans leurs projets. </font><font style="vertical-align: inherit;">Le r√©sultat de cette √©tape a √©t√©:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioth√®que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@ vlsergey / REACT-Promesse</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - mise en </font><font style="vertical-align: inherit;">≈ìuvre PromiseComponent et PromisesComponent soutenir les </font><font style="vertical-align: inherit;">r√©sultats de Memoization (√† moins UI ¬´ tics ¬ª lorsque nous sans int√©r√™t √† des </font><font style="vertical-align: inherit;">changements)</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Biblioth√®que </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">@ vlsergey / REACT-indexdb-repo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - IndexedDbRepository de mise en </font><font style="vertical-align: inherit;">≈ìuvre, fonction de </font><font style="vertical-align: inherit;">connexion () et certaines classes utilitaires</font></font></li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un exemple d'utilisation de cette biblioth√®que pour cr√©er une liste de t√¢ches</font></font></a> </li></ul><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Au lieu d'une conclusion: ce qui reste √† la mer </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Le code ci-dessus est d√©j√† suffisamment pratique pour √™tre utilis√© dans des solutions industrielles. </font><font style="vertical-align: inherit;">Mais n'oubliez pas les limitations:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Les propri√©t√©s qui ne changent pas toujours devraient conduire √† de nouvelles promesses. </font><font style="vertical-align: inherit;">Ici, vous devez utiliser la fonction de m√©morisation, mais prenez en compte l'indicateur de changement de base de donn√©es. </font><font style="vertical-align: inherit;">C'est l√† que le tampon de IndexedDbRepository est utile (peut-√™tre que ce morceau de code semblait redondant pour quelqu'un).</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La connexion du r√©f√©rentiel via l'importation, m√™me en un seul endroit, est incorrecte. </font><font style="vertical-align: inherit;">Il faut regarder vers l'utilisation des contextes.</font></font></li><li>     ,     IndexedDB      . </li><li>            :     .     .   IndexDB      ¬´¬ª   ,    ‚Äî       . </li><li>  ,  IndexDB    Redux Storage.      IndexDB    ,            . </li></ul><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">   </a> <br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Online-</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472246/">https://habr.com/ru/post/fr472246/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472230/index.html">Chips for ML - parler de nouveaux produits</a></li>
<li><a href="../fr472232/index.html">De ¬´Color Extender for ZX-Spectrum¬ª √† ZX-Poly</a></li>
<li><a href="../fr472234/index.html">Crypto-monnaie: est-ce toujours un freeloader ou un partenaire?</a></li>
<li><a href="../fr472240/index.html">√Ä propos de la gamification. Qu'est-ce que c'est, pourquoi et comment le faire? D√©veloppeur Look</a></li>
<li><a href="../fr472242/index.html">Nous avons dix fois acc√©l√©r√© l'ordonnanceur Tokio</a></li>
<li><a href="../fr472248/index.html">Comment nous avons fusionn√© la programmation finale d'IT-Planet</a></li>
<li><a href="../fr472252/index.html">√âv√©nements num√©riques √† Moscou du 21 au 28 octobre</a></li>
<li><a href="../fr472254/index.html">√âv√©nements num√©riques √† Saint-P√©tersbourg du 21 au 28 octobre</a></li>
<li><a href="../fr472258/index.html">Comment "apprendre √† apprendre" - am√©liorer la pleine conscience</a></li>
<li><a href="../fr472262/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 318 (du 14 au 20 octobre)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>