<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•ë üõ§Ô∏è üñï Distributeur de jet ok.ru/music üë©üèª‚ÄçüöÄ ‚ò¶Ô∏è üèéÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je travaille dans l'√©quipe de la plateforme Odnoklassniki et aujourd'hui je parlerai des d√©tails d'architecture, de conception et d'impl√©mentation du ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Distributeur de jet ok.ru/music</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/434206/"><img src="https://habrastorage.org/webt/m8/yb/sn/m8ybsnu0c1bqakexungs-hkisui.png"><br><br>  Je travaille dans l'√©quipe de la plateforme Odnoklassniki et aujourd'hui je parlerai des d√©tails d'architecture, de conception et d'impl√©mentation du service de distribution de musique. <br><a name="habracut"></a><br><blockquote>  L'article est une transcription du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport</a> du <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Joker 2018</a> . </blockquote><br><h1>  Quelques statistiques </h1><br>  Tout d'abord, quelques mots sur OK.  Il s'agit d'un gigantesque service utilis√© par plus de 70 millions d'utilisateurs.  Ils sont desservis par 7 mille voitures dans 4 centres de donn√©es.  R√©cemment, nous avons franchi la barre du trafic √† 2 Tb / s sans tenir compte des nombreux sites CDN.  Nous tirons le maximum de notre mat√©riel, les services les plus charg√©s desservent jusqu'√† 100 000 requ√™tes par seconde √† partir d'un n≈ìud quadric≈ìur.  De plus, presque tous les services sont √©crits en Java. <br><br>  Il existe de nombreuses sections dans OK, l'une des plus populaires est ¬´Musique¬ª.  Dans ce document, les utilisateurs peuvent t√©l√©charger leurs pistes, acheter et t√©l√©charger de la musique de qualit√© diff√©rente.  La section a un merveilleux catalogue, un syst√®me de recommandation, une radio et bien plus encore.  Mais le but principal du service, bien s√ªr, est de jouer de la musique. <br><br>  Le distributeur de musique est responsable du transfert des donn√©es vers les lecteurs utilisateurs et les applications mobiles.  Vous pouvez l'attraper dans l'inspecteur Web si vous regardez les demandes au domaine musicd.mycdn.me.  L'API du distributeur est extr√™mement simple.  Il r√©pond aux requ√™tes HTTP <code>GET</code> et √©met la plage de pistes demand√©e. <br><br><img src="https://habrastorage.org/webt/j9/va/ze/j9vazesvr2fuqtpvhec0uj7gbmq.png"><br><br>  En p√©riode de pointe, la charge atteint 100 Gb / s via un demi-million de connexions.  En fait, le distributeur de musique est une interface de mise en cache devant notre r√©f√©rentiel de pistes interne, qui est bas√© sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">One Blob Storage</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">One Cold Storage</a> et contient des p√©taoctets de donn√©es. <br><br>  Puisque j'ai parl√© de mise en cache, regardons les statistiques de lecture.  Nous voyons un TOP prononc√©. <br><br><img src="https://habrastorage.org/webt/q6/jv/pc/q6jvpcopw2t0xt29sl84lwp1gkg.png"><br><br>  Environ 140 titres couvrent 10% de toutes les pi√®ces par jour.  Si nous voulons que notre serveur de cache ait un hit de cache d'au moins 90%, nous avons besoin d'un demi-million de pistes pour y entrer.  95% - pr√®s d'un million de pistes. <br><br><h1>  Exigences du distributeur </h1><br>  Quels objectifs nous sommes-nous fix√©s lors du d√©veloppement de la prochaine version du distributeur? <br><br>  Nous voulions qu'un n≈ìud puisse contenir 100 000 connexions.  Et ce sont des connexions client lentes: un tas de navigateurs et d'applications mobiles sur des r√©seaux √† des vitesses variables.  Dans le m√™me temps, le service, comme tous nos syst√®mes, doit √™tre √©volutif et tol√©rant aux pannes. <br><br>  Tout d'abord, nous devons augmenter la bande passante du cluster afin de suivre la popularit√© croissante du service et √™tre en mesure de donner de plus en plus de trafic.  Il est √©galement n√©cessaire de pouvoir faire √©voluer la capacit√© totale du cache de cluster, car le cache atteint et le pourcentage de requ√™tes qui tomberont dans le stockage des pistes en d√©pendent directement. <br><br>  Aujourd'hui, il est n√©cessaire de pouvoir faire √©voluer horizontalement tout syst√®me distribu√©, c'est-√†-dire ajouter des machines et des centres de donn√©es.  Mais nous voulions √©galement mettre en ≈ìuvre une mise √† l'√©chelle verticale.  Notre serveur moderne typique contient 56 c≈ìurs, 0,5 √† 1 To de RAM, une interface r√©seau de 10 ou 40 Go et une douzaine de disques SSD. <br><br>  En parlant d'√©volutivit√© horizontale, un effet int√©ressant se produit: lorsque vous avez des milliers de serveurs et des dizaines de milliers de disques, quelque chose se brise constamment.  La d√©faillance du disque est une routine, nous les changeons √† 20-30 pi√®ces par semaine.  Et les pannes de serveur ne surprennent personne; 2-3 voitures par jour sont remplac√©es.  J'ai √©galement d√ª faire face √† des d√©faillances de centres de donn√©es, par exemple, en 2018, il y a eu trois d√©faillances de ce type, et ce n'est probablement pas la derni√®re fois. <br><br>  Pourquoi suis-je tout √ßa?  Lorsque nous concevons des syst√®mes, nous savons qu'ils se briseront t√¥t ou tard.  Par cons√©quent, nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©tudions</a> toujours <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">attentivement les</a> sc√©narios de d√©faillance de tous les composants du syst√®me.  La principale fa√ßon de g√©rer les d√©faillances est la r√©plication des donn√©es: plusieurs copies de donn√©es sont stock√©es sur diff√©rents n≈ìuds. <br><br>  Nous r√©servons √©galement la bande passante du r√©seau.  Ceci est important car si un composant du syst√®me tombe en panne, il ne peut pas √™tre autoris√© de r√©duire la charge sur les composants restants. <br><br><h1>  √âquilibrage </h1><br>  Vous devez d'abord apprendre √† √©quilibrer les requ√™tes des utilisateurs entre les centres de donn√©es et √† le faire automatiquement.  C'est le cas si vous devez effectuer des travaux sur le r√©seau ou si le centre de donn√©es est en panne.  Mais l'√©quilibrage est √©galement n√©cessaire √† l'int√©rieur des centres de donn√©es.  Et nous voulons r√©partir les demandes entre les n≈ìuds non pas au hasard, mais avec des poids.  Par exemple, lorsque nous t√©l√©chargeons une nouvelle version d'un service et que nous voulons entrer en douceur un nouveau n≈ìud en rotation.  Les poids aident √©galement beaucoup lors des tests de r√©sistance: nous augmentons le poids et imposons une charge beaucoup plus lourde au n≈ìud afin de comprendre les limites de ses capacit√©s.  Et lorsqu'un n≈ìud tombe en panne sous charge, nous √©liminons rapidement le poids et le retirons de la rotation √† l'aide de m√©canismes d'√©quilibrage. <br><br>  √Ä quoi ressemble le chemin de demande de l'utilisateur au n≈ìud, qui renverra les donn√©es en tenant compte de l'√©quilibrage? <br><br><img src="https://habrastorage.org/webt/uu/tz/uf/uutzuf3bnfpetnns91ca-rcf5mc.png"><br><br>  L'utilisateur se connecte via le site Internet ou l'application mobile et re√ßoit l'URL de la piste: <br><br> <code>musicd.mycdn.me/v0/stream?id=...</code> <br> <br>  Pour obtenir l'adresse IP du nom d'h√¥te dans l'URL, le client contacte notre DNS GSLB, qui conna√Æt tous nos centres de donn√©es et sites CDN.  GSLB DNS donne au client l'adresse IP de l'√©quilibreur de l'un des centres de donn√©es et le client √©tablit une connexion avec lui.  L'√©quilibreur conna√Æt tous les n≈ìuds √† l'int√©rieur des centres de donn√©es et leur poids.  Il √©tablit, au nom de l'utilisateur, une connexion avec l'un des n≈ìuds.  Nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">utilisons des √©quilibreurs L4 bas√©s sur N4Ware</a> .  Noda donne directement les donn√©es de l'utilisateur, contournant l'√©quilibreur.  Dans des services comme un distributeur, le trafic sortant est nettement sup√©rieur √† celui entrant. <br><br>  Si un centre de donn√©es tombe en panne, GSLB DNS le d√©tecte et le supprime rapidement de la rotation: il cesse de donner aux utilisateurs l'adresse IP de l'√©quilibreur de ce centre de donn√©es.  Si un n≈ìud du centre de donn√©es tombe en panne, son poids est r√©initialis√© et l'√©quilibreur √† l'int√©rieur du centre de donn√©es cesse de lui envoyer des demandes. <br><br>  Envisagez maintenant d'√©quilibrer les pistes par n≈ìuds √† l'int√©rieur d'un centre de donn√©es.  Nous consid√©rerons les centres de donn√©es comme des unit√©s autonomes ind√©pendantes, chacune vivra et travaillera, m√™me si tous les autres sont morts.  Les pistes doivent √™tre √©quilibr√©es uniform√©ment sur les machines afin qu'il n'y ait pas de distorsions de charge et les r√©pliquer sur diff√©rents n≈ìuds.  Si un n≈ìud tombe en panne, la charge doit √™tre r√©partie uniform√©ment entre les autres. <br><br>  Ce probl√®me peut √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©solu de diff√©rentes mani√®res</a> .  Nous avons opt√© pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un hachage coh√©rent</a> .  Nous enveloppons toute la gamme possible de hachages d'identifiants de piste dans un anneau, puis chaque piste est affich√©e √† un point de cet anneau.  Ensuite, nous r√©partissons plus ou moins uniform√©ment les plages d'anneaux entre les n≈ìuds du cluster.  Les n≈ìuds qui stockeront la piste sont s√©lectionn√©s en hachant les pistes en un point de l'anneau et en les d√©pla√ßant dans le sens horaire. <br><br><img src="https://habrastorage.org/webt/qr/ty/xf/qrtyxfbchjhlp5taqfs0fbicnk0.jpeg"><br><br>  Mais un tel sch√©ma a un inconv√©nient: en cas de d√©faillance du n≈ìud N2, par exemple, toute sa charge tombera sur la prochaine r√©plique de l'anneau - N3.  Et s'il n'a pas une double marge de performance - et ce n'est pas √©conomiquement justifi√© - alors, tr√®s probablement, le deuxi√®me n≈ìud aura √©galement un mauvais moment.  N3 avec un degr√© √©lev√© de probabilit√© se d√©veloppera, la charge ira √† N4, et ainsi de suite - il y aura une d√©faillance en cascade le long de l'anneau entier. <br><br>  Ce probl√®me peut √™tre r√©solu en augmentant le nombre de r√©pliques, mais la capacit√© utile totale du cluster dans l'anneau diminue.  Par cons√©quent, nous faisons autrement.  Avec le m√™me nombre de n≈ìuds, l'anneau est divis√© en un nombre significativement plus grand de plages dispers√©es de mani√®re al√©atoire autour de l'anneau.  Les r√©pliques de la piste sont s√©lectionn√©es selon l'algorithme ci-dessus. <br><br><img src="https://habrastorage.org/webt/kc/uf/5-/kcuf5-1mmekp60d5emkp5ckkgps.png"><br><br>  Dans l'exemple ci-dessus, chaque n≈ìud est responsable de deux plages.  Si l'un des n≈ìuds tombe en panne, toute sa charge ne reposera pas sur le n≈ìud suivant de l'anneau, mais sera r√©partie entre les deux autres n≈ìuds du cluster. <br><br>  L'anneau est calcul√© sur la base d'un petit ensemble de param√®tres de mani√®re algorithmique et est d√©termin√© sur chaque n≈ìud.  Autrement dit, nous ne le stockons pas dans une sorte de configuration.  Nous avons plus de cent mille de ces gammes en production, et en cas de d√©faillance de l'un des n≈ìuds, la charge est r√©partie de mani√®re absolument √©gale entre tous les autres n≈ìuds vivants. <br><br>  √Ä quoi ressemble la piste de retour √† l'utilisateur dans un tel syst√®me avec un hachage coh√©rent? <br><br>  L'utilisateur via l'√©quilibreur L4 acc√®de √† un n≈ìud al√©atoire.  La s√©lection des n≈ìuds est al√©atoire, car l'√©quilibreur ne sait rien de la topologie.  Mais chaque r√©plique du cluster le sait.  Le n≈ìud qui a re√ßu la demande d√©termine s'il s'agit d'une r√©plique de la piste demand√©e.  Sinon, il passe en mode proxy avec l'une des r√©pliques, √©tablit une connexion avec lui et recherche les donn√©es dans son stockage local.  Si la piste n'est pas l√†, la r√©plique la extrait du magasin de pistes, l'enregistre dans le magasin local et donne le proxy, qui redirige les donn√©es vers l'utilisateur. <br><br><img src="https://habrastorage.org/webt/c5/pu/wl/c5puwlig-lfxy20leny4y4utqig.png"><br><br>  Si le lecteur de la r√©plique tombe en panne, les donn√©es du stockage seront transf√©r√©es directement √† l'utilisateur.  Et si la r√©plique √©choue, le proxy conna√Æt toutes les autres r√©pliques de cette piste, il √©tablira une connexion avec une autre r√©plique en direct et en recevra les donn√©es.  Nous garantissons donc que si un utilisateur demande une piste et qu'au moins une r√©plique est vivante, il recevra une r√©ponse. <br><br><h1>  Comment fonctionne un n≈ìud? </h1><br><img src="https://habrastorage.org/webt/2m/up/ob/2mupob-rqyqsbic50lc-qn2xwqe.png"><br><br>  Un n≈ìud est un pipeline √† partir d'un ensemble d'√©tapes par lesquelles passe la demande d'un utilisateur.  Tout d'abord, la demande est envoy√©e √† une API externe (nous envoyons tout via HTTPS).  Ensuite, la demande est valid√©e - les signatures sont v√©rifi√©es.  Ensuite, les balises IDv3 sont construites si n√©cessaire, par exemple, lors de l'achat d'une piste.  La demande passe √† l'√©tape de routage, o√π, sur la base de la topologie du cluster, il est d√©termin√© comment les donn√©es seront renvoy√©es: soit le n≈ìud actuel est une r√©plique pour cette piste, soit nous procurons un proxy √† partir d'un autre n≈ìud.  Dans le second cas, le n≈ìud via le client proxy √©tablit une connexion au r√©plica via l'API HTTP interne sans v√©rification des signatures.  Le r√©plica recherche les donn√©es dans le stockage local, s'il trouve une piste, il les donne √† partir de son disque;  et si ce n'est pas le cas, il extrait les pistes du stockage, met en cache et donne. <br><br><h1>  Charge de n≈ìud </h1><br>  Estimons quelle charge un n≈ìud devrait contenir dans cette configuration.  Ayons trois centres de donn√©es avec quatre n≈ìuds chacun. <br><br><img src="https://habrastorage.org/webt/in/-z/nz/in-znz1gekgg217y9oxdlm5pv-g.png"><br><br>  L'ensemble du service devrait desservir 120 Gbit / s, soit 40 Gbit / s par centre de donn√©es.  Supposons que les networkers aient fait des man≈ìuvres ou qu'un accident se soit produit et qu'il reste deux centres de donn√©es DC1 et DC3.  Maintenant, chacun d'eux devrait donner 60 Gbit / s.  Mais ici, c'√©tait aux d√©veloppeurs de d√©ployer une mise √† jour, dans chaque centre de donn√©es il restait 3 n≈ìuds actifs et chacun d'entre eux devrait donner 20 Gbit / s. <br><br><img src="https://habrastorage.org/webt/6q/tc/sz/6qtcszoeoi4w1zjxvh_o1u35vni.png"><br><br>  Mais au d√©part, dans chaque centre de donn√©es, il y avait 4 n≈ìuds.  Et si nous stockons deux r√©pliques dans le centre de donn√©es, alors avec une probabilit√© de 50%, le n≈ìud qui a re√ßu la demande ne sera pas une r√©plique de la piste demand√©e et proxy les donn√©es.  Autrement dit, la moiti√© du trafic √† l'int√©rieur du centre de donn√©es est mandat√©e. <br><br><img src="https://habrastorage.org/webt/yi/aj/tc/yiajtck3angspynaidxuar_t5gm.png"><br><br>  Ainsi, un n≈ìud devrait donner aux utilisateurs 20 Gb / s.  Parmi ceux-ci, 10 Gb / s, il tire de ses voisins dans le centre de donn√©es.  Mais le sch√©ma est sym√©trique: le n≈ìud donne les m√™mes 10 Gb / s aux voisins du centre de donn√©es.  Il s'av√®re que 30 Gbit / s sortent du n≈ìud, dont 20 Gbit / s doivent √™tre desservis par lui-m√™me, car il s'agit d'une r√©plique des donn√©es demand√©es.  De plus, les donn√©es proviendront soit des disques, soit de la RAM, qui contient environ 50 000 pistes ¬´chaudes¬ª.  Sur la base de nos statistiques de lecture, cela vous permet de supprimer 60 √† 70% de la charge des disques, et restera d'environ 8 Go / s.  Ce thread est tout √† fait capable de fournir une douzaine de SSD. <br><br><h1>  Stockage de donn√©es sur un n≈ìud </h1><br>  Si vous placez chaque piste dans un fichier s√©par√©, la surcharge de gestion de ces fichiers sera √©norme.  M√™me le red√©marrage des n≈ìuds et l'analyse des donn√©es sur les disques prendront des minutes, voire des dizaines de minutes. <br><br>  Il existe des limites moins √©videntes √† ce sch√©ma.  Par exemple, vous ne pouvez charger des pistes que depuis le tout d√©but.  Et si l'utilisateur a demand√© la lecture √† partir du milieu et que le cache a √©t√© manqu√©, nous ne pourrons pas envoyer un seul octet tant que nous n'aurons pas charg√© les donn√©es √† l'emplacement souhait√© √† partir du r√©f√©rentiel de pistes.  De plus, nous ne pouvons stocker les morceaux que dans leur ensemble, m√™me si c'est un livre audio g√©ant qu'ils arr√™tent d'√©couter √† la troisi√®me minute.  Il continuera √† peser lourd sur le disque, √† gaspiller de l'espace co√ªteux et √† r√©duire le nombre de correspondances de cache de ce n≈ìud. <br><br>  Par cons√©quent, nous le faisons d'une mani√®re compl√®tement diff√©rente: nous divisons les pistes en blocs de 256 Ko, car cela correspond √† la taille du bloc dans le SSD, et nous fonctionnons d√©j√† avec ces blocs.  Un disque de 1 To contient 4 millions de blocs.  Chaque disque d'un n≈ìud est un stockage ind√©pendant et tous les blocs de chaque piste sont r√©partis sur tous les disques. <br><br>  Nous ne sommes pas imm√©diatement arriv√©s √† un tel sch√©ma, au d√©but, tous les blocs d'une piste se trouvaient sur un seul disque.  Mais cela a conduit √† une forte distorsion de la charge entre les disques, car si une piste populaire atteint l'un des disques, toutes les demandes de donn√©es iront √† un seul disque.  Pour √©viter cela, nous avons r√©parti les blocs de chaque piste sur tous les disques, en √©quilibrant la charge. <br><br>  De plus, nous n'oublions pas que nous avons un tas de RAM, mais nous avons d√©cid√© de ne pas faire le cache s√©mantique, car nous avons un merveilleux cache de page sous Linux. <br><br>  Comment stocker des blocs sur des disques? <br><br>  Nous avons d'abord d√©cid√© d'obtenir un fichier XFS g√©ant de la taille d'un disque et d'y mettre tous les blocs.  Puis l'id√©e est venue de fonctionner directement avec un p√©riph√©rique bloc.  Nous avons impl√©ment√© les deux options, les avons compar√©es et il s'est av√©r√© que lorsque vous travaillez directement avec un p√©riph√©rique bloc, l'enregistrement est 1,5 fois plus rapide, le temps de r√©ponse est 2-3 fois plus faible, la charge totale du syst√®me est 2 fois plus faible. <br><br><h1>  Index </h1><br>  Mais il ne suffit pas de pouvoir stocker des blocs; vous devez conserver un index des blocs de pistes musicales aux blocs sur le disque. <br><br><img src="https://habrastorage.org/webt/me/4y/0b/me4y0bk_xbwco9r_5y6smyhmxmc.png"><br><br>  Il s'est av√©r√© √™tre assez compact, une entr√©e d'index ne prend que 29 octets.  Pour un stockage de 10 To, l'indice est un peu plus de 1 Go. <br><br>  Il y a un point int√©ressant ici.  Dans chacun de ces enregistrements, vous devez stocker la taille totale de la piste enti√®re.  Il s'agit d'un exemple classique de d√©normalisation.  La raison en est que, selon la sp√©cification de la r√©ponse de plage HTTP, nous devons renvoyer la taille totale de la ressource, ainsi que former un en-t√™te Content-length.  Si ce n'√©tait pas le cas, alors tout serait encore plus compact. <br><br>  Nous avons formul√© un certain nombre d'exigences pour l'index: travailler rapidement (de pr√©f√©rence, stock√© dans la RAM), √™tre compact et ne pas prendre de place sur le cache de page.  Un autre indice devrait √™tre persistant.  Si nous le perdons, nous perdrons des informations sur l'endroit o√π sur le disque quelle piste est stock√©e, et cela revient √† nettoyer les disques.  Et en g√©n√©ral, j'aimerais que les anciens blocs, auxquels on n'a pas acc√©d√© depuis longtemps, soient en quelque sorte supplant√©s, laissant la place √† des morceaux plus populaires.  Nous avons choisi la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">politique d'√©viction LRU</a> : les blocs sont √©vinc√©s une fois par minute, 1% des blocs sont libres.  Bien s√ªr, la structure d'index doit √™tre thread-safe, car nous avons 100 000 connexions par n≈ìud.  Toutes ces conditions sont id√©alement remplies par <code>SharedMemoryFixedMap</code> de notre biblioth√®que open source <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">one-nio</a> . <br><br>  On met l'index sur <code>tmpfs</code> , √ßa marche vite, mais il y a une nuance.  Lorsque la machine red√©marre, tout ce qui √©tait sur <code>tmpfs</code> , y compris l'index, est perdu.  De plus, si en raison de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code> sun.misc.Unsafe</code></a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code> sun.misc.Unsafe</code></a> notre processus s'est √©cras√©, il n'est pas clair dans quel √©tat l'indice est rest√©.  Par cons√©quent, nous en faisons une impression une fois par heure.  Mais cela ne suffit pas: puisque nous utilisons l'extrusion de blocs, nous devons prendre en charge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WAL</a> , dans lequel nous √©crivons des informations sur les blocs extrud√©s.  Les entr√©es concernant les blocs dans les transtypages et les WAL doivent √™tre tri√©es d'une mani√®re ou d'une autre pendant la r√©cup√©ration.  Pour ce faire, nous utilisons le bloc de g√©n√©ration.  Il joue le r√¥le d'un compteur de transactions global et incr√©ment√© √† chaque changement d'index.  Regardons un exemple de comment cela fonctionne. <br><br>  Prenez un index avec trois entr√©es: deux blocs de la piste n ¬∞ 1 et un bloc de la piste n ¬∞ 2. <br><br><img src="https://habrastorage.org/webt/l6/ux/51/l6ux512_lbpedki0bb3g0ouggau.png"><br><br>  Le flux de cr√©ation de pl√¢tres est r√©veill√© et it√©r√© par cet index: les premier et second tuples tombent dans le pl√¢tre.  Ensuite, le flux d'encombrement se tourne vers l'index, se rend compte que le septi√®me bloc n'a pas √©t√© consult√© depuis longtemps et d√©cide de l'utiliser pour autre chose.  Le processus force le blocage et √©crit un enregistrement dans le WAL.  Il arrive au bloc 9, voit qu'il n'a pas √©t√© contact√© depuis longtemps et le marque √©galement comme √©vinc√©.  Ici, l'utilisateur acc√®de au syst√®me et une erreur de cache se produit - une piste est demand√©e que nous n'avons pas.  Nous sauvegardons le bloc de cette piste dans notre r√©f√©rentiel, en √©crasant le bloc 9.  Dans ce cas, la g√©n√©ration est incr√©ment√©e et devient √©gale √† 22. Ensuite, le processus de cr√©ation d'un moule est activ√©, qui n'a pas termin√© son travail, atteint le dernier enregistrement et l'√©crit dans le moule.  En cons√©quence, nous avons deux enregistrements en direct dans l'index, un casting et WAL. <br><br><img src="https://habrastorage.org/webt/sy/vj/0_/syvj0_-kknmn4i5pulf_p8bclc4.png"><br><br>  Lorsque le n≈ìud actuel tombe, il restaure l'√©tat initial de l'index comme suit.  Tout d'abord, scannez le WAL et cr√©ez une carte de bloc sale.  La carte stocke le mappage du num√©ro de bloc √† la g√©n√©ration lorsque ce bloc a √©t√© remplac√©. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9p/g5/gn/9pg5gn-8atbixm4swmytkscxwpm.png" width="300"></div><br><br>  Apr√®s cela, nous commen√ßons √† parcourir le moule en utilisant la carte comme filtre.  Nous regardons le premier enregistrement du casting, il concerne le bloc num√©ro 3.  Il n'est pas mentionn√© parmi les sales, ce qui signifie qu'il est vivant et entre dans l'index.  Nous arrivons au bloc num√©ro 7 avec la dix-huiti√®me g√©n√©ration, mais la carte des blocs sales nous dit que juste √† la 18e g√©n√©ration, le bloc √©tait √©vinc√©.  Par cons√©quent, il ne tombe pas dans l'index.  Nous arrivons au dernier enregistrement, qui d√©crit le contenu du bloc 9 avec 22 g√©n√©rations.  Ce bloc est mentionn√© dans la carte des blocs sales, mais il a √©t√© remplac√© plus t√¥t.  Ainsi, il est r√©utilis√© pour de nouvelles donn√©es et entre dans l'index.  Le but est atteint. <br><br><h1>  Optimisations </h1><br>  Mais ce n'est pas tout, nous descendons plus profond√©ment. <br><br>  Commen√ßons par le cache de page.  Nous comptions sur lui au d√©part, mais lorsque nous avons commenc√© √† effectuer des tests de charge de la premi√®re version, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il s'est</a> av√©r√© que le taux de r√©ussite du cache de pages n'a pas atteint 20%.  Ils ont sugg√©r√© que le probl√®me soit lu √† l'avance: nous ne stockons pas de fichiers, mais des blocs, tout en servant un tas de connexions, et dans cette configuration, travailler avec le disque est al√©atoire de mani√®re efficace.  Nous ne lisons presque jamais rien s√©quentiellement.  Heureusement, sous Linux, il existe un appel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>posix_fadvise</code></a> qui vous permet de dire au noyau comment nous allons travailler avec le descripteur de fichier - en particulier, nous pouvons dire que nous n'avons pas besoin de lire √† l'avance en passant l'indicateur <code>POSIX_FADV_RANDOM</code> .  Cet appel syst√®me est disponible via <a href="">one-nio</a> .  En fonctionnement, notre hit de cache est de 70 √† 80%.  Le nombre de lectures physiques √† partir des disques a diminu√© de plus de 2 fois, le d√©lai de r√©ponse HTTP a diminu√© de 20%. <br><br>  .     heap.    TLB- ,   Huge Pages   Java-.          (GC Time/Safepoint Total Time  20-30% ),     ,    HTTP latency    . <br><br><h1>  </h1><br>       ( ) . <br><br>             .  ,     ,           ,    ,      .        ,   - .   ,    .  ,        ,    .   ,     Daft Punk    ‚Ññ2  sdc,            sdd. <br><br><img src="https://habrastorage.org/webt/9q/pu/9g/9qpu9gxbc-uph2jp7tsjkup4b5a.png"><br><br> ,            .    Linux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a> :      ,      . <br><br><img src="https://habrastorage.org/webt/3s/y-/vm/3sy-vmtyncu3miiwjhzyu0j9xi4.png"><br><br>   .        ID.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">WWN</a>           ,   WAL.      ,      ,             . <br><br><h1>   </h1><br>       ,            .    CDN    ,    CDN    -.      .        . ,          ,  . <br><br>     .            <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Open Tracing</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Zipkin</a> .      ,    .          ,    ,       HTTP-    .      ,   ,  ,   ,     ,   ,        . <br><br><h1>   </h1><br>         . ,  :  ,     ,    . <br><br><pre> <code class="java hljs">ByteBuffer buffer = ByteBuffer.allocate(size); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = fileChannel.read(buffer, position); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ... } buffer.flip(); socketChannel.write(buffer);</span></span></code> </pre> <br>        ,       : <br><br><ul><li>       <code>FileChannel.read()</code>    kernel space  user space; </li><li>            <code>SocketChannel.write()</code> ,    user space  kernel space. </li></ul><br>  ,  Linux   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>sendfile()</code></a> ,              ,    user space.  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">one-nio</a> .                ,      <code>sendfile()</code> ‚Äî    10 /   <code>sendfile()</code>    0. <br><br>     user-space SSL-     <code>sendfile()</code>      ,        .       .     <code>SocketChannel</code>  <code>FileChannel</code> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Async Profiler</a>         ,         <code>sun.nio.ch.IOUtil</code> ,      <code>read()</code>  <code>write()</code>   .    . <br><br><pre> <code class="java hljs">ByteBuffer bb = Util.getTemporaryDirectBuffer(dst.remaining()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = readIntoNativeBuffer(fd, bb, position, nd); bb.flip(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) dst.put(bb); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { Util.offerFirstTemporaryDirectBuffer(bb); }</code> </pre> <br>    .       heap <code>ByteBuffer</code> ,         ,    ,     heap <code>ByteBuffer</code> ,       .        . <br><br>  .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">one-nio</a> .   <code>MallocMT</code> ‚Äî  ,   .    SSL       ,     Java heap,    <code>ByteBuffer</code> ,      <code>FileChannel</code>       .      . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Allocator allocator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MallocMT(size, concurrency); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Socket socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (socket.getSslContext() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> address = allocator.malloc(size); ByteBuffer buf = DirectMemory.wrap(address, size); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> available = channel.read(buf, offset); socket.writeRaw(address, available, flags);</code> </pre><br><h1> 100 000    </h1><br>          .     .       100 .  .      ? <br><br> ,     ‚Äî                 .   ,   .             ,          .     . <br><br><img src="https://habrastorage.org/webt/mt/vg/eo/mtvgeoszcpcv6zpc-qi_rbqeyhy.png"><br><br>      ,    ,     .     ,    .        .       ,     ,       .         . <br><br>       .      .     ,      , ..         .        .       ,    ,          .       ,      .  back pressure. <br><br>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> .    ,  subscriber      publisher   demand. Demand ,      subscriber    demand,    . Publisher    ,          demand     . <br><br>        push  pull.  push  subscriber  ,  publisher,    publisher    demand  subscriber,   .    ,      subscriber-.  pull ,  publisher ,  subscriber.   publisher     ,  demand .   subscriber ,     , publisher        demand. <br><br>      .     publisher     subscriber  . <br><br>      . <code>Publisher</code>   <code>Subscriber</code> ,       : <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscriber&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&gt; s)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscription s)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br> <code>Subscription</code>   demand   .  Nulle part est plus facile. <br><br>         ,   ,  chunk.   ,     heap ,   . Chunk ‚Äî        ,       <code>ByteBuffer</code> ,      . <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chunk</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ByteBuffer dst)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Socket socket)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FileChannel channel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset)</span></span></span></span>; }</code> </pre> <br>    : <br><br><ul><li>  ,     cache hit      ,    <code>RandomAccessFile</code> .      ,       .     ,          <code>sendfile()</code> .      . </li><li>   cache miss   :             .     , ‚Äî  ,     , ‚Äî      . </li><li> ,    -      heap.        <code>ByteBuffer</code> . </li></ul><br><br>      API,      ,      .      Typed Actor Model,  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="> </a> .     ,       ,   ,        .      . <br><br><div class="spoiler"> <b class="spoiler_title"> ,    .</b> <div class="spoiler_text">     .   publisher  subscriber   ,    ,   executor,       . <code>AtomicBoolean</code>  happens before   . <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Incoming messages final Queue&lt;M&gt; mailbox; // Message processing works here final Executor executor; // To ensure HB relationship between runs final AtomicBoolean on = new AtomicBoolean();</span></span></code> </pre> <br>    : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ enqueue(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Request(n)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enqueue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> M message)</span></span></span><span class="hljs-function"> </span></span>{ mailbox.offer(message); tryScheduleToExecute(); }</code> </pre> <br>  <code>tryScheduleToExecute()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on.compareAndSet(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { executor.execute(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { ... } }</code> </pre> <br>  <code>run()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on.get()) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { dequeueAndProcess(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { on.set(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!messages.isEmpty()) { tryScheduleToExecute(); } } }</code> </pre> <br>  <code>dequeueAndProcess()</code> : <br><br><pre> <code class="java hljs">M message; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((message = mailbox.poll()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Pattern match if (message instanceof Request) { doRequest(((Request) message).n); } else { ‚Ä¶ } }</span></span></code> </pre> </div></div><br>     .    ,  <code>volatile</code> , <code>Atomic*</code> , contention  .       100 000    200 . <br><br><h1>  En fin de compte </h1><br>  production   12 ,          .        10 /    .     .    Java  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">one-nio</a> . <br><br><img src="https://habrastorage.org/webt/oa/pz/cq/oapzcqjf6y9ccxrnk1wzrpaigdy.jpeg"><br><br>     ,     . 99-  20 .   ‚Äî    HTTPS-.   ‚Äî         <code>sendfile()</code>  HTTP. <br><br>    cache hit  production 97%,    latency   ,         ,   ,   . <br><br><img src="https://habrastorage.org/webt/xp/fd/eq/xpfdequddx6cnglrzrgdxtbspuc.jpeg"><br><br>    75-    ,       1 .         ‚Äî   300 .  C'est-√†-dire 0.7  ‚Äî   . <br><br>      ,      ,     ,   . ,    . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr434206/">https://habr.com/ru/post/fr434206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr434194/index.html">D√©veloppement de comp√©tences pour Alice. Exp√©rience avec les interfaces vocales, conseils pour les d√©butants</a></li>
<li><a href="../fr434196/index.html">3CX v16 Alpha 2 et plans pour la nouvelle ann√©e</a></li>
<li><a href="../fr434198/index.html">Choisir un mode de fonctionnement du serveur Web en fonction de son exp√©rience personnelle</a></li>
<li><a href="../fr434200/index.html">La rouille est-elle si terrible qu'elle est peinte</a></li>
<li><a href="../fr434202/index.html">4 secrets pour ne pas perdre son emploi en science des donn√©es</a></li>
<li><a href="../fr434208/index.html">Comment Go a sauv√© notre Black Friday</a></li>
<li><a href="../fr434210/index.html">Analyse du concours de quiz Android du stand HeadHunter au Mobius 2018 Moscou</a></li>
<li><a href="../fr434212/index.html">Tour de Tesla. Que se passe-t-il dans et pr√®s d'un gratte-ciel lorsque la foudre frappe?</a></li>
<li><a href="../fr434214/index.html">Proxy dynamique Java: qu'est-ce que c'est et comment l'utiliser?</a></li>
<li><a href="../fr434216/index.html">Attaques par force brute avec Kali Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>