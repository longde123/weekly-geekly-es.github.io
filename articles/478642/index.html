<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöã ü§±üèø üëÉüèº MOXA Nport - Mirada interior üëãüèª ü§πüèæ üßõüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los servidores de recopilaci√≥n de datos de puerto serie MOXA Nport y similares son actualmente el est√°ndar de facto en el campo de los sistemas de con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MOXA Nport - Mirada interior</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478642/">  Los servidores de recopilaci√≥n de datos de puerto serie MOXA Nport y similares son actualmente el est√°ndar de facto en el campo de los sistemas de construcci√≥n que transmiten o reciben datos a trav√©s de interfaces RS-232, RS-485 y RS-422. <br><br>  Medidores de electricidad, v√°lvulas controladas y v√°lvulas de compuerta, medidores de flujo, sensores de vibraci√≥n, dispositivos de telemec√°nica. <br><br>  Todo lo que puede generar datos o controlarse de forma remota y tiene una interfaz RS-232, RS-485 y RS-422 funciona a trav√©s de estos convertidores. <br><br>  El significado general de su uso suele ser el siguiente: reenviar las interfaces RS-232, RS-485 y RS-422 a trav√©s de una red local existente, conectar un dispositivo o dispositivo que tenga una de las interfaces seriales a una PC (servidor, SCADA) a trav√©s de Ethernet, conectarse al dispositivo Tener una interfaz en serie a trav√©s de Internet para control remoto, etc. <br><br>  Los precios de estos convertidores no son muy altos, se pueden pedir prestados modelos m√°s j√≥venes por $ 100-200.  Pero dado que en cualquier producci√≥n automatizada de tales dispositivos se pueden instalar cientos o incluso miles, est√° surgiendo un bonito tidbit para los "sustitutos de importaci√≥n" nacionales. <br><br>  Tratar√© de ayudarlos hoy. <br><br>  Que haremos <br><br>  En primer lugar, entenderemos la teor√≠a de c√≥mo est√° organizado dentro. <br><br>  En segundo lugar, aislamos la funcionalidad m√≠nima para comenzar a trabajar en modo Real Com (de hecho, para reenviar el puerto COM virtual al dispositivo a trav√©s de Ethernet). <br><br>  En tercer lugar, por inter√©s, analizaremos el protocolo para buscar y configurar el dispositivo a trav√©s de la utilidad NPort Administration Suite.  Obtendremos una comprensi√≥n completa de c√≥mo crear un an√°logo pin a pin de una pieza de hierro que se puede atascar en lugar del MOXA Nport existente, mientras recibe soporte completo del software y controlador nativos. <br><br>  Y finalmente, intentemos calcular cu√°ntos indios escribieron el c√≥digo de firmware MOXA. <br><a name="habracut"></a><br><h4>  Parte 1. Introductoria </h4><br>  Entonces, tenemos un tema de prueba en nuestra mesa (en realidad hab√≠a varios de ellos, as√≠ que no se sorprenda si ve diferentes identificadores de modelo y diferentes direcciones MAC en el art√≠culo) <br><br><img src="https://habrastorage.org/webt/zs/bu/co/zsbucoqb74oopd5ld_vkqkqipfc.jpeg"><br><br>  Tiene un puerto Ethernet y dos puertos RS-422 / RS-485, esto es f√≠sicamente. <br>  Y en el plan del programa, en el dispositivo est√°n abiertos: <br>  Puerto UDP 4800: es responsable de capturar los paquetes de b√∫squeda del dispositivo y env√≠a datos sobre el dispositivo a la utilidad de configuraci√≥n. <br><br>  Puerto TCP 4900: recibe comandos de configuraci√≥n del dispositivo.  La hora, el nombre, la direcci√≥n IP, el modo de funcionamiento, la configuraci√≥n de velocidad y puerto del dispositivo y otros par√°metros b√°sicos del dispositivo se pueden configurar a trav√©s de este puerto, que se puede configurar a trav√©s de la interfaz principal de la utilidad NPort Administration Suite: <br><br><img src="https://habrastorage.org/webt/mh/me/79/mhme79fontjiywnsdxgq_wk2sau.png"><br><br>  Puerto TCP 80: es responsable del funcionamiento de la interfaz WEB <br>  Los puertos TCP 966, 967 (y 968, 969 para dispositivos de 4 puertos) son puertos de control de transmisi√≥n.  Ejecutan comandos para abrir / cerrar el puerto COM correspondiente, establecer la velocidad del puerto, enviar datos, controlar la plenitud del b√∫fer de transmisi√≥n / recepci√≥n, etc.  El puerto 966 es responsable de la operaci√≥n del primer puerto, respectivamente. <br><br>  Los puertos TCP (por defecto) 950, 951, (y 952, 953 para dispositivos de 4 puertos) son puertos de transferencia de datos directos.  Es decir, lo que deber√≠a aparecer directamente en el puerto RS-232/485/422 del dispositivo se transmite al puerto de datos.  Solo el control de flujo de datos en este puerto va a los puertos 966, 967, 968, 969, respectivamente. <br><br>  Espero que se haya desarrollado la imagen general de comprender el funcionamiento del dispositivo en mi cabeza.  Pasemos a la siguiente parte: <br><br><h4>  Parte 2. Emular MOXA </h4><br>  Seguramente para muchos ya ha quedado claro que para pretender ser MOXA Nport en la configuraci√≥n m√≠nima, es necesario elevar un servidor TCP en su propio hardware en 2 puertos: 966 para el control de transmisi√≥n y 950 para la transmisi√≥n directa de datos.  Naturalmente, tendr√° que responder y procesar correctamente las solicitudes de controladores en el puerto 966, pero como lo muestra el an√°lisis de Wirehark, no hay tantas solicitudes y son las m√°s simples. <br><br>  Para no sobrecargar el texto del art√≠culo con c√°lculos que describen las solicitudes y respuestas, prepar√© y publiqu√© por separado en forma de archivo pdf una descripci√≥n de todas las solicitudes analizadas, respuestas y par√°metros transmitidos. <br><br>  <a href="http://multimake.ru/wp-content/uploads/2019/12/%25D0%259E%25D0%25BF%25D0%25B8%25D1%2581%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5-%25D1%2580%25D0%25B0%25D0%25B7%25D0%25B1%25D0%25BE%25D1%2580%25D0%25B0-%25D0%25BF%25D1%2580%25D0%25BE%25D1%2582%25D0%25BE%25D0%25BA%25D0%25BE%25D0%25BB%25D0%25B0-MOXA.pdf">Descargar: Descripci√≥n del protocolo que analiza MOXA.pdf</a> <br>  Es decir, este conjunto de conocimientos le permite implementar un dispositivo que se puede emparejar con un controlador nativo y transmitir datos como MOXA.  La mitad del trabajo est√° hecho, pero hay un punto: ¬øc√≥mo cambiar la configuraci√≥n?  Ser√≠a genial utilizar la utilidad nativa NPort Administration Suite para estos fines. <br><br><h4>  Parte 3. Busca y encuentra </h4><br>  Las dos primeras partes describieron lo que hay que hacer, pero no hubo una palabra sobre c√≥mo obtener datos para la implementaci√≥n de los protocolos. <br><br>  En esta parte, profundizamos un poco m√°s y vemos c√≥mo se llev√≥ a cabo el an√°lisis del intercambio en s√≠. <br>  Sabemos que el puerto UDP 4800 est√° abierto en el dispositivo, conectemos el dispositivo, ejecute NPort Administration Suite, Wireshark y veamos qu√© sucede al buscar dispositivos con la utilidad nativa. <br><br><img src="https://habrastorage.org/webt/fk/b8/om/fkb8om_d1ieh_2wipyvvglmwzn8.png"><br><br>  Nos fijamos en los paquetes enviados: <br><br><img src="https://habrastorage.org/webt/av/j7/pg/avj7pgj8udm7ujvvnbs-26eip4i.png"><br><br>  Vemos que NPort Administration Suite env√≠a una transmisi√≥n a la direcci√≥n 255.255.255.255, es decir, espera que el paquete vuele a trav√©s de la red. <br><br>  El paquete de carga √∫til contiene datos: <br><br><pre><code class="plaintext hljs">01 00 00 08 00 00 00 00, : 01 00 ‚Äì   00 08 ‚Äì       Big Endian. 00 00 00 00 ‚Äì  </code> </pre> <br>  Esta solicitud se env√≠a varias veces, aparentemente con la esperanza de que al menos uno de ellos logre el objetivo. <br><br>  Todos los MOX responden a esta solicitud. <br><br><img src="https://habrastorage.org/webt/v7/u3/zn/v7u3zn6pil6rw8ijo1mad4caea4.png"><br><br>  Espec√≠ficamente, nuestro respondi√≥: <br><br><pre> <code class="plaintext hljs"> 81 00 00 18 00 00 00 00 12 03 00 80 32 03 00 90 e8 26 4a ab c0 a8 7f fe 81 00 ‚Äì   00 18 ‚Äì     (24) 00 00 00 00 ‚Äì   12 03 00 80 32 03 ‚Äì  MOXA Nport device,    NPort 5232.        MOXA Nport device.          NPort Administrator. 00 90 e8 26 4a ab ‚Äì MAC  MOXA Nport device c0 a8 7f fe ‚Äì IP  MOXA Nport device ( 192.168.127.254 )</code> </pre> <br>  Parece que todo es elemental simple, confunde solo el valor 12 03 00 80 32 03, que es responsable de la interpretaci√≥n de un modelo de dispositivo espec√≠fico. <br><br>  Pero, dado que este valor se compara con alguna referencia de referencia, significa que debe almacenarse en alg√∫n lugar. <br><br>  Despu√©s de estudiar un poco el directorio de software, encontramos que en NPort Administrator Suite v1.22 estos valores se almacenan en el archivo C: \ Archivos de programa \ NPortAdminSuite \ bin \ dsci.dll <br><br><img src="https://habrastorage.org/webt/fs/sf/8k/fssf8kgx4iaz45n0fzucjonzkla.png"><br><br>  Despu√©s de sentarnos con Wireshark y el dispositivo durante varios d√≠as, obtenemos un registro de intercambio completo y una comprensi√≥n de los c√≥digos de funci√≥n que responden.  Por conveniencia, todo lo encontrado se describe en el mismo archivo pdf, cuyo enlace se indica en el art√≠culo anterior. <br><br>  Para una comprensi√≥n completa de la imagen, solo le recordar√© que UDP 4800 recibe informaci√≥n primaria sobre el dispositivo, todos los par√°metros que requieren configuraci√≥n e instalaci√≥n se configuran a trav√©s de solicitudes para el puerto TCP 4900. <br><br>  Despu√©s de haber procesado correctamente todas las solicitudes entrantes para los puertos 4800 y 4900, podemos pretender completamente ser un dispositivo, por lo que incluso el software nativo no notar√° la captura. <br><br><h4>  Parte 4. Contando a los indios * </h4><br>  En el curso del an√°lisis del protocolo, tuve la sensaci√≥n de que diferentes partes del protocolo de intercambio fueron escritas por diferentes personas, el significado de las funciones y su interpretaci√≥n son demasiado diferentes. <br><br>  Entonces, por ejemplo: <br><br>  Los c√≥digos de funci√≥n del puerto UDP 4800 comienzan con: <br><br><pre> <code class="plaintext hljs"> 01 00 .. ..  81 00 .. ..  10 00 .. ..  90 00 .. ..  16 00 .. ..  96 00 .. ..  29 00 .. ..  a9 00 .. ..</code> </pre> <br>  Los c√≥digos de funci√≥n del puerto TCP 4900 comienzan con: <br><br><pre> <code class="plaintext hljs"> 00 01 .. ..  00 01 .. ..  02 01 .. ..  02 01 .. ..</code> </pre> <br>  y as√≠ sucesivamente <br><br>  Los c√≥digos de funci√≥n de los puertos TCP 966, 967, 968, 969 comienzan con: <br><br><pre> <code class="plaintext hljs"> 10 .. ..  10 4f 4b  11 .. ..  11 4f 4b</code> </pre> <br>  y as√≠ sucesivamente <br><br>  Es decir, se utiliza un identificador de un solo byte de la funci√≥n, y no un byte doble como antes. <br>  Entonces, por cierto, sali√≥ un momento divertido.  En los puertos 966, 967, 968, 969, la respuesta a los par√°metros de configuraci√≥n siempre consta de 3 bytes. <br><br>  El primero es el n√∫mero de funci√≥n, y el 2 restante es 4f 4b o hay un aspecto en la tabla ASCII - "O" "K" <br><br>  Bueno, est√° bien con √©l, adelante. <br><br>  La segunda caracter√≠stica vista es un hash de Big and Little Endian dentro de la misma respuesta. <br><br>  Ejemplo de respuesta: <br><br><pre> <code class="plaintext hljs">9a 00 00 24 00 00 00 00 01 52 00 80 9a 52 00 90 e8 3b 89 9c 75 00 04 00 01 00 0f 00 09 00 17 00 36 00 00 00 9a 00 ‚Äì   00 24 ‚Äì     (36) 00 00 00 00 ‚Äì   01 52 00 80 9a 52 ‚Äì  MOXA Nport device 00 90 e8 3b 89 9c - MAC  MOXA Nport device 75 00 - : 1900 +   (1900 + 117 = 2017) 04 00 - :     1 -     01 00 ‚Äì   0f 00 ‚Äì  (15) 09 00 ‚Äì  (9) 17 00 ‚Äì  (23) 36 00 ‚Äì  (36) 00 00 ‚Äì  </code> </pre> <br>  El tama√±o del paquete se codifica de una manera, y todos los valores num√©ricos (a√±o, mes, d√≠a ...) en otra.  De esto podemos concluir que el procesamiento de la parte del usuario a partir de 75 00 04 00 ....... fue escrito por otro programador. <br><br>  Para resumir: al menos 3 personas diferentes escribieron el protocolo de intercambio, 1 escribi√≥ el procesamiento de la parte de los datos del usuario y al menos 1 escribi√≥ el controlador de interfaz WEB.  Seg√∫n mis c√°lculos, unos 5 programadores trabajaron en el proyecto. <br>  ¬øCu√°nto contabas? <br><br>  * En este caso, el t√©rmino "hind√∫" significa un empleado que cumple con sus deberes para alimentos e hipotecas, que puede codificar desde aqu√≠ y antes del almuerzo sin realmente profundizar en los planes globales de la empresa del empleador. <br><br>  PD: Este art√≠culo fue escrito sobre materiales que se desarrollaron en 2017, por lo que muchos de los datos contienen dataciones precisamente este a√±o.  Los protocolos se examinaron en el marco de un borrador de trabajo, pero dado que la mente se impuso al marketing y el asunto no pas√≥ de la etapa de un solo prototipo de trabajo.  Publico todos los desarrollos de este proyecto en el dominio p√∫blico, ya que creo que esta informaci√≥n ser√° √∫til para la comunidad de desarrolladores. <br><br>  PPS Art√≠culo original como siempre en mi <a href="http://multimake.ru/moxa-nport-%25D0%25B2%25D0%25B7%25D0%25B3%25D0%25BB%25D1%258F%25D0%25B4-%25D0%25B8%25D0%25B7%25D0%25BD%25D1%2583%25D1%2582%25D1%2580%25D0%25B8/">blog personal</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/478642/">https://habr.com/ru/post/478642/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../478628/index.html">Alto CRI en chino</a></li>
<li><a href="../478630/index.html">Pascal juega Go. Implementaci√≥n de m√©todos e interfaces en un compilador aficionado.</a></li>
<li><a href="../478634/index.html">Errores en la gesti√≥n de proyectos de aprendizaje autom√°tico</a></li>
<li><a href="../478638/index.html">db-tree: busca y navega por la base de datos</a></li>
<li><a href="../478640/index.html">Autos aut√≥nomos en c√≥digo abierto</a></li>
<li><a href="../478646/index.html">JetQuad: Aviones a reacci√≥n con despegue y aterrizaje vertical</a></li>
<li><a href="../478650/index.html">Dawn 3D</a></li>
<li><a href="../478652/index.html">Estructura de paquetes DNS</a></li>
<li><a href="../478654/index.html">Recuento de distribuci√≥n estimado: clasificaci√≥n reinventada con mayor frecuencia</a></li>
<li><a href="../478658/index.html">¬øC√≥mo despertar amable? Nueva alarma de luz Dawn Plus</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>