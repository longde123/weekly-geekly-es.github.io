<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚕 👶 🤜🏿 تصدير نماذج Google + تنزيل Google Script عبر REST API (Python) 👨🏿‍⚕️ 🙆 🐗</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="كان لدينا نموذجان من google ، و 75 سؤالًا في كل منهما ، و 5 من مستخدمي الأعمال الذين قاموا بتحرير هذه النماذج بشكل نشط ، وأيضًا برنامج نصي من google ل...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>تصدير نماذج Google + تنزيل Google Script عبر REST API (Python)</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485898/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/gi/tl/nl/gitlnlklzpbmybk3jz3utl4_uow.png"><br><br>  كان لدينا نموذجان من google ، و 75 سؤالًا في كل منهما ، و 5 من مستخدمي الأعمال الذين قاموا بتحرير هذه النماذج بشكل نشط ، وأيضًا برنامج نصي من google لتصدير النموذج إلى JSON.  ليس من الصعب تشغيله في كل مرة بيديك ، ولكن بمجرد البدء في أتمتة عملك ، ثم انتقل إلى هذه الهواية. <br><br>  في الوثائق الرسمية ، سوف يكسر الشيطان ساقه ، لذلك تحت القط سنلقي نظرة فاحصة على التنزيل عن بُعد وإطلاق Google Apps Script من خلال واجهة برمجة تطبيقات REST باستخدام Python. <br><a name="habracut"></a><br><h2 style=";text-align:right;direction:rtl">  مقدمة </h2><br>  في Doctor Near ، نقوم بتطوير نظام أساسي لبرامج الدردشة ، حيث يتم استخدام نماذج Google لوصف السيناريوهات.  وفقًا لذلك ، أرغب في الحصول على JSON من النماذج بنقرة زر واحدة تحتوي على العقد (نقاط النموذج) والبيانات الوصفية لها (الانتقال بين العقد وأنواع العقد واسمها).  يبدو أن الرغبة بسيطة ، لكن Google لا تدعم هذه الوظيفة وعليك تجميع هذا "المصدر" بيديك.  النظر في الخطوات اللازمة لإنشائه. <br><br><h2 style=";text-align:right;direction:rtl">  الخطوة 1. النص البرمجي لتطبيقات Google </h2><br>  وفرت Google القدرة على التفاعل مع خدماتها (الأوراق والمستندات والنماذج) من خلال Google Apps Script - البرامج النصية المكتوبة بلغة google script (.gs).  لا تقدم هذه المقالة تحليلًا للغة النص البرمجي لـ google ، لذا سأقدم مثالًا على برنامج نصي جاهز يقوم بإنشاء JSON من نموذج Google موجود.  تم أخذ <a href="" rel="nofollow">رمز</a> المستخدم <a href="https://github.com/stevenschmatz" rel="nofollow">Steven Schmatz</a> من github كأساس ، والذي أعرب عن امتناني له. <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">رمز البرنامج النصي</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"><code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Steven Schmatz // Humanitas Labs // 13 October, 2016. // Roman Shekhovtsov // dr-telemed.ru // Autumn 2019 // Nikita Orekhov // dr-telemed.ru // Autumn 2019 /** * Converts the given form URL into a JSON object. */ function main() { form_url = "&lt;YOUR_FORM_URL&gt;" var form = FormApp.openByUrl(form_url); var items = form.getItems(); var result = { "metadata": getFormMetadata(form), "items": items.map(itemToObject), "count": items.length }; // sendEmail("&lt;YOUR_EMAIL&gt;", result) return result; } /** If we want to receive data by email * Sends JSON as text to recipient email * @param recipient: String * @param result: JSON */ function sendEmail(recipient, json_file){ var subject = "google form json import" var body = JSON.stringify(json_file); Logger.log(body); MailApp.sendEmail(recipient, subject, body); } /** * Returns the form metadata object for the given Form object. * @param form: Form * @returns (Object) object of form metadata. */ function getFormMetadata(form) { return { "title": form.getTitle(), "id": form.getId(), "description": form.getDescription(), "publishedUrl": form.getPublishedUrl(), "editorEmails": form.getEditors().map(function(user) { return user.getEmail() }), "count": form.getItems().length, "confirmationMessage": form.getConfirmationMessage(), "customClosedFormMessage": form.getCustomClosedFormMessage() }; } /** * Returns an Object for a given Item. * @param item: Item * @returns (Object) object for the given item. */ function itemToObject(item) { var data = {}; data.type = item.getType().toString(); // Downcast items to access type-specific properties var itemTypeConstructorName = snakeCaseToCamelCase("AS_" + item.getType().toString() + "_ITEM"); var typedItem = item[itemTypeConstructorName](); // Keys with a prefix of "get" have "get" stripped var getKeysRaw = Object.keys(typedItem).filter(function(s) {return s.indexOf("get") == 0}); getKeysRaw.map(function(getKey) { var propName = getKey[3].toLowerCase() + getKey.substr(4); // Image data, choices, and type come in the form of objects / enums if (["image", "choices", "type", "alignment"].indexOf(propName) != -1) {return}; // Skip feedback-related keys if ("getFeedbackForIncorrect".equals(getKey) || "getFeedbackForCorrect".equals(getKey) || "getGeneralFeedback".equals(getKey)) {return}; var propValue = typedItem[getKey](); data[propName] = propValue; }); // Bool keys are included as-is var boolKeys = Object.keys(typedItem).filter(function(s) { return (s.indexOf("is") == 0) || (s.indexOf("has") == 0) || (s.indexOf("includes") == 0); }); boolKeys.map(function(boolKey) { var propName = boolKey; var propValue = typedItem[boolKey](); data[propName] = propValue; }); // Handle image data and list choices switch (item.getType()) { case FormApp.ItemType.LIST: case FormApp.ItemType.CHECKBOX: data.choices = typedItem.getChoices().map(function(choice) { return choice.getValue() }); case FormApp.ItemType.MULTIPLE_CHOICE: data.choices = typedItem.getChoices().map(function(choice) { gotoPage = choice.getGotoPage() if (gotoPage == null) return choice.getValue() else return { "value": choice.getValue(), "gotoPage":choice.getGotoPage().getId() }; }); break; case FormApp.ItemType.IMAGE: data.alignment = typedItem.getAlignment().toString(); if (item.getType() == FormApp.ItemType.VIDEO) { return; } var imageBlob = typedItem.getImage(); data.imageBlob = { "dataAsString": "", //imageBlob.getDataAsString(), - BLOB too big "name": imageBlob.getName(), "isGoogleType": imageBlob.isGoogleType() }; break; case FormApp.ItemType.PAGE_BREAK: data.pageNavigationType = typedItem.getPageNavigationType().toString(); break; default: break; } // Have to do this because for some reason Google Scripts API doesn't have a // native VIDEO type if (item.getType().toString() === "VIDEO") { data.alignment = typedItem.getAlignment().toString(); } return data; } /** * Converts a SNAKE_CASE string to a camelCase string. * @param s: string in snake_case * @returns (string) the camelCase version of that string */ function snakeCaseToCamelCase(s) { return s.toLowerCase().replace(/(\_\w)/g, function(m) {return m[1].toUpperCase();}); }</span></span></code> </pre> <br></div></div><br>  ما يحدث في الكود: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  دالة <i>getFormMetadata</i> - تقوم بإرجاع JSON مع بيانات تعريف النموذج </li><li style=";text-align:right;direction:rtl">  دالة <i>itemToObject</i> - تحول الكائن <i>form.item</i> إلى JSON مع الحقول المطلوبة </li><li style=";text-align:right;direction:rtl">  وظيفة <i>sendEmail</i> - ترسل ملف JSON إلى البريد المحدد في النص </li><li style=";text-align:right;direction:rtl">  الوظيفة <i>الرئيسية</i> - إرجاع الناتج JSON </li><li style=";text-align:right;direction:rtl">  المتغير <i>form_url</i> في الوظيفة <i>الرئيسية</i> هو عنوان نموذج google الخاص بنا </li></ul><br><h2 style=";text-align:right;direction:rtl">  الخطوة 2. اختبار البرنامج النصي </h2><br>  في الوقت الحالي ، يمكن التحقق من أداء البرنامج النصي على النحو التالي: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://script.google.com/home/start" rel="nofollow">إنشاء</a> مشروع البرنامج النصي التطبيق الخاص بك </li><li style=";text-align:right;direction:rtl">  انسخ الكود فيه </li><li style=";text-align:right;direction:rtl">  بدلاً من <i>&lt;YOUR_FORM_URL&gt; نستبدل</i> عنوان النموذج الخاص بنا للنموذج <i><a href="https://docs.google.com/forms/d/FORM_IDENTIFICATOR/edit" rel="nofollow">docs.google.com/forms/d/FORM_IDENTIFICATOR/edit</a></i> </li><li style=";text-align:right;direction:rtl">  uncomment الدعوة <i>لإرسال البريد الإلكتروني</i> في الوظيفة <i>الرئيسية</i> </li><li style=";text-align:right;direction:rtl">  بدلاً من <i>&lt;YOUR_EMAIL&gt; نستبدل</i> عنوان البريد الإلكتروني الذي نريد استلام JSON إليه </li><li style=";text-align:right;direction:rtl">  احفظ المشروع </li><li style=";text-align:right;direction:rtl">  تشغيل الوظيفة <i>الرئيسية</i> </li><li style=";text-align:right;direction:rtl">  إذا كانت هذه هي المرحلة الأولى من البرنامج النصي ، فسيعلمك النظام بالحاجة إلى منح البرنامج النصي إذنًا لإرسال بريد إلكتروني من عنوانك.  لا تخف.  هذا هو الإجراء القياسي المطلوب لاختبار البرنامج النصي.  انتقل إلى "أذونات المراجعة" -&gt; حدد حسابك -&gt; "خيارات متقدمة" -&gt; "انتقل إلى مشروع PROJECT_NAME (غير آمن)" -&gt; "السماح" </li><li style=";text-align:right;direction:rtl">  في انتظار البرنامج النصي للعمل </li><li style=";text-align:right;direction:rtl">  ابحث في صندوق البريد وشاهد ملف JSON في نموذج نصي </li></ol><br>  سيكون كل شيء على ما يرام ، ولكن الاستخدام الإضافي للبيانات التي تم الحصول عليها يتضمن النسخ اليدوي من البريد ، ومعالجة هذا النص (في بيثون ، على سبيل المثال) وحفظ الملف الناتج.  لا يبدو جاهزًا جدًا للإنتاج.  نحن نتمكّن من تشغيل هذا البرنامج النصي تلقائيًا والحصول على نتائجه من خلال واجهة برمجة تطبيقات Google Apps Script ، لكن أولاً أنشأنا مشروع Google وفقًا لذلك. <br><br>  <b>انتباه:</b> لتوفير الراحة لفهم ما يحدث ، سأشير أدناه إلى صفحتين فقط ، لذلك يوصى بفتحها في علامات تبويب متجاورة: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://script.google.com/home" rel="nofollow">صفحة</a> تحرير النص / البرنامج النصي - <i>"الصفحة 1"</i> </li><li style=";text-align:right;direction:rtl">  صفحة Google Cloud Platform - <i>"الصفحة 2"</i> </li></ol><br><h2 style=";text-align:right;direction:rtl">  الخطوة 3. تكوين Google Cloud Platform </h2><br>  نذهب إلى Google Cloud Platform (صفحة 2) ، لإنشاء مشروع جديد.  من الضروري إنشاء مشروع جديد ، لأن حالة المشروع هي افتراضي ، وستاندارت مطلوبة لأغراضنا.  يمكن العثور على مزيد من التفاصيل <a href="https://developers.google.com/apps-script/guides/cloud-platform-projects" rel="nofollow">هنا</a> (النقطة 3). <br><br>  نعود إلى الصفحة 2 ، انتقل إلى علامة التبويب "API والخدمات" ، ثم "نافذة طلب وصول OAuth".  اضبط نوع المستخدم على "خارجي". <br><br>  في النافذة التي تظهر ، املأ "اسم التطبيق". <br><br>  افتح الصفحة الرئيسية على Google Cloud Platform.  من كتلة "معلومات المشروع" نسخ رقم المشروع. <br><br>  انتقل إلى الصفحة 1. افتح البرنامج النصي الذي تم إنشاؤه مسبقًا.  في نافذة تحرير النصوص المفتوحة ، انتقل إلى "الموارد" -&gt; "مشروع منصة السحاب".  في حقل "تغيير المشروع" ، أدخل رقم المشروع الذي تم نسخه مسبقًا.  الآن يرتبط هذا البرنامج النصي بالمشروع الذي تم إنشاؤه. <br><br><h2 style=";text-align:right;direction:rtl">  الخطوة 4. بيثون REST API </h2><br>  حان الوقت لأتمتة البرنامج النصي باستخدام <a href="https://developers.google.com/apps-script/api/reference/rest" rel="nofollow">REST API</a> .  تم استخدام بايثون كلغة. <br><br><h3 style=";text-align:right;direction:rtl">  تطبيقات API سيناريو تسجيل الدخول </h3><br>  يجب أن يكون للرمز حق الوصول إلى المشروع ، وبالتالي فإن الإجراء الأول والمهم للغاية هو تسجيل الدخول في Apps Script API.  افتح الصفحة 2 -&gt; "API والخدمات" -&gt; "بيانات الاعتماد" -&gt; "إنشاء بيانات اعتماد" -&gt; "معرف عميل OAuth" -&gt; "أنواع أخرى".  نحن نسمي معرفنا ، انتقل إليه.  في علامة التبويب "بيانات الاعتماد" ، حدد "تنزيل ملف JSON".  سيؤدي هذا إلى تحميل ملف المفتاح للوصول من الرمز إلى المشروع في Google.  نضع هذا الملف في مجلد بيانات الاعتماد. <br><br>  تحتاج الآن إلى منح إذن لاستخدام واجهة برمجة التطبيقات (في حالتنا ، واجهة برمجة تطبيقات Apps) كجزء من هذا المشروع.  للقيام بذلك ، انتقل إلى "API والخدمات" -&gt; "المكتبة" -&gt; اكتب "Apps Script API" في البحث وانقر على "تمكين". <br><br>  تحتوي التطبيقات التي تتفاعل مع Google على مجموعة من الأذونات التي يجب على المستخدم منحها عند تشغيله.  تعتمد هذه النسخة على الوظائف التي يستخدمها برنامج نصي معين ويمكنك العثور عليها بالانتقال إلى الصفحة 1 في نافذة تحرير البرنامج النصي في "ملف" -&gt; "خصائص المشروع" -&gt; "النطاقات".  يجب حفظ هذه الأذونات للاستخدام المستقبلي في التعليمات البرمجية. <br><br>  في هذه الحالة ، ستبدو وظيفة تسجيل الدخول كما يلي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br>  تعتبر مجموعة التعليمات البرمجية هذه الإجراء القياسي لبدء استخدام Google App Script. <br>  نستخدم رمز المصادقة ، ومن خلال تسجيل الدخول ، إما إنشاء رمز مميز جديد أو استخدام رمز موجود. <br><br>  للراحة ، تم إنشاء ملف تكوين JSON ، والذي يحتوي على النموذج التالي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"SCOPES"</span></span>: [<span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/forms"</span></span>, <span class="hljs-string"><span class="hljs-string">"https://www.googleapis.com/auth/script.send_mail"</span></span>], <span class="hljs-attr"><span class="hljs-attr">"credentials_path"</span></span>: <span class="hljs-string"><span class="hljs-string">"credentials/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"google_test_project.json"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"token_file"</span></span>: <span class="hljs-string"><span class="hljs-string">"token.pickle"</span></span> }</code> </pre><br>  <b>هام:</b> يتم إنشاء الرمز المميز للمصادقة مع نطاق معين من الأذونات.  بمعنى آخر ، عند تغيير نطاق الأذونات ، يجب عليك حذف الرمز المميز وإنشاء رمز جديد عند تسجيل الدخول. <br><br><h3 style=";text-align:right;direction:rtl">  رمز البرنامج النصي للتحديث عن بعد </h3><br>  الآن سوف نتعلم كيفية تحديث رمز البرنامج النصي عن بعد ، ثم تشغيل هذا الرمز والحصول على النتيجة.  في الواقع ، بالإضافة إلى الشفرة التي نديرها في محرر Google ، يوجد أيضًا <a href="https://developers.google.com/apps-script/concepts/manifests" rel="nofollow">ملف بيان</a> يحتوي على حقوق التشغيل ، وإعدادات النشر ، إلخ.  مزيد من المعلومات حول هيكلها يمكن العثور عليها <a href="https://developers.google.com/apps-script/manifest/" rel="nofollow">هنا</a> . <br>  للاطلاع على ملف البيان الافتراضي الذي أنشأته Google للنص الخاص بك ، انتقل إلى محرر النص في "عرض" -&gt; "إظهار ملف البيان".  سيظهر البيان في قائمة الملفات المتعلقة بهذا البرنامج النصي. <br><br>  لم يكن الكلام عن البيان بدون سبب: يتطلب تحديث البرنامج النصي عن بُعد تنزيل رمز الملفين (* .gs) وبيان البيان (appscript.json). <br><br>  أولاً ، اقرأ رمز ملف .gs الذي نريد نشره: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'export-google-form.gs'</span></span>, <span class="hljs-string"><span class="hljs-string">'r'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: sample_code = f.read()</code> </pre><br>  الآن قم بنسخ البيان الذي تم إنشاؤه تلقائيًا وقم بتعديله قليلاً لأغراضنا.  تصف الوثائق بشكل شامل هيكل ملف البيان ، لذلك لن أتناول هذه النقطة.  لكي يعمل البرنامج النصي ، تحتاج إلى إضافة قسم "implementationApi" إلى البيان الافتراضي المطلوب لتشغيل البرنامج النصي عن بُعد من خلال واجهة برمجة التطبيقات.  في هذا القسم ، نشير إلى دائرة الأشخاص الذين لديهم القدرة على تشغيلها.  لقد سمحت بالتشغيل لجميع الذين حصلوا على ترخيص ، والذي يتوافق مع معرف "أي شخص": <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip()</code> </pre><br>  يجب أن يحتوي نص طلب التحديث على مجموعة من الملفات بالهيكل التالي: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <i>الاسم</i> : اسم الملف المراد إنشاؤه على الخادم ، دون امتداد </li><li style=";text-align:right;direction:rtl">  <i>النوع</i> : <i>نوع</i> الملف (JSON للبيان ، SERVER_JS for .gs) </li><li style=";text-align:right;direction:rtl">  <i>المصدر</i> : رمز الملف </li></ul><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">request = { <span class="hljs-string"><span class="hljs-string">'files'</span></span>: [{ <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'hello'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'SERVER_JS'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: sample_code }, { <span class="hljs-string"><span class="hljs-string">'name'</span></span>: <span class="hljs-string"><span class="hljs-string">'appsscript'</span></span>, <span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'JSON'</span></span>, <span class="hljs-string"><span class="hljs-string">'source'</span></span>: MANIFEST } ] }</code> </pre><br>  أخيرًا ، يجب أن يحتوي طلب التحديث نفسه على النص الأساسي (الطلب الموضح أعلاه) ومعرف البرنامج النصي.  يمكن الحصول على الأخير من خلال الانتقال إلى "الملف" -&gt; "خصائص المشروع" في محرر النصوص ونسخ "معرف البرنامج النصي": <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">script_id = <span class="hljs-string"><span class="hljs-string">'qwertyuiopQWERTYUIOPasdfghjkl123456789zxcvbnmASDFGHJKL54'</span></span></code> </pre><br>  بالنسبة لكائن الخدمة الذي تم الحصول عليه نتيجة لتسجيل الدخول ، نحصل على حقل المشاريع () ونستدعي طريقة updateContent () ، وبعد ذلك نسمي طريقة execute () لكائن HttpRequest المستلم: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">service.projects().updateContent( body=request, scriptId=script_id ).execute()</code> </pre><br>  ومع ذلك ، في الوقت الحالي ، سيؤدي تشغيل الرمز إلى حدوث خطأ: <br><br><pre style=";text-align:right;direction:rtl"> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"error"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">403</span></span>, <span class="hljs-attr"><span class="hljs-attr">"message"</span></span>: <span class="hljs-string"><span class="hljs-string">"Request had insufficient authentication scopes."</span></span>, <span class="hljs-attr"><span class="hljs-attr">"status"</span></span>: <span class="hljs-string"><span class="hljs-string">"PERMISSION_DENIED"</span></span> }</code> </pre><br>  كما ترون ، لا توجد أذونات كافية في مصادقة osprey ، والتي أشرنا إليها سابقًا.  ننتقل إلى الوثائق الرسمية على واجهة برمجة التطبيقات ، وهي طريقة <a href="https://developers.google.com/apps-script/api/reference/rest/v1/projects/updateContent" rel="nofollow">updateContent</a> ، والتي استخدمناها لتحديث البرنامج النصي عن بُعد.  تقول الوثائق أن استخدام هذه الطريقة يتطلب تمكين الوصول إلى script.projects: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">https://www.googleapis.com/auth/script.projects</code> </pre> <br>  قم بإضافته إلى ملف التكوين الخاص بنا في قسم SCOPES.  كما كتبت أعلاه ، عند تغيير osprey ، من الضروري حذف الرمز المميز الذي تم إنشاؤه تلقائيًا. <br><br>  ! ممتاز  في الوقت الحالي ، تعلمنا تحديث برنامج Google النصي عن بُعد.  يبقى لتشغيله والحصول على نتيجة التنفيذ. <br><br><h3 style=";text-align:right;direction:rtl">  تشغيل البرنامج النصي </h3><br>  يحتوي طلب <a href="https://developers.google.com/apps-script/api/reference/rest/v1/scripts/run" rel="nofollow">بدء تشغيل البرنامج النصي</a> على scriptID والنصوص بالهيكل التالي: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <i>الوظيفة</i> : اسم الوظيفة التي نريد تشغيلها </li><li style=";text-align:right;direction:rtl">  <i>المعلمات</i> : <i>(اختياري)</i> مجموعة من المعلمات من النوع البدائي (سلسلة ، صفيف ...) تنتقل إلى الوظيفة </li><li style=";text-align:right;direction:rtl">  <i>sessionState</i> : <i>(اختياري)</i> مطلوب فقط لتطبيقات Android </li><li style=";text-align:right;direction:rtl">  <i>devMode</i> : <i>(اختياري)</i> صحيح إذا كان المستخدم هو مالك البرنامج النصي ، ثم سيتم إطلاق الإصدار الأحدث من الإصدار الذي تم نشره باستخدام Apps Script API.  (افتراضيا - خطأ) </li></ul><br>  من أجل عدم خياطة عنوان URL لنموذج Google في البرنامج النصي ، سنقوم بتمرير <i>form_url</i> إلى الوظيفة <i>الرئيسية</i> كوسيطة. <br><br>  <b>تحذير.</b>  عندما اختبرنا البرنامج النصي ، لم تقبل الوظيفة <i>الرئيسية</i> أي شيء ، لذلك سنقوم بتغيير الأسطر الأولى من التعليمات البرمجية في ملف .gs كما يلي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form_url</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> form = FormApp.openByUrl(form_url); .......</code> </pre><br>  نظرًا لأن تطبيقنا ليس لنظام Android ونحن أصحاب البرنامج النصي ، فسيبدو الجسم كما يلي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">body = { <span class="hljs-string"><span class="hljs-string">"function"</span></span>: <span class="hljs-string"><span class="hljs-string">"main"</span></span>, <span class="hljs-string"><span class="hljs-string">"devMode"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">"parameters"</span></span>: form_url }</code> </pre><br>  قم بتشغيل البرنامج النصي واكتب نتيجة التنفيذ إلى متغير resp: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">resp = service.scripts().run(scriptId=script_id, body=body).execute()</code> </pre><br>  حفظ resp إلى ملف بتنسيق JSON مناسب: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'habr_auto.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'w'</span></span>, encoding=<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: json.dump(resp[<span class="hljs-string"><span class="hljs-string">'response'</span></span>][<span class="hljs-string"><span class="hljs-string">'result'</span></span>], f, ensure_ascii=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, indent=<span class="hljs-number"><span class="hljs-number">4</span></span>)</code> </pre><br>  <b>تحذير.</b>  بسبب حقيقة أن طلب script.run () ينتظر النتيجة عبر مأخذ التوصيل ، عندما يتم تجاوز المهلة بحلول وقت التنفيذ ، سيحدث خطأ من النوع التالي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs">socket.timeout: The read operation timed out</code> </pre><br>  لتجنب هذا السلوك ، أوصي في بداية البرنامج بتعيين حد لوقت مأخذ التوصيل المفتوح ، وهو ما يكفي بوضوح لانتظار انتهاء البرنامج النصي للتنفيذ.  في حالتي ، 120 ثانية تكفي: <br><br><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>)</code> </pre><br>  فويلا!  خط أنابيب مناسب للتحديث عن بعد وإطلاق البرامج النصية من Google جاهز.  ويرد رمز كامل تكييفها لاطلاق من المحطة في <a href="https://github.com/nikanor97/habr_google_script_api" rel="nofollow">جيثب</a> بلدي. <br><br>  أيضا ، سأقدم رمز الوظائف الرئيسية أدناه <br><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">login.py</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pickle <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os.path <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient.discovery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> build <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_auth_oauthlib.flow <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> InstalledAppFlow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google.auth.transport.requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Request <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(config)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: creds = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-comment"><span class="hljs-comment"># The file token.pickle stores the user's access and refresh tokens, and is # created automatically when the authorization flow completes for the first # time. token_file = config['credentials_path'] + config['token_file'] credentials_file = config['credentials_path'] + config['credentials_file'] if os.path.exists(token_file): with open(token_file, 'rb') as token: creds = pickle.load(token) # If there are no (valid) credentials available, let the user log in. if not creds or not creds.valid: if creds and creds.expired and creds.refresh_token: creds.refresh(Request()) else: flow = InstalledAppFlow.from_client_secrets_file(credentials_file, config['SCOPES']) creds = flow.run_local_server(port=0) # Save the credentials for the next run with open(token_file, 'wb') as token: pickle.dump(creds, token) service = build('script', 'v1', credentials=creds) pprint('Login successful') return service except Exception as e: pprint(f'Login failure: {e}') return None</span></span></code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">update_script.py</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login MANIFEST = <span class="hljs-string"><span class="hljs-string">''' { "timeZone": "America/New_York", "exceptionLogging": "STACKDRIVER", "executionApi": { "access": "ANYONE" } } '''</span></span>.strip() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update_project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(service, script_id, script_file_name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># Read from file code we want to deploy with open(script_file_name, 'r') as f: sample_code = f.read() # Upload two files to the project request = { 'files': [{ 'name': 'hello', 'type': 'SERVER_JS', 'source': sample_code }, { 'name': 'appsscript', 'type': 'JSON', 'source': MANIFEST } ] } # Update files in the project service.projects().updateContent( body=request, scriptId=script_id ).execute() pprint('Project was successfully updated') def main(): try: args = sys.argv if len(args) != 4: raise TypeError('Wrong number of arguments. Three argument required: &lt;config_file_name&gt;, &lt;script_id&gt; and ' '&lt;script_file_name&gt;') config_file_name = args[1] script_id = args[2] script_file_name = args[3] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) update_project(service, script_id, script_file_name) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">export_form.py</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pprint <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> socket <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> googleapiclient <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> errors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> google_habr_login <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> login socket.setdefaulttimeout(<span class="hljs-number"><span class="hljs-number">120</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Get JSON, which is returned by script def get_json(service, file_name, script_id, form_url): pprint('Exporting form...') body = { "function": "main", "devMode": True, "parameters": form_url } # Get JSON from script resp = service.scripts().run(scriptId=script_id, body=body).execute() # Write out JSON to file with open(file_name, 'w', encoding='utf-8') as f: json.dump(resp['response']['result'], f, ensure_ascii=False, indent=4) pprint('Form was successfully exported') def main(): try: args = sys.argv if len(args) != 5: raise TypeError('Wrong number of arguments. Four arguments required: &lt;config_file_name&gt;, ' '&lt;result_file_name&gt;, &lt;script_id&gt; and &lt;google_form_url&gt;') config_file_name = args[1] file_name = args[2] script_id = args[3] form_url = args[4] with open(config_file_name, "r") as f: config = json.load(f) service = login(config) get_json(service, file_name, script_id, form_url) except (errors.HttpError, ) as error: # The API encountered a problem. pprint(error.content.decode('utf-8')) if __name__ == '__main__': main()</span></span></code> </pre><br></div></div><br>  للبدء ، تحتاج إلى وضع ملف JSON مع مفاتيح الوصول إلى Google في مجلد بيانات الاعتماد ، وتهيئة JSON في نفس الدليل مثل البرامج النصية. <br><br>  ثم ، إذا كنا نريد تحديث البرنامج النصي عن بُعد ، فعند اتصال المحطة الطرفية: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">python update_script.py &lt;config_file_name&gt; &lt;script_id&gt; &lt;script_file_name&gt;</code> </pre><br>  في هذه الحالة: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <i>config_file_name</i> - اسم ملف التكوين JSON </li><li style=";text-align:right;direction:rtl">  <i>script_id</i> - معرف البرنامج النصي </li><li style=";text-align:right;direction:rtl">  <i>script_file_name</i> - اسم ملف .gs الذي سيتم تحميله إلى google </li></ul><br>  لتشغيل البرنامج النصي ، اتصل: <br><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">python export_form.py &lt;config_file_name&gt; &lt;result_file_name&gt; &lt;script_id&gt; &lt;google_form_url&gt;</code> </pre><br>  في هذه الحالة: <br><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <i>config_file_name</i> - اسم ملف التكوين JSON </li><li style=";text-align:right;direction:rtl">  <i>result_file_name</i> - اسم ملف JSON الذي سيتم فيه إلغاء تحميل النموذج </li><li style=";text-align:right;direction:rtl">  <i>script_id</i> - معرف البرنامج النصي </li><li style=";text-align:right;direction:rtl">  <i>google_form_url</i> - google form url </li></ul><br>  شكرا لاهتمامكم ، في انتظار اقتراحاتكم وتعليقاتكم :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar485898/">https://habr.com/ru/post/ar485898/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar485878/index.html">سلسلة من الخطوات لتنظيم المحاسبة الإدارية على منصة JetCalc</a></li>
<li><a href="../ar485884/index.html">كيفية إعداد Levitron الصينية</a></li>
<li><a href="../ar485886/index.html">كيف (ولماذا) تحليل مفاتيح وإعلانات المنافسين من Yandex.Direct وإعلانات Google مجانًا</a></li>
<li><a href="../ar485888/index.html">خادم طلب تزوير ، عملية أعمى SSRF</a></li>
<li><a href="../ar485896/index.html">قاعدة بيانات متوازية بشكل كبير Greenplum - برنامج تعليمي قصير</a></li>
<li><a href="../ar485908/index.html">بفضل خلل مذهل في Ocarina of Time ، كان من الممكن إضافة نماذج من Star Fox 64</a></li>
<li><a href="../ar485910/index.html">نشر واجهات برمجة التطبيقات مع AWS مرن شجرة الفاصولياء</a></li>
<li><a href="../ar485912/index.html">لماذا تعد الترجمة في التسمية أمرًا سيئًا وغير ذلك من الميزات المثيرة للاهتمام لتصورنا للرمز</a></li>
<li><a href="../ar485914/index.html">مدعوم من ZeroTier. دليل عملي لبناء الشبكات الافتراضية. الجزء 1</a></li>
<li><a href="../ar485916/index.html">إزالة غير ضروري [امسح الجدول من غير الضروري]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>