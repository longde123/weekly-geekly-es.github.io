<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêã üïé ‚èèÔ∏è Como funciona a renderiza√ß√£o de jogos em 3D: processamento de v√©rtices üö• üêè üëåüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste post, consideraremos a etapa do trabalho com v√©rtices. Ou seja, teremos novamente que obter os livros did√°ticos de matem√°tica e lembrar √°lgebra ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como funciona a renderiza√ß√£o de jogos em 3D: processamento de v√©rtices</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472688/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/070/e30/bd5/070e30bd57f6af2d7c1e36abe15f949b.jpg" alt="imagem"></div><br>  Neste post, consideraremos a etapa do trabalho com v√©rtices.  Ou seja, teremos novamente que obter os livros did√°ticos de matem√°tica e lembrar √°lgebra linear, matrizes e trigonometria.  Viva! <br><br>  Vamos descobrir como os modelos 3D s√£o transformados e as fontes de luz s√£o levadas em considera√ß√£o.  Tamb√©m explicaremos em detalhes a diferen√ßa entre v√©rtices e sombreamentos geom√©tricos, e voc√™ descobrir√° em que est√°gio √© o local do mosaico.  Para facilitar o entendimento, usamos diagramas e exemplos de c√≥digo que demonstram como o jogo executa c√°lculos e processa valores. <br><br>  A captura de tela no in√≠cio do post mostra o jogo GTA V no modo de exibi√ß√£o de estrutura de arame.  Compare-o com a estrutura de arame half-Life muito menos complexa 2. As imagens foram criadas por thalixte com <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ReShade</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4c4/562/7ee/4c45627ee9916f0bcdce6858b510b6a6.jpg"></div><a name="habracut"></a><br><h2>  Qual √© o objetivo? </h2><br>  No mundo da matem√°tica, um ponto √© simplesmente um lugar no espa√ßo geom√©trico.  Como n√£o h√° nada menor que um ponto, ele n√£o tem tamanho; portanto, os pontos podem ser usados ‚Äã‚Äãpara especificar a localiza√ß√£o exata do in√≠cio e do fim dos objetos, como segmentos de linha, planos e volumes. <br><br>  Para gr√°ficos 3D, essas informa√ß√µes s√£o extremamente importantes, a apar√™ncia de tudo depende disso, porque todos os objetos s√£o exibidos como conjuntos de segmentos de linhas, planos etc.  A imagem abaixo mostra uma captura de tela do Bethesda 2015 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fallout 4</a> : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/87b/33c/f82/87b33cf825a8ed9d87b7c8a7cc873e69.jpg"></div><br>  Pode n√£o ser f√°cil para voc√™ ver que isso √© apenas um monte de pontos e linhas, por isso mostraremos como a mesma cena fica no modo de estrutura de arame.  Nesse modo, o mecanismo de renderiza√ß√£o 3D ignora as texturas e os efeitos executados no est√°gio do pixel e desenha apenas linhas multicoloridas conectando os pontos. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/430/8a0/f67/4308a0f6729ff459c600275d8755f12c.jpg"></div><br>  Agora tudo parece completamente diferente, mas vemos como todas as linhas s√£o combinadas para formar v√°rios objetos, ambientes e planos de fundo.  Alguns consistem em apenas dezenas de linhas, por exemplo, pedras em primeiro plano, enquanto outras cont√™m tantas linhas que parecem s√≥lidas. <br><br>  Cada ponto no in√≠cio e no final de cada linha √© processado executando v√°rios c√°lculos.  Alguns c√°lculos s√£o muito simples e r√°pidos, outros s√£o muito mais complicados.  Ao processar pontos em grupos, especialmente na forma de tri√¢ngulos, voc√™ pode obter um aumento significativo na produtividade, ent√£o vamos dar uma olhada neles. <br><br><h2>  O que √© necess√°rio para um tri√¢ngulo? </h2><br>  O nome <em>tri√¢ngulo</em> deixa claro que a figura tem tr√™s cantos internos;  Para fazer isso, ela precisa de tr√™s pontos de canto e tr√™s segmentos conectando-os.  √â correto chamar um ponto de <em>v√©rtice de v√©rtice</em> (no plural - v√©rtices);  cada v√©rtice √© definido por um ponto.  Como estamos em um mundo geom√©trico tridimensional, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">sistema de coordenadas cartesianas √©</a> usado para obter pontos.  Normalmente, as coordenadas s√£o escritas na forma de tr√™s valores, por exemplo, (1, 8, -3) ou genericamente ( <em>x, y, z</em> ). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64c/b9e/77f/64cb9e77ffcc16159b4d201026a4ba04.png"></div><br>  Em seguida, podemos adicionar mais dois v√©rtices para formar um tri√¢ngulo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/732/482/c6b/732482c6b6faef01c7a7281f9b30da31.png"></div><br>  Observe que as linhas mostradas s√£o opcionais - podemos definir os pontos e informar ao sistema que esses tr√™s v√©rtices formam um tri√¢ngulo.  Todos os dados de v√©rtice s√£o armazenados em um bloco de mem√≥ria cont√≠guo chamado <em>buffer de v√©rtice</em> ;  as informa√ß√µes sobre a figura que eles formam s√£o codificadas diretamente no programa de renderiza√ß√£o ou armazenadas em outro bloco de mem√≥ria chamado <em>buffer de √≠ndice</em> . <br><br>  Se as informa√ß√µes s√£o codificadas em um programa de renderiza√ß√£o, as v√°rias formas que podem ser formadas por v√©rtices s√£o chamadas <em>primitivas</em> .  O Direct3D sugere o uso de uma lista para eles, tiras e ventiladores na forma de pontos, linhas e tri√¢ngulos.  Quando usadas corretamente, as faixas de tri√¢ngulos usam v√©rtices para mais de um tri√¢ngulo, o que melhora a produtividade.  No exemplo abaixo, vemos que, para criar dois tri√¢ngulos conectados, s√£o necess√°rios apenas quatro v√©rtices - se eles estiverem separados, precisaremos de seis v√©rtices. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/41e/9cb/a1e/41e9cba1ee23a0b9787994ef7249d6ff.png"></div><br>  <i>Da esquerda para a direita: lista de pontos, lista de linhas e tira de tri√¢ngulos</i> <br><br>  Se precisarmos processar um conjunto maior de v√©rtices, por exemplo, em um modelo de NPC de jogo, √© melhor usar um objeto chamado <em>malha</em> , outro bloco de mem√≥ria, mas que consiste em v√°rios buffers (v√©rtices, √≠ndices etc.) e recursos de textura do modelo .  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o online</a> da Microsoft tem uma breve explica√ß√£o de como usar esses buffers. <br><br>  Por enquanto, vamos nos concentrar no que acontece com esses v√©rtices em um jogo em 3D ao renderizar cada novo quadro.  Em resumo, eles executam uma das duas opera√ß√µes: <br><br><ul><li>  O v√©rtice se move para uma nova posi√ß√£o. </li><li>  Mudan√ßas na cor do v√©rtice </li></ul><br>  Pronto para matem√°tica?  Excelente, porque precisamos disso. <br><br><h2>  Vetor aparece no palco. </h2><br>  Imagine que voc√™ tem um tri√¢ngulo na tela e pressiona uma tecla para mov√™-lo para a esquerda.  Naturalmente, esperamos que os n√∫meros ( <em>x, y, z</em> ) de cada v√©rtice sejam alterados de acordo;  √© isso que acontece, mas uma <em>maneira</em> inesperada <em>de</em> implementar mudan√ßas.  Em vez de simplesmente alterar as coordenadas, a grande maioria dos sistemas de renderiza√ß√£o de gr√°ficos 3D usa uma ferramenta matem√°tica especial: queremos dizer <em>vetores</em> . <br><br>  Um vetor pode ser representado como uma seta apontando para um ponto espec√≠fico no espa√ßo e tendo o comprimento desejado.  Os v√©rtices s√£o geralmente definidos usando vetores baseados em coordenadas cartesianas: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c5/5e4/79d/1c55e479dbf4da359cfa6ef7e3d55e8f.png"></div><br>  Observe que a seta azul come√ßa em um lugar (neste caso, o <em>ponto de origem</em> ) e se estende at√© o topo.  Para definir o vetor, usamos um <em>registro em uma coluna</em> , mas √© bem poss√≠vel usar um <em>registro em uma linha</em> .  Voc√™ deve ter notado que existe outro quarto valor, geralmente chamado <em>de componente w</em> .  √â usado para mostrar o que o vetor significa: posi√ß√£o do ponto ( <em>vetor da posi√ß√£o</em> ) ou dire√ß√£o geral (vetor da <em>dire√ß√£o</em> ).  No caso de um vetor de dire√ß√£o, ele ter√° a seguinte apar√™ncia: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bb2/73e/525/bb273e52588aa21666075a11a34ee32d.png"></div><br>  Esse vetor aponta na mesma dire√ß√£o e tem o mesmo comprimento que o vetor de posi√ß√£o anterior, ou seja, os valores ( <em>x, y, z</em> ) ser√£o os mesmos;  no entanto, o componente <em>w</em> n√£o √© 1, mas zero.  Explicaremos o uso de vetores de dire√ß√£o posteriormente, mas, por enquanto, lembre-se do fato de que todos os v√©rtices na cena 3D ser√£o descritos dessa maneira.  Porque  Porque neste formato √© muito mais f√°cil mov√™-los. <br><br><h2>  Matem√°tica, matem√°tica e novamente matem√°tica </h2><br>  Lembre-se de que temos um tri√¢ngulo simples e queremos mov√™-lo para a esquerda.  Cada v√©rtice √© descrito por um vetor de posi√ß√£o; portanto, a ‚Äúmatem√°tica do movimento‚Äù (chamada <em>transforma√ß√µes</em> ) deve trabalhar com esses vetores.  Uma nova ferramenta aparece: <em>matrizes</em> ( <em>matriz</em> no singular).  Essa √© uma matriz de valores gravados em um formato semelhante a uma planilha do Excel, com linhas e colunas. <br><br>  Para cada tipo de transforma√ß√£o, h√° uma matriz correspondente e, para uma transforma√ß√£o, basta multiplicar a matriz de transforma√ß√£o e o vetor de posi√ß√£o.  N√£o entraremos em detalhes de como e por que isso acontece, mas apenas veremos como fica. <br><br>  Mover um v√©rtice no espa√ßo 3D √© chamado de <em>tradu√ß√£o</em> e requer o seguinte c√°lculo: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/530/c9b/eca/530c9beca19d9b0c8d61db78ecb8682a.png"></div><br>  Valores <em>x <sub>0</sub></em> , etc.  representa as coordenadas originais do vetor;  valores <em>delta</em> - <em>x</em> representam a quantidade pela qual o v√©rtice precisa ser movido.  A multiplica√ß√£o da matriz e do vetor leva ao fato de que eles simplesmente resumem (observe que o componente <em>w</em> permanece inalterado, de modo que a resposta final permanece o vetor de posi√ß√£o como antes). <br><br>  Al√©m de mover, tamb√©m podemos precisar rotacionar o tri√¢ngulo ou alterar sua escala - para essas opera√ß√µes, tamb√©m h√° transforma√ß√µes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1fc/ba4/d0b/1fcba4d0b2a678e94c17c49a09af0591.png"></div><br>  <i>Essa transforma√ß√£o gira o v√©rtice em torno do eixo z no plano XY</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5eb/1d5/26e/5eb1d526eb15b522f3fddb0dadffa8cf.png"></div><br>  <em>E isso √© usado se voc√™ precisar alterar a escala da figura</em> <br><br>  Podemos usar a ferramenta gr√°fica baseada em WebGL da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Real-Time Rendering</a> para visualizar esses c√°lculos para a figura inteira.  Vamos come√ßar com a caixa na posi√ß√£o padr√£o: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/220/5d7/3d2/2205d73d2920758e3fb11f6829cb924d.jpg"></div><br>  Nesta ferramenta online, o ponto do modelo √© o vetor de posi√ß√£o, a matriz mundial √© a matriz de transforma√ß√£o e o ponto do espa√ßo mundial √© o vetor de posi√ß√£o do v√©rtice transformado. <br><br>  Vamos aplicar v√°rias transforma√ß√µes √† caixa: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/820/d7b/5d6/820d7b5d618f68de9446d0ee005a50da.jpg"></div><br>  Na imagem acima, a figura foi <em>movida</em> 5 unidades ao longo de cada eixo.  Esses valores podem ser vistos na √∫ltima coluna da matriz grande do meio.  O vetor de posi√ß√£o original (4, 5, 3, 1) permanece o mesmo que deveria, mas o v√©rtice transformado agora √© movido para (9, 10, 8, 1). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/9a1/8c4/6fd/9a18c46fd6df9936f3632fd4e4b2a287.jpg"></div><br>  Nesta transforma√ß√£o, tudo foi dimensionado por um fator de 2: agora os lados da caixa se tornaram o dobro do tempo.  Por fim, veja o exemplo de rota√ß√£o: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/21c/beb/340/21cbeb3409b55b736d2dd1322a1d80b0.jpg"></div><br><br>  O paralelep√≠pedo foi girado atrav√©s de um √¢ngulo de 45 ¬∞, mas o <em>seno</em> e o <em>cosseno</em> desse √¢ngulo s√£o usados ‚Äã‚Äãna matriz.  Depois de verificar em uma calculadora cient√≠fica, podemos ver que <em>sin (45 ¬∞)</em> = 0,7071 ..., que √© arredondado para o valor mostrado de 0,71.  N√≥s obtemos a mesma resposta para o valor do <em>cosseno</em> . <br><br>  Matrizes e vetores s√£o opcionais;  Uma alternativa popular para eles, especialmente ao lidar com curvas complexas, √© o uso de n√∫meros complexos e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">quaterni√µes</a> .  Esses c√°lculos s√£o muito diferentes dos vetores, portanto, n√£o os consideraremos, continuando a trabalhar com transforma√ß√µes. <br><br><h2>  Poder do shader do v√©rtice </h2><br>  Nesse est√°gio, precisamos entender que tudo isso √© feito por pessoas que programam o c√≥digo de renderiza√ß√£o.  Se um desenvolvedor de jogos usa um mecanismo de terceiros (por exemplo, Unity ou Unreal), tudo isso j√° foi feito por ele;  mas se algu√©m fizer seu motor do zero, precisar√° executar todos esses c√°lculos com v√©rtices. <br><br>  Mas como tudo isso parece em termos de c√≥digo? <br><br>  Para entender isso, usaremos exemplos do incr√≠vel site <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Braynzar Soft</a> .  Se voc√™ deseja come√ßar a trabalhar com programa√ß√£o 3D, ent√£o este √© o lugar certo para aprender o b√°sico, bem como as coisas mais complexas ... <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/726/99f/664/72699f66423a8f3094cb911bc99a18e2.png"></div><br>  Este √© um exemplo de uma transforma√ß√£o all-in-one.  Ele cria as matrizes de transforma√ß√£o apropriadas com base na entrada do teclado e as aplica ao vetor de posi√ß√£o original em uma opera√ß√£o.  Observe que isso sempre √© feito na ordem especificada (redimensionamento - rota√ß√£o - transfer√™ncia), porque qualquer outra maneira arruinar√° completamente o resultado. <br><br>  Esses blocos de c√≥digo s√£o chamados de <em>sombreadores de v√©rtices</em> ; sua complexidade e tamanho podem variar enormemente.  O exemplo acima √© simples, √© <em>apenas um</em> shader de v√©rtice que n√£o usa toda a natureza program√°vel dos shaders.  Uma sequ√™ncia mais complexa de shaders pode transformar objetos no espa√ßo 3D, processar sua apar√™ncia do ponto de vista da c√¢mera de cena e depois transferir dados para o pr√≥ximo est√°gio do processo de renderiza√ß√£o.  Considerando a ordem do processamento do v√©rtice, estudaremos outros exemplos. <br><br>  Obviamente, eles podem ser usados ‚Äã‚Äãpara muito mais; portanto, ao jogar um jogo em 3D, n√£o esque√ßa que todo o movimento que voc√™ v√™ √© feito por uma GPU executando comandos de vertex shader. <br><br>  No entanto, esse nem sempre foi o caso.  Se voc√™ voltar a meados dos anos 90, as placas gr√°ficas daquela √©poca n√£o tinham a capacidade de processar independentemente v√©rtices e primitivas, apenas o processador central fazia tudo isso. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/954/1d1/c15/9541d1c150a6ef926d98449addf51206.jpg"></div><br>  Um dos primeiros processadores com sua pr√≥pria acelera√ß√£o de hardware desse processo foi a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Nvidia GeForce, lan√ßada em 2000</a> , e essa funcionalidade foi chamada de <em>Hardware Transform and Lighting</em> (abrevia√ß√£o de Hardware TnL).  Os processos com os quais esse equipamento podia lidar eram muito limitados em termos de equipes, mas com o lan√ßamento de novos chips, a situa√ß√£o mudou rapidamente.  Hoje, n√£o h√° equipamentos separados para o processamento de v√©rtices, e um dispositivo faz tudo de uma vez: pontos, primitivas, pixels, texturas etc. <br><br>  A prop√≥sito, sobre <em>ilumina√ß√£o</em> : vale a pena notar que vemos tudo gra√ßas √† luz, ent√£o vamos ver como ele pode ser processado no est√°gio do v√©rtice.  Para fazer isso, precisamos aproveitar o que falamos anteriormente. <br><br><h2>  Luz, c√¢mera, motor! </h2><br>  Imagine esta foto: o jogador est√° em um quarto escuro, iluminado por uma fonte de luz √† direita.  No meio da sala h√° uma chaleira enorme.  Voc√™ pode precisar de ajuda com isso, ent√£o vamos usar o site de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">renderiza√ß√£o em tempo real</a> e ver como fica: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b1a/6a4/5f4/b1a6a45f47e81bec587c4f7bda1bf3ae.jpg"></div><br>  N√£o esque√ßa que este objeto √© um conjunto de tri√¢ngulos planos conectados juntos;  isto √©, o plano de cada tri√¢ngulo ser√° direcionado em uma determinada dire√ß√£o.  Alguns deles s√£o direcionados para a c√¢mera, alguns - para outros, alguns ser√£o distorcidos.  A luz da fonte cai em cada plano e √© refletida a partir de um certo √¢ngulo. <br><br>  Dependendo de onde a luz √© refletida, a cor e o brilho do avi√£o podem mudar e, para que a cor do objeto pare√ßa correta, tudo isso precisa ser calculado e levado em considera√ß√£o. <br><br>  Para come√ßar, precisamos descobrir para onde cada plano √© direcionado e, para isso, precisamos <em>do vetor normal do</em> plano.  Essa √© outra seta, mas, diferentemente do vetor de posi√ß√£o, seu tamanho n√£o √© importante (de fato, depois de calcular a escala dos vetores normais sempre diminui para que eles tenham um comprimento de 1), e √© sempre direcionado <em>perpendicularmente</em> (em √¢ngulo reto) ao plano. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/228/84c/836/22884c83697e201f3b00bb7d06f6f95f.png"></div><br>  O normal para o plano de cada tri√¢ngulo √© calculado determinando o produto vetorial de dois vetores de dire√ß√£o (mostrados acima <strong>p</strong> e <strong>q</strong> ) que formam os lados do tri√¢ngulo.  De fato, √© melhor calcul√°-los para cada v√©rtice, e n√£o para um tri√¢ngulo, mas como sempre h√° mais do que o √∫ltimo, ser√° mais r√°pido calcular as normais dos tri√¢ngulos. <br><br>  Depois de receber o normal na superf√≠cie, voc√™ pode come√ßar a considerar a fonte de luz e a c√¢mera.  Na renderiza√ß√£o 3D, as fontes de luz podem ser de tipos diferentes, mas neste artigo consideraremos apenas fontes <em>direcionais</em> , por exemplo, holofotes.  Como o plano do tri√¢ngulo, o foco e a c√¢mera apontam em uma determinada dire√ß√£o, algo como isto: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3a8/f24/b91/3a8f24b915d631a9608faaf106b04300.png"></div><br>  O vetor da fonte de luz e o vetor normal podem ser usados ‚Äã‚Äãpara calcular o √¢ngulo em que a luz cai na superf√≠cie (usando a rela√ß√£o entre o produto escalar dos vetores e o produto de seu tamanho).  Os v√©rtices do tri√¢ngulo conter√£o informa√ß√µes adicionais sobre sua cor e material.  O material descreve o que acontece com a luz quando atinge a superf√≠cie. <br><br>  Uma superf√≠cie lisa de metal refletir√° quase toda a luz incidente no √¢ngulo em que caiu e mal mudar√° a cor do objeto.  O material fosco √°spero dispersa a luz de maneira menos previs√≠vel e muda ligeiramente de cor.  Para levar isso em considera√ß√£o, voc√™ precisa adicionar valores adicionais aos v√©rtices: <br><br><ul><li>  Cor base original </li><li>  Atributo de material ambiente - um valor que determina quanto a ilumina√ß√£o de "fundo" pode absorver e refletir um v√©rtice </li><li>  O atributo do material Difuso √© outro valor, mas desta vez a determina√ß√£o da ‚Äúrugosidade‚Äù do v√©rtice, que, por sua vez, afeta a quantidade de absor√ß√£o e reflex√£o da luz dispersa. </li><li>  Atributos de material especular - dois valores que especificam o brilho do v√©rtice </li></ul><br>  Diferentes modelos de ilumina√ß√£o usam diferentes f√≥rmulas matem√°ticas para agrupar todos esses atributos, e o resultado do c√°lculo √© o vetor de ilumina√ß√£o de sa√≠da.  Em combina√ß√£o com o vetor da c√¢mera, permite determinar a apar√™ncia geral do tri√¢ngulo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/627/648/a21/627648a213ed357982314f7ed7fdd915.jpg"></div><br>  <i>Uma fonte de luz direcional ilumina muitos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">demos Nvidia</a> diferentes</i> <br><br>  Omitimos muitos detalhes detalhados, e por boas raz√µes: abra qualquer tutorial de renderiza√ß√£o em 3D e voc√™ ver√° que cap√≠tulos inteiros s√£o dedicados a esse processo.  No entanto, nos jogos modernos, a maior parte de todos os c√°lculos de efeitos de ilumina√ß√£o e materiais s√£o realizados no est√°gio de processamento de pixels, portanto, retornaremos a eles no pr√≥ximo artigo. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d7c/8b7/3b0/d7c8b73b0185c20eb23b2a9fdee1cba6.png"></div><br>  <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">C√≥digo de amostra</a> B. Anguelov mostrando como o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">modelo de reflex√£o da luz Phong</a> pode ser processado no shader de v√©rtice.</i> <br><br>  Tudo o que examinamos acima √© feito por sombreadores de v√©rtices e parece que nada √© imposs√≠vel para eles;  infelizmente isso n√£o √© verdade.  Os sombreadores de v√©rtices n√£o podem criar novos v√©rtices e cada sombreador deve processar cada v√©rtice individual.  Seria conveniente se voc√™ pudesse usar o c√≥digo para criar novos tri√¢ngulos entre os que j√° possu√≠mos (para melhorar a qualidade visual) e um shader que processe toda uma primitiva (para acelerar o processamento).  Bem, nas GPUs modernas, <em>podemos</em> faz√™-lo! <br><br><h2>  Por favor, senhor, eu quero mais (tri√¢ngulos) </h2><br>  Os chips gr√°ficos modernos s√£o extremamente poderosos e capazes de executar milh√µes de c√°lculos de vetores matriciais a cada segundo;  eles lidam facilmente com uma enorme pilha de picos por vez.  Por outro lado, a cria√ß√£o de modelos altamente detalhados para renderiza√ß√£o √© um processo muito longo e, se o modelo estiver a alguma dist√¢ncia da cena, todos esses detalhes ser√£o desperdi√ßados. <br><br>  Ou seja, precisamos de alguma forma ordenar que o processador divida uma primitiva grande, por exemplo, um tri√¢ngulo plano em um conjunto de tri√¢ngulos menores localizados dentro do original.  Esse processo √© chamado de <em>mosaico,</em> e os chips gr√°ficos j√° aprenderam a execut√°-lo muito bem;  ao longo dos anos de desenvolvimento, o grau de controle que os programadores t√™m sobre esse processo aumentou. <br><br>  Para analisar isso em a√ß√£o, usaremos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ferramenta de benchmark Heaven do mecanismo Unigine</a> , porque ela nos permite aplicar diferentes valores de mosaico aos modelos usados ‚Äã‚Äãno teste. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d11/630/5fd/d116305fd0fa789635bc3631a4463829.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para come√ßar, vamos tomar um lugar no benchmark e estud√°-lo sem usar mosaico. </font><font style="vertical-align: inherit;">Observe que os paralelep√≠pedos no ch√£o parecem muito antinaturais - a textura usada √© eficaz, mas parece errada. </font><font style="vertical-align: inherit;">Vamos aplicar o mosaico √† cena: o mecanismo Unigine o aplica apenas a pe√ßas individuais, mas a diferen√ßa ser√° significativa.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e1c/8fb/399/e1c8fb3998d448711164832c4b3af2ff.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A terra, as bordas dos edif√≠cios e a porta parecem muito mais realistas. </font><font style="vertical-align: inherit;">Podemos ver como isso foi alcan√ßado iniciando o processo novamente, mas desta vez com a sele√ß√£o de todas as primitivas (ou seja, no modo de estrutura de arame):</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0c2/691/fec/0c2691fec046708d4c65058ed3cec016.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â claramente visto por que a Terra parece t√£o estranha - √© completamente plana! A porta se funde com as paredes e as bordas do edif√≠cio s√£o simples paralelep√≠pedos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No Direct3D, as primitivas podem ser divididas em um grupo de partes menores (esse processo √© chamado </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">de subdivis√£o)</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> executando um processo de tr√™s etapas. Primeiro, os programadores escrevem um </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shader de superf√≠cie (hull shader)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - na verdade, esse c√≥digo cria uma estrutura chamada de </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">patch de geometria</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Voc√™ pode pensar nisso como um mapa informando ao processador onde novos pontos e linhas aparecer√£o dentro do primitivo inicial. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em seguida, o bloco do mosaico dentro da GPU aplica esse patch ao primitivo. No final, um </font><em><font style="vertical-align: inherit;">sombreador de dom√≠nio</font></em><font style="vertical-align: inherit;"> √© executado</font></font><em><font style="vertical-align: inherit;"></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">calcular as posi√ß√µes de todos os novos v√©rtices. Se necess√°rio, esses dados podem ser transferidos de volta para o buffer de v√©rtice, para que os c√°lculos de ilumina√ß√£o possam ser executados novamente, mas desta vez com melhores resultados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como √© isso? Vamos lan√ßar a vers√£o em wireframe da cena mosaica:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3c0/ca9/5af/3c0ca95af3ce89f1ae854706dfd04adc.jpg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Honestamente, estabelecemos um alto grau de mosaico para tornar a explica√ß√£o do processo mais vis√≠vel. N√£o importa o qu√£o bons sejam os chips gr√°ficos modernos, isso n√£o deve ser feito em todas as cenas - observe, por exemplo, a l√¢mpada ao lado da porta. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nas imagens com a estrutura de arame desativada, dificilmente voc√™ encontrar√° diferen√ßas a essa dist√¢ncia, e vemos que esse n√≠vel de mosaico adicionou tantos tri√¢ngulos que √© dif√≠cil separ√°-los. No entanto, quando usada corretamente, essa fun√ß√£o de processamento de v√©rtices pode criar efeitos visuais fant√°sticos, especialmente ao simular colis√µes de corpos moles. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos ver como isso pode parecer em termos de c√≥digo Direct3D; para isso, usamos o exemplo de outro √≥timo site, o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RasterTek</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Aqui est√° um tri√¢ngulo verde simples, dividido em v√°rios pequenos tri√¢ngulos ... </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/13a/3bd/3d4/13a3bd3d482f26404d92d3ab60694fa3.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O </font><font style="vertical-align: inherit;">processamento de </font><font style="vertical-align: inherit;">v√©rtices </font><font style="vertical-align: inherit;">√© realizado por tr√™s sombreadores separados (consulte o </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">exemplo de c√≥digo</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ): um sombreador de v√©rtice preparando um tri√¢ngulo para mosaico, um sombreamento de superf√≠cie gerando um patch e um sombreador de dom√≠nio processando novos v√©rtices. </font><font style="vertical-align: inherit;">O resultado √© compreens√≠vel o suficiente, mas o exemplo da Unigine demonstra os benef√≠cios em potencial e os perigos do uso generalizado do mosaico.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> "Iron" n√£o aguenta mais! </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lembre-se, dissemos que os sombreadores de v√©rtices sempre processam todos os v√©rtices de uma cena? √â f√°cil entender que o mosaico pode ser um problema s√©rio aqui. E existem muitos efeitos visuais nos quais voc√™ precisa processar vers√µes diferentes de uma primitiva, mas sem cri√°-las desde o in√≠cio, por exemplo, cabelos, p√™los, grama e part√≠culas de explos√µes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Felizmente, especialmente para essas coisas, existe outro shader - um </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shader geom√©trico</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Esta √© uma vers√£o mais limitada do shader de v√©rtice, mas pode ser aplicada a toda a primitiva. Em combina√ß√£o com o mosaico, oferece aos programadores maior controle sobre grandes grupos de v√©rtices.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/602/97d/f09/60297df09a132ab07b00140fa2a07b77.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O 3DMark Vantage da UL Benchmark - sombreadores geom√©tricos processam part√≠culas e sinalizadores</font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Direct3D, como todas as APIs gr√°ficas modernas, permite realizar muitos c√°lculos com v√©rtices. Os dados finalizados podem ser transferidos para o pr√≥ximo est√°gio do processo de renderiza√ß√£o ( </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rasteriza√ß√£o</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ) ou retornados ao pool de mem√≥ria para reprocessamento ou leitura pelo processador central para outros fins. Como a documenta√ß√£o da Microsoft no </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Direct3D</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> diz </font><font style="vertical-align: inherit;">, isso pode ser implementado como um fluxo de dados:</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/638/134/de2/638134de2960977f2847aab27c88df84.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">etapa de sa√≠da do fluxo √©</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> opcional, especialmente porque s√≥ pode transferir primitivas inteiras (em vez de v√©rtices individuais) de volta ao ciclo de renderiza√ß√£o, mas √© √∫til para efeitos que exigem um grande n√∫mero de part√≠culas. O mesmo truque pode ser feito usando um </font><font style="vertical-align: inherit;">buffer de v√©rtice </font><font style="vertical-align: inherit;">vari√°vel ou </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">din√¢mico</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mas √© melhor manter os buffers de entrada inalterados, porque quando voc√™ os abre para edi√ß√£o, o desempenho √© reduzido. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O processamento de v√©rtices √© uma parte cr√≠tica da renderiza√ß√£o, porque determina como ser√° a cena da perspectiva da c√¢mera. Nos jogos modernos, milh√µes de tri√¢ngulos podem ser usados ‚Äã‚Äãpara construir mundos, e cada um desses v√©rtices √© de alguma forma transformado e iluminado.</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bdd/760/829/bdd760829e81753b4938fd8ff3076b6d.jpg"></div><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tri√¢ngulos. </font><font style="vertical-align: inherit;">Existem milh√µes deles. </font></font></i> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O processamento de todos esses c√°lculos e matem√°tica pode parecer um pesadelo log√≠stico, mas os processadores gr√°ficos (GPUs) e as APIs s√£o projetados com tudo isso em mente - imagine uma f√°brica funcionando perfeitamente passando um produto de cada vez pelo pipeline de produ√ß√£o. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Programadores </font><font style="vertical-align: inherit;">experientes em </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">renderiza√ß√£o de jogos em 3D</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> possuem conhecimentos fundamentais em matem√°tica e f√≠sica; </font><font style="vertical-align: inherit;">eles usam todos os truques e ferramentas poss√≠veis para otimizar as opera√ß√µes, comprimindo o est√°gio de processamento de v√©rtices em apenas alguns milissegundos. </font><font style="vertical-align: inherit;">Mas este √© apenas o come√ßo da constru√ß√£o de um quadro 3D - o pr√≥ximo est√°gio √© a rasteriza√ß√£o, o processamento extremamente complexo de pixels e texturas e somente ent√£o a imagem entra no monitor.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472688/">https://habr.com/ru/post/pt472688/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472674/index.html">Vari√°veis ‚Äã‚Äãde ambiente para projetos Python</a></li>
<li><a href="../pt472676/index.html">Criamos o departamento de Jones para ajudar as equipes principais, usando apenas Slack, Jira e a fita azul</a></li>
<li><a href="../pt472682/index.html">Retardando o envelhecimento com sinergias medicamentosas em C. elegans</a></li>
<li><a href="../pt472684/index.html">Surpresa fsync () PostgreSQL</a></li>
<li><a href="../pt472686/index.html">Est√∫dio de V√≠deo Baseado no i486</a></li>
<li><a href="../pt472690/index.html">O que h√° de novo no Zabbix 4.4</a></li>
<li><a href="../pt472694/index.html">Mais do que Ceph: MCS Block Cloud Storage</a></li>
<li><a href="../pt472702/index.html">JH Rainwater ‚ÄúComo pastar gatos‚Äù: ra√ßas de programadores e caracter√≠sticas de sua cria√ß√£o</a></li>
<li><a href="../pt472708/index.html">Imperva revelou detalhes t√©cnicos do Cloud WAF hack</a></li>
<li><a href="../pt472714/index.html">Onde o trabalhador front-end deve procurar trabalho e n√£o cair: Telegrama, Slack e n√£o apenas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>