<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸƒ ğŸš â” å¦‚ä½•ä½¿ç”¨Pythonï¼ŒDjangoå’ŒWebhookä¸ºVKontakteåˆ›å»ºèŠå¤©æœºå™¨äºº ğŸ™…ğŸ¾ â˜ºï¸ â™ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸ºä»€ä¹ˆè¿˜è¦å†å†™ä¸€ç¯‡æœ‰å…³åˆ›å»ºèŠå¤©æœºå™¨äººçš„æ–‡ç« ï¼Ÿ 
 ä¹Ÿè®¸æˆ‘æœç´¢ä¸åŠ›ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°å…³äºä½¿ç”¨Djangoæ¡†æ¶å’Œç”±ä¿„ç½—æ–¯å…¬å¸æ‰˜ç®¡çš„webhookæ–¹æ³•åˆ›å»ºpythonæœºå™¨äººçš„è¯¦ç»†æŒ‡å—ã€‚ å¤§å¤šæ•°ææ–™éƒ½è°ˆè®ºä½¿ç”¨Flaskæ¡†æ¶ä»¥åŠä½¿ç”¨Herokuå’ŒPythonAnywhereçš„å…è´¹æ‰˜ç®¡ã€‚ Habrç¤¾åŒºçš„ç»éªŒå¸®äº†æˆ‘å¤§å¿™...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•ä½¿ç”¨Pythonï¼ŒDjangoå’ŒWebhookä¸ºVKontakteåˆ›å»ºèŠå¤©æœºå™¨äºº</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429628/"><h3> ä¸ºä»€ä¹ˆè¿˜è¦å†å†™ä¸€ç¯‡æœ‰å…³åˆ›å»ºèŠå¤©æœºå™¨äººçš„æ–‡ç« ï¼Ÿ </h3><br> ä¹Ÿè®¸æˆ‘æœç´¢ä¸åŠ›ï¼Œä½†æ˜¯æ‰¾ä¸åˆ°å…³äºä½¿ç”¨Djangoæ¡†æ¶å’Œç”±ä¿„ç½—æ–¯å…¬å¸æ‰˜ç®¡çš„webhookæ–¹æ³•åˆ›å»ºpythonæœºå™¨äººçš„è¯¦ç»†æŒ‡å—ã€‚ å¤§å¤šæ•°ææ–™éƒ½è°ˆè®ºä½¿ç”¨Flaskæ¡†æ¶ä»¥åŠä½¿ç”¨Herokuå’ŒPythonAnywhereçš„å…è´¹æ‰˜ç®¡ã€‚  Habrç¤¾åŒºçš„ç»éªŒå¸®äº†æˆ‘å¤§å¿™ï¼Œæ‰€ä»¥æˆ‘å†³å®šæŠ½å‡ºå®è´µçš„æ—¶é—´å†™è¿™ç¯‡æ–‡ç« ã€‚ æˆ‘å°†æè¿°è·å¾—çš„å®è·µç»éªŒï¼Œä»¥ä½¿å¯¹æ­¤æ„Ÿå…´è¶£çš„æ¯ä¸ªäººéƒ½å¯ä»¥èŠ‚çœæ—¶é—´ï¼Œå¹¶æ›´å¥½åœ°äº†è§£å¦‚ä½•åœ¨ä½¿ç”¨webhookæ–¹æ³•çš„ä¸»æœºä¸Šä½¿ç”¨Djangoæ¡†æ¶åœ¨Pythonä¸­åˆ¶ä½œæœºå™¨äººã€‚ <br><a name="habracut"></a><br><h3> ä¸ºä»€ä¹ˆè¦ä»˜è´¹æ‰˜ç®¡ï¼Ÿ </h3><br> æˆ‘è®¤ä¸ºï¼Œå¯è¡Œçš„botç‰ˆæœ¬æ˜¯å®ƒç‹¬ç«‹äºæ‚¨çš„æœ¬åœ°è®¡ç®—æœºå¹¶ä¸”24/7å¯ç”¨ã€‚ ä¸ºæ­¤ï¼Œæ‚¨éœ€è¦ä¸€ä¸ªä¸»æœºï¼Œä¸Šé¢æœ‰ä¸€ä¸ªä¸»æœºï¼šWebæœåŠ¡å™¨ï¼Œæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆç”¨äºå¼€å‘Botçš„åŠŸèƒ½ï¼‰ï¼ŒåŸŸåæ³¨å†Œï¼Œä¸ºæ­¤è·å–SSLè¯ä¹¦ä»¥åŠå¯¹æ‰€æœ‰ä¸Šè¿°ç»æµæƒ…å†µçš„æŠ€æœ¯æ”¯æŒã€‚ è¿™ç§æœåŠ¡è¦èŠ±é’±ã€‚ æˆ‘æ¯æœˆä¸ºæ‰˜ç®¡138å¢å¸ƒæ”¯ä»˜æ‰˜ç®¡è´¹ç”¨ï¼Œä»¥ç»´æŠ¤è¯¥æœºå™¨äººçš„å·¥ä½œåŸºç¡€ï¼šæ”¯æŒPython + Djangoï¼Œ25 GBçš„MySQL DBMSï¼Œæ”¯æŒSSHã€‚ <br> åœ¨å¤§å¤šæ•°è¯¾ç¨‹ä¸­ï¼Œæˆ‘çœ‹åˆ°ä¸ªäººè®¡ç®—æœºè¢«ç”¨ä½œæœåŠ¡å™¨æˆ–å…è´¹ä¸»æœºï¼Œä½†å·¥ä½œæ—¶é—´å—åˆ°é™åˆ¶ç­‰ã€‚åœ¨ç¤ºä¾‹ä¸­ï¼Œè¯¥æœºå™¨äººä¼šå®šæœŸè½®è¯¢MessengeræœåŠ¡å™¨ï¼Œä»¥æŸ¥æ‰¾æ¥è‡ªç”¨æˆ·çš„æ–°æ¶ˆæ¯ã€‚ è¿™æ˜¯MessengeræœåŠ¡å™¨ä¸Šçš„é¢å¤–è´Ÿè½½ï¼Œå› æ­¤å¯ä»¥åœ¨ä¸€æ®µæ—¶é—´å†…â€œç¦æ­¢â€è¯¥æ¼«æ¸¸å™¨ã€‚ æˆ‘è®¤ä¸ºï¼Œæ‰€æœ‰è¿™äº›å¯¹äºç”Ÿäº§æ€§ä½¿ç”¨éƒ½ä¸æ˜¯è‡³å…³é‡è¦çš„ã€‚ ä½†æ˜¯å¯¹äºæµ‹è¯•å’ŒåŸ¹è®­æ˜¯å®Œå…¨å¯èƒ½çš„ã€‚ <br><br><h3> ä»€ä¹ˆæ˜¯ç½‘ç»œæŒ‚é’©ï¼Œä¸ºä»€ä¹ˆï¼Ÿ </h3><br> å¯¹äºäº§å“ï¼Œæˆ‘è®¤ä¸ºæ­£ç¡®çš„å†³å®šæ˜¯ä½¿ç”¨Webhookï¼Œå³æˆ‘ä»¬çš„æœºå™¨äººåœ¨è¿™ç§æ–¹æ³•ä¸­ï¼ŒæœŸæœ›æœºå™¨äººä»MessengeræœåŠ¡å™¨è·å–æ¶ˆæ¯ï¼Œè€Œä¸ç”¨å®šæœŸè¯·æ±‚â€œé”¤å‡»â€æ¶ˆæ¯ï¼šæ˜¯å¦æœ‰æ–°æ¶ˆæ¯ã€‚ æœ‰äº†ä¸€ä¸ªWebhookï¼Œå°†æ˜¯è¿™æ ·çš„ï¼šç”¨æˆ·ç¼–å†™äº†ä¸€æ¡æ¶ˆæ¯ï¼ŒMessengeræœåŠ¡å™¨å°†å…¶å‘é€åˆ°æ‚¨çš„æœºå™¨äººï¼Œä»–æ”¶åˆ°äº†è¯¥æ¶ˆæ¯ï¼Œå¯¹å…¶è¿›è¡Œäº†å¤„ç†å¹¶è¿›è¡Œäº†å›ç­”ã€‚ <br><br><h3> ä¸ºä»€ä¹ˆæ˜¯Django </h3><br> æˆ‘å†³å®šç”¨pythonåšä¸€ä¸ªæœºå™¨äººï¼Œæ‰€ä»¥æˆ‘åœ¨ä¸»æœºä¸Šè¿æ¥äº†pythonæ”¯æŒã€‚ ä½†æ˜¯æˆ‘æ²¡æœ‰ä¸€ä¸ªé€‰æ‹©çš„æ¡†æ¶-æ‰˜ç®¡åªæœ‰Djangoã€‚ ä»–ä»¬è¯´å®ƒé€‚ç”¨äºInstagramï¼ŒPinterestï¼ŒBitbucketå’ŒMozillaã€‚ ä¹Ÿè®¸è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ‰˜ç®¡æä¾›å®ƒçš„åŸå› ã€‚ <br><br><h3> ä¸ºä»€ä¹ˆé€‰æ‹©VKontakteï¼Œè€Œä¸æ˜¯Telegramæˆ–Viberï¼Ÿ </h3><br> ä»ç®€å•åˆ°å¤æ‚ï¼Œå¯¹æˆ‘æ¥è¯´ï¼Œæ‰¾åˆ°ä¸€ç§æœ€ç®€å•ï¼Œæœ€ç›´è§‚çš„æ–¹å¼æ¥å»ºç«‹ä¸€ä¸ªWebhookè‡³å…³é‡è¦ã€‚ äº‹å®è¯æ˜ï¼Œå¯¹äºæˆ‘æ¥è¯´ï¼ŒVKontakteæ˜¯æœ€å¯ç†è§£çš„ï¼Œå› ä¸ºåœ¨â€œç®¡ç†-ä½¿ç”¨APIâ€‹â€‹â€éƒ¨åˆ†çš„ç¤¾åŒºæ§åˆ¶é¢æ¿ä¸­ï¼Œè¿æ¥Webhookçš„æ˜ç¡®å¸®åŠ©å’Œä¾¿æ·æ€§ã€‚ æˆ‘å°†å¦‚ä½•è¿›ä¸€æ­¥é…ç½®å’Œè¿æ¥æ‰€æœ‰å†…å®¹çš„æè¿°ã€‚ å°†æ¥ï¼Œæˆ‘æƒ³è®©æˆ‘çš„æœºå™¨äººåœ¨Viberä¸­å¯ç”¨ã€‚ è€Œä¸”Telegramä¸åœ¨è·¯ä¸Šï¼Œå› ä¸ºæˆ‘çš„æ‰˜ç®¡åœ°ç‚¹åœ¨ä¿„ç½—æ–¯ï¼Œè€ŒTelegramè¢«ä¿„ç½—æ–¯å°é”äº†ã€‚ ä¸ºé¿å…Telegramå‡ºç°é—®é¢˜ï¼Œæ‚¨å¯ä»¥åœ¨å›½å¤–è´­ä¹°æ‰˜ç®¡æœåŠ¡ã€‚ <br><br><h3> å¦‚ä½•ä¸ºVK botå®‰è£…webhookï¼Ÿ </h3><br>  <strong>åŸŸåhttpsï¼š//</strong> ã€‚ é¦–å…ˆï¼Œæ‚¨éœ€è¦æ³¨å†Œè¯¥ç«™ç‚¹çš„åŸŸåå¹¶ä¸ºå…¶è·å–sslè¯ä¹¦ã€‚ <br><br> æˆ‘ä¸æƒ³ä½¿ç”¨èŠå¤©æœºå™¨äººçš„æ ¹åŸŸï¼Œå› æ­¤åœ¨æ³¨å†Œè¯¥åŸŸä¹‹åï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªå­åŸŸå¹¶æ”¶åˆ°äº†sslè¯ä¹¦ã€‚ <br><br> æˆ‘ç”¨æˆ‘çš„ä¸ªäººå¸æˆ·åœ¨æ‰˜ç®¡ç«™ç‚¹ä¸Šè¿›è¡Œäº†æ‰€æœ‰è¿™äº›æ“ä½œã€‚ <br> ç»“æœï¼Œæˆ‘æ”¶åˆ°äº†ç½‘ç«™mybot.mysite.ruçš„åœ°å€åŠå…¶sslè¯ä¹¦ã€‚ <br><br>  <strong>æˆ‘ä»¬è·å¾—äº†æœºå™¨äººçš„VKå¯†é’¥ï¼ˆä»¤ç‰Œï¼‰ã€‚</strong> é¦–å…ˆï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªå°é—­çš„ç»„ï¼Œç„¶ååœ¨â€œä½¿ç”¨APIâ€‹â€‹â€éƒ¨åˆ†ä¸­è¿›å…¥è¯¥ç»„çš„â€œç®¡ç†â€ã€‚ åœ¨â€œè®¿é—®å¯†é’¥â€é€‰é¡¹å¡ä¸­æ˜¯ä»¤ç‰Œï¼Œåœ¨â€œå›è°ƒAPIâ€é€‰é¡¹å¡ä¸­æ˜¯Webhookè®¾ç½®ã€‚ <br><br><img src="https://habrastorage.org/webt/in/46/po/in46po1vy4iq3vcdnezwpp5okg8.png"><br><br>  <strong>å®‰è£…å’Œé…ç½®Django</strong> ã€‚ ä¹Ÿè®¸æ‚¨ä¸éœ€è¦Djangoæ¥è¿è¡Œpythonè„šæœ¬ï¼Œä½†æ˜¯æˆ‘ä¸çŸ¥é“å¦‚ä½•åšã€‚ <br><br> ä½¿ç”¨PuTTYï¼Œæˆ‘é€šè¿‡SSHè¿æ¥åˆ°æœåŠ¡å™¨ï¼Œé…ç½®å¹¶æ¿€æ´»äº†è™šæ‹Ÿç¯å¢ƒã€‚ <br><br>  SSHï¼š <br><pre><code class="bash hljs">virtualenv-2.7 virtualenv/myEnv . virtualenv/myEnv/bin/activate</code> </pre> <br> ç¬¬ä¸€è¡Œä¸­çš„å‘½ä»¤åˆ›å»ºä¸€ä¸ªè™šæ‹Ÿç¯å¢ƒï¼Œç¬¬äºŒè¡Œä¸­çš„å‘½ä»¤å°†å…¶æ¿€æ´»ï¼ˆæ³¨æ„å¥ç‚¹åçš„ç©ºæ ¼ï¼‰ã€‚  2.7ç‰ˆç”±æ‰˜ç®¡æœåŠ¡å•†å†³å®šï¼Œæ‚¨çš„æƒ…å†µå¯èƒ½æœ‰æ‰€ä¸åŒã€‚ å› æ­¤ï¼Œè¯·é˜…è¯»æ‰˜ç®¡å¸®åŠ©ã€‚ <br><br> æ¥ä¸‹æ¥å®‰è£…Django <br>  SSHï¼š <br><pre> <code class="bash hljs">pip install <span class="hljs-string"><span class="hljs-string">'django&lt;2'</span></span></code> </pre><br> æˆ‘å®‰è£…çš„Djangoç‰ˆæœ¬ä¸æ—©äºç¬¬äºŒä¸ªç‰ˆæœ¬ï¼Œå› ä¸ºåœ¨ä¸»æœºä¸Šä½¿ç”¨äº†python 2.7ï¼Œå¹¶ä¸”åªæœ‰å°äº2çš„Djangoç‰ˆæœ¬å¯ä»¥ä½¿ç”¨ã€‚ <br><br> å¹¶å®‰è£…äº†pythonæ¨¡å—ä»¥ä¸VKontakte APIé…åˆä½¿ç”¨ <br>  SSHï¼š <br><pre> <code class="bash hljs">pip install vk</code> </pre><br><br>  FTPï¼š <br> åœ¨ä¸»æœºçš„æ ¹ç›®å½•ä¸­ä¸ºdjango-projectsåˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶å¤¹ã€‚ ä»–ç§°å¥¹ä¸ºdjangoã€‚ <br><br>  SSHï¼š <br> åˆ›å»ºäº†ä¸€ä¸ªæ–°é¡¹ç›®ã€‚ <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> django/ django-admin.py startproject mybot</code> </pre><br> ç»“æœï¼Œå°†åœ¨/ djangoæ–‡ä»¶å¤¹ä¸­åˆ›å»ºä¸€ä¸ªå¸¦æœ‰é¡¹ç›®åç§°çš„æ–‡ä»¶å¤¹ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ä¸ºâ€œ mybotâ€ï¼‰ã€‚ å®ƒå°†åŒ…å«è‡ªåŠ¨åˆ›å»ºçš„åˆå§‹é¡¹ç›®æ–‡ä»¶ï¼š <br>  / django <br>  / mybot-é¡¹ç›®æ–‡ä»¶å¤¹ <br>  / mybot-å…·æœ‰æˆ‘ä»¬é¡¹ç›®è®¾ç½®çš„æ¨¡å— <br>  __init__.py <br>  settings.py <br>  urls.py <br>  wsgi.py <br>  manage.py <br><br>  Djangoä¸­çš„ä¸€ä¸ªé¡¹ç›®æ˜¯ä¸€ç»„åº”ç”¨ç¨‹åºã€‚  Djangoä¸­çš„åº”ç”¨ç¨‹åºæ˜¯æ‰§è¡Œå¼€å‘äººå‘˜è§„å®šçš„æ“ä½œçš„ç¨‹åºã€‚ <br><br>  SSHï¼š <br> åˆ›å»ºä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚ <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> mybot python manage.py startapp vk_bot</code> </pre><br> æˆ‘è½¬åˆ°<i>/ django / mybotæ–‡ä»¶å¤¹ï¼Œ</i>å¹¶åˆ›å»ºäº†ä¸€ä¸ªåä¸ºâ€œ vk_botâ€çš„æ–°åº”ç”¨ç¨‹åºã€‚ <br> åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­åˆ›å»ºäº†ä¸€ä¸ªåŒ…å«åº”ç”¨ç¨‹åºåç§°çš„æ–‡ä»¶å¤¹ï¼Œå…¶ä¸­åŒ…å«è‡ªåŠ¨åˆ›å»ºçš„åº”ç”¨ç¨‹åºæ–‡ä»¶ï¼š <br><br>  / django <br>  / mybot-é¡¹ç›®æ–‡ä»¶å¤¹ <br>  / mybot-å…·æœ‰æˆ‘ä»¬é¡¹ç›®è®¾ç½®çš„æ¨¡å— <br>  __init__.py <br>  settings.py <br>  urls.py <br>  wsgi.py <br>  manage.py <br>  / vk_bot-åº”ç”¨ç¨‹åºæ–‡ä»¶å¤¹ <br>  __init__.py <br> ç®¡ç†å‘˜ <br>  apps.py <br>  models.py <br>  tests.py <br>  views.py <br><br>  FTPï¼š <br> æˆ‘å°†æ‰€æœ‰é¡¹ç›®æ–‡ä»¶ä¸‹è½½åˆ°ç¬”è®°æœ¬ç”µè„‘ä¸Šä»¥ä½¿ç”¨ä»£ç ã€‚ <br> ä¸ºäº†å¤„ç†é¡¹ç›®æ–‡ä»¶å’Œç¼–ç¨‹ï¼Œæˆ‘ä½¿ç”¨äº†Atomåº”ç”¨ç¨‹åºã€‚ <br><br> åŸå­ï¼š <br> åœ¨æ–‡ä»¶<i>/django/mybot/mybot/settings.pyä¸­</i>ç¼–è¾‘äº†é¡¹ç›®è®¾ç½® <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>DEBUG = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> ... ALLOWED_HOSTS = [ <span class="hljs-string"><span class="hljs-string">u'mybot.mysite.ru'</span></span>, ] ...</code> </pre><br> åŸå­ï¼š <br> åœ¨<i>/django/mybot/mybot/urls.py</i>æ–‡ä»¶ä¸­ç¼–è¾‘çš„URLè·¯ç”±è®¾ç½® <br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">... </span></span>urlpatterns = [ url(<span class="hljs-string"><span class="hljs-string">r'^vk_bot/'</span></span>, include(<span class="hljs-string"><span class="hljs-string">'vk_bot.urls'</span></span>)), ] ...</code> </pre><br>  FTPï¼š <br> åˆ›å»ºäº†ä¸€ä¸ªæ–‡ä»¶<i>/django/mybot/vk_bot/urls.pyï¼Œ</i>å†…å®¹<i>å¦‚ä¸‹</i> ï¼š <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf.urls <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> url <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> . <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> views app_name = <span class="hljs-string"><span class="hljs-string">'vk_bot'</span></span> urlpatterns = [ url(<span class="hljs-string"><span class="hljs-string">r'^$'</span></span>, views.index, name=<span class="hljs-string"><span class="hljs-string">'index'</span></span>), ]</code> </pre><br> åŸå­ï¼š <br> ç¼–è¾‘æ–‡ä»¶<i>/django/mybot/vk_bot/views.py-</i>å‘å…¶ä¸­æ·»åŠ äº†ä¸€ä¸ªåä¸ºindexçš„å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨æµè§ˆå™¨ä¸­è¯·æ±‚åœ°å€æ—¶æ‰§è¡Œ <br><pre>  https://mybot.mysite.ru/vk_bot/ </pre><br><br>  views.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from __future__ import unicode_literals from django.views.decorators.csrf import csrf_exempt from django.shortcuts import render from django.http import HttpResponse from bot_config import * # import token, confirmation_token and over constants from bot_config.py import json, vk # vk is library from VK """ Using VK Callback API version 5.5 For more ditalies visit https://vk.com/dev/callback_api """ """ From Django documentation (https://docs.djangoproject.com/en/1.11/ref/request-response/) When a page is requested, Django automatically creates an HttpRequest object that contains metadata about the request. Then Django loads the appropriate view, passing the HttpRequest as the first argument to the view function. This argiment is &lt;request&gt; in def index(request): Decorator &lt;@csrf_exempt&gt; marks a view as being exempt from the protection ensured by the Django middleware. For cross site request protection will be used secret key from VK """ @csrf_exempt #exempt index() function from built-in Django protection def index(request): #url: https://mybot.mysite.ru/vk_bot/ if (request.method == "POST"): data = json.loads(request.body)# take POST request from auto-generated variable &lt;request.body&gt; in json format if (data['secret'] == secret_key):# if json request contain secret key and it's equal my secret key if (data['type'] == 'confirmation'):# if VK server request confirmation """ For confirmation my server (webhook) it must return confirmation token, whitch issuing in administration web-panel your public group in vk.com. Using &lt;content_type="text/plain"&gt; in HttpResponse function allows you response only plain text, without any format symbols. Parametr &lt;status=200&gt; response to VK server as VK want. """ # confirmation_token from bot_config.py return HttpResponse(confirmation_token, content_type="text/plain", status=200) if (data['type'] == 'message_new'):# if VK server send a message session = vk.Session() api = vk.API(session, v=5.5) user_id = data['object']['user_id'] # token from bot_config.py api.messages.send(access_token = token, user_id = str(user_id), message = "Hello, I'm bot!") return HttpResponse('ok', content_type="text/plain", status=200) else: return HttpResponse('see you :)')</span></span></code> </pre><br> åœ¨<i>views.py</i>è„šæœ¬çš„<i>indexï¼ˆrequestï¼‰</i>å‡½æ•°ä¸­ï¼Œæˆ‘å¿…é¡»ç¦ç”¨Django CSRFå†…ç½®çš„ä¿æŠ¤ï¼Œå› ä¸º æˆ‘æ”¶åˆ°â€œ 403 Forbiddenâ€é”™è¯¯ã€‚  CSRF-è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ä¿æŠ¤-é˜²æ­¢è·¨ç«™ç‚¹è¯·æ±‚ä¼ªé€ ã€‚ æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¬æ–‡ä¸­</a>é˜…è¯»CSRFçš„å·¥ä½œæ–¹å¼ã€‚ <br> è¦ç¦ç”¨ä¿æŠ¤ï¼Œæˆ‘ä½¿ç”¨äº†<i>@csrf_exempt</i>è£…é¥°å™¨ã€‚ ä½†æ˜¯ä¸ºäº†æä¾›ç›¸åŒçš„ä¿æŠ¤ï¼Œä½†ä»¥ä¸€ç§æ›´ç®€å•çš„æ–¹å¼ï¼Œæˆ‘ä½¿ç”¨äº†ä¸€ä¸ªç§˜å¯†å¯†é’¥ï¼Œè¯¥å¯†é’¥å·²åœ¨VKontakteç½‘ç«™ä¸Šçš„ç»„ç®¡ç†éƒ¨åˆ†ä¸­æ³¨å†Œã€‚ <br><br> è¿™æ®µä»£ç è´Ÿè´£å¤„ç†æ¥è‡ªæœåŠ¡å™¨çš„è¯·æ±‚ï¼ŒæœåŠ¡å™¨å°†å‘é€è¯¥è¯·æ±‚ä»¥è¿æ¥æˆ‘ä»¬çš„Webhookè¿›è¡Œäº‹ä»¶å¤„ç†ã€‚ æˆ‘ä»¬åªæ˜¯è¯´ä¸€ä¸‹â€œç¡®è®¤â€ã€‚ <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data[<span class="hljs-string"><span class="hljs-string">'type'</span></span>] == <span class="hljs-string"><span class="hljs-string">'confirmation'</span></span>):<span class="hljs-comment"><span class="hljs-comment"># if VK server request confirmation """ For confirmation my server (webhook) it must return confirmation token, whitch issuing in administration web-panel your public group in vk.com. Using &lt;content_type="text/plain"&gt; in HttpResponse function allows you response only plain text, without any format symbols. Parametr &lt;status=200&gt; response to VK server as VK want. """ # confirmation_token from bot_config.py return HttpResponse(confirmation_token, content_type="text/plain", status=200)</span></span></code> </pre><br> è¯·æ³¨æ„ï¼Œæˆ‘å°†æ‰€æœ‰é…ç½®è®¾ç½®éƒ½ä¿å­˜åœ¨å•ç‹¬çš„boté…ç½®æ–‡ä»¶<i>bot_config.pyä¸­</i> ï¼Œå› æ­¤åœ¨è„šæœ¬å¼€å¤´å°†å…¶è¿æ¥ï¼š <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> bot_config <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-comment"><span class="hljs-comment"># import token, confirmation_token and over constants from bot_config.py</span></span></code> </pre><br>  bot_config.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- """ Configuration file for VK bot """ # token issued on the VK group web-administration page token = '...' # confirmation token issued on the VK group web-administration page in "Callback API" section confirmation_token = '...' # secret key for cross site request forgery protection. It will be in each VK server request secret_key = '...'</span></span></code> </pre><br> åœ¨è¿™æ®µä»£ç ä¸­ï¼Œå®ƒå¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼š <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data[<span class="hljs-string"><span class="hljs-string">'type'</span></span>] == <span class="hljs-string"><span class="hljs-string">'message_new'</span></span>):<span class="hljs-comment"><span class="hljs-comment"># if VK server send a message session = vk.Session() api = vk.API(session, v=5.5) user_id = data['object']['user_id'] # token from bot_config.py api.messages.send(access_token = token, user_id = str(user_id), message = "Hello, I'm bot!") return HttpResponse('ok', content_type="text/plain", status=200)</span></span></code> </pre><br> å¦‚æœæ‚¨ä¼¼ä¹æ— æ³•ç†è§£ï¼Œåˆ™å¯ä»¥é˜…è¯»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ‰å…³ç¬¬ä¸€ä¸ªDjangoè®¾ç½®</a>çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ–‡ç« </a> ã€‚ <br><br>  <strong>WebæœåŠ¡å™¨çš„é­”åŠ›</strong> ã€‚ ä¸ºäº†é…ç½®å¯¹WebæœåŠ¡å™¨çš„è¯·æ±‚çš„å¯»å€ï¼Œæˆ‘é€šè¿‡FTPå®¢æˆ·ç«¯FileZillaè¿›å…¥å…·æœ‰åŸŸçš„æ–‡ä»¶å¤¹ä¸­çš„æœåŠ¡å™¨ï¼Œå¹¶åœ¨å…¶ä¸­åˆ›å»ºäº†æ–‡ä»¶å¤¹â€œ <i>mybot.mysite.ru</i> â€ï¼Œåœ¨å…¶ä¸­æ”¾ç½®äº†ä¸‰ä¸ªæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶çš„å†…å®¹æ¥è‡ªæ‰˜ç®¡æœåŠ¡å•†çš„å¸®åŠ©ï¼š <br><br>  .htaccess <br><pre> <code class="python hljs">AddHandler wsgi-script .wsgi RewriteEngine on RewriteCond %{REQUEST_FILENAME} !-f RewriteRule ^(.*)$ /django.wsgi/$<span class="hljs-number"><span class="hljs-number">1</span></span> [QSA,PT,L] RewriteCond %{HTTP:X-Forwarded-Protocol} !=https RewriteRule .* https://%{SERVER_NAME}%{REQUEST_URI} [R=<span class="hljs-number"><span class="hljs-number">301</span></span>,L]</code> </pre><br>  django.wsgi <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os, sys virtual_env = os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~/virtualenv/myEnv'</span></span>) activate_this = os.path.join(virtual_env, <span class="hljs-string"><span class="hljs-string">'bin/activate_this.py'</span></span>) execfile(activate_this, dict(__file__=activate_this)) sys.path.insert(<span class="hljs-number"><span class="hljs-number">0</span></span>, os.path.join(os.path.expanduser(<span class="hljs-string"><span class="hljs-string">'~'</span></span>), <span class="hljs-string"><span class="hljs-string">'django/mybot'</span></span>)) os.environ[<span class="hljs-string"><span class="hljs-string">'DJANGO_SETTINGS_MODULE'</span></span>] = <span class="hljs-string"><span class="hljs-string">'mybot.settings'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.core.wsgi <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> get_wsgi_application application = get_wsgi_application()</code> </pre><br> è¿™é‡Œçš„â€œ myEnvâ€æ˜¯æ‚¨åˆ›å»ºçš„è™šæ‹Ÿç¯å¢ƒçš„åç§°ï¼Œâ€œ djangoâ€æ˜¯ä¸»æœºä¸Šæ–‡ä»¶ç³»ç»Ÿçš„æ ¹éƒ¨åˆ†ä¸­çš„æ–‡ä»¶å¤¹ï¼Œâ€œ mybotâ€æ˜¯æˆ‘ä»¬ä½¿ç”¨Djangoåˆ›å»ºçš„é¡¹ç›®çš„åç§°ã€‚ <br><br>  index.html <br><pre> <code class="python hljs">  </code> </pre><br>  <strong>å°†æˆ‘ä»¬çš„Webhookâ€œç»‘å®šâ€åˆ°åˆ›å»ºçš„VKontakteç»„ä¸­çš„æ¶ˆæ¯å¤„ç†ã€‚</strong> <br> ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†è¿”å›åˆ°VKontakteç½‘ç«™ä¸Šç”¨äºç®¡ç†ç»„çš„éƒ¨åˆ†ï¼ˆè¯·å‚è§ä¸Šé¢çš„å±å¹•æˆªå›¾ï¼‰ã€‚ æˆ‘ä»¬å°†åœ¨â€œåœ°å€â€å­—æ®µä¸­è¾“å…¥Webhookåœ°å€ <pre>  https://mybot.mysite.ru/vk_bot/ </pre> ç„¶åç‚¹å‡»â€œç¡®è®¤â€æŒ‰é’®ã€‚ å¦‚æœæˆ‘ä»¬åœ¨æ–‡ä»¶<i>/django/mybot/vk_bot/views.pyä¸­</i>ç¼–å†™çš„<i>ç´¢å¼•ï¼ˆè¯·æ±‚ï¼‰</i>åŠŸèƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒä¸åŒ…å«é”™åˆ«å­—å’Œé”™è¯¯ï¼Œåˆ™ä¼šå‡ºç°ä¸€ä¸ªç»¿è‰²çš„é€‰ä¸­æ ‡è®°ï¼Œè¡¨ç¤ºä¸€åˆ‡æ­£å¸¸ã€‚ <br><br> ä¸ºäº†ä½¿æˆ‘ä»¬çš„Webhookæ¥æ”¶æ¥è‡ªVKontakteæœåŠ¡å™¨çš„æœ‰å…³æ–°ç”¨æˆ·æ¶ˆæ¯çš„æ¶ˆæ¯ï¼Œè¯·åœ¨VKontakteç½‘ç«™ä¸Šâ€œç®¡ç†æˆ‘ä»¬çš„ç»„â€éƒ¨åˆ†çš„â€œäº‹ä»¶ç±»å‹â€é€‰é¡¹å¡ä¸­ï¼Œé€‰ä¸­â€œä¼ å…¥æ¶ˆæ¯â€æ¡†ã€‚ <br><br> ç»“æœï¼Œæˆ‘ä»¬çš„è„šæœ¬å°†ä»¥<i>json</i>æ ¼å¼æ¥æ”¶ä»¥ä¸‹æ¶ˆæ¯ï¼š <br><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"message_new"</span></span>,<span class="hljs-string"><span class="hljs-string">"object"</span></span>:{<span class="hljs-string"><span class="hljs-string">"id"</span></span>:<span class="hljs-number"><span class="hljs-number">891</span></span>,<span class="hljs-string"><span class="hljs-string">"date"</span></span>:<span class="hljs-number"><span class="hljs-number">1541599508</span></span>,<span class="hljs-string"><span class="hljs-string">"out"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1.</span></span>.<span class="hljs-number"><span class="hljs-number">.1</span></span>,<span class="hljs-string"><span class="hljs-string">"read_state"</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-string"><span class="hljs-string">"title"</span></span>:<span class="hljs-string"><span class="hljs-string">""</span></span>,<span class="hljs-string"><span class="hljs-string">"body"</span></span>:<span class="hljs-string"><span class="hljs-string">"  "</span></span>},<span class="hljs-string"><span class="hljs-string">"group_id"</span></span>:<span class="hljs-number"><span class="hljs-number">1.</span></span>.<span class="hljs-number"><span class="hljs-number">.4</span></span>,<span class="hljs-string"><span class="hljs-string">"secret"</span></span>:<span class="hljs-string"><span class="hljs-string">"uxSBw"</span></span>}</code> </pre><br> è¯·æ³¨æ„ï¼Œ <i>json</i>æ¶ˆæ¯ä¸­æœ‰ä¸€ä¸ªâ€œç§˜å¯†â€å­—æ®µã€‚ è¿™æ˜¯æˆ‘åœ¨VKontakteç½‘ç«™çš„ç»„ç®¡ç†éƒ¨åˆ†ä¸­æ³¨å†Œçš„åŒä¸€å¯†é’¥ï¼Œè€Œä¸æ˜¯æˆ‘å¿…é¡»ç¦ç”¨çš„Django CSRFä¸­å†…ç½®çš„ä¿æŠ¤ã€‚ <br><br><h3> å¦‚ä½•ä½¿æœºå™¨äººæ›´èªæ˜æ›´å¥½ï¼Ÿ </h3><br> æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªåŒ…å«ç”¨æˆ·ç­”æ¡ˆçš„â€‹â€‹æ•°æ®åº“ï¼Œå¹¶è®©æ¼«æ¸¸å™¨é€‰æ‹©å«ä¹‰æœ€æ¥è¿‘ç”¨æˆ·é—®é¢˜çš„ç­”æ¡ˆã€‚ æˆ‘å°†åœ¨å¦ä¸€ç¯‡æ–‡ç« ä¸­å¯¹æ­¤è¿›è¡Œè®¨è®ºã€‚ <br> å¯ä»¥è¿™ä¹ˆè¯´ï¼Œå¯¹ç”¨æˆ·äº¤äº’æ–¹æ¡ˆè¿›è¡Œç¼–ç¨‹ä»¥ä¿æŒå¯¹è¯æ˜¯å¯èƒ½ä¸”å¿…è¦çš„ã€‚ <br><br> ç¥æ‚¨åˆ›ä½œæ„‰å¿«ï¼ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN429628/">https://habr.com/ru/post/zh-CN429628/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN429618/index.html">ç”µå­æ¸¸æˆXO</a></li>
<li><a href="../zh-CN429620/index.html">å¦‚ä½•ä¸ºæ¸¸æˆåˆ›å»ºå¤§æ´²åœ°å›¾</a></li>
<li><a href="../zh-CN429622/index.html">æœºå™¨äººç”¨20,000åå·¥äººå–ä»£äº†äºšé©¬é€Š</a></li>
<li><a href="../zh-CN429624/index.html">ç¾å›½å®‡èˆªå±€å°†å¦‚ä½•ä½¿ç”¨æœºå™¨äººä»ç«æ˜ŸåœŸå£¤ä¸­åˆ¶é€ ç«ç®­ç‡ƒæ–™</a></li>
<li><a href="../zh-CN429626/index.html">åŸºå› ç»„ç ´è§£è€…è¡¨æ˜ï¼Œä¸å†æœ‰DNAå°†æ˜¯åŒ¿åçš„</a></li>
<li><a href="../zh-CN429630/index.html">â€œæ¸¸æˆä¸­çš„æ€ªç‰©æˆ–ä½¿ææƒ§å¤šæ ·åŒ–â€</a></li>
<li><a href="../zh-CN429632/index.html">æ·»åŠ åˆ°ç›®å½•æ—¶æ‹’ç»æ‰˜ç®¡è€…çš„åŸå› </a></li>
<li><a href="../zh-CN429634/index.html">è¿™å°±æ˜¯åœ¨å-çªƒä¸­å¯»æ‰¾è´·æ¬¾çš„æ–¹å¼</a></li>
<li><a href="../zh-CN429636/index.html">åœ¨Amazon Lightsail Cloudä¸­å®‰è£…3CX PBX</a></li>
<li><a href="../zh-CN429638/index.html">èŠå¤©ï¼Œæå–ï¼šå¤æ‚èŠå¤©æœºå™¨äººçš„ä½“ç³»ç»“æ„</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>