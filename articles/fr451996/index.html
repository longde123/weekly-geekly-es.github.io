<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïï üë®üèΩ‚Äçü§ù‚Äçüë®üèª üé≤ Mon exp√©rience des erreurs üçï üèß üë©üèº‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mon exp√©rience des erreurs 
 Liste d'erreurs 


1. Classe omnipotente MCManager 
2. Inventer notre navigation entre les √©crans 
3. Il n'y a jamais bea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mon exp√©rience des erreurs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451996/"><h3>  Mon exp√©rience des erreurs </h3><br><h4>  Liste d'erreurs </h4><br><ol><li>  Classe omnipotente MCManager </li><li>  Inventer notre navigation entre les √©crans </li><li>  Il n'y a jamais beaucoup d'h√©ritage </li><li>  Architecture de notre propre production ou continuer √† cr√©er des v√©los </li><li>  MVVM avec soul MVP </li><li>  La deuxi√®me tentative avec la navigation ou le routeur et la courbure de la navigation </li><li>  Gestionnaire persistant </li></ol><br>  Beaucoup de gens, y compris moi-m√™me, √©crivent comment faire la bonne chose dans une situation donn√©e, comment √©crire du code correctement, comment appliquer des solutions architecturales, etc. Mais je voudrais partager mon exp√©rience de la fa√ßon dont cela a √©t√© mal fait et les conclusions que j'ai fait sur la base de ses erreurs.  Il s'agit tr√®s probablement d'erreurs courantes de tous ceux qui suivent le chemin du d√©veloppeur, ou peut-√™tre que quelque chose sera nouveau.  Je veux juste partager mon exp√©rience et lire les commentaires des autres gars. <br><a name="habracut"></a><br><h4>  Classe omnipotente MCManager </h4><br>  Apr√®s la premi√®re ann√©e de travail dans l'informatique, et plus particuli√®rement le d√©veloppement iOS, j'ai d√©cid√© que j'√©tais d√©j√† suffisamment architecte et tout √† fait pr√™t √† cr√©er.  M√™me alors, j'ai intuitivement compris qu'il √©tait n√©cessaire de s√©parer la logique m√©tier de la couche de pr√©sentation.  Mais la qualit√© de mon id√©e de la fa√ßon de proc√©der √©tait loin de la r√©alit√©. <br><br>  J'ai d√©m√©nag√© dans un nouveau lieu de travail, o√π j'ai √©t√© affect√© √† d√©velopper de mani√®re ind√©pendante une nouvelle fonctionnalit√© pour un projet existant.  C'√©tait un analogue de l'enregistrement de vid√©os sur Instagram, o√π l'enregistrement est effectu√© pendant que l'utilisateur tient son doigt sur le bouton, puis plusieurs fragments de la vid√©o sont connect√©s ensemble.  Dans un premier temps, il a √©t√© d√©cid√© de faire de cette fonctionnalit√© un projet distinct, ou plut√¥t sous la forme d'un √©chantillon.  Cela, si je comprends bien, commence la source de mes probl√®mes architecturaux, qui ont dur√© plus d'un an. <br><br>  √Ä l'avenir, cet √©chantillon est devenu une application √† part enti√®re pour l'enregistrement et l'√©dition de vid√©os.  C'est dr√¥le qu'initialement l'√©chantillon ait un nom, √† partir de l'abr√©viation dont le pr√©fixe MC a √©t√© collect√©.  Bien que le projet ait √©t√© rapidement renomm√©, mais le pr√©fixe requis par la convention de nom dans Objective-C, MC est rest√©.  La toute puissante classe MCManager √©tait donc n√©e. <br><br><img src="https://habrastorage.org/webt/sz/jw/m_/szjwm_hbfvtxjbovprczya2jyca.jpeg"><br><br>  Comme il s'agissait d'un exemple et que la fonctionnalit√© √©tait simple au d√©part, j'ai d√©cid√© qu'une seule classe de gestionnaire serait suffisante.  La fonctionnalit√©, comme je l'ai mentionn√© plus t√¥t, comprenait l'enregistrement d'un fragment vid√©o avec des options de d√©marrage / arr√™t et la combinaison de ces fragments dans une vid√©o enti√®re.  Et √† ce moment pr√©cis, je peux nommer ma premi√®re erreur - le nom de la classe MCManager.  MCManager, Karl!  Que devrait dire un nom de classe aux autres d√©veloppeurs sur son objectif, ses capacit√©s et comment l'utiliser?  Bon, absolument rien!  Et c'est en annexe, dont le nom ne contient m√™me pas les lettres M et, sa m√®re, C. Bien que ce ne soit pas ma principale erreur, car la classe avec le nom partisan a tout fait, tout du mot est absolument tout, ce qui √©tait l'erreur cl√©. <br><br>  L'enregistrement vid√©o est un petit service, la gestion du stockage des fichiers vid√©o dans le syst√®me de fichiers est le deuxi√®me service suppl√©mentaire pour combiner plusieurs vid√©os en une seule.  Le travail de ces trois services ind√©pendants, il a √©t√© d√©cid√© de regrouper en un seul manager.  L'id√©e √©tait noble, en utilisant le mod√®le de fa√ßade, pour cr√©er une interface simple pour la logique m√©tier et masquer tous les d√©tails inutiles sur l'interaction des diff√©rents composants.  Au d√©but, m√™me le nom d'une telle classe de fa√ßade n'a soulev√© aucun soup√ßon, en particulier dans l'√©chantillon. <br>  Mais le client a aim√© la d√©mo et bient√¥t l'√©chantillon s'est transform√© en une application √† part enti√®re.  Vous pouvez justifier qu'il n'y avait pas assez de temps pour le refactoring, que le client ne voulait pas refaire le code de travail, mais franchement, √† ce moment-l√†, je pensais moi-m√™me avoir pos√© une excellente architecture.  En v√©rit√©, l'id√©e de s√©parer la logique m√©tier et la pr√©sentation a √©t√© un succ√®s.  L'architecture √©tait une classe de singleton MCManager, qui √©tait la fa√ßade de quelques dizaines de services et autres gestionnaires.  Oui, c'√©tait aussi un singleton, qui √©tait disponible √† tous les coins de l'application. <br><br>  On peut d√©j√† comprendre l'ampleur de toute la catastrophe.  Une classe avec plusieurs milliers de lignes de code difficiles √† lire et √† maintenir.  Je suis d√©j√† silencieux sur la possibilit√© de mettre en √©vidence des fonctionnalit√©s individuelles afin de les transf√©rer vers une autre application, ce qui est assez courant dans le d√©veloppement mobile. <br>  Les conclusions que je me suis faites apr√®s un certain temps ne sont pas de cr√©er des classes universelles avec des noms obscurs.  J'ai r√©alis√© que la logique doit √™tre bris√©e en morceaux et ne pas cr√©er une interface universelle pour tout.  En fait, c'√©tait un exemple de ce qui se passerait si vous n'adh√©rez pas √† l'un des principes SOLIDES, le principe de s√©paration d'interface. <br><br><h4>  Inventer notre navigation entre les √©crans </h4><br>  La s√©paration de la logique et de l'interface n'est pas le seul probl√®me qui m'inqui√®te pour le projet ci-dessus.  Je ne dirai pas qu'√† ce moment-l√† j'allais s√©parer le code d'√©cran et le code de navigation, mais il s'est av√©r√© que je suis venu avec mon v√©lo pour la navigation. <br><br><img src="https://habrastorage.org/webt/ab/dt/j1/abdtj1sogyy-j7ppjfbk9uhshge.jpeg"><br><br>  L'√©chantillon ne comportait que trois √©crans: un menu avec un tableau de vid√©os enregistr√©es, un √©cran d'enregistrement et un √©cran de post-traitement.  Afin de ne pas faire attention √† ce que la pile de navigation contienne des ViewControllers en double, j'ai d√©cid√© de ne pas utiliser UINavigationController.  J'ai ajout√© le RootViewcontroller, les lecteurs attentifs ont d√©j√† devin√© que c'√©tait le MCRootViewController, qui √©tait d√©fini comme le principal dans les param√®tres du projet.  Dans le m√™me temps, le contr√¥leur racine n'√©tait pas l'un des √©crans d'application, il pr√©sentait simplement l'UIViewController souhait√©.  Comme si cela ne suffisait pas, le contr√¥leur racine √©tait √©galement un d√©l√©gu√© de tous les contr√¥leurs repr√©sent√©s.  Par cons√©quent, √† chaque instant, il n'y avait que deux vc dans la hi√©rarchie et toute la navigation √©tait impl√©ment√©e √† l'aide du mod√®le d√©l√©gu√©. <br><br>  √Ä quoi cela ressemblait: chaque √©cran avait son propre protocole de d√©l√©gu√©, o√π les m√©thodes de navigation √©taient indiqu√©es, et le contr√¥leur racine impl√©mentait ces m√©thodes et changeait les √©crans.  RootViewController a dissip√© le contr√¥leur de courant, en a cr√©√© un nouveau et l'a pr√©sent√©, alors qu'il √©tait possible de transf√©rer des informations d'un √©cran √† un autre.  Heureusement, la logique m√©tier √©tait dans la classe singleton la plus cool, donc aucun des √©crans ne stockait rien et pouvait √™tre d√©truit sans douleur.  Encore une fois, une bonne intention a √©t√© r√©alis√©e, bien que la r√©alisation ait boit√© sur les deux jambes, et ait parfois tr√©buch√©. <br><br>  Comme vous pouvez le deviner, si vous devez revenir de l'√©cran d'enregistrement vid√©o au menu principal, la m√©thode a √©t√© appel√©e: <br><br><pre><code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)cancel;</code> </pre> <br>  ou quelque chose comme √ßa, et le contr√¥leur racine fait d√©j√† tout le sale boulot. <br>  Au final, MCRootViewController est devenu un analogue de MCManager, mais dans la navigation entre les √©crans, comme avec la croissance de l'application et l'ajout de nouvelles fonctionnalit√©s, de nouveaux √©crans ont √©t√© ajout√©s. <br><br>  L'usine de v√©los fonctionnait inexorablement, et j'ai continu√© √† ignorer les articles sur les architectures d'applications mobiles.  Mais je n'ai jamais abandonn√© l'id√©e de s√©parer la navigation des √©crans. <br><br>  L'avantage √©tait que les √©crans √©taient ind√©pendants et pouvaient √™tre r√©utilis√©s, mais ce n'est pas exact.  Mais les inconv√©nients incluent la difficult√© de maintenir de telles classes.  Le probl√®me avec l'absence d'une pile d'√©crans lorsque vous devez revenir en faisant d√©filer les √©crans pr√©c√©demment s√©lectionn√©s.  La logique complexe de transition entre les √©crans, le contr√¥leur racine a affect√© une partie de la logique m√©tier afin d'afficher correctement un nouvel √©cran. <br><br>  En g√©n√©ral, vous ne devez pas impl√©menter toute la navigation dans l'application de cette mani√®re, car mon MCRootViewController a viol√© le principe du principe ouvert-ferm√©.  Il est presque impossible de d√©velopper, et tous les changements doivent √™tre constamment apport√©s √† la classe elle-m√™me. <br>  J'ai commenc√© √† en savoir plus sur la navigation entre les √©crans dans une application mobile, me suis familiaris√© avec des approches telles que routeur et coordinateur.  J'√©crirai sur Router un peu plus tard, car il y a quelque chose √† partager. <br><br><h4>  Il n'y a jamais beaucoup d'h√©ritage </h4><br>  Je veux aussi partager non seulement mes perles, mais aussi les approches et solutions dr√¥les des autres avec lesquelles j'ai d√ª faire face. Au m√™me endroit o√π j'ai cr√©√© mes chefs-d'≈ìuvre, ils m'ont confi√© une t√¢che simple.  La t√¢che consistait √† ajouter un √©cran d'un autre projet √† mon projet.  Comme nous l'avons d√©termin√© avec PM, apr√®s une analyse peu approfondie et un peu de r√©flexion, cela aurait d√ª prendre deux ou trois heures et pas plus, car ce qui ne va pas, il vous suffit d'ajouter une classe d'√©cran pr√™te √† l'emploi √† votre application.  En effet, tout a d√©j√† √©t√© fait pour nous, il faut faire ctrl + c et ctrl + v.  Voici juste une petite nuance, le d√©veloppeur qui a √©crit cette application a vraiment ador√© l'h√©ritage. <br><br><img src="https://habrastorage.org/webt/bv/e7/h8/bve7h8vugtvsjzyw_ml4esh5vbe.jpeg"><br><br>  J'ai rapidement trouv√© le ViewController dont j'avais besoin, j'ai eu la chance qu'il n'y ait pas de s√©paration entre logique et pr√©sentation.  C'√©tait une bonne vieille approche, lorsque le contr√¥leur contenait tout le code n√©cessaire.  Je l'ai copi√© dans mon projet et j'ai commenc√© √† comprendre comment le faire fonctionner.  Et la premi√®re chose que j'ai d√©couverte est que le contr√¥leur dont j'ai besoin h√©rite d'un autre contr√¥leur.  Une chose courante, un √©v√©nement assez attendu.  Comme je n'avais pas beaucoup de temps, je viens de trouver la classe dont j'avais besoin et de la faire glisser vers mon projet.  Eh bien maintenant √ßa devrait marcher, pensais-je, et je n'avais jamais eu autant tort! <br><br>  Non seulement la classe dont j'avais besoin avait de nombreuses variables de classes personnalis√©es qui devaient √©galement √™tre copi√©es dans mon projet, donc chacune d'elles a h√©rit√© de quelque chose.  √Ä leur tour, les classes de base √©taient h√©rit√©es ou contenaient des champs avec des types personnalis√©s qui, comme beaucoup auraient pu le deviner, h√©ritaient de quelque chose, et ce n'√©tait malheureusement pas NSObject, UIViewController ou UIView.  Ainsi, un bon tiers du projet inutile a migr√© vers moi dans le projet. <br><br>  Comme il n'y avait pas beaucoup de temps pr√©vu pour terminer cette t√¢che, je n'ai pas vu d'autre moyen de simplement ajouter les classes n√©cessaires dont xCode avait besoin simplement pour lancer mon projet sans douleur.  En cons√©quence, deux ou trois heures ont tra√Æn√© un peu, car au final j'ai d√ª plonger dans tout le tissu de la hi√©rarchie de l'h√©ritage, comme un vrai sculpteur, coupant l'exc√®s. <br><br>  En cons√©quence, je suis arriv√© √† la conclusion que toutes les bonnes choses devraient √™tre avec mod√©ration, m√™me une chose aussi ¬´merveilleuse¬ª que l'h√©ritage.  Puis j'ai commenc√© √† comprendre les inconv√©nients de l'h√©ritage.  J'ai conclu pour moi-m√™me, si je veux faire des modules r√©utilisables, je devrais les rendre plus ind√©pendants. <br><br><h4>  Architecture de notre propre production ou continuer √† cr√©er des v√©los </h4><br>  En d√©m√©nageant dans un nouveau lieu de travail et en commen√ßant un nouveau projet, j'ai pris en compte toute l'exp√©rience disponible dans la conception d'architecture et j'ai continu√© √† cr√©er.  Naturellement, j'ai continu√© √† ignorer les architectures d√©j√† invent√©es, mais en m√™me temps j'ai toujours adh√©r√© au principe de ¬´diviser pour r√©gner¬ª. <br><br>  Il n'y avait pas longtemps avant l'av√®nement de Swift, j'ai donc explor√© les possibilit√©s d'Objective-c.  J'ai d√©cid√© de faire l'injection de d√©pendances en utilisant les fonctionnalit√©s du langage.  J'ai √©t√© inspir√© par l'outil d'extension lib; je ne me souviens m√™me pas de son nom. <br><br>  L'essentiel est: dans la classe de base BaseViewController, j'ai ajout√© un champ de classe BaseViewModel.  En cons√©quence, pour chaque √©cran, j'ai cr√©√© mon propre contr√¥leur, qui a h√©rit√© des basiques, et j'ai ajout√© un protocole pour que le contr√¥leur interagisse avec le viewModel.  Puis vint la magie.  J'ai red√©fini les propri√©t√©s de viewModel et ajout√© la prise en charge du protocole souhait√©.  √Ä mon tour, j'ai cr√©√© une nouvelle classe ViewModel pour un √©cran particulier qui a impl√©ment√© ce protocole.  Par cons√©quent, dans le BaseViewController de la m√©thode viewDidLoad, j'ai v√©rifi√© le type du protocole du mod√®le, v√©rifi√© la liste de tous les descendants de BaseViewModel, trouv√© la classe dont j'avais besoin et cr√©√© le viewModel du type dont j'avais besoin. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de base de ViewController</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> // MVC model #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseMVCModel.h"</span></span></span><span class="hljs-meta"> @class BaseViewController; @protocol BaseViewControllerDelegate </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NSObject&gt;</span></span></span><span class="hljs-meta"> @required - (void)backFromNextViewController:(BaseViewController *)aNextViewController withOptions:(NSDictionary *)anOptionsDictionary; @end @interface BaseViewController : UIViewController </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;BaseViewControllerDelegate&gt;</span></span></span><span class="hljs-meta"> @property (nonatomic, weak) BaseMVCModel *model; @property (nonatomic, assign) id</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;BaseViewControllerDelegate&gt;</span></span></span><span class="hljs-meta"> prevViewController; - (void)backWithOptions:(NSDictionary *)anOptionsDictionary; + (void)setupUIStyle; @end import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseViewController.h"</span></span></span><span class="hljs-meta"> // Helpers #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RuntimeHelper.h"</span></span></span><span class="hljs-meta"> @interface BaseViewController () @end @implementation BaseViewController + (void)setupUIStyle { } #pragma mark - #pragma mark Life cycle - (void)viewDidLoad { [super viewDidLoad]; self.model = [BaseMVCModel getModel:FindPropertyProtocol(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"model"</span></span></span><span class="hljs-meta">, [self class])]; } #pragma mark - #pragma mark Navigation - (void)backWithOptions:(NSDictionary *)anOptionsDictionary { if (self.prevViewController) { [self.prevViewController performSelector:@selector(backFromNextViewController:withOptions:) withObject:self withObject:anOptionsDictionary]; } } #pragma mark - #pragma mark Seque - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender { if ([segue.destinationViewController isKindOfClass:[BaseViewController class]] { ((BaseViewController *)segue.destinationViewController).prevViewController = self; } } #pragma mark - #pragma mark BaseViewControllerDelegate - (void)backFromNextViewController:(BaseViewController *)aNextViewController withOptions:(NSDictionary *)anOptionsDictionary { [self doesNotRecognizeSelector:_cmd]; } @end</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple de base de ViewModel</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface BaseMVCModel : NSObject @property (nonatomic, assign) id delegate; + (id)getModel:(NSString *)someProtocol; @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseMVCModel.h"</span></span></span><span class="hljs-meta"> // IoC #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IoCContainer.h"</span></span></span><span class="hljs-meta"> @implementation BaseMVCModel + (id)getModel:(NSString *)someProtocol { return [[IoCContainer sharedIoCContainer] getModel:NSProtocolFromString(someProtocol)]; } @end</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Classes d'assistance</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface IoCContainer : NSObject + (instancetype)sharedIoCContainer; - (id)getModel:(Protocol *)someProtocol; @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IoCContainer.h"</span></span></span><span class="hljs-meta"> // Helpers #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RuntimeHelper.h"</span></span></span><span class="hljs-meta"> // Models #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseMVCModel.h"</span></span></span><span class="hljs-meta"> @interface IoCContainer () @property (nonatomic, strong) NSMutableSet *models; @end @implementation IoCContainer #pragma mark - #pragma mark Singleton + (instancetype)sharedIoCContainer { static IoCContainer *_sharedIoCContainer = nil; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ _sharedIoCContainer = [IoCContainer new]; }); return _sharedIoCContainer; } - (id)getModel:(Protocol *)someProtocol { if (!someProtocol) { return [BaseMVCModel new]; } NSArray *modelClasses = ClassGetSubclasses([BaseMVCModel class]); __block Class currentClass = NULL; [modelClasses enumerateObjectsUsingBlock:^(Class class, NSUInteger idx, BOOL *stop) { if ([class conformsToProtocol:someProtocol]) { currentClass = class; } }]; if (currentClass == nil) { return [BaseMVCModel new]; } __block BaseMVCModel *currentModel = nil; [self.models enumerateObjectsUsingBlock:^(id model, BOOL *stop) { if ([model isKindOfClass:currentClass]) { currentModel = model; } }]; if (!currentModel) { currentModel = [currentClass new]; [self.models addObject:currentModel]; } return currentModel; } - (NSMutableSet *)models { if (!_models) { _models = [NSMutableSet set]; } return _models; } @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> NSString * FindPropertyProtocol(NSString *propertyName, Class class); NSArray * ClassGetSubclasses(Class parentClass); #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RuntimeHelper.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;objc/runtime.h&gt;</span></span></span><span class="hljs-meta"> #pragma mark - #pragma mark Functions NSString * FindPropertyProtocol(NSString *aPropertyName, Class class) { unsigned int propertyCount; objc_property_t *properties = class_copyPropertyList(class, &amp;propertyCount); for (unsigned int i = 0; i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; propertyCount; i++) { objc_property_t property = properties[i]; const char *propertyName = property_getName(property); if ([@(propertyName) isEqualToString:aPropertyName]) { const char *attrs = property_getAttributes(property); NSString* propertyAttributes = @(attrs); NSScanner *scanner = [NSScanner scannerWithString: propertyAttributes]; [scanner scanUpToString:@"&lt;" intoString:NULL]; [scanner scanString:@"&lt;" intoString:NULL]; NSString* protocolName = nil; [scanner scanUpToString:@"&gt;</span></span></span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" intoString: &amp;protocolName]; return protocolName; } } return nil; } NSArray * ClassGetSubclasses(Class parentClass) { int numClasses = objc_getClassList(NULL, 0); Class *classes = NULL; classes = (Class *)malloc(sizeof(Class) * numClasses); numClasses = objc_getClassList(classes, numClasses); NSMutableArray *result = [NSMutableArray array]; for (NSInteger i = 0; i &lt; numClasses; i++) { Class superClass = classes[i]; do { superClass = class_getSuperclass(superClass); } while(superClass &amp;&amp; superClass != parentClass); if (superClass == nil) { continue; } [result addObject:classes[i]]; } free(classes); return result; }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Exemple d'√©cran de connexion</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseViewController.h"</span></span></span><span class="hljs-meta"> @protocol LoginProtocol </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NSObject&gt;</span></span></span><span class="hljs-meta"> @required - (void)login:(NSString *)aLoginString password:(NSString *)aPasswordString completionBlock:(DefaultCompletionBlock)aCompletionBlock; @end @interface LoginVC : BaseViewController @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"LoginVC.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UIViewController+Alert.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UIViewController+HUD.h"</span></span></span><span class="hljs-meta"> @interface LoginVC () @property id</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;LoginProtocol&gt;</span></span></span><span class="hljs-meta"> model; @property (weak, nonatomic) IBOutlet UITextField *emailTF; @property (weak, nonatomic) IBOutlet UITextField *passTF; @end @implementation LoginVC @synthesize model = _model; #pragma mark - #pragma mark IBActions - (IBAction)loginAction:(id)sender { [self login]; } #pragma mark - #pragma mark UITextFieldDelegate - (BOOL)textFieldShouldReturn:(UITextField *)textField { if (textField == self.emailTF) { [self.passTF becomeFirstResponder]; } else { [self login]; } return YES; } #pragma mark - #pragma mark Login - (void)login { NSString *email = self.emailTF.text; NSString *pass = self.passTF.text; if (email.length == 0 || pass.length == 0) { [self showAlertOkWithMessage:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Please, input info!"</span></span></span><span class="hljs-meta">]; return; } __weak __typeof(self)weakSelf = self; [self showHUD]; [self.model login:self.emailTF.text password:self.passTF.text completionBlock:^(BOOL isDone, NSError *anError) { [weakSelf hideHUD]; if (isDone) { [weakSelf backWithOptions:nil]; } }]; } @end</span></span></code> </pre> <br></div></div><br>  D'une mani√®re si simple, j'ai fait l'initialisation paresseuse de viewModel et mal connect√© la vue aux mod√®les via des protocoles.  Avec tout cela, √† ce moment-l√†, je ne savais toujours rien de l'architecture MVP, bien que quelque chose de similaire m'ait menac√©. <br>  La navigation entre les √©crans a √©t√© laiss√©e √† la discr√©tion de ¬´viewModel¬ª, car j'ai ajout√© un maillon faible au contr√¥leur. <br><br>  En me souvenant de cette impl√©mentation maintenant, je ne peux pas dire avec certitude que tout √©tait mauvais.  L'id√©e de s√©parer les couches a √©t√© un succ√®s, le moment de cr√©er et d'assigner des mod√®les au contr√¥leur a √©t√© simplifi√©. <br>  Mais pour moi, j'ai d√©cid√© d'en savoir plus sur les approches et architectures pr√™tes √† l'emploi, car lors du d√©veloppement d'une application avec ma propre architecture, j'ai d√ª faire face √† de nombreuses nuances.  Par exemple, r√©utilisation d'√©crans et de mod√®les, h√©ritage, transitions complexes entre √©crans.  √Ä ce moment-l√†, il me semblait que viewModel faisait partie de la logique m√©tier, m√™me si maintenant je comprends qu'il s'agit toujours d'une couche de pr√©sentation.  J'ai acquis une grande exp√©rience au cours de cette exp√©rience. <br><br><h4>  MVVM avec soul MVP </h4><br>  Ayant d√©j√† acquis de l'exp√©rience, j'ai d√©cid√© de choisir une architecture sp√©cifique pour moi et de la suivre, au lieu d'inventer des v√©los.  J'ai commenc√© √† en savoir plus sur les architectures, √† √©tudier en d√©tail ce qui √©tait populaire √† l'√©poque et √† m'installer sur MVVM.  Franchement, je n'ai pas tout de suite compris son essence, mais je l'ai choisi parce que j'aimais son nom. <br><br>  Je n'ai pas imm√©diatement compris l'essence de l'architecture et la relation entre ViewModel et View (ViewController), mais j'ai commenc√© √† faire ce que j'avais compris.  Les yeux ont peur et les mains tapent fr√©n√©tiquement le code. <br><br>  Pour ma d√©fense, j'ajouterai qu'√† cette √©poque, le temps et le temps pour r√©fl√©chir et analyser la cr√©ation que j'avais cr√©√©e √©taient tr√®s serr√©s.  Par cons√©quent, au lieu de classeurs, j'ai cr√©√© des liens directs dans le ViewModel vers la vue correspondante.  Et d√©j√† dans ViewModel lui-m√™me, j'ai fait la configuration de la pr√©sentation. <br><br>  √Ä propos de MVP, j'avais la m√™me id√©e que sur les autres architectures, donc je croyais fermement que c'√©tait MVVM, dans lequel ViewModel s'est av√©r√© √™tre le plus r√©el des pr√©sentateurs. <br><br><div class="spoiler">  <b class="spoiler_title">Un exemple de mon architecture ¬´MVVM¬ª et oui, j'ai aim√© l'id√©e avec RootViewController, qui est responsable du plus haut niveau de navigation dans l'application.</b>  <b class="spoiler_title">√Ä propos du routeur est √©crit ci-dessous.</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit class RootViewController: UIViewController { var viewModel: RootViewModel? override func viewDidLoad() { super.viewDidLoad() let router = (UIApplication.shared.delegate as? AppDelegate)!.router viewModel = RootViewModel(with: self, router: router) viewModel?.setup() } } <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit protocol ViewModelProtocol: class { func setup() func backAction() } class RootViewModel: NSObject, ViewModelProtocol { unowned var router : RootRouter unowned var view: RootViewController init(with view: RootViewController, router: RootRouter) { self.view = view self.router = router } <span class="hljs-comment"><span class="hljs-comment">// MARK: - ViewModelProtocol func setup() { if AccountManager.shared.isLoggedIn() { router.route(to: RootRoutes.launch.rawValue, from: view, parameters: nil) } else { router.route(to: RootRoutes.loginregistartion.rawValue, from: view, parameters: nil) } } func backAction() { } }</span></span></code> </pre> <br></div></div><br>  Cela n'a pas particuli√®rement affect√© la qualit√© du projet, car l'ordre et une approche unique ont √©t√© respect√©s.  Mais l'exp√©rience a √©t√© inestimable.  Apr√®s les v√©los que j'ai cr√©√©s, j'ai finalement commenc√© √† faire selon l'architecture g√©n√©ralement accept√©e.  √Ä moins que les pr√©sentateurs soient appel√©s pr√©sentateurs, ce qui pourrait d√©router un d√©veloppeur tiers. <br><br>  J'ai d√©cid√© qu'√† l'avenir, il valait la peine de faire de petits projets de test, pour approfondir l'essence d'une approche particuli√®re de la conception.  Pour ainsi dire, sentez-vous d'abord dans la pratique, puis entrez dans la bataille.  Telle est la conclusion que je me suis faite. <br><br><h4>  La deuxi√®me tentative avec la navigation ou le routeur et la courbure de la navigation </h4><br>  Sur le m√™me projet, o√π j'ai impl√©ment√© vaillamment et na√Øvement MVVM, j'ai d√©cid√© d'essayer une nouvelle approche dans la navigation entre les √©crans.  Comme je l'ai mentionn√© plus t√¥t, j'ai toujours adh√©r√© √† l'id√©e de s√©parer les √©crans et √† la logique de transition entre eux. <br><br>  En lisant MVVM, je m'int√©ressais √† un mod√®le tel que le routeur.  Apr√®s avoir revu la description, j'ai commenc√© √† impl√©menter la solution dans mon projet. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple de routeur</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit protocol Router: class { func route(to routeID: String, from view: UIViewController, parameters: Any?) func back(from view: UIViewController, parameters: Any?) } extension Router { func back(from view: UIViewController, parameters: Any?) { let navigationController: UINavigationController = checkNavigationController(for: view) navigationController.popViewController(animated: false) } } enum RootRoutes: String { case launch = "Launch" case loginregistartion = "LoginRegistartionRout" case mainmenu = "MainMenu" } class RootRouter: Router { var loginRegistartionRouter: LoginRegistartionRouter? var mainMenuRouter: MainMenuRouter? <span class="hljs-comment"><span class="hljs-comment">// MARK: Router func route(to routeID: String, from view: UIViewController, parameters: Any?) { var rootView = view if view is EPLaunchViewController { rootView = (view.navigationController?.viewControllers.first)! view.navigationController?.popViewController(animated: false) } if routeID == RootRoutes.loginregistartion.rawValue { loginRegistartionRouter = LoginRegistartionRouter(with: self) loginRegistartionRouter?.route(to: LRRouteID.phoneNumber.rawValue, from: rootView, parameters: nil) } else if routeID == RootRoutes.mainmenu.rawValue { if mainMenuRouter == nil { mainMenuRouter = MainMenuRouter(with: self) } mainMenuRouter?.route(to: MMRouteID.start.rawValue, from: rootView, parameters: nil) } else if routeID == RootRoutes.launch.rawValue { let storyboard = UIStoryboard(name: "RootStoryboard", bundle: nil) let launchView = storyboard.instantiateViewController(withIdentifier: "LaunchViewController") as! LaunchViewController let navigationController: UINavigationController = checkNavigationController(for: view) launchView.viewModel = LaunchViewModel(with: launchView, router: self) navigationController.pushViewController(launchView, animated: false) } } }</span></span></code> </pre><br></div></div><br>  Le manque d'exp√©rience dans la mise en ≈ìuvre d'un tel mod√®le s'est fait sentir.  Tout semblait √™tre net et clair, le routeur a cr√©√© une nouvelle classe UIViewController, cr√©√© un ViewModel pour cela et ex√©cut√© la logique pour passer √† cet √©cran.  Mais encore, de nombreuses lacunes se sont fait sentir. <br>  Des difficult√©s ont commenc√© √† survenir lorsqu'il a √©t√© n√©cessaire d'ouvrir une application avec un certain √©cran apr√®s notification push.  En cons√©quence, √† certains endroits, nous avons eu une logique confuse pour choisir le bon √©cran et une difficult√© suppl√©mentaire √† soutenir une telle approche. <br><br>  Je n'ai pas abandonn√© l'id√©e d'impl√©menter Router, mais j'ai continu√© dans cette direction, gagnant de plus en plus d'exp√©rience.  N'abandonnez pas quelque chose apr√®s la premi√®re tentative infructueuse. <br><br><h4>  Gestionnaire persistant </h4><br>  Une autre classe de manager int√©ressante dans ma pratique.  Mais celui-ci est relativement jeune.  Tout de m√™me, le processus de d√©veloppement consiste en essais et erreurs, et comme nous tous, enfin, ou la plupart d'entre nous, sommes constamment dans le processus de d√©veloppement, des erreurs apparaissent toujours. <br><br>  L'essence du probl√®me est la suivante: l'application dispose de services qui doivent constamment se bloquer et en m√™me temps √™tre disponibles dans de nombreux endroits. <br><br>  Exemple: d√©termination de l'√©tat de Bluetooth.  Dans mon application, dans plusieurs services, je dois comprendre si le Bluetooth est activ√© ou d√©sactiv√© et m'abonner aux mises √† jour de statut.  Puisqu'il existe plusieurs emplacements de ce type: quelques √©crans, plusieurs gestionnaires de logique m√©tier suppl√©mentaires, etc., il devient n√©cessaire pour chacun d'entre eux de s'abonner au d√©l√©gu√© CBPeripheralManager (ou CBCentralManager). <br><br>  La solution semble √©vidente, nous cr√©ons une classe distincte qui surveille l'√©tat du bluetooth et avertit tous ceux qui en ont besoin via le mod√®le Observer.  Mais alors la question se pose, qui va stocker en permanence ce service?  La premi√®re chose qui me vient √† l'esprit en ce moment est d'en faire un singleton!  Tout semble aller bien! <br><br>  Mais voici le moment o√π plus d'un de ces services s'est accumul√© dans ma candidature.  Je ne veux pas non plus faire 100500 singletones dans le projet. <br><br>  Et puis une autre lumi√®re s'est allum√©e au-dessus de ma petite t√™te d√©j√† brillante.  Cr√©ez un singleton qui stockera tous ces services et leur donnera acc√®s tout au long de l'application.  Et donc le ¬´manager permanent¬ª est n√©.  Avec le nom, je n'ai pas r√©fl√©chi longtemps et je l'ai appel√©, comme tout le monde pouvait d√©j√† le deviner, PersistentManager. <br><br>  Comme vous pouvez le voir, j'ai √©galement une approche tr√®s originale du nommage des classes.  Je pense que je dois ajouter une mode sur le nom des classes dans mon plan de d√©veloppement. <br><br>  Le probl√®me cl√© de cette impl√©mentation est le singleton, qui est disponible n'importe o√π dans le projet.  Et cela conduit au fait que les managers qui utilisent l'un des services permanents y acc√®dent √† l'int√©rieur de leurs m√©thodes, ce qui n'est pas √©vident.  Pour la premi√®re fois, je suis tomb√© sur cela lorsque je cr√©ais une grande fonctionnalit√© complexe dans un projet de d√©monstration s√©par√© et transf√©rais une partie de la logique m√©tier du projet principal.  Puis j'ai commenc√© √† recevoir des messages contenant des erreurs sur les services manquants. <br><br>  La conclusion que j'ai faite apr√®s cela est que vous devez concevoir vos classes de mani√®re √† ce qu'il n'y ait pas de d√©pendances cach√©es.  Les services n√©cessaires doivent √™tre pass√©s en tant que param√®tres lors de l'initialisation de la classe, mais pas en utilisant un singleton, accessible depuis n'importe o√π.  Et encore plus magnifiquement, cela vaut la peine d'utiliser des protocoles. <br>  Cela s'est av√©r√© √™tre une autre confirmation de l'absence d'un mod√®le singleton. <br><br><h4>  R√©sum√© </h4><br>  Et √ßa, je ne reste pas immobile, mais j'avance, maitrisant de nouvelles approches en programmation.  L'essentiel est de bouger, chercher et exp√©rimenter.  Les erreurs seront toujours, il n'y a pas d'√©chappatoire √† cela.  Mais juste √† cause de la reconnaissance de ses erreurs, on peut se d√©velopper qualitativement. <br><br><img src="https://habrastorage.org/webt/xe/xr/wf/xexrwfhf0_i5cpoxtv3kjrqxsne.gif"><br><br>  Dans la plupart des cas, les probl√®mes sont des super classes qui font beaucoup de choses, ou les mauvaises d√©pendances entre les classes.  Ce qui sugg√®re qu'il est n√©cessaire de d√©composer la logique de mani√®re plus comp√©tente. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr451996/">https://habr.com/ru/post/fr451996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr451974/index.html">Histoire d'AMD: 50 ans de d√©veloppement rapide</a></li>
<li><a href="../fr451976/index.html">Combien co√ªte un Runet ¬´souverain¬ª?</a></li>
<li><a href="../fr451982/index.html">Plus vite vous oubliez la POO, mieux c'est pour vous et vos programmes.</a></li>
<li><a href="../fr451986/index.html">R√©cup√©rer des donn√©es avec ORM est facile! Ou pas?</a></li>
<li><a href="../fr451990/index.html">FAQ sur les transferts et les vols de correspondance: quelle est la diff√©rence qu'un passager peut et ne peut pas faire</a></li>
<li><a href="../fr451998/index.html">Probl√®mes de l'agriculture de pr√©cision et comment vivre avec eux</a></li>
<li><a href="../fr452000/index.html">Comment √† Leroy Merlin vous pouvez acheter des marchandises de l'entrep√¥t d'un fournisseur qui ne fait pas partie de l'assortiment du magasin</a></li>
<li><a href="../fr452004/index.html">Trouv√© l'emplacement de la chute de l'appareil "Bereshit" sur la lune</a></li>
<li><a href="../fr452006/index.html">Epop Metaverse: Pourquoi les auteurs Fortnite devraient l'obtenir</a></li>
<li><a href="../fr452008/index.html">Approches d'ing√©nierie et liste de contr√¥le: comment ne pas devenir fou dans le chaos des t√¢ches</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>