<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§ï üë®üèæ‚Äç‚öïÔ∏è ‚ùï Incorporamos el int√©rprete de Lua en el proyecto para el microcontrolador (stm32) üõåüèº ü§™ üö†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En aplicaciones bastante grandes, una parte importante del proyecto es la l√≥gica empresarial. Es conveniente depurar esta parte del programa en una co...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Incorporamos el int√©rprete de Lua en el proyecto para el microcontrolador (stm32)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459602/"><img src="https://habrastorage.org/webt/p6/9j/kz/p69jkzome873c4rbil8fftedrxs.png"><br><br>  En aplicaciones bastante grandes, una parte importante del proyecto es la l√≥gica empresarial.  Es conveniente depurar esta parte del programa en una computadora, y luego incrustarla en el proyecto para el microcontrolador, esperando que esta parte se ejecute exactamente como se pretend√≠a sin ninguna depuraci√≥n (caso ideal). <br><br>  Dado que la mayor√≠a de los programas para microcontroladores est√°n escritos en C / C ++, para estos prop√≥sitos generalmente usan clases abstractas que proporcionan interfaces a entidades de bajo nivel (si un proyecto se escribe solo usando C, a menudo se usan estructuras de puntero de funci√≥n).  Este enfoque proporciona el nivel requerido de abstracci√≥n sobre el hierro, sin embargo, est√° plagado de la necesidad de una compilaci√≥n constante del proyecto con la programaci√≥n posterior de la memoria no vol√°til del microcontrolador con un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gran</a> archivo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">firmware</a> binario. <br><br>  Sin embargo, existe otra forma: utilizar un lenguaje de secuencias de comandos que le permita depurar la l√≥gica empresarial en tiempo real en el dispositivo o cargar secuencias de trabajo directamente desde la memoria externa, sin incluir este c√≥digo en el firmware del microcontrolador. <br><br>  Eleg√≠ Lua como el lenguaje de script. <a name="habracut"></a><br><br><h2>  ¬øPor qu√© lua? </h2><br>  Hay varios lenguajes de secuencias de comandos que puede incrustar en un proyecto para un microcontrolador.  Unos simples como BASIC, PyMite, Pawn ... Cada uno tiene sus pros y sus contras, una discusi√≥n de los cuales no est√° incluida en la lista de temas discutidos en este art√≠culo. <br><br>  Brevemente sobre lo que es bueno espec√≠ficamente lua - se puede encontrar en el art√≠culo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">"Lua en 60 minutos"</a> .  Este art√≠culo me inspir√≥ mucho y, para un estudio m√°s detallado del tema, le√≠ la gu√≠a oficial del autor del lenguaje Robert Jeruzalimsky " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Programaci√≥n en Lua</a> " (disponible en la traducci√≥n oficial al ruso). <br><br>  Tambi√©n me gustar√≠a mencionar el proyecto eLua.  En mi caso, ya tengo una capa de software de bajo nivel lista para interactuar tanto con los perif√©ricos del microcontrolador como con otros perif√©ricos necesarios ubicados en la placa del dispositivo.  Por lo tanto, no he considerado este proyecto (ya que se reconoce que proporciona las capas para conectar el n√∫cleo Lua con los perif√©ricos del microcontrolador). <br><br><h2>  Sobre el proyecto en el que se integrar√° Lua </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Por tradici√≥n</a> , mi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">proyecto de sandbox</a> se utilizar√° como la calidad del campo para los experimentos (enlace al commit con el lua ya integrado con todas las mejoras necesarias que se describen a continuaci√≥n). <br><br>  El proyecto se basa en el microcontrolador stm32f405rgt6 con 1 MB no vol√°til y 192 KB de RAM (actualmente se utilizan los 2 bloques m√°s antiguos con una capacidad total de 128 KB). <br><br>  El proyecto tiene un sistema operativo en tiempo real FreeRTOS para soportar la infraestructura perif√©rica de hardware.  Toda la memoria para tareas, sem√°foros y otros objetos FreeRTOS se asigna est√°ticamente en la etapa de enlace (ubicada en el √°rea .bss de RAM).  Todas las entidades FreeRTOS (sem√°foros, colas, pilas de tareas, etc.) son partes de objetos globales en las √°reas privadas de sus clases.  Sin embargo, el mont√≥n FreeRTOS todav√≠a est√° asignado para admitir las funciones <i>malloc</i> , <i>free</i> , <i>calloc</i> (necesarias para funciones como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">printf</a> ) que se redefinen para trabajar con √©l.  Existe una API elevada para trabajar con tarjetas MicroSD (FatFS), as√≠ como para depurar UART (115200, 8N1). <br><br><h2>  Sobre la l√≥gica de usar Lua como parte de un proyecto </h2><br>  Con el fin de depurar la l√≥gica empresarial, se supone que los comandos se enviar√°n a trav√©s de UART, empaquetados (como un objeto separado) en l√≠neas terminadas (que terminan con el car√°cter "\ n" + 0-terminador) y enviados a la m√°quina lua.  En caso de ejecuci√≥n fallida, salida mediante printf (ya que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">anteriormente</a> estuvo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">involucrado</a> en el proyecto).  Cuando se depura la l√≥gica, ser√° posible descargar el archivo de l√≥gica de negocios final del archivo de la tarjeta microSD (no incluido en el material de este art√≠culo).  Adem√°s, con el prop√≥sito de depurar Lua, la m√°quina se ejecutar√° dentro de un hilo FreeRTOS separado (en el futuro, se asignar√° un hilo separado para cada script de l√≥gica de negocios depurado en el que se ejecutar√° con su entorno). <br><br><h2>  Inclusi√≥n del subm√≥dulo lua en el proyecto. </h2><br>  El <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">espejo oficial del proyecto en github</a> se usar√° como fuente de la biblioteca lua (ya que mi proyecto tambi√©n se publica all√≠. Puede usar las fuentes directamente desde el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sitio oficial</a> ).  Dado que el proyecto tiene un sistema establecido para ensamblar subm√≥dulos como parte del proyecto, CMakeLists individuales para cada subm√≥dulo, cre√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">subm√≥dulo separado</a> en el que inclu√≠ esta bifurcaci√≥n y CMakeLists para mantener un estilo de ensamblaje √∫nico. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CMakeLists</a> construye las fuentes del repositorio lua como una biblioteca est√°tica con los siguientes indicadores de compilaci√≥n de subm√≥dulos (tomados del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">archivo de configuraci√≥n de subm√≥dulos</a> en el proyecto principal): <br><br><pre><code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(C_COMPILER_FLAGS <span class="hljs-string"><span class="hljs-string">"-std=gnu99;-fshort-enums;-fno-exceptions;-Wno-type-limits;-ffunction-sections;-fdata-sections;"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(MODULE_LUA_COMP_FLAGS <span class="hljs-string"><span class="hljs-string">"-O0;-g3;${C_COMPILER_FLAGS}"</span></span></code> </pre> <br>  Y las banderas de especificaci√≥n del procesador utilizado (establecido en las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Listas CMake ra√≠z</a> ): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(HARDWARE_FLAGS -mthumb; -mcpu=cortex-m4; -mfloat-abi=hard; -mfpu=fpv4-sp-d16;)</code> </pre> <br>  Es importante tener en cuenta la necesidad de que las CMakeLists ra√≠z especifiquen una definici√≥n que permita no usar valores dobles (ya que el microcontrolador no tiene soporte de hardware para dobles. Solo flotante): <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span>(-DLUA_32BITS)</code> </pre> <br>  Bueno, solo queda informar al vinculador sobre la necesidad de ensamblar esta biblioteca e incluir el resultado en el dise√±o del proyecto final: <br><br><div class="spoiler">  <b class="spoiler_title">Parcela CMakeLists para vincular un proyecto con la biblioteca lua</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">add_subdirectory</span></span>(<span class="hljs-variable"><span class="hljs-variable">${CMAKE_SOURCE_DIR}</span></span>/bsp/submodules/module_lua) ... <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf PUBLIC <span class="hljs-comment"><span class="hljs-comment"># -Wl,--start-group       #      . #  Lua    ,      #  . "-Wl,--start-group" ..._... MODULE_LUA ..._... "-Wl,--end-group")</span></span></code> </pre> </div></div><br><h2>  Definici√≥n de funciones para trabajar con memoria. </h2><br>  Como Lua en s√≠ no se ocupa de la memoria, esta responsabilidad se transfiere al usuario.  Sin embargo, cuando se utiliza la biblioteca <i>lauxlib</i> incluida y la funci√≥n <i>luaL_newstate</i> de esta, la funci√≥n <i>l_alloc</i> est√° <i>vinculada</i> como un sistema de memoria.  Se define de la siguiente manera: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l_alloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ud, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> osize, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nsize)</span></span></span><span class="hljs-function"> </span></span>{ (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)ud; (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)osize; <span class="hljs-comment"><span class="hljs-comment">/* not used */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nsize == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">realloc</span></span>(ptr, nsize); }</code> </pre> <br>  Como se mencion√≥ al principio del art√≠culo, el proyecto ya ha anulado <i>las</i> funciones <i>malloc</i> y <i>gratuitas</i> , pero no hay <i>una</i> funci√≥n <i>realloc</i> .  Necesitamos arreglarlo. <br><br>  En el mecanismo est√°ndar para trabajar con el mont√≥n FreeRTOS, el archivo heap_4.c utilizado en el proyecto no tiene una funci√≥n para cambiar el tama√±o de un bloque de memoria previamente asignado.  En este sentido, es necesario realizar su implementaci√≥n en base a <i>malloc</i> y de forma <i>gratuita</i> . <br><br>  Dado que en el futuro es posible cambiar el esquema de asignaci√≥n de memoria (usando otro archivo heap_x.c), se decidi√≥ no usar los interiores del esquema actual (heap_4.c), sino hacer un complemento de nivel superior.  Aunque menos efectivo. <br><br>  Es importante tener en cuenta que el m√©todo <i>realloc</i> no solo elimina el bloque antiguo (si exist√≠a) y crea uno nuevo, sino que tambi√©n mueve los datos del bloque antiguo al nuevo.  Adem√°s, si el bloque antiguo ten√≠a m√°s datos que el nuevo, el nuevo se llena con los antiguos hasta el l√≠mite y los datos restantes se descartan. <br><br>  Si no se tiene en cuenta este hecho, su m√°quina podr√° ejecutar dicho script tres veces desde la l√≠nea " <i>a = 3 \ n</i> ", despu√©s de lo cual caer√° en un fallo grave.  El problema se puede resolver despu√©s de estudiar la imagen residual de los registros en el controlador de fallas duras, desde el cual ser√° posible descubrir que el bloqueo ocurri√≥ despu√©s de intentar expandir la tabla en las entra√±as del c√≥digo del int√©rprete y sus bibliotecas.  Si llama a un script como " <i>print 'test'</i> ", el comportamiento cambiar√° dependiendo de c√≥mo se ensamble el archivo de firmware (en otras palabras, el comportamiento no est√° definido). <br><br>  Para copiar datos del bloque antiguo al nuevo, necesitamos averiguar el tama√±o del bloque antiguo.  FreeRTOS heap_4.c (como otros archivos que proporcionan m√©todos de manejo de almacenamiento din√°mico) no proporciona una API para esto.  Por lo tanto, tienes que terminar el tuyo.  Como base, tom√© la funci√≥n <i>vPortFree</i> y <i>reduje</i> su funcionalidad a la siguiente forma: <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de funci√≥n VPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vPortGetSizeBlock</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *pv)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *puc = (<span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *)pv; BlockLink_t *pxLink; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (pv != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { puc -= xHeapStructSize; pxLink = (BlockLink_t *)puc; configASSERT((pxLink-&gt;xBlockSize &amp; xBlockAllocatedBit) != <span class="hljs-number"><span class="hljs-number">0</span></span>); configASSERT(pxLink-&gt;pxNextFreeBlock == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pxLink-&gt;xBlockSize &amp; ~xBlockAllocatedBit; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> </div></div><br>  Ahora es peque√±o, escriba <i>realloc</i> basado en <i>malloc</i> , <i>gratis</i> y <i>vPortGetSizeBlock</i> : <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de implementaci√≥n de Realloc basado en malloc, gratuito y vPortGetSizeBlock</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">realloc</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *ptr, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> new_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ptr == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); } <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* p = <span class="hljs-built_in"><span class="hljs-built_in">malloc</span></span>(new_size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (p == <span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; } <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> old_size = vPortGetSizeBlock(ptr); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> cpy_len = (new_size &lt; old_size)?new_size:old_size; <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(p, ptr, cpy_len); <span class="hljs-built_in"><span class="hljs-built_in">free</span></span>(ptr); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> p; }</code> </pre> </div></div><br><h2>  Agregue soporte para trabajar con stdout </h2><br>  Como se sabe a partir de la descripci√≥n oficial, el int√©rprete lua en s√≠ no puede trabajar con E / S.  Para estos fines, una de las bibliotecas est√°ndar est√° conectada.  Para la salida, utiliza la secuencia <i>stdout</i> .  La funci√≥n <i>luaopen_io</i> de la biblioteca est√°ndar es responsable de conectarse a la secuencia.  Para admitir el trabajo con <i>stdout</i> (a diferencia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">printf</a> ), deber√° anular la funci√≥n <i>fwrite</i> .  Lo redefin√≠ en funci√≥n de las funciones descritas en el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo anterior</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Funci√≥n Fwrite</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> fwrite(<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *buf, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> size, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> count, FILE *stream) { stream = stream; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> len = size * count; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *s = <span class="hljs-keyword"><span class="hljs-keyword">reinterpret_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>*&gt;(buf); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; len; i++) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_write_char((s[i])) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> len; }</code> </pre> </div></div><br>  Sin su definici√≥n, la funci√≥n de <i>impresi√≥n</i> en lua se ejecutar√° con √©xito, pero no habr√° salida.  Adem√°s, no habr√° errores en la pila Lua de la m√°quina (ya que formalmente la funci√≥n se ejecut√≥ con √©xito). <br><br>  Adem√°s de esta funci√≥n, necesitaremos la funci√≥n <i>fflush</i> (para que funcione el modo interactivo, que se <i>discutir√°</i> m√°s adelante).  Como esta funci√≥n no se puede anular, tendr√° que nombrarla de forma un poco diferente.  La funci√≥n es una versi√≥n reducida de la funci√≥n <i>fwrite</i> y est√° destinada a enviar lo que ahora est√° en el b√∫fer con su posterior limpieza (sin transferencia de carro adicional). <br><br><div class="spoiler">  <b class="spoiler_title">Funci√≥n Mc_fflush</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mc_fflush</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> len = buf_p; buf_p = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uart_1.tx(tx_buf, len, <span class="hljs-number"><span class="hljs-number">100</span></span>) != mc_interfaces::res::ok) { errno = EIO; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br></div></div><br><h2>  Recuperando cadenas de un puerto serial </h2><br>  Para obtener cadenas para una m√°quina lua, decid√≠ escribir una clase simple de uart-terminal, que: <br><br><ul><li>  recibe datos en un puerto serie byte por byte (en interrupci√≥n); </li><li>  agrega el byte recibido a la cola, desde donde lo recibe la secuencia; </li><li>  en una secuencia de bytes, si esto no es un avance de l√≠nea, enviado de vuelta en la forma en que lleg√≥; </li><li>  si ha llegado un avance de l√≠nea (' <i>\ r</i> '), se env√≠an 2 bytes de retorno de carro terminal (" <i>\ n \ r</i> "); </li><li>  despu√©s de enviar la respuesta, se llama al controlador del byte que lleg√≥ (objeto de dise√±o de l√≠nea); </li><li>  controla la presi√≥n de la tecla eliminar caracteres (para evitar eliminar caracteres de servicio de la ventana del terminal); </li></ul><br>  Enlaces a fuentes: <br><br><ul><li>  La interfaz de clase UART est√° <a href="">aqu√≠</a> ; </li><li>  La clase base UART est√° <a href="">aqu√≠</a> y <a href="">aqu√≠</a> ; </li><li>  clase uart_terminal <a href="">aqu√≠</a> y <a href="">aqu√≠</a> ; </li><li>  creando un objeto de clase como parte del proyecto <a href="">aqu√≠</a> . </li></ul><br>  Adem√°s, observo que para que este objeto funcione correctamente, debe asignar una prioridad a la interrupci√≥n de UART en el rango permitido para trabajar con funciones FreeRTOS desde la interrupci√≥n.  De lo contrario, puede obtener interesantes errores dif√≠ciles de depurar.  En el ejemplo actual, las siguientes opciones para las interrupciones se establecen en el archivo <a href="">FreeRTOSConfig.h</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Configuraciones en FreeRTOSConfig.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configPRIO_BITS 4 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> configKERNEL_INTERRUPT_PRIORITY 0XF0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//   FreeRTOS API   //   0x8 - 0xF. #define configMAX_SYSCALL_INTERRUPT_PRIORITY 0x80</span></span></span></span></code> </pre> </div></div><br>  En el proyecto en s√≠, un objeto de la clase <i>nvic</i> establece la prioridad de la interrupci√≥n 0x9, que se incluye en el rango v√°lido (la clase nvic se describe <a href="">aqu√≠</a> y <a href="">aqu√≠</a> ). <br><br><h2>  Formaci√≥n de cuerdas para una m√°quina Lua </h2><br>  Los bytes recibidos del objeto uart_terminal se transfieren a una instancia de una clase simple serial_cli, que proporciona una interfaz m√≠nima para editar la cadena y transferirla directamente al hilo en el que se ejecuta la m√°quina lua (llamando a la funci√≥n de devoluci√≥n de llamada).  Al aceptar el car√°cter '\ r', se llama a una funci√≥n de devoluci√≥n de llamada.  Esta funci√≥n debe copiar una l√≠nea en s√≠ misma y "liberar" el control (ya que la recepci√≥n de nuevos bytes est√° bloqueada durante una llamada. Esto no es un problema con flujos correctamente priorizados y una velocidad UART suficientemente baja). <br><br>  Enlaces a fuentes: <br><br><ul><li>  archivos de descripci√≥n serial_cli <a href="">aqu√≠</a> y <a href="">aqu√≠</a> ; </li><li>  creando un objeto de clase como parte del proyecto <a href="">aqu√≠</a> . </li></ul><br>  Es importante tener en cuenta que esta clase considera que una cadena de m√°s de 255 caracteres no es v√°lida y la descarta.  Esto es intencional, porque el int√©rprete lua le permite ingresar construcciones l√≠nea por l√≠nea, esperando el final del bloque. <br><br><h2>  Pasar una cadena al int√©rprete de Lua y su ejecuci√≥n. </h2><br>  El propio int√©rprete de Lua no sabe c√≥mo aceptar el c√≥digo de bloque l√≠nea por l√≠nea, y luego ejecuta todo el bloque por s√≠ solo.  Sin embargo, si instala Lua en una computadora y ejecuta el int√©rprete en modo interactivo, podemos ver que la ejecuci√≥n es l√≠nea por l√≠nea con la notaci√≥n correspondiente a medida que escribe, que el bloque a√∫n no est√° completo.  Como el modo interactivo es el que se proporciona en el paquete est√°ndar, podemos ver su c√≥digo.  Se encuentra en el archivo <a href="">lua.c.</a>  Estamos interesados ‚Äã‚Äãen la funci√≥n <i>doREPL</i> y todo lo que usa.  Para no tener una bicicleta, para obtener las funciones del modo interactivo en el proyecto, hice un puerto de este c√≥digo en una clase separada, a la que llam√© <i>lua_repl</i> por el nombre de la funci√≥n original, que usa printf para imprimir informaci√≥n en la consola y tiene un m√©todo p√∫blico <i>add_lua_string</i> para agregar una l√≠nea recibida del objeto de clase serial_cli descrito anteriormente. <br><br>  Referencias <br><br><ul><li>  descripci√≥n de clase lua_repl <a href="">aqu√≠</a> ; </li><li>  codifique <a href="">aqu√≠</a> , <a href="">aqu√≠</a> y <a href="">aqu√≠</a> ; </li></ul><br>  La clase se realiza de acuerdo con el patr√≥n Singleton Myers, ya que no es necesario proporcionar varios modos interactivos dentro del mismo dispositivo.  Un objeto de la clase lua_repl recibe datos de un objeto de la clase serial_cli <a href="">aqu√≠</a> . <br><br>  Como el proyecto ya tiene un sistema unificado para inicializar y dar servicio a objetos globales, el puntero al objeto de la clase lua_repl se pasa al objeto de la clase global <a href="">player :: base</a> <a href="">aqu√≠</a> .  En el m√©todo de <i>inicio</i> de un objeto de class <a href="">player :: base</a> (declarado <a href="">aqu√≠</a> . Tambi√©n se llama desde main), el m√©todo <i>init</i> del objeto de clase lua_repl se llama con la prioridad de la tarea FreeRTOS 3 (en el proyecto, puede asignar una prioridad de tarea de 1 a 4. Donde 1 Es la prioridad m√°s baja y 4 es la m√°s alta).  Despu√©s de una inicializaci√≥n exitosa, la clase global inicia el planificador FreeRTOS y el modo interactivo comienza su trabajo. <br><br><h2>  Problemas de portabilidad </h2><br>  A continuaci√≥n se muestra una lista de los problemas que encontr√© durante el puerto Lua de la m√°quina. <br><br><h4>  Se ejecutan 2-3 scripts de una sola l√≠nea de asignaci√≥n variable, luego todo cae en una falla grave </h4><br>  El problema fue con el m√©todo realloc.  Se requiere no solo volver a seleccionar el bloque, sino tambi√©n copiar el contenido del antiguo (como se describi√≥ anteriormente). <br><br><h4>  Al intentar imprimir un valor, el int√©rprete cae en una falla grave </h4><br>  Ya era m√°s dif√≠cil detectar el problema, pero al final logr√© descubrir que snprintf se usaba para imprimir.  Como lua almacena valores en doble (o flotante en nuestro caso), se requiere printf (y sus derivados) con soporte de coma flotante (escrib√≠ sobre las complejidades de printf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ). <br><br><h2>  Requisitos para la memoria no vol√°til (flash) </h2><br>  Aqu√≠ hay algunas medidas que hice para juzgar cu√°nta memoria no vol√°til (flash) debe asignarse para integrar la m√°quina Lua en el proyecto.  La compilaci√≥n se realiz√≥ con gcc-arm-none-eabi-8-2018-q4-major.  Se us√≥ la versi√≥n de Lua 5.4.  A continuaci√≥n, en las mediciones, la frase "sin Lua" significa la no inclusi√≥n del int√©rprete y los m√©todos de interacci√≥n con √©l y sus bibliotecas, as√≠ como un objeto de la clase lua_repl en el proyecto.  Todas las entidades de bajo nivel (incluidas las anulaciones para las funciones <i>printf</i> y <i>fwrite</i> ) permanecen en el proyecto.  El tama√±o de almacenamiento din√°mico de FreeRTOS es 1024 * 25 bytes.  El resto est√° ocupado por entidades globales del proyecto. <br><br>  La tabla de resumen de resultados es la siguiente (todos los tama√±os en bytes): <br><table border="1"><tbody><tr><th>  Opciones de compilaci√≥n </th><th>  Sin lua </th><th>  Solo n√∫cleo </th><th>  Lua con biblioteca base </th><th>  Lua con bibliotecas base, corutina, tabla, cadena </th><th>  luaL_openlibs </th></tr><tr><td>  -O0 -g3 </td><td>  103028 </td><td>  220924 </td><td>  236124 </td><td>  262652 </td><td>  308372 </td></tr><tr><td>  -O1 -g3 </td><td>  74940 </td><td>  144732 </td><td>  156916 </td><td>  174452 </td><td>  213068 </td></tr><tr><td>  -Os -g0 </td><td>  71172 </td><td>  134228 </td><td>  145756 </td><td>  161428 </td><td>  198400 </td></tr></tbody></table><br><h2>  Requisitos de RAM </h2><br>  Dado que el consumo de RAM depende completamente de la tarea, le dar√© una tabla resumen de la memoria consumida inmediatamente despu√©s de encender la m√°quina con un conjunto diferente de bibliotecas (se muestra mediante el <i>comando print (collectgarbage ("count") * 1024</i> ). <br><table border="1"><tbody><tr><td>  Composici√≥n </td><td>  RAM utilizada </td></tr><tr><td>  Lua con biblioteca base </td><td>  4809 </td></tr><tr><td>  Lua con bibliotecas base, corutina, tabla, cadena </td><td>  6407 </td></tr><tr><td>  luaL_openlibs </td><td>  12769 </td></tr></tbody></table><br>  En el caso de utilizar todas las bibliotecas, el tama√±o de la RAM requerida aumenta significativamente en comparaci√≥n con los conjuntos anteriores.  Sin embargo, su uso en una parte considerable de las aplicaciones no es necesario. <br><br>  Adem√°s, tambi√©n se asignan 4 kb a la pila de tareas, en la que se ejecuta la m√°quina Lua. <br><br><h2>  Uso adicional </h2><br>  Para el uso completo de la m√°quina en el proyecto, deber√° describir mejor todas las interfaces requeridas por el c√≥digo de l√≥gica de negocios para el hardware o los objetos de servicio del proyecto.  Sin embargo, este es el tema de un art√≠culo separado. <br><br><h2>  Resumen </h2><br>  Este art√≠culo describe c√≥mo conectar una m√°quina Lua a un proyecto para un microcontrolador, as√≠ como lanzar un int√©rprete interactivo completo que le permite experimentar con la l√≥gica empresarial directamente desde la l√≠nea de comandos del terminal.  Adem√°s, los requisitos para el hardware del microcontrolador se consideraron para diferentes configuraciones de la m√°quina Lua. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/459602/">https://habr.com/ru/post/459602/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../459590/index.html">Programa de afiliados de c√≥digo abierto descentralizado en la cadena de bloques Waves</a></li>
<li><a href="../459592/index.html">Tres consejos de gesti√≥n del tiempo para aquellos que lo han intentado todo.</a></li>
<li><a href="../459594/index.html">Leer entre notas: sistema de transferencia de datos dentro de la m√∫sica</a></li>
<li><a href="../459596/index.html">iOS Digest No. 9 (28 de junio - 11 de julio)</a></li>
<li><a href="../459598/index.html">Preguntas frecuentes de SELinux (FAQ)</a></li>
<li><a href="../459604/index.html">Telegram - bot | Men√∫ completo</a></li>
<li><a href="../459606/index.html">Redes sociales distribuidas</a></li>
<li><a href="../459610/index.html">Estos enrutadores peligrosos: el hackeo a gran escala de equipos de red recientes y m√©todos de protecci√≥n</a></li>
<li><a href="../459612/index.html">C√≥mo Qualcomm estaf√≥ la industria m√≥vil durante casi 20 a√±os seguidos</a></li>
<li><a href="../459614/index.html">Pato robot revuelve arrozales</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>