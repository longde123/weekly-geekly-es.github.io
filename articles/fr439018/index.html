<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•• üí∂ üî∫ Configurer Sphinx Search pour une boutique en ligne üë∂ üë©üèΩ‚ÄçüöÄ üóûÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il n'y a pas autant d'informations sur Sphinx que nous le souhaiterions. Un exc√®s d'article ne fait pas de mal. 
 Les premi√®res √©tapes du d√©veloppemen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Configurer Sphinx Search pour une boutique en ligne</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439018/"><p> Il n'y a pas autant d'informations sur Sphinx que nous le souhaiterions.  Un exc√®s d'article ne fait pas de mal. <br>  Les premi√®res √©tapes du d√©veloppement de Sphinx m'ont aid√© √† r√©aliser les articles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Cr√©ation d'un moteur de recherche d'introduction sur Sphinx + php</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sphinx Exemple de recherche sur un projet r√©el - Magasin de pi√®ces d√©tach√©es Tecdoc</a> je vous conseille de commencer par eux. </p><br><p>  Pendant un certain temps, une recherche via LIKE pour chaque mot de la requ√™te a fonctionn√© sur mon site.  J'en voulais plus, et voici quelques cas qui seront d√©sormais trait√©s correctement: </p><br><ul><li>  Formes de mots.  La sortie pour ¬´vis¬ª et ¬´vis¬ª doit √™tre la m√™me. </li><li>  Recherche par fragment de mot. </li><li>  Recherchez des nombres non entiers.  S√©parateur point et virgule. </li><li>  Lettre y </li><li>  Erreurs courantes.  Par exemple, ¬´Amortisseur¬ª. </li><li>  Synonymes  R√©gulateur et ESC. </li><li>  Langue.  mAh et mAh, B et V, AAA latin et cyrillique. </li><li>  Mot compos√© de lettres et de chiffres.  10x15x4, 6000mAh </li></ul><a name="habracut"></a><br><h2 id="razdel-source-i-dopolnitelnaya-sortirovka">  Section source et tri facultatif </h2><br><p>  Le probl√®me doit d'abord contenir des articles en stock, puis temporairement absents, puis archiv√©s.  Et ces trois groupes devraient √™tre tri√©s par pertinence.  Pour ce faire, vous devez d√©finir les attributs.  Dans mon cas, ce sont les champs de d√©gagement et in_stock de la section source sphinx.conf </p><br><pre><code class="sql hljs">sql_query = \ <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-string"><span class="hljs-string">`art`</span></span>, <span class="hljs-string"><span class="hljs-string">`name`</span></span>, <span class="hljs-string"><span class="hljs-string">`clearance`</span></span>, <span class="hljs-string"><span class="hljs-string">`in_stock`</span></span> \ <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> items_zip <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> show_flag=<span class="hljs-number"><span class="hljs-number">1</span></span> sql_attr_bool = clearance sql_attr_uint = in_stock</code> </pre> <br><p>  Ces champs seront utilis√©s pour g√©n√©rer une sortie en PHP.  Je d√©crirai ci-dessous. </p><br><h2 id="razdel-index-v-sphinxconf">  Section d'index dans sphinx.conf </h2><br><p>  <strong>morphologie = stem_enru</strong> <br>  La morphologie r√©sout mon premier probl√®me.  Une recherche de ¬´roulements¬ª, ¬´roulements¬ª, ¬´roulements¬ª conduira √† un seul r√©sultat. </p><br><p>  Les tiges (stem_enru) sont plus rapides, les lemmes (lemmatize_ru) sont plus pr√©cis.  Je n'ai essay√© que des balbutiements.  Le choix affectera votre dictionnaire de remplacements de formes de mots.  Vous voulez changer - vous devez r√©√©crire. </p><br><p>  <strong>min_word_len = 1</strong> <br>  Index des mots de n'importe quelle longueur. </p><br><p>  <strong>html_strip = 1</strong> <br>  Supprimer les balises html </p><br><p>  <strong>min_infix_len = 1</strong> <br>  La recherche se fera sur un fragment du mot.  Index des fragments jusqu'√† 1 lettre.  √âtant donn√© que j'ai moins de 10 000 √©l√©ments dans la base de donn√©es, je n'√©conomise pas sur l'index. </p><br><p>  <strong>expand_keywords = 1</strong> <br>  M√®ne automatiquement la requ√™te au formulaire "(en cours d'ex√©cution | en <em>cours d'ex√©cution</em> = en cours d'ex√©cution)".  min_infix_len et expand_keywords entra√Æneront RV 2205 pour √©mettre RV2205.  Au fait, un tiret est un s√©parateur √©quivalent √† un espace.  Le RV-2205 donnera donc le m√™me RV2205. </p><br><p>  <strong>charset_table = 0..9, A..Z-&gt; a..z, _, a..z, U + 410..U + 42F-&gt; U + 430..U + 44F, U + 430..U + 44F, U + 401-&gt; U + 0435, U + 451-&gt; U + 0435</strong> <br>  Nous apportons l'alphabet latin et l'alphabet cyrillique en minuscules.   remplacer par e. </p><br><p>  <strong>blend_chars = +, &amp;, U + 2C, U + 2E</strong> <br>  J'ai beaucoup de nombres non entiers.  Ils doivent √™tre enti√®rement index√©s.  U + 2C et U + 2E sont un point et une virgule.  Par exemple, 1,25 sera index√© en tant que ¬´1,25¬ª, ¬´1¬ª et ¬´25¬ª. </p><br><p>  <strong>regexp_filter = (\ d +) \, (\ d +) =&gt; \ 1. \ 2</strong> <br>  Les d√©cimales dans les nombres peuvent √™tre s√©par√©es par des points et des virgules: "1,75", "1,75".  Nous mettons tout au point </p><br><p>  <strong>Synonymes et fautes de frappe</strong> </p><br><p>  Les unit√©s de mesure peuvent √™tre √©crites en russe ou en anglais: mm-mm, mAh-mAh, mW-mW.  Ajoutez au dictionnaire des synonymes, dont le chemin est sp√©cifi√© dans les formes de mots: "mach&gt; mah".  Je choisis la langue de l'index selon mes propres pr√©f√©rences. </p><br><p>  Le signe ~ indique d'appliquer le remplacement apr√®s le gestionnaire de morphologie.  Cela vous permet de ne pas √©crire toutes les formes de mots et au lieu des r√®gles pour 'crust', 'crust', 'crust' d'√©crire "~ cork&gt; body" </p><br><p>  Ma liste est compl√®te: </p><br><pre> <code class="plaintext hljs">~ &gt; esc  &gt; esc  &gt; mah ~ &gt;  ~ &gt;  ~ &gt; buzz ~ &gt; buzz ~ &gt; buzz ~ &gt; buzz ~ &gt; buzz ~ &gt;  ~ &gt;  ~ &gt;  li-po &gt; lipo ~ &gt;  ~ &gt;   &gt;   &gt;  vtx &gt;  ~ &gt;  lollipop &gt; lolipop battery &gt;  ~ &gt;  ~ &gt;  ~ &gt;  mkF &gt;   &gt; BEC  &gt; BEC ~ &gt;  LED &gt;  ~ &gt;  driver &gt;  ~ &gt;  ~ &gt;   &gt; AAA  &gt; AA  &gt; M mm &gt;   &gt; mW  &gt; V  &gt; A deans &gt; t-plug tplug &gt; t-plug</code> </pre> <br><p>  <strong>Coller des lettres aux chiffres</strong> </p><br><p>  Parfois, les chiffres font partie du nom (par exemple LCD5208D), mais le plus souvent une caract√©ristique (100mAh, 10x15x4mm).  S√©parez tous les chiffres des lettres et de l'index. </p><br><p>  Cela r√©soudra plusieurs probl√®mes: </p><br><ul><li>  Quelqu'un cherchera "portant 10x15x4", quelqu'un "portant 15x10x4".  Les nombres index√©s donneront la sortie correcte. </li><li>  Les unit√©s de mesure peuvent ou non √™tre s√©par√©es par un espace du nombre: "1,75 mm", "1,75 mm". </li><li>  Pour les titres, cela est √©galement utile.  La sortie correcte sera dans les trois options d'enregistrement LCD-5208, LCD 5208 et LCD5208 </li></ul><br><p>  Avant d'√©crire une expression r√©guli√®re pour s√©parer les nombres, vous devez unifier les d√©limiteurs.  Il est important de se rappeler que les expressions r√©guli√®res sont ex√©cut√©es toutes et s√©quentiellement. </p><br><p>  Nous supprimons le x, lui et l'√©toile dans des tailles comme 10x4x4 M3x10: </p><br><pre> <code class="plaintext hljs">regexp_filter = (\d+)[x\x{0445}\*] =&gt; \1 x</code> </pre> <br><p>  Laissez tomber la queue: </p><br><pre> <code class="plaintext hljs">regexp_filter = (\d*\.?\d+)(\D+) =&gt; \1 \2</code> </pre> <br><p>  Et les t√™tes: </p><br><pre> <code class="plaintext hljs">regexp_filter = (\D+)(\d*\.?\d+) =&gt; \1 \2</code> </pre> <br><p>  Nous √©liminons les "mm", car ils ne sont souvent pas indiqu√©s dans le nom du produit. <br>  Cr√©ez un fichier stop.txt et √©crivez-le dans des mots vides. <br>  Contenu: </p><br><pre> <code class="plaintext hljs"> mm</code> </pre> <br><h2 id="teper-nemnogo-pro-php">  Maintenant un peu sur PHP </h2><br><p>  Sphinxapi sera d√©pr√©ci√© t√¥t ou tard.  Nous utiliserons Sphinxql.  Pour ce faire, connectez-vous √† la base de donn√©es.  Dans mon cas, Sphinx est connect√© via l'h√©bergement, cela ressemble √† ceci: </p><br><pre> <code class="php hljs">$opt = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( PDO::ATTR_ERRMODE =&gt; PDO::ERRMODE_EXCEPTION, PDO::ATTR_DEFAULT_FETCH_MODE =&gt; PDO::FETCH_ASSOC, PDO::ATTR_EMULATE_PREPARES =&gt; <span class="hljs-keyword"><span class="hljs-keyword">TRUE</span></span>, ); $dsn = <span class="hljs-string"><span class="hljs-string">'mysql:host=127.0.0.1;port=9306;'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pdo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDO($dsn, DB_USER, DB_PASS, $opt);</code> </pre> <br><p>  Et toutes les communications avec Spinxql sont un seul SELECT transmettant le texte de requ√™te filtr√© </p><br><pre> <code class="php hljs">$stmt = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;pdo-&gt;prepare(<span class="hljs-string"><span class="hljs-string">"SELECT `id`, WEIGHT() as `w`, in_stock&gt;0 AS stock FROM `items` WHERE MATCH ('"</span></span>.$search.<span class="hljs-string"><span class="hljs-string">"') ORDER BY clearance ASC, stock DESC, w DESC LIMIT "</span></span>.$limit.<span class="hljs-string"><span class="hljs-string">" OPTION field_weights=(name=10, art=3, cat_names=3, model_names=3)"</span></span>);</code> </pre> <br><p>  SphinxQL ne comprend pas les expressions dans la section de tri ORDER BY, donc WEIGHT () et in_stock&gt; 0 ont d√ª √™tre mis dans des champs.  Soit dit en passant, la limite par d√©faut n'est que de 20. </p><br><p>  Le tri produira d'abord des articles en stock, puis temporairement absents, puis archiv√©s.  Et tous ces trois groupes seront tri√©s par pertinence (poids). </p><br><p>  Gr√¢ce √† field_weights, nous d√©finissons quels champs auront plus de poids. </p><br><p>  En remplissant la demande, nous obtenons un tableau d'identification tri√©.  Mais, malheureusement, la s√©lection des donn√©es via WHERE id IN () violera ce tri.  Vous devez former votre demande pour chaque identifiant. </p><br><p>  Dans la phase de d√©bogage <strong>, la</strong> requ√™te <strong>SHOW META</strong> imm√©diatement apr√®s la requ√™te SELECT aide beaucoup.  Surtout pour v√©rifier les formes de mots du dictionnaire et les filtres d'expressions r√©guli√®res.  Vous pouvez voir la liste des mots cl√©s dans lesquels la requ√™te s'est d√©velopp√©e. </p><br><h2 id="uslozhnyaem-sql_query">  Complication de sql_query </h2><br><p>  Nous vendons des pi√®ces d√©tach√©es.  J'ai d√©cid√© d'ajouter le nom de la cat√©gorie de produit et le nom du mod√®le pour lequel la pi√®ce de rechange est destin√©e √† √™tre ajout√©e √† l'index.  Mais chaque produit peut √™tre li√© √† plusieurs cat√©gories √† la fois et convenir √† plusieurs mod√®les.  Et j'ai d√©couvert la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GROUP_CONCAT qui</a> permet d'obtenir des donn√©es en les regroupant dans une cha√Æne.  Par exemple, le champ categories.name contiendra toutes les cat√©gories de l'√©l√©ment items_zip.id s√©par√©es par des espaces. </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> items_zip.id, <span class="hljs-string"><span class="hljs-string">`art`</span></span>, items_zip.<span class="hljs-string"><span class="hljs-string">`name`</span></span>, <span class="hljs-string"><span class="hljs-string">`clearance`</span></span>, <span class="hljs-string"><span class="hljs-string">`in_stock`</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> categories.name SEPARATOR <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> cat_names, <span class="hljs-keyword"><span class="hljs-keyword">GROUP_CONCAT</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> items.family SEPARATOR <span class="hljs-string"><span class="hljs-string">' '</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> model_names <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> items_zip <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> items_cat <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> items_cat.item_id=items_zip.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> categories <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> categories.id=items_cat.cat_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> zip_comp <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> zip_comp.zip_id=items_zip.id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> items <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> zip_comp.model_id=items.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> items_zip.show_flag=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> items_zip.id</code> </pre> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr439018/">https://habr.com/ru/post/fr439018/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr439002/index.html">Comment arr√™ter d'√©crire des savoirs traditionnels et commencer √† travailler?</a></li>
<li><a href="../fr439006/index.html">Comment l'IA aide √† apprendre la langue des signes</a></li>
<li><a href="../fr439010/index.html">Fonctionnement de la consolidation d'archives dans DeviceLock DLP</a></li>
<li><a href="../fr439012/index.html">Annuaire t√©l√©phonique de l'organisation - version imprim√©e</a></li>
<li><a href="../fr439016/index.html">Tableaux g√©n√©riques statiques</a></li>
<li><a href="../fr439020/index.html">Ticket to Ride Europe - Arithm√©tique, deuxi√®me partie</a></li>
<li><a href="../fr439022/index.html">CNC dans un atelier de bricolage (partie 3)</a></li>
<li><a href="../fr439024/index.html">Slurm 3 R√©sultats</a></li>
<li><a href="../fr439026/index.html">Apprenez les tactiques, techniques et connaissances communes contradictoires (ATT @ CK). Tactiques d'entreprise. Partie 8</a></li>
<li><a href="../fr439028/index.html">Comment am√©liorer la protection du p√©rim√®tre du r√©seau? Recommandations pratiques pour Check Point et pas seulement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>