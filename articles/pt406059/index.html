<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õµÔ∏è ü§∞üèº üï¥üèº DIY KVM IP 3.0 ü¶å üó®Ô∏è üì≤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta √© a terceira varia√ß√£o do tema do IP KVM; dessa vez, o conceito foi completamente revisado. Vamos come√ßar a criar algo novo. Haver√° muitas coisas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>DIY KVM IP 3.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/406059/"> Esta √© a terceira varia√ß√£o do tema do IP KVM; dessa vez, o conceito foi completamente revisado. Vamos come√ßar a criar algo novo.  Haver√° muitas coisas interessantes, n√£o saia da tela.  Outro dispositivo incomum aparecer√°: vamos descartar quase todos os componentes antigos, voltar ao nosso arduino nativo e jogar um pouco de hacker. <br><br>  Para aqueles que acabaram de participar, um resumo dos epis√≥dios anteriores: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Primeiro artigo</a> <br>  Coletado KVM IP no Arduino e Raspberry Pi, ficou caro e com baixa qualidade de v√≠deo. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Segundo artigo</a> <br>  OrangePI e Atmega16u2, aprenderam barato, mas a qualidade da imagem ainda √© nojenta. </li></ul><br>  E, finalmente, neste artigo, todas as desvantagens dos anteriores ser√£o corrigidas.  √änfase particular ser√° dada √† redu√ß√£o m√°xima no custo dos componentes. <br><a name="habracut"></a><br>  <b>Por tradi√ß√£o, consideramos os componentes do dispositivo montado:</b> <br><br>  <b>1.</b> Nosso velho amigo Atmega16u2: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/d38/32f/4a0/d3832f4a098f4cf8abe96103b11496a3.jpg"></div><br>  Este √© o √∫nico componente que ser√° movido dos artigos anteriores. <br><br>  <b>2. O</b> not√≥rio ESP8266, neste caso o ESP8266-12e: <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/d3/d9/59d3d9e494103245224131.jpeg"></div><br>  Voc√™ pode usar outra vers√£o do ESP8266, apenas √© necess√°rio considerar o n√∫mero e o local das portas. <br><br>  <b>3.</b> E, de fato, o her√≥i da ocasi√£o LKV373A <br><br><img src="https://habrastorage.org/webt/59/d3/da/59d3da94466d8417530057.jpeg"><br><br>  Gra√ßas a este dispositivo, tornou-se poss√≠vel transmitir v√≠deo em uma rede local com alta <br>  resolu√ß√£o at√© full-HD. <br><br><h3>  O plano de a√ß√£o √© o seguinte: </h3><br><ol><li>  Ocultar e procurar: procuramos o LKV373A, onde ele se escondeu na rede, em que endere√ßo IP </li><li>  Jogo de hackers: preencha o firmware, redefina as senhas e configure o LKV373A </li><li>  Fazendo novos amigos: ESP8266, Arduino IDE e fotos engra√ßadas </li><li>  O final da celebra√ß√£o.  Conectamos todos os componentes e transmitimos pressionamentos de tecla via telnet </li></ol><br><h3>  LKV373A Background </h3><br>  Ent√£o, vamos come√ßar!  LKV373A ou dispositivo HDMI Extender para capturar imagens diretamente da porta HDMI e transmitir para a rede local, esses dispositivos tamb√©m s√£o chamados de extensores HDMI.  Conforme planejado pelos fabricantes, um conjunto desses dispositivos deve consistir em um transmissor (transmissor) e um receptor (receptor), designa√ß√£o TX e RX, respectivamente.  Eles devem ser usados, provavelmente, para trazer mais lucro ao fabricante, apenas em pares.  Mas havia um homem, sob o apelido Danman, aqui est√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> para seu blog, que estava interessado em como ele funciona.  Ele abriu o Wireshark, farejou o tr√°fego transmitido pelo dispositivo TX, o que acabou por ser? <br><br>  O fluxo de v√≠deo √© transmitido sem criptografia e, usando o VLC Player, voc√™ pode assisti-lo sem muito esfor√ßo.  Mas ele n√£o parou por a√≠, ‚Äúsentiu‚Äù: ele puxou a interface da web, TTL, telnet e at√© puxou o firmware com o programador.  Ele falou sobre isso em detalhes em seu blog.  O firmware que nos interessa em primeiro lugar tamb√©m foi carregado l√°: IPTV_TX_PKG_v4_0_0_0_20160427.PKG.  Neste firmware, a interface da Web com configura√ß√µes avan√ßadas, e n√£o como a padr√£o, possui apenas o bot√£o de atualiza√ß√£o.  Al√©m disso, este firmware possui um telnet com muitos comandos para configurar.  √â com este firmware que reconfiguramos o HDMI Extender para nossas tarefas.  Postei o firmware e tudo o que precisava no github, aqui est√° o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> , precisaremos mais tarde, mas, por enquanto, terminamos com a teoria.  Vamos seguir praticando. <br><br><h2>  Transmissor </h2><br><h3>  Estamos procurando LKV373A na rede </h3><br>  Ca√≠ nas m√£os do mesmo extensor que Danman (y).  Tudo o que ser√° descrito abaixo √© adequado especificamente para o HDMI Extender LKV373A vers√£o V3.0! <br><br>  N√≥s conectamos o LKV373A √† rede local, ligue a energia.  Agora vamos tentar garantir que o dispositivo esteja vis√≠vel na rede <code>ping 192.168.1.238</code> . <br><br>  192.168.1.238 √© o endere√ßo IP padr√£o.  Se o extensor n√£o alterar o endere√ßo antigo do firmware, independentemente de haver ou n√£o um servidor DHCP na rede.  Vers√µes de firmware mais recentes usam IP por padr√£o somente se o dispositivo n√£o puder obter um endere√ßo do DHCP.  Se voc√™ recebeu uma resposta ao ping, continue.  Caso contr√°rio, n√£o se desespere, tente conectar o extensor diretamente √† porta LAN do computador e use o sniffer. <br><br><h3>  Piscando </h3><br>  Extensor HDMI encontrado, v√° para o firmware.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Vamos</a> para o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">github</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">baixamos</a> tudo o que √© apresentado l√°.  Agora abra a interface da web do extensor atrav√©s de um navegador e veja a seguinte imagem: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d91fbcc37298629734.png"><br><br>  Clique em "Procurar ...", selecione o firmware, um arquivo chamado IPTV_TX_PKG_v4_0_0_0_20160427.PKG, e clique em "Atualizar".  Tadam!  O firmware est√° conclu√≠do, agora conecte-se ao LKV373A por telnet para redefinir a senha. <br><br>  O comando para conectar ser√° semelhante ao Telnet 192.168.1.238 9999, em que 9999 √© a porta √† qual se conectar.  O CEP alerta: o endere√ßo obtido do DHCP pode ser encontrado usando um scanner de rede. <br><br><h3>  Conectar via telnet </h3><br>  Ao conectar, a seguinte mensagem deve aparecer: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;</code> </pre><br>  N√≥s escrevemos <code>list</code> .  Em resposta, obtemos uma lista de comandos: <br><br><pre> <code class="bash hljs">============================== ========IPTV TX Server======== ============================== input&gt;list set_group_id get_group_id set_dhcp get_dhcp set_uart_baudrate get_uart_baudrate set_static_ip get_static_ip set_mac_address get_mac_address get_lan_status get_hdcp get_video_lock get_ip_config set_session_key set_device_name get_device_name set_video_bitrate get_video_bitrate set_downscale_mode get_downscale_mode set_video_out_mode get_video_out_mode set_streaming_mode get_streaming_mode get_fw_version get_company_id factory_reset reboot list <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br>  Para redefinir todas as configura√ß√µes e senha, use o comando <code>factory_reset</code> .  Escrevemos um comando, pressione enter e obtenha esta imagem: <br><br><pre> <code class="bash hljs">input&gt;factory_reset Processing factory reset! System will reboot after few seconds! Connection closed by foreign host.</code> </pre><br><h3>  Interface da web </h3><br>  Agora podemos configurar o dispositivo conforme necess√°rio.  Vamos para a interface da web.  Usamos o login padr√£o: senha de administrador: 123456 e aqui est√°, a interface da web "cobi√ßada" com configura√ß√µes adicionais: <br><br><img src="https://habrastorage.org/webt/59/d4/e7/59d4e71a2b694981418223.png"><br><br>  Embora as oportunidades na interface da Web tenham aumentado, elas ainda n√£o s√£o suficientes para nossos prop√≥sitos.  Particularmente faltando configura√ß√µes mais gratuitas em termos de streaming, √© codificado, longe do mais conveniente, uma lista de endere√ßos IP para os quais voc√™ pode transmitir.  √â claro que existe um multicast, mas √© melhor deix√°-lo para a televis√£o.  Limita√ß√µes podem ser contornadas, mais sobre isso mais tarde. <br><br>  Ent√£o, eles encontraram o dispositivo na rede, enrolaram e redefiniram as senhas.  O transmissor est√° quase pronto para passar para o receptor. <br><br><h2>  Receptor </h2><br>  Vamos decidir sobre o dispositivo sob o controle de qual sistema operacional transmitiremos o fluxo.  Eu n√£o acho que voc√™ experimentar√° o tormento da escolha, existem apenas duas op√ß√µes: <br><br><h4>  Windows </h4><br>  Para Windows, tentei v√°rios players, mas os resultados foram mais ou menos.  Ao capturar e depois reproduzir um fluxo de v√≠deo, aparece um atraso, que depende principalmente do reprodutor que estiver reproduzindo o fluxo.  Em v√°rios jogadores, o atraso variou de um segundo a cinco ou mais.  O melhor de tudo, no Windows, o VLC Player provou ser. <br><br>  Vamos ao que interessa.  Inicie o VLC Player, na parte superior do menu suspenso "M√≠dia", selecione "Abrir URL ..." no campo de endere√ßo de rede, escreva <code>udp://@:5004</code> , insira um alerta na caixa de sele√ß√£o "Mostrar configura√ß√µes avan√ßadas" e coloque seu valor no campo "Cache" este par√¢metro √© determinado individualmente.  Quanto menor o valor nesse campo, menor o atraso, mas um valor muito pequeno pode levar a "artefatos" e queda de quadros, tudo depender√° da infraestrutura de rede local.  Os melhores resultados que pude alcan√ßar foram um atraso de cerca de um segundo.  No Linux, os resultados foram muito melhores em torno de 200 a 300 milissegundos. <br><br><h4>  Linux </h4><br>  Como mostra a pr√°tica, os melhores resultados s√£o obtidos usando uma combina√ß√£o de programas socat e mplayer.  O Ubuntu est√° instalado no meu computador, ent√£o o comando para instalar o socat ficar√° assim: <br><br><pre> <code class="bash hljs">sudo apt-get install socat</code> </pre> <br>  O Mplayer √© instalado da mesma forma: <br><br><pre> <code class="bash hljs">sudo apt-get install mplayer</code> </pre> <br>  Bem, e siga o conselho de Danman: <br><br><pre> <code class="bash hljs">sudo iptables -t raw -A PREROUTING -p udp -m length --length 28 -j DROP</code> </pre> <br>  Este comando √© necess√°rio para remover os chamados "Pacotes UDP de comprimento zero" do fluxo - pacotes de tamanho zero que "obstruem" o fluxo. <br><br><h2>  Go live! </h2><br>  O receptor est√° pronto, voc√™ pode iniciar a transmiss√£o!  Digitamos no console do computador receptor <code>ifconfig</code> ou <code>ipconfig</code> , dependendo do sistema operacional, lembramos o endere√ßo IP do receptor e retornamos √† interface da web do transmissor.  Abriremos a interface da Web. Se j√° a tivermos fechado, digite o nome de usu√°rio, a senha e escreva diretamente na barra de endere√ßos do navegador: <br><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">///dev/info.cgi?action=streaminfo&amp;udp=n&amp;rtp=y&amp;multicast=n&amp;unicast=y&amp;mcastaddr=&amp;port=5004</span></span></code> </pre> <br>  Substitua seus endere√ßos IP e pressione enter.  Esta linha ir√° configurar o HDMI Extender para transmitir o v√≠deo capturado para o ip escolhido e desligar o multicast. <br><br>  Iniciamos o VLC no Windows.  Ou no terminal Linux, escrevemos: <br><br><pre> <code class="bash hljs">socat UDP-RECV:5004 - | mplayer ‚Äì</code> </pre> <br>  Abra Cadabra!  E aqui est√° a nossa, ou n√£o a nossa, √°rea de trabalho ao vivo. <br><br><img src="https://habrastorage.org/webt/59/d3/f3/59d3f3c6a0c3b976110026.png"><br><br>  Portanto, com alguns m√©todos hackers, for√ßamos o dispositivo a fazer o que precis√°vamos. <br><br>  Com a transfer√™ncia do v√≠deo resolvida, v√° para o controle remoto. <br><br><h2>  Transfer√™ncia de controle </h2><br><h3>  Sele√ß√£o de componentes </h3><br>  Porque  o custo do HDMI Extender √© baixo, cerca de 1800 rublos, e tamb√©m por causa dos coment√°rios que, dizem eles, um pouco caros, propus o slogan: "D√™ IP KVM por 2000 rublos!".  A taxa de c√¢mbio do rublo afetar√° grandemente a fidelidade desta declara√ß√£o, mas n√£o vamos falar de coisas tristes, quero acreditar em um futuro brilhante.  Para atingir a meta, precisaremos de elementos muito baratos, minha escolha recaiu sobre o ESP8266 como controlador e, ao mesmo tempo, o mesmo Atmega (16/8/32) u2 como atuador. <br><br>  Obviamente, voc√™ pode considerar outros candidatos para a fun√ß√£o de um dispositivo executivo (teclado).  O firmware que emula o teclado √© gravado na biblioteca LUFA (mais ou menos).  Essa biblioteca pode ser usada para toda a fam√≠lia AVR com conectividade USB.  Daqui resulta que, como um emulador de teclado, voc√™ pode adquirir um microcontrolador, possivelmente mais barato.  Esta √© uma informa√ß√£o a ser considerada, mas agora continuamos. <br><br>  Voc√™ pode comprar o ESP8266 por cerca de 90 rublos, o Atmega (16/8/32) u2 por cerca de 100 rublos e ainda mais barato se voc√™ receber pequenos lotes de 5 ou mais pe√ßas.  Obviamente, ser√£o necess√°rios consum√≠veis para amarrar os microcontroladores, mas seu custo √© extremamente pequeno, portanto n√£o os considerarei. <br><br><h2>  ESP8266 </h2><br>  Esse milagre da ind√∫stria chinesa n√£o precisa de introdu√ß√£o; portanto, apenas direi que neste projeto usei a vers√£o do ESP8266-12e.  Claro, voc√™ pode usar outras vers√µes, apenas voc√™ precisa considerar a localiza√ß√£o das portas, porque  nesta vers√£o, uma das portas do ESP8266 √© usada para ligar o Atmega (16/8/32) u2, isso ser√° indicado no diagrama abaixo. <br><br><h3>  Firmware </h3><br>  O firmware do ESP8266 est√° escrito no ambiente ArduinoIDE, ent√£o baixe a vers√£o mais recente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">do site do desenvolvedor</a> .  Em seguida, voc√™ precisa adicionar suporte ao ESP8266 - a maneira mais f√°cil pode ser encontrada neste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">link</a> .  Na mesma p√°gina, voc√™ pode encontrar muitas informa√ß√µes √∫teis, como a conex√£o de energia e TTL.  Para quem n√£o est√° atualizado, o ESP8266 usa <b>estritamente 3,3 volts!</b>  Se voc√™ n√£o est√° confiante em suas pr√≥prias habilidades, √© melhor usar uma op√ß√£o de placa adaptada para USB, como o NodeMCU: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d92043a87951368720.jpeg"><br><br>  Se tudo estiver pronto, abra o ArduinoIDE e copie meu esbo√ßo: <br><br><div class="spoiler">  <b class="spoiler_title">Esbo√ßo</b> <div class="spoiler_text"><pre> <code class="hljs lua">#include &lt;ESP8266WiFi.h&gt; #include &lt;WiFiClient.h&gt; #include &lt;ESP8266WebServer.h&gt; #include &lt;ESP8266mDNS.h&gt; #include &lt;SoftwareSerial.h&gt; #include &lt;HIDKeyboard.h&gt; #define MAX_SRV_CLIENTS <span class="hljs-number"><span class="hljs-number">3</span></span> HIDKeyboard keyboard; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* host = <span class="hljs-string"><span class="hljs-string">"esp8266"</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* ssid = <span class="hljs-string"><span class="hljs-string">""</span></span>; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* pass = <span class="hljs-string"><span class="hljs-string">""</span></span>; int rebootdev = <span class="hljs-number"><span class="hljs-number">0</span></span>; int modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>; // ,    ESP8266    #define Port1 <span class="hljs-number"><span class="hljs-number">15</span></span> #define Port2 <span class="hljs-number"><span class="hljs-number">14</span></span> #define Port3 <span class="hljs-number"><span class="hljs-number">12</span></span> #define Port4 <span class="hljs-number"><span class="hljs-number">4</span></span> #define Port5 <span class="hljs-number"><span class="hljs-number">5</span></span> //  String ColorB1; String ColorB2; String ColorB3; String ColorB4; String ColorB5; ESP8266WebServer server(<span class="hljs-number"><span class="hljs-number">80</span></span>); WiFiClient serverClients[MAX_SRV_CLIENTS]; const <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* serverIndex = <span class="hljs-string"><span class="hljs-string">"&lt;form method='POST' action='/update' enctype='multipart/form-data'&gt;&lt;input type='file' name='update'&gt;&lt;input type='submit' value='Update'&gt;&lt;/form&gt;&lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>;//Update //    void handleRedirect(){ String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;head&gt;&lt;meta http-equiv='refresh' content='0;/'&gt;&lt;head&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } //  WI-FI void handleLogin(){ String msg = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasArg(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) &amp;&amp; server.hasArg(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>)){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>) != NULL) &amp;&amp; (server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>) != NULL)){ String header = <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 301 OK\r\r\nLocation: /\r\nCache-Control: no-cache\r\n\r\n"</span></span>; server.sendContent(header); String web_ssid = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID"</span></span>); String web_pass = server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(<span class="hljs-string"><span class="hljs-string">"PASSAP"</span></span>); ssid = web_ssid.c_str();//       C pass = web_pass.c_str(); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"SSID "</span></span>); Serial.println(ssid); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Pass "</span></span>); Serial.println(pass); WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); ESP.reset(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } msg = <span class="hljs-string"><span class="hljs-string">"Wrong ssid/password! try again."</span></span>; Serial.println(<span class="hljs-string"><span class="hljs-string">"Login Failed"</span></span>); } String content = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;body&gt;&lt;form action='/' method='POST'&gt;Enter the access point name and password &lt;br&gt;"</span></span>;//  SSID   content += <span class="hljs-string"><span class="hljs-string">"Name AP:&lt;input type='text' name='SSID' placeholder='SSID'&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Password:&lt;input type='password' name='PASSAP' placeholder='password'&gt;&lt;br&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"&lt;input type='submit' name='SUBMIT' value='Connect to WI-FI'&gt;&lt;/form&gt;&lt;b&gt;&lt;font color='red'&gt;"</span></span> + msg + <span class="hljs-string"><span class="hljs-string">"&lt;/font&gt;&lt;/b&gt;&lt;br&gt;"</span></span>; content += <span class="hljs-string"><span class="hljs-string">"Firmware update &lt;a href='/upload'&gt;UPDATE&lt;/a&gt;&lt;/body&gt;&lt;/html&gt;"</span></span>; server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, content); } void handleNotFound(){ String message = <span class="hljs-string"><span class="hljs-string">"File Not Found\n\n"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"URI: "</span></span>; message += server.uri(); message += <span class="hljs-string"><span class="hljs-string">"\nMethod: "</span></span>; message += (server.method() == HTTP_GET)?<span class="hljs-string"><span class="hljs-string">"GET"</span></span>:<span class="hljs-string"><span class="hljs-string">"POST"</span></span>; message += <span class="hljs-string"><span class="hljs-string">"\nArguments: "</span></span>; message += server.args(); message += <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (uint8_t i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;server.args(); i++){ message += <span class="hljs-string"><span class="hljs-string">" "</span></span> + server.argName(i) + <span class="hljs-string"><span class="hljs-string">": "</span></span> + server.<span class="hljs-built_in"><span class="hljs-built_in">arg</span></span>(i) + <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; } server.send(<span class="hljs-number"><span class="hljs-number">404</span></span>, <span class="hljs-string"><span class="hljs-string">"text/plain"</span></span>, message); } //  int controlPin(int UsePin){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (UsePin &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ int StPort; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (digitalRead(UsePin) == <span class="hljs-number"><span class="hljs-number">1</span></span>) {//      digitalWrite(UsePin, LOW); StPort = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(UsePin, HIGH); StPort = <span class="hljs-number"><span class="hljs-number">1</span></span>; } digitalWrite(LED_BUILTIN, HIGH);//    Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Port "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(UsePin); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"="</span></span>); Serial.println(StPort); delay(<span class="hljs-number"><span class="hljs-number">500</span></span>); digitalWrite(LED_BUILTIN, LOW); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(StPort); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } //  int clientConnect(int Seconds){ Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"connection "</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (int i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt;= Seconds; i++){ WiFi.begin(ssid, pass); digitalWrite(LED_BUILTIN, LOW); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); digitalWrite(LED_BUILTIN, HIGH); delay(<span class="hljs-number"><span class="hljs-number">250</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"."</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>); Serial.println(); } void setup(void){ Serial.begin(<span class="hljs-number"><span class="hljs-number">115200</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); pinMode(LED_BUILTIN, OUTPUT); digitalWrite(LED_BUILTIN, HIGH); //uint8_t i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">0</span></span>) WiFi.mode(WIFI_STA);//  modeswitch = <span class="hljs-number"><span class="hljs-number">0</span></span>     Serial.println(); Serial.println(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>) != <span class="hljs-number"><span class="hljs-number">0</span></span>) modeswitch = <span class="hljs-number"><span class="hljs-number">1</span></span>;//            <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ Serial.println(<span class="hljs-string"><span class="hljs-string">""</span></span>); Serial.println(<span class="hljs-string"><span class="hljs-string">"WiFi switch AP mode"</span></span>); //WiFi.mode(WIFI_AP_STA);    +  .     WiFi.mode(WIFI_AP); WiFi.softAP(<span class="hljs-string"><span class="hljs-string">"TD"</span></span>, <span class="hljs-string"><span class="hljs-string">"testtest"</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"AP mode ip adress "</span></span>); Serial.println(WiFi.softAPIP()); digitalWrite(LED_BUILTIN, LOW); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); Serial.println(); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client mod ip address: "</span></span>); Serial.println(WiFi.localIP()); digitalWrite(LED_BUILTIN, LOW); } MDNS.begin(host); pinMode(Port1, OUTPUT); pinMode(Port2, OUTPUT); pinMode(Port3, OUTPUT); pinMode(Port4, OUTPUT); pinMode(Port5, OUTPUT); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>){ //     server.on(<span class="hljs-string"><span class="hljs-string">"/"</span></span>, handleLogin);//  (SSID)   //  server.on(<span class="hljs-string"><span class="hljs-string">"/upload"</span></span>, HTTP_GET, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, serverIndex); }); server.on(<span class="hljs-string"><span class="hljs-string">"/update"</span></span>, HTTP_POST, [](){ server.sendHeader(<span class="hljs-string"><span class="hljs-string">"Connection"</span></span>, <span class="hljs-string"><span class="hljs-string">"close"</span></span>); int uperror = Update.hasError(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"UPERR %u\nRebooting...\n"</span></span>,Update.hasError()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (uperror == <span class="hljs-number"><span class="hljs-number">0</span></span>) server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Firmware update successfully &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"Update error &lt;a href='/'&gt;BACK&lt;/a&gt;"</span></span>); ESP.restart(); },[](){ HTTPUpload&amp; upload = server.upload(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_START){ Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); WiFiUDP::stopAll(); Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update: %s\n"</span></span>, upload.filename.c_str()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (upload.filename == NULL) { Serial.printf(<span class="hljs-string"><span class="hljs-string">"ERROR: zero file size"</span></span>); server.send(<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-string"><span class="hljs-string">"&lt;html&gt; zero file size &lt;a href='/upload'&gt;BACK&lt;/a&gt;&lt;/html&gt;"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>); } uint32_t maxSketchSpace = (ESP.getFreeSketchSpace() - <span class="hljs-number"><span class="hljs-number">0x1000</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xFFFFF000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Update.begin(maxSketchSpace)){//start with <span class="hljs-built_in"><span class="hljs-built_in">max</span></span> available size Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_WRITE){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(upload.buf, upload.currentSize) != upload.currentSize){ Update.printError(Serial); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(upload.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span> == UPLOAD_FILE_END){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Update.<span class="hljs-keyword"><span class="hljs-keyword">end</span></span>(<span class="hljs-literal"><span class="hljs-literal">true</span></span>)){ //<span class="hljs-literal"><span class="hljs-literal">true</span></span> to set the size to the current progress Serial.printf(<span class="hljs-string"><span class="hljs-string">"Update Success: %u\nRebooting...\n"</span></span>, upload.totalSize); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Update.printError(Serial); } Serial.setDebugOutput(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">yield</span></span>(); }); //  server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt1"</span></span>, [] { controlPin(Port1); handleRedirect();//    }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt2"</span></span>, [] { controlPin(Port2); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt3"</span></span>, [] { controlPin(Port3); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt4"</span></span>, [] { controlPin(Port4); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/PoRt5"</span></span>, [] { controlPin(Port5); handleRedirect(); }); server.on(<span class="hljs-string"><span class="hljs-string">"/reboot"</span></span>, [] { rebootdev = <span class="hljs-number"><span class="hljs-number">1</span></span>;//      handleRedirect(); }); server.onNotFound(handleNotFound);//    //server.begin(); MDNS.addService(<span class="hljs-string"><span class="hljs-string">"http"</span></span>, <span class="hljs-string"><span class="hljs-string">"tcp"</span></span>, <span class="hljs-number"><span class="hljs-number">80</span></span>); Serial.println(); Serial.println(<span class="hljs-string"><span class="hljs-string">"HTTP server started"</span></span>); } server.begin(); } void loop(void){ uint8_t i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch == <span class="hljs-number"><span class="hljs-number">1</span></span>) server.handleClient(); delay(<span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (modeswitch != <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() != WL_CONNECTED) clientConnect(<span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { digitalWrite(<span class="hljs-number"><span class="hljs-number">5</span></span>, HIGH);//  ATMEGA16U2 digitalWrite(LED_BUILTIN, LOW); } } WiFiServer server(<span class="hljs-number"><span class="hljs-number">23</span></span>); server.setNoDelay(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); server.begin(); keyboard.begin(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(WiFi.<span class="hljs-built_in"><span class="hljs-built_in">status</span></span>() == WL_CONNECTED) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (server.hasClient()){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ //<span class="hljs-built_in"><span class="hljs-built_in">find</span></span> free/disconnected spot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!serverClients[i] || !serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i]) serverClients[i].stop(); serverClients[i] = server.available(); Serial.println(<span class="hljs-string"><span class="hljs-string">"New client: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(i); continue; } } //no free/disconnected spot so reject WiFiClient serverClient = server.available(); serverClient.stop(); } //check clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(serverClients[i].available()){ //get data from the telnet client <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> push it to the UART String bufkey; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(serverClients[i].available()) bufkey += (serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>());//     <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bufkey != <span class="hljs-number"><span class="hljs-number">0</span></span>) { bufkey = bufkey.substring(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>);//  int key = bufkey.toInt();//   switch (key){ case <span class="hljs-number"><span class="hljs-number">277980</span></span>: keyboard.pressSpecialKey(F1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277981</span></span>: keyboard.pressSpecialKey(F2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277982</span></span>: keyboard.pressSpecialKey(F3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">277983</span></span>: keyboard.pressSpecialKey(F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914953</span></span>: keyboard.pressSpecialKey(F5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914955</span></span>: keyboard.pressSpecialKey(F6); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914956</span></span>: keyboard.pressSpecialKey(F7); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914957</span></span>: keyboard.pressSpecialKey(F8); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915048</span></span>: keyboard.pressSpecialKey(F9); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915049</span></span>: keyboard.pressSpecialKey(F10); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915051</span></span>: keyboard.pressSpecialKey(F11); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915052</span></span>: keyboard.pressSpecialKey(F12); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">1310</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">130</span></span>: keyboard.pressSpecialKey(ENTER); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27</span></span>: keyboard.pressSpecialKey(ESCAPE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">8</span></span>: keyboard.pressSpecialKey(BACKSPACE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">9</span></span>: keyboard.pressSpecialKey(TAB); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">32</span></span>: keyboard.pressSpecialKey(SPACEBAR); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915012</span></span>: keyboard.pressSpecialKey(INSERT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27914912</span></span>: keyboard.pressSpecialKey(HOME); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915312</span></span>: keyboard.pressSpecialKey(PAGEUP); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915212</span></span>: keyboard.pressSpecialKey(END); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915412</span></span>: keyboard.pressSpecialKey(PAGEDOWN); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279167</span></span>: keyboard.pressSpecialKey(RIGHTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279168</span></span>: keyboard.pressSpecialKey(LEFTARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279166</span></span>: keyboard.pressSpecialKey(DOWNARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">279165</span></span>: keyboard.pressSpecialKey(UPARROW); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">127</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">27915112</span></span>: keyboard.pressSpecialKey(DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; case <span class="hljs-number"><span class="hljs-number">4</span></span>: keyboard.pressSpecialKey((LCTRL | ALT), DELETE); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //CTRL+ALT+DELETE  Ctrl + d case <span class="hljs-number"><span class="hljs-number">6</span></span>: keyboard.pressSpecialKey(ALT, F4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; //alt+f4  Ctrl + f case <span class="hljs-number"><span class="hljs-number">19</span></span>: keyboard.pressSpecialKey(ALT | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+s case <span class="hljs-number"><span class="hljs-number">2</span></span>: keyboard.pressSpecialKey(LCTRL | SHIFT); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//   Ctrl+b //    case <span class="hljs-number"><span class="hljs-number">17</span></span>: controlPin(Port1); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+q case <span class="hljs-number"><span class="hljs-number">23</span></span>: controlPin(Port2); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+w case <span class="hljs-number"><span class="hljs-number">5</span></span>: controlPin(Port3); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+e case <span class="hljs-number"><span class="hljs-number">18</span></span>: controlPin(Port4); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+r case <span class="hljs-number"><span class="hljs-number">20</span></span>: controlPin(Port5); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//Ctrl+t default: keyboard.pressKey(key); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;//  } keyboard.releaseKey();//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" string: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(key);//  Serial.<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">" KEY: "</span></span>); Serial.<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(bufkey.toInt()); bufkey = <span class="hljs-string"><span class="hljs-string">'0'</span></span>;//    } } } } //check UART <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Serial.available()){ size_t <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> = Serial.available(); uint8_t sbuf[<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>]; Serial.readBytes(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); //push UART data to all connected telnet clients <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; MAX_SRV_CLIENTS; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serverClients[i] &amp;&amp; serverClients[i].connected()){ serverClients[i].<span class="hljs-built_in"><span class="hljs-built_in">write</span></span>(sbuf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); delay(<span class="hljs-number"><span class="hljs-number">1</span></span>); } } } } }</code> </pre><br></div></div><br>  Conecte a biblioteca desejada: <br><br>  Selecione a guia "Esbo√ßo" ‚Üí "Conectar biblioteca" ‚Üí "Adicionar biblioteca .ZIP". Selecione a biblioteca chamada "UNO-HIDKeyboard-Library-master (mod) .zip", que foi baixada do github.  N√≥s compilamos e preenchemos o firmware.  Para baixar o firmware, conecte o ESP8266 TTL, defina a porta desejada no ArduinoIDE.  As configura√ß√µes devem ser algo como isto: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920b385c613386705.png"><br><br>  Para baixar o firmware, √© necess√°rio um curto-circuito na porta GPIO0 para o aterramento e reiniciar o microcontrolador fazendo um curto-circuito na porta Reset tamb√©m.  N√£o vou pintar em detalhes, para n√£o inflar o artigo, o Google o ajudar√°. <br><br>  A l√≥gica do ESP8266 √© a seguinte: Quando a energia √© aplicada, o microcontrolador tenta se conectar a um ponto de acesso Wi-Fi por cerca de trinta segundos: <br><br>  <b>Se a conex√£o for bem</b> - <b>sucedida</b> : abre a porta 23, √† qual voc√™ pode se conectar usando telnet e transmitir pressionamentos de tecla.  Al√©m das teclas, voc√™ pode transferir combina√ß√µes criadas com a tecla "Ctrl + key" que pressionar√° certas combina√ß√µes.  Por exemplo, se voc√™ passar "Ctrl + d", a combina√ß√£o CTRL + ALT + DELETE ser√° pressionada no computador gerenciado. <br><br>  Tamb√©m existem combina√ß√µes para controlar as portas do ESP8266, por exemplo, voc√™ pode conectar um rel√© e usar a combina√ß√£o "Ctrl + q" para ativar e desativar o rel√©, assim, ligar e desligar remotamente o computador gerenciado.  Voc√™ pode ver essas e outras combina√ß√µes na fonte. <br><br>  <b>Se falhar</b> : o ESP8266 alterna para o modo de ponto de acesso com o nome ‚ÄúTD‚Äù, Senha ‚Äútesttest‚Äù e abre uma pequena interface da Web, acess√≠vel em 192.168.4.1, na qual √© poss√≠vel definir as configura√ß√µes para conex√£o via WI-FI. <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920802fd033414007.png"><br><br>  Assim, o dispositivo pode ser facilmente conectado a outro ponto de acesso.  Sim, uma mosca na pomada est√° oculta aqui. Para a opera√ß√£o do nosso IP KVM, voc√™ precisar√° de um cabo LAN e Wi-Fi.  Esse ser√° o custo do pre√ßo baixo do dispositivo. <br><br>  Lidamos com o ESP8266, com o Atmega16u2 tudo como nos artigos anteriores, exibimos o programa Flip, o firmware est√° no arquivo baixado do github. <br><br><h2>  Conex√£o de componentes </h2><br>  Para a conex√£o correta dos componentes, conecto o circuito.  Basta ter em mente que este √© um esquema condicional, que serve para esclarecer e n√£o afirma ser o ideal.  Todo mundo √© livre para "fornec√™-la" como ele gosta. <br><br><img src="https://habrastorage.org/webt/59/d6/52/59d6521903f44207012758.jpeg"><br><br>  Deixe-me explicar alguns pontos: O transistor no circuito √© necess√°rio para ligar o Atmega16u2 ap√≥s carregar o ESP8266, porque quando o ESP8266 √© ativado, as informa√ß√µes de depura√ß√£o s√£o transmitidas para todas as portas TX e, se o Atmega16u2 estiver ligado e conectado ao computador, um fluxo de dados com o volume transmitido o motorista n√£o aguenta.  N√£o se sabe ao certo o que acontece neste momento, o buffer do driver provavelmente est√° transbordando, o efeito √© extremamente desagrad√°vel: centenas de teclas s√£o pressionadas, se um editor de texto √© aberto, ele libera um monte de bobagens e todas as teclas de servi√ßo ficam presas e, como resultado, trabalhar com o teclado torna-se imposs√≠vel .  Para evitar isso, o Atmega16u2 precisa ser ligado ap√≥s o carregamento do ESP8266.  No firmware, esse momento √© levado em considera√ß√£o. <br><br>  Obviamente, existe uma alternativa ao esquema, mas essa √© uma op√ß√£o para os ricos ou pregui√ßosos.  E, a prop√≥sito, esta op√ß√£o n√£o cancela o acima: <br><br><img src="https://habrastorage.org/webt/59/d3/d9/59d3d920e7d2e067456748.jpeg"><br><br>  Na foto, o Arduino UNO sem o chip Atmega328p est√° conectado ao equivalente chin√™s do NodeMCU.  A linha de 3,3 volts √© conectada √† linha do mesmo n√≠vel de tens√£o no Arduino, assim como o terra e o pino GPIO2 (ESP8266) s√£o conectados ao pino TX no Arduino. <br><br><h2>  Verifica√ß√£o final </h2><br>  N√≥s nos conectamos por telnet √† porta 23 e verificamos o desempenho.  Voc√™ pode fazer isso: No Windows com o comando <code>telnet [ip- ESP8266]</code> . <br><br>  No Linux, ser√° um pouco mais complicado: <br><br>  O comando <code>telnet [ip- ESP8266]</code> ent√£o voc√™ precisa pressionar o caractere de controle, o padr√£o √© "Ctrl +]", o telnet deve entrar no modo de comando e, em seguida, pressione "l" e "Enter".  Com essas a√ß√µes, mudaremos o telnet para o modo de s√≠mbolo. <br><br><pre> <code class="bash hljs">$ telnet 192.168.***.*** Trying 192.168.***.***... Connected to 192.168.***.***. Escape character is <span class="hljs-string"><span class="hljs-string">'^]'</span></span>. ^] telnet&gt; l</code> </pre><br>  Tudo est√° pronto, podemos verificar o funcionamento do dispositivo que criamos.  Deixe-me lembr√°-lo das combina√ß√µes poss√≠veis para pressionar "Alt + Tab", "Ctrl + Alt + Del" e etc.  pode ver no esbo√ßo.  Isso √© tudo, a terceira encarna√ß√£o IP KVM DIY est√° pronta. <br><br><h2>  Resumir </h2><br><h3>  Pr√≥s: </h3><br><ul><li>  Provavelmente a vantagem mais importante √© o pre√ßo, acabou por caber em 2000 rublos </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> N√£o deve haver reclama√ß√µes sobre a qualidade do v√≠deo. Voc√™ pode transmitir para Full HD sem problemas </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A capacidade de expandir a funcionalidade adicionando at√© quatro rel√©s ou outros atuadores. </font></font></li></ul><br><h3>  Contras: </h3><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Precisa se conectar via Wi-Fi e cabo Lan </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Quando usado com VGA, √© necess√°rio um adaptador, o que afetar√° naturalmente o custo </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Em geral, o dispositivo ficou digno de aten√ß√£o, √© claro, n√£o √© um concorrente para KVMs IP seriais com todos os seus "presentes", mas ganha muito em pre√ßo. </font><font style="vertical-align: inherit;">E para uso dom√©stico, e talvez n√£o apenas, √© bastante adequado. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Gostaria de aproveitar esta oportunidade para agradecer ao usu√°rio </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DaylightIsBurning</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Esse homem gentil sugeriu a dire√ß√£o certa para escavar.</font></font><br><br>  Obrigado pela aten√ß√£o.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> At√© breve! </font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt406059/">https://habr.com/ru/post/pt406059/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt406047/index.html">Uberiza√ß√£o de caminh√µes de reboque</a></li>
<li><a href="../pt406049/index.html">Exibir gr√°ficos 3D no PSP</a></li>
<li><a href="../pt406051/index.html">A caminho das estrelas: o perigo das viagens espaciais</a></li>
<li><a href="../pt406055/index.html">Uma pessoa que recebeu uma atualiza√ß√£o do sistema imunol√≥gico para combater o c√¢ncer</a></li>
<li><a href="../pt406057/index.html">As equipes do concurso Lunar X PRIZE do Google ter√£o tempo extra</a></li>
<li><a href="../pt406061/index.html">Especialista em seguran√ßa da informa√ß√£o hackeado o Apple Secure Enclave Cryptographic Protection</a></li>
<li><a href="../pt406063/index.html">O que exatamente acontecer√° quando o fork do bitcoin segwit2x for ativado em novembro?</a></li>
<li><a href="../pt406065/index.html">Especialistas em seguran√ßa da informa√ß√£o: ‚ÄúUm carro inteligente est√° longe de ser sempre um carro seguro‚Äù</a></li>
<li><a href="../pt406067/index.html">Contratos inteligentes. Parte 1. Quando o jornal sabe o que voc√™ disse a ela e o faz</a></li>
<li><a href="../pt406069/index.html">Contratos inteligentes. Parte 2. Do hype √† realidade</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>