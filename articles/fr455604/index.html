<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçá üîÉ ‚úåüèΩ Possibilit√© de g√©rer la configuration de Windows. Histoire de r√©ussite üï¢ üà≤ üë©üèΩ‚Äçüöí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lors d'une des r√©unions de la communaut√© .Net de Saint-P√©tersbourg des d√©veloppeurs de la communaut√© SpbDotNet, nous avons fait une exp√©rience et d√©ci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Possibilit√© de g√©rer la configuration de Windows. Histoire de r√©ussite</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/veeam/blog/455604/"><p>  Lors d'une des r√©unions de la communaut√© .Net de Saint-P√©tersbourg des d√©veloppeurs de la communaut√© SpbDotNet, nous avons fait une exp√©rience et d√©cid√© de discuter de la fa√ßon dont vous pouvez appliquer des approches qui sont depuis longtemps devenues la norme dans le monde Linux pour automatiser les infrastructures Windows.  Mais afin de ne pas tout mettre au point de marquer le drapeau Ansible, il a √©t√© d√©cid√© de le montrer par l'exemple du d√©ploiement d'une application ASP.Net. </p><br><p>  Aleksey Chernov, d√©veloppeur principal de l'√©quipe de d√©veloppement de la biblioth√®que de composants d'interface utilisateur pour nos projets, s'est port√© volontaire pour √™tre conf√©rencier.  Et oui, cela ne vous a pas sembl√©: un d√©veloppeur JavaScript s'est pr√©sent√© devant un public .Net. </p><br><p>  Quiconque est int√©ress√© par le r√©sultat d'une telle exp√©rience, bienvenue, sous la coupe du d√©codage. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nEA3sSE33U4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><a name="habracut"></a><br><p>  Salut) Ils se sont d√©j√† un peu g√¢t√©s et ont dit que je suis un front-end, donc vous pouvez d√©j√† diverger =) Je m'appelle Alexey, je fais toutes sortes de choses sur le d√©veloppement web depuis un certain temps.  J'ai commenc√© avec Perl, puis il y avait PHP, un petit RoR, un peu, un peu de √ßa.  Et puis JavaScript a fait irruption dans ma vie, et depuis lors, je fais presque tout cela. </p><br><p>  En plus de JS, j'ai r√©cemment √©crit pas mal d'autotests (en plus, sur le m√™me JS), et je dois donc m'occuper de l'automatisation du d√©ploiement des bancs de test et de l'infrastructure pour eux. </p><br><p>  <strong>Contexte</strong> </p><br><p>  Il y a deux ans, je me suis retrouv√© chez Veeam, o√π ils d√©veloppent des produits pour Windows.  √Ä ce moment, j'ai √©t√© tr√®s surpris, mais il s'est av√©r√© que cela se produit =).  Mais surtout, j'ai √©t√© surpris par le niveau inhabituellement bas d'automatisation de tout ce qui est li√© au d√©ploiement, au d√©ploiement d'applications, aux tests, etc. </p><br><p>  Nous, ceux qui d√©veloppons pour Linux, sommes habitu√©s depuis longtemps au fait que tout devrait √™tre dans Docker, il y a Kubernetes, et tout se d√©roule en un seul clic.  Et quand je me suis retrouv√© dans un environnement o√π tout cela n'est pas l√†, √ßa a choqu√©.  Et quand j'ai commenc√© √† faire des tests automatiques, j'ai r√©alis√© que ce n'√©tait que 20% de r√©ussite, et tout le reste pr√©parait l'infrastructure pour eux. </p><br><p><img src="https://habrastorage.org/webt/5v/rm/ca/5vrmcacwrpdrkb1dejapgmjzfqa.png"><br>  <em>Mes sentiments au d√©but</em> </p><br><p>  <strong>Conditions actuelles</strong> </p><br><p>  Je vais vous expliquer comment tout est organis√© avec nous, ce que nous devons automatiser et ce que nous faisons. </p><br><p> Nous avons un tas de produits diff√©rents, la plupart sous Windows, il y en a plusieurs sous Linux et m√™me quelque chose sous Solaris.  Un grand nombre de versions sont collect√©es quotidiennement pour tous les produits.  En cons√©quence, il est n√©cessaire de tout d√©ployer dans les laboratoires de test, √† la fois pour l'AQ et pour les d√©veloppeurs eux-m√™mes, afin qu'ils puissent v√©rifier l'int√©gration des applications.  Tout cela n√©cessite une √©norme infrastructure de nombreux serveurs et machines virtuelles Iron.  Et parfois, nous effectuons des tests de performances, lorsque nous devons √©lever imm√©diatement un millier de machines virtuelles et voir √† quelle vitesse nos applications fonctionneront. </p><br><p>  <strong>Les probl√®mes</strong> </p><br><p>  Bien s√ªr, dans les premi√®res √©tapes (lire, il y a longtemps), lors de la tentative d'automatisation directe, PowerShell a √©t√© utilis√©.  L'outil est puissant, mais les scripts de d√©ploiement sont extr√™mement compliqu√©s.  Un autre probl√®me √©tait le manque de gestion centralis√©e de ce processus.  Certains scripts ont √©t√© ex√©cut√©s localement par des d√©veloppeurs, d'autres sur des machines virtuelles cr√©√©es √† l'√©poque des mammouths, etc.  R√©sultat: il √©tait difficile d'obtenir un seul r√©sultat et de comprendre ce qui fonctionne et ce qui ne fonctionne pas.  Vous venez travailler, ouvrez le navigateur - le serveur n'est pas disponible.  Pourquoi il n'est pas disponible, ce qui s'est pass√©, o√π il s'est cass√© - ce n'√©tait absolument pas clair.  Il n‚Äôy avait pas de point d‚Äôentr√©e unique, et j‚Äôai d√ª chercher la v√©rit√© sur les forums de discussion, et c‚Äôest bien si quelqu'un r√©pondait. </p><br><p>  Un autre probl√®me, moins √©vident, est celui des d√©butants.  C'√©tait difficile pour eux.  La premi√®re semaine de travail, ils se sont plong√©s dans ce qui se passait.  Nous vivions habituellement avec cela, nous assurant que la vie est une chose difficile et que nous devons l'accepter.  Comprendre et pardonner, pour ainsi dire. </p><br><p>  Mais √† un moment donn√©, ils ont trouv√© la force int√©rieure pour la surmonter et regarder autour de eux.  D'une mani√®re ou d'une autre, vous pouvez probablement le g√©rer. </p><br><p><img src="https://habrastorage.org/webt/kg/ra/io/kgraiod0cirwgawpngochydtu2e.png"><br>  <em>La premi√®re √©tape vers la r√©solution du probl√®me est de l'accepter.</em> </p><br><p>  <strong>S√©lection de la solution</strong> </p><br><p>  Lorsque vous ne savez pas quoi faire, voyez ce que font les autres. </p><br><p>  Et pour commencer, nous avons fait notre liste d'exigences pour ce que nous voulons obtenir √† la fin. </p><br><ul><li>  Base de code unifi√©e.  Tous les scripts de d√©ploiement doivent √™tre au m√™me endroit.  Vous souhaitez d√©ployer quelque chose ou voir comment cela se d√©roule: voici un r√©f√©rentiel pour vous, allez-y. </li><li>  Tout le monde sait comment cela fonctionne.  Les questions devraient dispara√Ætre "Je ne comprends pas comment le d√©ployer, donc le deuxi√®me jour je ne pourrai pas fermer le bogue". </li><li>  Possibilit√© de d√©marrer par bouton.  Nous devons pouvoir contr√¥ler les d√©ploiements.  Par exemple, une sorte d'interface Web, o√π vous allez, appuyez sur un bouton et le produit souhait√© est d√©ploy√© sur l'h√¥te souhait√©. </li></ul><br><p>  Apr√®s nous √™tre assur√©s que cette liste couvre le minimum d'exigences n√©cessaires et suffisantes pour notre bonheur, nous avons commenc√© √† essayer.  Traditionnellement, la premi√®re chose qu'ils essayaient de r√©soudre √©tait la m√©thode d'attaque frontale.  Avons-nous de nombreux scripts PowerShell?  Alors combinons-les dans un r√©f√©rentiel.  Mais le probl√®me n'est pas qu'il y avait trop de scripts, mais que diff√©rentes √©quipes ont fait la m√™me chose avec diff√©rents scripts.  J'ai parcouru diff√©rentes √©quipes, √©cout√© leurs besoins, collect√© les m√™mes scripts, essay√© de les combiner et de les param√©trer d'une mani√®re ou d'une autre, puis de les placer dans un r√©f√©rentiel unique. </p><br><p>  <strong>√âchec: la</strong> tentative a √©chou√©.  Premi√®rement, nous avons commenc√© √† nous disputer beaucoup sur les raisons pour lesquelles nous proc√©dons ainsi et non de cette fa√ßon.  Pourquoi cette m√©thode a-t-elle √©t√© utilis√©e, et pas une autre, etc.  Et par cons√©quent, nombreux √©taient ceux qui voulaient tout refaire "comme il se doit", sur le principe "Je vais tout bifurquer et tout r√©√©crire pour vous".  Et, bien s√ªr, il ne sera pas possible de combiner les branches avec cette approche. </p><br><p>  Tentative num√©ro deux: il √©tait cens√© prendre notre serveur CI (TeamCity), faire des mod√®les dessus et, en utilisant l'h√©ritage, fermer le probl√®me principal d√®s la premi√®re tentative.  Mais, comme vous l'avez peut-√™tre devin√© tout de suite, <strong>Fail</strong> nous attendait √©galement <strong>:</strong> vous ne pouvez utiliser le mod√®le que pour la derni√®re version, ce qui signifie que nous n'obtiendrons pas le versioning n√©cessaire.  Et la cons√©quence d'un grand nombre d'√©quipes - les mod√®les sont devenus tr√®s nombreux, il est devenu plus difficile de les g√©rer, et √† l'horizon un nouveau marais √©tait clairement visible. </p><br><p><img src="https://habrastorage.org/webt/10/mb/ai/10mbain0xddl-fwxwkvtmebrl-i.png"></p><br><p>  Fatigu√© de tomber face cach√©e √† toute tentative de d√©collage, il a √©t√© d√©cid√© de se rasseoir et de r√©fl√©chir s√©rieusement.  Nous avons donc un grand nombre de ps-scripts d'une part et un grand nombre de virtuels d'autre part.  Mais nous avions tort, car  ce n'√©tait pas la racine du probl√®me.  Le probl√®me √©tait qu'il y avait toujours une personne entre ces choses.  Peu importe qu'il s'agisse d'un d√©veloppeur, d'un testeur ou de quelqu'un d'autre, la cha√Æne logique a toujours √©t√© comme ceci: </p><br><ul><li>  J'ai donc besoin d'une machine virtuelle pour les tests </li><li>  Oui, nous avons ici un pool d'h√¥tes </li><li>  Et voici le script dont j'ai besoin, maintenant je vais l'ex√©cuter, et tout se passera </li></ul><br><p>  Avec la r√©alisation d'une chose aussi simple en apparence, le probl√®me g√©n√©ral a commenc√© √† jouer avec de nouvelles couleurs.  Il s'est av√©r√© que toutes nos peines sont dues √† l'absence d'une description unique de notre infrastructure.  C'√©tait dans l'esprit des gens qui l'ont cr√©√©, ils ont si√©g√© dans diff√©rents d√©partements, n'ont pas essay√© de le documenter d'une mani√®re ou d'une autre et, g√©n√©ralement, chacun vivait dans son propre √©tat. <br>  En ce moment, nous sommes arriv√©s √† la conclusion que la r√©ponse √† tous nos probl√®mes est: </p><br><p>  <strong>L'infrastructure comme code</strong> </p><br><p>  C'est pr√©cis√©ment que toute notre infrastructure doit √™tre d√©crite dans le code et se trouver dans le r√©f√©rentiel.  Toutes les machines virtuelles, tous leurs param√®tres, tout ce qui y est install√© - tout doit √™tre d√©crit dans le code. </p><br><p>  Une question l√©gitime se pose - pourquoi? </p><br><p>  Nous r√©pondons: cette approche nous donnera l'occasion d'appliquer les meilleures pratiques du monde du d√©veloppement, auxquelles nous sommes tous si habitu√©s: </p><br><ul><li>  Contr√¥le de version.  Nous pouvons toujours comprendre ce qui a chang√© et quand.  Plus d'h√¥te sortant de nulle part ou parti nulle part.  Il sera toujours clair qui a apport√© les modifications. </li><li>  R√©vision du code.  Nous pourrons contr√¥ler les processus de d√©ploiement afin que certains ne portent pas atteinte aux autres. </li><li>  Int√©gration continue. </li></ul><br><p>  <strong>S√©lection d'outils</strong> </p><br><p>  Comme nous le savons tous, il existe de nombreux outils de gestion de configuration.  Nous avons opt√© pour Ansible, car il contient un ensemble de fonctionnalit√©s dont nous avons besoin. <br>  Tout d'abord, nous voulons que le syst√®me d'automatisation ne lance aucun programme d'installation, que quelque chose migre quelque part, etc.  Tout d'abord, √† partir d'un tel syst√®me, nous voulons qu'apr√®s avoir appuy√© sur un bouton, nous verrons l'interface utilisateur de l'application dont nous avons besoin. </p><br><p>  Par cons√©quent, la caract√©ristique cl√© pour nous est l'idempotence.  Ansible n'a pas d'importance ce qui s'est pass√© avant.  Apr√®s avoir d√©marr√© le playbook souhait√©, nous obtenons toujours le m√™me r√©sultat.  Ceci est tr√®s important lorsque vous dites non pas "Installer IIS", mais "Il devrait y avoir IIS", et vous n'avez pas √† vous demander s'il √©tait l√† avant ou non.  Il est tr√®s difficile d'y parvenir avec des scripts, et les playbooks Ansible offrent une telle opportunit√©. </p><br><p>  Il convient √©galement de mentionner l'absence d'agent d'Ansible.  La plupart des syst√®mes d'automatisation fonctionnent via des agents.  Il y a de nombreux avantages √† cela - par exemple, les meilleures performances - mais il √©tait important pour nous qu'il n'y ait pas d'agent pour que le syst√®me n'ait pas √† √™tre pr√©par√© en plus d'une mani√®re ou d'une autre. </p><br><p>  PowerShell: </p><br><pre><code class="bash hljs"><span class="hljs-variable"><span class="hljs-variable">$url</span></span> = <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> <span class="hljs-variable"><span class="hljs-variable">$output</span></span> = <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$PSSscriptRoot</span></span></span><span class="hljs-string">\build.msi"</span></span> Invoke-WebRequest -Uri <span class="hljs-variable"><span class="hljs-variable">$url</span></span> -OutFile <span class="hljs-variable"><span class="hljs-variable">$output</span></span></code> </pre> <br><p>  Ansible: </p><br><pre> <code class="bash hljs">name: Download build hosts: all tasks: name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"http://buildserver/build.msi"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"build.msi"</span></span> force: no</code> </pre> <br><p>  Ici, nous voyons que dans l'exemple de base, le ps-script sera encore plus concis que le playbook Ansible.  3 lignes de script contre 7 lignes de playbook pour t√©l√©charger un fichier. </p><br><p>  Mais, Petka, il y a une nuance.  D√®s que nous voulons adh√©rer au principe d'idempotence et, par exemple, pour √™tre s√ªr que le fichier sur le serveur n'a pas chang√© et qu'il n'a pas besoin d'√™tre t√©l√©charg√©, vous devrez impl√©menter une requ√™te HEAD dans le script, ce qui ajoute environ 200 lignes.  Et dans le playbook - un.  Le module Ansible win_get_url, qui effectue toutes les v√©rifications pour vous, contient 257 lignes de code que vous n‚Äôavez pas √† ins√©rer dans chaque script. </p><br><p>  Et ce n'est l√† qu'un exemple d'une t√¢che tr√®s simple. </p><br><p><img src="https://habrastorage.org/webt/ca/tz/el/catzel2r3lxpzk_yaz0moo6s-c0.png"></p><br><p>  Et si vous y r√©fl√©chissez, nous avons besoin d'idempotence partout: </p><br><ul><li>  V√©rifiez l'existence d'une machine virtuelle.  Dans le cas des scripts, nous risquons soit d'en produire un nombre infini, soit le script plantera au tout d√©but. </li><li>  Quels packages msi existe-t-il sur la machine?  Dans le meilleur des cas, rien ne tombera ici; dans le pire, la machine cessera de fonctionner correctement. </li><li>  Dois-je t√©l√©charger √† nouveau des artefacts de build?  C'est bien si vos builds p√®sent une douzaine de m√©gaoctets.  Et qu'en est-il de ceux qui ont quelques gigaoctets? </li></ul><br><p>  Et d'autres exemples, o√π la solution consiste √† gonfler les scripts avec une ramification sans fin des ifs qui ne peuvent pas √™tre correctement d√©bogu√©s et impossibles √† g√©rer. </p><br><p>  Entre autres choses qui sont importantes pour nous, Ansible n'utilise pas d'agents pour g√©rer vos h√¥tes et machines.  Sous Linux, bien s√ªr, il fonctionne sur ssh, tandis que pour Windows, WinRM est utilis√©.  D'o√π la cons√©quence √©vidente: Ansible est multi-plateforme.  Il prend en charge un nombre fantastique de plates-formes, jusqu'aux √©quipements r√©seau. </p><br><p>  Et le dernier, mais non moins important, est le format d'enregistrement de configuration YAML.  Tout le monde y est habitu√©, il est facile √† lire et il est facile de comprendre ce qui s'y passe. </p><br><p>  Mais tout n'est pas si doux, il y a des probl√®mes: </p><br><ul><li>  Le probl√®me est douteux: pour ex√©cuter des playbooks, vous avez toujours besoin d'une machine Linux, m√™me si l'ensemble de votre infrastructure est exclusivement Windows.  Bien que ce ne soit pas un si gros probl√®me dans le monde moderne, car  sur Windows 10, il y a maintenant WSL, o√π vous pouvez ex√©cuter Ubuntu, sous lequel piloter des playbooks. </li><li>  Parfois, les playbooks sont vraiment difficiles √† d√©boguer.  Ansible est √©crit en python, et la derni√®re chose que je veux voir est une feuille de pile de pile python √† cinq √©crans.  Et une faute de frappe dans le nom du module </li></ul><br><p>  <strong>Comment √ßa marche?</strong> <br>  Tout d'abord, nous avons besoin d'une machine Linux.  Dans la terminologie Ansible, cela s'appelle la machine de contr√¥le. <br>  Les playbooks vont commencer √† partir de l√†, et toute la magie se produit dessus. </p><br><p>  Sur cette machine, nous aurons besoin de: </p><br><ul><li>  Python et le gestionnaire de paquets python pip.  De nombreuses distributions sont pr√™tes √† l'emploi, donc pas de surprise ici. </li><li>  Installez Ansible via pip, comme le moyen le plus universel: pip install ansible </li><li>  Ajouter un module winrm pour acc√©der aux machines Windows: pip install pywinrm [credssp] </li><li>  Et sur les machines que nous voulons contr√¥ler, nous devons activer winrm, car  il est d√©sactiv√© par d√©faut.  Il existe de nombreuses fa√ßons de proc√©der, et elles sont toutes d√©crites dans la documentation Ansible.  Mais le plus simple consiste √† extraire le script termin√© du r√©f√©rentiel Ansible et √† l'ex√©cuter avec l'option d'autorisation requise: ConfigureRemotingForAnsible.ps1 -EnableCredSSP </li></ul><br><p>  La partie la plus importante dont nous avions besoin pour arr√™ter de souffrir avec les scripts ps √©tait Inventory.  Un fichier YAML (dans notre cas), qui d√©crit notre infrastructure et o√π vous pouvez toujours chercher √† comprendre o√π cela est d√©ploy√©.  Et, bien s√ªr, les playbooks eux-m√™mes.  √Ä l'avenir, le travail ressemble √† lancer un playbook avec le fichier d'inventaire n√©cessaire et des param√®tres suppl√©mentaires. </p><br><pre> <code class="bash hljs">all: children: webservers: hosts: spbdotnet-test-host.dev.local: dbservers: hosts: spbdotnet-test-host.dev.local: vars: ansible_connection: winrm ansible_winrm_transport: credssp ansible_winrm_server_cert_validation: ignore ansible_user: administrator ansible_password: 123qweASD</code> </pre> <br><p>  Ici, tout est simple: le groupe racine est all et deux sous-groupes, les webserves et les dbservers.  Tout le reste est intuitif, mais j'attirerai votre attention sur le fait qu'Ansible, par d√©faut, croit que Linux est partout, donc pour Windows, vous devez absolument sp√©cifier winrm et le type d'autorisation. </p><br><p>  Le mot de passe sous forme claire, bien s√ªr, n'a pas besoin d'√™tre stock√© dans le playbook, voici juste un exemple.  Les mots de passe peuvent √™tre stock√©s, par exemple, dans Ansible-Vault.  Nous utilisons TeamCity pour cela, qui transmet des secrets √† travers des variables d'environnement et ne d√©clenche rien. </p><br><p>  <strong>Modules</strong> </p><br><p>  Tout ce que fait Ansible, il le fait √† l'aide de modules.  Les modules pour Linux sont √©crits en python, pour Windows dans PowerShell.  Et une v√©n√©ration pour l'idempotence: le r√©sultat du module se pr√©sente toujours sous la forme d'un fichier json, qui indique s'il y a eu des changements sur l'h√¥te ou non. </p><br><p>  Dans le cas g√©n√©ral, nous ex√©cuterons une construction de la forme liste de modules du fichier d'inventaire du groupe d'h√¥tes ansible: </p><br><p><img src="https://habrastorage.org/webt/dt/ww/s7/dtwws7ix1i1k1jqbtpp0cnowrus.png"></p><br><p>  <strong>Playbooks</strong> </p><br><p>  Un playbook est une description de comment et o√π nous ex√©cuterons les modules Ansible. </p><br><pre> <code class="bash hljs">- name: Install AWS CLI hosts: all vars: aws_cli_download_dir: c:\downloads aws_cli_msi_url: https://s3.amazonaws.com/aws-cli/AWSCLI32PY3.msi tasks: - name: Ensure target directory exists win_file: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}"</span></span> state: directory - name: Download installer win_get_url: url: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_msi_url }}"</span></span> dest: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> force: no - name: Install AWS CLI win_package: path: <span class="hljs-string"><span class="hljs-string">"{{ aws_cli_download_dir }}\\awscli.msi"</span></span> state: present</code> </pre> <br><p>  Dans cet exemple, nous avons trois t√¢ches.  Chaque t√¢che est un appel de module.  Dans ce manuel, nous cr√©ons d'abord un r√©pertoire (assurez-vous qu'il existe), puis t√©l√©chargez-y l'AWS CLI et utilisez le module win_packge pour l'installer. </p><br><p>  En ex√©cutant ce playbook, nous obtenons ce r√©sultat. </p><br><p><img src="https://habrastorage.org/webt/ga/2x/sd/ga2xsdh7zgvlxvioliy_g3ijkxo.png"></p><br><p>  Le rapport montre que quatre t√¢ches ont √©t√© men√©es √† bien et trois des quatre ont apport√© des modifications √† l'h√¥te. </p><br><p>  Mais que se passe-t-il si vous ex√©cutez √† nouveau ce manuel?  Nous n'avons √©crit nulle part o√π cr√©er le r√©pertoire, t√©l√©charger le fichier d'installation et l'ex√©cuter.  Nous v√©rifions simplement la disponibilit√© de chaque article et sautons si disponible. </p><br><p><img src="https://habrastorage.org/webt/8m/ro/de/8mrodes1ld9oocapp3qhnypwkcw.png"></p><br><p>  C'est l'idempotence que nous ne pouvions pas atteindre avec PowerShell. </p><br><p>  <strong>Pratique</strong> </p><br><p>  Il s'agit d'un exemple l√©g√®rement simplifi√©, mais, en principe, c'est exactement ce que nous faisons tous les jours. <br>  Nous d√©ploierons une application compos√©e d'un service Windows et d'une application Web sous IIS. </p><br><pre> <code class="bash hljs">- name: Setup App hosts: webservers tasks: - name: Install IIS win_feature: name: - Web-Server - Web-Common-Http include_sub_features: True include_management_tools: True state: present register: win_feature - name: reboot <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> installing Web-Server feature requires it win_reboot: when: win_feature.reboot_required</code> </pre> <br><p>  Tout d'abord, nous devons voir s'il existe un IIS sur l'h√¥te et l'installer sinon.  Et ce serait bien d'ajouter imm√©diatement des outils de gestion et toutes les fonctionnalit√©s d√©pendantes.  Et c'est tr√®s bien si l'h√¥te est red√©marr√© si n√©cessaire. </p><br><p>  La premi√®re t√¢che que nous r√©solvons est le module win_feature, qui est engag√© dans la gestion des fonctionnalit√©s de Windows.  Et ici, pour la premi√®re fois, nous avons les variables d'environnement Ansible, dans l'√©l√©ment de registre.  Rappelez-vous, j'ai dit que les t√¢ches retournent toujours un objet json?  Maintenant, apr√®s avoir termin√© la t√¢che Installer IIS, la sortie du module win_feature se trouve dans la variable win_feature (excusez-moi pour la tautologie). </p><br><p>  Dans la t√¢che suivante, nous appelons le module win_reboot.  Mais nous n'avons pas besoin de red√©marrer notre serveur √† chaque fois.  Nous ne le rechargerons que si le module win_feature nous renvoie cette exigence sous forme de variable. </p><br><p>  L'√©tape suivante consiste √† installer SQL.  Un million de fa√ßons ont d√©j√† √©t√© invent√©es pour ce faire.  J'utilise le module win_chocolatey ici.  Il s'agit d'un gestionnaire de packages pour Windows.  Oui, c'est exactement ce √† quoi nous sommes habitu√©s sous Linux.  Les modules sont soutenus par la communaut√©, et maintenant il y en a d√©j√† plus de six mille.  Je vous conseille fortement d'essayer. </p><br><pre> <code class="bash hljs">- name: SQL Server hosts: dbservers tasks: - name: Install MS SQL Server 2014 win_chocolatey: name: mssqlserver2014express state: present</code> </pre> <br><p>  Nous avons donc pr√©par√© l'h√¥te pour le lancement de l'application, d√©ployons-le! </p><br><pre> <code class="plaintext hljs">- name: Deploy binaries hosts: webservers vars: myapp_artifacts: files/MyAppService.zip myapp_workdir: C:\myapp tasks: - name: Remove Service if exists win_service: name: MyAppService state: absent path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  Au cas o√π, la premi√®re chose que nous faisons est de supprimer le service existant. </p><br><pre> <code class="plaintext hljs">- name: Delete old files win_file: path: "{{ myapp_workdir }}\\" state: absent - name: Copy artifacts to remote machine win_copy: src: "{{ myapp_artifacts }}" dest: "{{ myapp_workdir }}\\" - name: Unzip build artifacts win_unzip: src: "{{ myapp_workdir }}\\MyAppService.zip" dest: "{{ myapp_workdir }}"</code> </pre> <br><p>  L'√©tape suivante consiste √† t√©l√©charger de nouveaux artefacts sur l'h√¥te.  Ce playbook implique qu'il s'ex√©cute sur un serveur de build, toutes les archives sont dans un dossier connu, et nous leur indiquons le chemin avec des variables.  Apr√®s la copie (win_copy), les archives sont d√©compress√©es (win_unzip).  Ensuite, nous enregistrons simplement le service, disons le chemin vers exe et qu'il doit √™tre d√©marr√©. </p><br><pre> <code class="plaintext hljs"> - name: Register and start the service win_service: name: ReporterService start_mode: auto state: started path: "{{ myapp_workdir }}\\MyAppService.exe"</code> </pre> <br><p>  <strong>Termin√©!?</strong> </p><br><p>  Il semble que notre service soit pr√™t pour le travail et la d√©fense, cependant, il y a un ¬´mais¬ª - nous n'avons pas observ√© le principe de l'idempotence.  Nous supprimons toujours le code existant, puis d√©ployons le nouveau. </p><br><p>  Et c'est √ßa le probl√®me.  Si nous supprimions l'ancien service hors service, et apr√®s qu'une sorte d'erreur s'est produite et que le playbook n'a pas termin√© son travail, nous aurons un h√¥te cass√©.  Ou, par exemple, nous d√©ployons plusieurs applications en m√™me temps, dont une n'a pas chang√©, alors nous n'avons pas besoin de la d√©ployer aussi. </p><br><p>  Que peut-on faire?  Alternativement, vous pouvez v√©rifier la somme de contr√¥le de nos artefacts et les comparer avec ceux du serveur. </p><br><pre> <code class="plaintext hljs"> - name: Get arifacts checksum stat: path: "{{ myapp_artifacts }}" delegate_to: localhost register: myapp_artifacts_stat - name: Get remote artifacts checksum win_stat: path: "{{ myapp_workdir }}\\MyAppService.zip" register: myapp_remote_artifacts_stat</code> </pre> <br><p>  Nous utilisons le module stat, qui fournit toutes sortes d'informations sur les fichiers, y compris la somme de contr√¥le.  Ensuite, en utilisant le registre de directives familier, nous √©crivons le r√©sultat dans une variable.  D'int√©ressant: delegate_to indique que cela doit √™tre fait sur la machine locale o√π le playbook est d√©marr√©. </p><br><pre> <code class="plaintext hljs"> - name: Stop play if checksums match meta: end_play when: - myapp_artifacts_stat.stat.checksum is defined - myapp_remote_artifacts_stat.stat.checksum is defined - myapp_artifacts_stat.stat.checksum == myapp_remote_artifacts_stat.stat.checksum</code> </pre> <br><p>  Et avec l'aide du m√©ta-module, nous disons que nous devons terminer le playbook si les sommes de contr√¥le des artefacts sur les machines locales et distantes correspondent.  C'est ainsi que nous avons observ√© le principe de l'idempotence. </p><br><pre> <code class="plaintext hljs"> - name: Ensure that the WebApp application exists win_iis_webapplication: name: WebApp physical_path: c:\webapp site: Default Web Site state: present</code> </pre> <br><p>  Voyons maintenant notre application Web.  Nous omettons la partie sur la copie de fichiers, allons droit au but.  Notre serveur de build a cr√©√© l'√©diteur, t√©l√©charg√© tous les fichiers en vrac sur l'h√¥te et utilis√© le module int√©gr√© pour travailler avec les applications IIS.  Il cr√©era l'application et l'ex√©cutera. </p><br><p>  <strong>R√©utilisation du code</strong> </p><br><p>  L'une des t√¢ches que nous nous √©tions fix√©es √©tait de permettre √† tout ing√©nieur de l'entreprise de lancer facilement un d√©ploiement.  Il √©crit son livre de jeu √† partir de modules pr√™ts √† l'emploi, dit qu'il doit ex√©cuter tel ou tel produit sur tel ou tel h√¥te. </p><br><p>  Pour cela, Ansible a des r√¥les.  Il s'agit essentiellement d'une convention.  Nous cr√©ons un dossier / r√¥les / sur le serveur et y mettons nos r√¥les.  Chaque r√¥le est un ensemble de fichiers de configuration: une description de nos appareils, variables, fichiers de service, etc.  Habituellement, une entit√© isol√©e joue un r√¥le.  L'installation d'IIS est un excellent exemple si nous devons non seulement l'installer, mais aussi le configurer d'une mani√®re ou d'une autre avec des t√¢ches suppl√©mentaires.  Nous cr√©ons un r√¥le distinct et isolons ainsi tous les playbooks li√©s √† IIS dans le dossier de r√¥les.  √Ä l'avenir, nous appellerons simplement ce r√¥le avec la directive include_role% role_name%. </p><br><p>  Naturellement, nous avons cr√©√© des r√¥les pour toutes les applications, laissant aux ing√©nieurs la possibilit√© de personnaliser le processus √† l'aide de param√®tres de configuration. </p><br><pre> <code class="plaintext hljs">- name: Run App hosts: webservers tasks: - name: "Install IIS" include_role: name: IIS - name: Run My App include_role: name: MyAppService vars: myapp_artifacts: ./buld.zip</code> </pre> <br><p>  Dans cet exemple, le r√¥le Ex√©cuter mon application a la capacit√© de transf√©rer un chemin d'acc√®s aux artefacts. </p><br><p>  Ici, vous devez mettre un mot sur Ansible Galaxy - un r√©f√©rentiel de solutions standard couramment disponibles.  Comme d'habitude dans une soci√©t√© d√©cente, de nombreux probl√®mes ont d√©j√† √©t√© r√©solus devant nous.  Et s'il y a un sentiment que maintenant nous allons commencer √† r√©inventer la roue, alors vous devez d'abord regarder la liste des modules int√©gr√©s, puis plonger dans Ansible Galaxy.  Il est probable que le playbook dont vous avez besoin ait d√©j√† √©t√© cr√©√© par quelqu'un d'autre.  Il existe un grand nombre de modules pour toutes les occasions. </p><br><p>  <strong>Plus de flexibilit√©</strong> </p><br><p>  Mais que faire s'il n'y a pas de module int√©gr√© ou un r√¥le appropri√© dans Galaxy?  Il y a deux options: soit nous faisons quelque chose de mal, soit nous avons vraiment une t√¢che unique. </p><br><p>  Dans le cas de la deuxi√®me option, nous pouvons toujours √©crire notre module.  Comme je l'ai montr√© au d√©but, Ansible permet d'√©crire le module le plus simple en 10 minutes, et lorsque vous approfondissez, une documentation assez d√©taill√©e vient √† votre aide, couvrant de nombreuses questions. </p><br><p>  <strong>Ci</strong> <br>  Dans notre d√©partement, nous aimons vraiment TeamCity, mais il peut y avoir tout autre serveur CI de votre choix.  Pourquoi devons-nous les partager? </p><br><p>  Premi√®rement, nous pouvons toujours v√©rifier la syntaxe de nos playbooks.  Bien que YAML consid√®re les onglets comme une erreur de syntaxe, il s'agit d'une fonctionnalit√© tr√®s utile. </p><br><p>  √âgalement sur le serveur CI, nous ex√©cutons ansible-lint.  Il s'agit d'un analyseur statique de configurations ansibles, qui donne une liste de recommandations. </p><br><p><img src="https://habrastorage.org/webt/mc/rf/ks/mcrfks9tz2igullrdgqeedqkyim.png"></p><br><p>  Par exemple, ici, il dit que nous avons un espace suppl√©mentaire √† la fin de la ligne, et pour une t√¢che, aucun nom n'est donn√©.  Ceci est important car  le nom du module peut appara√Ætre plusieurs fois dans le m√™me playbook et toutes les t√¢ches doivent √™tre nomm√©es. </p><br><p>  Bien s√ªr, vous pouvez toujours √©crire des tests pour les playbooks.  Nous pouvons nous permettre de ne pas le faire parce que  nous allons d√©ployer dans l'environnement de test et rien de critique ne se produira.  Mais si vous d√©ployez sur le prod, il serait pr√©f√©rable de tout v√©rifier.  L'avantage d'ansible vous permet de tester non seulement des playbooks, mais aussi des modules individuels.  Assurez-vous donc d'y pr√™ter attention. </p><br><p>  Et la deuxi√®me raison principale d'utiliser le serveur CI est de lancer des playbooks.  C'est le m√™me bouton magique "Bien faire", qui nous donne TeamCity.  Nous cr√©ons simplement des configurations simples pour diff√©rents produits, o√π nous disons: ansible-playbook reporter_vm.yml -i inventaire.yml -vvvv et obtenez le bouton D√©ployer. </p><br><p>  Bonus suppl√©mentaire: vous pouvez construire des builds en fonction des builds.  D√®s que quelque chose s'est consolid√©, TeamCity d√©marre le processus de red√©ploiement, apr√®s quoi nous ne pouvons consulter les journaux que si quelque chose se casse soudainement. </p><br><p>  <strong>Total</strong> </p><br><ul><li>  Scripts PowerShell confus et disparates que nous avons remplac√©s par des configurations YAML. </li><li>  Nous avons remplac√© diverses impl√©mentations des m√™mes probl√®mes par des r√¥les communs qui peuvent √™tre r√©utilis√©s.  Un r√©f√©rentiel a √©t√© cr√©√© o√π se trouvent les r√¥les.  Si le r√¥le vous convient, il vous suffit de l'utiliser.  Si cela ne vous convient pas, il vous suffit d'envoyer la demande de pool, et cela vous convient =) </li><li>  Vous pouvez d√©sormais v√©rifier le succ√®s du d√©ploiement en un seul endroit. </li><li>  Tout le monde sait o√π chercher les journaux. </li><li>  Les probl√®mes de communication ont √©galement √©t√© r√©solus via un r√©f√©rentiel commun et TeamCity.  Toutes les personnes int√©ress√©es savent o√π se trouvent les playbooks et comment ils fonctionnent. </li></ul><br><p>  PS Tous les exemples de l'article peuvent √™tre pris sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr455604/">https://habr.com/ru/post/fr455604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr455594/index.html">Microsoft Edge de CVE √† RCE sur Windows 10</a></li>
<li><a href="../fr455596/index.html">DevConfX :: Management - rapports des managers en mots simples</a></li>
<li><a href="../fr455598/index.html">Mettre √† jour Exim √† 4.92 de toute urgence - il y a une infection active</a></li>
<li><a href="../fr455600/index.html">La plateforme 3DEXPERIENCE aide √† cr√©er les transports publics du futur</a></li>
<li><a href="../fr455602/index.html">Provoquer un crash du navigateur avec fuzzing comportemental</a></li>
<li><a href="../fr455606/index.html">Apprentissage automatique et analyse des donn√©es: programme de ma√Ætrise √† l'√âcole sup√©rieure d'√©conomie de Saint-P√©tersbourg</a></li>
<li><a href="../fr455608/index.html">Index bitmap dans Go: vitesse de recherche incroyable</a></li>
<li><a href="../fr455610/index.html">Intel Core i7-2600K l√©gendaire: test de Sandy Bridge en 2019 (partie 1)</a></li>
<li><a href="../fr455612/index.html">Nous r√©fl√©chissons aux personnages de jeux et dialogues sur les conseils d'√©crivains et sur l'exemple des partisans de la th√©orie d'une Terre plate</a></li>
<li><a href="../fr455614/index.html">FFI: √©crire en Rust dans un programme PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>