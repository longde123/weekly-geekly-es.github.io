<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ö†Ô∏è ü§ß üà∏ Automa√ß√£o para os mais pequenos. Parte Dois. Projeto de rede ü§¥üèæ üñ•Ô∏è üëÇüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nos dois primeiros artigos, levantei a quest√£o da automa√ß√£o e esbocei sua estrutura; no segundo, fiz uma digress√£o sobre a virtualiza√ß√£o de rede, como...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automa√ß√£o para os mais pequenos. Parte Dois. Projeto de rede</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/475614/">  Nos dois primeiros artigos, levantei a quest√£o da automa√ß√£o e esbocei sua estrutura; no segundo, fiz uma digress√£o sobre a virtualiza√ß√£o de rede, como a primeira abordagem para automatizar a configura√ß√£o de servi√ßos. <br>  E agora √© hora de desenhar um diagrama de rede f√≠sico. <br><br>  Se voc√™ n√£o est√° muito interessado no dispositivo das redes de data center, recomendo come√ßar com um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo sobre elas</a> . <br><br>  Todas as edi√ß√µes: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">0. ADSM.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte zero.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Planejamento</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">1. ADSM.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte um (que √© depois de zero).</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Virtualiza√ß√£o de rede</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">2. ADSM.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte Dois.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Projeto de rede</a> </li></ul><br>  As pr√°ticas descritas nesta s√©rie devem ser aplic√°veis ‚Äã‚Äãa uma rede de qualquer tipo, escala e variedade de fornecedores (n√£o).  No entanto, um exemplo universal da aplica√ß√£o dessas abordagens n√£o pode ser descrito.  Portanto, vou me concentrar na arquitetura moderna da rede DC: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Klose Factory</a> . <br>  DCI far√° em MPLS L3VPN. <br><br>  Uma rede de sobreposi√ß√£o do host √© executada sobre a rede f√≠sica (pode ser OpenStack VXLAN ou Tungsten Fabric ou qualquer outra coisa que exija apenas conectividade IP b√°sica da rede). <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/e13/b5a/aa8/e13b5aaa8e2c2161e75084de878ed741.jpg" width="600"></a> <br><br>  Nesse caso, obtemos um cen√°rio relativamente simples para automa√ß√£o, porque temos muitos equipamentos configurados da mesma maneira. <br><br>  Vamos escolher uma CD esf√©rica no v√°cuo: <br><br><ul><li>  Uma vers√£o do design est√° em todo lugar. </li><li>  Dois fornecedores formando dois planos da rede. </li><li>  Um CD √© como outro, como duas gotas de √°gua. </li></ul><br><hr><br><a name="habracut"></a><br><h1>  Conte√∫do </h1><br><ul><li>  <b>Topologia f√≠sica</b> </li><li>  <b>Encaminhamento</b> </li><li>  <b>Plano IP</b> </li><li>  <b>Laba</b> </li><li>  <b>Conclus√£o</b> </li><li>  <b>Links √∫teis</b> </li></ul><br>  Permita que o nosso provedor de servi√ßos LAN_DC, por exemplo, hospede v√≠deos de treinamento sobre sobreviv√™ncia em elevadores presos. <br><br>  Nas megacidades, isso √© muito popular, ent√£o h√° muitas m√°quinas f√≠sicas. <br><br>  Primeiro, descreverei a rede aproximadamente como gostaria de v√™-la.  E ent√£o vou simplific√°-lo para o laborat√≥rio. <br><br><hr><br><br><h1>  Topologia f√≠sica </h1><br><h2>  Localiza√ß√µes </h2><br>  LAN_DC ter√° 6 DCs: <br><ul><li>  R√∫ssia ( <b>RU</b> ): <br><ul><li>  Moscovo ( <b>msk</b> ) </li><li>  Kazan ( <b>kzn</b> ) </li></ul><br></li><li>  Espanha ( <b>SP</b> ): <br><ul><li>  Barcelona ( <b>bcn</b> ) </li><li>  M√°laga ( <b>mlg</b> ) </li></ul><br></li><li>  China ( <b>CN</b> ): <br><ul><li>  Xangai ( <b>sha</b> ) </li><li>  Xian ( <b>sia</b> ) </li></ul><br></li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/c79/5f3/6f3/c795f36f3eb1553eaf32f909d570ed16.png" width="800"><br><hr><br><br><h2>  CC interna (Intra-DC) </h2><br>  Em todos os controladores de dom√≠nio, redes de conectividade interna id√™nticas baseadas na topologia Clos. <br>  Que tipo de redes s√£o Klose e por que elas est√£o em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> separado. <br><br>  Em cada CD h√° 10 racks com carros, eles ser√£o numerados como <b>A</b> , <b>B</b> , <b>C</b> E assim por diante. <br><br>  Cada rack tem 30 carros.  Eles n√£o v√£o nos interessar. <br><br>  Al√©m disso, em cada rack, h√° um comutador no qual todas as m√°quinas est√£o conectadas - este √© <b>o comutador Top of the Rack - ToR</b> ou, em termos da f√°brica da Klose, chamaremos de <b>Leaf</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e3a/5da/d17/e3a5dad17c7aadf1cf95865deaa8e359.png" width="800"><br>  <i>O esquema geral da f√°brica.</i> <br><br>  Vamos <i>cham√°-</i> los de <i><b>XXX-</b> folha <b>Y</b></i> , onde <b>XXX</b> √© a abrevia√ß√£o de tr√™s letras DC e <b>Y</b> √© o n√∫mero de s√©rie.  Por exemplo, <i>kzn-leaf11</i> . <br><blockquote>  Nos artigos, permito-me usar os termos Leaf e ToR de maneira bastante fr√≠vola, como sin√¥nimos.  No entanto, √© preciso lembrar que n√£o √© assim. <br>  ToR √© um comutador montado em rack ao qual as m√°quinas se conectam. <br>  Leaf √© o papel de um dispositivo em uma rede f√≠sica ou de um switch de primeiro n√≠vel em termos de topologia do Clos. <br>  Ou seja, Leaf! = ToR. <br>  Portanto, o Leaf pode ser um switch EndofRaw, por exemplo. <br>  No entanto, dentro da estrutura deste artigo, nos referiremos a eles como sin√¥nimos. <br></blockquote>  Cada switch ToR, por sua vez, √© conectado a quatro switches de agrega√ß√£o upstream - <b>Spine</b> .  Sob Spine'y alocou um rack no DC.  N√≥s o <i>nomearemos</i> da mesma maneira: <i><b>XXX</b> -spine <b>Y.</b></i> <br><br>  No mesmo rack, haver√° equipamentos de rede para conectividade entre roteadores DCs - 2 com MPLS a bordo.  Mas, em geral, esses s√£o os mesmos ToRs.  Ou seja, do ponto de vista dos Spine-switches, n√£o importa se existe um ToR comum com m√°quinas conectadas ou um roteador para DCI - uma coisa maldita. <br><br>  Esses ToRs especiais s√£o chamados <b>Edge-leaf</b> .  Vamos cham√°-los de <i><b>XXX-</b> edge <b>Y.</b></i> <br><br>  Ser√° assim. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/62c/83f/d27/62c83fd278227f1740e5cf4e64eaed4e.png" width="800"><br><br>  No diagrama acima da borda e da folha, eu realmente coloquei no mesmo n√≠vel.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">As redes cl√°ssicas de tr√™s n√≠veis</a> nos ensinaram a considerar o uplink (o termo √© realmente daqui), como links.  E aqui acontece que o "uplink" do DCI diminui, o que de certa forma quebra a l√≥gica usual.  No caso de grandes redes, quando os data centers s√£o divididos em unidades menores - <b>PODs</b> (Ponto de Entrega), <b>Edge-PODs</b> separados s√£o alocados para DCI e acesso a redes externas. <br><br>  Por conveni√™ncia, no futuro ainda vou desenhar Edge on Spine, embora tenhamos em mente que n√£o h√° intelig√™ncia sobre Spine e diferen√ßas ao trabalhar com Leaf e Edge-leaf comuns (embora possa haver nuances, mas em geral √© assim). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ca5/67d/9db/ca567d9db0c49c3baf63304443477102.png" width="600"><br>  <i>Layout de f√°brica com folhas de borda.</i> <br><br>  Trinity Leaf, Spine e Edge formam uma rede ou f√°brica de Underlay. <br><br>  A tarefa da f√°brica de rede (leia Underlay), como j√° determinamos na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">edi√ß√£o anterior</a> , √© muito, muito simples - fornecer conectividade IP entre m√°quinas, tanto no mesmo DC quanto no meio. <br>  √â por isso que a rede √© chamada de f√°brica, assim como, por exemplo, uma f√°brica de comuta√ß√£o dentro de caixas de rede modulares, que podem ser encontradas em mais detalhes no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SDSM14</a> . <br><blockquote>  Em geral, essa topologia √© chamada de f√°brica, porque a malha na tradu√ß√£o √© uma malha.  E √© dif√≠cil n√£o concordar: <br><img src="https://habrastorage.org/getpro/habr/post_images/7e9/db7/2c3/7e9db72c353e6b5b050eb63de72bb111.png" width="300"><br></blockquote><br>  F√°brica completamente L3.  Sem VLANs, sem transmiss√£o - estes s√£o √≥timos programadores em LAN_DC, eles podem escrever aplicativos que vivem no paradigma L3 e as m√°quinas virtuais n√£o exigem Live Migration ao salvar o endere√ßo IP. <br><br>  E novamente: a resposta √† pergunta por que a f√°brica e por que L3 - em um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> separado. <br><hr><br><br><h2>  DCI - Interconex√£o de Data Center (Inter-DC) </h2><br>  O DCI ser√° organizado usando Edge-Leaf, ou seja, eles s√£o nosso ponto de sa√≠da para a rodovia. <br>  Para simplificar, assumimos que os controladores de dom√≠nio estejam conectados por links diretos. <br>  Exclu√≠mos a conectividade externa da considera√ß√£o. <br><blockquote>  Estou ciente de que toda vez que removo um componente, simplifico bastante a rede.  E com a automa√ß√£o de nossa rede abstrata, tudo ficar√° bem, mas muletas aparecer√£o na rede real. <br>  Isso √© verdade.  No entanto, o objetivo desta s√©rie √© pensar e trabalhar em abordagens, e n√£o heroicamente resolver problemas imagin√°rios. <br></blockquote><br>  No Edge-Leafs, o underlay √© colocado na VPN e transmitido pelo backbone MPLS (o mesmo link direto). <br><br>  Aqui est√° um esquema de n√≠vel superior. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e4e/ad7/b78/e4ead7b7898490c29fa93f7375376aa8.png" width="800"><br><br><hr><br><br><h1>  Encaminhamento </h1><br><br>  Para roteamento dentro do controlador de dom√≠nio, usaremos o BGP. <br>  No tronco MPLS OSPF + LDP <br>  Para o DCI, ou seja, a organiza√ß√£o da conectividade na parte inferior √© BGP L3VPN sobre MPLS. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a55/3b1/30b/a553b130b286a50fd1c97fe8bb2b5b5b.png" width="800"><br>  <i>Esquema geral de roteamento</i> <br><br>  N√£o h√° OSPF e ISIS na f√°brica (protocolo de roteamento proibido na Federa√ß√£o Russa). <br><br>  E isso significa que n√£o haver√° descoberta autom√°tica e c√°lculos de caminho mais curto - apenas manual (de fato autom√°tico - estamos aqui sobre automa√ß√£o) configura√ß√µes de protocolo, vizinhan√ßa e pol√≠ticas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/82b/426/251/82b4262513aeae7c12d6e1618182f272.png" width="600"><br>  <i>Esquema de roteamento BGP dentro do DC</i> <br><br>  <b>Por que bgp?</b> <br><br>  Existe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">uma RFC inteira</a> chamada Facebook e Arista sobre esse assunto, que explica como construir redes <b>muito grandes</b> de data centers usando BGP.  L√™ quase como uma arte, recomendo para uma noite l√¢nguida. <br><br>  E uma se√ß√£o inteira no meu artigo √© dedicada a isso.  Para onde estou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">enviando voc√™</a> . <br><br>  Mas, em resumo, nenhum IGP √© adequado para redes de grandes centros de dados, onde milhares de dispositivos de rede contam. <br><br>  Al√©m disso, o uso do BGP em qualquer lugar permite que voc√™ n√£o use o suporte de v√°rios protocolos diferentes e a sincroniza√ß√£o entre eles. <br><blockquote>  De cora√ß√£o, em nossa f√°brica, que com um alto grau de probabilidade n√£o crescer√° rapidamente, a OSPF seria suficiente para os olhos.  Na verdade, esses s√£o os problemas dos megascalers e dos tit√£s das nuvens.  Mas vamos imaginar alguns problemas de que precisamos e usaremos o BGP, como Peter Lapukhov legou. <br></blockquote><br><hr><br><br><h2>  Pol√≠ticas de roteamento </h2><br>  Nos comutadores Leaf, importamos para prefixos BGP as interfaces Underlay com redes. <br>  Teremos uma sess√£o BGP entre <b>cada</b> par Leaf-Spine, na qual esses prefixos de Underlay ser√£o anunciados em uma rede de po√ßas. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/85a/4b0/38d/85a4b038dc57c9fc54f1fb1ad10a5172.png" width="800"><br><br>  Dentro de um data center, distribuiremos os detalhes importados para o ToRe.  No Edge-Leafs, n√≥s os agregaremos e os anunciaremos em controladores remotos e os reduziremos a ToRs.  Ou seja, cada ToR saber√° exatamente como chegar a outro ToR no mesmo CD e onde √© o ponto de entrada para chegar ao ToR em outro CD. <br><br>  No DCI, as rotas ser√£o transmitidas como VPNv4.  Para fazer isso, no Edge-Leaf, a interface da f√°brica ser√° colocada em VRF, vamos cham√°-lo de UNDERLAY, e o bairro com Spine no Edge-Leaf surgir√° dentro do VRF e entre os Edge-Leafs na fam√≠lia VPNv4. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/231/d58/9d6/231d589d6ae0bcd63e4f60028771cd95.png" width="800"><br><br>  E tamb√©m proibiremos o an√∫ncio de rotas recebidas de espinhos, de volta a eles. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f0/f41/dfa/3f0f41dfa8510d48849ef8743f5b757a.png" width="500"><br><br>  No Leaf and Spine, n√£o importaremos Loopbacks.  Precisamos deles apenas para determinar o ID do roteador. <br><br>  Mas no Edge-Leafs n√≥s o importamos para o BGP Global.  Entre os endere√ßos de loopback, o Edge Leafs estabelecer√° uma sess√£o BGP na fam√≠lia de VPN IPv4 entre si. <br><br>  Entre os dispositivos EDGE, teremos um backbone OSPF + LDP.  Tudo em uma zona.  Configura√ß√£o extremamente simples. <br><br>  Aqui est√° uma imagem do roteamento. <br><hr><br><br><h2>  BGP ASN </h2><br><h3>  Edge-Leaf ASN </h3><br>  No Edge-Leafs, haver√° um ASN em todos os CDs.  √â importante que exista iBGP entre as folhas de bordo e que n√£o nos deparemos com as nuances do eBGP.  Que seja 65535. Na realidade, poderia ser um n√∫mero p√∫blico AS. <br><br><h3>  Spine ASN </h3><br>  Na Spine, teremos um ASN por DC.  Vamos come√ßar aqui a partir do primeiro n√∫mero do intervalo AS privado - 64512, 64513 E assim por diante. <br><br>  Por que o ASN est√° em DC? <br><br>  Decompomos esta quest√£o em duas: <br><br><ul><li>  Por que os mesmos ASNs est√£o em todos os espinhos do mesmo controlador de dom√≠nio? </li><li>  Por que eles s√£o diferentes em diferentes CDs? </li></ul><br>  <b>Por que os mesmos ASNs em todos os espinhos de um DC</b> <br><br>  Aqui est√° a apar√™ncia da rota Anderlay do AS-Path no Edge-Leaf: <br> <code>[leafX_ASN, <b>spine_ASN</b> , edge_ASN]</code> <br>  Se voc√™ tentar anunciar de volta ao Spine, ele ser√° descartado porque o AS (Spine_AS) j√° est√° na lista. <br><br>  No entanto, dentro do CD, estamos completamente satisfeitos que as rotas do Underlay que subiram ao Edge n√£o ser√£o capazes de descer.  Toda a comunica√ß√£o entre os hosts no DC deve ocorrer dentro do n√≠vel da coluna vertebral. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0b3/cec/64c/0b3cec64c8666b0154f041bd64c9059b.png" width="800"><br><br>  Ao mesmo tempo, as rotas agregadas de outros controladores de dom√≠nio, em qualquer caso, atingir√£o livremente os ToRs - em seu caminho AS haver√° apenas ASN 65535 - o n√∫mero de AS Edge-Leafs, porque foi neles que eles foram criados. <br><br>  <b>Por que s√£o diferentes em diferentes DC</b> <br><br>  Teoricamente, podemos precisar arrastar Loopbacks e algumas m√°quinas virtuais de servi√ßo entre os controladores de dom√≠nio. <br><br>  Por exemplo, em um host, executaremos um Route Reflector ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o mesmo VNGW</a> (Virtual Network Gateway), que ser√° bloqueado com o ToR via BGP e anunciar√° seu loopback, que deve estar dispon√≠vel em todos os controladores de dom√≠nio. <br><br>  Ent√£o, aqui est√° a apar√™ncia do seu AS-Path: <br> <code>[VNF_ASN, leafX_DC1_ASN, <b>spine_DC1_ASN</b> , edge_ASN, <b>spine_DC2_ASN</b> , leafY_DC2_ASN]</code> <br> <br>  E aqui n√£o deve haver ASNs duplicados em nenhum lugar. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fee/b97/61f/feeb9761f4964eda7f7519464927f61e.png" width="800"><br><br>  Ou seja, Spine_DC1 e Spine_DC2 devem ser diferentes, assim como leafX_DC1 e leafY_DC2, que √© exatamente o que estamos abordando. <br><blockquote>  Como voc√™ provavelmente sabe, existem hacks que permitem aceitar rotas com ASNs repetidos, apesar do mecanismo de preven√ß√£o de loopback da Cisco.  E tem usos at√© bastante leg√≠timos.  Mas essa √© uma viola√ß√£o potencial na resili√™ncia da rede.  E eu pessoalmente ca√≠ nele algumas vezes. <br><br>  E se tivermos a oportunidade de n√£o usar coisas perigosas, vamos us√°-lo. <br></blockquote><br><h3>  Asn da folha </h3><br>  Teremos um ASN individual em cada switch Leaf em toda a rede. <br>  Fazemos isso pelos motivos acima: AS-Path sem loops, configura√ß√£o BGP sem marcadores. <br><br>  Para que as rotas entre Leafs passem sem obst√°culos, o AS-Path deve se parecer com o seguinte: <br> <code>[leafX_ASN, spine_ASN, leafY_ASN]</code> <br>  onde leafX_ASN e leafY_ASN seria bom ser diferente. <br><br>  Isso tamb√©m √© necess√°rio para a situa√ß√£o com o an√∫ncio do loopback do VNF entre controladores de dom√≠nio: <br> <code>[VNF_ASN, <b>leafX_DC1_ASN</b> , spine_DC1_ASN, edge_ASN, spine_DC2_ASN, <b>leafY_DC2_ASN</b> ]</code> <br> <br>  Usaremos o ASN de 4 bytes e o geraremos com base no n√∫mero do ASN e do comutador de folhas da Spine, ou seja, assim: <i>Spine_ASN.0000X</i> . <br><hr><br><br>  Aqui est√° uma foto com o ASN. <br><img src="https://habrastorage.org/getpro/habr/post_images/c4a/f3b/66c/c4af3b66cff4bb0589ee0c6ef98134cf.png" width="800"><br><hr><br><br><h1>  Plano IP </h1><br><br>  Basicamente, precisamos alocar endere√ßos para as seguintes conex√µes: <br><br><ol><li>  Underlay os endere√ßos de rede entre o ToR e a m√°quina.  Eles devem ser √∫nicos em toda a rede para que qualquer m√°quina possa se comunicar com outra.  √ìtimo para <b>10/8</b> .  Para cada rack / 26 com uma margem.  Alocaremos / 19 para DC e / 17 para a regi√£o. <br></li><li>  Endere√ßos de link entre Leaf / Tor e Spine. <br><br>  Gostaria de atribu√≠-los algoritmicamente, ou seja, calcular a partir dos nomes dos dispositivos que precisam ser conectados. <br><br>  Que seja ... 169.254.0.0/16. <br>  Ou seja, <b>169.254.00X.Y / 31</b> , onde <b>X</b> √© o n√∫mero da coluna, <b>Y</b> √© a rede P2P / 31. <br>  Isso permitir√° que voc√™ execute at√© 128 racks e at√© 10 Spine no DC.  Os endere√ßos de link podem (e ser√£o) repetidos de DC para DC. </li><li>  Organizaremos a articula√ß√£o Spine - Edge-Leaf nas sub-redes <b>169.254.10X.Y / 31</b> , onde da mesma maneira <b>X</b> √© o n√∫mero da coluna, <b>Y</b> √© a rede P2P / 31. </li><li>  Vincule endere√ßos do Edge-Leaf ao backbone do MPLS.  Aqui a situa√ß√£o √© um pouco diferente - o lugar de conectar todas as pe√ßas em uma torta, para que a reutiliza√ß√£o dos mesmos endere√ßos n√£o funcione - voc√™ precisa selecionar a pr√≥xima sub-rede livre.  Portanto, tomaremos <b>192.168.0.0/16</b> como base e extrairemos os livres. </li><li>  Endere√ßos de loopback.  D√™ a eles todo o intervalo <b>172.16.0.0/12</b> . <br><ul><li>  Folha - a / 25 por CC - os mesmos 128 racks.  Aloque por / 23 para a regi√£o. </li><li>  Spine - by / 28 no CD - at√© 16 Spine.  Aloque por / 26 para a regi√£o. </li><li>  Edge-Leaf - por / 29 no DC - at√© 8 caixas.  Aloque por / 27 para a regi√£o. </li></ul></li></ol><br>  Se no CD n√£o tivermos o suficiente dos intervalos selecionados (mas eles n√£o estar√£o l√° - fingimos ser hiper-skeylerostvo), basta selecionar o pr√≥ximo bloco. <br><br>  Aqui est√° uma foto com endere√ßamento IP. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/def/f08/e49/deff08e49e0fee39e0799dfac4fad2a4.png" width="800"><br><br>  Loopbacks: <br><table border="2"><tbody><tr><td>  <b>Prefixo</b> </td><td>  <b>Fun√ß√£o do dispositivo</b> </td><td>  <b>Regi√£o</b> </td><td>  <b>DC</b> </td></tr><tr><td>  172.16.0.0/23 </td><td rowspan="10">  orla </td><td></td><td></td></tr><tr><td>  172.16.0.0/27 </td><td rowspan="3">  ru </td><td></td></tr><tr><td>  172.16.0.0/29 </td><td>  msk </td></tr><tr><td>  172.16.0.8/29 </td><td>  kzn </td></tr><tr><td>  172.16.0.32/27 </td><td rowspan="3">  sp </td><td></td></tr><tr><td>  172.16.0.32/29 </td><td>  bcn </td></tr><tr><td>  172.16.0.40/29 </td><td>  mlg </td></tr><tr><td>  172.16.0.64/27 </td><td rowspan="3">  cn </td><td></td></tr><tr><td>  172.16.0.64/29 </td><td>  sha </td></tr><tr><td>  172.16.0.72/29 </td><td>  sia </td></tr><tr><td>  172.16.2.0/23 </td><td rowspan="10">  coluna vertebral </td><td></td><td></td></tr><tr><td>  172.16.2.0/26 </td><td rowspan="3">  ru </td><td></td></tr><tr><td>  172.16.2.0/28 </td><td>  msk </td></tr><tr><td>  172.16.2.16/28 </td><td>  kzn </td></tr><tr><td>  172.16.2.64/26 </td><td rowspan="3">  sp </td><td></td></tr><tr><td>  172.16.2.64/28 </td><td>  bcn </td></tr><tr><td>  172.16.2.80/28 </td><td>  mlg </td></tr><tr><td>  172.16.2.128/26 </td><td rowspan="3">  cn </td><td></td></tr><tr><td>  172.16.2.128/28 </td><td>  sha </td></tr><tr><td>  172.16.2.144/28 </td><td>  sia </td></tr><tr><td>  172.16.8.0/21 </td><td rowspan="10">  folhagem </td><td></td><td></td></tr><tr><td>  172.16.8.0/23 </td><td rowspan="3">  ru </td><td></td></tr><tr><td>  172.16.8.0/25 </td><td>  msk </td></tr><tr><td>  172.16.8.128/25 </td><td>  kzn </td></tr><tr><td>  172.16.10.0/23 </td><td rowspan="3">  sp </td><td></td></tr><tr><td>  172.16.10.0/25 </td><td>  bcn </td></tr><tr><td>  172.16.10.128/25 </td><td>  mlg </td></tr><tr><td>  172.16.12.0/23 </td><td rowspan="3">  cn </td><td></td></tr><tr><td>  172.16.12.0/25 </td><td>  sha </td></tr><tr><td>  172.16.12.128/25 </td><td>  sia </td></tr></tbody></table><br><br>  Underlay: <br><table border="2"><tbody><tr><td>  <b>Prefixo</b> </td><td>  <b>Regi√£o</b> </td><td>  <b>DC</b> </td></tr><tr><td>  10.0.0.0/17 </td><td rowspan="3">  ru </td><td></td></tr><tr><td>  10.0.0.0/19 </td><td>  msk </td></tr><tr><td>  10.0.32.0/19 </td><td>  kzn </td></tr><tr><td>  10.0.128.0/17 </td><td rowspan="3">  sp </td><td></td></tr><tr><td>  10.0.128.0/19 </td><td>  bcn </td></tr><tr><td>  10.0.160.0/19 </td><td>  mlg </td></tr><tr><td>  10.1.0.0/17 </td><td rowspan="3">  cn </td><td></td></tr><tr><td>  10.1.0.0/19 </td><td>  sha </td></tr><tr><td>  10.1.32.0/19 </td><td>  sia </td></tr></tbody></table><br><hr><br><br><h1>  Laba </h1><br>  Dois fornecedores.  Uma rede  ADSM. <br><br>  Juniper + Arista.  Ubuntu  Boa e velha Eva. <br><br>  A quantidade de recursos em nosso virtual em Miran ainda √© limitada, portanto, para a pr√°tica, usaremos uma rede t√£o simplificada at√© o limite. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/477/a27/096/477a2709633866d53fec5972e9417421.png" width="800"><br><br>  Dois data centers: Kazan e Barcelona. <br><br><ul><li>  Dois espinhos em cada um: Juniper e Arista. </li><li>  Um toro (Leaf) em cada um - Juniper e Arista, com um host conectado (vamos usar a Cisco IOL leve para isso). </li><li>  Um n√≥ Edge-Leaf (apenas Juniper at√© o momento). </li><li>  Um switch da Cisco para governar todos eles. </li><li>  Al√©m das caixas de rede, uma m√°quina virtual de gerenciamento foi lan√ßada.  Executando o Ubuntu. <br>  Ele tem acesso a todos os dispositivos, sistemas IPAM / DCIM, v√°rios scripts Python, ansible e qualquer outra coisa que possamos precisar estar√° girando nele. </li></ul><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A configura√ß√£o completa de</a> todos os dispositivos de rede que tentaremos reproduzir usando a automa√ß√£o. <br><hr><br><br><h1>  Conclus√£o </h1><br>  Tamb√©m aceita?  Sob cada artigo para fazer uma breve conclus√£o? <br><br>  Por isso, escolhemos a rede Klose de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tr√™s n√≠veis</a> dentro do DC, porque esperamos muito tr√°fego Leste-Oeste e queremos ECMP. <br><br>  Dividimos a rede em f√≠sico (underlay) e virtual (overlay).  Nesse caso, a sobreposi√ß√£o come√ßa no host - simplificando, assim, os requisitos para a subjac√™ncia. <br><br>  Escolhemos o BGP como o protocolo de roteamento para redes n√£o retransmitidas por sua escalabilidade e flexibilidade de pol√≠ticas. <br><br>  Teremos n√≥s separados para a organiza√ß√£o do DCI - Edge-leaf. <br>  Haver√° OSPF + LDP no tronco. <br>  O DCI ser√° implementado com base no MPLS L3VPN. <br>  Para links P2P, calcularemos os endere√ßos IP algoritmicamente com base nos nomes dos dispositivos. <br>  Os Lupbacks ser√£o atribu√≠dos pela fun√ß√£o dos dispositivos e sua localiza√ß√£o sequencialmente. <br>  Prefixos de subjac√™ncia - somente nos comutadores Leaf, sequencialmente, com base em sua localiza√ß√£o. <br><br>  Suponha que n√£o temos o equipamento instalado no momento. <br>  Portanto, nossos pr√≥ximos passos ser√£o coloc√°-los nos sistemas (IPAM, invent√°rio), organizar o acesso, gerar uma configura√ß√£o e implant√°-la. <br><br>  No pr√≥ximo artigo, trataremos do Netbox, o sistema de gerenciamento de invent√°rio e espa√ßo IP no controlador de dom√≠nio. <br><hr><br><br><h1>  Obrigado </h1><br><ul><li>  Andrey Glazkov, tamb√©m conhecido como @glazgoo, para revis√£o e edi√ß√£o </li><li>  Alexander Klimenko, tamb√©m conhecido como @ v00lk, para revis√£o e edi√ß√£o </li><li>  Artyom Chernobay para KDPV </li></ul><br><hr></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt475614/">https://habr.com/ru/post/pt475614/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt475600/index.html">Como conectamos Prometheus</a></li>
<li><a href="../pt475604/index.html">Configurando o modelo oficial do PostgreSQL no Zabbix 4.4</a></li>
<li><a href="../pt475608/index.html">Gerenciador de tags do Google: configura√ß√µes de gatilho n√£o √≥bvias e √∫teis</a></li>
<li><a href="../pt475610/index.html">Candeeiros de mesa LED seguros que mant√™m a vis√£o</a></li>
<li><a href="../pt475612/index.html">Dado, quando, afirma√ß√µes e confian√ßa na implementa√ß√£o</a></li>
<li><a href="../pt475618/index.html">Como escrever um contrato Python inteligente na rede Ontology. Parte 2: API de armazenamento</a></li>
<li><a href="../pt475622/index.html">Estendendo o UObject no Unreal Engine 4</a></li>
<li><a href="../pt475624/index.html">PHP-Watcher: uma ferramenta que simplifica o desenvolvimento de aplicativos de longa dura√ß√£o</a></li>
<li><a href="../pt475626/index.html">Os autotestes podem substituir uma pessoa em busca de vulnerabilidades: entrevista com Alexandra Svatikova</a></li>
<li><a href="../pt475630/index.html">Knative - uma plataforma baseada em k8s como um servi√ßo com suporte sem servidor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>