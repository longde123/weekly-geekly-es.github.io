<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßòüèª üòà üõåüèΩ Comment Kafka est devenu r√©alit√© üö¢ ü¶é ü•å</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! 


 Je travaille dans l'√©quipe Tinkoff, qui d√©veloppe son propre centre de notification. Pour la plupart, je d√©veloppe en Java en utili...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment Kafka est devenu r√©alit√©</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/tinkoff/blog/481784/"><p><img src="https://habrastorage.org/webt/d1/z0/m1/d1z0m1b3kvl5hobn4_4nnxuxc3o.png"></p><br><p>  Bonjour, Habr! </p><br><p>  Je travaille dans l'√©quipe Tinkoff, qui d√©veloppe son propre centre de notification.  Pour la plupart, je d√©veloppe en Java en utilisant Spring Boot et je r√©sous divers probl√®mes techniques qui surviennent dans le projet. </p><br><p>  La plupart de nos microservices interagissent de mani√®re asynchrone les uns avec les autres via un courtier de messages.  Auparavant, nous utilisions IBM MQ en tant que courtier, qui a cess√© de faire face √† la charge, mais en m√™me temps, avait des garanties de livraison √©lev√©es. </p><br><p>  En remplacement, Apache Kafka nous a √©t√© propos√©, qui a une grande √©volutivit√©, mais, malheureusement, n√©cessite une approche de configuration presque individuelle pour diff√©rents sc√©narios.  De plus, le m√©canisme de livraison au moins une fois, qui fonctionne par d√©faut dans Kafka, n'a pas permis de maintenir le niveau de coh√©rence requis hors de la bo√Æte.  Ensuite, je partagerai notre exp√©rience dans la configuration de Kafka, en particulier, je vous dirai comment configurer et vivre avec une seule livraison. </p><a name="habracut"></a><br><h2 id="garantirovannaya-dostavka-i-ne-tolko">  Livraison garantie et plus </h2><br><p>  Les param√®tres qui seront discut√©s plus tard permettront d'√©viter un certain nombre de probl√®mes avec les param√®tres de connexion par d√©faut.  Mais d'abord, je veux faire attention √† un param√®tre qui facilitera un √©ventuel d√©bogage. </p><br><p>  <strong>Client.id</strong> pour le producteur et le consommateur vous y aidera.  √Ä premi√®re vue, vous pouvez utiliser le nom de l'application comme valeur, et dans la plupart des cas, cela fonctionnera.  Bien que la situation lorsque plusieurs consommateurs sont utilis√©s dans l'application et que vous leur donnez le m√™me client.id m√®ne √† l'avertissement suivant: </p><br><pre><code class="java hljs">org.apache.kafka.common.utils.AppInfoParser ‚Äî Error registering AppInfo mbean javax.management.InstanceAlreadyExistsException: kafka.consumer:type=app-info,id=kafka.test-<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Si vous souhaitez utiliser JMX dans une application avec Kafka, cela peut √™tre un probl√®me.  Dans ce cas, il est pr√©f√©rable d'utiliser une combinaison du nom de l'application et, par exemple, du nom de rubrique, comme valeur de client.id.  Le r√©sultat de notre configuration est visible dans la sortie de la commande <strong>kafka-consumer-groups</strong> des utilitaires de Confluent: </p><br><p><img src="https://habrastorage.org/webt/1e/qh/1z/1eqh1zw485osmsizmx6gu9_d8ne.png"></p><br><p>  Nous allons maintenant analyser le sc√©nario de livraison garantie des messages.  Kafka Producer a un param√®tre <strong>acks</strong> qui vous permet de configurer apr√®s combien d'acquittements le chef de cluster doit consid√©rer le message enregistr√© avec succ√®s.  Ce param√®tre peut prendre les valeurs suivantes: </p><br><ul><li>  0 - accus√© de r√©ception ne sera pas pris en consid√©ration. </li><li>  1 - param√®tre par d√©faut, un accus√© de r√©ception est requis √† partir d'une seule r√©plique. </li><li>  ‚àí1 - un accus√© de r√©ception est requis de toutes les r√©pliques synchronis√©es ( <strong>configuration de</strong> cluster <strong>min.insync.replicas</strong> ). </li></ul><br><p>  Il peut √™tre vu √† partir des valeurs ci-dessus que acks √©gal √† -1 donne les meilleures garanties que le message ne sera pas perdu. </p><br><p>  Comme nous le savons tous, les syst√®mes distribu√©s ne sont pas fiables.  Pour se prot√©ger contre les dysfonctionnements temporaires, Kafka Producer fournit un param√®tre de nouvelles <strong>tentatives</strong> qui vous permet de d√©finir le nombre de tentatives de relance pendant <strong>delivery.timeout.ms</strong> .  √âtant donn√© que le param√®tre retries par d√©faut est Integer.MAX_VALUE (2147483647), le nombre de retransmissions d'un message peut √™tre contr√¥l√© en modifiant uniquement delivery.timeout.ms. </p><br><h2 id="dvizhemsya-k-exactly-once-delivery">  Vers une livraison exactement une fois </h2><br><p>  Ces param√®tres permettent √† notre producteur de d√©livrer des messages avec une garantie √©lev√©e.  Voyons maintenant comment garantir l'enregistrement d'une seule copie d'un message dans un sujet Kafka?  Dans le cas le plus simple, pour ce faire sur Producer, d√©finissez le param√®tre <strong>enable.idempotence</strong> sur true.  Idempotency garantit l'enregistrement d'un seul message dans une partition particuli√®re d'un sujet.  Une condition pr√©alable √† l'activation de l'idempotence est <strong>acks = all, r√©essayez&gt; 0, max.in.flight.requests.per.connection ‚â§ 5</strong> .  Si ces param√®tres ne sont pas d√©finis par le d√©veloppeur, les valeurs ci-dessus seront automatiquement d√©finies. </p><br><p>  Lorsque idempotency est configur√©, il est n√©cessaire de s'assurer que les m√™mes messages tombent √† chaque fois dans les m√™mes partitions.  Cela peut √™tre fait en configurant la cl√© et le param√®tre partitioner.class sur Producer.  Commen√ßons par la cl√©.  Pour chaque envoi, il doit √™tre le m√™me.  Ceci est facilement r√©alis√© en utilisant n'importe quel identifiant d'entreprise du message d'origine.  Le param√®tre partitioner.class a la valeur par d√©faut <a href="">DefaultPartitioner</a> .  Avec cette strat√©gie de partitionnement, le comportement par d√©faut est le suivant: </p><br><ul><li>  Si la partition est explicitement sp√©cifi√©e lors de l'envoi du message, nous l'utilisons. </li><li>  Si la partition n'est pas sp√©cifi√©e, mais que la cl√© est sp√©cifi√©e, s√©lectionnez la partition par hachage dans la cl√©. </li><li>  Si la partition et la cl√© ne sont pas sp√©cifi√©es, s√©lectionnez les partitions tour √† tour (round-robin). </li></ul><br><p>  De plus, l'utilisation de la cl√© et l'envoi idempotent avec le param√®tre <strong>max.in.flight.requests.per.connection = 1</strong> vous donne un traitement ordonn√© des messages sur Consumer.  S√©par√©ment, il convient de se rappeler que si le contr√¥le d'acc√®s est configur√© sur votre cluster, vous aurez alors besoin des droits d'√©criture idempotente sur le sujet. </p><br><p>  Si vous manquez soudainement des capacit√©s d'envoi idempotent par cl√© ou si la logique du c√¥t√© producteur n√©cessite la pr√©servation de la coh√©rence des donn√©es entre les diff√©rentes partitions, les transactions viendront √† la rescousse.  De plus, √† l'aide d'une transaction en cha√Æne, vous pouvez synchroniser conditionnellement un enregistrement dans Kafka, par exemple, avec un enregistrement dans la base de donn√©es.  Pour activer l'envoi transactionnel au producteur, il est n√©cessaire qu'il poss√®de l'idempotency, et √©ventuellement d√©finissez <strong>transactional.id</strong> .  Si le contr√¥le d'acc√®s est configur√© sur votre cluster Kafka, alors pour l'enregistrement transactionnel, ainsi que pour idempotent, vous aurez besoin d'autorisations d'√©criture, qui peuvent √™tre accord√©es par masque en utilisant la valeur stock√©e dans transactional.id. </p><br><p>  Formellement, n'importe quelle cha√Æne peut √™tre utilis√©e comme identifiant de transaction, par exemple, le nom d'une application.  Mais si vous ex√©cutez plusieurs instances de la m√™me application avec le m√™me transactional.id, la premi√®re instance lanc√©e sera arr√™t√©e avec une erreur, car Kafka le consid√©rera comme un processus zombie. </p><br><pre> <code class="java hljs">org.apache.kafka.common.errors.ProducerFencedException: Producer attempted an operation with an old epoch. Either there is a newer producer with the same transactionalId, or the producer<span class="hljs-string"><span class="hljs-string">'s transaction has been expired by the broker.</span></span></code> </pre> <br><p>  Pour r√©soudre ce probl√®me, nous ajoutons un suffixe au nom de l'application sous la forme du nom d'h√¥te, qui est obtenu √† partir des variables d'environnement. </p><br><p>  Le producteur est configur√©, mais les transactions sur Kafka ne contr√¥lent que la port√©e du message.  Quel que soit le statut de la transaction, le message tombe imm√©diatement dans la rubrique, mais poss√®de des attributs syst√®me suppl√©mentaires. </p><br><p>  Pour emp√™cher que de tels messages soient lus √† l'avance par Consumer, il doit d√©finir le param√®tre <strong>isolation.level</strong> sur read_committed.  Un tel consommateur pourra lire les messages non transactionnels comme auparavant, et les messages transactionnels uniquement apr√®s une validation. <br>  Si vous avez install√© tous les param√®tres r√©pertori√©s ci-dessus, vous avez configur√© exactement une fois la livraison.  F√©licitations! </p><br><p>  Mais il y a encore une nuance.  Transactional.id, que nous avons configur√© ci-dessus, est en fait un pr√©fixe de transaction.  Sur le gestionnaire de transactions, un num√©ro de s√©rie lui est ajout√©.  L'identifiant re√ßu est √©mis sur <strong>transactional.id.expiration.ms</strong> , qui est configur√© sur le cluster Kafka et a une valeur par d√©faut de "7 jours".  Si pendant ce temps l'application n'a re√ßu aucun message, alors lorsque vous essayez le prochain envoi transactionnel, vous recevrez une <strong>exception InvalidPidMappingException</strong> .  Apr√®s cela, le coordinateur de transaction √©mettra un nouveau num√©ro de s√©quence pour la prochaine transaction.  Toutefois, le message peut √™tre perdu si l'InvalidPidMappingException n'est pas correctement trait√©. </p><br><h2 id="vmesto-itogov">  Au lieu de totaux </h2><br><p>  Comme vous pouvez le voir, il ne suffit pas d'envoyer des messages √† Kafka.  Vous devez choisir une combinaison de param√®tres et √™tre pr√™t √† effectuer des changements rapides.  Dans cet article, j'ai essay√© de montrer en d√©tail les param√®tres de livraison une seule fois et j'ai d√©crit plusieurs probl√®mes de configuration client.id et transactional.id que nous avons rencontr√©s.  Le r√©sum√© des param√®tres Producteur et Consommateur est r√©sum√© ci-dessous. </p><br><p>  Producteur: </p><br><ol><li>  acks = tout </li><li>  nouvelles tentatives&gt; 0 </li><li>  enable.idempotence = true </li><li>  max.in.flight.requests.per.connection ‚â§ 5 (1 - pour l'envoi ordonn√©) </li><li>  transactional.id = $ {nom-application} - $ {hostname} </li></ol><br><p>  Consommateur: </p><br><ol><li>  isolation.level = read_committed </li></ol><br><p>  Pour minimiser les erreurs dans les applications futures, nous avons cr√©√© notre wrapper sur la configuration du ressort, o√π les valeurs de certains des param√®tres r√©pertori√©s sont d√©j√† d√©finies. </p><br><p>  Et voici quelques documents pour une √©tude ind√©pendante: </p><br><ul><li>  <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98%2B-%2BExactly%2BOnce%2BDelivery%2Band%2BTransactional%2BMessaging">KIP-98 - Livraison exacte et messagerie transactionnelle</a> </li><li>  <a href="https://kafka.apache.org/documentation/">Description des param√®tres</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr481784/">https://habr.com/ru/post/fr481784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr481768/index.html">Nous traitons WebKit dans 1C, par exemple, l'int√©gration de TinyMCE dans un formulaire g√©r√© dans UT 11.4</a></li>
<li><a href="../fr481776/index.html">Services de jeux 5G et cloud - testez comment cela fonctionne √† Moscou</a></li>
<li><a href="../fr481778/index.html">Analyse des logiciels malveillants Skeleton Key</a></li>
<li><a href="../fr481780/index.html">MyOffice a plus de 200 nouvelles fonctionnalit√©s</a></li>
<li><a href="../fr481782/index.html">A propos des probl√®mes de traducteur Python et repenser la langue</a></li>
<li><a href="../fr481786/index.html">Google enterre l'extension PHP IMAP</a></li>
<li><a href="../fr481788/index.html">Analyse de la r√©solution de probl√®mes r√©els de l'industrie (sauver des porcelets et autres)</a></li>
<li><a href="../fr481790/index.html">Comment la tricherie change la communaut√© des speedrunners</a></li>
<li><a href="../fr481792/index.html">Comment PVS-Studio a organis√© la seconde moiti√© des conf√©rences 2019</a></li>
<li><a href="../fr481794/index.html">Beckender - un psychoth√©rapeute: un d√©bogueur pour la psych√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>