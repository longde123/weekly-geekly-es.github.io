<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üìÉ üéÅ üòä Panneau QtQML / Quick correlation üßòüèΩ üßê üëáüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! Je suis chef d'√©quipe pour le d√©veloppement d'applications bureautiques au sein de la soci√©t√© Rogia Europe. Nous d√©veloppons des solut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Panneau QtQML / Quick correlation</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480334/"><p>  Bonjour √† tous!  Je suis chef d'√©quipe pour le d√©veloppement d'applications bureautiques au sein de la soci√©t√© Rogia Europe.  Nous d√©veloppons des solutions logicielles pour l'industrie p√©troli√®re et gazi√®re. </p><br><p>  Il se trouve que notre produit phare StarSteer n'a pas de panneau de corr√©lation - un outil classique pour les guides de puits.  La t√¢che a √©t√© report√©e pendant longtemps √† cause d'autres t√¢ches plus prioritaires, mais l'automne dernier, nous avons finalement pu la d√©marrer. </p><br><p> Contourner les questions de la base de code h√©rit√©e - je le mentionnerai dans l'article - il y avait une question fondamentale - quelle technologie devrais-je utiliser?  Nous avions absolument besoin d'OpenGL - qui est d√©j√† utilis√© dans MapView et la vue 3D bas√©e sur OpenSceneGraph - mais il est √©vident qu'il n'est pas nu, et avec des √©l√©ments d'interface graphique.  OSG est tomb√© = (. Une technologie qui r√©pond √† deux exigences - graphique de sc√®ne et GUI sur OpenGL - je n'en connaissais qu'une - Qt QML / Quick. √Ä propos de ce que nous avons et de ce que nous devons partager - √† l'int√©rieur. <a name="habracut"></a></p><br><h3 id="vstuplenie">  Entr√©e </h3><br><p>  Nous avons commenc√© √† d√©velopper le produit √† l'automne 2013.  Quel ensemble de biblioth√®ques utiliser pour moi, en tant que fan de Qt, n'√©tait m√™me pas une question.  A ce moment, la question pourrait se poser: utiliser la 4√®me ou la 5√®me version (encore assez r√©cente) de Qt.  Nous avons choisi le cinqui√®me et du haut de notre vol je ne peux que dire: Dieu merci! </p><br><p>  L'ensemble du look est d√©velopp√© sur QtGui / Widgets.  Toutes les sc√®nes o√π des graphiques sont affich√©s (gamma, porosit√©, r√©sistance, etc.) sont r√©alis√©es sur QGraphicsScene / View.  Mon conseil est - n'utilisez pas ce bundle pour des choses s√©rieuses!  Arguments: barres de d√©filement et non d√©connect√© de l'ext√©rieur (il est √† l'ext√©rieur sans les <a href="">propres</a> modifications de Qt) pour centrer la sc√®ne ( <a href="">qgraphicsview.cpp +458</a> et plus dans la m√™me m√©thode pour horizontal; <a href="">qgraphicsview.cpp +3816</a> - quel contr√¥le sur la matrice).  Si cela ne vous d√©range pas, utilisez - beaucoup de pi√®ces pratiques de la bo√Æte. </p><br><p>  Quoi d'autre √† ne pas utiliser?  NSIS. </p><br><p>  Tout √©tait parfait, le produit se d√©veloppait, les t√¢ches se faisaient, le nombre de clients augmentait.  Refactoring ... En g√©n√©ral, apr√®s un certain temps, QGraphicsScene a commenc√© √† interf√©rer avec nous - nous n'√©tions pas press√©s d'optimiser le dessin de graphiques de 40000 points, lorsque les lignes √©paisses √©taient activ√©es - tout ce truc sur le CPU √©tait tr√®s lent. </p><br><p>  En cours de route, nous nous sommes lass√©s de d√©velopper GUY sur des widgets.  Soit avec vos mains compl√®tement dans le code, soit un peu dans le concepteur (de Creator, <em>.ui +</em> .cpp).  Je voulais des trucs modernes, comme une description d√©clarative de l'interface graphique. </p><br><p>  Faire une liste des technologies sur lesquelles nous allons faire: </p><br><ul><li>  l'ancienne m√©thode sur QGraphicsView / Scene; </li><li>  pour chaque piste, utilisez un QOpenGLWidget nu s√©par√©; </li><li>  impl√©menter toute la fen√™tre sur QOpenGLWidget, mais l'interface graphique par nous-m√™mes (ou trouver quelque chose); </li><li>  deux points pr√©c√©dents + OSG respectivement; </li><li>  Qt QML / Quick, </li></ul><br><p>  seulement six points;  discut√©.  Mon charisme l'emportait et j'ai d√©cid√© d'essayer de voir comment le prototype en QML se comportait. </p><br><h3 id="prototip">  Prototype </h3><br><p>  J'ai ouvert un exemple de scenegraph \ graph.  Regard√© et ferm√© =).  J'ai jou√© pendant plusieurs jours, j'ai regard√© d'autres exemples, mais rien n'a approch√© mon objectif ch√©ri. </p><br><p>  Et que fallait-il alors?  Voici √† quoi pourrait ressembler le panneau de corr√©lation: </p><br><ul><li>  premier exemple: <a href="">Well correlation1.png</a> (√† partir de la page <a href="https://geosteering.ru/software/geosteering-office.html">https://geosteering.ru/software/geosteering-office.html</a> ); </li><li>  deuxi√®me: <a href="">cp_1.png</a> (√† partir de la page <a href="https://geosteertech.com/products/geonaft/correlation-panel/">https://geosteertech.com/products/geonaft/correlation-panel/</a> ); </li><li>  Bien s√ªr, le g√©ant Petrel l'a; </li><li>  aussi google sur demande (bien) panneau de corr√©lation. </li></ul><br><p>  Une structure assez simple est une liste de pistes de puits, √† l'int√©rieur de pistes de courbes, d'√©chelles;  Eh bien, les petites choses.  Beaucoup de texte, √† l'avenir, certains contr√¥les - boutons, listes d√©roulantes, champs de saisie, etc. </p><br><p>  J'ai regard√© sgengine, j'ai appris √† cr√©er deux graphiques de sc√®ne et √† les dessiner dans la fen√™tre d√©sign√©e.  Plus tard, j'ai r√©alis√© qu'avec cette option, QML / Quick ne le serait pas, alors pourquoi ai-je besoin de tout cela? </p><br><p>  En fait, je ne me souviens pas quels m√©dicaments, mais pour une raison quelconque, j'ai d√©cid√© de me tourner vers les bases de l'infographie.  Ainsi, aux derni√®res √©tapes de la pixellisation, toutes les coordonn√©es de la sc√®ne sont transf√©r√©es vers le NKU (Normalized Device Coordinates; mieux connu sous le nom de NDC = Normalized Device Coordinates).  Oui, j'ai entendu que la sortie du vertex shader est en fait un espace de clip et apr√®s cela, il y a toujours une distorsion affine, mais tout cela est pour une repr√©sentation en trois dimensions, et en 2D c'est toujours w = 1 et donc nous pouvons supposer que la sortie imm√©diatement au NDC. </p><br><p>  OK, NDC, quelle est la prochaine √©tape?  Que si la largeur de votre fen√™tre est de 800 pixels, alors la coordonn√©e NDC du centre du pixel z√©ro est -1;  la coordonn√©e centrale du 799th est 1. En bref, ndcX = -1 + 2 * i / 799. Imaginez maintenant qu'il y a un rectangle de 100 √† 300 et je veux dessiner la sc√®ne enti√®re non pas dans une fen√™tre enti√®re, mais dedans.  En utilisant cette connaissance fragmentaire, je compterai ndcX100, ndcX300, puis les jetterai dans le vertex shader et l√†, apr√®s le standard </p><br><pre><code class="plaintext hljs">gl_Position = matrix * position;</code> </pre> <br><p>  ¬´envelopper¬ª gl_Position.x de fa√ßon lin√©aire dans [ndcX100;  ndcX300].  Nous faisons de m√™me pour la composante verticale.  Cette astuce vous permettra de faire appara√Ætre des sc√®nes dans n'importe quel rectangle s√©lectionn√© de la sc√®ne.  Avec cette connaissance, l'exemple de graphique a commenc√© √† subir des modifications.  Vous pouvez regarder la paroisse ici - <a href="https://github.com/rogii-com/graph">graphique</a> ;  tout le sel dans <code>shaders/line.vsh</code> . </p><br><h3 id="sceneitemscene">  SceneItem / Scene </h3><br><p>  Les trois mois suivants ont √©t√© l'√©criture de TK, il s'est av√©r√© 12 feuilles de A4 =).  En parall√®le, nous avons consid√©r√© l'architecture.  Ils ont pris MVC ... c'est MVP ... c'est Hierarchical MVC / MVP ... ou m√™me PAC - ce sont toutes des conventions, une bonne d√©composition est importante. </p><br><p>  En g√©n√©ral, nous avons pr√©par√© un exemple de sc√®ne.  Les sources sont disponibles ici - <a href="https://github.com/rogii-com/SceneSample">SceneSample</a> .  Il s'est av√©r√© un certain cadre pour cr√©er des applications avec des graphiques sur QtQML / Quick.  N'oubliez pas que ce code sert toujours d'exemple.  Oui, d√©j√† √† moiti√© pr√™t et semble plus ou moins soign√©, mais pas pr√™t. </p><br><p>  La sc√®ne est le principal acteur.  Cette classe surveille ses coordonn√©es NDC et met √† jour les matrices correspondantes.  SceneCamera est un ami proche de lui.  La prochaine entit√© qui m√©rite d'√™tre mentionn√©e est SceneItem.  Il est inutile en soi, il ne contient qu'une logique de base;  h√©ritez-le - comme LineStrip - et impl√©mentez ce dont vous avez besoin.  Dans le m√™me temps, dans <code>updatePaintNode</code> vous devez utiliser des d√©riv√©s de SceneMaterial - FlatColorMaterial comme r√©f√©rence.  Les entit√©s restantes font aussi quelque chose =), toutes sortes de manipulateurs, d'outils.  La plupart des classes ne sont pas lanc√©es en QML, et vous ne pouvez pas vous passer d'un tel C ++;  vous souvenez-vous de ce qui n'est pas pr√™t? </p><br><p>  La deuxi√®me difficult√© est que si nous voulons utiliser des contr√¥les √† l'int√©rieur d'une nouvelle sc√®ne, nous ne pourrons pas le faire.  Nous avons pens√©, d√©cid√© que nous n'en avions pas besoin et avons calmement poursuivi le d√©veloppement. </p><br><p>  Avantages de l'approche: </p><br><ul><li>  tout est dessin√© dans une colonne de la sc√®ne; </li><li>  nous n'avons pas corrig√© Qt - il reste possible d'ajouter des contr√¥les QML normaux √† la sc√®ne afin que l'ordre z entre eux et les courbes (ou tout autre SceneItem) soit correct; </li><li>  consommation de m√©moire inf√©rieure par rapport √† d'autres approches. </li></ul><br><p>  Inconv√©nients </p><br><ul><li>  machine urbaine complexe; </li><li>  la connaissance d'OpenGL et de GLSL est requise; </li><li>  solution semi-finie. </li></ul><br><p>  Bien s√ªr, nous avons rencontr√© quelques difficult√©s lors du d√©veloppement.  L'un d'eux √©tait </p><br><h3 id="bag-s-z-order">  Bug avec z-order </h3><br><p>  Lorsque nous avons essay√© pour la premi√®re fois d'afficher une sc√®ne avec des courbes, nous avons vu de telles images: <br><img src="https://habrastorage.org/webt/wc/qb/mi/wcqbmirtmjya6uaqdsqhgegqhci.jpeg"></p><br><p><img src="https://habrastorage.org/webt/el/_e/xo/el_exofkaclv-pdkv83yi-jybhs.jpeg"></p><br><p>  √Ä premi√®re vue, ce n'√©tait pas clair, "nous avons tout fait correctement!"  On a vaguement devin√© que gl_Position.z √©tait en quelque sorte erron√©, mais pourquoi il √©tait difficile de comprendre pourquoi la nuit.  Nous n'avons pas abandonn√©: nous avons vu que Qt corrige les shaders et ajoute le code pour changer gl_Position.z, nous avons pens√©.  Au bout d'un moment, il nous est apparu: nous avons foir√© les donn√©es de la matrice par le changement de z, et Qt leur transf√®re ses valeurs!  Ainsi, la valeur item.z de QML est mapp√©e √† z d'OpenGL ( <a href="">SceneMaterial.cpp +20</a> ): </p><br><p><img src="https://habrastorage.org/webt/bd/bg/jr/bdbgjroxi-khledimuejjj-f7pw.jpeg"></p><br><h3 id="bag-s-clip-true">  Bug avec clip: vrai </h3><br><p>  Une fois dans un chat, une √©quipe commerciale envoie un √©cran o√π la ligne gauche de la grille de coordonn√©es a disparu. </p><br><p><img src="https://habrastorage.org/webt/k9/df/sm/k9dfsml6hlop-oa8hegvygeaa_8.jpeg"></p><br><p>  Notre Q&amp;A a tourment√© le programme et a trouv√© des √©tapes pour une lecture stable: nous avons r√©gl√© la mise √† l'√©chelle du moniteur sur un multiple de 100% et les lignes ¬´flash¬ª.  Artyom s'est assis, a pens√© et trouv√© que lorsque <code>clip: true</code> et que l'√©l√©ment est rectangulaire, glScissor est utilis√©, mais ses arguments sont des coordonn√©es de pixels enti√®res!  Au niveau des √©l√©ments de QML, ils sont r√©els et il s'est av√©r√© que la pixellisation de la ligne est tomb√©e au pixel suivant / pr√©c√©dent, et les ciseaux ont √©t√© coup√©s au courant. </p><br><p>  Nous avons corrig√© la sc√®ne comme ceci: <code>width: Math.round(metrics.width + leftPadding + 2 * rightPadding + 0.5)</code> .  Par cons√©quent, l'√©l√©ment de sc√®ne doit toujours avoir des coordonn√©es enti√®res afin d'√©viter de tels artefacts. </p><br><p>  En conclusion, je vais apporter KDPV </p><br><p><img src="https://habrastorage.org/webt/1v/jm/hn/1vjmhn-nmmfitmvq4cjqccfaf_m.jpeg"></p><br><p>  Merci √† tous pour votre attention! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr480334/">https://habr.com/ru/post/fr480334/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr480324/index.html">Impl√©mentation du type de cha√Æne dans CPython</a></li>
<li><a href="../fr480326/index.html">F5 Networks Corporation envoie des lettres √† ses clients pour les informer de la situation actuelle avec NGINX</a></li>
<li><a href="../fr480328/index.html">Comment se faire des amis PyTorch et C ++. Utilisation de TorchScript</a></li>
<li><a href="../fr480330/index.html">Outil d'√©valuation id√©al des employ√©s</a></li>
<li><a href="../fr480332/index.html">Analyse des donn√©es du vote blockchain 2019 √† la Douma de Moscou</a></li>
<li><a href="../fr480338/index.html">Fonctionnement du rendu de jeu 3D: pixellisation et lancer de rayons</a></li>
<li><a href="../fr480340/index.html">Je me suis oppos√© √† un gestionnaire incomp√©tent, puis il a √©t√© promu</a></li>
<li><a href="../fr480342/index.html">Paradigme de d√©veloppement par le commentaire</a></li>
<li><a href="../fr480348/index.html">Deep Fake Science, la crise de la reproductibilit√© et d'o√π viennent les r√©f√©rentiels vides</a></li>
<li><a href="../fr480350/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 326 (du 9 au 15 d√©cembre)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>