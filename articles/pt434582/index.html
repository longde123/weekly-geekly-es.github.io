<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üè† üöú üç∂ Solu√ß√µes arquitet√¥nicas para um jogo para celular. Parte 1: Modelo üí© üî∞ ‚òùÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ep√≠grafe: 
 - Como vou avaliar se voc√™ n√£o sabe o que fazer? 
 - Bem, haver√° telas e bot√µes. 
 - Dima, voc√™ descreveu toda a minha vida em tr√™s palavr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Solu√ß√µes arquitet√¥nicas para um jogo para celular. Parte 1: Modelo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434582/">  <i>Ep√≠grafe:</i> <i><br></i>  <i>- Como vou avaliar se voc√™ n√£o sabe o que fazer?</i> <i><br></i>  <i>- Bem, haver√° telas e bot√µes.</i> <i><br></i>  <i>- Dima, voc√™ descreveu toda a minha vida em tr√™s palavras!</i> <i><br></i>  <i>(c) Di√°logo real em uma manifesta√ß√£o em uma empresa de jogos</i> <br><br><img src="https://habrastorage.org/webt/zp/ab/js/zpabjszvfb5gcancgd76i5trlz8.jpeg"><br><br>  Um conjunto de necessidades e as solu√ß√µes que as atendem, que discutirei neste artigo, foi formado durante minha participa√ß√£o em cerca de uma d√∫zia de grandes projetos, primeiro no Flash e depois no Unity.  O maior dos projetos teve mais de 200.000 DAUs e complementou meu cofrinho com novos desafios originais.  Por outro lado, a relev√¢ncia e a necessidade de descobertas anteriores foram confirmadas. <br><br>  Em nossa dura realidade, todo mundo que pelo menos uma vez projetou um projeto grande, pelo menos em seus pensamentos, tem suas pr√≥prias id√©ias sobre como faz√™-lo e, com frequ√™ncia, est√° pronto para defend√™-las at√© a √∫ltima gota de sangue.  Para outros, isso me faz sorrir, e a ger√™ncia geralmente v√™ tudo isso como uma enorme caixa preta que n√£o descansa contra ningu√©m.  Mas e se eu lhe disser que as solu√ß√µes corretas ajudar√£o a reduzir a cria√ß√£o de novas funcionalidades em 2 a 3 vezes, a busca de erros nos antigos 5 a 10 vezes e permitir√° que voc√™ fa√ßa muitas coisas novas e importantes que antes n√£o estavam dispon√≠veis?  √â o suficiente para deixar a arquitetura entrar em seu cora√ß√£o! <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Solu√ß√µes arquitet√¥nicas para um jogo para celular.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2: Comando e suas filas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Solu√ß√µes arquitet√¥nicas para um jogo para celular.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 3: Vista sobre o impulso do jato</a> <br><a name="habracut"></a><br><br><h2>  Modelo </h2><br><h3>  Acesso a campos </h3><br>  A maioria dos programadores reconhece a import√¢ncia de usar algo como o MVC.  Poucas pessoas usam o MVC puro do livro de uma turma de quatro, mas todas as decis√µes dos escrit√≥rios normais s√£o de alguma forma semelhantes a esse padr√£o em esp√≠rito.  Hoje falaremos sobre a primeira das letras nesta abrevia√ß√£o.  Como grande parte do trabalho dos programadores em um jogo para dispositivos m√≥veis s√£o novos recursos no meta-jogo, implementados como manipula√ß√µes com o modelo e parafusando milhares de interfaces nesses recursos.  E a conveni√™ncia do modelo desempenha um papel fundamental nesta li√ß√£o. <br><br>  Eu n√£o forne√ßo o c√≥digo completo, porque √© um pouco complicado, e geralmente n√£o √© sobre ele.  Ilustrarei meu racioc√≠nio com um exemplo simples: <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory; <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } }</code> </pre> <br>  Essa op√ß√£o n√£o √© adequada para n√≥s, porque o modelo n√£o envia eventos sobre as mudan√ßas que ocorrem nele.  Se as informa√ß√µes sobre quais campos foram afetados pelas altera√ß√µes, quais n√£o s√£o e quais precisam ser redesenhadas, e quais n√£o s√£o, o programador indicar√° manualmente de uma forma ou de outra - essa se tornar√° a principal fonte de erros e tempo.  E n√£o √© preciso ter olhos surpresos.Na maioria dos grandes escrit√≥rios em que trabalhei, o programador enviou todos os tipos de InventoryUpdatedEvent, e em alguns casos tamb√©m os preencheu manualmente.  Alguns desses escrit√≥rios fizeram milh√µes, voc√™ acha, obrigado ou apesar disso? <br><br>  Usaremos nossa pr√≥pria classe ReactiveProperty &lt;T&gt;, que ocultar√° todas as manipula√ß√µes para enviar as mensagens necess√°rias.  Ser√° algo parecido com isto: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;InventoryModel&gt; inventory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;InventoryModel&gt;(); <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money.Value = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.Value.capacity.Value++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ money.SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  Esta √© a primeira vers√£o do modelo.  Essa op√ß√£o j√° √© um sonho para muitos programadores, mas ainda n√£o gosto.  A primeira coisa que n√£o gosto √© que acessar valores √© complicado.  Consegui me confundir enquanto escrevia este exemplo, esquecendo o Valor em um s√≥ lugar, e s√£o precisamente essas manipula√ß√µes de dados que comp√µem a maior parte de tudo o que √© feito e confundido com o modelo.  Se voc√™ estiver usando a vers√£o do idioma 4.x, poder√° fazer o seguinte: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; money { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactiveProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;();</code> </pre> <br>  mas isso n√£o resolve todos os problemas.  Gostaria de escrever simplesmente: invent√°rio.capacidade ++;.  Suponha que tentemos obter para cada campo do modelo;  conjunto;  Mas, para se inscrever em eventos, tamb√©m precisamos acessar o pr√≥prio ReactiveProperty.  Inconveniente claro e fonte de confus√£o.  Apesar do fato de que precisamos apenas indicar qual campo vamos monitorar.  E aqui eu vim com uma manobra complicada que eu gostei. <br><br>  Vamos ver se voc√™ gosta. <br><br>  N√£o √© ReactiveProperty que est√° inserido no modelo concreto com o qual o programador est√° lidando, est√° inserido, mas seu descritor est√°tico PValue, o herdeiro da Propriedade mais geral, identifica o campo e, dentro do cap√¥ do construtor Model, est√° oculta a cria√ß√£o e o armazenamento da ReactiveProperty do tipo desejado.  N√£o √© o melhor nome, mas aconteceu, depois renomeou. <br><br>  No c√≥digo, fica assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; MONEY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> money { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MONEY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { MONEY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value) } } <span class="hljs-comment"><span class="hljs-comment">/* Using */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SomeTestChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ money = <span class="hljs-number"><span class="hljs-number">10</span></span>; inventory.capacity++; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text text)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Get(MONEY).SubscribeWithState(text, (x, t) =&gt; t.text = x.ToString()); } }</code> </pre> <br>  Esta √© a segunda op√ß√£o.  O ancestral geral do Modelo, √© claro, era complicado √†s custas da cria√ß√£o e extra√ß√£o de uma ReactiveProperty real de acordo com seu descritor, mas isso pode ser feito muito rapidamente e sem reflex√£o, ou melhor, aplicando a reflex√£o apenas uma vez no est√°gio de inicializa√ß√£o da classe.  E este √© o trabalho que √© feito uma vez pelo criador do mecanismo, e depois ser√° usado por todos.  Al√©m disso, esse design evita tentativas acidentais de manipular o pr√≥prio ReactiveProperty em vez dos valores armazenados nele.  A cria√ß√£o do campo √© confusa, mas em todos os casos √© exatamente a mesma e pode ser criada com um modelo. <br><br>  No final do artigo, h√° uma enquete sobre a op√ß√£o que voc√™ mais gosta. <br>  Tudo descrito abaixo pode ser implementado nas duas vers√µes. <br><br><h3>  Transa√ß√µes </h3><br>  Desejo que os programadores possam alterar os campos do modelo somente quando isso for permitido pelas restri√ß√µes adotadas no mecanismo, isto √©, dentro da equipe e nunca mais.  Para fazer isso, o setter deve ir a algum lugar e verificar se o comando de transa√ß√£o est√° aberto no momento e somente depois permitir que as informa√ß√µes sejam editadas no modelo.  Isso √© muito necess√°rio, porque os usu√°rios do mecanismo regularmente tentam fazer algo estranho para ignorar um processo t√≠pico, quebrando a l√≥gica do mecanismo e causando erros sutis.  Vi isso mais de uma ou duas vezes. <br><br>  H√° uma cren√ßa de que, se voc√™ criar uma interface separada para ler dados do modelo e escrever, isso ajudar√° de alguma forma.  Na realidade, o modelo est√° cheio de arquivos adicionais e opera√ß√µes adicionais tediosas.  Essas restri√ß√µes s√£o finais: os programadores s√£o obrigados, em primeiro lugar, a conhec√™-los e a pensar constantemente sobre eles: ‚Äúo que cada fun√ß√£o espec√≠fica, modelo ou interface deve oferecer‚Äù e, em segundo lugar, tamb√©m surgem situa√ß√µes em que essas restri√ß√µes precisam ser contornadas; na sa√≠da, temos d'Artagnan, que criou tudo isso em branco, e muitos usu√°rios de seu mecanismo, que s√£o maus guardas do gerente de projetos e, apesar dos constantes abusos, nada funciona como planejado.  Portanto, prefiro bloquear firmemente a possibilidade de tal erro.  Reduza a dose de conven√ß√µes, por assim dizer. <br><br>  O configurador ReactiveProperty deve ter um link para o local em que o estado atual da transa√ß√£o deve ser verificado.  Digamos que este lugar seja classCModelRoot.  A op√ß√£o mais f√°cil √© pass√°-lo explicitamente ao construtor do modelo.  A segunda vers√£o do c√≥digo ao chamar o RProperty recebe um link para isso explicitamente e pode obter todas as informa√ß√µes necess√°rias a partir da√≠.  Para a primeira vers√£o do c√≥digo, voc√™ precisar√° executar os campos do tipo ReactiveProperty no construtor com uma reflex√£o e fornecer um link para isso para outras manipula√ß√µes.  Um pequeno inconveniente √© a necessidade de criar um construtor expl√≠cito com um par√¢metro em cada modelo, algo como isto: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelRoot gamestate)</span></span></span><span class="hljs-function"> : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gamestate)</span></span></span><span class="hljs-function"> </span></span>{} }</code> </pre> <br>  Mas para outras caracter√≠sticas dos modelos, √© muito √∫til que o modelo tenha um link para o modelo pai, formando uma constru√ß√£o biconetada.  No nosso exemplo, este ser√° player.inventory.Parent == player.  E ent√£o esse construtor pode ser evitado.  Qualquer modelo poder√° obter e armazenar em cache um link para um lugar m√°gico de seus pais, e aquele de seus pais, e assim por diante, at√© que o pr√≥ximo pai se torne esse lugar m√°gico.  Como resultado, no n√≠vel das declara√ß√µes, tudo isso ser√° assim: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> locked { get; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Model Parent { get; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ModelRoot Root { get; } }</code> </pre> <br>  Toda essa beleza ser√° preenchida automaticamente quando o modelo entrar na √°rvore de gamestate.  Sim, o modelo rec√©m-criado, que ainda n√£o chegou l√°, n√£o poder√° aprender sobre a transa√ß√£o e bloquear as manipula√ß√µes consigo mesmo, mas se o estado da transa√ß√£o for proibido, ele n√£o poder√° entrar no estado depois disso, o setter do futuro pai n√£o o permitir√°, portanto, a integridade do gamestate n√£o ser√° afetada.  Sim, isso exigir√° trabalho adicional na fase de programa√ß√£o do mecanismo, mas, por outro lado, um programador que use o mecanismo eliminar√° completamente a necessidade de conhecer e pensar sobre ele at√© que ele tente fazer algo errado e coloque as m√£os nele. <br><br>  Desde o in√≠cio da conversa sobre transatividade, as mensagens sobre altera√ß√µes n√£o devem ser processadas imediatamente ap√≥s a altera√ß√£o, mas somente quando todas as manipula√ß√µes com o modelo na estrutura do comando atual forem conclu√≠das.  H√° duas raz√µes para isso: a primeira √© a consist√™ncia dos dados. Nem todos os estados dos dados s√£o internamente consistentes. Talvez voc√™ n√£o possa tentar renderiz√°-los.  Ou se voc√™ estiver impaciente, por exemplo, para classificar uma matriz ou alterar alguma vari√°vel de modelo em um loop.  Voc√™ n√£o deve receber centenas de mensagens de altera√ß√£o. <br><br>  Existem duas maneiras de fazer isso.  A primeira √© usar a fun√ß√£o complicada ao assinar atualiza√ß√µes de uma vari√°vel, que adicionar√° um fluxo de finaliza√ß√µes de transa√ß√£o ao fluxo de altera√ß√µes na vari√°vel e passar√° apenas as mensagens ap√≥s elas.  Isso √© f√°cil o suficiente, se voc√™ estiver usando o UniRX, por exemplo.  Mas esta op√ß√£o tem muitas defici√™ncias, em particular, gera muitos movimentos desnecess√°rios.  Pessoalmente, gosto da outra op√ß√£o. <br><br>  Cada ReactiveProperty lembrar√° seu estado antes do in√≠cio da transa√ß√£o e seu estado atual.  Uma mensagem sobre a altera√ß√£o e a corre√ß√£o das altera√ß√µes ser√° feita apenas no final da transa√ß√£o.  No caso de o objeto da altera√ß√£o ser algum tipo de cole√ß√£o, isso permitir√° incluir explicitamente informa√ß√µes sobre as altera√ß√µes que ocorreram na mensagem enviada.Por exemplo, esses dois itens da lista foram adicionados e esses dois foram exclu√≠dos.  Em vez de apenas dizer que algo mudou, e for√ßar o destinat√°rio a analisar uma lista de mil elementos em busca de informa√ß√µes que precisam ser redesenhadas. <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DispatchChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Command transaction)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FixChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RevertChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br>  A op√ß√£o consome mais tempo na fase de cria√ß√£o do mecanismo, mas o custo de uso √© menor.  E o mais importante, abre a possibilidade para a pr√≥xima melhoria. <br><br><h3>  Informa√ß√µes sobre altera√ß√µes feitas no modelo </h3><br>  Eu quero mais do modelo.  A qualquer momento, desejo ver com facilidade e conveni√™ncia o que mudou no estado do modelo como resultado de minhas a√ß√µes.  Por exemplo, neste formul√°rio: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>}}}</code> </pre> <br>  Na maioria das vezes, √© √∫til que o programador veja a diferen√ßa entre o estado do modelo antes do in√≠cio do comando e ap√≥s seu t√©rmino ou em algum momento dentro do comando.  Alguns deles clonam todo o estado do jogo antes do in√≠cio da equipe e depois comparam.  Isso resolve parcialmente o problema no est√°gio de depura√ß√£o, mas √© absolutamente imposs√≠vel execut√°-lo no produto.  Essa clonagem de estado, que calcula a diferen√ßa insignificante entre as duas listas, √© uma opera√ß√£o monstruosamente cara relacionada a qualquer espirro. <br><br>  Portanto, ReactiveProperty deve armazenar n√£o apenas seu estado atual, mas tamb√©m o estado anterior.  Isso d√° origem a todo um grupo de oportunidades extremamente √∫teis.  Em primeiro lugar, a extra√ß√£o da diferen√ßa em tal situa√ß√£o √© r√°pida e podemos despejar tudo com calma nos alimentos.  Em segundo lugar, voc√™ n√£o pode obter um diff volumoso, mas um pequeno hash compacto de altera√ß√µes e compar√°-lo com um hash de altera√ß√µes em outro mesmo estado de jogo.  Se n√£o concordar, voc√™ tem problemas.  Em terceiro lugar, se a execu√ß√£o do comando falhou com a execu√ß√£o, voc√™ sempre pode cancelar as altera√ß√µes e descobrir o estado n√£o preservado no momento em que a transa√ß√£o foi iniciada.  Juntamente com a equipe aplicada ao estado, essas informa√ß√µes s√£o inestim√°veis, pois √© poss√≠vel reproduzir facilmente a situa√ß√£o com precis√£o.  Obviamente, para isso, voc√™ precisa ter uma funcionalidade pronta para serializa√ß√£o e desserializa√ß√£o convenientes do estado do jogo, mas ser√° necess√°rio de qualquer maneira. <br><br><h3>  Serializa√ß√£o de mudan√ßas de modelo </h3><br>  O mecanismo fornece serializa√ß√£o e bin√°rio, e em json - e isso n√£o √© por acaso.  Obviamente, a serializa√ß√£o bin√°ria ocupa muito menos espa√ßo e funciona muito mais rapidamente, o que √© importante, especialmente durante a inicializa√ß√£o inicial.  Mas este n√£o √© um formato leg√≠vel por humanos, e aqui oramos pela conveni√™ncia da depura√ß√£o.  Al√©m disso, h√° outra armadilha.  Quando o jogo come√ßar, voc√™ precisar√° mudar constantemente de vers√£o para vers√£o.  Se seus programadores seguirem algumas precau√ß√µes simples e n√£o exclu√≠rem nada do estado do jogo desnecessariamente, voc√™ n√£o sentir√° essa transi√ß√£o.  E no formato bin√°rio, n√£o h√° nomes de cadeias de campos por raz√µes √≥bvias, e se as vers√µes n√£o corresponderem, voc√™ ter√° que ler o bin√°rio com a vers√£o antiga do estado, export√°-lo para algo mais informativo, por exemplo, o mesmo json, import√°-lo para um novo estado e export√°-lo para o bin√°rio, escreva e somente depois de todo esse trabalho, como de costume.  Como resultado, em alguns projetos, as configura√ß√µes s√£o gravadas em bin√°rios, tendo em vista o tamanho das cicl√≥picas, e eles j√° preferem arrastar o estado para frente e para tr√°s na forma de json.  Avalie a sobrecarga e escolha voc√™. <br><br><pre> <code class="cpp hljs">[Flags] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ExportMode { all = <span class="hljs-number"><span class="hljs-number">0x0</span></span>, changes = <span class="hljs-number"><span class="hljs-number">0x1</span></span>, serverVerified = <span class="hljs-number"><span class="hljs-number">0x2</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    ,    } /**    */ public partial class Model { public bool GetHashCode(ExportMode mode, out int code); public bool Import(BinaryReader binarySerialization); public bool Import(JSONReader json); public void ExportAll(ExportMode mode, BinaryWriter binarySerialization); public void ExportAll(ExportMode mode, JSONWriter json); public bool Export(ExportMode mode, out Dictionary&lt;string, object&gt; data); }</span></span></code> </pre> <br>  A assinatura do m√©todo Export (modo ExportMode, out Dictionary &lt;string, object&gt; data) √© um tanto alarmante.  E o problema √© o seguinte: quando voc√™ serializa a √°rvore inteira, pode escrever diretamente no fluxo, ou no nosso caso, no JSONWriter, que √© um complemento simples para o StringWriter.  Mas quando voc√™ exporta as altera√ß√µes, n√£o √© t√£o simples, porque quando voc√™ se aprofunda em uma √°rvore e entra em um dos galhos, ainda n√£o sabe se deseja exportar algo.  Portanto, nessa fase, eu criei duas solu√ß√µes, uma mais simples, a segunda mais complicada e econ√¥mica.  Uma mais simples √© que, ao exportar apenas altera√ß√µes, voc√™ transforma todas as altera√ß√µes em uma √°rvore do Dicion√°rio &lt;string, objeto&gt; e da Lista &lt;object&gt;.  E ent√£o o que aconteceu, alimente seu serializador favorito.  Esta √© uma abordagem simples que n√£o exige que voc√™ dance com um pandeiro.  Mas sua desvantagem √© que, no processo de exportar altera√ß√µes para o heap, um local para cole√ß√µes √∫nicas ser√° alocado.  De fato, n√£o h√° muito espa√ßo, porque essa exporta√ß√£o completa fornece uma √°rvore grande e o comando t√≠pico deixa muito poucas altera√ß√µes na √°rvore. <br><br>  No entanto, muitas pessoas acreditam que alimentar o Coletor de Lixo como aquele troll n√£o √© necess√°rio sem extrema necessidade.  Para eles, e para acalmar minha consci√™ncia, preparei uma solu√ß√£o mais complexa: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/**    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newModel = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">false</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DetectChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Stack&lt;Model&gt; ierarchyChanged = null)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExportChanges</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExportMode mode, Type propertyType, JSONWriter writer, Queue&lt;Model&gt; ierarchyChanges = null)</span></span></span></span>; }</code> </pre> <br>  A ess√™ncia desse m√©todo √© percorrer a √°rvore duas vezes.  Pela primeira vez, visualize todos os modelos que se mudaram ou que tenham altera√ß√µes nos modelos filhos e escreva todos na Fila &lt;Model&gt; ierarchyChanges exatamente na ordem em que aparecem na √°rvore em seu estado atual.  N√£o h√° muitas altera√ß√µes, a fila n√£o ser√° longa.  Al√©m disso, nada impede manter a pilha &lt;Model&gt; e a fila &lt;Model&gt; entre as chamadas e, em seguida, haver√° muito poucas aloca√ß√µes durante a chamada. <br><br>  E j√° passando pela segunda vez pela √°rvore, ser√° poss√≠vel olhar para o topo da fila a cada vez e entender se √© necess√°rio entrar nesse ramo da √°rvore ou seguir imediatamente em frente.  Isso permite que o JSONWriter escreva imediatamente sem retornar outros resultados intermedi√°rios. <br><br>  √â muito prov√°vel que essa complica√ß√£o n√£o seja realmente necess√°ria, pois mais tarde voc√™ ver√° que a exporta√ß√£o de altera√ß√µes na √°rvore √© necess√°ria apenas para depura√ß√£o ou ao travar com o Exception.  Durante a opera√ß√£o normal, tudo se limita ao GetHashCode (modo ExportMode, out int code), para o qual todas essas del√≠cias s√£o profundamente estranhas. <br><br>  Antes de continuarmos a complicar nosso modelo, vamos falar sobre isso. <br><br><h2>  Por que isso √© t√£o importante? </h2><br>  Todos os programadores dizem que isso √© extremamente importante, mas geralmente ningu√©m acredita neles.  Porque <br><br>  Primeiro, porque todos os programadores dizem que voc√™ precisa jogar fora o antigo e escrever no novo.  Isso √© tudo, independentemente das qualifica√ß√µes.  N√£o existe uma maneira gerencial de descobrir se isso √© verdade ou n√£o, e os experimentos geralmente s√£o muito caros.  O gerente ser√° for√ßado a escolher um programador e confiar em seu julgamento.  O problema √© que esse consultor geralmente √© aquele com quem a ger√™ncia trabalha h√° muito tempo e o avalia se conseguiu realizar suas id√©ias.E todas as suas melhores id√©ias j√° est√£o incorporadas na realidade.  Portanto, essa tamb√©m n√£o √© uma maneira ideal de descobrir qu√£o boas s√£o as id√©ias de outras pessoas e diferentes. <br><br>  Em segundo lugar, 80% de todos os jogos para celular trazem menos de US $ 500 em toda a vida.  Portanto, no in√≠cio do projeto, o gerenciamento tem outros problemas, mais importante ainda a arquitetura.  Mas as decis√µes tomadas no in√≠cio do projeto tornam as pessoas ref√©ns e n√£o deixam passar de seis meses a tr√™s anos.  O processo de refatora√ß√£o e mudan√ßa para outras id√©ias em um projeto j√° em funcionamento, que tamb√©m tem clientes, √© um neg√≥cio muito dif√≠cil, caro e arriscado.  Se, para um projeto no in√≠cio, investir tr√™s meses-homem em uma arquitetura normal parece um luxo inadmiss√≠vel, o que voc√™ pode dizer sobre o custo de adiar a atualiza√ß√£o com novos recursos por alguns meses? <br><br>  Terceiro, mesmo que a id√©ia de ‚Äúcomo deveria ser‚Äù seja boa e ideal, n√£o se sabe quanto tempo levar√° sua implementa√ß√£o.  A depend√™ncia do tempo gasto com a frieza do programador √© muito n√£o linear.  O senhor far√° uma tarefa simples, n√£o muito mais r√°pida que o j√∫nior.  Uma vez e meia, talvez.  Mas cada programador tem seu pr√≥prio "limite de complexidade", al√©m do qual sua efic√°cia cai drasticamente.  Tive um caso em minha vida em que precisava realizar uma tarefa arquitet√¥nica bastante complicada, e at√© mesmo me concentrar completamente no problema de desligar a Internet em casa e pedir refei√ß√µes prontas por um m√™s n√£o ajudou, mas dois anos depois, depois de ler livros interessantes e resolver tarefas relacionadas , Resolvi esse problema em tr√™s dias.  Estou certo de que todos se lembrar√£o de algo assim em sua carreira.  E aqui est√° o problema!  O fato √© que, se uma id√©ia engenhosa lhe veio √† mente como deveria ser, provavelmente essa nova id√©ia est√° em algum lugar do seu limite pessoal de complexidade e talvez at√© um pouco atr√°s dela.  A ger√™ncia, tendo repetidamente queimado isso, come√ßa a soprar novas id√©ias.  E se voc√™ faz o jogo por si mesmo, o resultado pode ser ainda pior, porque n√£o haver√° ningu√©m para impedi-lo. <br><br>  Mas como, ent√£o, algu√©m consegue usar boas solu√ß√µes?  Existem v√°rias maneiras. <br><br>  Em primeiro lugar, cada empresa deseja contratar uma pessoa pronta que j√° fez isso com um empregador anterior.  Essa √© a maneira mais comum de transferir o √¥nus da experimenta√ß√£o para outra pessoa. <br><br>  Em segundo lugar, as empresas ou pessoas que fizeram seu primeiro jogo de sucesso, beberam e iniciaram o pr√≥ximo projeto est√£o prontas para mudan√ßas. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Terceiro, admita honestamente que √†s vezes faz algo n√£o por uma quest√£o de sal√°rio, mas pelo prazer do processo. O principal √© encontrar tempo para isso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Quarto, √© um conjunto de solu√ß√µes e bibliotecas comprovadas, juntamente com as pessoas, que comp√µem os principais fundos da empresa de jogos, e essa √© a √∫nica coisa que permanecer√° quando uma pessoa-chave sair e se mudar para a Austr√°lia.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A √∫ltima raz√£o, embora n√£o a mais √≥bvia: porque √© terrivelmente ben√©fica. </font><font style="vertical-align: inherit;">Boas solu√ß√µes levam a uma redu√ß√£o m√∫ltipla no tempo para escrever novos recursos, depur√°-los e detectar erros. </font><font style="vertical-align: inherit;">Deixe-me dar um exemplo: dois dias atr√°s, o cliente teve uma execu√ß√£o em um novo recurso, cuja probabilidade √© de 1 em 1.000, ou seja, o controle de qualidade torturar√° para reproduzi-lo e, se voc√™ der, s√£o 200 mensagens de erro por dia. </font><font style="vertical-align: inherit;">Quanto tempo leva para voc√™ reproduzir a situa√ß√£o e capturar o cliente no ponto de interrup√ß√£o uma linha antes de tudo entrar em colapso? </font><font style="vertical-align: inherit;">Por exemplo, eu tenho 10 minutos.</font></font><br><br><h2>  Modelo </h2><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √Årvore modelo </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O modelo consiste em muitos objetos. Diferentes programadores decidem de maneira diferente como conect√°-los. A primeira maneira √© quando o modelo √© identificado pelo local onde est√°. Isso √© muito conveniente e simples quando a refer√™ncia ao modelo pertence a um √∫nico local no ModelRoot. Talvez ele possa ser deslocado de um lugar para outro, mas dois elos de lugares diferentes nunca levam a isso. Faremos isso introduzindo uma nova vers√£o do descritor ModelProperty, que lidar√° com links de um modelo para outros modelos localizados nele. No c√≥digo, ficar√° assim:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PModel</span></span></span><span class="hljs-class">&lt;T&gt; :</span></span> Property&lt;T&gt; where T:Model {} <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PlayerModel</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> PModel&lt;InventoryModel&gt; INVENTORY = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PModel&lt;InventoryModel&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> InventoryModel inventory { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { INVENTORY.Value(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qual a diferen√ßa? </font><font style="vertical-align: inherit;">Quando um novo modelo √© adicionado a este campo, o modelo no qual foi adicionado √© gravado no campo Pai e, quando exclu√≠do, o campo Pai √© redefinido. </font><font style="vertical-align: inherit;">Em teoria, est√° tudo bem, mas h√° muitas armadilhas. </font><font style="vertical-align: inherit;">Os primeiros - programadores que o usar√£o, podem estar enganados. </font><font style="vertical-align: inherit;">Para evitar isso, impomos verifica√ß√µes ocultas nesse processo, de diferentes √¢ngulos:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fixaremos o PValue para que ele verifique o tipo de seu valor e jura pelos especialistas ao tentar armazenar uma refer√™ncia ao modelo, indicando que, para isso, √© necess√°rio usar uma constru√ß√£o diferente, apenas para n√£o ficar confuso. </font><font style="vertical-align: inherit;">Isso, √© claro, √© uma verifica√ß√£o de tempo de execu√ß√£o, mas jura na primeira tentativa de iniciar, assim ser√°.</font></font></li><li>   PModel       Parent  -  ,       .     .        ,  . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um efeito colateral surge disso, se voc√™ precisar mudar esse modelo de um lugar para outro, voc√™ deve primeiro remov√™-lo do primeiro lugar e depois adicion√°-lo ao segundo - caso contr√°rio, as verifica√ß√µes o repreender√£o. Mas isso realmente acontece muito raramente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como o modelo est√° em um local estritamente definido e tem uma refer√™ncia ao seu pai, podemos adicionar um novo m√©todo a ele - ele pode dizer de que maneira est√° na √°rvore ModelRoot. Isso √© extremamente conveniente para depura√ß√£o, mas tamb√©m √© necess√°rio para que possa ser identificado exclusivamente. Por exemplo, encontre outro exatamente o mesmo modelo em outro mesmo estado de jogo ou indique no comando transmitido ao servidor um link para o modelo que o comando cont√©m. Parece algo como isto:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelPath</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Property[] properties; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Object[] indexes; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> override </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FromString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> path)</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ModelPath </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Path</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Model </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByPath</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ModelPath path)</span></span></span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">E por que, de fato, √© imposs√≠vel ter um objeto enraizado em um lugar e fazer refer√™ncia a ele de outro? E porque voc√™ imagina que est√° desserializando um objeto do JSON, e aqui encontrar√° um link para um objeto enraizado em um local completamente diferente. E ainda n√£o h√° lugar para isso, ele ser√° criado apenas atrav√©s do piso da desserializa√ß√£o. Opa Por favor, n√£o ofere√ßa desserializa√ß√£o multipass. Essa √© a limita√ß√£o deste m√©todo. Portanto, criaremos um segundo m√©todo:</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todos os modelos criados pelo segundo m√©todo s√£o criados em um local m√°gico e, em todos os outros locais do estado do jogo, apenas links s√£o inseridos neles. Durante a desserializa√ß√£o, se houver v√°rias refer√™ncias ao objeto, na primeira vez em que voc√™ acessar o local m√°gico, o objeto ser√° criado e com todas as refer√™ncias subsequentes ao mesmo objeto ser√£o retornadas. Para implementar outros recursos, assumimos que o jogo pode ter v√°rios gamestates, portanto, o local m√°gico n√£o deve ser um comum, mas deve estar localizado, por exemplo, no gamestate. Para refer√™ncias a esses modelos, usamos outra varia√ß√£o do descritor PPersistent. O modelo em si ser√° tornado mais especial pelo Persistent: Model. No c√≥digo, ser√° algo parecido com isto:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Persistent</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> id { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ModelRoot</span></span></span><span class="hljs-class"> :</span></span> Model { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> nextFreePersistentId { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NEXT_FREE_PERSISTENT_ID.Get(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> { NEXT_FREE_PERSISTENT_ID.Set(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; NEXT_FREE_PERSISTENT_ID = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RProperty&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt; PERSISTENT = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDictionaryModel&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, Persistent&gt;() { notServerVerified = <span class="hljs-literal"><span class="hljs-literal">true</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt;      Id-. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;(int localId) where PersistentT : Persistent, new(); /// &lt;summary&gt; C    Id. &lt;/summary&gt; public PersistentT Persistent&lt;PersistentT&gt;() where PersistentT : Persistent, new(); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Um pouco complicado, mas pode ser usado. </font><font style="vertical-align: inherit;">Para colocar canudos, Persistent pode fixar o construtor com o par√¢metro ModelRoot, que disparar√° um alarme se eles tentarem criar esse modelo, n√£o atrav√©s dos m√©todos deste ModelRoot. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Eu tenho as duas op√ß√µes no meu c√≥digo, e a pergunta √©: por que usar a primeira op√ß√£o se a segunda cobrir totalmente todos os casos poss√≠veis? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A resposta √© que o estado do jogo deve ser, antes de tudo, leg√≠vel pelas pessoas. </font><font style="vertical-align: inherit;">Como √© se, se poss√≠vel, a primeira op√ß√£o for usada?</font></font><br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{}, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> E agora, como seria se apenas a segunda op√ß√£o fosse usada: </font></font><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"persistents"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"1"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"money"</span></span>:<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"inventory"</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>}, <span class="hljs-attr"><span class="hljs-attr">"2"</span></span>:{<span class="hljs-attr"><span class="hljs-attr">"capacity"</span></span>:<span class="hljs-number"><span class="hljs-number">11</span></span>} }, <span class="hljs-attr"><span class="hljs-attr">"player"</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Para depurar pessoalmente, prefiro a primeira op√ß√£o. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Propriedades do modelo de acesso </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No final, o acesso a instala√ß√µes de armazenamento reativo para propriedades ficou oculto sob o cap√¥ do modelo. N√£o √© muito √≥bvio como faz√™-lo funcionar para que ele funcione rapidamente, sem muito c√≥digo nos modelos finais e sem muita reflex√£o. Vamos dar uma olhada.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira coisa que √© √∫til saber sobre o Dicion√°rio √© que a leitura dele n√£o leva muito tempo constante, independentemente do tamanho do dicion√°rio. Criaremos um dicion√°rio est√°tico privado no Modelo, no qual cada tipo de modelo recebe uma descri√ß√£o de quais campos est√£o nele e o acessaremos uma vez ao construir o modelo. No construtor type, procuramos ver se existe uma descri√ß√£o para o nosso tipo, caso contr√°rio, criamos, se sim, pegamos o que foi finalizado. Assim, a descri√ß√£o ser√° criada apenas uma vez para cada classe. Ao criar uma descri√ß√£o, colocamos em cada Propriedade est√°tica (descri√ß√£o do campo) os dados extra√≠dos por reflex√£o - o nome do campo e o √≠ndice sob o qual o armazenamento de dados para esse campo estar√° na matriz. Desta maneiraquando acessado atrav√©s da descri√ß√£o do campo, seu armazenamento ser√° retirado da matriz em um √≠ndice conhecido anteriormente, ou seja, rapidamente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> No c√≥digo, ficar√° assim: </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-class"> :</span></span> IModelInternals { <span class="hljs-meta"><span class="hljs-meta">#region Properties protected static Dictionary</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Type, Property[]&gt; propertiesDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected static Dictionary&lt;Type, Property[]&gt; propertiesForBinarySerializationDictionary = new Dictionary&lt;Type, Property[]&gt;(); protected Property[] _properties, _propertiesForBinarySerialization; protected BaseStorage[] _storages; public Model() { Type targetType = GetType(); if (!propertiesDictionary.ContainsKey(targetType)) RegisterModelsProperties(targetType, new List&lt;Property&gt;(), new List&lt;Property&gt;()); _properties = propertiesDictionary[targetType]; _storages = new BaseStorage[_properties.Length]; for (var i = 0; i &lt; _storages.Length; i++) _storages[i] = _properties[i].CreateStorage(); } private void RegisterModelsProperties(Type target, List&lt;Property&gt; registered, List&lt;Property&gt; registeredForBinary) { if (!propertiesDictionary.ContainsKey(target)) { if (target.BaseType != typeof(Model) &amp;&amp; typeof(Model).IsAssignableFrom(target.BaseType)) RegisterModelsProperties(target.BaseType, registered, registeredForBinary); var fields = target.GetFields(BindingFlags.Public | BindingFlags.Static); // | BindingFlags.DeclaredOnly List&lt;Property&gt; alphabeticSorted = new List&lt;Property&gt;(); for (int i = 0; i &lt; fields.Length; i++) { var field = fields[i]; if (typeof(Property).IsAssignableFrom(field.FieldType)) { var prop = field.GetValue(this) as Property; prop.Name = field.Name; prop.Parent = target; prop.storageIndex = registered.Count; registered.Add(prop); alphabeticSorted.Add(prop); } } alphabeticSorted.Sort((p1, p2) =&gt; String.Compare(p1.Name, p2.Name)); registeredForBinary.AddRange(alphabeticSorted); Property[] properties = new Property[registered.Count]; for (int i = 0; i &lt; registered.Count; i++) properties[i] = registered[i]; propertiesDictionary.Add(target, properties); properties = new Property[registered.Count]; for (int i = 0; i &lt; registeredForBinary.Count; i++) properties[i] = registeredForBinary[i]; propertiesForBinarySerializationDictionary.Add(target, properties); } else { registered.AddRange(propertiesDictionary[target]); registeredForBinary.AddRange(propertiesForBinarySerializationDictionary[target]); } } CastType IModelInternals.GetStorage&lt;CastType&gt;(Property property) { try { return (CastType)_storages[property.storageIndex]; } catch { UnityEngine.Debug.LogError(string.Format("{0}.GetStorage&lt;{1}&gt;({2})",GetType().Name, typeof(CastType).Name, property.ToString())); return null; } } #endregion }</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> O design √© um pouco simples, porque os descritores de propriedades est√°ticas declarados nos ancestrais deste modelo j√° podem ter √≠ndices de armazenamento registrados, e a ordem de retorno das propriedades de Type.GetFields () n√£o √© garantida. Para a ordem e para que as propriedades n√£o sejam reinicializadas em dois vezes, voc√™ precisa se monitorar. </font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Propriedades da cole√ß√£o </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na se√ß√£o da √°rvore de modelos, foi poss√≠vel notar uma constru√ß√£o que n√£o foi mencionada anteriormente: PDictionaryModel &lt;int, Persistent&gt; - um descritor para um campo que cont√©m uma cole√ß√£o. Est√° claro que teremos que criar nosso pr√≥prio reposit√≥rio para cole√ß√µes, que armazena informa√ß√µes sobre a apar√™ncia da cole√ß√£o antes do in√≠cio da transa√ß√£o e como ela √© agora. A pedra subaqu√°tica aqui √© do tamanho de uma Pedra do Trov√£o sob Peter I. Consiste no fato de que, tendo dois dicion√°rios longos √† m√£o, √© uma tarefa extremamente cara calcular o diferencial entre eles. Suponho que esses modelos devem ser usados ‚Äã‚Äãpara todas as tarefas relacionadas √† meta, o que significa que eles devem funcionar rapidamente. Em vez de armazenar dois estados, clon√°-los e compar√°-los com dispendiosos, fa√ßo um gancho complicado - apenas o estado atual do dicion√°rio √© armazenado na loja.Outros dois dicion√°rios s√£o valores exclu√≠dos,e valores antigos de elementos substitu√≠dos. Por fim, um conjunto de novas chaves adicionadas ao dicion√°rio √© armazenado. Essas informa√ß√µes s√£o preenchidas com facilidade e rapidez. √â f√°cil gerar todas as diferen√ßas necess√°rias com ela e √© suficiente restaurar o estado anterior, se necess√°rio. No c√≥digo, fica assim:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DictionaryStorage</span></span></span><span class="hljs-class">&lt;TKey, TValues&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; removed = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;TKey, TValues&gt; changedValues = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;TKey, TValues&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HashSet&lt;TKey&gt; newKeys = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;TKey&gt;(); }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o consegui criar um reposit√≥rio igualmente bonito para a Lista, ou n√£o tenho tempo suficiente, mantenho duas c√≥pias. √â necess√°rio um complemento adicional para tentar minimizar o tamanho do diff.</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListStorage</span></span></span><span class="hljs-class">&lt;TValue&gt; :</span></span> BaseStorage { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; current = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TValue&gt; previouse = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TValue&gt;(); <span class="hljs-comment"><span class="hljs-comment">//        public List&lt;int&gt; order = new List&lt;int&gt;(); //       . }</span></span></code> </pre> <br><h2>  Total </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ souber claramente o que deseja receber e como, poder√° escrever tudo isso em algumas semanas. A velocidade de desenvolvimento do jogo ao mesmo tempo muda t√£o dramaticamente que, quando tentei, nem comecei meus pr√≥prios jogos de cria√ß√£o de jogos sem ter um bom motor. S√≥ porque no primeiro m√™s o investimento para mim obviamente deu resultado. Obviamente, isso s√≥ se aplica √† meta. A jogabilidade tem que ser feita da maneira antiga. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na pr√≥xima parte do artigo, falarei sobre comandos, rede e previs√£o de respostas do servidor. E tamb√©m tenho algumas perguntas importantes para voc√™. Se suas respostas diferirem das apresentadas entre par√™nteses, terei prazer em l√™-las nos coment√°rios ou talvez voc√™ at√© escreva um artigo. Agradecemos antecipadamente pelas respostas.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PS: Uma proposta de coopera√ß√£o e instru√ß√µes sobre v√°rios erros de sintaxe, por favor, no PM. </font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434582/">https://habr.com/ru/post/pt434582/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434570/index.html">Simulador online minimalista de circuitos lineares de CC e CA</a></li>
<li><a href="../pt434574/index.html">Anima√ß√£o de sublinhado de link CSS puro</a></li>
<li><a href="../pt434576/index.html">Trabalhar com a API KOMPAS-3D ‚Üí Li√ß√£o 14 ‚Üí Texto de v√°rias linhas</a></li>
<li><a href="../pt434578/index.html">Higiene Digital: As Regras do Jogo</a></li>
<li><a href="../pt434580/index.html">Estat√≠sticas da torradeira de 2018</a></li>
<li><a href="../pt434584/index.html">Os dados s√£o engra√ßados (e aqui est√£o alguns exemplos)</a></li>
<li><a href="../pt434586/index.html">Aeronaves pessoais. Entenda e aguarde</a></li>
<li><a href="../pt434588/index.html">Resumindo o ano de 2018 no My Circle</a></li>
<li><a href="../pt434590/index.html">$ ls -l / home / avitotech / ano_ novo</a></li>
<li><a href="../pt434592/index.html">Elon Musk promete cobrir a Europa com a rede Tesla Supercharger no pr√≥ximo ano</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>