<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ·ï¸ ğŸ‘¨ğŸ¿â€ğŸ¤ ğŸ‘ŒğŸ¼ è¿™äº›å¤©çš„å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ ğŸ‘¼ğŸ¾ â›¹ğŸ¾ ğŸŒ¶ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ç®€è€Œè¨€ä¹‹ï¼š 


- è¯¥è¯æ˜å·²ç»åœ¨é€‚ç”¨äºJavaçš„ C ++ ï¼Œ JSå’ŒPHPä¸­å®ç°ã€‚ 
- æ¯”åç¨‹å’ŒPromise æ›´å¿« ï¼ŒåŠŸèƒ½æ›´å¤šã€‚ 
- å®ƒä¸éœ€è¦å•ç‹¬çš„è½¯ä»¶å †æ ˆã€‚ 
- ä¸æ‰€æœ‰å®‰å…¨å’Œè°ƒè¯•å·¥å…·æˆä¸ºæœ‹å‹ã€‚ 
- å®ƒé€‚ç”¨äºä»»ä½•ä½“ç³»ç»“æ„ï¼Œä¸éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨æ ‡å¿—ã€‚ 




- å›å¤´çœ‹ 
- FutoI...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>è¿™äº›å¤©çš„å¼‚æ­¥ä¸šåŠ¡é€»è¾‘</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/424311/"><p> ç®€è€Œè¨€ä¹‹ï¼š </p><br><blockquote><ul><li> è¯¥è¯æ˜å·²ç»åœ¨é€‚ç”¨äº<strong>Javaçš„</strong> <strong>C ++</strong> ï¼Œ <strong>JS</strong>å’Œ<strong>PHPä¸­</strong>å®ç°ã€‚ </li><li>æ¯”åç¨‹å’ŒPromise <strong>æ›´å¿«</strong> ï¼ŒåŠŸèƒ½æ›´å¤šã€‚ </li><li> å®ƒä¸éœ€è¦å•ç‹¬çš„è½¯ä»¶å †æ ˆã€‚ </li><li> ä¸æ‰€æœ‰å®‰å…¨å’Œè°ƒè¯•å·¥å…·æˆä¸ºæœ‹å‹ã€‚ </li><li> å®ƒé€‚ç”¨äºä»»ä½•ä½“ç³»ç»“æ„ï¼Œä¸éœ€è¦ç‰¹æ®Šçš„ç¼–è¯‘å™¨æ ‡å¿—ã€‚ </li></ul><br></blockquote><a name="habracut"></a><br><hr><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å›å¤´çœ‹</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FutoIn AsyncSteps-åç¨‹çš„æ›¿ä»£å“</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åˆ°æ•°å­—</a> </li></ul><br><h2 id="vzglyad-nazad"> å›å¤´çœ‹ </h2><br><p> åœ¨è®¡ç®—æœºè¯ç”Ÿä¹‹åˆï¼Œåªæœ‰ä¸€ä¸ªæ§åˆ¶æµï¼Œä½†é˜»å¡äº†è¾“å…¥è¾“å‡ºã€‚ ç„¶åé“ä¸­æ–­æ·»åŠ åˆ°å®ƒã€‚ ç°åœ¨ï¼Œæ‚¨å¯ä»¥æœ‰æ•ˆåœ°ä½¿ç”¨ç¼“æ…¢ä¸”ä¸å¯é¢„æµ‹çš„è®¾å¤‡ã€‚ </p><br><p> éšç€ç†¨æ–—åŠŸèƒ½çš„å¢é•¿å’Œå¯ç”¨æ€§çš„é™ä½ï¼Œå¿…é¡»åŒæ—¶æ‰§è¡Œå¤šé¡¹ä»»åŠ¡ï¼Œä»è€Œæä¾›ç¡¬ä»¶æ”¯æŒã€‚ å› æ­¤ï¼Œå­˜åœ¨éš”ç¦»çš„è¿‡ç¨‹ï¼Œå…¶ä¸­ä¸­æ–­ä»¥ä¿¡å·çš„å½¢å¼ä»é“ä¸­æŠ½è±¡å‡ºæ¥ã€‚ </p><br><p> ä¸‹ä¸€ä¸ªæ¼”è¿›é˜¶æ®µæ˜¯å¤šçº¿ç¨‹ï¼Œå®ƒæ˜¯åœ¨ç›¸åŒè¿›ç¨‹çš„åŸºç¡€ä¸Šå®ç°çš„ï¼Œä½†æ˜¯å…±äº«è®¿é—®å†…å­˜å’Œå…¶ä»–èµ„æºã€‚ è¿™ç§æ–¹æ³•æœ‰å…¶å±€é™æ€§ï¼Œè€Œä¸”åˆ‡æ¢åˆ°å®‰å…¨OSçš„å¼€é”€ä¹Ÿå¾ˆå¤§ã€‚ </p><br><p> ä¸ºäº†åœ¨æµç¨‹ç”šè‡³ä¸åŒçš„æœºå™¨ä¹‹é—´è¿›è¡Œé€šä¿¡ï¼Œ40å¹´å‰å°±æå‡ºäº†Promise / FutureæŠ½è±¡ã€‚ </p><br><p> ç”¨æˆ·ç•Œé¢å’Œå½“å‰å¯ç¬‘çš„10Kå®¢æˆ·ç«¯é—®é¢˜å¯¼è‡´äº†äº‹ä»¶å¾ªç¯ï¼Œååº”å™¨å’ŒProactoræ–¹æ³•çš„é¼ç››æ—¶æœŸï¼Œå®ƒä»¬æ¯”æ¸…æ™°ï¼Œä¸€è‡´çš„ä¸šåŠ¡é€»è¾‘æ›´é¢å‘äº‹ä»¶ã€‚ </p><br><p> æœ€åï¼Œæˆ‘ä»¬ä»‹ç»äº†ç°ä»£åç¨‹ï¼ˆåç¨‹ï¼‰ï¼Œæœ¬è´¨ä¸Šæ˜¯åœ¨ä¸Šè¿°æŠ½è±¡ä¹‹ä¸Šå¯¹æµç¨‹è¿›è¡Œçš„ä»¿çœŸï¼Œå…·æœ‰ç›¸åº”çš„æŠ€æœ¯å±€é™æ€§å’Œæ§åˆ¶æƒçš„ç¡®å®šæ€§è½¬ç§»ã€‚ </p><br><p> ä¸ºäº†ä¼ è¾¾äº‹ä»¶ï¼Œç»“æœå’Œå¼‚å¸¸ï¼Œå®ƒä»¬éƒ½å›åˆ°äº†â€œæ‰¿è¯º/æœªæ¥â€çš„ç›¸åŒæ¦‚å¿µã€‚ ä¸€äº›åŠå…¬å®¤å†³å®šä½¿ç”¨ä¸åŒçš„åç§°-â€œä»»åŠ¡â€ã€‚ </p><br><p>æœ€åï¼Œä»–ä»¬å°†æ‰€æœ‰å†…å®¹éƒ½éšè—åœ¨æ¼‚äº®çš„<code>async/await</code>åŒ…ä¸­ï¼Œè¿™å–å†³äºæŠ€æœ¯è¦æ±‚ç¼–è¯‘å™¨æˆ–ç¿»è¯‘å™¨æ”¯æŒã€‚ </p><br><h3 id="problemy-s-tekuschiy-situaciy-asinhronnoy-biznes-logiki"> å½“å‰å¼‚æ­¥ä¸šåŠ¡é€»è¾‘æƒ…å†µçš„é—®é¢˜ </h3><br><p> ä»…è€ƒè™‘ç”¨<code>async/await</code>è£…é¥°çš„åç¨‹å’ŒPromiseï¼Œä½œä¸º æ—§æ–¹æ³•ä¸­é—®é¢˜çš„å­˜åœ¨è¯å®äº†è¿›åŒ–è¿‡ç¨‹æœ¬èº«ã€‚ </p><br><p> è¿™ä¸¤ä¸ªæœ¯è¯­ä¸ç›¸åŒã€‚ ä¾‹å¦‚ï¼Œåœ¨ECMAScriptä¸­ï¼Œæ²¡æœ‰åç¨‹ï¼Œä½†æ˜¯ä½¿ç”¨<code>Promise</code>å‡è½»è¯­æ³•çš„è´Ÿæ‹…ï¼Œè€Œ<code>Promise</code>åªèƒ½ä½¿ç”¨å›è°ƒåœ°ç‹±æ¥ç»„ç»‡å·¥ä½œã€‚ å®é™…ä¸Šï¼ŒåƒV8è¿™æ ·çš„è„šæœ¬å¼•æ“èµ°å¾—æ›´è¿œï¼Œå¹¶å¯¹çº¯<code>async/await</code>å‡½æ•°å’Œè°ƒç”¨è¿›è¡Œäº†ç‰¹æ®Šçš„ä¼˜åŒ–ã€‚ </p><br><p> ä¸“å®¶<code>co_async/co_await</code>å¹¶æ²¡æœ‰åŒ…å«åœ¨C ++ 17ä¸­ï¼Œä½†æ˜¯æ¥è‡ªè½¯ä»¶å·¨å¤´åç¨‹çš„å‹åŠ›å¯ä»¥å®Œå…¨ä»¥å®ƒä»¬çš„å½¢å¼å‡ºç°åœ¨æ ‡å‡†ä¸­ã€‚ åŒæ—¶ï¼Œä¼ ç»Ÿä¸Šå…¬è®¤çš„è§£å†³æ–¹æ¡ˆæ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Boost.Context</a> ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Boost.Fiber</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Boost.Coroutine2</a> ã€‚ </p><br><p> åœ¨Javaä¸­ï¼Œåœ¨è¯­è¨€çº§åˆ«ä¸Šä»ç„¶æ²¡æœ‰<code>async/await</code> ï¼Œä½†æ˜¯æœ‰è¯¸å¦‚<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">EA Asyncä¹‹</a>ç±»çš„è§£å†³æ–¹æ¡ˆï¼ŒåƒBoost.Contextä¸€æ ·ï¼Œéœ€è¦é’ˆå¯¹æ¯ä¸ªç‰ˆæœ¬çš„JVMå’Œä»£ç å­—èŠ‚è¿›è¡Œè‡ªå®šä¹‰ã€‚ </p><br><p>  Goæœ‰å…¶è‡ªå·±çš„åç¨‹ï¼Œä½†æ˜¯å¦‚æœæ‚¨ä»”ç»†æŸ¥çœ‹å¼€æ”¾é¡¹ç›®çš„æ–‡ç« å’Œé”™è¯¯æŠ¥å‘Šï¼Œäº‹å®è¯æ˜è¿™é‡Œçš„ä¸€åˆ‡éƒ½ä¸é‚£ä¹ˆé¡ºåˆ©ã€‚ ä¹Ÿè®¸å¤±å»åç¨‹æ¥å£ä½œä¸ºæ‰˜ç®¡å®ä½“ä¸æ˜¯ä¸€ä¸ªå¥½ä¸»æ„ã€‚ </p><br><h4 id="mnenie-avtora-soprogrammy-na-golom-zheleze-opasny"> ä½œè€…çš„æ„è§ï¼šè£¸éœ²çš„åç¨‹å¾ˆå±é™© </h4><br><p> å°±ä¸ªäººè€Œè¨€ï¼Œä½œè€…å¾ˆå°‘åå¯¹ä½¿ç”¨åŠ¨æ€è¯­è¨€ç¼–å†™çš„åç¨‹ï¼Œä½†æ˜¯ä»–éå¸¸è­¦æƒ•ä»»ä½•åœ¨æœºå™¨ä»£ç çº§åˆ«ä¸Šå¯¹å †æ ˆçš„è°ƒæƒ…ã€‚ </p><br><p> å‡ ç‚¹ï¼š </p><br><ol><li> éœ€è¦å †å ï¼š <br><ul><li> å †ä¸Šçš„å †æ ˆæœ‰è®¸å¤šç¼ºç‚¹ï¼šæ— æ³•åŠæ—¶ç¡®å®šæº¢å‡ºï¼Œé‚»å±…æŸåå’Œå…¶ä»–å¯é æ€§/å®‰å…¨æ€§é—®é¢˜çš„é—®é¢˜ï¼Œ </li><li> ä¸€ä¸ªå®‰å…¨å †æ ˆè‡³å°‘éœ€è¦ä¸€é¡µç‰©ç†å†…å­˜ï¼Œä¸€ä¸ªæ¡ä»¶é¡µä»¥åŠæ¯æ¬¡è°ƒç”¨<code>async</code>å‡½æ•°çš„é¢å¤–å¼€é”€ï¼š4 + KBï¼ˆæœ€å°ï¼‰+å¢åŠ çš„ç³»ç»Ÿé™åˆ¶ï¼Œ </li><li> æœ€ç»ˆï¼Œå¯èƒ½æ˜¯åœ¨åç¨‹åœæœºæœŸé—´æœªä½¿ç”¨åˆ†é…ç»™å †æ ˆçš„å¤§éƒ¨åˆ†å†…å­˜ã€‚ </li></ul></li><li> æœ‰å¿…è¦å®ç°ä¸€ä¸ªå¤æ‚çš„é€»è¾‘æ¥ä¿å­˜ï¼Œæ¢å¤å’Œåˆ é™¤åç¨‹çŠ¶æ€ï¼š <br><ul><li> å¯¹äºå¤„ç†å™¨æ¶æ„ï¼ˆç”šè‡³æ¨¡å‹ï¼‰å’ŒäºŒè¿›åˆ¶æ¥å£ï¼ˆABIï¼‰çš„æ¯ç§æƒ…å†µï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">example</a> ï¼Œ </li><li> æ–°çš„æˆ–å¯é€‰çš„æ¶æ„åŠŸèƒ½ä¼šå¸¦æ¥æ½œåœ¨çš„æ½œåœ¨é—®é¢˜ï¼ˆä¾‹å¦‚ï¼Œè‹±ç‰¹å°”TSXï¼ŒARMåå¤„ç†å™¨æˆ–MIPSï¼‰ï¼Œ </li><li> ç”±äºä¸“æœ‰ç³»ç»Ÿè€Œå¯¼è‡´çš„å…¶ä»–æ½œåœ¨é—®é¢˜å·²å…³é—­æ–‡æ¡£ï¼ˆBoostæ–‡æ¡£æ˜¯ä¸æ­¤ç›¸å…³çš„æ–‡æ¡£ï¼‰ã€‚ </li></ul></li><li> åŠ¨æ€åˆ†æå·¥å…·å’Œæ€»ä½“å®‰å…¨æ€§æ–¹é¢çš„æ½œåœ¨é—®é¢˜ï¼š <br><ul><li> ä¾‹å¦‚ï¼Œç”±äºç›¸åŒçš„è·³è·ƒå †æ ˆï¼Œå› æ­¤å¿…é¡»ä¸Valgrindé›†æˆï¼Œ </li><li> æ€æ¯’è½¯ä»¶å¾ˆéš¾è¯´ï¼Œä½†åœ¨è¿‡å»çš„JVMé—®é¢˜ç¤ºä¾‹ä¸­ï¼Œå®ƒä»¬å¯èƒ½å¹¶ä¸ååˆ†å–œæ¬¢å®ƒï¼Œ </li><li> æˆ‘æ•¢è‚¯å®šï¼Œå°†ä¼šå‡ºç°æ–°çš„æ”»å‡»ç±»å‹ï¼Œå¹¶ä¸”å°†æ­ç¤ºä¸å®æ–½åç¨‹ç›¸å…³çš„æ¼æ´ã€‚ </li></ul></li></ol><br><h4 id="mnenie-avtora-generatory-i-yield-principialnoe-zlo"> ä½œè€…çš„è§‚ç‚¹ï¼šå‘ç”µæœºå’Œ<code>yield</code>æ ¹æœ¬çš„é‚ªæ¶ </h4><br><p> è¿™ä¸ªçœ‹ä¼¼ç¬¬ä¸‰æ–¹çš„ä¸»é¢˜ä¸åç¨‹çš„æ¦‚å¿µå’Œâ€œ continueâ€å±æ€§ç›´æ¥ç›¸å…³ã€‚ </p><br><p> ç®€è€Œè¨€ä¹‹ï¼Œä»»ä½•é›†åˆéƒ½å¿…é¡»å­˜åœ¨å®Œæ•´çš„è¿­ä»£å™¨ã€‚ ä¸ºä»€ä¹ˆåˆ›å»ºè£å‰ªçš„è¿­ä»£å™¨-ç”Ÿæˆå™¨é—®é¢˜å°šä¸æ¸…æ¥šã€‚ ä¾‹å¦‚ï¼Œåœ¨Pythonä¸­å¸¦æœ‰<code>range()</code>çš„æƒ…å†µæ¯”æŠ€æœ¯å¤æ‚åŒ–çš„å€Ÿå£æ›´åƒæ˜¯æ’ä»–æ€§ç‚«è€€ã€‚ </p><br><p> å¦‚æœæƒ…å†µæ˜¯æ— é™ç”Ÿæˆå™¨ï¼Œåˆ™å…¶å®ç°çš„é€»è¾‘æ˜¯åŸºæœ¬çš„ã€‚ ä¸ºä»€ä¹ˆè¦å¢åŠ é¢å¤–çš„æŠ€æœ¯éš¾åº¦ä»¥æ¨åŠ¨ä¸æ–­å‘å±•çš„å‘¨æœŸã€‚ </p><br><p> åç¨‹çš„æ”¯æŒè€…åæ¥æå‡ºçš„å”¯ä¸€æ˜æ™ºçš„ç†ç”±æ˜¯ï¼Œå„ç§å…·æœ‰åå‘æ§åˆ¶çš„æµè§£æå™¨ã€‚ å®é™…ä¸Šï¼Œè¿™æ˜¯åœ¨åº“çº§åˆ«è§£å†³å•ä¸ªé—®é¢˜çš„ç‹­ä¹‰ä¸“ä¸šæ¡ˆä¾‹ï¼Œè€Œä¸æ˜¯åº”ç”¨ç¨‹åºçš„ä¸šåŠ¡é€»è¾‘ã€‚ åŒæ—¶ï¼Œé€šè¿‡æœ‰é™çŠ¶æ€æœºæä¾›äº†ä¸€ç§ä¼˜é›…ï¼Œç®€å•ä¸”æ›´å…·æè¿°æ€§çš„è§£å†³æ–¹æ¡ˆã€‚ è¿™äº›æŠ€æœ¯é—®é¢˜çš„èŒƒå›´æ¯”æ™®é€šä¸šåŠ¡é€»è¾‘çš„èŒƒå›´å°å¾—å¤šã€‚ </p><br><p> å®é™…ä¸Šï¼Œè¦è§£å†³çš„é—®é¢˜æ˜¯ä»æ‰‹æŒ‡ä¸Šè·å¾—çš„ï¼Œå¹¶ä¸”éœ€è¦ç›¸å¯¹è®¤çœŸçš„åŠªåŠ›æ¥è¿›è¡Œåˆå§‹å®æ–½å’Œé•¿æœŸæ”¯æŒã€‚ å¦‚æ­¤ä¹‹å¤šï¼Œä»¥è‡³äºæŸäº›é¡¹ç›®å¯èƒ½ä¼šåœ¨ç¦æ­¢ä½¿ç”¨<code>goto</code>æˆ–åœ¨å„ä¸ªè¡Œä¸šä¸­ä½¿ç”¨åŠ¨æ€å†…å­˜åˆ†é…çš„ç¤ºä¾‹åï¼Œç¦æ­¢ä½¿ç”¨æœºå™¨ä»£ç çº§ååŒç¨‹åºã€‚ </p><br><h4 id="mnenie-avtora-model-asyncawait-na-promise-iz-ecmascript-bolee-nadyozhna-no-trebuet-adaptacii"> ä½œè€…æ„è§ï¼šECMAScriptçš„<code>async/await</code> Promiseæ¨¡å‹æ›´å¯é ï¼Œä½†éœ€è¦ä¿®æ”¹ </h4><br><p> ä¸è¿ç»­åç¨‹ä¸åŒï¼Œåœ¨æ­¤æ¨¡å‹ä¸­ï¼Œä»£ç æ®µè¢«ç§˜å¯†åœ°åˆ’åˆ†ä¸ºè®¾è®¡ä¸ºåŒ¿åå‡½æ•°çš„ä¸å¯ä¸­æ–­å—ã€‚ åœ¨C ++ä¸­ï¼Œç”±äºå†…å­˜ç®¡ç†çš„ç‰¹æ®Šæ€§ï¼Œè¿™å¹¶ä¸å®Œå…¨é€‚åˆï¼Œä¾‹å¦‚ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SomeObject</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Value = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">vector</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">funcPromise</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Promise.resolved(value_); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">funcCallback</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::function&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">()&gt; &amp;&amp;cb, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Value&amp; val)</span></span></span><span class="hljs-function"> </span></span>{ somehow_call_later(cb); } Value value_; }; <span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SomeObject some_obj; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> some_obj.funcPromise() .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>([](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception &amp;e){ <span class="hljs-comment"><span class="hljs-comment">// ... }) .then([&amp;](SomeObject::value &amp;&amp;val){ return Promise([&amp;](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ some_obj.funcCallback(resolve, val); }); }); }</span></span></code> </pre> <br><p> é¦–å…ˆï¼Œé€€å‡º<code>example()</code>ä»¥åŠè°ƒç”¨lambdaå‡½æ•°ä¹‹å‰ï¼Œ <code>some_obj</code>å°†è¢«é”€æ¯ã€‚ </p><br><p> å…¶æ¬¡ï¼Œå…·æœ‰æ•è·å˜é‡æˆ–å¼•ç”¨çš„lambdaå‡½æ•°æ˜¯å¯¹è±¡ï¼Œå¹¶ç§˜å¯†åœ°æ·»åŠ å¤åˆ¶/ç§»åŠ¨ï¼Œè¿™å¯èƒ½ä¼šå¯¹å…·æœ‰å¤§é‡æ•è·çš„æ€§èƒ½äº§ç”Ÿè´Ÿé¢å½±å“ï¼Œå¹¶ä¸”éœ€è¦åœ¨é€šå¸¸çš„<code>std::function</code>åœ¨ç±»å‹æ“¦é™¤æœŸé—´åœ¨å †ä¸Šåˆ†é…å†…å­˜ã€‚ </p><br><p> ç¬¬ä¸‰ï¼Œ <code>Promise</code>æ¥å£æœ¬èº«æ˜¯åŸºäºç»“æœçš„â€œæ‰¿è¯ºâ€æ¦‚å¿µï¼Œè€Œä¸æ˜¯ä¸šåŠ¡é€»è¾‘çš„ä¸€è‡´æ‰§è¡Œã€‚ </p><br><p> åŸç†å›¾éæœ€ä½³è§£å†³æ–¹æ¡ˆå¯èƒ½çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">Promise </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LocalContext</span></span></span><span class="hljs-class"> {</span></span> SomeObject some_obj; }; <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> ctx = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::make_shared&lt;LocalContext&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> some_obj.funcPromise() .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>([](<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception &amp;e){ <span class="hljs-comment"><span class="hljs-comment">// ... }) .then([ctx](SomeObject::Value &amp;&amp;val){ struct LocalContext2 { LocalContext2(std::shared_ptr&lt;LocalContext&gt; &amp;&amp;ctx, SomeObject::Value &amp;&amp;val) : ctx(ctx), val(val) {} std::shared_ptr&lt;LocalContext&gt; ctx; SomeObject::Value val; }; auto ctx2 = std::make_shared&lt;LocalContext2&gt;( std::move(ctx), std::forward&lt;SomeObject::Value&gt;(val) ); return Promise([ctx2](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ ctx2-&gt;ctx-&gt;some_obj.funcCallback([ctx2, resolve](){ resolve(); }, val); }); }); }</span></span></code> </pre> <br><p>  <em>æ³¨æ„ï¼š <code>std::move</code>è€Œä¸æ˜¯<code>std::shared_ptr</code>ä¸åˆé€‚çš„ï¼Œå› ä¸ºå®ƒæ— æ³•ä¸€æ¬¡è½¬ç§»åˆ°å¤šä¸ªlambdaï¼Œå¹¶ä¸”å®ƒä»¬çš„å¤§å°ä¼šå¢åŠ ã€‚</em> </p><br><p> éšç€<code>async/await</code>å¼‚æ­¥ææ€–è¿›å…¥äº†ä¸€ç§å¯æ¶ˆåŒ–çš„çŠ¶æ€ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">async </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">example</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ SomeObject some_obj; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { SomeObject::Value val = await some_obj.func(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::exception&amp; e) ( <span class="hljs-comment"><span class="hljs-comment">// ... } // Capture "async context" return Promise([async](Resolve&amp;&amp; resolve, Reject&amp;&amp;){ some_obj.funcCallback([async](){ resolve(); }, val); }); }</span></span></code> </pre> <br><h4 id="mnenie-avtora-planirovschik-soprogramm---eto-perebor"> ä½œè€…è§‚ç‚¹ï¼šåç¨‹ç­–åˆ’å¸ˆæ˜¯åŠèº«åƒ </h4><br><p> ä¸€äº›æ‰¹è¯„å®¶ç§°ç¼ºå°‘è°ƒåº¦ç¨‹åºå’Œå¯¹å¤„ç†å™¨èµ„æºçš„â€œä¸è¯šå®â€ä½¿ç”¨æ˜¯ä¸€ä¸ªé—®é¢˜ã€‚ ä¹Ÿè®¸æ›´ä¸¥é‡çš„é—®é¢˜æ˜¯æ•°æ®å±€éƒ¨æ€§å’Œå¤„ç†å™¨ç¼“å­˜çš„æœ‰æ•ˆåˆ©ç”¨ã€‚ </p><br><p> å…³äºç¬¬ä¸€ä¸ªé—®é¢˜ï¼šåœ¨å„ä¸ªåç¨‹çº§åˆ«ä¸Šè¿›è¡Œä¼˜å…ˆçº§æ’åºä¼¼ä¹å¼€é”€å¾ˆå¤§ã€‚ ç›¸åï¼Œå®ƒä»¬å¯ä»¥ä¸ºç‰¹å®šçš„ç»Ÿä¸€ä»»åŠ¡å…±åŒæ“ä½œã€‚ è¿™å°±æ˜¯æµé‡çš„ä½œç”¨ã€‚ </p><br><p> è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨å…¶è‡ªå·±çš„â€œé“â€çº¿ç¨‹åˆ›å»ºå•ç‹¬çš„Event Loopå®ä¾‹å¹¶åœ¨æ“ä½œç³»ç»Ÿçº§åˆ«è¿›è¡Œè®¡åˆ’æ¥å®ç°ã€‚ ç¬¬äºŒç§é€‰æ‹©æ˜¯åœ¨ç«äº‰å’Œ/æˆ–æ€§èƒ½æ–¹é¢å°†åç¨‹ä¸ç›¸å¯¹åŸå§‹çš„ï¼ˆMutexï¼ŒThrottleï¼‰åŸå§‹åŒæ­¥ã€‚ </p><br><p> å¼‚æ­¥ç¼–ç¨‹ä¸ä¼šä½¿å¤„ç†å™¨èµ„æºå…·æœ‰å¼¹æ€§ï¼Œå¹¶ä¸”éœ€è¦å¯¹åŒæ—¶å¤„ç†çš„ä»»åŠ¡æ•°é‡å’Œæ€»æ‰§è¡Œæ—¶é—´è¿›è¡Œç»å¯¹æ­£å¸¸çš„é™åˆ¶ã€‚ </p><br><p> é˜²æ­¢åœ¨ä¸€ä¸ªåç¨‹ä¸Šé•¿æ—¶é—´é˜»å¡éœ€è¦é‡‡å–ä¸å›è°ƒç›¸åŒçš„æªæ–½-é¿å…é˜»å¡ç³»ç»Ÿè°ƒç”¨å’Œå†—é•¿çš„æ•°æ®å¤„ç†å‘¨æœŸã€‚ </p><br><p> ç¬¬äºŒä¸ªé—®é¢˜éœ€è¦ç ”ç©¶ï¼Œä½†è‡³å°‘åç¨‹æœ¬èº«ä¼šå †å åœ¨ä¸€èµ·ï¼Œå¹¶ä¸”Future / Promiseå®ç°çš„è¯¦ç»†ä¿¡æ¯å·²ç»è¿åäº†æ•°æ®çš„å±€éƒ¨æ€§ã€‚ å¦‚æœå°†æ¥å·²ç»å¾ˆé‡è¦ï¼Œåˆ™æœ‰æœºä¼šå°è¯•ç»§ç»­æ‰§è¡Œç›¸åŒçš„åç¨‹ã€‚ ä¸ºäº†é˜²æ­¢ä¸€ä¸ªåç¨‹æ•è·æ•´ä¸ªå¤„ç†å™¨æ—¶é—´ï¼Œéœ€è¦æŸç§æœºåˆ¶æ¥è®¡ç®—æ‰§è¡Œæ—¶é—´æˆ–è¿™ç§è¿ç»­çš„æ¬¡æ•°ã€‚ æ ¹æ®å¤„ç†å™¨ç¼“å­˜çš„å¤§å°å’Œçº¿ç¨‹æ•°çš„ä¸åŒï¼Œè¿™å¯èƒ½ä¸ä¼šç»™å‡ºç»“æœï¼Œæˆ–è€…ç»™å‡ºéå¸¸åŒé‡çš„ç»“æœã€‚ </p><br><p> è¿˜æœ‰ç¬¬ä¸‰ç‚¹-åç¨‹è°ƒåº¦ç¨‹åºçš„è®¸å¤šå®ç°å…è®¸æ‚¨åœ¨ä¸åŒçš„å¤„ç†å™¨å†…æ ¸ä¸Šè¿è¡Œå®ƒä»¬ï¼Œç›¸åï¼Œç”±äºåœ¨è®¿é—®å…±äº«èµ„æºæ—¶è¿›è¡Œå¼ºåˆ¶åŒæ­¥ï¼Œå› æ­¤å¢åŠ äº†é—®é¢˜ã€‚ åœ¨å•ä¸ªäº‹ä»¶å¾ªç¯æµçš„æƒ…å†µä¸‹ï¼Œä»…åœ¨é€»è¾‘çº§åˆ«éœ€è¦è¿™ç§åŒæ­¥ï¼Œå› ä¸º ä¿è¯æ¯ä¸ªåŒæ­¥å›è°ƒå—éƒ½å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œè€Œä¸ä¼šä¸å…¶ä»–ç»„ä»¶ç«äº‰ã€‚ </p><br><h4 id="mnenie-avtora-vsyo-horosho-v-meru"> ä½œè€…çš„è§‚ç‚¹ï¼šä¸€åˆ‡éƒ½è¦é€‚åº¦ </h4><br><p> ç°ä»£æ“ä½œç³»ç»Ÿä¸­çº¿ç¨‹çš„å­˜åœ¨ä¸ä¼šå¦å®šå•ä¸ªè¿›ç¨‹çš„ä½¿ç”¨ã€‚ åŒæ ·ï¼Œåœ¨äº‹ä»¶å¾ªç¯ä¸­å¤„ç†å¤§é‡å®¢æˆ·ç«¯å¹¶ä¸ä¼šå¦å®šå°†éš”ç¦»çš„â€œé“â€çº¿ç¨‹ç”¨äºå…¶ä»–éœ€æ±‚ã€‚ </p><br><p> æ— è®ºå¦‚ä½•ï¼Œåç¨‹å’Œäº‹ä»¶å¾ªç¯çš„å„ç§å˜ä½“åœ¨æ²¡æœ‰å¿…è¦å·¥å…·æ”¯æŒçš„æƒ…å†µä¸‹ä½¿è°ƒè¯•è¿‡ç¨‹å¤æ‚åŒ–ï¼Œå¹¶ä¸”åœ¨åç¨‹å †æ ˆä¸Šå…·æœ‰å±€éƒ¨å˜é‡ï¼Œä¸€åˆ‡éƒ½å˜å¾—æ›´åŠ å›°éš¾-å‡ ä¹æ²¡æœ‰åŠæ³•è·å¾—å®ƒä»¬ã€‚ </p><br><hr><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2p/pp/lb/2ppplbzrvm8c0yvbasdwrojknss.png" width="326" height="326"></div><br><h2 id="futoin-asyncsteps---alternativa-soprogrammam">  FutoIn AsyncSteps-åç¨‹çš„æ›¿ä»£å“ </h2><br><p> æˆ‘ä»¬ä»¥å·²ç»å»ºç«‹çš„äº‹ä»¶å¾ªç¯æ¨¡å¼å’Œæ ¹æ®ECMAScriptï¼ˆJavaScriptï¼‰Promiseç±»å‹çš„å›è°ƒæ–¹æ¡ˆçš„ç»„ç»‡ä¸ºåŸºç¡€ã€‚ </p><br><p> åœ¨æ‰§è¡Œè®¡åˆ’æ–¹é¢ï¼Œæˆ‘ä»¬å¯¹Event Loopçš„ä»¥ä¸‹æ´»åŠ¨æ„Ÿå…´è¶£ï¼š </p><br><ol><li>  <code>Handle immediate(callack)</code>éœ€è¦å¹²å‡€è°ƒç”¨å †æ ˆçš„<code>Handle immediate(callack)</code> ã€‚ </li><li>  Deferred callbackå»¶è¿Ÿ<code>Handle deferred(delay, callback)</code> ã€‚ </li><li> å–æ¶ˆå›è°ƒ<code>handle.cancel()</code> ã€‚ </li></ol><br><p> å› æ­¤ï¼Œæˆ‘ä»¬è·å¾—äº†ä¸€ä¸ªåä¸º<code>AsyncTool</code>çš„æ¥å£ï¼Œè¯¥æ¥å£å¯ä»¥é€šè¿‡å¤šç§æ–¹å¼å®ç°ï¼ŒåŒ…æ‹¬åœ¨ç°æœ‰çš„ç»è¿‡éªŒè¯çš„å¼€å‘ä¹‹ä¸Šã€‚ ä»–ä¸ç¼–å†™ä¸šåŠ¡é€»è¾‘æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œå› æ­¤æˆ‘ä»¬ä¸å†èµ˜è¿°ã€‚ </p><br><h3 id="derevo-shagov"> æ­¥éª¤æ ‘ï¼š </h3><br><p> åœ¨AsyncStepsæ¦‚å¿µä¸­ï¼Œé€šè¿‡æ·±å…¥åˆ›å»ºåºåˆ—æ¥æ’åˆ—å¹¶æ‰§è¡ŒåŒæ­¥æ­¥éª¤çš„æŠ½è±¡æ ‘ã€‚ å®Œæˆè¿™æ ·çš„é€šé“åï¼Œå°†åŠ¨æ€è®¾ç½®æ¯ä¸ªæ›´æ·±å±‚æ¬¡çš„æ­¥éª¤ã€‚ </p><br><p> æ‰€æœ‰äº¤äº’éƒ½é€šè¿‡å•ä¸ª<code>AsyncSteps</code>æ¥å£è¿›è¡Œï¼ŒæŒ‰ç…§çº¦å®šï¼Œè¯¥æ¥å£ä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’åˆ°æ¯ä¸ªæ­¥éª¤ã€‚ æŒ‰ç…§æƒ¯ä¾‹ï¼Œå‚æ•°åç§°ä¸º<code>asi</code>æˆ–ä¸å»ºè®®ä½¿ç”¨ã€‚ è¿™ç§æ–¹æ³•ä½¿æ‚¨å‡ ä¹å¯ä»¥å®Œå…¨æ‰“ç ´ç‰¹å®šå®ç°ä¹‹é—´çš„è”ç³»ï¼Œå¹¶åœ¨æ’ä»¶å’Œåº“ä¸­ç¼–å†™ä¸šåŠ¡é€»è¾‘ã€‚ </p><br><p> åœ¨è§„èŒƒçš„å®ç°ä¸­ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½ä¼šæ”¶åˆ°è‡ªå·±çš„å¯¹è±¡å®ä¾‹ï¼Œè¯¥å¯¹è±¡å®ç°<code>AsyncSteps</code> ï¼Œè¯¥å®ä¾‹å…è®¸åœ¨ä½¿ç”¨æ¥å£æ—¶åŠæ—¶è·Ÿè¸ªé€»è¾‘é”™è¯¯ã€‚ </p><br><p> æŠ½è±¡ç¤ºä¾‹ï¼š </p><br><pre> <code class="hljs lua"> asi.add( // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> func( asi ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func"</span></span> ) asi.add( // Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> func( asi ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 func"</span></span> ) asi.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>( <span class="hljs-string"><span class="hljs-string">"MyError"</span></span> ) }, onerror( asi, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ){ // Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> catch <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 onerror: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ) asi.<span class="hljs-built_in"><span class="hljs-built_in">error</span></span>( <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) } ) }, onerror( asi, <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ){ // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> catch <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 onerror: "</span></span> + <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">error</span></span> strequal <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) { asi.success( <span class="hljs-string"><span class="hljs-string">"Prm"</span></span>, <span class="hljs-number"><span class="hljs-number">123</span></span>, [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>], <span class="hljs-literal"><span class="hljs-literal">true</span></span>) } } ) asi.add( // Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">2</span></span> func( asi, str_param, int_param, array_param ){ <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func2: "</span></span> + param ) } )</code> </pre> <br><p> æ‰§è¡Œç»“æœï¼š </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> func <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> func <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> onerror <span class="hljs-number"><span class="hljs-number">1</span></span>: MyError <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> onerror <span class="hljs-number"><span class="hljs-number">1</span></span>: NewError <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> func <span class="hljs-number"><span class="hljs-number">2</span></span>: Prm</code> </pre> <br><p> åŒæ­¥æ˜¾ç¤ºå¦‚ä¸‹ï¼š </p><br><pre> <code class="hljs coffeescript"> str_res, int_res, array_res, bool_res <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func 1"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 func 1"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"MyError"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>( error ){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">1</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 1 onerror 1: "</span></span> + error ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>( error ){ <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 onerror 1: "</span></span> + error ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( error strequal <span class="hljs-string"><span class="hljs-string">"NewError"</span></span> ) { str_res = <span class="hljs-string"><span class="hljs-string">"Prm"</span></span> int_res = <span class="hljs-number"><span class="hljs-number">123</span></span> array_res = [<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>] bool_res = <span class="hljs-literal"><span class="hljs-literal">true</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { re-<span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> } } { <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Level <span class="hljs-number"><span class="hljs-number">0</span></span> step <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>( <span class="hljs-string"><span class="hljs-string">"Level 0 func 2: "</span></span> + str_res ) }</code> </pre> <br><p> ä¼ ç»ŸåŒæ­¥ä»£ç çš„æœ€å¤§æ¨¡ä»¿æ˜¯ç«‹å³å¯è§çš„ï¼Œè¿™åº”è¯¥æœ‰åŠ©äºæé«˜å¯è¯»æ€§ã€‚ </p><br><p> ä»ä¸šåŠ¡é€»è¾‘çš„è§’åº¦æ¥çœ‹ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¤§é‡éœ€æ±‚</a>éšæ—¶é—´å¢é•¿ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥å°†å…¶åˆ†ä¸ºæ˜“äºç†è§£çš„éƒ¨åˆ†ã€‚ å¦‚ä¸‹æ‰€è¿°ï¼Œæ˜¯å®é™…è¿è¡Œå››å¹´çš„ç»“æœã€‚ </p><br><h3 id="bazovye-api-vremeni-vypolneniya"> æ ¸å¿ƒè¿è¡Œæ—¶APIï¼š </h3><br><ol><li>  <code>add(func[, onerror])</code> -æ¨¡ä»¿<code>try-catch</code> ã€‚ </li><li>  <code>success([args...])</code> -æˆåŠŸå®Œæˆçš„æ˜ç¡®æŒ‡ç¤ºï¼š <br><ul><li> é»˜è®¤æš—ç¤º </li><li> å¯ä»¥å°†ç»“æœä¼ é€’ç»™ä¸‹ä¸€æ­¥ã€‚ </li></ul></li><li>  <code>error(code[, reason)</code> -å› é”™è¯¯è€Œä¸­æ–­æ‰§è¡Œï¼š <br><ul><li>  <code>code</code> -å…·æœ‰å­—ç¬¦ä¸²ç±»å‹ï¼Œå¯ä»¥æ›´å¥½åœ°ä¸å¾®æœåŠ¡æ¶æ„ä¸­çš„ç½‘ç»œåè®®é›†æˆï¼Œ </li><li>  <code>reason</code> -å¯¹ä¸€ä¸ªäººçš„ä»»æ„è§£é‡Šã€‚ </li></ul></li><li>  <code>state()</code> -çº¿ç¨‹æœ¬åœ°å­˜å‚¨çš„æ¨¡æ‹Ÿã€‚ é¢„å®šä¹‰çš„å…³è”é”®ï¼š <br><ul><li>  <code>error_info</code>å¯¹ä¸€ä¸ªäººçš„æœ€åä¸€ä¸ªé”™è¯¯çš„è§£é‡Šï¼Œ </li><li>  <code>last_exception</code>æŒ‡å‘æœ€åä¸€ä¸ªå¼‚å¸¸çš„å¯¹è±¡çš„æŒ‡é’ˆï¼Œ </li><li>  <code>async_stack</code>æŠ€æœ¯å…è®¸çš„å¼‚æ­¥è°ƒç”¨å †æ ˆï¼Œ </li><li> å…¶ä½™çš„ç”±ç”¨æˆ·è®¾ç½®ã€‚ </li></ul></li></ol><br><p> å‰é¢çš„ç¤ºä¾‹å·²ç»å…·æœ‰çœŸæ­£çš„C ++ä»£ç å’Œä¸€äº›å…¶ä»–åŠŸèƒ½ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/iasyncsteps.hpp&gt; using namespace futoin; void some_api(IAsyncSteps&amp; asi) { asi.add( [](IAsyncSteps&amp; asi) { std::cout &lt;&lt; "Level 0 func 1" &lt;&lt; std::endl; asi.add( [](IAsyncSteps&amp; asi) { std::cout &lt;&lt; "Level 1 func 1" &lt;&lt; std::endl; asi.error("MyError"); }, [](IAsyncSteps&amp; asi, ErrorCode code) { std::cout &lt;&lt; "Level 1 onerror 1: " &lt;&lt; code &lt;&lt; std::endl; asi.error("NewError", "Human-readable description"); } ); }, [](IAsyncSteps&amp; asi, ErrorCode code) { std::cout &lt;&lt; "Level 0 onerror 1: " &lt;&lt; code &lt;&lt; std::endl; if (code == "NewError") { // Human-readable error info assert(asi.state().error_info == "Human-readable description"); // Last exception thrown is also available in state std::exception_ptr e = asi.state().last_exception; // NOTE: smart conversion of "const char*" asi.success("Prm", 123, std::vector&lt;int&gt;({1, 2, 3}, true)); } } ); asi.add( [](IAsyncSteps&amp; asi, const futoin::string&amp; str_res, int int_res, std::vector&lt;int&gt;&amp;&amp; arr_res) { std::cout &lt;&lt; "Level 0 func 2: " &lt;&lt; str_res &lt;&lt; std::endl; } ); }</span></span></span></span></code> </pre> <br><h3 id="api-dlya-sozdaniya-ciklov"> ç”¨äºåˆ›å»ºå¾ªç¯çš„APIï¼š </h3><br><ol><li>  <code>loop( func, [, label] )</code> -æ— é™é‡å¤çš„æ­¥éª¤ã€‚ </li><li>  <code>forEach( map|list, func [, label] )</code> -é›†åˆå¯¹è±¡çš„é€æ­¥è¿­ä»£ã€‚ </li><li>  <code>repeat( count, func [, label] )</code> -é€æ­¥é‡å¤æŒ‡å®šçš„æ¬¡æ•°ã€‚ </li><li>  <code>break( [label] )</code>æ˜¯ä¼ ç»Ÿå¾ªç¯ä¸­æ–­çš„ç±»ä¼¼ç‰©ã€‚ </li><li>  <code>continue( [label] )</code>æ˜¯ä¼ ç»Ÿå¾ªç¯å»¶ç»­çš„ç±»ä¼¼å½¢å¼ï¼Œä½†æœ‰æ–°çš„è¿­ä»£ã€‚ </li></ol><br><p>  <em>è§„èŒƒæä¾›å¤‡ç”¨åç§°<code>breakLoop</code> ï¼Œ <code>continueLoop</code>ç­‰ï¼Œä»¥é˜²ä¸ä¿ç•™å­—å†²çªã€‚</em> </p><br><p>  C ++ç¤ºä¾‹ï¼š </p><br><pre> <code class="cpp hljs"> asi.loop([](IAsyncSteps&amp; asi) { <span class="hljs-comment"><span class="hljs-comment">// infinite loop asi.breakLoop(); }); asi.repeat(10, [](IAsyncSteps&amp; asi, size_t i) { // range loop from i=0 till i=9 (inclusive) asi.continueLoop(); }); asi.forEach( std::vector&lt;int&gt;{1, 2, 3}, [](IAsyncSteps&amp; asi, size_t i, int v) { // Iteration of vector-like and list-like objects }); asi.forEach( std::list&lt;futoin::string&gt;{"1", "2", "3"}, [](IAsyncSteps&amp; asi, size_t i, const futoin::string&amp; v) { // Iteration of vector-like and list-like objects }); asi.forEach( std::map&lt;futoin::string, futoin::string&gt;(), [](IAsyncSteps&amp; asi, const futoin::string&amp; key, const futoin::string&amp; v) { // Iteration of map-like objects }); std::map&lt;std::string, futoin::string&gt; non_const_map; asi.forEach( non_const_map, [](IAsyncSteps&amp; asi, const std::string&amp; key, futoin::string&amp; v) { // Iteration of map-like objects, note the value reference type });</span></span></code> </pre> <br><h3 id="api-integracii-s-vneshnimi-sobytiyami"> ä¸å¤–éƒ¨äº‹ä»¶é›†æˆçš„APIï¼š </h3><br><ol><li>  <code>setTimeout( timeout_ms )</code> -å¦‚æœæ­¥éª¤åŠå…¶å­æ ‘å°šæœªå®Œæˆæ‰§è¡Œï¼Œåˆ™åœ¨<code>Timeout</code>åå¼•å‘<code>Timeout</code>é”™è¯¯ã€‚ </li><li>  <code>setCancel( handler )</code> -è®¾ç½®å–æ¶ˆå¤„ç†ç¨‹åºï¼Œå½“å®Œå…¨å–æ¶ˆçº¿ç¨‹ä»¥åŠåœ¨é”™è¯¯å¤„ç†è¿‡ç¨‹ä¸­æ‰©å±•å¼‚æ­¥æ­¥éª¤å †æ ˆæ—¶è°ƒç”¨æ­¤å¤„ç†ç¨‹åºã€‚ </li><li>  <code>waitExternal()</code> -ä¸€ä¸ªç®€å•çš„ç­‰å¾…å¤–éƒ¨äº‹ä»¶ã€‚ <br><ul><li>  <em>æ³¨æ„ï¼šä»…åœ¨å¸¦æœ‰åƒåœ¾æ”¶é›†å™¨çš„æŠ€æœ¯ä¸­ä½¿ç”¨æ˜¯å®‰å…¨çš„ã€‚</em> </li></ul></li></ol><br><p> è°ƒç”¨è¿™äº›å‡½æ•°ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½éœ€è¦æ˜¾å¼è°ƒç”¨<code>success()</code> ã€‚ </p><br><p>  C ++ç¤ºä¾‹ï¼š </p><br><pre> <code class="cpp hljs"> asi.add([](IAsyncSteps&amp; asi) { <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> handle = schedule_external_callback([&amp;](<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> err) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { asi.error(<span class="hljs-string"><span class="hljs-string">"ExternalError"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (...) { <span class="hljs-comment"><span class="hljs-comment">// pass } } else { asi.success(); } }); asi.setCancel([=](IAsyncSteps&amp; asi) { external_cancel(handle); }); }); asi.add( [](IAsyncSteps&amp; asi) { // Raises Timeout error after specified period asi.setTimeout(std::chrono::seconds{10}); asi.loop([](IAsyncSteps&amp; asi) { // infinite loop }); }, [](IAsyncSteps&amp; asi, ErrorCode code) { if (code == futoin::errors::Timeout) { asi(); } });</span></span></code> </pre> <br><p>  ECMAScriptç¤ºä¾‹ï¼š </p><br><pre> <code class="javascript hljs">asi.add( <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">asi</span></span></span><span class="hljs-function">) =&gt;</span></span> { asi.waitExternal(); <span class="hljs-comment"><span class="hljs-comment">// disable implicit success() some_obj.read( (err, data) =&gt; { if (!asi.state) { // ignore as AsyncSteps execution got canceled } else if (err) { try { asi.error( 'IOError', err ); } catch (_) { // ignore error thrown as there are no // AsyncSteps frames on stack. } } else { asi.success( data ); } } ); } );</span></span></code> </pre> <br><h3 id="api-integracii-s-futurepromise"> æœªæ¥/æ‰¿è¯ºé›†æˆAPIï¼š </h3><br><ol><li>  <code>await(promise_future[, on_error])</code> -ç­‰å¾…Future / Promiseä½œä¸ºä¸€ä¸ªæ­¥éª¤ã€‚ </li><li>  <code>promise()</code> -å°†æ•´ä¸ªæ‰§è¡Œæµç¨‹è½¬æ¢ä¸ºFuture / Promiseï¼Œè€Œä¸æ˜¯<code>execute()</code> ã€‚ </li></ol><br><p>  C ++ç¤ºä¾‹ï¼š </p><br><pre> <code class="hljs pgsql"> [](IAsyncSteps&amp; asi) { // Proper way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AsyncSteps instances // <span class="hljs-keyword"><span class="hljs-keyword">without</span></span> hard dependency <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> implementation. auto new_steps = asi.newInstance(); new_steps-&gt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>([](IAsyncSteps&amp; asi) {}); // Can be <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> outside <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> AsyncSteps event <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> // new_steps.promise().wait(); // <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> // new_steps.promise&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;().<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(); // Proper way <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> wait <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> standard std::future asi.await(new_steps-&gt;promise()); // Ensure instance lifetime asi.state()["some_obj"] = std::<span class="hljs-keyword"><span class="hljs-keyword">move</span></span>(new_steps); };</code> </pre> <br><h3 id="api-kontrolya-potoka-vypolneniya-biznes-logiki"> ä¸šåŠ¡é€»è¾‘æµæ§åˆ¶APIï¼š </h3><br><ol><li>  <code>AsyncSteps(AsyncTool&amp;)</code>æ˜¯å°†æ‰§è¡Œçº¿ç¨‹ç»‘å®šåˆ°ç‰¹å®šäº‹ä»¶å¾ªç¯çš„æ„é€ å‡½æ•°ã€‚ </li><li>  <code>execute()</code> -å¯åŠ¨æ‰§è¡Œçº¿ç¨‹ã€‚ </li><li>  <code>cancel()</code> -å–æ¶ˆæ‰§è¡Œçº¿ç¨‹ã€‚ </li></ol><br><p> è¿™é‡Œå·²ç»éœ€è¦ç‰¹å®šçš„æ¥å£å®ç°ã€‚ </p><br><p>  C ++ç¤ºä¾‹ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/ri/asyncsteps.hpp&gt; #include &lt;futoin/ri/asynctool.hpp&gt; void example() { futoin::ri::AsyncTool at; futoin::ri::AsyncSteps asi{at}; asi.loop([&amp;](futoin::IAsyncSteps &amp;asi){ // Some infinite loop logic }); asi.execute(); std::this_thread::sleep_for(std::chrono::seconds{10}); asi.cancel(); // called in d-tor by fact }</span></span></span></span></code> </pre> <br><h3 id="prochie-api"> å…¶ä»–APIï¼š </h3><br><ol><li>  <code>newInstance()</code> -å…è®¸æ‚¨åˆ›å»ºæ–°çš„æ‰§è¡Œçº¿ç¨‹ï¼Œè€Œæ— éœ€ç›´æ¥ä¾èµ–äºå®ç°ã€‚ </li><li>  <code>sync(object, func, onerror)</code> -ç›¸åŒï¼Œä½†æ˜¯ç›¸å¯¹äºå®ç°ç›¸åº”æ¥å£çš„å¯¹è±¡å…·æœ‰åŒæ­¥ã€‚ </li><li>  <code>parallel([on_error])</code> -ç‰¹æ®Šçš„<code>add()</code> ï¼Œå…¶å­æ­¥éª¤æ˜¯å•ç‹¬çš„AsyncStepsæµï¼š <br><ul><li> æ‰€æœ‰çº¿ç¨‹éƒ½æœ‰å…±åŒçš„<code>state()</code> ï¼Œ </li><li> çˆ¶çº¿ç¨‹åœ¨æ‰€æœ‰å­çº¿ç¨‹å®Œæˆåç»§ç»­æ‰§è¡Œ </li><li> ä»»ä½•å­çº§ä¸­æœªæ•è·çš„é”™è¯¯ä¼šç«‹å³å–æ¶ˆæ‰€æœ‰å…¶ä»–å­çº§çº¿ç¨‹ã€‚ </li></ul></li></ol><br><p>  C ++ç¤ºä¾‹ï¼š </p><br><pre> <code class="cpp hljs"> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;futoin/ri/mutex.hpp&gt; using namespace futoin; ri::Mutex mtx_a; void sync_example(IAsyncSteps&amp; asi) { asi.sync(mtx_a, [](IAsyncSteps&amp; asi) { // synchronized section asi.add([](IAsyncSteps&amp; asi) { // inner step in the section // This synchronization is NOOP for already // acquired Mutex. asi.sync(mtx_a, [](IAsyncSteps&amp; asi) { }); }); }); } void parallel_example(IAsyncSteps&amp; asi) { using OrderVector = std::vector&lt;int&gt;; asi.state("order", OrderVector{}); auto&amp; p = asi.parallel([](IAsyncSteps&amp; asi, ErrorCode) { // Overall error handler asi.success(); }); p.add([](IAsyncSteps&amp; asi) { // regular flow asi.state&lt;OrderVector&gt;("order").push_back(1); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(4); }); }); p.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(2); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(5); asi.error("SomeError"); }); }); p.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(3); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order").push_back(6); }); }); asi.add([](IAsyncSteps&amp; asi) { asi.state&lt;OrderVector&gt;("order"); // 1, 2, 3, 4, 5 }); };</span></span></span></span></code> </pre> <br><h3 id="standartnye-primitivy-dlya-sinhronizacii"> åŒæ­¥çš„æ ‡å‡†åŸè¯­ </h3><br><ol><li>  <code>Mutex</code>é™åˆ¶åŒæ—¶åœ¨<code>Q</code>çš„é˜Ÿåˆ—ä¸­åŒæ—¶æ‰§è¡Œ<code>N</code>çº¿ç¨‹ï¼Œé»˜è®¤æƒ…å†µä¸‹<code>N=1, Q=unlimited</code> ã€‚ </li><li>  <code>Throttle</code> -åœ¨å‘¨æœŸ<code>P</code>ä¸­é™åˆ¶<code>Q</code>çš„è¾“å…¥<code>P</code>çš„æ•°é‡<code>N</code> ï¼Œé»˜è®¤æƒ…å†µä¸‹<code>N=1, P=1s, Q=0</code> ã€‚ </li><li>  <code>Limiter</code>æ˜¯<code>Mutex</code>å’Œ<code>Throttle</code>çš„ç»„åˆï¼Œé€šå¸¸ç”¨äºå¤„ç†å¤–éƒ¨è¯·æ±‚çš„è¾“å…¥ä»¥åŠåœ¨è°ƒç”¨å¤–éƒ¨ç³»ç»Ÿä»¥åœ¨è´Ÿè½½ä¸‹ç¨³å®šè¿è¡Œçš„ç›®çš„ã€‚ </li></ol><br><p> å¦‚æœ<code>DefenseRejected</code>é˜Ÿåˆ—é™åˆ¶ï¼Œåˆ™ä¼š<code>DefenseRejected</code>é”™è¯¯ï¼Œå…¶å«ä¹‰ä»<code>Limiter</code>æè¿°ä¸­å¯ä»¥æ¸…æ¥šçœ‹å‡ºã€‚ </p><br><h3 id="klyuchevye-preimuschestva"> ä¸»è¦å¥½å¤„ </h3><br><p>  AsyncStepsçš„æ¦‚å¿µæœ¬èº«å¹¶ä¸æ˜¯ç›®çš„ï¼Œè€Œæ˜¯å‡ºäºå¯¹æ—¶é—´çš„é™åˆ¶ï¼Œå–æ¶ˆå’Œå„ä¸ªå›è°ƒçš„æ•´ä½“è¿æ¥æ€§è€Œéœ€è¦å¯¹ç¨‹åºè¿›è¡Œæ›´å—æ§çš„å¼‚æ­¥æ‰§è¡Œçš„éœ€è¦è€Œè¯ç”Ÿçš„ã€‚ å½“æ—¶è¿˜æ²¡æœ‰é€šç”¨è§£å†³æ–¹æ¡ˆæä¾›ç›¸åŒçš„åŠŸèƒ½ã€‚ å› æ­¤ï¼š </p><br><p> <strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="> FTN12</a>   </strong> â€”           . </p><br><p> <strong>  <code>setCancel()</code></strong> â€”                    .       ,     .   RAII  <code>atexit()</code>   . </p><br><p> <strong>   <code>cancel()</code></strong> â€”     ,         .   <code>SIGTERM</code>  <code>pthread_cancel()</code> ,       . </p><br><p> <strong>   <code>setTimeout()</code></strong> â€”                 .    ,    "Timeout". </p><br><p> <strong>     </strong> â€”  FutoIn AsyncSteps             . </p><br><p> <strong>      </strong> â€”          ABI     ,    .    Embedded     MMU. </p><br><hr><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/yj/8x/wv/yj8xwvibm7tjsj30qhojwbleige.jpeg"></div><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><em> </em></a> </p><br><h2 id="k-cifram">   </h2><br><p>    Intel Xeon E3-1245v2/DDR1333  Debian Stretch    . </p><br><p>   : </p><br><ol><li> Boost.Fiber  <code>protected_fixedsize_stack</code> . </li><li> Boost.Fiber  <code>pooled_fixedsize_stack</code>     . </li><li> FutoIn AsyncSteps   . </li><li> FutoIn AsyncSteps      ( <code>FUTOIN_USE_MEMPOOL=false</code> ). <br><ul><li>      <code>futoin::IMemPool</code> . </li></ul></li><li> FutoIn NitroSteps&lt;&gt; â€”           . <br><ul><li>         . </li></ul></li></ol><br><p>    Boost.Fiber    : </p><br><ol><li>     1 . . </li><li>       30 .   1 . . <br><ul><li>   30 .     <code>mmap()/mprotect()</code>  <code>boost::fiber::protected_fixedsize_stack</code> . </li><li>          . </li></ul></li><li>   30 .   10 .     . <br><ul><li>    ""          . </li></ul></li></ol><br><p>      "" , ..     ,       .        .   . </p><br><p>    GCC 6.3.0.   lang  tcmalloc  ,     . </p><br><p>      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab</a> . </p><br><h3 id="1-posledovatelnoe-sozdanie"> 1.   </h3><br><table><thead><tr><th>  </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 4.8s </td><td> 208333.333Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 0.23s </td><td> 4347826.086Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>0.21s</strong> </td><td> <strong>4761904.761Hz</strong> </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 0.31s </td><td> 3225806.451Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> 0.255s </td><td> 3921568.627Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/qm/ur/y6/qmury65-mbkth_om8smkfi7vamq.png"></div><br><p> <em> â€” .</em> </p><br><p>     Boost.Fiber -      ,     <code>pooled_fixedsize_stack</code>   ,    AsyncSteps. </p><br><h3 id="2-parallelnoe-sozdanie-i-ispolnenie"> 2.     </h3><br><table><thead><tr><th>  </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 6.31s </td><td> 158478.605Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 1.558s </td><td> 641848.523Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>1.13s</strong> </td><td> <strong>884955.752Hz</strong> </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 1.353s </td><td> 739098.300Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> 1.43s </td><td> 699300.699Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0s/gz/lu/0sgzlur2xsrlf-wo4mrcynvzhxi.png"></div><br><p> <em> â€” .</em> </p><br><p>    ,          .    ,        â€”            . </p><br><h3 id="3-parallelnye-cikly"> 3.   </h3><br><table><thead><tr><th>  </th><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 5.096s </td><td> 1962323.390Hz </td></tr><tr><td> Boost.Fiber pooled </td><td> 5.077s </td><td> 1969667.126Hz </td></tr><tr><td> FutoIn AsyncSteps </td><td> 5.361s </td><td> 1865323.633Hz </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> 8.288s </td><td> 1206563.706Hz </td></tr><tr><td> FutoIn NitroSteps </td><td> <strong>3.68s</strong> </td><td> <strong>2717391.304Hz</strong> </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/pb/c1/17/pbc117djqds0d4twh5fzcklsmfc.png"></div><br><p> <em> â€” .</em> </p><br><p>   ,        Boost.Fiber      AsyncSteps,    NitroSteps. </p><br><h3 id="ispolzovanie-pamyati-po-rss">   ( RSS) </h3><br><table><thead><tr><th>  </th><th>  </th></tr></thead><tbody><tr><td> Boost.Fiber protected </td><td> 124M </td></tr><tr><td> Boost.Fiber pooled </td><td> 505M </td></tr><tr><td> FutoIn AsyncSteps </td><td> 124M </td></tr><tr><td> FutoIn AsyncSteps no mempool </td><td> <strong>84M</strong> </td></tr><tr><td> FutoIn NitroSteps </td><td> 115M </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ol/w0/6n/olw06nef5wj3ah1lo9u-pby9sfg.png"></div><br><p> <em> â€” .</em> </p><br><p>  , Boost.Fiber  . </p><br><h3 id="bonus-testy-na-nodejs"> :   Node.js </h3><br><p>      -  <code>Promise</code> : +    10 . .   10 .          JIT  <code>NODE_ENV=production</code> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>@futoin/optihelp</code></a> . </p><br><p>      <a href="">GitHub</a>  <a href="">GitLab</a> .   Node.js v8.12.0  v10.11.0,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">FutoIn CID</a> . </p><br><table><thead><tr><th> Tech </th><th> Simple </th><th> Loop </th></tr></thead><tbody><tr><td> <strong>Node.js v10</strong> </td><td></td><td></td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>1342899.520Hz</strong> </td><td> 587.777Hz </td></tr><tr><td> async/await </td><td> 524983.234Hz </td><td> <strong>630.863Hz</strong> </td></tr><tr><td> <strong>Node.js v8</strong> </td><td></td><td></td></tr><tr><td> FutoIn AsyncSteps </td><td> <strong>682420.735Hz</strong> </td><td> <strong>588.336Hz</strong> </td></tr><tr><td> async/await </td><td> 365050.395Hz </td><td> 400.575Hz </td></tr></tbody></table><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/x7/-n/b5/x7-nb5v9dfkwn1lttyg67w2b_tk.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/gh/yj/9p/ghyj9pczw0smbfksq-aad_tltay.png"></div><br><p> <em> â€” .</em> </p><br><p>   <code>async/await</code> ? ,   V8  Node.js v10       . </p><br><p>  ,   Promise  <code>async/await</code> <strong></strong> Node.js Event Loop.          ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ),   FutoIn AsyncSteps   . </p><br><p> <em>   AsyncSteps  Node.js Event Loop      <code>async/await</code>  -  Node.js v10.</em> </p><br><p> <em>,      ++   â€”    .  ,    Node.js    10 .</em> </p><br><h3 id="vyvody"> ç»“è®º </h3><br><p>   C++, FutoIn AsyncSteps  Boost.Fiber       ,     Boost.Fiber         <code>mmap()/mprotect</code> . </p><br><p>       ,      -      ,   .     . </p><br><p> FutoIn AsyncSteps  JavaScript  <code>async/await</code>       Node.js v10. </p><br><p>   ,       -,       .        . </p><br><p>   -                        ""  .     â€”   API. </p><br><hr><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> ,  FutoIn AsyncSteps ,          "" <code>async/await</code> . ,         .      <code>Promise</code>  ECMAScript, AsyncSteps    ""           . </p><br><p>               .        AsyncSteps  NitroSteps   . </p><br><p>     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> ,    - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="></a> . </p><br><p>       Java/JVM         â€”    .    . </p><br><p>      ,       <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitHub</a> / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">GitLab</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN424311/">https://habr.com/ru/post/zh-CN424311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN424297/index.html">éº»çœç†å·¥å­¦é™¢çš„è¯¾ç¨‹â€œè®¡ç®—æœºç³»ç»Ÿå®‰å…¨â€ã€‚ è®²åº§9ï¼šWebåº”ç”¨ç¨‹åºå®‰å…¨æ€§ï¼Œç¬¬3éƒ¨åˆ†</a></li>
<li><a href="../zh-CN424301/index.html">è‡ªé€‚åº”ç¥ç»ç½‘ç»œå›¾åƒæ»¤æ³¢ç®—æ³•</a></li>
<li><a href="../zh-CN424305/index.html">Uberè·¨å¹³å°ç§»åŠ¨æ¶æ„RIB</a></li>
<li><a href="../zh-CN424307/index.html">GitLab 11.3ä¸Mavenå­˜å‚¨åº“å’Œå®‰å…¨ç¯å¢ƒä¸€èµ·å‘å¸ƒ</a></li>
<li><a href="../zh-CN424309/index.html">DevCoreï¼šDevBoyé¡¹ç›®çš„è½¯ä»¶éƒ¨åˆ†</a></li>
<li><a href="../zh-CN424313/index.html">EveryLangæ˜¯ä¸€ä¸ªå‡ ä¹å¯ä»¥åšæ‰€æœ‰äº‹æƒ…çš„ç¨‹åº</a></li>
<li><a href="../zh-CN424315/index.html">æ–°ä¸€è½®è¿›å£æ›¿ä»£ã€‚ åœ¨å“ªé‡Œè·‘æ­¥ï¼Œæ€ä¹ˆåŠï¼Ÿ</a></li>
<li><a href="../zh-CN424319/index.html">ç½‘ä¸Šå•†åº—çš„ç»“æ„ã€‚ ç¬¬äºŒéƒ¨åˆ†</a></li>
<li><a href="../zh-CN424321/index.html">è®©NetFlowä¾¿å®œåˆç”Ÿæ°”</a></li>
<li><a href="../zh-CN424323/index.html">Googleå’ŒMicrosoftäº§å“ç»ç†ä½¿ç”¨ICEæ–¹æ³•çš„ç¤ºä¾‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>