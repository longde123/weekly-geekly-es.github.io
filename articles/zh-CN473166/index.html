<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•¤ ğŸ§‘ğŸ¾â€ğŸ¤â€ğŸ§‘ğŸ» ğŸ† å°†FFmpegç¼–è¯‘ä¸ºWebAssemblyï¼ˆ= ffmpeg.jsï¼‰ï¼šç¬¬3éƒ¨åˆ†-å°†aviè½¬æ¢ä¸ºmp4 ğŸ§—ğŸ» ğŸ‘©ğŸ½â€ğŸš’ ğŸ‘‡ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="è¯¥ç³»åˆ—çš„ç¿»è¯‘éƒ¨åˆ†æ¸…å•ï¼š 


1. åšé¥­ 
2. ç”¨Emscriptenç¼–è¯‘ 
3. å°†AVIè½¬æ¢ä¸ºmp4 ï¼ˆæ‚¨åœ¨è¿™é‡Œï¼‰ 



 åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†åˆ†æï¼š 



1. ä½¿ç”¨ä¼˜åŒ–çš„å‚æ•°ç¼–è¯‘FFmpegåº“ã€‚ 
2. Emscriptenæ–‡ä»¶ç³»ç»Ÿç®¡ç†ã€‚ 
3. ffmpeg.js v0.1.0å’Œè§†é¢‘...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å°†FFmpegç¼–è¯‘ä¸ºWebAssemblyï¼ˆ= ffmpeg.jsï¼‰ï¼šç¬¬3éƒ¨åˆ†-å°†aviè½¬æ¢ä¸ºmp4</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/473166/"><p></p><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/899/a0b/a50/899a0ba50105cb44cf23fe8cc40b8e42.png" width="640" height="360"></div><br><br><p> è¯¥ç³»åˆ—çš„ç¿»è¯‘éƒ¨åˆ†æ¸…å•ï¼š </p><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åšé¥­</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”¨Emscriptenç¼–è¯‘</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å°†AVIè½¬æ¢ä¸ºmp4</a> ï¼ˆæ‚¨åœ¨è¿™é‡Œï¼‰ </li></ol><br><hr><br><p> åœ¨è¿™ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†åˆ†æï¼š </p><br><br><ol><li> ä½¿ç”¨ä¼˜åŒ–çš„å‚æ•°ç¼–è¯‘FFmpegåº“ã€‚ </li><li>  Emscriptenæ–‡ä»¶ç³»ç»Ÿç®¡ç†ã€‚ </li><li>  ffmpeg.js v0.1.0å’Œè§†é¢‘è½¬æ¢çš„å¼€å‘ã€‚ </li></ol><br><a name="habracut"></a><hr><br><h1> ä½¿ç”¨ä¼˜åŒ–çš„å‚æ•°ç¼–è¯‘FFmpegåº“ </h1><br><p> å°½ç®¡æœ¬éƒ¨åˆ†çš„æœ€ç»ˆç›®æ ‡æ˜¯åˆ›å»ºffmpeg.js v0.1.0ä»¥ä¾¿å°†aviè½¬æ¢ä¸ºmp4ï¼Œä½†åœ¨ä¸Šä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬ä»…åˆ›å»ºäº†â€œè£¸â€ç‰ˆæœ¬çš„FFmpegï¼Œå¯ä»¥ä½¿ç”¨å¤šä¸ªå‚æ•°è¿›è¡Œä¼˜åŒ–ã€‚ </p><br><ol><li>  <b>-Oz</b> ï¼šä¼˜åŒ–ä»£ç å¹¶å‡å°å…¶å¤§å°ï¼ˆä»30åˆ°15 MBï¼‰ </li><li>  <b>-o javascript / ffmpeg-core.js</b> ï¼šå°†jså’Œwasmæ–‡ä»¶ä¿å­˜åˆ°javascriptç›®å½•ã€‚  ï¼ˆæˆ‘ä»¬å°†ä»ffmpeg.jsåŒ…è£…å™¨åº“ä¸­è°ƒç”¨ffmpeg-core.jsï¼Œè¯¥åŒ…è£…å™¨åº“æä¾›äº†æ¼‚äº®çš„APIï¼‰ </li><li> <b>-s MODULARIZE = 1</b> ï¼šåˆ›å»ºä¸€ä¸ªåº“ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªå‘½ä»¤è¡Œå®ç”¨ç¨‹åºï¼ˆæ‚¨å°†éœ€è¦ä¿®æ”¹æºï¼Œä»¥ä¸‹è¯¦ç»†ä¿¡æ¯ï¼‰ </li><li>  <b>-s EXPORTED_FUNCTIONS =â€œ [_ ffmpeg]â€</b> ï¼šå°†Cå‡½æ•°â€œ ffmpegâ€å¯¼å‡ºåˆ°JavaScriptä¸–ç•Œ </li><li>  <b>-s EXTRA_EXPORTED_RUNTIME_METHODS =â€œ [cwrapï¼ŒFSï¼ŒgetValueï¼ŒsetValue]â€</b> ï¼šç”¨äºå¤„ç†æ–‡ä»¶ç³»ç»Ÿå’ŒæŒ‡é’ˆçš„é™„åŠ åŠŸèƒ½ï¼Œæœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚è§æ–‡ç« <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸ä»£ç äº¤äº’</a> ã€‚ </li><li>  <b>-s ALLOW_MEMORY_GROWTH = 1</b> ï¼šå–æ¶ˆå¯¹å·²ç”¨å†…å­˜çš„é™åˆ¶ </li><li>  <b>-lpthread</b> ï¼šå·²åˆ é™¤ï¼Œå› ä¸ºæˆ‘ä»¬è®¡åˆ’åˆ›å»ºè‡ªå·±çš„å·¥ä½œç¨‹åºã€‚  ï¼ˆè¿™æ˜¯å‡ºç‰ˆç‰©ç¬¬å››éƒ¨åˆ†çš„å¾…åŠäº‹é¡¹ï¼‰ </li></ol><br><blockquote><p> æœ‰å…³æ¯ä¸ªå‚æ•°çš„æ›´å¤šè¯¦ç»†ä¿¡æ¯ï¼Œå¯ä»¥åœ¨githubå­˜å‚¨åº“è„šæœ¬ä¸­çš„<a href="">src / settings.js</a>ä¸­æ‰¾åˆ°ã€‚ </p></blockquote><br><p> å½“æ·»åŠ <b>-s MODULARIZE = 1æ—¶ï¼Œ</b>æˆ‘ä»¬å°†éœ€è¦ä¿®æ”¹æºä»£ç ä»¥æ»¡è¶³æ¨¡å—åŒ–çš„è¦æ±‚ï¼ˆå®é™…ä¸Šï¼Œæ‘†è„±äº†mainï¼ˆï¼‰å‡½æ•°ï¼‰ã€‚ æ‚¨åªéœ€è¦æ›´æ”¹ä¸‰è¡Œã€‚ </p><br><p>  1. <b>fftools / ffmpeg.c</b> ï¼šå°†mainé‡å‘½åä¸ºffmpeg </p><br><pre><code class="plaintext hljs">- int main(int argc, char **argv) + int ffmpeg(int argc, char **argv)</code> </pre> <br><p>  2. <b>fftools / ffmpeg.h</b> ï¼šå°†ffmpegæ·»åŠ åˆ°æ–‡ä»¶æœ«å°¾ä»¥å¯¼å‡ºåŠŸèƒ½ </p><br><pre> <code class="plaintext hljs">+ int ffmpeg(int argc, char** argv); #endif /* FFTOOLS_FFMPEG_H */</code> </pre> <br><p>  3. <b>fftools / cmdutils.c</b> ï¼šæ³¨é‡Šé€€å‡ºï¼ˆé€€å‡ºï¼‰ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„åº“ä¸ä¼šä¸ºæˆ‘ä»¬é€€å‡ºè¿è¡Œæ—¶ï¼ˆç¨åæˆ‘ä»¬å°†å¯¹æ­¤è¿›è¡Œæ”¹è¿›ï¼‰ã€‚ </p><br><pre> <code class="plaintext hljs">void exit_program(int ret){ if (program_exit) program_exit(ret); - exit(ret); + // exit(ret); }</code> </pre> <br><p> æˆ‘ä»¬æ–°ç‰ˆæœ¬çš„ç¼–è¯‘è„šæœ¬ï¼š </p><br><pre> <code class="plaintext hljs">emcc \ -Llibavcodec -Llibavdevice -Llibavfilter -Llibavformat -Llibavresample -Llibavutil -Llibpostproc -Llibswscale -Llibswresample \ -Qunused-arguments -Oz \ -o javascript/ffmpeg-core.js fftools/ffmpeg_opt.o fftools/ffmpeg_filter.o fftools/ffmpeg_hw.o fftools/cmdutils.o fftools/ffmpeg.o \ -lavdevice -lavfilter -lavformat -lavcodec -lswresample -lswscale -lavutil -lm \ -s MODULARIZE=1 \ -s EXPORTED_FUNCTIONS="[_ffmpeg]" \ -s EXTRA_EXPORTED_RUNTIME_METHODS="[cwrap, FS, getValue, setValue]" \ -s TOTAL_MEMORY=33554432 \ -s ALLOW_MEMORY_GROWTH=1</code> </pre> <br><p>  ffmpeg-core.jså‡†å¤‡å¥½äº†ï¼ </p><br><p> å¦‚æœæ‚¨æœ‰ä½¿ç”¨ffmpegçš„ç»éªŒï¼Œé‚£ä¹ˆæ‚¨å·²ç»çŸ¥é“å…¸å‹å‘½ä»¤å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="plaintext hljs">$ ffmpeg -i input.avi output.mp4</code> </pre> <br><p> è€Œä¸”ç”±äºæˆ‘ä»¬ä½¿ç”¨ffmpegå‡½æ•°è€Œä¸æ˜¯mainï¼Œå› æ­¤å‘½ä»¤è°ƒç”¨å°†å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="plaintext hljs">const args = ['./ffmpeg', '-i', 'input.avi', 'output.mp4']; ffmpeg(args.length, args);</code> </pre> <br><p> å½“ç„¶ï¼Œå¹¶éæ‰€æœ‰äº‹æƒ…éƒ½é‚£ä¹ˆç®€å•ï¼Œæˆ‘ä»¬éœ€è¦åœ¨JavaScriptå’ŒCè¯­è¨€ä¸–ç•Œä¹‹é—´æ¶èµ·ä¸€åº§æ¡¥æ¢ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ä»emscriptenæ–‡ä»¶ç³»ç»Ÿå¼€å§‹ã€‚ </p><br><h1>  Emscriptenæ–‡ä»¶ç³»ç»Ÿç®¡ç† </h1><br><p>  Emscriptenæœ‰ä¸€ä¸ªè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ¥æ”¯æŒå¯¹Cçš„è¯»å–/å†™å…¥ï¼Œffmpeg-core.jsä½¿ç”¨è¯¥æ–‡ä»¶ç³»ç»Ÿæ¥å¤„ç†è§†é¢‘æ–‡ä»¶ã€‚ </p><br><blockquote><p> åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">File System APIä¸­</a>é˜…è¯»æœ‰å…³æ­¤å†…å®¹çš„æ›´å¤šä¿¡æ¯ã€‚ </p></blockquote><br><p> ä¸ºäº†ä½¿ä¸€åˆ‡æ­£å¸¸ï¼Œæˆ‘ä»¬ä»emscriptenä¸­å¯¼å‡ºFS APIï¼Œè¿™æ˜¯ç”±äºä¸Šè¿°å‚æ•°æ‰€è‡´ï¼š </p><br><pre> <code class="plaintext hljs">-s EXTRA_EXPORTED_RUNTIME_METHODS="[cwrap, FS, getValue, setValue]"</code> </pre> <br><p> è¦ä¿å­˜æ–‡ä»¶ï¼Œæ‚¨éœ€è¦åœ¨Node.jsç¯å¢ƒä¸­ä»¥Uint8Arrayæ ¼å¼å‡†å¤‡æ•°ç»„ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è¿›è¡Œæ“ä½œï¼š </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const data = new Uint8Array(fs.readFileSync('./input.avi'));</code> </pre> <br><p> å¹¶ä½¿ç”¨FS.writeFileï¼ˆï¼‰å°†å…¶ä¿å­˜åˆ°emscriptenæ–‡ä»¶ç³»ç»Ÿä¸­ï¼š </p><br><pre> <code class="plaintext hljs">require('./ffmpeg-core.js)() .then(Module =&gt; { Module.FS.writeFile('input.avi', data); });</code> </pre> <br><p> å¹¶ä»emscriptenä¸‹è½½æ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">require('./ffmpeg-core.js)() .then(Module =&gt; { const data = Module.FS.readFile('output.mp4'); });</code> </pre> <br><p> è®©æˆ‘ä»¬å¼€å§‹å¼€å‘ffmpeg.jsæ¥å°†è¿™äº›å¤æ‚æ€§éšè—åœ¨æ¼‚äº®çš„APIä¹‹åã€‚ </p><br><h1> å¼€å‘ffmpeg.js v0.1.0å’Œè§†é¢‘è½¬æ¢ </h1><br><p>  ffmpeg.jsçš„å¼€å‘å¹¶éæ˜“äº‹ï¼Œå› ä¸ºæ‚¨ç»å¸¸éœ€è¦åœ¨JavaScriptå’ŒCçš„ä¸–ç•Œä¹‹é—´åˆ‡æ¢ï¼Œä½†æ˜¯å¦‚æœæ‚¨ç†Ÿæ‚‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æŒ‡é’ˆ</a> ï¼Œå°†ä¼šæ›´å®¹æ˜“ç†è§£è¿™é‡Œå‘ç”Ÿçš„äº‹æƒ…ã€‚ </p><br><p> æˆ‘ä»¬çš„ä»»åŠ¡æ˜¯åƒè¿™æ ·å¼€å‘ffmpeg.jsï¼š </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const ffmpeg = require('@ffmpeg/ffmpeg'); (async () =&gt; { await ffmpeg.load(); const data = ffmpeg.transcode('./input.avi', 'mp4'); fs.writeFileSync('./output.mp4', data); })();</code> </pre> <br><p> é¦–å…ˆï¼Œä¸‹è½½ffmpeg-core.jsï¼Œå®ƒé€šå¸¸æ˜¯å¼‚æ­¥å®Œæˆçš„ï¼Œä»¥å…é˜»å¡ä¸»çº¿ç¨‹ã€‚ </p><br><p> çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š </p><br><pre> <code class="plaintext hljs">const { setModule } = require('./util/module'); const FFmpegCore = require('./ffmpeg-core'); module.exports = () =&gt; ( new Promise((resolve, reject) =&gt; { FFmpegCore() .then((Module) =&gt; { setModule(Module); resolve(); }); }) );</code> </pre> <br><p> å°†ä¸€ä¸ªpromise <b>æ¢æˆ</b>å¦ä¸€ä¸ªpromiseä¼¼ä¹å¾ˆå¥‡æ€ªï¼Œè¿™æ˜¯å› ä¸º<b>FFmpegCoreï¼ˆï¼‰</b>ä¸æ˜¯çœŸæ­£çš„promiseï¼Œè€Œåªæ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿpromise APIçš„å‡½æ•°ã€‚ </p><br><p> ä¸‹ä¸€æ­¥æ˜¯ä½¿ç”¨<b>Module</b>é€šè¿‡<b>cwrap</b>å‡½æ•°è·å–ffmpegå‡½æ•°ï¼š </p><br><pre> <code class="plaintext hljs">// int ffmpeg(int argc, char **argv) const ffmpeg = Module.cwrap('ffmpeg', 'number', ['number', 'number']);</code> </pre> <br><p>  <b>cwrap</b>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‡½æ•°çš„åç§°ï¼ˆå¿…é¡»åœ¨EXPORTED_FUNCTIONSä¸­ï¼Œä¸”å¸¦æœ‰ä¸‹åˆ’çº¿ï¼‰ï¼Œç¬¬äºŒä¸ªæ˜¯è¿”å›å€¼çš„ç±»å‹ï¼Œç¬¬ä¸‰ä¸ªæ˜¯å‡½æ•°çš„å‚æ•°çš„ç±»å‹ï¼ˆint argcå’Œchar ** argvï¼‰ã€‚ </p><br><p> å¾ˆæ¸…æ¥šä¸ºä»€ä¹ˆ<b>argcæ˜¯ä¸€ä¸ª</b>æ•°å­—ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆ<b>argv</b>ä¹Ÿæ˜¯ä¸€ä¸ªæ•°å­—ï¼Ÿ  <b>argv</b>æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œå¹¶ä¸”è¯¥æŒ‡é’ˆå°†åœ°å€å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼ˆç±»å‹ä¸º0xfffffffï¼‰ï¼Œå› æ­¤è¯¥æŒ‡é’ˆç±»å‹æ˜¯WebAssemblyä¸­çš„32ä½æ— ç¬¦å·ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°†æ•°å­—æŒ‡å®šä¸º<b>argv</b>ç±»å‹çš„åŸå› ã€‚ </p><br><p> è¦è°ƒç”¨ffmpegï¼ˆï¼‰ï¼Œç¬¬ä¸€ä¸ªå‚æ•°åœ¨JavaScriptä¸­å°†æ˜¯ä¸€ä¸ªå¸¸è§„æ•°ï¼Œä½†ç¬¬äºŒä¸ªå‚æ•°åº”æ˜¯ä¸€ä¸ªæŒ‡å‘å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼ˆJavaScriptä¸­çš„Uint8ï¼‰ã€‚ </p><br><p> æˆ‘ä»¬å°†æ­¤ä»»åŠ¡åˆ†ä¸ºä¸¤ä¸ªå­ä»»åŠ¡ï¼š </p><br><ol><li> å¦‚ä½•åˆ›å»ºä¸€ä¸ªæŒ‡å‘å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆï¼Ÿ </li><li> å¦‚ä½•åˆ›å»ºä¸€ä¸ªæŒ‡å‘æŒ‡é’ˆæ•°ç»„çš„æŒ‡é’ˆï¼Ÿ </li></ol><br><p> æˆ‘ä»¬å°†é€šè¿‡åˆ›å»º<b>str2ptr</b>å®ç”¨ç¨‹åºè§£å†³ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š </p><br><pre> <code class="plaintext hljs">const { getModule } = require('./module'); module.exports = (s) =&gt; { const Module = getModule(); const ptr = Module._malloc((s.length+1)*Uint8Array.BYTES_PER_ELEMENT); for (let i = 0; i &lt; s.length; i++) { Module.setValue(ptr+i, s.charCodeAt(i), 'i8'); } Module.setValue(ptr+s.length, 0, 'i8'); return ptr; };</code> </pre> <br><p>  <b>Module._mallocï¼ˆï¼‰</b>ä¸Cä¸­çš„<b>mallocï¼ˆï¼‰</b>ç±»ä¼¼ï¼Œå®ƒåœ¨å †ä¸Šåˆ†é…ä¸€å—å†…å­˜ã€‚  <b>Module.setValueï¼ˆï¼‰</b>é€šè¿‡æŒ‡é’ˆè®¾ç½®ç‰¹å®šå€¼ã€‚ </p><br><blockquote><p> åˆ‡è®°åœ¨å­—ç¬¦æ•°ç»„çš„æœ«å°¾æ·»åŠ 0ï¼Œä»¥å…å‘ç”Ÿæ„å¤–æƒ…å†µã€‚ </p></blockquote><br><p> å¤„ç†å®Œç¬¬ä¸€<b>ä¸ªå­</b>ä»»åŠ¡åï¼Œåˆ›å»º<b>strList2ptr</b>æ¥è§£å†³ç¬¬äºŒä¸ªä»»åŠ¡ï¼š </p><br><pre> <code class="plaintext hljs">const { getModule } = require('./module'); const str2ptr = require('./str2ptr'); module.exports = (strList) =&gt; { const Module = getModule(); const listPtr = Module._malloc(strList.length*Uint32Array.BYTES_PER_ELEMENT); strList.forEach((s, idx) =&gt; { const strPtr = str2ptr(s); Module.setValue(listPtr + (4*idx), strPtr, 'i32'); }); return listPtr; };</code> </pre> <br><p> åœ¨è¿™é‡Œä¸»è¦è¦äº†è§£çš„æ˜¯ï¼ŒæŒ‡é’ˆæ˜¯JavaScriptä¸­çš„<b>Uint32</b>å€¼ï¼Œå› æ­¤<b>listPtr</b>æ˜¯æŒ‡å‘Uint32æ•°ç»„çš„æŒ‡é’ˆï¼Œè¯¥æ•°ç»„å­˜å‚¨æŒ‡å‘Uint8æ•°ç»„çš„æŒ‡é’ˆã€‚ </p><br><p>  <b>æ”¾åœ¨</b>ä¸€èµ·ï¼Œæˆ‘ä»¬å¾—åˆ°ä»¥ä¸‹<b>ffmepg.transcodeï¼ˆï¼‰çš„å®ç°</b> ï¼š </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const { getModule } = require('./util/module'); const strList2ptr = require('./util/strList2ptr'); module.exports = (inputPath, outputExt) =&gt; { const Module = getModule(); const data = new Uint8Array(fs.readFileSync(inputPath)); const ffmpeg = Module.cwrap('ffmpeg', 'number', ['number', 'number']); const args = ['./ffmpeg', '-i', 'input.avi', `output.${outputExt}`]; Module.FS.writeFile('input.avi', data); ffmpeg(args.length, strList2ptr(args)); return Buffer.from(Module.FS.readFile(`output.${outputExt}`)); };</code> </pre> <br><p> åšå®Œäº†ï¼ ç°åœ¨æˆ‘ä»¬æœ‰äº†ffmpeg.js v0.1.0ï¼Œå¯ä»¥å°†aviè½¬æ¢ä¸ºmp4ã€‚ </p><br><p> æ‚¨å¯ä»¥é€šè¿‡å®‰è£…åº“è‡ªå·±æµ‹è¯•ç»“æœï¼š </p><br><pre> <code class="plaintext hljs">$ npm install @ffmpeg/ffmpeg@0.1.0</code> </pre> <br><p> ç„¶ååƒè¿™æ ·è½¬æ¢æ–‡ä»¶ï¼š </p><br><pre> <code class="plaintext hljs">const fs = require('fs'); const ffmpeg = require('@ffmpeg/ffmpeg'); (async () =&gt; { await ffmpeg.load(); const data = ffmpeg.transcode('./input.avi', 'mp4'); fs.writeFileSync('./output.mp4', data); })();</code> </pre> <br><p> è¯·è®°ä½ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œè¯¥åº“ä»…é€‚ç”¨äºNode.jsï¼Œä½†æ˜¯åœ¨ä¸‹ä¸€éƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬å°†æ·»åŠ å¯¹Web-workerï¼ˆä»¥åŠNode.jsä¸­çš„child_processï¼‰çš„æ”¯æŒã€‚ </p><br><p> æºä»£ç ï¼š </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ffmpeg-core.js</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ffmpeg.js</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN473166/">https://habr.com/ru/post/zh-CN473166/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN473146/index.html">.NET Core 3.0æ–¹æ¡ˆä¸­çš„Blazor Serverå’Œæ€§èƒ½</a></li>
<li><a href="../zh-CN473150/index.html">ç°åœ¨æ˜¯æ—¶å€™åˆ¶ä½œä¸€ä¸ªæ–°çš„Windows Terminal profile.json</a></li>
<li><a href="../zh-CN473154/index.html">å‹å¥½çš„å¼€æ”¾ç©ºé—´JSï¼šå®¢æˆ·ç«¯æ¸²æŸ“å’ŒåŒ…è£…åˆ›å»º</a></li>
<li><a href="../zh-CN473156/index.html">å¦‚ä½•åœ¨å®è·µä¸­æµ‹è¯•çŸ¥è¯†ï¼Œè·å¾—å…¥è¯»ç¡•å£«è¯¾ç¨‹å’Œå·¥ä½œé‚€è¯·çš„å¥½å¤„</a></li>
<li><a href="../zh-CN473158/index.html">å½“æ‚¨æœ‰75ï¼…çš„å‘˜å·¥æ‚£æœ‰è‡ªé—­ç—‡æ—¶ï¼Œä¼šæ˜¯ä»€ä¹ˆæ ·ï¼Ÿ</a></li>
<li><a href="../zh-CN473168/index.html">ASP.NETå’ŒASP.NET Coreä¸­å³å°†è¿›è¡Œçš„SameSite Cookieæ›´æ”¹</a></li>
<li><a href="../zh-CN473172/index.html">.NET Core 3.0ä¸­çš„BlazoræœåŠ¡å™¨ä½¿ç”¨æ–¹æ¡ˆå’Œæ€§èƒ½</a></li>
<li><a href="../zh-CN473176/index.html">æ˜¯æ—¶å€™åˆ¶ä½œä¸€ä¸ªæ–°çš„Windows Terminal profile.json</a></li>
<li><a href="../zh-CN473182/index.html">å¢åŠ ç°ä»£æ±½è½¦ICEç‰¹æ€§çµæ´»æ€§çš„åŸç†</a></li>
<li><a href="../zh-CN473184/index.html">Docker + php-fpm + PhpStorm + Xdebug</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>