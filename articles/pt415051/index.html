<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üç∞ üë©üèø‚Äçü§ù‚Äçüë©üèæ üåõ Isometria, √≠ndices z em jogos para celular e sua otimiza√ß√£o üîü üë©üèΩ‚Äçü§ù‚Äçüë®üèæ üíú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! Recentemente, lan√ßamos nosso jogo , que preparamos por um longo tempo e no processo em que um n√∫mero consider√°vel de t√≥picos interessantes s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Isometria, √≠ndices z em jogos para celular e sua otimiza√ß√£o</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415051/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/lk/eu/4v/lkeu4vc8aqhbtyddxs_2cckvcbq.gif"></div><br>  Ol√° Habr!  Recentemente, lan√ßamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nosso jogo</a> , que preparamos por um longo tempo e no processo em que um n√∫mero consider√°vel de t√≥picos interessantes se acumulou e que valem a pena ser compartilhados com a comunidade.  O t√≥pico ser√° de interesse n√£o apenas do iOS e de outros desenvolvedores de dispositivos m√≥veis, mas tamb√©m de todos os interessados ‚Äã‚Äãem saber como todo tipo de coisa gr√°fica funciona, bem como de todos os f√£s de estrat√©gias 2D, o que eu mesmo j√° fiz na terceira d√©cada. <br><a name="habracut"></a><br>  Hoje falaremos sobre as nuances de um t√≥pico t√£o importante como os √≠ndices z em uma superf√≠cie isom√©trica (sim, nem tudo √© t√£o simples quanto parece para alguns wiseacres).  No mundo 3d, estranhamente, temos tr√™s coordenadas - x, y, z - que determinam completamente a posi√ß√£o do objeto no espa√ßo.  A tarefa de determinar a proximidade dos objetos com a c√¢mera tamb√©m est√° l√°, mas fica inteiramente sobre os ombros do OpenGL.  O desenvolvedor opera apenas com par√¢metros de alto n√≠vel, como a profundidade do buffer z, que afetam o desempenho, mas voc√™ pode confiar no OpenGL como uma caixa preta - ele possui informa√ß√µes suficientes. <br><br>  Uma situa√ß√£o completamente diferente √© observada em nosso mundo ‚Äúpseudo-3D‚Äù - cada objeto possui apenas (x, y) - coordenadas e tamanho do sprite.  A primeira tarefa que um programador enfrenta ao escrever um mecanismo √© a tarefa de determinar quais objetos devem se sobrepor na frente de nossa "c√¢mera" virtual. <br><br><h3>  Sinopse </h3><br>  Coordenadas do SpriteKit (onde (0; 0) √© o centro do "mundo" e Y sobe). Nesse caso, n√£o estamos interessados, porque  eles n√£o significam nada em nosso ‚Äúmundo‚Äù isom√©trico com voc√™, ent√£o vamos fazer uma reserva - temos um campo em forma de diamante como o Age of Empires. <br><br><img src="https://habrastorage.org/webt/wr/5e/vv/wr5evvkc_hek_pscypdlvngc_rc.jpeg"><br><br>  Um bloco com coordenadas (0; 0) est√° localizado no canto esquerdo do losango, a abcissa X aumenta "para baixo" e "para a direita", ou seja,  cresce mais perto do observador, a ordenada Y aumenta "para cima" e "para a direita", ou seja,  diminui √† medida que voc√™ se aproxima do observador. <br><br>  Al√©m disso, os trilhos devem estar "embaixo" do trem, a fuma√ßa da chamin√© deve estar "acima" do trem.  Mas n√£o vamos nos preocupar agora com as "camadas do ser" - obviamente, nada nos impede de fazer quantas fatias isom√©tricas quiser, trabalhando de acordo com as mesmas regras.  Assumimos que em um bloco h√° sempre um objeto - para maior clareza, mais n√£o √© necess√°rio. <br><br><img src="https://habrastorage.org/webt/qi/2u/cs/qi2ucse8xajdr-r3ttwf1t9smt4.jpeg"><br><br>  Considere os dois trens acima.  Obviamente, do ponto de vista do observador, os carros devem estar localizados "abaixo" do trem, ou seja,  o √≠ndice z deve ser menor.  Ao mesmo tempo, o trem ‚Äúsuperior‚Äù deve ‚Äúse sobrepor‚Äù ao vizinho, estar ‚Äúmais longe‚Äù.  Podemos, tendo apenas as coordenadas (x; y), construir um mapa de √≠ndices z para cada bloco? <br><br>  Obviamente, sim, usando a seguinte f√≥rmula (pseudoc√≥digo √† la swift): <br><br><pre><code class="hljs matlab">zIndex = pos.x * field.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>.width - pos.y</code> </pre> <br>  Assim, garantimos que, √† medida que a ordenada cresce, os objetos se afastam (-pos.y), bem como com o aumento da abcissa, os objetos se aproximam (pos.x) e, principalmente, qualquer objeto que tenha uma abcissa, digamos 44, ser√° deliberadamente "mais pr√≥ximo" ‚ÄùDo que qualquer objeto com uma abcissa 43. Para adicionar" camadas "aqui (lembre-se, os trilhos sob o trem fumam acima da chamin√©), basta adicionar alguma" altura "constante da camada: <br><br><pre> <code class="hljs matlab">zIndex = layerZIndex + pos.x * field.<span class="hljs-built_in"><span class="hljs-built_in">size</span></span>.width - pos.y</code> </pre> <br>  √â isso a√≠, voc√™ pode terminar o artigo e elogiar-se pelos conceitos b√°sicos de estereometria aprendidos na 10¬™ s√©rie e iniciar a l√≥gica do jogo.  N√£o?  Se ao menos!  Eu escreveria sobre as coisas √≥bvias!  (Bem, como √≥bvio, alguns dias s√£o esmagados e isso) <br><br>  Estamos apenas come√ßando a parte divertida, seguindo em frente. <br><br><h3>  Luta pelo desempenho </h3><br>  Todos, pelo menos uma vez, executaram um projeto de teste para o SpriteKit (ou um coco, ou qualquer outro mecanismo), viram n√∫meros m√°gicos - fps e n√≥s. <br><br><img src="https://habrastorage.org/webt/ej/ly/fg/ejlyfgpeamuachzwte2aucpuxhy.jpeg"><br><br>  Obviamente, fps √© o n√∫mero de quadros por segundo, n√≥s √© o n√∫mero de n√≥s, principalmente sprites.  Mas, na pr√°tica, a maioria de todos os fps √© definida n√£o pelo n√∫mero de n√≥s, mas por outro par√¢metro, que por padr√£o n√£o √© exibido, mas que tamb√©m pode ser exibido com uma linha - o n√∫mero de empates redesenhados. <br><br><img src="https://habrastorage.org/webt/or/w6/mq/orw6mqdp2bgxt5bfybnz1evzt5y.jpeg"><br><br>  Na mesma cena, como voc√™ v√™ agora, o n√∫mero de n√≥s √© de cerca de 6000 e o n√∫mero de renderiza√ß√µes √© de cerca de 120. Esse √© o zoom m√≠nimo (a c√¢mera est√° o mais pr√≥ximo poss√≠vel da superf√≠cie), 1: 1. <br><br>  Agora vamos mover a c√¢mera para a dist√¢ncia m√°xima (no nosso jogo s√£o 2,5: 1) <br><br><img src="https://habrastorage.org/webt/g1/78/wz/g178wz_a1q85pqtrtyzvffswndo.jpeg"><br><br>  Alteramos a escala em apenas 2,5 vezes (no exemplo, longe de todos os objetos s√£o desenhados), e o n√∫mero de empates aumentou de 5 a 6 vezes com a contagem de n√≥s inalterada! <br><br>  Obviamente, o n√∫mero de renderiza√ß√µes afeta fps incomensuravelmente mais do que o n√∫mero abstrato de n√≥s.  O SpriteKit simplesmente n√£o desenha n√≥s que n√£o caem na janela de exibi√ß√£o (na c√¢mera).  A √∫nica exce√ß√£o que encontrei at√© agora s√£o os emissores de part√≠culas, sempre desenhados, independentemente de serem vis√≠veis ou n√£o. <br><br>  Agora vamos falar sobre o significado desse desenho "desenho".  A placa de v√≠deo possui todos os n√≥s "camadas", guiados por seus √≠ndices z.  E ele repassa o quadro todo repetidas vezes, do mais baixo ao mais alto.  O n√∫mero de tais ciclos de renderiza√ß√£o √© empatado. <br><br>  Agora voc√™ entende que, se voc√™ desenhar cada objeto min√∫sculo (e tivermos um mapa grande, aproximadamente 6000 x 3000) com seu pr√≥prio z-index, isso arruinar√° o desempenho de qualquer telefone. <br><br>  Os problemas s√£o mais vis√≠veis nos antigos 5 e 5s, mas a presen√ßa do iPhone 10 n√£o garante nada - com a abordagem errada, voc√™ pode abandonar qualquer hardware poderoso.  No nosso jogo, uma das pedras angulares foi a extrema clareza.  No zoom mais pr√≥ximo, os sprites um a um correspondem a retin pixels.  Devo dizer que, na maioria dos jogos para dispositivos m√≥veis, a resolu√ß√£o √© de ordens de magnitude mais baixa, por isso os requisitos n√£o s√£o t√£o grandes, mas fizemos qualitativamente, quanto a n√≥s mesmos ... <br><br>  Ent√£o voc√™ tem que ir para os truques. <br><br><ul><li>  Todos os objetos com os quais o jogador n√£o interage e que est√£o no mesmo n√≠vel na coordenada X podem geralmente ser mesclados em um sprite.  Para uma placa de v√≠deo, √© muito mais f√°cil desenhar um sprite grande do que 10 pequenos.  Portanto, as pistas florestais entre as estradas s√£o sprites integrais que consistem em v√°rias √°rvores.  E √°rvores que n√£o se sobrep√µem a caminhos e outras √°rvores geralmente s√£o costuradas no mapa.  Em alpha, a prop√≥sito, houve alguns bugs quando o carvalho secular cresceu sob os trilhos de um trem ou sob o sem√°foro de um trem, teste com cuidado seu jogo para n√£o divertir os usu√°rios. <br></li><li>  Os objetos que possuem um √≠ndice z s√£o desenhados na ordem em que aparecem na placa de v√≠deo.  I.e.  adicionando objetos ‚Äúdistantes‚Äù antes dos objetos ‚Äúfechados‚Äù, eles cair√£o corretamente, mas n√£o aumentar√£o o n√∫mero de renderiza√ß√µes da placa gr√°fica. <br></li></ul><br>  Tudo isso permite reduzir o n√∫mero de empates √†s vezes, fixando fps mesmo no iPhone antigo.  Eu tive que limitar severamente alguns efeitos a eles, mas a Apple n√£o lan√ßou atualiza√ß√µes para eles h√° um ano - um pecado vai reclamar! <br><br><h3>  Eleva√ß√£o </h3><br>  Bem, tudo, o motor est√° pronto, voc√™ j√° pode come√ßar algo interessante?  Algu√©m pode, mas √© muito cedo para n√≥s.  Afinal, o trem deve sair lindamente do t√∫nel, e aqui nem tudo √© t√£o simples quanto parece. <br><br><img src="https://habrastorage.org/webt/sp/cb/nm/spcbnmehem8_bu1ogy0fijlt_ho.jpeg"><br><br>  O trem deve estar localizado "mais alto" do que a parede "distante" do t√∫nel e "mais baixo" que o teto do t√∫nel e as montanhas que o seguem.  Afinal, √© lindo quando o mapa √© t√£o multin√≠vel, com mudan√ßas de altitude - novamente, n√£o estamos fazendo bobagens sem alma, mas sim o que gostamos! <br><br>  Mas voltando aos detalhes - para isso, o mapa foi ‚Äúcortado‚Äù da seguinte forma. <br><br><img src="https://habrastorage.org/webt/wj/vc/cq/wjvccqdd_chsxclx127yy127ffo.png"><br><br>  A parede interna do t√∫nel e tudo o mais √† esquerda √© mais baixa e <br><br><img src="https://habrastorage.org/webt/7e/iz/4v/7eiz4vshagonj-yf5of3ndzsr6m.png"><br><br>  o topo do t√∫nel, juntamente com as montanhas para as quais ele flui.  Aqui, nenhuma gera√ß√£o processual de √≠ndices z ajudar√°, apenas um c√≥digo r√≠gido bielorrusso grave. <br><br>  O habrayuzer atento notou na captura de tela do jogo que perto dos t√∫neis as √°rvores foram "cortadas" cuidadosamente, expondo a areia da praia.  Essa falha aparentemente vem da impossibilidade fundamental de realizar essas planta√ß√µes de √°rvores em 2D.  O trem, saindo do t√∫nel, deve estar deliberadamente "acima" das √°rvores sobrepostas, cobrindo-as consigo mesmo.  Mas essas mesmas √°rvores devem se sobrepor ao teto do t√∫nel, sob o qual o trem deve entrar!  E o teto deve ser mais alto que o trem e, em c√≠rculo, temos uma contradi√ß√£o l√≥gica ... <br><br>  Por uma raz√£o semelhante, devido √† imperfei√ß√£o do mecanismo gr√°fico, em jogos antigos como Duke Nukem e Doom2, n√£o existem grandes diferen√ßas nas alturas e pisos dos edif√≠cios. <br><br>  √â por isso que as √°rvores n√£o crescem perto dos t√∫neis. <br><br>  Espero que tenha sido interessante, o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">brinquedo ao vivo aqui (livre para jogar)</a> , o pr√≥ximo artigo da s√©rie ser√° sobre √°gua 2D realista bonita, n√£o perca! <br><br>  PS A prop√≥sito, um v√≠deo para atrair aten√ß√£o pode ser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">visto no youtube</a> em qualidade normal. <br><br>  PPS At√© agora, o jogo est√° dispon√≠vel apenas na CEI, Canad√° e Irlanda. Se algu√©m quiser procurar em outros pa√≠ses, envie um e-mail pessoal com appleId - vou adicion√°-lo ao TestFlight </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt415051/">https://habr.com/ru/post/pt415051/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../In146152/index.html">‡§ü‡•à‡§≤‡•á‡§Ç‡§ü ‡§Æ‡•à‡§™ ‡§∞‡§ø‡§ú‡•ç‡§Ø‡•Ç‡§Æ‡•á ‡§µ‡§ø‡§ú‡§º‡•Å‡§Ö‡§≤‡§æ‡§á‡§ú‡§º‡§∞ - ‡§∞‡§ø‡§≤‡•Ä‡§ú‡§º ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§∞‡§æ‡§∏‡•ç‡§§‡•á ‡§™‡§∞ ‡§è‡§°‡§µ‡•á‡§Ç‡§ö‡§∞‡•ç‡§∏</a></li>
<li><a href="../pt415043/index.html">Rob√¥ voador muda de forma no ar</a></li>
<li><a href="../pt415045/index.html">A pol√≠tica de licenciamento da Oracle impulsiona as an√°lises no Hadoop</a></li>
<li><a href="../pt415047/index.html">Eventos digitais em Moscou, de 25 de junho a 1 de julho</a></li>
<li><a href="../pt415049/index.html">Criando comandos de gerenciamento no Django</a></li>
<li><a href="../pt415053/index.html">Por que os processadores Skylake √†s vezes rodam 2 vezes mais devagar</a></li>
<li><a href="../pt415055/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 320 (18-24 de junho de 2018)</a></li>
<li><a href="../pt415057/index.html">PHP Digest No. 133 (10 a 24 de junho de 2018)</a></li>
<li><a href="../pt415059/index.html">Segredos da culin√°ria JavaScript: especiarias</a></li>
<li><a href="../pt415061/index.html">Do front-end ao back-end</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>