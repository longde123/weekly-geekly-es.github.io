<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçü§ù‚Äçüë®üèº üôãüèæ üíä C√≥mo conectar GitLab y Pantheon y optimizar los flujos de trabajo de Drupal y WordPress ü§≠ üßñüèø ü§∞üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nuestro invitado, creador de las herramientas de desarrollo de Pantheon, habla sobre c√≥mo automatizar las implementaciones de WordPress usando GitLab ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo conectar GitLab y Pantheon y optimizar los flujos de trabajo de Drupal y WordPress</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/447966/"><p><img src="https://habrastorage.org/webt/ja/h2/ef/jah2efouevm2la2v9vkt3vuojm8.png"></p><br><p>  Nuestro invitado, creador de las herramientas de desarrollo de Pantheon, habla sobre c√≥mo automatizar las implementaciones de WordPress usando GitLab CI / CD. </p><br><p>  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pantheon,</a> me ocupo de las relaciones con los desarrolladores, por lo que siempre busco nuevas formas de ayudar a los desarrolladores de WordPress y Drupal a resolver problemas de automatizaci√≥n en sus flujos de trabajo.  Para hacer esto, me gusta experimentar con nuevas herramientas y combinarlas entre s√≠ para un trabajo efectivo. </p><br><p>  <strong>A menudo veo desarrolladores atormentados con un √∫nico servidor de desarrollo.</strong> </p><br><p> Muy divertido: esperar su turno para usar un servidor o enviar a los clientes una URL con una nota: "Mire aqu√≠, pero no mire aqu√≠". </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Los entornos multidev</a> , una de las herramientas geniales de Pantheon, resuelven este problema, porque con ellos puede crear entornos para las sucursales de Git a pedido.  Cada entorno multidev tiene su propia URL y base de datos, por lo que los desarrolladores trabajan en silencio, verifican la calidad y obtienen la aprobaci√≥n sin pisar los talones. </p><br><p>  Pero Pantheon no tiene herramientas para el control de versiones o la integraci√≥n y despliegue continuo (CI / CD).  Pero esta es una plataforma flexible con la que puede integrar cualquier herramienta. </p><br><p>  <strong>Tambi√©n not√© que para el desarrollo del equipo utilizan una herramienta, y para el ensamblaje y la implementaci√≥n, otras.</strong> </p><br><p>  Por ejemplo, tienen diferentes herramientas para el control de versiones y CI / CD.  Tienes que perder el tiempo y cambiar entre herramientas para editar el c√≥digo y diagnosticar problemas. </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitLab</a> tiene un conjunto completo de herramientas de desarrollo: para control de versiones, tickets, solicitudes de fusi√≥n, la mejor canalizaci√≥n de CI / CD en la clase, un registro de contenedores y todo eso.  No he encontrado aplicaciones en las que habr√≠a tanto para administrar el flujo de trabajo de desarrollo. </p><br><p>  Me encanta la automatizaci√≥n, as√≠ que aprend√≠ c√≥mo conectar Pantheon a GitLab para que los compromisos con la rama principal de GitLab se implementen en el entorno de desarrollo principal en Pantheon.  Y las solicitudes de fusi√≥n en GitLab pueden crear e implementar c√≥digo en entornos multidev en Pantheon. </p><br><p>  En este tutorial, le mostrar√© c√≥mo configurar una conexi√≥n entre GitLab y Pantheon y optimizar su flujo de trabajo de WordPress y Drupal. </p><br><p>  Por supuesto, puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">duplicar el repositorio de GitLab</a> , pero haremos todo lo posible con l√°pices para profundizar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitLab CI</a> y usar esta herramienta no solo para la implementaci√≥n en el futuro. </p><br><h3 id="vvedenie">  Introduccion </h3><br><p>  Para esta publicaci√≥n, debe comprender que Pantheon divide cada sitio en tres elementos: c√≥digo, base de datos y archivos. </p><br><p>  El c√≥digo incluye archivos CMS, como el n√∫cleo, los complementos y los temas de WordPress.  Estos archivos se administran en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el repositorio de Git</a> alojado por Pantheon, es decir, podemos implementar c√≥digo de GitLab a Pantheon con Git. <br>  Los archivos en Pantheon se denominan archivos multimedia, es decir, im√°genes del sitio.  Por lo general, los usuarios los descargan y Git los ignora. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cree una cuenta gratuita</a> , obtenga m√°s informaci√≥n sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el flujo de trabajo de Pantheon</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reg√≠strese para una demostraci√≥n</a> en pantheon.io. </p><br><h3 id="predpolozheniya">  Supuestos </h3><br><p> Mi proyecto sobre Pantheon y GitLab se llama <code>pantheon-gitlab-blog-demo</code> .  El nombre del proyecto debe ser √∫nico.  Aqu√≠ trabajaremos con el sitio de WordPress.  Puede tomar Drupal, pero deber√° cambiar algo. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Usar√© la l√≠nea de comando Git</a> , y puedes trabajar en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GUI</a> si quieres. </p><br><h3 id="sozdaem-proekt">  Crear un proyecto </h3><br><p>  Para comenzar, cree <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un proyecto GitLab</a> (volveremos a eso). </p><br><p>  Ahora <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">crea un sitio de WordPress en Pantheon</a> .  Luego instale WordPress para el sitio del tablero. </p><br><blockquote>  Si le pican las manos, cambie algo, por ejemplo, elimine y agregue complementos, sea paciente.  El sitio a√∫n no est√° conectado a GitLab, y queremos que todos los cambios de c√≥digo pasen por GitLab. </blockquote><p>  Cuando instalamos WordPress, volvemos al panel del sitio web de Pantheon y cambiamos el modo de desarrollo a Git. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/up/zf/50/upzf50ocuma107rer9uxiybvjnc.png"></a> </p><br><h3 id="nachalnyy-kommit-na-gitlab">  Compromiso inicial de GitLab </h3><br><p>  Ahora necesita transferir el c√≥digo inicial de WordPress desde el sitio web de Pantheon a GitLab.  Para hacer esto, clonamos el c√≥digo del repositorio Git del sitio Pantheon localmente y luego lo enviamos al repositorio GitLab. </p><br><p>  Para hacerlo m√°s f√°cil y seguro, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agregaremos una clave SSH a Pantheon</a> y no ingresaremos la contrase√±a cada vez que clonemos el repositorio Pantheon Git.  Al mismo tiempo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agregaremos una clave SSH a GitLab</a> . </p><br><p>  Para hacer esto, clonamos el sitio de Pantheon localmente copiando el comando del campo Clonar con Git en el tablero del sitio. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/em/qz/ga/emqzgamloafdlzbj3xp0ssrt2o0.png"></a> <br>  <em>Si necesita ayuda, lea la documentaci√≥n de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Inicio de Git para Pantheon</a> .</em> </p><br><p>  Ahora cambie <code>git remote origin</code> para que apunte a GitLab en lugar de Pantheon.  Esto se puede hacer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code> git remote</code></a> . </p><br><p>  Vayamos al proyecto GitLab y copiemos la URL del repositorio de la lista desplegable Clonar en la p√°gina de detalles del proyecto.  Seleccionaremos la opci√≥n Clonar con SSH, porque ya hemos configurado la clave SSH. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6m/4o/ea/6m4oeailmhmcggywg27uptq7aio.png"></a> </p><br><p>  Por defecto, <code>git remote</code> para la copia local del repositorio de c√≥digo es <code>origin</code> .  Esto se puede cambiar con <code>git remote set-url origin [URL  GitLab]</code> , donde en lugar de par√©ntesis, ingresamos la URL real. </p><br><p>  Finalmente, ejecute <code>git push origin master --force</code> para enviar su c√≥digo de WordPress desde Pantheon a GitLab. </p><br><blockquote>  La opci√≥n ‚Äìforce se necesita solo una vez.  Luego, en los comandos de <code>git push</code> en GitLab no lo ser√°. </blockquote><br><h3 id="nastraivaem-uchetnye-dannye-i-peremennye">  Configurar credenciales y variables </h3><br><p>  ¬øRecuerdas c√≥mo agregamos localmente una clave SSH para iniciar sesi√≥n en Pantheon y GitLab?  El token SSH se puede usar para autorizar GitLab y Pantheon. </p><br><p>  GitLab tiene una excelente documentaci√≥n.  Veamos la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">secci√≥n sobre claves SSH al usar el ejecutor Docker en el documento sobre el uso de claves SSH con GitLab CI / CD</a> . </p><br><p>  Ahora completaremos los dos primeros pasos: <em>crear un nuevo par de claves SSH localmente con ssh-keygen y agregar la clave privada como una variable al proyecto</em> . </p><br><p>  Luego configuramos <code>SSH_PRIVATE_KEY</code> como la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">variable de entorno GitLab CI / CD</a> en la configuraci√≥n del proyecto. <br>  En los pasos tercero y cuarto, cree un <code>.gitlab-ci.yml</code> con el siguiente contenido: </p><br><pre> <code class="plaintext hljs">before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI"</code> </pre> <br><p>  Hasta que <code>.gitlab-ci.yml</code> , entonces se debe agregar algo m√°s. </p><br><p>  Ahora realizamos el quinto paso y <em>agregamos la clave p√∫blica que creamos en el primer paso a los servicios a los que necesita acceder en el entorno de compilaci√≥n</em> . </p><br><p>  En nuestro caso, queremos obtener acceso a Pantheon desde GitLab.  Siga las instrucciones en el documento de Pantheon para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">agregar una clave SSH a Pantheon</a> y complete este paso. </p><br><blockquote>  Recuerde: cerrado SSH en GitLab, abierto en Pantheon. </blockquote><p>  Configure algunas variables de entorno m√°s.  El primero se llama PANTHEON_SITE.  Su significado es el nombre del sitio Pantheon en su m√°quina. </p><br><p>  El nombre en la m√°quina se indica al final del comando Clonar con Git.  Ya ha clonado el sitio localmente, por lo que este ser√° el nombre del directorio del repositorio local. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/rf/3p/gb/rf3pgbmo_2u0xsri8d1hq5f-xxw.png"></a> </p><br><p>  A continuaci√≥n, configure la <code>PANTHEON_GIT_URL</code> entorno <code>PANTHEON_GIT_URL</code> .  Esta es la URL del repositorio de Git para el sitio Pantheon que ya hemos usado. </p><br><blockquote>  Ingresamos solo la URL del repositorio SSH, sin <code>git clone</code> y el nombre del sitio en la m√°quina al final. </blockquote><p>  Fuh  Esto est√° hecho, ahora podemos terminar nuestro <code>.gitlab-ci.yml</code> . </p><br><h3 id="sozdaem-zadachu-deploya">  Crear una tarea de implementaci√≥n </h3><br><p>  Lo que haremos inicialmente con GitLab CI es muy similar a lo que hicimos con los repositorios de Git antes.  Pero esta vez, agregue el repositorio Pantheon como la segunda fuente remota de Git y luego env√≠e el c√≥digo de GitLab a Pantheon. </p><br><p>  Para hacer esto, configure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la etapa de</a> <code>deploy</code> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la tarea</a> <code>deploy:dev</code> , porque implementaremos el entorno de desarrollo en Pantheon.  Como resultado, el <code>.gitlab-ci.yml</code> se ver√° as√≠: </p><br><pre> <code class="plaintext hljs">stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master</code> </pre> <br><p>  Las variables <code>SSH_PRIVATE_KEY, PANTHEON_SITE</code> y <code>PANTHEON_GIT_URL</code> deber√≠an ser familiares: configuramos estas variables de entorno anteriormente.  Con estas variables, podemos usar los valores en el <code>.gitlab-ci.yml</code> muchas veces, y solo necesitaremos actualizarlos en un solo lugar. </p><br><p>  Finalmente, agregue, <code>.gitlab-ci.yml</code> y <code>.gitlab-ci.yml</code> a GitLab. </p><br><h3 id="proveryaem-deploy">  Comprobar implementaci√≥n </h3><br><p>  Si hicimos todo bien, la tarea <code>deploy:dev</code> tendr√° √©xito en el CI / CD de GitLab y enviar√° el <code>.gitlab-ci.yml</code> a Pantheon.  A ver </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ex/pu/to/exputo8aihdn0sxv1aavrpa-rg4.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2w/4_/zs/2w4_zszf0r6dxu8jvgo-ogfzzqi.png"></a> </p><br><p> <a href=""><img src="https://habrastorage.org/webt/6z/tk/ir/6ztkirsm-22bbcegra12_lyx3zg.png"></a> </p><br><h3 id="otpravlyaem-vetki-merzh-rekvestov-v-pantheon">  Enviamos ramas de solicitudes de fusi√≥n a Pantheon </h3><br><p>  Aqu√≠ usaremos mi caracter√≠stica favorita de Pantheon: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">multidev</a> , donde puede crear entornos Pantheon adicionales para las sucursales de Git a pedido. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El acceso a multidev es limitado</a> , por lo que esta secci√≥n es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">opcional</a> .  Pero si tiene acceso, puede aumentar considerablemente la productividad configurando la creaci√≥n autom√°tica de entornos multidev en Pantheon a partir de solicitudes de fusi√≥n de GitLab. </p><br><p>  Primero, <code>git checkout -b multidev-support</code> una nueva rama de Git localmente usando <code>git checkout -b multidev-support</code> .  Ahora, nuevamente, algo cambiar√° en <code>.gitlab-ci.yml</code> . </p><br><p>  Me gusta indicar el n√∫mero de solicitud de fusi√≥n en el nombre del entorno Pantheon.  Por ejemplo, la primera solicitud de fusi√≥n es <code>mr-1</code> , la segunda es <code>mr-2</code> , etc. </p><br><p>  La solicitud de fusi√≥n est√° cambiando, por lo que debemos identificar din√°micamente los nombres de rama de Pantheon.  En GitLab, esto es simple: debe usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">variables de entorno predefinidas</a> . </p><br><p>  Podemos tomar <code>$CI_MERGE_REQUEST_IID</code> para indicar el n√∫mero de solicitud de fusi√≥n.  Apliquemos todo esto junto con las variables de entorno global que especificamos anteriormente, y agreguemos una nueva implementaci√≥n: tarea multidev al final del <code>.gitlab-ci.yml</code> . </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Checkout the merge request source branch - git checkout $CI_COMMIT_REF_NAME # Add the Pantheon git repository as an additional remote - git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon - git push pantheon $CI_COMMIT_REF_NAME:mr-$CI_MERGE_REQUEST_IID --force only: - merge_requests</code> </pre> <br><p>  Ser√° similar a nuestro <code>deploy:dev</code> tarea de desarrollo, solo la rama se env√≠a a Pantheon, y no a <code>master</code> . </p><br><p>  <code>.gitlab-ci.yml</code> actualizado, y ahora enviaremos una nueva rama a GitLab con <code>git push -u origin multidev-support</code> . </p><br><p>  Ahora cree una nueva <em>solicitud de fusi√≥n</em> desde la <code>multidev-support</code> haciendo clic en <em>Crear solicitud de fusi√≥n</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/bi/bv/gt/bibvgthkwykacqew-cswygjdmig.png"></a> </p><br><p>  Una vez creada la solicitud de fusi√≥n, observamos c√≥mo se realiza la <code>deploy:multidev</code> CI / CD <code>deploy:multidev</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ck/ev/lq/ckevlqnrfbfanoj0dlmjt26wxpw.png"></a> </p><br><p>  Mira, se ha enviado una nueva sucursal a Pantheon.  Pero si vamos a la secci√≥n multidev en el panel de control del sitio Pantheon, no veremos el nuevo entorno all√≠. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/yy/yy/bz/yyyybzmedtphnsj-6humcyu2hmu.png"></a> </p><br><p>  Echa un vistazo a la secci√≥n Ramas de Git. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/hp/_o/bl/hp_obl6r7pv4ihuot7i6gx4rqwm.png"></a> </p><br><p>  Como resultado, nuestra rama <code>mr-1</code> lleg√≥ al Pante√≥n.  Cree un entorno desde la rama <code>mr-1</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/2v/xg/ez/2vxgez9ugraihe2bdyn-5cxevjm.png"></a> </p><br><p>  Creamos un entorno multidev y ahora volvemos a GitLab y mira la secci√≥n <em>Operaciones&gt; Entornos</em> .  Veremos entradas para <code>dev</code> y <code>mr-1</code> . </p><br><p>  Esto se debe a que agregamos una entrada de <code>environment</code> llamada <code>name</code> y <code>url</code> a las tareas de CI / CD.  Si hacemos clic en el √≠cono de entorno abierto, iremos a la URL del entorno multidev Pantheon. </p><br><h3 id="avtomatiziruem-sozdanie-multidev">  Automatiza la creaci√≥n de multidev </h3><br><p>  En principio, puede detenerse aqu√≠ y recordar crear un entorno multidev para cada solicitud de fusi√≥n, pero este proceso puede automatizarse. </p><br><p>  Pantheon tiene una herramienta de l√≠nea de comando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Terminus</a> donde puede trabajar con la plataforma autom√°ticamente.  En Terminus, puede crear entornos multidev desde la l√≠nea de comandos, ideal para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitLab CI</a> . </p><br><p>  Necesitamos una nueva solicitud de fusi√≥n para probarlo.  Cree una nueva rama usando <code>git checkout -b auto-multidev-creation</code> . </p><br><p>  Para usar Terminus en las tareas de GitLab CI / CD, necesita un token de m√°quina para la autenticaci√≥n en Terminus y una imagen de contenedor con Terminus. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Cree un token de m√°quina Pantheon</a> , gu√°rdelo en un lugar seguro y agr√©guelo como una variable de entorno global en GitLab con el nombre <code>PANTHEON_MACHINE_TOKEN</code> . </p><br><blockquote>  Si olvid√≥ c√≥mo agregar variables de entorno de GitLab, vuelva a donde definimos <code>PANTHEON_SITE</code> . </blockquote><br><h3 id="sozdaem-dockerfile-s-terminus">  Crear un Dockerfile con Terminus </h3><br><p>  Si no usa Docker o no le gustan los <code>Dockerfile</code> , tome mi <code>registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest</code> image y omita esta secci√≥n. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GitLab tiene un registro de contenedor</a> donde puede construir y alojar un Dockerfile para nuestro proyecto.  Creemos un Dockerfile con Terminus para trabajar con Pantheon. </p><br><p>  Terminus es una herramienta de l√≠nea de comandos en PHP, as√≠ que comencemos con la imagen PHP.  Instalo Terminus a trav√©s de Composer, as√≠ que tomar√© la imagen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">oficial de Docker Composer</a> como base.  Cree un <code>Dockerfile</code> en el directorio del repositorio local con los siguientes contenidos: </p><br><pre> <code class="plaintext hljs"># Use the official Composer image as a parent image FROM composer:1.8 # Update/upgrade apk RUN apk update RUN apk upgrade # Make the Terminus directory RUN mkdir -p /usr/local/share/terminus # Install Terminus 2.x with Composer RUN /usr/bin/env COMPOSER_BIN_DIR=/usr/local/bin composer -n --working-dir=/usr/local/share/terminus require pantheon-systems/terminus:"^2"</code> </pre> <br><p>  Siga las instrucciones para ensamblar y enviar im√°genes desde la secci√≥n <em>Compilar y enviar im√°genes</em> en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n del registro</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">contenedor</a> para recopilar la imagen del <code>Dockerfile</code> y enviarla a GitLab. </p><br><p>  Abra la secci√≥n <em>Registro</em> en el proyecto GitLab.  Si todo sali√≥ seg√∫n lo planeado, habr√° nuestra imagen.  Registre el enlace a la etiqueta de la imagen; lo necesitamos para el <code>.gitlab-ci.yml</code> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/_x/ta/yn/_xtayn5xz10hq5kuv7abvqvskgq.png"></a> </p><br><p>  La secci√≥n de <code>script</code> en la <code>deploy:multidev</code> comienza a crecer, as√≠ que vamos a moverla a un archivo separado.  Cree un nuevo <code>private/multidev-deploy.sh:</code> </p><br><pre> <code class="plaintext hljs">#!/bin/bash # Store the mr- environment name export PANTHEON_ENV=mr-$CI_MERGE_REQUEST_IID # Authenticate with Terminus terminus auth:login --machine-token=$PANTHEON_MACHINE_TOKEN # Checkout the merge request source branch git checkout $CI_COMMIT_REF_NAME # Add the Pantheon Git repository as an additional remote git remote add pantheon $PANTHEON_GIT_URL # Push the merge request source branch to Pantheon git push pantheon $CI_COMMIT_REF_NAME:$PANTHEON_ENV --force # Create a function for determining if a multidev exists TERMINUS_DOES_MULTIDEV_EXIST() { # Stash a list of Pantheon multidev environments PANTHEON_MULTIDEV_LIST="$(terminus multidev:list ${PANTHEON_SITE} --format=list --field=id)" while read -r multiDev; do if [[ "${multiDev}" == "$1" ]] then return 0; fi done &lt;&lt;&lt; "$PANTHEON_MULTIDEV_LIST" return 1; } # If the mutltidev doesn't exist if ! TERMINUS_DOES_MULTIDEV_EXIST $PANTHEON_ENV then # Create it with Terminus echo "No multidev for $PANTHEON_ENV found, creating one..." terminus multidev:create $PANTHEON_SITE.dev $PANTHEON_ENV else echo "The multidev $PANTHEON_ENV already exists, skipping creating it..." fi</code> </pre> <br><p>  El script se encuentra en un directorio privado y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no proporciona acceso web en Pantheon</a> .  Tenemos un script para nuestra l√≥gica multidev.  <code>deploy:multidev</code> archivo <code>.gitlab-ci.yml</code> para obtener esto: </p><br><pre> <code class="plaintext hljs">deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Necesitamos asegurarnos de que nuestras tareas se realicen en la imagen personalizada creada, por lo que agregamos la <code>image</code> definici√≥n con la URL del registro en <code>.gitlab-ci.yml</code> .  Como resultado, obtuvimos el siguiente <code>.gitlab-ci.yml</code> : </p><br><pre> <code class="plaintext hljs">image: registry.gitlab.com/ataylorme/pantheon-gitlab-blog-demo:latest stages: - deploy before_script: # See https://docs.gitlab.com/ee/ci/ssh_keys/README.html - eval $(ssh-agent -s) - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add - &gt; /dev/null - mkdir -p $HOME/.ssh &amp;&amp; echo "StrictHostKeyChecking no" &gt;&gt; "$HOME/.ssh/config" - git config --global user.email "$GITLAB_USER_EMAIL" - git config --global user.name "Gitlab CI" deploy:dev: stage: deploy environment: name: dev url: https://dev-$PANTHEON_SITE.pantheonsite.io/ script: - git remote add pantheon $PANTHEON_GIT_URL - git push pantheon master --force only: - master deploy:multidev: stage: deploy environment: name: multidev/mr-$CI_MERGE_REQUEST_IID url: https://mr-$CI_MERGE_REQUEST_IID-$PANTHEON_SITE.pantheonsite.io/ script: # Run the multidev deploy script - "/bin/bash ./private/multidev-deploy.sh" only: - merge_requests</code> </pre> <br><p>  Agregue, <code>private/multidev-deploy.sh</code> y env√≠e <code>private/multidev-deploy.sh</code> y <code>.gitlab-ci.yml</code> .  Ahora regrese a GitLab y espere a que se complete la tarea de CI / CD.  Sea paciente: multidev puede tomar varios minutos. </p><br><p>  Luego vamos a ver la lista multidev en Pantheon.  ¬°Oh milagro!  El entorno multidev <code>mr-2</code> ya est√° aqu√≠. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/gx/jf/ab/gxjfabnawlvvtncrg268q7nwkiw.png"></a> </p><br><h3 id="zaklyuchenie">  Conclusi√≥n </h3><br><p>  Mi equipo se gan√≥ mucha m√°s diversi√≥n cuando comenzamos a abrir solicitudes de fusi√≥n y crear entornos autom√°ticamente. </p><br><p>  Con las poderosas herramientas GitLab y Pantheon, puede conectar GitLab a Pantheon autom√°ticamente. </p><br><p>  Una vez que usemos GitLab CI / CD, nuestro flujo de trabajo estar√° donde crecer.  Aqu√≠ hay un par de ideas para comenzar: </p><br><ul><li>  Agrega un paso de compilaci√≥n. </li><li>  A√±adir pruebas automatizadas. </li><li>  Agregue una tarea para garantizar el cumplimiento de los est√°ndares del c√≥digo. </li><li>  Agregue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pruebas de seguridad de aplicaciones din√°micas</a> . </li></ul><br><p>  Escribe lo que piensas de GitLab, Pantheon y la automatizaci√≥n. </p><br><p>  PD: ¬øSab√≠a que Terminus, la herramienta de l√≠nea de comandos Pantheon, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se puede ampliar a trav√©s de complementos</a> ? </p><br><p>  En Pantheon trabajamos duro en la versi√≥n 2 de nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">complemento para las herramientas de compilaci√≥n de Terminus</a> habilitadas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">para</a> GitLab.  Si no desea jugar con la configuraci√≥n de cada proyecto, pruebe este complemento y ay√∫denos a probar la versi√≥n beta v2.  Para el comando <code>build:project:create</code> Terminus, solo necesita el token Pantheon y el token GitLab.  Implementar√° un proyecto de ejemplo con Composer y pruebas automatizadas, crear√° un nuevo proyecto en GitLab, el nuevo sitio Pantheon, y los conectar√° utilizando variables de entorno y claves SSH. </p><br><h3 id="ob-avtore">  Sobre el autor </h3><br><p>  Andrew Taylor crea herramientas para desarrolladores en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pantheon</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/447966/">https://habr.com/ru/post/447966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../447956/index.html">Comunicaciones cu√°nticas en la Universidad ITMO: un proyecto de sistemas de transferencia de datos irrompibles</a></li>
<li><a href="../447958/index.html">CJM por activaci√≥n falsa del antivirus DrWeb</a></li>
<li><a href="../447960/index.html">Veeam Linux Backup en Elbrus OS. Sustituci√≥n de importaci√≥n ['?' El | '.' El | '!']</a></li>
<li><a href="../447962/index.html">Los piratas inform√°ticos pueden controlar remotamente el Tesla Model S utilizando el sistema de piloto autom√°tico</a></li>
<li><a href="../447964/index.html">Prueba de microordenador para IoT</a></li>
<li><a href="../447968/index.html">Escribiendo en Rust + CUDA C</a></li>
<li><a href="../447970/index.html">Registro de JavaScript s√∫per simple: dos decoradores y listo</a></li>
<li><a href="../447976/index.html">Desarrollo y montaje de una l√°mpara fotogr√°fica.</a></li>
<li><a href="../447980/index.html">¬øPor qu√© es imprescindible invertir y desarrollar una aplicaci√≥n de taxi de marca para su empresa?</a></li>
<li><a href="../447982/index.html">Compendio: 10 materiales sobre pantallas y proyectores para cine en casa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>