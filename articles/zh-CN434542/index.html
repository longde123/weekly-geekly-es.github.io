<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ½â€ğŸ“ ğŸ˜œ ğŸˆ¯ï¸ ä¼ä¸šå­˜å‚¨æ•°æ®è´¨é‡æ§åˆ¶æµç¨‹è‡ªåŠ¨åŒ– ğŸ“ ğŸ‘´ğŸ¿ ğŸ‘‰ğŸ¼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä¸ä»»ä½•å¤§å…¬å¸ä¸€æ ·ï¼Œåœ¨Rostelecomä¸­ï¼Œæœ‰ä¸€ä¸ªå…¬å¸æ•°æ®ä»“åº“ï¼ˆWCDï¼‰ã€‚ æˆ‘ä»¬çš„WCDä¸æ–­å¢é•¿å’Œæ‰©å±•ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸Šæ„å»ºæœ‰ç”¨çš„åº—é¢ï¼ŒæŠ¥è¡¨å’Œæ•°æ®å¤šç»´æ•°æ®é›†ã€‚ åœ¨æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬é¢ä¸´è¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œé‚£å°±æ˜¯åœ¨æ„å»ºçª—å£æ˜¾ç¤ºæ—¶ï¼ŒåŠ£è´¨æ•°æ®ä¼šå¹²æ‰°æˆ‘ä»¬ï¼Œå¯¼è‡´ç”Ÿæˆçš„å•ä½æ— æ³•ä¸æºç³»ç»Ÿçš„å•ä½èåˆï¼Œä»è€Œå¯¼è‡´å¯¹ä¸šåŠ¡çš„äº†è§£ä¸è¶³ã€‚ ä¾‹...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¼ä¸šå­˜å‚¨æ•°æ®è´¨é‡æ§åˆ¶æµç¨‹è‡ªåŠ¨åŒ–</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rostelecom/blog/434542/">ä¸ä»»ä½•å¤§å…¬å¸ä¸€æ ·ï¼Œåœ¨Rostelecomä¸­ï¼Œæœ‰ä¸€ä¸ªå…¬å¸æ•°æ®ä»“åº“ï¼ˆWCDï¼‰ã€‚ æˆ‘ä»¬çš„WCDä¸æ–­å¢é•¿å’Œæ‰©å±•ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸Šæ„å»ºæœ‰ç”¨çš„åº—é¢ï¼ŒæŠ¥è¡¨å’Œæ•°æ®å¤šç»´æ•°æ®é›†ã€‚ åœ¨æŸäº›æ—¶å€™ï¼Œæˆ‘ä»¬é¢ä¸´è¿™æ ·ä¸€ä¸ªäº‹å®ï¼Œé‚£å°±æ˜¯åœ¨æ„å»ºçª—å£æ˜¾ç¤ºæ—¶ï¼ŒåŠ£è´¨æ•°æ®ä¼šå¹²æ‰°æˆ‘ä»¬ï¼Œå¯¼è‡´ç”Ÿæˆçš„å•ä½æ— æ³•ä¸æºç³»ç»Ÿçš„å•ä½èåˆï¼Œä»è€Œå¯¼è‡´å¯¹ä¸šåŠ¡çš„äº†è§£ä¸è¶³ã€‚ ä¾‹å¦‚ï¼Œå¤–é”®ï¼ˆå¤–é”®ï¼‰ä¸­å…·æœ‰Nullå€¼çš„æ•°æ®æœªè¿æ¥åˆ°å…¶ä»–è¡¨ä¸­çš„æ•°æ®ã€‚ <br>  WCDçš„ç®€å›¾ï¼š <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd8/4e9/34f/bd84e934f59ab39d8142ed7c18b397a8.png"><br><br> æˆ‘ä»¬äº†è§£ï¼Œä¸ºäº†ç¡®ä¿å¯¹æ•°æ®è´¨é‡çš„ä¿¡å¿ƒï¼Œæˆ‘ä»¬éœ€è¦å®šæœŸè¿›è¡Œå¯¹å¸æµç¨‹ã€‚ å½“ç„¶ï¼Œå®ƒæ˜¯è‡ªåŠ¨åŒ–çš„ï¼Œå¹¶å…è®¸æ¯ä¸ªæŠ€æœ¯çº§åˆ«åœ¨å‚ç›´å’Œæ°´å¹³æ–¹å‘ä¸Šéƒ½ç¡®ä¿æ•°æ®çš„è´¨é‡åŠå…¶èåˆã€‚ ç»“æœï¼Œæˆ‘ä»¬åŒæ—¶å®¡æŸ¥äº†ä¸‰ä¸ªç°æˆçš„å¹³å°æ¥ç®¡ç†æ¥è‡ªå„ä¸ªä¾›åº”å•†çš„å¯¹å¸ï¼Œå¹¶ç¼–å†™äº†æˆ‘ä»¬è‡ªå·±çš„å¹³å°ã€‚ æˆ‘ä»¬åœ¨è¿™ç¯‡æ–‡ç« ä¸­åˆ†äº«æˆ‘ä»¬çš„ç»éªŒã€‚ <br><a name="habracut"></a><br> æˆå“å¹³å°çš„ç¼ºç‚¹æ˜¯ä¼—æ‰€å‘¨çŸ¥çš„ï¼šä»·æ ¼ï¼Œæœ‰é™çš„çµæ´»æ€§ï¼Œç¼ºä¹æ·»åŠ å’Œä¿®å¤åŠŸèƒ½çš„èƒ½åŠ›ã€‚ ä¼˜ç‚¹-mdmé›¶ä»¶ï¼ˆé»„é‡‘æ•°æ®ç­‰ï¼‰ï¼ŒåŸ¹è®­å’Œæ”¯æŒä¹Ÿå·²å…³é—­ã€‚ åœ¨æ„è¯†åˆ°è¿™ä¸€ç‚¹ä¹‹åï¼Œæˆ‘ä»¬å¾ˆå¿«å°±å¿˜è®°äº†è´­ä¹°ï¼Œè€Œä¸“æ³¨äºå¼€å‘æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆã€‚ <br><br> æˆ‘ä»¬ç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯ç”¨Pythonç¼–å†™çš„ï¼Œç”¨äºå­˜å‚¨ï¼Œè®°å½•å’Œå­˜å‚¨ç»“æœçš„å…ƒæ•°æ®æ•°æ®åº“æ˜¯ç”¨Oracleç¼–å†™çš„ã€‚  Pythonæœ‰å¾ˆå¤šåº“ï¼Œæˆ‘ä»¬ä¸ºHiveï¼ˆpyhiveï¼‰ï¼ŒGreenPlumï¼ˆpgdbï¼‰ï¼ŒOracleï¼ˆcx_Oracleï¼‰è¿æ¥ä½¿ç”¨äº†å¿…è¦çš„æœ€å°å€¼ã€‚ è¿æ¥å…¶ä»–ç±»å‹çš„æºä¹Ÿåº”è¯¥ä¸æ˜¯é—®é¢˜ã€‚ <br><br> æˆ‘ä»¬å°†ç”Ÿæˆçš„æ•°æ®é›†ï¼ˆç»“æœé›†ï¼‰æ”¾å…¥ç”Ÿæˆçš„Oracleè¡¨ä¸­ï¼Œå¯ä»¥éšæ—¶è¯„ä¼°å¯¹å¸çš„çŠ¶æ€ï¼ˆSUCCESS / ERRORï¼‰ã€‚ åœ¨ç”Ÿæˆç»“æœå¯è§†åŒ–çš„ç»“æœè¡¨ä¸Šé…ç½®äº†APEXï¼Œä¾¿äºç»´æŠ¤å’Œç®¡ç†ã€‚ <br><br> è¦åœ¨å­˜å‚¨åº“ä¸­è¿è¡Œæ£€æŸ¥ï¼Œå°†ä½¿ç”¨Informaticaä¹å›¢ï¼Œè¯¥ä¹å›¢ä¸‹è½½æ•°æ®ã€‚ æ”¶åˆ°ä¸‹è½½æˆåŠŸçŠ¶æ€åï¼Œæ­¤æ•°æ®å°†è‡ªåŠ¨å¼€å§‹è¿›è¡ŒéªŒè¯ã€‚ æŸ¥è¯¢å‚æ•°åŒ–å’ŒWCDå…ƒæ•°æ®çš„ä½¿ç”¨å…è®¸å¯¹è¡¨é›†ä½¿ç”¨æŸ¥è¯¢åè°ƒæ¨¡æ¿ã€‚ <br><br> ç°åœ¨ä»‹ç»åœ¨æ­¤å¹³å°ä¸Šå®ç°çš„å¯¹å¸ã€‚ <br><br> æˆ‘ä»¬ä»æŠ€æœ¯å¯¹å¸å¼€å§‹ï¼Œè¯¥å¯¹å¸å°†WCDçš„è¾“å…¥å’Œå±‚ä¸Šçš„æ•°æ®é‡ä¸æŸäº›è¿‡æ»¤å™¨çš„åº”ç”¨è¿›è¡Œæ¯”è¾ƒã€‚ æˆ‘ä»¬è·å–WCDè¾“å…¥ä¸­çš„ctlæ–‡ä»¶ï¼Œä»ä¸­è¯»å–è®°å½•æ•°ï¼Œå¹¶å°†å…¶ä¸Stage ODLå’Œ/æˆ–Stage ODSä¸Šçš„è¡¨ï¼ˆå›¾ä¸­çš„1ã€2ã€3ï¼‰è¿›è¡Œæ¯”è¾ƒã€‚ éªŒè¯æ ‡å‡†ä»¥è®°å½•æ•°ï¼ˆè®¡æ•°ï¼‰çš„ç›¸ç­‰æ€§å®šä¹‰ã€‚ å¦‚æœæ•°é‡æ”¶æ•›ï¼Œåˆ™ç»“æœä¸ºSUCCESSï¼ˆæˆåŠŸï¼‰ï¼Œå¦-ERRORï¼ˆé”™è¯¯ï¼‰å¹¶æ‰‹åŠ¨åˆ†æé”™è¯¯ã€‚ <br><br> ä¸è®°å½•æ•°ç›¸æ¯”ï¼Œè¿™ç§æŠ€æœ¯å¯¹å¸é“¾æ‰©å±•åˆ°äº†ADSå±‚ï¼ˆå›¾ä¸­ä¸º8ï¼‰ã€‚ è¿‡æ»¤å™¨åœ¨å±‚ä¹‹é—´è¿›è¡Œæ›´æ”¹ï¼Œè¿™å–å†³äºåŠ è½½ç±»å‹-DIMï¼ˆå‚è€ƒä¹¦ï¼‰ï¼ŒHDIMï¼ˆå†å²å‚è€ƒä¹¦ï¼‰ï¼ŒFACTï¼ˆå®é™…åº”è®¡è¡¨ï¼‰ç­‰-ä»¥åŠSCDå’Œå±‚çš„ç‰ˆæœ¬æ§åˆ¶ã€‚ ç¦»æ˜¾ç¤ºå±‚è¶Šè¿‘ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„è¿‡æ»¤ç®—æ³•å°±è¶Šå¤æ‚ã€‚ <br><br> è¿˜å¯¹Pythonä¸­çš„è¾“å…¥è¿›è¡Œäº†æŠ€æœ¯æ£€æŸ¥ï¼Œä»¥æ£€æµ‹å…³é”®å­—æ®µä¸­çš„é‡å¤é¡¹ã€‚ åœ¨æˆ‘ä»¬çš„GreenPlumä¸­ï¼Œæ•°æ®åº“ç³»ç»Ÿå·¥å…·ä¸ä¿æŠ¤å…³é”®å­—æ®µï¼ˆPKï¼‰å…å—é‡å¤ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªPythonè„šæœ¬ï¼Œè¯¥è„šæœ¬ä»PKå…ƒæ•°æ®ä¸­è¯»å–å·²åŠ è½½è¡¨çš„å­—æ®µï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªSQLè„šæœ¬ï¼Œä»¥æ£€æŸ¥æ˜¯å¦ç¼ºå°‘è¿™äº›å­—æ®µã€‚ è¿™ç§æ–¹æ³•çš„çµæ´»æ€§ä½¿æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç”±ä¸€ä¸ªæˆ–å‡ ä¸ªå­—æ®µç»„æˆçš„PKï¼Œè¿™éå¸¸æ–¹ä¾¿ã€‚ è¿™ç§å¯¹å¸æ‰©å±•åˆ°STG ADSå±‚ã€‚ <br><br><pre><code class="python hljs">unique_check  <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime log_tmstmp = datetime.now().strftime(<span class="hljs-string"><span class="hljs-string">"%Y-%m-%d %H:%M:%S"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(args, context)</span></span></span><span class="hljs-function">:</span></span> tab = args[<span class="hljs-number"><span class="hljs-number">0</span></span>] data = [] fld_str = <span class="hljs-string"><span class="hljs-string">""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: sql = <span class="hljs-string"><span class="hljs-string">"""SELECT 't_'||lower(table_id) as tn, lower(column_name) as cn FROM src_column@meta_data WHERE  table_id = '%s' and is_primary_key = 'Y'"""</span></span> % (tab,) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> fld <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> context[<span class="hljs-string"><span class="hljs-string">'ora_get_data'</span></span>](context[<span class="hljs-string"><span class="hljs-string">'ora_con'</span></span>], sql): fld_str = fld_str + (fld_str <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-string"><span class="hljs-string">","</span></span>) + fld[<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> fld_str: config = context[<span class="hljs-string"><span class="hljs-string">'script_config'</span></span>] con_gp = context[<span class="hljs-string"><span class="hljs-string">'pg_open_con'</span></span>](config[<span class="hljs-string"><span class="hljs-string">'user'</span></span>], config[<span class="hljs-string"><span class="hljs-string">'pwd'</span></span>], config[<span class="hljs-string"><span class="hljs-string">'host'</span></span>], config[<span class="hljs-string"><span class="hljs-string">'port'</span></span>], config[<span class="hljs-string"><span class="hljs-string">'dbname'</span></span>]) sql = <span class="hljs-string"><span class="hljs-string">"""select %s as pkg_id, 't_%s' as table_name, 'PK fields' as column_name, coalesce(sum(cnt), 0) as NOT_UNIQUE_PK, to_char(current_timestamp, 'YYYY-MM-DD HH24:MI:SS') as sys_creation from (select 1 as cnt from edw_%s.t_%s where %s group by %s  having count(*) &gt; 1 ) sq; """</span></span> % (context[<span class="hljs-string"><span class="hljs-string">"package"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">'0'</span></span>,tab.lower(), args[<span class="hljs-number"><span class="hljs-number">1</span></span>], tab.lower(), (context[<span class="hljs-string"><span class="hljs-string">"package"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-string"><span class="hljs-string">"package_id = "</span></span> + context[<span class="hljs-string"><span class="hljs-string">"package"</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">"1=1"</span></span>), fld_str ) data.extend(context[<span class="hljs-string"><span class="hljs-string">'pg_get_data'</span></span>](con_gp, sql)) con_gp.close() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> [[(context[<span class="hljs-string"><span class="hljs-string">"package"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>),<span class="hljs-string"><span class="hljs-string">'t_'</span></span>+tab.lower(), <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, log_tmstmp]] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">'__main__'</span></span>: sys.exit(do_check([sys.argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], sys.argv[<span class="hljs-number"><span class="hljs-number">2</span></span>]], {}))</code> </pre> <br>  <i>å”¯ä¸€æ€§å¯¹å¸pythonä»£ç ç¤ºä¾‹ã€‚</i>  <i>è°ƒç”¨ï¼Œè¿æ¥å‚æ•°çš„ä¼ è¾“ä»¥åŠå°†ç»“æœæ”¾å…¥ç»“æœè¡¨ä¸­éƒ½æ˜¯ç”±Pythonä¸­çš„æ§åˆ¶æ¨¡å—æ‰§è¡Œçš„ã€‚</i> <br><br> ç¼ºå°‘NULLå€¼çš„å¯¹å¸ä¸ä¸Šä¸€ä¸ªç±»ä¼¼ï¼Œåœ¨Pythonä¸­ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ æˆ‘ä»¬ä»ä¸èƒ½åŒ…å«ç©ºï¼ˆNULLï¼‰å€¼çš„åŠ è½½å…ƒæ•°æ®å­—æ®µä¸­è¯»å–å†…å®¹ï¼Œå¹¶æ£€æŸ¥å…¶å¡«å……æ€§ã€‚ åœ¨DDSå±‚ä¹‹å‰ä½¿ç”¨å¯¹å¸ï¼ˆç¬¬ä¸€ä¸ªå›¾ä¸­çš„6ï¼‰ã€‚ <br><br> åœ¨å­˜å‚¨çš„å…¥å£å¤„ï¼Œè¿˜å¯¹åˆ°è¾¾è¾“å…¥çš„æ•°æ®åŒ…è¿›è¡Œè¶‹åŠ¿åˆ†æã€‚ æ–°åŒ…åˆ°è¾¾æ—¶æ¥æ”¶çš„æ•°æ®é‡å°†è¾“å…¥åˆ°å†å²è¡¨ä¸­ã€‚ éšç€æ•°æ®é‡çš„é‡å¤§å˜åŒ–ï¼Œè´Ÿè´£è¡¨å’ŒSIï¼ˆæºç³»ç»Ÿï¼‰çš„äººå‘˜ä¼šé€šè¿‡é‚®ä»¶ï¼ˆæŒ‰è®¡åˆ’ï¼‰æ”¶åˆ°é€šçŸ¥ï¼Œåœ¨æ•°æ®åŒ…è¿›å…¥ä»“åº“ä¹‹å‰å‘ç°APEXä¸­çš„é”™è¯¯ï¼Œå¹¶é€šè¿‡SIæ‰¾å‡ºåŸå› ã€‚ <br><br> åœ¨STGï¼ˆSTAGEï¼‰_ODSå’ŒODSï¼ˆæ“ä½œæ•°æ®å±‚ï¼‰ï¼ˆå›¾ä¸­çš„3å’Œ4ï¼‰ä¹‹é—´ï¼Œå‡ºç°æŠ€æœ¯åˆ é™¤å­—æ®µï¼ˆåˆ é™¤æŒ‡ç¤ºç¬¦= Deleted_indï¼‰ï¼Œæˆ‘ä»¬è¿˜é€šè¿‡SQLæŸ¥è¯¢æ£€æŸ¥å…¶æ­£ç¡®æ€§ã€‚ ç¼ºå°‘çš„è¾“å…¥åº”åœ¨ODSä¸­æ ‡è®°ä¸ºå·²åˆ é™¤ã€‚ <br><br> é¢„è®¡å¯¹å¸è„šæœ¬çš„ç»“æœå°†æ˜¾ç¤ºé›¶é”™è¯¯ã€‚ åœ¨ç»™å‡ºçš„å¯¹å¸ç¤ºä¾‹ä¸­ï¼Œå‚æ•°ã€œï¼ƒPKG_IDï¼ƒã€œé€šè¿‡Pythonæ§åˆ¶å—ä¼ é€’ï¼Œç±»å‹ã€œP_JOIN_CONDITIONã€œå’Œã€œPERIOD_COLã€œçš„å‚æ•°ä»è¡¨å…ƒæ•°æ®ï¼Œè¡¨åç§°æœ¬èº«ã€œTABLEã€œä»å¯åŠ¨å‚æ•°å¡«å……ã€‚ <br><br> ä»¥ä¸‹æ˜¯å‚æ•°åŒ–å¯¹å¸ã€‚  HDIMç±»å‹çš„STG_ODSå’ŒODSä¹‹é—´çš„ç¤ºä¾‹SQLåè°ƒä»£ç ï¼š <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> package_id <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> pkg_id, <span class="hljs-string"><span class="hljs-string">'T_~TABLE~'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> table_name, to_char(<span class="hljs-keyword"><span class="hljs-keyword">current_timestamp</span></span>, <span class="hljs-string"><span class="hljs-string">'YYYY-MM-DD HH24:MI:SS'</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(empty_in_ods, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> empty_in_ods, <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(not_equal_md5, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> not_equal_md5, <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(deleted_in_ods, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> deleted_in_ods, <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(not_deleted_in_ods, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> not_deleted_in_ods, max_load_dttm <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>    <span class="hljs-keyword"><span class="hljs-keyword">max</span></span> (src.package_id) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> package_id,    <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> tgt.md5 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> empty_in_ods,    <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> src.md5&lt;&gt;tgt.md5 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tgt.~PK~ <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tgt.deleted_ind = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> not_equal_md5,    <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> tgt.deleted_ind = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> src.md5=tgt.md5 <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> deleted_in_ods <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> EDW_STG_ODS.T_~<span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>~  src <span class="hljs-keyword"><span class="hljs-keyword">left</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span> EDW_ODS.T_~<span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span>~  tgt       <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> ~P_JOIN_CONDITION~ <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> tgt.active_ind =<span class="hljs-string"><span class="hljs-string">'Y'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> ~<span class="hljs-comment"><span class="hljs-comment">#PKG_ID#~ = 0   or src.package_id = ~#PKG_ID#~ ) aa, (select sum (case when src.~PK~ is null then 1 else 0 end) as not_deleted_in_ods, max (tgt.load_dttm) as max_load_dttm from EDW_STG_ODS.T_~TABLE~  src right join EDW_ODS.T_~TABLE~  tgt        on ~P_JOIN_CONDITION~ where tgt.deleted_ind = 0 and tgt.active_ind ='Y'  and tgt.~PERIOD_COL~ between (select min(~PERIOD_COL~) from EDW_STG_ODS.T_~TABLE~ where ~#PKG_ID#~ = 0 or package_id = ~#PKG_ID#~)                           and (select max(~PERIOD_COL~) from EDW_STG_ODS.T_~TABLE~ where ~#PKG_ID#~ = 0 or package_id = ~#PKG_ID#~) ) bb where 1=1</span></span></code> </pre> <br> ç”¨äºHDIMç±»å‹çš„STG_ODSå’ŒODSä¹‹é—´çš„SQLåè°ƒä»£ç ç¤ºä¾‹ï¼Œå…¶å‚æ•°æ›¿æ¢ä¸ºï¼š <br><br><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">--------------HDIM_CHECKS--------------- select package_id as pkg_id, 'TABLE_NAME' as table_name, to_char(current_timestamp, 'YYYY-MM-DD HH24:MI:SS'), coalesce(empty_in_ods, 0) as empty_in_ods, coalesce(not_equal_md5, 0) as not_equal_md5, coalesce(deleted_in_ods, 0) as deleted_in_ods, coalesce(not_deleted_in_ods, 0) as not_deleted_in_ods, max_load_dttm from (select    max (src.package_id) as package_id,    sum (case when tgt.md5 is null then 1 else 0 end) as empty_in_ods,    sum (case when src.md5&lt;&gt;tgt.md5 and tgt.ACTION_ID is not null and tgt.deleted_ind = 0 then 1 else 0 end) as not_equal_md5,    sum (case when tgt.deleted_ind = 1 and src.md5=tgt.md5 then 1 else 0 end) as deleted_in_ods from EDW_STG_ODS.TABLE_NAME  src left join EDW_ODS.TABLE_NAME  tgt       on SRC.PK_ID=TGT.PK_ID and tgt.active_ind ='Y' where 709083887 = 0   or src.package_id = 709083887 ) aa, (select sum (case when src.PK_ID is null then 1 else 0 end) as not_deleted_in_ods, max (tgt.load_dttm) as max_load_dttm from EDW_STG_ODS.TABLE_NAME  src right join EDW_ODS.TABLE_NAME  tgt        on SRC.PK_ID =TGT.PK_ID where tgt.del_ind = 0 and tgt.active_ind ='Y'  and tgt.DATE_SYS between (select min(DATE_SYS) from EDW_STG_ODS.TABLE_NAME where 70908 = 0 or package_id = 70908)                           and (select max(DATE_SYS) from EDW_STG_ODS.TABLE_NAME where 70908 = 0 or package_id = 70908) ) bb where 1=1</span></span></code> </pre> <br> ä»ODSå¼€å§‹ï¼Œå†å²è®°å½•ä¿å­˜åœ¨ç›®å½•ä¸­ï¼Œå› æ­¤ï¼Œå¿…é¡»æ£€æŸ¥å†å²è®°å½•æ˜¯å¦å­˜åœ¨äº¤å‰ç‚¹å’Œé—´éš™ã€‚ è¿™æ˜¯é€šè¿‡è®¡ç®—å†å²è®°å½•ä¸­é”™è¯¯å€¼çš„æ•°é‡å¹¶å°†é”™è¯¯çš„ç»“æœæ•°é‡å†™å…¥ç»“æœè¡¨æ¥å®Œæˆçš„ã€‚ å¦‚æœè¡¨ä¸­æœ‰å†å²è®°å½•é”™è¯¯ï¼Œåˆ™å¿…é¡»æ‰‹åŠ¨æœç´¢å®ƒä»¬ã€‚ æ ¸å¯¹å–å†³äºä¸‹è½½çš„ç±»å‹-é¦–å…ˆæ˜¯HDIMï¼ˆå†å²å‚è€ƒæŒ‡å—ï¼‰ã€‚ æˆ‘ä»¬å¯¹ç›´åˆ°ADSå±‚çš„ç›®å½•çš„å†å²æ­£ç¡®æ€§è¿›è¡Œæ ¸å¯¹ã€‚ <br><br> åœ¨DDSå±‚ï¼ˆç¬¬ä¸€ä¸ªå›¾ä¸­çš„6ï¼‰ä¸Šï¼Œå°†ä¸åŒçš„SIï¼ˆæºç³»ç»Ÿï¼‰ç»„åˆåˆ°ä¸€ä¸ªè¡¨ä¸­ï¼›å‡ºç°äº†HUBè¡¨ï¼Œç”¨äºç”Ÿæˆç”¨äºé“¾æ¥æ¥è‡ªä¸åŒæºç³»ç»Ÿçš„æ•°æ®çš„ä»£ç†é”®ã€‚ æˆ‘ä»¬é€šè¿‡ç±»ä¼¼äºstage-layerçš„python-checkæ£€æŸ¥å®ƒä»¬çš„å”¯ä¸€æ€§ã€‚ <br><br> åœ¨DDSå±‚ä¸Šï¼Œæ‚¨éœ€è¦æ£€æŸ¥ä¸HUBè¡¨ç»„åˆåï¼Œé”®å­—æ®µä¸­æ˜¯å¦æ²¡æœ‰å‡ºç°ç±»å‹0ï¼Œ-1ï¼Œ-2çš„å€¼ï¼Œè¿™æ„å‘³ç€è¡¨è¿æ¥ä¸æ­£ç¡®ï¼Œæ•°æ®ä¸è¶³ã€‚ å®ƒä»¬å¯èƒ½åœ¨HUBè¡¨ä¸­ç¼ºå°‘å¿…è¦æ•°æ®çš„æƒ…å†µä¸‹å‡ºç°ã€‚ è¿™æ˜¯æ‰‹åŠ¨è§£æçš„é”™è¯¯ã€‚ <br><br>  ADSçª—å£å±‚ï¼ˆç¬¬ä¸€ä¸ªå›¾ä¸­çš„8ï¼‰æ•°æ®çš„æœ€å¤æ‚è°ƒèŠ‚ã€‚ ä¸ºäº†å®Œå…¨æ”¾å¿ƒæ‰€è·å¾—çš„ç»“æœçš„æ”¶æ•›æ€§ï¼Œæ­¤å¤„éƒ¨ç½²äº†ä½¿ç”¨æºç³»ç»Ÿè¿›è¡Œè´¹ç”¨æ±‡æ€»çš„éªŒè¯ã€‚ ä¸€æ–¹é¢ï¼Œæœ‰ä¸€ç±»æŒ‡æ ‡åŒ…æ‹¬åº”è®¡æ€»é¢ã€‚ æˆ‘ä»¬ä»WCDçš„çª—æˆ·æ”¶é›†å®ƒä»¬ä¸€ä¸ªæœˆã€‚ å¦ä¸€æ–¹é¢ï¼Œæˆ‘ä»¬ä»æºç³»ç»Ÿä¸­æ”¶å–ç›¸åŒè´¹ç”¨çš„æ±‡æ€»ã€‚ å…è®¸åå·®ä¸è¶…è¿‡1ï¼…æˆ–æŸä¸ªå•†å®šçš„ç»å¯¹å€¼ã€‚ é€šè¿‡å¯¹å¸è·å¾—çš„ç»“æœé›†è¢«æ”¾å…¥æ¥æ”¶Oracleè¡¨çš„ç‰¹æ®Šåˆ›å»ºçš„æ•°æ®é›†ä¸­ã€‚ æ•°æ®æ¯”è¾ƒæ˜¯åœ¨Oracleè§†å›¾ä¸­å®Œæˆçš„ã€‚  APEXä¸­ç»“æœçš„å¯è§†åŒ–ã€‚ æ•´å¥—æ•°æ®ï¼ˆç»“æœé›†ï¼‰çš„å­˜åœ¨ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨å­˜åœ¨é”™è¯¯çš„æƒ…å†µä¸‹æ›´æ·±å…¥åœ°åˆ†æç»“æœçš„è¯¦ç»†æ•°æ®ï¼Œæ‰¾åˆ°å‘ç”Ÿå·®å¼‚çš„ç‰¹å®šæ–‡ç« ï¼Œå¹¶æ‰¾å‡ºå…¶åŸå› ã€‚ <br><br><img src="https://habrastorage.org/getpro/habr/post_images/097/e40/ec3/097e40ec3c68bb49522d89aa228dbd5e.jpg"><br>  <i>åœ¨APEXä¸­å‘ç”¨æˆ·æ˜¾ç¤ºå¯¹å¸ç»“æœ</i> <br><br> ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»è·å¾—äº†ä¸€ä¸ªå¯è¡Œä¸”æ´»è·ƒä½¿ç”¨çš„åº”ç”¨ç¨‹åºï¼Œç”¨äºå¯¹å¸æ•°æ®ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬æœ‰è®¡åˆ’è¿›ä¸€æ­¥å¼€å‘å¯¹å¸çš„æ•°é‡å’Œè´¨é‡ï¼Œä»¥åŠå¹³å°æœ¬èº«çš„å¼€å‘ã€‚ è‡ªå·±çš„å¼€å‘ä½¿æˆ‘ä»¬èƒ½å¤Ÿè¶³å¤Ÿå¿«åœ°æ›´æ”¹å’Œä¿®æ”¹åŠŸèƒ½ã€‚ <br><br>  <i>æœ¬æ–‡ç”±Rostelecomæ•°æ®ç®¡ç†å›¢é˜Ÿç¼–å†™</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN434542/">https://habr.com/ru/post/zh-CN434542/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN434530/index.html">é»˜è®¤æ—¥å†ï¼ŒLDAPä¸­çš„ä¿®å¤ç¨‹åºä»¥åŠZimbra 8.8.11ä¸­çš„å…¶ä»–åˆ›æ–°</a></li>
<li><a href="../zh-CN434532/index.html">ä¸€ä¸ªé¡¹ç›®çš„æ•…äº‹ï¼šå½“å›¢é˜Ÿæ²¡æœ‰é«˜çº§å¼€å‘äººå‘˜æ—¶</a></li>
<li><a href="../zh-CN434534/index.html">ONYX BOOXâ€œæˆ‘çš„ç¬¬ä¸€æœ¬ä¹¦â€ï¼šå¯¹æ¯å©´æ— å®³é˜…è¯»</a></li>
<li><a href="../zh-CN434538/index.html">å¤ªç©ºä¹‹æˆ˜ï¼šå«æ˜Ÿäº’è”ç½‘å¸‚åœºæ­£åœ¨å‘ç”Ÿä»€ä¹ˆ</a></li>
<li><a href="../zh-CN434540/index.html">ä¸å°†è¢«æœºå™¨äººå–ä»£çš„äººæ€ä¹ˆåŠï¼Ÿ</a></li>
<li><a href="../zh-CN434544/index.html">â€œæˆ‘ä»¬ä¸è¦æˆ˜äº‰â€-Adblock Plusæ€»ç›‘æœ¬Â·å¨å»‰å§†æ–¯ä¸“è®¿</a></li>
<li><a href="../zh-CN434548/index.html">æ´¥å·´å¸ƒéŸ¦çˆ±å›½è€…é˜ŸèŠ±è´¹5,000ç¾å…ƒåœ¨Google Street Viewä¸Šæ•°å­—åŒ–ç¥–å›½</a></li>
<li><a href="../zh-CN434550/index.html">å¤å¤æ¸¸æˆçš„å†…å¹•ï¼šä¸ºNESæ‰“å­”</a></li>
<li><a href="../zh-CN434552/index.html">GDG SPbã€‚ æˆ‘ä»¬ä¸€å¹´æ¥åšçš„äº‹</a></li>
<li><a href="../zh-CN434558/index.html">è¥¿ä¼¯åˆ©äºšæ”¯æŒç¤¾åŒºï¼šå¼€å§‹</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>