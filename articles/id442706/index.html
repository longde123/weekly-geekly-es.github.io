<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>㊙️ 🕝 🕑 MySQL - Menggunakan variabel dalam kueri 🕓 🍚 ⌛️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cukup sering mereka bertanya apakah ada fungsi analitis (jendela) di MySQL. Catatan Pada saat penulisan, tidak ada analog seperti itu, tetapi artikel ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MySQL - Menggunakan variabel dalam kueri</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442706/">  Cukup sering mereka bertanya apakah ada fungsi analitis (jendela) di MySQL.  <b>Catatan</b>  <i>Pada saat penulisan, tidak ada analog seperti itu, tetapi artikel tersebut masih menarik secara akademis dalam hal penguraian pendekatan asli untuk menggunakan variabel untuk MySQL.</i> <br><br>  Untuk mengganti fungsi analitik, kueri yang terhubung sendiri, subkueri kompleks, dan banyak lagi sering digunakan.  Sebagian besar solusi ini tidak efektif dalam hal kinerja. <br><br>  Juga di MySQL tidak ada rekursi.  Namun, beberapa tugas yang biasanya diselesaikan dengan fungsi analitik atau rekursi dapat ditangani oleh alat MySQL. <br><br>  Salah satu alat ini adalah unik, tidak khas untuk mekanisme DBMS lain yang bekerja dengan variabel di dalam kueri SQL.  Kami dapat mendeklarasikan variabel di dalam kueri, mengubah nilainya dan menggantinya dalam SELECT untuk output.  Selain itu, urutan pemrosesan baris dalam permintaan dan, sebagai hasilnya, urutan pemberian nilai ke variabel dapat diatur dalam penyortiran khusus! <br><br>  Peringatan  Artikel ini mengasumsikan bahwa pemrosesan ekspresi dalam klausa SELECT dilakukan dari kiri ke kanan, namun, tidak ada konfirmasi resmi dari urutan pemrosesan ini dalam dokumentasi MySQL.  Ini harus diingat ketika mengubah versi server.  Untuk memastikan konsistensi, Anda dapat menggunakan pernyataan KASUS dummy atau IF. <br><br><h2>  Rekursi Analog </h2><br>  Pertimbangkan contoh sederhana yang menghasilkan urutan Fibonacci (dalam urutan Fibonacci, setiap istilah sama dengan jumlah dari dua sebelumnya, dan 2 pertama sama dengan satu): <br><a name="habracut"></a><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(X=<span class="hljs-number"><span class="hljs-number">1</span></span>, Fn_1, Fn_2) F <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I := @I + @J Fn_1, @J := @I + @J Fn_2 <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> dummy <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>)a, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> dummy <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>)b, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I := <span class="hljs-number"><span class="hljs-number">1</span></span>, @J := <span class="hljs-number"><span class="hljs-number">1</span></span>)IJ )T, <span class="hljs-comment"><span class="hljs-comment">/* ,     1 */</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> X <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>)X;</code> </pre> <br>  Kueri ini menghasilkan 18 angka Fibonacci, tidak termasuk dua angka pertama: <br><br><pre> <code class="plaintext hljs">2,3,5,8,13,21,34,55,89,144,233,377,610,987,1597,2584,4181,6765</code> </pre> <br>  Sekarang mari kita lihat cara kerjanya. <br><br>  Dalam baris 5) 6) 9 catatan dihasilkan.  Tidak ada yang aneh di sini. <br><br>  Pada baris 7) kita mendeklarasikan dua variabel @I, @J dan menetapkannya 1. <br><br>  Pada baris 3), berikut ini terjadi: pertama, variabel @ saya diberi jumlah dari dua variabel.  Kemudian kita menetapkan hal yang sama ke variabel @J, dengan mempertimbangkan fakta bahwa nilai @I sudah berubah. <br><br>  Dengan kata lain, perhitungan dalam SELECT dilakukan dari kiri ke kanan - lihat juga komentar di awal artikel. <br><br>  Selain itu, perubahan variabel dilakukan di masing-masing dari 9 catatan kami, yaitu  saat memproses setiap baris baru, variabel @I dan @J akan berisi nilai yang dihitung dengan memproses baris sebelumnya. <br><br>  Untuk mengatasi masalah yang sama dengan bantuan DBMS lainnya, kita harus menulis <u>kueri rekursif!</u> <br><br>  <b>Catatan:</b> <br>  <i>Variabel harus dideklarasikan dalam subquery yang terpisah (baris 7), jika kita mendeklarasikan variabel dalam klausa SELECT, kemungkinan besar akan dievaluasi hanya 1 kali (walaupun perilaku spesifik akan tergantung pada versi server).</i>  <i>Jenis variabel ditentukan oleh nilai yang diinisialisasi.</i>  <i>Jenis ini dapat berubah secara dinamis.</i>  <i>Jika Anda mengatur variabel ke NULL, tipenya adalah BLOB.</i> <br><br>  Urutan di mana baris diproses dalam SELECT, seperti yang disebutkan di atas, tergantung pada penyortiran khusus.  Contoh sederhana penomoran baris dalam urutan tertentu: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> val, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Num</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> val <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>)a, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I := <span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> val;</code> </pre><br><pre> <code class="plaintext hljs">Val Num 10 1 20 2 30 3 50 4</code> </pre> <br><h2>  Analog dari fungsi analitik </h2><br>  Variabel juga dapat digunakan untuk menggantikan fungsi analitik.  Berikut ini adalah beberapa contoh.  Untuk kesederhanaan, kami menganggap bahwa semua bidang BUKAN NULL, dan pengurutan serta pemartisian (PARTITION BY) terjadi pada satu bidang.  Menggunakan nilai NULL dan pengurutan yang lebih kompleks akan membuat contoh lebih rumit, tetapi esensi tidak akan berubah. <br><br>  Sebagai contoh, buat tabel TestTable: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> TestTable( <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, order_id <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> );</code> </pre><br>  dimana <br>  group_id - pengidentifikasi grup (analog dari jendela fungsi analitik); <br>  order_id - bidang unik untuk pengurutan; <br>  nilai adalah beberapa nilai numerik. <br><br>  Isi tabel kami dengan data uji: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> TestTable(order_id, <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> order_id, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span> )T;</code> </pre> <br>  Contoh penggantian beberapa fungsi analitik. <br><br><h3>  1) ROW_NUMBER () LEBIH DARI (ORDER BY order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id;</code> </pre> <br> <code>group_id order_id value RowNum <br> 1 1 1 1 <br> 1 2 2 2 <br> 1 3 2 3 <br> 2 4 1 4 <br> 2 5 2 5 <br> 2 6 3 6 <br> 3 7 1 7 <br> 3 8 2 8 <br> 4 9 1 9 <br> 3 11 2 10 <br></code> <br><h3>  2) ROW_NUMBER () LEBIH (PARTITION BY group_id ORDER BY order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span>, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value RowNum <br> 1 1 1 1 <br> 1 2 2 2 <br> 1 3 2 3 <br> 2 4 1 1 <br> 2 5 2 2 <br> 2 6 3 3 <br> 3 7 1 1 <br> 3 8 2 2 <br> 3 11 2 3 <br> 4 9 1 1 <br></code> <br><h3>  3) SUM (nilai) LEBIH DARI (PARTISI DENGAN OLEH group_id ORDER OLEH order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, RunningTotal <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @I:=@I+<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, @I:=<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) RunningTotal, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value RunningTotal <br> 1 1 1 1 <br> 1 2 2 3 <br> 1 3 2 5 <br> 2 4 1 1 <br> 2 5 2 3 <br> 2 6 3 6 <br> 3 7 1 1 <br> 3 8 2 3 <br> 3 11 2 5 <br> 4 9 1 1 <br></code> <br><h3>  4) LAG (nilai) LEBIH DARI (PARTISI DENGAN OLEH group_id ORDER OLEH order_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, LAG <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span>, <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) LAG, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span>:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value LAG <br> 1 1 1 NULL <br> 1 2 2 1 <br> 1 3 2 2 <br> 2 4 1 NULL <br> 2 5 2 1 <br> 2 6 3 2 <br> 3 7 1 NULL <br> 3 8 2 1 <br> 3 11 2 2 <br> 4 9 1 NULL <br></code> <br>  Untuk LEAD, semuanya sama, hanya Anda perlu mengubah pengurutan ke ORDER BY group_id, order_id DESC <br><br>  Untuk fungsi COUNT, MIN, MAX, semuanya agak lebih rumit, karena sampai kita menganalisis semua baris dalam grup (jendela), kita tidak akan dapat mengetahui nilai fungsi.  MS SQL, misalnya, "gulungan" jendela untuk keperluan ini (sementara menempatkan baris jendela dalam tabel buffer tersembunyi untuk mengaksesnya lagi), di MySQL tidak ada kemungkinan seperti itu.  Tetapi kita dapat menghitung nilai fungsi pada setiap jendela pada baris terakhir untuk penyortiran yang diberikan (mis., Setelah menganalisis seluruh jendela), lalu, menyortir baris di jendela dalam urutan terbalik, meletakkan nilai yang dihitung di seluruh jendela. <br><br>  Jadi kita perlu dua penyortiran.  Sehingga pengurutan akhir tetap sama seperti pada contoh di atas, kita pertama-tama mengurutkan berdasarkan field group_id ASC, order_id DESC, kemudian oleh field group_id ASC, order_id ASC. <br><br><h3>  5) COUNT (*) LEBIH DARI (PARTISI DENGAN OLEH group_id) </h3><br>  Pada urutan pertama, kami cukup memberi nomor pada entri.  Dalam yang kedua, kami menetapkan jumlah maksimum untuk semua baris jendela, yang akan sesuai dengan jumlah baris di jendela. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, Cnt <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @MaxRowNum, @MaxRowNum := RowNumDesc) Cnt, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @I:=@I+<span class="hljs-number"><span class="hljs-number">1</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">1</span></span>) RowNumDesc, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @I:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> )T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @MaxRowNum:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id <span class="hljs-comment"><span class="hljs-comment">/* */</span></span> )T;</code> </pre> <br> <code>group_id order_id value Cnt <br> 1 1 1 3 <br> 1 2 2 3 <br> 1 3 2 3 <br> 2 4 1 3 <br> 2 5 2 3 <br> 2 6 3 3 <br> 3 7 1 3 <br> 3 8 2 3 <br> 3 11 2 3 <br> 4 9 1 1 <br></code> <br>  Fungsi MAX dan MIN dihitung dengan analogi.  Saya hanya akan memberikan contoh untuk MAX: <br><br><h3>  6) MAX (nilai) LEBIH DARI (PARTISI DENGAN OLEH group_id) </h3><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, MaxVal <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @MaxVal, @MaxVal := MaxVal) MaxVal, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">GREATEST</span></span>(@MaxVal, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>), @MaxVal:=<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>) MaxVal, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @MaxVal:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> )T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @MaxVal:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value MaxVal <br> 1 1 1 2 <br> 1 2 2 2 <br> 1 3 2 2 <br> 2 4 1 3 <br> 2 5 2 3 <br> 2 6 3 3 <br> 3 7 1 2 <br> 3 8 2 2 <br> 3 11 2 2 <br> 4 9 1 1 <br></code> <br><h3>  7) COUNT (nilai DISTINCT) OVER (PARTITION BY group_id) </h3><br>  Suatu hal yang menarik yang tidak tersedia di MS SQL Server, tetapi dapat dihitung dengan subquery dengan mengambil MAX dari RANK.  Kami akan melakukan hal yang sama di sini.  Pada sort pertama, kami menghitung RANK () OVER (PARTITION BY group_id ORDER BY value DESC), lalu pada sort kedua kami menempatkan nilai maksimum untuk semua baris di setiap jendela: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, Cnt <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>) Cnt, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> T.*, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@last_group_id = <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=@<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>) , @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>, @last_group_id := <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span> := <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">last_value</span></span>:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>, order_id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> )T,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @last_group_id:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, @<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>:=<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>)I <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, order_id )T;</code> </pre> <br> <code>group_id order_id value Cnt <br> 1 1 1 2 <br> 1 2 2 2 <br> 1 3 2 2 <br> 2 4 1 3 <br> 2 5 2 3 <br> 2 6 3 3 <br> 3 7 1 2 <br> 3 8 2 2 <br> 3 11 2 2 <br> 4 9 1 1 <br></code> <br><h2>  Performa </h2><br>  Untuk mulai dengan, kami membandingkan kinerja penomoran baris dalam kueri menggunakan gabungan-sendiri dan variabel. <br><br><h4>  1) Cara klasik dengan self-connect </h4><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*)N, T1.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T1 <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> TestTable T2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> T1.order_id &gt;= T2.order_id <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> T1.order_id;</code> </pre> <br>  Apa yang dihasilkan oleh 10.000 rekaman dalam tabel yang TestTable: <br><br>  Durasi / Ambil <br>  16,084 dtk / 0,016 dtk <br><br><h4>  2) Menggunakan variabel: </h4><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @N:=@N+<span class="hljs-number"><span class="hljs-number">1</span></span> N, T1.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable T1, (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> @N := <span class="hljs-number"><span class="hljs-number">0</span></span>)M <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> T1.order_id;</code> </pre> <br>  Ini menghasilkan: <br><br>  Durasi / Ambil <br>  0,016 dtk / 0,015 dtk <br><br>  Hasilnya berbicara sendiri.  Namun, harus dipahami bahwa nilai yang dihitung menggunakan variabel tidak secara optimal digunakan dalam kondisi penyaringan.  Penyortiran dan perhitungan akan terjadi untuk SEMUA baris, walaupun pada kenyataannya kita hanya membutuhkan sebagian kecil saja. <br><br>  Mari kita pertimbangkan secara lebih rinci dengan contoh tugas seperti itu: <br><br>  <b>Cetak 2 baris pertama dari tabel TestTable untuk setiap nilai group_id, diurutkan berdasarkan order_id.</b> <br><br>  Inilah cara tugas ini akan diselesaikan dalam DBMS dengan dukungan untuk fungsi analitis: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>, order_id, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *, ROW_NUMBER()<span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id) <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable )T <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RowNum</span></span> &lt;= <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br>  Namun, pengoptimal MySQL tidak tahu apa-apa tentang aturan yang digunakan untuk menghitung bidang RowNum.  Dia harus memberi nomor SEMUA baris, dan hanya kemudian pilih yang diperlukan. <br><br>  Sekarang bayangkan kita memiliki 1 juta catatan dan 20 nilai group_id unik.  Yaitu  untuk memilih 40 baris, MySQL akan menghitung nilai RowNum untuk satu juta baris!  Tidak ada solusi bagus untuk masalah ini dengan satu permintaan di MySQL.  Tapi Anda bisa mendapatkan daftar nilai group_id yang unik, misalnya, seperti ini: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable;</code> </pre> <br>  Kemudian, menggunakan bahasa pemrograman lain apa pun, buat kueri formulir: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL … <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> TestTable <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">group_id</span></span>=<span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> order_id <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre> <br>  20 kueri mudah akan bekerja lebih cepat daripada menghitung RowNum untuk sejuta baris. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id442706/">https://habr.com/ru/post/id442706/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id442696/index.html">S for Security: Internet Security of Things dan laporan di InoThings ++ 2019</a></li>
<li><a href="../id442698/index.html">Aplikasi metro Moskow untuk Windows Store</a></li>
<li><a href="../id442700/index.html">Apakah layak untuk berurusan dengan pembangkit listrik tenaga surya seluler?</a></li>
<li><a href="../id442702/index.html">Tentang magistrasi Tinkoff.ru di MIPT</a></li>
<li><a href="../id442704/index.html">Desain, siklus pengembangan, dan pengujian</a></li>
<li><a href="../id442708/index.html">Apa yang menentukan Penghasilan Penambang?</a></li>
<li><a href="../id442710/index.html">Tinjau Google IoT Platform</a></li>
<li><a href="../id442714/index.html">Suka cacat</a></li>
<li><a href="../id442716/index.html">Alas kaki</a></li>
<li><a href="../id442718/index.html">Karyawan Google menemukan bahwa pekerjaan pada versi mesin pencari untuk China berlanjut</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>