<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüíª üë®üèø‚Äçüè≠ üõÅ Environnements Android üîΩ üï¥üèΩ ü•¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©face 


 De loin en 2012, dans les grands espaces de Habr, je me souviens du commentaire: 
 ... s'il n'y a pas de cas depuis le tout d√©but, alors l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Environnements Android</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462751/"><h3 id="predislovie">  Pr√©face </h3><br><p>  De loin en 2012, dans les grands espaces de Habr, je me souviens du commentaire: </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">... s'il n'y a pas de cas depuis le tout d√©but, alors l'appareil restera</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><br></a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">inachev√©, tombera de la poussi√®re sur une √©tag√®re ...</a> </blockquote><p>  Le sujet est loin d'√™tre un composant mat√©riel.  Analysant mon probl√®me, je suis devenu convaincu de l'exactitude de ce jugement et j'ai essay√© de mettre les choses en ordre sur mon √©tag√®re poussi√©reuse. </p><br><p>  R√©cemment, j'ai √©t√© approch√© par un client qui m'a demand√© d'ajouter un support pour plusieurs services √† son projet.  La t√¢che √©tait que je devais connecter le service ¬´A¬ª et, avant de mettre l'application en production, ex√©cuter ce service sur un environnement de test.  J'ai d√©cid√© d'analyser mes d√©cisions pr√©c√©dentes et ... j'ai √©t√© horrifi√©. </p><br><p>  Pour diff√©rents types d'assemblages, j'ai utilis√© divers fichiers de configuration avec la description des variables d'environnement.  Mais le probl√®me √©tait que juste pour transmettre la valeur dans le vrai code, il √©tait n√©cessaire d'√©crire le m√™me code pour chaque type. </p><a name="habracut"></a><br><h3 id="problema">  Le probl√®me </h3><br><p> Google nous donne la possibilit√© de transmettre des valeurs personnalis√©es pour chaque <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">assemblage</a> . </p><br><pre><code class="plaintext hljs">android { //... buildTypes { release { buildConfigField("String", "HOST_URL", "\"prod.com\"") } debug { buildConfigField("String", "HOST_URL", "\"debug.com\"") } } }</code> </pre> <br><p>  Apr√®s avoir analys√© le script <strong>build.gradle</strong> , les outils Android prendront toutes les valeurs de <strong>buildConfigFileds</strong> des <strong>buildTypes</strong> et <strong>productFlavors</strong> et g√©n√©reront des fichiers <strong>BuildConfig</strong> pour chaque type d'assemblage: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BuildConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... // Fields from build type: release public static final String HOST_URL = "prod.com"; }</span></span></code> </pre> <br><p>  Aucun probl√®me √† premi√®re vue.  Surtout quand il n'y a pas autant de saveurs et de valeurs personnalis√©es dans votre application.  Dans mon projet, il y avait&gt; 20 et 3 environnements (interne / alpha / production).  De toute √©vidence, il n'y avait qu'un seul probl√®me pour moi - se d√©barrasser du passe-partout. </p><br><p>  Un probl√®me tout aussi important est que les valeurs des variables d'environnement ne doivent pas √™tre refl√©t√©es dans votre projet.  M√™me dans le fichier de configuration.  Vous devez v√©rifier votre configuration <strong>build.gradle</strong> via VCS.  Mais vous ne devez pas enregistrer vos cl√©s directement, pour cela, vous avez besoin d'un m√©canisme tiers (par exemple, un fichier, les services de votre CI).  Dans ma pratique, il y avait plusieurs projets pour lesquels pour l'assemblage de production de versions, je n'avais pas acc√®s aux valeurs de certaines biblioth√®ques.  C'est d√©j√† un probl√®me commercial et dans son int√©r√™t de ne pas faire de co√ªts inutiles.  Vous ne devez pas utiliser de cl√©s destin√©es √† la production lors du d√©bogage ou des tests internes. </p><br><h3 id="sposob-resheniyaproblemy">  La fa√ßon de r√©soudre le probl√®me </h3><br><p>  Dans l'un des anciens projets, pour stocker les valeurs des variables d'environnement, nous avons utilis√© des fichiers <strong>.properties</strong> simples qui permettaient d'acc√©der aux champs via la cl√© classique: mappage de valeurs.  Cette approche ne r√©sout pas le probl√®me de liaison.  Mais cela r√©sout le probl√®me de la livraison des donn√©es, qui devrait √™tre appliqu√©.  De plus, nous pouvons prendre des fichiers <strong>.properties</strong> comme base pour un certain type de contrat de fourniture de donn√©es. </p><br><p>  Si nous remontons un peu, nous avons une √©tape interm√©diaire: de <strong>buildConfigField</strong> au champ de la classe <strong>BuildConfig</strong> .  Mais qui fait √ßa?  Tout est assez ringard, le plugin gradle que vous connectez absolument dans tous les projets Android en est responsable. </p><br><pre> <code class="plaintext hljs">apply plugin: "com.android.application"</code> </pre> <br><p>  C'est lui qui est responsable du fait qu'apr√®s avoir analys√© votre fichier <strong>build.gradle</strong> , la classe <strong>BuildConfig</strong> sera g√©n√©r√©e pour chaque saveur avec son propre ensemble de champs.  De cette fa√ßon, je peux √©crire mon propre m√©dicament qui √©tendra les capacit√©s de <strong>com.android.application</strong> et √©conomisera <br>  moi de ce mal de t√™te. </p><br><p>  La solution est la suivante: proposer un contrat, <br>  qui d√©crira toutes les cl√©s et valeurs de tous les assemblys. <br>  D√©veloppez les fichiers de configuration en sous-types.  Donnez tout au plugin. </p><br><img src="https://drive.google.com/uc?id=10GEI-k-zG2JLOWQ1pNkRqLur7g3yKAE3" alt="dessin" width="800"><br><h3 id="reshenie">  Solution </h3><br><p>  Ci-dessus, nous avons compris la structure de la solution, la seule chose qui reste √† faire est de tout donner vie.  Il semblerait qu'une solution triviale et un probl√®me peuvent √™tre r√©solus par une simple extension de fichier de construction.  Au d√©part, je l'ai fait. </p><br><div class="spoiler">  <b class="spoiler_title">R√©v√©ler la solution</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">```groovy class Constants { // Environments properties path pattern, store your config files in each folders of pattern static final CONFIG_PROPERTY_PATTERN = "config/%s/config.properties" } android.buildTypes.all { buildType -&gt; buildConfigFields(buildType, buildType.name) } android.applicationVariants.all { appVariant -&gt; buildConfigFields(appVariant, appVariant.flavorName) } private def buildConfigFields(Object variant, String variantName) { def properties = getProperties(variantName) properties.each { key, value -&gt; variant.buildConfigField( parseValueType(value), toConfigKey(key), value ) } } // Convert config property key to java constant style private def toConfigKey(String key) { return key.replaceAll("(\\.)|(-)", "_") .toUpperCase() } // Parse configuration value type private def parseValueType(String value) { if (value == null) { throw new NullPointerException("Missing configuration value") } if (value =~ "[0-9]*L" ) { return "Long" } if (value.isInteger()) { return "Integer" } if (value.isFloat()) { return "Float" } if ("true" == value.toLowerCase() || "false" == value.toLowerCase()) { return "Boolean" } return "String" } private def getProperties(String variantName) { def propertiesPath = String.format( Constants.CONFIG_PROPERTY_PATTERN, variantName ) def propertiesFile = rootProject.file(propertiesPath) def properties = new Properties() // Do nothing, when configuration file doesn't exists if (propertiesFile.exists()) { properties.load(new FileInputStream(propertiesFile)) } return properties } ```</code> </pre> </div></div><br><p>  Et l√† surgirent aussit√¥t ces difficult√©s auxquelles je n'avais pas pens√© - un r√©giment poussi√©reux. J'ai d√©cid√© de "vendre" ma d√©cision √† mes coll√®gues.  J'ai pr√©par√© un dock, lanc√© la discussion et ... J'ai r√©alis√© que nous sommes tous des gens et que les programmeurs sont des gens paresseux.  Personne ne veut int√©grer un morceau de code qui lui est inconnu dans le projet, faut-il l'√©tudier, le lire pour de bon?  Et s'il ne travaille pas?  Et s'il fait autre chose de mal?  C'est groovy, mais je ne le connais pas et on ne sait pas comment travailler avec lui.  Et un script s'est d√©j√† d√©plac√© sur Kotlin depuis longtemps, et je ne peux pas faire de portage depuis des grooves, et ainsi de suite. </p><br><p>  La chose la plus int√©ressante est que tous ces jugements sont d√©j√† venus de moi, car  J'ai r√©alis√© qu'une telle int√©gration de la solution ne me convenait pas.  De plus, j'ai remarqu√© quelques points que j'aimerais vraiment am√©liorer.  Ayant impl√©ment√© la solution dans le projet A, je voudrais la soutenir dans le projet B. Il n'y a qu'une seule issue - vous devez √©crire un plug-in. </p><br><p>  Et quels probl√®mes le plug-in et sa livraison √† distance √† l'utilisateur r√©soudront-ils? </p><br><ul><li>  le probl√®me d'un programmeur paresseux.  Nous sommes trop paresseux pour fouiller la racine du probl√®me et les moyens possibles de le r√©soudre.  Il nous est beaucoup plus facile de prendre quelque chose qui a d√©j√† √©t√© fait avant vous et de l'utiliser. </li><li>  soutien.  Il comprend le support du code, son d√©veloppement et l'expansion des opportunit√©s.  Lors de la r√©solution de mon probl√®me, je n'ai r√©solu que les environnements probrosvarivnyh uniquement dans le code, oubliant compl√®tement la possibilit√© de transfert vers les ressources. </li><li>  qualit√© du code.  Il y a une opinion que certains d√©veloppeurs ne regardent m√™me pas le code open source qui n'est pas couvert par les tests.  Nous sommes en 2019 et nous pouvons facilement connecter des services pour suivre la qualit√© du code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://sonarcloud.io</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://codecov.io/</a> </li><li>  configuration.  L'extension de fichier de build m'oblige √† examiner ce code et √† apporter des modifications manuellement.  Dans mon cas, je n'ai pas toujours besoin d'utiliser la configuration pour <strong>buildTypes</strong> ou <strong>productFlavors</strong> , je veux une chose ou toutes √† la fois. </li><li>  nettoyage des √©tag√®res poussi√©reuses.  J'ai finalement nettoy√© l'un d'eux et j'ai pu faire avancer cette d√©cision de ma chambre. </li></ul><br><p>  Je n'entrerai pas dans les d√©tails et les probl√®mes lors de l'√©criture du plugin, il tire sur un nouveau sujet.  Vous pouvez prendre une d√©cision avec son int√©gration, proposer votre id√©e ou apporter votre contribution <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr462751/">https://habr.com/ru/post/fr462751/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr462737/index.html">Int√©gration d'OpenCart avec les syst√®mes comptables</a></li>
<li><a href="../fr462739/index.html">Conf√©rence de l'industrie du jeu GAMEDEV.HOUSE</a></li>
<li><a href="../fr462743/index.html">Moscou SPA Meetup # 5 - Annonce de r√©union</a></li>
<li><a href="../fr462747/index.html">J'ai √©crit cet article sans jamais regarder le clavier</a></li>
<li><a href="../fr462749/index.html">Gestion du bonheur: comment prendre soin et d√©velopper une √©quipe de bureau √† domicile dans plus de 30 villes</a></li>
<li><a href="../fr462753/index.html">La puissance des g√©n√©riques dans Swift. Partie 1</a></li>
<li><a href="../fr462755/index.html">Flux asynchrone en C # 8</a></li>
<li><a href="../fr462763/index.html">Jouet GAZ-66 sur le panneau de commande. 3e partie</a></li>
<li><a href="../fr462765/index.html">Test de ONYX BOOX Note Pro: lecteur PDF haut de gamme</a></li>
<li><a href="../fr462769/index.html">Application de l'apprentissage automatique et de la science des donn√©es dans l'industrie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>