<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëì ü¶å üÜô Arbeiten mit der Newtonsoft.Json-Bibliothek anhand eines realen Beispiels. Teil 2 üêô üçπ üë®üèΩ‚ÄçüöÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Im ersten Teil des Artikels wurde der Mechanismus zum Parsen von JSON-Objekten mit einer sich dynamisch √§ndernden Struktur untersucht. Diese Objekte w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Arbeiten mit der Newtonsoft.Json-Bibliothek anhand eines realen Beispiels. Teil 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/482042/">  Im ersten Teil des Artikels wurde der Mechanismus zum Parsen von JSON-Objekten mit einer sich dynamisch √§ndernden Struktur untersucht.  Diese Objekte wurden in newtonsoft.json.linq-Namespace-Typen umgewandelt und anschlie√üend in C # -Sprachenstrukturen konvertiert.  In den Kommentaren zum ersten Teil gab es viel Kritik, die gr√∂√ütenteils gerechtfertigt war.  Im zweiten Teil werde ich versuchen, alle Kommentare und Vorschl√§ge zu ber√ºcksichtigen. <br><br><img src="https://habrastorage.org/webt/3l/5k/h7/3l5kh7oqau8g7rjl5_urm3bcv-u.png"><br><a name="habracut"></a><br>  Dar√ºber hinaus konzentrieren wir uns auf die Vorbereitung von Klassen zur Feinabstimmung der Datentransformation. Zun√§chst m√ºssen Sie jedoch zum JSON-Parsing selbst zur√ºckkehren.  Ich erinnere mich, dass im ersten Teil die Methoden Parse () und ToObject &lt;T&gt; () der Klassen JObject und JArray des Namespace newtonsoft.json.linq verwendet wurden: <br><br><pre><code class="cs hljs">HttpClient httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> request = <span class="hljs-string"><span class="hljs-string">"https://api.exmo.com/v1/trades/?pair=BTC_USD,ETH_USD"</span></span>; HttpResponseMessage response = (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetAsync(request)).EnsureSuccessStatusCode(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> responseBody = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.Content.ReadAsStringAsync(); JObject jObject = JObject.Parse(responseBody); Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; dict = jObject.ToObject&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt;();</code> </pre> <br>  Es ist zu beachten, dass es im Namespace newtonsof.json in der Klasse JsonConvert eine statische Methode DeserializeObject &lt;&gt; gibt, mit der Sie Zeichenfolgen direkt in C # -Strukturen konvertieren k√∂nnen, die Objekten und Arrays der JSON-Notation entsprechen: <br><br><pre> <code class="cs hljs">Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; JsonObject = JsonConvert.DeserializeObject&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt;(responseBody); List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Json_Array = JsonConvert.DeserializeObject&lt;List&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(responseBody);</code> </pre><br>  In Zukunft wird diese Methode in diesem Artikel verwendet. Sie m√ºssen also newtonsoft.json zum Programm hinzuf√ºgen. <br><br>  Dar√ºber hinaus ist es m√∂glich, die Anzahl der Zwischenkonvertierungen weiter zu reduzieren. Nach der Installation der Microsoft.AspNet.WebApi.Client-Bibliothek (auch √ºber NuGet verf√ºgbar) k√∂nnen Daten mithilfe der ReadAsAsync-Methode direkt aus dem Stream analysiert werden: <br><br><pre> <code class="cs hljs">Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; JsonObject = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetAsync(request)). EnsureSuccessStatusCode().Content. ReadAsAsync&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt;();</code> </pre><br>  Danke f√ºr den Tipp <a href="https://habr.com/ru/post/481514/">Lair</a> . <br><br><h3>  Vorbereiten der Klasse f√ºr die Konvertierung </h3><br>  Zur√ºck zu unserer Auftragsklasse: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> trade_id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Ich m√∂chte Sie daran erinnern, dass es auf der Grundlage des von JSON C # Class Generator vorgeschlagenen Formats erstellt wurde.  Es gibt zwei Punkte, die beim Arbeiten mit Objekten dieser Klasse Schwierigkeiten verursachen k√∂nnen. <br><br>  Die erste - in dieser Form versto√üen die Eigenschaften unserer Klasse gegen die Regeln f√ºr die Benennung von Feldern.  Au√üerdem ist es logisch, dass ein Objekt vom Typ Order erwartet, dass sein Bezeichner OrderID hei√üt (und nicht traid_id, wie in den Beispielen aus dem ersten Teil).  Um ein JSON-Strukturelement und eine Klasseneigenschaft einem beliebigen Namen zuzuordnen, m√ºssen Sie das JsonProperty-Attribut vor der Eigenschaft hinzuf√ºgen: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { [JsonProperty(<span class="hljs-string"><span class="hljs-string">"trade_id"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"type"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"quantity"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"price"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"date"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Infolgedessen wird der dem Element "trade_id" entsprechende Wert in der Eigenschaft "OrderID", "type" in "Type" usw. aufgezeichnet.  Das JsonProperty-Attribut ist auch zum Serialisieren / Deserialisieren von Eigenschaften mit privaten oder statischen Modifizierern erforderlich. Standardm√§√üig werden solche Eigenschaften ignoriert. <br>  Folglich kann der Code zum Erstellen einer Liste aller OrderID-Transaktionen f√ºr die W√§hrungspaare BTC_USD und ETH_USD folgenderma√üen aussehen: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HttpClient httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> request = <span class="hljs-string"><span class="hljs-string">"https://api.exmo.com/v1/trades/?pair=BTC_USD,ETH_USD"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> responseBody = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetAsync(request)). EnsureSuccessStatusCode(). Content.ReadAsStringAsync(); Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; PairList = JsonConvert.DeserializeObject&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt;(responseBody); List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; IDs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> PairList) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pair.Value) IDs.Add(order.OrderID);</code> </pre><br>  Die zweite Schwierigkeit bei der Arbeit mit dieser Klasse ist die Eigenschaft Date.  Wie Sie sehen, hat der JSON C # -Klassengenerator das Element "date" als Primzahl definiert.  Es w√§re jedoch viel praktischer, wenn die Date-Eigenschaft unserer Klasse einen speziell f√ºr Datumsangaben erstellten Typ h√§tte - DateTime.  Wie dies gemacht wird, wird sp√§ter beschrieben. <br><br><h3>  Funktionen zum Arbeiten mit Datumsangaben </h3><br>  Der urspr√ºngliche Satz des <a href="https://www.newtonsoft.com/json/help/html/datesinjson.htm">Artikels</a> in der Dokumentation f√ºr newtonsof.json mit einer Beschreibung der Arbeit mit Datumsangaben kann grob als "DateTime in JSON - es ist schwer" √ºbersetzt werden.  Das Problem ist, dass die JSON-Spezifikation selbst keine Informationen dar√ºber enth√§lt, welche Syntax zur Beschreibung von Datum und Uhrzeit verwendet werden soll. <br><br>  Alles ist relativ gut, wenn das Datum in der JSON-Zeichenfolge in Textform dargestellt wird und das Darstellungsformat einer von drei Optionen entspricht: "Microsoft" (derzeit als veraltet betrachtet), "JavaScript" ( <a href="https://ru.wikipedia.org/wiki/Unix-%25D0%25B2%25D1%2580%25D0%25B5%25D0%25BC%25D1%258F">Unix-</a> Zeit) und die <a href="https://ru.wikipedia.org/wiki/ISO_8601">ISO 8601-</a> Variante.  Beispiele f√ºr g√ºltige Formate: <br><br><pre> <code class="cs hljs">Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, DateTime&gt; d = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, DateTime&gt; { { <span class="hljs-string"><span class="hljs-string">"date"</span></span>, DateTime.Now } }; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> isoDate = JsonConvert.SerializeObject(d); <span class="hljs-comment"><span class="hljs-comment">// {"date":"2019-12-19T14:10:31.3708939+03:00"} JsonSerializerSettings microsoftDateFormatSettings = new JsonSerializerSettings { DateFormatHandling = DateFormatHandling.MicrosoftDateFormat }; string microsoftDate = JsonConvert.SerializeObject(d, microsoftDateFormatSettings); // {"date":"\/Date(1576753831370+0300)\/"} string javascriptDate = JsonConvert.SerializeObject(d, new JavaScriptDateTimeConverter()); // {"date":new Date(1576753831370)}</span></span></code> </pre><br>  Beim Exmo-Tausch ist jedoch alles etwas komplizierter.  Die Beschreibung der Exchange-API gibt an, dass Datum und Uhrzeit im Unix-Format (JavaScript) angegeben sind.  Und theoretisch sollten wir, wenn wir unserer Date-Eigenschaft der Order-Klasse eine Formatkonvertierungsfunktion aus der JavaScriptDateTimeConverter () -Klasse hinzuf√ºgen, das Datum in den DateTime-Typ umwandeln: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { [JsonProperty(<span class="hljs-string"><span class="hljs-string">"trade_id"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"type"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"quantity"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"price"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"date"</span></span>, ItemConverterType = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(JavaScriptDateTimeConverter))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Wenn Sie jedoch in diesem Fall versuchen, Daten in eine Variable vom Typ DateTime zu analysieren, ist eine Ausnahme Newtonsoft.Json.JsonReaderException bereits aus dem ersten Teil des Artikels bekannt.  Dies liegt daran, dass die Konvertierungsfunktion der JavaScriptDateTimeConverter-Klasse keine numerischen Daten in den DateTime-Typ konvertieren kann (dies funktioniert nur f√ºr Zeichenfolgen). <br><br><img src="https://habrastorage.org/webt/0r/ra/lb/0rralbgk0tvrzdsq6sfwiphhpls.png"><br><br>  Ein m√∂glicher Ausweg aus dieser Situation ist das Schreiben einer eigenen Formatkonvertierungsklasse.  Tats√§chlich ist eine solche Klasse bereits vorhanden und kann verwendet werden, indem der Namespace Newtonsoft.Json.Converters vorab verbunden wird (beachten Sie, dass die Umkehrfunktion in dieser Klasse keine Konvertierung von DateTime nach JSON vornimmt): <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UnixTimeToDatetimeConverter</span></span> : <span class="hljs-title"><span class="hljs-title">DateTimeConverterBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DateTime _epoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DateTimeKind.Utc); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteJson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JsonWriter writer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, JsonSerializer serializer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadJson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JsonReader reader, Type objectType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> existingValue, JsonSerializer serializer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader.Value == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _epoch.AddSeconds(Convert.ToDouble(reader.Value)).ToLocalTime(); } }</code> </pre><br>  Es bleibt nur, unsere Funktion mit der Date-Eigenschaft der Order-Klasse zu verbinden.  Verwenden Sie dazu das JsonConverter-Attribut: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { [JsonProperty(<span class="hljs-string"><span class="hljs-string">"trade_id"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"type"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"quantity"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"price"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"date"</span></span>)] [JsonConverter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UnixTimeToDatetimeConverter))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Jetzt hat unsere Date-Eigenschaft den Typ DateTime und wir k√∂nnen beispielsweise eine Liste von Deals in den letzten 10 Minuten erstellen: <br><br><pre> <code class="cs hljs">HttpClient httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> request = <span class="hljs-string"><span class="hljs-string">"https://api.exmo.com/v1/trades/?pair=BTC_USD,ETH_USD"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> responseBody = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetAsync(request)). EnsureSuccessStatusCode(). Content.ReadAsStringAsync(); Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; PairList = JsonConvert.DeserializeObject&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt;(responseBody); List&lt;Order&gt; Last10minuts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Order&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> PairList) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pair.Value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (order.Date &gt; DateTime.Now.AddMinutes(<span class="hljs-number"><span class="hljs-number">-10</span></span>)) Last10minuts.Add(order);</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Volltext des Programms</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json.Converters; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">JSONObjects</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { [JsonProperty(<span class="hljs-string"><span class="hljs-string">"pair"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Pair { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"trade_id"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"type"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"quantity"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"price"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"date"</span></span>)] [JsonConverter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UnixTimeToDatetimeConverter))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UnixTimeToDatetimeConverter</span></span> : <span class="hljs-title"><span class="hljs-title">DateTimeConverterBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DateTime _epoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DateTimeKind.Utc); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteJson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JsonWriter writer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, JsonSerializer serializer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadJson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JsonReader reader, Type objectType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> existingValue, JsonSerializer serializer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader.Value == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _epoch.AddSeconds(Convert.ToDouble(reader.Value)).ToLocalTime(); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HttpClient httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> request = <span class="hljs-string"><span class="hljs-string">"https://api.exmo.com/v1/trades/?pair=BTC_USD,ETH_USD"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> responseBody = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetAsync(request)). EnsureSuccessStatusCode(). Content.ReadAsStringAsync(); Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; PairList = JsonConvert. DeserializeObject&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt;(responseBody); List&lt;Order&gt; Last10minuts = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Order&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> PairList) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pair.Value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (order.Date &gt; DateTime.Now.AddMinutes(<span class="hljs-number"><span class="hljs-number">-10</span></span>)) Last10minuts.Add(order); } } }</code> </pre><br></div></div><br><h3>  JSON-Elementsubstitution </h3><br>  Zuvor haben wir mit dem Trades Exchange Team zusammengearbeitet.  Dieser Befehl gibt Objekte mit den folgenden Feldern zur√ºck: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BTCUSD</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> trade_id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Der Austauschbefehl user_open_orders gibt eine sehr √§hnliche Struktur zur√ºck: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">BTCUSD</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> order_id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> created { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> pair { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  Daher ist es sinnvoll, die Order-Klasse so anzupassen, dass sie nicht nur die Handelsbefehlsdaten, sondern auch die user_open_orders-Befehlsdaten konvertieren kann. <br><br>  Der Unterschied besteht darin, dass es ein neues Paarelement gibt, das den Namen des W√§hrungspaares enth√§lt. Trade_id wird durch order_id ersetzt (und jetzt ist es eine Zeichenfolge). Das Datum wurde erstellt und ist auch eine Zeichenfolge. <br><br>  Zun√§chst f√ºgen wir die M√∂glichkeit hinzu, die order_id und die erstellten Felder in den entsprechenden OrderID- und Date-Feldern der Order-Klasse zu speichern.  Bereiten Sie dazu die OrderDataContractResolver-Klasse vor, in der die Feldnamen f√ºr das Parsen ersetzt werden (die Namespaces System.Reflection und Newtonsoft.Json.Serialization sind erforderlich): <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderDataContractResolver</span></span> : <span class="hljs-title"><span class="hljs-title">DefaultContractResolver</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> OrderDataContractResolver Instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderDataContractResolver(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> JsonProperty </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateProperty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MemberInfo member, MemberSerialization memberSerialization</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> property = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.CreateProperty(member, memberSerialization); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property.DeclaringType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Order)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property.PropertyName.Equals(<span class="hljs-string"><span class="hljs-string">"trade_id"</span></span>, StringComparison.OrdinalIgnoreCase)) { property.PropertyName = <span class="hljs-string"><span class="hljs-string">"order_id"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property.PropertyName.Equals(<span class="hljs-string"><span class="hljs-string">"date"</span></span>, StringComparison.OrdinalIgnoreCase)) { property.PropertyName = <span class="hljs-string"><span class="hljs-string">"created"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> property; } }</code> </pre><br>  Au√üerdem muss diese Klasse wie folgt als Parameter der DeserializeObject-Methode angegeben werden: <br><br><pre> <code class="cs hljs">Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; PairList = JsonConvert.DeserializeObject&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt;(responseBody, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonSerializerSettings { ContractResolver = OrderDataContractResolver.Instance });</code> </pre><br>  Als Ergebnis wird eine solche JSON-Struktur als Antwort auf den Befehl user_open_orders abgerufen: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"BTC_USD"</span></span>:[{<span class="hljs-attr"><span class="hljs-attr">"order_id"</span></span>:<span class="hljs-string"><span class="hljs-string">"4722868563"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"created"</span></span>:<span class="hljs-string"><span class="hljs-string">"1577349229"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"type"</span></span>:<span class="hljs-string"><span class="hljs-string">"sell"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"pair"</span></span>:<span class="hljs-string"><span class="hljs-string">"BTC_USD"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"quantity"</span></span>:<span class="hljs-string"><span class="hljs-string">"0.002"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"price"</span></span>:<span class="hljs-string"><span class="hljs-string">"8362.2"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"amount"</span></span>:<span class="hljs-string"><span class="hljs-string">"16.7244"</span></span>}]}</code> </pre><br>  wird in eine solche Datenstruktur konvertiert: <br><br><img src="https://habrastorage.org/webt/35/6-/oa/356-oattpssgl2dehracirilbtg.png"><br><br>  Beachten Sie, dass der Typ des OrderID-Felds in der Order-Klasse durch eine Zeichenfolge ersetzt werden musste, damit das Programm ordnungsgem√§√ü funktioniert. <br><br><div class="spoiler">  <b class="spoiler_title">Volltext des Programms</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Threading.Tasks; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Net.Http; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json.Converters; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> Newtonsoft.Json.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Reflection; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">JSONObjects</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { [JsonProperty(<span class="hljs-string"><span class="hljs-string">"pair"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Pair { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"trade_id"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OrderID { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"type"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"quantity"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Quantity { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"price"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"amount"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [JsonProperty(<span class="hljs-string"><span class="hljs-string">"date"</span></span>)] [JsonConverter(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(UnixTimeToDatetimeConverter))] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Date { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderDataContractResolver</span></span> : <span class="hljs-title"><span class="hljs-title">DefaultContractResolver</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> OrderDataContractResolver Instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OrderDataContractResolver(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> JsonProperty </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateProperty</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MemberInfo member, MemberSerialization memberSerialization</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> property = <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.CreateProperty(member, memberSerialization); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property.DeclaringType == <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Order)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property.PropertyName.Equals(<span class="hljs-string"><span class="hljs-string">"trade_id"</span></span>, StringComparison.OrdinalIgnoreCase)) { property.PropertyName = <span class="hljs-string"><span class="hljs-string">"order_id"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (property.PropertyName.Equals(<span class="hljs-string"><span class="hljs-string">"date"</span></span>, StringComparison.OrdinalIgnoreCase)) { property.PropertyName = <span class="hljs-string"><span class="hljs-string">"created"</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> property; } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UnixTimeToDatetimeConverter</span></span> : <span class="hljs-title"><span class="hljs-title">DateTimeConverterBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> DateTime _epoch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(<span class="hljs-number"><span class="hljs-number">1970</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, DateTimeKind.Utc); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteJson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JsonWriter writer, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">value</span></span></span></span><span class="hljs-function"><span class="hljs-params">, JsonSerializer serializer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotImplementedException(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadJson</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JsonReader reader, Type objectType, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> existingValue, JsonSerializer serializer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (reader.Value == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _epoch.AddSeconds(Convert.ToDouble(reader.Value)).ToLocalTime(); } } <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> HttpClient httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> request = <span class="hljs-string"><span class="hljs-string">"https://api.exmo.com/v1/trades/?pair=BTC_USD,ETH_USD"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> responseBody = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.GetAsync(request)). EnsureSuccessStatusCode(). Content.ReadAsStringAsync(); Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; PairList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;(); JObject jObject = JObject.Parse(responseBody); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> jObject) { List&lt;Order&gt; orders = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Order&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pair.Value.ToObject&lt;List&lt;Order&gt;&gt;()) { order.Pair = pair.Key; orders.Add(order); } PairList.Add(pair.Key, orders); } responseBody = <span class="hljs-string"><span class="hljs-string">"{\"BTC_USD\":[{\"order_id\":\"4722868563\","</span></span> + <span class="hljs-string"><span class="hljs-string">"\"created\":\"1577349229\",\"type\":\"sell\","</span></span> + <span class="hljs-string"><span class="hljs-string">"\"pair\":\"BTC_USD\",\"quantity\":\"0.002\","</span></span> + <span class="hljs-string"><span class="hljs-string">"\"price\":\"8362.2\",\"amount\":\"16.7244\"}]}"</span></span>; Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; PairList1 = JsonConvert.DeserializeObject&lt;Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;&gt; (responseBody, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsonSerializerSettings { ContractResolver = OrderDataContractResolver.Instance }); } } } }</code> </pre> <br></div></div><br><br>  Wie Sie sehen, enth√§lt die Antwort beim Aufrufen des Befehls user_open_orders das Feld "pair" (Paar). Im Fall des Handelsbefehls sind Informationen zum W√§hrungspaar nur im Schl√ºsselwert enthalten.  Daher m√ºssen Sie nach dem Parsen entweder das Feld Pair ausf√ºllen: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> PairList) <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pair.Value) order.Pair = pair.Key;</code> </pre><br>  Oder verwenden Sie das JObject-Objekt: <br><br><pre> <code class="cs hljs">Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt; PairList = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, List&lt;Order&gt;&gt;(); JObject jObject = JObject.Parse(responseBody); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> jObject) { List&lt;Order&gt; orders = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Order&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> order <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pair.Value.ToObject&lt;List&lt;Order&gt;&gt;()) { order.Pair = pair.Key; orders.Add(order); } PairList.Add(pair.Key, orders); }</code> </pre><br>  Was letztendlich zur Erstellung der folgenden Datenstruktur f√ºhrt: <br><br><img src="https://habrastorage.org/webt/bq/l0/q0/bql0q0xtvo06iesnfdskz80d_80.png"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de482042/">https://habr.com/ru/post/de482042/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de482028/index.html">Zwei rote Kn√∂pfe, L√∂tkolben und React: Wie wir uns f√ºr eine IT-Konferenz entschieden haben</a></li>
<li><a href="../de482030/index.html">Vue.js: Lifecycle-Hooks f√ºr Ihre und Komponenten von Drittanbietern</a></li>
<li><a href="../de482034/index.html">Yandex: Es gibt alles ... √ºber Benutzer</a></li>
<li><a href="../de482038/index.html">Wir fassen die Ergebnisse von 2019 bei Haber Career zusammen</a></li>
<li><a href="../de482040/index.html">Enth√§lt Profiling-Programme in C ++</a></li>
<li><a href="../de482044/index.html">10 Best Practices zum Sichern von Docker-Images. Teil 2</a></li>
<li><a href="../de482050/index.html">Jedi Convolution Network Reduction-Technik - Beschneiden</a></li>
<li><a href="../de482052/index.html">Neujahrs-Datensatz 2019: offenes Tonw√∂rterbuch der russischen Sprache</a></li>
<li><a href="../de482054/index.html">3. Elastic Stack: Sicherheitsprotokollanalyse. Dashboards</a></li>
<li><a href="../de482058/index.html">Raubtier oder Beute? Wer sch√ºtzt die Zertifizierungsstellen?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>