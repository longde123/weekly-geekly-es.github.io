<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😁 🛰️ 💿 Dynamisches CDN für WebRTC-Streaming mit geringer Latenz 🧓🏿 ⚱️ 🛏️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bei der Analyse der Möglichkeiten von Standard- Serverkonfigurationen in Digital Ocean im Hinblick auf WebRTC-Streaming haben wir bereits festgestellt...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dynamisches CDN für WebRTC-Streaming mit geringer Latenz</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flashphoner/blog/477310/"><p><img src="https://habrastorage.org/webt/qp/yd/gy/qpydgy2jfifixw87t9seev0eb7o.jpeg"></p><br><p>  Bei der Analyse der Möglichkeiten von Standard- <a href="https://habr.com/en/company/flashphoner/blog/476546/">Serverkonfigurationen in Digital Ocean</a> im Hinblick auf WebRTC-Streaming haben wir bereits festgestellt, dass ein Server bis zu 2000 Zuschauer bedienen kann.  In der Praxis gibt es oft Fälle, in denen ein Server nicht ausreicht. </p><br><p>  Sagen wir, Fans der Aufregung in Deutschland schauen sich in Australien Pferderennen in Echtzeit an.  Da Pferderennen nicht nur Pferdesport ist, sondern auch große Gewinne mit pünktlichen Wetten, sollte das Video mit der geringstmöglichen Verzögerung geliefert werden. </p><a name="habracut"></a><br><p>  Ein weiteres Beispiel.  Ein globales Unternehmen, eines der führenden Unternehmen auf dem FCMG-Markt mit Tochterunternehmen in Europa, Russland und Südostasien, organisiert Webinare, um Vertriebsleiter mit Übersetzungen vom Hauptsitz im Mittelmeerraum aus zu schulen.  Die Zuschauer sollten den Moderator in Echtzeit sehen und hören. </p><br><p>  Diese Beispiele kombinieren die Anforderungen: Bereitstellung von Medienströmen für eine große Anzahl von Zuschauern mit geringer Latenz.  Dazu müssen Sie ein Content Delivery-Netzwerk (CDN) bereitstellen. </p><br><p>  Beachten Sie, dass die klassische Technologie der Stream-Zustellung mit HLS nicht geeignet ist, da es zu Verzögerungen von bis zu 30 Sekunden kommen kann. Dies ist für Echtzeit-Shows von entscheidender Bedeutung.  Stellen Sie sich vor, die Pferde haben bereits die Ziellinie erreicht, die Ergebnisse werden auf der Website veröffentlicht und die Fans inspizieren das Rennen noch immer.  Diesem Nachteil wird die WebRTC-Technologie vorenthalten, die Verzögerungen innerhalb von 1 Sekunde bereitstellen kann. Mit modernen Kommunikationskanälen ist dies sogar zwischen Kontinenten möglich. </p><br><p>  Lassen Sie uns zunächst sehen, wie Sie das einfachste CDN für die Bereitstellung von WebRTC-Streams bereitstellen und anschließend skalieren. </p><br><h2 id="struktura-cdn">  CDN-Struktur </h2><br><p>  Ein Server in einem CDN kann eine der folgenden Rollen übernehmen: </p><br><ul><li>  Origin ist ein Server zum Veröffentlichen von Medienströmen.  Verteilt Streams an andere Server und kann auch an Abonnenten verteilt werden. </li><li>  Transcoder - Ein Server, der sich der Transcodierung von Streams widmet.  Nimmt Streams von Origin-Servern auf und verteilt transkodierte Streams an Edge.  Wir werden uns im nächsten Teil mit dieser Rolle befassen. </li><li>  Edge - ein Server, der zum Verteilen von Streams an Abonnenten entwickelt wurde.  Es werden Streams von Origin- oder Transcoder-Servern verwendet und keine Streams an andere CDN-Server verteilt. </li></ul><br><p> Sie können WebRTC- und RTMP-Streams auf dem Origin-Server veröffentlichen oder Streams aus anderen Quellen über RTMP, RTSP und andere mögliche Methoden erfassen. </p><br><p>  Abonnenten können Streams von Edgeservern über WebRTC, RTMP, RTSP, HLS wiedergeben </p><br><p>  Zwischen CDN-Servern ist es wünschenswert, über WebRTC zu streamen, um die Latenz zu verringern. </p><br><p>  Eine statische CDN wird in der Konfigurationsphase vollständig beschrieben.  Das Einrichten eines statischen CDN ähnelt dem Einrichten eines Lastenausgleichs: Alle Empfänger werden in den Einstellungen des Stream-Quellservers aufgelistet. </p><br><p>  Zum Beispiel haben wir einen Origin-Server in Frankfurt, einen Edge in New York und einen in Singapur </p><br><p><img src="https://habrastorage.org/webt/so/gg/1w/sogg1wq1m_67p9waxgdyjbtix4y.png"></p><br><p>  In diesem Fall ist Origin folgendermaßen konfiguriert: </p><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mode</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"roundrobin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">stream_distribution</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"webrtc"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge1.thestaticcdn.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span>edge2.thestaticcdn.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ip</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span>443<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">wss</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">node</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">loadbalancer</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Hier ist das erste Problem mit einem statischen CDN: Um einem solchen CDN einen neuen Edgeserver hinzuzufügen oder den Server aus dem CDN zu entfernen, müssen Sie die Einstellungen ändern und alle Origin-Server neu starten. </p><br><p>  In Origin veröffentlichte Streams werden an alle Server gesendet, die in den Edge-Einstellungen aufgeführt sind.  Die Entscheidung, zu welchem ​​der Edgeserver der Abonnent eine Verbindung herstellen soll, wird ebenfalls auf dem Origin-Server getroffen.  Hier ist das zweite Problem: Wenn es keine oder nur sehr wenige Zuschauer gibt, zum Beispiel in Singapur an einem frühen Abend und in New York mitten in der Nacht, werden die Streams immer noch an Edge 1 gesendet. Der Verkehr wird im Leerlauf und überhaupt nicht kostenlos ausgegeben. </p><br><p>  Dynamic CDN kann diese beiden Probleme lösen. </p><br><p>  Wir möchten also CDN konfigurieren, ohne alle Origin-Server neu zu starten, und wir möchten keine Streams zu den Edge-Servern übertragen, auf denen keine Abonnenten vorhanden sind.  In diesem Fall müssen Sie nicht die gesamte Liste der CDN-Server in den Einstellungen speichern.  Jeder Server selbst muss eine solche Liste erstellen und dafür den aktuellen Status der anderen Server zu einem bestimmten Zeitpunkt kennen. </p><br><p>  Idealerweise sollte es in den Einstellungen ausreichen, den Einstiegspunkt, den Server, von dem das CDN gestartet wird, anzugeben.  An diesem Einstiegspunkt sollte jeder Server beim Start eine Anforderung senden und als Antwort eine Liste der CDN-Knoten und eine Liste der veröffentlichten Streams erhalten.  Wenn der Einstiegspunkt nicht verfügbar ist, sollte der Server Nachrichten von anderen Servern erwarten. </p><br><p>  Der Server sollte alle Änderungen an seinem Status an andere Server im CDN senden. </p><br><h2 id="prosteyshaya-cdn-v-centre-evropy">  Das einfachste CDN: in der Mitte Europas </h2><br><p>  Versuchen wir also, ein dynamisches CDN zu konfigurieren und auszuführen.  Nehmen wir zunächst an, wir müssen Videostreams an europäische Zuschauer verteilen, während bis zu 5.000 Benutzer unterstützt werden müssen.  Angenommen, die Quelle der Ströme liegt ebenfalls in Europa. </p><br><p><img src="https://habrastorage.org/webt/xo/oi/rx/xooirxhid75yiqsfuff8sdu5xge.png"></p><br><p>  Wir setzen drei Server im europäischen Rechenzentrum ein.  Wir werden Flashphoner WebCallServer (WebRTC Streaming Video Server) als Elemente für die Erstellung eines CDN verwenden. </p><br><p><img src="https://habrastorage.org/webt/ts/de/4x/tsde4xzznh96b-15pb7pephsqlc.png"></p><br><p>  Setup: </p><br><ul><li>  Herkunft EU </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=origin</code> </pre> <br><ul><li>  Rand 1 EU </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-eu1.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><ul><li>  Rand 2 EU </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-eu2.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><p>  Messaging zwischen dynamischen CDN-Knoten erfolgt über Websocket, und Secure Websocket wird natürlich auch unterstützt. </p><br><p>  Innerhalb des CDN werden Streams über WebRTC übertragen.  In der Regel wird UDP als Transport verwendet, Sie können jedoch auf TCP umschalten, wenn Sie die Broadcast-Qualität mit einem nicht sehr guten Kanal zwischen Servern sicherstellen möchten.  Leider nehmen in diesem Fall die Verzögerungen zu. </p><br><p>  Wir starten die Server neu, öffnen das Two Way Streaming-Beispiel auf dem <code>o-eu1</code> und veröffentlichen ein zyklisches Video mit einem Countdown-Timer von 10 Minuten bis 0 Minuten </p><br><p><img src="https://habrastorage.org/webt/96/l1/ir/96l1irnyaa3owncv9nlj7acek74.png"></p><br><p>  Öffnen Sie das Player-Beispiel auf dem <code>e-eu1</code> und spielen Sie den Stream ab </p><br><p><img src="https://habrastorage.org/webt/fc/3p/st/fc3pst40kkeh0gh0dunrcktlksg.png"></p><br><p>  Und machen Sie dasselbe mit <code>e-eu2</code> </p><br><p><img src="https://habrastorage.org/webt/el/j5/ew/elj5ew8cqvaxpvmbmr14wwl1dvu.png"></p><br><p>  CDN funktioniert!  Wie Sie in den Screenshots sehen können, fällt die Zeit im Video dank WebRTC und guter Kanäle auf der Veröffentlichungsseite und in den Zuschauern bis zu einer Sekunde zusammen. </p><br><h2 id="dalee-vezde-podklyuchaem-ameriku">  Überall weiter: Amerika verbinden </h2><br><p>  Jetzt werden wir den Zuschauern auf dem amerikanischen Kontinent Streams liefern und die Veröffentlichung nicht vergessen. </p><br><p><img src="https://habrastorage.org/webt/y6/8r/ig/y68rigg5xu5uq32qmvrb2_6yexq.png"></p><br><p>  Ohne den europäischen Teil des CDN zu deaktivieren, stellen wir drei Server im amerikanischen Rechenzentrum bereit </p><br><p><img src="https://habrastorage.org/webt/t5/q8/vh/t5q8vh5mlwgvixiq_l-zdin6bje.png"></p><br><p>  Setup: </p><br><ul><li>  Herkunft USA </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=o-us1.flashponer.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=origin</code> </pre> <br><ul><li>  Edge 1 US </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-us1.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><ul><li>  Edge 2 US </li></ul><br><pre> <code class="plaintext hljs">cdn_enabled=true cdn_ip=e-us2.flashphoner.com cdn_point_of_entry=o-eu1.flashponer.com cdn_nodes_resolve_ip=false cdn_role=edge</code> </pre> <br><p>  Wir starten die amerikanischen Server neu, wir überprüfen die Publikation </p><br><p><img src="https://habrastorage.org/webt/6s/s1/uq/6ss1uquwqf-a0nctys-rsc6p4xo.png"><br>  und Reproduktion </p><br><p><img src="https://habrastorage.org/webt/4i/ur/_s/4iur_sn57za5_ypd9pssupfg8rm.png"></p><br><p>  Gleichzeitig arbeitet das europäische Segment weiter.  Überprüfen Sie, ob amerikanischen Abonnenten der Stream aus Europa angezeigt wird.  Wir veröffentlichen den Stream <code>test_eu</code> auf dem <code>o-eu1</code> </p><br><p><img src="https://habrastorage.org/webt/yp/dk/0o/ypdk0o9fnrje0kbmtx7-duhrkuo.png"></p><br><p>  und spiele es auf <code>e-us1</code> </p><br><p><img src="https://habrastorage.org/webt/ld/6n/u3/ld6nu3rzicqjotfzz88goggo1lk.png"></p><br><p>  Und es funktioniert auch!  Was die Verzögerung angeht, so beobachten wir in den Screenshots erneut das Zusammentreffen des Timers im Video auf der Veröffentlichungsseite und in den Zuschauern bis zu einer Sekunde. </p><br><p>  Bitte beachten Sie, dass auf einem anderen Origin-Server veröffentlichte Streams standardmäßig nicht direkt vom Origin-Server abgespielt werden können. Wenn Sie dies jedoch benötigen, können Sie es folgendermaßen konfigurieren </p><br><pre> <code class="plaintext hljs">cdn_origin_to_origin_route_propagation=true</code> </pre> <br><h2 id="prodolzhenie-sleduet">  Fortsetzung folgt </h2><br><p>  Daher haben wir ein einfaches CDN bereitgestellt und anschließend erfolgreich auf zwei Kontinente skaliert, um WebRTC-Streams mit geringer Latenz zu veröffentlichen und wiederzugeben.  Gleichzeitig haben wir die Parameter der Streams während der Wiedergabe nicht verändert, was im wirklichen Leben häufig erforderlich ist: Alle Zuschauer haben unterschiedliche Kanäle, und um die Qualität der Sendung aufrechtzuerhalten, ist es beispielsweise erforderlich, die Auflösung oder die Bitrate zu verringern.  Dies werden wir im nächsten Teil tun ... </p><br><h2 id="ssylki">  Referenzen </h2><br><p>  <a href="https://flashphoner.com/cdn-dlya-striminga-webrtc-s-nizkoj-zaderzhkoj/%3Flang%3Dru">WebRTC-Streaming mit geringer Latenz CDN ist ein auf</a> Web Call Server basierendes Netzwerk für die Bereitstellung von Inhalten. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de477310/">https://habr.com/ru/post/de477310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de477298/index.html">Was ist innerhalb des Flughafens: Kontrollzentren</a></li>
<li><a href="../de477300/index.html">Was ist in der besten regionalen Flughafen des Landes: Terminaldienste</a></li>
<li><a href="../de477304/index.html">Dynamisches CDN für WebRTC-Streaming mit geringer Latenz</a></li>
<li><a href="../de477306/index.html">Von der Produktion zum Gehalt bis zur Produktion auf Bestellung. Die Abfolge der Schritte und ein Beispiel für die praktische Umsetzung</a></li>
<li><a href="../de477308/index.html">Klon Numpy</a></li>
<li><a href="../de477314/index.html">Senden von Ereignissen von ViewModel an Activity / Fragment in MVVM</a></li>
<li><a href="../de477318/index.html">PHP Digest Nr. 168 (5. - 25. November 2019)</a></li>
<li><a href="../de477320/index.html">Umwelt: Wie das Internet der Dinge zum Schutz der Umwelt beiträgt</a></li>
<li><a href="../de477324/index.html">Warum Sie sich für den PVS-Studio Static Analyzer entscheiden sollten, um ihn in Ihren Entwicklungsprozess zu integrieren</a></li>
<li><a href="../de477326/index.html">Einfachheit Hickey</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>