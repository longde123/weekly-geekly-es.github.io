<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ЁЯСйЁЯП╛тАНЁЯМ╛ ЁЯХФ ЁЯФБ рд▓рд┐рдирдХреНрд╕ рдореЗрдВ x86 рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХрд╛ рд╡рд┐рдХрд╛рд╕ ЁЯУР тШЭЁЯП╗ ЁЯФк</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="рдкрд┐рдЫрд▓реЗ рд╕рдкреНрддрд╛рд╣рд╛рдВрдд рдореЗрдВ, 80386 рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдк рддрдереНрдпреЛрдВ рдХрд╛ рдЕрдзреНрдпрдпрди рдХрд░рддреЗ рд╣реБрдП, рдореБрдЭреЗ рдЕрдЪрд╛рдирдХ рдпрд╛рдж рдЖрдпрд╛ рдХрд┐ рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдХреЗ рдкрд╣рд▓реЗ рд╕рдВрд╕реНрдХрд░рдг рдЗ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>рд▓рд┐рдирдХреНрд╕ рдореЗрдВ x86 рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХрд╛ рд╡рд┐рдХрд╛рд╕</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438042/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/df8/ca2/556/df8ca2556ca28afde78fe531a3eb892b.png"></div><br><br>  рдкрд┐рдЫрд▓реЗ рд╕рдкреНрддрд╛рд╣рд╛рдВрдд рдореЗрдВ, 80386 рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдк рддрдереНрдпреЛрдВ рдХрд╛ рдЕрдзреНрдпрдпрди рдХрд░рддреЗ рд╣реБрдП, рдореБрдЭреЗ рдЕрдЪрд╛рдирдХ рдпрд╛рдж рдЖрдпрд╛ рдХрд┐ рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдХреЗ рдкрд╣рд▓реЗ рд╕рдВрд╕реНрдХрд░рдг рдЗрд╕ рдкрд░ рдирд┐рд░реНрднрд░ рдереЗред  рдФрд░ рдореИрдВ рдЙрд╕ рдХреЛрдб рдореЗрдВ рдбреВрдм рдЧрдпрд╛ рдЬрд┐рд╕реЗ рдореИрдВрдиреЗ рдХрдИ рд╕рд╛рд▓реЛрдВ рд╕реЗ рдирд╣реАрдВ рджреЗрдЦрд╛ рдерд╛ред  рдЕрдм рдореИрдВрдиреЗ рд▓рд┐рдирдХреНрд╕ рдХреЗ рдЗрддрд┐рд╣рд╛рд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЗрд╕ рдЕрджреНрднреБрдд рдпрд╛рддреНрд░рд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ред  рдореИрдВ рд╕рднреА рд╕реЛрдиреЗ рдХреА рдбрд▓реА рдФрд░ рдордЬреЗрджрд╛рд░ рдХрд▓рд╛рдХреГрддрд┐рдпреЛрдВ рдХреЛ рджрд┐рдЦрд╛рдКрдВрдЧрд╛ рдЬреЛ рдореБрдЭреЗ рд░рд╛рд╕реНрддреЗ рдореЗрдВ рдорд┐рд▓реАрдВред <br><br>  <b>рдЙрджреНрджреЗрд╢реНрдп:</b> рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдореЗрдВ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рд╕рдВрджрд░реНрдн рдХреЛ рдкрд╣рд▓реЗ (0.01) рд╕реЗ рдмрджрд▓рдХрд░ LTS (4.14.67) рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рдХреИрд╕реЗ рдЯреНрд░реИрдХ рдХрд┐рдпрд╛ рдЬрд╛рдП, рдкрд╣рд▓реЗ рдФрд░ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдкрд░ рд╡рд┐рд╢реЗрд╖ рдЬреЛрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред <br><a name="habracut"></a><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд▓рд┐рдирдХреНрд╕: рдкреНрд░рд╛рдЪреАрди рдЗрддрд┐рд╣рд╛рд╕</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓рд┐рдирдХреНрд╕ 1.0: рдЕрд╡рдзрд╛рд░рдгрд╛ рдХрд╛ рдкреНрд░рдорд╛рдг</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓рд┐рдирдХреНрд╕ 2.0: рдЙрдореНрдореАрджрд╡рд╛рд░</a> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">2.2 рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рд╕реНрддрд░ рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">2.4: рдЕрдВрддрд┐рдо рдкреБрд░рд╛рдирд╛ рдХреЛрд░</a> </li></ul></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓рд┐рдирдХреНрд╕ 2.6: рд▓реЛрдХрдкреНрд░рд┐рдпрддрд╛</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓рд┐рдирдХреНрд╕ 3.0: рдЖрдзреБрдирд┐рдХ рдУрдПрд╕</a> <br></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=">рд▓рд┐рдирдХреНрд╕ 4.14.67: рдирд╡реАрдирддрдо рдПрд▓рдЯреАрдПрд╕</a> </li></ul><br>  рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдХрд╣рд╛рдиреА рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рд╕рдВрджрд░реНрднреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдирд╣реАрдВ рд╣реИ, рдмрд▓реНрдХрд┐ рдПрдХ рдЫреЛрдЯреА рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╕реЗ рдЖрдзреБрдирд┐рдХ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд▓рд┐рдП рд▓рд┐рдирдХреНрд╕ рдХреЗ рд╡рд┐рдХрд╛рд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИред  рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдмрд╕ рдЗрд╕ рдХрд╣рд╛рдиреА рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред <br><br><h2>  рд╣рдо рдХрд┐рд╕ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрд╛рдд рдХрд░ рд░рд╣реЗ рд╣реИрдВ? </h2><br>  рдпрджреНрдпрдкрд┐ рдХрдИ рдЪреАрдЬреЗрдВ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдирд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХрд░реНрдиреЗрд▓ рдореЛрдб рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдирд╛, рдПрдХ рдмрд╛рдзрд╛ рд╣реИрдВрдбрд▓рд░ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдирд╛), рдореЗрд░рд╛ рдорддрд▓рдм рд╣реИ рдЖрдорддреМрд░ рдкрд░ рд╕реНрд╡реАрдХреГрдд рдЕрд░реНрде: <b>рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдмреАрдЪ рд╕реНрд╡рд┐рдЪ рдХрд░рдирд╛</b> ред  рд▓рд┐рдирдХреНрд╕ рдкрд░, рдпрд╣ <code>switch_to()</code> рдореИрдХреНрд░реЛ рдФрд░ рдЗрд╕рдореЗрдВ рд╕рдм рдХреБрдЫ рд╣реИред <br><br>  рдпрд╣ рдореИрдХреНрд░реЛ рджреЛ рдФрд░ рдЕрдзрд┐рдХ рджрд┐рд▓рдЪрд╕реНрдк рдкреНрд░рдгрд╛рд▓рд┐рдпреЛрдВ рдХреЗ рдмреАрдЪ рдПрдХ рд╕рд░рд▓ рдпрд╛рдВрддреНрд░рд┐рдХ рдХреНрд░рд┐рдпрд╛ рд╣реИ: рдПрдХ рдХрд╛рд░реНрдп рдЕрдиреБрд╕реВрдЪрдХ рдФрд░ рдПрдХ рд╕реАрдкреАрдпреВред  рдУрдПрд╕ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдореЗрдВ рдХрд╛рд░реНрдп рдпреЛрдЬрдирд╛ рд░рдгрдиреАрддрд┐рдпреЛрдВ рдХреЛ рдорд┐рд▓рд╛рдиреЗ рдФрд░ рд╕рдордиреНрд╡рдп рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИред  рд╕реАрдкреАрдпреВ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рднреА рд╡реНрдпрд╛рдкрдХ рд░реВрдк рд╕реЗ рдЦреБрд▓реЗ рд╣реИрдВ: рд▓рд┐рдирдХреНрд╕ рджрд░реНрдЬрдиреЛрдВ рдкреНрд░рдХрд╛рд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИред  рд▓реЗрдХрд┐рди рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдЙрдирдХреЗ рдмреАрдЪ рдХрд╛ рдЧрд┐рдпрд░ рд╣реИред  рдЗрд╕рдХрд╛ "рдбрд┐рдЬрд╝рд╛рдЗрди" рдЗрд╕рдХреЗ рдкрдбрд╝реЛрд╕рд┐рдпреЛрдВ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдУрдПрд╕ рдХрд╛ <i>рдХрдо</i> рд╕реЗ <i>рдХрдо</i> рджрд┐рд▓рдЪрд╕реНрдк рд╣рд┐рд╕реНрд╕рд╛ рд╣реЛрдиреЗ рдХрд╛ рджрд╛рд╡рд╛ рдХрд░рддрд╛ рд╣реИред  рдореИрдВ рджреЛрд╣рд░рд╛рддрд╛ рд╣реВрдВ: рд╡рд╣ рд╡рд╣реА рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдХрд░рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИред <br><br>  рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХрд╛рд░реНрдпреЛрдВ рдХреА рдПрдХ рдЫреЛрдЯреА рд╕реВрдЪреА: <br><br><ol><li>  рдХрд╛рд░реНрдпрдХреНрд╖реЗрддреНрд░ рдУрд╡рд░рд░рд╛рдЗрдб: рд╕реНрдЯреИрдХ рд░рд┐рдХрд╡рд░реА (рдПрд╕рдПрд╕: рдПрд╕рдкреА)ред <br></li><li>  рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рд░реНрджреЗрд╢ рдЦреЛрдЬреЗрдВ: IP рд░рд┐рдХрд╡рд░реА (CS: IP)ред <br></li><li>  рдЯрд╛рд╕реНрдХ рд╕реНрдЯреЗрдЯ рд░рд┐рдХрд╡рд░реА: рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рдпреЛрдЬрди рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреА рдмрд╣рд╛рд▓реАред <br></li><li>  рдореЗрдореЛрд░реА рдПрдбреНрд░реЗрд╕ рд╕реНрдкреЗрд╕ рд╕реНрд╡реИрдк рдХрд░рдирд╛: рдкреЗрдЬ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА (CR3) рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ <br></li><li>  ... рдФрд░ рдмрд╣реБрдд рдХреБрдЫ: рдПрдлрдкреАрдпреВ, рдУрдПрд╕ рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛рдПрдВ, рдбрд┐рдмрдЧ рд░рдЬрд┐рд╕реНрдЯрд░, рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╡рд░реНрдХрдЕрд░рд╛рдЙрдВрдб, рдЖрджрд┐ред </li></ol><br>  рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдЗрди рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХрдм рдФрд░ рдХрд╣рд╛рдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрджрд┐ рд╕реАрдкреАрдпреВ рдХрд┐рд╕реА рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд▓реЗрддрд╛ рд╣реИред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд▓рд┐рдирдХреНрд╕ 2.2 рд╕реЗ рдкрд╣рд▓реЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХрд╛рд░реНрдп 2, 3 рдХреЛ рдЫреБрдкрд╛рддрд╛ рд╣реИ, рдФрд░ 4. рдХрд░реНрдиреЗрд▓ рдореЛрдб рдХреЗ рдмреАрдЪ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рд╕реЗ рдЯрд╛рд╕реНрдХ 3 рд╕реАрдорд┐рдд рд╣реИред  рд╢реЗрдбреНрдпреВрд▓рд░ рд░рд┐рдЯрд░реНрди рдХреЗ рдмрд╛рдж рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдереНрд░реЗрдб рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рдПрдХ <code>iret</code> рдХрд╛рд░реНрдп рд╣реИред  рд╡рд┐рднрд┐рдиреНрди рдХрд░реНрдиреЗрд▓ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЗрдирдореЗрдВ рд╕реЗ рдХрдИ рдХрд╛рд░реНрдп <code>switch_to()</code> рдФрд░ рдЕрдиреБрд╕реВрдЪрдХ рдХреЗ рдмреАрдЪ <code>switch_to()</code> ред  рд╣рдо рдХреЗрд╡рд▓ рдЧрд╛рд░рдВрдЯреА рджреЗ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рд╣рдо рд╣рдореЗрд╢рд╛ рдПрдХ рд╕реНрдЯреИрдХ рд╕реНрд╡реИрдк рдФрд░ рдПрдлрдкреАрдпреВ рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рджреЗрдЦреЗрдВрдЧреЗред <br><br><h3>  рдпрд╣ рдХрд┐рд╕рдХреЗ рд▓рд┐рдП рд╣реИ? </h3><br>  рдХрд┐рд╕реА рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдирд╣реАрдВред  рд╕рдордЭрдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдХреЗрд╡рд▓ x86 рдХреЛрдбрд╛рдВрддрд░рдХ рдХреЛ рдЬрд╛рдирдирд╛ рд╣реЛрдЧрд╛ рдФрд░, рд╕рдВрднрд╡рддрдГ, OS рдбрд┐рдЬрд╝рд╛рдЗрди рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдиреНрдпреВрдирддрдо рд╢рд┐рдХреНрд╖рд╛ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред <br><br>  рдореБрдЭреЗ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">рддреБрд░рдВрдд</a> рдпрд╣ рдХрд╣рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдореИрдВ рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рдХрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">рдЕрдиреБрд░рдХреНрд╖рдХ</a> рдпрд╛ рдпреЛрдЧрджрд╛рдирдХрд░реНрддрд╛ рдирд╣реАрдВ рд╣реВрдВред  рдЗрди рдХрд╛рдорд░реЗрдбреЛрдВ рд╕реЗ рдпрд╛ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow">рдХрд░реНрдиреЗрд▓ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдореЗрд▓рд┐рдВрдЧ рд╕реВрдЪреА</a> рд╕реЗ рдХреЛрдИ рднреА рдЬрд╛рдирдХрд╛рд░реА рдЬреЛ рдореЗрд░реА рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╡рд┐рдкрд░реАрдд рд╣реИ, рдХреЛ рдЧрдВрднреАрд░рддрд╛ рд╕реЗ рд▓рд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  рдореЗрд░реЗ рдкрд╛рд╕ рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдкрд░рд┐рдпреЛрдЬрдирд╛ рд╣реИ, рди рдХрд┐ рдПрдХ рд╕рд╣рдХрд░реНрдореА рдХреА рд╕рдореАрдХреНрд╖рд╛ рдХреА рдЧрдИ рдкрддреНрд░рд┐рдХрд╛ рдореЗрдВ рдПрдХ рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ рд▓реЗрдЦред <br><br><a name="1"></a><h1>  1.0 рд╕реЗ рдкрд╣рд▓реЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд▓рд┐рдирдХреНрд╕: рдкреНрд░рд╛рдЪреАрди рдЗрддрд┐рд╣рд╛рд╕ (1991) </h1><br>  рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд▓рд┐рдирдХреНрд╕ рдХрд░реНрдиреЗрд▓ рд╕рд░рд▓ рдФрд░ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдореБрдЦ рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреА рдПрдХ рдЫреЛрдЯреА рд╕реВрдЪреА рд╣реИ: <br><br><ul><li>  рдПрдХрд▓ рд╡рд╛рд╕реНрддреБрдХрд▓рд╛ (80386 / i386): рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рдХрд╛рд░ рдХрд╛ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪред  рдХрдИ 80386 рд╕реБрд╡рд┐рдзрд╛рдПрдБ рдкреВрд░реЗ рдХреЛрд░ рдореЗрдВ рд╣рд╛рд░реНрдбрдХреЛрдб рдХреА рдЧрдИ рд╣реИрдВред  рдЗрди рднрд╛рдЧреЛрдВ рдХреЗ рд╕рдВрджрд░реНрдн рдХреЗ рд▓рд┐рдП, рдореИрдВрдиреЗ рдЗрдВрдЯреЗрд▓ 80386 рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдЧрд╛рдЗрдб (1986) рд▓рд┐рдпрд╛ред <br></li><li>  рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ: рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП, рдХрд░реНрдиреЗрд▓ рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рддрдВрддреНрд░ 80386 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред <br></li><li>  рдкреНрд░реАрдореЗрдкреНрдЯрд┐рд╡ рдорд▓реНрдЯреАрдЯрд╛рд╕реНрдХрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛: рдПрдХ рд╕рдордп рдореЗрдВ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдХреЗрд╡рд▓ рдПрдХ рд╕реАрдкреАрдпреВ рд╕рдХреНрд░рд┐рдп рд╣реЛрддрд╛ рд╣реИред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд┐рд╕реА рднреА рд╕рдордп рд╢реБрд░реВ рд╣реЛ рд╕рдХрддреА рд╣реИред  рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╕рд╛рдорд╛рдиреНрдп рддреБрд▓реНрдпрдХрд╛рд▓рди рдирд┐рдпрдо рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВ: рд╕рд╛рдЭрд╛ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рдирд╛ (рд╕реНрдкрд┐рди-рд▓реЙрдХ рдХреЗ рдмрд┐рдирд╛)ред  рдПрдХ рдЪрд░рдо рдорд╛рдорд▓реЗ рдореЗрдВ, рдЗрдВрдЯрд░рдкреНрдЯ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рд▓реЗрдХрд┐рди рдкрд╣рд▓реЗ рдореНрдпреВрдЯреЗрдХреНрд╕ рдХреЛ рд▓реЙрдХ рдХрд░рдиреЗ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/d58/0f8/1b3/d580f81b36718f5531ea3790fd00c8ab.png"><br><br>  рдЖрдЧреЗ рдХреА рд╣рд▓рдЪрд▓ рдХреЗ рдмрд┐рдирд╛, рджреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдкрд░ рдПрдХ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВред  рдХреЛрдб рдХреЛ рдмреЗрд╣рддрд░ рдкрдардиреАрдпрддрд╛ рдХреЗ рд▓рд┐рдП рд╕реНрд╡рд░реВрдкрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: рдирд┐рд░рдВрддрд░рддрд╛ рд╡рд░реНрдгреЛрдВ (\) рдХреЗ рдмрд┐рдирд╛ рдкреНрд░рддрд┐ рдкрдВрдХреНрддрд┐ рдПрдХ рддрддреНрд╡ред <br><br>  <b>рд▓рд┐рдирдХреНрд╕ 0.01</b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/linux/sched.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(n) { struct {long a,b;} __tmp; __asm__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %%ecx,_current\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"je 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"xchgl %%ecx,_current\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movw %%dx,%1\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ljmp %0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %%ecx,%2\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jne 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"clts\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:"</span></span></span><span class="hljs-meta"> ::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*&amp;__tmp.a), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*&amp;__tmp.b), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (last_task_used_math), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"d"</span></span></span><span class="hljs-meta"> _TSS(n), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"c"</span></span></span><span class="hljs-meta"> ((long) task[n])); }</span></span></code> </pre> <br>  <b>рд▓рд┐рдирдХреНрд╕ 0.11</b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/linux/sched.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(n) { struct {long a,b;} __tmp; __asm__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %%ecx,_current\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"je 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movw %%dx,%1\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"xchgl %%ecx,_current\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ljmp %0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %%ecx,_last_task_used_math\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jne 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"clts\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:"</span></span></span><span class="hljs-meta"> ::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*&amp;__tmp.a), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*&amp;__tmp.b), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"d"</span></span></span><span class="hljs-meta"> (_TSS(n)), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"c"</span></span></span><span class="hljs-meta"> ((long) task[n])); }</span></span></code> </pre> <br>  рддреБрд░рдВрдд рд╣рдбрд╝рддрд╛рд▓реА рд╡рд╣ рдХрд┐рддрдирд╛ рдЫреЛрдЯрд╛ рд╣реИ!  рдкреНрд░рддреНрдпреЗрдХ рдкрдВрдХреНрддрд┐ рдХреЛ рд╡реНрдпрдХреНрддрд┐рдЧрдд рд░реВрдк рд╕реЗ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЫреЛрдЯрд╛: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(n) {</span></span></code> </pre> <br>  рддреЛ <code>switch_to()</code> рдПрдХ рдореИрдХреНрд░реЛ рд╣реИред  рдпрд╣ рдмрд┐рд▓реНрдХреБрд▓ рдПрдХ рдЬрдЧрд╣ рдкрд░ рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИ: <code>schedule()</code> рдХреА рдЕрдВрддрд┐рдо рдкрдВрдХреНрддрд┐ <code>schedule()</code> ред  рдЗрд╕рд▓рд┐рдП, рдкреНрд░реАрдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рдХреЗ рдмрд╛рдж, рдореИрдХреНрд░реЛ рд╢реЗрдбреНрдпреВрд▓рд░ рдХреНрд╖реЗрддреНрд░ рдХреЛ рд╕рд╛рдЭрд╛ рдХрд░рддрд╛ рд╣реИред  рдЕрдЬреНрдЮрд╛рдд рд▓рд┐рдВрдХ рдХреЗ рд╡реИрд╢реНрд╡рд┐рдХ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдПрдХ рдЪреЗрдХ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ <code>current</code> рдФрд░ <code>last_task_used_math</code> ред  рдЗрдирдкреБрдЯ рддрд░реНрдХ <code>n</code> рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рдХреА рдЕрдиреБрдХреНрд░рдо рд╕рдВрдЦреНрдпрд╛ рд╣реИ (0 рд╕реЗ 63 рддрдХ)ред <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span><span class="hljs-keyword"><span class="hljs-keyword">long</span></span> a,b;} __tmp;</code> </pre> <br>  рд╕реНрдЯреИрдХ рдкрд░ 8 рдмрд╛рдЗрдЯреНрд╕ (64 рдмрд┐рдЯреНрд╕) рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрддрд╛ рд╣реИ, рджреЛ 4-рдмрд╛рдЗрдЯ рддрддреНрд╡реЛрдВ <code>a</code> рдФрд░ <code>b</code> рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реБрд▓рднред  рд╣рдо рд▓рдВрдмреА рдЫрд▓рд╛рдВрдЧ рдХреЗ рд╕рдВрдЪрд╛рд▓рди рдХреЗ рд▓рд┐рдП рдЗрдирдореЗрдВ рд╕реЗ рдХреБрдЫ рдмрд╛рдЗрдЯреНрд╕ рдХреЛ рдмрд╛рдж рдореЗрдВ рд╕реЗрдЯ рдХрд░реЗрдВрдЧреЗред <br><br><pre> <code class="cpp hljs">__asm__(<span class="hljs-string"><span class="hljs-string">"cmpl %%ecx,_current\n\t"</span></span></code> </pre> <br>  рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдЕрд╕реЗрдВрдмрд▓рд░ рдореЗрдВ рдПрдХ рд▓рдВрдмрд╛ рдЗрдирд▓рд╛рдЗрди рдмреНрд▓реЙрдХ рд╣реИред  рдкрд╣рд▓рд╛ рдирд┐рд░реНрджреЗрд╢ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд▓рдХреНрд╖реНрдп рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЪрд╛рд▓реВ рд╣реИред  рдпрд╣ рд╢реЗрдбреНрдпреВрд▓рд░ рд╕реЗ рд╡рд░реНрддрдорд╛рди <code>current</code> рдХреЗ рдореВрд▓реНрдп рдХреЗ рд╕рд╛рде рдИрд╕реАрдПрдХреНрд╕ рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рдореВрд▓реНрдп рдХреА рдПрдХ рдШрдЯрд┐рдпрд╛ рддреБрд▓рдирд╛ рд╣реИред  рджреЛрдиреЛрдВ рдореЗрдВ рдХреБрдЫ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ <code>task_struct</code> рд▓рд┐рдП рд╕рдВрдХреЗрдд рд╣реЛрддреЗ рд╣реИрдВред  ECX рдореЗрдВ рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд▓рдХреНрд╖реНрдп рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдВрдХреЗрддрдХ рд╣реИ: <code>"c" ((long) task[n])</code> ред  рддреБрд▓рдирд╛ рдкрд░рд┐рдгрд╛рдо рд╕реНрдерд┐рддрд┐ рд░рдЬрд┐рд╕реНрдЯрд░ EFLAGS рдХрд╛ рдореВрд▓реНрдп рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ: рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, ZF = 1 рдпрджрд┐ рджреЛрдиреЛрдВ рдмрд┐рдВрджреБрдУрдВ рдХрд╛ рдорд┐рд▓рд╛рди рд╣реЛрддрд╛ рд╣реИ (x - x = 0)ред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"je 1f\n\t"</span></span></code> </pre> <br>  рдпрджрд┐ рдЕрдЧрд▓рд╛ рдХрд╛рд░реНрдп рд╡рд░реНрддрдорд╛рди рдПрдХ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рд╕рдВрджрд░реНрдн рдХреЛ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЗрд╕ рдкреВрд░реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЫреЛрдбрд╝ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдП (рдХреВрджрдирд╛ рдЪрд╛рд╣рд┐рдП)ред  <code>je</code> рдирд┐рд░реНрджреЗрд╢ рдХреА рдЬрд╛рдБрдЪ рдХрд░рддрд╛ рд╣реИ рдХрд┐ ZF = 1. рдпрджрд┐ рдРрд╕рд╛ рд╣реИ, рддреЛ рдпрд╣ рдХреЛрдб рдореЗрдВ рдЗрд╕ рдмрд┐рдВрджреБ рдХреЗ рдмрд╛рдж рдкрд╣рд▓реЗ рд▓реЗрдмрд▓ '1' рдкрд░ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ 8 рд▓рд╛рдЗрдиреЛрдВ рд╕реЗ рдЖрдЧреЗ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"xchgl %%ecx,_current\n\t"</span></span></code> </pre> <br>  рдирдП рдХрд╛рд░реНрдп рдХреЛ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡реИрд╢реНрд╡рд┐рдХ <code>current</code> рдХреЛ рдЕрджреНрдпрддрди рдХрд░рддрд╛ рд╣реИред  ECX (рдХрд╛рд░реНрдп [n]) рд╕реЗ рд╕реВрдЪрдХ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИред  рдЭрдВрдбреЗ рдЕрдкрдбреЗрдЯ рдирд╣реАрдВ рдХрд┐рдП рдЧрдП рд╣реИрдВред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movw %%dx,%1\n\t"</span></span></code> </pre> <br>  рд▓рдХреНрд╖реНрдп рдЪрдпрдирдХрд░реНрддрд╛ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╕реЗрдЧрдореЗрдВрдЯ рдЪрдпрдирдХрд░реНрддрд╛ (TSS) рдЗрдВрдбреЗрдХреНрд╕ рдХреЛ рдкрд╣рд▓реЗ рд╕реЗ рдЖрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рди рдкрд░ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред  рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ, рдпрд╣ DX рд░рдЬрд┐рд╕реНрдЯрд░ рд╕реЗ <code>__tmp.b</code> рдкрд░ <code>__tmp.b</code> рдХреЛ <code>__tmp.b</code> рдХрд░рддрд╛ рд╣реИ, <code>__tmp.b</code> , рд╣рдорд╛рд░реА рдЖрд░рдХреНрд╖рд┐рдд 8-рдмрд╛рдЗрдЯ рд╕рдВрд░рдЪрдирд╛ рдХреЗ 8 рдореЗрдВ рд╕реЗ 5 рдмрд╛рдЗрдЯреНрд╕ред  рдбреАрдПрдХреНрд╕ рдорд╛рди рджрд┐рдпрд╛ рдЧрдпрд╛ рдЗрдирдкреБрдЯ рд╣реИ: <code>"d" (_TSS(n))</code> ред  рдмрд╣реБ-рд╕реНрддрд░реАрдп <code>_TSS</code> рдореИрдХреНрд░реЛ рдПрдХ рд╡реИрдз TSS рдЦрдВрдб рдЪрдпрдирдХрд░реНрддрд╛ рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореИрдВ рдереЛрдбрд╝реА рджреЗрд░ рдмрд╛рдж рдЪрд░реНрдЪрд╛ рдХрд░реВрдВрдЧрд╛ред  рд▓рдмреНрдмреЛрд▓реБрдЖрдм рдпрд╣ рд╣реИ рдХрд┐ рджреЛ рдЙрдЪреНрдЪ рдмрд╛рдЗрдЯреНрд╕ <code>__tmp.b</code> рдЕрдм рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реЗрдЧрдореЗрдВрдЯ рдкреЙрдЗрдВрдЯрд░ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"ljmp %0\n\t"</span></span></code> </pre> <br>  TSS рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдкрд░ рдЬрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ 80386 рд╣реИред  рдпрд╣ рд╕рд░рд▓ рдЫрд▓рд╛рдВрдЧ рднреНрд░рд╛рдордХ рд╣реЛ рд╕рдХрддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рддреАрди рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╡рд┐рдЪрд╛рд░ рд╣реИрдВ: рдкрд╣рд▓рд╛, <code>ljmp</code> рдПрдХ рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рд▓рдВрдмреА рдЫрд▓рд╛рдВрдЧ рд╣реИ рдЬрд┐рд╕рдореЗрдВ 6-рдмрд╛рдЗрдЯ (48-рдмрд┐рдЯ) рдСрдкрд░реЗрдВрдб рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред  рджреВрд╕рд░реЗ, рдСрдкрд░реЗрдВрдб% 0 рдХрд╛ рдЕрд░реНрде рд╣реИ <code>__tmp.</code> рдЪрд░ <code>__tmp.</code> ред  рдЕрдВрдд рдореЗрдВ, рдЬреАрдбреАрдЯреА рдореЗрдВ рдПрдХ рдЦрдВрдб рдЪрдпрдирдХрд░реНрддрд╛ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХрд╛ x86 рдореЗрдВ рд╡рд┐рд╢реЗрд╖ рдорд╣рддреНрд╡ рд╣реИред  рдЖрдЗрдП рдЗрди рдмрд┐рдВрджреБрдУрдВ рдкрд░ рдПрдХ рдирдЬрд░ рдбрд╛рд▓рддреЗ рд╣реИрдВред <br><br><h3>  рдЕрдкреНрд░рддреНрдпрдХреНрд╖ рджреВрд░ рдХрд╛ рд╕рдВрдХреНрд░рдордг </h3><br>  рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдВрджреБ рдпрд╣ рд╣реИ рдХрд┐ рдЗрд╕ рд╕рдВрдХреНрд░рдордг рдореЗрдВ 6-рдмрд╛рдЗрдЯ рдХрд╛ рд╕рдВрдЪрд╛рд▓рди рд╣реЛрддрд╛ рд╣реИред  80386 рдкреНрд░реЛрдЧреНрд░рд╛рдорд░ рдХреЗ рдЧрд╛рдЗрдб рдиреЗ рд╕рдВрдХреНрд░рдордг рдХрд╛ рд╡рд░реНрдгрди рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae5/fb3/676/ae5fb367632800feb6f59b53ee8d96c0.png"><br><br><h3>  __Tmp.a рдкрд░ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ </h3><br>  рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ <code>__tmp</code> рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рджреЛ 4-рдмрд╛рдЗрдЯ рдорд╛рди рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдФрд░ рд╕рдВрд░рдЪрдирд╛ <code>a</code> рдкрд░ рдЖрдзрд╛рд░рд┐рдд <code>a</code> ред  рд▓реЗрдХрд┐рди рдЕрдЧрд░ рд╣рдо рдЗрд╕ рддрддреНрд╡ рдХреЛ 6-рдмрд╛рдЗрдЯ рдСрдкрд░реЗрдВрдб рдХреЗ рдЖрдзрд╛рд░ рдкрддреЗ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдкреВрд░реНрдгрд╛рдВрдХ <code>__tmp.b</code> <b>рдЕрдВрджрд░</b> рджреЛ рдмрд╛рдЗрдЯреНрд╕ рддрдХ рдкрд╣реБрдВрдЪ <code>__tmp.b</code> ред  рдпреЗ рджреЛ рдмрд╛рдЗрдЯреНрд╕ рджреВрд░ рдкрддреЗ рдХреЗ "рд╕реЗрдЧрдореЗрдВрдЯ рд╕реЗрд▓реЗрдХреНрдЯрд░" рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИрдВред  рдЬрдм рдкреНрд░реЛрд╕реЗрд╕рд░ рджреЗрдЦрддрд╛ рд╣реИ рдХрд┐ рдЬреАрдбреАрдЯреА рдореЗрдВ рд╕реЗрдЧрдореЗрдВрдЯ рдЯреАрдПрд╕рдПрд╕ рд╣реИ, рддреЛ рдСрдлрд╕реЗрдЯ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдирдЬрд░рдЕрдВрджрд╛рдЬ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ <code>__tmp.a</code> рдХреЛ рдЖрд░рдВрднреАрдХреГрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд╕реЗ рдХреЛрдИ рдлрд░реНрдХ рдирд╣реАрдВ рдкрдбрд╝рддрд╛, рдХреНрдпреЛрдВрдХрд┐ <code>__tmp.b</code> рдЕрднреА рднреА рдкрд┐рдЫрд▓реЗ <code>movw</code> рдирд┐рд░реНрджреЗрд╢ рдХреЗ рд▓рд┐рдП рдПрдХ рдорд╛рдиреНрдп рдореВрд▓реНрдп рд╣реИред  рдЖрд░реЗрдЦ рдореЗрдВ рд╕рдВрдХреНрд░рдордг рдкрддрд╛ рдЬреЛрдбрд╝реЗрдВ: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c02/e5a/974/c02e5a974ab3b2c6f907564b1316a0cf.png"><br><br>  рд╣рдореЗрдВ рдХреИрд╕реЗ рдкрддрд╛ рдЪрд▓реЗрдЧрд╛ рдХрд┐ рдпрд╣ рдкрддрд╛ GDT рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ?  рдореИрдВ рдХреЛрдб рдХреА рдЕрдиреНрдп рдкрдВрдХреНрддрд┐рдпреЛрдВ рдореЗрдВ рд╡рд┐рд╡рд░рдг рдкреНрд░рдХрдЯ рдХрд░реВрдВрдЧрд╛, рд▓реЗрдХрд┐рди рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╕рдВрд╕реНрдХрд░рдг рдпрд╣ рд╣реИ рдХрд┐ рдЪрдпрдирдХрд░реНрддрд╛ рдореЗрдВ рдЪрд╛рд░ рд╢реВрдиреНрдп рдмрд┐рдЯреНрд╕ рдЬреАрдбреАрдЯреА рдЦреЛрдЬ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рддреЗ рд╣реИрдВред  <code>_TSS(n)</code> рдореИрдХреНрд░реЛ рдЗрди рдЪрд╛рд░ рд╢реВрдиреНрдп рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдХреА рдЧрд╛рд░рдВрдЯреА рджреЗрддрд╛ рд╣реИред  рдирд┐рдЪрд▓реЗ рджреЛ рдмрд┐рдЯ рдЦрдВрдб рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реНрддрд░ (00 рдкрд░реНрдпрд╡реЗрдХреНрд╖рдХ / рдХрд░реНрдиреЗрд▓ рд╕реЗ рдореЗрд▓ рдЦрд╛рддреЗ рд╣реИрдВ), рдЕрдЧрд▓реЗ рд╢реВрдиреНрдп рдмрд┐рдЯ рдХрд╛ рдорддрд▓рдм рд╣реИ GDT рддрд╛рд▓рд┐рдХрд╛ (рдмреВрдЯ рд╕рдордп рдкрд░ GDTR рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд)ред  рдЪреМрдерд╛ рд╢реВрдиреНрдп рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ рд╕реЗрдЧрдореЗрдВрдЯ рдЗрдВрдбреЗрдХреНрд╕ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИ, рдЬреЛ рд╕рднреА TSS рдХреЛ GDT рддрд╛рд▓рд┐рдХрд╛ рдХреА рд╕рдорд╛рди рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдкрд░ рдордЬрдмреВрд░ рдХрд░рддрд╛ рд╣реИред <br><br><h3>  рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ </h3><br>  <code>__tmp</code> рдореЗрдВ рдЬрдВрдк рдПрдбреНрд░реЗрд╕ GDT рдореЗрдВ TSS рд╣реИрдВрдбрд▓ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИред  рдпрд╣рд╛рдБ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдпрд╣ 80386 рдХреЗ рдореИрдиреБрдЕрд▓ рдореЗрдВ рдХреИрд╕реЗ рд╡рд░реНрдгрд┐рдд рд╣реИ: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b1c/014/050/b1c014050e704604c7064c14e33af920.png"><br><br>  рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдирд┐рдореНрди рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ: <br><br><ul><li>  рдЬрд╛рдБрдЪ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╡рд░реНрддрдорд╛рди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╕реНрддрд░ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ (рд╣рдо рдХрд░реНрдиреЗрд▓ рдореЛрдб рдореЗрдВ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╕рдм рдХреБрдЫ рдареАрдХ рд╣реИ)ред <br></li><li>  рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ TSS рдорд╛рдиреНрдп рд╣реИ (рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП)ред <br></li><li>  рдХрд╛рд░реНрдп рд░рдЬрд┐рд╕реНрдЯрд░ (TR) рдореЗрдВ рдЕрднреА рднреА рд╕рдВрдЧреНрд░рд╣реАрдд рдкреБрд░рд╛рдиреЗ TSS рдореЗрдВ рд╕рднреА рд╡рд░реНрддрдорд╛рди рдХрд╛рд░реНрдп рд╕реНрдерд┐рддрд┐ рдХреЛ рдмрдЪрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ EAX, ECX, EDX, EBX, ESP, EBP, ESP, ESI, EDI, ES, CS, SS, DS, FS, рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ рдЬреАрдПрд╕ рдФрд░ EFLAGSред  рдИрдЖрдИрдкреА рдХреЛ рдЕрдЧрд▓реЗ рдирд┐рд░реНрджреЗрд╢ рдкрд░ рдмрдврд╝рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдмрдЪрд╛рдпрд╛ рднреА рдЬрд╛рддрд╛ рд╣реИред <br></li><li>  рдирдП рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП TR рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИред <br></li><li>  рд╕рднреА рд╕рд╛рдорд╛рдиреНрдп рд░рдЬрд┐рд╕реНрдЯрд░, EIP рдФрд░ PDBR (рд╕реНрд╡реИрдк рдПрдбреНрд░реЗрд╕ рд╕реНрдкреЗрд╕) рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред  рдХрд╛рд░реНрдп рд╕реНрд╡рд┐рдЪ рд╕рдорд╛рдкреНрдд рд╣реЛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП TS рдлреНрд▓реИрдЧ рдХреЛ CR0 рд░рдЬрд┐рд╕реНрдЯрд░ рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </li></ul><br>  рддреЛ, рдХреЗрд╡рд▓ рдирд┐рд░реНрджреЗрд╢ <code>"ljmp %0\n\t"</code> рд▓рд┐рдпрд╛ рдФрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рд╕рднреА рдЪрд░рдгреЛрдВ рдХреЛ рдкреВрд░рд╛ рдХрд┐рдпрд╛ред  рдпрд╣ рдХреЗрд╡рд▓ рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"cmpl %%ecx,%2\n\t"</span></span></code> </pre> <br>  рд╣рдо рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ рдкрд┐рдЫрд▓реЗ рдХрд╛рд░реНрдп рдиреЗ рдЧрдгрд┐рддреАрдп рд╕рд╣рд╕рдВрд╕рд╛рдзрдХ рдХреЛ рдмрд╣рд╛рд▓ рдХрд┐рдпрд╛ рдерд╛ред  рддрд░реНрдХ <code>last_task_used_math</code> рд╕реВрдЪрдХ рд╣реИред  рдЯреАрдПрд╕ рдзреНрд╡рдЬ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдХреЙрдкрд░рдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рдПрдХ рдЕрд▓рдЧ рд╕рдВрджрд░реНрдн рд╣реИред  рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"jne 1f\n\t"</span></span></code> </pre> <br>  рдпрджрд┐ рдЕрдВрддрд┐рдо рдХрд╛рд░реНрдп рдХреЙрдкреАрдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рдЕрдВрдд рдореЗрдВ рдЬрд╛рдПрдВред  рд╣рдо рдЯреАрдПрд╕ рдзреНрд╡рдЬ рдХреЛ рдЫреЛрдбрд╝рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЕрдЧрд▓реА рдмрд╛рд░ рдЬрдм рдЖрдк рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ, рддреЛ рдЖрдк рдЖрд▓рд╕реА рд╕рдлрд╛рдИ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  "рдЖрд▓рд╕реА," рдХреНрдпреЛрдВрдХрд┐ рд╣рдордиреЗ рдХрд╛рд░реНрдп рдХреЛ рддрдм рддрдХ рдХреЗ рд▓рд┐рдП рдмрдВрдж рдХрд░ рджрд┐рдпрд╛ рд╣реИ рдЬрдм рддрдХ рдХрд┐ рдпрд╣ рдмрд┐рд▓реНрдХреБрд▓ рдЖрд╡рд╢реНрдпрдХ рди рд╣реЛ рдЬрд╛рдПред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"clts\n"</span></span></code> </pre> <br>  рдЯреАрдПрд╕ рдзреНрд╡рдЬ рдХреЛ рд╕рд╛рдлрд╝ рдХрд░реЗрдВ рдпрджрд┐ рдЕрдВрддрд┐рдо рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдиреЗ рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдмрд╣рд╛рд▓ рдХрд┐рдпрд╛ред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"1:"</span></span></code> </pre> <br>  рдкреНрд░рд╕рдВрдЧ рд╕реНрд╡рд┐рдЪ рдПрдВрдб рдорд╛рд░реНрдХред  рдЗрд╕ рд▓реЗрдмрд▓ рдХреЗ рд╕рднреА рдЬрдВрдк рдХреБрдЫ рдпрд╛ рд╕рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдЫреЛрдбрд╝ рджреЗрддреЗ рд╣реИрдВред <br><br><pre> <code class="cpp hljs">::<span class="hljs-string"><span class="hljs-string">"m"</span></span> (*&amp;__tmp.a),</code> </pre> <br>  рдЗрд╕ рдЕрд╕реЗрдВрдмрд▓рд░ рдмреНрд▓реЙрдХ рдореЗрдВ рдХреЛрдИ рдЖрдЙрдЯрдкреБрдЯ рдирд╣реАрдВ рд╣реИ, рдФрд░ рдкрд╣рд▓рд╛ рдЗрдирдкреБрдЯ (% 0) GDT рдореЗрдВ TSS рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд▓рд┐рдП рд╕реБрджреВрд░ рд╕реВрдЪрдХ рдХреЗ рдкрд╣рд▓реЗ рдЪрд╛рд░ рдмрд╛рдЗрдЯреНрд╕ рдХреА рд╕реНрдореГрддрд┐ рдореЗрдВ рд╕реНрдерд╛рди рд╣реИред  рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреЗрд╡рд▓ рдкрддреЗ рдХреЗ рд╕рдВрджрд░реНрдн рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдорд╛рди рдЖрд░рдВрдн рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"m"</span></span> (*&amp;__tmp.b),</code> </pre> <br>  рджреВрд╕рд░рд╛ рдЗрдирдкреБрдЯ (% 1) TSS рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд▓рд┐рдП рд╕реБрджреВрд░ рд╕реВрдЪрдХ рдХреЗ рдмрд╛рдЗрдЯреНрд╕ 5 рдФрд░ 6 рдХреА рд╕реНрдореГрддрд┐ рдореЗрдВ рд╕реНрдерд╛рди рд╣реИред  рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ, рдпрд╣ рд╕реНрдерд╛рди рдореЗрдореЛрд░реА рдореЗрдВ рдЪрд╛рд░ рдмрд╛рдЗрдЯреНрд╕ рд░рдЦрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдХреЗрд╡рд▓ рдкрд╣рд▓реЗ рджреЛ рдХреЛ рдЪреЗрдХ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"m"</span></span> (last_task_used_math),</code> </pre> <br>  рддреАрд╕рд░рд╛ рдЗрдирдкреБрдЯ (% 2) рдкреЙрдЗрдВрдЯрд░ рдХреА рдпрд╛рдж рдореЗрдВ рдЖрдЦрд┐рд░реА <code>task_struct</code> , рдЬрд┐рд╕рдиреЗ <code>task_struct</code> рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдмрд╣рд╛рд▓ рдХрд┐рдпрд╛ред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"d"</span></span> (_TSS(n)),</code> </pre> <br>  рдЪреМрдерд╛ рдЗрдирдкреБрдЯ (% 3 / %% edx) GDT рдореЗрдВ TSS рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╕реЗрдЧрдореЗрдВрдЯ рдЪрдпрдирдХрд░реНрддрд╛ рдХрд╛ рдкрддрд╛ рд╣реИред  рдЖрдЗрдП рдореИрдХреНрд░реЛ рдкрд░ рдПрдХ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВ: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _TSS(n) ((((unsigned long) n)&lt;&lt;4)+(FIRST_TSS_ENTRY&lt;&lt;3)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> FIRST_TSS_ENTRY 4</span></span></code> </pre> <br>  рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рд╣реИ рдХрд┐ рдкрд╣рд▓рд╛ TSS рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ 4 рд╡рд╛рдВ рд░рд┐рдХреЙрд░реНрдб рд╣реИ (рдЗрдВрдбреЗрдХреНрд╕ рдХреА рд╢реБрд░реБрдЖрдд рд╕реЗрдЧрдореЗрдВрдЯ рдЪрдпрдирдХрд░реНрддрд╛ рдХреЗ 4 рдмрд┐рдЯ рдХреЗ рд╕рд╛рде рд╣реЛрддреА рд╣реИ)ред  рдкреНрд░рддреНрдпреЗрдХ рдмрд╛рдж рдХреЗ рдЯреАрдПрд╕рдПрд╕ рдкреНрд░рддреНрдпреЗрдХ рджреВрд╕рд░реЗ рдЬреАрдбреАрдЯреА рд░рд┐рдХреЙрд░реНрдб рдкрд░ рдХрдмреНрдЬрд╛ рдХрд░ рд▓реЗрддрд╛ рд╣реИ: 4, 6, 8, рдЖрджрд┐ред рдкрд╣рд▓реЗ рдЖрда рдХрд╛рд░реНрдп рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддреЗ рд╣реИрдВ: <br><br><table border="0"><thead><tr><th>  рдЯрд╛рд╕реНрдХ # </th><th>  16-рдмрд┐рдЯ рдЦрдВрдб рдЪрдпрдирдХрд░реНрддрд╛ </th></tr></thead><tbody><tr><td>  0 </td><td>  0000000000100 0 00 </td></tr><tr><td>  1 </td><td>  0000000000110 0 00 </td></tr><tr><td>  2 </td><td>  0000000001000 0 00 </td></tr><tr><td>  3 </td><td>  0000000001010 0 00 </td></tr><tr><td>  4 </td><td>  0000000001100 0 00 </td></tr><tr><td>  5 </td><td>  0000000001110 0 00 </td></tr><tr><td>  6 </td><td>  0000000010000 0 00 </td></tr><tr><td>  7 </td><td>  0000000010010 0 00 </td></tr></tbody></table><br>  рдкрддрд╛ рдмрд┐рдЯреНрд╕ рдХреЛ рдлрд╝реАрд▓реНрдб рдкреНрд░рд╛рд░реВрдк рджреНрд╡рд╛рд░рд╛ рдЕрд▓рдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ 80386 рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/600/837/d6d/600837d6d6710747e269775a515658b6.png"><br><br>  рдЪрд╛рд░ рдХрдо рд╕реЗ рдХрдо рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрд┐рдЯ рд╣рдореЗрд╢рд╛ рд╢реВрдиреНрдп рд╣реЛрддреЗ рд╣реИрдВ, рдЬреЛ рдкрд░реНрдпрд╡реЗрдХреНрд╖рдХ рдореЛрдб, рдЬреАрдбреАрдЯреА рддрд╛рд▓рд┐рдХрд╛ рд╕реЗ рдореЗрд▓ рдЦрд╛рддреА рд╣реИ, рдФрд░ рдЬреАрдбреАрдЯреА рд╕реВрдЪрдХрд╛рдВрдХ рдХреА рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЛ рднреА рдмрд╛рдзреНрдп рдХрд░рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"c"</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">long</span></span>) task[n]));</code> </pre> <br>  рдЕрдВрддрд┐рдо рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ (% 4 /% ecx) рдирдП рдЯрд╛рд╕реНрдХ_рд╕реНрдЯреНрд░реИрдХ рдХрд╛ рдПрдХ рд╕рдВрдХреЗрддрдХ рд╣реИ, рдЬрд┐рд╕реЗ рд╣рдо рд╕реНрд╡рд┐рдЪ рдХрд░рддреЗ рд╣реИрдВред  рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рд╕реЗ рдареАрдХ рдкрд╣рд▓реЗ %% ecx рдорд╛рди рдкрд┐рдЫрд▓реЗ рдХрд╛рд░реНрдп рдореЗрдВ рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИред <br><br><h3>  0.01 рдФрд░ 0.11 рдХреЗ рдмреАрдЪ рдЕрдВрддрд░ </h3><br>  рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рдмреАрдЪ рджреЛ рдЕрдВрддрд░ рд╣реИрдВред  рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рд╕рд░рд▓ рдХреЛрдб рд╕рдлрд╛рдИ рд╣реИ, рдФрд░ рджреВрд╕рд░рд╛ рдЖрдВрд╢рд┐рдХ рддреНрд░реБрдЯрд┐ рд╕реБрдзрд╛рд░ рд╣реИред <br><br><ul><li>  <code>_last_task_used_math</code> рдЗрдирдкреБрдЯ рдЪрд░ рдХреЗ рд░реВрдк <code>_last_task_used_math</code> рд╣рдЯрд╛ рджрд┐рдпрд╛ <code>_last_task_used_math</code> рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рддреАрдХ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╡реИрд╢реНрд╡рд┐рдХ рджрд╛рдпрд░реЗ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред  рд╕рдВрдмрдВрдзрд┐рдд рддреБрд▓рдирд╛ рдСрдкрд░реЗрд╢рди рдХреЛ рд╕реАрдзрд╛ рд▓рд┐рдВрдХ рдореЗрдВ рдмрджрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред <br></li><li>  <code>xchgl</code> рдирд┐рд░реНрджреЗрд╢ рдХреЛ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ ( <code>ljmp</code> ) рдХреЗ рдХрд░реАрдм рд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП <code>xchgl</code> рд╕рд╛рде рд╕реНрд╡реИрдк рдХрд┐рдпрд╛ рдЧрдпрд╛ред  рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдпреЗ рдСрдкрд░реЗрд╢рди рдкрд░рдорд╛рдгреБ рдирд╣реАрдВ рд╣реИрдВ: рдпрд╣ рд╕рдВрднрд╛рд╡рдирд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ <code>xchgl</code> рдФрд░ <code>ljmp</code> рдмреАрдЪ рдПрдХ рд╡реНрдпрд╡рдзрд╛рди рдЙрддреНрдкрдиреНрди рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рдЧрд▓рдд <code>current</code> рдХрд╛рд░реНрдп рдФрд░ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдХрд╛рд░реНрдп рдХреЗ рдмрд┐рдирд╛ рд╕рд╣реЗрдЬреЗ рдЧрдП рд╕реНрдерд┐рддрд┐ рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЛ рдЬрдиреНрдо рджреЗрдЧрд╛ред  рдЗрди рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдпрд╣ рд╕реНрдерд┐рддрд┐ рдмрд╣реБрдд рдХрдо рд╣реЛ рдЬрд╛рддреА рд╣реИред  рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдгрд╛рд▓реА рдореЗрдВ рдпрд╣ "рдмрд╣реБрдд рдХрдо рд╕рдВрднрд╛рд╡рдирд╛" рд╣реИ - "рдЕрдкрд░рд┐рд╣рд╛рд░реНрдп" рдХрд╛ рдПрдХ рдкрд░реНрдпрд╛рдпред </li></ul><br><a name="2"></a><h1>  рд▓рд┐рдирдХреНрд╕ 1.x: рдЕрд╡рдзрд╛рд░рдгрд╛ рдХрд╛ рдкреНрд░рдорд╛рдг </h1><br>  0.11 рдФрд░ 1.0 рдХреЗ рдмреАрдЪ рдПрдХ рд╡рд░реНрд╖ рдореЗрдВ рд▓рдЧрднрдЧ 20 рдкреИрдЪ рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рдереЗред  рдЕрдзрд┐рдХрд╛рдВрд╢ рдкреНрд░рдпрд╛рд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдбреНрд░рд╛рдЗрд╡рд░реЛрдВ, рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рдереЗред  рдХрд╛рд░реНрдпреЛрдВ рдХреА рдЕрдзрд┐рдХрддрдо рд╕рдВрдЦреНрдпрд╛ 128 рд╣реЛ рдЧрдИ рд╣реИ, рд▓реЗрдХрд┐рди рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдореЗрдВ рдХрдИ рдореВрд▓рднреВрдд рдкрд░рд┐рд╡рд░реНрддрди рдирд╣реАрдВ рд╣реБрдП рд╣реИрдВред <br><br><h2>  рд▓рд┐рдирдХреНрд╕ 1.0 </h2><br>  рд▓рд┐рдирдХреНрд╕ 1.0 рдЕрднреА рднреА рдПрдХ рд╣реА рд╕реАрдкреАрдпреВ рдкрд░ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдЪрд▓рддрд╛ рд╣реИ, рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдПред <br><br><img src="https://habrastorage.org/getpro/habr/post_images/963/c40/196/963c40196485c16d16d5d53c8d15c910.png"><br><br>  <b>рд▓рд┐рдирдХреНрд╕ 1.0</b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/linux/sched.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(tsk) __asm__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %%ecx,_current\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"je 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cli\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"xchgl %%ecx,_current\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ljmp %0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sti\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %%ecx,_last_task_used_math\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jne 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"clts\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:"</span></span></span><span class="hljs-meta"> : </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* no output */</span></span></span><span class="hljs-meta"> :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*(((char *)&amp;tsk-&gt;tss.tr)-4)), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"c"</span></span></span><span class="hljs-meta"> (tsk) :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cx"</span></span></span><span class="hljs-meta">)</span></span></code> </pre> <br>  рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкрд░рд┐рд╡рд░реНрддрди рдпрд╣ рдерд╛ рдХрд┐ рдЗрдирдкреБрдЯ рддрд░реНрдХ рдХрд╛рд░реНрдп_ рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд╕рд░рдгреА рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдп рд╕рдВрдЦреНрдпрд╛ рд╕реВрдЪрдХрд╛рдВрдХ рдирд╣реАрдВ рд░рд╣ рдЧрдпрд╛ рд╣реИред  рдЕрдм <code>switch_to()</code> рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдПрдХ рдирдП рдХрд╛рд░реНрдп рдореЗрдВ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред  рддреЛ рдЖрдк <code>__tmp</code> рд╕рдВрд░рдЪрдирд╛ рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдЗрд╕рдХреЗ рдмрдЬрд╛рдп TSS рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реАрдзрд╛ рд▓рд┐рдВрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рдЖрдЗрдП рдкреНрд░рддреНрдпреЗрдХ рдкрдВрдХреНрддрд┐ рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВред <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(tsk)</span></span></code> </pre> <br>  рдЗрдирдкреБрдЯ рдЕрдм рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рдХреЛ task_struct рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЙрдЗрдВрдЯрд░ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"__asm__("</span></span>cmpl %%ecx,_current\n\t<span class="hljs-string"><span class="hljs-string">"</span></span></code> </pre> <br>  рдмрджрд▓рд╛ рдирд╣реАрдВ рдЧрдпрд╛ред  рдЬрд╛рдБрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЗрдирдкреБрдЯ рдХрд╛рд░реНрдп рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдЪрд╛рд▓реВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдХрд┐рд╕реА рд╕реНрд╡рд┐рдЪ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"je 1f\n\t"</span></span></code> </pre> <br>  рдмрджрд▓рд╛ рдирд╣реАрдВ рдЧрдпрд╛ред  рд╕реНрд╡рд┐рдЪ рдирд╣реАрдВ рд╣реЛрдиреЗ рдкрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХрд░рдирд╛ рдЫреЛрдбрд╝ рджреЗрдВред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"cli\n\t"</span></span></code> </pre> <br>  рд╡реНрдпрд╡рдзрд╛рдиреЛрдВ рдХреЛ рдмрд╛рдзрд┐рдд рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдПрдХ рд╡реИрд╢реНрд╡рд┐рдХ рдХрд╛рд░реНрдп рдФрд░ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдиреЗ рдХреЗ рдмреАрдЪ рдЯрд╛рдЗрдорд░ (рдпрд╛ рдХреЛрдИ рдФрд░) рджреБрд░реНрдШрдЯрдирд╛рдЧреНрд░рд╕реНрдд рди рд╣реЛред  рдпрд╣ рд░реБрдХрд╛рд╡рдЯ рдмреИрдВрд╣рдорд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рджреЛ рдирд┐рд░реНрджреЗрд╢ (рдЫрджреНрдо) рдкрд░рдорд╛рдгреБ рдмрдирд╛рдХрд░ рд╢реБрд░реБрдЖрддреА рдХрд░реНрдиреЗрд▓ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреА рд╕рдорд╕реНрдпрд╛ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"xchgl %%ecx,_current\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"ljmp %0\n\t"</span></span></code> </pre> <br>  рдХреЛрдИ рдкрд░рд┐рд╡рд░реНрддрди рдирд╣реАрдВ: рдирдП рдХрд╛рд░реНрдп рдХреЛ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рдХрд░рдиреЗ рдФрд░ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реНрд╡реИрдк рдХрд░реЗрдВред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"sti\n\t"</span></span></code> </pre> <br>  рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИ рдкрд░ рд╡рд╛рдкрд╕ рд╡реНрдпрд╡рдзрд╛рдиред <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"cmpl %%ecx,_last_task_used_math\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"jne 1f\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"clts\n"</span></span> <span class="hljs-string"><span class="hljs-string">"1:"</span></span></code> </pre> <br>  рд▓рд┐рдирдХреНрд╕ 0.11 рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рд╕рдм рдХреБрдЫ рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд рд╣реИред  рдЯреАрдПрд╕ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкрд┐рдЫрд▓реЗ рдХрд╛рд░реНрдп рд╕реЗ рдЧрдгрд┐рддреАрдп рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд╕рдорд╛рд╢реЛрдзрди рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХрд░рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs">: <span class="hljs-comment"><span class="hljs-comment">/* no output */</span></span></code> </pre> <br>  рдЗрд╕ рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ рдХрд╛ рдХреЛрдИ рдЖрдЙрдЯрдкреБрдЯ рдирд╣реАрдВ рд╣реИ - рдХрд░реНрдиреЗрд▓ рдХреЗ рдкреБрд░рд╛рдиреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдХреА рдХрдореА рд╕реЗ рдХреЛрдИ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдирд╛рд░рд╛рдЬ рдерд╛ред <br><br><pre> <code class="cpp hljs">:<span class="hljs-string"><span class="hljs-string">"m"</span></span> (*(((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)&amp;tsk-&gt;tss.tr)<span class="hljs-number"><span class="hljs-number">-4</span></span>)),</code> </pre> <br>  рдПрдХ рдирдП рдХрд╛рд░реНрдп рдХреЗ TSS рд╡рд┐рд╡рд░рдгрдХ рдХреЗ рд▓рд┐рдП рдПрдХ рдЦрдВрдб рдЪрдпрдирдХрд░реНрддрд╛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЕрдм task_struct рд╕реВрдЪрдХ рд╕реЗ рд╕реАрдзреЗ рдкрд╣реБрдБрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред  <code>tss.tr</code> рддрддреНрд╡ рдореЗрдВ GDT / TSS рдореЗрдореЛрд░реА рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ _TSS (task_number) рд╣реИ рдЬреЛ рдХрд░реНрдиреЗрд▓ рдореЗрдВ 1.0 рд╕реЗ рдкрд╣рд▓реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред  рд╣рдо рдЕрднреА рднреА 4 рдмрд╛рдЗрдЯреНрд╕ рд╕реЗ рд╡рд╛рдкрд╕ рдЖрддреЗ рд╣реИрдВ рдФрд░ рд╢реАрд░реНрд╖ рджреЛ рдмрд╛рдЗрдЯреНрд╕ рд▓реЗрдиреЗ рдХреЗ рд▓рд┐рдП 6-рдмрд╛рдЗрдЯ рд╕реЗрдЧрдореЗрдВрдЯ рдЪрдпрдирдХрд░реНрддрд╛ рдХреЛ рд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВред  рдордЬрд╛ рдЖ рдЧрдпрд╛! <br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"c"</span></span> (tsk)</code> </pre> <br>  рд▓рдЧрднрдЧ рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд - рдЕрдм рд╣рдо рд╕реАрдзреЗ рд╕реВрдЪрдХ рдХреЛ рд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдЗрдВрдбреЗрдХреНрд╕ рдХреА рддрд▓рд╛рд╢ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред <br><br><pre> <code class="cpp hljs">:<span class="hljs-string"><span class="hljs-string">"cx"</span></span>)</code> </pre> <br>  рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдИрд╕реАрдПрдХреНрд╕ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рддрд╛ рд╣реИред <br><br><h2>  рд▓рд┐рдирдХреНрд╕ 1.3 </h2><br>  рдХрд░реНрдиреЗрд▓ рдЕрдм рдХрдИ рдирдП рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ: рдЕрд▓реНрдлрд╛, рдПрдордЖрдЗрдкреАрдПрд╕ рдФрд░ рд╕реНрдкрд╛рд░реНрдХред  рдЗрд╕рд▓рд┐рдП, <code>switch_to()</code> рдЪрд╛рд░ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╕рдВрд╕реНрдХрд░рдг рд╣реИрдВ, рдЬрд┐рдирдореЗрдВ рд╕реЗ рдПрдХ рдХрд░реНрдиреЗрд▓ рдХреЛ рд╕рдВрдХрд▓рд┐рдд рдХрд░рддреЗ рд╕рдордп рд╢рд╛рдорд┐рд▓ рд╣реИред  рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░-рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреЛрдб рдХреЛ рдХрд░реНрдиреЗрд▓ рд╕реЗ рдЕрд▓рдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдХрд╣реАрдВ рдФрд░ x86 рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред <br><br>  <b>рд▓рд┐рдирдХреНрд╕ 1.3</b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/asm-i386/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(tsk) do { __asm__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cli\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"xchgl %%ecx,_current\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ljmp %0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sti\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %%ecx,_last_task_used_math\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jne 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"clts\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:"</span></span></span><span class="hljs-meta"> : </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* no output */</span></span></span><span class="hljs-meta"> :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*(((char *)&amp;tsk-&gt;tss.tr)-4)), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"c"</span></span></span><span class="hljs-meta"> (tsk) :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cx"</span></span></span><span class="hljs-meta">); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(current-&gt;debugreg[7]){ loaddebug(0); loaddebug(1); loaddebug(2); loaddebug(3); loaddebug(6); } } while (0)</span></span></code> </pre> <br>  рдХреБрдЫ рдЫреЛрдЯреЗ рдкрд░рд┐рд╡рд░реНрддрди: рдкреВрд░реЗ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЛ рдирдХрд▓реА рдбреВ-рдЯрд╛рдЗрдо рд▓реВрдк рдореЗрдВ рд▓рдкреЗрдЯрд╛ рдЧрдпрд╛ рд╣реИред  Feykov рдХреНрдпреЛрдВрдХрд┐ рд╡рд╣ рдХрднреА рдирд╣реАрдВ рджреЛрд╣рд░рд╛рддрд╛ рд╣реИред  рд╕реА рдореЗрдВ рдПрдХ рдирдпрд╛ рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреА рдЬрд╛рдВрдЪ рд╕реА рдореЗрдВ sheduler рдХреЛрдб рдХреЗ рд▓рд┐рдП <code>switch_to()</code> рд╕реЗ рдЪрд▓реА рдЧрдИ рд╣реИред рдХреБрдЫ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ C рдХреЛрдб рд╕реЗ <code>switch_to ()</code> рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╕рдВрднрд╡рддрдГ рдЙрдиреНрд╣реЗрдВ рдЕрд▓рдЧ рдХрд░рдиреЗ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдПред  рдЖрдЗрдП рдмрджрд▓рд╛рд╡реЛрдВ рдХреЛ рджреЗрдЦреЗрдВред <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(tsk) do {</span></span></code> </pre> <br>  рдЕрдм <code>switch_to()</code> рдПрдХ рдбреВ- <code>switch_to()</code> 0) рд▓реВрдк рдореЗрдВ рд▓рд┐рдкрдЯрд╛ рд╣реБрдЖ рд╣реИред  рдпрд╣ рдбрд┐рдЬрд╝рд╛рдЗрди рддреНрд░реБрдЯрд┐рдпреЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ рдпрджрд┐ рд╕реНрдерд┐рддрд┐ (рдпрджрд┐ рдХреЛрдИ рд╣реЛ) рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдореИрдХреНрд░реЛ рдХрдИ рдмрдпрд╛рдиреЛрдВ рддрдХ рдлреИрд▓рддрд╛ рд╣реИред  рд╡рд░реНрддрдорд╛рди рдореЗрдВ, рдпрд╣ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди рд╢реЗрдбреНрдпреВрд▓рд░ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдХреЛ рджреЗрдЦрддреЗ рд╣реБрдП, рдореБрдЭреЗ рд╕рдВрджреЗрд╣ рд╣реИ рдХрд┐ рдпрд╣ рдХреЛрдб рдХреЗ рд╕рдВрдкрд╛рджрди рдХрд╛ рдкрд░рд┐рдгрд╛рдо рд╣реИ, рдмрд╕ рдорд╛рдорд▓реЗ рдореЗрдВред  рдореЗрд░рд╛ рдЕрдиреБрдорд╛рди: <br><br>  <b>1.3 рдореЗрдВ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдпреЛрдЬрдирд╛рдХрд╛рд░</b> <br><pre> <code class="cpp hljs">...<span class="hljs-function"><span class="hljs-function">within </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">schedule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(current == next)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">return</span></span></span></span>; kstat.context_swtch++; switch_to(next);</code> </pre> <br>  <b>рдПрдХ рд╕рдВрднрд╛рд╡рд┐рдд рд╡рд┐рдХрд▓реНрдк рдЬреЛ switch_to рдХреЛ рддреЛрдбрд╝рддрд╛ рд╣реИ ()</b> <br><pre> <code class="cpp hljs">...<span class="hljs-function"><span class="hljs-function">within </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">schedule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">... </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(current != next)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">switch_to</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(next)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* do-while(0) 'captures' entire * block to ensure proper parse */</span></span></code> </pre> <br><br><pre> <code class="cpp hljs">__asm__(<span class="hljs-string"><span class="hljs-string">"cli\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"xchgl %%ecx,_current\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"ljmp %0\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"sti\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"cmpl %%ecx,_last_task_used_math\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"jne 1f\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"clts\n"</span></span> <span class="hljs-string"><span class="hljs-string">"1:"</span></span> : <span class="hljs-comment"><span class="hljs-comment">/* no output */</span></span> :<span class="hljs-string"><span class="hljs-string">"m"</span></span> (*(((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)&amp;tsk-&gt;tss.tr)<span class="hljs-number"><span class="hljs-number">-4</span></span>)), <span class="hljs-string"><span class="hljs-string">"c"</span></span> (tsk) :<span class="hljs-string"><span class="hljs-string">"cx"</span></span>);</code> </pre> <br>  рд▓рд┐рдирдХреНрд╕ 1.0 рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХреЛрдИ рдкрд░рд┐рд╡рд░реНрддрди рдирд╣реАрдВред  рдлрд┐рд░ рднреА, рдЗрдВрдЯрд░рдкреНрдЯ рдХреЛ рдХрд░рдВрдЯ рд╕реЗ * task_struct рд╕реНрд╡реИрдк рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЕрдХреНрд╖рдо рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдлрд┐рд░ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ рдФрд░ рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЪреЗрдХ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(current-&gt;debugreg[<span class="hljs-number"><span class="hljs-number">7</span></span>]){</code> </pre> <br>  рд╕рдХреНрд░рд┐рдп ptrace рдХреЗ рд▓рд┐рдП рдПрдХ рдирдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдбрд┐рдмрдЧрд┐рдВрдЧ рдирд┐рдпрдВрддреНрд░рдг рдХреА рдЬрд╛рдБрдЪ рдХрд░рддрд╛ рд╣реИ (рдпрд╣рд╛рдБ рдЧреИрд░-рд╢реВрдиреНрдп рдкрддреЗ рдХрд╛ рдЕрд░реНрде рд╣реИ рд╕рдХреНрд░рд┐рдп ptrace)ред  рдбреАрдмрдЧ рдЯреНрд░реИрдХрд┐рдВрдЧ <code>switch_to()</code> рдореЗрдВ рдЪрд▓реА рдЧрдИ рд╣реИред  рдареАрдХ рдЙрд╕реА рдХреНрд░рдо C рдХрд╛ рдЙрдкрдпреЛрдЧ 1.0 рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред  рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рдереЗ рдХрд┐: 1) рдбрд┐рдмрдЧрд┐рдВрдЧ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ 2 рдХреЗ рдЬрд┐рддрдирд╛ рд╕рдВрднрд╡ рд╣реЛ рдЙрддрдирд╛ рдХрд░реАрдм рд╣реИ) рд╕реНрд╡рд┐рдЪ_рдЯреЛ <code>schedule()</code> рдореЗрдВ рдирд╡реАрдирддрдо рд╣реИ <code>schedule()</code> ред <br><br><pre> <code class="cpp hljs">loaddebug(<span class="hljs-number"><span class="hljs-number">0</span></span>); loaddebug(<span class="hljs-number"><span class="hljs-number">1</span></span>); loaddebug(<span class="hljs-number"><span class="hljs-number">2</span></span>); loaddebug(<span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre> <br>  рд╕рд╣реЗрдЬреЗ рдЧрдП ptrace рд╕реНрдерд┐рддрд┐ рд╕реЗ рдбреАрдмрдЧ рдмреНрд░реЗрдХрдкреЙрдЗрдВрдЯ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs">loaddebug(<span class="hljs-number"><span class="hljs-number">6</span></span>);</code> </pre> <br>  рд╕рд╣реЗрдЬреЗ рдЧрдП ptrace рд╕реНрдерд┐рддрд┐ рд╕реЗ рдбреАрдмрдЧ рдирд┐рдпрдВрддреНрд░рдг рд░рдЬрд┐рд╕реНрдЯрд░ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред <br><br><pre> <code class="cpp hljs">} <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  <code>switch_to()</code> рдмреНрд▓реЙрдХ рдХреЛ рдмрдВрдж рдХрд░рддрд╛ рд╣реИред  рд╣рд╛рд▓рд╛рдБрдХрд┐, рд╕реНрдерд┐рддрд┐ рд╣рдореЗрд╢рд╛ рд╕рдорд╛рди рд╣реЛрддреА рд╣реИ, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдкрд╛рд░реНрд╕рд░ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЖрдзрд╛рд░ рдЗрдХрд╛рдИ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЗрддрд╛ рд╣реИ рдЬреЛ <code>schedule()</code> рдореЗрдВ рдкрдбрд╝реЛрд╕реА рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ <code>schedule()</code> ред  рдЕрдВрдд рдореЗрдВ рдЕрд▓реНрдкрд╡рд┐рд░рд╛рдо рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ - рдпрд╣ рдореИрдХреНрд░реЛ рдХреЙрд▓ рдХреЗ рдмрд╛рдж рдЦрдбрд╝рд╛ рд╣реЛрддрд╛ рд╣реИ: <code>switch_to(next);</code>  ред <br><br><a name="3"></a><h1>  рд▓рд┐рдирдХреНрд╕ 2.0: рдЙрдореНрдореАрджрд╡рд╛рд░ (1996) </h1><br>  рдЬреВрди 1996 рдореЗрдВ, рдХрд░реНрдиреЗрд▓ рдХреЛ рд╕рдВрд╕реНрдХрд░рдг 2.0 рдореЗрдВ рдЕрджреНрдпрддрди рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЗрд╕ рдкреНрд░рдореБрдЦ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рддрд╣рдд 15-рд╡рд░реНрд╖реАрдп рдУрдбрд┐рд╕реА рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЬреЛ рд╡реНрдпрд╛рдкрдХ рд╡реНрдпрд╛рд╡рд╕рд╛рдпрд┐рдХ рд╕рдорд░реНрдерди рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рд╣реБрдЖред  2.x рдореЗрдВ, рдХрд░реНрдиреЗрд▓ рдореЗрдВ рд▓рдЧрднрдЧ рд╕рднреА рдореВрд▓рднреВрдд рдкреНрд░рдгрд╛рд▓рд┐рдпрд╛рдБ рдЖрдореВрд▓ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рддреА рд╣реИрдВред  2.6 рд╕реЗ рдкрд╣рд▓реЗ рд╕рднреА рдЫреЛрдЯреА рд░рд┐рд▓реАрдЬ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВред  рд╕рдВрд╕реНрдХрд░рдг 2.6 рдХреЛ рдЗрддрдиреЗ рд▓рдВрдмреЗ рд╕рдордп рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдПрдХ рдЕрд▓рдЧ рдЕрдиреБрднрд╛рдЧ рдХреЗ рдпреЛрдЧреНрдп рд╣реИред <br><br><h2>  рд▓рд┐рдирдХреНрд╕ 2.0 </h2><br>  рд▓рд┐рдирдХреНрд╕ 2.0 рдХреА рд╢реБрд░реБрдЖрдд рдХрд╛рд░реНрдбрд┐рдирд▓ рдЗрдиреЛрд╡реЗрд╢рди рд╕реЗ рд╣реБрдИ: <b>рдорд▓реНрдЯреАрдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ</b> !  рджреЛ рдпрд╛ рдЕрдзрд┐рдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдПрдХ рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ / рдХрд░реНрдиреЗрд▓ рдХреЛрдб рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред  рд╕реНрд╡рд╛рднрд╛рд╡рд┐рдХ рд░реВрдк рд╕реЗ, рдЗрд╕рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдкрд░рд┐рд╢реЛрдзрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереАред  рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдореЗрдВ рдЕрдм рдПрдХ рд╕рдорд░реНрдкрд┐рдд рдмрд╛рдзрд╛ рдирд┐рдпрдВрддреНрд░рдХ, APIC рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╡реНрдпрд╡рдзрд╛рди рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдкрд░ рдЕрд▓рдЧ рд╕реЗ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред  рдЯрд╛рдЗрдорд░ рд░реБрдХрд╛рд╡рдЯ рдЬреИрд╕реЗ рддрдВрддреНрд░реЛрдВ рдХреЛ рдлрд┐рд░ рд╕реЗ рдХрд╛рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рд╡реНрдпрд╡рдзрд╛рдиреЛрдВ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдирд╛ рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ)ред  рд╕рд┐рдВрдХреНрд░рдирд╛рдЗрдЬрд╝реЗрд╢рди рдореБрд╢реНрдХрд┐рд▓ рд╣реИ, рдЦрд╛рд╕рдХрд░ рдЬрдм рдЗрд╕реЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдмрдбрд╝реЗ рдФрд░ рдЕрд╕рдВрдмрдВрдзрд┐рдд рдХреЛрдб рдЖрдзрд╛рд░ рдкрд░ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИред  рд▓рд┐рдирдХреНрд╕ 2.0 рдПрдХ рдмрдбрд╝реЗ рдХрд░реНрдиреЗрд▓ рд▓реЙрдХ (BKL) рдХреЗ рд▓рд┐рдП рдиреАрдВрд╡ рджреЗрддрд╛ рд╣реИ ... рдЖрдкрдХреЛ рдХрд╣реАрдВ рд╕реЗ рд╢реБрд░реВ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред <br><br>  рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ <code>switch_to()</code> рджреЛ рд╕рдВрд╕реНрдХрд░рдг рд╣реИрдВ <code>switch_to()</code> : Linux 1.x рд╕реЗ рдПрдХрд▓-рдкреНрд░реЛрд╕реЗрд╕рд░ рд╕рдВрд╕реНрдХрд░рдг (UP) рдФрд░ рд╕рдордорд┐рддреАрдп рдорд▓реНрдЯреАрдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ (SMP) рдХреЗ рд▓рд┐рдП рдирдпрд╛ рдЙрдиреНрдирдд рд╕рдВрд╕реНрдХрд░рдгред<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдкреБрд░рд╛рдиреЗ рдХреЛрдб рдореЗрдВ рдмрджрд▓рд╛рд╡ рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ, рдХреНрдпреЛрдВрдХрд┐ рд╡рд╣рд╛рдВ рд╕реЗ рдХреБрдЫ рдмрджрд▓рд╛рд╡ рдПрд╕рдПрдордкреА рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рднреА рд╢рд╛рдорд┐рд▓ рд╣реИрдВред </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.0.1: рдпреВрдиреАрдкреНрд░реЛрд╕реЗрд╕рд░ рд╡рд░реНрдЬрди (рдпреВрдкреА) </font></font></h2><br><img src="https://habrastorage.org/getpro/habr/post_images/e0c/ac1/b5c/e0cac1b5c0c3b269808a36f947528f9f.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.0.1 (рдпреВрдкреА)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/asm-i386/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Single process only (not SMP) */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev,next) do { __asm__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %2,"</span></span></span><span class="hljs-meta">SYMBOL_NAME_STR(current_set)</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ljmp %0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cmpl %1,"</span></span></span><span class="hljs-meta">SYMBOL_NAME_STR(last_task_used_math)</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jne 1f\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"clts\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:"</span></span></span><span class="hljs-meta"> : </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* no outputs */</span></span></span><span class="hljs-meta"> :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*(((char *)&amp;next-&gt;tss.tr)-4)), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta"> (prev), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta"> (next)); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(prev-&gt;debugreg[7]){ loaddebug(prev,0); loaddebug(prev,1); loaddebug(prev,2); loaddebug(prev,3); loaddebug(prev,6); } } while (0) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рджреЛ рдмрджрд▓рд╛рд╡ рддреБрд░рдВрдд рд╕реНрдкрд╖реНрдЯ рд╣реИрдВ: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпреВ </font></font><code>switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХрд╛ рдПрдХ рдирдпрд╛ рддрд░реНрдХ рд╣реИ: рдЬрд┐рд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ </font></font><code>*task_struct</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рд╕реНрд╡рд┐рдЪ рдХрд░ рд░рд╣реЗ рд╣реИрдВред</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ рдореЗрдВ рд╡рд░реНрдгреЛрдВ рдХреЗ рд╕рд╣реА рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд▓рд┐рдП рдореИрдХреНрд░реЛред </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╣рдореЗрд╢рд╛ рдХреА рддрд░рд╣, рдЪрд▓реЛ рд▓рд╛рдЗрдиреЛрдВ рдХреЗ рд╕рд╛рде рдЪрд▓рддреЗ рд╣реИрдВ рдФрд░ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдкрд░ рдЪрд░реНрдЪрд╛ рдХрд░рддреЗ рд╣реИрдВред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev,next) do {</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рддрд░реНрдХ </font></font><code>prev</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЙрд╕ рдХрд╛рд░реНрдп рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдо ( </font></font><code>*task_struct</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">рд╕реЗ рд╕реНрд╡рд┐рдЪ рдХрд░ рд░рд╣реЗ рд╣реИрдВ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рд╣рдо рдЕрднреА рднреА рдореИрдХреНрд░реЛ рдХреЛ рдбреВ-рдЯрд╛рдЗрдо (0) рд▓реВрдк рдореЗрдВ рд▓рдкреЗрдЯ рд░рд╣реЗ рд╣реИрдВ рддрд╛рдХрд┐ рдореИрдХреНрд░реЛ рдХреЗ рдЪрд╛рд░реЛрдВ рдУрд░ рд╕рд┐рдВрдЧрд▓-рд▓рд╛рдЗрди рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓ рд╕рдХреЗред</font></font><br><br><pre> <code class="cpp hljs">__asm__(<span class="hljs-string"><span class="hljs-string">"movl %2,"</span></span>SYMBOL_NAME_STR(current_set)<span class="hljs-string"><span class="hljs-string">"\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд░реНрддрдорд╛рди рдореЗрдВ рд╕рдХреНрд░рд┐рдп рдХрд╛рд░реНрдп рдХреЛ рдирдП рдЪрдпрдирд┐рдд рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рд░реВрдк рд╕реЗ рд╕рдорддреБрд▓реНрдп рд╣реИ </font></font><code>xchgl %%ecx,_current</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ </font></font><code>SYMBOL_NAME_STR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрд╕реЗрдВрдмрд▓реА рд╡рд░реНрдгреЛрдВ рдХреЛ рд╕рдВрд╕рд╛рдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП </font><font style="vertical-align: inherit;">рдХрдИ рдХрд╛рд░реНрдп_рд╕реНрдЯреНрд░реЛрдХ рдФрд░ рдПрдХ рдореИрдХреНрд░реЛ ( </font><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">рдХреА рдПрдХ рд╕рд░рдгреА рд╣реИ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдЗрд╕рдХреЗ рд▓рд┐рдП рдкреНрд░реАрдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреНрдпреЛрдВ рдХрд░реЗрдВ? </font><font style="vertical-align: inherit;">рддрдереНрдп рдпрд╣ рд╣реИ рдХрд┐ рдХреБрдЫ рдХреЛрдбрд╛рдВрддрд░рдХреЛрдВ (рдЬреАрдПрдПрд╕) рдХреЛ рдЪрд░ рдирд╛рдо рд╕реА рдХреЗ рдЕрдВрдбрд░рд╕реНрдХреЛрд░ (_) рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЕрдиреНрдп рдХреЛрдбрд╛рдВрддрд░рдХреЛрдВ рдХреА рдпрд╣ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред </font><font style="vertical-align: inherit;">рдПрдХ рдХрдиреНрд╡реЗрдВрд╢рди рдХреЛ рд╣рд╛рд░реНрдб рдбреНрд░рд╛рдЗрд╡ рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рдЗрд╕реЗ рдЕрдкрдиреЗ рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд╕реЗрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╕рдВрдХрд▓рди рд╕рдордп рдкрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"ljmp %0\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"cmpl %1,"</span></span>SYMBOL_NAME_STR(last_task_used_math)<span class="hljs-string"><span class="hljs-string">"\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"jne 1f\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"clts\n"</span></span> <span class="hljs-string"><span class="hljs-string">"1:"</span></span> : <span class="hljs-comment"><span class="hljs-comment">/* no outputs */</span></span> :<span class="hljs-string"><span class="hljs-string">"m"</span></span> (*(((<span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)&amp;next-&gt;tss.tr)<span class="hljs-number"><span class="hljs-number">-4</span></span>)),</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреЛрдИ рдмрджрд▓рд╛рд╡ рдирд╣реАрдВ рдЬрд┐рд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣рдордиреЗ рдмрд╛рдд рдирд╣реАрдВ рдХреА рд╣реИред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"r"</span></span> (prev), <span class="hljs-string"><span class="hljs-string">"r"</span></span> (next));</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдм рд╣рдо рдЗрдирд▓рд╛рдЗрди рдЕрд╕реЗрдВрдмрд▓рд░ рдХреЗ рдЗрдирдкреБрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рджреЛрдиреЛрдВ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдПрдХ рдорд╛рдореВрд▓реА рдмрджрд▓рд╛рд╡ рдпрд╣ рд╣реИ рдХрд┐ рдЕрдм рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЗ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рдкрд╣рд▓реЗ </font></font><code>next</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ECX рдореЗрдВ рдПрдирдХреЛрдбреЗрдб рдерд╛ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(prev-&gt;debugreg[<span class="hljs-number"><span class="hljs-number">7</span></span>]){ loaddebug(prev,<span class="hljs-number"><span class="hljs-number">0</span></span>); loaddebug(prev,<span class="hljs-number"><span class="hljs-number">1</span></span>); loaddebug(prev,<span class="hljs-number"><span class="hljs-number">2</span></span>); loaddebug(prev,<span class="hljs-number"><span class="hljs-number">3</span></span>); loaddebug(prev,<span class="hljs-number"><span class="hljs-number">6</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕рдм рдХреБрдЫ рдареАрдХ рд╡реИрд╕рд╛ рд╣реА рд╣реИ рдЬреИрд╕рд╛ рдХрд┐ рдХрд░реНрдиреЗрд▓ 1.3 рдореЗрдВред </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.0.1: рдорд▓реНрдЯреАрдкреНрд░реЛрд╕реЗрд╕рд░ рд╡рд░реНрдЬрди (рдПрд╕рдПрдордкреА) </font></font></h2><br><img src="https://habrastorage.org/getpro/habr/post_images/d40/32b/4ce/d4032b4ce288a06a189746c69757fd03.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.0.1 (рдПрд╕рдПрдордкреА)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/asm-i386/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __SMP__ </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Multiprocessing enabled */</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev,next) do { cli(); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(prev-&gt;flags&amp;PF_USEDFPU) { __asm__ __volatile__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fnsave %0"</span></span></span><span class="hljs-meta">:</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=m"</span></span></span><span class="hljs-meta"> (prev-&gt;tss.i387.hard)); __asm__ __volatile__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"fwait"</span></span></span><span class="hljs-meta">); prev-&gt;flags&amp;=~PF_USEDFPU; } prev-&gt;lock_depth=syscall_count; kernel_counter+=next-&gt;lock_depth-prev-&gt;lock_depth; syscall_count=next-&gt;lock_depth; __asm__(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%edx\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl "</span></span></span><span class="hljs-meta">SYMBOL_NAME_STR(apic_reg)</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">",%%edx\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl 0x20(%%edx), %%edx\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"shrl $22,%%edx\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"and $0x3C,%%edx\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %%ecx,"</span></span></span><span class="hljs-meta">SYMBOL_NAME_STR(current_set)</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"(,%%edx)\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%edx\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ljmp %0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"sti\n\t"</span></span></span><span class="hljs-meta"> : </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* no output */</span></span></span><span class="hljs-meta"> :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (*(((char *)&amp;next-&gt;tss.tr)-4)), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"c"</span></span></span><span class="hljs-meta"> (next)); </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta">(prev-&gt;debugreg[7]){ loaddebug(prev,0); loaddebug(prev,1); loaddebug(prev,2); loaddebug(prev,3); loaddebug(prev,6); } } while (0)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреНрдпрд╛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖ рд░рд╣рд╛ рд╣реИ? </font><font style="vertical-align: inherit;">рдореИрдВ рдХрд╣рдирд╛ рдЪрд╛рд╣реВрдВрдЧрд╛ рдХрд┐ рдмрд╛рдж рдореЗрдВ рдпрд╣ рдмреЗрд╣рддрд░ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рд▓реЗрдХрд┐рди рдПрд╕рдПрдордкреА рдХреА рджреБрдирд┐рдпрд╛ рдореЗрдВ рдРрд╕рд╛ рдирд╣реАрдВ рд╣реЛрдЧрд╛ред </font><font style="vertical-align: inherit;">рдЕрдВрддрд░рд┐рдХреНрд╖ рдХреЛ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдореИрдВ рдЕрдм рдЕрдкрд░рд┐рд╡рд░реНрддрд┐рдд рддрд╛рд░реЛрдВ рдХреА рд╕реВрдЪреА рдирд╣реАрдВ рджреВрдВрдЧрд╛ред </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрд╕рдПрдордкреА рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рд▓рд┐рдП рддреАрди рдЬреЛрдбрд╝: 1) рдЬрд┐рд╕ рддрд░рд╣ рд╕реЗ рдПрдХ рдПрдХрд▓ рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХрдИ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЙрд╕реЗ рдмрджрд▓рдирд╛; </font><font style="vertical-align: inherit;">2) рд▓реЙрдХ рдХреА рдЧрд╣рд░рд╛рдИ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛, рдХреНрдпреЛрдВрдХрд┐ рдХрд░реНрдиреЗрд▓ рд▓реЙрдХ рдкреБрдирд░рд╛рд╡рд░реНрддреА рд╣реИ; </font><font style="vertical-align: inherit;">3) рд╡рд░реНрддрдорд╛рди * task_struct рдХреЗ рд▓рд┐рдП CPU ID рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП APIC рд╕реЗ рд▓рд┐рдВрдХ рдХрд░реЗрдВред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(prev-&gt;flags&amp;PF_USEDFPU)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЬрд╛рдБрдЪрддрд╛ рд╣реИ рдХрд┐ рдЬрд┐рд╕ рдХрд╛рд░реНрдп рдХреЛ рд╣рдо рд╕реНрд╡рд┐рдЪ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рд╡рд╣ рдПрдХ рдХреЙрдкреАрдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрджрд┐ рд╣рд╛рдВ, рддреЛ рдЖрдкрдХреЛ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдПрдлрдкреАрдпреВ рдореЗрдВ рд╕рдВрджрд░реНрдн рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред</font></font><br><br><pre> <code class="cpp hljs">__asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"fnsave %0"</span></span>:<span class="hljs-string"><span class="hljs-string">"=m"</span></span> (prev-&gt;tss.i387.hard));</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TSS рдХреЛ FPU рд░рд╛рдЬреНрдп рдмрдЪрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">FNSAVE рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрдкрд╡рд╛рдж рд╣реИрдВрдбрд▓рд┐рдВрдЧ рдХреЛ рдЫреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </font></font><code>__volatile__</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдСрдкреНрдЯрд┐рдорд╛рдЗрдЬрд╝рд░ рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рд╕реЗ рдЗрд╕ рдирд┐рд░реНрджреЗрд╢ рдХреА рд░рдХреНрд╖рд╛ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред</font></font><br><br><pre> <code class="cpp hljs">__asm__ __volatile__(<span class="hljs-string"><span class="hljs-string">"fwait"</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕реАрдкреАрдпреВ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ рдЬрдмрдХрд┐ рдПрдлрдкреАрдпреВ рдкрд┐рдЫрд▓реЗ рдмрдЪрдд рдХреЗ рд╕рд╛рде рд╡реНрдпрд╕реНрдд рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">prev-&gt;flags&amp;=~PF_USEDFPU;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЗрд╕ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдПрдХ рдХреЛрдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдзреНрд╡рдЬ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ, рд╣рдореЗрд╢рд╛ рд╢реВрдиреНрдп рд╣реЛрддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">prev-&gt;lock_depth=syscall_count;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд┐рд╕реА рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдХрд░реНрдиреЗрд▓ рд▓реЙрдХрд┐рдВрдЧ рдХреЗ рдиреЗрд╕реНрдЯреЗрдб рдЙрдкрдпреЛрдЧ рдХреА рд╕рдВрдЦреНрдпрд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">kernel_counter+=next-&gt;lock_depth-prev-&gt;lock_depth;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡реИрд╢реНрд╡рд┐рдХ рдХрд░реНрдиреЗрд▓ рд▓реЙрдХ рдХрд╛рдЙрдВрдЯрд░ рдХреЛ рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЛ рдШрдЯрд╛ рджреЗрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдЕрдм рдирд┐рд╖реНрдХреНрд░рд┐рдп рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рд╕реЗ рд▓реЙрдХ рдХреЛ рд╣рдЯрд╛ рджреЗрддрд╛ рд╣реИ, рдФрд░ рдирдпрд╛ рдХрд╛рд░реНрдп рдЙрд╕ рд╕реНрдерд╛рди рд╕реЗ рдХрд╛рдо рдХрд░рдирд╛ рдЬрд╛рд░реА рд░рдЦ рд╕рдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдпрд╣ рд░реБрдХрд╛ рдерд╛ред</font></font><br><br><pre> <code class="cpp hljs">syscall_count=next-&gt;lock_depth;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХрд┐рд╕реА рдирдП рдХрд╛рд░реНрдп рдХреА рд▓реЙрдХ рд╕реНрдерд┐рддрд┐ рд▓реМрдЯрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рд╡рд╣ рдЬрдЧрд╣ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдЬрд╣рд╛рдВ рд╡рд╣ рд╕рдордп рдХреЗ рдЖрдЦрд┐рд░реА рдЦрд┐рдВрдЪрд╛рд╡ рдореЗрдВ рдЫреВрдЯ рдЧрдИред</font></font><br><br><pre> <code class="cpp hljs">__asm__(<span class="hljs-string"><span class="hljs-string">"pushl %%edx\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╣рдо EDX рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЗрд╕рдХрд╛ рд╡рд░реНрддрдорд╛рди рдореВрд▓реНрдп рд░рдЦреЗрдВрдЧреЗред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movl "</span></span>SYMBOL_NAME_STR(apic_reg)<span class="hljs-string"><span class="hljs-string">",%%edx\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EDIC I / O рдкрддреЗ рдХреЛ EDX рдкрд░ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╣рдореЗрдВ рд╕реАрдкреАрдпреВ рдЖрдИрдбреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдкреАрдЖрдИрд╕реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рд╣рдореЗрдВ рдирд╣реАрдВ рдкрддрд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕рд╛ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИред </font></font><code>apic_reg</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">OS рдЖрд░рдВрднреАрдХрд░рдг рдХреЗ рджреМрд░рд╛рди рдкреНрд░рд╕рд╛рд░рдгред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movl 0x20(%%edx), %%edx\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EDX рдореЗрдВ APIC рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЗ рдорд╛рди рдХреЛ рд╣рдЯрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдЖрдИрдбреА рдмрд┐рдЯреНрд╕ 24-27 рдореЗрдВ рд╣реИред</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b78/a09/fe4/b78a09fe454c84ff075d4a9d5759bbd7.png"><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"shrl $22,%%edx\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> APIC ID рдХреЛ 2-5 рдмрд┐рдЯреНрд╕ рдкрд░ рд╢рд┐рдлреНрдЯ рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"and $0x3C,%%edx\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдмрд┐рдЯреНрд╕ 2-5 рдореЗрдВ рдХреЗрд╡рд▓ APIC ID рдХреЛ рдорд╛рд╕реНрдХ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ CPU рдирдВрдмрд░ * 4 рдирд┐рдХрд▓ рдЬрд╛рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movl %%ecx,"</span></span>SYMBOL_NAME_STR(current_set)<span class="hljs-string"><span class="hljs-string">"(,%%edx)\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд░реНрддрдорд╛рди рд╕реАрдкреАрдпреВ рдХреЗ рдХрд╛рд░реНрдп рд╕реВрдЪрдХ рдХреЛ рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдЕрджреНрдпрддрди рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпреВрдкреА рд╕рдВрд╕реНрдХрд░рдг рдиреЗ рд╡рд░реНрддрдорд╛рди рдХрд╛рд░реНрдп рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП ECX рдХреЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрдкрдпреЛрдЧ рдХреЛ рдкрд╣рд▓реЗ рд╣реА рд╣рдЯрд╛ рджрд┐рдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрднреА рднреА SMP рд╕рдВрд╕реНрдХрд░рдг рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">EDX рдмрд┐рдЯреНрд╕ рдореЗрдВ CPU рд╕рдВрдЦреНрдпрд╛ 2-5, 4 рд╕реЗ рдЧреБрдгрд╛ рдХрд░рддрд╛ рд╣реИ, рдкреЙрдЗрдВрдЯрд░ рдЖрдХрд╛рд░ рдХреЛ _current_set рд╕реЗ рдСрдлрд╕реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдХреЗрд▓ рдореЗрдВ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"popl %%edx\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдореЗрдВ рдИрдбреАрдПрдХреНрд╕ рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдкрд╣рд▓реЗ рдЙрд╕ рдореВрд▓реНрдп рдХреЛ рдмрд╣рд╛рд▓ рдХрд░реЗрдВрдЧреЗред </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╢реЗрд╖ рд░реЗрдЦрд╛рдПрдБ рд╕рдорд╛рди рд╣реИрдВред</font></font><br><br><a name="4"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.2 (1999) </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.2 рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХреЗ рд▓рд╛рдпрдХ рдерд╛: рдпрд╣рд╛рдВ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЖрдпрд╛ рдерд╛ </font><font style="vertical-align: inherit;">! </font><font style="vertical-align: inherit;">рд╣рдо рдЕрднреА рднреА TSS рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯрд╛рд╕реНрдХ рд░рдЬрд┐рд╕реНрдЯрд░ (TR) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдПрд╕рдПрдордкреА рдФрд░ рдпреВрдкреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдПрдХреАрдХреГрдд рдПрдлрдкреАрдпреВ рд░рд╛рдЬреНрдп рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде рд╕рдВрдпреБрдХреНрдд рд╣реИрдВред </font><font style="vertical-align: inherit;">рдЕрдзрд┐рдХрд╛рдВрд╢ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдЕрдм рд╕реАред </font><b><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.2.0</font></b><font style="vertical-align: inherit;"> рдХреЛрдб </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/cfd/c33/992/cfdc33992fee3168758bf99d6abe0698.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ) рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/asm-i386/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev,next) do { unsigned long eax, edx, ecx; asm volatile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%ebx\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%esi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%edi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%ebp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %%esp,%0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save ESP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %5,%%esp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore ESP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl $1f,%1\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save EIP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %6\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore EIP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jmp __switch_to\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%ebp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%edi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%esi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%ebx"</span></span></span><span class="hljs-meta"> :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=m"</span></span></span><span class="hljs-meta"> (prev-&gt;tss.esp),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=m"</span></span></span><span class="hljs-meta"> (prev-&gt;tss.eip), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=a"</span></span></span><span class="hljs-meta"> (eax), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=d"</span></span></span><span class="hljs-meta"> (edx), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=c"</span></span></span><span class="hljs-meta"> (ecx) :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (next-&gt;tss.esp),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (next-&gt;tss.eip), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"a"</span></span></span><span class="hljs-meta"> (prev), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"d"</span></span></span><span class="hljs-meta"> (next)); } while (0)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рдирдпрд╛ рдПрдХ рдЖрдо </font></font><code>switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рддреМрд░ рдкрд░ рдкрд┐рдЫрд▓реЗ рд╕рднреА рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рд╕реЗ рдЕрд▓рдЧ рд╣реИ: рдпрд╣ рд╕рд░рд▓ рд╣реИ! </font><font style="vertical-align: inherit;">рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ рдореЗрдВ, рд╣рдо рд╕реНрдЯреИрдХ рдФрд░ рдирд┐рд░реНрджреЗрд╢ рдмрд┐рдВрджреБ (рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХрд╛рд░реНрдп 1 рдФрд░ 2) рд╕реНрд╡реИрдк рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">C ( </font></font><code>__switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">рдХреЛрдб рдореЗрдВ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж рдмрд╛рдХреА рд╕рдм рдХреБрдЫ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"pushl %%ebx\n\t"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"pushl %%esi\n\t"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"pushl %%edi\n\t"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"pushl %%ebp\n\t"</span></span></span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реНрдЯреЛрд░ EBX, ESI, EDI рдФрд░ EBP рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдвреЗрд░ рдореЗрдВ рд╣рдо рд╕реНрд╡реИрдк рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">(... рдХреНрдпреЛрдВ EBX?)</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movl %%esp,%0\n\t"</span></span> <span class="hljs-comment"><span class="hljs-comment">/* save ESP */</span></span> <span class="hljs-string"><span class="hljs-string">"movl %5,%%esp\n\t"</span></span> <span class="hljs-comment"><span class="hljs-comment">/* restore ESP */</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рд╕реЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рд╣рдо рдкреБрд░рд╛рдиреА рдФрд░ рдирдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдмреАрдЪ рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░реНрд╕ рд╕реНрд╡реИрдк рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдкреБрд░рд╛рдиреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдСрдкрд░реЗрдВрдб% 0 ( </font></font><code>prev-&gt;tss.esp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) рд╣реИ, рдЬрдмрдХрд┐ рдирдИ </font><font style="vertical-align: inherit;">рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ </font><font style="vertical-align: inherit;">% 5 ( </font></font><code>next-&gt;tss.esp</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movl $1f,%1\n\t"</span></span> <span class="hljs-comment"><span class="hljs-comment">/* save EIP */</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдВрджрд░реНрдн рд╡рд╛рдкрд╕ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рдЕрдЧрд▓реЗ рдирд┐рд░реНрджреЗрд╢ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢ рд╕реВрдЪрдХ рдХреЗ рдореВрд▓реНрдп рдХреЛ рд╕рд╣реЗрдЬрдирд╛ред </font><font style="vertical-align: inherit;">рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдирд┐рдореНрди рдХрдерди рдХрд╛ рдорд╛рди рдПрдХ рд▓реЗрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ </font></font><code>1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"pushl %6\n\t"</span></span> <span class="hljs-comment"><span class="hljs-comment">/* restore EIP */</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдП рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рд░реНрджреЗрд╢ рддреИрдпрд╛рд░ рдХрд░реЗрдВред </font><font style="vertical-align: inherit;">рдЪреВрдВрдХрд┐ рд╣рдордиреЗ рдЕрднреА рдПрдХ рдирдП рд╕реНрдЯреИрдХ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд┐рдпрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдЖрдИрдкреА рдирдП рдХрд╛рд░реНрдп рдХреЗ TSS рд╕реЗ рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рд╕реНрдЯреИрдХ рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдирд┐рд╖реНрдкрд╛рджрди рд╕реА тАЛтАЛрдХреЛрдб рдХреЗ 'рд░рд┐рдЯ' рдХреЗ рдмрд╛рдж рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдерди рд╕реЗ рд╢реБрд░реВ рд╣реЛрдЧрд╛ рдЬрд┐рд╕реЗ рд╣рдо рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"jmp __switch_to\n"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╣рдо рдЕрдкрдиреЗ рдирдП рдФрд░ рдмреЗрд╣рддрд░ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдкрд░ рдЬрд╛рддреЗ рд╣реИрдВ (рдиреАрдЪреЗ рджреЗрдЦреЗрдВ)ред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"popl %%ebp\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"popl %%edi\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"popl %%esi\n\t"</span></span> <span class="hljs-string"><span class="hljs-string">"popl %%ebx"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдПрдХ рдирдП рд╕рдордп рдЕрдВрддрд░рд╛рд▓ рдореЗрдВ рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╕рдВрднрд╡рддрдГ рд░рд┐рд╡рд░реНрд╕ рдСрд░реНрдбрд░ рдореЗрдВ рд╕реНрдЯреИрдХ рд╕реЗ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.2.0 (C)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/i386/kernel/process.c */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __switch_to(struct task_struct *prev, struct task_struct *next) { <span class="hljs-comment"><span class="hljs-comment">/* Do the FPU save and set TS if it wasn't set before.. */</span></span> unlazy_fpu(prev); gdt_table[next-&gt;tss.tr &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>].b &amp;= <span class="hljs-number"><span class="hljs-number">0xfffffdff</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ltr %0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">: :</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"g"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;next-&gt;tss.tr))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%fs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;tss.fs))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%gs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;tss.gs))</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Re-load LDT if necessary */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;mm-&gt;segments != prev-&gt;mm-&gt;segments) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"lldt %0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">: :</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"g"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;next-&gt;tss.ldt))</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Re-load page tables */</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> new_cr3 = next-&gt;tss.cr3; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_cr3 != prev-&gt;tss.cr3) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %0,%%cr3"</span></span></span></span><span class="hljs-function"><span class="hljs-params">: :</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"r"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (new_cr3))</span></span></span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* Restore %fs and %gs. */</span></span> loadsegment(fs,next-&gt;tss.fs); loadsegment(gs,next-&gt;tss.gs); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;tss.debugreg[<span class="hljs-number"><span class="hljs-number">7</span></span>]){ loaddebug(next,<span class="hljs-number"><span class="hljs-number">0</span></span>); loaddebug(next,<span class="hljs-number"><span class="hljs-number">1</span></span>); loaddebug(next,<span class="hljs-number"><span class="hljs-number">2</span></span>); loaddebug(next,<span class="hljs-number"><span class="hljs-number">3</span></span>); loaddebug(next,<span class="hljs-number"><span class="hljs-number">6</span></span>); loaddebug(next,<span class="hljs-number"><span class="hljs-number">7</span></span>); } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдореЗрдВ, TSS рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЗ рд▓рд┐рдП рдкреБрд░рд╛рдиреЗ рд╕рдВрдХреНрд░рдордг рдХреЛ рдирдП C: рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рд╕рдВрдХреНрд░рдордг рджреНрд╡рд╛рд░рд╛ рдмрджрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ </font></font><code>__switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рд╕реА рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕рдореЗрдВ рдХрдИ рдкрд░рд┐рдЪрд┐рдд рдШрдЯрдХ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рдЬреИрд╕реЗ рдбрд┐рдмрдЧ рд░рдЬрд┐рд╕реНрдЯрд░ред </font><font style="vertical-align: inherit;">C рдкрд░ рдЬрд╛рдиреЗ рд╕реЗ рдЖрдк рдЙрдиреНрд╣реЗрдВ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рдФрд░ рднреА рдХрд░реАрдм рд▓реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs">unlazy_fpu(prev);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдПрдлрдкреАрдпреВ рдХреЗ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдпрджрд┐ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЗрд╕рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдмрдЪрд╛ рд╕рдХрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдЕрдм рдпрд╣ рд╣рд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИ рдЬреЛ FPU рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╕рдлрд╛рдИ рдЕрдм рдЖрд▓рд╕реА рдирд╣реАрдВ рд╣реИред </font><font style="vertical-align: inherit;">рдкреНрд░рдХреНрд░рд┐рдпрд╛ 2.0.1 рд╕реЗ рдПрд╕рдПрдордкреА рджрд┐рдирдЪрд░реНрдпрд╛ рдХреЗ рд╕рдорд╛рди рд╣реИ, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рд╕реНрд╡рдЪреНрдЫ рдореИрдХреНрд░реЛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдореИрдиреБрдЕрд▓ рдЯреАрдПрд╕ рдЯреНрдпреВрдирд┐рдВрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">gdt_table[next-&gt;tss.tr &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>].b &amp;= <span class="hljs-number"><span class="hljs-number">0xfffffdff</span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рднрд╡рд┐рд╖реНрдп рдХреЗ рдХрд╛рд░реНрдп рд╡рд┐рд╡рд░рдгрдХ рдХреЗ рд▓рд┐рдП BUSY рдмрд┐рдЯ рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">GDT рдХреЛ рдЕрдиреБрдХреНрд░рдорд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдп рд╕рдВрдЦреНрдпрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред </font></font><code>tss.tr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХрд╛рд░реНрдп рдЦрдВрдб рдЪрдпрдирдХрд░реНрддрд╛ рдХрд╛ рдорд╛рди рд╕рдорд╛рд╣рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдирд┐рдЪрд▓реЗ рддреАрди рдмрд┐рдЯреНрд╕ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рд╣рдореЗрдВ рдХреЗрд╡рд▓ рдПрдХ рдЗрдВрдбреЗрдХреНрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдЗрди рдмрд┐рдЯреНрд╕ рдХреЛ рд╢рд┐рдлреНрдЯ рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рджреВрд╕рд░рд╛ TSS рдмрд╛рдЗрдЯ рдмрд┐рдЯ 10 рдХреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e76/93f/c83/e7693fc83518201122914c5854f59de1.png"><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"ltr %0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">: :</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"g"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;next-&gt;tss.tr))</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЯрд╛рд╕реНрдХ рд░рдЬрд┐рд╕реНрдЯрд░ рдПрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЗ рд╕рд╛рде рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рдЦрдВрдб рдЪрдпрдирдХрд░реНрддрд╛ рдХреЛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%fs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;tss.fs))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%gs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;tss.gs))</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд┐рдЫрд▓реЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП FS рдФрд░ GS рдЦрдВрдб рд░рдЬрд┐рд╕реНрдЯрд░ TSS рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИрдВред </font><font style="vertical-align: inherit;">рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдореЗрдВ, рдпрд╣ рдЪрд░рдг рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЕрдм рд╣рдореЗрдВ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд▓реЗрдХрд┐рди рдХреНрдпреЛрдВ? </font><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ рдПрдлрдПрд╕ рдФрд░ рдЬреАрдПрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░рддрд╛ рд╣реИ? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.2 (1999) рдкрд░ рдХреЛрдИ рд╕реНрдкрд╖реНрдЯ рдЙрддреНрддрд░ рдирд╣реАрдВ рд╣реИред </font><font style="vertical-align: inherit;">рдХреЗрд╡рд▓ рдпрд╣ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЙрдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЙрдиреНрд╣реЗрдВ рд╕рд╣реЗрдЬрдирд╛ рдЪрд╛рд╣рд┐рдП рддрд╛рдХрд┐ рд╡реЗ рд╕реБрд▓рдн рд░рд╣реЗрдВред </font><font style="vertical-align: inherit;">рдХрд░реНрдиреЗрд▓ рдореЛрдб рдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░реНрдиреЗрд▓-рдореЛрдб рдХреЛрдб рдЗрди рдЦрдВрдбреЛрдВ рдХреЛ "рдЙрдзрд╛рд░" рджреЗрдЧрд╛ред </font><font style="vertical-align: inherit;">рд╕рд╛рдЙрдВрдб рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдбреНрд░рд╛рдЗрд╡рд░ рдРрд╕рд╛ рд╣реА рдХрд░рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рд╣рд╛рд▓ рд╣реА рдореЗрдВ (~ 2.6 рдЖрдЧреЗ) рдПрдлрдПрд╕ рдФрд░ рдЬреАрдПрд╕ рдЕрдХреНрд╕рд░ рд╕реНрдерд╛рдиреАрдп рд╕реНрдЯреНрд░реАрдо рд╕реНрдЯреЛрд░реЗрдЬ рдФрд░ рдбреЗрдЯрд╛ рдХреНрд╖реЗрддреНрд░ рдкреНрд░рддрд┐ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;mm-&gt;segments != prev-&gt;mm-&gt;segments) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"lldt %0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">: :</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"g"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;next-&gt;tss.ldt))</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реНрдерд╛рдиреАрдп рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рдЦрдВрдбреЛрдВ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдпрджрд┐ рд╡реЗ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдкреБрд░рд╛рдиреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЕрдиреБрд░реВрдк рдирд╣реАрдВ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдпрд╣ LDT рд░рдЬрд┐рд╕реНрдЯрд░ рд▓реЛрдб рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (new_cr3 != prev-&gt;tss.cr3) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %0,%%cr3"</span></span></span></span><span class="hljs-function"><span class="hljs-params">: :</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"r"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (new_cr3))</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХрд┐рд╕реА рдирдП рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рд╡рд░реНрдЪреБрдЕрд▓ рдореЗрдореЛрд░реА рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдЕрджреНрдпрддрди рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, CR3 рд░рдЬрд┐рд╕реНрдЯрд░ рд╕реЗрдЯ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдирдП рд╕рдВрджрд░реНрдн рдореЗрдВ рдореЗрдореЛрд░реА рдПрдХреНрд╕реЗрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреГрд╖реНрдареЛрдВ рдХреА рдПрдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">loadsegment(fs,next-&gt;tss.fs); loadsegment(gs,next-&gt;tss.gs);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдП рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдПрдлрдПрд╕ рдФрд░ рдЬреАрдПрд╕ рдХреЛ рдмрд╣рд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рд╕рд╣реА рд╕рдВрд░реЗрдЦрдг рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдПрдХ рд╕рдорд╕реНрдпрд╛ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╢реВрдиреНрдп рдЦрдВрдб рд▓реЛрдб рд╣реЛрддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">loaddebug(prev,<span class="hljs-number"><span class="hljs-number">7</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдВрдд рдореЗрдВ, рдбреАрдмрдЧ рдХрдВрдЯреНрд░реЛрд▓ рд░рдЬрд┐рд╕реНрдЯрд░ рдЕрдм рдЯреАрдПрд╕рдПрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдВрдЧреНрд░рд╣реАрдд рдФрд░ рд╕реНрд╡рд┐рдЪ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдкрд╣рд▓реЗ, рдпрд╣ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЗрд╡рд▓ рдЪреЗрдХ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рднрдВрдбрд╛рд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред</font></font><br><br><a name="5"></a><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.4 (2001) </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд░реНрдЬрди 2.4 рдиреЗ рдХрд░реНрдиреЗрд▓ рдереНрд░реЗрдбреНрд╕ рдФрд░ рдЯрд╛рд╕реНрдХ рдХреНрдпреВ рдЬреИрд╕реЗ рдХрдИ рдирдП рдлреАрдЪрд░реНрд╕ рдкреЗрд╢ рдХрд┐рдПред </font><font style="vertical-align: inherit;">рд╢реЗрдбреНрдпреВрд▓рд░ рдореЗрдВ рдЗрд╕рдХреЗ рдФрд░ рдХреБрдЫ рдмрджрд▓рд╛рд╡реЛрдВ рдХреЗ рдмрд╛рд╡рдЬреВрдж, рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рд╕рдВрд╕реНрдХрд░рдг 2.2 рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдирд╣реАрдВ рдмрджрд▓рд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕рдиреЗ рд╕рднреА рд░рдЬрд┐рд╕реНрдЯрд░ рдбреЗрдЯрд╛ рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рдкрдХреНрд╖ рдореЗрдВ рдЯреАрдЖрд░ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛ рдмрдВрдж рдХрд░ рджрд┐рдпрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдореИрдВ рдЕрдиреМрдкрдЪрд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ рдЗрд╕реЗ "рдЕрдВрддрд┐рдо рд▓рд┐рдЧреЗрд╕реА рдХрд░реНрдиреЗрд▓" рдХрд╣рддрд╛ рд╣реВрдВ, рдХреНрдпреЛрдВрдХрд┐ рд╕рднреА рднрд╡рд┐рд╖реНрдп рдХреЗ рд░рд┐рд▓реАрдЬ 64-рдмрд┐рдЯ x86 рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/9fe/47c/1cb/9fe47c1cbc25d24606a3622694edcafb.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.4.0 (рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/asm-i386/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev,next,last) do { asm volatile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%esi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%edi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%ebp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %%esp,%0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save ESP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %3,%%esp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore ESP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl $1f,%1\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save EIP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %4\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore EIP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jmp __switch_to\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%ebp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%edi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%esi\n\t"</span></span></span><span class="hljs-meta"> :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=m"</span></span></span><span class="hljs-meta"> (prev-&gt;thread.esp),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=m"</span></span></span><span class="hljs-meta"> (prev-&gt;thread.eip), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=b"</span></span></span><span class="hljs-meta"> (last) :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (next-&gt;thread.esp),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (next-&gt;thread.eip), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"a"</span></span></span><span class="hljs-meta"> (prev), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"d"</span></span></span><span class="hljs-meta"> (next), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"b"</span></span></span><span class="hljs-meta"> (prev)); } while (0)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">2.4 рдХрд░реНрдиреЗрд▓ рдореЗрдВ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗрд╡рд▓ рдХреБрдЫ рдорд╛рдореВрд▓реА рдмрджрд▓рд╛рд╡ рдХрд░рддрд╛ рд╣реИ: EBX рдХреЛ рдЕрдм рдзрдХреНрдХрд╛ рдирд╣реАрдВ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИред </font><font style="vertical-align: inherit;">рдПрдХ рдирдпрд╛ рдЗрдирдкреБрдЯ рддрд░реНрдХ рд╕рд╛рдордиреЗ рдЖрдпрд╛ </font></font><code>last</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕рдорд╛рди рдорд╛рди рд╣реИ </font></font><code>prev</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдпрд╣ рдИрдмреАрдПрдХреНрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░реЗрд╖рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">:<span class="hljs-string"><span class="hljs-string">"=m"</span></span> (prev-&gt;thread.esp),<span class="hljs-string"><span class="hljs-string">"=m"</span></span> (prev-&gt;thread.eip), :<span class="hljs-string"><span class="hljs-string">"m"</span></span> (next-&gt;thread.esp),<span class="hljs-string"><span class="hljs-string">"m"</span></span> (next-&gt;thread.eip),</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I / O рдСрдкрд░реЗрдВрдб рдЕрдм рдХрд░реНрдиреЗрд▓ рдереНрд░реЗрдбреНрд╕ рдХреЗ рд▓рд┐рдП рд╕реНрдЯреИрдХ / рдирд┐рд░реНрджреЗрд╢ рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдЯреАрдПрд╕рдПрд╕ рд╕реЗ рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░реНрд╕ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.4.0 (C)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/i386/kernel/process.c */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __switch_to(struct task_struct *prev_p, struct task_struct *next_p) { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init_tss</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">smp_processor_id</span></span></span><span class="hljs-class">();</span></span> unlazy_fpu(prev_p); tss-&gt;esp0 = next-&gt;esp0; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%fs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;fs))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%gs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;gs))</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Restore %fs and %gs. */</span></span> loadsegment(fs, next-&gt;fs); loadsegment(gs, next-&gt;gs); <span class="hljs-comment"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;debugreg[<span class="hljs-number"><span class="hljs-number">7</span></span>]){ loaddebug(next, <span class="hljs-number"><span class="hljs-number">0</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">1</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">2</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* no 4 and 5 */</span></span> loaddebug(next, <span class="hljs-number"><span class="hljs-number">6</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">7</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prev-&gt;ioperm || next-&gt;ioperm) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;ioperm) { <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(tss-&gt;io_bitmap, next-&gt;io_bitmap, IO_BITMAP_SIZE*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)); tss-&gt;bitmap = IO_BITMAP_OFFSET; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> tss-&gt;bitmap = INVALID_IO_BITMAP_OFFSET; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реА рдХреЛрдб рд╡рд╛рд▓реЗ рд╣рд┐рд╕реНрд╕реЗ рдиреЗ рдХреБрдЫ рдЪреАрдЬреЗрдВ рдмрджрд▓ рджреА рд╣реИрдВред </font><font style="vertical-align: inherit;">TR рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛ рдХреЛрдИ рдЙрд▓реНрд▓реЗрдЦ рдЧрд╛рдпрдм рд╣реЛ рдЧрдпрд╛ рд╣реИ, рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рд╣рдо рд╡рд░реНрддрдорд╛рди рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд▓рд┐рдП рд╕рдХреНрд░рд┐рдп TSS рдХреЛ рд╕реАрдзреЗ рдмрджрд▓ рджреЗрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдЗрдирд▓рд╛рдЗрди рдХреЛрдбрд╛рдВрддрд░рдХ рдХреЗ рд░реВрдк рдореЗрдВ, рдкреНрд░рддреНрдпреЗрдХ рдХрд╛рд░реНрдп TSS рдбреЗрдЯрд╛ рдХреЛ рдереНрд░реЗрдб_рд╕реНрдЯреНрд░реЛрдХ рдХреЗ рдЕрдВрджрд░ task_struct рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдкреНрд░рддреНрдпреЗрдХ рд╕рдХреНрд░рд┐рдп CPU GDT рд╕реЗ рд╕рдорд░реНрдкрд┐рдд TSS рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрди рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЛ рд╕реАрдзреЗ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __switch_to(struct task_struct *prev_p, struct task_struct *next_p)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд┐рдЫрд▓реЗ рдФрд░ рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд╕рдВрдХреЗрдд рдкрд░ рдПрдХ рдкреНрд░рддреНрдпрдп рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИ </font></font><code>_p</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдпрд╣ рдПрдХ рдЫреЛрдЯреА рд▓реЗрдХрд┐рди рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЕрддрд┐ рд╕реВрдХреНрд╖реНрдо рдЕрдВрддрд░ рд╡рдЬрд╣ рд╕реЗ рд╣реИ </font></font><code>prev</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдФрд░ </font></font><code>next</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЧрд┐рд░реА рдзрд╛рдЧреЗ рдореЗрдВ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд╛ рд░рд╣рд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдкреНрд░рддреНрдпреЗрдХ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП TSS рдбреЗрдЯрд╛ рдХреЗ рдмрд┐рдВрджреБ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред </font></font><br><br><pre> <code class="cpp hljs">tss-&gt;esp0 = next-&gt;esp0;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдП рдХрд╛рд░реНрдп рд╕реЗ рдСрдлрд╕реЗрдЯ рдХреЗ рд╕рд╛рде рд╕реНрдЯреИрдХ рдСрдлрд╝рд╕реЗрдЯ рд░рд┐рдВрдЧ 0 рдХреА рдЬрдЧрд╣ред </font><font style="vertical-align: inherit;">рдЬрдм рддрдХ рдпрд╣ рдкреГрд╖реНрда рддрд╛рд▓рд┐рдХрд╛ рдХреЗ рдкреБрдирдГ рд▓реЛрдб рдХреЗ рд▓рд┐рдП рдмрд╛рдзреНрдп рди рд╣реЛ рдЬрд╛рдП ...</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%fs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;fs))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%gs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;gs))</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдПрдлрдПрд╕ рдФрд░ рдЬреАрдПрд╕ рдХреА рдмрдЪрддред </font><font style="vertical-align: inherit;">рдЗрди рдЦрдВрдбреЛрдВ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдЕрднреА рднреА рд╕рдордЭ рд╕реЗ рдмрд╛рд╣рд░ рд╣реИ, рд▓реЗрдХрд┐рди рд╡реЗ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдирддреАрдЬрддрди, рд╕рдВрд╕реНрдХрд░рдг 2.6 рдореЗрдВ рд╡реЗ рд╕реНрдерд╛рдиреАрдп рдПрдлрдПрд╕: рдереНрд░реЗрдб рд╕реНрдЯреЛрд░реЗрдЬ рдФрд░ рдЬреАрдПрд╕: рдкреНрд░рддрд┐-рдкреНрд░реЛрд╕реЗрд╕рд░ рдбреЗрдЯрд╛ рдХреНрд╖реЗрддреНрд░ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (prev-&gt;ioperm || next-&gt;ioperm) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;ioperm) { <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(tss-&gt;io_bitmap, next-&gt;io_bitmap, IO_BITMAP_SIZE*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)); tss-&gt;bitmap = IO_BITMAP_OFFSET;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЖрдЧрд╛рдореА рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рд╕рдХреНрд░рд┐рдп TSS рдореЗрдВ рдкреЛрд░реНрдЯ рдореИрдкрд┐рдВрдЧ I / O рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> tss-&gt;bitmap = INVALID_IO_BITMAP_OFFSET;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдПрдХ рдЬреНрдЮрд╛рдд рдЕрдорд╛рдиреНрдп рдмрд┐рдЯрдореИрдк (0x8000) рдХреЗ рд▓рд┐рдП рд╕рдХреНрд░рд┐рдп TSS рдХреЗ рд▓рд┐рдП I / O рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИред </font></font><br><br><a name="6"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.6: рд▓реЛрдХрдкреНрд░рд┐рдпрддрд╛ (2003) </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЬреИрд╕реЗ рд╣реА рдХрд░реНрдиреЗрд▓ 2.5 рд╡рд┐рджрд╛ рд╣реБрдЖ, рд▓реАрдирд┐рдпрд░-рд░рди рд╢реЗрдбреНрдпреВрд▓рд░ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдЙрдкрдпреЛрдЧ рдХреА рд╕реАрдорд╛ рддрдХ рдкрд╣реБрдВрдЪ рдЧрдпрд╛, рдФрд░ рдПрдПрдордбреА рдиреЗ x86 рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЬрд┐рд╕реЗ рдХрд░реНрдиреЗрд▓ рдбреЗрд╡рд▓рдкрд░реНрд╕ рдХрд╛ рддрддреНрдХрд╛рд▓ рдзреНрдпрд╛рди рджреЗрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА: x86-64ред </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.6.0 </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рд╕реНрдерд┐рд░ рдХреНрд░рдо рдХреЗ рд╕рд╛рде рдХрд░реНрдиреЗрд▓ рдЕрдиреБрд╕реВрдЪрдХ рдХрд░реНрдиреЗрд▓ рдореЗрдВ 2.6.0 рджрд┐рдЦрд╛рдИ рджрд┐рдпрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рдкрд┐рдЫрд▓реЗ рд░реИрдЦрд┐рдХ рдЕрдиреБрд╕реВрдЪрдХ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдПрдХ рдХрджрдо рдЖрдЧреЗ рд╣реИ, рд▓реЗрдХрд┐рди 2.6.23 рдореЗрдВ рдЕрдВрддрддрдГ рдЗрд╕реЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдирд┐рд╖реНрдкрдХреНрд╖ рдЕрдиреБрд╕реВрдЪрдХ (рд╕реАрдПрдлрдПрд╕) рджреНрд╡рд╛рд░рд╛ рдмрджрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ред </font><font style="vertical-align: inherit;">рджреВрд╕рд░реА рдУрд░, рдирдП 64-рдмрд┐рдЯ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдиреЗ рдЖрдЬ рддрдХ рдХреЗ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдмрджрд▓рд╛рд╡ рдХрд┐рдП рд╣реИрдВред</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.6.0: i386 рд╕рдВрд╕реНрдХрд░рдг </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рд▓реЗрдЦ рдореЗрдВ 32-рдмрд┐рдЯ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреА рдирд╡реАрдирддрдо рдЙрдкрд╕реНрдерд┐рддрд┐ рд╣реИред </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8f7/832/9c5/8f78329c52340939baba3bedbbcdfa39.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.6.0 (i386 рдореЗрдВ рдирд┐рд░реНрдорд┐рдд рдХреЛрдбрд╛рдВрддрд░рдХ)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/asm-i386/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev,next,last) do { unsigned long esi,edi; asm volatile(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushfl\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %%ebp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %%esp,%0\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save ESP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl %5,%%esp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore ESP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movl $1f,%1\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save EIP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushl %6\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore EIP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jmp __switch_to\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1:\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popl %%ebp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"popfl"</span></span></span><span class="hljs-meta"> :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=m"</span></span></span><span class="hljs-meta"> (prev-&gt;thread.esp),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=m"</span></span></span><span class="hljs-meta"> (prev-&gt;thread.eip), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=a"</span></span></span><span class="hljs-meta"> (last),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=S"</span></span></span><span class="hljs-meta"> (esi),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=D"</span></span></span><span class="hljs-meta"> (edi) :</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (next-&gt;thread.esp),</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (next-&gt;thread.eip), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"2"</span></span></span><span class="hljs-meta"> (prev), </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"d"</span></span></span><span class="hljs-meta"> (next)); } while (0)</span></span></code> </pre> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЪрд╛рд░ рд▓рд╛рдЗрдиреЗрдВ рд╣рдЯрд╛рдИ рдЧрдИрдВред </font><font style="vertical-align: inherit;">ESI рдФрд░ EDI рдХреЛ рдкрд╣рд▓реЗ рд╕реНрдЯреИрдХ рдкрд░ рдзрдХреЗрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЕрдм I / O рдСрдкрд░реЗрдВрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдзрдХреЗрд▓ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.6.0 (i386 C)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/i386/kernel/process.c */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> * __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch_to</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpu = smp_processor_id(); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init_tss</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cpu</span></span></span><span class="hljs-class">;</span></span> __unlazy_fpu(prev_p); load_esp0(tss, next-&gt;esp0); <span class="hljs-comment"><span class="hljs-comment">/* Load the per-thread Thread-Local Storage descriptor. */</span></span> load_TLS(next, cpu); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%fs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;fs))</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%gs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params">:</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (*(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *)&amp;prev-&gt;gs))</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/* Restore %fs and %gs if needed. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(prev-&gt;fs | prev-&gt;gs | next-&gt;fs | next-&gt;gs)) { loadsegment(fs, next-&gt;fs); loadsegment(gs, next-&gt;gs); } <span class="hljs-comment"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;debugreg[<span class="hljs-number"><span class="hljs-number">7</span></span>])) { loaddebug(next, <span class="hljs-number"><span class="hljs-number">0</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">1</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">2</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* no 4 and 5 */</span></span> loaddebug(next, <span class="hljs-number"><span class="hljs-number">6</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">7</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(prev-&gt;io_bitmap_ptr || next-&gt;io_bitmap_ptr)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;io_bitmap_ptr) { <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(tss-&gt;io_bitmap, next-&gt;io_bitmap_ptr, IO_BITMAP_BYTES); tss-&gt;io_bitmap_base = IO_BITMAP_OFFSET; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> tss-&gt;io_bitmap_base = INVALID_IO_BITMAP_OFFSET; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev_p; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреБрдЫ рджрд┐рд▓рдЪрд╕реНрдк рдмрджрд▓рд╛рд╡: рдлрд╝рдВрдХреНрд╢рди рджреНрд╡рд╛рд░рд╛ рд▓реМрдЯрд╛рдП рдЧрдП рдореВрд▓реНрдп рдФрд░ рдореИрдХреНрд░реЛ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ </font></font><code>unlikely()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдореИрдВ [un] рдореЗрдВ рд▓рд┐рдкрдЯреЗ рдореМрдЬреВрджрд╛ рдХреЛрдб рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдкрд░ рд╡рд┐рдЪрд╛рд░ рдирд╣реАрдВ рдХрд░реВрдБрдЧрд╛, рддрд╛рдХрд┐ рдЗрд╕реЗ рдлрд┐рд░ рд╕реЗ рд╕рдордЭрд╛ рди рдЬрд╛рдПред </font><font style="vertical-align: inherit;">рдореИрдХреНрд░реЛ рдХреЛрдб рдЬрдирд░реЗрдЯрд░ рдХреЛ рдХреЗрд╡рд▓ рдпрд╣ рдмрддрд╛рддрд╛ рд╣реИ рдХрд┐ рдкрд╛рдЗрдк рд▓рд╛рдЗрдирд┐рдВрдЧ рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреМрди рд╕реА рдЖрдзрд╛рд░ рдЗрдХрд╛рдИ рдкрд╣рд▓реЗ рджрд┐рдЦрд╛рдИ рджреЗрдиреА рдЪрд╛рд╣рд┐рдПред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch_to</span></span></span><span class="hljs-class">(...)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__switch_to рдЕрдм рдПрдХ рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдПрдХ рдкреЙрдЗрдВрдЯрд░ рд▓реМрдЯрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рдХрд╣реАрдВ рднреА рд╕рдВрд╕рд╛рдзрд┐рдд рдирд╣реАрдВ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╛ рддреЛ рдкрд░рд┐рд╡рд░реНрддрди рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдпрд╛ рд╡реЗ рд╕рдореНрдореЗрд▓рди рдХрд╛ рдкрд╛рд▓рди рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рдереЗред </font><font style="vertical-align: inherit;">рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХреНрд▓рд╛рд╕рд┐рдХ рд╕рдореНрдореЗрд▓рди рдЬрдм рдХреЛрдИ рдлрд╝рдВрдХреНрд╢рди рд░рд╛рдЬреНрдп рдмрджрд▓рддрд╛ рд╣реИ, рддреЛ рд╣рдо рдмрд╛рдж рдореЗрдВ рд╕рд╣реЗрдЬрдиреЗ рдФрд░ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд┐рдЫрд▓реА рд╕реНрдерд┐рддрд┐ рдХреЛ рд▓реМрдЯрд╛рддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдЬрдмрдХрд┐ рдпрд╣ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">load_TLS(next, cpu);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдП рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП GDT рдореЗрдВ рд╕реНрдерд╛рдиреАрдп рдереНрд░реЗрдб рд╕реНрдЯреЛрд░ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.6 рд╡рд┐рд╢рд┐рд╖реНрдЯ рдзрд╛рд░рд╛ рдЦрдВрдбреЛрдВ рдХреЗ рд▓рд┐рдП рдЬреАрдбреАрдЯреА рдореЗрдВ рддреАрди рдЯреАрдПрд▓рдПрд╕ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╕реНрддреБрдд рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рддреЛ, рдЧреНрд▓рд┐рдмрдХ рдкрд╣рд▓реЗ рдЦрдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рд╢рд░рд╛рдм - рджреВрд╕рд░рд╛ред </font><font style="vertical-align: inherit;">рдЕрдм рд╣рдо рдХреНрд░рдорд┐рдХ рд░реВрдк рд╕реЗ рдЖрд╡рд╢реНрдпрдХрддрд╛рдиреБрд╕рд╛рд░ рд╕реНрдерд╛рдиреАрдп рдереНрд░реЗрдб рд╕реНрдЯреЛрд░ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП FS рдЦрдВрдб рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(prev-&gt;fs | prev-&gt;gs | next-&gt;fs | next-&gt;gs)) {</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЕрдм рд╣рдо рдХреЗрд╡рд▓ FS рдФрд░ GS рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдпрджрд┐ рд╡реЗ рдкрд┐рдЫрд▓реЗ рдпрд╛ рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рдереЗред </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 2.6.0: x86_64 рд╕рдВрд╕реНрдХрд░рдг </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">X86_64 рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ 32-рдмрд┐рдЯ рдПрдХ рд╕реЗ рдХрд╛рдлреА рдЕрд▓рдЧ рд╣реИред </font><font style="vertical-align: inherit;">рдЗрд╕ рдмрд╛рд░ рд╣рдо рд╕рд╛рд╡рдзрд╛рдиреАрдкреВрд░реНрд╡рдХ рдХреЛрдб рдХрд╛ рдЕрдзреНрдпрдпрди рдХрд░реЗрдВрдЧреЗ, рдХреНрдпреЛрдВрдХрд┐ рднрд╡рд┐рд╖реНрдп рдореЗрдВ рд╣рдо рдХреЗрд╡рд▓ 64-рдмрд┐рдЯ рд╕рдВрд╕реНрдХрд░рдг рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░реЗрдВрдЧреЗред </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7d8/26c/076/7d826c0761304c0e1b5ee41b42420fe3.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.6.0 (рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдб x86_64)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** include/asm-x86_64/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SAVE_CONTEXT </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushfq ; pushq %%rbp ; movq %%rsi,%%rbp\n\t"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RESTORE_CONTEXT </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %%rbp,%%rsi ; popq %%rbp ; popfq\n\t"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __EXTRA_CLOBBER ,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rcx"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rbx"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rdx"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r8"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r9"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r10"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r11"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r12"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r13"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r14"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r15"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev,next,last) asm volatile(SAVE_CONTEXT </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %%rsp,%P[threadrsp](%[prev])\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save RSP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %P[threadrsp](%[next]),%%rsp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore RSP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"call __switch_to\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">".globl thread_return\n"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"thread_return:\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %%gs:%P[pda_pcurrent],%%rsi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %P[thread_info](%%rsi),%%r8\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"btr %[tif_fork],%P[ti_flags](%%r8)\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %%rax,%%rdi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jc ret_from_fork\n\t"</span></span></span><span class="hljs-meta"> RESTORE_CONTEXT : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=a"</span></span></span><span class="hljs-meta"> (last) : [next] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"S"</span></span></span><span class="hljs-meta"> (next), [prev] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"D"</span></span></span><span class="hljs-meta"> (prev), [threadrsp] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (offsetof(struct task_struct, thread.rsp)), [ti_flags] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (offsetof(struct thread_info, flags)), [tif_fork] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (TIF_FORK), [thread_info] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (offsetof(struct task_struct, thread_info)), [pda_pcurrent] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (offsetof(struct x8664_pda, pcurrent)) : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"memory"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cc"</span></span></span><span class="hljs-meta"> __EXTRA_CLOBBER)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореИрдХреНрд░реЛ рдХреЛ x86_64 рдореЗрдВ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ </font></font><code>_switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдлрд┐рд░ рд╕реЗ рдЗрд╕рдХреА рд▓рд╛рдЗрдиреЛрдВ рд╕реЗ рдЧреБрдЬрд░рдирд╛ рд╣реЛрдЧрд╛ред </font><font style="vertical-align: inherit;">рдХрдИ рдмрджрд▓рд╛рд╡ рдмрд╕ рдирд╛рдо рд░рдЬрд┐рд╕реНрдЯрд░ ( </font></font><code>r..</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдмрджрд▓реЗ </font></font><code>e..</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) рд╣реИрдВред </font><font style="vertical-align: inherit;">рдХреБрдЫ рдЕрдиреНрдп рд╕рд╣рд╛рдпрдХ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдореИрдВрдиреЗ рдКрдкрд░ рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAVE_CONTEXT</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдКрдкрд░ рджрд┐рдЦрд╛рдП рдЧрдП рд╕рд╣рд╛рдпрдХ рдореИрдХреНрд░реЛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реНрдЯреИрдХ рдкрд░ рдХрд░реНрдиреЗрд▓ рд╕рдВрджрд░реНрдн рдмрдЪрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">32-рдмрд┐рдЯ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рдорд╛рди, рдирдП рд░рдЬрд┐рд╕реНрдЯрд░ рдирд╛рдореЛрдВ рдХреЗ рдЕрдкрд╡рд╛рдж рдХреЗ рд╕рд╛рдеред </font><font style="vertical-align: inherit;">рдореИрдХреНрд░реЛ рдХреЛ RESTORE_CONTEXT рдХреЗ рд╕рд╛рде рдмрд┐рд▓реНрдЯ-рдЗрди рдЕрд╕реЗрдВрдмрд▓рд░ рдмреНрд▓реЙрдХ рдХреЗ рдЕрдВрдд рдореЗрдВ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movq %%rsp,%P[threadrsp](%[prev])\n\t"</span></span> <span class="hljs-comment"><span class="hljs-comment">/* save RSP */</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреБрд░рд╛рдиреЗ рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ TSS рдореЗрдВ рд╕рд╣реЗрдЬрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЗрдирдкреБрдЯ рдСрдкрд░реЗрдВрдб рд╕реЗрдХреНрд╢рди рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдирдИ рдиреЛрдЯреЗрд╢рди рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ: рдпрд╣ </font></font><code>[threadrsp]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">task_struct рдХреЗ рдЕрдВрджрд░ thread.rsp рдХреА рдбрд╛рдпрд░реЗрдХреНрдЯ рдСрдлрд╕реЗрдЯ рд╣реИред </font></font><code>%P</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">dereferences рдкреНрд░рдмрд▓: рдереНрд░реЗрдбрдкреЙрдЗрдВрдЯ рдкреЙрдЗрдВрдЯрд░ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдЕрджреНрдпрддрди SP рдареАрдХ рд╕реЗ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movq %P[threadrsp](%[next]),%%rsp\n\t"</span></span> <span class="hljs-comment"><span class="hljs-comment">/* restore RSP */</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдирдП рдХрд╛рд░реНрдп рдХреЗ рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"call __switch_to\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рднрд╛рдЧ C рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЗрд╕рдХрд╛ рд╡рд░реНрдгрди рдЕрдЧрд▓реЗ рднрд╛рдЧ рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">".globl thread_return\n"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рд╡реИрд╢реНрд╡рд┐рдХ рд▓реЗрдмрд▓ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ </font></font><code>thread_return</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"thread_return:\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЗ рд▓рд┐рдП рд╕рдВрдХреНрд░рдордг рдмрд┐рдВрджреБ </font></font><code>thread_return</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рд╡рд┐рд╢реБрджреНрдз рд░реВрдк рд╕реЗ рдпрд╛рдВрддреНрд░рд┐рдХ рд░реВрдк рд╕реЗ, рдирд┐рд░реНрджреЗрд╢ рд╕реВрдЪрдХ рдХреЛ рдЕрдЧрд▓реЗ рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред </font><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╛ рддреЛ рдХрд░реНрдиреЗрд▓ рдореЗрдВ рдпрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬреИрд╕реЗ glibc)ред </font><font style="vertical-align: inherit;">рдореЗрд░рд╛ рдЕрдиреБрдорд╛рди рд╣реИ рдХрд┐ pthreads рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ ... рд▓реЗрдХрд┐рди рдпрд╣ рдРрд╕рд╛ рдирд╣реАрдВ рд▓рдЧрддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movq %%gs:%P[pda_pcurrent],%%rsi\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреНрд░рддрд┐-рдХрд╛рд░реНрдп рдбреЗрдЯрд╛ рдХреНрд╖реЗрддреНрд░ (рдкреАрдбреАрдП) рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рдХреЗ рд╡рд░реНрддрдорд╛рди рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рд╕реВрдЪрдХрд╛рдВрдХ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдХрд░реНрдиреЗрд▓ рдореЛрдб рдореЗрдВ, рдЬреАрдПрд╕ рдХреЛ рд╣рдореЗрд╢рд╛ рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movq %P[thread_info](%%rsi),%%r8\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдВрд░рдЪрдирд╛ </font></font><code>thread_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЛ r8 рдореЗрдВ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рд▓рд┐рдирдХреНрд╕ 2.6 рдХреЗ рд▓рд┐рдП рдирдпрд╛ рд╣реИ, рдФрд░ рдЕрдирд┐рд╡рд╛рд░реНрдп рд░реВрдк рд╕реЗ рдПрдХ рд╣рд▓реНрдХрд╛ рд╕рдВрд╕реНрдХрд░рдг рд╣реИ </font></font><code>task_struct</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЬреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рд╕реНрдЯреИрдХ рдкрд░ рдлрд┐рдЯ рдмреИрдарддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"btr %[tif_fork],%P[ti_flags](%%r8)\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CF рдореЗрдВ TIF_FORK рдмрд┐рдЯ рдорд╛рди рд╕рд╣реЗрдЬрддрд╛ рд╣реИ </font></font><code>thread_info-&gt;flags</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдФрд░ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рдмрд┐рдЯ рдХреЛ рд░реАрд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдХреБрдЫ рдкрдВрдХреНрддрд┐рдпреЛрдВ рдХреЗ рдмрд╛рдж, рдпрд╣ рдмрд┐рдЯ рдХрд╛рдВрдЯрд╛ / рдХреНрд▓реЛрдирд┐рдВрдЧ рдХреЗ рдмрд╛рдж рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ ret_from_fork рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"movq %%rax,%%rdi\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"></font><code>task_struct</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RDI рдХреЛ рдкрд┐рдЫрд▓реА рд╕реНрдЯреНрд░реАрдо </font><font style="vertical-align: inherit;">рдмрдЪрд╛рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">EAX рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдЕрдВрддрд┐рдо рдирд┐рд░реНрджреЗрд╢ C рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рд╣реИ </font></font><code>__switch_to</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдЬреЛ </font></font><code>prev</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">EAX рдкрд░ </font><font style="vertical-align: inherit;">рд▓реМрдЯрддрд╛ </font><font style="vertical-align: inherit;">рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-string"><span class="hljs-string">"jc ret_from_fork\n\t"</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдпрджрд┐ рдпрд╣ рдзрд╛рдЧрд╛ рдПрдХ рддрд╛рдЬрд╝рд╛ рдХрд╛рдВрдЯрд╛ / рдХреНрд▓реЛрди рд╣реИ, рддреЛ рдлрд┐рд░ рд╕реЗ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП ret_from_fork рдкрд░ рдЬрд╛рдПрдВред </font></font><br><br><pre> <code class="cpp hljs">: <span class="hljs-string"><span class="hljs-string">"=a"</span></span> (last)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдкрд┐рдЫрд▓реА рдзрд╛рд░рд╛ EAX рдкрд░ рд╡рд╛рдкрд╕ рдЖ рдЧрдИ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">: [next] <span class="hljs-string"><span class="hljs-string">"S"</span></span> (next), [prev] <span class="hljs-string"><span class="hljs-string">"D"</span></span> (prev), [threadrsp] <span class="hljs-string"><span class="hljs-string">"i"</span></span> (offsetof(struct task_struct, thread.rsp)), [ti_flags] <span class="hljs-string"><span class="hljs-string">"i"</span></span> (offsetof(struct thread_info, flags)), [tif_fork] <span class="hljs-string"><span class="hljs-string">"i"</span></span> (TIF_FORK), [thread_info] <span class="hljs-string"><span class="hljs-string">"i"</span></span> (offsetof(struct task_struct, thread_info)), [pda_pcurrent] <span class="hljs-string"><span class="hljs-string">"i"</span></span> (offsetof(struct x8664_pda, pcurrent))</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрдирд▓рд╛рдЗрди рдЕрд╕реЗрдВрдмрд▓рд░ рдХреЗ рд▓рд┐рдП рдЗрдирдкреБрдЯ рд▓рд┐рдВрдХред </font><font style="vertical-align: inherit;">рдЙрдирдореЗрдВ рд╕реЗ рдЬреНрдпрд╛рджрд╛рддрд░ рдСрдлрд╕реЗрдЯ рдХреЗ рд╕рд╛рде рдкреНрд░рддреНрдпрдХреНрд╖ рдСрдкрд░реЗрдВрдб рд╣реИрдВред </font><font style="vertical-align: inherit;">рдКрдкрд░ рд╣рдо рдкрд╣рд▓реЗ рд╣реА рдЙрдирдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднрд╛рдЧ рдЪреБрдХреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs">: <span class="hljs-string"><span class="hljs-string">"memory"</span></span>, <span class="hljs-string"><span class="hljs-string">"cc"</span></span> __EXTRA_CLOBBER)</code> </pre> <br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 2.6.0 (x86_64 C)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/x86_64/kernel/process.c */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *__</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch_to</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">, *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpu = smp_processor_id(); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init_tss</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cpu</span></span></span><span class="hljs-class">;</span></span> unlazy_fpu(prev_p); tss-&gt;rsp0 = next-&gt;rsp0; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%es,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (prev-&gt;es))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;es | prev-&gt;es)) loadsegment(es, next-&gt;es); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%ds,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (prev-&gt;ds))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;ds | prev-&gt;ds)) loadsegment(ds, next-&gt;ds); load_TLS(next, cpu); <span class="hljs-comment"><span class="hljs-comment">/* Switch FS and GS. */</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> fsindex; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%fs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=g"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (fsindex))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(fsindex | next-&gt;fsindex | prev-&gt;fs)) { loadsegment(fs, next-&gt;fsindex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fsindex) prev-&gt;fs = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* when next process has a 64bit base use it */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;fs) wrmsrl(MSR_FS_BASE, next-&gt;fs); prev-&gt;fsindex = fsindex; } { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> gsindex; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%gs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=g"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (gsindex))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(gsindex | next-&gt;gsindex | prev-&gt;gs)) { load_gs_index(next-&gt;gsindex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gsindex) prev-&gt;gs = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;gs) wrmsrl(MSR_KERNEL_GS_BASE, next-&gt;gs); prev-&gt;gsindex = gsindex; } <span class="hljs-comment"><span class="hljs-comment">/* Switch the PDA context. */</span></span> prev-&gt;userrsp = read_pda(oldrsp); write_pda(oldrsp, next-&gt;userrsp); write_pda(pcurrent, next_p); write_pda(kernelstack, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)next_p-&gt;thread_info + THREAD_SIZE - PDA_STACKOFFSET); <span class="hljs-comment"><span class="hljs-comment">/* Now maybe reload the debug registers */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;debugreg7)) { loaddebug(next, <span class="hljs-number"><span class="hljs-number">0</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">1</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">2</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* no 4 and 5 */</span></span> loaddebug(next, <span class="hljs-number"><span class="hljs-number">6</span></span>); loaddebug(next, <span class="hljs-number"><span class="hljs-number">7</span></span>); } <span class="hljs-comment"><span class="hljs-comment">/* Handle the IO bitmap */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(prev-&gt;io_bitmap_ptr || next-&gt;io_bitmap_ptr)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;io_bitmap_ptr) { <span class="hljs-built_in"><span class="hljs-built_in">memcpy</span></span>(tss-&gt;io_bitmap, next-&gt;io_bitmap_ptr, IO_BITMAP_BYTES); tss-&gt;io_bitmap_base = IO_BITMAP_OFFSET; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { tss-&gt;io_bitmap_base = INVALID_IO_BITMAP_OFFSET; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev_p; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдВрд╕реНрдХрд░рдг x86_64 рдореЗрдВ, C рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЛрдб рдореЗрдВ рдХрдИ рдмрджрд▓рд╛рд╡ рдЬреЛрдбрд╝реЗ рдЧрдП рд╣реИрдВред </font><font style="vertical-align: inherit;">рдореИрдВ рд╕рд╛рдзрд╛рд░рдг рдХреЗрд╕ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рдирд╣реАрдВ рджреЛрд╣рд░рд╛рдКрдВрдЧрд╛ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, EAX рдХреЛ RAX рдХрд╛ рдирд╛рдо рджреЗрдирд╛)ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%es,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (prev-&gt;es))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;es | prev-&gt;es)) loadsegment(es, next-&gt;es);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП ES рд╕реЗрдЧрдореЗрдВрдЯ рдмрдЪрд╛рддрд╛ рд╣реИ, рдФрд░ рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рддреЛ рдирдпрд╛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%ds,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=m"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (prev-&gt;ds))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;ds | prev-&gt;ds)) loadsegment(ds, next-&gt;ds);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд┐рд╕реА рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдПрдХ рдбреЗрдЯрд╛ рдЦрдВрдб рдмрдЪрд╛рддрд╛ рд╣реИ, рдФрд░ рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рддреЛ рдПрдХ рдирдпрд╛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> fsindex; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">asm</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">volatile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"movl %%fs,%0"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> : </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"=g"</span></span></span></span><span class="hljs-function"><span class="hljs-params"> (fsindex))</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(fsindex | next-&gt;fsindex | prev-&gt;fs)) { loadsegment(fs, next-&gt;fsindex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fsindex) prev-&gt;fs = <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FS рдЦрдВрдб рдХреЛ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИ </font></font><code>fsindex</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рдФрд░ рдлрд┐рд░ рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рддреЛ рдПрдХ рдирдП рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП FS рд▓реЛрдб рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╕рд┐рджреНрдзрд╛рдВрдд рд░реВрдк рдореЗрдВ, рдпрджрд┐ рдХрд┐рд╕реА рдкреБрд░рд╛рдиреЗ рдпрд╛ рдирдП рдХрд╛рд░реНрдп рдореЗрдВ рдПрдлрдПрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡реИрдз рдореВрд▓реНрдп рд╣реИ, рддреЛ рдЙрд╕рдХреЗ рд╕реНрдерд╛рди рдкрд░ рдХреБрдЫ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рд╢рд╛рдпрдж NULL)ред </font><font style="vertical-align: inherit;">рдПрдлрдПрд╕ рдЖрдорддреМрд░ рдкрд░ рд╕реНрдерд╛рдиреАрдп рд╕реНрдЯреНрд░реАрдо рд╕реНрдЯреЛрд░реЗрдЬ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рд╣реЛрдиреЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЬреАрдПрд╕ рдХреЗ рд▓рд┐рдП рд╕рдорд╛рди рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рджреЛрд╣рд░рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред </font><font style="vertical-align: inherit;">рдЬреАрдПрд╕ рдЖрдорддреМрд░ рдкрд░ рдПрдХ рд╕реЗрдЧрдореЗрдВрдЯ рд╣реИ </font></font><code>thread_info</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;fs) wrmsrl(MSR_FS_BASE, next-&gt;fs);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрджрд┐ рдЕрдЧрд▓реЗ рдХрд╛рд░реНрдп рдореЗрдВ рдПрдлрдПрд╕ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдХрд┐ рд╕рдВрдкреВрд░реНрдг 64-рдмрд┐рдЯ рдорд╛рди рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рд╕реЗрдЧрдореЗрдВрдЯ рд░рдЬрд┐рд╕реНрдЯрд░ 16/32-рдмрд┐рдЯ рдпреБрдЧ рдХреА рдПрдХ рдХрд▓рд╛рдХреГрддрд┐ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдПрдХ рд╡рд┐рд╢реЗрд╖ рдлрд╝рдВрдХреНрд╢рди рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдКрдкрд░реА 32 рдмрд┐рдЯреНрд╕ рд▓рд┐рдЦреЗ рдЧрдП рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs">prev-&gt;fsindex = fsindex;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП FS рд╕рд╣реЗрдЬреЗрдВред </font></font><br><br><pre> <code class="cpp hljs">prev-&gt;userrsp = read_pda(oldrsp); write_pda(oldrsp, next-&gt;userrsp); write_pda(pcurrent, next_p); write_pda(kernelstack, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)next_p-&gt;thread_info + THREAD_SIZE - PDA_STACKOFFSET);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрдЧрд╛рдореА рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП рдкреАрдбреАрдП рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рдирд╛, рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдХреЗ рдкреБрд░рд╛рдиреЗ рдЖрд░рдПрд╕рдкреА (рд╕рд┐рд╕реНрдХреЙрд▓) рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред </font><font style="vertical-align: inherit;">рдкреАрдбреАрдП рдХреЛ рд╕реНрдЯреНрд░реАрдо рдФрд░ рд╕реНрдЯреИрдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред</font></font><br><br><a name="7"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 3.0: рдЖрдзреБрдирд┐рдХ рдУрдПрд╕ (2011) </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдВрдмрд░ рдХреЛ рдзреЛрдЦрд╛ рди рджреЗрдВред </font><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд╕рдВрд╕реНрдХрд░рдг 3.0 </font><font style="vertical-align: inherit;">2.6.0 рдХреЗ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рдЧрднрдЧ 8 рд╕рд╛рд▓</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдмрд╛рдж </font><font style="vertical-align: inherit;">рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рднрд╛рд░реА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдПрдХ рдкреВрд░реА рдкреБрд╕реНрддрдХ рдХреЗ рдпреЛрдЧреНрдп рд╣реИрдВ, рдФрд░ рдореИрдВ рдЖрдкрдХреЛ рд╕рдм рдХреБрдЫ рдирд╣реАрдВ рдмрддрд╛ рд╕рдХрддрд╛ред </font><font style="vertical-align: inherit;">рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП, i386 рдФрд░ x86_64 рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдлрд╝рд╛рдЗрд▓реЛрдВ (process_32.c рдФрд░ process_64.sред) рдХреЗ рд╕рд╛рде x86 рдореЗрдВ рд╕рдВрдпреБрдХреНрдд рд╣реИрдВред рдпрд╣ рд▓реЗрдЦ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдмрд╣реБрдд рдмрдбрд╝рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рдХреЗрд╡рд▓ рдмрд╛рдж рдореЗрдВ x86_64 рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░реЗрдВрдЧреЗ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ред </font><font style="vertical-align: inherit;">рд╣рдо рдХреЗрд╡рд▓ рдХреБрдЫ рд╡рд┐рд╡рд░рдгреЛрдВ рдХреЛ рд░реЗрдЦрд╛рдВрдХрд┐рдд рдХрд░реЗрдВрдЧреЗ рдФрд░ рдирд╡реАрдирддрдо рдПрд▓рдЯреАрдПрд╕ рдкрд░ рдХрд░реАрдм рд╕реЗ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВрдЧреЗред </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/d0a/a82/1f5/d0aa821f59086dc1f0937e4139353fff.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 3.0.1 (рдЕрдВрддрд░реНрдирд┐рд╣рд┐рдд рдХреЛрдб x86_64)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/x86/include/asm/system.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SAVE_CONTEXT </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pushf ; pushq %%rbp ; movq %%rsi,%%rbp\n\t"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> RESTORE_CONTEXT </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %%rbp,%%rsi ; popq %%rbp ; popf\t"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> __EXTRA_CLOBBER \ ,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rcx"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rbx"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"rdx"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r8"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r9"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r10"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r11"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r12"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r13"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r14"</span></span></span><span class="hljs-meta">,</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r15"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev, next, last) asm volatile(SAVE_CONTEXT </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %%rsp,%P[threadrsp](%[prev])\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* save RSP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %P[threadrsp](%[next]),%%rsp\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* restore RSP */</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"call __switch_to\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq "</span></span></span><span class="hljs-meta">__percpu_arg([current_task])</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">",%%rsi\n\t"</span></span></span><span class="hljs-meta"> __switch_canary </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %P[thread_info](%%rsi),%%r8\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %%rax,%%rdi\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"testl %[_tif_fork],%P[ti_flags](%%r8)\n\t"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jnz ret_from_fork\n\t"</span></span></span><span class="hljs-meta"> RESTORE_CONTEXT : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=a"</span></span></span><span class="hljs-meta"> (last) __switch_canary_oparam : [next] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"S"</span></span></span><span class="hljs-meta"> (next), [prev] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"D"</span></span></span><span class="hljs-meta"> (prev), [threadrsp] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (offsetof(struct task_struct, thread.sp)), [ti_flags] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (offsetof(struct thread_info, flags)), [_tif_fork] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (_TIF_FORK), [thread_info] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"i"</span></span></span><span class="hljs-meta"> (offsetof(struct task_struct, stack)), [current_task] </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"m"</span></span></span><span class="hljs-meta"> (current_task) __switch_canary_iparam : </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"memory"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"cc"</span></span></span><span class="hljs-meta"> __EXTRA_CLOBBER)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрда рд╕рд╛рд▓ - рдФрд░ рдореИрдХреНрд░реЛ рдореЗрдВ </font></font><code>switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЗрд╡рд▓ рдЪрд╛рд░ рдкрд░рд┐рд╡рд░реНрддрдиред </font><font style="vertical-align: inherit;">рдЙрдирдореЗрдВ рд╕реЗ рджреЛ рдПрдХ рджреВрд╕рд░реЗ рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реЗ рд╣реБрдП рд╣реИрдВ, рдФрд░ рдХреБрдЫ рднреА рдирдпрд╛ рдирд╣реАрдВ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">movq <span class="hljs-string"><span class="hljs-string">"__percpu_arg([current_task])"</span></span>,%%rsi\n\t</code> </pre> <br><font style="vertical-align: inherit;"></font><code>task_struct</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрд░рдПрд╕рдЖрдИ рдХреЗ рд▓рд┐рдП </font><font style="vertical-align: inherit;">рдирдП рдЯрд╛рдВрдХреЗ рдЪрд▓рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдпрд╣ рдХрд╛рд░реНрдп рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХрд╛ "рдирдпрд╛" рддрд░реАрдХрд╛ рд╣реИ: рдкреНрд░рддреНрдпреЗрдХ рд╕реАрдкреАрдпреВ рдореЗрдВ рдПрдХ рд╕реНрдерд┐рд░ рдкреНрд░рддреАрдХ рд╣реЛрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдкрд╣рд▓реЗ, рдЬрд╛рдирдХрд╛рд░реА GS: [рдкреАрдбреАрдП рдСрдлрд╕реЗрдЯ] рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдкрд▓рдмреНрдз рдереАред </font><font style="vertical-align: inherit;">рдЗрд╕рдХреЗ рдмрд╛рдж рдХреЗ RSI рдСрдкрд░реЗрд╢рди рд╕рдВрд╕реНрдХрд░рдг 2.6 рдореЗрдВ рд╣реА рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs">__switch_canary</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рдореИрдХреНрд░реЛ рдЖрдкрдХреЛ рдЕрддрд┐рд░рд┐рдХреНрдд рд░реВрдк рд╕реЗ рдЬрд╛рдБрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ CONFIG_CC_STACKPROTECTOR рдореИрдХреНрд░реЛ рдХрд░реНрдиреЗрд▓ рдЕрд╕реЗрдВрдмрд▓реА рдХреЗ рджреМрд░рд╛рди рд╕рдХреНрд╖рдо рд╣реИ рдпрд╛ рдирд╣реАрдВред </font><font style="vertical-align: inherit;">рдореИрдВ рдЗрд╕ рд╡рд┐рд╖рдп рдХреЛ рдмрд╣реБрдд рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреЛрджрдиреЗ рд╡рд╛рд▓рд╛ рдирд╣реАрдВ рд╣реВрдВ, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рдпрд╣ рддрдВрддреНрд░ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдвреЗрд░ рдХреЗ рд╣реИрдХрд░ рд╡рд┐рдирд╛рд╢ рд╕реЗ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдмрдЪрд╛рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рд╣рдо рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдореВрд▓реНрдп рдХреЛ рдмрдЪрд╛рддреЗ рд╣реИрдВ, рдФрд░ рдмрд╛рдж рдореЗрдВ рд╣рдо рдЗрд╕реЗ рдЬрд╛рдВрдЪрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдпрджрд┐ рдЕрд░реНрде рдмрджрд▓ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдкрд░реЗрд╢рд╛рдиреАред</font></font><br><br><pre> <code class="cpp hljs">testl %[_tif_fork],%P[ti_flags](%%r8)\n\t jnz ret_from_fork\n\t</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЬрд╛рдБрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдХреНрд▓реЛрдирд┐рдВрдЧ / рдХрд╛рдВрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдирдпрд╛ рдХрд╛рд░реНрдп рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдлрд┐рд░ рдЖрдЧреЗ рдмрдврд╝рддрд╛ рд╣реИ </font></font><code>ret_from_fork()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдпрд╣ рдПрдХ рдирд┐рд░реНрджреЗрд╢ рд╣реБрдЖ рдХрд░рддрд╛ рдерд╛ </font></font><code>btr</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, рд▓реЗрдХрд┐рди рдЕрдм рд╣рдо рдХреЙрд▓ рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рддрдХ рдмрд┐рдЯ рдХреЗ рд░реАрд╕реЗрдЯ рдХреЛ рд╕реНрдердЧрд┐рдд рдХрд░ рджреЗрддреЗ рд╣реИрдВред </font><font style="vertical-align: inherit;">рдкрд░реАрдХреНрд╖рдг рдкрд░рд┐рд╡рд░реНрддрди рдХреЗ рдХрд╛рд░рдг рдирд╛рдо рдмрджрд▓рдХрд░ рдЬреЗрдПрдирдЬреЗрдб рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: рдпрджрд┐ рдмрд┐рдЯ рд╕реЗрдЯ рд╣реИ, рддреЛ рдЯреЗрд╕реНрдЯ (рдФрд░) рд╕рдХрд╛рд░рд╛рддреНрдордХ рд╣реЛрдЧрд╛ред</font></font><br><br><pre> <code class="cpp hljs">__switch_canary_oparam</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЗ рд▓рд┐рдП рд╕реНрдЯреИрдХ рдХреИрдирд░реА рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ </font></font><code>CONFIG_CC_STACKPROTECTOR</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">__switch_canary_iparam</code> </pre> <br><font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 3.0.1 рдХреЗ</font></b><font style="vertical-align: inherit;"> рд▓рд┐рдП рдЗрдирдкреБрдЯ рд╕реНрдЯреИрдХ рдХреИрдирд░реА </font></font><code>CONFIG_CC_STACKPROTECTOR</code> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(x86_64 C)</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/x86/kernel/process_64.c */</span></span> __notrace_funcgraph <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> * __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch_to</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpu = smp_processor_id(); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">per_cpu</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init_tss</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cpu</span></span></span><span class="hljs-class">);</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> fsindex, gsindex; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> preload_fpu; preload_fpu = tsk_used_math(next_p) &amp;&amp; next_p-&gt;fpu_counter &gt; <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* we're going to use this soon, after a few expensive things */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preload_fpu) prefetch(next-&gt;fpu.state); <span class="hljs-comment"><span class="hljs-comment">/* Reload esp0, LDT and the page table pointer: */</span></span> load_sp0(tss, next); savesegment(es, prev-&gt;es); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;es | prev-&gt;es)) loadsegment(es, next-&gt;es); savesegment(ds, prev-&gt;ds); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;ds | prev-&gt;ds)) loadsegment(ds, next-&gt;ds); savesegment(fs, fsindex); savesegment(gs, gsindex); load_TLS(next, cpu); __unlazy_fpu(prev_p); <span class="hljs-comment"><span class="hljs-comment">/* Make sure cpu is ready for new context */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preload_fpu) clts(); arch_end_context_switch(next_p); <span class="hljs-comment"><span class="hljs-comment">/* Switch FS and GS. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(fsindex | next-&gt;fsindex | prev-&gt;fs)) { loadsegment(fs, next-&gt;fsindex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fsindex) prev-&gt;fs = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* when next process has a 64bit base use it */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;fs) wrmsrl(MSR_FS_BASE, next-&gt;fs); prev-&gt;fsindex = fsindex; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(gsindex | next-&gt;gsindex | prev-&gt;gs)) { load_gs_index(next-&gt;gsindex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (gsindex) prev-&gt;gs = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next-&gt;gs) wrmsrl(MSR_KERNEL_GS_BASE, next-&gt;gs); prev-&gt;gsindex = gsindex; <span class="hljs-comment"><span class="hljs-comment">/* Switch the PDA and FPU contexts. */</span></span> prev-&gt;usersp = percpu_read(old_rsp); percpu_write(old_rsp, next-&gt;usersp); percpu_write(current_task, next_p); percpu_write(kernel_stack, (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)task_stack_page(next_p) + THREAD_SIZE - KERNEL_STACK_OFFSET); <span class="hljs-comment"><span class="hljs-comment">/* Now maybe reload the debug registers and handle I/O bitmaps */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(task_thread_info(next_p)-&gt;flags &amp; _TIF_WORK_CTXSW_NEXT || task_thread_info(prev_p)-&gt;flags &amp; _TIF_WORK_CTXSW_PREV)) __switch_to_xtra(prev_p, next_p, tss); <span class="hljs-comment"><span class="hljs-comment">/* Preload the FPU context - task is likely to be using it. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preload_fpu) __math_state_restore(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev_p; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реА рдХреЛрдб рдореЗрдВ рдХреБрдЫ рдмрджрд▓рд╛рд╡ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╡реЗ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рдХрдо рд╣реИрдВ, рд░рд┐рд▓реАрдЬ рдХреЗ рдмреАрдЪ рдЖрда рд╕рд╛рд▓ рджрд┐рдП рдЧрдП рд╣реИрдВред </font><font style="vertical-align: inherit;">рдЙрдирдореЗрдВ рд╕реЗ рдХреБрдЫ рдХреЙрд╕реНрдореЗрдЯрд┐рдХ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рд╕рднреА рдШреЛрд╖рдгрд╛рдУрдВ рдХреЗ рд╢реАрд░реНрд╖ рдкрд░ рдЬрд╛рдирд╛ред </font><font style="vertical-align: inherit;">рдпрд╣рд╛рдБ рдХреНрдпрд╛ рдмрджрд▓ рдЧрдпрд╛ рд╣реИ:</font></font><br><br><pre> <code class="cpp hljs">__notrace_funcgraph <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> * __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch_to</span></span></span><span class="hljs-class">(...)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ рдирдпрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ </font></font><code>__notrace_funcgraph</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЯреНрд░реИрдХрд┐рдВрдЧ рд╕реЗ рд╕рдХреНрд░рд┐рдп рдлреБрдЯ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░рддрд╛ рд╣реИ </font></font><code>switch_to</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">preload_fpu = tsk_used_math(next_p) &amp;&amp; next_p-&gt;fpu_counter &gt; <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preload_fpu) prefetch(next-&gt;fpu.state);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдпрд╣ рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдПрдлрдкреАрдпреВ рдЕрдВрддрд┐рдо рдХрд╛рд░реНрдп рдореЗрдВ рдкрд┐рдЫрд▓реЗ 5 рдмрд╛рд░ рд╕реНрд▓рд╛рдЗрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдлрд┐рд░ рдмрд╛рдж рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рдХреЛ рдХреИрд╢ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">load_sp0(tss, next);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд░реНрдиреЗрд▓ рд╕реНрдкреЗрд╕ рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░ рдХреЛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ, рдкреЗрдЬ рдЯреЗрдмрд▓ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рд╣рд╛рдЗрдкрд░рд╡рд┐рдЬрд░ (рдпрджрд┐ рд▓рд╛рдЧреВ рд╣реЛ) рдХреЛ рд╕реВрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">savesegment(es, prev-&gt;es);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ES рдЦрдВрдб рдмрдЪрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдПрдХ рдирд╡реАрдирддрд╛ рдирд╣реАрдВ рд╣реИ, рд╕рд┐рд░реНрдл 2.6 рд╕реЗ рдЗрдирд▓рд╛рдЗрди рдХреЛрдбрд╛рдВрддрд░рдХ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрди рд╣реИ:</font></font><code>asm volatile("movl %%es,%0" : "=m" (prev-&gt;es));</code>  ред <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preload_fpu) clts();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдЧрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рддреЛ рддреБрд░рдВрдд FPU рдХреЛ рд░рд┐рдмреВрдЯ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЖрд╡реЗрджрди </font></font><code>clts()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- рдПрдХ рд╣реА рд╡рд┐рдЪрд╛рд░ рд╣реИ рдХрд┐ рд╣рдо рд▓рд┐рдирдХреНрд╕ рдХреЗ рдкрд╣рд▓реЗ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде рджреЗрдЦрд╛ рдерд╛: </font></font><code>"cmpl %%ecx,%2\n\t jne 1f\n\t clts\n"</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">jne <span class="hljs-number"><span class="hljs-number">1f</span></span>\n\t clts\n<span class="hljs-string"><span class="hljs-string">" arch_end_context_switch(next_p);</span></span></code> </pre> <br><font style="vertical-align: inherit;"></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬреЗрд╢рди рдХреЗ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдП рдХреЗрд╡рд▓ рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рд╣реИ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рд╕рд╛рдорд╛рдиреНрдп рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ, рдПрдХ рдлрд╝рдВрдХреНрд╢рди </font></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреБрдЫ рднреА рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ред </font><font style="vertical-align: inherit;">рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЕрдВрддрд┐рдо рдХрд░реНрдиреЗрд▓ рд╕рдВрд╕реНрдХрд░рдг рджреЗрдЦреЗрдВред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(task_thread_info(next_p)-&gt;flags &amp; _TIF_WORK_CTXSW_NEXT || task_thread_info(prev_p)-&gt;flags &amp; _TIF_WORK_CTXSW_PREV)) __switch_to_xtra(prev_p, next_p, tss);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ рдХрд╛рд░реНрдпреЛрдВ рдореЗрдВ рд▓рдЧреЗ рд╣реБрдП рд╣реИрдВ, рдЬрд┐рд╕реЗ рдкрд╣рд▓реЗ </font></font><code>switch_to</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдбрд┐рдмрдЧ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдФрд░ I / O рдмрд┐рдЯрдореИрдк рдорд╛рдкрджрдВрдбреЛрдВ рд╕рд╣рд┐рдд </font><font style="vertical-align: inherit;">рдЕрдВрдд рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рд╣рдо рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреЛрдб рд╕рдореАрдХреНрд╖рд╛ 4.14.67 рдореЗрдВ рдмрддрд╛рдПрдВрдЧреЗред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (preload_fpu) __math_state_restore();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕рдХреЗ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдБрдЪ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж FPU рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЗ рд╕рдлрд▓ рд╕рдВрдпреЛрдЬрди рдХреЗ рд╕рд╛рде, рдбреЗрдЯрд╛ рдкрд╣рд▓реЗ рд╕реЗ рдХрд┐рдП рдЧрдП рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЪрдпрди рдХреЗ рд▓рд┐рдП рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХреИрд╢ рдореЗрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред</font></font><br><br><a name="8"></a><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдирдХреНрд╕ 4.14.67: рдирд╡реАрдирддрдо LTS (2018) </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рдЖрдВрддрд░рд┐рдХ рдХрд╛рдордХрд╛рдЬ рдореЗрдВ рдпрд╣ рд╣рдорд╛рд░реА рд╕рдмрд╕реЗ рдЧрд╣рд░реА рд╡рд┐рд╕рд░реНрдЬрди рд╣реИред </font><font style="vertical-align: inherit;">3.0 рдХреА рд░рд┐рд╣рд╛рдИ рдХреЗ рдмрд╛рдж рд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХрд╛рдлреА рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдХреЛрдб рдХрд╛ рдЖрдпреЛрдЬрди рдХрд┐рдпрд╛ред </font><font style="vertical-align: inherit;">рдХреБрд▓ рдорд┐рд▓рд╛рдХрд░, рдпрд╣ рдЕрдм рд╕рд╛рдл рджрд┐рдЦрддрд╛ рд╣реИ рдФрд░ рдкрд╣рд▓реЗ рд╕реЗ рдХрд╣реАрдВ рдЬреНрдпрд╛рджрд╛ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рд╣реИред </font><font style="vertical-align: inherit;">X86_64 рдХреЗ рд▓рд┐рдП:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/140/b4b/ca3/140b4bca3a13ffac5abe3a2b3e723dc0.png"><br><br><ul><li>   3.4    <code>switch_to()</code>     <a href="" rel="nofollow">arch/x86/include/asm/switch_to.h</a> .     ,   <code>context_switch()</code>  <a href="" rel="nofollow">kernel/sched/core.</a> . <br></li><li>    4.9 <code>switch_to()</code>    :  <code>prepare_switch_to()</code>          ( <a href="" rel="nofollow">arch/x86/entry/entry_64.S</a> ). <br></li><li>   C            .   2.6.24    <a href="" rel="nofollow">arch/x86/kernel/process_64.c</a> . </li></ul><br> <b>Linux 4.14.67</b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/x86/include/asm/switch_to.h */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> switch_to(prev, next, last) do { prepare_switch_to(prev, next); ((last) = __switch_to_asm((prev), (next))); } while (0)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рдкреБрд░рд╛рдиреА рдЧреБрдард▓реА рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рд╕рд░рд▓ рджрд┐рдЦрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рдкреБрдирд░реНрдЧрдарди рд╕рдорд╕реНрдпрд╛ рдХреЗ рд╕рдорд╛рдзрд╛рди рдХрд╛ рдкрд░рд┐рдгрд╛рдо рдерд╛ рдЬрдм рдПрдВрдбреА рд▓реБрддреЛрдорд┐рд░рд╕реНрдХреА рдиреЗ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рдЧрднрдЧ рдорд┐рд▓рд╛рди рдХрд░реНрдиреЗрд▓ рд╕реНрдЯреИрдХ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдкреЗрд╢ рдХрд┐рдпрд╛ </font><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">prepare_switch_to(prev, next);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рдВрджрд░реНрднреЛрдВ рдХреЛ рд╕реНрд╡рд┐рдЪ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХрд░реНрдиреЗрд▓ рд╕реНрдЯреИрдХ рдЙрдкрд▓рдмреНрдз рд╣реИрдВред </font><font style="vertical-align: inherit;">рд╡рд╕реНрддреБрддрдГ рдореИрдк рдХрд┐рдП рдЧрдП рдХрд░реНрдиреЗрд▓ рд╕реНрдЯреИрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп рд╕рдВрджрд░реНрдн рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рдкреНрд░рдпрд╛рд╕ рдХреЗ рджреМрд░рд╛рди рдпрд╣ рд╕рдВрднрд╡ рджреЛрд╣рд░реА рддреНрд░реБрдЯрд┐ рдпрд╛ рдХрд░реНрдиреЗрд▓ рдЖрддрдВрдХ рд╕реЗ рдмрдЪрд╛ рдЬрд╛рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">((last) = __switch_to_asm((prev), (next)));</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИред </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдХ </font></font><code>prepare_switch_to</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣реА рд╕реНрд░реЛрдд рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд </font><font style="vertical-align: inherit;">рдкрд░ рдПрдХ рдирдЬрд╝рд░ рдбрд╛рд▓реЗрдВ </font><font style="vertical-align: inherit;">ред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 4.14.67</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/x86/include/asm/switch_to.h */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare_switch_to</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct task_struct *prev, struct task_struct *next)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> CONFIG_VMAP_STACK READ_ONCE(*(unsigned char *)next-&gt;thread.sp); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> }</span></span></code> </pre> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> CONFIG_VMAP_STACK</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рд╕реНрдЯреИрдХ рд╡рд░реНрдЪреБрдЕрд▓ рдореЗрдореЛрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╣рдореЗрдВ рдХреЗрд╡рд▓ рд╡рд░реНрдЪреБрдЕрд▓ рд╕реНрдЯреИрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рдХрд░реНрдиреЗрд▓ рдмрд┐рд▓реНрдб рдХреЗ рджреМрд░рд╛рди рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкреИрд░рд╛рдореАрдЯрд░ рд╣реИред </font><font style="vertical-align: inherit;">рдХрдИ рдЖрдзреБрдирд┐рдХ рд╡рд┐рддрд░рдгреЛрдВ рдореЗрдВ, рдЗрд╕рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдореВрд▓реНрдп рд╣реИ </font></font><code>yes</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">READ_ONCE(*(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *)next-&gt;thread.sp);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреГрд╖реНрда рддрд╛рд▓рд┐рдХрд╛рдУрдВ (pgd) рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдЧрд▓реЗ рд╕реНрдЯреИрдХ рдХрд╛ рдЙрд▓реНрд▓реЗрдЦред </font><font style="vertical-align: inherit;">рдореБрдЦреНрдп рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ рд╣рдо рдПрдХ рдРрд╕реЗ рдкреЙрдЗрдВрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдЬреЛ рди рдХреЗрд╡рд▓ рдкреГрд╖реНрдареЛрдВ рдХреЗ рдмрд╛рд╣рд░ (рдкреГрд╖реНрда-рдмрд╛рд╣рд░) рд╣реИ, рдмрд▓реНрдХрд┐ vmalloc рдХреНрд╖реЗрддреНрд░ рдХреЗ рд╡рд┐рд▓рдВрдмрд┐рдд рд▓реЛрдбрд┐рдВрдЧ рдХреЗ рдХрд╛рд░рдг рдЗрд╕ рдХрд╛рд░реНрдп рдХреА рд╕реНрдореГрддрд┐ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рднреА рдирд╣реАрдВ рд╣реИред </font><font style="vertical-align: inherit;">рдпрджрд┐ рдЖрдк рд╕рдорд╕реНрдпрд╛ рдХреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣рд▓ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ </font><font style="vertical-align: inherit;">рдкреЙрдЗрдВрдЯрд░ рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдФрд░ рдЕрдкреНрд░рд╛рдкреНрдпрддрд╛ рдХрд╛ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдорддрд▓рдм рдХрд░реНрдиреЗрд▓ рдкреИрдирд┐рдХ рд╣реИ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 4.16.67</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/x86/entry/entry_64.S */</span></span> ENTRY(__switch_to_asm) UNWIND_HINT_FUNC <span class="hljs-comment"><span class="hljs-comment">/* Save callee-saved registers */</span></span> pushq %rbp pushq %rbx pushq %r12 pushq %r13 pushq %r14 pushq %r15 <span class="hljs-comment"><span class="hljs-comment">/* switch stack */</span></span> movq %rsp, TASK_threadsp(%rdi) <span class="hljs-function"><span class="hljs-function">movq </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TASK_threadsp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(%rsi)</span></span></span><span class="hljs-function">, %rsp </span><span class="hljs-meta"><span class="hljs-function"><span class="hljs-meta">#</span></span><span class="hljs-meta-keyword"><span class="hljs-function"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span></span><span class="hljs-function"><span class="hljs-meta"> CONFIG_CC_STACKPROTECTOR movq TASK_stack_canary(%rsi), %rbx movq %rbx, PER_CPU_VAR(irq_stack_union)+stack_canary_offset #</span></span><span class="hljs-meta-keyword"><span class="hljs-function"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span><span class="hljs-function"><span class="hljs-meta"> #</span></span><span class="hljs-meta-keyword"><span class="hljs-function"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span></span><span class="hljs-function"><span class="hljs-meta"> CONFIG_RETPOLINE FILL_RETURN_BUFFER %r12, RSB_CLEAR_LOOPS, X86_FEATURE_RSB_CTXSW #</span></span><span class="hljs-meta-keyword"><span class="hljs-function"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span><span class="hljs-function"><span class="hljs-meta"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-meta"><span class="hljs-comment">/* restore callee-saved registers */</span></span></span></span><span class="hljs-function"><span class="hljs-meta"> popq %r15 popq %r14 popq %r13 popq %r12 popq %rbx popq %rbp jmp __switch_to END(__switch_to_asm)</span></span></span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореЗрдВ </font></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">entry_64.S</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд╛рдо рд╣реИ рдХрд┐ рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдкрд┐рдЫрд▓реЗ 25 рд╡рд░реНрд╖реЛрдВ рдХреЗ рдЗрдирд▓рд╛рдЗрди рдХреЛрдбрд╛рдВрддрд░рдХ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">UNWIND_HINT_FUNC</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдУрдмреНрдЬреЗрдХреНрдЯреВрд▓ рд╕реНрдЯреИрдХ рдЯреНрд░реЗрд╕ рдЯреВрд▓ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдЯреВрд▓рдЯрд┐рдкреНрд╕ рдмрдирд╛рддрд╛ рд╣реИ рдЬреЛ рдмрд╕ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рд╡рд┐рд╢реЗрд╖ рдмрд┐рд▓реНрдб рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдЬреЛ рд╕рд╛рдорд╛рдиреНрдп рд╕реА рднрд╛рд╖рд╛ рдХреЙрд▓рд┐рдВрдЧ рд╕рдореНрдореЗрд▓рдиреЛрдВ рдХрд╛ рдкрд╛рд▓рди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред рдРрд╕реЗ рд╕рдВрдХреЗрдд </font><font style="vertical-align: inherit;">рд╕рдВрд╕реНрдХрд░рдг 4.6 рдореЗрдВ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдУрдЖрд░рд╕реА "рдХреЛрдб рдЕрдирдЗрдиреНрдбрд░"</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреЗ рд╕рдлрд▓ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдХрд╛ рдХрд╛рд░рдг рд╣реИрдВ </font><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">pushq %rbp, %rbx, %r12, %r13, %r14, %r15</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╣рдо рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЛ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкреБрд░рд╛рдиреЗ рд╕реНрдЯреИрдХ рдореЗрдВ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕рд╣реЗрдЬрддреЗ рд╣реИрдВ </font><font style="vertical-align: inherit;">, рдЬрд┐рд╕рд╕реЗ рд╣рдо рд╕реНрд╡рд┐рдЪ рдХрд░рддреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs">movq %rsp, TASK_threadsp(%rdi) <span class="hljs-function"><span class="hljs-function">movq </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TASK_threadsp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(%rsi)</span></span></span><span class="hljs-function">, %rsp</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореИрдВ рдкреБрд░рд╛рдиреЗ рдФрд░ рдирдП рдХрд╛рд░реНрдп рдХреЗ рдмреАрдЪ рд╕реНрдЯреИрдХ рдкреЙрдЗрдВрдЯрд░реНрд╕ рд╕реНрд╡реИрдк рдХрд░рддрд╛ рд╣реВрдВред </font><font style="vertical-align: inherit;">рд╕реАрдзреЗ рдкрд░рд┐рд╡реЗрд╢ рд╡рд┐рдзрд╛рдирд╕рднрд╛ рд╕реЗ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ, рд▓реЗрдХрд┐рди RDI рдФрд░ RSI рдЗрдирдкреБрдЯ рддрд░реНрдХ рд╣реЛрддреЗ рд╣реИрдВ </font></font><code>task_struct *</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд┐рдЫрд▓рд╛</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдФрд░ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдЧрд▓реЗ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕рдореНрдореЗрд▓рдиреЛрдВ рд╕рд┐рд╕реНрдЯрдо рд╡реА ABI рдХреЗ рдЕрдиреБрд╕рд╛рд░ред </font><font style="vertical-align: inherit;">рдпрд╣рд╛рдБ рдЙрдирдХреЗ рдЙрдкрдпреЛрдЧ рдХреЗ рд╕рд╛рде рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХрд╛ рдПрдХ рд╕рдмрд╕реЗрдЯ рд╣реИ:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/9bc/13e/410/9bc13e4108b9c67a1a9d8cd78439b7a5.png"><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> CONFIG_CC_STACKPROTECTOR movq TASK_stack_canary(%rsi), %rbx movq %rbx, PER_CPU_VAR(irq_stack_union)+stack_canary_offset</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрджрд┐ рд╕реНрдЯреИрдХ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдХреНрд╖рдо рд╣реИ, рддреЛ рдЗрд╕ рдХрд╛рд░реНрдп рдХрд╛ рдХреИрдирд░реА рдорд╛рди рд╡рд░реНрддрдорд╛рди CPU рдХреЗ рдЗрдВрдЯрд░рдкреНрдЯ рд╕реНрдЯреИрдХ рдореЗрдВ рдЙрдкрдпреБрдХреНрдд рд╕реНрдерд╛рди рдкрд░ рд▓реЗ рдЬрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╕реНрдЯреИрдХ рд╕реБрд░рдХреНрд╖рд╛ рдЖрдорддреМрд░ рдкрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рдХреНрд╖рдо рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рд╣реЛрддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> CONFIG_RETPOLINE FILL_RETURN_BUFFER %r12, RSB_CLEAR_LOOPS, X86_FEATURE_RSB_CTXSW</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ </font><font style="vertical-align: inherit;">рд╢рд╛рдЦрд╛ рднрд╡рд┐рд╖реНрдпрд╡рд╛рдгреА (рд╕реНрдкреЗрдХреНрдЯрд░ рднреЗрджреНрдпрддрд╛) рдХреЗ рд╕рдВрднрд╛рд╡рд┐рдд рд╢реЛрд╖рдг рд╕реЗ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реБрд░рдХреНрд╖рд╛ рд╣реИ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ред </font><font style="vertical-align: inherit;">рд╢реБрджреНрдз </font></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реНрд╡рд░</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> !</font></font><br><br><pre> <code class="cpp hljs">popq %r15, %r14, %r13, %r12, %rbx, %rbp</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд░рд┐рд╡рд░реНрд╕ рдХреНрд░рдо рдореЗрдВ </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдП рд╕реНрдЯреИрдХ</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд╕реЗ рд╕рднреА рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">: (r15, r14, r13, r12, rbx, rbp) </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓рд┐рдирдХреНрд╕ 4.16.67 ( </font><font style="vertical-align: inherit;">рдЯрд┐рдкреНрдкрдгрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде </font></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реНрд░реЛрдд</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> )</font></font></b> <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/** arch/x86/kernel/process_64.c */</span></span> __visible __notrace_funcgraph <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> * __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch_to</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">) {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_fpu</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_fpu</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpu = smp_processor_id(); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">per_cpu</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cpu_tss_rw</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cpu</span></span></span><span class="hljs-class">);</span></span> WARN_ON_ONCE(IS_ENABLED(CONFIG_DEBUG_ENTRY) &amp;&amp; this_cpu_read(irq_count) != <span class="hljs-number"><span class="hljs-number">-1</span></span>); switch_fpu_prepare(prev_fpu, cpu); save_fsgs(prev_p); load_TLS(next, cpu); arch_end_context_switch(next_p); savesegment(es, prev-&gt;es); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;es | prev-&gt;es)) loadsegment(es, next-&gt;es); savesegment(ds, prev-&gt;ds); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;ds | prev-&gt;ds)) loadsegment(ds, next-&gt;ds); load_seg_legacy(prev-&gt;fsindex, prev-&gt;fsbase, next-&gt;fsindex, next-&gt;fsbase, FS); load_seg_legacy(prev-&gt;gsindex, prev-&gt;gsbase, next-&gt;gsindex, next-&gt;gsbase, GS); switch_fpu_finish(next_fpu, cpu); <span class="hljs-comment"><span class="hljs-comment">/* Switch the PDA and FPU contexts. */</span></span> this_cpu_write(current_task, next_p); this_cpu_write(cpu_current_top_of_stack, task_top_of_stack(next_p)); <span class="hljs-comment"><span class="hljs-comment">/* Reload sp0. */</span></span> update_sp0(next_p); <span class="hljs-comment"><span class="hljs-comment">/* Now maybe reload the debug registers and handle I/O bitmaps */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(task_thread_info(next_p)-&gt;flags &amp; _TIF_WORK_CTXSW_NEXT || task_thread_info(prev_p)-&gt;flags &amp; _TIF_WORK_CTXSW_PREV)) __switch_to_xtra(prev_p, next_p, tss); <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> CONFIG_XEN_PV </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (unlikely(static_cpu_has(X86_FEATURE_XENPV) &amp;&amp; prev-&gt;iopl != next-&gt;iopl)) xen_set_iopl_mask(next-&gt;iopl); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (static_cpu_has_bug(X86_BUG_SYSRET_SS_ATTRS)) { unsigned short ss_sel; savesegment(ss, ss_sel); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (ss_sel != __KERNEL_DS) loadsegment(ss, __KERNEL_DS); } </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/* Load the Intel cache allocation PQR MSR. */</span></span></span><span class="hljs-meta"> intel_rdt_sched_in(); return prev_p; }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреЛрдб рдХрд╛ рдпрд╣ рдЖрдЦрд┐рд░реА рдмреНрд▓реЙрдХ рдЖрдкрдХреЛ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдореЗрдВ рдирд╡реАрдирддрдо рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рд╕реЗ рдкрд░рд┐рдЪрд┐рдд рд╣реЛрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ! </font><font style="vertical-align: inherit;">рдпрджрд┐ рдЖрдкрдиреЗ рддреБрд░рдВрдд рдЗрд╕ рд╕реНрдерд╛рди рдкрд░ рд▓реЗрдЦ рдХреЛ рд╕реНрдХреНрд░реЙрд▓ рдХрд┐рдпрд╛ рд╣реИ, рддреЛ рдЪрд┐рдВрддрд╛ рди рдХрд░реЗрдВ - рдореИрдВ рдпрд╣рд╛рдВ (рдФрд░) рдЕрдзрд┐рдХ рд╕реЗ рдЕрдзрд┐рдХ рдмрд┐рдВрджреБрдУрдВ рдкрд░ рдФрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд┐рдЪрд╛рд░ рдХрд░реВрдВрдЧрд╛ред </font><font style="vertical-align: inherit;">рдХреБрдЫ рдЕрдкрд╡рд╛рджреЛрдВ рдкрд░ рдзреНрдпрд╛рди рджреЗрдВ рдЬреЛ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдореЗрдВ рдЖрддреЗ рд╣реИрдВред</font></font><br><br><pre> <code class="cpp hljs">__visible __notrace_funcgraph <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> * __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">switch_to</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">task_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> C рдкрд░ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдХреЗ рд▓рд┐рдП рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрдИ рднрд╛рдЧреЛрдВ рдореЗрдВ рд╣реИрдВ: </font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрджреГрд╢реНрдп</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - рдпрд╣ рд╡рд┐рд╢реЗрд╖рддрд╛ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд▓реЗрдЖрдЙрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди рдЕрдиреБрдХреВрд▓рди</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЪрд░рд┐рддреНрд░ рдХреЛ рдирд╣реАрдВ рд╣рдЯрд╛рддрд╛ рд╣реИ </font></font><code>__switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__notrace_funcgraph</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font><b><font style="vertical-align: inherit;">рдлреБрдЯреНрд░реЗрд╕</font></b></font><code>__switch_to()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЯреНрд░реЗрд╕рд░ рд╕реЗ </font><font style="vertical-align: inherit;">рдмрдЪрд╛рддрд╛ </font><font style="vertical-align: inherit;">рд╣реИред </font><font style="vertical-align: inherit;">рдлрд╝рдВрдХреНрд╢рди рдХреЛ рд╕рдВрд╕реНрдХрд░рдг 2.6.29 рдореЗрдВ рд▓рдЧрднрдЧ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рдЬрд▓реНрдж рд╣реА рдЗрд╕реЗ рдЪрд╛рд▓реВ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЗрдирдкреБрдЯ рддрд░реНрдХ рдкреБрд░рд╛рдиреЗ рдФрд░ рдирдП рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд╕рдВрдХреЗрдд рд╣реИрдВ рдЬреЛ RDI рдФрд░ RSI рдХреЛ рджрд┐рдП рдЧрдП рд╣реИрдВред </font></font></li></ul><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_p</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">thread</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_fpu</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next_fpu</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">next</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fpu</span></span></span><span class="hljs-class">;</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрдирдкреБрдЯ рдбреЗрдЯрд╛ рд╕реЗ рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рдПрдХрддреНрд░ рдХрд░рддрд╛ рд╣реИ </font></font><code>task_struct *</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдереНрд░реЗрдб_рд╕реНрдЯреНрд░реИрдХ </font></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореЗрдВ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП TSS рдбреЗрдЯрд╛ (рд░рдЬрд┐рд╕реНрдЯрд░ рдЖрджрд┐) </font></font><code>fpu&gt;</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╢рд╛рдорд┐рд▓ рд╣реИрдВ </font><font style="vertical-align: inherit;">ред рд╕рдВрд░рдЪрдирд╛ </font><font style="vertical-align: inherit;">рдореЗрдВ FPU рдбреЗрдЯрд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдЕрдВрддрд┐рдо рд╕реАрдкреАрдпреВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЖрд░рдВрднреАрдХрд░рдг рдФрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдореВрд▓реНрдпред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> cpu = smp_processor_id();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдкреНрд░реЛрд╕реЗрд╕рд░ рдирдВрдмрд░ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдореЗрдВ TSS рдбреЗрдЯрд╛, рд╕реНрдерд╛рдиреАрдп рдереНрд░реЗрдб рд╕реНрдЯреЛрд░реЗрдЬ рдФрд░ рдЧреИрд╕ рдЬрдирд░реЗрдЯрд░ рдХреА рд╕реНрдерд┐рддрд┐ рдХреА рддреБрд▓рдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП GDT рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред </font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss_struct</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tss</span></span></span><span class="hljs-class"> = &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">per_cpu</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cpu_tss_rw</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cpu</span></span></span><span class="hljs-class">);</span></span></code> </pre> <br><font style="vertical-align: inherit;"></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд░реНрддрдорд╛рди TSS CPU рдХреЛ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">WARN_ON_ONCE(IS_ENABLED(CONFIG_DEBUG_ENTRY) &amp;&amp; this_cpu_read(irq_count) != <span class="hljs-number"><span class="hljs-number">-1</span></span>);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХреЗ рджреМрд░рд╛рди IRQ рд╕реНрдЯреИрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ рдирд╣реАрдВ рдФрд░ рдкреНрд░рддрд┐ рд▓реЛрдб рдПрдХ рдмрд╛рд░ рдЗрд╕рдХреА рд░рд┐рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдпрд╣ рд╡рд┐рдХрд╛рд╕ 4.14 рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рдерд╛, рдФрд░ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╣ рдХреЛрдб рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">switch_fpu_prepare(prev_fpu, cpu);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдПрдлрдкреАрдпреВ рдХреА рд╡рд░реНрддрдорд╛рди рд╕реНрдерд┐рддрд┐ рдХреЛ рдмрдЪрд╛рддрд╛ рд╣реИ рдЬрдмрдХрд┐ рд╣рдо рдкреБрд░рд╛рдиреЗ рдХрд╛рд░реНрдп рдореЗрдВ рд╣реИрдВред </font></font><br><br><pre> <code class="cpp hljs">save_fsgs(prev_p);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдПрдлрдПрд╕ рдФрд░ рдЬреАрдПрд╕ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╣рдо рд╕реНрдерд╛рдиреАрдп рд╕реНрдЯреНрд░реАрдо рд╕реНрдЯреЛрд░реЗрдЬ рдХреЛ рдмрджрд▓рддреЗ рд╣реИрдВред </font></font><br><br><pre> <code class="cpp hljs">load_TLS(next, cpu);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдП рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд╕реНрдерд╛рдиреАрдп рдереНрд░реЗрдб рднрдВрдбрд╛рд░рдг рдХреЗ рд▓рд┐рдП рдЬреАрдбреАрдЯреА рдХреЛ рдкреБрдирдГ рд▓реЛрдб рдХрд░реЗрдВред </font><font style="vertical-align: inherit;">рдпрд╛рдВрддреНрд░рд┐рдХ рд░реВрдк рд╕реЗ tls_array рдХреЛ рдПрдХ рдирдИ рд╕реНрдЯреНрд░реАрдо рд╕реЗ GDT рд░рд┐рдХреЙрд░реНрдб 6, 7, рдФрд░ 8 рдореЗрдВ рдХреЙрдкреА рдХрд░рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">arch_end_context_switch(next_p);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдХреЗрд╡рд▓ paravirtualization рдХреЗ рд╕рд╛рде рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред </font><font style="vertical-align: inherit;">Paravirt рдореЛрдб рдХреЛ рдмрджрд▓рддрд╛ рд╣реИ рдФрд░ рд╢реЗрд╖ рд╕рднреА рдмреИрдЪ рдХрд╛рд░реНрдп рдХреЛ рд╕рд╛рдлрд╝ рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рд╣рд╛рд▓ рдХреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд 2.6.x. </font><font style="vertical-align: inherit;">рдореИрдВ рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдореЗрдВ рдмрд╣реБрдд рдордЬрдмреВрдд рдирд╣реАрдВ рд╣реВрдВ, рдЗрд╕рд▓рд┐рдП рдореИрдВ рдЗрд╕реЗ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдиреБрд╕рдВрдзрд╛рди рдХреЗ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рд▓рд┐рдП </font><font style="vertical-align: inherit;">рдкрд╛рдардХреЛрдВ рдкрд░ </font><font style="vertical-align: inherit;">рдЫреЛрдбрд╝ рджреВрдВрдЧрд╛ </font><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs">savesegment(es, prev-&gt;es); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(next-&gt;es | prev-&gt;es)) loadsegment(es, next-&gt;es);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ES рдЦрдВрдб рдмрдЪрд╛рддрд╛ рд╣реИ рдФрд░ рдпрджрд┐ рдЖрд╡рд╢реНрдпрдХ рд╣реЛ рддреЛ рдПрдХ рдирдпрд╛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдПрдХ рд╕рдорд╛рди рдбреАрдПрд╕ рдХреЙрд▓ рдЫреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рднрд▓реЗ рд╣реА рдирдпрд╛ рдХрд╛рд░реНрдп рдбреАрдПрд╕ / рдИрдПрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдлрд┐рд░ рднреА рдпрд╣ рд╕рднреА рдкреБрд░рд╛рдиреЗ рдореВрд▓реНрдпреЛрдВ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ред</font></font><br><br><pre> <code class="cpp hljs">load_seg_legacy(prev-&gt;fsindex, prev-&gt;fsbase, next-&gt;fsindex, next-&gt;fsbase, FS);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдирдП FS рд╕реЗрдЧрдореЗрдВрдЯреНрд╕ (GS рдЫреЛрдбрд╝рд╛ рдЧрдпрд╛)ред </font><font style="vertical-align: inherit;">рдпрд╣ 32-рдмрд┐рдЯ рдФрд░ 64-рдмрд┐рдЯ рд░рдЬрд┐рд╕реНрдЯрд░ рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЗ рд▓рд┐рдП рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдЧрд╛ рдФрд░ рд▓реЛрдб рдХрд░реЗрдЧрд╛ред </font><font style="vertical-align: inherit;">рдирдпрд╛ рдХрд╛рд░реНрдп рдЕрдм рдЯреАрдПрд▓рдПрд╕ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">switch_fpu_finish(next_fpu, cpu);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдЖрдиреЗ рд╡рд╛рд▓реЗ рдХрд╛рд░реНрдп рдХреЗ рд▓рд┐рдП FPU рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдЖрд░рдореНрдн рдХрд░рддрд╛ рд╣реИред </font></font><br><br><pre> <code class="cpp hljs">this_cpu_write(current_task, next_p);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╡рд░реНрддрдорд╛рди рд╕реАрдкреАрдпреВ ( </font></font><code>task_struct *</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) </font><font style="vertical-align: inherit;">рдХрд╛рд░реНрдп рдХреЛ рдЕрджреНрдпрддрди рдХрд░рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">ред </font><font style="vertical-align: inherit;">рдПрдлрдкреАрдпреВ рдФрд░ рдкреАрдбреАрдП (рдкреНрд░рддреНрдпреЗрдХ рдкреНрд░реЛрд╕реЗрд╕рд░ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛ рдХреНрд╖реЗрддреНрд░) рдХреА рд╕реНрдерд┐рддрд┐ рдХреЛ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">this_cpu_write(cpu_current_top_of_stack, task_top_of_stack(next_p));</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рд╕реАрдкреАрдпреВ рдвреЗрд░ рд╕реВрдЪрдХ рд╣реИ рдХрд┐ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХреЗ рд░реВрдк рдореЗрдВ SP1 рдУрд╡рд░рд▓реЛрдб рд╣реЛ рдЧрдпрд╛ рд╣реИ рдЕрджреНрдпрддрди рдХрд░рддрд╛ рд╣реИ </font></font><a href="" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЙрддреНрдкрдиреНрди рдХреЛрдб</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП (рдкреНрд░рд╡реЗрд╢ рдЯреНрд░реИрдореНрдкреЛрд▓рд┐рди)ред</font></font><br><br><pre> <code class="cpp hljs">update_sp0(next_p);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕реЗ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдирдП рд╕реНрдЯреИрдХ рдХрд╛ рд╕рддреНрдпрд╛рдкрдиред </font><font style="vertical-align: inherit;">рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ sp0 рдпрд╣рд╛рдБ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, sp1 рдирд╣реАрдВ? </font><font style="vertical-align: inherit;">рд╢рд╛рдпрдж рдирд╛рдо рдмрджрд▓рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (unlikely(task_thread_info(next_p)-&gt;flags &amp; _TIF_WORK_CTXSW_NEXT || task_thread_info(prev_p)-&gt;flags &amp; _TIF_WORK_CTXSW_PREV)) __switch_to_xtra(prev_p, next_p, tss);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдкрдбреЗрдЯ рдбрд┐рдмрдЧ рд░рдЬрд┐рд╕реНрдЯрд░ рдФрд░ I / O рдмрд┐рдЯрдореИрдкреНрд╕ред </font><font style="vertical-align: inherit;">рдЗрди рджреЛрдиреЛрдВ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдкрд╣рд▓реЗ рд╕рдВрджрд░реНрдн рд╕реНрд╡рд┐рдЪ рдореЗрдВ рд╕реАрдзреЗ рд╣реИрдВрдбрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЕрдм рдЗрд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ </font></font><code>__switch_to_xtra()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> CONFIG_XEN_PV </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (unlikely(static_cpu_has(X86_FEATURE_XENPV) &amp;&amp; prev-&gt;iopl != next-&gt;iopl)) xen_set_iopl_mask(next-&gt;iopl);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Xen paravirtualization рдХреЗ рд▓рд┐рдП I / O рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрд┐рдЯреНрд╕ рдХреЛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рд╕реНрд╡реИрдк рдХрд░рддрд╛ рд╣реИред </font><font style="vertical-align: inherit;">рдЬрд╛рд╣рд┐рд░рд╛ рддреМрд░ рдкрд░, рдирд┐рдпрдорд┐рдд рдзреНрд╡рдЬ рд╕реНрд╡рд┐рдЪ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдареАрдХ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , рдФрд░ рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рд╕реАрдзреЗ рд╡рд░реНрддрдорд╛рди рдмрд┐рдЯреНрд╕ рдХреЛ рдореБрдЦреМрдЯрд╛ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (static_cpu_has_bug(X86_BUG_SYSRET_SS_ATTRS)) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> ss_sel; savesegment(ss, ss_sel); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ss_sel != __KERNEL_DS) loadsegment(ss, __KERNEL_DS);</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдПрдПрдордбреА рдкреНрд░реЛрд╕реЗрд╕рд░ рдореЗрдВ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд SYSRET рд╡реНрдпрд╡рд╣рд╛рд░</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдХреЛ </font><font style="vertical-align: inherit;">рдЫреБрдкрд╛рддрд╛ рд╣реИ </font><font style="vertical-align: inherit;">рдЬреЛ рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рд╕реЗрдЧрдореЗрдВрдЯ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИред</font></font><br><br><pre> <code class="cpp hljs">intel_rdt_sched_in();</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдХреБрдЫ рдЗрдВрдЯреЗрд▓ рд╕рдлрд╛рдИ рдХрд╛рд░реНрдпред </font><font style="vertical-align: inherit;">рдЕрдкрдбреЗрдЯ </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=hi&amp;u=" rel="nofollow"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрд░рдПрдордЖрдИрдбреА рдФрд░ рдХреНрд▓реЛрд╕рд┐рдб</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ред</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> prev_p;</code> </pre> <br>  рд╣реЛ рдЧрдпрд╛! <br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> рдкреВрдЫреЗ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рд╢реНрди </font></font></h1><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЖрдкрдиреЗ рдЗрди рдХрд░реНрдиреЗрд▓ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЛ рдХреНрдпреЛрдВ рдЪреБрдирд╛? </font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдкрд╣рд▓реЗ рдФрд░ рдЕрдВрддрд┐рдо рд╕рдВрд╕реНрдХрд░рдг рд╕реНрдкрд╖реНрдЯ рдЙрдореНрдореАрджрд╡рд╛рд░ рдереЗред </font><font style="vertical-align: inherit;">рдкреНрд░рд╛рд░рдВрдн рдореЗрдВ, рдореИрдВрдиреЗ рдЪрд╛рд░ рдФрд░ рдордзреНрдпрд╡рд░реНрддреА рд╕рдВрд╕реНрдХрд░рдгреЛрдВ (2.1, 2.3, 2.5 рдФрд░ 2.6.26) рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░рдиреЗ рдХреА рдпреЛрдЬрдирд╛ рдмрдирд╛рдИ, рд▓реЗрдХрд┐рди рд▓реЗрдЦ рдХреЛ рдУрд╡рд░-рдЗрдирдлрд╝реНрд▓реЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рд╡рд░реНрддрди рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рдереЗред </font><font style="vertical-align: inherit;">рд╡рд╣ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдмрд╣реБрдд рдмрдбрд╝реА рд╣реИред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЗрд╕ рдЕрдзреНрдпрдпрди рдореЗрдВ рдХрд┐рддрдирд╛ рд╕рдордп рд▓рдЧрд╛? </font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рджреЛ рд╕рдкреНрддрд╛рд╣ред </font><font style="vertical-align: inherit;">рдХреЛрдб рд╡рд┐рд╢реНрд▓реЗрд╖рдг, рдиреЛрдЯреНрд╕ рдФрд░ рддрдХрдиреАрдХреА рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдкреНрддрд╛рд╣ред </font><font style="vertical-align: inherit;">рдлрд┐рд░ рдиреЛрдЯреНрд╕ рдХреЛ рдлрд┐рд░ рд╕реЗ рд▓рд┐рдЦрдиреЗ, рдЪрд┐рддреНрд░ рдмрдирд╛рдиреЗ рдФрд░ рд▓реЗрдЦ рдХреЛ рдкреНрд░рд╛рд░реВрдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдкреНрддрд╛рд╣ред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">4.14.67 - рдирд╡реАрдирддрдо рдПрд▓рдЯреАрдПрд╕ рд░рд┐рд▓реАрдЬ рдирд╣реАрдВ? </font></font></b> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдореИрдВрдиреЗ 1 рд╕рд┐рддрдВрдмрд░ рдХреЛ рдХреЛрдб рдХрд╛ рдЕрдзреНрдпрдпрди рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдФрд░ рд╕реНрд░реЛрдд рдХреЛрдб 4.14.67 рд▓рд┐рдпрд╛ред </font><font style="vertical-align: inherit;">рд╕рдВрд╕реНрдХрд░рдг 4.14.68 рдХреЛ рдЪрд╛рд░ рджрд┐рди рдмрд╛рдж рдкреВрд░рд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">рдЬреИрд╕реЗ рд╣реА рд╡реЗ рдЙрдкрд▓рдмреНрдз рд╣реЛрдВрдЧреЗ рдореИрдВ рдЕрдиреНрдп рдкреНрд░рд╢реНрди рдЬреЛрдбрд╝ рджреВрдВрдЧрд╛ред</font></font></b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/hi438042/">https://habr.com/ru/post/hi438042/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../hi438022/index.html">рдХреЛрдб рдХрд╛ рдЖрдХрд╛рд░ рдорд┐рдирд┐рдлрд╛рдпрд░, рдХрд▓реЗрдХреНрдЯрд░ рдФрд░ рднрд╛рд╖рд╛ рдкрд░ рдХреИрд╕реЗ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИред рдЕрдирдкреЗрдХреНрд╖рд┐рдд рд╡реЗрдмрдкреИрдХ рдЕрджреНрдпрддрди</a></li>
<li><a href="../hi438026/index.html">RedisPipe - рдПрдХ рд╕рд╛рде рдЕрдзрд┐рдХ рдордЬрд╝рд╛</a></li>
<li><a href="../hi438032/index.html">рд▓реЛрдХрдкреНрд░рд┐рдп рдЦреБрд▓рд╛ рд╕реНрд░реЛрдд - рднрд╛рдЧ рджреЛ: 5 рдмрд╛рджрд▓ рдкреНрд░рдмрдВрдзрди рдЙрдкрдХрд░рдг</a></li>
<li><a href="../hi438034/index.html">рдПрдВрдбреНрд░реЙрдЗрдб, рдЖрд░рдПрдХреНрд╕ рдФрд░ рдХреЛрдЯрд▓рд┐рди рдпрд╛ рд▓реЗрдЧреЛ рдкрдВрдЬрд╛ рдХреЛ рдХреИрд╕реЗ рд╕рд┐рдХреЛрдбрд╝реЗрдВред рднрд╛рдЧ 1</a></li>
<li><a href="../hi438036/index.html">рд░реВрд╕реА рдореЗрдВ 3blue1brown рдФрд░ MIT</a></li>
<li><a href="../hi438046/index.html">рдПрдХ рддреНрд╡рд░рд┐рдд рддрд░реАрдХреЗ рд╕реЗ рд╕реНрдкрд╛рд░реНрдХ рдкрд░ рдПрдХ рд▓рд╛рдЦ рдЕрдВрдХ рдЬрд┐рдпреЛрдХреЛрдб рдХреИрд╕реЗ рдХрд░реЗрдВ?</a></li>
<li><a href="../hi438048/index.html">рд╣рдо рд╡реНрдпрд╡рд╕рд╛рдп рдХреЛ рдмреЗрд╣рддрд░ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдирд╛рд╡рд╢реНрдпрдХ рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдФрд░ рдЙрддреНрдкрд╛рджреЛрдВ рдХреЛ рд╣рдЯрд╛рддреЗ рд╣реИрдВред</a></li>
<li><a href="../hi438052/index.html">рдЗрдВрдЯрд░реЗрдХреНрдЯрд░, рдСрдкрд░реЗрд╢рди рдкреИрдЯрд░реНрди</a></li>
<li><a href="../hi438058/index.html">"рдкрд╛рдпрдерди рдореЗрдВ рдбреЗрдЯрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг" рджреЛ рднрд╛рдЧреЛрдВ рдореЗрдВ</a></li>
<li><a href="../hi438060/index.html">рд╕реНрдерд╛рдирд┐рдХ рдЕрднрд┐рд╡рд┐рдиреНрдпрд╛рд╕ рдХрд╛ рдЕрдиреБрдорд╛рди, рдпрд╛ рдорд╣реЛрдиреА рдФрд░ рдорд╛рдЬрд┐рдХ рдлрд┐рд▓реНрдЯрд░ рд╕реЗ рдХреИрд╕реЗ рдбрд░реЗрдВ рдирд╣реАрдВ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>