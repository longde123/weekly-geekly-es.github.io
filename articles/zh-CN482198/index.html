<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸµ ğŸšµğŸ¼ â†–ï¸ å¦‚ä½•ä¸ºç¾¤é›†åˆ›å»ºè‡ªåŠ¨ç¼©æ”¾å™¨ â›±ï¸ ğŸ´ó §ó ¢ó ¥ó ®ó §ó ¿ ğŸ‘ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ä½ å¥½ æˆ‘ä»¬è®­ç»ƒäººä»¬ä½¿ç”¨å¤§æ•°æ®ã€‚ å¦‚æœæ²¡æœ‰è‡ªå·±çš„é›†ç¾¤ï¼Œæ‰€æœ‰å‚ä¸è€…å…±åŒåŠªåŠ›ï¼Œå°±æ— æ³•æƒ³è±¡å…³äºå¤§æ•°æ®çš„æ•™è‚²è®¡åˆ’ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å§‹ç»ˆåœ¨ç¨‹åºä¸­ä½¿ç”¨å®ƒï¼š)æˆ‘ä»¬ä»äº‹å…¶è°ƒä¼˜ï¼Œè°ƒä¼˜å’Œç®¡ç†å·¥ä½œï¼Œä»–ä»¬ç›´æ¥åœ¨æ­¤å¤„å¯åŠ¨MapReduce-jobså¹¶ä½¿ç”¨Sparkã€‚ 


 åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•ä½¿ç”¨Mail.ru Clou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•ä¸ºç¾¤é›†åˆ›å»ºè‡ªåŠ¨ç¼©æ”¾å™¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/newprolab/blog/482198/"><p> ä½ å¥½ æˆ‘ä»¬è®­ç»ƒäººä»¬ä½¿ç”¨å¤§æ•°æ®ã€‚ å¦‚æœæ²¡æœ‰è‡ªå·±çš„é›†ç¾¤ï¼Œæ‰€æœ‰å‚ä¸è€…å…±åŒåŠªåŠ›ï¼Œå°±æ— æ³•æƒ³è±¡å…³äºå¤§æ•°æ®çš„æ•™è‚²è®¡åˆ’ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å§‹ç»ˆåœ¨ç¨‹åºä¸­ä½¿ç”¨å®ƒï¼š)æˆ‘ä»¬ä»äº‹å…¶è°ƒä¼˜ï¼Œè°ƒä¼˜å’Œç®¡ç†å·¥ä½œï¼Œä»–ä»¬ç›´æ¥åœ¨æ­¤å¤„å¯åŠ¨MapReduce-jobså¹¶ä½¿ç”¨Sparkã€‚ </p><br><p> åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†æè¿°å¦‚ä½•ä½¿ç”¨<a href="https://mcs.mail.ru/">Mail.ru Cloud Solutions</a>äº‘ç¼–å†™è‡ªåŠ¨ä¼¸ç¼©ç¨‹åºæ¥<a href="https://mcs.mail.ru/">è§£å†³</a>ç¾¤é›†è´Ÿè½½ä¸å‡çš„é—®é¢˜ã€‚ </p><a name="habracut"></a><br><h2 id="problema"> é—®é¢˜ </h2><br><p> æˆ‘ä»¬ä½¿ç”¨çš„é›†ç¾¤ä¸æ˜¯å¾ˆå…¸å‹ã€‚ å¤„ç½®éå¸¸ä¸å‡åŒ€ã€‚ ä¾‹å¦‚ï¼Œå½“30ä¸ªäººå’Œè€å¸ˆå…¨éƒ¨è¿›å…¥é›†ç¾¤å¹¶å¼€å§‹ä½¿ç”¨å®ƒæ—¶ï¼Œä¼šæœ‰ä¸€äº›ç»ƒä¹ ã€‚ æˆ–è€…ï¼Œè¿˜æ˜¯åœ¨æˆªæ­¢æ—¥æœŸä¹‹å‰çš„å‡ å¤©é‡Œï¼Œè´Ÿè½½æ€¥å‰§å¢åŠ ã€‚ å…¶ä½™æ—¶é—´ï¼Œé›†ç¾¤ä»¥æ¬ è½½æ¨¡å¼è¿è¡Œã€‚ </p><br><p> è§£å†³æ–¹æ¡ˆ1æ˜¯ä¿æŒä¸€ä¸ªç¾¤é›†ï¼Œè¯¥ç¾¤é›†å¯ä»¥æ‰¿å—å³°å€¼è´Ÿè½½ï¼Œä½†åœ¨å…¶ä½™æ—¶é—´ä¿æŒç©ºé—²çŠ¶æ€ã€‚ </p><br><p> ç¬¬äºŒä¸ªè§£å†³æ–¹æ¡ˆæ˜¯ä¿ç•™ä¸€ä¸ªå°çš„ç¾¤é›†ï¼Œåœ¨ç¾¤é›†ä¸­åœ¨ç±»ä¹‹å‰å’Œå³°å€¼è´Ÿè½½æœŸé—´æ‰‹åŠ¨æ·»åŠ èŠ‚ç‚¹ã€‚ </p><br><p> è§£å†³æ–¹æ¡ˆ3æ˜¯ä¿ç•™ä¸€ä¸ªå°çš„ç¾¤é›†ï¼Œå¹¶ç¼–å†™ä¸€ä¸ªè‡ªåŠ¨ç¼©æ”¾å™¨ï¼Œä»¥ç›‘è§†å½“å‰çš„ç¾¤é›†è´Ÿè½½ï¼Œå¹¶ä½¿ç”¨å„ç§APâ€‹â€‹Iä»ç¾¤é›†ä¸­æ·»åŠ å’Œåˆ é™¤èŠ‚ç‚¹ã€‚ </p><br><p> åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºç¬¬3å·å†³å®šã€‚ è¿™æ ·çš„è‡ªåŠ¨ç¼©æ”¾å™¨é«˜åº¦ä¾èµ–äºå¤–éƒ¨å› ç´ ï¼Œè€Œä¸æ˜¯å†…éƒ¨å› ç´ ï¼Œæä¾›å•†é€šå¸¸ä¸æä¾›å®ƒã€‚ æˆ‘ä»¬ä½¿ç”¨Mail.ru Cloud Solutionsäº‘åŸºç¡€æ¶æ„ï¼Œå¹¶ä½¿ç”¨MCS APIç¼–å†™äº†è‡ªåŠ¨ç¼©æ”¾å™¨ã€‚ å¹¶ä¸”ç”±äºæˆ‘ä»¬æ­£åœ¨æ¥å—æ•°æ®å¤„ç†æ–¹é¢çš„åŸ¹è®­ï¼Œå› æ­¤æˆ‘ä»¬å†³å®šå‘æ‚¨å±•ç¤ºå¦‚ä½•ä¸ºæ‚¨çš„ç›®çš„ç¼–å†™ç±»ä¼¼çš„è‡ªåŠ¨ç¼©æ”¾å™¨å¹¶ä¸äº‘ä¸€èµ·ä½¿ç”¨ </p><br><h2 id="prerequisites"> å…ˆå†³æ¡ä»¶ </h2><br><p> é¦–å…ˆï¼Œæ‚¨å¿…é¡»å…·æœ‰Hadoopé›†ç¾¤ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬ä½¿ç”¨HDPåˆ†å‘ã€‚ </p><br><p> ä¸ºäº†å¯ä»¥å¿«é€Ÿæ·»åŠ å’Œåˆ é™¤èŠ‚ç‚¹ï¼Œå¿…é¡»åœ¨èŠ‚ç‚¹ä¹‹é—´å…·æœ‰ä¸€å®šçš„è§’è‰²åˆ†å¸ƒã€‚ </p><br><ol><li> ä¸»èŠ‚ç‚¹ã€‚ å¥½å§ï¼Œè¿™é‡Œä¸éœ€è¦ç‰¹åˆ«è¯´æ˜ï¼šé›†ç¾¤çš„ä¸»èŠ‚ç‚¹ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨äº¤äº’æ–¹å¼ï¼Œåˆ™å°†åœ¨è¯¥ä¸»èŠ‚ç‚¹ä¸Šå¯åŠ¨Sparké©±åŠ¨ç¨‹åºã€‚ </li><li> æ—¥æœŸèŠ‚ç‚¹ã€‚ è¿™æ˜¯æ‚¨åœ¨HDFSä¸Šå­˜å‚¨æ•°æ®å¹¶å¯¹å…¶æ‰§è¡Œè®¡ç®—çš„èŠ‚ç‚¹ã€‚ </li><li> è®¡ç®—èŠ‚ç‚¹ã€‚ åœ¨æ­¤èŠ‚ç‚¹ä¸Šï¼Œæ‚¨ä¸ä¼šåœ¨HDFSä¸Šå­˜å‚¨ä»»ä½•å†…å®¹ï¼Œä½†ä¼šå¯¹å…¶è¿›è¡Œè®¡ç®—ã€‚ </li></ol><br><p> é‡è¦çš„ä¸€ç‚¹ã€‚ ç”±äºç¬¬ä¸‰ç±»èŠ‚ç‚¹ï¼Œå°†å‘ç”Ÿè‡ªåŠ¨ç¼©æ”¾ã€‚ å¦‚æœæ‚¨å¼€å§‹æ‹¾å–å¹¶æ·»åŠ ç¬¬äºŒç§ç±»å‹çš„èŠ‚ç‚¹ï¼Œåˆ™å“åº”é€Ÿåº¦å°†éå¸¸ä½-è§£å‹ç¼©å¹¶å»ºè®®åœ¨ç¾¤é›†ä¸ŠèŠ±è´¹æ•°å°æ—¶ã€‚ å½“ç„¶ï¼Œè¿™ä¸æ˜¯è‡ªåŠ¨ç¼©æ”¾æ‰€æœŸæœ›çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬ä¸è§¦æ‘¸ç¬¬ä¸€ç±»å’Œç¬¬äºŒç±»çš„èŠ‚ç‚¹ã€‚ å®ƒä»¬å°†æ˜¯ä¸€ä¸ªæœ€å°å¯è¡Œçš„é›†ç¾¤ï¼Œå°†å­˜åœ¨äºæ•´ä¸ªè®¡åˆ’ä¸­ã€‚ </p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬çš„autoscoilerç”¨Python 3ç¼–å†™ï¼Œä½¿ç”¨Ambari APIç®¡ç†é›†ç¾¤æœåŠ¡ï¼Œä½¿ç”¨<a href="https://mcs.mail.ru/help/iaas-api/openstack-api">Mail.ru Cloud Solutions</a> ï¼ˆMCSï¼‰ <a href="https://mcs.mail.ru/help/iaas-api/openstack-api">API</a>å¯åŠ¨å’Œåœæ­¢è®¡ç®—æœºã€‚ </p><br><h2 id="arhitektura-resheniya"> è§£å†³æ–¹æ¡ˆæ¶æ„ </h2><br><ol><li>æ¨¡å—<code>autoscaler.py</code> ã€‚ å…¶ä¸­æ³¨å†Œäº†ä¸‰ç±»ï¼š1ï¼‰ç”¨äºAmbariçš„åŠŸèƒ½ï¼Œ2ï¼‰ç”¨äºMCSçš„åŠŸèƒ½ï¼Œ3ï¼‰ä¸è‡ªåŠ¨å®šæ ‡å™¨é€»è¾‘ç›´æ¥ç›¸å…³çš„åŠŸèƒ½ã€‚ </li><li> è„šæœ¬<code>observer.py</code> ã€‚ å®é™…ä¸Šï¼Œå®ƒç”±ä¸åŒçš„è§„åˆ™ç»„æˆï¼šä½•æ—¶ä»¥åŠä½•æ—¶è°ƒç”¨è‡ªåŠ¨å®šæ ‡å™¨åŠŸèƒ½ã€‚ </li><li> å…·æœ‰é…ç½®å‚æ•°<code>config.py</code>çš„æ–‡ä»¶ã€‚ ä¾‹å¦‚ï¼Œå®ƒåŒ…å«å…è®¸è‡ªåŠ¨ç¼©æ”¾çš„èŠ‚ç‚¹åˆ—è¡¨ä»¥åŠå…¶ä»–å½±å“å‚æ•°çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼Œä»æ·»åŠ æ–°èŠ‚ç‚¹èµ·éœ€è¦ç­‰å¾…å¤šå°‘æ—¶é—´ã€‚ è¿˜æœ‰ç±»å¼€å§‹çš„æ—¶é—´æˆ³ï¼Œä»¥ä¾¿åœ¨ä¼šè¯ä¹‹å‰å¯åŠ¨å…è®¸çš„æœ€å¤§ç¾¤é›†é…ç½®ã€‚ </li></ol><br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å‰ä¸¤ä¸ªæ–‡ä»¶ä¸­çš„ä»£ç æ®µã€‚ </p><br><h2 id="1-modul-autoscalerpy">  1. autoscaler.pyæ¨¡å— </h2><br><h3 id="klass-ambari"> ç±»å®‰å·´é‡Œ </h3><br><p> è¿™æ˜¯åŒ…å«<code>Ambari</code>ç±»çš„ä»£ç ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ambari</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ambari_url, cluster_name, headers, auth)</span></span></span><span class="hljs-function">:</span></span> self.ambari_url = ambari_url self.cluster_name = cluster_name self.headers = headers self.auth = auth <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop_all_services</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> url = self.ambari_url + self.cluster_name + <span class="hljs-string"><span class="hljs-string">'/hosts/'</span></span> + hostname + <span class="hljs-string"><span class="hljs-string">'/host_components/'</span></span> url2 = self.ambari_url + self.cluster_name + <span class="hljs-string"><span class="hljs-string">'/hosts/'</span></span> + hostname req0 = requests.get(url2, headers=self.headers, auth=self.auth) services = req0.json()[<span class="hljs-string"><span class="hljs-string">'host_components'</span></span>] services_list = list(map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> x: x[<span class="hljs-string"><span class="hljs-string">'HostRoles'</span></span>][<span class="hljs-string"><span class="hljs-string">'component_name'</span></span>], services)) data = { <span class="hljs-string"><span class="hljs-string">"RequestInfo"</span></span>: { <span class="hljs-string"><span class="hljs-string">"context"</span></span>:<span class="hljs-string"><span class="hljs-string">"Stop All Host Components"</span></span>, <span class="hljs-string"><span class="hljs-string">"operation_level"</span></span>: { <span class="hljs-string"><span class="hljs-string">"level"</span></span>:<span class="hljs-string"><span class="hljs-string">"HOST"</span></span>, <span class="hljs-string"><span class="hljs-string">"cluster_name"</span></span>: self.cluster_name, <span class="hljs-string"><span class="hljs-string">"host_names"</span></span>: hostname }, <span class="hljs-string"><span class="hljs-string">"query"</span></span>:<span class="hljs-string"><span class="hljs-string">"HostRoles/component_name.in({0})"</span></span>.format(<span class="hljs-string"><span class="hljs-string">","</span></span>.join(services_list)) }, <span class="hljs-string"><span class="hljs-string">"Body"</span></span>: { <span class="hljs-string"><span class="hljs-string">"HostRoles"</span></span>: { <span class="hljs-string"><span class="hljs-string">"state"</span></span>:<span class="hljs-string"><span class="hljs-string">"INSTALLED"</span></span> } } } req = requests.put(url, data=json.dumps(data), headers=self.headers, auth=self.auth) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> req.status_code <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-number"><span class="hljs-number">201</span></span>, <span class="hljs-number"><span class="hljs-number">202</span></span>]: message = <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: message = req.status_code <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message</code> </pre> <br><p> å¯¹äºä¸Šé¢çš„ç¤ºä¾‹ï¼Œæ‚¨å¯ä»¥æŸ¥çœ‹<code>stop_all_services</code>å‡½æ•°çš„å®ç°ï¼Œè¯¥å‡½æ•°å°†åœæ­¢æ‰€éœ€é›†ç¾¤èŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰æœåŠ¡ã€‚ </p><br><p> æ‚¨éœ€è¦é€šè¿‡<code>Ambari</code>ç­çº§ï¼š </p><br><ul><li> ä¸¾ä¾‹æ¥è¯´ï¼Œ <code>ambari_url</code>çš„æ ¼å¼ä¸º<code>'http://localhost:8080/api/v1/clusters/'</code> ï¼Œ </li><li>  <code>cluster_name</code>æ˜¯æ‚¨åœ¨Ambariä¸­çš„é›†ç¾¤çš„åç§°ï¼Œ </li><li> <code>headers = {'X-Requested-By': 'ambari'}</code> </li> <li>  <code>auth</code>å†…åŒ…å«æ¥è‡ªAmbariçš„ç”¨æˆ·åå’Œå¯†ç ï¼š <code>auth = ('login', 'password')</code> ã€‚ </li></ul><br><p> è¯¥å‡½æ•°æœ¬èº«ä¸è¿‡æ˜¯é€šè¿‡REST APIå¯¹Ambariçš„å‡ æ¬¡è°ƒç”¨ã€‚ ä»é€»è¾‘è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬é¦–å…ˆè·å¾—è¯¥èŠ‚ç‚¹ä¸Šæ­£åœ¨è¿è¡Œçš„æœåŠ¡çš„åˆ—è¡¨ï¼Œç„¶åè¦æ±‚åœ¨è¯¥èŠ‚ç‚¹ä¸Šçš„æ­¤é›†ç¾¤ä¸Šï¼Œå°†æœåŠ¡ä»åˆ—è¡¨è½¬ç§»åˆ°<code>INSTALLED</code>çŠ¶æ€ã€‚ ç”¨äºå¯åŠ¨æ‰€æœ‰æœåŠ¡ï¼Œå°†èŠ‚ç‚¹ç½®äº<code>Maintenance</code>çŠ¶æ€ç­‰çš„åŠŸèƒ½çœ‹èµ·æ¥å¾ˆç›¸ä¼¼-å®ƒä»¬åªæ˜¯é€šè¿‡APIçš„ä¸€äº›è¯·æ±‚ã€‚ </p><br><h3 id="klass-mcs">  MCSçº§ </h3><br><p> è¿™æ˜¯åŒ…å«<code>Mcs</code>ç±»çš„ä»£ç ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mcs</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, id1, id2, password)</span></span></span><span class="hljs-function">:</span></span> self.id1 = id1 self.id2 = id2 self.password = password self.mcs_host = <span class="hljs-string"><span class="hljs-string">'https://infra.mail.ru:8774/v2.1'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vm_turn_on</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> self.token = self.get_mcs_token() host = self.hostname_to_vmname(hostname) vm_id = self.get_vm_id(host) mcs_url1 = self.mcs_host + <span class="hljs-string"><span class="hljs-string">'/servers/'</span></span> + self.vm_id + <span class="hljs-string"><span class="hljs-string">'/action'</span></span> headers = { <span class="hljs-string"><span class="hljs-string">'X-Auth-Token'</span></span>: <span class="hljs-string"><span class="hljs-string">'{0}'</span></span>.format(self.token), <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> } data = {<span class="hljs-string"><span class="hljs-string">'os-start'</span></span> : <span class="hljs-string"><span class="hljs-string">'null'</span></span>} mcs = requests.post(mcs_url1, data=json.dumps(data), headers=headers) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mcs.status_code</code> </pre> <br><p> å¯¹äº<code>Mcs</code>ç±»ï¼Œæˆ‘ä»¬å°†äº‘ä¸­çš„é¡¹ç›®IDï¼Œç”¨æˆ·IDä»¥åŠä»–çš„å¯†ç ä¼ é€’ç»™äº‘ã€‚ åœ¨<code>vm_turn_on</code>å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è¦å¯ç”¨å…¶ä¸­ä¸€å°è®¡ç®—æœºã€‚ è¿™é‡Œçš„é€»è¾‘æœ‰ç‚¹å¤æ‚ã€‚ åœ¨ä»£ç çš„å¼€å¤´ï¼Œå°†è°ƒç”¨å…¶ä»–ä¸‰ä¸ªå‡½æ•°ï¼š1ï¼‰æˆ‘ä»¬éœ€è¦è·å–ä»¤ç‰Œï¼Œ2ï¼‰æˆ‘ä»¬éœ€è¦å°†ä¸»æœºåè½¬æ¢ä¸ºMCSä¸­è®¡ç®—æœºçš„åç§°ï¼Œ3ï¼‰è·å–è¯¥è®¡ç®—æœºçš„IDã€‚ æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›è¡Œä¸€ä¸ªç®€å•çš„åè¯·æ±‚å¹¶è¿è¡Œè¿™å°æœºå™¨ã€‚ </p><br><p> è¿™æ˜¯ä»¤ç‰Œæ¥æ”¶åŠŸèƒ½çš„æ ·å­ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_mcs_token</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> url = <span class="hljs-string"><span class="hljs-string">'https://infra.mail.ru:35357/v3/auth/tokens?nocatalog'</span></span> headers = {<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>} data = { <span class="hljs-string"><span class="hljs-string">'auth'</span></span>: { <span class="hljs-string"><span class="hljs-string">'identity'</span></span>: { <span class="hljs-string"><span class="hljs-string">'methods'</span></span>: [<span class="hljs-string"><span class="hljs-string">'password'</span></span>], <span class="hljs-string"><span class="hljs-string">'password'</span></span>: { <span class="hljs-string"><span class="hljs-string">'user'</span></span>: { <span class="hljs-string"><span class="hljs-string">'id'</span></span>: self.id1, <span class="hljs-string"><span class="hljs-string">'password'</span></span>: self.password } } }, <span class="hljs-string"><span class="hljs-string">'scope'</span></span>: { <span class="hljs-string"><span class="hljs-string">'project'</span></span>: { <span class="hljs-string"><span class="hljs-string">'id'</span></span>: self.id2 } } } } params = ((<span class="hljs-string"><span class="hljs-string">'nocatalog'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>),) req = requests.post(url, data=json.dumps(data), headers=headers, params=params) self.token = req.headers[<span class="hljs-string"><span class="hljs-string">'X-Subject-Token'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.token</code> </pre> <br><h3 id="klass-autoscaler"> ç±»è‡ªåŠ¨ç¼©æ”¾å™¨ </h3><br><p> æ­¤ç±»åŒ…å«ä¸å·¥ä½œé€»è¾‘æœ¬èº«æœ‰å…³çš„åŠŸèƒ½ã€‚ </p><br><p> æ­¤ç±»çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Autoscaler</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ambari, mcs, scaling_hosts, yarn_ram_per_node, yarn_cpu_per_node)</span></span></span><span class="hljs-function">:</span></span> self.scaling_hosts = scaling_hosts self.ambari = ambari self.mcs = mcs self.q_ram = deque() self.q_cpu = deque() self.num = <span class="hljs-number"><span class="hljs-number">0</span></span> self.yarn_ram_per_node = yarn_ram_per_node self.yarn_cpu_per_node = yarn_cpu_per_node <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale_down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, hostname)</span></span></span><span class="hljs-function">:</span></span> flag1 = flag2 = flag3 = flag4 = flag5 = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hostname <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.scaling_hosts: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status1 = self.ambari.decommission_nodemanager(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status1 == <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status1 == <span class="hljs-number"><span class="hljs-number">500</span></span>: flag1 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Decomission request accepted: {0}'</span></span>.format(flag1)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status3 = self.ambari.check_service(hostname, <span class="hljs-string"><span class="hljs-string">'NODEMANAGER'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status3 == <span class="hljs-string"><span class="hljs-string">'INSTALLED'</span></span>: flag3 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Nodemaneger decommissioned: {0}'</span></span>.format(flag3)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status2 = self.ambari.maintenance_on(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status2 == <span class="hljs-string"><span class="hljs-string">'Request accepted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status2 == <span class="hljs-number"><span class="hljs-number">500</span></span>: flag2 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Maintenance request accepted: {0}'</span></span>.format(flag2)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status4 = self.ambari.check_maintenance(hostname, <span class="hljs-string"><span class="hljs-string">'NODEMANAGER'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status4 == <span class="hljs-string"><span class="hljs-string">'ON'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> status4 == <span class="hljs-string"><span class="hljs-string">'IMPLIED_FROM_HOST'</span></span>: flag4 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.ambari.stop_all_services(hostname) logging.info(<span class="hljs-string"><span class="hljs-string">'Maintenance is on: {0}'</span></span>.format(flag4)) logging.info(<span class="hljs-string"><span class="hljs-string">'Stopping services'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> time.sleep(<span class="hljs-number"><span class="hljs-number">90</span></span>) status5 = self.mcs.vm_turn_off(hostname) <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">5</span></span>) status5 = self.mcs.get_vm_info(hostname)[<span class="hljs-string"><span class="hljs-string">'server'</span></span>][<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status5 == <span class="hljs-string"><span class="hljs-string">'SHUTOFF'</span></span>: flag5 = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'VM is turned off: {0}'</span></span>.format(flag5)) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> flag1 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag2 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag3 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag4 <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> flag5: message = <span class="hljs-string"><span class="hljs-string">'Success'</span></span> logging.info(<span class="hljs-string"><span class="hljs-string">'Scale-down finished'</span></span>) logging.info(<span class="hljs-string"><span class="hljs-string">'Cooldown period has started. Wait for several minutes'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> message</code> </pre> <br><p> æˆ‘ä»¬æ¥å—ç±»<code>Ambari</code>å’Œ<code>Mcs</code> ï¼Œå…è®¸æ‰©å±•çš„èŠ‚ç‚¹åˆ—è¡¨ä»¥åŠèŠ‚ç‚¹çš„é…ç½®å‚æ•°ï¼šåˆ†é…ç»™YARNä¸­èŠ‚ç‚¹çš„å†…å­˜å’Œcpuã€‚ è¿˜æœ‰2ä¸ªå†…éƒ¨å‚æ•°q_ramï¼Œq_cpuï¼Œå®ƒä»¬æ˜¯é˜Ÿåˆ—ã€‚ ä½¿ç”¨å®ƒä»¬ï¼Œæˆ‘ä»¬å¯ä»¥å­˜å‚¨å½“å‰é›†ç¾¤è´Ÿè½½çš„å€¼ã€‚ å¦‚æœæˆ‘ä»¬å‘ç°è¿‡å»5åˆ†é’Ÿå†…è´Ÿè½½ç¨³å®šå¢åŠ ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†³å®šéœ€è¦å‘é›†ç¾¤æ·»åŠ +1èŠ‚ç‚¹ã€‚ é›†ç¾¤æ¬ è½½çŠ¶æ€ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ </p><br><p> ä¸Šé¢çš„ä»£ç æ˜¾ç¤ºäº†ä¸€ä¸ªå‡½æ•°ç¤ºä¾‹ï¼Œè¯¥å‡½æ•°ä»ç¾¤é›†ä¸­åˆ é™¤è®¡ç®—æœºå¹¶å°†å…¶åœæ­¢åœ¨äº‘ä¸­ã€‚ é¦–å…ˆï¼Œ <code>YARN Nodemanager</code> ï¼Œç„¶åæ‰“å¼€<code>Maintenance</code>æ¨¡å¼ï¼Œç„¶ååœæ­¢è®¡ç®—æœºä¸Šçš„æ‰€æœ‰æœåŠ¡å¹¶å…³é—­äº‘ä¸­çš„è™šæ‹Ÿæœºã€‚ </p><br><h2 id="2-skript-observerpy">  2.è„šæœ¬observer.py </h2><br><p> é‚£é‡Œçš„ç¤ºä¾‹ä»£ç ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> scaler.assert_up(config.scale_up_thresholds) == <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: hostname = cloud.get_vm_to_up(config.scaling_hosts) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> hostname != <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: status1 = scaler.scale_up(hostname) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> status1 == <span class="hljs-string"><span class="hljs-string">'Success'</span></span>: text = {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0} has been successfully scaled-up"</span></span>.format(hostname)} post = {<span class="hljs-string"><span class="hljs-string">"text"</span></span>: <span class="hljs-string"><span class="hljs-string">"{0}"</span></span>.format(text)} json_data = json.dumps(post) req = requests.post(webhook, data=json_data.encode(<span class="hljs-string"><span class="hljs-string">'ascii'</span></span>), headers={<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>}) time.sleep(config.cooldown_period*<span class="hljs-number"><span class="hljs-number">60</span></span>)</code> </pre> <br><p> åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¢åŠ é›†ç¾¤å®¹é‡çš„æ¡ä»¶ï¼Œä»¥åŠæ˜¯å¦æ ¹æœ¬æœ‰å¤‡ç”¨æœºå™¨ï¼Œæˆ‘ä»¬è·å¾—å…¶ä¸­ä¸€å°çš„ä¸»æœºåï¼Œå°†å…¶æ·»åŠ åˆ°é›†ç¾¤ä¸­ï¼Œå¹¶åœ¨å›¢é˜Ÿçš„Slackä¸­å‘å¸ƒæœ‰å…³æ­¤æ¶ˆæ¯ã€‚ ä¹‹åï¼Œå½“æˆ‘ä»¬ä¸ä»é›†ç¾¤ä¸­æ·»åŠ æˆ–åˆ é™¤ä»»ä½•ä¸œè¥¿ï¼Œè€Œåªæ˜¯ç›‘è§†è´Ÿè½½æ—¶ï¼Œ <code>cooldown_period</code>å¯åŠ¨<code>cooldown_period</code> ã€‚ å¦‚æœå®ƒå·²ç»ç¨³å®šå¹¶å¤„äºæœ€ä½³è´Ÿè½½å€¼çš„èŒƒå›´ä¹‹å†…ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†ç»§ç»­è¿›è¡Œç›‘è§†ã€‚ å¦‚æœä¸€ä¸ªèŠ‚ç‚¹ä¸è¶³ï¼Œåˆ™æ·»åŠ å¦ä¸€ä¸ªã€‚ </p><br><p> å¯¹äºä¸Šä¸€èŠ‚è¯¾çš„æƒ…å†µï¼Œæˆ‘ä»¬å·²ç»ç¡®å®šä¸€ä¸ªèŠ‚ç‚¹ä¸å¤Ÿç”¨ï¼Œå› æ­¤æˆ‘ä»¬ç«‹å³å¯åŠ¨æ‰€æœ‰ç©ºé—²èŠ‚ç‚¹å¹¶å°†å…¶ä¿æŒæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°è¯¾ç¨‹ç»“æŸã€‚ æ—¶é—´æˆ³ç±»åˆ—è¡¨ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ </p><br><h2 id="zaklyuchenie"> ç»“è®º </h2><br><p> å¯¹äºç¾¤é›†è´Ÿè½½ä¸å‡åŒ€çš„æƒ…å†µï¼Œè‡ªåŠ¨ç¼©æ”¾å™¨æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾¿æ·è§£å†³æ–¹æ¡ˆã€‚ æ‚¨å¯ä»¥åŒæ—¶å®ç°å³°å€¼è´Ÿè½½æ‰€éœ€çš„ç¾¤é›†é…ç½®ï¼ŒåŒæ—¶åœ¨æ¬ è½½æœŸé—´ä¸è¦ä¿ç•™è¯¥ç¾¤é›†ï¼Œä»è€ŒèŠ‚çœäº†èµ„é‡‘ã€‚ å¥½å§ï¼Œæ­¤å¤–ï¼Œæ‰€æœ‰è¿™äº›éƒ½ä¼šè‡ªåŠ¨å‘ç”Ÿï¼Œè€Œæ— éœ€æ‚¨çš„å‚ä¸ã€‚ è‡ªåŠ¨ç¼©æ”¾å™¨æœ¬èº«ä¸è¿‡æ˜¯å¯¹é›†ç¾¤ç®¡ç†å™¨APIå’Œäº‘æä¾›è€…APIçš„ä¸€ç»„è¯·æ±‚ï¼Œå®ƒä»¬æ˜¯æ ¹æ®æŸç§é€»è¾‘è¿›è¡Œæ³¨å†Œçš„ã€‚ æ­£å¦‚æˆ‘ä»¬å…ˆå‰æ‰€å†™ï¼Œç¡®åˆ‡éœ€è¦è®°ä½çš„æ˜¯å°†èŠ‚ç‚¹åˆ†ä¸ºä¸‰ç§ç±»å‹ã€‚ è¿™æ ·æ‚¨ä¼šå¾ˆé«˜å…´çš„ã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482198/">https://habr.com/ru/post/zh-CN482198/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482182/index.html">å¦‚æœæˆ‘ä¸ºITä¸­çš„æ€§åˆ«å¹³è¡¡è€Œå¥‹æ–—ï¼Œä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</a></li>
<li><a href="../zh-CN482186/index.html">ç”Ÿæ´»å’ŒITæˆ–æˆ‘è¾å»ä¸Šä¸€ä»½å·¥ä½œçš„å¹´ä»½</a></li>
<li><a href="../zh-CN482188/index.html">å‘¨äº”æ°‘æ„è°ƒæŸ¥</a></li>
<li><a href="../zh-CN482190/index.html">æœè•¾æ–¯ï¼ˆDurexï¼‰å†…å®¹åœ¨ä¸­å›½çš„ç¤¾äº¤ç½‘ç»œä¸Šæ˜¯ä»€ä¹ˆæ ·çš„</a></li>
<li><a href="../zh-CN482196/index.html">ä»€ä¹ˆæ˜¯ç”Ÿäº§å»ºæ¨¡ï¼Œä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ</a></li>
<li><a href="../zh-CN482200/index.html">ç½‘ç»œå®‰å…¨çš„åŒºå—é“¾ï¼šæœŸæœ›ä¸ç°å®</a></li>
<li><a href="../zh-CN482202/index.html">å°†Check Pointè®¾å¤‡ä¸Šçš„å¯†ç æ›´æ–°ä¸ºGOST 2012çš„æ–¹æ³•</a></li>
<li><a href="../zh-CN482206/index.html">å¦‚ä½•ä½¿é£æœºé›¶ä»¶çš„3Dç”Ÿäº§æ›´åŠ ç»æµ</a></li>
<li><a href="../zh-CN482210/index.html">Bot for Tetriså’Œé€†å‘å·¥ç¨‹åŠ¨ç”»ã€‚ ç¬¬äºŒå±Šç¼–ç¨‹å† å†›èµ›çš„ç§»åŠ¨èµ›é“åˆ†æ</a></li>
<li><a href="../zh-CN482212/index.html">è°ˆè®º...å¥¶é…ªï¼Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>