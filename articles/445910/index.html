<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòØ üëµüèª üë∞üèº C√≥mo nos hicimos amigos de EF 6 MSSQL y PostgresSQL ü§∫ ü§ôüèæ üïµÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hab√≠a una vez un proyecto en EF 6 con el DBMS MSSQL. Y era necesario agregar la capacidad de trabajar con PostgreSQL. No esper√°bamos problemas aqu√≠, p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo nos hicimos amigos de EF 6 MSSQL y PostgresSQL</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/crosstech/blog/445910/"><img src="https://habrastorage.org/webt/_a/jr/dp/_ajrdpk_rrdrsqmckt71xkfceve.jpeg" alt="imagen"><br><br>  Hab√≠a una vez un proyecto en EF 6 con el DBMS MSSQL.  Y era necesario agregar la capacidad de trabajar con PostgreSQL.  No esper√°bamos problemas aqu√≠, porque hay una gran cantidad de art√≠culos sobre este tema, y ‚Äã‚Äãen los foros puede encontrar una discusi√≥n sobre problemas similares.  Sin embargo, en realidad, no todo result√≥ ser tan simple, y en este art√≠culo hablaremos sobre esta experiencia, sobre los problemas que encontramos durante la integraci√≥n del nuevo proveedor y sobre la soluci√≥n que elegimos. <br><a name="habracut"></a><br><h3>  Introductorio </h3><br>  Tenemos un producto en caja y tiene una estructura ya establecida.  Inicialmente, se configur√≥ para funcionar con un DBMS: MSSQL.  El proyecto tiene una capa de acceso a datos con implementaci√≥n EF 6 (enfoque Code First).  Trabajamos con migraciones a trav√©s de EF 6 Migraciones.  Las migraciones se crean manualmente.  La instalaci√≥n inicial de la base de datos ocurre desde la aplicaci√≥n de consola con la inicializaci√≥n del contexto en la cadena de conexi√≥n, pasada como argumento: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (args.Length == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"No arguments in command line"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">$"Initializing dbcontext via </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{connectionString}</span></span></span><span class="hljs-string">"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = MyDbContext(connectionString)) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Database created"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Console.WriteLine(e.Message); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  Al mismo tiempo, la infraestructura de EF y el dominio de dominio se describen en otro proyecto, que est√° conectado a la aplicaci√≥n de consola como una biblioteca.  El constructor de contexto en el proyecto de infraestructura se ve as√≠: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDbContext</span></span> : <span class="hljs-title"><span class="hljs-title">IdentityDbContext</span></span>&lt;<span class="hljs-title"><span class="hljs-title">User</span></span>, <span class="hljs-title"><span class="hljs-title">Role</span></span>, <span class="hljs-title"><span class="hljs-title">Key</span></span>, <span class="hljs-title"><span class="hljs-title">UserLogin</span></span>, <span class="hljs-title"><span class="hljs-title">UserRole</span></span>, <span class="hljs-title"><span class="hljs-title">UserClaim</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IUnitOfWork</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionString</span></span></span><span class="hljs-function">)</span></span> { Database.SetInitializer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbInitializer()); Database.Initialize(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); } }</code> </pre><br><h3>  Primer lanzamiento </h3><br>  Lo primero que hicimos fue conectar dos paquetes al proyecto a trav√©s de nuget: Npgsql y EntityFramework6.Npgsql. <br><br>  Tambi√©n registramos la configuraci√≥n de Postgres en la configuraci√≥n de la aplicaci√≥n de nuestra aplicaci√≥n de consola. <br><br>  La secci√≥n entityFramework especific√≥ la f√°brica de postgres predeterminada como la f√°brica de conexiones: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--&lt;defaultConnectionFactory type="System.Data.Entity.Infrastructure.SqlConnectionFactory, EntityFramework" /&gt;--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">defaultConnectionFactory</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlConnectionFactory, EntityFramework6.Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariantName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.SqlClient"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"System.Data.Entity.SqlServer.SqlProviderServices, EntityFramework.SqlServer"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">provider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariantName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlServices, EntityFramework6.Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">providers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">entityFramework</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  En la secci√≥n DbProviderFactories, se registr√≥ la f√°brica del nuevo proveedor: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.data</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DbProviderFactories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql Data Provider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">invariant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">support</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FF"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">description</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".Net Framework Data Provider for Postgresql"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Npgsql.NpgsqlFactory, Npgsql"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DbProviderFactories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.data</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Y de inmediato, intentaron inicializar la base de datos especificando la direcci√≥n del servidor Postgres y las credenciales del administrador del servidor en la cadena de conexi√≥n.  El resultado es la siguiente l√≠nea: <br><blockquote>  "Servidor = localhost;  Base de datos = TestPostgresDB;  Seguridad integrada = falso;  Id de usuario = postgres;  contrase√±a = pa $$ w0rd ‚Äù </blockquote>  Como se esperaba, gracias al modo manual de Migraciones EF, la inicializaci√≥n no pas√≥ y se produjo un error que no coincide con la imagen de la base de datos del modelo actual.  Para evitar la creaci√≥n de la migraci√≥n primaria con el nuevo proveedor y probar la inicializaci√≥n de la base de datos en Postgres, ajustamos ligeramente nuestra configuraci√≥n de infraestructura. <br><br>  En primer lugar, activamos las "migraciones autom√°ticas", una opci√≥n √∫til si un desarrollador realiza cambios en los modelos de dominio y la infraestructura de EF en el equipo: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> : <span class="hljs-title"><span class="hljs-title">DbMigrationsConfiguration</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; } }</code> </pre><br>  En segundo lugar, especificamos un nuevo proveedor en el m√©todo redefinido InitializeDatabase de la clase heredada CreateDatabaseIfNotExists, donde comenzamos las migraciones: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">CreateDatabaseIfNotExists</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyDbContext context</span></span></span><span class="hljs-function">)</span></span> { DbMigrator dbMigrator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbMigrator(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration { <span class="hljs-comment"><span class="hljs-comment">//TargetDatabase = new DbConnectionInfo(context.Database.Connection.ConnectionString, "System.Data.SqlClient") TargetDatabase = new DbConnectionInfo(context.Database.Connection.ConnectionString, "Npgsql") }); // There some code for run migrations } }</span></span></code> </pre><br>  Luego, lanzamos nuestra aplicaci√≥n de consola nuevamente con la misma cadena de conexi√≥n como argumento.  Esta vez, la inicializaci√≥n del contexto se realiz√≥ sin errores, y nuestros modelos de dominio se ajustan de manera segura a la nueva base de datos de Postgres.  La etiqueta "__MigrationHistory" apareci√≥ en la nueva base de datos, en la que hab√≠a un registro √∫nico de la primera migraci√≥n creada autom√°ticamente. <br><br>  En resumen: pudimos conectar un nuevo proveedor a un proyecto existente sin ning√∫n problema, pero al mismo tiempo cambiamos la configuraci√≥n del mecanismo de migraci√≥n. <br><br><h3>  Activar el modo de migraci√≥n manual </h3><br>  Como se mencion√≥ anteriormente, cuando el modo de migraci√≥n autom√°tica est√° activado, priva a su equipo de desarrollo paralelo en las √°reas de dominio y acceso a datos.  Para nosotros, esta opci√≥n era inaceptable.  Por lo tanto, necesit√°bamos configurar un modo manual de migraciones en el proyecto. <br><br>  Primero, devolvimos el campo AutomaticMigrationsEnabled a falso.  Entonces fue necesario lidiar con la creaci√≥n de nuevas migraciones.  Entendemos que las migraciones para diferentes DBMS, al menos, deben almacenarse en diferentes carpetas de proyectos.  Por lo tanto, decidimos crear una nueva carpeta para las migraciones de Postgres en un proyecto de infraestructura llamado PostgresMigrations (la carpeta con migraciones de MsSql, para mayor claridad, le cambiamos el nombre a MsSqlMigrations), y copiamos el archivo de configuraci√≥n de migraci√≥n de MsSql.  Al mismo tiempo, no copiamos todas las migraciones MsSql existentes a PostgresSql.  En primer lugar, porque todos contienen una instant√°nea de la configuraci√≥n del proveedor MsSql y, en consecuencia, no podremos usarlos en el nuevo DBMS.  En segundo lugar, el historial de cambios no es importante para el nuevo DBMS, y podemos pasar con la √∫ltima instant√°nea del estado de los modelos de dominio. <br><br>  Pensamos que todo estaba listo para la formaci√≥n de la primera migraci√≥n a Postgres.  Se elimin√≥ la base de datos creada durante la inicializaci√≥n del contexto con el modo de migraci√≥n autom√°tica activado.  Y, guiados por el hecho de que para la primera migraci√≥n necesita crear una base de datos f√≠sica basada en el estado actual de los modelos de dominio, calificamos felizmente el comando Actualizar-Base de datos en la Consola del Administrador de paquetes, especificando solo el par√°metro de cadena de conexi√≥n.  Como resultado, obtuvimos un error relacionado con la conexi√≥n al DBMS. <br><br>  Habiendo estudiado adicionalmente el principio de funcionamiento del comando Update-Database, hicimos lo siguiente: <br><br><ul><li>  agreg√≥ el siguiente c√≥digo a la configuraci√≥n de la migraci√≥n: <br><br>  para MsSql: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; MigrationsDirectory = <span class="hljs-string"><span class="hljs-string">@"MsSqlMigrations"</span></span>; }</code> </pre><br>  para Postgres: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { AutomaticMigrationsEnabled = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; ContextKey = <span class="hljs-string"><span class="hljs-string">"Project.Infrastructure.MyDbContext"</span></span>; MigrationsDirectory = <span class="hljs-string"><span class="hljs-string">@"PostgresMigrations"</span></span>; }</code> </pre></li><li>  indic√≥ el par√°metro necesario del comando Actualizar-Base de datos que pasa el nombre del proveedor </li><li>  par√°metros agregados que indican el proyecto que contiene la descripci√≥n de la infraestructura ef, y la carpeta con la configuraci√≥n de migraci√≥n del nuevo proveedor </li></ul><br>  Como resultado, obtuvimos este comando: <br><blockquote>  Update-Database -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.PostgresMigrations.Configuration -ConnectionString "Server = localhost;  Base de datos = TestPostgresDB;  Seguridad integrada = falso;  Id de usuario = postgres;  contrase√±a = pa $$ w0rd "-ConnectionProviderName" Npgsql " </blockquote>  Despu√©s de ejecutar este comando, pudimos ejecutar el comando Add-Migration con par√°metros similares, nombrando la primera migraci√≥n InitialCreate: <br><blockquote>  Add-Migration -Name "InitialCreate" -ProjectName "CrossTech.DSS.Infrastructure" -ConfigurationTypeName CrossTech.DSS.Infrastructure.PostgresMigrations.Configuration -ConnectionString "Server = localhost;  Base de datos = TestPostgresDB;  Seguridad integrada = falso;  Id de usuario = postgres;  contrase√±a = pa $$ w0rd "-ConnectionProviderName" Npgsql " </blockquote>  Ha aparecido un nuevo archivo en la carpeta PostgresMigrations: 2017010120705068_InitialCreate.cs <br><br>  Luego eliminamos la base de datos creada despu√©s de ejecutar el comando Update-Database y lanzamos nuestra aplicaci√≥n de consola con la cadena de conexi√≥n indicada anteriormente como argumento.  Y as√≠ obtuvimos la base de datos ya sobre la base de una migraci√≥n creada manualmente. <br><br>  Para resumir: pudimos, con un m√≠nimo esfuerzo, agregar la primera migraci√≥n para el proveedor de Postgres e inicializar el contexto a trav√©s de la aplicaci√≥n de consola, obteniendo una nueva base de datos, en la que se produjeron los cambios de nuestra primera migraci√≥n manual. <br><br><h3>  Cambiar entre proveedores </h3><br>  Todav√≠a ten√≠amos una pregunta abierta: ¬øc√≥mo configurar la inicializaci√≥n de contexto para que fuera posible acceder a un DBMS espec√≠fico en tiempo de ejecuci√≥n? <br><br>  La tarea consist√≠a en que en la etapa de inicializaci√≥n del contexto era posible seleccionar una u otra base de datos de destino del proveedor deseado.  Como resultado de repetidos intentos de configurar este interruptor, se nos ocurri√≥ una soluci√≥n que se parece a esto. <br><br>  En la aplicaci√≥n de consola del proyecto en app.config (y si no usa app.config, luego machine.config), agregamos una nueva cadena de conexi√≥n con el proveedor y el nombre de la conexi√≥n, y en el constructor de contexto "soltamos" el nombre de la conexi√≥n en lugar de la cadena de conexi√≥n.  Al mismo tiempo, conectamos la cadena de conexi√≥n al contexto a trav√©s del singleton de la instancia de DbConfiguration.  Pasamos la instancia de la clase heredada de DbConfiguration como par√°metro. <br><br>  La clase DbConfiguration heredada resultante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbConfig</span></span> : <span class="hljs-title"><span class="hljs-title">DbConfiguration</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DbConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> provideName</span></span></span><span class="hljs-function">)</span></span> { ConfigurationManager.ConnectionStrings.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionStringSettings(connectionName, connectionString, provideName)); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (connectionName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"PostgresDbConnection"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NpgsqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderServices(provideName, NpgsqlServices.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderFactory(provideName, NpgsqlFactory.Instance); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"MsSqlDbConnection"</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderServices(provideName, SqlProviderServices.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetProviderFactory(provideName, SqlClientFactory.Instance); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetDefaultConnectionFactory(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnectionFactory()); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  Y la inicializaci√≥n del contexto en s√≠ ahora se ve as√≠: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionName = args[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> connectionString = args[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> provideName = args[<span class="hljs-number"><span class="hljs-number">2</span></span>]; DbConfiguration.SetConfiguration(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbConfig(connectionName, connectionString, provideName)); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> context = MyDbContext(connectionName)) { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Database created"</span></span>); }</code> </pre><br>  Y quien sigui√≥ con cuidado, probablemente not√≥ que ten√≠amos que hacer un cambio m√°s en el c√≥digo.  Esta es la definici√≥n de la base de datos de destino durante la inicializaci√≥n de la base de datos, que ocurre en el m√©todo InitializeDatabase descrito anteriormente. <br><br>  Agregamos un interruptor simple para determinar la configuraci√≥n de migraci√≥n de un proveedor en particular: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DbInitializer</span></span> : <span class="hljs-title"><span class="hljs-title">CreateDatabaseIfNotExists</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MyDbContext</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _connectionName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DbInitializer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionName</span></span></span><span class="hljs-function">)</span></span> { _connectionName = connectionName; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeDatabase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MyDbContext context</span></span></span><span class="hljs-function">)</span></span> { DbMigrationsConfiguration&lt;MyDbContext&gt; config; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_connectionName) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"PostgresDbConnection"</span></span>: config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PostgresMigrations.Configuration(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">"MsSqlDbConnection"</span></span>: config = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MsSqlMigrations.Configuration(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: config = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (config == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; config.TargetDatabase = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbConnectionInfo(_connectionName); DbMigrator dbMigrator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbMigrator(config); <span class="hljs-comment"><span class="hljs-comment">// There some code for run migrations } }</span></span></code> </pre><br>  Y el propio constructor de contexto comenz√≥ a verse as√≠: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyDbContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionNameParam</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">connectionString</span></span></span><span class="hljs-function">)</span></span> { Database.SetInitializer(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DbInitializer(connectionName = connectionNameParam)); Database.Initialize(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre><br>  Luego, lanzamos la aplicaci√≥n de consola y especificamos el par√°metro de la aplicaci√≥n MsSql como proveedor de DBMS.  Establecemos los argumentos para la aplicaci√≥n de la siguiente manera: <blockquote>  Servidor "MsSqlDbConnection" "= localhost \ SQLEXPRESS;  Base de datos = TestMsSqlDB;  Id de usuario = sa;  contrase√±a = pa $$ w0rd "" System.Data.SqlClient " </blockquote><br>  La base de datos MsSql se cre√≥ sin errores. <br><br>  Luego especificamos los argumentos de la aplicaci√≥n: <br><blockquote>  "PostgresDbConnection" "Servidor = localhost;  Base de datos = TestPostgresDB;  Seguridad integrada = falso;  Id de usuario = postgres;  contrase√±a = pa $$ w0rd "" Npgsql " </blockquote>  La base de datos Postgres tambi√©n se cre√≥ sin errores. <br><br>  Entonces, un subtotal m√°s: para que EF inicialice el contexto de la base de datos para un proveedor espec√≠fico, en tiempo de ejecuci√≥n necesita: <br><br><ul><li>  "Indique" el mecanismo de migraci√≥n a este proveedor </li><li>  configurar cadenas de conexi√≥n DBMS antes de la inicializaci√≥n de contexto </li></ul><br><h3>  Trabajamos con las migraciones de dos DBMS en un equipo. </h3><br>  Como vimos, la parte m√°s interesante comienza despu√©s de la aparici√≥n de nuevos cambios en el dominio.  Debe generar migraciones para dos DBMS teniendo en cuenta un proveedor espec√≠fico. <br><br>  Entonces, para el servidor MSSQL, debe ejecutar comandos secuenciales (para Postgres, los comandos descritos anteriormente, al crear la primera migraci√≥n): <br><br><ul><li>  actualizar la base de datos de acuerdo con la √∫ltima instant√°nea <br><blockquote>  Actualizar-Base de datos -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.MsSqlMigrations.Configuration -ConnectionString "Server = localhost;  Base de datos = TestMsSqlDB;  Seguridad integrada = falso;  Id de usuario = sa;  contrase√±a = pa $$ w0rd "-ConnectionProviderName" System.Data.SqlClient " </blockquote></li><li>  agregando nueva migraci√≥n <br><blockquote>  Add-Migration -Name "SomeMigrationName" -ProjectName "Project.Infrastructure" -ConfigurationTypeName Project.Infrastructure.MsSqlMigrations.Configuration -ConnectionString "Server = localhost;  Base de datos = TestMsSqlDB;  Seguridad integrada = falso;  Id de usuario = sa;  contrase√±a = pa $$ w0rd "-ConnectionProviderName" System.Data.SqlClient " </blockquote></li></ul><br>  Cuando los desarrolladores realizan cambios en el dominio en paralelo, obtenemos m√∫ltiples conflictos al fusionar estos cambios en el sistema de control de versiones (por simplicidad llamaremos git).  Esto se debe al hecho de que las migraciones a EF van secuencialmente una tras otra.  Y si un desarrollador crea una migraci√≥n, entonces otro desarrollador simplemente no lograr√° agregar la migraci√≥n secuencialmente.  Cada migraci√≥n posterior almacena informaci√≥n sobre la anterior.  Por lo tanto, es necesario actualizar las llamadas instant√°neas del modelo en la migraci√≥n a la √∫ltima creada. <br><br>  Al mismo tiempo, la resoluci√≥n de conflictos en las migraciones de EF en un equipo se reduce a priorizar la importancia de los cambios de un desarrollador en particular.  Y cuyos cambios tienen mayor prioridad, esos deber√≠an ser los primeros en completarlos en git, y el resto de los desarrolladores de acuerdo con la jerarqu√≠a acordada deben hacer lo siguiente: <br><br><ol><li>  eliminar migraciones locales creadas </li><li>  lleve los cambios del repositorio a usted mismo, donde otros colegas con alta prioridad ya han vertido sus migraciones </li><li>  crear migraci√≥n local y subir los cambios resultantes de nuevo a git </li></ol><br>  En la medida en que estemos familiarizados con el mecanismo de migraci√≥n de EF, podemos juzgar que el enfoque de desarrollo de equipo descrito es el √∫nico en este momento.  No consideramos que esta soluci√≥n sea ideal, pero tiene derecho a la vida.  Y la cuesti√≥n de encontrar una alternativa al mecanismo de Migraciones EF se ha vuelto urgente para nosotros. <br><br><h3>  En conclusi√≥n </h3><br>  Trabajar con varios DBMS que usan EF6 junto con EF Migraciones es real, pero en esta versi√≥n los chicos de Microsoft no tomaron en cuenta la posibilidad de un trabajo paralelo del equipo usando sistemas de control de versiones. <br><br>  Hay muchas soluciones alternativas de EF Migraciones en el mercado (tanto de pago como gratuitas): DbUp, RoundhousE, ThinkingHome.Migrator, FluentMigrator, etc.  Y a juzgar por las revisiones, son m√°s como desarrolladores que EF Migraciones. <br><br>  Afortunadamente, ahora tenemos la oportunidad de realizar alg√∫n tipo de actualizaci√≥n en nuestro proyecto.  Y en el futuro cercano cambiaremos a EF Core.  Analizamos los pros y los contras del mecanismo de EF Core Migrations y llegamos a la conclusi√≥n de que ser√≠a m√°s conveniente para nosotros trabajar con una soluci√≥n de terceros, a saber, Fluent Migrator. <br><br>  Esperamos que te haya interesado nuestra experiencia.  Listo para aceptar comentarios y responder preguntas, ¬°Bienvenido! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/445910/">https://habr.com/ru/post/445910/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445898/index.html">Sobre nuevas ideas, opiniones limitadas y boca a boca</a></li>
<li><a href="../445900/index.html">C√≥mo soportar el aumento de las cargas del sistema: hable sobre los preparativos a gran escala para el Black Friday</a></li>
<li><a href="../445904/index.html">Tipos de infinitos y tallo cerebral</a></li>
<li><a href="../445906/index.html">No comer aspirina</a></li>
<li><a href="../445908/index.html">Golang y la evoluci√≥n de la interacci√≥n de la base de datos.</a></li>
<li><a href="../445912/index.html">Hola, Habr, somos Advantech.</a></li>
<li><a href="../445914/index.html">¬øDocker es un juguete o no? ¬øO es realmente as√≠?</a></li>
<li><a href="../445918/index.html">20 a√±os de RollerCoaster Tycoon: una entrevista con el creador del juego</a></li>
<li><a href="../445920/index.html">Live: c√≥mo frenar el desarrollo de iOS en equipos grandes</a></li>
<li><a href="../445922/index.html">¬øPor qu√© ver transmisiones en l√≠nea si puedes leer a Habr?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>