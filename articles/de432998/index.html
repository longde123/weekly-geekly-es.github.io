<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö§ üëàüèø üóÉÔ∏è Weihnachtsgeschichte üßúüèø üí™üèæ üíÖüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir m√∂chten die Geschichte teilen, die bei einem unserer Projekte f√ºr das neue Jahr passiert ist. Das Wesentliche des Projekts ist, dass es die Arbeit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Weihnachtsgeschichte</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/432998/">  Wir m√∂chten die Geschichte teilen, die bei einem unserer Projekte f√ºr das neue Jahr passiert ist.  Das Wesentliche des Projekts ist, dass es die Arbeit von √Ñrzten in medizinischen Einrichtungen automatisiert.  W√§hrend des Besuchs des Patienten schreibt der Arzt Informationen in den Rekorder, dann wird das Audio transkribiert.  Nach dem Transkriptionsprozess - d.h.  Umwandlung der Audioaufzeichnung in Text - Ein medizinisches Dokument wird gem√§√ü den einschl√§gigen Standards erstellt und an die Klinik zur√ºckgesandt, von der die Audioaufzeichnung stammt, wo der sendende Arzt sie empf√§ngt, pr√ºft und genehmigt.  Nach bestandener Pflichtpr√ºfung wird das Dokument an die endg√ºltigen Patienten gesendet. <br><a name="habracut"></a><br>  Alle medizinischen Einrichtungen, die das Produkt verwenden, k√∂nnen bedingt in zwei gro√üe Gruppen unterteilt werden: <br><br><ul><li>  Hosting im Rechenzentrum unseres Kunden, das f√ºr die Leistung der Anwendung sowohl f√ºr die Software als auch f√ºr die Hardware voll verantwortlich ist.  Zum Beispiel, wenn der Speicherplatz knapp wird oder die Serverleistung auf der CPU nicht ausreicht. </li><li>  Selbst gehostet: Sie platzieren alle Ger√§te direkt zu Hause und sind selbst f√ºr deren Leistung verantwortlich.  Unser Kunde stellt ihnen die Anwendung und deren Unterst√ºtzung zur Verf√ºgung. </li></ul><br>  Auf diese Weise interagiert unser Team mit Endservern, die direkt in der Cloud unseres Kunden gehostet werden. <br><br><img src="https://habrastorage.org/webt/fu/dh/qb/fudhqbrny8p_r3wcs4swokhglqw.png"><br><br>  Wir haben Zugriff auf diese Server, um alle geplanten Arbeiten und Wartungen durchzuf√ºhren, die erforderlich sind. <br><br>  Die zweite Gruppe - selbst gehostete Clients - f√ºr sie fungiert die Client-Cloud als Gateway, √ºber das wir eine Verbindung zu diesen Servern herstellen.  In diesem Fall haben wir eingeschr√§nkte Rechte. Oft k√∂nnen wir aufgrund von Sicherheitseinstellungen keine Vorg√§nge ausf√ºhren.  Wir stellen eine Verbindung zu den Servern √ºber RDP her, das Remotedesktopprotokoll unter Windows.  Das alles funktioniert nat√ºrlich √ºber ein VPN. <br><br>  Es ist zu beachten, dass jeder im Diagramm dargestellte Server tats√§chlich eine Kombination aus einem Anwendungsserver und einem Datenbankserver ist.  Auf dem Datenbankserver sind jeweils das MS SQL Server-DBMS und der SSRS-Berichtsdienst installiert.  Dar√ºber hinaus ist die Version von MSSQL Server in allen Kliniken unterschiedlich: 2008, 2012, 2014. Zus√§tzlich zu den Versionen selbst werden √ºberall verschiedene Service Packs und Patches installiert.  Im Allgemeinen ein kompletter Zoo. <br><br>  Auf dem Anwendungsserver haben wir den IIS- und ElasticSearch-Webserver installiert.  ElasticSearch ist eine Suchmaschine, die auch die Volltextsuche implementiert. <br>  Das Wesentliche an unserem Produkt ist ‚ÄûJob‚Äú.  Arbeit ist eine abstrakte Einheit, die alle Informationen miteinander verkn√ºpft, die sich auf die Aufnahme eines bestimmten Patienten beziehen.  Diese Informationen umfassen: <br><br><ul><li>  Daten √ºber den Arzt; </li><li>  Patientendaten; </li><li>  Daten √ºber den Besuch; </li><li>  Audiodatei (Rede des Arztes); </li><li>  Dokumente (mehrere Versionen); </li><li>  Arbeitsverarbeitungsgeschichte; </li><li>  Brancheninformationen usw. </li></ul><br>  Dieses Diagramm zeigt ein vereinfachtes Datenbankschema, anhand dessen Sie die Beziehungen zwischen den Haupttabellen sehen k√∂nnen.  Dies ist nur der grundlegende Teil, tats√§chlich hat die Datenbank mehr als 200 Tabellen. <br><br><img src="https://habrastorage.org/webt/sc/ke/hl/sckehlss-czi3bz2kagmfecrroy.png"><br><br>  Ein wenig √ºber die Klinik, in der sich der Vorfall ereignete: <br><br><ul><li>  1500-2000 Arbeiten pro Tag; </li><li>  1000+ aktive Benutzer (√Ñrzte + Sekret√§re); </li><li>  Selbst gehostet. </li></ul><br>  DB: <br><br><ul><li>  Gr√∂√üe: 800+ Gb (750K + Werke, 2M + Dokumente); </li><li>  DBMS: MS SQL Server 2008 R2; </li><li>  Wiederherstellungsmodell: Einfach. </li></ul><br>  Hier m√∂chte ich eine kleine Erkl√§rung geben.  In SQL Server gibt es drei Wiederherstellungsmodelle: einfach, massenprotokolliert und vollst√§ndig.  Ich werde jetzt nicht √ºber den dritten sprechen, ich werde den ersten und zweiten erkl√§ren.  Der Hauptunterschied besteht darin, dass im einfachen Modell der Transaktionsverlauf nicht im Protokoll gespeichert wird. Sobald die Transaktion festgeschrieben wurde, wird der Datensatz aus dem Transaktionsprotokoll gel√∂scht.  Bei Verwendung des vollst√§ndigen Wiederherstellungsmodus wird der gesamte Verlauf der Daten√§nderungen in einem Transaktionsprotokoll gespeichert.  Was gibt uns das?  In einem unvorhergesehenen Fall k√∂nnen wir, wenn wir die Datenbank von Sicherungen zur√ºcksetzen m√ºssen, nicht nur zu einer bestimmten Sicherung zur√ºckkehren, sondern zu jedem Zeitpunkt bis zu einer bestimmten Transaktion, d. H. Wir haben sie gespeichert Bei Sicherungen gibt es nicht nur einen bestimmten Status der Datenbank zum Zeitpunkt der Sicherung, sondern auch eine ganze Historie von Daten√§nderungen. <br><br>  Ich denke, es lohnt sich nicht zu erkl√§ren, dass der einfache Modus nur in der Entwicklung, auf Testservern und in der Produktion verwendet wird.  Auf keinen Fall. <br><br>  Aber die Klinik hatte offenbar ihre eigenen Gedanken zu diesem Thema;) <br><br><h3>  Starten Sie </h3><br>  Ein paar Tage sp√§ter, dem neuen Jahr, bereiten sich alle auf den Urlaub vor, kaufen Geschenke, schm√ºcken Weihnachtsb√§ume, verbringen Firmenfeiern und warten auf ein langes Wochenende. <br><br><h6>  22. Dezember (Freitag) 1 Tag </h6><br>  <strong>14:31</strong> Der Kunde sagte, dass er den n√§chsten Tagesbericht nicht erhalten habe.  Der Bericht kommt zweimal t√§glich nach einem Zeitplan per E-Mail an. Er muss das Senden von Daten an ein externes Integrationssystem steuern, was nicht allzu kritisch ist. <br><br>  Es kann mehrere Gr√ºnde geben: <br><br><ol><li>  Probleme mit SMTP, Briefe wurden einfach nicht zugestellt (sie haben beispielsweise das Passwort ge√§ndert und niemandem davon erz√§hlt); </li><li>  Probleme auf der Serverseite der Berichte; </li><li>  Es ist etwas mit der Datenbank passiert. </li></ol><br>  <strong>16:03 Die</strong> Klinik √§ndert manchmal das Passwort in SMTP, ohne dass jemand dar√ºber gewarnt wird. Nachdem wir die aktuellen Aufgaben erledigt haben, √ºberpr√ºfen wir den Bericht ruhig manuell, indem wir ihn √ºber die Weboberfl√§che starten. Es wird ein Fehler angezeigt, der auf Probleme in der Datenbank hinweist. <br><br>  Ein Beispiel f√ºr den Fehler, den wir beim Starten des Berichts erhalten haben. <br><br><pre><code class="plaintext hljs">SQL Server detected a logical consistency-based I/O error: incorrect checksum (expected: 0x9876641f; actual: 0xa3255fbf). It occurred during a read of page (1:876) in database ID 7 at offset 0x000000006d8000 in file 'D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\ServerLive.mdf'.</code> </pre> <br>  Dies zeigt an, dass die Datenbank Seiten besch√§digt hat.  Wir hatten ein leichtes Gef√ºhl der Angst. <br><br>  <strong>20:53</strong> Um das Ausma√ü des Schadens zu beurteilen, f√ºhren wir eine Datenbankpr√ºfung mit dem speziellen Befehl <strong><em>DBCC CHECKDB durch</em></strong> .  Abh√§ngig von der Gr√∂√üe des Schadens kann der Testbefehl eine Weile dauern, daher f√ºhren wir den Befehl nachts aus.  Hier haben wir Gl√ºck, dass dies am Freitagnachmittag passiert ist, das hei√üt, wir hatten zumindest alle freien Tage, um dieses Problem zu l√∂sen. <br><br>  In diesem Moment war die Situation wie folgt: <br><br><img src="https://habrastorage.org/webt/dp/nq/jm/dpnqjm7rvkmtjtxoc534js439zq.png"><br><br><h6>  23. Dezember (Samstag) 2. Tag </h6><br>  <strong>10:02</strong> Uhr morgens stellen wir fest, dass das √úberpr√ºfen der Datenbank mit CHECKDB eine Diskette ist - dies lag an einem Mangel an freiem Speicherplatz, weil  W√§hrend des √úberpr√ºfungsprozesses wird die tempor√§re Tempdb-Datenbank aktiv verwendet, und irgendwann ist der freie Speicherplatz einfach aufgebraucht. <br><br>  Daher entscheiden wir uns, anstatt die gesamte Datenbank zu √ºberpr√ºfen, sofort einen Tabellenscan zu starten.  Verwenden <strong><em>Sie dazu den Befehl DBCC CHECKTABLE</em></strong> . <br><br>  <strong>10:46</strong> Wir beschlie√üen, mit der JobHistory-Tabelle zu beginnen, die wahrscheinlich besch√§digt ist, da sie zum Generieren des Berichts verwendet wurde.  Diese Tabelle bewahrt, wie der Name schon sagt, die Geschichte aller Werke, d. H. √úberg√§nge der Arbeit zwischen Stufen. <br><br>  F√ºhren Sie <strong><em>DBCC CHECKTABLE ('dbo.JobHistory') aus</em></strong> . <br><br>  Durch √úberpr√ºfen dieser Tabelle werden besch√§digte Tabellen in der Datenbank angezeigt, was im Prinzip erwartet wurde. <br><br>  <strong>12:00</strong> Im Moment, wenn die Datenbank das vollst√§ndige Wiederherstellungsmodell verwendet, k√∂nnten wir die besch√§digten Seiten aus der Sicherung wiederherstellen, und das w√§re alles vorbei, aber unsere Datenbank befand sich im einfachen Modus.  Daher bleibt die einzige M√∂glichkeit, Sch√§den zu reparieren, der Start desselben Befehls mit dem speziellen Parameter <strong><em>REPAIR_ALLOW_DATA_LOSS</em></strong> .  Dies kann zu Datenverlust f√ºhren. <br><br>  Wir fangen an.  Die √úberpr√ºfung endet erneut mit einem Fehler. Wir erhalten die Fehlermeldung, dass die Wiederherstellung dieser Tabelle erst m√∂glich ist, wenn die zugeh√∂rigen Tabellen wiederhergestellt sind.  Die Verlaufstabelle bezieht sich auf die Arbeitstabelle (Jobs) des Fremdschl√ºssels. Daher schlie√üen wir, dass auch die Hauptarbeitstabelle (Jobs) besch√§digt ist. <br><br>  <strong>13:30</strong> Der n√§chste Schritt besteht darin, gleichzeitig die Jobs-Tabelle zu √ºberpr√ºfen. Wir hoffen, dass der Schaden im Index und nicht in den Daten enthalten ist.  In diesem Fall reicht es aus, den Index f√ºr die Datenwiederherstellung einfach neu zu erstellen. <br><br>  <strong>17:33</strong> Nach einer Weile stellen wir fest, dass unser Server √ºber RDP nicht verf√ºgbar ist.  Es wurde wahrscheinlich ausgeschaltet, die √úberpr√ºfung wurde nicht abgeschlossen, die Arbeit wurde ausgesetzt.  Wir informieren die Klinik, dass der Server nicht verf√ºgbar ist. Bitte erh√∂hen Sie ihn. <br><br>  Leichte Angst nimmt sehr spezifische Formen an. <br><br><h6>  24. Dezember (Sonntag) 3. Tag </h6><br>  <strong>14:31</strong> N√§her am Abendessen wird der Server angehoben, und wir f√ºhren die √úberpr√ºfung der Jobs-Tabelle erneut durch. <br>  <strong><em>DBCC CHECKTABLE ('dbo.Jobs')</em></strong> <br><br>  <strong>16:05 Die</strong> √úberpr√ºfung ist nicht abgeschlossen, der Server ist nicht verf√ºgbar.  Wieder. <br><br>  Nach einiger Zeit ist der Server wieder nicht verf√ºgbar, bevor wir die √úberpr√ºfung der Tabelle abgeschlossen haben.  Zu diesem Zeitpunkt f√ºhrt der IT-Service der Klinik eine Reihe von Serverpr√ºfungen durch.  Wir warten auf den Abschluss der Arbeiten. <br><br>  Aufgrund der Feiertage war die Kommunikation zwischen uns und dem Kunden langsam - wir erwarteten mehrere Stunden lang Antworten auf Fragen. <br><br><h6>  25. Dezember (Montag - Weihnachten) 4. Tag </h6><br>  <strong>16:00</strong> Am n√§chsten Tag, an dem der Server hochgefahren wurde, hat der Client Weihnachten und wir beginnen erneut mit der √úberpr√ºfung der Tabelle. Diesmal schlie√üen wir jedoch Indizes vom Scan aus und lassen nur die Datenpr√ºfung.  Und nach einiger Zeit ist der Server wieder nicht verf√ºgbar. <br><br>  Was ist los? <br><br>  In diesem Moment schleichen sich Gedanken ein, dass dies nicht nur ein Zufall ist, und es besteht der Verdacht, dass es sich um eine Besch√§digung auf Eisenebene handeln k√∂nnte (eine Festplatte ist gefallen).  Wir gehen davon aus, dass sich fehlerhafte Sektoren auf der Festplatte befinden. Wenn der Scan versucht, Daten aus diesen Sektoren zu lesen, st√ºrzt das System ab.  Wir informieren unseren Kunden √ºber unsere Annahme. <br><br>  Der Client f√ºhrt eine Festplattenpr√ºfung auf dem Hostcomputer durch. <br><br>  <strong>17:19 Der</strong> IT-Service der Klinik hat gemeldet, dass die Datei der virtuellen Maschine besch√§digt ist - das ist schlecht! ( <br>  Wir k√∂nnen noch nicht arbeiten und warten auf ein Signal, wenn sie das Problem beheben, und wir k√∂nnen unsere Arbeit fortsetzen. <br><br><h6>  26. Dezember (Dienstag) Tag 5 </h6><br>  <strong>14:05 Der</strong> IT-Klinikdienst startet einen weiteren Prozess zur Wiederherstellung von Datentr√§gern.  Uns wurde gesagt, dass wir CHECKTABLE parallel ausf√ºhren k√∂nnen, um die Tabelle zu √ºberpr√ºfen.  Wir starten den Test erneut - die virtuelle Maschine st√ºrzt erneut ab, wir informieren den Client, dass die Datei der virtuellen Maschine immer noch besch√§digt ist. <br><br>  Heutzutage ist die gesamte Kommunikation mit dem Kunden sehr langsam, mit einer enormen Zeitverz√∂gerung aufgrund der Feiertage. <br><br><h6>  27. Dezember (Mittwoch) Tag 6 </h6><br>  <strong>14:00</strong> Wir starten die Festplattenpr√ºfung unter Windows - <strong>checkdisk</strong> in der virtuellen Maschine - es wurden keine Probleme festgestellt. <br>  Die Datenbank befindet sich im einfachen Modus, sodass die Wahrscheinlichkeit, die aktuelle Datenbank mit den DBMS-Tools zu reparieren, auf Null sinkt, da  Wir k√∂nnen einzelne besch√§digte Seiten nicht wiederherstellen. <br>  Wir fangen an, die Option eines Rollbacks und der Wiederherstellung der Datenbank aus der Sicherung in Betracht zu ziehen. <br>  Wir √ºberpr√ºfen die Datenbanksicherungen und stellen fest, dass die Sicherungen nicht mit den DBMS-Mitteln erstellt wurden. Die letzte Sicherung erfolgte im Jahr 2014, d. H.  Es gibt keine Sicherungen der Datenbank.  Warum sie dies nicht getan haben, ist ein separates Problem. Es liegt in der Verantwortung der Klinik, die Effizienz und Sicherheit der Datenbank sicherzustellen. <br><br>  Es besteht eine hohe Wahrscheinlichkeit, dass die Wiederherstellung der aktuellen Datenbank nicht funktioniert. Wir beginnen, andere Optionen f√ºr das Rollback in Betracht zu ziehen. <br><br>  Lassen Sie uns die Situation mit Backups in der Klinik genauer untersuchen. <br><br>  Die Situation mit Backups: <br><br><ul><li>  Es gibt keine Datenbanksicherungen (!!!) </li><li>  Es gibt keine Schnappsch√ºsse der virtuellen Maschine (!?) </li><li>  Es gibt jedoch Festplattensicherungen (full + inc) </li></ul><br>  Die Datenbank befindet sich auf Datentr√§ger D. Sie haben w√∂chentliche vollst√§ndige Sicherungen und t√§gliche inkrementelle Sicherungen durchgef√ºhrt. <br><br><ul><li>  jeden Freitag um 20:00 Uhr vollst√§ndige Sicherung </li><li>  jeden Tag inkrementelle Sicherung </li><li>  Es gibt eine vollst√§ndige Sicherung vom 15. und 22 .. </li><li>  Es gibt t√§gliche Backups bis zum 21 .. </li></ul><br>  Das hei√üt,  Im Prinzip k√∂nnen wir auf den Zustand zur√ºcksetzen, bevor das Problem auftritt. <br>  Wir warten auf ein Update von der Klinik, um das Rollback der Datenbank aus dem Backup zu starten. <br><br>  Gleichzeitig schickte die Klinik eine Anfrage an den Eisenlieferanten (HP), die als ‚Äûdringend‚Äú gekennzeichnet war. <br><br><h6>  28. Dezember (Donnerstag) Tag 7 </h6><br>  <strong>13:13 Der</strong> IT-Service der Klinik beginnt mit der Einrichtung einer neuen virtuellen Maschine  Es ist nicht m√∂glich, den Schaden in der Datei der alten virtuellen Maschine zu beheben. <br><br>  <strong>19:09</strong> Eine neue virtuelle <strong>Maschine ist</strong> mit installiertem SQL Server verf√ºgbar. <br>  Der n√§chste Schritt besteht darin, die Datenbank aus der Festplattensicherung wiederherzustellen.  Zun√§chst beschlie√üen wir, zum 22. Tag zur√ºckzukehren, wenn das Problem weiterhin besteht, und dann zum 21., 20. usw. zur√ºckzukehren, bis wir zu einem funktionierenden Zustand gelangen. <br><br>  Es war der 28. Tag auf dem Hof, wir waren auf der Firmenfeier und hier erfahren sie, dass die Klinik Probleme mit der Wiederherstellung von Backups hat, weil BACKUPs LEER sind! <br><br>  Hier sind die Neuigkeiten! <br><br>  Wenn Sie eine Sicherung von Laufwerk D ab dem 21. wiederherstellen, stellt sich heraus, dass es wie alle anderen leer ist.  Es werden direkte Shredder-Backups erhalten - sie scheinen vorhanden zu sein, sind es aber gleichzeitig nicht.  Es ist nicht ganz klar, wie dies √ºberhaupt passiert ist, aber soweit wir verstehen konnten, ist der Punkt nicht gen√ºgend Speicherplatz zum Speichern von Festplattensicherungen.  Sie haben 500 GB Backups f√ºr die Speicherung zugewiesen, aber zum Zeitpunkt des Vorfalls wog die Datenbank bereits 800 GB, sodass die Sicherung im Prinzip nicht erfolgreich sein konnte.  Das hei√üt,  Backups wurden regelm√§√üig gem√§√ü dem Zeitplan erstellt, aber aufgrund von Platzmangel endeten sie mit einem Fehler und waren dementsprechend leer, und der IT-Service der Klinik hatte nicht einmal die Idee, zu √ºberpr√ºfen, ob alles in Ordnung mit ihnen war.  Nicht so. <br><br><h6>  29. Dezember (Freitag) Tag 8 </h6><br>  <strong>13:11</strong> Diskussion weiterer Aktionen.  M√∂gliche Optionen: <br><br><ul><li>  Beim Versuch, Datenbankdateien (.ldf + .two-Dateien) zu kopieren, sind die Erfolgschancen sehr gering. </li><li>  Der Versuch, die Datenbank zu sichern, ist wiederum sehr unwahrscheinlich. </li><li>  Replikation konfigurieren - funktioniert m√∂glicherweise. </li></ul><br>  Auf dem neuen Server wurde ein 1-TB-Laufwerk zugewiesen, was offensichtlich nicht ausreicht, wenn wir versuchen, von diesem Server aus zu sichern und wiederherzustellen  Im schlimmsten Fall nehmen Sicherungen ohne Komprimierung so viel Speicherplatz ein wie die urspr√ºngliche Datenbank, d. h.  800 GB. <br>  Bitte f√ºgen Sie Orte auf dem neuen Server hinzu und fahren Sie mit dem Kopieren der Datenbankdateien fort. <br>  Auf dem neuen Server wurde eine Datenbank erstellt und das Datenbankschema wiederhergestellt - dies erm√∂glicht zumindest die Verarbeitung neuer Arbeiten.  Die Klinik wird zumindest in der Lage sein, neue Patienten mit einem solchen System aufzunehmen. <br><br>  <strong>14:36</strong> Daher fahren wir mit Option Nummer eins fort, obwohl wir nicht viel Erfolg erwarten. <br>  Stoppen Sie SQL Server, kopieren Sie die Datendatei (mdf) und das Protokoll (ldf). <br><br>  <strong>16:13</strong> Nach der H√§lfte der Protokolldatei wurde sie erfolgreich kopiert (48 GB), und 50 GB der Datendatei wurden bereits kopiert (795 von 846 GB √ºbrig).  Bei dieser Geschwindigkeit dauert es ungef√§hr 12 Stunden, bis die Kopie fertig ist. <br><br>  <strong>16:30 Der</strong> alte Datenbankserver wurde beim Kopieren der Datei ausgeschaltet, was durchaus zu erwarten ist. <br><br>  <strong>17:09</strong> Daher fahren wir mit der n√§chsten Option fort - dem Einrichten der Replikation, w√§hrend wir angeben k√∂nnen, welche Daten repliziert werden sollen. Das hei√üt, wir k√∂nnen zuerst absichtlich besch√§digte Tabellen ausschlie√üen und zuerst die unbesch√§digten Daten kopieren und dann die problematischen Tabellen in Teilen √ºbertragen.  Leider funktioniert diese Option auch nicht, da wir aufgrund von Datenbankbesch√§digungen nicht einmal eine Publikation mit bestimmten Tabellen erstellen k√∂nnen. <br>  Wir erw√§gen auch Daten√ºbertragungsoptionen. <br><br>  <strong>20:01</strong> Infolgedessen beginnen wir einfach, Daten vom alten auf den neuen Server zu √ºbertragen, indem wir sie in Priorit√§tsreihenfolge importieren und exportieren. <br><br>  <strong>21:35</strong> Zuerst die kritischsten Daten, dann archiviert und weniger kritisch (~ 300 GB).  In der ersten Exportwelle blieben weniger als 300 GB Daten √ºbrig.  Die Dokumententabelle (300 GB) ist ebenfalls ausgeschlossen.  Wir beginnen nachts mit dem Kopieren. <br><br><h6>  30. Dezember (Samstag) Tag 9 </h6><br>  <strong>15:00 Wir √ºbertragen</strong> weiterhin Daten.  Die Jobs-Tabelle ist √ºberhaupt nicht verf√ºgbar.  Die meisten Tabellen wurden zu diesem Zeitpunkt kopiert. <br>  Aber ohne <strong>Jobs</strong> ist alles nutzlos, da es die Hauptverbindung zwischen allen Daten darstellt und ihnen aus gesch√§ftlicher Sicht Bedeutung und Wert verleiht.  Ohne sie haben wir nur einen unterschiedlichen Datensatz, den wir einfach nicht verwenden k√∂nnen. <br><br>  Zu diesem Zeitpunkt ist auch die Wiederherstellung des Datenbankschemas abgeschlossen. <br><br>  <strong>Die Folgen des Vorfalls:</strong> <br><br>  Zu diesem Zeitpunkt haben wir einen gro√üen Verlust an Live-Daten. <br>  Das hei√üt,  Formal haben wir einige Daten in der Datenbank, aber tats√§chlich gibt es keine M√∂glichkeit, sie zu verwenden oder zu verbinden, sodass wir √ºber den vollst√§ndigen Datenverlust sprechen k√∂nnen. <br>  Datenverlust bei mehr als 750.000 Patientenaufnahmen. <br><br>  Das ist wirklich traurig! <br><br><ul><li>  Dies ist ein schwerer Schlag f√ºr den Ruf unserer Kunden, der sich als gro√üe Probleme f√ºr sie im Gesch√§ftsleben herausstellen kann, wenn sie neue Vertr√§ge abschlie√üen und neue Kunden finden. </li><li>  Der Verlust so vieler Daten f√ºr die Klinik kann zu ernsthaften Problemen und Geldstrafen f√ºhren, weil  Dies sind vertrauliche Daten, die medizinische Vertraulichkeit enthalten und im wahrsten Sinne des Wortes vom Leben der Menschen abh√§ngen. </li></ul><br>  Wir begannen zu √ºberlegen, was wir in dieser Situation tun k√∂nnen.  Sie begannen, das System nach Knochen zu sortieren, um Hinweise zu finden. <br><br>  <strong>15:16</strong> Wenn wir alle Aspekte des Systems analysieren, verstehen wir, dass wir versuchen k√∂nnen, die fehlenden Daten aus dem ElasticSearch-Index zu extrahieren.  Die Sache ist, dass aufgrund der falschen Konfiguration der ElasticSearch-Indizes nicht nur die Felder gespeichert werden, in denen die Volltextsuche durchgef√ºhrt wird, sondern im Allgemeinen alles, dh tats√§chlich eine vollst√§ndige Kopie der Daten, und wir k√∂nnen theoretisch Daten daraus extrahieren √ºber Werke und legen Sie sie zur√ºck in unsere Datenbank.  Es ist zu hoffen, dass die Daten weiterhin wiederhergestellt werden k√∂nnen. <br><br>  Ein Fehler, dem Sie ein Denkmal setzen k√∂nnen! <br><br><img src="https://habrastorage.org/webt/oy/62/nt/oy62ntr-iiercftfvwmd_gzoide.png"><br><br>  <strong>18:00</strong> Ein Dienstprogramm wurde schnell geschrieben, um die Daten zu extrahieren. Nach einigen Stunden stellen wir sicher, dass der Ansatz funktioniert und die Daten wiederhergestellt werden k√∂nnen. <br><br>  <strong>20:00 Die</strong> Wiederherstellung der Arbeit von ElasticSearch mit Hilfe eines schriftlichen Dienstprogramms hat begonnen.  Der Ansatz hat funktioniert, wir k√∂nnen die Daten auf der Arbeit wiederherstellen.  Parallel dazu extrahieren wir f√ºr jede Arbeit die neuesten Versionen des Dokuments. <br><br><h6>  31. Dezember (Sonntag - Neujahr) Tag 10 </h6><br>  <strong>14:09</strong> In der Nacht wurden 188 811 Werke restauriert. <br><br>  <strong>20:13</strong> Angesichts unseres Erfolgs beschlie√üt die Klinik, die √úbertragung des Servers an den HP Service zu verschieben, um uns Zeit zu geben, die maximalen Daten vom alten Server zu extrahieren. <br>  Mit solchen Neuigkeiten haben wir das neue Jahr gefeiert)) <br><br><h6>  01. Januar (Montag) 11. Tag </h6><br>  <strong>11:23</strong> Vorbereitung zum Starten des Systems nach dem Vorfall: <br><br><ul><li>  IIS auf dem App-Server neu konfiguriert; </li><li>  alle erforderlichen Dienste f√ºr die Arbeit mit dem neuen Datenbankserver neu konfiguriert; </li><li>  Trigger, gespeicherte Prozeduren, wiederhergestellte Funktionen. </li></ul><br>  <strong>14:28</strong> Dann begannen sie, die Tabelle der Dokumente zu kopieren, die aufgrund der Gr√∂√üe bei der ersten √úbertragung √ºbersprungen wurde. <br>  - Der alte DB-Server wird wieder heruntergefahren.  Offensichtlich ist auch die Tabelle "Dokumente" besch√§digt. Damit werden alle Patienteninformationen gespeichert.  Gl√ºcklicherweise ist es nicht vollst√§ndig besch√§digt, wir k√∂nnen Anfragen an es stellen, und wenn eine Anfrage an uns einen besch√§digten Datensatz zur√ºckgibt, st√ºrzt der Server in diesem Moment ab und f√§hrt herunter.  Wir k√∂nnen einige der Daten extrahieren. <br><br>  Dementsprechend signalisieren wir dem Client, dass er den Server anhebt, und bereiten gleichzeitig die neue Datenbank f√ºr den Start des Systems vor. <br><br>  <strong>18:01</strong> Wiederherstellung aller Integrit√§tsbeschr√§nkungen nach der √úbertragung des Hauptteils der Daten. <br><br>  <strong>22:02</strong> Wiederherstellung der Einschr√§nkungen abgeschlossen.  Wir haben einfach die Rohdaten maximal √ºbertragen.  Das Vorhandensein von Integrit√§tsbeschr√§nkungen w√ºrde unsere Aufgabe erheblich erschweren. <br><br><h6>  02. Januar (Dienstag) Tag 12 </h6><br>  <strong>05:52 Der</strong> alte DB-Server wurde beim Kopieren des Dokuments wieder ausgeschaltet.  Er wird umgehend erzogen, damit wir weiterarbeiten k√∂nnen. <br><br>  <strong>09:00</strong> Es konnten ca. 200.000 Dokumente stapelweise wiederhergestellt werden (ca. 20%). <br>  Wir haben verschiedene Wiederherstellungsmethoden verwendet: Sortieren nach verschiedenen Spalten, um Daten vom Ende oder Anfang der Tabelle zu erhalten, bis wir auf einen besch√§digten Teil der Tabelle sto√üen. <br><br>  <strong>13:42</strong> Beginn des Kopierens von Archivierungsarbeiten in der Tabelle - zum Gl√ºck ist es nicht besch√§digt. <br><br>  <strong>17:08</strong> Alle Archivarbeiten wurden wiederhergestellt (491 380 St√ºck). <br><br>  Das System ist startbereit: Benutzer k√∂nnen neue Arbeiten erstellen und verarbeiten. <br><br>  Leider k√∂nnen Sie aufgrund einer teilweisen Besch√§digung der Dokumententabelle nicht einfach alle Daten von ihr √ºbertragen, wie bei anderen Tabellen, weil  Der Tisch ist teilweise besch√§digt.  Wenn Sie versuchen, alle Daten abzurufen, st√ºrzt die Anforderung daher ab, wenn Sie versuchen, besch√§digte Seiten zu lesen.  Daher extrahieren wir die Daten punktweise mit verschiedenen Sortierungen und Stichprobengr√∂√üen: <br><br><ul><li>  Sortieren nach verschiedenen Feldern (ID, DateTime); </li><li>  Sortieren Sie aufsteigend, absteigend; </li><li>  Arbeiten Sie mit kleinen Gruppen von Linien (1000, 100); </li><li>  Jobs nach ID abrufen. </li></ul><br><br><h6>  03. Januar (Mittwoch) Tag 13 </h6><br>  <strong>08:58</strong> Fortsetzung des Prozesses zum Wiederherstellen von Dokumenten.  Dokumente wurden nur f√ºr aktive, unvollst√§ndige Arbeiten wiederhergestellt.  Zu diesem Zeitpunkt arbeiten 1000 (aktiv) ohne Dokumente. <br><br>  <strong>11:38</strong> Alle SQL-Jobs wurden migriert <br><br>  <strong>13:17</strong> 5 funktioniert ohne Dokumente, 231 keine Arbeit, aber es gibt eine Audiodatei, die Sie neu synchronisieren m√ºssen. <br><br><h6>  04. Januar (Donnerstag) Tag 14 </h6><br>  Die manuelle Wiederherstellung und √úberpr√ºfung der verbleibenden Arbeiten hat begonnen. <br>  Das System arbeitet und √ºberwacht und behebt Fehler online. <br><br><h6>  05. Januar (Freitag) Tag 15 </h6><br>  Bericht Migration zu SSRS geplant. <br>  Eine √úbertragung auf einen neuen Server ist nicht m√∂glich, da  Die Klinik hat eine √§ltere Version von SQL Server installiert und es funktioniert nicht, die Datenbank vom alten Server zu √ºbertragen. <br><br>  Optionen: <br><br><ul><li>  Aktualisieren Sie SQL Server von 2008 auf 2008 R2. </li><li>  Konfigurieren Sie alles von Grund auf neu. </li></ul><br>  Es wurde beschlossen, auf das SQL Server-Update zu warten. <br><br>  <strong>09:21</strong> Hintergrund Die Wiederherstellung von Dokumenten f√ºr abgeschlossene Arbeiten hat begonnen - der Prozess ist lang und wird mehrere Tage dauern. <br><br>  <strong>13:28</strong> √Ñnderung der Priorit√§t der Wiederherstellung von Dokumenten durch Abteilungen. <br><br>  <strong>18:18 Die</strong> Klinik gew√§hrte Zugriff auf SMTP, Mail-Setup <br><br><h3>  Ergebnis: </h3><br><ul><li>  Fast alle Daten wurden wiederhergestellt (nur 5 Jobs gingen verloren); </li><li>  Es wurden Empfehlungen zur Datenbankwartung herausgegeben, um solche Situationen zu verhindern. </li><li>  Datenbanksicherungen werden mit SQL Server konfiguriert. </li><li>  Zus√§tzliche √úberwachung von Backups unsererseits, Warnungen im Fehlerfall. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de432998/">https://habr.com/ru/post/de432998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de432988/index.html">Achter Webmaster. Lebe auf Habr√©</a></li>
<li><a href="../de432990/index.html">Edison Sprachaktivierte Holzlampe. Ausgabepreis 5 USD</a></li>
<li><a href="../de432992/index.html">Er setzte seine Kopfh√∂rer auf und starb: Wir haben es mit dem seltsamen Tod eines Sch√ºlers in Rimbau zu tun</a></li>
<li><a href="../de432994/index.html">Vivaldi 2.2 - Quantit√§t in Qualit√§t umwandeln</a></li>
<li><a href="../de432996/index.html">Ein paar W√∂rterb√ºcher Interna in CPython (und PyPy)</a></li>
<li><a href="../de433000/index.html">Kotlin kompilieren: JetBrains VS ANTLR VS JavaCC</a></li>
<li><a href="../de433002/index.html">Komm selbst ... oder die Kommunikationsregeln in einem Team</a></li>
<li><a href="../de433004/index.html">Eine robuste Cloud-Migrationsstrategie f√ºr 2019: 7 Tipps</a></li>
<li><a href="../de433008/index.html">USB-Ger√§te sind eine "pl√∂tzliche" Bedrohung</a></li>
<li><a href="../de433010/index.html">Haben Sie eine Idee: Berechtigungssystem f√ºr npm-Pakete</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>