<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚤 👈🏿 🗃️ Weihnachtsgeschichte 🧜🏿 💪🏾 💅🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Wir möchten die Geschichte teilen, die bei einem unserer Projekte für das neue Jahr passiert ist. Das Wesentliche des Projekts ist, dass es die Arbeit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Weihnachtsgeschichte</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/432998/">  Wir möchten die Geschichte teilen, die bei einem unserer Projekte für das neue Jahr passiert ist.  Das Wesentliche des Projekts ist, dass es die Arbeit von Ärzten in medizinischen Einrichtungen automatisiert.  Während des Besuchs des Patienten schreibt der Arzt Informationen in den Rekorder, dann wird das Audio transkribiert.  Nach dem Transkriptionsprozess - d.h.  Umwandlung der Audioaufzeichnung in Text - Ein medizinisches Dokument wird gemäß den einschlägigen Standards erstellt und an die Klinik zurückgesandt, von der die Audioaufzeichnung stammt, wo der sendende Arzt sie empfängt, prüft und genehmigt.  Nach bestandener Pflichtprüfung wird das Dokument an die endgültigen Patienten gesendet. <br><a name="habracut"></a><br>  Alle medizinischen Einrichtungen, die das Produkt verwenden, können bedingt in zwei große Gruppen unterteilt werden: <br><br><ul><li>  Hosting im Rechenzentrum unseres Kunden, das für die Leistung der Anwendung sowohl für die Software als auch für die Hardware voll verantwortlich ist.  Zum Beispiel, wenn der Speicherplatz knapp wird oder die Serverleistung auf der CPU nicht ausreicht. </li><li>  Selbst gehostet: Sie platzieren alle Geräte direkt zu Hause und sind selbst für deren Leistung verantwortlich.  Unser Kunde stellt ihnen die Anwendung und deren Unterstützung zur Verfügung. </li></ul><br>  Auf diese Weise interagiert unser Team mit Endservern, die direkt in der Cloud unseres Kunden gehostet werden. <br><br><img src="https://habrastorage.org/webt/fu/dh/qb/fudhqbrny8p_r3wcs4swokhglqw.png"><br><br>  Wir haben Zugriff auf diese Server, um alle geplanten Arbeiten und Wartungen durchzuführen, die erforderlich sind. <br><br>  Die zweite Gruppe - selbst gehostete Clients - für sie fungiert die Client-Cloud als Gateway, über das wir eine Verbindung zu diesen Servern herstellen.  In diesem Fall haben wir eingeschränkte Rechte. Oft können wir aufgrund von Sicherheitseinstellungen keine Vorgänge ausführen.  Wir stellen eine Verbindung zu den Servern über RDP her, das Remotedesktopprotokoll unter Windows.  Das alles funktioniert natürlich über ein VPN. <br><br>  Es ist zu beachten, dass jeder im Diagramm dargestellte Server tatsächlich eine Kombination aus einem Anwendungsserver und einem Datenbankserver ist.  Auf dem Datenbankserver sind jeweils das MS SQL Server-DBMS und der SSRS-Berichtsdienst installiert.  Darüber hinaus ist die Version von MSSQL Server in allen Kliniken unterschiedlich: 2008, 2012, 2014. Zusätzlich zu den Versionen selbst werden überall verschiedene Service Packs und Patches installiert.  Im Allgemeinen ein kompletter Zoo. <br><br>  Auf dem Anwendungsserver haben wir den IIS- und ElasticSearch-Webserver installiert.  ElasticSearch ist eine Suchmaschine, die auch die Volltextsuche implementiert. <br>  Das Wesentliche an unserem Produkt ist „Job“.  Arbeit ist eine abstrakte Einheit, die alle Informationen miteinander verknüpft, die sich auf die Aufnahme eines bestimmten Patienten beziehen.  Diese Informationen umfassen: <br><br><ul><li>  Daten über den Arzt; </li><li>  Patientendaten; </li><li>  Daten über den Besuch; </li><li>  Audiodatei (Rede des Arztes); </li><li>  Dokumente (mehrere Versionen); </li><li>  Arbeitsverarbeitungsgeschichte; </li><li>  Brancheninformationen usw. </li></ul><br>  Dieses Diagramm zeigt ein vereinfachtes Datenbankschema, anhand dessen Sie die Beziehungen zwischen den Haupttabellen sehen können.  Dies ist nur der grundlegende Teil, tatsächlich hat die Datenbank mehr als 200 Tabellen. <br><br><img src="https://habrastorage.org/webt/sc/ke/hl/sckehlss-czi3bz2kagmfecrroy.png"><br><br>  Ein wenig über die Klinik, in der sich der Vorfall ereignete: <br><br><ul><li>  1500-2000 Arbeiten pro Tag; </li><li>  1000+ aktive Benutzer (Ärzte + Sekretäre); </li><li>  Selbst gehostet. </li></ul><br>  DB: <br><br><ul><li>  Größe: 800+ Gb (750K + Werke, 2M + Dokumente); </li><li>  DBMS: MS SQL Server 2008 R2; </li><li>  Wiederherstellungsmodell: Einfach. </li></ul><br>  Hier möchte ich eine kleine Erklärung geben.  In SQL Server gibt es drei Wiederherstellungsmodelle: einfach, massenprotokolliert und vollständig.  Ich werde jetzt nicht über den dritten sprechen, ich werde den ersten und zweiten erklären.  Der Hauptunterschied besteht darin, dass im einfachen Modell der Transaktionsverlauf nicht im Protokoll gespeichert wird. Sobald die Transaktion festgeschrieben wurde, wird der Datensatz aus dem Transaktionsprotokoll gelöscht.  Bei Verwendung des vollständigen Wiederherstellungsmodus wird der gesamte Verlauf der Datenänderungen in einem Transaktionsprotokoll gespeichert.  Was gibt uns das?  In einem unvorhergesehenen Fall können wir, wenn wir die Datenbank von Sicherungen zurücksetzen müssen, nicht nur zu einer bestimmten Sicherung zurückkehren, sondern zu jedem Zeitpunkt bis zu einer bestimmten Transaktion, d. H. Wir haben sie gespeichert Bei Sicherungen gibt es nicht nur einen bestimmten Status der Datenbank zum Zeitpunkt der Sicherung, sondern auch eine ganze Historie von Datenänderungen. <br><br>  Ich denke, es lohnt sich nicht zu erklären, dass der einfache Modus nur in der Entwicklung, auf Testservern und in der Produktion verwendet wird.  Auf keinen Fall. <br><br>  Aber die Klinik hatte offenbar ihre eigenen Gedanken zu diesem Thema;) <br><br><h3>  Starten Sie </h3><br>  Ein paar Tage später, dem neuen Jahr, bereiten sich alle auf den Urlaub vor, kaufen Geschenke, schmücken Weihnachtsbäume, verbringen Firmenfeiern und warten auf ein langes Wochenende. <br><br><h6>  22. Dezember (Freitag) 1 Tag </h6><br>  <strong>14:31</strong> Der Kunde sagte, dass er den nächsten Tagesbericht nicht erhalten habe.  Der Bericht kommt zweimal täglich nach einem Zeitplan per E-Mail an. Er muss das Senden von Daten an ein externes Integrationssystem steuern, was nicht allzu kritisch ist. <br><br>  Es kann mehrere Gründe geben: <br><br><ol><li>  Probleme mit SMTP, Briefe wurden einfach nicht zugestellt (sie haben beispielsweise das Passwort geändert und niemandem davon erzählt); </li><li>  Probleme auf der Serverseite der Berichte; </li><li>  Es ist etwas mit der Datenbank passiert. </li></ol><br>  <strong>16:03 Die</strong> Klinik ändert manchmal das Passwort in SMTP, ohne dass jemand darüber gewarnt wird. Nachdem wir die aktuellen Aufgaben erledigt haben, überprüfen wir den Bericht ruhig manuell, indem wir ihn über die Weboberfläche starten. Es wird ein Fehler angezeigt, der auf Probleme in der Datenbank hinweist. <br><br>  Ein Beispiel für den Fehler, den wir beim Starten des Berichts erhalten haben. <br><br><pre><code class="plaintext hljs">SQL Server detected a logical consistency-based I/O error: incorrect checksum (expected: 0x9876641f; actual: 0xa3255fbf). It occurred during a read of page (1:876) in database ID 7 at offset 0x000000006d8000 in file 'D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\ServerLive.mdf'.</code> </pre> <br>  Dies zeigt an, dass die Datenbank Seiten beschädigt hat.  Wir hatten ein leichtes Gefühl der Angst. <br><br>  <strong>20:53</strong> Um das Ausmaß des Schadens zu beurteilen, führen wir eine Datenbankprüfung mit dem speziellen Befehl <strong><em>DBCC CHECKDB durch</em></strong> .  Abhängig von der Größe des Schadens kann der Testbefehl eine Weile dauern, daher führen wir den Befehl nachts aus.  Hier haben wir Glück, dass dies am Freitagnachmittag passiert ist, das heißt, wir hatten zumindest alle freien Tage, um dieses Problem zu lösen. <br><br>  In diesem Moment war die Situation wie folgt: <br><br><img src="https://habrastorage.org/webt/dp/nq/jm/dpnqjm7rvkmtjtxoc534js439zq.png"><br><br><h6>  23. Dezember (Samstag) 2. Tag </h6><br>  <strong>10:02</strong> Uhr morgens stellen wir fest, dass das Überprüfen der Datenbank mit CHECKDB eine Diskette ist - dies lag an einem Mangel an freiem Speicherplatz, weil  Während des Überprüfungsprozesses wird die temporäre Tempdb-Datenbank aktiv verwendet, und irgendwann ist der freie Speicherplatz einfach aufgebraucht. <br><br>  Daher entscheiden wir uns, anstatt die gesamte Datenbank zu überprüfen, sofort einen Tabellenscan zu starten.  Verwenden <strong><em>Sie dazu den Befehl DBCC CHECKTABLE</em></strong> . <br><br>  <strong>10:46</strong> Wir beschließen, mit der JobHistory-Tabelle zu beginnen, die wahrscheinlich beschädigt ist, da sie zum Generieren des Berichts verwendet wurde.  Diese Tabelle bewahrt, wie der Name schon sagt, die Geschichte aller Werke, d. H. Übergänge der Arbeit zwischen Stufen. <br><br>  Führen Sie <strong><em>DBCC CHECKTABLE ('dbo.JobHistory') aus</em></strong> . <br><br>  Durch Überprüfen dieser Tabelle werden beschädigte Tabellen in der Datenbank angezeigt, was im Prinzip erwartet wurde. <br><br>  <strong>12:00</strong> Im Moment, wenn die Datenbank das vollständige Wiederherstellungsmodell verwendet, könnten wir die beschädigten Seiten aus der Sicherung wiederherstellen, und das wäre alles vorbei, aber unsere Datenbank befand sich im einfachen Modus.  Daher bleibt die einzige Möglichkeit, Schäden zu reparieren, der Start desselben Befehls mit dem speziellen Parameter <strong><em>REPAIR_ALLOW_DATA_LOSS</em></strong> .  Dies kann zu Datenverlust führen. <br><br>  Wir fangen an.  Die Überprüfung endet erneut mit einem Fehler. Wir erhalten die Fehlermeldung, dass die Wiederherstellung dieser Tabelle erst möglich ist, wenn die zugehörigen Tabellen wiederhergestellt sind.  Die Verlaufstabelle bezieht sich auf die Arbeitstabelle (Jobs) des Fremdschlüssels. Daher schließen wir, dass auch die Hauptarbeitstabelle (Jobs) beschädigt ist. <br><br>  <strong>13:30</strong> Der nächste Schritt besteht darin, gleichzeitig die Jobs-Tabelle zu überprüfen. Wir hoffen, dass der Schaden im Index und nicht in den Daten enthalten ist.  In diesem Fall reicht es aus, den Index für die Datenwiederherstellung einfach neu zu erstellen. <br><br>  <strong>17:33</strong> Nach einer Weile stellen wir fest, dass unser Server über RDP nicht verfügbar ist.  Es wurde wahrscheinlich ausgeschaltet, die Überprüfung wurde nicht abgeschlossen, die Arbeit wurde ausgesetzt.  Wir informieren die Klinik, dass der Server nicht verfügbar ist. Bitte erhöhen Sie ihn. <br><br>  Leichte Angst nimmt sehr spezifische Formen an. <br><br><h6>  24. Dezember (Sonntag) 3. Tag </h6><br>  <strong>14:31</strong> Näher am Abendessen wird der Server angehoben, und wir führen die Überprüfung der Jobs-Tabelle erneut durch. <br>  <strong><em>DBCC CHECKTABLE ('dbo.Jobs')</em></strong> <br><br>  <strong>16:05 Die</strong> Überprüfung ist nicht abgeschlossen, der Server ist nicht verfügbar.  Wieder. <br><br>  Nach einiger Zeit ist der Server wieder nicht verfügbar, bevor wir die Überprüfung der Tabelle abgeschlossen haben.  Zu diesem Zeitpunkt führt der IT-Service der Klinik eine Reihe von Serverprüfungen durch.  Wir warten auf den Abschluss der Arbeiten. <br><br>  Aufgrund der Feiertage war die Kommunikation zwischen uns und dem Kunden langsam - wir erwarteten mehrere Stunden lang Antworten auf Fragen. <br><br><h6>  25. Dezember (Montag - Weihnachten) 4. Tag </h6><br>  <strong>16:00</strong> Am nächsten Tag, an dem der Server hochgefahren wurde, hat der Client Weihnachten und wir beginnen erneut mit der Überprüfung der Tabelle. Diesmal schließen wir jedoch Indizes vom Scan aus und lassen nur die Datenprüfung.  Und nach einiger Zeit ist der Server wieder nicht verfügbar. <br><br>  Was ist los? <br><br>  In diesem Moment schleichen sich Gedanken ein, dass dies nicht nur ein Zufall ist, und es besteht der Verdacht, dass es sich um eine Beschädigung auf Eisenebene handeln könnte (eine Festplatte ist gefallen).  Wir gehen davon aus, dass sich fehlerhafte Sektoren auf der Festplatte befinden. Wenn der Scan versucht, Daten aus diesen Sektoren zu lesen, stürzt das System ab.  Wir informieren unseren Kunden über unsere Annahme. <br><br>  Der Client führt eine Festplattenprüfung auf dem Hostcomputer durch. <br><br>  <strong>17:19 Der</strong> IT-Service der Klinik hat gemeldet, dass die Datei der virtuellen Maschine beschädigt ist - das ist schlecht! ( <br>  Wir können noch nicht arbeiten und warten auf ein Signal, wenn sie das Problem beheben, und wir können unsere Arbeit fortsetzen. <br><br><h6>  26. Dezember (Dienstag) Tag 5 </h6><br>  <strong>14:05 Der</strong> IT-Klinikdienst startet einen weiteren Prozess zur Wiederherstellung von Datenträgern.  Uns wurde gesagt, dass wir CHECKTABLE parallel ausführen können, um die Tabelle zu überprüfen.  Wir starten den Test erneut - die virtuelle Maschine stürzt erneut ab, wir informieren den Client, dass die Datei der virtuellen Maschine immer noch beschädigt ist. <br><br>  Heutzutage ist die gesamte Kommunikation mit dem Kunden sehr langsam, mit einer enormen Zeitverzögerung aufgrund der Feiertage. <br><br><h6>  27. Dezember (Mittwoch) Tag 6 </h6><br>  <strong>14:00</strong> Wir starten die Festplattenprüfung unter Windows - <strong>checkdisk</strong> in der virtuellen Maschine - es wurden keine Probleme festgestellt. <br>  Die Datenbank befindet sich im einfachen Modus, sodass die Wahrscheinlichkeit, die aktuelle Datenbank mit den DBMS-Tools zu reparieren, auf Null sinkt, da  Wir können einzelne beschädigte Seiten nicht wiederherstellen. <br>  Wir fangen an, die Option eines Rollbacks und der Wiederherstellung der Datenbank aus der Sicherung in Betracht zu ziehen. <br>  Wir überprüfen die Datenbanksicherungen und stellen fest, dass die Sicherungen nicht mit den DBMS-Mitteln erstellt wurden. Die letzte Sicherung erfolgte im Jahr 2014, d. H.  Es gibt keine Sicherungen der Datenbank.  Warum sie dies nicht getan haben, ist ein separates Problem. Es liegt in der Verantwortung der Klinik, die Effizienz und Sicherheit der Datenbank sicherzustellen. <br><br>  Es besteht eine hohe Wahrscheinlichkeit, dass die Wiederherstellung der aktuellen Datenbank nicht funktioniert. Wir beginnen, andere Optionen für das Rollback in Betracht zu ziehen. <br><br>  Lassen Sie uns die Situation mit Backups in der Klinik genauer untersuchen. <br><br>  Die Situation mit Backups: <br><br><ul><li>  Es gibt keine Datenbanksicherungen (!!!) </li><li>  Es gibt keine Schnappschüsse der virtuellen Maschine (!?) </li><li>  Es gibt jedoch Festplattensicherungen (full + inc) </li></ul><br>  Die Datenbank befindet sich auf Datenträger D. Sie haben wöchentliche vollständige Sicherungen und tägliche inkrementelle Sicherungen durchgeführt. <br><br><ul><li>  jeden Freitag um 20:00 Uhr vollständige Sicherung </li><li>  jeden Tag inkrementelle Sicherung </li><li>  Es gibt eine vollständige Sicherung vom 15. und 22 .. </li><li>  Es gibt tägliche Backups bis zum 21 .. </li></ul><br>  Das heißt,  Im Prinzip können wir auf den Zustand zurücksetzen, bevor das Problem auftritt. <br>  Wir warten auf ein Update von der Klinik, um das Rollback der Datenbank aus dem Backup zu starten. <br><br>  Gleichzeitig schickte die Klinik eine Anfrage an den Eisenlieferanten (HP), die als „dringend“ gekennzeichnet war. <br><br><h6>  28. Dezember (Donnerstag) Tag 7 </h6><br>  <strong>13:13 Der</strong> IT-Service der Klinik beginnt mit der Einrichtung einer neuen virtuellen Maschine  Es ist nicht möglich, den Schaden in der Datei der alten virtuellen Maschine zu beheben. <br><br>  <strong>19:09</strong> Eine neue virtuelle <strong>Maschine ist</strong> mit installiertem SQL Server verfügbar. <br>  Der nächste Schritt besteht darin, die Datenbank aus der Festplattensicherung wiederherzustellen.  Zunächst beschließen wir, zum 22. Tag zurückzukehren, wenn das Problem weiterhin besteht, und dann zum 21., 20. usw. zurückzukehren, bis wir zu einem funktionierenden Zustand gelangen. <br><br>  Es war der 28. Tag auf dem Hof, wir waren auf der Firmenfeier und hier erfahren sie, dass die Klinik Probleme mit der Wiederherstellung von Backups hat, weil BACKUPs LEER sind! <br><br>  Hier sind die Neuigkeiten! <br><br>  Wenn Sie eine Sicherung von Laufwerk D ab dem 21. wiederherstellen, stellt sich heraus, dass es wie alle anderen leer ist.  Es werden direkte Shredder-Backups erhalten - sie scheinen vorhanden zu sein, sind es aber gleichzeitig nicht.  Es ist nicht ganz klar, wie dies überhaupt passiert ist, aber soweit wir verstehen konnten, ist der Punkt nicht genügend Speicherplatz zum Speichern von Festplattensicherungen.  Sie haben 500 GB Backups für die Speicherung zugewiesen, aber zum Zeitpunkt des Vorfalls wog die Datenbank bereits 800 GB, sodass die Sicherung im Prinzip nicht erfolgreich sein konnte.  Das heißt,  Backups wurden regelmäßig gemäß dem Zeitplan erstellt, aber aufgrund von Platzmangel endeten sie mit einem Fehler und waren dementsprechend leer, und der IT-Service der Klinik hatte nicht einmal die Idee, zu überprüfen, ob alles in Ordnung mit ihnen war.  Nicht so. <br><br><h6>  29. Dezember (Freitag) Tag 8 </h6><br>  <strong>13:11</strong> Diskussion weiterer Aktionen.  Mögliche Optionen: <br><br><ul><li>  Beim Versuch, Datenbankdateien (.ldf + .two-Dateien) zu kopieren, sind die Erfolgschancen sehr gering. </li><li>  Der Versuch, die Datenbank zu sichern, ist wiederum sehr unwahrscheinlich. </li><li>  Replikation konfigurieren - funktioniert möglicherweise. </li></ul><br>  Auf dem neuen Server wurde ein 1-TB-Laufwerk zugewiesen, was offensichtlich nicht ausreicht, wenn wir versuchen, von diesem Server aus zu sichern und wiederherzustellen  Im schlimmsten Fall nehmen Sicherungen ohne Komprimierung so viel Speicherplatz ein wie die ursprüngliche Datenbank, d. h.  800 GB. <br>  Bitte fügen Sie Orte auf dem neuen Server hinzu und fahren Sie mit dem Kopieren der Datenbankdateien fort. <br>  Auf dem neuen Server wurde eine Datenbank erstellt und das Datenbankschema wiederhergestellt - dies ermöglicht zumindest die Verarbeitung neuer Arbeiten.  Die Klinik wird zumindest in der Lage sein, neue Patienten mit einem solchen System aufzunehmen. <br><br>  <strong>14:36</strong> Daher fahren wir mit Option Nummer eins fort, obwohl wir nicht viel Erfolg erwarten. <br>  Stoppen Sie SQL Server, kopieren Sie die Datendatei (mdf) und das Protokoll (ldf). <br><br>  <strong>16:13</strong> Nach der Hälfte der Protokolldatei wurde sie erfolgreich kopiert (48 GB), und 50 GB der Datendatei wurden bereits kopiert (795 von 846 GB übrig).  Bei dieser Geschwindigkeit dauert es ungefähr 12 Stunden, bis die Kopie fertig ist. <br><br>  <strong>16:30 Der</strong> alte Datenbankserver wurde beim Kopieren der Datei ausgeschaltet, was durchaus zu erwarten ist. <br><br>  <strong>17:09</strong> Daher fahren wir mit der nächsten Option fort - dem Einrichten der Replikation, während wir angeben können, welche Daten repliziert werden sollen. Das heißt, wir können zuerst absichtlich beschädigte Tabellen ausschließen und zuerst die unbeschädigten Daten kopieren und dann die problematischen Tabellen in Teilen übertragen.  Leider funktioniert diese Option auch nicht, da wir aufgrund von Datenbankbeschädigungen nicht einmal eine Publikation mit bestimmten Tabellen erstellen können. <br>  Wir erwägen auch Datenübertragungsoptionen. <br><br>  <strong>20:01</strong> Infolgedessen beginnen wir einfach, Daten vom alten auf den neuen Server zu übertragen, indem wir sie in Prioritätsreihenfolge importieren und exportieren. <br><br>  <strong>21:35</strong> Zuerst die kritischsten Daten, dann archiviert und weniger kritisch (~ 300 GB).  In der ersten Exportwelle blieben weniger als 300 GB Daten übrig.  Die Dokumententabelle (300 GB) ist ebenfalls ausgeschlossen.  Wir beginnen nachts mit dem Kopieren. <br><br><h6>  30. Dezember (Samstag) Tag 9 </h6><br>  <strong>15:00 Wir übertragen</strong> weiterhin Daten.  Die Jobs-Tabelle ist überhaupt nicht verfügbar.  Die meisten Tabellen wurden zu diesem Zeitpunkt kopiert. <br>  Aber ohne <strong>Jobs</strong> ist alles nutzlos, da es die Hauptverbindung zwischen allen Daten darstellt und ihnen aus geschäftlicher Sicht Bedeutung und Wert verleiht.  Ohne sie haben wir nur einen unterschiedlichen Datensatz, den wir einfach nicht verwenden können. <br><br>  Zu diesem Zeitpunkt ist auch die Wiederherstellung des Datenbankschemas abgeschlossen. <br><br>  <strong>Die Folgen des Vorfalls:</strong> <br><br>  Zu diesem Zeitpunkt haben wir einen großen Verlust an Live-Daten. <br>  Das heißt,  Formal haben wir einige Daten in der Datenbank, aber tatsächlich gibt es keine Möglichkeit, sie zu verwenden oder zu verbinden, sodass wir über den vollständigen Datenverlust sprechen können. <br>  Datenverlust bei mehr als 750.000 Patientenaufnahmen. <br><br>  Das ist wirklich traurig! <br><br><ul><li>  Dies ist ein schwerer Schlag für den Ruf unserer Kunden, der sich als große Probleme für sie im Geschäftsleben herausstellen kann, wenn sie neue Verträge abschließen und neue Kunden finden. </li><li>  Der Verlust so vieler Daten für die Klinik kann zu ernsthaften Problemen und Geldstrafen führen, weil  Dies sind vertrauliche Daten, die medizinische Vertraulichkeit enthalten und im wahrsten Sinne des Wortes vom Leben der Menschen abhängen. </li></ul><br>  Wir begannen zu überlegen, was wir in dieser Situation tun können.  Sie begannen, das System nach Knochen zu sortieren, um Hinweise zu finden. <br><br>  <strong>15:16</strong> Wenn wir alle Aspekte des Systems analysieren, verstehen wir, dass wir versuchen können, die fehlenden Daten aus dem ElasticSearch-Index zu extrahieren.  Die Sache ist, dass aufgrund der falschen Konfiguration der ElasticSearch-Indizes nicht nur die Felder gespeichert werden, in denen die Volltextsuche durchgeführt wird, sondern im Allgemeinen alles, dh tatsächlich eine vollständige Kopie der Daten, und wir können theoretisch Daten daraus extrahieren über Werke und legen Sie sie zurück in unsere Datenbank.  Es ist zu hoffen, dass die Daten weiterhin wiederhergestellt werden können. <br><br>  Ein Fehler, dem Sie ein Denkmal setzen können! <br><br><img src="https://habrastorage.org/webt/oy/62/nt/oy62ntr-iiercftfvwmd_gzoide.png"><br><br>  <strong>18:00</strong> Ein Dienstprogramm wurde schnell geschrieben, um die Daten zu extrahieren. Nach einigen Stunden stellen wir sicher, dass der Ansatz funktioniert und die Daten wiederhergestellt werden können. <br><br>  <strong>20:00 Die</strong> Wiederherstellung der Arbeit von ElasticSearch mit Hilfe eines schriftlichen Dienstprogramms hat begonnen.  Der Ansatz hat funktioniert, wir können die Daten auf der Arbeit wiederherstellen.  Parallel dazu extrahieren wir für jede Arbeit die neuesten Versionen des Dokuments. <br><br><h6>  31. Dezember (Sonntag - Neujahr) Tag 10 </h6><br>  <strong>14:09</strong> In der Nacht wurden 188 811 Werke restauriert. <br><br>  <strong>20:13</strong> Angesichts unseres Erfolgs beschließt die Klinik, die Übertragung des Servers an den HP Service zu verschieben, um uns Zeit zu geben, die maximalen Daten vom alten Server zu extrahieren. <br>  Mit solchen Neuigkeiten haben wir das neue Jahr gefeiert)) <br><br><h6>  01. Januar (Montag) 11. Tag </h6><br>  <strong>11:23</strong> Vorbereitung zum Starten des Systems nach dem Vorfall: <br><br><ul><li>  IIS auf dem App-Server neu konfiguriert; </li><li>  alle erforderlichen Dienste für die Arbeit mit dem neuen Datenbankserver neu konfiguriert; </li><li>  Trigger, gespeicherte Prozeduren, wiederhergestellte Funktionen. </li></ul><br>  <strong>14:28</strong> Dann begannen sie, die Tabelle der Dokumente zu kopieren, die aufgrund der Größe bei der ersten Übertragung übersprungen wurde. <br>  - Der alte DB-Server wird wieder heruntergefahren.  Offensichtlich ist auch die Tabelle "Dokumente" beschädigt. Damit werden alle Patienteninformationen gespeichert.  Glücklicherweise ist es nicht vollständig beschädigt, wir können Anfragen an es stellen, und wenn eine Anfrage an uns einen beschädigten Datensatz zurückgibt, stürzt der Server in diesem Moment ab und fährt herunter.  Wir können einige der Daten extrahieren. <br><br>  Dementsprechend signalisieren wir dem Client, dass er den Server anhebt, und bereiten gleichzeitig die neue Datenbank für den Start des Systems vor. <br><br>  <strong>18:01</strong> Wiederherstellung aller Integritätsbeschränkungen nach der Übertragung des Hauptteils der Daten. <br><br>  <strong>22:02</strong> Wiederherstellung der Einschränkungen abgeschlossen.  Wir haben einfach die Rohdaten maximal übertragen.  Das Vorhandensein von Integritätsbeschränkungen würde unsere Aufgabe erheblich erschweren. <br><br><h6>  02. Januar (Dienstag) Tag 12 </h6><br>  <strong>05:52 Der</strong> alte DB-Server wurde beim Kopieren des Dokuments wieder ausgeschaltet.  Er wird umgehend erzogen, damit wir weiterarbeiten können. <br><br>  <strong>09:00</strong> Es konnten ca. 200.000 Dokumente stapelweise wiederhergestellt werden (ca. 20%). <br>  Wir haben verschiedene Wiederherstellungsmethoden verwendet: Sortieren nach verschiedenen Spalten, um Daten vom Ende oder Anfang der Tabelle zu erhalten, bis wir auf einen beschädigten Teil der Tabelle stoßen. <br><br>  <strong>13:42</strong> Beginn des Kopierens von Archivierungsarbeiten in der Tabelle - zum Glück ist es nicht beschädigt. <br><br>  <strong>17:08</strong> Alle Archivarbeiten wurden wiederhergestellt (491 380 Stück). <br><br>  Das System ist startbereit: Benutzer können neue Arbeiten erstellen und verarbeiten. <br><br>  Leider können Sie aufgrund einer teilweisen Beschädigung der Dokumententabelle nicht einfach alle Daten von ihr übertragen, wie bei anderen Tabellen, weil  Der Tisch ist teilweise beschädigt.  Wenn Sie versuchen, alle Daten abzurufen, stürzt die Anforderung daher ab, wenn Sie versuchen, beschädigte Seiten zu lesen.  Daher extrahieren wir die Daten punktweise mit verschiedenen Sortierungen und Stichprobengrößen: <br><br><ul><li>  Sortieren nach verschiedenen Feldern (ID, DateTime); </li><li>  Sortieren Sie aufsteigend, absteigend; </li><li>  Arbeiten Sie mit kleinen Gruppen von Linien (1000, 100); </li><li>  Jobs nach ID abrufen. </li></ul><br><br><h6>  03. Januar (Mittwoch) Tag 13 </h6><br>  <strong>08:58</strong> Fortsetzung des Prozesses zum Wiederherstellen von Dokumenten.  Dokumente wurden nur für aktive, unvollständige Arbeiten wiederhergestellt.  Zu diesem Zeitpunkt arbeiten 1000 (aktiv) ohne Dokumente. <br><br>  <strong>11:38</strong> Alle SQL-Jobs wurden migriert <br><br>  <strong>13:17</strong> 5 funktioniert ohne Dokumente, 231 keine Arbeit, aber es gibt eine Audiodatei, die Sie neu synchronisieren müssen. <br><br><h6>  04. Januar (Donnerstag) Tag 14 </h6><br>  Die manuelle Wiederherstellung und Überprüfung der verbleibenden Arbeiten hat begonnen. <br>  Das System arbeitet und überwacht und behebt Fehler online. <br><br><h6>  05. Januar (Freitag) Tag 15 </h6><br>  Bericht Migration zu SSRS geplant. <br>  Eine Übertragung auf einen neuen Server ist nicht möglich, da  Die Klinik hat eine ältere Version von SQL Server installiert und es funktioniert nicht, die Datenbank vom alten Server zu übertragen. <br><br>  Optionen: <br><br><ul><li>  Aktualisieren Sie SQL Server von 2008 auf 2008 R2. </li><li>  Konfigurieren Sie alles von Grund auf neu. </li></ul><br>  Es wurde beschlossen, auf das SQL Server-Update zu warten. <br><br>  <strong>09:21</strong> Hintergrund Die Wiederherstellung von Dokumenten für abgeschlossene Arbeiten hat begonnen - der Prozess ist lang und wird mehrere Tage dauern. <br><br>  <strong>13:28</strong> Änderung der Priorität der Wiederherstellung von Dokumenten durch Abteilungen. <br><br>  <strong>18:18 Die</strong> Klinik gewährte Zugriff auf SMTP, Mail-Setup <br><br><h3>  Ergebnis: </h3><br><ul><li>  Fast alle Daten wurden wiederhergestellt (nur 5 Jobs gingen verloren); </li><li>  Es wurden Empfehlungen zur Datenbankwartung herausgegeben, um solche Situationen zu verhindern. </li><li>  Datenbanksicherungen werden mit SQL Server konfiguriert. </li><li>  Zusätzliche Überwachung von Backups unsererseits, Warnungen im Fehlerfall. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de432998/">https://habr.com/ru/post/de432998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de432988/index.html">Achter Webmaster. Lebe auf Habré</a></li>
<li><a href="../de432990/index.html">Edison Sprachaktivierte Holzlampe. Ausgabepreis 5 USD</a></li>
<li><a href="../de432992/index.html">Er setzte seine Kopfhörer auf und starb: Wir haben es mit dem seltsamen Tod eines Schülers in Rimbau zu tun</a></li>
<li><a href="../de432994/index.html">Vivaldi 2.2 - Quantität in Qualität umwandeln</a></li>
<li><a href="../de432996/index.html">Ein paar Wörterbücher Interna in CPython (und PyPy)</a></li>
<li><a href="../de433000/index.html">Kotlin kompilieren: JetBrains VS ANTLR VS JavaCC</a></li>
<li><a href="../de433002/index.html">Komm selbst ... oder die Kommunikationsregeln in einem Team</a></li>
<li><a href="../de433004/index.html">Eine robuste Cloud-Migrationsstrategie für 2019: 7 Tipps</a></li>
<li><a href="../de433008/index.html">USB-Geräte sind eine "plötzliche" Bedrohung</a></li>
<li><a href="../de433010/index.html">Haben Sie eine Idee: Berechtigungssystem für npm-Pakete</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>