<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🗻 🗿 😶 Details zum Cloudflare-Absturz 2. Juli 2019 🛋️ 👨🏽‍⚕️ 😲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor fast 9 Jahren war Cloudflare ein winziges Unternehmen, aber ich habe nicht darin gearbeitet, ich war nur ein Kunde. Einen Monat nach dem Start von...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Details zum Cloudflare-Absturz 2. Juli 2019</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/460863/"><p><img src="https://habrastorage.org/webt/dx/yb/5r/dxyb5rids6_8tahyhactypl4rwm.png"></p><br><p>  Vor fast 9 Jahren war Cloudflare ein winziges Unternehmen, aber ich habe nicht darin gearbeitet, ich war nur ein Kunde.  Einen Monat nach dem Start von Cloudflare erhielt ich eine Benachrichtigung, dass DNS auf meiner jgc.org- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Website</a> anscheinend nicht funktioniert.  Cloudflare hat eine Änderung an den <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Protokollpuffern vorgenommen</a> , und es gab einen defekten DNS. </p><a name="habracut"></a><br><p>  Ich schrieb sofort an Matthew Prince mit der Überschrift „Wo ist mein DNS?“ Und er schickte eine lange Antwort voller technischer Details ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">lesen Sie die gesamte Korrespondenz hier</a> ), auf die ich antwortete: </p><br><blockquote>  Von: John Graham Cumming <br>  Datum: 7. Oktober 2010, 9:14 Uhr <br>  Betreff: Re: Wo ist mein DNS? <br>  An: Matthew Prince <br><br>  Cooler Bericht, danke.  Ich werde auf jeden Fall anrufen, wenn es Probleme gibt.  Es lohnt sich wahrscheinlich, einen Beitrag darüber zu schreiben, wenn Sie alle technischen Informationen gesammelt haben.  Ich denke, die Leute werden eine offene und ehrliche Geschichte mögen.  Vor allem, wenn Sie Grafiken anhängen, um zu zeigen, wie der Datenverkehr nach dem Start gewachsen ist. <br><br>  Ich habe eine gute Überwachung auf der Website und erhalte eine SMS über jeden Fehler.  Die Überwachung zeigt, dass der Fehler von 13:03:07 bis 14:04:12 war.  Tests werden alle fünf Minuten durchgeführt. <br><br>  Ich bin sicher, Sie werden es herausfinden.  Sie brauchen definitiv keine eigene Person in Europa?  :-) </blockquote><p>  Und er antwortete: </p><br><blockquote>  Von: Matthew Prince <br>  Datum: 7. Oktober 2010, 9:57 Uhr <br>  Betreff: Re: Wo ist mein DNS? <br>  An: John Graham Cumming <br><br>  Vielen Dank.  Wir haben allen geantwortet, die geschrieben haben.  Ich gehe jetzt ins Büro und wir werden etwas auf dem Blog schreiben oder einen offiziellen Beitrag in unserem Bulletin Board veröffentlichen.  Ich stimme vollkommen zu, Ehrlichkeit ist unser Alles. </blockquote><p>  Jetzt ist Cloudflare ein wirklich großes Unternehmen, ich arbeite darin und jetzt muss ich offen über unseren Fehler, seine Folgen und unser Handeln schreiben. </p><br><h3 id="sobytiya-2-iyulya">  2. Juli Veranstaltungen </h3><br><p>  Am 2. Juli haben wir eine neue Regel in verwalteten Regeln für WAF bereitgestellt, aufgrund derer die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Prozessorressourcen</a> auf jedem Prozessorkern, der HTTP / HTTPS-Verkehr im Cloudflare-Netzwerk auf der ganzen Welt verarbeitet, aufgebraucht sind.  Wir verbessern ständig die verwalteten Regeln für WAF als Reaktion auf neue Schwachstellen und Bedrohungen.  Im Mai haben wir beispielsweise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eine Regel hinzugefügt</a> , um uns vor einer schwerwiegenden Sicherheitsanfälligkeit in SharePoint zu schützen.  Der springende Punkt unserer WAF ist die Fähigkeit, Regeln schnell und global bereitzustellen. </p><br><p>  Leider enthielt das Update vom letzten Donnerstag einen regulären Ausdruck, der für das Zurückverfolgen zu vieler Prozessorressourcen aufgewendet wurde, die für HTTP / HTTPS zugewiesen wurden.  Dies betraf unsere Kernfunktionen für Proxy, CDN und WAF.  Die Grafik zeigt, dass die Prozessorressourcen für die Bereitstellung von HTTP / HTTPS-Verkehr auf Servern in unserem Netzwerk fast 100% erreichen. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/au/xp/dz/auxpdz0pbethhc_hka-nvzmmsmo.png"></a> <br>  <em>Verwenden von Prozessorressourcen an einem der Anwesenheitspunkte während eines Vorfalls</em> </p><br><p>  Infolgedessen stießen unsere Kunden (und die Kunden unserer Kunden) auf eine Seite mit einem 502-Fehler in den Cloudflare-Domänen.  502 Fehler wurden von Cloudflare-Front-End-Webservern generiert, die noch freie Kernel hatten, aber nicht mit Prozessen kommunizieren konnten, die HTTP / HTTPS-Verkehr verarbeiten. </p><br><p><img src="https://habrastorage.org/webt/mn/36/v_/mn36v_x1bbtqofu8l9lzpjty-pm.png"></p><br><p>  Wir wissen, wie viele Unannehmlichkeiten dies unseren Kunden verursacht hat.  Wir schämen uns schrecklich.  Und dieses Versagen hat uns daran gehindert, den Vorfall effektiv zu behandeln. </p><br><p> Wenn Sie einer dieser Kunden waren, hat es Sie wahrscheinlich erschreckt, verärgert und verärgert.  Darüber hinaus haben wir seit 6 Jahren keine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">globalen Ausfälle mehr</a> .  Der hohe CPU-Verbrauch war auf eine WAF-Regel mit einem schlecht formulierten regulären Ausdruck zurückzuführen, die zu übermäßigem Backtracking führte.  Hier ist der schuldige Ausdruck: <code>(?:(?:\"|'|\]|\}|\\|\d|(?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\-|\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </p><br><p>  Obwohl es an sich interessant ist (und ich werde Ihnen weiter unten mehr darüber erzählen), wurde der Cloudflare-Dienst für 27 Minuten unterbrochen, nicht nur wegen unpassender regulärer Ausdrücke.  Wir haben eine Weile gebraucht, um die Abfolge der Ereignisse zu beschreiben, die zum Ausfall geführt haben, sodass wir nicht schnell reagiert haben.  Am Ende des Beitrags werde ich das Backtracking in regulären Ausdrücken beschreiben und Ihnen sagen, was Sie dagegen tun sollen. </p><br><h3 id="chto-sluchilos">  Was ist passiert </h3><br><p>  Beginnen wir in der richtigen Reihenfolge.  Alle Zeiten werden hier in UTC angezeigt. </p><br><p>  Um 13:42 Uhr nahm ein Techniker des Firewall-Teams eine kleine Änderung an den Regeln für die Erkennung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">XSS</a> mithilfe eines automatischen Prozesses vor.  Dementsprechend wurde ein Ticket für eine Änderungsanforderung erstellt.  Wir verwalten diese Tickets über Jira (Screenshot unten). </p><br><p>  Nach 3 Minuten wurde die erste PagerDuty-Seite angezeigt, auf der ein Problem mit WAF gemeldet wurde.  Es war ein synthetischer Test, der die Funktionalität von WAF (wir haben Hunderte davon) außerhalb von Cloudflare überprüft, um den normalen Betrieb zu überwachen.  Dann gab es sofort Seiten mit Benachrichtigungen über Fehler anderer End-to-End-Tests von Cloudflare-Diensten, globale Verkehrsprobleme, weit verbreitete 502-Fehler und eine Reihe von Berichten von unseren Points of Presence (PoP) in Städten auf der ganzen Welt, die auf einen Mangel an Prozessorressourcen hinwiesen. </p><br><p><img src="https://habrastorage.org/webt/fh/iw/ja/fhiwjas8c3-qfcwo-11nks3lld4.png"></p><br><p><img src="https://habrastorage.org/webt/fs/g7/xo/fsg7xokybw-svzn8tn-uyhuj7dm.jpeg"></p><br><p>  Ich erhielt mehrere solcher Benachrichtigungen, fiel von der Besprechung ab und ging bereits zum Tisch, als der Leiter unserer Abteilung für Lösungsentwicklung sagte, dass wir 80% des Datenverkehrs verloren haben.  Ich lief zu unseren SRE-Ingenieuren, die bereits an dem Problem arbeiteten.  Zuerst dachten wir, es sei eine Art unbekannter Angriff. </p><br><p><img src="https://habrastorage.org/webt/-r/ox/mw/-roxmwj33bvn_n-xyww8xhfwpmw.jpeg"></p><br><p>  Cloudflare SRE-Ingenieure sind auf der ganzen Welt verstreut und überwachen die Situation rund um die Uhr.  In der Regel werden Sie durch solche Warnungen über bestimmte lokale Probleme mit begrenztem Umfang informiert, in internen Dashboards überwacht und mehrmals täglich behoben.  Solche Seiten und Benachrichtigungen wiesen jedoch auf etwas wirklich Ernstes hin, und die SRE-Ingenieure kündigten sofort den Schweregrad P0 an und wandten sich an die Management- und Systemingenieure. </p><br><p>  Unsere Londoner Ingenieure hörten gerade einen Vortrag in der Haupthalle.  Der Vortrag musste unterbrochen werden, alle versammelten sich in einem großen Konferenzraum und weitere Experten wurden eingeladen.  Dies war kein häufiges Problem, das SRE selbst herausfinden konnte.  Es war dringend notwendig, die richtigen Spezialisten zusammenzubringen. </p><br><p>  Um 14:00 Uhr stellten wir fest, dass es ein Problem mit WAF gab und es keinen Angriff gab.  Die Leistungsabteilung rief Prozessordaten ab, und es wurde offensichtlich, dass WAF schuld war.  Ein anderer Mitarbeiter bestätigte diese Theorie mit aller Kraft.  Jemand anderes sah in den Protokollen, dass das Problem mit WAF.  Um 14:02 Uhr kam das gesamte Team zu mir, als vorgeschlagen wurde, Global Kill zu verwenden - einen in Cloudflare integrierten Mechanismus, der eine Komponente auf der ganzen Welt deaktiviert. </p><br><p>  Wie wir für WAF weltweit getötet haben, ist eine andere Geschichte.  So einfach ist das nicht.  Wir verwenden unsere eigenen Produkte, und da unser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Access-</a> Service nicht funktioniert hat, konnten wir uns nicht authentifizieren und das interne Kontrollfeld nicht betreten (als alles repariert wurde, haben wir erfahren, dass einige Mitglieder des Teams den Zugriff aufgrund einer Sicherheitsfunktion verloren haben, die Anmeldeinformationen deaktiviert, wenn Verwenden Sie das interne Bedienfeld nicht für längere Zeit. </p><br><p>  Und wir konnten nicht zu unseren internen Diensten wie Jira oder dem Build-System gelangen.  Wir brauchten eine Problemumgehung, die wir selten verwendeten (dies müsste auch ausgearbeitet werden).  Schließlich konnte ein Ingenieur um 14:07 Uhr die WAF abhacken, und um 14:09 Uhr normalisierten sich das Verkehrsaufkommen und der Prozessor überall wieder.  Der Rest der Abwehrmechanismen von Cloudflare funktionierte wie erwartet. </p><br><p>  Dann machten wir uns daran, WAF wiederherzustellen.  Die Situation war ungewöhnlich, daher führten wir negative Tests (bei denen wir uns fragten, ob das Problem wirklich diese Änderung war) und positive Tests (um sicherzustellen, dass der Rollback funktionierte) in einer Stadt mit separatem Verkehr durch und transferierten bezahlte Kunden von dort. </p><br><p>  Um 14.52 Uhr waren wir überzeugt, dass wir den Grund verstanden und eine Korrektur vorgenommen hatten, und schalteten die WAF wieder ein. </p><br><h3 id="kak-rabotaet-cloudflare">  Wie Cloudflare funktioniert </h3><br><p>  Cloudflare verfügt über ein Team von Ingenieuren, die verwaltete Regeln für WAF verwalten.  Sie versuchen, die Erkennungsrate zu erhöhen, die Anzahl der Fehlalarme zu verringern und schnell auf neue Bedrohungen zu reagieren, sobald sie auftreten.  In den letzten 60 Tagen wurden 476 Änderungsanforderungen für von WAF verwaltete Regeln verarbeitet (durchschnittlich eine alle 3 Stunden). </p><br><p>  Diese spezielle Änderung musste im Simulationsmodus bereitgestellt werden, in dem der reale Clientverkehr die Regel durchläuft, aber nichts blockiert wird.  Wir verwenden diesen Modus, um die Wirksamkeit der Regeln zu überprüfen und den Anteil falsch positiver und falsch negativer Ergebnisse zu messen.  Aber auch im Simulationsmodus müssen die Regeln tatsächlich ausgeführt werden. In diesem Fall enthielt die Regel einen regulären Ausdruck, der zu viele Prozessorressourcen verbrauchte. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/1p/sc/90/1psc90ccs9enwxvdyvu4thq30eo.png"></a> </p><br><p>  Wie Sie der obigen Änderungsanforderung entnehmen können, verfügen wir über einen Bereitstellungsplan, einen Rollback-Plan und einen Link zur internen Standardarbeitsanweisung (SOP) für diese Art der Bereitstellung.  Mit SOP zum Ändern der Regel können Sie sie global veröffentlichen.  Tatsächlich ist in Cloudflare alles völlig anders angeordnet, und SOP erfordert, dass die Software zum Testen und für den internen Gebrauch zuerst an einen internen Point of Presence (PoP) (den unsere Mitarbeiter verwenden), dann an eine kleine Anzahl von Clients an einem isolierten Ort, dann an eine große Anzahl von Clients und nur dann gesendet wird für die ganze Welt. </p><br><p>  So sieht es aus.  Wir verwenden Git im internen System über BitBucket.  Die Änderungsingenieure senden den von ihnen erstellten Code an TeamCity, und wenn der Build erfolgreich ist, werden Prüfer zugewiesen.  Wenn die Poolanforderung genehmigt wird, wird der Code gesammelt und eine Reihe von Tests (erneut) durchgeführt. </p><br><p>  Wenn die Montage und die Tests erfolgreich sind, wird in Jira eine Änderungsanforderung erstellt, und die Änderung muss vom entsprechenden Vorgesetzten oder leitenden Spezialisten genehmigt werden.  Nach der Genehmigung wird es in der sogenannten „PoP-Menagerie“ eingesetzt: HUND, SCHWEIN und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kanarienvogel</a> (Hund, Mumps und Kanarienvogel). </p><br><p>  DOG PoP ist Cloudflare PoP (wie jede andere unserer Städte), das nur von Cloudflare-Mitarbeitern verwendet wird.  Mit PoP für den internen Gebrauch können Sie Probleme erkennen, noch bevor die Lösung Kundenverkehr empfängt.  Nützliche Sache. </p><br><p>  Wenn der DOG-Test erfolgreich ist, geht der Code zum PIG-Stadium (Meerschweinchen) über.  Dies ist Cloudflare PoP, bei dem ein kleiner Teil des freien Clientverkehrs durch den neuen Code fließt. <br>  Wenn alles in Ordnung ist, geht der Code an Canary.  Wir haben drei kanarische PoPs in verschiedenen Teilen der Welt.  Der Datenverkehr von bezahlten und kostenlosen Kunden durchläuft den neuen Code in ihnen, und dies ist die letzte Fehlerprüfung. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ew/d_/0h/ewd_0hfzquucy07y15qbgbckaao.png"></a> <br>  <em>Release-Prozess für Cloudflare-Software</em> </p><br><p>  Wenn der Code in Canary in Ordnung ist, geben wir ihn frei.  Das Durchlaufen aller Phasen - DOG, PIG, Canary, die ganze Welt - dauert je nach Codeänderung mehrere Stunden oder Tage.  Aufgrund der Vielfalt des Cloudflare-Netzwerks und der Kunden testen wir den Code vor einer globalen Veröffentlichung für alle Kunden gründlich.  WAF folgt diesem Prozess jedoch nicht speziell, da auf Bedrohungen schnell reagiert werden muss. </p><br><p>  Bedrohungen WAF <br>  In den letzten Jahren gab es bei herkömmlichen Anwendungen erheblich mehr Bedrohungen.  Dies ist auf die höhere Verfügbarkeit von Softwaretest-Tools zurückzuführen.  Zum Beispiel haben wir kürzlich über <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fuzzing geschrieben</a> . </p><br><p><img src="https://habrastorage.org/webt/br/lu/mp/brlumpkugkwhpdfq3zb0fb5vixm.png"><br>  <em>Quelle: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  Sehr oft wird eine Bestätigung des Konzepts erstellt und sofort auf Github veröffentlicht, damit die Teams, die die Anwendung warten, sie schnell testen und sicherstellen können, dass sie angemessen geschützt ist.  Daher muss Cloudflare in der Lage sein, so schnell wie möglich auf neue Angriffe zu reagieren, damit Kunden die Möglichkeit haben, ihre Software zu reparieren. </p><br><p>  Ein gutes Beispiel für die schnelle Reaktion von Cloudflare ist die Bereitstellung des SharePoint-Schwachstellenschutzes im Mai ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">siehe hier</a> ).  Fast unmittelbar nach der Veröffentlichung der Anzeigen haben wir eine Vielzahl von Versuchen festgestellt, die Sicherheitsanfälligkeit in den SharePoint-Installationen unserer Kunden auszunutzen.  Unsere Mitarbeiter überwachen ständig neue Bedrohungen und schreiben Regeln, um unsere Kunden zu schützen. </p><br><p>  Die Regel, die das Problem am Donnerstag verursachte, war der Schutz vor Cross-Site-Scripting (XSS).  In den letzten Jahren gab es auch viele weitere derartige Angriffe. </p><br><p><img src="https://habrastorage.org/webt/tr/jy/oz/trjyozwk_k4raviofhzgeskwf2s.png"><br>  <em>Quelle: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://cvedetails.com/</a></em> </p><br><p>  Das Standardverfahren zum Ändern einer verwalteten Regel für WAF erfordert kontinuierliche Integrationstests (CI) vor der globalen Bereitstellung.  Letzten Donnerstag haben wir es geschafft und die Regeln erweitert.  Um 13:31 Uhr schickte ein Ingenieur eine genehmigte Poolanfrage mit einer Änderung. </p><br><p><img src="https://habrastorage.org/webt/uz/xj/jo/uzxjjo5648f52t8x-tnu66tuvku.png"></p><br><p>  Um 13:37 Uhr sammelte TeamCity die Regeln, führte die Tests durch und gab den Startschuss.  Die WAF-Testsuite testet die WAF-Kernfunktionalität und besteht aus einer Vielzahl von Komponententests für einzelne Funktionen.  Nach Unit-Tests haben wir die Regeln für WAF mit einer großen Anzahl von HTTP-Anfragen überprüft.  HTTP-Anforderungen prüfen, welche Anforderungen von WAF blockiert werden sollen (um den Angriff abzufangen) und welche übersprungen werden können (um nicht alles zu blockieren und Fehlalarme zu vermeiden).  Wir haben jedoch keine Tests für die übermäßige Verwendung von Prozessorressourcen durchgeführt. Die Untersuchung der Protokolle früherer WAF-Assemblys zeigt, dass sich die Testausführungszeit mit der Regel nicht erhöht hat und es schwierig war zu vermuten, dass nicht genügend Ressourcen vorhanden waren. </p><br><p>  Die Tests wurden bestanden und TeamCity begann um 13:42 Uhr, die Änderung automatisch bereitzustellen. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/8-/s2/gd/8-s2gd8pw8j5zhxukadhwh77xr4.png"></a> </p><br><h3 id="quicksilver">  Quecksilber </h3><br><p>  WAF-Regeln befassen sich mit der dringenden Beseitigung von Bedrohungen. Daher stellen wir sie mithilfe der verteilten Schlüssel-Wert-Paare Quicksilver bereit, mit denen Änderungen innerhalb von Sekunden global verteilt werden.  Alle unsere Kunden verwenden diese Technologie, wenn sie die Konfiguration im Dashboard oder über die API ändern. Dank dieser Reaktion reagieren wir blitzschnell auf Änderungen. </p><br><p>  Wir haben ein wenig über Quecksilber gesprochen.  Früher haben wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kyoto Tycoon</a> als global verteiltes Repository für Schlüssel-Wert-Paare verwendet, aber es gab Betriebsprobleme, und wir haben unser Repository in mehr als 180 Städten repliziert.  Mit Quicksilver senden wir jetzt Änderungen an der Clientkonfiguration, aktualisieren WAF-Regeln und verteilen JavaScript-Code, der von Clients in Cloudflare Workers geschrieben wurde. </p><br><p>  Es dauert nur wenige Sekunden, bis eine Konfiguration weltweit funktioniert, vom Drücken einer Taste auf einem Dashboard über das Aufrufen einer API bis hin zum Vornehmen von Konfigurationsänderungen.  Kunden lieben diese Geschwindigkeitseinstellung.  Und Workers bietet ihnen eine fast sofortige globale Softwarebereitstellung.  Im Durchschnitt verteilt Quicksilver etwa 350 Änderungen pro Sekunde. </p><br><p>  Und Quecksilber ist sehr schnell.  Im Durchschnitt haben wir das 99. Perzentil von 2,29 Sekunden erreicht, um Änderungen auf jeden Computer auf der ganzen Welt zu übertragen.  Normalerweise ist die Geschwindigkeit gut.  Wenn Sie eine Funktion aktivieren oder den Cache leeren, geschieht dies schließlich fast sofort und überall.  Das Senden von Code über Cloudflare Workers erfolgt mit derselben Geschwindigkeit.  Cloudflare verspricht seinen Kunden schnelle Updates zum richtigen Zeitpunkt. </p><br><p>  Aber in diesem Fall hat uns die Geschwindigkeit einen Streich gespielt, und die Regeln haben sich innerhalb von Sekunden überall geändert.  Sie haben wahrscheinlich bemerkt, dass der WAF-Code Lua verwendet.  Cloudflare verwendet Lua in großem Umfang in der Produktionsumgebung, und wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">haben die</a> Details von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Lua bereits in WAF</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">besprochen</a> .  Lua WAF verwendet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">PCRE</a> intern und wendet das Back-Tracking für den Abgleich an.  Es gibt keine Abwehrmechanismen gegen außer Kontrolle geratene Ausdrücke.  Im Folgenden werde ich mehr darüber und darüber sprechen, was wir damit machen. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/zd/qq/yo/zdqqyof00zszstm3indwngi26_8.png"></a> </p><br><p>  Bevor die Regeln bereitgestellt wurden, verlief alles reibungslos: Die Poolanforderung wurde erstellt und genehmigt, die CI / CD-Pipeline hat den Code kompiliert und getestet, die Änderungsanforderung wurde gemäß der SOP gesendet, die die Bereitstellung und das Rollback regelt, und die Bereitstellung wurde abgeschlossen. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/5t/47/ar/5t47art0hduaaxywv3io5_71z8a.png"></a> <br>  <em>CloudFare WAF-Bereitstellungsprozess</em> </p><br><p>  Was ist schief gelaufen? <br>  Wie ich bereits sagte, stellen wir jede Woche Dutzende neuer WAF-Regeln bereit, und wir haben viele Schutzsysteme gegen die negativen Folgen einer solchen Bereitstellung.  Und wenn etwas schief geht, ist es normalerweise eine Kombination mehrerer Umstände.  Wenn Sie nur einen Grund finden, ist dies natürlich beruhigend, aber nicht immer wahr.  Hier sind die Gründe, die zusammen zum Ausfall unseres HTTP / HTTPS-Dienstes geführt haben. </p><br><ol><li>  Der Ingenieur schrieb einen regulären Ausdruck, der zu übermäßigem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Backtracking</a> führen könnte. </li><li>  Ein Tool, das eine übermäßige Verwendung der vom regulären Ausdruck verwendeten Prozessorressourcen verhindern konnte, wurde einige Wochen zuvor fälschlicherweise während des WAF-Refactorings entfernt. Das Refactoring war erforderlich, damit WAF weniger Ressourcen verbrauchte. </li><li>  Die Regex-Engine hatte keine Garantie für Komplexität. </li><li>  Die Testsuite konnte keinen übermäßigen CPU-Verbrauch feststellen. </li><li>  Das SOP-Verfahren ermöglicht die globale Bereitstellung nicht dringender Regeländerungen ohne einen mehrstufigen Prozess. </li><li>  Der Rollback-Plan erforderte zweimal eine vollständige WAF-Montage, was lange dauerte. </li><li>  Der erste globale Verkehrsalarm war zu spät. </li><li>  Wir haben die Aktualisierung der Statusseite verzögert. </li><li>  Wir hatten aufgrund eines Absturzes Probleme beim Zugriff auf Systeme, und die Problemumgehung wurde nicht gut genug ausgearbeitet. </li><li>  SRE-Ingenieure haben den Zugriff auf einige Systeme verloren, weil ihre Anmeldeinformationen aus Sicherheitsgründen abgelaufen sind. </li><li>  Unsere Kunden hatten keinen Zugriff auf das Cloudflare-Dashboard oder die API, da sie die Cloudflare-Region durchlaufen haben. </li></ol><br><h3 id="chto-izmenilos-s-proshlogo-chetverga">  Was hat sich seit letztem Donnerstag geändert? </h3><br><p>  Erstens haben wir alle Arbeiten an Releases für WAF vollständig eingestellt und gehen wie folgt vor: </p><br><ol><li>  Wiedereinführung des Schutzes vor übermäßigen Prozessorressourcen, die wir entfernt haben.  (Fertig) </li><li>  Überprüfen Sie alle 3868-Regeln in den verwalteten Regeln manuell, damit WAF andere potenzielle Fälle von übermäßigem Backtracking findet und behebt.  (Überprüfung abgeschlossen) </li><li>  Wir enthalten Leistungsprofile für alle Regeln in der Testsuite.  (Voraussichtlich: 19. Juli) </li><li>  Wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wechseln</a> zur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">re2-</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Rust-</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Regex-</a> Engine - beide bieten Garantien zur Laufzeit.  (Voraussichtlich: 31. Juli) </li><li>  Wir schreiben SOP neu, um die Regeln wie andere Software in Cloudflare schrittweise bereitzustellen, haben aber gleichzeitig die Möglichkeit, eine globale Notfallbereitstellung durchzuführen, wenn die Angriffe bereits begonnen haben. </li><li>  Wir entwickeln die Möglichkeit eines dringenden Rückzugs des Cloudflare-Dashboards und der API aus der Cloudflare-Region. </li><li>  Wir automatisieren die Aktualisierung der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Cloudflare-Statusseite</a> . </li></ol><br><p>  Auf lange Sicht geben wir Lua WAF auf, das ich vor einigen Jahren geschrieben habe.  Wir migrieren WAF auf das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">neue Firewall-System</a> .  So wird WAF schneller und erhält ein zusätzliches Schutzniveau. </p><br><h3 id="zaklyuchenie">  Fazit </h3><br><p>  Dieser Fehler verursachte Probleme für uns und unsere Kunden.  Wir haben schnell reagiert, um die Situation zu korrigieren, und jetzt arbeiten wir an Fehlern in den Prozessen, die den Fehler verursacht haben, und wir graben noch tiefer, um uns durch die Umstellung auf eine neue Technologie vor potenziellen Problemen mit regulären Ausdrücken in der Zukunft zu schützen. </p><br><p>  Wir schämen uns sehr für diesen Fehler und entschuldigen uns bei unseren Kunden.  Wir hoffen, dass diese Änderungen sicherstellen, dass dies nicht erneut geschieht. </p><br><h3 id="prilozhenie-bektreking-regulyarnyh-vyrazheniy">  Anwendung.  Backtracking für reguläre Ausdrücke </h3><br><p>  Um zu verstehen, wie der Ausdruck: </p><br><pre> <code class="plaintext hljs">(?:(?:\"|'|\]|\}|\\|\d (?:nan|infinity|true|false|null|undefined|symbol|math)|\`|\- |\+)+[)]*;?((?:\s|-|~|!|{}|\|\||\+)*.*(?:.*=.*)))</code> </pre> <br><p>  Wenn Sie alle Prozessorressourcen verbraucht haben, müssen Sie ein wenig über die Funktionsweise der Standard-Regex-Engine wissen.  Das Problem hier ist das Muster <code>.*(?:.*=.*)</code> .  <code>(?:</code> und die entsprechende <code>)</code> ist keine aufregende Gruppe (dh der Ausdruck in Klammern wird als ein Ausdruck gruppiert). </p><br><p>  Im Zusammenhang mit einem übermäßigen Verbrauch von Prozessorressourcen kann dieses Muster als <code>.*.*=.*</code> Bezeichnet werden.  Als solches sieht das Muster unnötig komplex aus.  Noch wichtiger ist jedoch, dass in der realen Welt solche Ausdrücke (ähnlich wie komplexe Ausdrücke in den WAF-Regeln), die die Engine auffordern, einem Fragment gefolgt von einem anderen Fragment zu entsprechen, zu einem katastrophalen Backtracking führen können.  Und hier ist warum. </p><br><p><img src="https://habrastorage.org/webt/wr/7g/ec/wr7gec__o2lld5uwyz5ir6vfolm.png"></p><br><p>  Im regulären Ausdruck <code>.</code>  bedeutet, dass Sie mit einem Zeichen übereinstimmen müssen. <code>.*</code> - Null oder mehr Zeichen "gierig" abgleichen, dh maximal ein Zeichen erfassen, also <code>.*.*=.*</code> bedeutet, dass Sie mit null oder mehr Zeichen übereinstimmen und dann mit null oder mehr Zeichen übereinstimmen Literalzeichen =, entspricht null oder mehr Zeichen. </p><br><p>  Nehmen Sie die Testlinie <code>x=x</code> .  Es entspricht dem Ausdruck <code>.*.*=.*. .*.*</code>  <code>.*.*=.*. .*.*</code> bis zum Gleichheitszeichen entspricht dem ersten <code>x</code> (eine der Gruppen <code>.*</code> entspricht <code>x</code> und das zweite bis null Zeichen).  <code>.*</code> after = entspricht dem letzten <code>x</code> . </p><br><p>  Für einen solchen Vergleich sind 23 Schritte erforderlich.  Die erste Gruppe <code>.*</code> <code>.*.*=.*</code> Handelt "gierig" und entspricht der gesamten Zeile <code>x=x</code> .  Der Motor fährt zur nächsten Gruppe <code>.*</code> .  Wir haben keine übereinstimmenden Zeichen mehr, also die zweite Gruppe <code>.*</code> Entspricht null Zeichen (dies ist zulässig).  Dann geht der Motor zum <code>=</code> -Zeichen.  Es gibt keine weiteren Zeichen (die erste Gruppe <code>.*</code> Verwendet den gesamten Ausdruck <code>x=x</code> ), es findet keine Übereinstimmung statt. </p><br><p>  Und hier kehrt die Engine für reguläre Ausdrücke zum Anfang zurück.  Er geht zur ersten Gruppe <code>.*</code> Und vergleicht sie <code> x=</code> (anstelle von <code>x=x</code> ) und übernimmt dann die zweite Gruppe <code>.*</code> .  Die zweite Gruppe <code>.*</code> Wird dem zweiten <code>x</code> , und wir haben wieder keine Zeichen mehr.  Und wenn der Motor <code>=</code> v <code>.*.*=.*</code> Erreicht, passiert wieder nichts.  Und er macht wieder einen Backtrack. </p><br><p>  Diesmal die Gruppe <code>.*</code> immer noch mit <code>x=</code> überein, aber mit der zweiten Gruppe <code>.*</code> nicht mehr <code>x</code> , sondern null Zeichen.  Die Engine versucht, das Literalsymbol <code>=</code> im Muster zu finden <code>.*.*=.*</code> , Wird jedoch nicht beendet (schließlich hat die erste Gruppe es bereits belegt <code>.*</code> ).  Und er macht wieder einen Backtrack. </p><br><p>  Diesmal die erste Gruppe <code>.*</code> Nimmt nur das erste x.  Aber die zweite Gruppe <code>.*</code> "Gierig" erfasst <code>=x</code> .  Schon erraten, was passieren wird?  Die Engine versucht, mit literal <code>=</code> übereinzustimmen, schlägt fehl und führt das nächste Backtracking durch. </p><br><p>   <code>.*</code>     <code>x</code> .  <code>.*</code>   <code>=</code> . ,      <code>=</code> ,       <code>.*</code> .   .         ! </p><br><p>     <code>.*</code>     <code>x</code> ,  <code>.*</code> —   ,      <code>=</code>   <code> =</code>  .    <code>.*</code>    <code>x</code> . </p><br><p> 23    <code>x=x</code> .      Perl <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Regexp::Debugger</a> ,  ,     . </p><br><p><img src="https://habrastorage.org/webt/a7/do/2n/a7do2nizluizhm1h2q2shajnvgs.gif"></p><br><p>    ,     <code>x=x</code>    <code>x=xx</code> ?  33 .   <code>x=xxx</code> ? 45.   .      <code>x=x</code>  <code>x=xxxxxxxxxxxxxxxxxxxx</code> (20 <code>x</code>  <code>=</code> ).    20 x  <code>=</code> ,     555 ! ( ,     <code>x=</code>      20 <code>x</code> ,   4067 ,  ,   ). </p><br><p><img src="https://habrastorage.org/webt/t-/1m/l4/t-1ml4up0y5w262eye_cyjmlik4.png"></p><br><p>         <code>x=xxxxxxxxxxxxxxxxxxxx</code> : </p><br><p><img src="https://habrastorage.org/webt/t8/oz/wq/t8ozwqwv1otujwl5_bebeglitpe.gif"></p><br><p>   ,         .      ,     . ,     <code>.*.*=.*</code> ; (         ). ,     ,  <code>foo=bar;</code>  . </p><br><p>       .   <code>x=x</code>  90 ,   23.     .   <code>x=</code>  20 <code>x</code> ,  5353 .  .      <code>Y</code>     . </p><br><p><img src="https://habrastorage.org/webt/kn/n9/ex/knn9exewj9a48-fkxyayefzexeu.png"></p><br><p>  ,   5353    <code>x=xxxxxxxxxxxxxxxxxxxx</code>  <code>.*.*=.*;</code> </p><br><p><img src="https://habrastorage.org/webt/d3/gg/ra/d3ggrayopot2-l7vivzm0fqfnmq.gif"></p><br><p>   «»,   «» ,    .      <code>.*?.*?=.*?</code> ,   <code>x=x</code>  11  (  23).    <code>x=xxxxxxxxxxxxxxxxxxxx</code> .  ,  <code>?</code>  <code>.*</code>      ,    . </p><br><p>  «»      .     <code>.*.*=.*;</code>  <code>.*?.*?=.*?;</code> ,    . <code>x=x</code>    555 ,  <code>x=</code>  20 <code>x</code> — 5353. </p><br><p> ,    (      ) —         .        . </p><br><p>       1968 ,      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Programming Techniques: Regular expression search algorithm</a> (« :    »).    ,         ,          ,        . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fd/nn/ri/fdnnril2lmr0udityqylanfzahk.png"></a> </p><br><blockquote> <strong>  <br>     <br>   (Ken Thompson)</strong> <br> Bell Telephone Laboratories, Inc., -,  - <br><br>                 .             IBM 7094    .               ,         .    ,   . <br><br> <strong></strong> <br>      ,       . <br><br>        .      .     —                  . <br>              . ,        . ,           . <br> ,           IBM 7094. <br><br> <strong></strong> <br>       .   —   ,       .       «·»    .         .      .  2  ,       . </blockquote><p>         ,           ALGOL-60,       IBM 7094.  ,     . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/fx/se/9x/fxse9xv8le3pgp2quvsrufznvb8.png"></a> </p><br><blockquote>   .    ⊕      . <br>   1          .      — a, b, c,      S[i]   NNODE. <br><br> NNODE   ,          (. . 5) </blockquote><p>       <code>.*.*=.*</code> ,   ,      . </p><br><p><img src="https://habrastorage.org/webt/mt/_5/lc/mt_5lcklo-jw2x6zmt8nwjg8hpy.png"></p><br><p>  . 0   ,   0,  3 ,     1, 2  3.      <code>.*</code>   . 3      .    <code>=</code>    <code>=</code> .  4  .    ,    . </p><br><p>  ,           <code>.*.*=.*</code> ,     <code>x=x</code> .     0,    .  1. </p><br><p><img src="https://habrastorage.org/webt/tx/a6/cl/txa6cltpurcbwxzrxk1v9ypkec4.png"></p><br><p>    ,        .        . </p><br><p>      ,       (1  2),    .  2. </p><br><p><img src="https://habrastorage.org/webt/ve/pb/nj/vepbnjljx-0cinc-eapaz17mths.png"></p><br><p>  . 2 ,  ,     <code>x</code>  <code>x=x</code> . <code>x</code>     ,    1     1.  <code>x</code>     ,    2     2. </p><br><p>    <code>x</code>  <code>x=x</code>  -   1  2.      3  4,       <code>=</code> . </p><br><p>    <code>=</code>  <code>x=x</code> .   x  ,              1    1    2   2,        <code>=</code>     2   3 (  4).    .  3. </p><br><p><img src="https://habrastorage.org/webt/0b/x8/7f/0bx87fp1aquszmn-wjp7ta3b4i0.png"></p><br><p>      <code>x</code>  <code>x=x</code> .   1  2        1  2.   3 <code>x</code>           3. </p><br><p>      <code>x=x</code> ,      4,     .     ,          .   . </p><br><p> ,     4 (   <code>x=</code> )    ,    ,    <code>x</code> . </p><br><p>        . </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de460863/">https://habr.com/ru/post/de460863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de460851/index.html">SamsPcbGuide, Teil 10: Technologie - Löten bleifreier Komponenten</a></li>
<li><a href="../de460855/index.html">Wie verwende ich PHP zur Implementierung von Microservices?</a></li>
<li><a href="../de460857/index.html">Wie Namecoin Blockchain Research RTM-Cyber-Angriffe vorhersagte</a></li>
<li><a href="../de460859/index.html">IThink # 3 Konferenz in Kharkov - basierend auf WWDC 2019</a></li>
<li><a href="../de460861/index.html">JavaScript lexikalischer Umfang und Abschluss</a></li>
<li><a href="../de460865/index.html">Menschen auf dem Mond. Quellen</a></li>
<li><a href="../de460867/index.html">Sourcery zur automatischen Konvertierung in Realm-Objektstrukturen</a></li>
<li><a href="../de460869/index.html">Echtzeit-Objekterkennung unter iOS mit YOLOv3</a></li>
<li><a href="../de460873/index.html">Warum Turok: Dinosaur Hunter für N64 seiner Zeit um Jahre voraus ist</a></li>
<li><a href="../de460875/index.html">Wie wir bei QIWI zu einem gemeinsamen Interaktionsstil zwischen View und ViewModel innerhalb von MVVM gekommen sind</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>