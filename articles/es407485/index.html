<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üÜë üë®üèæ‚ÄçüöÄ üì´ Programaci√≥n e intercambio de datos con ARDUINO a trav√©s de WIFI a trav√©s de ESP8266 Segunda parte üíû üö¥üèº üôáüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Les ofrezco, queridos lectores de GeekTimes, el siguiente art√≠culo del ciclo (espero que no sea el √∫ltimo) sobre el uso del chip ESP8266 como puente i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Programaci√≥n e intercambio de datos con ARDUINO a trav√©s de WIFI a trav√©s de ESP8266 Segunda parte</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/407485/">  Les ofrezco, queridos lectores de GeekTimes, el siguiente art√≠culo del ciclo (espero que no sea el √∫ltimo) sobre el uso del chip ESP8266 como puente inal√°mbrico para microcontroladores AVR, utilizando la plataforma de hardware Arduino Uno (Nano) como ejemplo. <br><br>  Despu√©s del primer art√≠culo sobre este tema, recib√≠ muchas respuestas amistosas, tales como: "¬øPor qu√© demonios tomaste arduine si todo se pod√≠a hacer exclusivamente en ESP8266?" O "¬øPor qu√©, tonto, no usaste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">esp-link</a> "?  "¬øEn serio por qu√©?"  - Pens√©, y ya sal√≠ de este art√≠culo y actualic√© varios de mis programas como nuevos argumentos. <br><br>  Entonces, conozca al programador inal√°mbrico para microcontroladores AVR BABUINO versi√≥n 0.9 <br><br><img src="https://habrastorage.org/webt/59/e6/27/59e627aa555f2888616620.png"><br><br>  Detalles debajo del corte: <br><a name="habracut"></a><br>  La versi√≥n original del programa se public√≥ en un art√≠culo anterior y, en principio, hizo casi lo mismo que la nueva versi√≥n.  Pero se distingui√≥ por inconvenientes extremos en el trabajo.  Como, sin embargo, y compitiendo esp-link.  Por lo tanto, con un suspiro, atornill√© la GUI a JAVA.  Ahora puede seleccionar de forma segura el archivo que necesita descargar a trav√©s del administrador de ventanas, as√≠ como editar la direcci√≥n IP del dispositivo de destino.  Todav√≠a ingres√© el n√∫mero de puerto TCP estrictamente (solo se edita en el c√≥digo), pero en teor√≠a, solo debe cambiarse si este puerto se usa en otro lugar (pero tambi√©n tendr√° que cambiar su n√∫mero en el firmware ESP8266). <br><br>  El microcontrolador tambi√©n se usa hasta ahora con uno con un tama√±o de memoria FLASH de 32 KB, este, por ejemplo, es el conocido Mega328P.  Como, como mencion√© en un art√≠culo anterior, en teor√≠a, mi programador cose versiones en 16 kbytes, y tal vez incluso en 8 kbytes.  Bueno, por supuesto, en las versiones de AVR de 64 kB y 128 kB, incluso puede flashear los primeros 32 kB de memoria.  Pero no tengo esos microcontroladores en mis manos y no puedo decir c√≥mo es realmente.  El punto es que 16 bits de direcciones en los comandos de programaci√≥n SPI est√°ndar est√°n tan inteligentemente divididos y cortados (bit aqu√≠, bit there) que no es f√°cil entender c√≥mo ser√° todo con un tama√±o de memoria diferente a 32 kbytes. <br><br>  S√≠, el programa no se verifica despu√©s de la grabaci√≥n, los registros AVR especiales no son legibles, EEPROM tampoco escribe.  Pero todo esto es te√≥ricamente posible sin problemas (en contraste con las limitaciones fundamentales de descargar c√≥digo a trav√©s de UART, como en esp-link).  Puede agregar, no me importa, el producto no es comercial. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu√≠ est√° el archivo ejecutable para Windows de 64 bits</a> .  Puede extraer el c√≥digo Java de √©l.  O tomar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> <br><br>  Entonces, comencemos. <br><br>  Entonces todo es simple, abra el archivo HEX que necesita (s√≠, el programa aprendi√≥ a convertir el formato BIN a HEX, ¬°salud!) Ingrese la direcci√≥n IP ESP8266 que necesita y haga clic en "Cargar" (c√≥mo encontrar la direcci√≥n IP del m√≥dulo ESP es una historia aparte).  Si el programador encuentra ESP8266, entonces r√°pidamente (mucho m√°s r√°pido que esp-link) inserta su c√≥digo en √©l y lo env√≠a m√°s al microcontrolador AVR a trav√©s de la interfaz SPI.  El programador describe en detalle sus acciones en la ventana e incluso se puede confiar en √©l, excepto que el programa se grab√≥ en AVR.  Como ya dije, no hay verificaci√≥n del registro, pero la interfaz SPI es puramente sincr√≥nica, generalmente no le importa si hay alguien en el segundo extremo de la l√≠nea o no.  Lanza datos, pero no espera una respuesta. <br><br>  Despu√©s de cerrar el programa (mediante "Detener" o simplemente cerrar la ventana), los datos que ingres√≥ (si presion√≥ el bot√≥n Cargar antes) se almacenan en el archivo tcp_dat.txt en el directorio ra√≠z de la unidad C, por lo que la pr√≥xima vez que lo abra, no tendr√° que preocuparse mucho, nuevamente para reclutar.  En general, la ventana del programa puede no estar cerrada.  Por experiencia, no molesta a nadie. <br><br>  Ahora pasemos al lado del m√≥dulo ESP y recordemos de nuevo, ahora en detalle, c√≥mo conectarlo al AVR y de qu√© manera flashearlo, para poder usar el programador mencionado anteriormente, y tambi√©n simplemente conducir datos a trav√©s de WI-FI de forma inal√°mbrica. <br><br>  Entonces, lo primero es el diagrama de conexi√≥n.  Tenga en cuenta que necesitamos ESP8266 en versiones con una cantidad suficiente de GPIO.  Necesitaremos conclusiones gratuitas en RESET, MOSI y SLK para programar en la interfaz SPI, adem√°s del hecho de que para el intercambio de datos tambi√©n usaremos el UART habitual con sus RX y TX.  Para esto, el ESP8266-07 parec√≠a el m√°s conveniente por el precio y la calidad. <br><br>  Lo tomamos e inmediatamente soldamos dos resistencias con un valor de 5-10 kOhm.  El primero en EN (CH-PD) y potencia, el segundo en GPIO15 y tierra <br><br><img src="https://habrastorage.org/webt/59/e6/2a/59e62a1ce6d68161674830.jpeg"><br><br>  Ahora puede conectarlo al adaptador, a trav√©s del cual cargaremos el firmware de NodeMCU y luego nuestro gestor de arranque LUA. <br><br><img src="https://habrastorage.org/webt/59/e6/2a/59e62ae77bcbd280076551.jpeg"><br><br>  Un mill√≥n de adaptadores, toma cualquiera.  Conectamos, como siempre, RX c TX y viceversa.  Hacemos que la tierra sea com√∫n.  Suministramos energ√≠a al ESP8266 por separado, y su adaptador del puerto USB es suficiente.  Lanzamos cero en GPIO0 y completamos el √∫ltimo firmware de NodeMCU (puede obtenerlo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> , o crear el suyo propio) a trav√©s del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">programa PyFlasher NODE MCU</a> . <br><br><img src="https://habrastorage.org/web/437/bd0/676/437bd067628f4a9db96466bb8d0d793b.png"><br><br>  Todo esto, en principio, se describe en el art√≠culo anterior y muchas veces en Internet.  A continuaci√≥n, eliminamos el cero de GPIO0 (puede dejarlo colgado, est√° bien) y abrimos el entorno <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">ESPlorer</a> para depurar y descargar programas en Lua.  Es cierto que esta infecci√≥n sin el entorno JAVA no funciona.  As√≠ que esto (¬° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Descargue Java en su computadora de escritorio ahora!</a> ) Tendr√° que estar preinstalado de todos modos. <br><br>  Despu√©s de conectarse a ESPlorer, formatear√° ligeramente el m√≥dulo ESP y le informar√° con los mensajes apropiados.  (lo principal es no tocar nada en este momento), y luego ESP se reiniciar√°.  Puede comenzar a trabajar en la descarga de programas LUA. <br><br><img src="https://habrastorage.org/webt/59/e6/2c/59e62c1c2d69d544915668.png"><br><br>  Y tendremos el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">siguiente</a> programa: <br><br><div class="spoiler">  <b class="spoiler_title">Cargador de arranque para AVR en Lua en ESP8266</b> <div class="spoiler_text"><pre><code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InstrProgrammingEnable</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">-- instruction for MC "enable programming" p=0 while p&lt;31 do p=p+1 pin=8 gpio.write(pin, gpio.LOW) spi.send(1, 0xAC,0x53) read = spi.recv( 1, 8) spi.send(1,0,0) gpio.write(pin, gpio.HIGH) if (string.byte(read)== 83) then --print("connection established") p=33 if(p==31) then --print("no connection") end end end end function ProgrammingDisable () pin=2--END OF RESET FOR MK GPIO4 gpio.mode(pin, gpio.INPUT) pin=8 gpio.mode(pin, gpio.INPUT) -- CE chip enable not used GPIO15 pin=5--CLK MASTER for SPI GPIO14 used gpio.mode(pin, gpio.INPUT) pin=6--MISO MASTER for SPI GPIO 12 may not used gpio.mode(pin, gpio.INPUT) pin=7--MOSI MASTER for SPI //GPIO13 used gpio.mode(pin, gpio.INPUT) end --PROGRAMMING ENABLE function ProgrammingEnable () pin=2-- RESET FOR MK gpio.mode(pin, gpio.OUTPUT) gpio.write(pin, gpio.LOW) pin=2--POZITIV FOR 4MSEC RESET FOR MK gpio.mode(pin, gpio.OUTPUT) gpio.write(pin, gpio.HIGH) tmr.delay(4) gpio.mode(pin, gpio.OUTPUT) gpio.write(pin, gpio.LOW) tmr.delay(25000) end function InstrFlashErase() pin=8 gpio.write(pin, gpio.LOW) spi.send(1,0xAC,0x80,0,0) gpio.write(pin, gpio.HIGH) tmr.delay(15000) pin=2--RESET FOR MK gpio.mode(pin, gpio.OUTPUT) gpio.write(pin, gpio.HIGH) tmr.delay(20000) gpio.write(pin, gpio.LOW) --print( "FLASH is erased") InstrProgrammingEnable () end function InstrStorePAGE(H, address, data) pin=8 gpio.write(pin, gpio.LOW) spi.send(1,H,0,address,data) gpio.write(pin, gpio.HIGH) tmr.delay(500) end function InstrWriteFLASH(page_address_low,page_address_high) pin=8 gpio.write(pin, gpio.LOW) spi.send(1,0x4C,page_address_high,page_address_low,0) gpio.write(pin, gpio.HIGH) tmr.delay(5000)--        end function Programming (payload) pin=8--CS MASTER for SPI gpio.mode(pin, gpio.OUTPUT, gpio.PULLUP) pin=4--LED LIGHTS ON LOW gpio.mode(pin, gpio.OUTPUT) gpio.write(pin, gpio.LOW) --print(string.len(payload)) page_count = 7 --  1  for k =0 ,page_count ,1 do--quantity of pages for i=0 , 127, 2 do-- -1 address = i/2 data=payload:byte(i+1+128*k) if data == nil then data = 0xff end InstrStorePAGE(0x40,address,data) -- tmr.delay(100)-- otherwise not in time write data =payload:byte(i+1+1+128*k) if data == nil then data = 0xff end InstrStorePAGE(0x48,address,data) -- tmr.delay(100) end page_address_low=bit.band(k ,3)*64 -- 3   11 page_address_high=k/4+frame1024*2 tmr.delay(1000) InstrWriteFLASH(page_address_low,page_address_high) tmr.wdclr() end pin=4--LED gpio.mode(pin, gpio.OUTPUT) gpio.write(pin, gpio.HIGH) end --MAIN BLOCK wifi.setmode(wifi.STATION) --wifi.sta.config("SSID","password ") -- set SSID and password of your access point station_cfg={} tmr.delay(30000) station_cfg.ssid="SSID" tmr.delay(30000) station_cfg.pwd="Password" tmr.delay(30000) wifi.sta.config(station_cfg) tmr.delay(30000) wifi.sta.connect() tmr.delay(1000000) --print(wifi.sta.status()) --print(wifi.sta.getip()) while ( wifi.sta.status()~=1 ) do if( wifi.sta.status()==5) then break end end prog_address=""; sv=net.createServer(net.TCP,30) tmr.delay(100) --print("SERVER READY") sv:listen(40000,function(c)-- ,   c:on("receive", function(c, payload) --print(payload) if (payload =="program\r\n") then c:send("ready\r\n") --print("ready for program\r\n") tmr.wdclr() spi.setup(1, spi.MASTER, spi.CPOL_LOW, spi.CPHA_LOW, spi.DATABITS_8,80,spi.FULLDUPLEX) --  SPI 320  115 000  -- 80    1  ProgrammingEnable () tmr.delay(100) InstrProgrammingEnable () tmr.delay(100) InstrFlashErase() tmr.delay(100) frame1024=0--   st=net.createServer(net.TCP,30)--         AWR,   stop program st:listen(40001,function(c) c:on("receive", function(c, payload) tmr.wdclr() Programming (payload) frame1024=frame1024+1 end) end) end if (payload =="data\r\n") then tmr.wdclr() c:send("ready\r\n") -- print("ready for data\r\n") c:on("receive", function(c, prog_address_payload) prog_address=prog_address_payload-- IP  UDP       -- print(prog_address) c:send(prog_address) srv=net.createUDPSocket()--     ,   data stop srv:listen(50000) uart.setup(0,9600,8,0,1,0) srv:on("receive", function(srv, pl) --      UDP pl=pl*1 -- print(pl) uart.write(0,pl) --    UART  AVR end) uart.on("data", 1, function(data) --    UART  AVR srv:send(50000,prog_address,data) --    UDP   end, 0) tmr.wdclr() end) end if (payload =="stop data\r\n") --      then ready = false if(srv~=nil) then srv:close() -- print("stop data") end collectgarbage() end if (payload =="stop program\r\n") then if(st~=nil) then st:close() frame1024=0 ProgrammingDisable () -- print("stop program") end collectgarbage() end end) end)</span></span></code> </pre> <br></div></div><br>  Es casi lo mismo que se describe en la primera parte, pero ahora no solo puede transmitir el flujo de datos desde la computadora al microcontrolador AVR, sino que ahora lo hace en la direcci√≥n opuesta. <br><br>  En el proceso de escritura, tuve que resolver un inconveniente interesante.  Cuando enviamos datos desde una computadora al ESP8266 usando UDP, no hay problemas.  Se conoce la direcci√≥n IP del m√≥dulo ESP (la manejamos nosotros mismos al principio, si es as√≠), se conoce el puerto, todo est√° bien.  Pero cuando intentamos enviar datos en la direcci√≥n opuesta, no podemos hacer esto, ya que el m√≥dulo ESP no conoce la direcci√≥n IP de la computadora en la que se ejecuta el programador.  M√°s bien, √©l lo conoce, porque antes de eso establecemos contacto a trav√©s del protocolo TCP para enviar comandos de control (programa, datos, detenci√≥n).  Y cuando se usa este protocolo, los dispositivos intercambian sus direcciones, porque es bidireccional.  Pero aqu√≠ no se lo dir√°.  En cualquier caso, no encontr√© en las funciones API de NodeMCU para sacarlo.  Por supuesto, puede conducir la IP de la computadora directamente al gestor de arranque en el ESP8266, pero esta no es una opci√≥n.  De repente, ejecutamos un programa para intercambiar datos en otra computadora.  O tiene m√°s de una tarjeta de red. <br><br>  Entonces hice una muleta.  Transferimos la IP de la computadora en la que se ejecuta el programa expl√≠citamente antes de comenzar el intercambio de datos.  En la API de JAVA, afortunadamente, existe una funci√≥n para determinar la direcci√≥n de red del host en el que se ejecuta el programa.  ESP8266, despu√©s de haber recibido esta direcci√≥n, ahora puede enviar f√°cilmente datos no solo a AVR, sino tambi√©n desde √©l.  En cuanto al programa LUA, es muy simple, ingenuo y simple, y esto se debe al hecho de que en este idioma todav√≠a estoy muy mal orientado. <br><br>  Entonces, con la ayuda de ESPlorer, registramos el gestor de arranque actualizado en ESP8266.  No olvide nombrar inicialmente el archivo como init.lua o renombrarlo a trav√©s de ESPlorer, de lo <s>contrario no despegar√°</s> .  Bueno, por supuesto, martillee en el cuerpo (donde est√° el BLOQUE PRINCIPAL) del gestor de arranque su nombre de red y contrase√±a. <br><br>  A continuaci√≥n, debemos determinar y corregir la direcci√≥n IP del m√≥dulo ESP en nuestra red interna.  Entramos en el enrutador local bajo derechos de administrador y vemos algo as√≠. <br><br><img src="https://habrastorage.org/webt/59/e6/2e/59e62ec9372c5031952835.png"><br><br>  Esta direcci√≥n sigue siendo din√°mica (es decir, despu√©s de volver a conectarla se le puede asignar una diferente), por lo tanto, la asociamos con la direcci√≥n MAC ESP8266 en el mismo lugar en el enrutador. <br><br><img src="https://habrastorage.org/webt/59/e6/2e/59e62eeb3e72f523746841.png"><br><br>  Incluso puede escribirlo (√∫ltimos d√≠gitos) en el propio m√≥dulo, si tiene esclerosis. <br><br><img src="https://habrastorage.org/webt/59/e6/2f/59e62f039cdef226173063.jpeg"><br><br>  El m√≥dulo ESP est√° listo para funcionar, puede conectarlo con un microcontrolador AVR. <br><br><img src="https://habrastorage.org/webt/59/e6/2f/59e62f315c64b451508790.png"><br><br>  Lanzamos BABUINO, escribimos la direcci√≥n IP del m√≥dulo ESP, seleccionamos el archivo HEX (algunos PARPADEAMOS), presionamos ‚ÄúCargar‚Äù y disfrutamos del parpadeo del LED.  El programador escribir√° en su ventana, algo como esto: <br><br><img src="https://habrastorage.org/webt/59/e6/2f/59e62f7fbddbb531168682.png"><br><br>  Pero a veces esto puede suceder si el m√≥dulo ESP est√° en silencio por alguna raz√≥n: <br><br><img src="https://habrastorage.org/webt/59/e6/2f/59e62f996cd87469422553.png"><br><br>  Ahora veamos c√≥mo nuestro cargador de arranque conectado en ESP8266 puede intercambiar datos en ambas direcciones.  Para hacer esto, controlaremos el carro rob√≥tico desde el teclado de la computadora, y nos enviar√° su camino recorrido.  Mi primer carro rob√≥tico de cuatro ruedas muri√≥ al morir el valiente, recibiendo una se√±al del Cosmos y cayendo de la mesa (este hecho astral se explicar√° m√°s adelante).  Por lo tanto, hasta que un nuevo marco acr√≠lico provenga de China, se realizar√°n experimentos en un carro rob√≥tico de dos ruedas, que, por cierto, he estado tratando de forzar el equilibrio sobre dos ruedas de a√±o en a√±o, pero hasta ahora sin √©xito.  De acuerdo con el esquema de conexi√≥n electr√≥nica y el programa para AVR, estos carros no difieren, lo que utilizaremos. <br><br><img src="https://habrastorage.org/webt/59/e6/38/59e6382e0dfb9760308932.png"><br><br>  El programa para el carrito est√° escrito en C y no deber√≠a causar grandes dificultades de comprensi√≥n.  Constantemente estamos escribiendo un nuevo valor de velocidad en los registros PWM del controlador, y da se√±ales a los motores.  Hay un circuito de retroalimentaci√≥n en el ADC interno del microcontrolador.  Cuando el voltaje de la bater√≠a disminuye, la velocidad aumenta mediante programaci√≥n.  Debido a esto, hasta el descenso completo, el carro se desplaza a una velocidad constante.  La conclusi√≥n es que cuanto m√°s denso es el llenado de PWM, m√°s r√°pido giran los motores, pero como el voltaje de la bater√≠a cae con el tiempo, giran m√°s lentamente.  Luego, el llenado de PWM aumenta y giran nuevamente m√°s r√°pido.  Y as√≠, hasta que el llenado PWM sea del 100%, es decir, la salida ser√° constantemente l√≥gica "1".  No hay nada que puedas hacer al respecto.  Para cargar! <br><br><div class="spoiler">  <b class="spoiler_title">Programa C para el microcontrolador AVRmega328P</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * TWO_WEELS_ROBOT_NEW.c * * Created: 22.09.2017 23:48:49 * Author : User */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> F_CPU 16000000 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/io.h&gt; #include &lt;stdint.h&gt;//    #include &lt;avr/interrupt.h&gt; #include &lt;math.h&gt; //  #include &lt;stdio.h&gt; // - #include &lt;setjmp.h&gt; #include &lt;stdlib.h&gt; //  volatile uint8_t Speed_of_ADC_conversion=0; volatile uint8_t U_BATTERY; //        volatile uint8_t avr_speed=30;//  ,        //  8      - 110 //  ,  53.  10   volatile uint8_t komanda_s_kompa = 0; volatile uint8_t transmition_ready = 0; volatile uint8_t wheel_counter=0; #define Left_Speed OCR0A //    #define Right_Speed OCR0B //    void time_delay(long dell)//     //     { long i; cli(); sei(); dell=dell*1500; for(i=0;i&lt;dell;i++){;;}; } ISR(USART_RX_vect) //    UART { komanda_s_kompa=UDR0; } ISR(PCINT1_vect )//PC2 int 10 //    { transmition_ready=1; wheel_counter++; } ISR(TIMER0_OVF_vect)//      30 , //     ,       90  { Speed_of_ADC_conversion++; if (Speed_of_ADC_conversion&lt;2) {ADCSRA |=(1&lt;&lt;ADSC);}//   if(Speed_of_ADC_conversion&gt;2)//    { ADCSRA &amp;=~(1&lt;&lt;ADSC); Speed_of_ADC_conversion=0; U_BATTERY = ADCH;////    //      ,   1/3  //         //.  U = 8  (2   - LN298 1 ) = 7  / 2 //  3,5 ..      ,      1  if(U_BATTERY&lt;=avr_speed)//   {Right_Speed++;//   -  ,    Left_Speed++;} else {Right_Speed--;//  ,   Left_Speed--;} } } void stop() { PORTD|=(1&lt;&lt;PORTD3); PORTD|=(1&lt;&lt;PORTD2); PORTD|=(1&lt;&lt;PORTD4); PORTD|=(1&lt;&lt;PORTD7); } void go_left() { PORTD|=(1&lt;&lt;PORTD3);//   PORTD&amp;=~(1&lt;&lt;PORTD2); PORTD|=(1&lt;&lt;PORTD4);//   PORTD&amp;=~(1&lt;&lt;PORTD7); } void go_right() { PORTD|=(1&lt;&lt;PORTD2);//   PORTD&amp;=~(1&lt;&lt;PORTD3); PORTD|=(1&lt;&lt;PORTD7);//  PORTD&amp;=~(1&lt;&lt;PORTD4); } void go_ahead()//   { PORTD|=(1&lt;&lt;PORTD3);//  PORTD&amp;=~(1&lt;&lt;PORTD2); PORTD|=(1&lt;&lt;PORTD7);// PORTD&amp;=~(1&lt;&lt;PORTD4); } void go_back()//   { PORTD|=(1&lt;&lt;PORTD2);//   PORTD&amp;=~(1&lt;&lt;PORTD3); PORTD|=(1&lt;&lt;PORTD4);//   PORTD&amp;=~(1&lt;&lt;PORTD7); } int main(void) { cli(); // UART  9600 UCSR0A=0; UCSR0B=0b10011000; UCSR0C=0b00000110; UBRR0L=103; UBRR0H=0; //   INT0   2   10 PCICR|=(1&lt;&lt;PCIE1);//   14-8 PCMSK1|=(1&lt;&lt;PCINT10);//    INT10 DDRC&amp;=~(1&lt;&lt;PORTC2); //        PORTC|=(1&lt;&lt;PORTC2); //      ADC1, ADMUX= 0b01100001; // V ref  5 ,   ADC1     ,  2 ADCSRA=0b10010110;//       ADCSRB=0; DDRC&amp;=~(1&lt;&lt;PORTC1);// / //   0       ,  B  TCCR0A |=(1&lt;&lt;COM0A1)|(1&lt;&lt;COM0B1);//   TCCR0A &amp;=~(1&lt;&lt;COM0A0)&amp;~(1&lt;&lt;COM0B0); TCCR0A |=(1&lt;&lt;WGM00); TCCR0B &amp;=~(1&lt;&lt;WGM02)&amp;~(1&lt;&lt;WGM01);//   c   TCCR0B|=0b00000101; //   30  // CS02 CS01 CS00 - 000 - ; 001  ; 010 c  8; // 011 -64; 100 -256; 101 -1024 TIMSK0|=(1&lt;&lt;TOIE0);//    0   DDRB|=(1&lt;&lt;5);//    DDRD=0b11111110; //       , RX   PORTD&amp;=~(1&lt;&lt;PORTD5)&amp;~(1&lt;&lt;PORTD6); //     Left_Speed=10;//        Right_Speed=10;//      ( 8-12 ) sei(); PORTB |=(1&lt;&lt;5);//   time_delay(500); PORTB &amp;=~(1&lt;&lt;5); time_delay(500); PORTB |=(1&lt;&lt;5); time_delay(500); PORTB &amp;=~(1&lt;&lt;5); time_delay(500); PORTB |=(1&lt;&lt;5); while (1) { if( (UDRE0)){ if(transmition_ready==1)//      { UDR0=wheel_counter; transmition_ready=0; } } switch (komanda_s_kompa) { case 2: go_right(); break; case 1: go_left(); break; case 3: go_ahead(); break; case 4: go_back(); break; case 5: avr_speed++; if (avr_speed&gt;100) { avr_speed=100; } time_delay(200); //  break; case 6: avr_speed--; if (avr_speed&lt;0) { avr_speed=0; } time_delay(200);//  break; case 0: stop(); break; } } }</span></span></span></span></code> </pre> <br></div></div><br>  La ruta atravesada se considera un interruptor de l√°minas, que lanza una interrupci√≥n externa INT10.  Tan pronto como se incrementa la ruta, los datos se vierten inmediatamente en el UART.  En consecuencia, las se√±ales de control (adelante, atr√°s, izquierda, derecha, gas, freno, parada) provienen del UART en la direcci√≥n opuesta. <br><br>  Tenga en cuenta que los motores chinos son ruidosos con una potencia terrible, por lo que no ayudan los condensadores de potencia.  En el circuito de l√°minas, se induce tal interferencia que parece que su carro est√° participando en la F√≥rmula 1 en t√©rminos de velocidad de la ruta.  Ahorra, solo un condensador de 22 nF en la entrada de una interrupci√≥n externa se traga esta interferencia. <br><br>  El programa de direcci√≥n del carro en s√≠ fue tomado de un art√≠culo anterior, donde anteriormente hab√≠a operado con un brazo mec√°nico.  Solo se hicieron peque√±as adiciones: dos cuadros de texto, donde puede ver en tiempo real, los datos recibidos y enviados (1,2,3,4,5,6,0 - adelante, derecha, izquierda, atr√°s, gas, freno, parada) , as√≠ como la capacidad de editar y guardar la direcci√≥n IP del m√≥dulo ESP a trav√©s de la GUI y el bot√≥n "Conectar".  Controlamos el carrito con las flechas desde el teclado o con el mouse en la ventana.  Es cierto, dado que todos los botones est√°n en un ciclo, cambiar la velocidad y la direcci√≥n al mismo tiempo no funcionar√°, solo uno a la vez.  Pero, por supuesto, esto es solo porque el programa es una demostraci√≥n. <br><br><img src="https://habrastorage.org/webt/59/e6/2f/59e62fee675d1509154701.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El archivo ejecutable para Windows de 64 bits</a> .  Puede extraer el c√≥digo Java de √©l.  O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enfr√©ntate</a> al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github</a> . <br><br>  Ahora que el programador y el intercambio de datos han sido probados (en general, probablemente, he flasheado AVR a trav√©s de WI-FI al menos cien veces de esta manera), entonces podemos volver a la pregunta de por qu√© eleg√≠ este camino por m√≠ mismo, y no esp-link. <br><br>  Entonces, comencemos con la instalaci√≥n. <br><br>  Parpadear el m√≥dulo ESP es un poco m√°s complicado que el de un competidor.  Primero cosimos NodeMCU, luego llenamos el gestor de arranque en el LUA.  En esp-link cosimos solo un firmware.  Pero el tiempo que pasamos aqu√≠ es de una sola vez.  En el futuro, no tocamos el m√≥dulo ESP.  Por otro lado, en nuestro caso, podemos terminar mi programa de roble en LUA, como queramos, agregar nuestros propios m√≥dulos, etc.  etc.  Con esp-link es m√°s dif√≠cil.  All√≠, el conocimiento de los conceptos b√°sicos de LUA y la API NodeMCU ya no funcionar√°. <br><br>  En el lado de la computadora, todos los beneficios de BABUINO.  Simplemente ejecute el ejecutable y trabaje.  Incluso un entorno JAVA no es necesario si tiene una versi√≥n de Windows de 64 bits (pero luego necesita un disco de 200 MB).  Y si tiene Linux o Mac OS, puede consultar el eslogan de Oracle sobre su Java, "Est√° escrito en un lugar, funciona en todas partes", porque la m√°quina virtual Java y el c√≥digo de bytes son los mismos.  Pero, para ser sincero, no lo comprob√©, no lo s√©. <br><br>  Con esp-link encontrar√°s bailes nobles con panderetas, seg√∫n la instalaci√≥n del gerente de Tibbo (lo s√© por experiencia).  Este es un programa para soportar el puerto COM virtual.  Requiere ajustar un mont√≥n de par√°metros y una presencia constante en el sistema.  Inmediatamente improbable que funcione, prep√°rate.  Luego, a trav√©s del navegador, debe configurar el m√≥dulo ESP en s√≠.  Es importante en todas partes, incluso en Tibbo, establecer las tasas de intercambio de datos correctas y cualquier bit de parada y paridad. <br><br>  Despu√©s de eso, ya a trav√©s del Arduino Uploader est√°ndar (desde el que duermo ... tom√© el dise√±o) o a trav√©s del Arduino IDE (nuevamente configurando COM), comenzamos a cargar el programa muy AVO.  No, realmente, realmente se carga para siempre.  Incluso si es peque√±o.  Puedes ir a hacer t√© durante este tiempo.  El signo negativo se cae peri√≥dicamente, dej√°ndolo completamente perdido en cuanto a por qu√© no se realiz√≥ la descarga.  Y luego solo hay una salida: reiniciar, reiniciar, reiniciar, reiniciar ... <br><br>  Y BABUINO lanza mucho m√°s r√°pido, como un programador SPI normal (y los archivos que caben en un paquete de 1024 bytes son generalmente instant√°neos).  Es cierto que no se verifica.  Pero esto es reparable y de todos modos no tomar√° mucho tiempo, ya que se llevar√° a cabo simult√°neamente con el firmware (una buena caracter√≠stica del protocolo SPI).  Adem√°s, tenemos acceso a todos los comandos de programaci√≥n SPI: fusibles y bits de bloqueo, firmware EEPROM, etc.  Y si la grabaci√≥n falla, entonces ver√° todas las razones en el cuadro de texto.  <i>Nota</i>  <i>Los comandos est√°n disponibles, pero a√∫n no hay implementaci√≥n.</i>  <i>Ups</i> <br><br>  Esto es para programaci√≥n inal√°mbrica.  Ahora pasemos a la transferencia de datos.  En este sentido, no utilic√© esp-link, por lo que mi razonamiento ser√° puramente te√≥rico. <br><br>  Entonces, esp-link usa hasta donde yo s√© el protocolo MQTT.  En esencia, esto es solo una abstracci√≥n del siguiente nivel sobre TCP. <br><br><img src="https://habrastorage.org/webt/59/e6/30/59e630d68bd58205138107.png"><br><br>  Sin entrar en sutilezas, veamos por qu√© es necesario. <br><br>  Bueno, por ejemplo, cuando tienes muchos dispositivos en alg√∫n tipo de hogar inteligente que funcionan con este protocolo.  Cuando tienes algo, va a la nube y regresa.  Cuando se integra en alg√∫n tipo de red que se ejecuta en MQTT.  Cuando tiene un proyecto conjunto, para no inventar algo propio, sino utilizar algo ya conocido y colegas conocidos. <br><br>  Y si solo necesita enviar el flujo de bytes de vuelta all√≠ sin cables, entonces, ¬øpara usted qu√© dificultades tiene?  ¬øPor qu√© apilar otro protocolo desde arriba? <br><br>  Aunque, por supuesto, no niego la utilidad de los protocolos MQTT en general e incluso trato de integrar su soporte en mi cargador de arranque-intercambiador en los siguientes desarrollos y art√≠culos.  Pero aunque no lo necesito, buscaremos m√°s.  Y si lo necesitas, decide por ti mismo. <br><br>  Mientras tanto, mi carrito gira obedientemente las ruedas en la direcci√≥n correcta y env√≠a telemetr√≠a de la distancia recorrida a la computadora (tenga en cuenta que el firewall de la computadora puede no permitir paquetes con ESP).  La pr√≥xima vez intentaremos controlarlo desde un tel√©fono m√≥vil.  Trat√© de equilibrarlo sobre dos ruedas desde el teclado, pero la experiencia no tuvo √©xito.  Existe la idea de utilizar los aceler√≥metros de un tel√©fono inteligente para esto (intent√© usar una placa separada con un giroscopio y un aceler√≥metro, pero no despeg√≥). <br><br>  Volvamos a la segunda pregunta, que se plante√≥ repetidamente durante la discusi√≥n del art√≠culo en los comentarios.  ‚Äú¬øPor qu√© no hacer todo en ESP?  Ella puede!  Y dejemos que AVR sea como un expansor de puerto y suficiente de √©l ‚Äù. <br><br>  ¬°Por supuesto que puede!  Aunque todo es lo mismo, como puede ver, AVR es indispensable. <br><br>  S√≠, ella puede si: <br><br>  1. Usted es un programador hereditario orientado a objetos al que le encanta envolverse en todo tipo de envoltorios, hacer devoluciones de llamada y no imaginar la vida sin tablas meta. <br><br>  2. Conoces bien los detalles del trabajo de diferentes sistemas operativos.  Y solo escupe para aprender que el nuevo sistema operativo ahora es RT (en tiempo real), sus llamadas al sistema y bibliotecas <s>escritas por los chinos para un plato de arroz.</s> <br><br>  3. En la universidad, su conocimiento de los microcontroladores se limitaba a uno o dos trabajos de laboratorio, y ni siquiera desea conocer los bits y perif√©ricos all√≠.  Y, en general, para PWM, por ejemplo, es m√°s f√°cil para usted tomar una biblioteca de software que usar algo de hardware all√≠. <br><br>  4. No necesita una respuesta del dispositivo en microsegundos.  No, por supuesto, RTOS puede intentar proporcionarlo, ya que es un sistema operativo en tiempo real.  Pero no el hecho de que proporcionar√°. <br><br>  5. No tiene cientos de kilobytes de c√≥digo ya escrito y, lo que es m√°s importante, ya funciona sin fallas en AVR y no necesita portarlo y depurarlo en consecuencia, pero es m√°s f√°cil escribir en el SDK nativo (que tambi√©n necesita aprender a escupir usando fuentes en ingl√©s) desde cero. <br><br>  Entonces si.  No leas este art√≠culo.  Y lo m√°s importante, <s>no escriba comentarios.</s> <br><br>  Pero si: <br><br>  1. Has estado jugando con microcontroladores durante muchos a√±os y conoces su arquitectura de memoria. <br><br>  2. No necesita errores de origen <s>chino</s> incomprensible. <br><br>  3. Ha escrito y depurado megabytes de c√≥digo para su larga vida como desarrollador, y no desea volver a escribir y depurar todo nuevamente. <br><br>  4. No tiene el tiempo o el deseo de aprender <s>en el idioma de un posible adversario el</s> SDK y RTOS nativos de una compa√±√≠a <s>no muy</s> conocida en el mundo (todav√≠a no es Microsoft), y tambi√©n esperar y creer en sus parches y actualizaciones. <br><br>  5. Al programar, no ha salido especialmente para "comenzar si luego hacer mientras cambia al final", y considera que las palabras funci√≥n lambda y corutina son latinas obscenas. <br><br>  6. De hecho, para su dispositivo que ya funciona, pero de acuerdo con las tendencias de los nuevos tiempos, solo necesita un puente inal√°mbrico para identificaci√≥n, programaci√≥n e intercambio de datos. <br><br>  Bueno, usa el ESP8266 para esto.  Como un puente inal√°mbrico.  Ellos, ya sabes, usan AVR como un expansor de puertos para ESP.  ¬°Y haremos lo contrario! <br><br><img src="https://habrastorage.org/webt/59/e6/39/59e6391b09b52099089002.jpeg"><br><br>  De hecho, no tome mis √∫ltimas declaraciones demasiado en serio.  Esto es esencialmente solo una broma.  Cualquier desarrollador con suficiente experiencia toma su decisi√≥n en funci√≥n de muchos factores, como la velocidad y los par√°metros de consumo de energ√≠a, el ciclo de vida del dispositivo, la continuidad con los logros pasados, el costo del producto en s√≠ y el costo de la transferencia a una nueva plataforma, confiabilidad, el tiempo requerido para estudiar nuevas arquitecturas, SDK, sistemas operativos, la presencia de empleados con tal experiencia en un proyecto conjunto, etc. <br><br>  Por lo tanto, es mejor cuando: <br><br><img src="https://habrastorage.org/webt/59/e6/32/59e63221bec16157434858.jpeg"><br><br>  Me gustar√≠a que te gustara el art√≠culo.  No doy bibliograf√≠as, es lo mismo que en el art√≠culo anterior. <br><br>  PS <br><br>  Y finalmente, sobre las se√±ales del espacio.  Todo el secreto es que al m√≥dulo ESP con firmware NodeMCU realmente le gusta enviar todo tipo de informaci√≥n a la consola.  Por ejemplo, despu√©s de un reinicio de emergencia (y sucede a veces en ESP, cr√©anme, la glucosa sigue siendo la misma).  O, por ejemplo, si olvid√≥ eliminar print ("algo all√≠") del programa en Lu despu√©s de la depuraci√≥n.  O cuando aparece la API en desuso (en desuso) (usted cambi√≥ el firmware y ahora deber√≠a usar una nueva ortograf√≠a, por ejemplo, al iniciar el servidor UDP) y ESP siempre le recordar√° esto.  Hasta que reescribas el c√≥digo. <br><br>  Y el problema es que todo esto se env√≠a de manera precisa y met√≥dica a la consola, es decir, al puerto UART.  Bueno, ¬øqu√© pasa si su puerto UART est√° esperando un comando o datos en este momento para decirle a su carro que contin√∫e?  <s>Entonces su carro puede caerse de la mesa.</s> <br>  Entonces, este punto tambi√©n vale la pena considerar. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es407485/">https://habr.com/ru/post/es407485/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es407475/index.html">¬øPuede Starry Beam matar fibra?</a></li>
<li><a href="../es407477/index.html">Las ideas m√°s originales de ICO este oto√±o</a></li>
<li><a href="../es407479/index.html">Emulador de unidad para Atari en Arduino</a></li>
<li><a href="../es407481/index.html">¬øPor qu√© todos aprendemos el idioma durante a√±os, pero no podemos aprender?</a></li>
<li><a href="../es407483/index.html">Aprendiendo rob√≥tica y los comienzos de la programaci√≥n con droides y dise√±adores de Star Wars</a></li>
<li><a href="../es407487/index.html">Microsoft regresar√° 2007 con el nuevo dise√±o fluido</a></li>
<li><a href="../es407491/index.html">Prometemos que ser√° interesante.</a></li>
<li><a href="../es407493/index.html">Rusia y China emitir√°n criptomonedas nacionales. Pero por que?</a></li>
<li><a href="../es407495/index.html">¬øQui√©n se convertir√° en el l√≠der en la carrera de comercio electr√≥nico del futuro?</a></li>
<li><a href="../es407497/index.html">Roscosmos se encarg√≥ de la construcci√≥n de un m√≥dulo de bloqueo en la Estaci√≥n Orbital Lunar Internacional</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>