<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ§‘ğŸ½â€ğŸ¤â€ğŸ§‘ğŸ½ ğŸ® â˜ğŸ½ ä¸ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä»¥åŠä½•æ—¶ä½¿ç”¨ValueTask ğŸ§‘ ğŸ‘©ğŸ¾â€ğŸ”§ âœ‚ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ„Ÿè°¢è‰¯å¥½çš„è¯„è®º0x1000000æ¥å®Œæˆäº†æ­¤ç¿»è¯‘ã€‚ 
 




 .NET Framework 4å¼•å…¥äº†System.Threading.Tasksç©ºé—´ä»¥åŠTaskç±»ã€‚ è¿™ç§ç±»å‹ä»¥åŠå®ƒç”Ÿæˆçš„Task <TResult>å·²ç»ç­‰å¾…äº†å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°å®ƒä»¬è¢«.NETä¸­çš„æ ‡å‡†è¯†åˆ«ä¸ºCï¼ƒ5ä¸­é€šè¿‡å…¶async / ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸ºä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä»¥åŠä½•æ—¶ä½¿ç”¨ValueTask</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458828/"><p>  <sup>æ„Ÿè°¢è‰¯å¥½çš„è¯„è®º<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" class="user_link">0x1000000</a>æ¥å®Œæˆäº†æ­¤ç¿»è¯‘ã€‚</sup> <sup><br></sup> </p><p><img src="https://habrastorage.org/webt/4t/kr/wh/4tkrwhp_br-sobqvgwwyimflsjq.jpeg" alt="å›¾ç‰‡"></p><br><p>  .NET Framework 4å¼•å…¥äº†System.Threading.Tasksç©ºé—´ä»¥åŠTaskç±»ã€‚ è¿™ç§ç±»å‹ä»¥åŠå®ƒç”Ÿæˆçš„Task &lt;TResult&gt;å·²ç»ç­‰å¾…äº†å¾ˆé•¿æ—¶é—´ï¼Œç›´åˆ°å®ƒä»¬è¢«.NETä¸­çš„æ ‡å‡†è¯†åˆ«ä¸ºCï¼ƒ5ä¸­é€šè¿‡å…¶async / awaitè¯­å¥å¼•å…¥çš„å¼‚æ­¥ç¼–ç¨‹æ¨¡å‹çš„å…³é”®æ–¹é¢ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†è®¨è®ºValueTask / ValueTask &lt;TResult&gt;çš„æ–°ç±»å‹ï¼Œè¿™äº›ç±»å‹æ—¨åœ¨åœ¨åº”è€ƒè™‘å†…å­˜åˆ†é…å¼€é”€çš„æƒ…å†µä¸‹æé«˜å¼‚æ­¥æ–¹æ³•çš„æ€§èƒ½ã€‚ </p><a name="habracut"></a><br><h3 id="task"> å·¥ä½œä»»åŠ¡ </h3><br><p>ä»»åŠ¡æ‰®æ¼”ç€ä¸åŒçš„è§’è‰²ï¼Œä½†ä¸»è¦ä»»åŠ¡æ˜¯â€œæ‰¿è¯ºâ€ï¼ˆpromiseï¼‰ï¼Œå®ƒæ˜¯è¡¨ç¤ºæŸäº›æ“ä½œå¯èƒ½å®Œæˆçš„å¯¹è±¡ã€‚ æ‚¨å¯åŠ¨ä¸€ä¸ªæ“ä½œå¹¶ä¸ºå…¶è·å–ä¸€ä¸ªTaskå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å°†åœ¨æ“ä½œå®Œæˆåæ‰§è¡Œï¼Œè¿™å¯ä»¥åœ¨åŒæ­¥æ¨¡å¼ä¸‹ä½œä¸ºæ“ä½œåˆå§‹åŒ–çš„ä¸€éƒ¨åˆ†å‘ç”Ÿï¼ˆä¾‹å¦‚ï¼Œæ¥æ”¶ç¼“å†²åŒºä¸­å·²ç»å­˜åœ¨çš„æ•°æ®ï¼‰ï¼Œè€Œåœ¨å¼‚æ­¥æ¨¡å¼ä¸‹åˆ™åœ¨æ‰§è¡Œæ—¶æ‚¨å°†è·å¾—Taskï¼ˆä¸æ˜¯ä»ç¼“å†²åŒºæ¥æ”¶æ•°æ®ï¼Œè€Œæ˜¯éå¸¸å¿«é€Ÿåœ°æ¥æ”¶æ•°æ®ï¼‰ï¼Œæˆ–è€…åœ¨å¼‚æ­¥æ¨¡å¼ä¸‹ï¼Œä½†æ˜¯åœ¨æ‹¥æœ‰Taskï¼ˆä»è¿œç¨‹èµ„æºæ¥æ”¶æ•°æ®ï¼‰ä¹‹åï¼Œå¾—åˆ°Taskã€‚ ç”±äºè¯¥æ“ä½œå¯ä»¥å¼‚æ­¥ç»“æŸï¼Œå› æ­¤æ‚¨å¯ä»¥é˜»æ­¢æ‰§è¡Œæµç¨‹ï¼Œç­‰å¾…ç»“æœï¼ˆè¿™é€šå¸¸ä½¿è°ƒç”¨çš„å¼‚æ­¥æ€§å˜å¾—æ¯«æ— æ„ä¹‰ï¼‰ï¼Œæˆ–è€…åˆ›å»ºä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œè¯¥å‡½æ•°å°†åœ¨æ“ä½œå®Œæˆåè¢«æ¿€æ´»ã€‚ åœ¨.Net 4ä¸­ï¼Œå›è°ƒçš„åˆ›å»ºæ˜¯é€šè¿‡Taskå¯¹è±¡çš„ContinueWithæ–¹æ³•å®ç°çš„ï¼Œè¯¥æ–¹æ³•é€šè¿‡åœ¨æ‰§è¡ŒTaskä¹‹åæ¥å—å§”æ‰˜å‡½æ•°æ¥è¿è¡Œæ¥æ˜¾å¼æ¼”ç¤ºæ­¤æ¨¡å‹ï¼š </p><br><pre><code class="plaintext hljs">SomeOperationAsync().ContinueWith(task =&gt; { try { TResult result = task.Result; UseResult(result); } catch (Exception e) { HandleException(e); } });</code> </pre> <br><p> ä½†æ˜¯åœ¨.NET Framework 4.5å’ŒCï¼ƒ5ä¸­ï¼Œä»»åŠ¡å¯¹è±¡å¯ä»¥ç®€å•åœ°ç”±awaitè¿ç®—ç¬¦è°ƒç”¨ï¼Œè¿™ä½¿å¾—è·å–å¼‚æ­¥æ“ä½œçš„ç»“æœå˜å¾—å®¹æ˜“ï¼Œå¹¶ä¸”å½“æ“ä½œä»¥åŒæ­¥æ¨¡å¼ï¼Œå¿«é€Ÿå¼‚æ­¥æˆ–å¿«é€Ÿå®Œæˆæ—¶ï¼Œé’ˆå¯¹ä¸Šè¿°é€‰é¡¹è¿›è¡Œä¼˜åŒ–çš„ç”Ÿæˆä»£ç å°†åœ¨æ‰€æœ‰æƒ…å†µä¸‹å‡èƒ½æ­£å¸¸å·¥ä½œã€‚ä¸ä½¿callbackaå¼‚æ­¥ï¼š </p><br><pre> <code class="plaintext hljs">TResult result = await SomeOperationAsync(); UseResult(result);</code> </pre> <br><p> ä»»åŠ¡æ˜¯ä¸€ä¸ªéå¸¸çµæ´»çš„ç±»ï¼Œå®ƒå…·æœ‰è®¸å¤šä¼˜ç‚¹ã€‚ ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ä¸€æ¬¡å¯¹ä»»æ„æ•°é‡çš„ä½¿ç”¨è€…æ‰§è¡Œå¤šæ¬¡ç­‰å¾…ã€‚ æ‚¨å¯ä»¥å°†å…¶æ”¾å…¥é›†åˆï¼ˆå­—å…¸ï¼‰ä¸­ï¼Œä»¥å¤‡å°†æ¥é‡å¤ä½¿ç”¨ï¼Œä»¥å°†å…¶ç”¨ä½œå¼‚æ­¥è°ƒç”¨ç»“æœçš„ç¼“å­˜ã€‚ å¦‚æœéœ€è¦ï¼Œæ‚¨å¯ä»¥åœ¨ç­‰å¾…Taskå®Œæˆçš„åŒæ—¶é˜»æ­¢æ‰§è¡Œã€‚ æ‚¨å¯ä»¥åœ¨Taskå¯¹è±¡ï¼ˆæœ‰æ—¶ç§°ä¸ºâ€œç»„åˆå™¨â€ï¼‰ä¸Šç¼–å†™å¹¶åº”ç”¨å„ç§æ“ä½œï¼Œä¾‹å¦‚ï¼Œâ€œ when any whenâ€ï¼ˆå¼‚æ­¥ï¼‰ç­‰å¾…å¤šä¸ªTaskçš„é¦–æ¬¡å®Œæˆã€‚ <br> ä½†æ˜¯åœ¨æœ€å¸¸è§çš„æƒ…å†µä¸‹ï¼Œè¿™ç§çµæ´»æ€§å˜å¾—å¤šä½™ï¼šåªéœ€è°ƒç”¨å¼‚æ­¥æ“ä½œå¹¶ç­‰å¾…ä»»åŠ¡å®Œæˆå³å¯ï¼š </p><br><pre> <code class="plaintext hljs">TResult result = await SomeOperationAsync(); UseResult(result);</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä¸éœ€è¦ç­‰å¾…æ‰§è¡Œå¤šæ¬¡ã€‚ æˆ‘ä»¬æ— éœ€ç¡®ä¿æœŸæœ›å…·æœ‰ç«äº‰åŠ›ã€‚ æˆ‘ä»¬ä¸éœ€è¦æ‰§è¡ŒåŒæ­¥é”å®šã€‚ æˆ‘ä»¬ä¸ä¼šç¼–å†™ç»„åˆå™¨ã€‚ æˆ‘ä»¬åªæ˜¯åœ¨ç­‰å¾…å¼‚æ­¥æ“ä½œçš„å®Œæˆã€‚ æœ€åï¼Œè¿™å°±æ˜¯æˆ‘ä»¬ç¼–å†™åŒæ­¥ä»£ç çš„æ–¹å¼ï¼ˆä¾‹å¦‚ï¼ŒTResultç»“æœ= SomeOperationï¼ˆï¼‰;ï¼‰ï¼Œå¹¶ä¸”é€šå¸¸å°†å…¶è½¬æ¢ä¸ºasync / awaitã€‚ </p><br><p> æ­¤å¤–ï¼ŒTaskå…·æœ‰æ½œåœ¨çš„å¼±ç‚¹ï¼Œå°¤å…¶æ˜¯åœ¨åˆ›å»ºå¤§é‡å®ä¾‹æ—¶ï¼Œé«˜ååé‡å’Œé«˜æ€§èƒ½æ˜¯å…³é”®è¦æ±‚-Taskæ˜¯ä¸€ç±»â€‹â€‹ã€‚ è¿™æ„å‘³ç€ä»»ä½•éœ€è¦æ‰§è¡ŒTaskçš„æ“ä½œéƒ½è¢«è¿«åˆ›å»ºå’Œæ”¾ç½®ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä¸”åˆ›å»ºçš„å¯¹è±¡è¶Šå¤šï¼Œåƒåœ¾æ”¶é›†å™¨ï¼ˆGCï¼‰æ‰€éœ€çš„å·¥ä½œå°±è¶Šå¤šï¼Œå¹¶ä¸”è¿™é¡¹å·¥ä½œæ¶ˆè€—äº†æˆ‘ä»¬å¯ä»¥èŠ±åœ¨æ›´å¤šäº‹æƒ…ä¸Šçš„èµ„æºã€‚æœ‰ç”¨çš„ã€‚ </p><br><p> åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿è¡Œæ—¶åº“å’Œç³»ç»Ÿåº“æœ‰åŠ©äºç¼“è§£æ­¤é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬ç¼–å†™è¿™æ ·çš„æ–¹æ³•ï¼š </p><br><pre> <code class="plaintext hljs">public async Task WriteAsync(byte value) { if (_bufferedCount == _buffer.Length) { await FlushAsync(); } _buffer[_bufferedCount++] = value; }</code> </pre> <br><p> é€šå¸¸ï¼Œç¼“å†²åŒºä¸­å°†æœ‰è¶³å¤Ÿçš„å¯ç”¨ç©ºé—´ï¼Œå¹¶ä¸”è¯¥æ“ä½œå°†åŒæ­¥æ‰§è¡Œã€‚ å‘ç”Ÿè¿™ç§æƒ…å†µæ—¶ï¼Œæ— éœ€æ‰§è¡Œä»»ä½•åº”è¿”å›çš„Taskä»»åŠ¡ï¼Œå› ä¸ºæ²¡æœ‰è¿”å›å€¼ï¼Œå› æ­¤ä½¿ç”¨Taskç­‰æ•ˆäºè¿”å›ç©ºå€¼ï¼ˆæ— æ•ˆï¼‰çš„åŒæ­¥æ–¹æ³•ã€‚ å› æ­¤ï¼Œç¯å¢ƒå¯ä»¥ç®€å•åœ°ç¼“å­˜ä¸€ä¸ªéæ³›å‹Taskå¹¶ä½œä¸ºå¯¹ä»»ä½•åŒæ­¥å®Œæˆçš„å¼‚æ­¥æ–¹æ³•çš„æ‰§è¡Œç»“æœä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨å®ƒï¼ˆå¯ä»¥é€šè¿‡Task.CompletedTaskè·å¾—æ­¤ç¼“å­˜çš„å•ä¾‹ï¼‰ã€‚ æˆ–è€…ï¼Œä¾‹å¦‚ï¼Œæ‚¨ç¼–å†™ï¼š </p><br><pre> <code class="plaintext hljs">public async Task&lt;bool&gt; MoveNextAsync() { if (_bufferedCount == 0) { await FillBuffer(); } return _bufferedCount &gt; 0; }</code> </pre> <br><p> é€šå¸¸ï¼Œç”±äºæœŸæœ›æ•°æ®å·²ç»åœ¨ç¼“å†²åŒºä¸­ï¼Œå› æ­¤è¯¥æ–¹æ³•åªæ£€æŸ¥_bufferedCountçš„å€¼ï¼Œçœ‹å®ƒæ˜¯å¦å¤§äº0ï¼Œç„¶åè¿”å›trueï¼› å¹¶ä¸”ä»…å½“ç¼“å†²åŒºä¸­æ²¡æœ‰æ•°æ®æ—¶ï¼Œæ‰éœ€è¦æ‰§è¡Œå¼‚æ­¥æ“ä½œã€‚ è€Œä¸”ï¼Œç”±äºåªæœ‰ä¸¤ä¸ªå¯èƒ½çš„å¸ƒå°”ç±»å‹ç»“æœï¼ˆtrueå’Œfalseï¼‰ï¼Œæ‰€ä»¥ä»…éœ€è¦ä¸¤ä¸ªå¯èƒ½çš„Taskå¯¹è±¡æ¥è¡¨ç¤ºè¿™äº›ç»“æœï¼Œå› æ­¤ç¯å¢ƒå¯ä»¥ç¼“å­˜è¿™äº›å¯¹è±¡å¹¶ä»¥ç›¸åº”çš„å€¼è¿”å›å®ƒä»¬è€Œæ— éœ€åˆ†é…å†…å­˜ã€‚ ä»…åœ¨å¼‚æ­¥å®Œæˆçš„æƒ…å†µä¸‹ï¼Œè¯¥æ–¹æ³•æ‰éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„Taskï¼Œå› ä¸ºå°†éœ€è¦åœ¨çŸ¥é“æ“ä½œç»“æœä¹‹å‰å°†å…¶è¿”å›ã€‚ <br></p><p> è¯¥ç¯å¢ƒä¸ºå…¶ä»–ä¸€äº›ç±»å‹æä¾›äº†ç¼“å­˜ï¼Œä½†æ˜¯ç¼“å­˜æ‰€æœ‰å¯èƒ½çš„ç±»å‹æ˜¯ä¸ç°å®çš„ã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹æ–¹æ³•ï¼š </p><br><pre> <code class="plaintext hljs">public async Task&lt;int&gt; ReadNextByteAsync() { if (_bufferedCount == 0) { await FillBuffer(); } if (_bufferedCount == 0) { return -1; } _bufferedCount--; return _buffer[_position++]; }</code> </pre> <br><p> é€šå¸¸ä¹Ÿä¼šåŒæ­¥æ‰§è¡Œã€‚ ä½†æ˜¯ï¼Œä¸ç»“æœç±»å‹ä¸ºBooleançš„å˜ä½“ä¸åŒï¼Œæ­¤æ–¹æ³•è¿”å›Int32ï¼Œå…¶å€¼çº¦ä¸º40äº¿ï¼Œå¹¶ä¸”ç¼“å­˜Task &lt;int&gt;çš„æ‰€æœ‰å˜ä½“å°†éœ€è¦æ•°ç™¾GBçš„å†…å­˜ã€‚ è¯¥ç¯å¢ƒä¸ºTask &lt;int&gt;æä¾›äº†ä¸€ä¸ªå°çš„ç¼“å­˜ï¼Œä½†æ˜¯ä¸€ç»„éå¸¸æœ‰é™çš„å€¼ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ­¤æ–¹æ³•ä»¥è¿”å›å€¼4åŒæ­¥å®Œæˆï¼ˆæ•°æ®å·²ç»åœ¨ç¼“å†²åŒºä¸­ï¼‰ï¼Œå®ƒå°†æ˜¯ä¸€ä¸ªç¼“å­˜çš„Taskï¼Œä½†æ˜¯å¦‚æœè¿”å›å€¼42ï¼Œåˆ™éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„ä»»åŠ¡&lt;int&gt;ï¼Œç±»ä¼¼äºè°ƒç”¨Task.FromResultï¼ˆ42ï¼‰ã€‚ </p><br><p> è®¸å¤šåº“æ–¹æ³•å°è¯•é€šè¿‡æä¾›è‡ªå·±çš„ç¼“å­˜æ¥æ¶ˆé™¤è¿™ç§æƒ…å†µã€‚ ä¾‹å¦‚ï¼ŒMemoryStream.ReadAsyncæ–¹æ³•çš„.NET Framework 4.5ä¸­çš„é‡è½½åœ¨ä»å†…å­˜ä¸­è¯»å–æ•°æ®æ—¶æ€»æ˜¯åŒæ­¥ç»“æŸã€‚  ReadAsyncè¿”å›Task &lt;int&gt;ï¼Œå…¶ä¸­Int32ç»“æœæŒ‡ç¤ºå·²è¯»å–å¤šå°‘å­—èŠ‚ã€‚ æ­¤æ–¹æ³•é€šå¸¸åœ¨å¾ªç¯ä¸­ä½¿ç”¨ï¼Œæ¯ä¸ªè°ƒç”¨é€šå¸¸å…·æœ‰ç›¸åŒçš„æ‰€éœ€å­—èŠ‚æ•°ï¼Œå¹¶ä¸”é€šå¸¸å¯ä»¥å®Œå…¨æ»¡è¶³æ­¤éœ€æ±‚ã€‚ å› æ­¤ï¼Œå¯¹äºé‡å¤è°ƒç”¨ReadAsyncè€Œè¨€ï¼Œå¯ä»¥åˆç†åœ°é¢„æœŸTask &lt;int&gt;å°†ä»¥ä¸ä¸Šä¸€ä¸ªè°ƒç”¨ç›¸åŒçš„å€¼åŒæ­¥è¿”å›ã€‚ å› æ­¤ï¼ŒMemoryStreamä¸ºåœ¨ä¸Šä¸€æ¬¡æˆåŠŸè°ƒç”¨ä¸­è¿”å›çš„ä¸€ä¸ªå¯¹è±¡åˆ›å»ºä¸€ä¸ªç¼“å­˜ã€‚ åœ¨ä¸‹ä¸€ä¸ªè°ƒç”¨ä¸­ï¼Œå¦‚æœç»“æœé‡å¤ï¼Œå®ƒå°†è¿”å›ç¼“å­˜çš„å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™ä½¿ç”¨Task.FromResultåˆ›å»ºä¸€ä¸ªæ–°å¯¹è±¡ï¼Œå°†å…¶ä¿å­˜åˆ°ç¼“å­˜ä¸­å¹¶è¿”å›ã€‚ </p><br><p> ä½†æ˜¯ï¼Œåœ¨è®¸å¤šå…¶ä»–æƒ…å†µä¸‹ï¼Œæ“ä½œæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œä½†æ˜¯å¿…é¡»åˆ›å»ºTask &lt;TResult&gt;å¯¹è±¡ã€‚ </p><br><h4 id="valuetasktresult-i-sinhronnoe-vypolnenie">  ValueTask &lt;TResult&gt;å’ŒåŒæ­¥æ‰§è¡Œ </h4><br><p> æ‰€æœ‰è¿™ä¸€åˆ‡éƒ½éœ€è¦åœ¨.NET Core 2.0ä¸­å®ç°ä¸€ç§æ–°ç±»å‹ï¼Œè¯¥æ–°ç±»å‹åœ¨.NETçš„æ—©æœŸç‰ˆæœ¬ä¸­çš„NuGet System.Threading.Tasks.Extensionsï¼šValueTask &lt;TResult&gt;åŒ…ä¸­å¯ç”¨ã€‚ <br>  ValueTask &lt;TResult&gt;æ˜¯åœ¨.NET Core 2.0ä¸­åˆ›å»ºçš„ï¼Œå…¶ç»“æ„èƒ½å¤ŸåŒ…è£…TResultå’ŒTask &lt;TResult&gt;ã€‚ è¿™æ„å‘³ç€å¯ä»¥ä»asyncæ–¹æ³•è¿”å›å®ƒï¼Œå¹¶ä¸”å¦‚æœè¯¥æ–¹æ³•è¢«åŒæ­¥æˆåŠŸæ‰§è¡Œï¼Œåˆ™æ— éœ€åœ¨å †ä¸Šæ”¾ç½®ä»»ä½•å¯¹è±¡ï¼šæ‚¨å¯ä»¥ç®€å•åœ°ä½¿ç”¨å€¼TResultåˆå§‹åŒ–æ­¤ValueTask &lt;TResult&gt;ç»“æ„å¹¶è¿”å›å®ƒã€‚ ä»…åœ¨å¼‚æ­¥æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œå°†æ”¾ç½®Task &lt;TResult&gt;å¯¹è±¡ï¼ŒValueTask &lt;TResult&gt;å°†å¯¹å…¶è¿›è¡ŒåŒ…è£…ï¼ˆä¸ºæœ€å°åŒ–ç»“æ„çš„å¤§å°å¹¶ä¼˜åŒ–æˆåŠŸæ‰§è¡Œçš„æƒ…å†µï¼Œä»¥ä¸æ”¯æŒçš„å¼‚å¸¸ç»“å°¾çš„å¼‚æ­¥æ–¹æ³•ä¹Ÿå°†æ”¾ç½®Task &lt;TResult&gt;ï¼Œå› æ­¤ValueTask &lt;TResult&gt;ä¹Ÿä»…åŒ…è£…Task &lt;TResult&gt;ï¼Œå¹¶ä¸”ä¸ä¼šé™„å¸¦ç”¨äºå­˜å‚¨Exceptionçš„é™„åŠ å­—æ®µã€‚ </p><br><p> åŸºäºæ­¤ï¼ŒåƒMemoryStream.ReadAsyncè¿™æ ·çš„æ–¹æ³•ï¼Œä½†è¿”å›ValueTask &lt;int&gt;ï¼Œä¸åº”å¤„ç†ç¼“å­˜ï¼Œè€Œå¯ä»¥è¿™æ ·ç¼–å†™ï¼š </p><br><pre> <code class="plaintext hljs">public override ValueTask&lt;int&gt; ReadAsync(byte[] buffer, int offset, int count) { try { int bytesRead = Read(buffer, offset, count); return new ValueTask&lt;int&gt;(bytesRead); } catch (Exception e) { return new ValueTask&lt;int&gt;(Task.FromException&lt;int&gt;(e)); } }</code> </pre> <br><h4 id="valuetasktresult-i-asinhronnoe-vypolnenie">  ValueTask &lt;TResult&gt;å’Œå¼‚æ­¥æ‰§è¡Œ </h4><br><p> ç¼–å†™å¯ä»¥å¼‚æ­¥å®Œæˆçš„å¼‚æ­¥æ–¹æ³•è€Œæ— éœ€é¢å¤–æ”¾ç½®ç»“æœçš„èƒ½åŠ›æ˜¯ä¸€ä¸ªå·¨å¤§çš„èƒœåˆ©ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨.NET Core 2.0ä¸­æ·»åŠ ValueTask &lt;TResult&gt;çš„åŸå› ï¼Œç°åœ¨é€šè¿‡è¿”å›ValueTask &lt;TResult&gt;è€Œä¸æ˜¯Task &lt;TResult&gt;æ¥å®£å¸ƒå¯èƒ½åœ¨éœ€è¦æ€§èƒ½çš„åº”ç”¨ç¨‹åºä¸­ä½¿ç”¨çš„æ–°æ–¹æ³•ã€‚ ä¾‹å¦‚ï¼Œå½“æˆ‘ä»¬å‘.NET Core 2.1æ·»åŠ Streamç±»çš„æ–°ReadAsyncé‡è½½æ—¶ï¼Œä¸ºäº†èƒ½å¤Ÿä¼ é€’Memoryè€Œä¸æ˜¯byte []ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­è¿”å›ValueTask &lt;int&gt;ç±»å‹ã€‚ ä»¥è¿™ç§å½¢å¼ï¼Œå¯ä»¥ä»¥æ›´å°‘çš„å†…å­˜åˆ†é…æ¥ä½¿ç”¨Streamå¯¹è±¡ï¼ˆåœ¨å…¶ä¸­ï¼ŒReadAsyncæ–¹æ³•é€šå¸¸æ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œå¦‚MemoryStreamçš„å‰é¢çš„ç¤ºä¾‹ä¸€æ ·ï¼‰ã€‚ <br></p><p> ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨å¸¦å®½éå¸¸é«˜çš„æœåŠ¡æ—¶ï¼Œæˆ‘ä»¬ä»ç„¶å¸Œæœ›å°½å¯èƒ½é¿å…å†…å­˜åˆ†é…ï¼Œè¿™æ„å‘³ç€ä¹Ÿè¦å‡å°‘å’Œæ¶ˆé™¤å¼‚æ­¥æ‰§è¡Œè·¯å¾„ä¸Šçš„å†…å­˜åˆ†é…ã€‚ <br> åœ¨awaitæ¨¡å‹ä¸­ï¼Œå¯¹äºä»»ä½•å¼‚æ­¥å®Œæˆçš„æ“ä½œï¼Œæˆ‘ä»¬éƒ½éœ€è¦å…·æœ‰è¿”å›è¡¨ç¤ºè¯¥æ“ä½œå¯èƒ½å®Œæˆçš„å¯¹è±¡çš„èƒ½åŠ›ï¼šè°ƒç”¨æ–¹éœ€è¦é‡å®šå‘å°†åœ¨æ“ä½œç»“æŸæ—¶å¯åŠ¨çš„å›è°ƒï¼Œå¹¶ä¸”è¿™éœ€è¦å †ä¸­çš„å”¯ä¸€å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥ç”¨ä½œè¯¥å¯¹è±¡çš„ä¼ è¾“é€šé“ã€‚æ­¤ç‰¹å®šæ“ä½œã€‚ åŒæ—¶ï¼Œè¿™å¹¶ä¸æ„å‘³ç€è¯¥å¯¹è±¡åœ¨æ“ä½œå®Œæˆåæ˜¯å¦å°†è¢«é‡ç”¨ã€‚ å¦‚æœå¯ä»¥é‡å¤ä½¿ç”¨æ­¤å¯¹è±¡ï¼Œåˆ™APIå¯ä»¥ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªè¿™äº›å¯¹è±¡ç»„ç»‡ä¸€ä¸ªç¼“å­˜ï¼Œå¹¶å°†å…¶ç”¨äºé¡ºåºæ“ä½œï¼Œå³ä¸è¦å°†åŒä¸€ä¸ªå¯¹è±¡ç”¨äºå¤šä¸ªä¸­é—´å¼‚æ­¥æ“ä½œï¼Œè€Œæ˜¯å°†å…¶ç”¨äºéç«äº‰æ€§è®¿é—®ã€‚ <br> åœ¨.NET Core 2.1ä¸­ï¼ŒValueTask &lt;TResult&gt;ç±»å·²å¾—åˆ°å¢å¼ºï¼Œä»¥æ”¯æŒç±»ä¼¼çš„æ± åŒ–å’Œé‡ç”¨ã€‚ ä¿®è®¢åçš„ç±»ä¸ä»…å¯ä»¥åŒ…è£…TResultæˆ–Task &lt;TResult&gt;ï¼Œè¿˜å¯ä»¥åŒ…è£…æ–°çš„IValueTaskSource &lt;TResult&gt;æ¥å£ã€‚ è¯¥æ¥å£æä¾›äº†ä¸ValueTask &lt;TResult&gt;å¯¹è±¡ä¸€èµ·è¿›è¡Œå¼‚æ­¥æ“ä½œæ‰€éœ€çš„åŸºæœ¬åŠŸèƒ½ï¼Œä¸Task &lt;TResult&gt;çš„æ‰§è¡Œæ–¹å¼ç›¸åŒï¼š </p><br><pre> <code class="plaintext hljs">public interface IValueTaskSource&lt;out TResult&gt; { ValueTaskSourceStatus GetStatus(short token); void OnCompleted(Action&lt;object&gt; continuation, object state, short token, ValueTaskSourceOnCompletedFlags flags); TResult GetResult(short token); }</code> </pre> <br><p>  GetStatusæ–¹æ³•ç”¨äºå®ç°ValueTask &lt;TResult&gt; .IsCompletedä¹‹ç±»çš„å±æ€§ï¼Œè¯¥å±æ€§å°†è¿”å›æœ‰å…³æ‰§è¡Œå¼‚æ­¥æ“ä½œè¿˜æ˜¯å®Œæˆå¼‚æ­¥æ“ä½œä»¥åŠå®Œæˆæ–¹å¼ï¼ˆæˆåŠŸä¸å¦ï¼‰çš„ä¿¡æ¯ã€‚ ç­‰å¾…å¯¹è±¡ä½¿ç”¨OnCompletedæ–¹æ³•é™„åŠ ä¸€ä¸ªå›è°ƒï¼Œä»¥åœ¨æ“ä½œå®Œæˆåä»ç­‰å¾…ç‚¹ç»§ç»­æ‰§è¡Œã€‚ å¹¶ä¸”éœ€è¦GetResultæ–¹æ³•æ¥è·å–æ“ä½œçš„ç»“æœï¼Œå› æ­¤åœ¨æ“ä½œç»“æŸåï¼Œè°ƒç”¨æ–¹å¯ä»¥è·å–TResultå¯¹è±¡æˆ–ä¼ é€’ä»»ä½•å¼•å‘çš„å¼‚å¸¸ã€‚ </p><br><p> å¤§å¤šæ•°å¼€å‘äººå‘˜ä¸éœ€è¦æ­¤æ¥å£ï¼šæ–¹æ³•ä»…è¿”å›ValueTask &lt;TResult&gt;å¯¹è±¡ï¼Œå¯ä»¥å°†å…¶åˆ›å»ºä¸ºå®ç°æ­¤æ¥å£çš„å¯¹è±¡çš„åŒ…è£…ï¼Œè€Œè°ƒç”¨æ–¹æ³•å°†ä¿æŒåœ¨é»‘æš—çŠ¶æ€ã€‚ è¯¥æ¥å£é€‚ç”¨äºåœ¨ä½¿ç”¨æ€§èƒ½å…³é”®å‹APIæ—¶éœ€è¦é¿å…åˆ†é…å†…å­˜çš„å¼€å‘äººå‘˜ã€‚ </p><br><p>  .NET Core 2.1ä¸­æœ‰å‡ ä¸ªè¿™æ ·çš„APIçš„ç¤ºä¾‹ã€‚ æœ€è‘—åçš„æ–¹æ³•æ˜¯Socket.ReceiveAsyncå’ŒSocket.SendAsyncï¼Œä¾‹å¦‚åœ¨2.1ä¸­æ·»åŠ äº†æ–°çš„é‡è½½ã€‚ </p><br><pre> <code class="plaintext hljs">public ValueTask&lt;int&gt; ReceiveAsync(Memory&lt;byte&gt; buffer, SocketFlags socketFlags, CancellationToken cancellationToken = default);</code> </pre> <br><p> æ­¤é‡è½½è¿”å›ValueTask &lt;int&gt;ã€‚ å¦‚æœæ“ä½œåŒæ­¥å®Œæˆï¼Œåˆ™å¯ä»¥ç®€å•åœ°è¿”å›å¸¦æœ‰ç›¸åº”å€¼çš„ValueTask &lt;int&gt;ï¼š </p><br><pre> <code class="plaintext hljs">int result = â€¦; return new ValueTask&lt;int&gt;(result);</code> </pre> <br><p> å¼‚æ­¥ç»ˆæ­¢åï¼Œå®ƒå¯ä»¥ä½¿ç”¨å®ç°æ¥å£çš„æ± ä¸­çš„å¯¹è±¡ï¼š </p><br><pre> <code class="plaintext hljs">IValueTaskSource&lt;int&gt; vts = â€¦; return new ValueTask&lt;int&gt;(vts);</code> </pre> <br><p>  Socketå®ç°åœ¨æ± ä¸­æ”¯æŒä¸€ä¸ªè¿™æ ·çš„å¯¹è±¡ç”¨äºæ¥æ”¶ï¼Œè€Œåœ¨ä¼ è¾“ä¸­åˆ™æ”¯æŒä¸€ä¸ªå¯¹è±¡ï¼Œå› ä¸ºæ¯ä¸ªæ–¹å‘ä¸Šä¸€æ¬¡éƒ½ä¸èƒ½æœ‰å¤šä¸ªå¯¹è±¡ç­‰å¾…æ‰§è¡Œã€‚ å³ä½¿åœ¨å¼‚æ­¥æ“ä½œçš„æƒ…å†µä¸‹ï¼Œè¿™äº›é‡è½½ä¹Ÿä¸ä¼šåˆ†é…å†…å­˜ã€‚ æ­¤è¡Œä¸ºåœ¨NetworkStreamç±»ä¸­æ›´åŠ æ˜æ˜¾ã€‚ <br> ä¾‹å¦‚ï¼Œåœ¨.NET Core 2.1ä¸­ï¼ŒStreamæä¾›äº†ï¼š </p><br><pre> <code class="plaintext hljs">public virtual ValueTask&lt;int&gt; ReadAsync(Memory&lt;byte&gt; buffer, CancellationToken cancellationToken);</code> </pre> <br><p> åœ¨NetworkStreamä¸­é‡æ–°å®šä¹‰ã€‚  NetworkStream.ReadAsyncæ–¹æ³•ä»…ä½¿ç”¨Socket.ReceiveAsyncæ–¹æ³•ï¼Œä»¥ä¾¿å°†Socketä¸­çš„å¥–é‡‘å¹¿æ’­åˆ°NetworkStreamï¼Œè€ŒNetworkStream.ReadAsyncä¹Ÿä¸å®é™…åˆ†é…å†…å­˜ã€‚ </p><br><h4 id="neobobschyonnyy-valuetask"> éå…±äº«çš„ValueTask </h4><br><p> å½“.NET Core 2.0ä¸­å‡ºç°ValueTask &lt;TResult&gt;æ—¶ï¼Œå¦‚æœTResultå€¼å·²ç»å‡†å¤‡å¥½ï¼Œåˆ™ä»…åœ¨å…¶ä¸­ä¼˜åŒ–äº†åŒæ­¥æ‰§è¡Œç”¨ä¾‹ï¼Œä»¥æ’é™¤Task &lt;TResult&gt;å¯¹è±¡çš„æ”¾ç½®ã€‚ è¿™æ„å‘³ç€ä¸éœ€è¦éé€šç”¨çš„ValueTaskç±»ï¼šå¯¹äºåŒæ­¥æ‰§è¡Œï¼Œå•ä¾‹Task.CompletedTaskå¯ä»¥ç®€å•åœ°ä»æ–¹æ³•ä¸­è¿”å›ï¼Œè€Œè¿™æ˜¯ç”±ç¯å¢ƒåœ¨è¿”å›Taskçš„å¼‚æ­¥æ–¹æ³•ä¸­éšå¼å®Œæˆçš„ã€‚ </p><br><p> ä½†æ˜¯ï¼Œç”±äºåœ¨ä¸åˆ†é…å†…å­˜çš„æƒ…å†µä¸‹è·å¾—å¼‚æ­¥æ“ä½œï¼Œå› æ­¤éå…±äº«ValueTaskçš„ä½¿ç”¨å†æ¬¡å˜å¾—æœ‰æ„ä¹‰ã€‚ åœ¨.NET Core 2.1ä¸­ï¼Œæˆ‘ä»¬å¼•å…¥äº†é€šç”¨çš„ValueTaskå’ŒIValueTaskSourceã€‚ å®ƒä»¬æä¾›äº†é€šç”¨ç‰ˆæœ¬çš„ç›´æ¥ç­‰æ•ˆé¡¹ï¼Œç”¨äºç±»ä¼¼çš„ç”¨é€”ï¼Œä½†è¿”å›å€¼ä¸ºç©ºã€‚ </p><br><h4 id="realizaciya-ivaluetasksourceivaluetasksourcet"> å®æ–½IValueTaskSource / IValueTaskSource &lt;T&gt; </h4><br><p> å¤§å¤šæ•°å¼€å‘äººå‘˜ä¸åº”å®ç°è¿™äº›æ¥å£ã€‚ è€Œä¸”ï¼Œè¿™ä¸æ˜¯é‚£ä¹ˆå®¹æ˜“ã€‚ å¦‚æœæ‚¨å†³å®šè¿™æ ·åšï¼Œ.NET Core 2.1ä¸­çš„å‡ ç§å®ç°éƒ½å¯ä»¥ä½œä¸ºèµ·ç‚¹ï¼Œä¾‹å¦‚ï¼š </p><br><ul><li>  AwaitableSocketAsyncEventArgs </li><li>  AsyncOperation &lt;TResult&gt; </li><li>  DefaultPipeReader </li></ul><br><p> ä¸ºäº†ä½¿æ­¤æ“ä½œæ›´å®¹æ˜“ï¼Œæˆ‘ä»¬è®¡åˆ’åœ¨.NET Core 3.0ä¸­å¼•å…¥ManualResetValueTaskSourceCore &lt;TResult&gt;ç±»å‹ä¸­åŒ…å«çš„æ‰€æœ‰å¿…è¦é€»è¾‘ï¼Œè¯¥ç»“æ„å¯ä»¥åµŒå…¥å®ç°IValueTaskSource &lt;TResult&gt;å’Œ/æˆ–IValueTaskSourceçš„å¦ä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œä»¥ä¾¿å¯ä»¥å°†å…¶å§”æ´¾ç»™æ­¤ç»“æ„æ˜¯åŠŸèƒ½çš„å¤§éƒ¨åˆ†ã€‚ æ‚¨å¯ä»¥ä»dotnet / corefxå­˜å‚¨åº“ä¸­çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://github.com/dotnet/corefx/issues/32664</a>äº†è§£æ›´å¤šä¿¡æ¯ã€‚ </p><br><h4 id="patterny-primeneniya-valuetasks">  ValueTasksåº”ç”¨ç¨‹åºæ¨¡å¼ </h4><br><p> ä¹ä¸€çœ‹ï¼ŒValueTaskå’ŒValueTask &lt;TResult&gt;çš„èŒƒå›´æ¯”Taskå’ŒTask &lt;TResult&gt;å—åˆ°æ›´å¤§çš„é™åˆ¶ã€‚ è¿™æ˜¯å¾ˆå¥½çš„ï¼Œç”šè‡³å¯ä»¥é¢„æ–™çš„ï¼Œå› ä¸ºä½¿ç”¨å®ƒä»¬çš„ä¸»è¦æ–¹æ³•åªæ˜¯ä½¿ç”¨awaitè¿ç®—ç¬¦ã€‚ </p><br><p> ä½†æ˜¯ï¼Œç”±äºå®ƒä»¬å¯ä»¥åŒ…è£…é‡ç”¨çš„å¯¹è±¡ï¼Œå› æ­¤ï¼Œå¦‚æœæ‚¨åç¦»äº†é€šå¸¸çš„ç®€å•ç­‰å¾…æ–¹å¼ï¼Œåˆ™ä¸Taskå’ŒTask &lt;TResult&gt;ç›¸æ¯”ï¼Œå®ƒä»¬çš„ä½¿ç”¨å—åˆ°äº†å¾ˆå¤§çš„é™åˆ¶ã€‚ åœ¨ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå†³ä¸è¦å¯¹ValueTask / ValueTask &lt;TResult&gt;æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š </p><br><ul><li>  <strong>é‡å¤ç­‰å¾…ValueTask / ValueTask &lt;TResult&gt;</strong>ç»“æœå¯¹è±¡å¯èƒ½å·²è¢«å¤„ç½®å¹¶åœ¨å¦ä¸€æ“ä½œä¸­ä½¿ç”¨ã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼Œä»»åŠ¡/ä»»åŠ¡&lt;TResult&gt;æ°¸è¿œä¸ä¼šä»å®ŒæˆçŠ¶æ€è½¬æ¢ä¸ºä¸å®Œæ•´çŠ¶æ€ï¼Œå› æ­¤æ‚¨å¯ä»¥æ ¹æ®éœ€è¦å¤šæ¬¡å¯¹å…¶è¿›è¡Œé‡æ–°é¢„æœŸï¼Œå¹¶æ¯æ¬¡éƒ½è·å¾—ç›¸åŒçš„ç»“æœã€‚ </li><li>  <strong>å¹¶è¡Œç­‰å¾…ValueTask / ValueTask &lt;TResult&gt;</strong>ç»“æœå¯¹è±¡æœŸæœ›ä¸€æ¬¡ä»…ä»ä¸€ä¸ªä½¿ç”¨è€…ä½¿ç”¨ä¸€ä¸ªå›è°ƒè¿›è¡Œå¤„ç†ï¼Œè€Œå°è¯•åŒæ—¶ä»ä¸åŒçš„æµä¸­ç­‰å¾…å¾ˆå®¹æ˜“å¯¼è‡´ç«äº‰å’Œç»†å¾®çš„ç¨‹åºé”™è¯¯ã€‚ å¦å¤–ï¼Œè¿™ä¹Ÿæ˜¯å…ˆå‰æ— æ•ˆçš„â€œé‡æ–°ç­‰å¾…â€æ“ä½œçš„æ›´å…·ä½“æƒ…å†µã€‚ ç›¸æ¯”ä¹‹ä¸‹ï¼Œä»»åŠ¡/ä»»åŠ¡&lt;TResult&gt;æä¾›ä»»æ„æ•°é‡çš„å¹¶è¡Œç­‰å¾…ã€‚ </li><li>  <strong>åœ¨æ“ä½œå°šæœªå®Œæˆæ—¶ä½¿ç”¨.GetAwaiterï¼ˆï¼‰ã€‚GetResultï¼ˆï¼‰ã€‚</strong> IValueTaskSource / IValueTaskSource &lt;TResult&gt;çš„å®ç°åœ¨æ“ä½œå®Œæˆä¹‹å‰ä¸éœ€è¦é”å®šæ”¯æŒï¼Œå¹¶ä¸”å¾ˆå¯èƒ½ä¸ä¼šè¿™æ ·åšï¼Œå› æ­¤ï¼Œè¿™æ ·çš„æ“ä½œè‚¯å®šä¼šå¯¼è‡´ç«é€Ÿï¼Œå¹¶ä¸”å¯èƒ½å°†ä¸ä¼šæŒ‰ç…§è°ƒç”¨æ–¹æ³•çš„é¢„æœŸæ‰§è¡Œã€‚ ä»»åŠ¡/ä»»åŠ¡&lt;TResult&gt;é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆã€‚ </li></ul><br><p> å¦‚æœæ”¶åˆ°ValueTaskæˆ–ValueTask &lt;TResult&gt;ï¼Œä½†æ˜¯éœ€è¦æ‰§è¡Œè¿™ä¸‰ä¸ªæ“ä½œä¹‹ä¸€ï¼Œåˆ™å¯ä»¥ä½¿ç”¨.AsTaskï¼ˆï¼‰ï¼Œè·å–Task / Task &lt;TResult&gt;ï¼Œç„¶åä½¿ç”¨æ¥æ”¶åˆ°çš„å¯¹è±¡è¿›è¡Œæ“ä½œã€‚ ä¹‹åï¼Œæ‚¨å°†æ— æ³•å†ä½¿ç”¨è¯¥ValueTask / ValueTask &lt;TResult&gt;ã€‚ </p><br><p> ç®€è€Œè¨€ä¹‹ï¼Œè§„åˆ™æ˜¯è¿™æ ·çš„ï¼šä½¿ç”¨ValueTask / ValueTask &lt;TResult&gt;æ—¶ï¼Œæ‚¨å¿…é¡»ç›´æ¥ç­‰å¾…å®ƒï¼ˆå¯èƒ½ä½¿ç”¨.ConfigureAwaitï¼ˆfalseï¼‰ï¼‰æˆ–è°ƒç”¨AsTaskï¼ˆï¼‰å¹¶ä¸å†ä½¿ç”¨å®ƒï¼š </p><br><pre> <code class="plaintext hljs">//   ,  ValueTask&lt;int&gt; public ValueTask&lt;int\&gt; SomeValueTaskReturningMethodAsync(); ... // GOOD int result = await SomeValueTaskReturningMethodAsync(); // GOOD int result = await SomeValueTaskReturningMethodAsync().ConfigureAwait(false); // GOOD Task&lt;int&gt; t = SomeValueTaskReturningMethodAsync().AsTask(); // WARNING ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); //       , //     // BAD: await   ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); int result = await vt; int result2 = await vt; // BAD: await  (    ) ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); Task.Run(async () =&gt; await vt); Task.Run(async () =&gt; await vt); // BAD:  GetAwaiter().GetResult(),     ValueTask&lt;int&gt; vt = SomeValueTaskReturningMethodAsync(); int result = vt.GetAwaiter().GetResult();</code> </pre> <br><p> æˆ‘å¸Œæœ›ç¨‹åºå‘˜è¿˜æœ‰ä¸€ç§é«˜çº§æ¨¡å¼ï¼Œåªæœ‰ç»è¿‡ä»”ç»†è¡¡é‡å¹¶è·å¾—æ˜æ˜¾ä¼˜åŠ¿ä¹‹åï¼Œæ‰èƒ½åº”ç”¨ã€‚  ValueTask / ValueTask &lt;TResult&gt;ç±»å…·æœ‰æŠ¥å‘Šæ“ä½œå½“å‰çŠ¶æ€çš„å¤šä¸ªå±æ€§ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ“ä½œå®Œæˆï¼ˆå³ï¼Œå®ƒä¸å†è¿è¡Œä¸”æˆåŠŸæˆ–ä¸æˆåŠŸå®Œæˆï¼‰ï¼Œåˆ™IsCompletedå±æ€§è¿”å›trueï¼Œè€ŒIsCompletedSuccessfullyå±æ€§ä»…è¿”å›trueã€‚å¦‚æœå®ƒæˆåŠŸå®Œæˆï¼ˆåœ¨ç­‰å¾…å¹¶æ¥æ”¶ç»“æœæ—¶ï¼Œå®ƒæ²¡æœ‰å¼•å‘å¼‚å¸¸ï¼‰ã€‚ å¯¹äºæœ€è‹›åˆ»çš„æ‰§è¡Œçº¿ç¨‹ï¼Œå¼€å‘äººå‘˜å¸Œæœ›é¿å…å¼‚æ­¥æ¨¡å¼ä¸‹äº§ç”Ÿçš„æˆæœ¬ï¼Œå¯ä»¥åœ¨å®é™…é”€æ¯ValueTask / ValueTask &lt;TResult&gt;å¯¹è±¡çš„æ“ä½œï¼ˆä¾‹å¦‚ï¼Œç­‰å¾….AsTaskï¼ˆï¼‰ï¼‰ä¹‹å‰æ£€æŸ¥è¿™äº›å±æ€§ã€‚ ä¾‹å¦‚ï¼Œåœ¨.NET Core 2.1ä¸­çš„SocketsHttpHandlerçš„å®ç°ä¸­ï¼Œä»£ç ä»è¿æ¥è¯»å–å¹¶æ¥æ”¶ValueTask &lt;int&gt;ã€‚ å¦‚æœæ­¤æ“ä½œæ˜¯åŒæ­¥æ‰§è¡Œçš„ï¼Œåˆ™ä¸å¿…æ‹…å¿ƒæ“ä½œä¼šæå‰ç»ˆæ­¢ã€‚ ä½†æ˜¯ï¼Œå¦‚æœå®ƒå¼‚æ­¥è¿è¡Œï¼Œæˆ‘ä»¬å¿…é¡»æŒ‚æ¥ä¸­æ–­å¤„ç†ç¨‹åºï¼Œä»¥ä¾¿ä¸­æ–­è¯·æ±‚æ–­å¼€è¿æ¥ã€‚ ç”±äºè¿™æ˜¯ä¸€æ®µéå¸¸ç´§å¼ çš„ä»£ç ï¼Œå› æ­¤å¦‚æœæ¦‚è¦åˆ†æè¡¨æ˜éœ€è¦è¿›è¡Œä»¥ä¸‹è¾ƒå°çš„æ›´æ”¹ï¼Œåˆ™å¯ä»¥é‡‡ç”¨ä»¥ä¸‹ç»“æ„ï¼š </p><br><pre> <code class="plaintext hljs">int bytesRead; { ValueTask&lt;int&gt; readTask = _connection.ReadAsync(buffer); if (readTask.IsCompletedSuccessfully) { bytesRead = readTask.Result; } else { using (_connection.RegisterCancellation()) { bytesRead = await readTask; } } }</code> </pre> <br><h4 id="dolzhen-li-kazhdyy-novyy-metod-asinhronnogo-api-vozvraschat-valuetaskvaluetasktresult"> æ¯ä¸ªæ–°çš„å¼‚æ­¥APIæ–¹æ³•éƒ½åº”è¯¥è¿”å›ValueTask / ValueTask &lt;TResult&gt;å—ï¼Ÿ </h4><br><p> ç®€çŸ­åœ°å›ç­”ï¼šä¸ï¼Œé»˜è®¤æƒ…å†µä¸‹ä»ç„¶å€¼å¾—é€‰æ‹©Task / Task &lt;TResult&gt;ã€‚ <br> å¦‚ä¸Šæ‰€è¿°ï¼ŒTaskå’ŒTask &lt;TResult&gt;æ¯”ValueTaskå’ŒValueTask &lt;TResult&gt;æ›´æ˜“äºæ­£ç¡®ä½¿ç”¨ï¼Œå¹¶ä¸”åªè¦æ€§èƒ½è¦æ±‚ä¸è¶…è¿‡å®ç”¨æ€§è¦æ±‚ï¼Œåˆ™é¦–é€‰Taskå’ŒTask &lt;TResult&gt;ã€‚ å¦å¤–ï¼Œè¿”å›ValueTask &lt;TResult&gt;è€Œä¸æ˜¯Task &lt;TResult&gt;çš„å¼€é”€å¾ˆå°ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¾®åŸºå‡†æµ‹è¯•æ˜¾ç¤ºawait Task &lt;TResult&gt;æ¯”await ValueTask &lt;TResult&gt;æ›´å¿«ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæ‚¨ä½¿ç”¨ä»»åŠ¡ç¼“å­˜ï¼Œåˆ™æ‚¨çš„æ–¹æ³•å°†è¿”å›Taskæˆ–Taskï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œå€¼å¾—ä½¿ç”¨Taskæˆ–Taskã€‚  ValueTask / ValueTask &lt;TResult&gt;å¯¹è±¡åœ¨å†…å­˜ä¸­å æ®å‡ ä¸ªå­—ï¼Œå› æ­¤ï¼Œå½“æœŸæœ›å®ƒä»¬å¹¶ä¸”å®ƒä»¬çš„å­—æ®µåœ¨è°ƒç”¨asyncæ–¹æ³•çš„çŠ¶æ€æœºä¸­ä¿ç•™æ—¶ï¼Œå®ƒä»¬å°†åœ¨å…¶ä¸­å æ®æ›´å¤šçš„å†…å­˜ã€‚ <br></p><p>  - ValueTask/ValueTask&lt;TResult&gt;    : )  ,        await, )        , )     ,          .   ,                /  . </p><br><h4 id="chto-dalshe-s-valuetask-i-valuetasktresult">    ValueTask  ValueTask&lt;TResult&gt;? </h4><br><p>    .NET      ,  Task/Task&lt;TResult&gt;,  ,  ValueTask/ValueTask&lt;TResult&gt;,     ,   .      â€“   IAsyncEnumerator&lt;T&gt;,     .NET Core 3.0. IEnumerator&lt;T&gt;   MoveNext,   bool,     IAsyncEnumerator&lt;T&gt;   MoveNextAsync.     , ,     Task,             . ,   ,       ,        (           ),        await   foreach,      ValueTask.        ,         .      C#   ,    ,     ,   . </p><p></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN458828/">https://habr.com/ru/post/zh-CN458828/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN458812/index.html">JVM TIï¼šå¦‚ä½•ä¸ºè™šæ‹Ÿæœºåˆ¶ä½œæ’ä»¶</a></li>
<li><a href="../zh-CN458814/index.html">ä¸ºéœ€æ±‚æœªå®šçš„äº§å“å¯åŠ¨ç½‘ç«™</a></li>
<li><a href="../zh-CN458818/index.html">æ°å‡ºçš„åŒæ—¶ä»£äºº</a></li>
<li><a href="../zh-CN458820/index.html">å…³äºåœ¨Minecraftå¹³å°ä¸Šå®æ–½è‘—åæµæ´¾çš„é—®é¢˜</a></li>
<li><a href="../zh-CN458826/index.html">å¦‚ä½•æ¸…é™¤æ—§å•†å“ï¼Œä½¿å®ƒä»¬åœ¨æœ‰æœºå•†å“ä¸­æ€¥å‰§å¢é•¿ï¼šå…­ä¸ªæœˆçš„æµé‡å¢åŠ äº†104ï¼…</a></li>
<li><a href="../zh-CN458830/index.html">Dell Technologiesç½‘ç»œç ”è®¨ä¼šï¼šæˆ‘ä»¬æ•™ç¨‹çš„æ‰€æœ‰è¯¦ç»†ä¿¡æ¯</a></li>
<li><a href="../zh-CN458832/index.html">äº”åå­¦ç”Ÿå’Œä¸‰ä¸ªåˆ†å¸ƒå¼é”®å€¼å­˜å‚¨</a></li>
<li><a href="../zh-CN458834/index.html">ä¿ç½—Â·è‰¾ä¼¦ï¼ˆPaul Allenï¼‰ä¸ªæ€§çš„ä¸€é¢ï¼Œå…³äºè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘æƒ³çŸ¥é“çš„äººå¹¶ä¸å¤š</a></li>
<li><a href="../zh-CN458836/index.html">ç½—å®‹æ±¤æŒ‡æ•°ã€‚ è¯„ä¼°ï¼Œæ¯”è¾ƒï¼Œç¡®å®šä»·æ ¼/è´¨é‡æ¯”çš„ç³»ç»Ÿæ–¹æ³•</a></li>
<li><a href="../zh-CN458840/index.html">æˆ‘ä»¬å¦‚ä½•åˆºç©¿ä¸­å›½å¤§é˜²ç«å¢™ï¼ˆç¬¬2éƒ¨åˆ†ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>