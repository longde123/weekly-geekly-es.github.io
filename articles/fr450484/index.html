<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üîõ üíΩ üë∑üèº Performance d'animation de site Web üññ üõÑ üôãüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lors du d√©veloppement de sites qui d√©passent le cadre d'un bootstrap conditionnel, des questions se posent t√¥t ou tard concernant les performances des...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Performance d'animation de site Web</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450484/"><p><img src="https://habrastorage.org/webt/ih/4a/ik/ih4aikfcshl-qmlrus_osjofine.jpeg" alt="image"></p><br><p> Lors du d√©veloppement de sites qui d√©passent le cadre d'un bootstrap conditionnel, des questions se posent t√¥t ou tard concernant les performances des animations.  Ils sont particuli√®rement importants dans les sites de conception, tels que ceux qui entrent dans les catalogues Awwwards, FWA, CSS Design Awards, etc.  Dans ce cas, la t√¢che de cr√©er des animations et d'optimiser ensuite, si n√©cessaire, repose souvent sur les √©paules de d√©veloppeurs peu exp√©riment√©s qui ne savent m√™me pas par o√π commencer.  Habituellement, tout cela se traduit par des sites inhibiteurs qui sont impossibles √† utiliser, et l'attitude n√©gative qui en d√©coule pour l'ensemble de la classe de ces projets.  Dans cet article, nous allons essayer de comprendre o√π se situe la limite des performances d'animation acceptables, quels goulots d'√©tranglement sont courants et o√π chercher dans les outils de d√©veloppement en premier lieu. </p><a name="habracut"></a><br><p>  <em>Une petite remarque: cet article √©tant destin√© davantage aux d√©veloppeurs d√©butants et son objectif est de montrer des approches g√©n√©rales pour optimiser les animations, beaucoup de choses seront donn√©es sous une forme simplifi√©e, pas tout √† fait acad√©mique.</em> </p><br><h2 id="kak-brauzer-otobrazhaet-stranicu">  Comment le navigateur affiche la page </h2><br><p>  Tout d'abord, il est utile de comprendre ce qui se passe lorsque le navigateur nous affiche l'√©tat actuel de la page.  Il y a quatre √©tapes principales: </p><br><ol><li>  Calcul de style (le navigateur analyse les s√©lecteurs CSS, d√©termine quels styles doivent √™tre appliqu√©s √† quoi) </li><li>  Cr√©ation de mise en page (la mise en page est en fait form√©e) </li><li>  Peinture (cr√©e des repr√©sentations pixel des √©l√©ments pour un rendu ult√©rieur) </li><li>  Composition des calques (le navigateur collecte tout ensemble et s'affiche √† l'√©cran) </li></ol><br><p>  De plus, le navigateur agit toujours dans cette s√©quence et va jusqu'au bout.  Lorsque la page est initialement affich√©e apr√®s son chargement, les quatre √©tapes passent par.  √Ä l'avenir, nos actions peuvent entra√Æner l'ex√©cution de l'une d'entre elles, mais en m√™me temps toutes les suivantes seront ex√©cut√©es.  Mais pas les pr√©c√©dents. </p><br><p>  Nous examinerons plus loin les goulots d'√©tranglement de chacune de ces √©tapes, et maintenant nous poserons une question idiote √† premi√®re vue, √† partir de laquelle, en th√©orie, vous devez commencer ... </p><br><h2 id="tormozit-ili-ne-tormozit-vot-v-chem-vopros">  Que cela ralentisse ou non, c'est la question ... </h2><br><p>  Tr√®s souvent, vous pouvez rencontrer des gens qui ne font rien avec un site Web clairement lent et dire "mais ma vitesse de page donne 100 points, tout va bien."  Ou vice versa, sur un site qui fonctionne bien, les gens sont engag√©s depuis longtemps dans une sorte d'optimisation, car certains algorithmes fonctionnent de mani√®re inefficace sur la base de certaines mesures myst√©rieuses.  Mais entre ces extr√™mes devrait √™tre le milieu du bon sens, alors o√π est-il? </p><br><p><img src="https://habrastorage.org/webt/zv/su/nv/zvsunvxfwjqvs98q0_yhc9s5jry.jpeg" alt="image"></p><br><p>  √Ä <del>  faire connaissance avec zen </del>  pour savoir si vous avez besoin d'optimiser vos animations, vous devez r√©aliser une profonde r√©flexion philosophique: </p><br><blockquote>  Si vous voyez que le site est lent, cela signifie qu'il est lent.  Si vous ne voyez pas que le site ralentit, il ne ralentit pas. </blockquote><p>  Pour une raison quelconque, beaucoup de gens trouvent cette d√©claration tr√®s stupide, mais est-ce le cas?  Pour l'utilisateur final, les performances ne sont pas une sorte de m√©triques ou d'algorithmes id√©aux avec une justification math√©matique rigoureuse.  Pour lui, la performance est l'une des deux choses: elle ralentit ou ne ralentit pas. </p><br><p>  Comment d√©termine-t-il cela?  L'≈ìil d'une personne qui passe beaucoup de temps derri√®re le moniteur commence √† r√©agir brusquement √† une baisse de fps.  Cela provoque une √©trange sensation d'inconfort.  En cons√©quence, notre t√¢che, en tant que d√©veloppeurs, est d'emp√™cher l'affaissement.  L'utilisateur a-t-il l'habitude de voir le navigateur fonctionner √† 60 ips?  Eh bien, nous faisons tout pour que tout reste comme √ßa.  Nous prenons un ordinateur portable avec un fer moyen et regardons.  Nous voyons beaucoup moins de 60 images par seconde - nous optimisons.  Nous voyons environ 60 - ne touchez √† rien.  L'utilisateur ne remarquera pas la diff√©rence de toute fa√ßon, et nous consacrerons beaucoup de temps √† l'optimisation dans un souci d'optimisation. </p><br><blockquote>  Ne faites pas d'optimisations pour les optimisations. </blockquote><br><h2 id="165ms">  16,5 ms </h2><br><p>  S'exprimer en termes de fps n'est pas pratique, alors passons aux millisecondes.  Avec une simple division de 1000 ms / 60 ips, nous obtenons environ 16,5 ms de temps par image. </p><br><p>  Qu'est-ce que cela signifie?  Pendant 16,5 ms, le navigateur devrait nous afficher l'√©tat actuel de la page avec l'animation, en suivant les √©tapes que nous avons examin√©es ci-dessus, et en m√™me temps, il devrait y avoir des ressources pour d'autres scripts, la communication avec le serveur, etc.  Si plus de temps est consacr√© √† l'affichage de l'√©tat actuel de la page, nous verrons √† travers nos yeux le d√©calage.  Si environ 16 ms, il n'y aura pas d'affaissement, mais il est probable que la charge de fer soit tr√®s √©lev√©e, les refroidisseurs bourdonnent et les t√©l√©phones se r√©chauffent.  Ainsi, nous devons nous assurer que le rendu d'une image ne se rapproche pas de cette valeur dans le temps, et encore mieux n'est pas sup√©rieur √† 10 ms, afin qu'il y ait une marge de performance.  N'oubliez pas que les tests sont toujours effectu√©s sur le mat√©riel interm√©diaire - par exemple, dans les exemples suivants, des captures d'√©cran seront prises sur Pentium Silver avec des graphiques int√©gr√©s. </p><br><blockquote>  Testez sur le mat√©riel que vos utilisateurs sont plus susceptibles d'avoir.  Si vous avez un processeur haut de gamme et une ferme mini√®re sous la table dans votre lieu de travail, alors tout fonctionnera bien pour vous, tandis que vos utilisateurs d'ordinateurs portables √† petit budget peuvent √™tre tr√®s tristes. </blockquote><p>  Afin de ne pas compter uniquement sur votre bon ≈ìil et votre intuition, il est utile de ma√Ætriser les outils de d√©veloppement, au moins au niveau de base.  Ils fourniront non seulement des donn√©es de performances pr√©cises, mais vous indiqueront √©galement o√π chercher le probl√®me, si tout ne fonctionne pas tr√®s bien. </p><br><h2 id="instrumenty-razrabotchika-v-google-chrome">  Outils de d√©veloppement dans Google Chrome </h2><br><p>  De nombreux codeurs sont souvent plus frapp√©s par les outils de d√©veloppement du navigateur que par la console Linux.  Mais il n'y a vraiment rien √† craindre.  Oui, il existe de nombreux boutons, mais ils sont redondants pour r√©soudre nos probl√®mes.  Nous allons maintenant voir o√π cela vaut la peine de faire attention avant tout pour comprendre quoi faire avec l'animation, et s'il est n√©cessaire de faire quelque chose. </p><br><p>  En ce qui concerne les performances, nous passerons la plupart du temps dans l'onglet performances et appuyez sur le m√™me bouton. </p><br><p><img src="https://habrastorage.org/webt/a_/wd/vn/a_wdvnjnvppuvnrzp_f4sxp4gb0.png" alt="image"></p><br><p>  Le raccourci Ctrl-E ou le bouton rond √† gauche d√©marre et arr√™te l'enregistrement de ce qui se passe.  Les r√©sultats sont affich√©s ici.  Le navigateur √©crit beaucoup de choses, mais il vaut mieux le voir une fois que de le lire plusieurs fois, alors prenons une sorte d'animation et regardons-le.  Que ce soit une simple animation CSS pour les d√©butants.  Si vous l'ouvrez en plein √©cran, vous pouvez voir qu'il fonctionne avec des bourrages visibles: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://codepen.io/sfi0zy/embed/preview/Xwrqpw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Nous enregistrerons quelques secondes en mode plein √©cran et verrons ce qui s'y passe: </p><br><p><img src="https://habrastorage.org/webt/ih/4a/ik/ih4aikfcshl-qmlrus_osjofine.jpeg" alt="image"></p><br><p>  Le navigateur enregistre tout ce qu'il fait.  Dans la partie sup√©rieure de la fen√™tre, nous voyons un graphique fps.  Il peut facilement √™tre utilis√© pour d√©tecter une anomalie si, dans le processus de travail avec la page, il commence √† ralentir fortement.  Si vous cliquez sur le graphique avec la souris et le tirez sur le c√¥t√© ou tournez la roue, vous pouvez s√©lectionner cette plage de temps et des informations d√©taill√©es seront affich√©es ci-dessous.  Dans notre exemple simple, il n'y a pas d'anomalies, mais on voit clairement que tout ne fonctionne pas de mani√®re tr√®s uniforme. </p><br><p>  Faites imm√©diatement attention √† la ligne <em>Cadres</em> , elle contient des informations sur le temps pass√© sur chaque cadre.  Vous pouvez remarquer que ce temps saute constamment et d√©passe consid√©rablement 16 ms (ci-dessous, dans des exemples pratiques, nous allons l√©g√®rement am√©liorer cette animation). </p><br><p>  Ensuite, nous voyons plusieurs lignes dans lesquelles la charge est affich√©e dans diff√©rentes couleurs - vous pouvez voir combien de temps le navigateur a pass√© sur diff√©rents types d'activit√©s.  Notre animation est uniforme et les m√™mes op√©rations sont effectu√©es pour chaque image, indiqu√©es en violet et vert.  Si vous d√©placez la souris sur les blocs color√©s, il deviendra clair que nous avons affaire aux √©l√©ments mentionn√©s au d√©but - le <em>style de recalcul</em> et l' <em>arborescence des calques de mise √† jour</em> sont violets, et <em>les</em> <em>calques de</em> <em>peinture</em> et <em>composites</em> sont verts. </p><br><p>  Consid√©rez une autre animation.  Cette fois avec des scripts - un simple g√©n√©rateur de bruit.  Il s'agit d'un exemple assez illustratif, bien qu'il ne pr√©sente aucun int√©r√™t du point de vue de la conception: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://codepen.io/sfi0zy/embed/preview/QRLrBJ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Vous remarquerez peut-√™tre que des blocs jaunes ont √©t√© ajout√©s pour afficher l'ex√©cution des scripts.  S'il y a beaucoup d'appels de fonction, alors pour chaque appel un bloc suppl√©mentaire sera ajout√© - par leur taille, il est facile de trouver la fonction "la plus lourde", avec laquelle, probablement, l'optimisation devrait commencer. </p><br><p><img src="https://habrastorage.org/webt/er/j_/cb/erj_cbmcg89tvzk-dco35nqcmia.jpeg" alt="image"></p><br><p>  Dans l'exemple, le temps pass√© sur une image oscille autour de 80 ms.  Mais qu'y a-t-il, m√™me √† l'≈ìil nu, vous pouvez clairement voir comment tout se bloque.  En regardant la section <em>r√©capitulative</em> ci-dessous, nous voyons que les scripts prennent le plus de temps.  Par rapport √† eux, le <em>rendu</em> et la <em>peinture</em> ressemblent √† des erreurs qui peuvent √™tre n√©glig√©es.  Pas toujours, bien s√ªr, cela arrive, mais assez souvent. </p><br><p>  Si vous cliquez sur le bloc marqu√© comme <em>appel de fonction</em> , alors ci-dessous est un lien vers la fonction dans le code de script.  Si vous le parcourez, vous pouvez voir que dans cet exemple, il y a un cycle √† travers tous les pixels de l'√©cran.  Il serait plus logique de faire une telle t√¢che sur des shaders, alors les performances seraient bien meilleures.  Mais nous allons l'examiner dans des exemples pratiques. </p><br><h2 id="chto-delat-esli">  Que faire si ... </h2><br><p>  Nous avons appris quelles √©tapes il y a lors de l'affichage de l'√©tat actuel d'une page dans un navigateur, et o√π voir laquelle prend le plus de temps.  Il est temps de vous familiariser avec les raisons les plus courantes pour lesquelles telle ou telle √©tape commence √† n√©cessiter trop de ressources et donne quelques conseils sur ce qu'il faut faire dans tel ou tel cas. </p><br><h2 id="style-calculation">  Calcul de style </h2><br><p>  Si vous voyez que d√©j√† √† cette √©tape, les probl√®mes commencent - le plus probable n'est m√™me pas dans l'animation, mais dans le fait qu'il y a trop d'√©l√©ments sur la page.  Dans les sites de conception, cela est assez rare, g√©n√©ralement un tel probl√®me est un satellite de grandes tables avec des milliers d'√©l√©ments, mais si vous rencontrez toujours ceci: </p><br><blockquote>  R√©duisez le nombre d'√©l√©ments sur la page, simplifiez la mise en page.  Portez une attention particuli√®re √† la r√©p√©tition de morceaux de code avec des wrappers, il est probable qu'ils puissent √™tre supprim√©s. </blockquote><p>  La deuxi√®me raison associ√©e √† la premi√®re est les s√©lecteurs CSS complexes.  Si sur de petites pages, il est tout √† fait possible d'utiliser une imbrication profonde, des hacks d√©licats avec des √©l√©ments voisins, etc., alors sur une tr√®s grande page, tout cela peut entra√Æner de mauvaises performances. </p><br><blockquote>  Simplifiez les s√©lecteurs CSS, utilisez BEM. </blockquote><br><h2 id="layout-creation">  Cr√©ation de mise en page </h2><br><p>  Cet article est d√©j√† plus proche de la conception et des animations, des choses int√©ressantes commencent ici.  La premi√®re chose qu'il est important de comprendre est que la disposition enti√®re est form√©e.  Si nous changeons quelque chose, il se forme √† nouveau.  Pour cette raison, m√™me de petites modifications sur la grande page peuvent entra√Æner des retards notables √† cette √©tape. </p><br><p>  La r√®gle principale qui nous guide lors de la cr√©ation d'animations est de ne pas permettre la restructuration de la mise en page √† tout prix.  Par cons√©quent, nous n'essayons g√©n√©ralement pas de l'optimiser (et il n'y a pas d'opportunit√©s particuli√®res), √† savoir, nous essayons de l'√©viter. </p><br><p>  Il existe de nombreuses <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">propri√©t√©s</a> qui peuvent entra√Æner la reconstruction de la mise en page, vous pouvez trouver des listes sur Internet, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">csstriggers.com</a> n'est pas mauvais.  Plus souvent que d'autres dans les animations, vous pouvez trouver des propri√©t√©s: </p><br><pre><code class="plaintext hljs">display position / top / left / right / bottom width / height padding / margin border font-size / font-weight / line-height ...</code> </pre> <br><p>  Vous remarquerez peut-√™tre que toutes ces propri√©t√©s sont unies par une seule chose - elles d√©crivent les caract√©ristiques g√©om√©triques des √©l√©ments - les param√®tres d'affichage, la taille et l'emplacement physique.  Donc, au lieu de les m√©moriser tous, rappelez-vous √† quoi ils se r√©f√®rent. </p><br><blockquote>  Ne modifiez pas les propri√©t√©s g√©om√©triques des √©l√©ments, il est pr√©f√©rable d'utiliser la transformation et l'opacit√©. </blockquote><p>  Par ailleurs, il convient de noter que la modification de l'arri√®re-plan de l'√©l√©ment nous ram√®nera √©galement √† cette √©tape.  Ils oublient constamment cela, nous soulignons donc dans une recommandation distincte: </p><br><blockquote>  Ne modifiez pas les √©l√©ments d'arri√®re-plan. </blockquote><p>  Dans certains navigateurs ( <del>  Je ne piquerai pas du doigt dans Firefox </del>  ), un d√©calage typique des animations CSS avec transformations peut appara√Ætre, en particulier si plusieurs animations sont effectu√©es par unit√© de temps.  Ext√©rieurement, cela peut ressembler non seulement √† une pause dans son travail, mais aussi √† des ¬´pannes¬ª de l'animation √† ses d√©buts.  Il semble que le navigateur recalcule constamment quelque chose.  Ce comportement est presque toujours corrig√© √† l'aide de la propri√©t√© <em>backface-visibilit√©</em> . </p><br><blockquote>  Si possible, ajoutez une visibilit√© sur la face arri√®re: cach√©e aux √©l√©ments anim√©s. </blockquote><p>  De plus, la reconstruction de la mise en page est caus√©e par nos appels aux √©l√©ments √† partir de scripts.  De plus, cela ne doit pas √™tre un changement direct de CSS, cela peut aussi √™tre un appel √† certaines propri√©t√©s et m√©thodes d'√©l√©ments.  Les plus courants sont: </p><br><pre> <code class="plaintext hljs">offset*** client*** inner*** scroll***</code> </pre> <br><p>  Dans les animations, vous devez √™tre prudent avec elles, car  si nous commen√ßons √† faire r√©f√©rence √† ces propri√©t√©s et m√©thodes pour un grand nombre d'√©l√©ments, cela entra√Ænera √† chaque fois une restructuration de la disposition. </p><br><blockquote>  √âvitez de vous r√©f√©rer aux propri√©t√©s et m√©thodes mentionn√©es pour les √©l√©ments individuels des boucles. </blockquote><br><h2 id="painting-i-layer-composition">  Peinture et composition des couches </h2><br><p>  Nous consid√©rerons ces deux √©tapes ensemble, comme  ils sont quelque peu li√©s et g√©n√©ralement s'il y a des probl√®mes avec l'un, ils le seront avec l'autre.  Ignorer ces √©tapes, les √©viter ne fonctionnera pas, nous essayons donc de les optimiser d'une mani√®re ou d'une autre. </p><br><p>  Le navigateur ne pr√©pare pas l'image en pixels de la page, mais en partie - les calques.  Il peut y en avoir beaucoup.  Chaque couche existe comme si en elle-m√™me et n'affecte pas le reste, ce qui cr√©e la base de certains hacks CSS.  Mais nous en reparlerons une autre fois.  Ensuite, l'image finale est collect√©e √† partir de ces couches.  Dans le contexte des animations, il est tr√®s utile de placer les √©l√©ments anim√©s dans un calque s√©par√© afin que leurs modifications n'affectent pas tout autour.  Il est souhaitable que le contenu des √©l√©ments soit petit.  Nous pouvons le faire en utilisant la propri√©t√© <em>will-change</em> ou, comme nous l'avons fait pr√©c√©demment, <em>transform: translateZ (0)</em> .  La seule chose √† retenir est que vous ne pouvez pas augmenter ind√©finiment le nombre de couches.  √Ä un moment donn√©, cela jouera un tour et la performance oppos√©e chutera.  Il y aura donc deux conseils: </p><br><blockquote>  Utilisez will-change ou transform: translateZ (0) pour d√©placer les √©l√©ments anim√©s vers un calque s√©par√©. </blockquote><p>  mais en m√™me temps </p><br><blockquote>  N'en faites pas trop avec cette entreprise.  V√©rifiez dans les outils de d√©veloppement que ce n'est pas pire. </blockquote><p>  Tr√®s souvent, de graves probl√®mes sont caus√©s par des filtres qui transforment en quelque sorte l'image des √©l√©ments.  Il peut s'agir de simples filtres CSS avec <em>flou</em> ou d'options confuses avec SVG, mais l'effet sera le m√™me - une baisse notable des performances. </p><br><blockquote>  N'utilisez pas de filtres complexes.  Si vous avez toujours besoin de l'effet recherch√©, envisagez de l'impl√©menter sur WebGL. </blockquote><br><h2 id="naskolko-eti-sovety-rabotayut">  Comment fonctionnent ces conseils? </h2><br><p>  Ils fonctionnent, mais vous n'avez pas besoin d'attendre un miracle de leur part.  Sur le net, les d√©butants disent parfois: ¬´J'ai ajout√© un changement de volont√©, mais rien n'a chang√©.¬ª  Habituellement, cela signifie que le probl√®me principal √©tait √† un autre endroit, et cette technique a donn√© une si petite augmentation de la productivit√© qu'elle est pass√©e inaper√ßue.  C'est pourquoi il est important d'utiliser les outils du d√©veloppeur pour comprendre clairement o√π se situe le goulot d'√©tranglement et ne pas consacrer de temps et d'efforts √† optimiser ce qui fonctionne bien de toute fa√ßon. </p><br><p>  De tout cela, nous pouvons conclure qu'il n'y a pas beaucoup de fa√ßons d'influencer le rendu d'une page, et leur effet ne sera pas toujours significatif.  Ces astuces ne sont pas des balles d'argent, elles sont plut√¥t n√©cessaires pour peaufiner l'animation.  Si nous regardons des sites avec de tr√®s mauvaises performances, nous remarquerons que dans la grande majorit√© des cas, nos propres scripts sont √† bl√¢mer, et pas de probl√®mes myst√©rieux avec l'analyse CSS quelque part dans les entrailles du navigateur. </p><br><h2 id="skripty">  Scripts ... </h2><br><p>  Savez-vous o√π les probl√®mes d'animations inhibitrices se d√©veloppent le plus souvent (selon mes observations)?  Voici cette approche de d√©veloppement: </p><br><p><img src="https://habrastorage.org/webt/31/ov/_a/31ov_auhpakgnb4tu2mtfapgi7w.jpeg" alt="image"></p><br><p>  Cela semble idiot, mais √ßa l'est.  Il y a constamment des solutions, √©videmment copi√©es de quelque part compl√®tement sans comprendre ce qui se passait.  Il arrive m√™me que vous puissiez supprimer la moiti√© du code et tout continuera √† fonctionner.  Souvent, le code dans les r√©ponses √† SO ou Toaster n'est pas destin√© √† votre production.  Cela devrait √™tre √©vident.  Il montre l'id√©e, r√©pond √† la question, mais n'est pas du tout l'option finale optimale pour votre t√¢che sp√©cifique. </p><br><blockquote>  Si vous copiez d√©j√†, regardez au moins le code pour les actions inutiles. </blockquote><br><h2 id="requestanimationframe">  RequestAnimationFrame </h2><br><p>  Ils parlent souvent de cette m√©thode et recommandent de l'utiliser au lieu de <em>setTimeout / setInterval</em> dans les animations.  Cela a du sens, car ces m√©thodes ont la propri√©t√© d'√™tre d√©synchronis√©es avec les images que le navigateur redessine, ce qui entra√Æne de petits retards.  Mais il y a deux points. </p><br><p>  Premi√®rement, si plusieurs √©l√©ments sont anim√©s sur la page et que nous appelons requestAnimationFrame plusieurs fois, cela entra√Ænera un affaissement net de fps.  En th√©orie, cela ne devrait pas √™tre le cas, mais en pratique, tout se passe comme √ßa.  Vous pouvez vous familiariser avec les tests <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><blockquote>  Combinez tous les rappels d'animation en un seul requestAnimationFrame. </blockquote><p>  Le deuxi√®me point est probablement li√© √† la situation o√π nous avons d√©j√† une animation lourde, peut-√™tre avec l'utilisation de canvas, dont nous ne pouvons pas nous d√©barrasser ou que nous n'avons pas le temps de refaire, et ce qui suit se produit: disons que l'animation devrait √™tre termin√©e en N secondes et nous utilisons d√©j√† <em>requestAnimationFrame</em> .  Mais il faut beaucoup de ressources pour calculer l'√©tat actuel et nous voyons cette image: l'animation fonctionne bien, magnifiquement, mais en 2N, voire 3N secondes.  En cons√©quence, tout est per√ßu soooooooooo.  Afin de corriger ce comportement, vous pouvez aller √† l'encontre de toutes les recommandations, utiliser ainsi <em>setInterval / setTimeout</em> et lier les √©tats des √©l√©ments anim√©s au temps physique et non aux cadres abstraits.  En cons√©quence, nous obtenons une diminution formelle des fps, mais avec l'effet psychologique des gains de productivit√©. </p><br><blockquote>  Dans le cas d'animations extr√™mement lentes, il peut √™tre judicieux de refuser requestAnimationFrame en faveur de setInterval / setTimeout. </blockquote><br><h2 id="canvas-i-sheydery">  Toile et shaders </h2><br><p>  Une partie importante des animations sur des sites non standard est li√©e au canevas.  C'est compr√©hensible, CSS est une chose limit√©e, mais ici nous pouvons r√©aliser les fantasmes de tout concepteur.  Mais vous devez garder √† l'esprit que la toile 2D habituelle est loin d'√™tre la technologie la plus productive.  Si vous commencez √† dessiner beaucoup d'√©l√©ments dessus ou √† travailler directement avec des pixels, vous constaterez rapidement que le fps est en train de couler, ou tout √† coup la <em>peinture</em> et la <em>composition des calques</em> commencent √† prendre ind√©cemment beaucoup de temps.  Ce probl√®me peut √™tre clairement vu dans l'exemple: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://codepen.io/sfi0zy/embed/preview/vdYRoj" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Voyons ce que fait le navigateur (le dernier Google Chrome sous Linux): </p><br><p><img src="https://habrastorage.org/webt/na/ox/5k/naox5kmmcqfuosbsfhgozpq91zw.jpeg" alt="image"></p><br><p>  Remarquez √† quel point l'√©tape de <em>composition</em> du <em>calque</em> s'est d√©velopp√©e.  Cela semble un peu illogique, car il n'y a qu'un seul √©l√©ment, que peut-on y assembler si longtemps?  Mais lorsque vous utilisez le canevas 2d, ce comportement n'est pas rare, et quelque chose √† voir avec cela est tr√®s probl√©matique.  C'est l'une des raisons pour lesquelles nous avons g√©n√©ralement tendance √† utiliser WebGL, il n'y a pas de telles questions. </p><br><blockquote>  S'il y a un choix entre le canevas 2d et WebGL, choisissez le second.  Cela donnera un bonus de performance initial sur les m√™mes t√¢ches. </blockquote><p>  Qu'est-ce qui est g√©n√©ralement associ√© √† WebGL?  Avec des shaders.  Et le d√©bogage des shaders est un casse-t√™te pour tous ceux qui travaillent avec eux.  Et les outils de d√©veloppement ici sont pratiquement impuissants.  Habituellement, s'il y a trop de calculs dans les shaders, nous voyons dans le r√©sum√© ci-dessous que le plus de temps est "simple", ce qui est en fait l'ex√©cution de nos shaders quel que soit le navigateur, et nous ne pouvons pas obtenir de d√©tails utiles. </p><br><p>  Il existe diff√©rentes recommandations sur les fonctions √† pr√©f√©rer aux shaders, car elles sont cens√©es √™tre mieux optimis√©es.  Ou que les op√©rations de blocage doivent √™tre √©vit√©es.  Tout cela est vrai, mais selon mes observations, dans la plupart des cas, les shaders qui ralentissent trop le site sont tout simplement de tr√®s gros shaders.  Si vous avez √©crit 100 lignes GLSL en un seul endroit, cela est presque garanti de mal fonctionner.  Et s'il existe √©galement diff√©rentes constructions imbriqu√©es, boucles, alors tout - l'√©criture a disparu.  Il est difficile de faire des recommandations ici, √† moins que: </p><br><blockquote>  Si vous avez r√©alis√© au cours du travail que tout est plus compliqu√© qu'il n'y paraissait au d√©part, et qu'il y aura beaucoup de code et qu'il ralentira - il est pr√©f√©rable d'en discuter avec le concepteur et le client d√®s que possible et de r√©fl√©chir √† ce qui peut √™tre chang√©. </blockquote><p>  Souvent, vous pouvez arriver √† la conclusion qu'une vid√©o pr√©-pr√©par√©e fonctionnera beaucoup mieux que d'essayer de rendre une sorte de chose confuse en temps r√©el.  N'oubliez pas cela.  Oui, tout le monde veut se montrer, ils veulent se montrer "mais je peux le faire comme √ßa", mais n'oubliez pas les utilisateurs finaux. </p><br><p>  √Ä propos de cette pens√©e, je rappelle la ¬´maladie¬ª √† laquelle l'ancienne Olympiade est particuli√®rement sensible.  Pour une raison quelconque, cela se manifeste fortement lorsque vous travaillez avec un canevas.  Pour cette raison, vous devez toujours copier soigneusement le code de ces personnes.  Ils essaient d'utiliser les algorithmes math√©matiques ¬´corrects¬ª, des formules physiques complexes, et de calculer tous les mouvements des √©l√©ments avec une grande pr√©cision m√™me l√† o√π cela est compl√®tement inutile.  Cela conduit √† une augmentation de la charge du processeur et au fait que pour nos 10ms conditionnels il n'a pas le temps de compter quoi que ce soit.  Dans la pratique, vous pouvez souvent vous en tirer avec des formules approximatives et des connaissances scolaires en physique.  Ce n'est pas n√©cessaire de compliquer les choses, nous cr√©ons des sites Web, pas des logiciels pour les missiles balistiques. </p><br><blockquote>  Utilisez des algorithmes simples. </blockquote><p>  Il existe une autre astuce appel√©e <em>RayMarching</em> .  Certaines personnes consid√®rent la cr√©ation de diff√©rents effets avec elle comme un d√©fi, un √©chauffement pour l'esprit, et parfois les r√©sultats sont tr√®s impressionnants.  Par exemple, tout un monde sous-marin est g√©n√©r√© ici (j'ai ins√©r√© une vid√©o, car √† partir de calculs en temps r√©el, le t√©l√©phone / ordinateur portable peut se bloquer): </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mQXUHTTq4E8" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Le shader lui-m√™me peut √™tre trouv√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  En pratique, tout cela n√©cessite des ressources incroyables pour fonctionner.  En mode plein √©cran, nous avons 400 √† 800 ms par image (en g√©n√©ral, dans cet exemple, cela peut aller jusqu'√† 1500 ms): </p><br><p><img src="https://habrastorage.org/webt/pj/jj/pj/pjjjpj9fu4fcqkvtqg2bggwhqhc.jpeg" alt="image"></p><br><p>  Donc, si vous vous surprenez √† penser √† faire quelque chose comme √ßa sur un site de combat, donnez-vous un clavier sur la t√™te, buvez du th√© et pensez √† des options alternatives pour impl√©menter des effets. </p><br><blockquote>  N'utilisez pas RayMarching, c'est un moyen s√ªr de r√©duire les performances. </blockquote><br><h2 id="prakticheskiy-primer">  Exemple pratique </h2><br><p>  Il n'y a souvent pas assez d'exemples dans les articles sur la productivit√©, mais il peut √™tre difficile de prendre un mot.  Consid√©rez donc un couple.  Vous vous souvenez du premier exemple de tunnel de rotation CSS?  Le navigateur a fait beaucoup de choses: </p><br><p><img src="https://habrastorage.org/webt/ih/4a/ik/ih4aikfcshl-qmlrus_osjofine.jpeg" alt="image"></p><br><p>  Nous voulons acc√©l√©rer un peu les choses.  Par o√π commencer?  Nous voyons des blocs violets, ce qui signifie que le navigateur reconstruit constamment la disposition.  Il n'y a pas de scripts, mais il y a des animations CSS dans lesquelles quelque chose change.  Regardons leur code: </p><br><pre> <code class="css hljs">@<span class="hljs-keyword"><span class="hljs-keyword">keyframes</span></span> rotate { <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">rotate</span></span>(0); } <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">rotate</span></span>(360deg); } } @<span class="hljs-keyword"><span class="hljs-keyword">keyframes</span></span> move-block { <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">translateX</span></span>(0); <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: @color1; } <span class="hljs-selector-tag"><span class="hljs-selector-tag">to</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">transform</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">translateX</span></span>(-@block-size * 6); <span class="hljs-attribute"><span class="hljs-attribute">background</span></span>: @color2; } }</code> </pre> <br><p>  Les transformations ne nous font pas peur, mais nous constatons un changement dans le fond des √©l√©ments.  Nous rappelons que cela peut entra√Æner une restructuration de la mise en page, et nous pensons √† ce qui peut √™tre fait dans cette situation ... </p><br><p>  La modification de l'arri√®re-plan doit √™tre supprim√©e √† tout prix, donc sur la base de l'id√©e g√©n√©rale d'animation, nous d√©cidons que vous pouvez mettre un d√©grad√© radial sur le dessus, ce qui cr√©era presque le m√™me effet de volume.  Quelqu'un dira que les d√©grad√©s ont un mauvais effet sur les performances, mais nous n'allons pas le changer.  Que ce soit mieux une fois qu'il affecte gravement que nous aurons toute une montagne d'√©l√©ments qui affectent constamment.  Le r√©sultat est: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://codepen.io/sfi0zy/embed/preview/OYLZpx" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Voyons ce que fait le navigateur: </p><br><p><img src="https://habrastorage.org/webt/0i/hc/oh/0ihcohn8cxnwbrq78qgmo8b0-w4.jpeg" alt="image"></p><br><p>  Wow ... Au lieu d'un tas d'actions, nous voyons de rares appels au GPU et rien d'autre, tandis que l'animation elle-m√™me a commenc√© √† fonctionner de mani√®re nettement plus fluide. </p><br><h2 id="esche-primer">  Un autre exemple </h2><br><p>  Rappelez-vous √† quoi ressemblait le navigateur dans le g√©n√©rateur de bruit: </p><br><p><img src="https://habrastorage.org/webt/er/j_/cb/erj_cbmcg89tvzk-dco35nqcmia.jpeg" alt="image"></p><br><p>  Le probl√®me est d√©finitivement dans les scripts.  On peut voir que le bloc "render" est le plus grand.  C'est notre fonction principale pour le rendu de l'image.  Regardons-la: </p><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> imageData = CTX.createImageData(CTX.canvas.width, CTX.canvas.height); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; imageData.data.length; i += <span class="hljs-number"><span class="hljs-number">4</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> color = getRandom(); imageData.data[i] = color; imageData.data[i + <span class="hljs-number"><span class="hljs-number">1</span></span>] = color; imageData.data[i + <span class="hljs-number"><span class="hljs-number">2</span></span>] = color; imageData.data[i + <span class="hljs-number"><span class="hljs-number">3</span></span>] = <span class="hljs-number"><span class="hljs-number">255</span></span>; } CTX.putImageData(imageData, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); requestAnimationFrame(render); }</code> </pre> <br><p>  Il y a certainement du travail en cours avec des pixels individuels.  Ce n'est pas tr√®s sain.  Nous avons dit que si possible, il est pr√©f√©rable d'utiliser non pas 2d-canvas, mais WebGL, et cette t√¢che veut juste √™tre parall√©lis√©e √† l'aide d'un shader.  Faisons-le: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://codepen.io/sfi0zy/embed/preview/VOZxGp" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Quel sera le r√©sultat?  Voyez par vous-m√™me: </p><br><p><img src="https://habrastorage.org/webt/3m/td/vh/3mtdvhlrjo4-cjuqmzieis4tr7w.jpeg" alt="image"></p><br><p>  Le temps pour une image a √©t√© r√©duit √† pr√®s de 16 ms.  Bien s√ªr, ce n'est pas id√©al, mais toujours mieux que 80 ms.  Dans de belles animations complexes, un tel gain de performances peut √™tre tr√®s perceptible.  J'en profite pour recommander aux d√©butants de se familiariser avec l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">introduction des shaders en programmation</a> et la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">suite avec des exemples</a> . </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Dans cet article, nous avons compris comment optimiser les performances des animations, comment utiliser les outils de d√©veloppement dans Chrome dans ce contexte et quoi rechercher en premier.  J'esp√®re que ces informations seront utiles aux d√©veloppeurs qui sont confront√©s √† de telles t√¢ches pour la premi√®re fois et ne savent pas par o√π commencer. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450484/">https://habr.com/ru/post/fr450484/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450472/index.html">Comment faire une feuille de route parfaite?</a></li>
<li><a href="../fr450474/index.html">Introduction √† Python</a></li>
<li><a href="../fr450476/index.html">Comment nous avons enregistr√© une entreprise dans l'UE</a></li>
<li><a href="../fr450478/index.html">Aujourd'hui, de nombreux modules compl√©mentaires populaires pour Firefox ont cess√© de fonctionner en raison de probl√®mes de certificat.</a></li>
<li><a href="../fr450480/index.html">Comment l'informatique quantique peut affecter le d√©veloppement logiciel</a></li>
<li><a href="../fr450486/index.html">9. Check Point Getting Started R80.20. Contr√¥le des applications et filtrage d'URL</a></li>
<li><a href="../fr450488/index.html">Chock Norris Facts Android App sur Kotlin</a></li>
<li><a href="../fr450490/index.html">Accord de 6,9 ‚Äã‚Äãmilliards de dollars: pourquoi un d√©veloppeur de GPU ach√®te-t-il un fabricant d'√©quipement r√©seau</a></li>
<li><a href="../fr450492/index.html">Travail social et design ouvert. Pr√©sentation</a></li>
<li><a href="../fr450494/index.html">Comment la traduction du terme trunk d√©pend-elle du fournisseur du commutateur?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>