<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßî ü§û üë©üèΩ‚Äçüé® Seguridad en electr√≥nica automotriz - hello world en el tablero de instrumentos üì´ üõ≥Ô∏è üßëüèª‚Äçü§ù‚Äçüßëüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Despu√©s de experimentar con el autob√∫s CAN en el autom√≥vil, hubo un deseo salvaje de profundizar un poco m√°s en el lugar m√°s sagrado. Creo que todos c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Seguridad en electr√≥nica automotriz - hello world en el tablero de instrumentos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/474718/"> Despu√©s de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">experimentar con el autob√∫s CAN en el autom√≥vil,</a> hubo un deseo salvaje de profundizar un poco m√°s en el lugar m√°s sagrado.  Creo que todos conocen un t√©rmino como "ajuste de chip", en ruso, este es un firmware simple para unidades de control (motor, caja de cambios, etc.).  El fabricante del equipo inicialmente establece la funcionalidad en sus dispositivos para actualizar o cambiar el software del microcontrolador, pero su mecanismo no se revela a nadie por razones obvias, y para complicar este proceso, el programa en s√≠, con el que funciona con memoria no vol√°til, no se almacena en el firmware, sino que se carga en el firmware. controlador solo en el momento del servicio.  Este art√≠culo trata sobre c√≥mo hacer que el microcontrolador del tablero ejecute el c√≥digo de otra persona mientras tiene acceso al conector de diagn√≥stico autom√°tico. <br><a name="habracut"></a><br>  En general, el mecanismo de carga de datos en la ECU (unidad de control electr√≥nico) se describe en el protocolo de diagn√≥stico <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UDS</a> , a saber, las funciones: <br><br>  <b>34 - Solicitar descarga</b> <b><br></b>  <b>36 - Transferencia de datos</b> <br><br>  Pero en t√©rminos de implementar UDS, los fabricantes de autom√≥viles no son aprensivos para hacer cambios / adiciones al protocolo, creando un complemento propietario.  En mi caso, el proceso de actualizaci√≥n se ve as√≠: <br><br><ol><li>  Iniciar sesi√≥n en una sesi√≥n de diagn√≥stico extendida </li><li>  Reiniciar en el gestor de arranque </li><li>  Obtenci√≥n de acceso de seguridad para permitir una operaci√≥n de carga de datos </li><li>  Transferencia de la direcci√≥n en la memoria donde se guardar√° el volumen de registros y datos. </li><li>  Carga de datos </li><li>  Haciendo lo que estaba cargado </li><li>  Lo siguiente es programar la EEPROM con el programa que descargaste antes. </li></ol><br>  Los puntos 1-3 no fueron dif√≠ciles, pero ¬øqu√© hacer a continuaci√≥n?  ¬øD√≥nde obtener la direcci√≥n y la cantidad m√°xima de datos?  ¬øC√≥mo despu√©s del arranque hacer lo que se descarg√≥?  En realidad, por el bien de esto, se est√° escribiendo un art√≠culo. <br><br>  Se eligi√≥ una combinaci√≥n de dispositivos como sujeto de prueba, porque, en primer lugar, tengo uno m√°s en caso de un apocalipsis, y en segundo lugar, su controlador se puede leer con un simple adaptador USB-RS232.  Habiendo estudiado el interior, tenemos el controlador Fujitsu MB91F223.  Este es un micr√≥n de 32 bits con un n√∫cleo FR60Lite, 512 KB de memoria y 16 KB de RAM.  Hoja de datos, RM, manual del ensamblador, un programador para buscarlo f√°cilmente en Internet, no me detendr√© aqu√≠.  Aqu√≠ √©l es guapo: <br><br><img src="https://habrastorage.org/webt/rg/02/dp/rg02dpmoegxxftuytny98ozj-8y.jpeg"><br><br>  Plan de acci√≥n: <br><br><ol><li>  Encuentre manejadores de solicitud de diagn√≥stico </li><li>  Encuentra direcciones en la memoria donde puedes escribir algo </li><li>  Encuentre una forma de ejecutar c√≥digo grabado </li></ol><br>  Para realizar el paso 1, debe estudiar el controlador de interrupciones desde el bus CAN y comprender d√≥nde se almacenan los datos para su posterior procesamiento.  Muchos controladores tienen una llamada tabla de vectores de interrupci√≥n, que contiene las direcciones de las funciones responsables de procesarlos.  En la familia Fujitsu FR, esta tabla est√° en su industria, y el puntero a esta se almacena en el registro TBR (registro base de tabla).  Una simple b√∫squeda de texto en la IDA da un resultado positivo y la direcci√≥n de la tabla de interrupciones con nosotros. <br><br><img src="https://habrastorage.org/webt/mh/7p/ia/mh7piaj9bhse6fozuoafhefnumk.jpeg"><br><br>  Seg√∫n el manual, la direcci√≥n de interrupci√≥n CAN se encuentra en el desplazamiento 0x370 desde el comienzo del TBR.  Ah√≠ est√°. <br><br><img src="https://habrastorage.org/webt/lj/vy/2t/ljvy2ttce6rnwnohdx0zutbdct0.png"><br><br><div class="spoiler">  <b class="spoiler_title">√âl, pero ya en pleno crecimiento, tambi√©n es un manejador de mensajes que utiliza el protocolo ISO-TP</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/aw/5i/59/aw5i599go63z2o1kmyvescaz4uq.png"><br>  El controlador ISO-TP no est√° completo, pero donde los marcos de diferentes tipos divergen <br><img src="https://habrastorage.org/webt/kk/-z/2d/kk-z2dgsfkzyqfj-h7qplp_l6-e.png"><br></div></div><br>  Desde la base de datos del software de diagn√≥stico del distribuidor, ten√≠a los identificadores SID y LID (31E1) del protocolo UDS que inici√≥ el procedimiento de ejecuci√≥n del c√≥digo, esto simplific√≥ la tarea y me permiti√≥ actuar desde el principio hasta el principio.  En el controlador de funciones 31E1, se encontr√≥ un fragmento donde se carga la direcci√≥n que pertenece al √°rea de RAM, y luego se realiza una llamada a esta direcci√≥n.  ¬øNo es esto lo que estamos buscando? <br><br><img src="https://habrastorage.org/webt/_y/xv/zw/_yxvzwljw0jjf73z7478j3hhans.png"><br><br>  La b√∫squeda del uso de la constante 0x3F100 nos lleva a otro lugar en el firmware, al controlador de funciones UDS 34: ¬°solicite la descarga!  Esto es exactamente lo que necesita, se encuentra la direcci√≥n para escribir datos y la cantidad m√°xima (0x700 bytes) en RAM. <br><br><img src="https://habrastorage.org/webt/_2/ek/jq/_2ekjqd-pqyahjuez8mztaa8l-0.png"><br><br>  Ahora, despu√©s de enviar un comando para solicitar permiso para descargar datos 34 <b>03F100</b> 00 <i>00010C</i> (la direcci√≥n que se muestra en cursiva se indica en negrita), el tablero responde con un buen 740401 en respuesta. A continuaci√≥n, los datos del usuario se cargan usando la funci√≥n Transferir datos y se emite un comando para cumplir  Descubrimos la carga y ejecuci√≥n, pero ahora necesita encontrar qu√© descargar.  No encontr√© un entorno de desarrollo de c√≥digo abierto para este microcontrolador, pero despu√©s de un mes hubo un golpe en el soporte t√©cnico de cipreses (s√≠, no fujitsu, o los absorbieron, en general, no lo s√©) dieron un enlace a un IDE llamado Shaggy Softune Workbench 97 a√±os con los que el compilador vino bajo el n√∫cleo FR. <br><br>  Eso es lo que parece, no un par vscode. <br><br>  En la captura de pantalla, un fragmento del programa para parpadear LED (no patear por el estilo de escritura en ensamblador, esta es mi primera experiencia). <br><br><img src="https://habrastorage.org/webt/1c/7o/rb/1c7orby5-1pllaw12rz-ms3wut8.png"><br><br>  El mismo c√≥digo, pero ya en si <br><br><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delay</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> loops)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(--loops) { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> asm NOP NOP #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> endasm __asm(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" nop"</span></span></span><span class="hljs-meta">); } } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> DDR2 (*((char*)0x402)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> PDR2 (*((char*)0x2)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WPR (*((char*)0x485)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> LVRC (*((char*)0x57D)) void wdt_reset(void) { WPR = 0xA5; WPR = 0x5A; LVRC = 0x10; } void main(void) { int current_pin = 2; DDR2 |= 0x7E; while(1) { wdt_reset(); PDR2 |= current_pin; delay(0x7FFF); PDR2 &amp;= ~current_pin; delay(0x7FFF); current_pin </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;&lt;= 1; if(current_pin &gt;= 0x80) { current_pin = 2; } } }</span></span></span></span></code> </pre> <br>  Bueno, el resultado en s√≠ <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Z8vsqunIUuM" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Con otros nodos, todo se ve m√°s o menos igual, con la excepci√≥n de la arquitectura del controlador y el orden en que se ejecutan los comandos.  ¬øEs seguro dejar tales lagunas en los equipos automotrices?  Aparentemente s√≠, ya que el fabricante lo hace.  ¬øPor qu√© estoy haciendo esto?  Fue interesante, bueno, el ensamblador me interes√≥ durante mucho tiempo, lo conoc√≠, por as√≠ decirlo. <br><br>  Asunto: panel de instrumentos Mitsubishi 8100B197, la comunicaci√≥n en el bus CAN se realiz√≥ mediante el adaptador Tactrix OpenPort 2.0, software en una computadora de dise√±o propio. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/474718/">https://habr.com/ru/post/474718/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../474708/index.html">Internet est√° m√°s fragmentado que nunca: ¬øa d√≥nde "llegan" m√°s de un mill√≥n de nuevos usuarios diariamente? Parte 1</a></li>
<li><a href="../474710/index.html">c.tech: Frontend Meetup # 2</a></li>
<li><a href="../474712/index.html">Udalenka en TI: experiencia personal</a></li>
<li><a href="../474714/index.html">Caracter√≠sticas del comercio minorista nacional, o c√≥mo prob√© la fuerza de la tecnolog√≠a francesa</a></li>
<li><a href="../474716/index.html">Errores C ++ 20. Resultados de la reuni√≥n en Belfast</a></li>
<li><a href="../474720/index.html">El laboratorio de radio de Nizhny Novgorod y los "cristadins" de Losev</a></li>
<li><a href="../474722/index.html">"Nadie les dice a los dem√°s lo que deben hacer": Nicol√≤ Ribaudo sobre el desarrollo de Babel y m√°s</a></li>
<li><a href="../474724/index.html">¬øQu√© pasar√° con PHP en 5 a√±os? Le preguntamos a los hablantes del mitap de Mosc√∫ m√°s cercano.</a></li>
<li><a href="../474726/index.html">Incluso los ni√±os entender√°n: una explicaci√≥n simple de async / wait y promesas en JavaScript</a></li>
<li><a href="../474732/index.html">Trabaje con la lista de pines, en C ++ para microcontroladores (usando CortexM como ejemplo)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>