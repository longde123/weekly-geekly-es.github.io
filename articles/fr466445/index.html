<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòπ ‚ôøÔ∏è üåæ Attaques entre approbations entre domaines ‚úçüèø ü§õüèª ü•¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="T√¥t ou tard, pendant le pentest, la t√¢che se pose de compromettre la for√™t enti√®re - √† condition qu'il y ait des droits dans l'un des domaines. √Ä de t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Attaques entre approbations entre domaines</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jetinfosystems/blog/466445/"><img src="https://habrastorage.org/webt/ki/6u/o8/ki6uo88vz8xcqbapiyvfwn4sc-s.jpeg"><br><br>  T√¥t ou tard, pendant le pentest, la t√¢che se pose de compromettre la for√™t enti√®re - √† condition qu'il y ait des droits dans l'un des domaines.  √Ä de tels moments, de nombreuses questions se posent concernant les fiducies, leurs propri√©t√©s et les attaques elles-m√™mes.  Essayons de tout comprendre. <br><a name="habracut"></a><br>  La confiance entre les domaines est utilis√©e pour authentifier les utilisateurs d'un domaine sur le contr√¥leur d'un autre domaine.  En d'autres termes, pour que les utilisateurs du domaine A puissent avoir acc√®s aux ressources du domaine B. La structure du domaine peut √™tre de deux types: <br><br><ul><li>  Arbres de domaine </li><li>  for√™ts de domaine. </li></ul><br><img src="https://habrastorage.org/webt/5w/zx/4c/5wzx4cfoai1nwiwk6rissbhy4cu.png"><br><br>  Lors de la cr√©ation d'une arborescence de domaines entre les domaines, par d√©faut, les approbations transitives sont √©tablies.  Tous les ordinateurs ont en commun: <br><br><ul><li>  catalogue global </li><li>  espace de noms </li><li>  r√©gime. </li></ul><br>  Les arbres de domaine peuvent √™tre combin√©s en for√™ts.  Lors de la cr√©ation d'une for√™t de domaine, des approbations transitives sont √©tablies et tous les ordinateurs de la for√™t partagent les √©l√©ments suivants: <br><br><ul><li>  catalogue global </li><li>  r√©gime. </li></ul><br>  Le tableau ci-dessous montre les types d'approbation entre les domaines et leurs propri√©t√©s. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Non. </td><td>  Type de confiance </td><td>  Transitivit√© </td><td>  Direction </td><td>  M√©canisme d'authentification </td><td>  La description </td></tr><tr><td>  1 </td><td>  Externe </td><td>  Non transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  NTLM uniquement </td><td>  Ils sont install√©s entre des domaines appartenant √† des for√™ts diff√©rentes ou avec un domaine Windows NT 4.0. </td></tr><tr><td>  2 </td><td>  Royaume </td><td>  Transitive ou non transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  Kerberos uniquement </td><td>  Install√© entre les domaines Windows et non Windows √† l'aide du protocole Kerberos.  Ce type d'approbation peut √™tre utilis√© pour fournir une authentification de bout en bout sur les syst√®mes Windows et UNIX. </td></tr><tr><td>  3 </td><td>  La for√™t </td><td>  Transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Situ√© entre les for√™ts.  Dans le m√™me temps, les administrateurs d√©cident eux-m√™mes si la relation sera bilat√©rale ou unilat√©rale. </td></tr><tr><td>  4 </td><td> Raccourci </td><td>  Transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Situ√© entre les domaines d'arbres diff√©rents appartenant √† la m√™me for√™t.  Utilis√© pour r√©duire le chemin de la confiance, augmentant ainsi l'efficacit√© de l'interaction entre les deux domaines. </td></tr><tr><td>  5 </td><td>  Parent-enfant </td><td>  Transitive </td><td>  Bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Ils sont install√©s automatiquement lorsqu'un nouveau domaine est cr√©√© dans l'arborescence.  Dans une arborescence de domaine, les relations sont d√©crites par le sch√©ma parent-enfant. </td></tr><tr><td>  6 </td><td>  Confiance √† la racine de l'arbre </td><td>  Transitive </td><td>  Bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Install√© automatiquement lorsqu'une nouvelle arborescence de domaine est cr√©√©e dans une for√™t existante.  En fait, la confiance s'√©tablit entre le domaine racine de la for√™t et le domaine cr√©√©, qui sera la racine de la nouvelle arborescence. </td></tr></tbody></table></div><br>  Plus clairement, les types d'approbations entre domaines sont illustr√©s dans l'image ci-dessous. <br><br><img src="https://habrastorage.org/webt/jp/mc/eo/jpmceokjm7kwra_mhgfrw3n8tc0.png"><br><br><h4>  Transitivit√© </h4><br>  La transitivit√© est n√©cessaire pour d√©finir la confiance en dehors des deux domaines entre lesquels elle a √©t√© form√©e et est utilis√©e pour √©tendre les relations de confiance avec d'autres domaines.  Si nous ajoutons un domaine enfant au domaine, une relation d'approbation bidirectionnelle est √©tablie entre les domaines parent et enfant.  Ces relations sont transitives, c'est-√†-dire  si le domaine A approuve le domaine D et le domaine D approuve le domaine E, le domaine A approuve √©galement le domaine E. <br><br><img src="https://habrastorage.org/webt/xv/wb/wf/xvwbwfp8-uopt2k_bmlk5y0onci.png"><br><br>  La confiance non transitoire peut √™tre utilis√©e pour refuser la confiance avec d'autres domaines. <br><br><h4>  Direction </h4><br>  Un chemin de relation d'approbation est une s√©rie de relations d'approbation entre des domaines auxquels des demandes d'authentification doivent √™tre re√ßues.  En d'autres termes, avant d'authentifier un utilisateur, la confiance entre les domaines est d√©termin√©e.  Pour que les utilisateurs du domaine A acc√®dent aux ressources du domaine D, le domaine D doit approuver le domaine A. <br><br>  La direction de la confiance est de deux types: <br><br><ul><li>  unilat√©ral; </li><li>  bilat√©rale. </li></ul><br>  La confiance unidirectionnelle est un chemin d'authentification unidirectionnel cr√©√© entre deux domaines.  Dans une approbation unidirectionnelle entre le domaine A et le domaine B, les utilisateurs du domaine B ont acc√®s aux ressources du domaine A. Cependant, les utilisateurs du domaine A n'ont pas acc√®s aux ressources du domaine B. Ce type d'approbation n'est pas transitoire. <br><br>  La confiance bilat√©rale est une combinaison de deux relations de confiance unidirectionnelles.  Dans une confiance bidirectionnelle entre les domaines A et B, leurs utilisateurs ont acc√®s aux ressources des deux domaines.  Ce type de confiance est transitoire. <br><br>  La direction de la confiance est toujours oppos√©e √† la direction de l'acc√®s.  Diagramme repr√©sentatif de Microsoft ci-dessous: <br><img src="https://habrastorage.org/webt/r2/d6/jo/r2d6jope8ji-ivoblptob-s5y94.png"><br>  Liens pour des types d'approbation plus approfondis: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Confiance externe</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Royaume</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La for√™t</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Raccourci</a> </li></ul><br><h4>  Kerberos entre domaines approuv√©s </h4><br>  Prenons un exemple.  Le client tente d'acc√©der au serveur. <br><br><div class="spoiler">  <b class="spoiler_title">Des points 1 √† 3, des actions standard se produisent lors de l'utilisation du protocole Kerberos.</b> <div class="spoiler_text"><ul><li>  Le mot de passe est converti en hachage NTLM, l'horodatage est chiffr√© avec un hachage et envoy√© √† KDC en tant qu'authentificateur dans la demande de ticket TGT (AS-REQ).  Le contr√¥leur de domaine (KDC) v√©rifie les informations utilisateur et cr√©e un ticket TGT. </li><li>  Le ticket TGT est crypt√©, sign√© et envoy√© √† l'utilisateur (AS-REP).  Seul le service Kerberos (KRBTGT) peut ouvrir et lire les donn√©es d'un ticket TGT. </li><li>  Un utilisateur soumet un ticket TGT √† un contr√¥leur de domaine lors de la demande d'un ticket TGS (TGS-REQ).  Le contr√¥leur de domaine ouvre un ticket TGT et v√©rifie la somme de contr√¥le PAC. </li></ul><br></div></div><br>  Les changements commencent √† partir du point 4: un ticket TGT inter-domaine appara√Æt, le soi-disant ticket de r√©f√©rence, qui est crypt√© / sign√© avec une cl√© inter-domaine cr√©√©e √† partir d'un mot de passe de confiance.  Un mot de passe approuv√© est d√©fini lors de l'√©tablissement de l'approbation et est connu des deux contr√¥leurs de domaine.  √Ä l'aide du ticket TGT inter-domaines, un utilisateur du domaine 1 peut demander un ticket TGS pour acc√©der aux ressources du domaine 2. <br><br><img src="https://habrastorage.org/webt/s4/3v/hj/s43vhjcgbdqvzebpjmra7d2cr_g.png"><br><br><h4>  NTLM entre domaines approuv√©s </h4><br><img src="https://habrastorage.org/webt/v2/2c/x4/v22cx4pt6iw7mlgxrlus2t3xdqs.png"><br><br><ol><li>  Le client envoie une demande d'authentification directement √† la ressource elle-m√™me, situ√©e dans un autre domaine, √† laquelle il souhaite acc√©der. </li><li>  Le serveur re√ßoit une demande du client et lui envoie une r√©ponse CHALLENGE_MESSAGE, qui contient une s√©quence al√©atoire de 8 octets.  Il s'agit du Server Challenge. </li><li>  Le client, apr√®s avoir re√ßu la s√©quence Server Challenge du serveur, crypte cette s√©quence avec son mot de passe, puis envoie au serveur une r√©ponse qui contient 24 octets. </li><li>  Le serveur envoie une requ√™te et une r√©ponse au contr√¥leur de son domaine B. </li><li>  Dans le cas d'une authentification entre approbations, la logique suivante est effectu√©e: <br><br><ul><li>  Relations d'approbation de direction v√©rifi√©es. <br><ul><li>  Les informations d'identification du client sont envoy√©es au domaine A pour s'authentifier. </li><li>  S'il n'y a pas de relation d'approbation, la transitivit√© est v√©rifi√©e avec le domaine A. </li></ul><br></li><li>  V√©rification de la transivit√© entre les domaines <br><ul><li>  En cas de transitivit√© entre les domaines, une demande d'authentification est envoy√©e au domaine suivant dans le chemin de confiance.  Ce contr√¥leur de domaine r√©p√®te le processus, v√©rifiant les informations d'identification de l'utilisateur par rapport √† sa base de donn√©es de comptes de s√©curit√©. </li><li>  S'il n'y a pas de transitivit√©, un message d'acc√®s refus√© est renvoy√© au client. </li></ul><br></li></ul><br>  6-8.  La r√©ponse avec la d√©cision d'authentifier le client. <br><br><h1>  Attaques entre approbations entre domaines </h1><br>  Donc, pour mener une attaque, nous avons besoin d'informations sur les relations de confiance dans notre domaine. <br><br><h4>  Cotation des fiducies </h4><br>  Il existe 3 m√©thodes principales pour r√©pertorier les approbations dans un domaine: <br><br><ol><li>  via l'API Win32; </li><li>  via les m√©thodes .NET; </li><li>  via LDAP. </li></ol><br>  <b><i>API Win32</i></b> <br><br>  L'√©num√©ration est effectu√©e en appelant la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DsEnumerateDomainTrusts</a> , qui renvoie la structure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DS_DOMAIN_TRUSTSA</a> .  En utilisant cette m√©thode, le SID et le GUID du domaine cible, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">indicateurs</a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">attributs</a> caract√©risant la confiance actuelle dans le domaine sont renvoy√©s. <br><br><div class="spoiler">  <b class="spoiler_title">Drapeaux</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  DS_DOMAIN_DIRECT_INBOUND </td><td>  √ânum√©rer les domaines qui approuvent directement le domaine dont ServerName est membre. </td></tr><tr><td>  DS_DOMAIN_DIRECT_OUTBOUND </td><td>  √ânum√©rer les domaines directement approuv√©s par le domaine dont ServerName est membre. </td></tr><tr><td>  DS_DOMAIN_IN_FOREST </td><td>  √ânum√©rer les domaines qui sont membres de la m√™me for√™t qui a ServerName comme membre. </td></tr><tr><td>  DS_DOMAIN_NATIVE_MODE </td><td>  √ânum√©rer les domaines o√π le domaine principal s'ex√©cute en mode natif Windows 2000. </td></tr><tr><td>  DS_DOMAIN_PRIMARY </td><td>  √ânum√©rer les domaines qui sont le domaine principal du domaine dont ServerName est membre. </td></tr><tr><td>  DS_DOMAIN_TREE_ROOT </td><td>  √ânum√©rer les domaines qui se trouvent √† la racine de la for√™t dont ServerName est membre. </td></tr></tbody></table></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Attributs</b> <div class="spoiler_text"><br><br><div class="scrollable-table"><table><tbody><tr><td>  TRUST_ATTRIBUTE_NON_TRANSITIVE </td><td>  Interdisez la transitivit√©. </td></tr><tr><td>  TRUST_ATTRIBUTE_UPLEVEL_ONLY </td><td>  Le lien d'approbation n'est pas valide pour les syst√®mes d'exploitation clients ant√©rieurs √† Windows 2000. </td></tr><tr><td>  TRUST_ATTRIBUTE_FILTER_SIDS </td><td>  Domaines de quarantaine. </td></tr><tr><td>  TRUST_ATTRIBUTE_FOREST_TRANSITIVE </td><td>  Le lien d'approbation peut contenir des informations d'approbation de for√™t. </td></tr><tr><td>  TRUST_ATTRIBUTE_CROSS_ORGANIZATION </td><td>  Cette approbation concerne un domaine / for√™t qui ne fait pas partie de cette entreprise. </td></tr><tr><td>  TRUST_ATTRIBUTE_TREAT_AS_EXTERNAL </td><td>  La confiance est trait√©e comme externe √† des fins de limite de confiance. </td></tr><tr><td>  TRUST_ATTRIBUTE_WITHIN_FOREST </td><td>  La confiance est interne √† cette for√™t. </td></tr></tbody></table></div><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BloodHound</a> collecte des informations √† l'aide de la m√©thode API Win32. <br><br><img src="https://habrastorage.org/webt/d4/hq/df/d4hqdf50vvyi6k4b2bv6dbcnekw.png"><br><br>  <b><i>.Net</i></b> <br><br>  La m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GetCurrentDomain</a> de l'espace de noms [System.DirectoryServices.ActiveDirectory.Domain] est utilis√©e, qui renvoie une instance de la classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">System.DirectoryServices.ActiveDirectory.Domain</a> .  Cette classe impl√©mente la m√©thode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GetAllTrustRelationships</a> , qui renvoie toutes les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">approbations</a> du domaine actuel. <br><br><pre><code class="bash hljs">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</code> </pre> <br>  L'utilisation de cette m√©thode est impl√©ment√©e dans le module Get-DomainTrust dans <a href="">PowerView</a> . <br><br><img src="https://habrastorage.org/webt/bv/px/vf/bvpxvf6de-v4o3f04sp5mtrgdd0.png"><br><br>  Un des avantages de cette m√©thode est sa simplicit√©.  L'information est facile √† lire et √† comprendre, mais son volume est beaucoup plus petit que lors de l'√©num√©ration par d'autres m√©thodes. <br><br>  <b><i>LDAP</i></b> <br><br>  Les informations d'approbation de domaine sont stock√©es dans Active Directory en tant que classe d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">objet de la</a> classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">trustedDomain</a> . <br><br>  Exemple d'utilisation: <br><br><pre> <code class="bash hljs">dsquery * -filter <span class="hljs-string"><span class="hljs-string">"(objectClass=trustedDomain)"</span></span> -attr *</code> </pre> <br><img src="https://habrastorage.org/webt/oa/xc/2x/oaxc2xunppmfjl7vpjztuudgm5e.png"><br><br>  <a href="">PowerView</a> utilise cette m√©thode par d√©faut. <br><br><img src="https://habrastorage.org/webt/cx/p1/_w/cxp1_w24rxlh7-naqk5swez6vc4.png"><br><br>  Avec des informations sur les domaines et les types d'approbation, vous pouvez acc√©der directement √† l'attaque elle-m√™me.  Consid√©rez 2 options: <br><br><ol><li>  Nous avons r√©ussi √† compromettre le domaine et nous avons des droits d'administrateur de domaine. </li><li>  Nous n'avons pas de droits d'administrateur de domaine. </li></ol><br><h2>  Avec des droits d'administrateur sur l'un des domaines </h2><br>  Selon le domaine compromis, plusieurs vecteurs d'attaque peuvent √™tre distingu√©s: <br><br><br><div class="scrollable-table"><table><tbody><tr><td>  Non. </td><td>  D√©marrer le domaine  Position de l'attaquant </td><td>  Domaine attaqu√© </td><td>  Technique d'attaque </td><td>  Relation de confiance </td></tr><tr><td>  1 </td><td>  Racine </td><td>  Enfant </td><td>  Golden Ticket + Groupe Admin Entreprise </td><td>  Inter-royaume (2 voies) </td></tr><tr><td>  2 </td><td>  Enfant </td><td>  Enfant </td><td>  Fonctionnement de l'historique SID </td><td>  Parent-enfant inter-royaumes (2 voies) </td></tr><tr><td>  3 </td><td>  Enfant </td><td>  Racine </td><td>  Fonctionnement de l'historique SID <br>  Trust Trust Operation </td><td>  Racine d'arbre inter-domaines (2 voies) </td></tr><tr><td>  4 </td><td>  For√™t 1 </td><td>  For√™t 2 </td><td>  Bug d'imprimante </td><td>  For√™t inter-royaumes ou Approbation externe (bidirectionnelle) </td></tr></tbody></table></div><br>  Il convient de noter que pour une mise en ≈ìuvre r√©ussie de tous les vecteurs, une confiance bilat√©rale entre les domaines est n√©cessaire. <br><br><h4>  <i>1. Historique de l'op√©ration SID</i> </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'historique SID a</a> √©t√© introduit pour faciliter la migration des utilisateurs d'un domaine √† un autre.  L'attribut contient les objets SID pr√©c√©dents.  Chaque fois qu'un objet passe d'un domaine √† un autre, un nouveau SID est cr√©√©, qui devient un objectSID.  Le SID pr√©c√©dent est ajout√© √† la propri√©t√© sIDHistory. <br><br>  Chaque for√™t a un groupe d'utilisateurs Enterprise Admins qui n'existe que dans le domaine racine et dispose de droits d'administrateur local sur les contr√¥leurs de domaine de tous les domaines enfants de la for√™t.  Cette attaque a √©t√© d√©montr√©e pour la premi√®re fois par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sean Metcalf</a> au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BlackHat USA 2015</a> .  L'essence de l'attaque est que nous √©mettons un ticket d'or avec l'ajout d'un SID suppl√©mentaire du groupe Enterprise Admins.  Cela se fait en ajoutant des ExtraSids dans la structure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">KERB_SID_AND_ATTRIBUTES</a> , qui est envoy√©e dans la structure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">KERB_VALIDATION_INFO</a> . <br><br><img src="https://habrastorage.org/webt/kl/hy/fj/klhyfjzath65qptysuylgzft-fk.png"><br><br>  D√©mo d'attaque: <br><br><img src="https://habrastorage.org/webt/v6/ia/1g/v6ia1gvjk-sxs7x8plq6uvwojjk.gif"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Impacket</a> a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script</a> qui automatise tout cela. <br><br><h4>  <i>2. Golden Admin + Enterprise Admin Group</i> </h4><br>  Ayant des droits d'administrateur dans le domaine racine, nous pouvons cr√©er un Golden Ticket avec l'ajout d'un utilisateur au groupe Enterprise Admins (519). <br><br><pre> <code class="bash hljs">Kerberos::golden /domain:&lt;domain&gt; /sid:&lt;domain_SID&gt; /krbtgt:&lt;ntlm_hash_krbtgt_user&gt; /user:&lt;user&gt; /groups:500,501,513,512,520,518,519 /ptt</code> </pre> <br>  Comme d√©crit ci-dessus, Enterprise Admin dispose de droits d'administrateur local sur les domaines DC Child.  Ainsi, nous pourrons compromettre tous les domaines enfants de la for√™t. <br><br><h4>  <i>3. Fonctionnement des tickets de fiducie</i> </h4><br>  Pour acc√©der √† une ressource √† l'aide du protocole Kerberos, vous avez besoin d'un ticket TGS, qui est chiffr√© avec le hachage NTLM du mot de passe du compte de service.  Un contr√¥leur de domaine stocke uniquement des hachages de mots de passe utilisateur pour son domaine. Ainsi, lorsqu'un utilisateur du domaine A a besoin d'acc√©der √† une ressource du domaine B, une cl√© inter-domaine est utilis√©e.  Cette cl√© est cr√©√©e sur la base d'un mot de passe approuv√©, qui est d√©fini lors de la cr√©ation de relations d'approbation entre les domaines de la m√™me for√™t.  Dans la base de donn√©es de mots de passe (NTDS.dit) sur le contr√¥leur de domaine, vous pouvez trouver des utilisateurs avec le signe $ √† la fin.  Leur mot de passe est √©galement utilis√© pour cr√©er des cl√©s inter-domaines.  Pour cr√©er un ticket TGT inter-domaines, nous avons besoin d'un hachage de mot de passe de ce compte. <br><br><pre> <code class="bash hljs">Kerberos::golden /user:&lt;user&gt; /domain:&lt;domain&gt; /sid:&lt;sid_domain&gt; /sids:&lt;extra_sid_entrprice_admin_group_from _another_domain&gt; /aes256:&lt;aes256_trust_user_password&gt; /service:krbtgt /target:&lt;target_domain&gt; /ptt</code> </pre> <br>  D√©mo d'attaque: <br><br><img src="https://habrastorage.org/webt/fk/cv/ji/fkcvjizxaup946gngi9zsk6xqm8.gif"><br><br>  L'attaque est particuli√®rement pertinente lorsque le service IS a remarqu√© une menace et a chang√© le mot de passe krbtgt 2 fois.  Dans ce cas, nous pourrons cr√©er des tickets d'or en utilisant un mot de passe de confiance entre les domaines. <br><br><h4>  <i>4. Bug d'imprimante</i> </h4><br>  Le protocole distant du syst√®me d'impression Windows (MS-RPRN) a la m√©thode RpcRemoteFindFirstPrinterChangeNotification (Ex) activ√©e par d√©faut, qui vous permet de forcer l'authentification sur tout ordinateur ex√©cutant le service Spouleur sur l'h√¥te sp√©cifi√© √† l'aide du protocole Kerberos ou NTLM.  Dans le cas de c NTLM, nous pouvons ex√©cuter NTLM-relay, ou commencer √† casser le mot de passe de l'ordinateur (ne jamais d√©cocher).  Dans le cas de Kerberos, une machine compromise avec d√©l√©gation illimit√©e est n√©cessaire.  Ensuite, nous pouvons prendre un ticket TGT et d√©velopper une attaque. <br><br>  D√©mo d'attaque: <br><br><img src="https://habrastorage.org/webt/3g/h9/gf/3gh9gfnx0b6k8hucav8zy964ap0.gif"><br><br>  La figure ci-dessous montre les √©tapes illustr√©es dans la vid√©o. <br><br><img src="https://habrastorage.org/webt/cu/e0/0l/cue00l2_x_fdpsxj0vyalrvjscs.png"><br><br><h2>  Nous n'avons pas de droits d'administrateur de domaine </h2><br>  Un peu de th√©orie.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Carlos Garsia</a> dans son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport a</a> donn√© un excellent tableau qui illustre les propri√©t√©s de diff√©rents types de groupes. <br><br><img src="https://habrastorage.org/webt/jz/5x/jc/jz5xjcruevdpcv_jnz1knoyh1oi.png"><br><br>  Parmi les fonctionnalit√©s, il convient de consid√©rer <a href="">que les groupes AD Domain Local et AD Global sont r√©pliqu√©s sans membres de groupe dans le catalogue global et que les groupes AD Universal sont r√©pliqu√©s avec les utilisateurs.</a> <br><blockquote>  En raison de la fa√ßon dont les groupes sont √©num√©r√©s par le catalogue global, les r√©sultats d'une recherche de lien arri√®re [c.-√†-d. Les membres peuvent varier, selon que vous recherchez le catalogue global (port 3268) ou le domaine (port 389), le type de groupes auxquels l'utilisateur appartient (groupes globaux vs groupes locaux de domaine). </blockquote>  Dans le cas o√π nous n'avons pas de droits d'administrateur de domaine, nous √©num√©rons les objets.  Nous sommes int√©ress√©s par: <br><ol><li>  Utilisateurs d'un autre domaine disposant de droits d'administrateur local sur les machines de notre domaine. </li><li>  Utilisateurs d'autres domaines membres de groupes de domaines d'utilisateurs.  Groupes contenant des utilisateurs d'un autre domaine. </li><li>  Responsables ACL √©trangers. </li></ol><br><h4>  <i>1. Utilisateurs d'un autre domaine disposant de droits d'administrateur local sur les machines de notre domaine</i> </h4><br>  Recherchez les utilisateurs d'un autre domaine qui sont des administrateurs locaux sur les h√¥tes de notre domaine dans BloodHound: <br><br><pre> <code class="bash hljs">MATCH (c:Computer) OPTIONAL MATCH p1 = (u1)-[:AdminTo]-&gt;(c) WHERE NOT u1.domain = c.domain WITH p1,c OPTIONAL MATCH p2 = (u2)-[:MemberOf*1..]-&gt;(:Group)-[:AdminTo]-&gt;(c) WHERE NOT u2.domain = c.domain RETURN p1,p2</code> </pre><br><img src="https://habrastorage.org/webt/07/2y/92/072y92dgtftil5yz9uvrgv8ui3a.png"><br><br>  Commande dans <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-NetLocalGroupMember &lt;server&gt;</code> </pre> <br><h4>  <i>2. Utilisateurs d'autres domaines, compos√©s de groupes de domaines d'utilisateurs.</i>  <i>Groupes contenant des utilisateurs d'un autre domaine</i> </h4><br>  Comme mentionn√© ci-dessus, les utilisateurs qui sont membres de groupes Universal uniquement sont r√©pliqu√©s dans le catalogue global.  Pour illustrer cette fonctionnalit√©, nous interrogerons les groupes du catalogue global qui contiennent au moins un utilisateur et une demande LDAP directe au contr√¥leur de domaine. <br><br><pre> <code class="bash hljs">Get-DomainGroup -Properties name, grouptype, member, DistinguishedName -LDAPFilter <span class="hljs-string"><span class="hljs-string">'(member=*)'</span></span> -SearchBase <span class="hljs-string"><span class="hljs-string">"GC://jet.lab"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/vr/zv/sd/vrzvsdj1pez6rn-ndb4_zcklpdu.png"><br><br>  Lors de l'ex√©cution d'une requ√™te dans le catalogue global, nous ne voyons qu'un seul groupe Universal Group de type AD Universal du domaine one.jet.lab. <br><br>  Si nous ex√©cutons une requ√™te LDAP directe sur one.jet.lab, nous verrons d'autres groupes de type AD Domain local et AD Global. <br><br><img src="https://habrastorage.org/webt/jf/3n/ku/jf3nkumv72dhsoyhb8kpqntq9ba.png"><br><br>  Ceci est important √† prendre en compte lors de l'√©num√©ration des utilisateurs et des groupes. <br><br>  Commandes dans <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-DomainForeignUser -Domain &lt;Domain&gt; Get-DomainForeignGroupMember -Domain &lt;Domain&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/ia/no/24/iano24rfj4ldithcbqhapwts4uk.png"><br><br><img src="https://habrastorage.org/webt/zf/2n/f-/zf2nf-tutgsxrzz99pdp6199fw0.png"><br><br><h4>  <i>3. Directeurs √©trangers de l'ACL</i> </h4><br>  Le descripteur de s√©curit√© ntSecurityDescriptor (https://docs.microsoft.com/en-us/windows/win32/adschema/a-ntsecuritydescriptor) est accessible √† tous les utilisateurs des domaines approuv√©s et est r√©pliqu√© dans le catalogue global.  Ainsi, nous pouvons interroger tous les DACL pour tous les objets dans les domaines de confiance et filtrer les utilisateurs d'autres domaines. <br><br><pre> <code class="bash hljs">Get-DomainObjectAcl -Domain jet.lab -ResolveGuids | ?{<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.SecurityIdentifier -like <span class="hljs-string"><span class="hljs-string">'SID_Domain*'</span></span>}</code> </pre> <br><img src="https://habrastorage.org/webt/fw/kn/si/fwknsimcsrubz0tputfddzosgr0.png"><br><br>  Nous avons donc r√©ussi √† identifier l'utilisateur Mike du domaine forestc.lab, qui avait des droits sur le groupe mondial dans le domaine jet.lab. <br><br>  Le filtrage PS SID et l'authentification s√©lective sont utilis√©s pour la protection entre les for√™ts.  Une attaque entre les for√™ts avec le filtrage SID a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">activ√© dirkjan</a> sur son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">blog</a> .  Le 9 juillet √©galement, Microsoft a publi√© une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mise √† jour</a> qui d√©sactive la d√©l√©gation TGT entre les for√™ts par d√©faut.  Maintenant, tout, l'histoire avec la d√©l√©gation illimit√©e et le compromis d'une for√™t √† l'autre en utilisant le protocole Kerberos ne fonctionne plus. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr466445/">https://habr.com/ru/post/fr466445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr466435/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 42. Routage inter-VLAN et SVI</a></li>
<li><a href="../fr466437/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 43. Protocoles de routage Distance du vecteur et √©tat de la liaison</a></li>
<li><a href="../fr466439/index.html">V√©rifiez vous-m√™me: combien de questions pouvez-vous r√©pondre √† ChGK?</a></li>
<li><a href="../fr466441/index.html">Code buggy Python: 10 erreurs les plus courantes que les d√©veloppeurs font</a></li>
<li><a href="../fr466443/index.html">ShIoTiny et le monde: capteurs analogiques ou ADC pour les plus petits</a></li>
<li><a href="../fr466447/index.html">Pourquoi devrions-nous construire un CDN?</a></li>
<li><a href="../fr466449/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 44. Introduction √† OSPF</a></li>
<li><a href="../fr466451/index.html">Read_You can't_throw</a></li>
<li><a href="../fr466453/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 45. Configuration d'OSPF</a></li>
<li><a href="../fr466455/index.html">Services, microservices et programmation orient√©e batch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>