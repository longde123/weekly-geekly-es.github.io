<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😹 ♿️ 🌾 Attaques entre approbations entre domaines ✍🏿 🤛🏻 🥦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tôt ou tard, pendant le pentest, la tâche se pose de compromettre la forêt entière - à condition qu'il y ait des droits dans l'un des domaines. À de t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Attaques entre approbations entre domaines</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jetinfosystems/blog/466445/"><img src="https://habrastorage.org/webt/ki/6u/o8/ki6uo88vz8xcqbapiyvfwn4sc-s.jpeg"><br><br>  Tôt ou tard, pendant le pentest, la tâche se pose de compromettre la forêt entière - à condition qu'il y ait des droits dans l'un des domaines.  À de tels moments, de nombreuses questions se posent concernant les fiducies, leurs propriétés et les attaques elles-mêmes.  Essayons de tout comprendre. <br><a name="habracut"></a><br>  La confiance entre les domaines est utilisée pour authentifier les utilisateurs d'un domaine sur le contrôleur d'un autre domaine.  En d'autres termes, pour que les utilisateurs du domaine A puissent avoir accès aux ressources du domaine B. La structure du domaine peut être de deux types: <br><br><ul><li>  Arbres de domaine </li><li>  forêts de domaine. </li></ul><br><img src="https://habrastorage.org/webt/5w/zx/4c/5wzx4cfoai1nwiwk6rissbhy4cu.png"><br><br>  Lors de la création d'une arborescence de domaines entre les domaines, par défaut, les approbations transitives sont établies.  Tous les ordinateurs ont en commun: <br><br><ul><li>  catalogue global </li><li>  espace de noms </li><li>  régime. </li></ul><br>  Les arbres de domaine peuvent être combinés en forêts.  Lors de la création d'une forêt de domaine, des approbations transitives sont établies et tous les ordinateurs de la forêt partagent les éléments suivants: <br><br><ul><li>  catalogue global </li><li>  régime. </li></ul><br>  Le tableau ci-dessous montre les types d'approbation entre les domaines et leurs propriétés. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Non. </td><td>  Type de confiance </td><td>  Transitivité </td><td>  Direction </td><td>  Mécanisme d'authentification </td><td>  La description </td></tr><tr><td>  1 </td><td>  Externe </td><td>  Non transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  NTLM uniquement </td><td>  Ils sont installés entre des domaines appartenant à des forêts différentes ou avec un domaine Windows NT 4.0. </td></tr><tr><td>  2 </td><td>  Royaume </td><td>  Transitive ou non transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  Kerberos uniquement </td><td>  Installé entre les domaines Windows et non Windows à l'aide du protocole Kerberos.  Ce type d'approbation peut être utilisé pour fournir une authentification de bout en bout sur les systèmes Windows et UNIX. </td></tr><tr><td>  3 </td><td>  La forêt </td><td>  Transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Situé entre les forêts.  Dans le même temps, les administrateurs décident eux-mêmes si la relation sera bilatérale ou unilatérale. </td></tr><tr><td>  4 </td><td> Raccourci </td><td>  Transitive </td><td>  Unidirectionnel ou bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Situé entre les domaines d'arbres différents appartenant à la même forêt.  Utilisé pour réduire le chemin de la confiance, augmentant ainsi l'efficacité de l'interaction entre les deux domaines. </td></tr><tr><td>  5 </td><td>  Parent-enfant </td><td>  Transitive </td><td>  Bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Ils sont installés automatiquement lorsqu'un nouveau domaine est créé dans l'arborescence.  Dans une arborescence de domaine, les relations sont décrites par le schéma parent-enfant. </td></tr><tr><td>  6 </td><td>  Confiance à la racine de l'arbre </td><td>  Transitive </td><td>  Bidirectionnel </td><td>  Kerberos ou NTLM </td><td>  Installé automatiquement lorsqu'une nouvelle arborescence de domaine est créée dans une forêt existante.  En fait, la confiance s'établit entre le domaine racine de la forêt et le domaine créé, qui sera la racine de la nouvelle arborescence. </td></tr></tbody></table></div><br>  Plus clairement, les types d'approbations entre domaines sont illustrés dans l'image ci-dessous. <br><br><img src="https://habrastorage.org/webt/jp/mc/eo/jpmceokjm7kwra_mhgfrw3n8tc0.png"><br><br><h4>  Transitivité </h4><br>  La transitivité est nécessaire pour définir la confiance en dehors des deux domaines entre lesquels elle a été formée et est utilisée pour étendre les relations de confiance avec d'autres domaines.  Si nous ajoutons un domaine enfant au domaine, une relation d'approbation bidirectionnelle est établie entre les domaines parent et enfant.  Ces relations sont transitives, c'est-à-dire  si le domaine A approuve le domaine D et le domaine D approuve le domaine E, le domaine A approuve également le domaine E. <br><br><img src="https://habrastorage.org/webt/xv/wb/wf/xvwbwfp8-uopt2k_bmlk5y0onci.png"><br><br>  La confiance non transitoire peut être utilisée pour refuser la confiance avec d'autres domaines. <br><br><h4>  Direction </h4><br>  Un chemin de relation d'approbation est une série de relations d'approbation entre des domaines auxquels des demandes d'authentification doivent être reçues.  En d'autres termes, avant d'authentifier un utilisateur, la confiance entre les domaines est déterminée.  Pour que les utilisateurs du domaine A accèdent aux ressources du domaine D, le domaine D doit approuver le domaine A. <br><br>  La direction de la confiance est de deux types: <br><br><ul><li>  unilatéral; </li><li>  bilatérale. </li></ul><br>  La confiance unidirectionnelle est un chemin d'authentification unidirectionnel créé entre deux domaines.  Dans une approbation unidirectionnelle entre le domaine A et le domaine B, les utilisateurs du domaine B ont accès aux ressources du domaine A. Cependant, les utilisateurs du domaine A n'ont pas accès aux ressources du domaine B. Ce type d'approbation n'est pas transitoire. <br><br>  La confiance bilatérale est une combinaison de deux relations de confiance unidirectionnelles.  Dans une confiance bidirectionnelle entre les domaines A et B, leurs utilisateurs ont accès aux ressources des deux domaines.  Ce type de confiance est transitoire. <br><br>  La direction de la confiance est toujours opposée à la direction de l'accès.  Diagramme représentatif de Microsoft ci-dessous: <br><img src="https://habrastorage.org/webt/r2/d6/jo/r2d6jope8ji-ivoblptob-s5y94.png"><br>  Liens pour des types d'approbation plus approfondis: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Confiance externe</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Royaume</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">La forêt</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Raccourci</a> </li></ul><br><h4>  Kerberos entre domaines approuvés </h4><br>  Prenons un exemple.  Le client tente d'accéder au serveur. <br><br><div class="spoiler">  <b class="spoiler_title">Des points 1 à 3, des actions standard se produisent lors de l'utilisation du protocole Kerberos.</b> <div class="spoiler_text"><ul><li>  Le mot de passe est converti en hachage NTLM, l'horodatage est chiffré avec un hachage et envoyé à KDC en tant qu'authentificateur dans la demande de ticket TGT (AS-REQ).  Le contrôleur de domaine (KDC) vérifie les informations utilisateur et crée un ticket TGT. </li><li>  Le ticket TGT est crypté, signé et envoyé à l'utilisateur (AS-REP).  Seul le service Kerberos (KRBTGT) peut ouvrir et lire les données d'un ticket TGT. </li><li>  Un utilisateur soumet un ticket TGT à un contrôleur de domaine lors de la demande d'un ticket TGS (TGS-REQ).  Le contrôleur de domaine ouvre un ticket TGT et vérifie la somme de contrôle PAC. </li></ul><br></div></div><br>  Les changements commencent à partir du point 4: un ticket TGT inter-domaine apparaît, le soi-disant ticket de référence, qui est crypté / signé avec une clé inter-domaine créée à partir d'un mot de passe de confiance.  Un mot de passe approuvé est défini lors de l'établissement de l'approbation et est connu des deux contrôleurs de domaine.  À l'aide du ticket TGT inter-domaines, un utilisateur du domaine 1 peut demander un ticket TGS pour accéder aux ressources du domaine 2. <br><br><img src="https://habrastorage.org/webt/s4/3v/hj/s43vhjcgbdqvzebpjmra7d2cr_g.png"><br><br><h4>  NTLM entre domaines approuvés </h4><br><img src="https://habrastorage.org/webt/v2/2c/x4/v22cx4pt6iw7mlgxrlus2t3xdqs.png"><br><br><ol><li>  Le client envoie une demande d'authentification directement à la ressource elle-même, située dans un autre domaine, à laquelle il souhaite accéder. </li><li>  Le serveur reçoit une demande du client et lui envoie une réponse CHALLENGE_MESSAGE, qui contient une séquence aléatoire de 8 octets.  Il s'agit du Server Challenge. </li><li>  Le client, après avoir reçu la séquence Server Challenge du serveur, crypte cette séquence avec son mot de passe, puis envoie au serveur une réponse qui contient 24 octets. </li><li>  Le serveur envoie une requête et une réponse au contrôleur de son domaine B. </li><li>  Dans le cas d'une authentification entre approbations, la logique suivante est effectuée: <br><br><ul><li>  Relations d'approbation de direction vérifiées. <br><ul><li>  Les informations d'identification du client sont envoyées au domaine A pour s'authentifier. </li><li>  S'il n'y a pas de relation d'approbation, la transitivité est vérifiée avec le domaine A. </li></ul><br></li><li>  Vérification de la transivité entre les domaines <br><ul><li>  En cas de transitivité entre les domaines, une demande d'authentification est envoyée au domaine suivant dans le chemin de confiance.  Ce contrôleur de domaine répète le processus, vérifiant les informations d'identification de l'utilisateur par rapport à sa base de données de comptes de sécurité. </li><li>  S'il n'y a pas de transitivité, un message d'accès refusé est renvoyé au client. </li></ul><br></li></ul><br>  6-8.  La réponse avec la décision d'authentifier le client. <br><br><h1>  Attaques entre approbations entre domaines </h1><br>  Donc, pour mener une attaque, nous avons besoin d'informations sur les relations de confiance dans notre domaine. <br><br><h4>  Cotation des fiducies </h4><br>  Il existe 3 méthodes principales pour répertorier les approbations dans un domaine: <br><br><ol><li>  via l'API Win32; </li><li>  via les méthodes .NET; </li><li>  via LDAP. </li></ol><br>  <b><i>API Win32</i></b> <br><br>  L'énumération est effectuée en appelant la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DsEnumerateDomainTrusts</a> , qui renvoie la structure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DS_DOMAIN_TRUSTSA</a> .  En utilisant cette méthode, le SID et le GUID du domaine cible, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">indicateurs</a> et les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">attributs</a> caractérisant la confiance actuelle dans le domaine sont renvoyés. <br><br><div class="spoiler">  <b class="spoiler_title">Drapeaux</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  DS_DOMAIN_DIRECT_INBOUND </td><td>  Énumérer les domaines qui approuvent directement le domaine dont ServerName est membre. </td></tr><tr><td>  DS_DOMAIN_DIRECT_OUTBOUND </td><td>  Énumérer les domaines directement approuvés par le domaine dont ServerName est membre. </td></tr><tr><td>  DS_DOMAIN_IN_FOREST </td><td>  Énumérer les domaines qui sont membres de la même forêt qui a ServerName comme membre. </td></tr><tr><td>  DS_DOMAIN_NATIVE_MODE </td><td>  Énumérer les domaines où le domaine principal s'exécute en mode natif Windows 2000. </td></tr><tr><td>  DS_DOMAIN_PRIMARY </td><td>  Énumérer les domaines qui sont le domaine principal du domaine dont ServerName est membre. </td></tr><tr><td>  DS_DOMAIN_TREE_ROOT </td><td>  Énumérer les domaines qui se trouvent à la racine de la forêt dont ServerName est membre. </td></tr></tbody></table></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Attributs</b> <div class="spoiler_text"><br><br><div class="scrollable-table"><table><tbody><tr><td>  TRUST_ATTRIBUTE_NON_TRANSITIVE </td><td>  Interdisez la transitivité. </td></tr><tr><td>  TRUST_ATTRIBUTE_UPLEVEL_ONLY </td><td>  Le lien d'approbation n'est pas valide pour les systèmes d'exploitation clients antérieurs à Windows 2000. </td></tr><tr><td>  TRUST_ATTRIBUTE_FILTER_SIDS </td><td>  Domaines de quarantaine. </td></tr><tr><td>  TRUST_ATTRIBUTE_FOREST_TRANSITIVE </td><td>  Le lien d'approbation peut contenir des informations d'approbation de forêt. </td></tr><tr><td>  TRUST_ATTRIBUTE_CROSS_ORGANIZATION </td><td>  Cette approbation concerne un domaine / forêt qui ne fait pas partie de cette entreprise. </td></tr><tr><td>  TRUST_ATTRIBUTE_TREAT_AS_EXTERNAL </td><td>  La confiance est traitée comme externe à des fins de limite de confiance. </td></tr><tr><td>  TRUST_ATTRIBUTE_WITHIN_FOREST </td><td>  La confiance est interne à cette forêt. </td></tr></tbody></table></div><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BloodHound</a> collecte des informations à l'aide de la méthode API Win32. <br><br><img src="https://habrastorage.org/webt/d4/hq/df/d4hqdf50vvyi6k4b2bv6dbcnekw.png"><br><br>  <b><i>.Net</i></b> <br><br>  La méthode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GetCurrentDomain</a> de l'espace de noms [System.DirectoryServices.ActiveDirectory.Domain] est utilisée, qui renvoie une instance de la classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">System.DirectoryServices.ActiveDirectory.Domain</a> .  Cette classe implémente la méthode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GetAllTrustRelationships</a> , qui renvoie toutes les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">approbations</a> du domaine actuel. <br><br><pre><code class="bash hljs">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</code> </pre> <br>  L'utilisation de cette méthode est implémentée dans le module Get-DomainTrust dans <a href="">PowerView</a> . <br><br><img src="https://habrastorage.org/webt/bv/px/vf/bvpxvf6de-v4o3f04sp5mtrgdd0.png"><br><br>  Un des avantages de cette méthode est sa simplicité.  L'information est facile à lire et à comprendre, mais son volume est beaucoup plus petit que lors de l'énumération par d'autres méthodes. <br><br>  <b><i>LDAP</i></b> <br><br>  Les informations d'approbation de domaine sont stockées dans Active Directory en tant que classe d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">objet de la</a> classe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">trustedDomain</a> . <br><br>  Exemple d'utilisation: <br><br><pre> <code class="bash hljs">dsquery * -filter <span class="hljs-string"><span class="hljs-string">"(objectClass=trustedDomain)"</span></span> -attr *</code> </pre> <br><img src="https://habrastorage.org/webt/oa/xc/2x/oaxc2xunppmfjl7vpjztuudgm5e.png"><br><br>  <a href="">PowerView</a> utilise cette méthode par défaut. <br><br><img src="https://habrastorage.org/webt/cx/p1/_w/cxp1_w24rxlh7-naqk5swez6vc4.png"><br><br>  Avec des informations sur les domaines et les types d'approbation, vous pouvez accéder directement à l'attaque elle-même.  Considérez 2 options: <br><br><ol><li>  Nous avons réussi à compromettre le domaine et nous avons des droits d'administrateur de domaine. </li><li>  Nous n'avons pas de droits d'administrateur de domaine. </li></ol><br><h2>  Avec des droits d'administrateur sur l'un des domaines </h2><br>  Selon le domaine compromis, plusieurs vecteurs d'attaque peuvent être distingués: <br><br><br><div class="scrollable-table"><table><tbody><tr><td>  Non. </td><td>  Démarrer le domaine  Position de l'attaquant </td><td>  Domaine attaqué </td><td>  Technique d'attaque </td><td>  Relation de confiance </td></tr><tr><td>  1 </td><td>  Racine </td><td>  Enfant </td><td>  Golden Ticket + Groupe Admin Entreprise </td><td>  Inter-royaume (2 voies) </td></tr><tr><td>  2 </td><td>  Enfant </td><td>  Enfant </td><td>  Fonctionnement de l'historique SID </td><td>  Parent-enfant inter-royaumes (2 voies) </td></tr><tr><td>  3 </td><td>  Enfant </td><td>  Racine </td><td>  Fonctionnement de l'historique SID <br>  Trust Trust Operation </td><td>  Racine d'arbre inter-domaines (2 voies) </td></tr><tr><td>  4 </td><td>  Forêt 1 </td><td>  Forêt 2 </td><td>  Bug d'imprimante </td><td>  Forêt inter-royaumes ou Approbation externe (bidirectionnelle) </td></tr></tbody></table></div><br>  Il convient de noter que pour une mise en œuvre réussie de tous les vecteurs, une confiance bilatérale entre les domaines est nécessaire. <br><br><h4>  <i>1. Historique de l'opération SID</i> </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">L'historique SID a</a> été introduit pour faciliter la migration des utilisateurs d'un domaine à un autre.  L'attribut contient les objets SID précédents.  Chaque fois qu'un objet passe d'un domaine à un autre, un nouveau SID est créé, qui devient un objectSID.  Le SID précédent est ajouté à la propriété sIDHistory. <br><br>  Chaque forêt a un groupe d'utilisateurs Enterprise Admins qui n'existe que dans le domaine racine et dispose de droits d'administrateur local sur les contrôleurs de domaine de tous les domaines enfants de la forêt.  Cette attaque a été démontrée pour la première fois par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sean Metcalf</a> au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">BlackHat USA 2015</a> .  L'essence de l'attaque est que nous émettons un ticket d'or avec l'ajout d'un SID supplémentaire du groupe Enterprise Admins.  Cela se fait en ajoutant des ExtraSids dans la structure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">KERB_SID_AND_ATTRIBUTES</a> , qui est envoyée dans la structure <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">KERB_VALIDATION_INFO</a> . <br><br><img src="https://habrastorage.org/webt/kl/hy/fj/klhyfjzath65qptysuylgzft-fk.png"><br><br>  Démo d'attaque: <br><br><img src="https://habrastorage.org/webt/v6/ia/1g/v6ia1gvjk-sxs7x8plq6uvwojjk.gif"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Impacket</a> a un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">script</a> qui automatise tout cela. <br><br><h4>  <i>2. Golden Admin + Enterprise Admin Group</i> </h4><br>  Ayant des droits d'administrateur dans le domaine racine, nous pouvons créer un Golden Ticket avec l'ajout d'un utilisateur au groupe Enterprise Admins (519). <br><br><pre> <code class="bash hljs">Kerberos::golden /domain:&lt;domain&gt; /sid:&lt;domain_SID&gt; /krbtgt:&lt;ntlm_hash_krbtgt_user&gt; /user:&lt;user&gt; /groups:500,501,513,512,520,518,519 /ptt</code> </pre> <br>  Comme décrit ci-dessus, Enterprise Admin dispose de droits d'administrateur local sur les domaines DC Child.  Ainsi, nous pourrons compromettre tous les domaines enfants de la forêt. <br><br><h4>  <i>3. Fonctionnement des tickets de fiducie</i> </h4><br>  Pour accéder à une ressource à l'aide du protocole Kerberos, vous avez besoin d'un ticket TGS, qui est chiffré avec le hachage NTLM du mot de passe du compte de service.  Un contrôleur de domaine stocke uniquement des hachages de mots de passe utilisateur pour son domaine. Ainsi, lorsqu'un utilisateur du domaine A a besoin d'accéder à une ressource du domaine B, une clé inter-domaine est utilisée.  Cette clé est créée sur la base d'un mot de passe approuvé, qui est défini lors de la création de relations d'approbation entre les domaines de la même forêt.  Dans la base de données de mots de passe (NTDS.dit) sur le contrôleur de domaine, vous pouvez trouver des utilisateurs avec le signe $ à la fin.  Leur mot de passe est également utilisé pour créer des clés inter-domaines.  Pour créer un ticket TGT inter-domaines, nous avons besoin d'un hachage de mot de passe de ce compte. <br><br><pre> <code class="bash hljs">Kerberos::golden /user:&lt;user&gt; /domain:&lt;domain&gt; /sid:&lt;sid_domain&gt; /sids:&lt;extra_sid_entrprice_admin_group_from _another_domain&gt; /aes256:&lt;aes256_trust_user_password&gt; /service:krbtgt /target:&lt;target_domain&gt; /ptt</code> </pre> <br>  Démo d'attaque: <br><br><img src="https://habrastorage.org/webt/fk/cv/ji/fkcvjizxaup946gngi9zsk6xqm8.gif"><br><br>  L'attaque est particulièrement pertinente lorsque le service IS a remarqué une menace et a changé le mot de passe krbtgt 2 fois.  Dans ce cas, nous pourrons créer des tickets d'or en utilisant un mot de passe de confiance entre les domaines. <br><br><h4>  <i>4. Bug d'imprimante</i> </h4><br>  Le protocole distant du système d'impression Windows (MS-RPRN) a la méthode RpcRemoteFindFirstPrinterChangeNotification (Ex) activée par défaut, qui vous permet de forcer l'authentification sur tout ordinateur exécutant le service Spouleur sur l'hôte spécifié à l'aide du protocole Kerberos ou NTLM.  Dans le cas de c NTLM, nous pouvons exécuter NTLM-relay, ou commencer à casser le mot de passe de l'ordinateur (ne jamais décocher).  Dans le cas de Kerberos, une machine compromise avec délégation illimitée est nécessaire.  Ensuite, nous pouvons prendre un ticket TGT et développer une attaque. <br><br>  Démo d'attaque: <br><br><img src="https://habrastorage.org/webt/3g/h9/gf/3gh9gfnx0b6k8hucav8zy964ap0.gif"><br><br>  La figure ci-dessous montre les étapes illustrées dans la vidéo. <br><br><img src="https://habrastorage.org/webt/cu/e0/0l/cue00l2_x_fdpsxj0vyalrvjscs.png"><br><br><h2>  Nous n'avons pas de droits d'administrateur de domaine </h2><br>  Un peu de théorie.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Carlos Garsia</a> dans son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">rapport a</a> donné un excellent tableau qui illustre les propriétés de différents types de groupes. <br><br><img src="https://habrastorage.org/webt/jz/5x/jc/jz5xjcruevdpcv_jnz1knoyh1oi.png"><br><br>  Parmi les fonctionnalités, il convient de considérer <a href="">que les groupes AD Domain Local et AD Global sont répliqués sans membres de groupe dans le catalogue global et que les groupes AD Universal sont répliqués avec les utilisateurs.</a> <br><blockquote>  En raison de la façon dont les groupes sont énumérés par le catalogue global, les résultats d'une recherche de lien arrière [c.-à-d. Les membres peuvent varier, selon que vous recherchez le catalogue global (port 3268) ou le domaine (port 389), le type de groupes auxquels l'utilisateur appartient (groupes globaux vs groupes locaux de domaine). </blockquote>  Dans le cas où nous n'avons pas de droits d'administrateur de domaine, nous énumérons les objets.  Nous sommes intéressés par: <br><ol><li>  Utilisateurs d'un autre domaine disposant de droits d'administrateur local sur les machines de notre domaine. </li><li>  Utilisateurs d'autres domaines membres de groupes de domaines d'utilisateurs.  Groupes contenant des utilisateurs d'un autre domaine. </li><li>  Responsables ACL étrangers. </li></ol><br><h4>  <i>1. Utilisateurs d'un autre domaine disposant de droits d'administrateur local sur les machines de notre domaine</i> </h4><br>  Recherchez les utilisateurs d'un autre domaine qui sont des administrateurs locaux sur les hôtes de notre domaine dans BloodHound: <br><br><pre> <code class="bash hljs">MATCH (c:Computer) OPTIONAL MATCH p1 = (u1)-[:AdminTo]-&gt;(c) WHERE NOT u1.domain = c.domain WITH p1,c OPTIONAL MATCH p2 = (u2)-[:MemberOf*1..]-&gt;(:Group)-[:AdminTo]-&gt;(c) WHERE NOT u2.domain = c.domain RETURN p1,p2</code> </pre><br><img src="https://habrastorage.org/webt/07/2y/92/072y92dgtftil5yz9uvrgv8ui3a.png"><br><br>  Commande dans <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-NetLocalGroupMember &lt;server&gt;</code> </pre> <br><h4>  <i>2. Utilisateurs d'autres domaines, composés de groupes de domaines d'utilisateurs.</i>  <i>Groupes contenant des utilisateurs d'un autre domaine</i> </h4><br>  Comme mentionné ci-dessus, les utilisateurs qui sont membres de groupes Universal uniquement sont répliqués dans le catalogue global.  Pour illustrer cette fonctionnalité, nous interrogerons les groupes du catalogue global qui contiennent au moins un utilisateur et une demande LDAP directe au contrôleur de domaine. <br><br><pre> <code class="bash hljs">Get-DomainGroup -Properties name, grouptype, member, DistinguishedName -LDAPFilter <span class="hljs-string"><span class="hljs-string">'(member=*)'</span></span> -SearchBase <span class="hljs-string"><span class="hljs-string">"GC://jet.lab"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/vr/zv/sd/vrzvsdj1pez6rn-ndb4_zcklpdu.png"><br><br>  Lors de l'exécution d'une requête dans le catalogue global, nous ne voyons qu'un seul groupe Universal Group de type AD Universal du domaine one.jet.lab. <br><br>  Si nous exécutons une requête LDAP directe sur one.jet.lab, nous verrons d'autres groupes de type AD Domain local et AD Global. <br><br><img src="https://habrastorage.org/webt/jf/3n/ku/jf3nkumv72dhsoyhb8kpqntq9ba.png"><br><br>  Ceci est important à prendre en compte lors de l'énumération des utilisateurs et des groupes. <br><br>  Commandes dans <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-DomainForeignUser -Domain &lt;Domain&gt; Get-DomainForeignGroupMember -Domain &lt;Domain&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/ia/no/24/iano24rfj4ldithcbqhapwts4uk.png"><br><br><img src="https://habrastorage.org/webt/zf/2n/f-/zf2nf-tutgsxrzz99pdp6199fw0.png"><br><br><h4>  <i>3. Directeurs étrangers de l'ACL</i> </h4><br>  Le descripteur de sécurité ntSecurityDescriptor (https://docs.microsoft.com/en-us/windows/win32/adschema/a-ntsecuritydescriptor) est accessible à tous les utilisateurs des domaines approuvés et est répliqué dans le catalogue global.  Ainsi, nous pouvons interroger tous les DACL pour tous les objets dans les domaines de confiance et filtrer les utilisateurs d'autres domaines. <br><br><pre> <code class="bash hljs">Get-DomainObjectAcl -Domain jet.lab -ResolveGuids | ?{<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.SecurityIdentifier -like <span class="hljs-string"><span class="hljs-string">'SID_Domain*'</span></span>}</code> </pre> <br><img src="https://habrastorage.org/webt/fw/kn/si/fwknsimcsrubz0tputfddzosgr0.png"><br><br>  Nous avons donc réussi à identifier l'utilisateur Mike du domaine forestc.lab, qui avait des droits sur le groupe mondial dans le domaine jet.lab. <br><br>  Le filtrage PS SID et l'authentification sélective sont utilisés pour la protection entre les forêts.  Une attaque entre les forêts avec le filtrage SID a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">activé dirkjan</a> sur son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">blog</a> .  Le 9 juillet également, Microsoft a publié une <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mise à jour</a> qui désactive la délégation TGT entre les forêts par défaut.  Maintenant, tout, l'histoire avec la délégation illimitée et le compromis d'une forêt à l'autre en utilisant le protocole Kerberos ne fonctionne plus. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr466445/">https://habr.com/ru/post/fr466445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr466435/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 42. Routage inter-VLAN et SVI</a></li>
<li><a href="../fr466437/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 43. Protocoles de routage Distance du vecteur et état de la liaison</a></li>
<li><a href="../fr466439/index.html">Vérifiez vous-même: combien de questions pouvez-vous répondre à ChGK?</a></li>
<li><a href="../fr466441/index.html">Code buggy Python: 10 erreurs les plus courantes que les développeurs font</a></li>
<li><a href="../fr466443/index.html">ShIoTiny et le monde: capteurs analogiques ou ADC pour les plus petits</a></li>
<li><a href="../fr466447/index.html">Pourquoi devrions-nous construire un CDN?</a></li>
<li><a href="../fr466449/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 44. Introduction à OSPF</a></li>
<li><a href="../fr466451/index.html">Read_You can't_throw</a></li>
<li><a href="../fr466453/index.html">Formation Cisco 200-125 CCNA v3.0. Jour 45. Configuration d'OSPF</a></li>
<li><a href="../fr466455/index.html">Services, microservices et programmation orientée batch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>