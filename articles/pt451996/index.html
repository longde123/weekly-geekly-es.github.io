<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüè≠ üö≥ üßìüèæ Minha experi√™ncia de erros üåë ü§µüèæ üî±</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Minha experi√™ncia de erros 
 Lista de erros 


1. Classe onipotente MCManager 
2. Inventando nossa navega√ß√£o entre telas 
3. Nunca h√° muita heran√ßa 
4...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Minha experi√™ncia de erros</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451996/"><h3>  Minha experi√™ncia de erros </h3><br><h4>  Lista de erros </h4><br><ol><li>  Classe onipotente MCManager </li><li>  Inventando nossa navega√ß√£o entre telas </li><li>  Nunca h√° muita heran√ßa </li><li>  Arquitetura de nossa pr√≥pria produ√ß√£o ou continuar a criar bicicletas </li><li>  MVVM com alma MVP </li><li>  A segunda tentativa com navega√ß√£o ou roteador e a curvatura da navega√ß√£o </li><li>  Gerente persistente </li></ol><br>  Muitas pessoas, inclusive eu, escrevem como fazer a coisa certa em uma determinada situa√ß√£o, como escrever c√≥digo corretamente, como aplicar solu√ß√µes arquiteturais etc. Mas gostaria de compartilhar minha experi√™ncia de como isso foi feito incorretamente e as conclus√µes que feito com base em seus erros.  Muito provavelmente, ser√£o erros comuns de todos que seguem o caminho do desenvolvedor, ou talvez algo seja novo.  Eu s√≥ quero compartilhar minha experi√™ncia e ler os coment√°rios de outros caras. <br><a name="habracut"></a><br><h4>  Classe onipotente MCManager </h4><br>  Ap√≥s o primeiro ano de trabalho em TI e, mais especificamente, o desenvolvimento do iOS, decidi que j√° era arquiteto o suficiente e pronto para criar.  Mesmo assim, compreendi intuitivamente que era necess√°rio separar a l√≥gica de neg√≥cios da camada de apresenta√ß√£o.  Mas a qualidade da minha ideia de como fazer isso estava longe da realidade. <br><br>  Eu mudei para um novo local de trabalho, onde fui designado para desenvolver independentemente um novo recurso para um projeto existente.  Era um an√°logo para gravar v√≠deos no Instagram, onde a grava√ß√£o √© realizada enquanto o usu√°rio pressiona o bot√£o no bot√£o e, em seguida, v√°rios fragmentos do v√≠deo s√£o conectados juntos.  Inicialmente, foi decidido fazer esse recurso como um projeto separado, ou melhor, na forma de uma amostra.  Isso, pelo que entendi, come√ßa a fonte dos meus problemas arquitet√¥nicos, que duraram mais de um ano. <br><br>  No futuro, esse exemplo se tornou um aplicativo completo para grava√ß√£o e edi√ß√£o de v√≠deos.  √â engra√ßado que, inicialmente, a amostra tivesse um nome, cuja abrevia√ß√£o foi a qual o prefixo MC foi coletado.  Embora o projeto tenha sido renomeado em breve, mas o prefixo, conforme exigido pela conven√ß√£o de nomes no Objective-C, o MC permaneceu.  Ent√£o, a poderosa classe MCManager nasceu. <br><br><img src="https://habrastorage.org/webt/sz/jw/m_/szjwm_hbfvtxjbovprczya2jyca.jpeg"><br><br>  Como era uma amostra e, a princ√≠pio, a funcionalidade era simples, decidi que uma classe de gerente seria suficiente.  A funcionalidade, como mencionei anteriormente, inclu√≠a a grava√ß√£o de um fragmento de v√≠deo com op√ß√µes de in√≠cio / parada e a combina√ß√£o adicional desses fragmentos em um v√≠deo inteiro.  E, nesse exato momento, posso nomear meu primeiro erro - o nome da classe MCManager.  MCManager, Karl!  O que um nome de classe deve dizer a outros desenvolvedores sobre seu objetivo, seus recursos e como us√°-lo?  Certo, absolutamente nada!  E isso est√° no ap√™ndice, cujo nome nem cont√©m as letras M e, sua m√£e, C. Embora esse n√£o seja o meu principal erro, uma vez que a turma com o nome partid√°rio fez tudo, tudo na palavra √© absolutamente tudo, que foi o principal erro. <br><br>  A grava√ß√£o de v√≠deo √© um servi√ßo pequeno, o gerenciamento do armazenamento de arquivos de v√≠deo no sistema de arquivos √© o segundo e adicional servi√ßo para combinar v√°rios v√≠deos em um.  O trabalho desses tr√™s servi√ßos independentes, foi decidido combinar em um gerente.  A id√©ia era nobre, usando o padr√£o de fachada, para criar uma interface simples para a l√≥gica de neg√≥cios e ocultar todos os detalhes desnecess√°rios sobre a intera√ß√£o de v√°rios componentes.  Nos est√°gios iniciais, mesmo o nome de uma classe de fachada n√£o levantou suspeitas, principalmente na amostra. <br>  Mas o cliente gostou da demonstra√ß√£o e logo a amostra se transformou em um aplicativo completo.  Voc√™ pode justificar que n√£o havia tempo suficiente para refatorar, que o cliente n√£o queria refazer o c√≥digo de trabalho, mas, francamente, naquele momento, eu pr√≥prio pensei que havia estabelecido uma excelente arquitetura.  Na verdade, a ideia de separar a l√≥gica e a apresenta√ß√£o dos neg√≥cios foi um sucesso.  A arquitetura era uma classe do MCManager √∫nico, que era a fachada de uma d√∫zia de servi√ßos e outros gerentes.  Sim, tamb√©m era um singleton, dispon√≠vel em todos os cantos do aplicativo. <br><br>  J√° se pode entender a escala de todo o desastre.  Uma classe com v√°rios milhares de linhas de c√≥digo dif√≠ceis de ler e de manter.  J√° estou em sil√™ncio sobre a possibilidade de destacar recursos individuais para transferi-los para outro aplicativo, o que √© bastante comum no desenvolvimento m√≥vel. <br>  As conclus√µes que tirei depois de um tempo n√£o s√£o para criar classes universais com nomes obscuros.  Percebi que a l√≥gica precisa ser dividida em peda√ßos e n√£o criar uma interface universal para tudo.  De fato, este era um exemplo do que aconteceria se voc√™ n√£o seguisse um dos princ√≠pios do SOLID, o Princ√≠pio de Segrega√ß√£o de Interface. <br><br><h4>  Inventando nossa navega√ß√£o entre telas </h4><br>  A separa√ß√£o da l√≥gica e da interface n√£o √© o √∫nico problema que me preocupou com o projeto acima.  N√£o vou dizer que naquele momento eu ia separar o c√≥digo da tela e o c√≥digo de navega√ß√£o, mas aconteceu que eu criei minha bicicleta para navega√ß√£o. <br><br><img src="https://habrastorage.org/webt/ab/dt/j1/abdtj1sogyy-j7ppjfbk9uhshge.jpeg"><br><br>  A amostra possu√≠a apenas tr√™s telas: um menu com uma tabela de v√≠deos gravados, uma tela de grava√ß√£o e uma tela de p√≥s-processamento.  Para n√£o me importar com o fato de a pilha de navega√ß√£o conter ViewControllers duplicados, decidi n√£o usar o UINavigationController.  Eu adicionei o RootViewcontroller, leitores atentos j√° imaginaram que era o MCRootViewController, que foi definido como o principal nas configura√ß√µes do projeto.  Ao mesmo tempo, o controlador raiz n√£o era uma das telas do aplicativo, apenas apresentava o UIViewController desejado.  Como se isso n√£o bastasse, o controlador raiz tamb√©m foi um representante de todos os controladores representados.  Como resultado, a cada momento, havia apenas dois vc na hierarquia e toda a navega√ß√£o era implementada usando o padr√£o de delega√ß√£o. <br><br>  Como parecia: cada tela tinha seu pr√≥prio protocolo de delega√ß√£o, onde os m√©todos de navega√ß√£o foram indicados, e o controlador raiz implementou esses m√©todos e alterou as telas.  O RootViewController dissmisil o controlador atual, criou um novo e o apresentou, enquanto era poss√≠vel transferir informa√ß√µes de uma tela para outra.  Felizmente, a l√≥gica de neg√≥cios estava na classe singleton mais legal; portanto, nenhuma das telas armazenava nada e podia ser destru√≠da sem dor.  Mais uma vez, uma boa inten√ß√£o foi realizada, embora a realiza√ß√£o mancasse nas duas pernas e √†s vezes trope√ßasse. <br><br>  Como voc√™ pode imaginar, se voc√™ precisar ir da tela de grava√ß√£o de v√≠deo para o menu principal, o m√©todo foi chamado: <br><br><pre><code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)cancel;</code> </pre> <br>  ou algo assim, e o controlador raiz j√° est√° fazendo todo o trabalho sujo. <br>  Como resultado, o MCRootViewController tornou-se um an√°logo do MCManager, mas na navega√ß√£o entre telas, como no crescimento do aplicativo e na adi√ß√£o de novas funcionalidades, novas telas foram adicionadas. <br><br>  A f√°brica de bicicletas funcionou inexoravelmente e eu continuei ignorando artigos sobre arquiteturas de aplicativos m√≥veis.  Mas nunca desisti da ideia de separar a navega√ß√£o das telas. <br><br>  A vantagem era que as telas eram independentes e poderiam ser reutilizadas, mas isso n√£o √© exato.  Mas as desvantagens incluem a dificuldade em manter essas classes.  O problema com a falta de uma pilha de telas quando voc√™ precisa retornar rolando pelas telas selecionadas anteriormente.  A l√≥gica complexa de transi√ß√£o entre telas, o controlador raiz afetou parte da l√≥gica de neg√≥cios para exibir corretamente uma nova tela. <br><br>  Em geral, voc√™ n√£o deve implementar toda a navega√ß√£o no aplicativo dessa maneira, pois meu MCRootViewController violou o princ√≠pio do princ√≠pio aberto-fechado.  √â quase imposs√≠vel expandir, e todas as mudan√ßas devem ser feitas constantemente na pr√≥pria classe. <br>  Comecei a ler mais sobre a navega√ß√£o entre telas em um aplicativo m√≥vel, familiarizei-me com abordagens como roteador e coordenador.  Escreverei sobre o roteador um pouco mais tarde, pois h√° algo para compartilhar. <br><br><h4>  Nunca h√° muita heran√ßa </h4><br>  Tamb√©m quero compartilhar n√£o apenas minhas p√©rolas, mas tamb√©m as abordagens e solu√ß√µes engra√ßadas de outras pessoas com as quais tive que lidar.No mesmo local em que criei minhas obras-primas, eles me confiaram uma tarefa simples.  A tarefa era adicionar uma tela de outro projeto ao meu projeto.  Como determinamos com o PM, ap√≥s uma an√°lise superficial e um pouco de reflex√£o, isso deve levar duas ou tr√™s horas e n√£o mais, porque o que h√° de errado nisso, voc√™ s√≥ precisa adicionar uma classe de tela pronta ao seu aplicativo.  De fato, tudo j√° foi feito por n√≥s, precisamos fazer ctrl + ce ctrl + v.  Aqui est√£o apenas uma pequena nuance, o desenvolvedor que escreveu este aplicativo realmente adorou heran√ßa. <br><br><img src="https://habrastorage.org/webt/bv/e7/h8/bve7h8vugtvsjzyw_ml4esh5vbe.jpeg"><br><br>  Encontrei rapidamente o ViewController de que precisava, tive sorte de n√£o haver separa√ß√£o entre l√≥gica e apresenta√ß√£o.  Era uma boa abordagem antiga, quando o controlador continha todo o c√≥digo necess√°rio.  Copiei para o meu projeto e comecei a descobrir como faz√™-lo funcionar.  E a primeira coisa que descobri √© que o controlador de que preciso herda de outro controlador.  Uma coisa comum, um evento bastante esperado.  Como n√£o tinha muito tempo, encontrei a classe de que precisava e a arrastei para o meu projeto.  Bem, agora deveria funcionar, pensei, e nunca estive t√£o errado! <br><br>  A classe de que eu precisava n√£o s√≥ tinha muitas vari√°veis ‚Äã‚Äãde classes personalizadas que tamb√©m precisavam ser copiadas para o meu projeto, como cada uma delas herdou algo.  Por sua vez, as classes base eram herdadas ou continham campos com tipos personalizados que, como muitos podem ter adivinhado, herdaram algo, e isso, infelizmente, n√£o era NSObject, UIViewController ou UIView.  Assim, um bom ter√ßo do projeto desnecess√°rio migrou para mim no projeto. <br><br>  Como n√£o havia muito tempo para concluir esta tarefa, n√£o havia outra maneira de simplesmente adicionar as classes necess√°rias que o xCode exigia simplesmente para iniciar meu projeto sem problemas.  Como resultado, duas ou tr√™s horas se arrastaram um pouco, porque no final tive que mergulhar em toda a teia da hierarquia de heran√ßa, como um verdadeiro escultor, cortando o excesso. <br><br>  Como resultado, cheguei √† conclus√£o de que todas as coisas boas deveriam estar com modera√ß√£o, mesmo uma coisa ‚Äúmaravilhosa‚Äù como heran√ßa.  Ent√£o comecei a entender as desvantagens da heran√ßa.  Conclu√≠ por mim mesmo, se eu quiser fazer m√≥dulos reutiliz√°veis, devo torn√°-los mais independentes. <br><br><h4>  Arquitetura de nossa pr√≥pria produ√ß√£o ou continuar a criar bicicletas </h4><br>  Movendo-me para um novo local de trabalho e iniciando um novo projeto, levei em conta toda a experi√™ncia dispon√≠vel no design da arquitetura e continuei a criar.  Naturalmente, continuei ignorando as arquiteturas j√° inventadas, mas ao mesmo tempo segui persistentemente o princ√≠pio de ‚Äúdividir e conquistar‚Äù. <br><br>  N√£o demorou muito para o advento de Swift, ent√£o me aprofundou nas possibilidades do Objective-c.  Eu decidi fazer a inje√ß√£o de depend√™ncia usando os recursos de linguagem.  Fui inspirado pela ferramenta de expans√£o da lib; nem me lembro do nome. <br><br>  A linha inferior √©: na classe base BaseViewController, adicionei um campo da classe BaseViewModel.  Assim, para cada tela, criei meu pr√≥prio controlador, que herdou os b√°sicos, e adicionei um protocolo para o controlador interagir com o viewModel.  Ent√£o veio a magia.  Redefini as propriedades do viewModel e adicionei suporte ao protocolo desejado.  Por sua vez, criei uma nova classe ViewModel para uma tela espec√≠fica que implementou esse protocolo.  Como resultado, no BaseViewController no m√©todo viewDidLoad, verifiquei o tipo de protocolo do modelo, verifiquei a lista de todos os descendentes de BaseViewModel, localizei a classe necess√°ria e criei o viewModel do tipo necess√°rio. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo b√°sico de ViewController</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;UIKit/UIKit.h&gt;</span></span></span><span class="hljs-meta"> // MVC model #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseMVCModel.h"</span></span></span><span class="hljs-meta"> @class BaseViewController; @protocol BaseViewControllerDelegate </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NSObject&gt;</span></span></span><span class="hljs-meta"> @required - (void)backFromNextViewController:(BaseViewController *)aNextViewController withOptions:(NSDictionary *)anOptionsDictionary; @end @interface BaseViewController : UIViewController </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;BaseViewControllerDelegate&gt;</span></span></span><span class="hljs-meta"> @property (nonatomic, weak) BaseMVCModel *model; @property (nonatomic, assign) id</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;BaseViewControllerDelegate&gt;</span></span></span><span class="hljs-meta"> prevViewController; - (void)backWithOptions:(NSDictionary *)anOptionsDictionary; + (void)setupUIStyle; @end import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseViewController.h"</span></span></span><span class="hljs-meta"> // Helpers #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RuntimeHelper.h"</span></span></span><span class="hljs-meta"> @interface BaseViewController () @end @implementation BaseViewController + (void)setupUIStyle { } #pragma mark - #pragma mark Life cycle - (void)viewDidLoad { [super viewDidLoad]; self.model = [BaseMVCModel getModel:FindPropertyProtocol(@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"model"</span></span></span><span class="hljs-meta">, [self class])]; } #pragma mark - #pragma mark Navigation - (void)backWithOptions:(NSDictionary *)anOptionsDictionary { if (self.prevViewController) { [self.prevViewController performSelector:@selector(backFromNextViewController:withOptions:) withObject:self withObject:anOptionsDictionary]; } } #pragma mark - #pragma mark Seque - (void)prepareForSegue:(UIStoryboardSegue *)segue sender:(id)sender { if ([segue.destinationViewController isKindOfClass:[BaseViewController class]] { ((BaseViewController *)segue.destinationViewController).prevViewController = self; } } #pragma mark - #pragma mark BaseViewControllerDelegate - (void)backFromNextViewController:(BaseViewController *)aNextViewController withOptions:(NSDictionary *)anOptionsDictionary { [self doesNotRecognizeSelector:_cmd]; } @end</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Exemplo b√°sico de ViewModel</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface BaseMVCModel : NSObject @property (nonatomic, assign) id delegate; + (id)getModel:(NSString *)someProtocol; @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseMVCModel.h"</span></span></span><span class="hljs-meta"> // IoC #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IoCContainer.h"</span></span></span><span class="hljs-meta"> @implementation BaseMVCModel + (id)getModel:(NSString *)someProtocol { return [[IoCContainer sharedIoCContainer] getModel:NSProtocolFromString(someProtocol)]; } @end</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Classes auxiliares</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface IoCContainer : NSObject + (instancetype)sharedIoCContainer; - (id)getModel:(Protocol *)someProtocol; @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IoCContainer.h"</span></span></span><span class="hljs-meta"> // Helpers #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RuntimeHelper.h"</span></span></span><span class="hljs-meta"> // Models #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseMVCModel.h"</span></span></span><span class="hljs-meta"> @interface IoCContainer () @property (nonatomic, strong) NSMutableSet *models; @end @implementation IoCContainer #pragma mark - #pragma mark Singleton + (instancetype)sharedIoCContainer { static IoCContainer *_sharedIoCContainer = nil; static dispatch_once_t onceToken; dispatch_once(&amp;onceToken, ^{ _sharedIoCContainer = [IoCContainer new]; }); return _sharedIoCContainer; } - (id)getModel:(Protocol *)someProtocol { if (!someProtocol) { return [BaseMVCModel new]; } NSArray *modelClasses = ClassGetSubclasses([BaseMVCModel class]); __block Class currentClass = NULL; [modelClasses enumerateObjectsUsingBlock:^(Class class, NSUInteger idx, BOOL *stop) { if ([class conformsToProtocol:someProtocol]) { currentClass = class; } }]; if (currentClass == nil) { return [BaseMVCModel new]; } __block BaseMVCModel *currentModel = nil; [self.models enumerateObjectsUsingBlock:^(id model, BOOL *stop) { if ([model isKindOfClass:currentClass]) { currentModel = model; } }]; if (!currentModel) { currentModel = [currentClass new]; [self.models addObject:currentModel]; } return currentModel; } - (NSMutableSet *)models { if (!_models) { _models = [NSMutableSet set]; } return _models; } @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> NSString * FindPropertyProtocol(NSString *propertyName, Class class); NSArray * ClassGetSubclasses(Class parentClass); #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"RuntimeHelper.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;objc/runtime.h&gt;</span></span></span><span class="hljs-meta"> #pragma mark - #pragma mark Functions NSString * FindPropertyProtocol(NSString *aPropertyName, Class class) { unsigned int propertyCount; objc_property_t *properties = class_copyPropertyList(class, &amp;propertyCount); for (unsigned int i = 0; i </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt; propertyCount; i++) { objc_property_t property = properties[i]; const char *propertyName = property_getName(property); if ([@(propertyName) isEqualToString:aPropertyName]) { const char *attrs = property_getAttributes(property); NSString* propertyAttributes = @(attrs); NSScanner *scanner = [NSScanner scannerWithString: propertyAttributes]; [scanner scanUpToString:@"&lt;" intoString:NULL]; [scanner scanString:@"&lt;" intoString:NULL]; NSString* protocolName = nil; [scanner scanUpToString:@"&gt;</span></span></span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" intoString: &amp;protocolName]; return protocolName; } } return nil; } NSArray * ClassGetSubclasses(Class parentClass) { int numClasses = objc_getClassList(NULL, 0); Class *classes = NULL; classes = (Class *)malloc(sizeof(Class) * numClasses); numClasses = objc_getClassList(classes, numClasses); NSMutableArray *result = [NSMutableArray array]; for (NSInteger i = 0; i &lt; numClasses; i++) { Class superClass = classes[i]; do { superClass = class_getSuperclass(superClass); } while(superClass &amp;&amp; superClass != parentClass); if (superClass == nil) { continue; } [result addObject:classes[i]]; } free(classes); return result; }</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Exemplo da tela de login</b> <div class="spoiler_text"><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"BaseViewController.h"</span></span></span><span class="hljs-meta"> @protocol LoginProtocol </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NSObject&gt;</span></span></span><span class="hljs-meta"> @required - (void)login:(NSString *)aLoginString password:(NSString *)aPasswordString completionBlock:(DefaultCompletionBlock)aCompletionBlock; @end @interface LoginVC : BaseViewController @end #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"LoginVC.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UIViewController+Alert.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"UIViewController+HUD.h"</span></span></span><span class="hljs-meta"> @interface LoginVC () @property id</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;LoginProtocol&gt;</span></span></span><span class="hljs-meta"> model; @property (weak, nonatomic) IBOutlet UITextField *emailTF; @property (weak, nonatomic) IBOutlet UITextField *passTF; @end @implementation LoginVC @synthesize model = _model; #pragma mark - #pragma mark IBActions - (IBAction)loginAction:(id)sender { [self login]; } #pragma mark - #pragma mark UITextFieldDelegate - (BOOL)textFieldShouldReturn:(UITextField *)textField { if (textField == self.emailTF) { [self.passTF becomeFirstResponder]; } else { [self login]; } return YES; } #pragma mark - #pragma mark Login - (void)login { NSString *email = self.emailTF.text; NSString *pass = self.passTF.text; if (email.length == 0 || pass.length == 0) { [self showAlertOkWithMessage:@</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Please, input info!"</span></span></span><span class="hljs-meta">]; return; } __weak __typeof(self)weakSelf = self; [self showHUD]; [self.model login:self.emailTF.text password:self.passTF.text completionBlock:^(BOOL isDone, NSError *anError) { [weakSelf hideHUD]; if (isDone) { [weakSelf backWithOptions:nil]; } }]; } @end</span></span></code> </pre> <br></div></div><br>  De uma maneira t√£o direta, fiz uma inicializa√ß√£o lenta do viewModel e conectei mal a visualiza√ß√£o aos modelos atrav√©s de protocolos.  Com tudo isso, naquele momento eu ainda n√£o sabia nada sobre a arquitetura MVP, embora algo semelhante pairasse sobre mim. <br>  A navega√ß√£o entre as telas foi deixada ao crit√©rio de "viewModel", pois adicionei um link fraco ao controlador. <br><br>  Lembrando essa implementa√ß√£o agora, n√£o posso ter certeza de que tudo estava ruim.  A id√©ia de separar as camadas foi um sucesso, o momento de criar e atribuir modelos ao controlador foi simplificado. <br>  Mas, por mim mesmo, decidi aprender mais sobre abordagens e arquiteturas prontas, pois durante o desenvolvimento de um aplicativo com minha pr√≥pria arquitetura, tive que lidar com muitas nuances.  Por exemplo, reutiliza√ß√£o de telas e modelos, heran√ßa, transi√ß√µes complexas entre telas.  Naquele momento, pareceu-me que o viewModel fazia parte da l√≥gica de neg√≥cios, embora agora eu entenda que ainda seja uma camada de apresenta√ß√£o.  Eu tive uma √≥tima experi√™ncia durante esse experimento. <br><br><h4>  MVVM com alma MVP </h4><br>  J√° tendo adquirido experi√™ncia, decidi escolher uma arquitetura espec√≠fica para mim e segui-la, em vez de inventar bicicletas.  Comecei a ler mais sobre arquiteturas, a estudar em detalhes populares na √©poca e a instalar o MVVM.  Francamente, n√£o entendi imediatamente sua ess√™ncia, mas a escolhi porque gostei do nome. <br><br>  N√£o entendi imediatamente a ess√™ncia da arquitetura e o relacionamento entre o ViewModel e o View (ViewController), mas comecei a fazer o que eu entendia.  Os olhos est√£o com medo e as m√£os est√£o furiosamente digitando o c√≥digo. <br><br>  Em minha defesa, acrescentarei que, naquela √©poca, o tempo e o tempo para pensar e analisar a cria√ß√£o que eu criava eram muito restritos.  Portanto, em vez de pastas, criei links diretos no ViewModel para a visualiza√ß√£o correspondente.  E j√° no ViewModel, fiz a configura√ß√£o da apresenta√ß√£o. <br><br>  Sobre o MVP, eu tinha a mesma id√©ia que sobre outras arquiteturas, por isso acreditava firmemente que era o MVVM, no qual o ViewModel acabou sendo os apresentadores mais reais. <br><br><div class="spoiler">  <b class="spoiler_title">Um exemplo da minha arquitetura ‚ÄúMVVM‚Äù e, sim, gostei da ideia com o RootViewController, respons√°vel pelo mais alto n√≠vel de navega√ß√£o no aplicativo.</b>  <b class="spoiler_title">Sobre o roteador est√° escrito abaixo.</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit class RootViewController: UIViewController { var viewModel: RootViewModel? override func viewDidLoad() { super.viewDidLoad() let router = (UIApplication.shared.delegate as? AppDelegate)!.router viewModel = RootViewModel(with: self, router: router) viewModel?.setup() } } <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit protocol ViewModelProtocol: class { func setup() func backAction() } class RootViewModel: NSObject, ViewModelProtocol { unowned var router : RootRouter unowned var view: RootViewController init(with view: RootViewController, router: RootRouter) { self.view = view self.router = router } <span class="hljs-comment"><span class="hljs-comment">// MARK: - ViewModelProtocol func setup() { if AccountManager.shared.isLoggedIn() { router.route(to: RootRoutes.launch.rawValue, from: view, parameters: nil) } else { router.route(to: RootRoutes.loginregistartion.rawValue, from: view, parameters: nil) } } func backAction() { } }</span></span></code> </pre> <br></div></div><br>  Isso n√£o afetou particularmente a qualidade do projeto, uma vez que a ordem e uma √∫nica abordagem foram respeitadas.  Mas a experi√™ncia foi inestim√°vel.  Depois das bicicletas que criei, finalmente comecei a fazer de acordo com a arquitetura geralmente aceita.  A menos que os apresentadores sejam chamados de apresentadores, o que pode confundir um desenvolvedor de terceiros. <br><br>  Decidi que, no futuro, vale a pena fazer pequenos projetos de teste, para aprofundar a ess√™ncia de uma abordagem espec√≠fica no design com mais detalhes.  Por assim dizer, primeiro sinta-se na pr√°tica e depois entre na batalha.  Essa √© a conclus√£o que tirei para mim. <br><br><h4>  A segunda tentativa com navega√ß√£o ou roteador e a curvatura da navega√ß√£o </h4><br>  No mesmo projeto, onde implementei o MVVM de forma valiosa e ing√™nua, decidi tentar uma nova abordagem na navega√ß√£o entre telas.  Como mencionei anteriormente, ainda aderi √† id√©ia de separar telas e √† l√≥gica de transi√ß√£o entre elas. <br><br>  Lendo sobre o MVVM, eu estava interessado em um padr√£o como o Roteador.  Depois de revisar a descri√ß√£o novamente, comecei a implementar a solu√ß√£o no meu projeto. <br><br><div class="spoiler">  <b class="spoiler_title">Exemplo de roteador</b> <div class="spoiler_text"><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> UIKit protocol Router: class { func route(to routeID: String, from view: UIViewController, parameters: Any?) func back(from view: UIViewController, parameters: Any?) } extension Router { func back(from view: UIViewController, parameters: Any?) { let navigationController: UINavigationController = checkNavigationController(for: view) navigationController.popViewController(animated: false) } } enum RootRoutes: String { case launch = "Launch" case loginregistartion = "LoginRegistartionRout" case mainmenu = "MainMenu" } class RootRouter: Router { var loginRegistartionRouter: LoginRegistartionRouter? var mainMenuRouter: MainMenuRouter? <span class="hljs-comment"><span class="hljs-comment">// MARK: Router func route(to routeID: String, from view: UIViewController, parameters: Any?) { var rootView = view if view is EPLaunchViewController { rootView = (view.navigationController?.viewControllers.first)! view.navigationController?.popViewController(animated: false) } if routeID == RootRoutes.loginregistartion.rawValue { loginRegistartionRouter = LoginRegistartionRouter(with: self) loginRegistartionRouter?.route(to: LRRouteID.phoneNumber.rawValue, from: rootView, parameters: nil) } else if routeID == RootRoutes.mainmenu.rawValue { if mainMenuRouter == nil { mainMenuRouter = MainMenuRouter(with: self) } mainMenuRouter?.route(to: MMRouteID.start.rawValue, from: rootView, parameters: nil) } else if routeID == RootRoutes.launch.rawValue { let storyboard = UIStoryboard(name: "RootStoryboard", bundle: nil) let launchView = storyboard.instantiateViewController(withIdentifier: "LaunchViewController") as! LaunchViewController let navigationController: UINavigationController = checkNavigationController(for: view) launchView.viewModel = LaunchViewModel(with: launchView, router: self) navigationController.pushViewController(launchView, animated: false) } } }</span></span></code> </pre><br></div></div><br>  A falta de experi√™ncia na implementa√ß√£o de tal padr√£o se fez sentir.  Tudo parecia arrumado e claro, o roteador criou uma nova classe UIViewController, criou um ViewModel para ele e executou a l√≥gica para mudar para essa tela.  Mas, ainda assim, muitas defici√™ncias se fizeram sentir. <br>  Dificuldades come√ßaram a surgir quando foi necess√°rio abrir um aplicativo com uma certa tela ap√≥s a notifica√ß√£o por push.  Como resultado, em alguns lugares, obtivemos uma l√≥gica confusa para escolher a tela certa e mais dificuldades em apoiar essa abordagem. <br><br>  N√£o abandonei a id√©ia de implementar o Roteador, mas continuei nessa dire√ß√£o, ganhando cada vez mais experi√™ncia.  N√£o desista de algo ap√≥s a primeira tentativa falhada. <br><br><h4>  Gerente persistente </h4><br>  Outra classe de gerente interessante na minha pr√°tica.  Mas este √© relativamente jovem.  Mesmo assim, o processo de desenvolvimento consiste em tentativa e erro e, como todos n√≥s, bem ou a maioria de n√≥s, estamos constantemente no processo de desenvolvimento, os erros sempre aparecem. <br><br>  A ess√™ncia do problema √© esta: o aplicativo possui servi√ßos que devem travar constantemente e, ao mesmo tempo, devem estar dispon√≠veis em muitos lugares. <br><br>  Exemplo: determinando o status do Bluetooth.  No meu aplicativo, em v√°rios servi√ßos, preciso entender se o bluetooth est√° ativado ou desativado e assinar atualiza√ß√µes de status.  Como existem v√°rios locais: algumas telas, v√°rios gerenciadores de l√≥gica de neg√≥cios adicionais etc., torna-se necess√°rio que cada um deles assine o delegado CBPeripheralManager (ou CBCentralManager). <br><br>  A solu√ß√£o parece √≥bvia: criamos uma classe separada que monitora o status do bluetooth e notifica todos que precisam dele atrav√©s do padr√£o Observer.  Mas ent√£o surge a pergunta: quem armazenar√° permanentemente esse servi√ßo?  A primeira coisa que vem √† mente neste momento √© torn√°-lo um singleton!  Tudo parece estar bem! <br><br>  Mas aqui chega o momento em que mais de um servi√ßo foi acumulado no meu aplicativo.  Tamb√©m n√£o quero criar 100500 singletones no projeto. <br><br>  E ent√£o outra luz se acendeu acima da minha cabecinha j√° brilhante.  Fa√ßa um singleton que armazene todos esses servi√ßos e forne√ßa acesso a eles em todo o aplicativo.  E assim nasceu o "gerente permanente".  Com o nome, n√£o pensei por muito tempo e o chamei, como todos j√° podiam adivinhar, PersistentManager. <br><br>  Como voc√™ pode ver, tamb√©m tenho uma abordagem muito original para nomear classes.  Eu acho que preciso adicionar um modismo sobre o nome das classes no meu plano de desenvolvimento. <br><br>  O principal problema nesta implementa√ß√£o √© o singleton, que est√° dispon√≠vel em qualquer lugar do projeto.  E isso leva ao fato de os gerentes que usam um dos servi√ßos permanentes acessarem seus m√©todos, o que n√£o √© √≥bvio.  Pela primeira vez, me deparei com isso quando estava criando um grande recurso complexo em um projeto de demonstra√ß√£o separado e transferindo parte da l√≥gica de neg√≥cios do projeto principal.  Ent√£o comecei a receber mensagens com erros sobre servi√ßos ausentes. <br><br>  A conclus√£o que tirei depois disso √© que voc√™ precisa criar suas classes de forma que n√£o haja depend√™ncias ocultas.  Os servi√ßos necess√°rios devem ser passados ‚Äã‚Äãcomo par√¢metros ao inicializar a classe, mas n√£o usando um singleton, que pode ser acessado de qualquer lugar.  E ainda mais lindamente, vale a pena usar protocolos. <br>  Isso acabou por ser outra confirma√ß√£o da falta de um padr√£o singleton. <br><br><h4>  Sum√°rio </h4><br>  E isso, eu n√£o fico parado, mas avan√ßo, dominando novas abordagens na programa√ß√£o.  O principal √© mover, buscar e experimentar.  Erros sempre ser√£o, n√£o h√° como escapar disso.  Mas apenas por causa do reconhecimento dos pr√≥prios erros, √© poss√≠vel desenvolver qualitativamente. <br><br><img src="https://habrastorage.org/webt/xe/xr/wf/xexrwfhf0_i5cpoxtv3kjrqxsne.gif"><br><br>  Na maioria dos casos, os problemas s√£o super classes que fazem muito ou depend√™ncias incorretas entre as classes.  O que sugere que √© necess√°rio decompor a l√≥gica com mais compet√™ncia. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt451996/">https://habr.com/ru/post/pt451996/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt451974/index.html">Hist√≥ria da AMD: 50 anos de desenvolvimento r√°pido</a></li>
<li><a href="../pt451976/index.html">Quanto custa um Runet "soberano"?</a></li>
<li><a href="../pt451982/index.html">Quanto mais r√°pido voc√™ esquecer OOP, melhor para voc√™ e seus programas.</a></li>
<li><a href="../pt451986/index.html">Buscar dados com o ORM √© f√°cil! Ou n√£o?</a></li>
<li><a href="../pt451990/index.html">Perguntas frequentes sobre transfer√™ncias e voos de conex√£o: qual a diferen√ßa que um passageiro pode ou n√£o fazer</a></li>
<li><a href="../pt451998/index.html">Problemas da agricultura de precis√£o e como conviver com eles</a></li>
<li><a href="../pt452000/index.html">Como na Leroy Merlin voc√™ pode comprar mercadorias do armaz√©m de um fornecedor que n√£o est√° no sortimento da loja</a></li>
<li><a href="../pt452004/index.html">Encontrou a localiza√ß√£o da queda do dispositivo "Bereshit" na lua</a></li>
<li><a href="../pt452006/index.html">Metaverso √âpico: Por que os autores do Fortnite devem obt√™-lo</a></li>
<li><a href="../pt452008/index.html">Abordagens de engenharia e lista de verifica√ß√£o: como n√£o enlouquecer no caos de tarefas</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>