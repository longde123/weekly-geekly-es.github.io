<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🔬 🤱 👩🏻‍🤝‍👨🏿 Dummer Grund, warum Ihre listige Bildverarbeitungsanwendung nicht funktioniert: Orientierung in EXIF 👨🏿‍🤝‍👨🏽 🎩 🤸🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich habe viel über Computer Vision und maschinelle Lernprojekte geschrieben, wie zum Beispiel Objekterkennungssysteme und Gesichtserkennungsprojekte ....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Dummer Grund, warum Ihre listige Bildverarbeitungsanwendung nicht funktioniert: Orientierung in EXIF</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/471112/"> Ich habe viel über Computer Vision und maschinelle Lernprojekte geschrieben, wie zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Objekterkennungssysteme</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gesichtserkennungsprojekte</a> .  Ich habe auch eine Open-Source-Python- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Gesichtserkennungsbibliothek</a> , die es irgendwie in die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Top 10 der beliebtesten Bibliotheken für maschinelles Lernen auf Github geschafft hat</a> .  All dies hat Neulinge in Python und Machine Vision dazu gebracht, mir <i>viele</i> Fragen zu stellen. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c4b/b2f/40c/c4bb2f40c4522fd2caee36c65a8f4b09.png"><br><br>  Aus Erfahrung gibt es ein spezifisches technisches Problem, das die Menschen am häufigsten verwirrt.  Nein, dies ist keine schwierige theoretische Frage oder ein Problem mit teuren GPUs.  Tatsache ist, dass fast jeder Bilder rotiert in den Speicher lädt, ohne es zu wissen.  Und Computer erkennen Objekte nicht <i>sehr gut</i> oder erkennen Gesichter in gedrehten Bildern nicht. <br><a name="habracut"></a><br><h1>  Wie Digitalkameras Bilder automatisch drehen </h1><br>  Wenn Sie ein Bild aufnehmen, registriert die Kamera die Position des Telefons, sodass in einem anderen Programm das Bild in der richtigen Ausrichtung angezeigt wird: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd0/0e3/ebd/cd00e3ebd77f1d9e920128d76b4f776a.png"><br><br>  Die Kamera dreht die Pixeldaten in der Datei jedoch nicht.  Da Bildsensoren in Digitalkameras zeilenweise als kontinuierlicher Strom von Pixelinformationen gelesen werden, ist es für die Kamera einfacher, Pixeldaten unabhängig von der tatsächlichen Position des Telefons immer in derselben Reihenfolge zu speichern. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3f4/5ba/d70/3f45bad70377a193db2bf631ef1a91ab.png"><br><br>  Dies ist das Anliegen des Programms für die Anzeige - drehen Sie das Bild korrekt, bevor Sie es auf dem Bildschirm anzeigen.  Neben den Daten des Bildes selbst speichert die Kamera auch Metadaten - Objektiveinstellungen, Standortdaten und natürlich den Drehwinkel der Kamera.  Der Betrachter sollte diese Informationen verwenden, um korrekt anzuzeigen. <br><br>  Das am häufigsten verwendete Bildmetadatenformat heißt <b>EXIF</b> (kurz für Exchangeable Image File Format).  EXIF-Metadaten sind in jede JPEG-Datei eingebettet.  Sie können sie nicht auf dem Bildschirm sehen, aber sie werden von jedem Programm gelesen, das weiß, wo sie suchen müssen. <br><br>  Hier sind die EXIF-Metadaten im JPEG-Bild unserer Gans aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">exiftool-</a> Tool: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/601/cad/fda/601cadfda25a8aab0af8ccb2b8c699b1.png"><br><br>  Siehe das Element 'Orientierung'?  Er sagt dem Betrachter, dass das Bild vor der Anzeige auf dem Bildschirm um 90 Grad im Uhrzeigersinn gedreht werden sollte.  Wenn das Programm dies vergisst, ist das Bild auf der Seite! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3d7/c9d/230/3d7c9d230dab3133a1628aec93169824.png"><br><br><h1>  Warum werden dadurch so viele Bildverarbeitungsanwendungen in Python zerstört? </h1><br>  EXIF-Metadaten waren ursprünglich nicht Teil des JPEG-Formats.  Sie wurden viel später eingeführt und liehen sich die Idee aus dem TIFF-Format aus.  Aus Gründen der Abwärtskompatibilität sind diese Metadaten optional, und einige Programme machen sich nicht die Mühe, sie zu analysieren. <br><br>  Die meisten Python-Bildbibliotheken wie Numpy, Scipy, TensorFlow, Keras usw. betrachten sich als <i>wissenschaftliche Werkzeuge für ernsthafte Personen</i> , die mit gemeinsam genutzten Datensätzen arbeiten.  Sie kümmern sich nicht um Probleme auf <i>Verbraucherebene</i> wie die automatische Bildrotation, obwohl dies für fast alle Fotos auf der Welt erforderlich ist, die mit modernen Kameras aufgenommen wurden. <br><br>  Dies bedeutet, dass Sie bei der Verarbeitung eines Bildes mit fast jeder Python-Bibliothek die ursprünglichen Bilddaten ohne Drehung erhalten.  Und raten Sie mal, was passiert, wenn Sie versuchen, ein Foto auf Ihrer Seite oder verkehrt herum in das Gesichts- oder Objekterkennungsmodell hochzuladen?  Der Detektor wird nicht ausgelöst, weil Sie ihm schlechte Daten gegeben haben. <br><br>  Sie mögen denken, dass Probleme nur in den Programmen von Anfängern und Studenten auftreten, aber das ist nicht so!  Selbst die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Demoversion von Googles Flaggschiff-Vision-API</a> verarbeitet die EXIF-Ausrichtung nicht richtig: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e81/3e6/0dc/e813e60dcc810a22eb21a15b3adb52f2.jpg"><br>  <i><font color="gray">Demo Die Google Vision API kann keine hochformatigen Bilder von einem Standard-Mobiltelefon drehen</font></i> <br><br>  Obwohl Google Vision einige Tiere auf seiner Seite erkennt, kennzeichnet es sie mit der allgemeinen Bezeichnung "Tier", da Bildverarbeitungsmodelle eine Gans auf ihrer Seite viel schwieriger erkennen als eine vertikale Gans.  Hier ist das Ergebnis, wenn Sie das Bild korrekt drehen, bevor Sie es an das Modell senden: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/68f/7c9/a07/68f7c9a073642c35d200cacbe9d89838.jpg"><br><br>  Mit der richtigen Ausrichtung erkennt Google Vögel mit einer spezifischeren Gänsehaut und einem höheren Vertrauensindikator.  Viel besser! <br><br>  Dies ist ein sehr offensichtliches Problem, wenn Sie <i>deutlich sehen, dass sich das Bild</i> wie in dieser Demo <i>auf der Seite</i> befindet.  Aber hier wird alles heimtückisch - normalerweise sieht man es nicht!  Alle normalen Programme auf Ihrem Computer zeigen das Bild in der richtigen Ausrichtung an und nicht so, wie es tatsächlich auf der Festplatte gespeichert ist.  Wenn Sie versuchen, ein Bild anzuzeigen, um festzustellen, warum Ihr Modell nicht funktioniert, wird es daher korrekt angezeigt und Sie werden nicht verstehen, warum das Modell nicht funktioniert! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2b6/cb5/a01/2b6cb5a010eca220dd2f9887c4c24e27.png"><br>  <i><font color="gray">Der Finder auf dem Mac zeigt Fotos immer korrekt aus EXIF ​​gedreht an.</font></i>  <i><font color="gray">Es ist nicht zu erkennen, dass das Bild tatsächlich auf der Seite gespeichert ist</font></i> <br><br>  Dies führt unweigerlich zu vielen offenen Tickets bei Github: Die Leute beschweren sich, dass Open-Source-Projekte kaputt sind und die Modelle nicht sehr genau sind.  Das Problem ist jedoch viel einfacher: Sie führen nur gedrehte oder invertierte Fotos zum Eingang! <br><br><h1>  Korrektur </h1><br>  Die Lösung besteht darin, dass Sie jedes Mal, wenn Sie Bilder in Python-Programme laden, die EXIF-Orientierungsmetadaten überprüfen und die Bilder bei Bedarf drehen sollten.  Es ist ziemlich einfach, aber im Internet ist es überraschend schwierig, Codebeispiele zu finden, die es für alle Orientierungen richtig machen. <br><br>  Hier ist der Code zum Laden eines Bildes in ein Numpy-Array mit der richtigen Ausrichtung: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PIL.Image <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PIL.ImageOps <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exif_transpose</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(img)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> img: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> img exif_orientation_tag = <span class="hljs-number"><span class="hljs-number">274</span></span> <span class="hljs-comment"><span class="hljs-comment"># Check for EXIF data (only present on some files) if hasattr(img, "_getexif") and isinstance(img._getexif(), dict) and exif_orientation_tag in img._getexif(): exif_data = img._getexif() orientation = exif_data[exif_orientation_tag] # Handle EXIF Orientation if orientation == 1: # Normal image - nothing to do! pass elif orientation == 2: # Mirrored left to right img = img.transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 3: # Rotated 180 degrees img = img.rotate(180) elif orientation == 4: # Mirrored top to bottom img = img.rotate(180).transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 5: # Mirrored along top-left diagonal img = img.rotate(-90, expand=True).transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 6: # Rotated 90 degrees img = img.rotate(-90, expand=True) elif orientation == 7: # Mirrored along top-right diagonal img = img.rotate(90, expand=True).transpose(PIL.Image.FLIP_LEFT_RIGHT) elif orientation == 8: # Rotated 270 degrees img = img.rotate(90, expand=True) return img def load_image_file(file, mode='RGB'): # Load the image with PIL img = PIL.Image.open(file) if hasattr(PIL.ImageOps, 'exif_transpose'): # Very recent versions of PIL can do exit transpose internally img = PIL.ImageOps.exif_transpose(img) else: # Otherwise, do the exif transpose ourselves img = exif_transpose(img) img = img.convert(mode) return np.array(img)</span></span></code> </pre> <br>  Von hier aus können Sie ein Array von Bilddaten in jede Standard-Python-Bildverarbeitungsbibliothek übertragen, die ein Eingabearray erwartet: z. B. Keras oder TensorFlow. <br><br>  Da das Problem allgegenwärtig ist, habe ich diese Funktion als Pip-Bibliothek mit dem Namen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">image_to_numpy veröffentlicht</a> .  Sie können es wie folgt installieren: <br><br><pre>  pip3 installiere image_to_numpy </pre><br>  Es funktioniert mit jedem Python-Programm und behebt das Laden von Bildern, zum Beispiel: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> matplotlib.pyplot <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> plt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> image_to_numpy <span class="hljs-comment"><span class="hljs-comment"># Load your image file img = image_to_numpy.load_image_file("my_file.jpg") # Show it on the screen (or whatever you want to do) plt.imshow(img) plt.show()</span></span></code> </pre> <br>  Weitere Informationen finden Sie in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Readme-Datei</a> . <br><br>  Genieße es! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de471112/">https://habr.com/ru/post/de471112/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de471096/index.html">Öffentlicher Test: Lösung für Datenschutz und Skalierbarkeit in Ethereum</a></li>
<li><a href="../de471098/index.html">Digitaler Durchbruch - wie es war</a></li>
<li><a href="../de471100/index.html">Interaktion zwischen Winkelkomponenten mit RxJS</a></li>
<li><a href="../de471102/index.html">Benutzerdefiniertes dynamisches DNS mit CloudFlare</a></li>
<li><a href="../de471104/index.html">Oktober IT Events Digest (Teil 2)</a></li>
<li><a href="../de471116/index.html">5 Food-Tech-Geräte und ein Roboter mit Tomaten</a></li>
<li><a href="../de471118/index.html">So führen Sie Ihre Organisation in OpenStack ein</a></li>
<li><a href="../de471120/index.html">So lösen Sie aktuelle IT-Probleme bei der Verwaltung von Gerätereparaturen</a></li>
<li><a href="../de471122/index.html">Nachrichten aus der Welt von OpenStreetMap Nr. 480 (24.09.2019 - 09.09.2019)</a></li>
<li><a href="../de471126/index.html">Umgang mit Backups für Dell EMC UnityVSA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>