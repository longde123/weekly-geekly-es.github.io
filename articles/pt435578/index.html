<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí∑ ‚ñ´Ô∏è ‚òùÔ∏è Passeio espacial no Natal üè¥ üëé ‚ÜïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° Habr! 

 Pouco antes do Natal, decidiu-se estudar o Spacewalk no departamento de TI - este √© o sistema Red Hat, um an√°logo gratuito do Satellite, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Passeio espacial no Natal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435578/"> Ol√° Habr! <br><br>  Pouco antes do Natal, decidiu-se estudar o Spacewalk no departamento de TI - este √© o sistema Red Hat, um an√°logo gratuito do Satellite, para gerenciamento centralizado da configura√ß√£o, atualiza√ß√µes do sistema e suporte conveniente para todo o parque de servidores. <br><br>  Devido ao fato de a documenta√ß√£o dispon√≠vel no site oficial ser bastante escassa para coment√°rios adicionais de v√°rios tipos de solu√ß√£o de problemas, a tarefa era estudar o produto para sua introdu√ß√£o gradual primeiro nos servidores de teste e, posteriormente, nos produtos. <br><br>  A id√©ia principal de introduzir o Spacewalk n√£o era apenas a centraliza√ß√£o e simplifica√ß√£o do controle, mas tamb√©m para que ningu√©m reproduzisse atualiza√ß√µes nos servidores do novo projeto com canetas divertidas, j√° que os precedentes j√° aconteceram. <br><br>  Ap√≥s duas semanas de trabalho, todo o conhecimento que recebi foi inserido no an√°logo interno do Confluence, e um dia de folga gratuito me levou a escrever um artigo sobre Habr. <br><a name="habracut"></a><br>  Antes de come√ßar, gostaria de destacar brevemente o que foi e n√£o foi afetado, para n√£o pretender um manual completo para trabalhar com o Spacewalk: <br><br>  + Instala√ß√£o e configura√ß√£o do servidor / cliente <br>  + Configura√ß√£o do sistema na GUI <br>  Solucionar problemas de instala√ß√£o / atualiza√ß√£o de pacotes, trabalhar com configura√ß√µes <br>  + Errata (coleta de informa√ß√µes sobre atualiza√ß√µes cr√≠ticas, vulnerabilidades etc.) <br><br>  - Proxy (a necessidade desapareceu, depois de desistir da HA) <br>  - sapateiro / kickstart <br>  - OpenSCAP <br><br><h3>  Requisitos de sistema </h3><br>  Devido ao fato de toda a infraestrutura ser executada no VMWare, o trabalho foi realizado em uma VM executando o CentOS 7. Os requisitos de sistema recomendados pelo desenvolvedor s√£o: <br><br><ul><li>  4GB RAM </li><li>  6 GB de espa√ßo livre para / var / satellite / </li><li>  12 GB para DB </li></ul><br>  Eu usei: <br><br><ul><li>  6GB RAM </li><li>  4 CPU (s) </li><li>  HD de 40GB </li></ul><br>  Tamb√©m aconselho a desativar o SELinux e, se n√£o estiver usando, o firewalld.  Ou adicione o servi√ßo http √†s exce√ß√µes. <br><br>  Nota: no final do artigo, haver√° playbooks para o Ansible, tanto para as partes do cliente quanto do servidor, al√©m de scripts bash.  Com a ajuda deles, ser√° poss√≠vel implantar toda a infraestrutura em alguns minutos. <br><br><h3>  Instala√ß√£o </h3><br>  A instala√ß√£o em si √© descrita na documenta√ß√£o oficial e em v√°rios sites, no entanto, para a integridade do artigo, deixe-me mencionar este ponto aqui. <br><br>  O Spacewalk trabalha com dois DBMSs: PostgreSQL e Oracle RDBMS.  Eu tenho experi√™ncia com o primeiro e vou us√°-lo agora. <br><br>  Existem duas op√ß√µes de instala√ß√£o: atrav√©s do instalador autom√°tico do Spacewalk, que instalar√° e configurar√° a si pr√≥prio e o banco de dados, no entanto, no mesmo servidor, e a instala√ß√£o manual, onde voc√™ poder√° colocar o banco de dados e o aplicativo em servidores diferentes.  Vou considerar as duas op√ß√µes, come√ßarei com uma instala√ß√£o separada. <br><br><h4>  PostgreSQL </h4><br><pre><code class="bash hljs">yum install -y postgresql-server</code> </pre> <br>  Tamb√©m √© necess√°rio conectar os m√≥dulos PL / Tcl para PG: <br><br><pre> <code class="bash hljs">yum install -y postgresql-pltcl postgresql-setup initdb systemctl start postgresql</code> </pre> <br>  Crie um banco de dados, um usu√°rio e conecte o m√≥dulo: <br><br><pre> <code class="bash hljs">su - postgres -c <span class="hljs-string"><span class="hljs-string">'PGPASSWORD=verystrong; createdb spcwlkdb ; createlang plpgsql spcwlkdb ; createlang pltclu spcwlkdb ; yes $PGPASSWORD | createuser -P -sDR spcwlkuser'</span></span></code> </pre> <br>  Para evitar problemas de conex√£o, vale a pena alterar <i>/var/lib/pgsql/data/pg_hba.conf</i> , adicionando as linhas ANTES da linha all: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">local</span></span> spcwlkdb spcwlkuser md5 host spcwlkdb spcwlkuser 127.0.0.1/8 md5 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> spcwlkdb postgres ident</code> </pre> <br>  Reinicie tudo: <br><br><pre> <code class="bash hljs">systemctl restart postgresql</code> </pre> <br>  Se voc√™ pretende instalar o aplicativo e o banco de dados em servidores diferentes, verifique se o pacote <i>postgresql-contrib</i> est√° instalado no servidor de banco de dados. <br><br><h4>  Passeio espacial </h4><br>  Conectamos reposit√≥rios: <br><br><pre> <code class="bash hljs">rpm -Uvh https://copr-be.cloud.fedoraproject.org/results/@spacewalkproject/spacewalk-2.8/epel-7-x86_64/00736372-spacewalk-repo/spacewalk-repo-2.8-11.el7.centos.noarch.rpm</code> </pre> <br>  Conecte tamb√©m a epel: <br><br><pre> <code class="bash hljs">rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</code> </pre> <br>  Java: <br><br><pre> <code class="bash hljs">(<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/yum.repos.d &amp;&amp; curl -O https://copr.fedorainfracloud.org/coprs/g/spacewalkproject/java-packages/repo/epel-7/group_spacewalkproject-java-packages-epel-7.repo)</code> </pre> <br>  Agora, diretamente o instalador do Spacewalk-postgres: <br><br><pre> <code class="bash hljs">yum -y install spacewalk-setup-postgresql</code> </pre> <br>  Conecte-se ao nosso banco de dados: <br><br><pre> <code class="bash hljs">spacewalk-setup-postgresql create --db spcwlkdb --user spcwlkuser --password verystrong</code> </pre> <br>  No caso de voc√™ estar usando um m√©todo de banco de dados / aplicativo separado, ser√° necess√°rio adicionar o sinalizador <i>--standalone</i> e especificar o endere√ßo IP do servidor de banco de dados, tamb√©m n√£o se esque√ßa de abrir a porta 5432. <br><br>  <i>Nota: Aconselho ajustar o banco de dados de acordo com o seu hardware para uma opera√ß√£o mais produtiva de todo o sistema.</i> <br><br>  Agora instale o pr√≥prio Spacewalk e execute a instala√ß√£o: <br><br><pre> <code class="bash hljs">yum -y install spacewalk-postgresql spacewalk-setup --external-postgresql</code> </pre> <br>  Em seguida, v√°rias perguntas ser√£o feitas, tanto em rela√ß√£o ao certificado SSL quanto ao banco de dados.  Voc√™ pode inserir todos os valores manualmente ou usar o sinalizador <i>--answer-file</i> e especificar o caminho para o arquivo com respostas para automatizar a instala√ß√£o no futuro: <br><br><pre> <code class="bash hljs">admin-email = root@localhost ssl-set-cnames = spcwlkserver ssl-set-org = Unicorn ssl-set-org-unit = EOH ssl-set-city = Prague ssl-set-state = HMP ssl-set-country = CZ ssl-password = verystrong ssl-set-email = root@localhost ssl-config-sslvhost = Y db-backend=postgresql db-name=spcwlkdb db-user=spcwlkuser db-password=verystrong db-host=localhost db-port=5432 <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-tftp=Y</code> </pre> <br>  Para controlar o aplicativo diretamente, voc√™ deve usar: <br><br><pre> <code class="bash hljs">/usr/sbin/spacewalk-service [stop|start|restart]</code> </pre> <br>  Para exibir todos os servi√ßos de terceiros que contribuem para o aplicativo: <br><br><pre> <code class="bash hljs">spacewalk-service status</code> </pre> <br><h4>  Op√ß√£o dois, instala√ß√£o autom√°tica </h4><br>  Ap√≥s conectar os reposit√≥rios, configure e execute: <br><br><pre> <code class="bash hljs">yum -y install spacewalk-setup-postgresql yum -y install spacewalk-postgresql spacewalk-setup</code> </pre> <br>  Novamente, ser√£o feitas perguntas sobre o banco de dados e o SSL, usamos a chave <i>--answer-file</i> e o caminho para o arquivo com as respostas. <br><br><h3>  Canais de Base e Crian√ßa, Repos </h3><br>  Para gerenciar esta√ß√µes clientes, o Spacewalk usa um sistema dos chamados canais, que podem ser principal (filho) ou filho (filho), um reposit√≥rio necess√°rio √© anexado a cada canal, al√©m de uma chave - com a qual o cliente est√° emparelhado servidor. <br><br>  Como resultado, os reposit√≥rios s√£o sincronizados com os canais, que, por sua vez, est√£o conectados aos clientes, e o Spacewalk funciona de maneira geral.  Tamb√©m √© preciso mencionar as erratas, que podem ser vinculadas aos canais, o que simplifica a atualiza√ß√£o e o controle de pacotes. <br><br>  Todos os clientes podem ser agrupados de acordo com v√°rios crit√©rios, com os mesmos canais e com diferentes canais ou reposit√≥rios.√â poss√≠vel trabalhar com um grande n√∫mero de clientes por vez, o que ajuda a fazer atualiza√ß√µes em mais de 100 servidores. <br><br>  Uma lista de todos os pacotes instalados est√° dispon√≠vel e ap√≥s a sincroniza√ß√£o dos reposit√≥rios e poss√≠vel para instala√ß√£o.  Alguns pontos s√£o intuitivos e n√£o faz sentido considerar cada item linha por linha. <br><br>  Todas as a√ß√µes no Spacewalk ocorrem em uma programa√ß√£o (Agenda), quase qualquer a√ß√£o pode ser configurada para o hor√°rio que for mais conveniente para voc√™. <br><br>  Ap√≥s a instala√ß√£o, ser√° poss√≠vel acessar o endere√ßo do seu servidor, realizar outras configura√ß√µes atrav√©s da interface gr√°fica: <br><br><img src="https://habrastorage.org/webt/bb/iq/co/bbiqcow_kswo_i91vsqceeg6g0s.png"><br><br>  Digite a senha, o nome do administrador, o nome da organiza√ß√£o (que tamb√©m √© uma das maneiras de gerenciar clientes) e v√° para o painel inicial. <br><br>  Por enquanto, voc√™ pode explorar as op√ß√µes dispon√≠veis ou criar canais. <br><br>  <i>Canais - Gerenciar Canais de Software - Criar Canal:</i> <br><br><img src="https://habrastorage.org/webt/5m/6o/f9/5m6of99m6ey7yq0rxbdmenvhcuw.png"><br><br>  Eu recomendo definir os nomes dos canais de acordo com os tipos e tipos de SO que ser√£o vinculados a esse canal, por exemplo, <i>CentOS_7_x86_64</i> , voc√™ pode escolher com seguran√ßa sha256 como verifica√ß√µes, o campo Channell Summary destina-se a uma pequena descri√ß√£o do canal.  Al√©m disso, voc√™ pode opcionalmente fornecer informa√ß√µes adicionais. <br><br>  Agora crie um canal filho e vincule-o ao canal principal.  Iremos da mesma maneira que a cria√ß√£o do canal principal; somente no campo Canal Pai, indicaremos o canal criado anteriormente. <br><br>  Ligue os reposit√≥rios aos canais principais e subsidi√°rios. <br>  <i>Canais - Gerenciar Reposit√≥rios</i> <br><br><img src="https://habrastorage.org/webt/a3/gq/ok/a3gqokxrwd10mlfq4geiw0f1nqy.png"><br><br>  Para os principais canais, eu uso os Recursos de Base, para os canais subsidi√°rios - Atualiza√ß√µes. <br><br>  Ap√≥s criar os reposit√≥rios, voc√™ precisa conect√°-los aos canais. <br>  <i>Canais - gerencie canais de software</i> , abra seu canal principal, abra a se√ß√£o Reposit√≥rios. <br><br><img src="https://habrastorage.org/webt/hw/ro/og/hwroogjvybx0p1z2mslzxf8nunq.png"><br><br>  Haver√° todos os reposit√≥rios criados, selecione o que voc√™ precisa, marque-o e clique em Atualizar Recursos. <br><br>  Em seguida, abra a subchave Sync: <br><br><img src="https://habrastorage.org/webt/ho/j7/4m/hoj74mhjkorduvftwkwbteuxzk4.png"><br><br>  Onde voc√™ pode sincronizar o reposit√≥rio e o canal, configure o agendamento da sincroniza√ß√£o. <br><br>  <i>Nota: no meu caso de canetas divertidas, tive que excluir o reposit√≥rio padr√£o do sistema do cliente.</i> <br><br><h4>  Instala√ß√£o do cliente, emparelhando o cliente com o servidor, gerenciamento de chaves, configurando o canal de configura√ß√£o </h4><br>  Como mencionei anteriormente, o Spacewalk usa um sistema de chaves da Red Hat Network, que √© usado para emparelhamento e gerenciamento. <br><br>  Para criar uma chave, v√° para <i>Sistemas - Chaves de Ativa√ß√£o - Criar Chave:</i> <br><br><img src="https://habrastorage.org/webt/ea/df/vf/eadfvfezxpeh1s_lt9blgfox3j8.png"><br><br>  Tudo √© extremamente simples aqui, vale a pena mencionar que voc√™ mesmo pode definir a chave, seu formato sempre ser√° <i>1-XXXXXX</i> e, al√©m disso, cada chave √© anexada ao canal.  O sinalizador Universal Default for√ßa novos sistemas a selecionar os principais par√¢metros. <br><br>  <b>Instala√ß√£o do cliente</b> <br><br>  Conecte o reposit√≥rio do cliente e instale os pacotes necess√°rios: <br><br><pre> <code class="bash hljs">rpm -Uvh https://copr-be.cloud.fedoraproject.org/results/@spacewalkproject/spacewalk-2.8-client/epel-7-x86_64/00742644-spacewalk-repo/spacewalk-client-repo-2.8-11.el7.centos.noarch.rpm yum -y install rhn-client-tools rhn-check rhn-setup rhnsd m2crypto yum-rhn-plugin rhncfg-actions deltarpm</code> </pre> <br><br>  <i>Nota: rhncfg-actions e deltarpm s√£o necess√°rios para que as configura√ß√µes e o controle remoto funcionem corretamente.</i> <br><br>  O Spacewalk usa rhn_check para sincronizar o servidor do cliente, que √© executado a cada 4 horas.  Esse valor pode ser reduzido para 60 minutos, mas para mim nenhuma das op√ß√µes era √≥tima, portanto, existem duas op√ß√µes: use osad, que acompanha o Spacewalk, ou simplesmente adicione um cronjob para rhn_check, por exemplo, a cada minuto enquanto testar o sistema, o valor pode ser alterado como desejar. <br><br><pre> <code class="bash hljs">crontab -e * * * * * /usr/sbin/rhn_check</code> </pre> <br>  Tamb√©m n√£o ser√° errado adicionar / usr / bin / rhn-actions-control --enable-all ao Cron tamb√©m, ele √© usado para implantar configura√ß√µes e √†s vezes fica est√∫pido. <br><br>  Retornamos ao gerenciamento de chaves, copiamos o ID da chave que criamos e executamos: <br><br><pre> <code class="bash hljs">rhnreg_ks --serverUrl=http://your-server-ip/XMLRPC --activationkey=1-YOURKEY --force</code> </pre> <br>  S√≥ n√£o se esque√ßa de alterar os valores de IP e chave para voc√™.  Novamente, recomendo que voc√™ use o sinalizador <i>--force</i> , pois notei problemas sem us√°-lo. <br><br>  Voltamos ao <i>Systems - Todos</i> , temos o prazer de observar nosso sistema.  Agora voc√™ pode abri-lo e explorar o que e como, mas por enquanto eu recomendo criar um grupo para um gerenciamento de sistema mais conveniente. <br><br>  <i>Sistemas - Grupos de sistemas - Criar grupo</i> , preencha o nome e a descri√ß√£o, salve, abra o grupo rec√©m-criado, v√° para a se√ß√£o <i>Sistemas</i> e adicione o sistema ao grupo. <br><br>  Agora, inscreva o sistema no canal <i>Systems - Seu sistema - pasta Software - subpasta Software Channels:</i> <br><br><img src="https://habrastorage.org/webt/7f/hp/lu/7fhplurd2imupn4cio2n7ymcz1y.png"><br><br>  Escolha o seu canal e clique na confirma√ß√£o.  Por divers√£o, voc√™ pode tentar instalar o pacote, <i>Software - Pacotes - Instalar</i> . <br><br>  <b>Canal de configura√ß√£o</b> <br><br>  Para gerenciar configura√ß√µes entre o servidor cliente / m√°quina local e o controle remoto, vale a pena configurar o canal de configura√ß√£o e vincular o sistema a ele. <br>  Vamos para <i>Configura√ß√£o - Canais de configura√ß√£o - Criar canal de configura√ß√£o</i> , defina o nome, descri√ß√£o, salve e, em <i>Configura√ß√£o - Gerenciar canais de configura√ß√£o - Inscreva-se em Canais</i> e assine o canal de configura√ß√£o no canal de software e no sistema. <br><br><img src="https://habrastorage.org/webt/jy/ki/wt/jykiwtrdmame71pab7yyzr40lay.png"><br><br>  Agora podemos implantar configura√ß√µes do servidor e das m√°quinas locais e criar parti√ß√µes. <br><br>  <i>Configura√ß√£o - Adicionar arquivos - Criar arquivo / Carregar arquivo:</i> <br><br><img src="https://habrastorage.org/webt/cf/js/ie/cfjsieqwp21zlmem7goijg7cqui.png"><br><br>  Al√©m disso, podemos enviar comandos remotos na forma de um script bash: <br><br><img src="https://habrastorage.org/webt/hy/xw/d-/hyxwd-znezglfc-glf5yhn44wsq.png"><br><br>  Lembro que todas as a√ß√µes passam por uma Agenda, uma lista de todas as a√ß√µes aplicadas a este sistema pode ser encontrada na se√ß√£o Eventos: <br><br><img src="https://habrastorage.org/webt/9m/fp/hj/9mfphjmglxmqpxfd_cdqpsf8g2s.png"><br><br>  <b>Errata</b> <br><br>  Um dos recursos mais importantes do Spacewalk √© o suporte a erratas, que se liga convenientemente aos canais e permite monitorar o n√≠vel de import√¢ncia das atualiza√ß√µes mais recentes.  Isso √© configurado diretamente no servidor, al√©m dos scripts, voc√™ precisa baixar os pacotes necess√°rios para o Pearl: <br><br><pre> <code class="bash hljs">yum -y install perl-Frontier-RPC perl-Text-Unidecode wget https://raw.githubusercontent.com/stevemeier/cefs/master/errata-import.pl chmod +x errata-import.pl</code> </pre> <br>  Em seguida, crie as principais erratas do script de atualiza√ß√£o e cole√ß√£o, que ser√£o armazenadas em <i>/ etc / rhn /:</i> <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash cd /etc/rhn/ wget -N http://cefs.steve-meier.de/errata.latest.xml wget -N https://www.redhat.com/security/data/oval/com.redhat.rhsa-all.xml export SPACEWALK_USER='root' export SPACEWALK_PASS='verystrong' ./errata-import.pl --server YourServerIPAddress --errata errata.latest.xml --rhsa-oval com.redhat.rhsa-all.xml --publish unset SPACEWALK_USER unset SPACEWALK_PASS</span></span></code> </pre> <br>  Na exporta√ß√£o, especifique o nome e a senha do administrador do Spacewalk, que voc√™ especificou no in√≠cio. <br><br>  Vamos tornar o script execut√°vel e adicion√°-lo ao Cron: <br><br><pre> <code class="bash hljs">chmod +x spcwlk_errata.sh crontab -e 0 2 * * 7 /usr/bin/sh /etc/rhn/spcwlk_errata.sh</code> </pre> <br>  Vamos execut√°-lo agora mesmo para ver altera√ß√µes na interface gr√°fica.  A execu√ß√£o levar√° algum tempo. <br><br><img src="https://habrastorage.org/webt/5v/yy/v9/5vyyv9a4xpmq7c2lqqglozhdrsk.png"><br><br><h4>  Sum√°rio </h4><br>  Um ponto importante, na minha opini√£o, que eu pessoalmente senti falta, √© configurar e instalar um proxy, al√©m de elevar todo o sistema como HA.  Tive uma ideia de configurar o aplicativo atrav√©s do pacemaker e sincronizar no banco de dados.  Como resultado, decidiu-se abandonar essa ideia, tendo em vista a frota de servidores n√£o muito grande de esta√ß√µes clientes.  No entanto, se o sistema for extremamente √∫til nos pr√≥ximos seis meses, talvez voc√™ precise expandir o servidor original. <br><br><h4>  Automa√ß√£o </h4><br>  <b>Servidor:</b> <br><br><div class="spoiler">  <b class="spoiler_title">Script bash para implanta√ß√£o do servidor (DISABLES firewalld):</b> <div class="spoiler_text"><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # rpm -Uvh https://copr-be.cloud.fedoraproject.org/results/@spacewalkproject/spacewalk-2.8/epel-7-x86_64/00736372-spacewalk-repo/spacewalk-repo-2.8-11.el7.centos.noarch.rpm rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm (cd /etc/yum.repos.d &amp;&amp; curl -O https://copr.fedorainfracloud.org/coprs/g/spacewalkproject/java-packages/repo/epel-7/group_spacewalkproject-java-packages-epel-7.repo) yum -y install spacewalk-setup-postgresql spacewalk-postgresql wget perl-Frontier-RPC perl-Text-Unidecode perl-XML-Simple # mkdir /usr/share/spcwlk-tmp/ echo 'admin-email = root@localhost ssl-set-cnames = spcwlkserver ssl-set-org = Unicorn ssl-set-org-unit = EOH ssl-set-city = Prague ssl-set-state = SCK ssl-set-country = CZ ssl-password = verystrong ssl-set-email = root@localhost ssl-config-sslvhost = Y db-backend=postgresql db-name=spcwlkdb db-user=spcwlkuser db-password=verystrong db-host=localhost db-port=5432 enable-tftp=Y' &gt; /usr/share/spcwlk-tmp/spcwlk_answer spacewalk-setup --answer-file=/usr/share/spcwlk-tmp/spcwlk_answer # systemctl stop firewalld systemctl disable firewalld #</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Script Bash para instalar erratas (primeiro defina o nome e a senha do administrador do Spacewalk):</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # wget https://raw.githubusercontent.com/stevemeier/cefs/master/errata-import.pl -P /etc/rhn/ echo '#!/bin/bash cd /etc/rhn/ wget -N http://cefs.steve-meier.de/errata.latest.xml wget -N https://www.redhat.com/security/data/oval/com.redhat.rhsa-all.xml export SPACEWALK_USER='gui username' export SPACEWALK_PASS='Password to your gui account' ./errata-import.pl --server YourServerIPAddress --errata errata.latest.xml --rhsa-oval com.redhat.rhsa-all.xml --publish unset SPACEWALK_USER unset SPACEWALK_PASS' &gt; /etc/rhn/spcwlk_errata.sh # chmod +x /etc/rhn/errata-import.pl chmod +x /etc/rhn/spcwlk_errata.sh # echo '#!/bin/bash # /etc/rhn/./spcwlk_errata.sh' &gt; /etc/rhn/spcwlk_errata_cron.sh chmod +x /etc/rhn/spcwlk_errata_cron.sh echo '0 2 * * 7 /usr/bin/sh /etc/rhn/spcwlk_errata_cron.sh' &gt;&gt; /var/spool/cron/root /etc/rhn/./spcwlk_errata.sh #</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Manual poss√≠vel para implanta√ß√£o do servidor (n√£o se esque√ßa de adicionar um arquivo de resposta):</b> <div class="spoiler_text"><pre> <code class="bash hljs">- hosts: spcwlk-server tasks: - name: Install Spacewalk repo yum: name: https://copr-be.cloud.fedoraproject.org/results/@spacewalkproject/spacewalk-2.8/epel-7-x86_64/00736372-spacewalk-repo/spacewalk-repo-2.8-11.el7.centos.noarch.rpm state: present - name: Install epel repo yum: name: https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm state: present - name: Install PostgreSQL packages yum: name: - spacewalk-setup-postgresql - spacewalk-postgresql - wget - perl-Frontier-RPC - perl-Text-Unidecode - perl-XML-Simple - name: Creates directory <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Spacewalk answer file file: path: /usr/share/spcwlk-tmp/ state: directory mode: 0755 - name: Deploy answer file copy: src: /etc/ansible/spcwlk_answer dest: /usr/share/spcwlk-tmp/spcwlk_answer - name: Spacewalk Server Deploy shell: spacewalk-setup --answer-file=/usr/share/spcwlk-tmp/spcwlk_answer - name: Stop firewalld systemd: name: firewalld state: stopped enabled: no</code> </pre> <br></div></div><br>  <b>Cliente:</b> <br><br><div class="spoiler">  <b class="spoiler_title">Script Bash para implanta√ß√£o do cliente (n√£o se esque√ßa do IP e da chave):</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh # rpm -Uvh https://copr-be.cloud.fedoraproject.org/results/@spacewalkproject/spacewalk-2.8-client/epel-7-x86_64/00742644-spacewalk-repo/spacewalk-client-repo-2.8-11.el7.centos.noarch.rpm yum -y install rhn-client-tools rhn-check rhn-setup rhnsd m2crypto yum-rhn-plugin rhncfg-actions deltarpm wget echo '#!/bin/bash # /usr/sbin/rhn_check' &gt; rhn_check.sh mv rhn_check.sh /etc/cron.hourly/ chmod +x /etc/cron.hourly/rhn_check.sh echo '* * * * * /usr/bin/sh /etc/cron.hourly/rhn_check.sh' &gt;&gt; /var/spool/cron/root /usr/bin/rhn-actions-control --enable-all cd /usr/share/rhn/ wget http://YourServerIPAddress/pub/RHN-ORG-TRUSTED-SSL-CERT rhnreg_ks --serverUrl=http://172.22.64.41/XMLRPC --activationkey=1-xxxxxxxxxxxxxxxxxxxxxxxxxxxx --force</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Manual anisble para implanta√ß√£o do cliente:</b> <div class="spoiler_text"><pre> <code class="bash hljs">- hosts: spcwlk-clients tasks: - name: Install spacewalk repo yum: name: https://copr-be.cloud.fedoraproject.org/results/@spacewalkproject/spacewalk-2.8-client/epel-7-x86_64/00742644-spacewalk-repo/spacewalk-client-repo-2.8-11.el7.centos.noarch.rpm state: present - name: Install client packages yum: name: - rhn-client-tools - rhn-check - rhn-setup - rhnsd - m2crypto - yum-rhn-plugin - rhncfg-actions - deltarpm - wget - name: Create cronjob <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rhn_check cron: name: <span class="hljs-string"><span class="hljs-string">"rhn_check"</span></span> minute: <span class="hljs-string"><span class="hljs-string">"*"</span></span> hour: <span class="hljs-string"><span class="hljs-string">"*"</span></span> day: <span class="hljs-string"><span class="hljs-string">"*"</span></span> month: <span class="hljs-string"><span class="hljs-string">"*"</span></span> weekday: <span class="hljs-string"><span class="hljs-string">"*"</span></span> job: <span class="hljs-string"><span class="hljs-string">"/usr/sbin/rhn_check"</span></span> - name: Enable controls <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> config and remote control deployment shell: /usr/bin/rhn-actions-control --<span class="hljs-built_in"><span class="hljs-built_in">enable</span></span>-all - name: Get certificate from server to client get_url: url: http://YourServerIPAddress/pub/RHN-ORG-TRUSTED-SSL-CERT dest: /usr/share/rhn/ - name: Register client to server rhn_register: state: present server_url: http://YourServerIPAddress/XMLRPC activationkey: <span class="hljs-string"><span class="hljs-string">"{{ activation_key }}"</span></span></code> </pre> <br></div></div><br>  Obrigado a todos por ler o artigo.  Boa sorte </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt435578/">https://habr.com/ru/post/pt435578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt435564/index.html">Usando GtkApplication. Recursos de renderiza√ß√£o Librsvg</a></li>
<li><a href="../pt435568/index.html">Roteador VyOS OpenSource</a></li>
<li><a href="../pt435572/index.html">Anycubic i3 Mega: remake de qualidade do Prusa i3</a></li>
<li><a href="../pt435574/index.html">Como o zig funciona?</a></li>
<li><a href="../pt435576/index.html">1C, sem dor</a></li>
<li><a href="../pt435580/index.html">Servi√ßos Java, Spring, Kurento e M√≠dia</a></li>
<li><a href="../pt435582/index.html">Como adicionar um √≠ndice em um sistema carregado 24/7, sem tempo de inatividade?</a></li>
<li><a href="../pt435584/index.html">Slush 2018. Primeiro dia, segundo dia</a></li>
<li><a href="../pt435586/index.html">A arte do xamanismo ou firmware personalizado para o Olinuxino. Kernel e Ubuntu Parte 3</a></li>
<li><a href="../pt435588/index.html">Promo√ß√£o de um aplicativo m√≥vel com experi√™ncia real em n√∫meros</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>