<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèæ ‚úä üì≠ Importar OpenStreetMap. Desde la fuente binaria hasta la tabla en la base de datos en unos pocos pasos üë™ ü•Ç ü§ôüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Por lo general, cuando alguien habla de OSM, aparece uno de los servicios web en su cabeza o una aplicaci√≥n como Maps.me, basada en datos de OSM. De h...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Importar OpenStreetMap. Desde la fuente binaria hasta la tabla en la base de datos en unos pocos pasos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467043/">  Por lo general, cuando alguien habla de OSM, aparece uno de los servicios web en su cabeza o una aplicaci√≥n como Maps.me, basada en <b>datos de</b> OSM.  De hecho, el proyecto OSM es principalmente datos, todo lo dem√°s es esencialmente un caso especial de su uso.  Los servicios generalmente proporcionan solo una parte de la informaci√≥n obtenida de acuerdo con sus reglas. <br><br>  Inicialmente, OSM es una colecci√≥n de puntos, enlaces entre puntos y etiquetas para ellos.  Las fuentes comunitarias tienen dos formatos.  Inicialmente, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">XML se</a> utiliz√≥ como una forma prioritaria de distribuir datos, pero el archivo Planet.osm en forma no comprimida ya ha excedido los terabytes, y no veo ninguna raz√≥n para usarlo para informaci√≥n relativamente voluminosa.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PBF</a> tiene una gran ventaja: es binario y el archivo Earth completo tiene un tama√±o de aproximadamente 50 GB (XML comprimido aproximadamente 80 GB). <br><br>  Se tratar√° de importar datos OSM desde el formato "nativo" utilizando la herramienta Osmosis. <br><br>  Tambi√©n necesitamos PostgreSql con la extensi√≥n Postgis, en la que importaremos datos OSM. <br><br>  Como resultado, es posible obtener informaci√≥n sobre objetos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">con las etiquetas enumeradas aqu√≠</a> en su base de datos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">.</a> <br><br><img src="https://habrastorage.org/webt/eh/7q/5x/eh7q5xn38dp6getkc5o2l5dbijy.png"><br><a name="habracut"></a><br><h3>  Preparaci√≥n de DB. </h3><br>  Primero, cree una base de datos en Postgresql, el nombre realmente no importa. <br><br><pre><code class="bash hljs">psql -c <span class="hljs-string"><span class="hljs-string">"CREATE DATABASE map;"</span></span></code> </pre> <br>  A continuaci√≥n, agregue las extensiones necesarias para seguir trabajando. <br><br><pre> <code class="bash hljs">psql -d map -c <span class="hljs-string"><span class="hljs-string">"CREATE EXTENSION postgis; CREATE EXTENSION hstore; "</span></span></code> </pre> <br>  La extensi√≥n Postgis "conecta" a la base de datos el m√≥dulo real para trabajar con geodatos (le recuerdo que debe instalar Postgis).  La extensi√≥n hstore est√° dise√±ada para funcionar con conjuntos de clave / valor, como  Se incluir√° una gran cantidad de informaci√≥n en las etiquetas OSM. <br><br>  Descargar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Osmosis</a> .  En resumen, es un software para una amplia variedad de operaciones con datos OSM.  Hay buena documentaci√≥n sobre c√≥mo trabajar con la l√≠nea de comando.  Fuentes en Java.  A continuaci√≥n usaremos la l√≠nea de comando.  Tambi√©n us√© Osmosis como una biblioteca de Java, el c√≥digo fuente (disponible en GitHub) me pareci√≥ lo suficientemente claro y la API fue f√°cil de usar. <br><br>  Ahora estamos preparando la base de datos para importar.  Las tablas y funciones necesarias se pueden crear utilizando scripts que se encuentran en la carpeta osmosis / script.  Adem√°s del script principal, ejecutaremos c√≥digo SQL que crear√° un campo para almacenar la geometr√≠a de las l√≠neas.  Esto se debe al hecho de que los datos de OSM se representan m√°s probablemente como conexiones de puntos que como un conjunto de formas geom√©tricas. <br><br><pre> <code class="bash hljs">psql -d map -<span class="hljs-built_in"><span class="hljs-built_in">fc</span></span>:\osmosis\script\pgsnapshot_schema_0.6.sql psql -d map -<span class="hljs-built_in"><span class="hljs-built_in">fc</span></span>:\osmosis\script\pgsnapshot_schema_0.6_linestring.sql</code> </pre> <br><h3>  Importar datos OSM en una base de datos </h3><br>  Bueno, ahora casi todo est√° listo.  Incluso puedes ejecutar la importaci√≥n.  Es necesario decidir qu√© tomaremos como fuente.  Es decir, debe elegir el formato y la fuente.  Inicialmente, la comunidad OSM us√≥ (y usa) el formato XML.  Pero, la cantidad de datos est√° creciendo y creciendo, por lo que el formato de texto se est√° desplazando gradualmente.  Usar PBF es algo m√°s conveniente.  La fuente central <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">planet.openstreetmap.org</a> contiene datos para todo el mundo.  Con un archivo, puede descargar toda la base de conocimiento del proyecto, que ya ha superado los 40 gigabytes en forma binaria.  En aquellos casos en los que quer√≠a recortar un dato a partir de ah√≠, generalmente dejaba la computadora port√°til funcionando toda la noche, proporcion√°ndole m√°s de 100 GB de espacio libre en el SSD para archivos temporales. <br><br>  En nuestro caso, podemos comenzar usando cargas de miembros de la comunidad.  Existen recursos que permiten descargar datos solo para una regi√≥n espec√≠fica.  Por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">download.geofabrik.de</a> .  Tome la regi√≥n de Voronezh.  All√≠ se incluye en un archivo que contiene datos para todo el distrito federal central.  Puede descargar central-fed-district-latest.osm.pbf, y luego cortar la "pieza" deseada en un archivo o filtro separado por coordenadas al importar a la base de datos.  Sugerir√≠a la primera opci√≥n: <br><br><pre> <code class="bash hljs">c:\osmosis\bin\osmosis.bat --<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>-pbf file=<span class="hljs-string"><span class="hljs-string">"c:\downloads\central-fed-district-latest.osm.pbf"</span></span> --bounding-box top=52.059564 left=37.92290 bottom=49.612297 right=43.225858 --write-pbf file=<span class="hljs-string"><span class="hljs-string">"c:\map\voronezh.osm.pbf"</span></span></code> </pre> <br>  Todo es simple aqu√≠.  Leemos el archivo PBF, filtramos los resultados de lectura por el rect√°ngulo de coordenadas y escribimos los resultados despu√©s de filtrarlos al archivo de salida.  Puede filtrar por coordenadas con mayor precisi√≥n utilizando no un rect√°ngulo, sino un pol√≠gono cuyas coordenadas est√°n en un archivo separado. <br><br>  El archivo resultante voronezh.osm.pbf se importa a la base de datos.  Para conectarse, cree un archivo de propiedades con par√°metros de acceso a la base de datos: <br><br><pre> <code class="plaintext hljs">host=localhost database=map user=pguser password=pgpassword dbType=postgresql</code> </pre> <br>  Bueno, la importaci√≥n en s√≠: <br><br><pre> <code class="bash hljs">c:\osmosis\bin\osmosis.bat --<span class="hljs-built_in"><span class="hljs-built_in">read</span></span>-pbf c:\map\voronezh.osm.pbf --write-pgsql authFile=c:\map\databaseinfo.properties</code> </pre> <br><h3>  Datos importados </h3><br>  Ahora ya puede comenzar a estudiar lo que tenemos en la base de datos.  El primer pensamiento es que hay un conjunto de cifras, pero esto no es del todo cierto.  Como dije, el elemento principal es el punto.  Todo lo dem√°s se crea creando enlaces (relaciones) entre puntos.  Todav√≠a no profundizaremos, especialmente porque las manos ya est√°n ansiosas por crear su propia tabla "plana" con algunos datos.  Bueno, para l√≠neas y puntos todo est√° listo, solo necesita crear una tabla con los campos necesarios e insertar las entradas necesarias all√≠.  ¬øY qu√© campos tenemos?  Aqu√≠ para ayudar a la wiki.  Por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">tome el par clave / valor power = line</a> .  Elija una lista de campos que usaremos, por ejemplo: nombre, voltaje, operador, cables.  Resulta que queremos seleccionar las l√≠neas que necesariamente tienen la propiedad power = line, junto con el nombre del campo, voltaje, operador, cables.  Crea una tabla: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> power_lines ( <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, voltage <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, cables <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, geom geometry )</code> </pre><br>  Y la solicitud en s√≠ para completar nuestra nueva tabla: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> power_lines <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ways.tags -&gt; <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, ways.tags -&gt; <span class="hljs-string"><span class="hljs-string">'voltage'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> voltage, ways.tags -&gt; <span class="hljs-string"><span class="hljs-string">'operator'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>, ways.tags -&gt; <span class="hljs-string"><span class="hljs-string">'cables'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> cables, ways.linestring <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> geom <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ways <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ways.tags -&gt; <span class="hljs-string"><span class="hljs-string">'power'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'line'</span></span> )</code> </pre><br>  Hecho, tenemos una tabla con l√≠neas el√©ctricas, ¬°donde algunas l√≠neas incluso tienen algunos de los campos llenos!  Bueno, la tabla es ciertamente interesante, pero tambi√©n ser√≠a bueno visualizar los datos para ver la geometr√≠a.  La forma m√°s r√°pida de hacer esto es con QGIS, excepto que este poderoso SIG primero debe instalarse.  All√≠ ya agregamos una capa Postgis, use cualquier mapa como sustrato (puede usar el complemento OpenLayers).  Configurado, mira: <br><br><img src="https://habrastorage.org/webt/tv/pm/zc/tvpmzcal1xew9jsnej-y4nxgwgc.png"><br><br>  ¬°Hurra!  Incluso muy similar a la verdad, pens√©, mirando por la ventana las l√≠neas el√©ctricas. <br><br>  ¬øY pol√≠gonos? <br><br>  La situaci√≥n con los puntos es casi la misma, excepto que necesita usar la tabla de nodos.  KDPV solo contiene <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">datos sobre subestaciones</a> .  ¬øY qu√© hay de los pol√≠gonos?  Los pol√≠gonos tambi√©n consisten en l√≠neas (cerradas).  Parece que puedes cerrar las l√≠neas y disfrutar del resultado, pero no funciona de esa manera.  Hay muchas trampas.  Los pol√≠gonos pueden constar de varias l√≠neas cerradas. <br><br>  Por ejemplo, una isla puede estar en un lago.  Por lo tanto, obtenemos un "agujero" en el vertedero.  Tambi√©n tuve que aprender sobre el significado de la palabra "exclave" (para mi verg√ºenza, solo sab√≠a sobre el "enclave").  Los pol√≠gonos tambi√©n est√°n agrupados.  Por ejemplo, un bosque puede constar de varias "piezas".  Que debemos representar como un solo objeto.  Para colmo, debemos cortar los pol√≠gonos abiertos si algunos de los datos est√°n fuera del mapa.  Resolv√≠ estos y otros problemas en el script SQL, que puse en el estante de manera segura despu√©s de que funcion√≥.  El proyecto <a href="">osmosis-multypolygon</a> se encontr√≥ en GitHub.  De mala gana, decid√≠ que usar esta soluci√≥n es una mejor opci√≥n que mi conjunto de scripts escritos en mi rodilla en un par de d√≠as.  Hacemos lo que se dice en README, es decir, ejecutamos la lista de scripts, y tenemos la tabla multipol√≠gonos, que se completa con las instrucciones de assemble.sql.  Despu√©s de llenar la tabla con pol√≠gonos, puede llegar a lo que queremos obtener.  ¬øElegimos el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">territorio de los parques</a> ? <br><br>  Miramos la wiki y escribimos un gui√≥n: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> parks ( <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, geom geometry ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> parks <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> m.tags -&gt; <span class="hljs-string"><span class="hljs-string">'name'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, m.geom <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> multipolygons m <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> m.tags -&gt; <span class="hljs-string"><span class="hljs-string">'leisure'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> ( <span class="hljs-string"><span class="hljs-string">'park'</span></span> )</code> </pre><br>  Ahora visualizamos: <br><br><img src="https://habrastorage.org/webt/e0/fd/ha/e0fdhahxcsypi_hppboxwtvd8qs.png"><br><br>  Bueno, para ser honesto, aqu√≠ puede discutir sobre la relevancia de los datos.  Pero este es un tema para otra discusi√≥n. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/467043/">https://habr.com/ru/post/467043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../467033/index.html">Una selecci√≥n de documentos t√©cnicos geniales de Chaos Communication Camp 2019</a></li>
<li><a href="../467035/index.html">Dise√±o de paneles de control para el sitio de comercio electr√≥nico de an√°lisis web. Parte 4: Canal de Youtube</a></li>
<li><a href="../467037/index.html">Factoring: c√≥mo obtener dinero para sillas</a></li>
<li><a href="../467039/index.html">C√≥mo realizar una revisi√≥n de c√≥digo</a></li>
<li><a href="../467041/index.html">C√≥mo digitalizamos Kazajst√°n</a></li>
<li><a href="../467047/index.html">Fen√≥meno XY: evitar problemas "incorrectos"</a></li>
<li><a href="../467049/index.html">Gu√≠a completa de Flexbox</a></li>
<li><a href="../467053/index.html">Comprender los conceptos b√°sicos de Blockchain: el desaf√≠o de los generales bizantinos. Parte 1</a></li>
<li><a href="../467057/index.html">ICD Mobile Banking: Historia de desarrollo</a></li>
<li><a href="../467061/index.html">Fila babil√≥nica: 5 problemas de seguridad en el negocio de la construcci√≥n</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>