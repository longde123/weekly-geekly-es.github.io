<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî≥ üç¥ üöè Col√®re, n√©gociation et d√©pression lorsque vous travaillez avec InfluxDB üèçÔ∏è üç¨ üè†</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si vous utilisez la base de donn√©es de s√©ries chronologiques (timeseries db, wiki ) comme r√©f√©rentiel principal pour un site avec des statistiques, au...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Col√®re, n√©gociation et d√©pression lorsque vous travaillez avec InfluxDB</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449028/"><img src="https://habrastorage.org/webt/t2/ck/io/t2ckiopr9_xbq3n4mbrhs868k1g.png" alt="Influxdb"><br><br>  Si vous utilisez la base de donn√©es de s√©ries chronologiques (timeseries db, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">wiki</a> ) comme r√©f√©rentiel principal pour un site avec des statistiques, au lieu de r√©soudre le probl√®me, vous pouvez avoir beaucoup de maux de t√™te.  Je travaille sur un projet o√π une telle base de donn√©es est utilis√©e, et parfois InfluxDB, qui sera discut√©, a pr√©sent√© des surprises inattendues en g√©n√©ral. <br><a name="habracut"></a><br>  <b>Avis de non</b> - <b>responsabilit√©</b> : ces probl√®mes concernent InfluxDB 1.7.4. <br><br><h3>  Pourquoi des s√©ries chronologiques? </h3><br>  Le projet consiste √† suivre les transactions dans diverses cha√Ænes de blocs et √† afficher des statistiques.  Plus pr√©cis√©ment, nous examinons l'√©mission et la combustion de pi√®ces stables ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">wiki</a> ).  Sur la base de ces transactions, vous devez cr√©er des graphiques et afficher des tableaux crois√©s dynamiques. <br><br>  Lors de l'analyse des transactions, l'id√©e est venue: utiliser la base de donn√©es de s√©ries chronologiques InfluxDB comme stockage principal.  Les transactions sont des points dans le temps et elles s'int√®grent bien dans le mod√®le des s√©ries chronologiques. <br><br>  De plus, les fonctions d'agr√©gation semblaient tr√®s pratiques - elles sont id√©ales pour le traitement de graphiques sur une longue p√©riode.  L'utilisateur a besoin d'un graphique pour l'ann√©e et la base de donn√©es contient un ensemble de donn√©es avec un d√©lai de cinq minutes.  Il est inutile de lui envoyer cent mille points - √† l'exception d'un long traitement, ils ne rentreront pas √† l'√©cran.  Vous pouvez √©crire votre propre impl√©mentation d'augmentation du d√©lai ou utiliser les fonctions d'agr√©gation int√©gr√©es √† Influx.  Avec leur aide, vous pouvez regrouper les donn√©es par jour et envoyer les 365 points souhait√©s. <br><br>  Il √©tait un peu g√™nant que ces bases de donn√©es soient g√©n√©ralement utilis√©es pour collecter des mesures.  Serveurs de surveillance, iot-devices, le tout √† partir duquel des millions de points de la forme ¬´pour¬ª: [&lt;time&gt; - &lt;metric value&gt;].  Mais si la base de donn√©es fonctionne bien avec un grand flux de donn√©es, pourquoi une petite quantit√© devrait-elle causer des probl√®mes?  Dans cet esprit, ils ont pris InfluxDB pour travailler. <br><br><h3>  Quoi d'autre est pratique dans InfluxDB </h3><br>  En plus des fonctions d'agr√©gation mentionn√©es, il y a une autre grande chose - <b>les requ√™tes continues</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">doc</a> ).  Il s'agit d'un planificateur int√©gr√© √† la base de donn√©es qui peut traiter les donn√©es selon un calendrier.  Par exemple, vous pouvez regrouper tous les enregistrements d'un jour toutes les 24 heures, calculer la moyenne et √©crire un nouveau point dans un autre tableau sans √©crire vos propres v√©los. <br><br>  Il existe √©galement des <b>politiques de conservation</b> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">doc</a> ) - mise en place de la suppression des donn√©es apr√®s une p√©riode.  Il est utile lorsque, par exemple, vous devez stocker la charge sur le processeur pendant une semaine avec des mesures une fois par seconde, mais √† une distance de quelques mois, cette pr√©cision n'est pas n√©cessaire.  Dans cette situation, vous pouvez le faire: <br><br><ol><li>  cr√©er une requ√™te continue pour agr√©ger les donn√©es dans une autre table; </li><li>  Pour le premier tableau, d√©finissez une strat√©gie de suppression des m√©triques ant√©rieures √† cette semaine. </li></ol><br>  Et Influx r√©duira ind√©pendamment la taille des donn√©es et supprimera les inutiles. <br><br><h3>  √Ä propos des donn√©es stock√©es </h3><br>  Peu de donn√©es sont stock√©es: environ 70 000 transactions et un autre million de points avec des informations sur le march√©.  Ajout de nouvelles entr√©es - pas plus de 3000 points par jour.  Il y a aussi des mesures sur le site, mais il y a peu de donn√©es et selon la politique de r√©tention, elles ne sont pas stock√©es plus d'un mois. <br><br><h3>  Les probl√®mes </h3><br>  Au cours du d√©veloppement et des tests ult√©rieurs du service, de plus en plus de probl√®mes critiques sont survenus lors du fonctionnement d'InfluxDB. <br><br><h4>  1. Suppression de donn√©es </h4><br>  Il existe une s√©rie de donn√©es avec des transactions: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>, amount, <span class="hljs-keyword"><span class="hljs-keyword">block</span></span>, symbol <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> symbol=<span class="hljs-string"><span class="hljs-string">'USDT'</span></span></code> </pre> <br>  R√©sultat: <br><br><img src="https://habrastorage.org/webt/lg/1m/us/lg1musgntnlnrlps2vpswkph5z0.png"><br><br>  J'envoie une commande pour supprimer les donn√©es: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> symbol=<span class="hljs-string"><span class="hljs-string">'USDT'</span></span></code> </pre> <br>  Ensuite, je fais une demande pour recevoir des donn√©es d√©j√† supprim√©es.  Et Influx, au lieu d'une r√©ponse vide, renvoie une partie des donn√©es √† supprimer. <br><br>  J'essaie de supprimer tout le tableau: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DROP</span></span> MEASUREMENT transactions</code> </pre> <br>  Je v√©rifie la suppression de la table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SHOW</span></span> MEASUREMENTS</code> </pre> <br>  Je ne regarde pas le tableau dans la liste, mais une nouvelle demande de donn√©es renvoie toujours le m√™me ensemble de transactions. <br><br>  Le probl√®me ne m'est venu qu'une seule fois, car le cas de suppression est un cas isol√©.  Mais ce comportement de la base de donn√©es ne rentre manifestement pas dans le cadre d'un travail "correct".  Plus tard sur github, j'ai trouv√© un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ticket</a> ouvert il y a presque un an sur ce sujet. <br><br>  En cons√©quence, la suppression et la restauration ult√©rieure de la base de donn√©es enti√®re ont aid√©. <br><br><h4>  2. Nombres √† virgule flottante </h4><br>  Les calculs math√©matiques utilisant les fonctions int√©gr√©es dans InfluxDB donnent des erreurs de pr√©cision.  Non pas que ce soit inhabituel, mais d√©sagr√©able. <br><br>  Dans mon cas, les donn√©es ont une composante financi√®re et je voudrais les traiter avec une grande pr√©cision.  Pour cette raison, les plans d'abandonner les requ√™tes continues. <br><br><h4>  3. Les requ√™tes continues ne peuvent pas √™tre adapt√©es √† diff√©rents fuseaux horaires </h4><br>  Le service dispose d'un tableau avec des statistiques quotidiennes sur les transactions.  Pour chaque jour, vous devez regrouper toutes les transactions de cette journ√©e.  Mais la journ√©e de chaque utilisateur commencera √† une heure diff√©rente, donc l'ensemble des transactions est diff√©rent.  UTC dispose de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">37 options de</a> d√©calage pour lesquelles vous devez agr√©ger des donn√©es. <br><br>  Lors du regroupement par heure dans InfluxDB, vous pouvez √©galement sp√©cifier un d√©calage, par exemple, pour l'heure de Moscou (UTC + 3): <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MEAN(<span class="hljs-string"><span class="hljs-string">"supply"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> symbol, <span class="hljs-built_in"><span class="hljs-built_in">time</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>d, <span class="hljs-number"><span class="hljs-number">3</span></span>h) fill(previous)</code> </pre> <br>  Mais le r√©sultat de la requ√™te sera incorrect.  Pour une raison quelconque, les donn√©es regroup√©es par jour commenceront d√®s 1677 (InfluxDB prend officiellement en charge la p√©riode de cette ann√©e): <br><br><img src="https://habrastorage.org/webt/ze/cw/oz/zecwoz4n2fxfpsugncvgydiyhvy.png"><br><br>  Pour contourner ce probl√®me, le service a √©t√© temporairement transf√©r√© vers UTC + 0. <br><br><h4>  4. Performance </h4><br>  Il existe de nombreux points de r√©f√©rence sur Internet avec des comparaisons d'InfluxDB et d'autres bases de donn√©es.  √Ä la premi√®re connaissance, ils ressemblaient √† du mat√©riel de marketing, mais maintenant je pense qu'il y a du vrai en eux. <br><br>  Je vais vous raconter mon cas. <br><br>  Le service fournit une m√©thode API qui renvoie des statistiques pour le dernier jour.  Pendant les calculs, la m√©thode interroge la base de donn√©es trois fois avec les requ√™tes suivantes: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> coins_info <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &lt;= <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> symbol <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dominance_info <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> transactions <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> &gt;= <span class="hljs-keyword"><span class="hljs-keyword">NOW</span></span>() - <span class="hljs-number"><span class="hljs-number">24</span></span>h <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-built_in"><span class="hljs-built_in">time</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br>  Explication <br><br><ol><li>  Dans la premi√®re requ√™te, nous obtenons les derniers points pour chaque pi√®ce avec les donn√©es du march√©.  Huit points pour huit pi√®ces dans mon cas. <br></li><li>  La deuxi√®me demande re√ßoit l'un du point le plus r√©cent. <br></li><li>  Le troisi√®me demande une liste de transactions pour le dernier jour, il peut y en avoir plusieurs centaines. <br></li></ol><br>  Je pr√©cise que dans InfluxDB, un index est automatiquement cr√©√© par balises et par heure, ce qui acc√©l√®re les requ√™tes.  Dans la premi√®re requ√™te, le <i>symbole</i> est la balise. <br><br>  J'ai fait un test de r√©sistance pour cette m√©thode API.  Pour 25 RPS, le serveur a montr√© une charge compl√®te de six CPU: <br><br><img src="https://habrastorage.org/webt/t2/ck/io/t2ckiopr9_xbq3n4mbrhs868k1g.png"><br><br>  Dans le m√™me temps, le processus NodeJs n'a donn√© aucune charge. <br><br>  La vitesse d'ex√©cution s'est d√©j√† d√©grad√©e de 7 √† 10 RPS: si un client pouvait recevoir une r√©ponse en 200 ms, alors 10 clients devraient attendre une seconde.  25 RPS - la fronti√®re avec laquelle la stabilit√© a souffert, 500 erreurs ont √©t√© retourn√©es aux clients. <br><br>  Avec de telles performances, il est impossible d'utiliser Influx dans notre projet.  De plus: dans un projet o√π vous devez d√©montrer la surveillance √† de nombreux clients, des probl√®mes similaires peuvent appara√Ætre et le serveur m√©trique sera surcharg√©. <br><br><h3>  Conclusion </h3><br>  La conclusion la plus importante de l'exp√©rience acquise est que vous ne pouvez pas int√©grer une technologie inconnue dans le projet sans une analyse suffisante.  Un simple filtrage des tickets ouverts sur github pourrait fournir des informations afin de ne pas prendre InfluxDB comme entrep√¥t de donn√©es principal. <br><br>  InfluxDB aurait d√ª √™tre bien adapt√© aux t√¢ches de mon projet, mais comme la pratique l'a montr√©, cette base de donn√©es ne r√©pond pas aux besoins et g√¢che beaucoup. <br><br>  Vous pouvez d√©j√† trouver la version 2.0.0-beta dans le r√©f√©rentiel du projet, on esp√®re que dans la deuxi√®me version il y aura des am√©liorations significatives.  En attendant, je vais √©tudier la documentation de TimescaleDB. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr449028/">https://habr.com/ru/post/fr449028/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr449016/index.html">St√©ganographie dans le syst√®me de fichiers √† disque optique</a></li>
<li><a href="../fr449020/index.html">Analyse du code de la plateforme CUBA avec PVS-Studio</a></li>
<li><a href="../fr449022/index.html">Analyse du code de la plateforme CUBA √† l'aide de PVS-Studio</a></li>
<li><a href="../fr449024/index.html">"Le secret de la troisi√®me plan√®te" avec des graphismes de r√©seaux de neurones am√©lior√©s</a></li>
<li><a href="../fr449026/index.html">Syst√®mes d'exploitation: trois pi√®ces faciles. Partie 4: Introduction √† l'ordonnanceur (traduction)</a></li>
<li><a href="../fr449032/index.html">Nous concevons un syst√®me d'extinction d'incendie par aspersion</a></li>
<li><a href="../fr449034/index.html">Citymobil - un manuel pour am√©liorer la disponibilit√© au milieu de la croissance des entreprises pour les startups. Partie 1</a></li>
<li><a href="../fr449036/index.html">Et encore le loup d√©guis√© en mouton</a></li>
<li><a href="../fr449038/index.html">Gestion des conteneurs Docker dans Go</a></li>
<li><a href="../fr449040/index.html">Semaine de la s√©curit√© 17: Attaques de la cha√Æne d'approvisionnement</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>