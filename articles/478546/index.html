<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëú üë¥ üö¥üèª Websockets Alguna experiencia en desarrollo y operaci√≥n. Modificamos al cliente üë©üèΩ‚Äçü§ù‚Äçüë®üèø üèÅ üé∏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Doy la bienvenida a todos los interesados ‚Äã‚Äãen este protocolo, y de antemano me disculpo por mi nota demasiado emocional. Particip√≥ en este tema a tod...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Websockets Alguna experiencia en desarrollo y operaci√≥n. Modificamos al cliente</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/478546/">  Doy la bienvenida a todos los interesados ‚Äã‚Äãen este protocolo, y de antemano me disculpo por mi nota demasiado emocional.  Particip√≥ en este tema a toda prisa (seg√∫n sea necesario), pero durante mucho tiempo.  En este sentido, se ha acumulado y formado una pr√°ctica determinada de dise√±o y uso de esta tecnolog√≠a.  La opci√≥n de implementaci√≥n del servicio se describe <a href="https://habr.com/ru/post/344292/">aqu√≠</a> .  Desde entonces ha corrido mucha agua.  Los principios b√°sicos se han mantenido igual, pero el c√≥digo de la aplicaci√≥n en s√≠ ha sufrido modificaciones naturales.  En algunos lugares, se encontraron y corrigieron errores no cr√≠ticos, en alg√∫n lugar se optimiz√≥ el control de los flujos del programa, las listas de conexiones abiertas, etc. <br><br>  Pero adem√°s del lado del servidor, como saben, hay un lado del cliente.  Y aqu√≠ me gustar√≠a detenerme m√°s a fondo y describir lo que tuve que enfrentar y lo que podr√≠a ser influenciado.  Por supuesto, cuando use JavaScript, no podr√° "divertirse" especialmente, porque todo est√° listo y cerrado, pero puede decir algo sobre el cliente en Java. <br><br>  No importa cu√°n bueno sea un programador, siempre es dif√≠cil desarrollar, inventar algo √∫nico y luego depurar sus propios versos.  Por lo tanto, en un momento sucumb√≠ a la tentaci√≥n de encontrar algo que ya estaba listo, permiti√©ndote usarlo de inmediato en mis proyectos.  Los criterios de selecci√≥n para el m√≥dulo terminado fueron simples.  Quer√≠a obtener un c√≥digo completo y funcional en Java con una sobrecarga m√≠nima. <br><a name="habracut"></a><br>  Como el seleccionado, me instal√© en un m√≥dulo usando las bibliotecas de Apache.  En particular, estos: <br><br><ul><li>  apache-mime4j-core-0.7.2.jar; </li><li>  httpclient-4.2.1.jar; </li><li>  httpcore-4.2.1.jar; </li><li>  httpmime-4.2.1.jar. </li></ul><br>  ¬øQu√© se puede decir sobre su uso?  El software Apache siempre ha sido famoso por su confiabilidad, sofisticaci√≥n y optimizaci√≥n.  El cliente para Android funcion√≥ con √©xito.  El tama√±o del archivo * .apk terminado no era cr√≠ticamente grande.  No hubo quejas especiales sobre el trabajo de estas bibliotecas.  Pero la vida siempre es m√°s inteligente que nosotros.  Y el tiempo (y este per√≠odo es de aproximadamente cuatro a cinco a√±os) hace sus propios ajustes.  La aplicaci√≥n se escribi√≥ cuando hab√≠a una versi√≥n de Android 4.2 - 4.4.  Y la necesidad de nuevas soluciones surgi√≥ este a√±o, cuando los dispositivos con la versi√≥n 10 ya estaban en pleno apogeo. <br><br>  El desarrollo se realiz√≥ en ese momento en Eclipse para Windows 7. La actualizaci√≥n del SDK de Android al nivel deseado llev√≥ al hecho de que el peque√±o disco duro SSD de 128 GB estaba lleno.  Tuve que cambiar a Android Studio.  Adem√°s, tuve que cambiar el sistema operativo base.  Trat√© de instalar Ubuntu (no recuerdo el n√∫mero de versi√≥n) y ya uso Studio en este entorno.  Pero, de nuevo, el fracaso, Andriod Studio tercamente no quer√≠a instalar. <br><br>  Por qu√©, ya olvidado.  Al final, siguiendo el consejo de mis amigos, instal√© la √∫ltima versi√≥n de Linux-Mint y, he aqu√≠, el kit de herramientas lo dej√≥ sin quejas.  Luego, lo que realmente sucedi√≥, precisamente por lo que se describieron todos estos detalles, es decir, la rutina de escribir pruebas. <br><br>  Entonces, ¬øqu√© se esperaba en esta tyagomotina?  Comencemos con el hecho de que desde el sitio oficial Apache copi√≥ versiones m√°s actuales de las bibliotecas anteriores.  Los agreg√≥ al proyecto y ... Y los errores de compilaci√≥n cayeron.  El tiempo ha pasado, las interfaces de clase han cambiado.  As√≠ que (debido a la falta de tiempo para estudiar nuevas bibliotecas) tuve que volver a las versiones anteriores.  Pero ... <br><br>  Pero, de nuevo, no estamos buscando formas f√°ciles.  Pens√©, ¬øpor qu√© necesito estas bibliotecas por completo?  Los textos de estos paquetes son.  ¬øQu√© pasa si tomas y sacas solo las clases necesarias de ellos?  Adem√°s, al considerar los textos del m√≥dulo para trabajar con sockets web, puede ver solo dos clases de estas bibliotecas. <br><br>  As√≠ que cre√© un nuevo proyecto y comenc√© a agregar las clases necesarias.  Y al final result√≥ que para una compilaci√≥n exitosa es necesario sacar 32 clases.  Y sin embargo, s√≠, el proyecto funcion√≥.  Todo respiraba.  La conexi√≥n al servicio de socket web fue exitosa.  Y todo estar√≠a bien, pero not√© el siguiente evento, incomprensible para m√≠.  Al cerrar la conexi√≥n, el m√≥dulo responsable de la conexi√≥n lanz√≥ una excepci√≥n: <br><br>  java.io.EOFException <br>  en java.io.DataInputStream.readByte (DataInputStream.java:77) <br>  en com.example.wsci.HybiParser.start (HybiParser.java:112) <br>  en com.example.wsci.WebSocketClient $ 1.run (WebSocketClient.java:144) <br>  en java.lang.Thread.run (Thread.java:818) <br><br>  Estaba perdido.  Lo siguiente confundido.  La conexi√≥n al servidor fue exitosa.  Los paquetes llegaron y se fueron con √©xito.  Pero, ¬øpor qu√© exactamente el cierre arroj√≥ una excepci√≥n?  Adem√°s, todo era est√°ndar en el servidor.  Obviamente, en alg√∫n lugar del texto, los clientes ten√≠an algunas cosas que afectaban el cierre.  Adem√°s, los textos mostraron tal caracter√≠stica.  De acuerdo con la <a href="https://tools.ietf.org/html/rfc6455">cl√°usula 7.1.1 del documento, el</a> cierre del lado del cliente consiste no solo en llamar al m√©todo close (), sino en formar y enviar un paquete con el c√≥digo de operaci√≥n 8 (operaci√≥n de cierre).  En este caso, el servidor enviar√≠a su paquete de cierre, despu√©s de lo cual el cliente cerrar√≠a la conexi√≥n.  Pero en nuestro caso, tal secuencia de llamadas no se observ√≥.  Simplemente llam√≥ a la funci√≥n de cierre y eso es todo.  En general, hab√≠a algo en lo que pensar.  Y cuanto m√°s miraba y estudiaba los textos de este m√≥dulo con el analizador de paquetes, menos me gustaba, m√°s ten√≠a el deseo de reescribirlos con mi visi√≥n de este protocolo.  Al final, se decidi√≥ llevar a cabo esta "haza√±a laboral". <br><br>  ¬øQu√© no encajaba realmente, qu√© causaba "protesta civil" en estos m√≥dulos?  En primer lugar, la organizaci√≥n de la interacci√≥n entre el m√≥dulo de conexi√≥n directa con el servidor y el analizador de paquetes.  Result√≥ que el m√≥dulo de conexi√≥n interactuaba con el servidor, generaba un analizador al que le pasaba un enlace como par√°metro.  Como resultado, se deleg√≥ al analizador la autoridad para tomar decisiones sobre los pr√≥ximos eventos de la red.  A este respecto, surgi√≥ la pregunta, pero ¬øes buena?  ¬øNo ser√≠a mejor si el m√≥dulo analizador cumpliera su misi√≥n correspondiente, devolviera el resultado de su trabajo, pero la decisi√≥n de control sobre los eventos ser√≠a ejecutada por el objeto que gener√≥ el analizador?  En este caso, se determinar√≠a una estricta jerarqu√≠a de interacci√≥n entre los objetos.  (Aqu√≠, por supuesto, puede debatir qu√© es mejor: una jerarqu√≠a o una red, pero luego nos alejamos del tema). <br><br>  La segunda cosa que me hizo querer volver a escribir todo fue la estructura del analizador.  Este objeto (clase) debe cumplir dos funciones principales, a saber, formar un paquete de datos para su transmisi√≥n al servidor y el an√°lisis de los paquetes recibidos del servidor.  Entonces, fueron estas dos funciones las que no se adaptaron, en general.  Y con esto <br><br>  Imagine que se ha producido un evento de red, ha llegado un paquete.  ¬øQu√© hizo HybiParser en este caso?  Este objeto ley√≥ los primeros dos bytes del flujo de entrada del socket por byte y determin√≥ sus siguientes acciones: analizar el tama√±o de los datos, la m√°scara, etc.  Como resultado, esto se implement√≥ en varias operaciones de lectura desde el flujo de entrada del socket.  Adem√°s, el an√°lisis fue complicado por las etapas de lectura, lo que complic√≥ a√∫n m√°s el algoritmo.  Y nuevamente surgi√≥ la pregunta, ¬øes correcto, por qu√© tantas dificultades?  ¬øNo es mejor considerar un paquete como una operaci√≥n, especialmente porque se puede determinar el tama√±o de los datos entrantes? <br><br>  El tercero  Parece que un aspecto m√°s controvertido del trabajo del analizador es el ciclo de aceptaci√≥n de paquetes "eterno".  El ciclo se ejecuta en una secuencia de programa separada.  En alg√∫n momento, el z√≥calo se cierra.  ¬øQu√© sigue, el manejo habitual de excepciones?  O que hacer  No, no estoy en contra del mecanismo de excepciones, pero ser√≠a bueno prever esta circunstancia y la reacci√≥n por adelantado.  Por ejemplo, fue posible proponer un mecanismo de sincronizaci√≥n como soluci√≥n, durante el cual se completar√° regularmente el ciclo y, en consecuencia, se producir√° la secuencia del programa. <br><br>  Como resultado de la evaluaci√≥n de todos estos matices, se determinaron los siguientes requisitos para el dise√±o de los m√≥dulos necesarios: <br><br><ul><li>  Los m√≥dulos deben ser independientes de las bibliotecas de terceros; </li><li>  Los m√≥dulos deben ser simples y f√°ciles de integrar en otros proyectos; </li><li>  Los m√≥dulos deben estar listos para una futura expansi√≥n funcional. </li></ul><br>  Bueno, y para no ser culpado por las cr√≠ticas excesivas a la soluci√≥n preparada anterior, agregamos a esto adem√°s que parte de las funciones preparadas y no cr√≠ticas podr√≠an transferirse de manera segura a una nueva implementaci√≥n.  Bueno, eso es todo, y como dijeron en el XXII Congreso del PCUS: "Nuestros objetivos son claros, las tareas est√°n definidas.  ¬°Al trabajo, camaradas!  ¬°Por las nuevas victorias del comunismo! <br><br>  En general, para no sobrecargarlo, querido lector, para no quitarle su valioso tiempo, describir√© brevemente mi propuesta y me centrar√© solo en los puntos clave. <br>  Entonces, la implementaci√≥n propuesta contiene solo cuatro m√≥dulos (de acuerdo con los requisitos anteriores de la biblioteca Apache o las clases individuales de ellos no se incluyeron en el proyecto): <br><br><ul><li>  WebSocket protocol 07 m√≥dulo de constantes globales; </li><li>  Clase de excepci√≥n auxiliar; </li><li>  Cliente de socket web; </li><li>  M√≥dulo para analizar paquetes del protocolo webSocket nivel 07. </li></ul><br>  En los primeros dos m√≥dulos, la implementaci√≥n es trivial, no hay nada que considerar.  El m√≥dulo del cliente implementa el control sobre la conexi√≥n al servidor, y me gustar√≠a detenerme en los siguientes puntos.  La funci√≥n de conexi√≥n abierta tiene un bucle de encabezados que provienen del servidor.  Aqu√≠, el an√°lisis de claves Sec-WebSocket-Accept se implementa realmente, y en nuestro caso, el an√°lisis se realiza sin utilizar las bibliotecas de Apache. <br><br>  A continuaci√≥n, preste atenci√≥n a las funciones de control de bucle de paquetes.  La implementaci√≥n es trivial, a trav√©s de un objeto de sincronizaci√≥n. <br><br>  El siguiente punto a respetar es la funci√≥n del bucle.  El ciclo no es "eterno", sino con la salida de acuerdo con la condici√≥n de verificar el objeto de sincronizaci√≥n.  En un ciclo, un paquete que llega se lee en una operaci√≥n.  El paquete es analizado por el objeto correspondiente para el an√°lisis.  A continuaci√≥n, se toma una decisi√≥n de gesti√≥n sobre el pr√≥ximo evento de red. <br><br>  Para completar la descripci√≥n, observamos la funci√≥n de terminar de forma segura la conexi√≥n.  Esto se hace de la siguiente manera.  Se env√≠a un paquete de terminaci√≥n de conexi√≥n al servidor y se genera una variable de la clase Runnable, que luego se coloca en el procesador de cola para su ejecuci√≥n a trav√©s de la funci√≥n postDelayed, uno de cuyos par√°metros es el retraso en la operaci√≥n en milisegundos.  En la variable Ejecutable, la funci√≥n de ejecuci√≥n contiene una secuencia de llamadas cuando finaliza la secuencia del programa y se cierra la conexi√≥n al servidor.  En el caso de que el paquete de respuesta de cierre llegue antes, esta posici√≥n en la lista de procesamiento se elimina. <br><br>  La clase que implementa el an√°lisis de los paquetes de WebSocket contiene dos m√©todos que requieren atenci√≥n: el an√°lisis y la formaci√≥n de un paquete para la transmisi√≥n de acuerdo con los par√°metros relevantes.  Al analizar, todos los indicadores y datos del paquete recibido se almacenan en variables de clase p√∫blicas.  ¬øPor qu√© p√∫blico?  S√≠, por simplicidad, para no crear funciones adicionales get / set para ellos. <br><br>  Bueno, en realidad, querido lector.  Se <a href="https://yadi.sk/d/TAODjdYRpyWl5Q">adjunta el</a> archivo con el proyecto para Android Studio.  No har√© ning√∫n reclamo sobre el uso de estos textos en sus proyectos.  Se acepta la cr√≠tica constructiva.  Responda preguntas lo m√°s lejos posible. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/478546/">https://habr.com/ru/post/478546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../478534/index.html">DevFest Siberia 2019: un vistazo a las tendencias desde el interior</a></li>
<li><a href="../478536/index.html">WebRTC a trav√©s de Kurento: experiencia de prueba e implementaci√≥n</a></li>
<li><a href="../478538/index.html">C√≥mo verificar la validez de su pasaporte</a></li>
<li><a href="../478542/index.html">FigmaGen: Style Automation en la aplicaci√≥n iOS</a></li>
<li><a href="../478544/index.html">Vue Storefront: Importar directorio desde Magento 2</a></li>
<li><a href="../478550/index.html">¬øC√≥mo gestionar un reloj? An√°lisis de la pista front-end del segundo campeonato de programaci√≥n.</a></li>
<li><a href="../478552/index.html">Segundo applet, cierre y botones transparentes en Processing 3</a></li>
<li><a href="../478554/index.html">Seminario web "SRE: ¬øexageraci√≥n o el futuro?" 12 de diciembre a las 11:00</a></li>
<li><a href="../478560/index.html">¬øSon an√≥nimos los mensajeros instant√°neos gratuitos?</a></li>
<li><a href="../478564/index.html">C√≥mo nosotros en TsIAN domesticamos terabytes de troncos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>