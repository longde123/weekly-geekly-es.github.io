<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚ò∏Ô∏è üéä üèÇüèΩ Para a pergunta sobre bitset üê¥ üàöÔ∏è ‚èØÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúN√£o est√° na hora, meus amigos, de balan√ßar em William, veja, nosso Shakespeare? " 


 Recentemente, li um post sobre um teclado personalizado e mais ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Para a pergunta sobre bitset</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447688/"><h3>  ‚ÄúN√£o est√° na hora, meus amigos, de balan√ßar em William, veja, nosso Shakespeare?  " </h3><br><img src="https://habrastorage.org/webt/p7/bz/aw/p7bzaw_ttw8pdlvlc4wmn3hltcw.jpeg"><br><br>  Recentemente, li um post sobre um teclado personalizado e mais uma vez pensei que seria bom escrever uma implementa√ß√£o de teclado (ou seja, que n√£o tenha vergonha de assinar com seu nome e coloc√°-lo em exibi√ß√£o p√∫blica).  Essa ideia n√£o me vem pela primeira vez, mas, de alguma forma, para na primeira etapa - lendo as informa√ß√µes iniciais, porque quero tornar essa etapa f√°cil de configurar, conveniente de usar, universal e eficaz, e n√£o gosto da oferta "escolha duas". <br><br>  Nota necess√°ria - vejo 4 camadas de implementa√ß√£o do teclado: 0 - detec√ß√£o de eventos, 1 - leitura de dados, 2 - limpeza e armazenamento de dados, 3 - gera√ß√£o de mensagens, 4 - transcodifica√ß√£o, etc.  O mais promissor para a camada 1 e a camada 0 associada a mim me parece o uso de modelos Anton Chizhov para trabalhar com pinos MK (baseados na classe Loki) e, talvez, algum dia, o resultado resultante n√£o ter√° vergonha de compartilhar, mas certamente n√£o hoje.  Agora estou pensando na camada 2. <br><a name="habracut"></a><br>  Vamos formular o problema - √© necess√°rio armazenar informa√ß√µes sobre um conjunto fixo de comutadores que usam um dos dois valores predefinidos - "fechado" e "n√£o fechado".  Os candidatos mais naturais s√£o vari√°veis ‚Äã‚Äãbooleanas e a biblioteca de bits, como uma maneira de armazenar um conjunto.  Como o requisito de efici√™ncia √© um imperativo categ√≥rico, √© desej√°vel avaliar a implementa√ß√£o do m√≥dulo deste ponto de vista. <br><br>  O primeiro pensamento foi examinar os c√≥digos-fonte e tudo ficou imediatamente claro, mas depois de um breve conhecimento deles, percebi que aprender sobre os modelos de outras pessoas n√£o era muito interessante (e n√£o muito produtivo).  Al√©m disso, as fontes n√£o fornecem uma avalia√ß√£o precisa da efic√°cia da implementa√ß√£o, uma vez que est√° diretamente fechada ao compilador.  De fato, o texto original ainda precisava ser estudado, caso contr√°rio, fazer altera√ß√µes torna-se um processo muito demorado (a menos que, √© claro, tenhamos interesse em obter um determinado resultado), mas esse √© o t√≥pico de uma postagem separada. <br><br>  Portanto, a t√©cnica de estudar a ‚Äúcaixa preta‚Äù √© adotada - alimentamos v√°rios fragmentos de c√≥digo e consideramos o assembler gerado.  Infelizmente, n√£o √© poss√≠vel usar o site godbolt favorito para a arquitetura familiar do AVR, pois n√£o h√° biblioteca em estudo nesta implementa√ß√£o.  Obviamente, voc√™ pode arrast√°-lo com canetas, mas n√£o h√° garantia de que seja o c√≥digo-fonte correto. <br><br>  Portanto, veremos uma arquitetura diferente.  O x51 n√£o √© apresentado para o compilador gcc, eu nunca gostei do x86, o ARM tem um montador n√£o muito conveniente (para uma pessoa) e compreens√≠vel, o MIPS √© muito espec√≠fico e n√£o √© muito comum, todos os tipos de SPARCs s√£o ainda piores (bem, bem, eu n√£o vou ofender ningu√©m com sua arquitetura favorita, n√£o √© melhor), mas existe um √≥timo candidato MSP430, que foi baseado na arquitetura cristalina e elegante do PDP e da TI e n√£o o estragou muito (embora os caras tenham tentado).  Uma biblioteca de muitos bits para essa arquitetura √© apresentada, para que voc√™ possa come√ßar a estudar. <br><br>  Vamos come√ßar, pois n√£o parece trivial, desde o in√≠cio, isto √©, com o an√∫ncio da multid√£o.  Imediatamente veremos que a mem√≥ria para armazenamento √© alocada em palavras de quatro bytes, apesar do fato de a unidade natural nessa arquitetura ser uma palavra de dois bytes, e √© fornecido um trabalho bastante conveniente e eficiente com bytes, o que leva a incidentes estranhos.  Voc√™ pode entender o autor, a implementa√ß√£o de um n√∫mero de 32 bits deve estar em toda parte e depender dele com bastante naturalidade, mas nesse caso, 8 bits seria prefer√≠vel e, para o AVR, 8 bits seria a √∫nica solu√ß√£o razo√°vel. <br><br>  Uma pergunta interessante, mas como voc√™ pode determinar a profundidade de bits da arquitetura durante o processo de compila√ß√£o, ser√° necess√°rio experimentar uint8_t_fast.  Observamos uma poss√≠vel otimiza√ß√£o e seguimos em frente. <br><br>  Al√©m de alocar mem√≥ria, a inicializa√ß√£o √© de interesse - para conjuntos globais √© feita da maneira padr√£o - zerando antes de chamar main, para conjuntos locais tamb√©m √© feita da maneira padr√£o, ou seja, de maneira alguma se o valor inicial n√£o for especificado explicitamente.  Bem, e, como sempre, se √© poss√≠vel descrever um conjunto est√°tico com um valor inicial fora da fun√ß√£o, isso deve ser usado para n√£o ativar sinalizadores desnecess√°rios e n√£o gastar tempo de execu√ß√£o com eles.  Mas aqui n√£o esper√°vamos revela√ß√µes, apenas chec√°vamos as regras gerais. <br><br>  Vamos come√ßar a modificar o conjunto, para o qual deixamos colchetes e os m√©todos set e reset.  Podemos esperar algo assim para definir o elemento n no conjunto M: <br><br><pre><code class="cpp hljs">M[n / w] |= (<span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;(n % w))</code> </pre> <br>  onde w √© o n√∫mero de bits no elemento base que, para uma determinada arquitetura, √© definido estaticamente n (por exemplo, 4) e a otimiza√ß√£o inclu√≠da leva a um c√≥digo no formato: <br><br><pre> <code class="cpp hljs">bis.w #<span class="hljs-number"><span class="hljs-number">0x0010</span></span>, m</code> </pre> <br>  De fato, vemos esse c√≥digo na metade direita da janela e √© improv√°vel que algu√©m arrisque seriamente afirmar que uma solu√ß√£o mais eficaz √© poss√≠vel.  Mas isso √© apenas para as condi√ß√µes indicadas, para um cen√°rio arbitr√°rio em que a imagem muda completamente, para m√©todos que observamos a valida√ß√£o do argumento de admissibilidade com a gera√ß√£o da exce√ß√£o correspondente e para os colchetes vemos a restri√ß√£o do argumento com uma m√°scara de bits da faixa permitida com comportamento indefinido completamente previs√≠vel, ambos os casos s√£o bastante consistentes com a documenta√ß√£o.  Os valores negativos s√£o processados ‚Äã‚Äãcorretamente, pois os √≠ndices s√£o considerados como n√∫meros n√£o assinados. <br><br>  Chamamos aten√ß√£o para o fato de que o valor atribu√≠do a um elemento de um conjunto pode ser n√£o apenas 0 e 1, como seria de esperar, mas tamb√©m qualquer n√∫mero inteiro ao qual a regra ‚ÄúO que √© unidade?  Diferente de zero ‚Äù, √© bastante l√≥gico, mas pouco refletido na documenta√ß√£o.  Um pouco estranho, mas os valores booleanos seriam mais naturais, marcariam e seguiriam em frente. <br><br>  A compara√ß√£o do c√≥digo gerado para o caso de um n√∫mero de elemento estaticamente indeterminado do conjunto mostra que a efici√™ncia do c√≥digo em ambos os casos ([] e m√©todos) √© muito pr√≥xima e pequena, j√° que uma sub-rotina da biblioteca padr√£o √© chamada para calcular (1 &lt;&lt; n), e essa sub-rotina muda. N√∫mero de 32 bits 0x00000001, colocado em dois registros.  N√£o podemos ver o texto fonte, mas o pr√≥prio fato da liga√ß√£o leva a pensamentos tristes.  O fato √© que, na arquitetura em quest√£o, n√£o h√° deslocamento para a esquerda (e tamb√©m n√£o h√° direito) por um n√∫mero arbitr√°rio de posi√ß√µes, como em todos os (muitos) ARMs amados.  H√° uma mudan√ßa em 1 posi√ß√£o (seria estranho se n√£o existisse), h√° uma mudan√ßa em 2,3,4 posi√ß√µes (mas por um n√∫mero estritamente fixado no comando, n√£o por um par√¢metro), h√° um prefixo REPT (mas sua velocidade de execu√ß√£o deixa desejar o melhor).  Voc√™ pode implementar o deslocamento da unidade menor (isso √© importante, apenas uma unidade), ou seja, obter uma m√°scara de bits pelo n√∫mero de bits em um tempo relativamente curto, atrav√©s de truques como a troca de tetradas, mas essa ser√° uma parte muito dependente e, em geral, √© melhor n√£o fazer isso. <br><br>  Portanto, um m√©todo universal e r√°pido seria armazenar m√°scaras de bits em uma matriz e √≠ndice, e nessa arquitetura tamb√©m √© muito eficiente, o c√≥digo fica assim: <br><br><pre> <code class="cpp hljs">M[n/w] |= BitArray[n %w]</code> </pre> <br>  ficando montador como: <br><br><pre> <code class="cpp hljs"> bis.<span class="hljs-function"><span class="hljs-function">b </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BitArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r0)</span></span></span><span class="hljs-function">,</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">M</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r1)</span></span></span></span></code> </pre> <br>  Como estamos falando de padr√µes ew √© m√∫ltiplo do tamanho de um byte, as opera√ß√µes de divis√£o s√£o implementadas com muita efici√™ncia aqui.  Observamos a clara vantagem de um elemento de armazenamento minimamente implementado: para um byte, uma matriz de 8 bytes √© necess√°ria para um byte, -2 * 16 = 32 bytes para organiza√ß√£o de palavras e 4 * 32 = 128 bytes para uma palavra longa de 32 bits para armazenar todo o necess√°rio m√°scaras, por que pagar mais se o resultado n√£o mudar.  Vamos lembrar mais uma otimiza√ß√£o poss√≠vel e seguir em frente. <br><br>  Observamos mais um fato - implementa√ß√µes muito mais eficientes de opera√ß√µes com um elemento definido s√£o poss√≠veis se a arquitetura de destino tiver uma regi√£o de mem√≥ria marcada por bits (aqui, novamente, o ARM rejeitado anteriormente √© lembrado), onde a opera√ß√£o de instala√ß√£o do elemento geralmente se transforma em um BitSetAddr [n] = ab√≥bora 1, que se traduz em um √∫nico comando assembler para a constante n, mas j√° existem mudan√ßas efetivas suficientes l√°, de modo que essa otimiza√ß√£o seria mais redundante, principalmente levando em conta suas limita√ß√µes.  Em princ√≠pio, existe uma √°rea de endere√ßamento de bits semelhante no x51 e no AVR, mas existem comandos eficazes apenas para n√∫meros constantes de elementos e, no caso geral, nem tudo √© t√£o bom (francamente ruim). <br><br>  Bem, agora d√™ uma olhada no c√≥digo resultante e observe que observamos artefatos associados ao armazenamento do conjunto em palavras duplas.  O compilador para a opera√ß√£o de modificar um elemento de um conjunto gera uma sequ√™ncia de comandos que l√™ a palavra dupla correspondente da mem√≥ria em 2 registros (lembro que temos registros de 16 bits), modifica-os e envia os resultados de volta √† mem√≥ria.  Se alterarmos apenas um elemento, a m√°scara de opera√ß√£o conter√° exatamente uma unidade dentre 32 poss√≠veis, os zeros restantes.  Quando aplicamos um n√∫mero de elemento definido estaticamente, as opera√ß√µes que n√£o alteram o resultado devem ser exclu√≠das no est√°gio de otimiza√ß√£o.  Como regra, isso acontece, mas para v√°rios operandos algo d√° errado e os artefatos do formul√°rio vazam para o c√≥digo final: <br><br><pre> <code class="cpp hljs">bic #<span class="hljs-number"><span class="hljs-number">0</span></span>,r0</code> </pre> <br>  o que parece especialmente engra√ßado se voc√™ notar que o registro n√£o √© gravado de volta na mem√≥ria, embora seja lido.  Estritamente falando, os resultados das otimiza√ß√µes n√£o s√£o regulados em nenhum lugar; portanto, podem ser qualquer coisa e n√£o h√° nada para se ofender, mas, de qualquer forma, "n√£o √© legal como funciona".  N√£o podemos influenciar diretamente esse processo, se n√£o considerarmos seriamente o c√≥digo-fonte do compilador, ent√£o vamos ignor√°-lo - ajudaremos o otimizador simplificando sua tarefa. <br><br>  A prop√≥sito, ainda n√£o consigo encontrar a resposta para a pergunta - √© poss√≠vel em C ++ no n√≠vel de macro ou modelo definir uma implementa√ß√£o diferente para definida estaticamente no est√°gio de compila√ß√£o em rela√ß√£o a um par√¢metro estaticamente indefinido.  Se algu√©m conhece o caminho do samurai, diga-me nos coment√°rios, tentei o constexpr, n√£o funcionou. <br><br>  Continuamos nossa pesquisa e descobrimos que o compilador est√° otimizando incontrolavelmente as chamadas para o conjunto (√© claro, se a otimiza√ß√£o estiver ativada), ou seja, a ordem de instala√ß√£o / limpeza de v√°rios elementos n√£o √© totalmente garantida e n√£o est√° conectada √† ordem dos operadores de c√≥digo-fonte.  Mas n√£o consegui criar um conjunto vol√°til, talvez esteja fazendo algo errado?  Como no caso de qualquer otimiza√ß√£o local, a chamada para uma fun√ß√£o externa for√ßa o compilador a for√ßar todas as opera√ß√µes preparadas para a matriz global, mas essa √© uma solu√ß√£o muito forte e n√£o ajuda nas locais.  Bem, provavelmente n√£o h√° nada a ser feito, e voc√™ s√≥ precisa levar em considera√ß√£o um recurso semelhante e n√£o usar conjuntos para transferir informa√ß√µes entre fluxos usando interfaces seriais (ou seja, seus equivalentes de software). <br><br>  Uma conclus√£o geral pode ser feita: o uso de bitset em sua forma atual para arquiteturas com recursos limitados n√£o pode ser recomendado devido a custos excessivos na mem√≥ria e no tempo de execu√ß√£o.  Uma poss√≠vel modifica√ß√£o, que leva em considera√ß√£o todos os dados no texto do coment√°rio, est√° no Github, todos podem us√°-lo.  A hist√≥ria da cria√ß√£o deste mod ser√° publicada em breve em Habr√©, houve momentos engra√ßados. <br><br>  Em conclus√£o, uma pequena observa√ß√£o - a implementa√ß√£o do data warehouse "frontal", mesmo na vers√£o otimizada do conjunto, exigir√° N / 8 bytes de mem√≥ria de dados (para 128 comutadores, 16 bytes ser√£o necess√°rios) e, embora as opera√ß√µes exijam tempo O (1), o multiplicador ser√° muitas unidades ( e at√© 10 ou mais) ciclos de MK.  Portanto, levando em considera√ß√£o os requisitos do problema e introduzindo certas restri√ß√µes, podemos oferecer uma implementa√ß√£o alternativa de armazenamento de dados. <br><br>  Se acreditarmos que n√£o √© poss√≠vel fechar mais de um comutador a qualquer momento (ignoramos todos os outros at√© que o bot√£o pressionado no momento seja aberto), podemos ignorar um byte (desde que n√£o haja mais que 256 comutadores) e a escrita / leitura levar√° O (1) ciclos do processador, e o multiplicador ser√° bastante modesto. <br><br>  Essa abordagem √© f√°cil de expandir e armazenar informa√ß√µes sobre n switches fechados simultaneamente, mas voc√™ n√£o deve tornar n muito grande, pois a quantidade necess√°ria de mem√≥ria aumenta e o tempo para executar opera√ß√µes de invers√£o aumenta linearmente com um aumento no n√∫mero de elementos no conjunto, embora permane√ßa O (1) por em rela√ß√£o ao n√∫mero de comutadores.  O aumento de tempo indicado pode ser reduzido significativamente usando a implementa√ß√£o triangular da √°rvore bin√°ria para O (loq2 (n)), mas para n pequeno, isso n√£o √© t√£o importante.  Sim, e √© duvidoso que a complexidade do c√°lculo do pr√≥ximo √≠ndice durante a pesquisa compense a diminui√ß√£o no n√∫mero de itera√ß√µes simples.  As desvantagens dessa implementa√ß√£o incluem uma poss√≠vel falha no registro do elemento do conjunto, que deve ser processado no programa de chamada (rejeitamos a op√ß√£o com um tamanho de buffer vari√°vel imediatamente e com indigna√ß√£o - isso n√£o √© para solu√ß√µes internas). <br><br>  A implementa√ß√£o desta abordagem ser√° dada l√°. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447688/">https://habr.com/ru/post/pt447688/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447678/index.html">O conceito de uma breve enciclop√©dia</a></li>
<li><a href="../pt447680/index.html">Exerc√≠cios de emula√ß√£o: manual do Xbox 360 FMA</a></li>
<li><a href="../pt447682/index.html">Data Center Espacial: 24 horas antes do lan√ßamento</a></li>
<li><a href="../pt447684/index.html">Como mostrar os valores da empresa em um escrit√≥rio (sem p√¥steres e slogans)</a></li>
<li><a href="../pt447686/index.html">Um par√¢metro muito importante das l√¢mpadas LED, que poucas pessoas conhecem</a></li>
<li><a href="../pt447690/index.html">Configura√ß√£o compil√°vel de um sistema distribu√≠do</a></li>
<li><a href="../pt447694/index.html">Configura√ß√£o do sistema distribu√≠do compilado</a></li>
<li><a href="../pt447696/index.html">Por que as cidades se op√µem ao Amazon Go, as primeiras lojas que n√£o s√£o de caixa</a></li>
<li><a href="../pt447698/index.html">Red Hogwarts: acad√™mico sem diploma</a></li>
<li><a href="../pt447700/index.html">A flexibilidade emocional √© a chave para o crescimento pessoal.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>