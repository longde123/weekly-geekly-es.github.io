<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïî üõåüèº üîÅ Do iniciante ao estilo √≠cones: como fizemos pr√™mios em 2GIS ü§¥üèø ‚ôéÔ∏è üë®‚Äçüëß</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Todos os dias, os usu√°rios do 2GIS nos ajudam a manter a precis√£o dos dados: eles informam sobre novas empresas, adicionam eventos de tr√°fego, enviam ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Do iniciante ao estilo √≠cones: como fizemos pr√™mios em 2GIS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/470942/"><img src="https://habrastorage.org/webt/kl/9g/ja/kl9gjaqo9dmcbsimconigs2pnxo.png"><br><br>  Todos os dias, os usu√°rios do 2GIS nos ajudam a manter a precis√£o dos dados: eles informam sobre novas empresas, adicionam eventos de tr√°fego, enviam fotos e escrevem cr√≠ticas.  Anteriormente, s√≥ pod√≠amos agradec√™-los com palavras ou organizar uma oferta.  Mas, com o tempo, as palavras s√£o esquecidas e nem todos recebem presentes.  Portanto, decidimos garantir que todos aqueles que se preocupam com o 2GIS vejam sua contribui√ß√£o para o produto e nossa gratid√£o por isso. <br><br>  Portanto, houve pr√™mios - medalhas virtuais que acumulamos para v√°rios tipos de tarefas: fazer upload de fotos em cart√µes de caf√©, escrever resenhas sobre teatros, especificar o hor√°rio de trabalho das organiza√ß√µes e assim por diante.  Os usu√°rios veem as recompensas recebidas em seu perfil 2GIS pessoal e na guia "My 2GIS" no aplicativo m√≥vel.  Aqui, mostramos quanto resta at√© a pr√≥xima conquista. <br><br>  Para implementar esse recurso, aprendemos como processar um fluxo de eventos com um volume de 500 mil registros por hora (em locais de at√© 50 mil registros por segundo) e analisar dados de v√°rios servi√ßos.  E tamb√©m - eles adicionaram um pouco de metaprograma√ß√£o para simplificar a configura√ß√£o ao desenvolver novos pr√™mios. <br><br>  Juntamente com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Rapter</a> , informaremos o que est√° por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">tr√°s</a> do processo de premia√ß√£o. <br><a name="habracut"></a><br><h2>  Conceito </h2><br>  Para entender a complexidade do recurso, voc√™ precisa entender como o problema t√©cnico soou.  Ent√£o - considere a id√©ia de implementa√ß√£o e o esquema geral dos componentes do sistema.  √â isso que faremos nesta se√ß√£o. <br><br><h3>  Requisitos para Resumos </h3><br>  Requisitos - uma coisa bastante chata, para n√£o pintarmos todas as nuances, vamos nos concentrar nas coisas mais importantes: <br><br><ul><li>  os pr√™mios s√£o emitidos apenas para usu√°rios autorizados; </li><li>  atualizar o progresso de uma recompensa deve ser o mais r√°pido poss√≠vel; </li><li>  recompensa - o resultado de um usu√°rio executar um conjunto de a√ß√µes no produto: fazer upload de uma foto, escrever uma cr√≠tica, encontrar instru√ß√µes etc. etc. Existem muitas fontes de dados. </li></ul><br><h3>  Ideia arquitet√¥nica </h3><br>  A ideia de implementa√ß√£o n√£o √© muito complicada.  Pode ser expresso tese: <br><br><ul><li>  o pr√™mio consiste em tarefas cujos resultados s√£o combinados de acordo com a f√≥rmula especificada na configura√ß√£o do pr√™mio; </li><li>  a tarefa responde a eventos sobre a√ß√µes do usu√°rio vindas de fora, os filtra e registra a altera√ß√£o em andamento na forma de contadores; </li><li>  ‚ÄúEventos externos‚Äù s√£o gerados por sistemas mestre (foto, feedback, servi√ßos de aprimoramento etc.) ou servi√ßos auxiliares que transformam ou filtram os fluxos de eventos j√° existentes; </li><li>  o processamento de eventos ocorre de forma ass√≠ncrona e pode ser interrompido a qualquer momento, se necess√°rio; </li><li>  o usu√°rio v√™ o status atual de seus pr√™mios; </li><li>  tudo o resto s√£o os detalhes ... </li></ul><br><h3>  Entidades-chave </h3><br>  O diagrama abaixo mostra as principais entidades da √°rea de assunto e seu relacionamento: <br><br><img src="https://habrastorage.org/webt/vi/ya/59/viya59qa7bnnad3hogutbunyds4.png"><br><br>  Duas zonas s√£o distinguidas no diagrama: <br><br><ul><li>  Esquema - uma zona para descrever a estrutura dos pr√™mios e as regras para seu ac√∫mulo; </li><li>  Dados - √°rea de premia√ß√£o para usu√°rios espec√≠ficos e dados relacionados ao seu status atual. </li></ul><br>  As entidades no diagrama: <br><br><ul><li>  Alcan√ßar - informa√ß√µes sobre o pr√™mio que pode ser obtido.  Inclui meta-informa√ß√µes e uma descri√ß√£o de como combinar os resultados das tarefas - uma estrat√©gia. </li><li>  Objetivo - uma tarefa cujas condi√ß√µes devem ser cumpridas para avan√ßar no recebimento de um pr√™mio. </li><li>  UserAchieve - o estado atual da recompensa para um usu√°rio espec√≠fico. </li><li>  UserObjective - o estado atual do trabalho de recompensa do usu√°rio. </li><li>  Usu√°rio - informa√ß√µes sobre o usu√°rio, necess√°rias para notifica√ß√µes e entendimento de seu status atual (recompensas remotas e banidas n√£o s√£o necess√°rias). </li><li>  ProcessingLog - um log de acumula√ß√µes para tarefas.  Cont√©m informa√ß√µes sobre como uma a√ß√£o espec√≠fica influenciou o progresso da tarefa. </li><li>  Evento - a informa√ß√£o m√≠nima necess√°ria sobre um evento que de alguma forma influenciou o progresso das tarefas do usu√°rio. </li></ul><br><h3>  Estrutura de servi√ßo </h3><br>  Agora considere os principais componentes do servi√ßo e suas depend√™ncias: <br><br><img src="https://habrastorage.org/webt/qi/dp/k_/qidpk_jo7rqnh2x5dywk0sg0ij4.png"><br><br><ul><li>  Barramento de Eventos - um barramento de eventos que pode ser usado para concluir tarefas.  Estamos usando o Apache Kafka. </li><li>  Os bancos de dados mestre e escravo s√£o o principal data warehouse.  Nesse caso, um cluster do PostgreSQL. </li><li>  ConsumingWorkers - manipuladores de eventos de barramento.  A principal tarefa √© ler eventos de uma fonte espec√≠fica (fotos, cr√≠ticas etc.), aplic√°-los √†s tarefas do usu√°rio e salvar o resultado. </li><li>  AchievesWorker - relata o progresso nas recompensas do usu√°rio de acordo com o status das tarefas. </li><li>  NotificationWorkers - um conjunto de manipuladores para agendar e enviar notifica√ß√µes sobre o recebimento de pr√™mios, an√∫ncios de novas conquistas poss√≠veis etc. </li><li>  API p√∫blica - uma interface REST p√∫blica para aplicativos da Web e m√≥veis. </li><li>  API privada - interface REST para o painel de administra√ß√£o, que ajuda na investiga√ß√£o de incidentes e no suporte a servi√ßos.  Est√° dispon√≠vel para desenvolvedores e equipes de suporte. </li></ul><br>  Cada um dos componentes √© isolado em termos de l√≥gica e √°reas de responsabilidade, o que evita integra√ß√µes e impasses desnecess√°rios ao modificar dados.  Abaixo, consideramos apenas parte do esquema associado ao processamento de eventos e √† convers√£o deles em recompensas. <br><br><h2>  Manipula√ß√£o de eventos </h2><br><h3>  Conte√∫do </h3><br>  As recompensas s√£o principalmente um servi√ßo de agrega√ß√£o de dados.  Cada sistema mestre gera v√°rios tipos de eventos.  Como regra, cada tipo de evento est√° intimamente relacionado ao estado do conte√∫do, seu modelo de status.  Assim, uma foto pode ser moderada, exclu√≠da, bloqueada, oculta ou ativa.  Todos esses eventos s√£o tratados por um trabalhador separado, especializado em uma fonte espec√≠fica.  No momento, h√° uma intera√ß√£o com as seguintes fontes (sistemas mestre): <br><br><ul><li>  Foto - gera v√°rios eventos relacionados √†s opera√ß√µes executadas pelos usu√°rios nas fotografias. </li><li>  Revis√µes - eventos relacionados a opera√ß√µes nas revis√µes de usu√°rios. </li><li>  Datafeedback - eventos relacionados a opera√ß√µes de refinamento.  Esclarecimento √© uma altera√ß√£o nas informa√ß√µes sobre um objeto em um mapa, seja uma empresa ou um monumento. </li><li>  Cheque - eventos relacionados ao aplicativo 2GIS Check. </li><li>  BSS s√£o eventos de an√°lise que geram aplicativos 2GIS.  Por exemplo, a abertura de uma determinada empresa, viagens no navegador etc. </li></ul><br><img src="https://habrastorage.org/webt/vg/xy/zb/vgxyzbizbytl_up3fllx5epasue.png"><br><br>  Os eventos gerados pelo sistema mestre se enquadram no t√≥pico Kafka na ordem de altera√ß√£o de status, o que torna poss√≠vel avan√ßar o progresso do pr√™mio para o usu√°rio n√£o apenas para a frente, mas tamb√©m para revert√™-lo.  Por exemplo, se a foto estava no status "ativo" e, por algum motivo, adquiriu o status de "bloqueado", o progresso no pr√™mio deve mudar para baixo.  O progresso do pr√™mio √© uma interpreta√ß√£o de objetos internos chamados contadores de conte√∫do. <br><br>  Os contadores podem variar para dados diferentes.  Por exemplo, para eventos sobre a foto, s√£o os seguintes: o n√∫mero de aprovados, o n√∫mero com modera√ß√£o, o n√∫mero de bloqueados e para eventos de cart√µes de abertura, √© necess√°rio considerar apenas o n√∫mero de cart√µes abertos pelo usu√°rio.  Com base nos valores atuais dos contadores de conte√∫do, para um usu√°rio espec√≠fico, dentro da estrutura de um pr√™mio espec√≠fico, s√£o determinadas as respostas para as seguintes perguntas: <br><br><ul><li>  O pr√™mio come√ßou? </li><li>  qual √© o progresso </li><li>  A recompensa est√° totalmente conclu√≠da? </li></ul><br><h3>  Filtros e regras </h3><br>  Os contadores de tarefas de um pr√™mio espec√≠fico s√£o alterados apenas se um evento chegar com o tipo de conte√∫do desejado, bem como com os dados necess√°rios para receber o pr√™mio. <br><br>  Para ignorar apenas o conte√∫do adequado ao pr√™mio, realizamos cada evento por meio de uma s√©rie de filtros e regras. <br><br>  Um filtro √© uma certa restri√ß√£o imposta ao conte√∫do.  Ele s√≥ se preocupa em responder √† pergunta: "Um novo evento se encaixa nessa condi√ß√£o ou n√£o?" <br>  Uma regra √© um filtro especial, cujo objetivo √© dizer: "Se um evento se encaixa na condi√ß√£o, como os contadores devem mudar?"  A regra inclui um algoritmo para alterar contadores.  Cada pr√™mio cont√©m apenas uma regra. <br><br>  A implementa√ß√£o de filtros e regras est√° no c√≥digo do projeto e a descri√ß√£o de quais filtros (regra) pertencem a um pr√™mio espec√≠fico est√° no banco de dados no formato JSON.  N√£o chegamos a essa decis√£o imediatamente.  Inicialmente, n√£o era poss√≠vel definir filtros e regras usando a configura√ß√£o por meio do banco de dados, o pr√™mio foi totalmente descrito no c√≥digo, apenas seu identificador foi armazenado na tabela.  Esta decis√£o deu uma s√©rie de desvantagens significativas: <br><br><ul><li>  O problema de suportar v√°rios ambientes.  Se voc√™ deseja implementar um estado da lista de pr√™mios no ambiente de teste e enviar outro para a batalha, ser√° necess√°rio conhecer o ambiente no c√≥digo do projeto ou ter um arquivo de configura√ß√£o com a lista de pr√™mios.  Ao mesmo tempo, n√£o √© poss√≠vel usar bancos de dados diferentes para esta tarefa, embora eles j√° existam para cada ambiente. </li><li>  Capacidade de configurar a filtragem apenas pelo desenvolvedor.  Como tudo est√° descrito no c√≥digo, apenas uma pessoa que conhece o projeto e a linguagem de programa√ß√£o pode fazer altera√ß√µes, gostaria que fosse poss√≠vel fazer isso simplesmente atrav√©s da API ou banco de dados privados. </li><li>  A desvantagem da visualiza√ß√£o.  Existem muitas recompensas, √†s vezes voc√™ precisa ver os filtros que eles usam.  Cada vez, fazer isso olhando o c√≥digo √© bastante entediante. </li></ul><br>  No in√≠cio do aplicativo, correspondemos pelo nome dos filtros carregados do banco de dados e os colocamos em uma recompensa espec√≠fica.  Exemplo de descri√ß√£o do filtro: <br><br><pre><code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>:<span class="hljs-string"><span class="hljs-string">"SourceFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"sources"</span></span>:[<span class="hljs-string"><span class="hljs-string">"reviews"</span></span>] } }, { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewsLengthFilter"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"allowed_length"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> } } ]</code> </pre> <br>  Nesse caso, faremos apenas essas revis√µes (isso √© indicado pelo primeiro objeto de descri√ß√£o da matriz de filtros), cujo texto cont√©m mais de 100 caracteres (o segundo filtro na lista). <br><br>  Descri√ß√£o da regra de exemplo: <br><br><pre> <code class="json hljs">{<span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"ReviewUniqueByObjectRule"</span></span>,<span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:{}}</code> </pre><br>  Esta regra permitir√° que voc√™ altere os contadores apenas se o usu√°rio tiver escrito uma revis√£o para o objeto, enquanto apenas uma revis√£o ser√° levada em considera√ß√£o para um objeto. <br><br><h3>  Bss </h3><br>  Vamos nos concentrar separadamente no trabalho com o fluxo de eventos do BSS.  H√° pelo menos tr√™s raz√µes para isso: <br><br><ul><li>  Os eventos de an√°lise n√£o podem ser revertidos, n√£o h√° um modelo de status neles, o que, em geral, √© l√≥gico, pois dirigir por um navegador ou criar uma rota n√£o pode ser cancelado.  A a√ß√£o estava l√° ou n√£o. </li><li>  Volumes.  Deixe-me lembr√°-lo de que o p√∫blico total de 2GIS √© de mais de 50 milh√µes de usu√°rios por m√™s.  Juntos, eles fazem mais de 1,5 bilh√£o de consultas de pesquisa, al√©m de muitas outras a√ß√µes: iniciar o aplicativo, visualizar o cart√£o do objeto etc. No pico, o n√∫mero de eventos pode chegar a 50.000 por segundo.  Devemos passar todas essas informa√ß√µes atrav√©s de filtros, a fim de recompensar o usu√°rio. </li><li>  Os eventos do Analytics t√™m recursos: v√°rios formatos, uma grande variedade de tipos. </li></ul><br>  Tudo isso influenciou bastante o processamento de dados do t√≥pico BSS, pois se precisamos de tempo real, precisamos de um tempo de processamento muito pr√≥ximo. <br><br>  Para reduzir as diferen√ßas descritas, foi criado um servi√ßo separado que prepara esses eventos.  O servi√ßo pode trabalhar com toda a variedade de formatos de mensagens provenientes da an√°lise.  A ess√™ncia de seu trabalho √© a seguinte: todo o fluxo de eventos do BSS √© lido, do qual apenas os necess√°rios para os pr√™mios s√£o retirados.  Esse filtro de servi√ßo reduz significativamente a carga (ap√≥s a filtragem, a taxa de fluxo √© de ~ 300 eventos por segundo) do Rewards do processador de fluxo BSS e tamb√©m gera eventos em um √∫nico formato, nivelando a desvantagem associada ao hist√≥rico da an√°lise interna. <br><br><h2>  Pr√©mios </h2><br>  Ent√£o, descobrimos como lidar com eventos e calcular o progresso nas atribui√ß√µes.  Agora √© hora de dar uma olhada no processo de emiss√£o de recompensas para os usu√°rios. <br><br>  A primeira pergunta que surge √©: por que alocar a sa√≠da para um trabalhador separado, ela n√£o pode ser recontada ao processar cada evento?  Resposta: poss√≠vel, mas n√£o vale a pena. <br><br>  H√° v√°rios motivos para alocar extradi√ß√£o para um processo separado: <br><br><ol><li>  Transferindo a recontagem para cada ConsumingWorker, obtemos a Condi√ß√£o de Corrida para a opera√ß√£o de atualiza√ß√£o do progresso por recompensa, porque cada manipulador tentar√° atualizar o progresso com base no estado conhecido das tarefas, e outros mudar√£o ativamente esse estado. </li><li>  Cada lote do ConsumingWorker processa eventos do Kafka em uma transa√ß√£o.  Ao adicionar uma inser√ß√£o √† tabela de recompensas do usu√°rio, chamaremos bloqueios extras no n√≠vel do banco de dados, o que inibir√° outros manipuladores. </li><li>  No processo de emiss√£o de pr√™mios, existe uma l√≥gica para o envio de notifica√ß√µes, o que desacelerar√° o processamento do fluxo de eventos, o que √© indesej√°vel. </li></ol><br>  As raz√µes para o surgimento de um AchievesWorker separado (manipulador para emitir pr√™mios) foram resolvidas.  Agora voc√™ precisa lidar com duas partes importantes do processamento: <br><br><ol><li>  H√° um conjunto de miss√µes na recompensa.  H√° um conjunto de contadores para essas tarefas.  Como entender o quanto o pr√™mio √© concedido e como express√°-lo em c√≥digo? <br>  Exemplo: voc√™ precisa escrever 3 revis√µes ou fazer upload de 3 fotos.  O usu√°rio possui 1 avalia√ß√£o e 2 fotos.  Qual √© o progresso do pr√™mio?  Resposta: 3, porque o usu√°rio definitivamente ter√° certeza de que voc√™ precisa de 3 no total. </li><li>  Temos um manipulador separado para emitir pr√™mios.  A cada vez, √© improv√°vel que se reconhe√ßa v√°rias dezenas de pr√™mios para cada usu√°rio autorizado, ou seja, v√°rias dezenas de milh√µes, com √™xito r√°pido.  Como ele pode aprender sobre o progresso de quais usu√°rios espec√≠ficos e quais tarefas foram alteradas desde o √∫ltimo processamento? </li></ol><br>  Vamos considerar cada parte separadamente. <br><br><h3>  Fluxo de progresso </h3><br>  Para uma melhor compreens√£o de como voc√™ pode descrever como transformar o progresso das tarefas em progresso por recompensa, dividimos as recompensas em categorias e analisamos as transforma√ß√µes. <br><br>  <b>"Conclua uma tarefa por X unidades."</b>  Exemplo: Dirija 10 km no navegador. <br><br><img src="https://habrastorage.org/webt/vv/qu/x5/vvqux5yb09uehrul3dkd3mux3wm.png"><br><br>  <b>"Conclua v√°rias tarefas para X unidades cada."</b>  Exemplo: fa√ßa upload de 5 fotos e escreva 5 resenhas em cart√µes - apenas 10 unidades de conte√∫do. <br><br><img src="https://habrastorage.org/webt/fe/n8/oc/fen8oc0kbm372ozvyvr3a7fj8jo.png"><br><br>  <b>"Conclua v√°rias tarefas para X unidades no total."</b>  Exemplo: escreva 5 coment√°rios ou fa√ßa upload de 5 fotos. <br><br><img src="https://habrastorage.org/webt/d-/ld/gd/d-ldgdazj8xt2eysdzqhgauaxgc.png"><br><br>  <b>"Conclua v√°rias tarefas agrupadas por tipo."</b>  Exemplo: fa√ßa upload de 5 unidades de conte√∫do (fotos ou cr√≠ticas) e dirija 10 km no navegador. <br><br><img src="https://habrastorage.org/webt/ue/c3/ck/uec3ckf33tcm4pjcfmtkfbmv9eq.png"><br><br>  Teoricamente, poderia haver combina√ß√µes aninhadas mais complexas.  No entanto, em condi√ß√µes reais, n√£o √© poss√≠vel explicar ao usu√°rio em duas ou tr√™s frases a combina√ß√£o l√≥gica complexa que deve ser realizada para receber o pr√™mio.  Portanto, na maioria dos casos, essas op√ß√µes s√£o suficientes. <br><br>  Chamamos o m√©todo de convers√£o de estrat√©gia e tentamos torn√°-lo mais ou menos universal, elaborando uma descri√ß√£o formal na forma de um objeto JSON.  Voc√™ poderia, √© claro, pensar em escrever na forma de uma f√≥rmula, mas ent√£o voc√™ teria que usar as semelhan√ßas de eval ou descrever a gram√°tica e implement√°-la, e isso √© claramente uma complica√ß√£o excessiva.  Armazenar a estrat√©gia no c√≥digo-fonte para cada pr√™mio n√£o √© muito conveniente, porque a descri√ß√£o do pr√™mio (parte do banco de dados e parte do c√≥digo) ser√° rasgada e tamb√©m n√£o permitir√° a coleta de pr√™mios de componentes prontos no futuro sem a participa√ß√£o do desenvolvimento. <br><br>  A estrat√©gia √© apresentada na forma de uma √°rvore, em que cada n√≥: <br><br><ul><li>  Refere-se ao progresso atual da atribui√ß√£o ou √© um grupo de outros n√≥s. </li><li>  Pode ter uma restri√ß√£o m√°xima - na verdade, uma indica√ß√£o da necessidade de usar min (). </li><li>  Pode ter um coeficiente de normaliza√ß√£o.  Necess√°rio para convers√µes simples, multiplicando o resultado por um n√∫mero.  Viemos a calhar para converter metros em quil√¥metros. </li></ul><br>  Para descrever os exemplos acima, uma opera√ß√£o √© suficiente - soma.  A soma √© √≥tima para mostrar claramente o progresso do usu√°rio com um √∫nico n√∫mero, mas outras opera√ß√µes podem ser usadas, se desejado. <br><br>  Aqui est√° um exemplo de descri√ß√£o da estrat√©gia para a √∫ltima categoria: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"photo"</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"reviews"</span></span> } ] }, { <span class="hljs-attr"><span class="hljs-attr">"goal"</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"operation"</span></span>: <span class="hljs-string"><span class="hljs-string">"sum"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"strategy"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"objective_id"</span></span>: <span class="hljs-string"><span class="hljs-string">"navi"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"normalization_factor"</span></span>: <span class="hljs-number"><span class="hljs-number">0.001</span></span> } ] } ] }</code> </pre><br><h3>  Atualiza√ß√µes necess√°rias </h3><br>  Existem v√°rios manipuladores que analisam incansavelmente os eventos dos usu√°rios e aplicam altera√ß√µes ao andamento das tarefas.  Uma pesquisa regular de todos os usu√°rios com cada pr√™mio levar√° a uma an√°lise de v√°rias dezenas de milh√µes de pr√™mios - n√£o muito encorajador, desde que as atualiza√ß√µes reais sejam medidas em milhares.  Como aprender apenas sobre milhares e n√£o desperdi√ßar milh√µes de CPU? <br><br>  A id√©ia de como recalcular o progresso apenas nos pr√™mios que realmente mudaram veio rapidamente.  √â baseado no uso de rel√≥gios vetoriais. <br><br>  Antes da descri√ß√£o, lembrarei das entidades: <br><br><ul><li>  UserObjective - dados sobre o progresso do usu√°rio, definindo o pr√™mio. </li><li>  UserAchieve - recompensa dados de progresso do usu√°rio. </li></ul><br>  A implementa√ß√£o √© assim: <br><br><ul><li>  Obtemos o campo de vers√£o para UserObjective e UserAchieve e Sequence no PostgreSQL. </li><li>  Cada atualiza√ß√£o da entidade UserObjective altera sua vers√£o.  O valor √© retirado da sequ√™ncia (√© comum a todos os registros). </li><li>  O valor da vers√£o para UserAchieve ser√° determinado como o m√°ximo das vers√µes do UserObjective associado. </li><li>  Em cada ciclo de processamento, o AchievesWorker procura esse UserObjective para o qual n√£o h√° UserAchieve ou UserAchieve.version &lt;UserObjective.version.  O problema √© resolvido por uma √∫nica consulta no banco de dados. </li></ul><br>  Vale ressaltar que a solu√ß√£o tem limita√ß√µes no n√∫mero de entradas nas tabelas de pr√™mios e atribui√ß√µes, bem como na frequ√™ncia das altera√ß√µes em andamento nas atribui√ß√µes, mas com algumas dezenas de milh√µes de pr√™mios e o n√∫mero de atualiza√ß√µes inferiores a mil por minuto, √© poss√≠vel conviver com essa solu√ß√£o.  De alguma forma, contaremos separadamente como otimizamos a emiss√£o do concurso " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Agentes 2GIS</a> ". <br><br><h2>  Conclus√µes </h2><br>  Apesar do artigo ser bastante volumoso, muitas nuances permaneceram nos bastidores, uma vez que n√£o seria poss√≠vel falar brevemente sobre eles. <br><br>  Que conclus√µes tiramos gra√ßas aos pr√™mios: <br><br><ul><li>  O princ√≠pio de "dividir e conquistar", neste caso, jogou em nossas m√£os.  A aloca√ß√£o de manipuladores de eventos para cada fonte nos ajuda a dimensionar quando necess√°rio.  Seu trabalho √© isolado de acordo com os dados e se cruza apenas em pequenas √°reas.  Destacar a l√≥gica da recompensa permite reduzir a sobrecarga nos manipuladores de eventos. </li><li>  Se voc√™ precisar digerir muitos dados e o processamento for bastante caro, pense imediatamente em como filtrar o que definitivamente n√£o √© necess√°rio.  A experi√™ncia com a filtragem de um fluxo BSS √© um exemplo. </li><li>  Mais uma vez, est√°vamos convencidos de que a integra√ß√£o de servi√ßos por meio de um barramento de evento comum √© muito conveniente e permite evitar cargas desnecess√°rias em outros servi√ßos.  Se o servi√ßo Rewards recebesse dados dos servi√ßos Foto, Cr√≠ticas etc. por meio de solicita√ß√µes http, v√°rios servi√ßos teriam que ser preparados para uma carga adicional. </li><li>  Um pouco de metaprograma√ß√£o pode ajudar a manter a integridade da configura√ß√£o de dados e separar ambientes arbitrariamente.  O armazenamento de filtros, regras e estrat√©gias no banco de dados simplificou o processo de desenvolvimento e libera√ß√£o de novos pr√™mios. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt470942/">https://habr.com/ru/post/pt470942/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt470928/index.html">Pr√°ticas recomendadas para executar o Buildah dentro de um cont√™iner</a></li>
<li><a href="../pt470930/index.html">Gamifica√ß√£o do produto. Ratatype da hist√≥ria</a></li>
<li><a href="../pt470934/index.html">Cura antes do casamento: prolifera√ß√£o celular e habilidades regenerativas da √°gua-viva</a></li>
<li><a href="../pt470938/index.html">Como abrir um link em Python. Trabalhando com o WebBrowser e resolvendo um problema com o Internet Explorer</a></li>
<li><a href="../pt470940/index.html">MSK VUE.JS meetup # 3 no Mail.ru Group: materiais da mitap</a></li>
<li><a href="../pt470950/index.html">bear_hug: jogos em arte ASCII em Python3.6 +</a></li>
<li><a href="../pt470952/index.html">Dicas e truques para forense digital: aplicativo "Seu telefone" Forense</a></li>
<li><a href="../pt470954/index.html">Instale o Zimbra OSE 8.8.15 e o Zextras Suite Pro no Ubuntu 18.04 LTS</a></li>
<li><a href="../pt470958/index.html">Sondas de vida em Kubernetes podem ser perigosas</a></li>
<li><a href="../pt470962/index.html">JSConf Budapest 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>