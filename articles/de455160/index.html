<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèæ üå´Ô∏è üß° Entity Framework 6 mit Volltextsuche √ºber LINQ üíç ü¶Ö ü•õ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ich m√∂chte meine Kr√ºcke bei der L√∂sung eines eher banalen Problems teilen: Wie man mit Entity Framework eine Volltext-MSSQL-Suche f√ºr Freunde findet. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Entity Framework 6 mit Volltextsuche √ºber LINQ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455160/"><p>  Ich m√∂chte meine Kr√ºcke bei der L√∂sung eines eher banalen Problems teilen: Wie man mit Entity Framework eine Volltext-MSSQL-Suche f√ºr Freunde findet.  Das Thema ist sehr spezialisiert, aber es scheint mir heute relevant zu sein.  F√ºr Interessierte bitte ich um Katze. </p><a name="habracut"></a><br><h1 id="vse-nachalos-s-boli">  Alles begann mit Schmerzen </h1><br><p>  Ich entwickle Projekte in C # (ASP.NET) und schreibe manchmal Microservices.  In den meisten F√§llen verwende ich die MSSQL-Datenbank, um mit Daten zu arbeiten.  Entity Framework wird als Verbindung zwischen der Datenbank und meinem Projekt verwendet.  Mit EF habe ich reichlich Gelegenheit, mit Daten zu arbeiten, die richtigen Abfragen zu generieren und die Belastung des Servers zu regulieren.  Der magische LINQ-Mechanismus besticht durch seine F√§higkeiten.  Im Laufe der Jahre stelle ich mir keine schnelleren und bequemeren M√∂glichkeiten mehr vor, mit der Datenbank zu arbeiten.  Aber wie fast jedes ORM hat EF eine Reihe von Nachteilen.  Erstens ist dies Leistung, aber dies ist das Thema eines separaten Artikels.  Und zweitens werden die Funktionen der Datenbank selbst behandelt. </p><br><p> MSSQL verf√ºgt √ºber eine integrierte Volltextsuche, die sofort funktioniert.  Um Volltextabfragen durchzuf√ºhren, k√∂nnen Sie die integrierten Pr√§dikate (CONTAINS und FREETEXT) oder Funktionen (CONTAINSTABLE und FREETEXTTABLE) verwenden.  Es gibt nur ein Problem: EF unterst√ºtzt √ºberhaupt keine Volltextabfragen! </p><br><p>  Ich werde ein Beispiel aus der Praxis geben.  Angenommen, ich habe eine Artikeltabelle - Artikel, und ich erstelle eine Klasse daf√ºr, die diese Tabelle beschreibt: </p><br><pre><code class="plaintext hljs">/// c# public partial class Article { public int Id { get; set; } public System.DateTime Date { get; set; } public string Text { get; set; } public bool Active { get; set; } }</code> </pre> <br><p>  Dann muss ich eine Auswahl dieser Artikel treffen, beispielsweise die letzten 10 ver√∂ffentlichten Artikel ausgeben: </p><br><pre> <code class="plaintext hljs">/// c# dbEntities db = new dbEntities(); var articles = db.Article .Where(n =&gt; n.Active) .OrderByDescending(n =&gt; n.Date) .Take(10) .ToArray();</code> </pre> <br><p>  Alles ist sehr sch√∂n, bis die Aufgabe des Hinzuf√ºgens der Volltextsuche erscheint.  Da Volltextauswahlfunktionen in EF nicht unterst√ºtzt werden (.NET Core 2.1 verf√ºgt bereits teilweise <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dar√ºber</a> ), m√ºssen Sie entweder eine Bibliothek eines Drittanbieters verwenden oder eine Abfrage in reinem SQL schreiben. </p><br><p>  Die SQL-Abfrage aus dem obigen Beispiel ist nicht so kompliziert: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">10</span></span>) [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>], [Extent1].[Active] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Active] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Article] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> [Extent1].[Active] = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p>  In realen Projekten sind die Dinge nicht so einfach.  Abfragen an die Datenbank sind viel komplizierter und es ist schwierig, sie manuell zu verwalten.  Als ich zum ersten Mal eine Abfrage mit LINQ schrieb, bekam ich den generierten Text der SQL-Abfrage in die Datenbank und f√ºhrte bereits die Bedingungen f√ºr die Volltextdatenauswahl ein.  Dann schickte ich es an <code>db.Database.SqlQuery</code> und erhielt die Daten, die ich brauchte.  Das ist nat√ºrlich alles gut, solange die Anfrage nicht ein Dutzend verschiedener Filter mit komplexen Join-Us und Bedingungen aufh√§ngen muss. </p><br><p>  Also - ich habe einen bestimmten Schmerz.  Wir m√ºssen es l√∂sen! </p><br><h1 id="v-poiskah-resheniya">  Auf der Suche nach einer L√∂sung </h1><br><p>  Wieder einmal stie√ü ich bei meiner Lieblingssuche in der Hoffnung, zumindest eine L√∂sung zu finden, auf <a href="">dieses Repository</a> .  Mit dieser L√∂sung kann die Unterst√ºtzung von LINQ-Pr√§dikaten (CONTAINS und FREETEXT) implementiert werden.  Dank der Unterst√ºtzung von EF 6 der speziellen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>IDbCommandInterceptor</code></a> Schnittstelle, mit der Sie die fertige SQL-Abfrage abfangen k√∂nnen, wurde diese L√∂sung implementiert, bevor Sie sie an die Datenbank senden.  Eine speziell generierte Markierungszeichenfolge wird in das Feld " <code>Contains</code> eingef√ºgt. Nach dem Generieren der Anforderung wird diese Stelle durch ein Pr√§dikat ersetzt. Beispiel: </p><br><pre> <code class="plaintext hljs">/// c# var text = FullTextSearchModelUtil.Contains("code"); db.Tables.Where(c=&gt;c.Fullname.Contains(text));</code> </pre> <br><p>  Wenn die Datenauswahl jedoch nach dem Rang der √úbereinstimmungen sortiert werden muss, funktioniert diese L√∂sung nicht mehr und Sie m√ºssen die SQL-Abfrage manuell schreiben.  Im Wesentlichen ersetzt diese L√∂sung das √ºbliche LIKE durch eine Pr√§dikatauswahl. </p><br><p>  Zu diesem Zeitpunkt hatte ich also eine Frage: Ist es m√∂glich, eine echte Volltextsuche mit den integrierten MS SQL-Funktionen (CONTAINSTABLE und FREETEXTTABLE) zu implementieren, damit all dies √ºber LINQ und sogar mit Unterst√ºtzung f√ºr das Sortieren der Abfrage nach dem Rang der √úbereinstimmungen generiert werden kann?  Wie sich herausstellte, k√∂nnen Sie! </p><br><h1 id="realizaciya">  Implementierung </h1><br><p>  Zun√§chst musste die Logik zum Schreiben der Abfrage selbst mit LINQ entwickelt werden.  Da in realen SQL-Abfragen mit Volltextauswahl JOIN am h√§ufigsten zum Verkn√ºpfen einer virtuellen Tabelle mit R√§ngen verwendet wird, habe ich mich f√ºr den gleichen Weg in der LINQ-Abfrage entschieden. </p><br><p>  Hier ist ein Beispiel f√ºr eine solche LINQ-Abfrage: </p><br><pre> <code class="plaintext hljs">/// c# var queryFts = db.FTS_Int.Where(n =&gt; n.Query.Contains(queryText)); var query = db.Article .Join(queryFts, article =&gt; article.Id, fts =&gt; fts.Key, (article, fts) =&gt; new { article.Id, article.Text, fts.Key, fts.Rank, }) .OrderByDescending(n =&gt; n.Rank);</code> </pre> <br><p>  Ein solcher Code konnte noch nicht kompiliert werden, l√∂ste jedoch bereits visuell das Problem der Sortierung der resultierenden Daten nach Rang.  Es blieb, um es in die Praxis umzusetzen. </p><br><p>  Zus√§tzliche Klasse <code>FTS_Int</code> die in dieser Anforderung verwendet wird: </p><br><pre> <code class="plaintext hljs">/// c# public partial class FTS_Int { public int Key { get; set; } public int Rank { get; set; } public string Query { get; set; } }</code> </pre> <br><p>  Der Name wurde nicht zuf√§llig ausgew√§hlt, da die Schl√ºsselspalte in dieser Klasse mit der Schl√ºsselspalte in der Suchtabelle √ºbereinstimmen sollte (in meinem Beispiel mit <code>[Article].[Id]</code> Typ <code>int</code> ).  F√ºr den Fall, dass Sie Abfragen f√ºr andere Tabellen mit anderen Arten von Schl√ºsselspalten durchf√ºhren m√ºssen, habe ich angenommen, dass Sie einfach eine √§hnliche Klasse kopieren und ihren Schl√ºssel des erforderlichen Typs erstellen. </p><br><p>  Die Bedingung f√ºr die Bildung einer Volltextabfrage sollte in der Variablen <code>queryText</code> werden.  Um den Text dieser Variablen zu bilden, wurde eine separate Funktion implementiert: </p><br><pre> <code class="plaintext hljs">/// c# string queryText = FtsSearch.Query( dbContext: db, //   ,       ftsEnum: FtsEnum.CONTAINS, //  : CONTAINS  FREETEXT tableQuery: typeof(News), //       tableFts: typeof(FTS_Int), //    search: "text"); //   </code> </pre> <br><p>  Erf√ºllung einer fertigen Anfrage und Datenerfassung: </p><br><pre> <code class="plaintext hljs">/// c# var result = FtsSearch.Execute(() =&gt; query.ToList());</code> </pre> <br><p>  Die letzte <code>FtsSearch.Execute</code> Wrapper-Funktion wird verwendet, um die <code>IDbCommandInterceptor</code> Schnittstelle vor√ºbergehend zu verbinden.  In dem Beispiel, das durch den obigen Link bereitgestellt wird, hat der Autor es vorgezogen, den Abfragesubstitutionsalgorithmus st√§ndig f√ºr alle Anforderungen zu verwenden.  Infolgedessen sucht jede Anforderung nach dem Verbinden des Mechanismus zum Ersetzen von Abfragen nach der erforderlichen Kombination zum Ersetzen.  Diese Option erschien mir verschwenderisch, daher wird die Ausf√ºhrung der Datenanforderung selbst in der √ºbertragenen Funktion ausgef√ºhrt, die vor dem Aufruf die automatische Ersetzung der Abfrage verbindet und nach dem Anruf die Verbindung trennt. </p><br><h1 id="primenenie">  Anwendung </h1><br><p>  Ich verwende die automatische Generierung von Datenmodellklassen aus einer Datenbank mithilfe der EDMX-Datei.  Da Sie die erstellte <code>FTS_Int</code> Klasse in EF aufgrund des Fehlens der erforderlichen Metadaten in <code>DbContext</code> einfach nicht verwenden <code>DbContext</code> , habe ich eine echte Tabelle gem√§√ü ihrem Modell erstellt (vielleicht kennt jemand einen besseren Weg, ich freue mich √ºber Ihre Hilfe in den Kommentaren): </p><br><p>  <em>Screenshot der in der edmx-Datei erstellten Tabelle</em> </p><br><p><img src="https://habrastorage.org/webt/p3/my/mm/p3mymmi7n_n6kpsxqibzdrrixfi.png"></p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[FTS_Int] ( [<span class="hljs-keyword"><span class="hljs-keyword">Key</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">Query</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_FTS_Int] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> CLUSTERED ([<span class="hljs-keyword"><span class="hljs-keyword">Key</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>) );</code> </pre> <br><p>  F√ºgen Sie anschlie√üend beim Aktualisieren der edmx-Datei aus der Datenbank die erstellte Tabelle hinzu und rufen Sie die generierte Klasse ab: </p><br><pre> <code class="plaintext hljs">/// c# public partial class FTS_Int { public int Key { get; set; } public int Rank { get; set; } public string Query { get; set; } }</code> </pre> <br><p>  F√ºr diese Tabelle werden keine Abfragen durchgef√ºhrt. Sie wird nur ben√∂tigt, damit die Metadaten zum Erstellen der Abfrage korrekt gebildet werden.  Das letzte Beispiel f√ºr die Verwendung einer Volltext-Datenbankabfrage: </p><br><pre> <code class="plaintext hljs">/// c# string queryText = FtsSearch.Query( dbContext: db, ftsEnum: FtsEnum.CONTAINS, tableQuery: typeof(Article), tableFts: typeof(FTS_Int), search: "text"); var queryFts = db.FTS_Int.Where(n =&gt; n.Query.Contains(queryText)); var query = db.Article .Where(n =&gt; n.Active) .Join(queryFts, article =&gt; article.Id, fts =&gt; fts.Key, (article, fts) =&gt; new { article, fts.Rank, }) .OrderByDescending(n =&gt; n.Rank) .Take(10) .Select(n =&gt; n.article); var result = FtsSearch.Execute(() =&gt; query.ToList());</code> </pre> <br><p>  Es gibt auch Unterst√ºtzung f√ºr asynchrone Anforderungen: </p><br><pre> <code class="plaintext hljs">/// c# var result = await FtsSearch.ExecuteAsync(async () =&gt; await query.ToListAsync());</code> </pre> <br><p>  Vor der Autokorrektur generierte SQL-Abfrage: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">10</span></span>) [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Project1].[<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>], [Project1].[<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>], [Project1].[Active] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Active] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>], [Extent1].[Active] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Active], [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Article] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> [dbo].[FTS_Int] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Key</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ([Extent1].[Active] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ([Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Query</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> @p__linq__0 ESCAPE N<span class="hljs-string"><span class="hljs-string">'~'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project1] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p>  SQL-Abfrage nach Autokorrektur generiert: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP (<span class="hljs-number"><span class="hljs-number">10</span></span>) [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Project1].[<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>], [Project1].[<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>], [Project1].[Active] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Active] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>], [Extent1].[<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-built_in"><span class="hljs-built_in">Text</span></span>], [Extent1].[Active] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Active], [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [dbo].[Article] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent1] <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> CONTAINSTABLE([dbo].[Article],(*),<span class="hljs-string"><span class="hljs-string">'text'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Extent2] <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [Extent1].[<span class="hljs-keyword"><span class="hljs-keyword">Id</span></span>] = [Extent2].[<span class="hljs-keyword"><span class="hljs-keyword">Key</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ([Extent1].[Active] = <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> [Project1] <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> [Project1].[<span class="hljs-keyword"><span class="hljs-keyword">Rank</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span></code> </pre> <br><p>  Standardm√§√üig funktioniert die Volltextsuche in allen Spalten der Tabelle: </p><br><pre> <code class="sql hljs">CONTAINSTABLE([dbo].[Article],(*),'text')</code> </pre> <br><p>  Wenn Sie nur bestimmte Felder ausw√§hlen m√ºssen, k√∂nnen Sie diese im Parameter <code>FtsSearch.Query</code> Funktion <code>FtsSearch.Query</code> . </p><br><h1 id="itogo">  Insgesamt </h1><br><p>  Das Ergebnis ist die Unterst√ºtzung der Volltextsuche in LINQ. </p><br><p>  Die Nuancen dieses Ansatzes. </p><br><ol><li><p>  Der Suchparameter in der Funktion <code>FtsSearch.Query</code> verwendet keine √úberpr√ºfungen oder Wrapper zum Schutz vor SQL-Injection.  Der Wert dieser Variablen wird unver√§ndert an den Anforderungstext √ºbergeben.  Wenn Sie Ideen dazu haben, schreiben Sie in die Kommentare.  Ich habe den √ºblichen regul√§ren Ausdruck verwendet, bei dem einfach alle Zeichen au√üer Buchstaben und Zahlen entfernt werden. </p><br></li><li><p>  Sie m√ºssen auch die Funktionen zum Erstellen von Ausdr√ºcken f√ºr Volltextabfragen ber√ºcksichtigen.  Parameter zur Funktion </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> CONTAINSTABLE([dbo].[News],(*),' ')</code> </pre> <br><p>  Es hat ein ung√ºltiges Format, da MS SQL die Trennung von W√∂rtern durch logische Literale erfordert.  Damit die Anforderung erfolgreich abgeschlossen werden kann, m√ºssen Sie sie wie folgt beheben: </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> CONTAINSTABLE([dbo].[News],(*),' and ')</code> </pre> <br><p>  oder √§ndern Sie die Datenabruffunktion </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> FREETEXTTABLE([dbo].[News],(*),' ')</code> </pre> <br><p>  Weitere Informationen zu den Funktionen zum Erstellen von Abfragen finden Sie in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">offiziellen Dokumentation</a> . </p><br></li><li><p>  Die Standardprotokollierung mit dieser L√∂sung funktioniert nicht ordnungsgem√§√ü.  Hierzu wurde ein spezieller Logger hinzugef√ºgt: </p><br><pre> <code class="plaintext hljs">/// c# db.Database.Log = (val) =&gt; Console.WriteLine(val);</code> </pre> <br><p>  Wenn Sie sich die generierte Abfrage f√ºr die Datenbank ansehen, wird sie generiert, bevor die Funktionen zum automatischen Ersetzen verarbeitet werden. </p><br></li></ol><br><p>  W√§hrend des Tests habe ich komplexere Abfragen mit Mehrfachauswahl aus verschiedenen Tabellen √ºberpr√ºft und es gab keine Probleme. </p><br><p>  <a href="">GitHub-</a> Quellen </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de455160/">https://habr.com/ru/post/de455160/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de455144/index.html">Vorbereitungen f√ºr 2020: 8 Trends in der clientseitigen JavaScript-Entwicklung, die Sie kennen m√ºssen</a></li>
<li><a href="../de455148/index.html">Wir l√∂sen datengesteuerte Entscheidungsaufgaben</a></li>
<li><a href="../de455152/index.html">Verbessern Sie Ihre mobile Anwendung mithilfe der Technologie des maschinellen Lernens</a></li>
<li><a href="../de455156/index.html">Aufgaben der inl√§ndischen Sequenzierung (Juni 2019)</a></li>
<li><a href="../de455158/index.html">Die Wunder der Rechnungslegungsmethode: Abschreibungsfonds</a></li>
<li><a href="../de455164/index.html">Elena Balashova: ‚ÄûAktivisten haben die Frage aufgeworfen, dass die Daten unseres GIS-Portals f√ºr OpenStreetMap offen sein sollten.‚Äú</a></li>
<li><a href="../de455166/index.html">VPN auf dem Beeline-Router zur Umgehung von Sperren</a></li>
<li><a href="../de455168/index.html">492-Byte-Demo auf ATtiny5</a></li>
<li><a href="../de455170/index.html">Neue Architektur f√ºr den Bytezugriff auf SSD - wie es funktioniert</a></li>
<li><a href="../de455172/index.html">Ausgewogene bin√§re Suchb√§ume: Implementierung auf Julia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>