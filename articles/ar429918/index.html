<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐จ๐ฟโโ๏ธ ๐๏ธ ๐คฎ ุงูุนุงูู ุงูุงูุชุฑุงุถู ุฅูุชู. ุงูุฌุฒุก 2: SMP ๐จโ๐ฆ ๐บ๐พ ๐น</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ูู ููุงู ุณุงุจู (ุฑุงุจุท) ุ ุชุญุฏุซุช ุนู ุงูููููู ุงูุฃุณุงุณู ูุจุฑูุงูุฌ Hypervisor ุงููุงุฆู ุนูู ุชูููุฉ ุงููุญุงูุงุฉ ุงูุงูุชุฑุงุถูุฉ ูุฃุฌูุฒุฉ Intel. ุฃูุชุฑุญ ุงูุขู ุชูุณูุน ุฅููุงููุงุช ุจุฑูุงูุฌ ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ุงูุนุงูู ุงูุงูุชุฑุงุถู ุฅูุชู. ุงูุฌุฒุก 2: SMP</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/429918/" style=";text-align:right;direction:rtl">  ูู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุงู</a> ุณุงุจู (ุฑุงุจุท) ุ ุชุญุฏุซุช ุนู ุงูููููู ุงูุฃุณุงุณู ูุจุฑูุงูุฌ Hypervisor ุงููุงุฆู ุนูู ุชูููุฉ ุงููุญุงูุงุฉ ุงูุงูุชุฑุงุถูุฉ ูุฃุฌูุฒุฉ Intel.  ุฃูุชุฑุญ ุงูุขู ุชูุณูุน ุฅููุงููุงุช ุจุฑูุงูุฌ ูุฑุงูุจุฉ ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ุนู ุทุฑูู ุฅุถุงูุฉ ุฏุนู ูุจููุฉ ุงููุนุงูุฌุงุช ุงููุชุนุฏุฏุฉ (SMP) ุ ูุฃูุถูุง ุถุน ูู ุงุนุชุจุงุฑู ูุซุงูุงู ุนูู ููููุฉ ููุงู ุจุฑูุงูุฌ ูุฑุงูุจุฉ ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ุจุฅุฌุฑุงุก ุชุบููุฑุงุช ุนูู ูุธุงู ุชุดุบูู ุงูุถูู. <br><br>  ุณูุชู ุชูููุฐ ุฌููุน ุงูุฅุฌุฑุงุกุงุช ุงูุฅุถุงููุฉ ุนูู ุฌูุงุฒ ุงูููุจููุชุฑ ุจุงุณุชุฎุฏุงู ุงูุชูููู ุงูุชุงูู: <br><br>  ูุญุฏุฉ ุงููุนุงูุฌุฉ ุงููุฑูุฒูุฉ: Intel Core i7 5820K <br>  ุงูููุญุฉ ุงูุฃู: Asus X99-PRO <br>  ุฑุงู: 16 ุฌูุฌุง <br>  ูุธุงู ุงูุชุดุบูู ุงูุถูู: Windows 7 x32 ูุน PAE Disabled <br><a name="habracut"></a><br>  ุณุฃุจุฏุฃ ุจูุตู ูููุน ููููุงุช ุจุฑูุงูุฌ ูุฑุงูุจุฉ ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ุนูู ุงููุฑุต ุงูุตูุจ (ูุชู ุชุญุฏูุฏ ุฌููุน ุงูููู ูู ุงููุทุงุนุงุช). <br><br><img src="https://habrastorage.org/webt/in/_l/4b/in_l4birv9nzswyy15vouhjywla.jpeg" alt="ุงูุตูุฑุฉ"><br>  <i>ุชุฎุชูู ุนูููุฉ ุชุญููู hypervisor ุนู ุงูุฅุตุฏุงุฑ ุงูุณุงุจู ููุท ูู ูุฌูุฏ ูุญุฏุฉ ููุทูุฉ ุฌุฏูุฏุฉ <i>hypervisor.ap</i> ุ ูุงูุบุฑุถ ูููุง ูู ุงูุชููุฆุฉ ุงูุฃุณุงุณูุฉ ููุนุงูุฌ AP.</i> <br><br>  ุนูููุฉ ุชุญููู ุงููุญุฏุงุช ูู ุงูุฐุงูุฑุฉ: <br><br><img src="https://habrastorage.org/webt/3a/in/ul/3ainulrasx1dmbgbpodesnsg-qy.jpeg"><br><br>  <b>ุฏุนู SMP</b> <br><br>  ููุช ุจุชุทุจูู ุจุฑูุงูุฌ ูุฑุงูุจุฉ ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ุนูู ูุจุฏุฃ ุงููุนุงูุฌุฉ ุงููุชุนุฏุฏุฉ ุงููุชูุงุธุฑุฉ ุ ููุง ูุนูู ุฃูู ุณูุชู ุฅุทูุงู ููุณ ุงููุณุฎุฉ ูู VMX ุนูู ุฌููุน ุงููุนุงูุฌุงุช ุงูููุทููุฉ ุงูููุฌูุฏุฉ.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุณุชููู ุฌุฏุงูู IDT ู GDT ุ ููุฐูู ุฌุฏุงูู ุฐุงูุฑุฉ ุงูุชุฑุญูู ุ ูุดุชุฑูุฉ ูุฌููุน ุงููุนุงูุฌุงุช ุงูููุทููุฉ.  ููุฏ ูุนูุช ุฐูู ูุฃู ุจุฑูุงูุฌ Hypervisor ุณูููู ุจุชููุฆุฉ ุงูุฐุงูุฑุฉ ููุฑูุง ููุณุงุญุฉ ุงูุนููุงู ููุธุงู ุงูุชุดุบูู ุงูุถูู ููุง ุชูุฌุฏ ุญุงุฌุฉ ูุฅุนุงุฏุฉ ุชุนููู ุงูุนูุงููู ุงููุนููุฉ ููุตูุญุงุช ุงููุฑุฏูุฉ ุจุดูู ุฏููุงูููู.  ุฃูุถูุง ุ ุจุงุณุชุฎุฏุงู ูุฐุง ุงูููุฌ ุ ูุง ุชุญุชุงุฌ ุฅูู ูุฑุงูุจุฉ ูุฑุงุณูุงุช ูุฎุงุจุฆ TLB ูููุนุงูุฌ ุนูู ุฌุงูุจ ุจุฑูุงูุฌ Hypervisor. <br>  ุณุชููู ุนูููุฉ ุงูุชููุฆุฉ ูู BSP ู AP ูุฎุชููุฉ.  ุณูุชู ุฅูุดุงุก ุฌููุน ุงูููุงูู ุงูุฑุฆูุณูุฉ ุงููุดุงุฑูุฉ ูู ุจุฑูุงูุฌ Hypervisor ุฃุซูุงุก ุชููุฆุฉ BSP.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ุณูุชู ุชุนููู ุญุงูุฉ ุงููุดุงุท ููุนุงูุฌุงุช AP ุจูุถุน ุงูุฌุฐุฑ ุบูุฑ vmx ุฅูู ุญุงูุฉ HLT.  ูุจุงูุชุงูู ุ ุณูุชู ูุญุงูุงุฉ ุจูุฆุฉ ูุธุงู ุงูุชุดุบูู ุงูุถูู ููููุง ููุง ุณุชููู ุนููู ุจุฏูู ุงุณุชุฎุฏุงู ุงููุญุงูุงุฉ ุงูุงูุชุฑุงุถูุฉ. <br><br>  ุชููุฆุฉ BSP: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุชููุฆุฉ Spinlock </li><li style=";text-align:right;direction:rtl">  ุชููุฆุฉ ูุชุญููู ุฌุฏุงูู GDT ู IDT </li><li style=";text-align:right;direction:rtl">  ุชููุฆุฉ ุฌุฏุงูู ุงูุชุฑุญูู </li><li style=";text-align:right;direction:rtl">  ุชููุฆุฉ ููุงูู VMCS ูุฅูุดุงุก ุฌุฏูู EPT ูุดุชุฑู </li><li style=";text-align:right;direction:rtl">  ุชูุนูู ูุนุงูุฌุงุช AP.  ููููุงู ุจุฐูู ุ ูุชู ุฅุฑุณุงู ุชุณูุณู ููุงุทุนุฉ INIT - SIPI ุฅูู ูู AP.  ุงููุชุฌู ูููุงุทุนุฉ SIPI ูู 0x20 ุ ููู ูุง ูุชูุงูู ูุน ููู ุนูุตุฑ ุชุญูู AP ุนูุฏ 0x20000 (ูุญุฏุฉ hypervisor.ap) </li><li style=";text-align:right;direction:rtl">  ุจุฏุก ุชุดุบูู ูุธุงู ุชุดุบูู ุงูุถูู ุนูุฏ 0x7C00 (ูุญุฏุฉ win7.mbr) </li></ol><br>  AP ุงูุชููุฆุฉ: <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  ุจุนุฏ ุชูุดูุท AP ุ ูููู ุงููุนุงูุฌ ูู ุงููุถุน ุงูุญูููู.  ุชููุฆุฉ ุงููุญุฏุฉ ุงูููุทูุฉ hypervisor.ap ุงูุฐุงูุฑุฉ ูุฌุฏุงูู ุงูุชุฑุญูู ููุชุจุฏูู ุฅูู ุงููุถุน ุงูุทููู </li><li style=";text-align:right;direction:rtl">  ูู ุจุชูุฒูู IDT ู GDT ููุฐูู ูุชุงููุฌ ุฌุฏุงูู ุงูุชุฑุญูู ุงูุชู ุชู ุฅูุดุงุคูุง ุฃุซูุงุก ูุฑุญูุฉ ุชููุฆุฉ BSP </li><li style=";text-align:right;direction:rtl">  ุชููุฆุฉ ููุงูู VMCS ุ ูุชุญููู ุฌุฏุงูู EPT ุงูุชู ุชู ุฅูุดุงุคูุง ูู ูุฑุญูุฉ ุงูุชููุฆุฉ ูู BSP </li><li style=";text-align:right;direction:rtl">  ุงูุชุจุฏูู ุฅูู ุงููุถุน ุบูุฑ ุงูุฌุฐุฑ vmx ูุน ุญุงูุฉ HLT ุงููุดุทุฉ </li></ol><br>  ูููููุง ุงูููู ุฃู ุชูููุฐ ุฏุนู SMP ูู ุจุฑูุงูุฌ Hypervisor ุจุณูุท ููุบุงูุฉ ุ ูููู ููุงู ุจุนุถ ุงูููุงุท ุงูุชู ุฃูุฏ ุฃู ุฃููุช ุงูุงูุชุจุงู ุฅูููุง. <br><br>  1.ุฏุนู USB Legacy <br><br>  ูุฏ ูุง ุชุญุชูู ููุฏููุงุช ุงูููุญุฉ ุงูุฃู ุงูุฌุฏูุฏุฉ ุนูู ููุตูุงุช PS / 2 ุ ูุฐูู ูุชู ุงุณุชุฎุฏุงู ุฏุนู USB Legacy ูุถูุงู ุงูุชูุงูู ูุน ุงูุฅุตุฏุงุฑุงุช ุงูุณุงุจูุฉ.  ูุฐุง ูุนูู ุฃูู ููููู ุงูุนูู ุจุงุณุชุฎุฏุงู ููุญุฉ ููุงุชูุญ ุฃู ูุงูุณ USB ุจุงุณุชุฎุฏุงู ููุณ ุงูุฃุณุงููุจ (ููุงูุฐ ุงูุฅุฏุฎุงู / ุงูุฅุฎุฑุงุฌ) ููุง ูุงูุช ูุน ูุนูุงุฑ PS / 2.  ูุง ูุนุชูุฏ ุชุทุจูู USB Legacy Support ุนูู ุทุฑุงุฒ ุงูููุญุฉ ุงูุฃู ูุญุณุจ ุ ุจู ูููู ุฃูุถูุง ุฃู ูุชู ุงุณุชุฎุฏุงูู ูู ุฅุตุฏุงุฑุงุช ูุฎุชููุฉ ูู ุงูุจุฑุงูุฌ ุงูุซุงุจุชุฉ.  ุนูู ุงูููุญุฉ ุงูุฃู Asus X99-PRO ุ ูุชู ุชูููุฐ ุฏุนู USB Legacy ูู ุฎูุงู ููุงุทุนุงุช SMI ุ ูู ุงููุนุงูุฌ ุงูุฐู ูุญุฏุซ ูุถุงูุงุฉ PS / 2.  ุฃูุชุจ ุนู ูุฐุง ุจูุซู ูุฐู ุงูุชูุงุตูู ุ ูุฃูู ูู ุญุงูุชู (ุฅุตุฏุงุฑ ุงูุจุฑุงูุฌ ุงูุซุงุจุชุฉ 3801) ุ ูุง ูุชูุงูู ุฏุนู USB Legacy ูุน ุงููุถุน ุงูุทููู ูุนูุฏูุง ูุนูุฏ ูู SMM ุ ููุชูู ุงููุนุงูุฌ ุฅูู ุญุงูุฉ ุฅููุงู ุงูุชุดุบูู. <br><br>  ุงูุญู ุงูุฃุณูู ูู ูุฐู ุงูุญุงูุฉ ูู ุฅููุงู ุชุดุบูู ุฏุนู USB Legacy ูุจู ุงูุชุจุฏูู ุฅูู ุงููุถุน ุงูุทููู.  ููุน ุฐูู ุ ูู Windows ุ ูุชู ุงุณุชุฎุฏุงู ุทุฑููุฉ ุงูุชุฑุงุน ููุญุฉ ุงูููุงุชูุญ PS / 2 ูู ูุฑุญูุฉ ุชุญุฏูุฏ ุฎูุงุฑุงุช ุงูุชูููุฏ ุ ูุฐูู ูุฌุจ ุชูุดูุท ุฏุนู USB Legacy ูุฑุฉ ุฃุฎุฑู ูุจู ุจุฏุก ุชุญููู ูุธุงู ุชุดุบูู ุงูุถูู. <br><br>  2. ุชุจุฏูู ูููุฉ ุงูุฃุฌูุฒุฉ <br><br>  ูู ุฃูุธูุฉ ุงูุชุดุบูู ุงูุญุฏูุซุฉ ุ ูุชู ุชูููุฐ ุงูุชุจุฏูู ุจูู ุงูููุงู ุ ููุงุนุฏุฉ ุนุงูุฉ ุ ูู ุฎูุงู ุทุฑู ุงูุจุฑูุฌูุงุช.  ููุน ุฐูู ุ ูู Windows7 ุ ูุชู ุชุนููู ุงููุญุฏุฏุงุช ุงูุชู ุชุดูุฑ ุฅูู TSS ููููุงุทุนุงุช 2 - NMI ู 8 - ุฎุทุฃ ูุฒุฏูุฌ ุ ููุง ูุนูู ุฃู ูุฐู ุงูููุงุทุนุงุช ุณุชุคุฏู ุฅูู ุชุจุฏูู ุณูุงู ุงูุฃุฌูุฒุฉ.  ูุง ูุฏุนู Intel VMX ุชุจุฏูู ููุงู ุงูุฃุฌูุฒุฉ ุ ูุชุคุฏู ูุญุงููุฉ ุชูููุฐู ุฅูู ุฎุฑูุฌ VM.  ููุซู ูุฐู ุงูุญุงูุงุช ุ ูุชุจุช ูุนุงูุฌ ุชุจุฏูู ุงูููุงู ุงูุฎุงุต ุจู (ูุธููุฉ GuestTaskSwitch).  ูุญุฏุซ ููุงุทุนุฉ ุฎุทุฃ ูุฒุฏูุฌ ููุท ูู ุญุงูุฉ ูุฌูุฏ ุชุนุงุฑุถ ุฎุทูุฑ ูู ุงููุธุงู ุจุณุจุจ ุงููุนุงูุฌุฉ ุบูุฑ ุงูุตุญูุญุฉ ููููุงุทุนุงุช ุงูุฃุฎุฑู.  ูู ุนูููุฉ ุงูุชุตุญูุญ ุ ูู ุฃุตุงุฏู ุฐูู.  ููู NMI ูุธูุฑ ุนูู ูุนุงูุฌุงุช AP ูู ููุช ุฅุนุงุฏุฉ ุชุดุบูู Windows.  ูุง ูุฒุงู ูุฐุง ูุซูุฑ ุดูููู ูุฃูู ูู ุบูุฑ ุงููุงุถุญ ูุง ุฅุฐุง ูุงูุช ูุฐู NMIs ูุงุชุฌุฉ ุนู ุนูููุฉ ุฅุนุงุฏุฉ ุชุดุบูู ููุชุธูุฉ ุฃู ุฃู ูุฐู ุงูุนูููุฉ ุบูุฑ ุงูุตุญูุญุฉ ูุจุฑูุงูุฌ Hypervisor ูู ุจุนุถ ุงููุฑุงุญู ุงูุณุงุจูุฉ.  ุฅุฐุง ูุงู ูุฏูู ุฃู ูุนูููุงุช ุญูู ูุฐุง ุงูููุถูุน ุ ูุฑุฌู ุงูุชุญุฏุซ ูู ุงูุชุนูููุงุช ุฃู ูุฑุงุณูุชู ูู ุฑุณุงูุฉ ุดุฎุตูุฉ. <br><br>  <b>ุงูุชุบููุฑุงุช ูู ูุธุงู ุชุดุบูู ุงูุถูู</b> <br><br>  ุจุตุฑุงุญุฉ ุ ูู ุฃุณุชุทุน ุฃู ุฃูุฑุฑ ููุชุฑุฉ ุทูููุฉ ุจุงูุถุจุท ุงูุชุบููุฑุงุช ุงูุชู ูุฌุจ ุฃู ูููู ุจูุง ุจุฑูุงูุฌ ูุฑุงูุจุฉ ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ูู ุนูู ูุธุงู ุงูุชุดุบูู ุงูุถูู.  ูุงูุญูููุฉ ูู ูู ูุงุญูุฉ ุ ุฃุฑุฏุช ุฃู ุฃุธูุฑ ุดูุฆูุง ูุซูุฑูุง ููุงูุชูุงู ุ ูุซู ุฅุฏุฎุงู ูุนุงูุฌุงุชูุง ูู ุจุฑูุชููููุงุช ุงูุดุจูุฉ ุงูุฃุณุงุณูุฉ ุ ูููู ูู ูุงุญูุฉ ุฃุฎุฑู ุ ูุฅู ูู ุฐูู ุณูุตู ุฅูู ูููุฉ ูุจูุฑุฉ ูู ุงูุชุนูููุงุช ุงูุจุฑูุฌูุฉ ุ ููู ููู ููุงู ุงููุซูุฑ ููููุงู ุจู ูุน ููุถูุน ุงููุดุฑู.  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูู ุฃุฑุบุจ ูู ุฑุจุท ุจุฑูุงูุฌ ูุฑุงูุจุฉ ุงูุฃุฌูุฒุฉ ุงูุงูุชุฑุงุถูุฉ ุจุฃู ูุฌููุนุฉ ูุญุฏุฏุฉ ูู ุงูุญุฏูุฏ. <br><br>  ููุชูุฌุฉ ูุฐูู ุ ุชู ุงูุนุซูุฑ ุนูู ุงูุญู ุงููุณุท ุงูุชุงูู: ูู ูุฐุง ุงูุฅุตุฏุงุฑ ูู ุจุฑูุงูุฌ Hypervisor ุ ูุชู ุชูููุฐ ุงูุชุญูู ูู ููุงููุงุช ุงููุธุงู ูู ูุถุน ุงููุณุชุฎุฏู ุ ูุจุนุจุงุฑุฉ ุฃุฎุฑู ุ ุณูููู ูู ุงููููู ุงูุชุญูู ูู ุชุดุบูู ุงูุชุทุจููุงุช ุงูุชู ุชุนูู ูู ูุธุงู ุชุดุบูู ุงูุถูู.  ูุฐุง ุงูููุน ูู ุงูุชุญูู ุณูู ุงูุชูููุฐ ููุบุงูุฉ ููุชูุญ ูู ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุงูุญุตูู ุนูู ูุชูุฌุฉ ูุฑุฆูุฉ ููุนูู. <br><br>  ุณูุชู ุงูุชุญูู ูู ุชุดุบูู ุงูุชุทุจููุงุช ุนูู ูุณุชูู ููุงููุงุช ุงููุธุงู.  ูุณูููู ุงููุฏู ุงูุฑุฆูุณู ุชุบููุฑ ูุชูุฌุฉ ุฏุงูุฉ <i>NtQuerySystemInformation</i> ุจุญูุซ ููููู ุนูุฏ ุงูุงุชุตุงู ูุน ูุณูุทุฉ <i>SystemProcessInformation</i> ( <i>0x05</i> ) ุ ุงุนุชุฑุงุถ ูุนูููุงุช ุงูุนูููุฉ. <br><br>  ูู Windows 7 ุ ูุณุชุฎุฏู ุจุฑูุงูุฌ ุงูุชุทุจูู ูุงุณุชุฏุนุงุก ูุธููุฉ ุงููุธุงู ุงูุฃูุฑ ุงููุฌูุน sysenter ุ ูุจุนุฏ ุฐูู ูุชู ููู ุนูุตุฑ ุงูุชุญูู ุฅูู ูุนุงูุฌ <i>KiFastCallEntry</i> ุฅูู kernel ุนูุฏ ุงููุณุชูู r0.  ููุนูุฏุฉ ุฅูู ูุณุชูู ุงูุชุทุจูู r3 ุ ุงุณุชุฎุฏู ุงูุฃูุฑ sysexit. <br>  ูููุตูู ุฅูู ูุชุงุฆุฌ <i>ุชูููุฐ</i> ูุธููุฉ <i>NtQuerySystemInformation ุ</i> ูู ุงูุถุฑูุฑู ุญูุธ ุนุฏุฏ ุงููุธููุฉ ุงููุทููุจุฉ ูู ูู ูุฑุฉ ูุชู ูููุง ุชูููุฐ ุงูุฃูุฑ sysenter.  ุจุนุฏ ุฐูู ุ ุนูุฏ ุชูููุฐ <i>sysexit ุ</i> ูุงุฑู ุงููููุฉ ุงููุฎุฒูุฉ ูุน ุฑูู ุงููุธููุฉ ุงูุชู ูุชู ุงุนุชุฑุงุถูุง ุ ูุฅุฐุง ูุงู ููุงู ุชุทุงุจู ุ ูู ุจุฅุฌุฑุงุก ุชุบููุฑุงุช ุนูู ุงูุจูุงูุงุช ุงูุชู ูุชู ุฅุฑุฌุงุนูุง ุจูุงุณุทุฉ ุงููุธููุฉ. <br>  ูุง ุชููุฑ Intel VMX ูุณุงุฆู ูุจุงุดุฑุฉ ูุฑุตุฏ ุชูููุฐ <i>sysenter / sysexit</i> ุ ููุน ุฐูู ุ ุฅุฐุง ูุชุจุช ุงููููุฉ 0 ุฅูู <i>Guest MSR IA32_SYSENTER_CS</i> ุ ูุฅู <i>ุฃูุงูุฑ sysenter / sysexit</i> ุณุชุซูุฑ ุงุณุชุซูุงุก GP ุงูุฐู ูููู ุงุณุชุฎุฏุงูู ูุงุณุชุฏุนุงุก ูุนุงูุฌ VM Exit.  ูู ุฃุฌู ุงุณุชุซูุงุก GP ูุงุณุชุฏุนุงุก ุฎุฑูุฌ VM ุ ุชุญุชุงุฌ ุฅูู ุชุนููู 13 ุจุช ูู ุญูู <i>ุงุณุชุซูุงุก ุงูุตูุฑุฉ ุงูููุทูุฉ</i> ูู VMCS. <br><br>  ูุชู ุงุณุชุฎุฏุงู ุงููููู ุฃุฏูุงู ููุญุงูุงุฉ ุฒูุฌ sysenter / sysexit. <br><br><pre style=";text-align:right;direction:rtl"><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class">{</span></span> QWORD ServiceNumber; QWORD Guest_Sys_CS; QWORD Guest_Sys_EIP; QWORD Guest_Sys_ESP; } SysEnter_T;</code> </pre> <br>  ูุญุชูู ุญูู <i>ServiceNumber</i> ุนูู ุฑูู ุงููุธููุฉ ุงูุชู ูุชู ุงุณุชุฏุนุงุคูุง ููุชู ุชุญุฏูุซูุง ูุน ูู ุงุณุชุฏุนุงุก ุฅูู sysenter. <br><br>  ูุชู <i>ุชุญุฏูุซ</i> ุงูุญููู <i>Guest_Sys_CS ู Guest_Sys_EIP ู Guest_Sys_ESP</i> ุนูุฏูุง ูุญุงูู ูุธุงู ุงูุชุดุบูู ุงูุถูู ุงููุชุงุจุฉ ุฅูู ุณุฌู MSR ุงูููุงุจู.  ููููุงู ุจุฐูู ุ <i>ูุชู ุชุนููู</i> ุฃููุนุฉ ุงููุชุงุจุฉ ูู <i>ุนููุงู MSR-Bitmap</i> . <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 174H 372 IA32_SYSENTER_CS SYSENTER_CS write mask ptrMSR_BMP[0x100 + (0x174 &gt;&gt; 6)] |= (1UL &lt;&lt; (0x174 &amp; 0x3F)); // 175H 373 IA32_SYSENTER_ESP SYSENTER_ESP write mask ptrMSR_BMP[0x100 + (0x175 &gt;&gt; 6)] |= (1UL &lt;&lt; (0x175 &amp; 0x3F)); // 176H 374 IA32_SYSENTER_EIP SYSENTER_EIP write mask ptrMSR_BMP[0x100 + (0x176 &gt;&gt; 6)] |= (1UL &lt;&lt; (0x176 &amp; 0x3F));</span></span></code> </pre><br>  ูุฌุจ ุฃูุง ูุฑู ูุธุงู ุงูุชุดุบูู ุงูุถูู ุงูุชุบููุฑุงุช ุงูุชู ุฃุฌุฑุงูุง ุงููุดุฑู ุนูู ุชุดุบูู ุงุณุชุฏุนุงุกุงุช ูุธุงุฆู ุงููุธุงู.  ูู ุฎูุงู ุชุนููู ููุงุน ุงููุฑุงุกุฉ ูู <i>MSR IA32_SYSENTER_CS ุ</i> ููููู ุฅุนุงุฏุฉ ูุธุงู ุงูุชุดุบูู ุงูุถูู ุฅูู ูููุฉ ุงูุชุณุฌูู ุงูุฃุตููุฉ ุนูุฏ ุงููุฑุงุกุฉ. <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// 174H 372 IA32_SYSENTER_CS SYSENTER_CS read mask ptrMSR_BMP[0x174 &gt;&gt; 6] |= (1UL &lt;&lt; (0x174 &amp; 0x3F));</span></span></code> </pre><br>  ูุง ููู ูู ูุธุงู ูุถุงูุงุฉ ุงูุฃูุฑ <i>sysenter / sysexit</i> . <br><br><img src="https://habrastorage.org/webt/bl/wx/vo/blwxvocgthxx_0skhnjmm4sbf4i.jpeg"><br><br>  ูู <i>ูุฑุญูุฉ</i> ูุถุงูุงุฉ <i>sysexit</i> ุ ุชุชู ููุงุฑูุฉ ุงูุฑูู <i>ุงููุฎุฒู ูููุธููุฉ ุงููุทููุจุฉ</i> ุจุฑูู NtQuerySystemInformation (0x105).  ูู ุญุงูุฉ ุงููุทุงุจูุฉ ุ ูุชู ุงูุชุญูู ูู ุงุณุชุฏุนุงุก NtQuerySystemInformation ูุน ูุณูุทุฉ ูุนูููุงุช ูุนุงูุฌุฉ ุงููุธุงู ูุฅุฐุง ูุงู ุงูุฃูุฑ ูุฐูู ุ ูุฅู ูุธููุฉ <i>ChangeProcessNames (DWORD SPI_GVAุ DWORD SPI_size)</i> ุชููู ุจุฅุฌุฑุงุก ุชุบููุฑุงุช ุนูู ุงูููุงูู ุงูุชู ุชุญุชูู ุนูู ูุนูููุงุช ุญูู ุงูุนูููุงุช. <br>  <i>SPI_GVA</i> ูู ุนููุงู ุงูุถูู ุงูุธุงูุฑู ูุจููุฉ <i>SYSTEM_PROCESS_INFORMATION</i> <br>  <i>SPI_size</i> ูู ุงูุญุฌู ุงูุฅุฌูุงูู ููููุงูู ุจุงูุจุงูุช. <br>  <i>ุชุจุฏู</i> ุจููุฉ <i>SYSTEM_PROCESS_INFORMATION ููุณูุง</i> ููุง ููู: <br><br><pre style=";text-align:right;direction:rtl"> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SYSTEM_PROCESS_INFORMATION</span></span></span><span class="hljs-class"> {</span></span> ULONG NextEntryOffset; ULONG NumberOfThreads; BYTE Reserved1[<span class="hljs-number"><span class="hljs-number">48</span></span>]; UNICODE_STRING ImageName; KPRIORITY BasePriority; HANDLE UniqueProcessId; PVOID Reserved2; ULONG HandleCount; ULONG SessionId; PVOID Reserved3; SIZE_T PeakVirtualSize; SIZE_T VirtualSize; ULONG Reserved4; SIZE_T PeakWorkingSetSize; SIZE_T WorkingSetSize; PVOID Reserved5; SIZE_T QuotaPagedPoolUsage; PVOID Reserved6; SIZE_T QuotaNonPagedPoolUsage; SIZE_T PagefileUsage; SIZE_T PeakPagefileUsage; SIZE_T PrivatePageCount; LARGE_INTEGER Reserved7[<span class="hljs-number"><span class="hljs-number">6</span></span>]; } SYSTEM_PROCESS_INFORMATION;</code> </pre><br>  ูุง ููุฌุฏ ุดูุก ูุนูุฏ ูู ุชุญูููู ุ ุงูุดูุก ุงูุฑุฆูุณู ูู ุนุฏู ูุณูุงู ุชุฑุฌูุฉ ุนููุงู ุงูุถูู ุงูุงูุชุฑุงุถู ุฅูู ูุนูู ุ ุญูุซ ูุชู ุงุณุชุฎุฏุงู ูุธููุฉ <i>GuestLinAddrToPhysAddr ()</i> . <br><br>  ููุชูุถูุญ ุ ููุช ุจุงุณุชุจุฏุงู ุงูุญุฑููู ุงูุฃูููู ูู ุฃุณูุงุก ุฌููุน ุงูุนูููุงุช ุจุนูุงูุฉ " <b>:)</b> ". ุชุธูุฑ ูุชูุฌุฉ ูุฐุง ุงูุงุณุชุจุฏุงู ูู ููุทุฉ ุงูุดุงุดุฉ. <br><br><img src="https://habrastorage.org/webt/rs/nq/rt/rsnqrtxvkrcoc0r_4xgjnuabk8o.png"><br><br>  <b>ุงูููุฎุต</b> <br><br>  ุจุดูู ุนุงู ุ ุชู ุงูุงูุชูุงุก ูู ุงูููุงู ุงููุญุฏุฏุฉ ูู ุจุฏุงูุฉ ุงูููุงูุฉ.  ูุถูู ุจุฑูุงูุฌ Hypervisor ุงูุชุดุบูู ุงููุณุชูุฑ ููุธุงู ุงูุชุดุบูู ุงูุถูู ุ ููุชุญูู ุฃูุถูุง ูู ุงุณุชุฏุนุงุก ูุธุงุฆู ุงููุธุงู ูู ูุณุชูู ุงูุชุทุจูู.  ุฃูุงุญุธ ุฃู ุงูุนูุจ ุงูุฑุฆูุณู ูุงุณุชุฎุฏุงู ูุญุงูุงุฉ ุงูุฃูุฑ <i>sysenter / sysexit</i> ูู ุฒูุงุฏุฉ ูุจูุฑุฉ ูู ููุงููุงุช VM Exit ุ ููุง ูุคุซุฑ ุนูู ุงูุฃุฏุงุก ููุฐุง ููุญูุธ ุจุดูู ุฎุงุต ุนูุฏูุง ูููู ูุธุงู ุงูุชุดุบูู ุงูุถูู ูู ูุถุน ุงููุนุงูุฌ ุงูููุฑุฏ.  ูููู ุงูุชุฎูุต ูู ูุฐุง ุงูุนูุจ ุฅุฐุง ููุช ุชุชุญูู ูู ุงูููุงููุงุช ููุท ูู ุณูุงู ุงูุนูููุงุช ุงููุญุฏุฏุฉ. <br><br>  ููุฐุง ูู ุดูุก ุงูุขู.  ูููู ุฃู ุชุคุฎุฐ ูุตุงุฏุฑ ุงูููุงู <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">ููุง</a> <br><br>  ุดูุฑุง ููู ุนูู ุงูุชูุงููู. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar429918/">https://habr.com/ru/post/ar429918/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar429908/index.html">ููููุฉ ุงุณุชุฎุฏุงู ููุฑูุชููุงุช ูู ุงูุทุนุงู ูุงูููู ุจุณูุงู ูู ุงูููู</a></li>
<li><a href="../ar429910/index.html">ูุฑุชูุน AppsConf</a></li>
<li><a href="../ar429912/index.html">ุชุทููุฑ ุงูููุชุจุฉ: ูู API ุฅูู ุงูุฅุตุฏุงุฑ ุงูุนุงู</a></li>
<li><a href="../ar429914/index.html">OpenSceneGraph: ุงูุฑุณู ุงูุจูุงูู ูููุดูุฏ ูุงููุคุดุฑุงุช ุงูุฐููุฉ</a></li>
<li><a href="../ar429916/index.html">ููู ุชุจูู ูุชุจูู</a></li>
<li><a href="../ar429920/index.html">ุฃุนูุงู Tragicomedy ูู NaN: ููู ุตูุนูุง ูุนุจุฉ ุนูู JS ูุฃุทูููุงูุง ุนูู Steam</a></li>
<li><a href="../ar429922/index.html">ููููุฉ ุชุญููู ูุดุฑูุน ุจุณูุท ุฅูู ุจูุงุก ุทููู ุงูุฃูุฏ ุฃู ูุทุน ูู ูุง ูุง ุฏุงุนู ูู</a></li>
<li><a href="../ar429928/index.html">ูู ูุง ุชุฑูุฏ ูุนุฑูุชู ุนู ุงูุชูุชุฑ ูุงูุนูุงุทู ุงููููุฉ</a></li>
<li><a href="../ar429930/index.html">ุดูู ุงุณุชูุดุงู ุฃุฎุทุงุก ุงูุชุทุจูู ุจุณูููุฉ</a></li>
<li><a href="../ar429934/index.html">ูุงุฐุง ููุฌุฏุ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>