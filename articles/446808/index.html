<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßöüèª üë©üèº üç∞ Mi compilador para Lisp üóÉÔ∏è ü§üüèΩ üé°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬°Me complace anunciar la finalizaci√≥n de mi primer compilador para un lenguaje de programaci√≥n! Malcc es un compilador incremental de Lisp AOT escrito...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mi compilador para Lisp</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446808/">  ¬°Me complace anunciar la finalizaci√≥n de mi primer compilador para un lenguaje de programaci√≥n!  <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Malcc</a> es un compilador incremental de Lisp <abbr title="Por adelantado">AOT</abbr> escrito en C.</b> <br><br>  Hablar√© brevemente sobre sus muchos a√±os de desarrollo y lo que aprend√≠ en el proceso.  T√≠tulo del art√≠culo alternativo: "C√≥mo escribir un compilador en diez a√±os o menos". <br><br>  (Al final hay <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">TL; DR</a> , si no te importa el fondo). <br><a name="habracut"></a><br><h1>  Demo del compilador </h1><br><pre><code class="plaintext hljs">tim ~/pp/malcc master 0 ‚Üí ./malcc Mal [malcc] user&gt; (println "hello world") hello world nil user&gt; (+ 1 2) 3 user&gt; (def! fib2 (fn* (n) (let* (f (fn* (n1 n2 c) (if (= cn) n2 (f n2 (+ n1 n2) (+ c 1))))) (f 0 1 1)))) &lt;lambda&gt; user&gt; (fib2 25) 75025 user&gt; ^D% tim ~/pp/malcc master 0 ‚Üí ./malcc examples/hello.mal hello world tim ~/pp/malcc master 0 ‚Üí ./malcc --compile examples/hello.mal hello gcc -g -I ./tinycc -I . -o hello hello.c ./reader.c ./printer.c ./hashmap.c ./types.c ./util.c ./env.c ./core.c ./tinycc/libtcc.a -ledit -lgc -lpcre -ldl tim ~/pp/malcc master 0 ‚Üí ./hello hello world tim ~/pp/malcc master 0 ‚Üí</code> </pre> <br><h1>  Fracasos exitosos </h1><br>  Durante casi diez a√±os, so√±√© con escribir un compilador.  Siempre me ha fascinado el trabajo de los lenguajes de programaci√≥n, especialmente los compiladores.  Aunque imagin√© el compilador como magia oscura y entend√≠ que era imposible para un simple mortal como yo hacerlo desde cero. <br><br>  ¬°Pero a√∫n lo intent√© y estudi√© en el camino! <br><br><h1>  Primero, el int√©rprete </h1><br>  En 2011, comenc√© a trabajar en un int√©rprete simple para el lenguaje ficticio Airball (airball se puede traducir como "muff").  Por nombre, puede evaluar el grado de mi incertidumbre de que funcionar√°.  Fue un programa Ruby bastante simple que analiz√≥ el c√≥digo y camin√≥ a trav√©s de un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">√°rbol de sintaxis abstracta</a> (AST).  Cuando el int√©rprete a√∫n funcionaba, le cambi√© el nombre a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lydia</a> y lo reescrib√≠ a C para hacerlo m√°s r√°pido. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6b4/902/4ee/6b49024ee04e02ae1b56776aa5ed05bc.png"><br><br>  ¬°Recuerdo que la sintaxis de Lydia me pareci√≥ muy inteligente!  Todav√≠a disfruto de su simplicidad. <br><br>  Aunque Lydia estaba lejos de ser un compilador perfecto, me inspir√≥ a seguir experimentando.  Sin embargo, todav√≠a me atormentaban las preguntas sobre c√≥mo hacer que funcione el compilador: <i>¬øen qu√© compilar?</i>  <i>¬øNecesito aprender ensamblador?</i> <br><br><h1>  En segundo lugar, el compilador e int√©rprete de bytecode </h1><br>  Como siguiente paso, en 2014, comenc√© a trabajar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">scheme-vm</a> , una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">m√°quina virtual</a> para Scheme escrita en Ruby.  Pens√© que una m√°quina virtual con su propia pila y c√≥digo de bytes ser√≠a una etapa de transici√≥n de un int√©rprete con pases AST y un compilador completo.  Y dado que Scheme est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">formalmente definido</a> , no hay necesidad de inventar nada. <br><br>  He estado jugando con esquema-vm durante m√°s de tres a√±os y he aprendido mucho sobre la compilaci√≥n.  Al final, me di cuenta de que no pod√≠a terminar este proyecto.  El c√≥digo se convirti√≥ en un verdadero caos, pero no hab√≠a un final a la vista.  Sin un mentor o experiencia, parec√≠a vagar en la oscuridad.  Al final result√≥ que, <i>la especificaci√≥n de</i> idioma no es la misma que el <i>manual</i> para ello.  Lecci√≥n aprendida! <br><br>  A finales de 2017, pospuse el esquema-vm en busca de algo mejor. <br><br><h1>  Encuentro con Mal </h1><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/386/7e7/183/3867e7183f1ec919f168fcfefc2ec6b3.png"></a> <br><br>  En alg√∫n momento en 2018, me encontr√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">con Mal</a> , un int√©rprete Lisp de estilo Clojure. <br><br>  Mal fue inventado por Joel Martin como una herramienta de entrenamiento.  Desde entonces, se han desarrollado m√°s de 75 implementaciones en diferentes idiomas.  Cuando mir√© estas implementaciones, me di cuenta de que realmente ayudan: si estoy atascado, entonces puedo buscar pistas en la versi√≥n Ruby o Python.  Finalmente, ¬°al menos alguien habla mi idioma! <br><br>  Tambi√©n pens√© que si pod√≠a escribir un int√©rprete para Mal, podr√≠a repetir los mismos pasos y crear un compilador para Mal. <br><br><h1>  Mal int√©rprete en Rust </h1><br>  Primero, comenc√© a desarrollar el int√©rprete de acuerdo con el <a href="">tutorial</a> .  En ese momento, estaba estudiando activamente Rust (lo dejar√© para otro art√≠culo), as√≠ que escrib√≠ mi propia implementaci√≥n de Mal in Rust: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">mal-rust</a> .  Vea aqu√≠ para m√°s informaci√≥n sobre este experimento. <br><br>  <b>Fue un placer perfecto!</b>  No s√© c√≥mo agradecer o alabar a Joel por crear una excelente gu√≠a para Mal.  Cada paso se describe <i>en detalle</i> , hay diagramas de flujo, pseudoc√≥digo y <b>pruebas</b> .  Todo lo que un desarrollador necesita para crear un lenguaje de programaci√≥n de principio a fin. <br><br>  Hacia el final del tutorial, logr√© ejecutar mi implementaci√≥n de Mal para Mal, escrita en Mal, adem√°s de mi implementaci√≥n de Rust.  (dos niveles de profundidad, wow).  ¬°Cuando trabaj√≥ por primera vez, salt√© sobre una silla con entusiasmo! <br><br><h1>  Compilador Mal C </h1><br>  Tan pronto como prob√© la viabilidad del mal √≥xido, inmediatamente comenc√© a investigar c√≥mo escribir un compilador.  Compilar al ensamblador?  ¬øPuedo compilar el c√≥digo de la m√°quina directamente? <br><br>  Vi el ensamblador x86 escrito en Ruby.  Me intrig√≥, pero la idea de trabajar con ensamblador me hizo parar. <br><br>  En un momento, me top√© con este <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comentario en Hacker News</a> , que se refer√≠a al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compilador de Tiny C</a> como un "backend de compilaci√≥n".  ¬°Parec√≠a una gran idea! <br><br>  TinyCC tiene un archivo de prueba que muestra <a href="">c√≥mo usar libtcc</a> para compilar el c√≥digo C del programa C. Este es el punto de partida para "hello world". <br><br>  Volviendo nuevamente al tutorial de Mal, recordando mi conocimiento de C, en un par de meses de tardes y fines de semana libres, pude escribir el compilador de Mal.  Fue un verdadero placer. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/187/2e2/99e/1872e299effaaea82a3716cd48cdf27a.png"></a> <br><br>  Si est√° acostumbrado a desarrollar pruebas, eval√∫e la disponibilidad de un conjunto preliminar de pruebas.  Las pruebas conducen a una implementaci√≥n funcional. <br><br>  No puedo decir mucho sobre este proceso, a menos que repita: el manual de Mal es un verdadero tesoro.  ¬°En cada paso, sab√≠a exactamente qu√© hacer! <br><br><h1>  Dificultades </h1><br>  Mirando hacia atr√°s, aqu√≠ hay algunas dificultades al escribir el compilador de Mal, donde tuve que pensar: <br><br><ol><li>  Las macros deben compilarse sobre la marcha y estar listas para ejecutarse en el momento de la compilaci√≥n.  Esto es un poco desconcertante. <br></li><li>  Es necesario proporcionar un "entorno" (un √°rbol de hashes / matrices asociativas / diccionarios con variables y sus valores) tanto para el c√≥digo del compilador como para el c√≥digo final del programa compilado.  Esto le permite definir macros en tiempo de compilaci√≥n. <br></li><li>  Como el entorno est√° disponible en el momento de la compilaci√≥n, inicialmente Malcc detect√≥ errores <i>indefinidos</i> durante la compilaci√≥n (acceso a una variable que no estaba definida), y en un par de lugares esto viol√≥ las expectativas del conjunto de pruebas.  Al final, para pasar las pruebas, apagu√© esta funci√≥n.  Ser√≠a genial volver a agregarlo como un indicador adicional del compilador, ya que de esta manera puede detectar muchos errores por adelantado. </li><li>  Compil√© el c√≥digo C escribiendo tres l√≠neas de la estructura: <ul><li>  <code>top</code> : c√≥digo de nivel <code>top</code> : aqu√≠ est√°n las funciones </li><li>  <code>decl</code> : declaraci√≥n e inicializaci√≥n de variables utilizadas en el cuerpo </li><li>  <code>body</code> : cuerpo donde se realiza el trabajo principal </li></ul></li><li>  Todo el d√≠a me pregunt√© si podr√≠a escribir mi propio recolector de basura, pero decid√≠ dejar este ejercicio para m√°s tarde.  La biblioteca de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">recolecci√≥n de basura Boehm-Demers-Weiser</a> es f√°cil de conectar y est√° disponible en muchas plataformas. <br></li><li>  Es importante mirar el c√≥digo que escribe su compilador.  Siempre que el compilador encontr√≥ una variable de entorno <code>DEBUG</code> , devolvi√≥ el c√≥digo C compilado donde se pod√≠an ver los errores. </li></ol><br><h1>  ¬øQu√© har√≠a de otra manera? </h1><br><ol><li>  Escribir c√≥digo C e intentar mantener la sangr√≠a no fue f√°cil, entonces no rechazar√≠a la automatizaci√≥n.  Me parece que algunos compiladores escriben c√≥digo feo, y luego una biblioteca especial lo "decora" antes de emitirlo.  ¬°Necesita ser estudiado! <br></li><li>  Agregar l√≠neas durante la generaci√≥n de c√≥digo es un poco complicado.  Podr√≠a considerar crear un AST y luego convertirlo a la √∫ltima l√≠nea de c√≥digo C. Esto deber√≠a poner el c√≥digo en orden y darle armon√≠a. </li></ol><br><a name="1"></a><h1>  Ahora consejo </h1><br>  Me gusta que tard√≥ casi una d√©cada para el compilador.  No realmente  Cada paso en el camino es un recuerdo agradable de c√≥mo me convert√≠ gradualmente en un mejor programador. <br><br>  Pero esto no significa que haya "terminado".  Todav√≠a hay cientos de m√©todos y herramientas que necesitas aprender para sentirte como un verdadero autor de compiladores.  Pero puedo decir con confianza: "Lo hice". <br><br>  Aqu√≠ est√° todo el proceso en forma concisa, c√≥mo hacer su propio compilador Lisp: <br><br><ol><li>  Elija el idioma en el que se sienta c√≥modo.  No desea aprender simult√°neamente un nuevo idioma y c√≥mo escribir otro nuevo idioma. <br></li><li>  Siguiendo <a href="">el manual de Mal,</a> escriba un int√©rprete. <br></li><li>  Al√©grate! <br></li><li>  Siga las instrucciones nuevamente, pero en lugar de ejecutar el c√≥digo, escriba el c√≥digo que lo ejecuta.  (No solo "refactorizar" el int√©rprete existente. Debe comenzar desde cero, aunque no est√° prohibido copiar y pegar). </li></ol><br>  Creo que este m√©todo se puede usar con cualquier lenguaje de programaci√≥n que se compila en un archivo ejecutable.  Por ejemplo, puedes: <br><br><ol><li>  Escribe el int√©rprete de Mal en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Go</a> . </li><li>  Modifique su c√≥digo para: <br><ul><li>  cree una l√≠nea de c√≥digo Go y escr√≠bala en un archivo; </li><li>  compile este archivo resultante con <code>go build</code> . </li></ul></li></ol><br>  Idealmente, es mejor controlar el compilador Go como una biblioteca, ¬°pero esta tambi√©n es una forma de hacer un compilador! <br><br>  Con la ayuda de la gu√≠a de Mal y tu ingenio, puedes hacer todo esto.  Si incluso yo pudiera, entonces t√∫ puedes! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/446808/">https://habr.com/ru/post/446808/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446794/index.html">Trabajamos con Wordstat correctamente. Gu√≠a completa</a></li>
<li><a href="../446796/index.html">Circuitos no est√°ndar: indicador de siete segmentos en ATtiny13</a></li>
<li><a href="../446798/index.html">La partida de un ingeniero electr√≥nico de Apple caus√≥ revuelo entre los especuladores burs√°tiles. ¬øC√≥mo llegar a ser como √©l?</a></li>
<li><a href="../446802/index.html">Recarga de cartuchos de puntos: es interesante</a></li>
<li><a href="../446806/index.html">Antecedentes: "Runet aut√≥nomo": qu√© es y qui√©n lo necesita</a></li>
<li><a href="../446810/index.html">Si tienes un paquete de cigarrillos en el bolsillo ...</a></li>
<li><a href="../446812/index.html">Movilidad y respeto al medio ambiente: c√≥mo los modernos trolebuses pueden viajar sin trolebuses</a></li>
<li><a href="../446816/index.html">OOP, la "Sant√≠sima Trinidad" y S√ìLIDO: algunos conocimientos m√≠nimos sobre ellos</a></li>
<li><a href="../446818/index.html">Venus, la luna, en adelante en todas partes: una entrevista con Pavel Shubin</a></li>
<li><a href="../446820/index.html">Seminario web: Autenticaci√≥n y ES en entornos VDI con clientes ligeros Dell y dongles JaCarta</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>