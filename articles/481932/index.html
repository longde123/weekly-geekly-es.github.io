<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥫 🏴󠁧󠁢󠁥󠁮󠁧󠁿 🎺 Implementación de bases de datos y tiempo de inactividad cero 📇 🙍🏿 🦖</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artículo explica en detalle cómo resolver los problemas asociados con la compatibilidad de la base de datos durante la implementación. Le diremos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementación de bases de datos y tiempo de inactividad cero</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/481932/"><p><img src="https://habrastorage.org/webt/hr/vy/qq/hrvyqqi2mmitehw9vx_xklbofj8.png" alt="imagen"></p><br><p>  Este artículo explica en detalle cómo resolver los problemas asociados con la compatibilidad de la base de datos durante la implementación.  Le diremos qué puede pasarle a sus aplicaciones en el producto si intenta realizar una implementación sin ninguna preparación preliminar.  Luego, pasaremos por las etapas del ciclo de vida de la aplicación, que son necesarias para tener un tiempo de inactividad cero ( <em>aprox. Transl .: más adelante, tiempo de inactividad cero</em> ).  El resultado de nuestras operaciones será la aplicación de un cambio de base de datos incompatible con versiones anteriores de una manera compatible con versiones anteriores. </p><a name="habracut"></a><br><p>  Si desea comprender los ejemplos de código del artículo, los encontrará en <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub</a> . </p><br><h2 id="vvedenie">  Introduccion </h2><br><h3 id="zero-downtime-deployment">  Implementación de tiempo de inactividad cero </h3><br><p>  ¿Cuál es la <strong>implementación</strong> mística de <strong>tiempo de inactividad cero</strong> ?  Podemos decir esto cuando su aplicación se implementa para que pueda introducir con éxito una nueva versión de la aplicación para producción, mientras que el usuario no nota su inaccesibilidad.  Desde el punto de vista del usuario y de la empresa, este es el mejor escenario de implementación posible, ya que de esta manera puede introducir nuevas funciones y eliminar errores sin interrupción. </p><br><p>  ¿Cómo lograr esto?  Hay varias formas, aquí hay una de ellas: </p><br><ul><li>  expanda la versión 1 de su servicio </li><li>  migrar la base de datos </li><li>  Implemente la versión 2 de su servicio en paralelo con la versión 1 </li><li>  tan pronto como vea que la versión número 2 funciona como debería, elimine la versión número 1 </li><li>  hecho! </li></ul><br><p>  Fácil, verdad?  Desafortunadamente, esto no es tan simple, y lo consideraremos en detalle más adelante.  Ahora veamos otro proceso de implementación bastante común: la implementación azul verde. </p><br><p>  ¿Alguna vez has oído hablar del <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">despliegue verde azul</a> ?  Con Cloud Foundry, esto es extremadamente fácil de hacer.  Solo eche un vistazo a <a href="https://spring.io/blog/2014/04/04/project-sagan-zero-downtime-deployments">este artículo</a> donde lo describimos con más detalle.  Resumiendo brevemente, recordamos cómo hacer un despliegue verde azul: </p><br><ul><li>  <em>Asegure la operación de dos copias de su código de producción ("azul" y "verde");</em> </li><li>  <em>dirigir todo el tráfico al entorno azul, es decir</em>  <em>para que las URL de producción se apunten allí;</em> </li><li>  <em>Implemente y pruebe todos los cambios de la aplicación en un entorno verde</em> </li><li>  <em>cambiar las URL del entorno azul al verde</em> </li></ul><br><p>  El despliegue verde azulado es un enfoque que le permite introducir fácilmente nuevas características sin preocuparse de que la producción se interrumpa.  Esto se debe al hecho de que incluso si algo sucede, puede retroceder fácilmente al entorno anterior simplemente haciendo clic en un interruptor. </p><br><p>  Después de leer todo lo anterior, puede hacer la pregunta: ¿Qué tiene que ver el tiempo de inactividad cero con la implementación verde azul? </p><br><p>  Bueno, tienen mucho en común, porque admitir dos copias del mismo entorno requiere un doble esfuerzo para mantenerlas.  Es por eso que algunos equipos, según <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">Martin Fowler</a> , se adhieren a las variaciones de este enfoque: </p><br><p>  <em>Otra opción es utilizar la misma base de datos, creando conmutadores azul-verdes para las capas web y de dominio.</em>  <em>En este enfoque, las bases de datos a menudo pueden ser un problema, especialmente cuando necesita cambiar su esquema para admitir una nueva versión del software.</em> </p><br><p>  Y aquí llegamos al problema principal en este artículo.  <strong>La base de datos</strong>  Echemos otro vistazo a esta frase. </p><br><p>  <em>migrar la base de datos.</em> </p><br><p>  Ahora tiene que hacerse la pregunta: ¿qué sucede si cambiar la base de datos es incompatible con versiones anteriores?  ¿No se romperá mi primera versión de la aplicación?  De hecho, esto es exactamente lo que sucederá ... </p><br><p>  Por lo tanto, incluso a pesar de los enormes beneficios del tiempo de inactividad cero / implementación verde azul, las empresas tienden a seguir el siguiente proceso de implementación más seguro para sus aplicaciones: </p><br><ul><li>  preparar un paquete con una nueva versión de la aplicación </li><li>  cerrar una aplicación en ejecución </li><li>  ejecutar scripts para la migración de la base de datos </li><li>  implementar y lanzar la nueva versión de la aplicación </li></ul><br><p>  En este artículo, describiremos en detalle cómo puede trabajar con una base de datos y un código para aprovechar la implementación de tiempo de inactividad cero. </p><br><h3 id="problemy-s-bazoy-dannyh">  Problemas de base de datos </h3><br><p>  Si tiene una aplicación sin estado que no almacena ningún dato en la base de datos, puede obtener una implementación de tiempo de inactividad cero de inmediato.  Desafortunadamente, la mayoría del software necesita almacenar datos en algún lugar.  Es por eso que debe pensarlo dos veces antes de realizar cambios en el circuito.  Antes de profundizar en los detalles de cómo cambiar el esquema para que sea posible implementarlo sin tiempo de inactividad, centrémonos primero en el esquema de control de versiones. </p><br><h3 id="shema-upravleniya-versiyami">  Esquema de control de versiones </h3><br><p> En este artículo, utilizaremos <a href="https://flywaydb.org/">Flyway</a> como herramienta para el control de versiones ( <em>aprox. Traducción: estamos hablando de migración de bases de datos</em> ).  Naturalmente, también escribiremos una aplicación Spring Boot que tenga soporte Flyway incorporado y migrará el circuito mientras configura el contexto de la aplicación.  Al usar Flyway, puede almacenar scripts de migración en la carpeta de sus proyectos (de manera predeterminada en <code>classpath:db/migration</code> ).  Aquí puede ver un ejemplo de dichos archivos de migración. </p><br><pre> <code class="plaintext hljs">└── db └── migration ├── V1__init.sql ├── V2__Add_surname.sql ├── V3__Final_migration.sql └── V4__Remove_lastname.sql</code> </pre> <br><p>  En este ejemplo, vemos 4 escenarios de migración que, si no se ejecutaron antes, se ejecutarán uno tras otro cuando se inicie la aplicación.  Veamos uno de los archivos ( <code>V1__init.sql</code> ) como ejemplo. </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Todo habla perfectamente por sí mismo: puede usar SQL para determinar cómo se debe modificar su base de datos.  Para obtener más información sobre Spring Boot y Flyway, consulte <a href="https://docs.spring.io/spring-boot/docs/1.3.5.RELEASE/reference/html/howto-database-initialization.html">Spring Boot Docs</a> . </p><br><p>  El uso del control de versiones con Spring Boot le brinda 2 grandes beneficios: </p><br><ul><li>  separa los cambios de la base de datos de los cambios de código </li><li>  la migración de la base de datos ocurre junto con el despliegue de su aplicación, es decir  su proceso de implementación se simplifica </li></ul><br><h2 id="reshenie-problem-s-bazoy-dannyh">  Resolver problemas de la base de datos </h2><br><p>  En la siguiente sección del artículo, nos centraremos en considerar dos enfoques para los cambios en la base de datos. </p><br><ul><li>  incompatibilidad hacia atrás </li><li>  compatibilidad con versiones anteriores </li></ul><br><p>  El primero se considerará como una advertencia de que no debe realizar una implementación de tiempo de inactividad cero sin una preparación preliminar ... El segundo ofrece una solución sobre cómo puede realizar una implementación sin tiempo de inactividad y, al mismo tiempo, mantener la compatibilidad con versiones anteriores. </p><br><p>  Nuestro proyecto, en el que trabajaremos, será una aplicación simple Spring Boot Flyway en la que hay una <code>Person</code> con <code>last_name</code> la base de datos ( <em>aprox. Por <code>Person</code> : <code>Person</code> es una tabla, y <code>irst_name</code> y <code>last_name</code> son los campos en ella</em> ).  Queremos cambiar el <code>last_name</code> de <code>surname</code> por <code>surname</code> . </p><br><h3 id="dopuscheniya">  Supuestos </h3><br><p>  Antes de profundizar en los detalles, necesitamos esbozar un par de suposiciones sobre nuestras aplicaciones.  El principal resultado que queremos lograr será un proceso bastante simple. </p><br><blockquote>  <strong>Nota</strong>  Negocio PRO-TIP.  Los procesos de racionalización pueden ahorrarle mucho dinero en soporte (¡cuanta más gente trabaje en su empresa, más dinero puede ahorrar)! </blockquote><br><h3 id="ne-nado-delat-otkat-bazy-dannyh">  No es necesario revertir la base de datos </h3><br><p>  Esto simplifica el proceso de implementación (algunas reversiones de la base de datos son casi imposibles, por ejemplo, eliminación de reversión).  Preferimos deshacer las aplicaciones solamente.  De esta manera, incluso si tiene bases de datos diferentes (por ejemplo, SQL y NoSQL), su canal de implementación tendrá el mismo aspecto. </p><br><p>  <strong>SIEMPRE debe ser posible revertir la aplicación una versión atrás (no más)</strong> </p><br><p>  La reversión debe hacerse solo si es necesario.  Si hay un error en la versión actual que no es fácil de solucionar, deberíamos poder devolver la última versión de trabajo.  Asumimos que esta última versión de trabajo es la anterior.  Mantener el código y la compatibilidad de la base de datos para más de una implementación sería extremadamente difícil y costoso. </p><br><blockquote>  <strong>Nota</strong>  Para una mayor legibilidad, en el marco de este artículo cambiaremos la versión principal de la aplicación. </blockquote><br><h3 id="shag-1-ishodnoe-sostoyanie">  Paso 1: estado inicial </h3><br><p>  Versión de aplicación: <code>1.0.0</code> <br>  Versión DB: <code>v1</code> </p><br><h3 id="kommentariy">  Comentario </h3><br><p>  Este será el estado inicial de la aplicación. </p><br><h3 id="izmeneniya-bd">  Cambios de DB </h3><br><p>  La base de datos contiene <code>last_name.</code> </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><h3 id="izmeneniya-koda">  Cambios de código </h3><br><p>  La aplicación guarda los datos de la Persona en <code>last_name</code> : </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return this.lastName; } public void setLastName(String lastname) { this.lastName = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + "]"; } }</code> </pre> <br><h3 id="obratno-nesovmestimoe-pereimenovanie-stolbca">  Cambio de nombre de columna incompatible </h3><br><p>  Veamos un ejemplo de cómo cambiar el nombre de una columna: </p><br><blockquote>  <strong>Atencion</strong>  El siguiente ejemplo se romperá intencionalmente.  Mostramos esto para demostrar el problema de compatibilidad de la base de datos. </blockquote><p>  Versión de la aplicación: <code>2.0.0.BAD</code> </p><br><p>  Versión DB: <code>v2bad</code> </p><br><h3 id="kommentariy-1">  Comentario </h3><br><p>  Los cambios actuales NO nos permiten ejecutar dos instancias (antigua y nueva) al mismo tiempo.  Por lo tanto, la implementación de tiempo de inactividad cero será difícil de lograr (suposiciones tomadas en cuenta, esto es prácticamente imposible). </p><br><h3 id="ab-testirovanie">  Pruebas A / B </h3><br><p>  La situación actual es que tenemos una versión de aplicación <code>1.0.0,</code> implementada en prod, y una base de datos <code>v1</code> .  Debemos implementar la segunda instancia de la aplicación, versión <code>2.0.0.BAD</code> , y actualizar la base de datos a <code>v2bad</code> . </p><br><p>  Pasos: </p><br><ol><li>  desplegó una nueva instancia de la aplicación versión <code>2.0.0.BAD</code> , que actualiza la base de datos a <code>v2bad</code> </li><li>  la columna <code>last_name</code> ya no existe en la <code>v2bad</code> datos <code>v2bad</code> , se cambió a <code>surname</code> </li><li>  Las actualizaciones de la base de datos y las aplicaciones fueron exitosas, y algunas instancias funcionan en <code>1.0.0</code> , otras en <code>2.0.0.BAD</code> .  Todo lo relacionado con <code>v2bad</code> </li><li>  todas las instancias de la versión <code>1.0.0</code> comenzarán a arrojar errores porque intentarán insertar datos en la columna <code>last_name</code> , que ya no es </li><li>  todas las instancias de la versión <code>2.0.0.BAD</code> funcionarán sin problemas </li></ol><br><p>  Como puede ver, si hacemos cambios incompatibles con la base de datos y las aplicaciones, las pruebas A / B son imposibles. </p><br><h3 id="otkat-prilozheniya">  Aplicación de reversión </h3><br><p>  Supongamos que después de intentar realizar la implementación A / B ( <em>aprox. Traducción: probablemente, el autor se refería a las pruebas A / B aquí</em> ), decidimos que necesitamos revertir la aplicación a la versión <code>1.0.0.</code>  Supongamos que no queremos revertir la base de datos. </p><br><p>  Pasos: </p><br><ol><li>  paramos la instancia de la aplicación versión <code>2.0.0.BAD</code> </li><li>  la base de datos sigue siendo <code>v2bad</code> </li><li>  <code>1.0.0</code> versión <code>1.0.0</code> no comprende qué <code>surname</code> , veremos errores </li><li>  el infierno se liberó, ya no podemos regresar </li></ol><br><p>  Como puede ver, si realizamos cambios incompatibles con la base de datos y las aplicaciones, no podemos retroceder a la versión anterior. </p><br><h3 id="logi-ispolneniya-skripta">  Registros de ejecución de script </h3><br><pre> <code class="plaintext hljs">Backward incompatible scenario: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0.BAD 05) Wait for the app (2.0.0.BAD) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 &lt;-- this should fail 07) Generate a person by calling POST localhost:9992/person to version 2.0.0.BAD &lt;-- this should pass Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"b73f639f-e176-4463-bf26-1135aace2f57","lastName":"b73f639f-e176-4463-bf26-1135aace2f57"} Starting app in version 2.0.0.BAD Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: curl: (22) The requested URL returned error: 500 Internal Server Error Generate a person in version 2.0.0.BAD Sending a post to 127.0.0.1:9995/person. This is the response: {"firstName":"e156be2e-06b6-4730-9c43-6e14cfcda125","surname":"e156be2e-06b6-4730-9c43-6e14cfcda125"}</code> </pre> <br><h3 id="izmeneniya-bd-1">  Cambios de DB </h3><br><p>  Script de migración que renombra <code>last_name</code> a <code>surname</code> </p><br><p>  Guión de Flyway de origen: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Un script que cambia el nombre de <code>last_name</code> . </p><br><pre> <code class="plaintext hljs">-- This change is backward incompatible - you can't do A/B testing ALTER TABLE PERSON CHANGE last_name surname VARCHAR;</code> </pre> <br><h3 id="izmeneniya-koda-1">  Cambios de código </h3><br><p>  Cambiamos el nombre del campo apellido por <code>surname</code> . </p><br><h3 id="pereimenovanie-stolbca-obratno-sovmestimym-sposobom">  Cambiar el nombre de una columna de forma compatible con versiones anteriores </h3><br><p>  Esta es la situación más común que podemos encontrar.  Necesitamos hacer cambios hacia atrás incompatibles.  Ya hemos demostrado que para una implementación sin tiempo de inactividad, no solo debemos aplicar la migración de la base de datos sin acciones adicionales.  En esta sección del artículo, realizaremos 3 implementaciones de la aplicación junto con las migraciones de la base de datos para lograr el resultado deseado y al mismo tiempo mantener la compatibilidad con versiones anteriores. </p><br><blockquote>  <strong>Nota</strong>  Recordemos que tenemos una versión de base de datos <code>v1</code> .  Contiene las columnas <code>first_name</code> y <code>last_name</code> .  Debemos cambiar el <code>surname</code> por <code>surname</code> .  También tenemos una versión de la aplicación <code>1.0.0,</code> que aún no usa el <code>surname</code> . </blockquote><br><h3 id="shag-2-dobavlyaem-surname">  Paso 2: agregar apellido </h3><br><p>  Versión de aplicación: <code>2.0.0</code> <br>  Versión DB: <code>v2</code> </p><br><h3 id="kommentariy-2">  Comentario </h3><br><p>  Al agregar una nueva columna y copiar su contenido, creamos cambios de bases de datos compatibles con versiones anteriores.  Al mismo tiempo, si revertimos el JAR o tenemos un JAR antiguo que funciona, no se romperá en el tiempo de ejecución. </p><br><h3 id="vykatyvaem-novuyu-versiyu">  Lanzamos la nueva versión </h3><br><p>  Pasos: </p><br><ol><li>  migre la base de datos para crear una nueva columna de <code>surname</code> .  Ahora tu versión de db <code>v2</code> </li><li>  Copie los datos de <code>last_name</code> al <code>surname</code> .  <strong>Tenga en cuenta</strong> que si tiene muchos de estos datos, debe considerar la migración por lotes. </li><li>  escriba el código donde <strong>AMBOS</strong> se utilizan tanto la columna <strong>nueva</strong> como la <strong>antigua</strong> .  Ahora su aplicación versión <code>2.0.0</code> </li><li>  lea el valor de la columna de <code>surname</code> si no es <code>null</code> , o de l <code>ast_name</code> si no se especifica el <code>surname</code> .  Puede eliminar <code>getLastName()</code> del código, ya que devolverá <code>null</code> cuando <code>getLastName()</code> su aplicación de <code>3.0.0</code> a <code>2.0.0</code> . </li></ol><br><p>  Si está utilizando Spring Boot Flyway, estos dos pasos se realizarán durante el lanzamiento de la versión <code>2.0.0</code> aplicación.  Si ejecuta la herramienta de control de versiones de la base de datos manualmente, tendrá que hacer dos cosas diferentes para esto (primero actualice la versión de DB manualmente y luego implemente una nueva aplicación). </p><br><blockquote>  <strong>Es importante</strong>  Recuerde que una columna recién creada <strong>NO</strong> <strong>DEBE</strong> <strong>NO SER NULA</strong> .  Si retrocede, la aplicación anterior no conoce la nueva columna y no la instalará durante la <code>Insert.</code>  Pero si agrega esta restricción, y su base de datos será <code>v2</code> , requerirá establecer el valor de la nueva columna.  Lo que conducirá a violaciones de las restricciones. <br><br>  <strong>Es importante</strong>  Debe eliminar el método <code>getLastName()</code> , ya que la versión <code>3.0.0</code> no tiene el concepto de una columna de <code>last_name</code> en el código.  Esto significa que se establecerá nulo allí.  Puede abandonar el método y agregar comprobaciones <code>null</code> , pero una solución mucho mejor sería asegurarse de que en la lógica <code>getSurname()</code> haya elegido el valor correcto distinto de cero. </blockquote><br><h3 id="ab-testirovanie-1">  Pruebas A / B </h3><br><p>  La situación actual es que tenemos una aplicación versión <code>1.0.0</code> implementada en el producto y una base de datos en <code>v1</code> .  Necesitamos implementar la segunda instancia de la versión <code>2.0.0</code> de la aplicación, que actualizará la base de datos a <code>v2</code> . </p><br><p>  Pasos: </p><br><ol><li>  desplegó una nueva instancia de la versión <code>2.0.0</code> de la aplicación, que actualiza la base de datos a <code>v2</code> </li><li>  Mientras tanto, algunas solicitudes fueron manejadas por instancias de la versión <code>1.0.0</code> </li><li>  la actualización se realizó correctamente y tiene varias instancias de trabajo de la versión de la aplicación <code>1.0.0</code> y el resto de la versión <code>2.0.0.</code>  Todos se comunican con la base de datos en <code>v2</code> </li><li>  la versión <code>1.0.0</code> no utiliza la columna de apellido en la base de datos, pero sí la versión <code>2.0.0</code> .  No interfieren entre sí y no debe haber errores. </li><li>  la versión <code>2.0.0</code> almacena datos en la columna anterior y en la nueva, lo que proporciona compatibilidad con versiones anteriores </li></ol><br><blockquote>  <strong>Es importante</strong>  Si tiene alguna consulta que cuente elementos en función de los valores de la columna antigua / nueva, debe recordar que ahora tiene valores duplicados (lo más probable es que todavía estén migrando).  Por ejemplo, si desea contar el número de usuarios cuyo apellido (no importa cuál sea el nombre de la columna) comienza con la letra <code>A</code> , antes de que se complete la migración de datos ( <code>old</code> → <code>new</code> columna), puede tener datos inconsistentes si ejecuta una consulta en una nueva columna. </blockquote><br><h3 id="otkat-prilozheniya-1">  Aplicación de reversión </h3><br><p>  Ahora tenemos una versión de aplicación <code>2.0.0</code> y una base de datos en <code>v2</code> . </p><br><p>  Pasos: </p><br><ol><li>  revierta su aplicación a la versión <code>1.0.0</code> . </li><li>  la versión <code>1.0.0</code> no utiliza la columna de <code>surname</code> en la base de datos, por lo que la reversión debe ser exitosa </li></ol><br><h3 id="izmeneniya-db">  Cambios de DB </h3><br><p>  La base de datos contiene una columna llamada <code>last_name</code> . </p><br><p>  Guión de Flyway de origen: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  El script para agregar <code>surname</code> . </p><br><blockquote>  <strong>Atencion</strong>  Recuerde que NO PUEDE AGREGAR ninguna restricción NOT NULL a la columna agregada.  Si revierte el JAR, la versión anterior no tiene idea acerca de la columna agregada, y la establecerá automáticamente en NULL.  Si existe tal restricción, la aplicación anterior simplemente se romperá. </blockquote><br><pre> <code class="plaintext hljs">-- NOTE: This field can't have the NOT NULL constraint cause if you rollback, the old version won't know about this field -- and will always set it to NULL ALTER TABLE PERSON ADD surname varchar(255); -- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES UPDATE PERSON SET PERSON.surname = PERSON.last_name</code> </pre> <br><h3 id="izmeneniya-koda-2">  Cambios de código </h3><br><p>  Almacenamos datos tanto en <code>surname</code> como en <code>surname</code> .  Al mismo tiempo, leemos desde <code>last_name</code> , ya que esta columna es más relevante.  Durante el proceso de implementación, algunas solicitudes pueden haber sido manejadas por una instancia de aplicación que aún no se ha actualizado. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } /** * Reading from the new column if it's set. If not the from the old one. * * When migrating from version 1.0.0 -&gt; 2.0.0 this can lead to a possibility that some data in * the surname column is not up to date (during the migration process lastName could have been updated). * In this case one can run yet another migration script after all applications have been deployed in the * new version to ensure that the surname field is updated. * * However it makes sense since when looking at the migration from 2.0.0 -&gt; 3.0.0. In 3.0.0 we no longer * have a notion of lastName at all - so we don't update that column. If we rollback from 3.0.0 -&gt; 2.0.0 if we * would be reading from lastName, then we would have very old data (since not a single datum was inserted * to lastName in version 3.0.0). */ public String getSurname() { return this.surname != null ? this.surname : this.lastName; } /** * Storing both FIRST_NAME and SURNAME entries */ public void setSurname(String surname) { this.lastName = surname; this.surname = surname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-3-udalenie-last_name-iz-koda">  Paso 3: eliminar last_name del código </h3><br><p>  Versión de aplicación: <code>3.0.0</code> </p><br><p>  Versión DB: <code>v3</code> </p><br><h3 id="kommentariy-3">  Comentario </h3><br><p>  <em>Nota</em>  <em>trans .: Aparentemente, el autor copió por error el texto de este bloque del paso 2 en el artículo original. En este paso, se deben realizar cambios en el código de la aplicación para eliminar la funcionalidad que utiliza la columna <code>last_name</code> .</em> </p><br><p>  Al agregar una nueva columna y copiar su contenido, creamos cambios de bases de datos compatibles con versiones anteriores.  Además, si revertimos el JAR o tenemos un JAR antiguo que funciona, no se romperá en tiempo de ejecución. </p><br><h3 id="otkat-prilozheniya-2">  Aplicación de reversión </h3><br><p>  Actualmente tenemos la aplicación versión <code>3.0.0</code> y la base de datos <code>v3</code> .  La versión <code>3.0.0</code> no guarda datos en <code>last_name</code> .  Esto significa que el <code>surname</code> almacena la información más actualizada. </p><br><p>  Pasos: </p><br><ol><li>  revierta su aplicación a la versión <code>2.0.0</code> . </li><li>  La versión <code>2.0.0</code> utiliza el <code>surname</code> y el <code>surname</code> . </li><li>  la versión <code>2.0.0</code> tomará <code>surname</code> si no es nulo, de lo contrario <code>last_name</code> </li></ol><br><h3 id="izmeneniya-bd-2">  Cambios de DB </h3><br><p>  No hay cambios estructurales en la base de datos.  Se ejecuta el siguiente script, que realiza la migración final de datos antiguos: </p><br><pre> <code class="plaintext hljs">-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES -- ALSO WE'RE NOT CHECKING IF WE'RE NOT OVERRIDING EXISTING ENTRIES. WE WOULD HAVE TO COMPARE -- ENTRY VERSIONS TO ENSURE THAT IF THERE IS ALREADY AN ENTRY WITH A HIGHER VERSION NUMBER -- WE WILL NOT OVERRIDE IT. UPDATE PERSON SET PERSON.surname = PERSON.last_name; -- DROPPING THE NOT NULL CONSTRAINT; OTHERWISE YOU WILL TRY TO INSERT NULL VALUE OF THE LAST_NAME -- WITH A NOT_NULL CONSTRAINT. ALTER TABLE PERSON MODIFY COLUMN last_name varchar(255) NULL DEFAULT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-3">  Cambios de código </h3><br><p>  <em>Nota</em>  <em>trans .: La descripción de este bloque también fue copiada erróneamente por el autor del paso 2. De acuerdo con la lógica de la historia del artículo, los cambios en el código en este paso deben estar dirigidos a eliminar de él elementos que funcionan con la columna <code>last_name</code> .</em> </p><br><p>  Almacenamos datos tanto en <code>surname.</code> como en <code>surname.</code>  Además, leemos de la columna <code>last_name</code> , ya que es más relevante.  Durante el proceso de implementación, algunas solicitudes pueden ser procesadas por una instancia que aún no se ha actualizado. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getSurname() { return this.surname; } public void setSurname(String lastname) { this.surname = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-4-udalenie-last_name-iz-bd">  Paso 4: eliminar last_name de la base de datos </h3><br><p>  Versión de aplicación: <code>4.0.0</code> </p><br><p>  Versión DB: <code>v4</code> </p><br><h3 id="kommentariy-4">  Comentario </h3><br><p>  Debido al hecho de que el código de la versión <code>3.0.0</code> no usó la columna <code>last_name</code> , no ocurrirá nada malo durante la ejecución si volvemos a <code>3.0.0</code> después de eliminar la columna de la base de datos. </p><br><h3 id="logi-ispolneniya-skripta-1">  Registros de ejecución de script </h3><br><pre> <code class="plaintext hljs">We will do it in the following way: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0 05) Wait for the app (2.0.0) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 07) Generate a person by calling POST localhost:9992/person to version 2.0.0 08) Kill app (1.0.0) 09) Run 3.0.0 10) Wait for the app (3.0.0) to boot 11) Generate a person by calling POST localhost:9992/person to version 2.0.0 12) Generate a person by calling POST localhost:9993/person to version 3.0.0 13) Kill app (3.0.0) 14) Run 4.0.0 15) Wait for the app (4.0.0) to boot 16) Generate a person by calling POST localhost:9993/person to version 3.0.0 17) Generate a person by calling POST localhost:9994/person to version 4.0.0 Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2","lastName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2"} Starting app in version 2.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"e41ee756-4fa7-4737-b832-e28827a00deb","lastName":"e41ee756-4fa7-4737-b832-e28827a00deb"} Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","lastName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","surname":"0c1240f5-649a-4bc5-8aa9-cff855f3927f"} Killing app 1.0.0 Starting app in version 3.0.0 Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","lastName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","surname":"74d84a9e-5f44-43b8-907c-148c6d26a71b"} Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"c6564dbe-9ab5-40ae-9077-8ae6668d5862","surname":"c6564dbe-9ab5-40ae-9077-8ae6668d5862"} Killing app 2.0.0 Starting app in version 4.0.0 Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"cbe942fc-832e-45e9-a838-0fae25c10a51","surname":"cbe942fc-832e-45e9-a838-0fae25c10a51"} Generate a person in version 4.0.0 Sending a post to 127.0.0.1:9994/person. This is the response: {"firstName":"ff6857ce-9c41-413a-863e-358e2719bf88","surname":"ff6857ce-9c41-413a-863e-358e2719bf88"}</code> </pre> <br><h3 id="izmeneniya-db-1">  Cambios de DB </h3><br><p>  Para <code>v3</code> simplemente <code>last_name</code> columna <code>last_name</code> y agregamos las restricciones que faltan. </p><br><pre> <code class="plaintext hljs">-- REMOVE THE COLUMN ALTER TABLE PERSON DROP last_name; -- ADD CONSTRAINTS UPDATE PERSON SET surname='' WHERE surname IS NULL; ALTER TABLE PERSON ALTER COLUMN surname VARCHAR NOT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-4">  Cambios de código </h3><br><p>  No hay cambios en el código. </p><br><h3 id="vyvod">  Conclusión </h3><br><p>  Aplicamos con éxito el cambio de nombre de columna incompatible con versiones anteriores al realizar varias implementaciones compatibles con versiones anteriores.  A continuación se muestra un resumen de los pasos dados: </p><br><ol><li>  implementación de la aplicación versión <code>1.0.0</code> con esquema de base de datos <code>v1</code> (nombre de columna = <code>last_name</code> ) </li><li>  <code>last_name</code> versión <code>2.0.0,</code> aplicación <code>2.0.0,</code> que guarda los datos en <code>surname</code> y <code>surname</code> .  La aplicación lee desde <code>last_name</code> .  La base de datos está en la versión <code>v2</code> , que contiene las columnas de <code>surname. surname</code> y <code>surname. surname</code>  <code>surname. surname</code> es una copia de l <code>ast_name</code> .  (NOTA: esta columna no debe tener una restricción no nula) </li><li>    <code>3.0.0</code> ,      <code>surname</code>    surname.   ,     <code>last_name</code>  <code>surname</code> .   <strong>NOT NULL</strong>   <code>last_name</code> .     <code>v3</code> </li><li>    <code>4.0.0</code> —      .    <code>v4</code> ,   <code>last_name</code> .         . </li></ol><br><p>   ,        ,      / . </p><br><h3 id="kod">  Código </h3><br><p>  ,    ,   <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">Github</a> .   . </p><br><h3 id="proekty">  Proyectos </h3><br><p>   ,     . </p><br><pre> <code class="plaintext hljs">├── boot-flyway-v1 - 1.0.0 version of the app with v1 of the schema ├── boot-flyway-v2 - 2.0.0 version of the app with v2 of the schema (backward-compatible - app can be rolled back) ├── boot-flyway-v2-bad - 2.0.0.BAD version of the app with v2bad of the schema (backward-incompatible - app cannot be rolled back) ├── boot-flyway-v3 - 3.0.0 version of the app with v3 of the schema (app can be rolled back) └── boot-flyway-v4 - 4.0.0 version of the app with v4 of the schema (app can be rolled back)</code> </pre> <br><h3 id="skripty">  </h3><br><p>    ,    ,         . </p><br><p>   <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_compatible.sh</code> </pre> <br><p>    <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_incompatible.sh</code> </pre> <br><h3 id="spring-boot-sample-flyway"> Spring Boot Sample Flyway </h3><br><p>     <code>Spring Boot Sample Flyway.</code> </p><br><p>     <code>http://localhost:8080/flyway</code> ,   . </p><br><p>        H2 (  <code>http://localhost:8080/h2-console</code> ),        (URL jdbc   — <code>jdbc:h2:mem:testdb</code> ). </p><br><h2 id="dopolnitelno">  Opcional </h2><br><ul><li> <a href="https://databaserefactoring.com/">Database Refactoring patterns</a> </li><li> <a href="https://martinfowler.com/bliki/ContinuousDelivery.html">Continuous Delivery</a> </li></ul><br><h2 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Lea también otros artículos en nuestro blog: </h2><br><ul><li>  <a href="https://habr.com/ru/company/nixys/blog/480072/">Kubernetes: ¿por qué es tan importante configurar la gestión de recursos del sistema?</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/481992/">Tubería Tekton - Tuberías nativas de Kubernetes</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473578/">Construyendo Módulos Dinámicos para Nginx</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473014/">Introducción a la autorización de Kubernetes del cónsul de Hashicorp</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/468779/">¿Cuál fue el resultado de la migración de ClickHouse sin autorización a ClickHouse con autorización?</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/470568/">Implementación azul-verde de aplicaciones Spring con el servidor web Nginx</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/481932/">https://habr.com/ru/post/481932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../481916/index.html">¿Para qué fue recordado el año 2019 en desarrollo?</a></li>
<li><a href="../481922/index.html">Año nuevo IMaskjs 6 - React Native, Pipes, ESM</a></li>
<li><a href="../481924/index.html">Apache Spark, evaluación diferida y consultas SQL de varias páginas</a></li>
<li><a href="../481926/index.html">Conozca la nueva solución Veeam Backup para AWS</a></li>
<li><a href="../481930/index.html">Cultura de desarrollo: cómo se evalúan el rendimiento y la eficiencia</a></li>
<li><a href="../481934/index.html">Análisis: por qué las acciones de Tesla están creciendo en precio</a></li>
<li><a href="../481936/index.html">Pros y contras de las pruebas A / B: experiencia de grandes empresas</a></li>
<li><a href="../481940/index.html">Trabajo rápido y efectivo en línea de comando</a></li>
<li><a href="../481942/index.html">Regreso al futuro: qué juegos modernos se presentaron en 2010</a></li>
<li><a href="../481944/index.html">¿Qué determina la posición del sitio en la página de búsqueda?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>