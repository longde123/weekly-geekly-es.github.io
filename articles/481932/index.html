<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•´ üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø üé∫ Implementaci√≥n de bases de datos y tiempo de inactividad cero üìá üôçüèø ü¶ñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo explica en detalle c√≥mo resolver los problemas asociados con la compatibilidad de la base de datos durante la implementaci√≥n. Le diremos...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementaci√≥n de bases de datos y tiempo de inactividad cero</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/481932/"><p><img src="https://habrastorage.org/webt/hr/vy/qq/hrvyqqi2mmitehw9vx_xklbofj8.png" alt="imagen"></p><br><p>  Este art√≠culo explica en detalle c√≥mo resolver los problemas asociados con la compatibilidad de la base de datos durante la implementaci√≥n.  Le diremos qu√© puede pasarle a sus aplicaciones en el producto si intenta realizar una implementaci√≥n sin ninguna preparaci√≥n preliminar.  Luego, pasaremos por las etapas del ciclo de vida de la aplicaci√≥n, que son necesarias para tener un tiempo de inactividad cero ( <em>aprox. Transl .: m√°s adelante, tiempo de inactividad cero</em> ).  El resultado de nuestras operaciones ser√° la aplicaci√≥n de un cambio de base de datos incompatible con versiones anteriores de una manera compatible con versiones anteriores. </p><a name="habracut"></a><br><p>  Si desea comprender los ejemplos de c√≥digo del art√≠culo, los encontrar√° en <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">GitHub</a> . </p><br><h2 id="vvedenie">  Introduccion </h2><br><h3 id="zero-downtime-deployment">  Implementaci√≥n de tiempo de inactividad cero </h3><br><p>  ¬øCu√°l es la <strong>implementaci√≥n</strong> m√≠stica de <strong>tiempo de inactividad cero</strong> ?  Podemos decir esto cuando su aplicaci√≥n se implementa para que pueda introducir con √©xito una nueva versi√≥n de la aplicaci√≥n para producci√≥n, mientras que el usuario no nota su inaccesibilidad.  Desde el punto de vista del usuario y de la empresa, este es el mejor escenario de implementaci√≥n posible, ya que de esta manera puede introducir nuevas funciones y eliminar errores sin interrupci√≥n. </p><br><p>  ¬øC√≥mo lograr esto?  Hay varias formas, aqu√≠ hay una de ellas: </p><br><ul><li>  expanda la versi√≥n 1 de su servicio </li><li>  migrar la base de datos </li><li>  Implemente la versi√≥n 2 de su servicio en paralelo con la versi√≥n 1 </li><li>  tan pronto como vea que la versi√≥n n√∫mero 2 funciona como deber√≠a, elimine la versi√≥n n√∫mero 1 </li><li>  hecho! </li></ul><br><p>  F√°cil, verdad?  Desafortunadamente, esto no es tan simple, y lo consideraremos en detalle m√°s adelante.  Ahora veamos otro proceso de implementaci√≥n bastante com√∫n: la implementaci√≥n azul verde. </p><br><p>  ¬øAlguna vez has o√≠do hablar del <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">despliegue verde azul</a> ?  Con Cloud Foundry, esto es extremadamente f√°cil de hacer.  Solo eche un vistazo a <a href="https://spring.io/blog/2014/04/04/project-sagan-zero-downtime-deployments">este art√≠culo</a> donde lo describimos con m√°s detalle.  Resumiendo brevemente, recordamos c√≥mo hacer un despliegue verde azul: </p><br><ul><li>  <em>Asegure la operaci√≥n de dos copias de su c√≥digo de producci√≥n ("azul" y "verde");</em> </li><li>  <em>dirigir todo el tr√°fico al entorno azul, es decir</em>  <em>para que las URL de producci√≥n se apunten all√≠;</em> </li><li>  <em>Implemente y pruebe todos los cambios de la aplicaci√≥n en un entorno verde</em> </li><li>  <em>cambiar las URL del entorno azul al verde</em> </li></ul><br><p>  El despliegue verde azulado es un enfoque que le permite introducir f√°cilmente nuevas caracter√≠sticas sin preocuparse de que la producci√≥n se interrumpa.  Esto se debe al hecho de que incluso si algo sucede, puede retroceder f√°cilmente al entorno anterior simplemente haciendo clic en un interruptor. </p><br><p>  Despu√©s de leer todo lo anterior, puede hacer la pregunta: ¬øQu√© tiene que ver el tiempo de inactividad cero con la implementaci√≥n verde azul? </p><br><p>  Bueno, tienen mucho en com√∫n, porque admitir dos copias del mismo entorno requiere un doble esfuerzo para mantenerlas.  Es por eso que algunos equipos, seg√∫n <a href="https://martinfowler.com/bliki/BlueGreenDeployment.html">Martin Fowler</a> , se adhieren a las variaciones de este enfoque: </p><br><p>  <em>Otra opci√≥n es utilizar la misma base de datos, creando conmutadores azul-verdes para las capas web y de dominio.</em>  <em>En este enfoque, las bases de datos a menudo pueden ser un problema, especialmente cuando necesita cambiar su esquema para admitir una nueva versi√≥n del software.</em> </p><br><p>  Y aqu√≠ llegamos al problema principal en este art√≠culo.  <strong>La base de datos</strong>  Echemos otro vistazo a esta frase. </p><br><p>  <em>migrar la base de datos.</em> </p><br><p>  Ahora tiene que hacerse la pregunta: ¬øqu√© sucede si cambiar la base de datos es incompatible con versiones anteriores?  ¬øNo se romper√° mi primera versi√≥n de la aplicaci√≥n?  De hecho, esto es exactamente lo que suceder√° ... </p><br><p>  Por lo tanto, incluso a pesar de los enormes beneficios del tiempo de inactividad cero / implementaci√≥n verde azul, las empresas tienden a seguir el siguiente proceso de implementaci√≥n m√°s seguro para sus aplicaciones: </p><br><ul><li>  preparar un paquete con una nueva versi√≥n de la aplicaci√≥n </li><li>  cerrar una aplicaci√≥n en ejecuci√≥n </li><li>  ejecutar scripts para la migraci√≥n de la base de datos </li><li>  implementar y lanzar la nueva versi√≥n de la aplicaci√≥n </li></ul><br><p>  En este art√≠culo, describiremos en detalle c√≥mo puede trabajar con una base de datos y un c√≥digo para aprovechar la implementaci√≥n de tiempo de inactividad cero. </p><br><h3 id="problemy-s-bazoy-dannyh">  Problemas de base de datos </h3><br><p>  Si tiene una aplicaci√≥n sin estado que no almacena ning√∫n dato en la base de datos, puede obtener una implementaci√≥n de tiempo de inactividad cero de inmediato.  Desafortunadamente, la mayor√≠a del software necesita almacenar datos en alg√∫n lugar.  Es por eso que debe pensarlo dos veces antes de realizar cambios en el circuito.  Antes de profundizar en los detalles de c√≥mo cambiar el esquema para que sea posible implementarlo sin tiempo de inactividad, centr√©monos primero en el esquema de control de versiones. </p><br><h3 id="shema-upravleniya-versiyami">  Esquema de control de versiones </h3><br><p> En este art√≠culo, utilizaremos <a href="https://flywaydb.org/">Flyway</a> como herramienta para el control de versiones ( <em>aprox. Traducci√≥n: estamos hablando de migraci√≥n de bases de datos</em> ).  Naturalmente, tambi√©n escribiremos una aplicaci√≥n Spring Boot que tenga soporte Flyway incorporado y migrar√° el circuito mientras configura el contexto de la aplicaci√≥n.  Al usar Flyway, puede almacenar scripts de migraci√≥n en la carpeta de sus proyectos (de manera predeterminada en <code>classpath:db/migration</code> ).  Aqu√≠ puede ver un ejemplo de dichos archivos de migraci√≥n. </p><br><pre> <code class="plaintext hljs">‚îî‚îÄ‚îÄ db ‚îî‚îÄ‚îÄ migration ‚îú‚îÄ‚îÄ V1__init.sql ‚îú‚îÄ‚îÄ V2__Add_surname.sql ‚îú‚îÄ‚îÄ V3__Final_migration.sql ‚îî‚îÄ‚îÄ V4__Remove_lastname.sql</code> </pre> <br><p>  En este ejemplo, vemos 4 escenarios de migraci√≥n que, si no se ejecutaron antes, se ejecutar√°n uno tras otro cuando se inicie la aplicaci√≥n.  Veamos uno de los archivos ( <code>V1__init.sql</code> ) como ejemplo. </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Todo habla perfectamente por s√≠ mismo: puede usar SQL para determinar c√≥mo se debe modificar su base de datos.  Para obtener m√°s informaci√≥n sobre Spring Boot y Flyway, consulte <a href="https://docs.spring.io/spring-boot/docs/1.3.5.RELEASE/reference/html/howto-database-initialization.html">Spring Boot Docs</a> . </p><br><p>  El uso del control de versiones con Spring Boot le brinda 2 grandes beneficios: </p><br><ul><li>  separa los cambios de la base de datos de los cambios de c√≥digo </li><li>  la migraci√≥n de la base de datos ocurre junto con el despliegue de su aplicaci√≥n, es decir  su proceso de implementaci√≥n se simplifica </li></ul><br><h2 id="reshenie-problem-s-bazoy-dannyh">  Resolver problemas de la base de datos </h2><br><p>  En la siguiente secci√≥n del art√≠culo, nos centraremos en considerar dos enfoques para los cambios en la base de datos. </p><br><ul><li>  incompatibilidad hacia atr√°s </li><li>  compatibilidad con versiones anteriores </li></ul><br><p>  El primero se considerar√° como una advertencia de que no debe realizar una implementaci√≥n de tiempo de inactividad cero sin una preparaci√≥n preliminar ... El segundo ofrece una soluci√≥n sobre c√≥mo puede realizar una implementaci√≥n sin tiempo de inactividad y, al mismo tiempo, mantener la compatibilidad con versiones anteriores. </p><br><p>  Nuestro proyecto, en el que trabajaremos, ser√° una aplicaci√≥n simple Spring Boot Flyway en la que hay una <code>Person</code> con <code>last_name</code> la base de datos ( <em>aprox. Por <code>Person</code> : <code>Person</code> es una tabla, y <code>irst_name</code> y <code>last_name</code> son los campos en ella</em> ).  Queremos cambiar el <code>last_name</code> de <code>surname</code> por <code>surname</code> . </p><br><h3 id="dopuscheniya">  Supuestos </h3><br><p>  Antes de profundizar en los detalles, necesitamos esbozar un par de suposiciones sobre nuestras aplicaciones.  El principal resultado que queremos lograr ser√° un proceso bastante simple. </p><br><blockquote>  <strong>Nota</strong>  Negocio PRO-TIP.  Los procesos de racionalizaci√≥n pueden ahorrarle mucho dinero en soporte (¬°cuanta m√°s gente trabaje en su empresa, m√°s dinero puede ahorrar)! </blockquote><br><h3 id="ne-nado-delat-otkat-bazy-dannyh">  No es necesario revertir la base de datos </h3><br><p>  Esto simplifica el proceso de implementaci√≥n (algunas reversiones de la base de datos son casi imposibles, por ejemplo, eliminaci√≥n de reversi√≥n).  Preferimos deshacer las aplicaciones solamente.  De esta manera, incluso si tiene bases de datos diferentes (por ejemplo, SQL y NoSQL), su canal de implementaci√≥n tendr√° el mismo aspecto. </p><br><p>  <strong>SIEMPRE debe ser posible revertir la aplicaci√≥n una versi√≥n atr√°s (no m√°s)</strong> </p><br><p>  La reversi√≥n debe hacerse solo si es necesario.  Si hay un error en la versi√≥n actual que no es f√°cil de solucionar, deber√≠amos poder devolver la √∫ltima versi√≥n de trabajo.  Asumimos que esta √∫ltima versi√≥n de trabajo es la anterior.  Mantener el c√≥digo y la compatibilidad de la base de datos para m√°s de una implementaci√≥n ser√≠a extremadamente dif√≠cil y costoso. </p><br><blockquote>  <strong>Nota</strong>  Para una mayor legibilidad, en el marco de este art√≠culo cambiaremos la versi√≥n principal de la aplicaci√≥n. </blockquote><br><h3 id="shag-1-ishodnoe-sostoyanie">  Paso 1: estado inicial </h3><br><p>  Versi√≥n de aplicaci√≥n: <code>1.0.0</code> <br>  Versi√≥n DB: <code>v1</code> </p><br><h3 id="kommentariy">  Comentario </h3><br><p>  Este ser√° el estado inicial de la aplicaci√≥n. </p><br><h3 id="izmeneniya-bd">  Cambios de DB </h3><br><p>  La base de datos contiene <code>last_name.</code> </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><h3 id="izmeneniya-koda">  Cambios de c√≥digo </h3><br><p>  La aplicaci√≥n guarda los datos de la Persona en <code>last_name</code> : </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getLastName() { return this.lastName; } public void setLastName(String lastname) { this.lastName = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + "]"; } }</code> </pre> <br><h3 id="obratno-nesovmestimoe-pereimenovanie-stolbca">  Cambio de nombre de columna incompatible </h3><br><p>  Veamos un ejemplo de c√≥mo cambiar el nombre de una columna: </p><br><blockquote>  <strong>Atencion</strong>  El siguiente ejemplo se romper√° intencionalmente.  Mostramos esto para demostrar el problema de compatibilidad de la base de datos. </blockquote><p>  Versi√≥n de la aplicaci√≥n: <code>2.0.0.BAD</code> </p><br><p>  Versi√≥n DB: <code>v2bad</code> </p><br><h3 id="kommentariy-1">  Comentario </h3><br><p>  Los cambios actuales NO nos permiten ejecutar dos instancias (antigua y nueva) al mismo tiempo.  Por lo tanto, la implementaci√≥n de tiempo de inactividad cero ser√° dif√≠cil de lograr (suposiciones tomadas en cuenta, esto es pr√°cticamente imposible). </p><br><h3 id="ab-testirovanie">  Pruebas A / B </h3><br><p>  La situaci√≥n actual es que tenemos una versi√≥n de aplicaci√≥n <code>1.0.0,</code> implementada en prod, y una base de datos <code>v1</code> .  Debemos implementar la segunda instancia de la aplicaci√≥n, versi√≥n <code>2.0.0.BAD</code> , y actualizar la base de datos a <code>v2bad</code> . </p><br><p>  Pasos: </p><br><ol><li>  despleg√≥ una nueva instancia de la aplicaci√≥n versi√≥n <code>2.0.0.BAD</code> , que actualiza la base de datos a <code>v2bad</code> </li><li>  la columna <code>last_name</code> ya no existe en la <code>v2bad</code> datos <code>v2bad</code> , se cambi√≥ a <code>surname</code> </li><li>  Las actualizaciones de la base de datos y las aplicaciones fueron exitosas, y algunas instancias funcionan en <code>1.0.0</code> , otras en <code>2.0.0.BAD</code> .  Todo lo relacionado con <code>v2bad</code> </li><li>  todas las instancias de la versi√≥n <code>1.0.0</code> comenzar√°n a arrojar errores porque intentar√°n insertar datos en la columna <code>last_name</code> , que ya no es </li><li>  todas las instancias de la versi√≥n <code>2.0.0.BAD</code> funcionar√°n sin problemas </li></ol><br><p>  Como puede ver, si hacemos cambios incompatibles con la base de datos y las aplicaciones, las pruebas A / B son imposibles. </p><br><h3 id="otkat-prilozheniya">  Aplicaci√≥n de reversi√≥n </h3><br><p>  Supongamos que despu√©s de intentar realizar la implementaci√≥n A / B ( <em>aprox. Traducci√≥n: probablemente, el autor se refer√≠a a las pruebas A / B aqu√≠</em> ), decidimos que necesitamos revertir la aplicaci√≥n a la versi√≥n <code>1.0.0.</code>  Supongamos que no queremos revertir la base de datos. </p><br><p>  Pasos: </p><br><ol><li>  paramos la instancia de la aplicaci√≥n versi√≥n <code>2.0.0.BAD</code> </li><li>  la base de datos sigue siendo <code>v2bad</code> </li><li>  <code>1.0.0</code> versi√≥n <code>1.0.0</code> no comprende qu√© <code>surname</code> , veremos errores </li><li>  el infierno se liber√≥, ya no podemos regresar </li></ol><br><p>  Como puede ver, si realizamos cambios incompatibles con la base de datos y las aplicaciones, no podemos retroceder a la versi√≥n anterior. </p><br><h3 id="logi-ispolneniya-skripta">  Registros de ejecuci√≥n de script </h3><br><pre> <code class="plaintext hljs">Backward incompatible scenario: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0.BAD 05) Wait for the app (2.0.0.BAD) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 &lt;-- this should fail 07) Generate a person by calling POST localhost:9992/person to version 2.0.0.BAD &lt;-- this should pass Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"b73f639f-e176-4463-bf26-1135aace2f57","lastName":"b73f639f-e176-4463-bf26-1135aace2f57"} Starting app in version 2.0.0.BAD Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: curl: (22) The requested URL returned error: 500 Internal Server Error Generate a person in version 2.0.0.BAD Sending a post to 127.0.0.1:9995/person. This is the response: {"firstName":"e156be2e-06b6-4730-9c43-6e14cfcda125","surname":"e156be2e-06b6-4730-9c43-6e14cfcda125"}</code> </pre> <br><h3 id="izmeneniya-bd-1">  Cambios de DB </h3><br><p>  Script de migraci√≥n que renombra <code>last_name</code> a <code>surname</code> </p><br><p>  Gui√≥n de Flyway de origen: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  Un script que cambia el nombre de <code>last_name</code> . </p><br><pre> <code class="plaintext hljs">-- This change is backward incompatible - you can't do A/B testing ALTER TABLE PERSON CHANGE last_name surname VARCHAR;</code> </pre> <br><h3 id="izmeneniya-koda-1">  Cambios de c√≥digo </h3><br><p>  Cambiamos el nombre del campo apellido por <code>surname</code> . </p><br><h3 id="pereimenovanie-stolbca-obratno-sovmestimym-sposobom">  Cambiar el nombre de una columna de forma compatible con versiones anteriores </h3><br><p>  Esta es la situaci√≥n m√°s com√∫n que podemos encontrar.  Necesitamos hacer cambios hacia atr√°s incompatibles.  Ya hemos demostrado que para una implementaci√≥n sin tiempo de inactividad, no solo debemos aplicar la migraci√≥n de la base de datos sin acciones adicionales.  En esta secci√≥n del art√≠culo, realizaremos 3 implementaciones de la aplicaci√≥n junto con las migraciones de la base de datos para lograr el resultado deseado y al mismo tiempo mantener la compatibilidad con versiones anteriores. </p><br><blockquote>  <strong>Nota</strong>  Recordemos que tenemos una versi√≥n de base de datos <code>v1</code> .  Contiene las columnas <code>first_name</code> y <code>last_name</code> .  Debemos cambiar el <code>surname</code> por <code>surname</code> .  Tambi√©n tenemos una versi√≥n de la aplicaci√≥n <code>1.0.0,</code> que a√∫n no usa el <code>surname</code> . </blockquote><br><h3 id="shag-2-dobavlyaem-surname">  Paso 2: agregar apellido </h3><br><p>  Versi√≥n de aplicaci√≥n: <code>2.0.0</code> <br>  Versi√≥n DB: <code>v2</code> </p><br><h3 id="kommentariy-2">  Comentario </h3><br><p>  Al agregar una nueva columna y copiar su contenido, creamos cambios de bases de datos compatibles con versiones anteriores.  Al mismo tiempo, si revertimos el JAR o tenemos un JAR antiguo que funciona, no se romper√° en el tiempo de ejecuci√≥n. </p><br><h3 id="vykatyvaem-novuyu-versiyu">  Lanzamos la nueva versi√≥n </h3><br><p>  Pasos: </p><br><ol><li>  migre la base de datos para crear una nueva columna de <code>surname</code> .  Ahora tu versi√≥n de db <code>v2</code> </li><li>  Copie los datos de <code>last_name</code> al <code>surname</code> .  <strong>Tenga en cuenta</strong> que si tiene muchos de estos datos, debe considerar la migraci√≥n por lotes. </li><li>  escriba el c√≥digo donde <strong>AMBOS</strong> se utilizan tanto la columna <strong>nueva</strong> como la <strong>antigua</strong> .  Ahora su aplicaci√≥n versi√≥n <code>2.0.0</code> </li><li>  lea el valor de la columna de <code>surname</code> si no es <code>null</code> , o de l <code>ast_name</code> si no se especifica el <code>surname</code> .  Puede eliminar <code>getLastName()</code> del c√≥digo, ya que devolver√° <code>null</code> cuando <code>getLastName()</code> su aplicaci√≥n de <code>3.0.0</code> a <code>2.0.0</code> . </li></ol><br><p>  Si est√° utilizando Spring Boot Flyway, estos dos pasos se realizar√°n durante el lanzamiento de la versi√≥n <code>2.0.0</code> aplicaci√≥n.  Si ejecuta la herramienta de control de versiones de la base de datos manualmente, tendr√° que hacer dos cosas diferentes para esto (primero actualice la versi√≥n de DB manualmente y luego implemente una nueva aplicaci√≥n). </p><br><blockquote>  <strong>Es importante</strong>  Recuerde que una columna reci√©n creada <strong>NO</strong> <strong>DEBE</strong> <strong>NO SER NULA</strong> .  Si retrocede, la aplicaci√≥n anterior no conoce la nueva columna y no la instalar√° durante la <code>Insert.</code>  Pero si agrega esta restricci√≥n, y su base de datos ser√° <code>v2</code> , requerir√° establecer el valor de la nueva columna.  Lo que conducir√° a violaciones de las restricciones. <br><br>  <strong>Es importante</strong>  Debe eliminar el m√©todo <code>getLastName()</code> , ya que la versi√≥n <code>3.0.0</code> no tiene el concepto de una columna de <code>last_name</code> en el c√≥digo.  Esto significa que se establecer√° nulo all√≠.  Puede abandonar el m√©todo y agregar comprobaciones <code>null</code> , pero una soluci√≥n mucho mejor ser√≠a asegurarse de que en la l√≥gica <code>getSurname()</code> haya elegido el valor correcto distinto de cero. </blockquote><br><h3 id="ab-testirovanie-1">  Pruebas A / B </h3><br><p>  La situaci√≥n actual es que tenemos una aplicaci√≥n versi√≥n <code>1.0.0</code> implementada en el producto y una base de datos en <code>v1</code> .  Necesitamos implementar la segunda instancia de la versi√≥n <code>2.0.0</code> de la aplicaci√≥n, que actualizar√° la base de datos a <code>v2</code> . </p><br><p>  Pasos: </p><br><ol><li>  despleg√≥ una nueva instancia de la versi√≥n <code>2.0.0</code> de la aplicaci√≥n, que actualiza la base de datos a <code>v2</code> </li><li>  Mientras tanto, algunas solicitudes fueron manejadas por instancias de la versi√≥n <code>1.0.0</code> </li><li>  la actualizaci√≥n se realiz√≥ correctamente y tiene varias instancias de trabajo de la versi√≥n de la aplicaci√≥n <code>1.0.0</code> y el resto de la versi√≥n <code>2.0.0.</code>  Todos se comunican con la base de datos en <code>v2</code> </li><li>  la versi√≥n <code>1.0.0</code> no utiliza la columna de apellido en la base de datos, pero s√≠ la versi√≥n <code>2.0.0</code> .  No interfieren entre s√≠ y no debe haber errores. </li><li>  la versi√≥n <code>2.0.0</code> almacena datos en la columna anterior y en la nueva, lo que proporciona compatibilidad con versiones anteriores </li></ol><br><blockquote>  <strong>Es importante</strong>  Si tiene alguna consulta que cuente elementos en funci√≥n de los valores de la columna antigua / nueva, debe recordar que ahora tiene valores duplicados (lo m√°s probable es que todav√≠a est√©n migrando).  Por ejemplo, si desea contar el n√∫mero de usuarios cuyo apellido (no importa cu√°l sea el nombre de la columna) comienza con la letra <code>A</code> , antes de que se complete la migraci√≥n de datos ( <code>old</code> ‚Üí <code>new</code> columna), puede tener datos inconsistentes si ejecuta una consulta en una nueva columna. </blockquote><br><h3 id="otkat-prilozheniya-1">  Aplicaci√≥n de reversi√≥n </h3><br><p>  Ahora tenemos una versi√≥n de aplicaci√≥n <code>2.0.0</code> y una base de datos en <code>v2</code> . </p><br><p>  Pasos: </p><br><ol><li>  revierta su aplicaci√≥n a la versi√≥n <code>1.0.0</code> . </li><li>  la versi√≥n <code>1.0.0</code> no utiliza la columna de <code>surname</code> en la base de datos, por lo que la reversi√≥n debe ser exitosa </li></ol><br><h3 id="izmeneniya-db">  Cambios de DB </h3><br><p>  La base de datos contiene una columna llamada <code>last_name</code> . </p><br><p>  Gui√≥n de Flyway de origen: </p><br><pre> <code class="plaintext hljs">CREATE TABLE PERSON ( id BIGINT GENERATED BY DEFAULT AS IDENTITY, first_name varchar(255) not null, last_name varchar(255) not null ); insert into PERSON (first_name, last_name) values ('Dave', 'Syer');</code> </pre> <br><p>  El script para agregar <code>surname</code> . </p><br><blockquote>  <strong>Atencion</strong>  Recuerde que NO PUEDE AGREGAR ninguna restricci√≥n NOT NULL a la columna agregada.  Si revierte el JAR, la versi√≥n anterior no tiene idea acerca de la columna agregada, y la establecer√° autom√°ticamente en NULL.  Si existe tal restricci√≥n, la aplicaci√≥n anterior simplemente se romper√°. </blockquote><br><pre> <code class="plaintext hljs">-- NOTE: This field can't have the NOT NULL constraint cause if you rollback, the old version won't know about this field -- and will always set it to NULL ALTER TABLE PERSON ADD surname varchar(255); -- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES UPDATE PERSON SET PERSON.surname = PERSON.last_name</code> </pre> <br><h3 id="izmeneniya-koda-2">  Cambios de c√≥digo </h3><br><p>  Almacenamos datos tanto en <code>surname</code> como en <code>surname</code> .  Al mismo tiempo, leemos desde <code>last_name</code> , ya que esta columna es m√°s relevante.  Durante el proceso de implementaci√≥n, algunas solicitudes pueden haber sido manejadas por una instancia de aplicaci√≥n que a√∫n no se ha actualizado. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String lastName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } /** * Reading from the new column if it's set. If not the from the old one. * * When migrating from version 1.0.0 -&gt; 2.0.0 this can lead to a possibility that some data in * the surname column is not up to date (during the migration process lastName could have been updated). * In this case one can run yet another migration script after all applications have been deployed in the * new version to ensure that the surname field is updated. * * However it makes sense since when looking at the migration from 2.0.0 -&gt; 3.0.0. In 3.0.0 we no longer * have a notion of lastName at all - so we don't update that column. If we rollback from 3.0.0 -&gt; 2.0.0 if we * would be reading from lastName, then we would have very old data (since not a single datum was inserted * to lastName in version 3.0.0). */ public String getSurname() { return this.surname != null ? this.surname : this.lastName; } /** * Storing both FIRST_NAME and SURNAME entries */ public void setSurname(String surname) { this.lastName = surname; this.surname = surname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", lastName=" + this.lastName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-3-udalenie-last_name-iz-koda">  Paso 3: eliminar last_name del c√≥digo </h3><br><p>  Versi√≥n de aplicaci√≥n: <code>3.0.0</code> </p><br><p>  Versi√≥n DB: <code>v3</code> </p><br><h3 id="kommentariy-3">  Comentario </h3><br><p>  <em>Nota</em>  <em>trans .: Aparentemente, el autor copi√≥ por error el texto de este bloque del paso 2 en el art√≠culo original. En este paso, se deben realizar cambios en el c√≥digo de la aplicaci√≥n para eliminar la funcionalidad que utiliza la columna <code>last_name</code> .</em> </p><br><p>  Al agregar una nueva columna y copiar su contenido, creamos cambios de bases de datos compatibles con versiones anteriores.  Adem√°s, si revertimos el JAR o tenemos un JAR antiguo que funciona, no se romper√° en tiempo de ejecuci√≥n. </p><br><h3 id="otkat-prilozheniya-2">  Aplicaci√≥n de reversi√≥n </h3><br><p>  Actualmente tenemos la aplicaci√≥n versi√≥n <code>3.0.0</code> y la base de datos <code>v3</code> .  La versi√≥n <code>3.0.0</code> no guarda datos en <code>last_name</code> .  Esto significa que el <code>surname</code> almacena la informaci√≥n m√°s actualizada. </p><br><p>  Pasos: </p><br><ol><li>  revierta su aplicaci√≥n a la versi√≥n <code>2.0.0</code> . </li><li>  La versi√≥n <code>2.0.0</code> utiliza el <code>surname</code> y el <code>surname</code> . </li><li>  la versi√≥n <code>2.0.0</code> tomar√° <code>surname</code> si no es nulo, de lo contrario <code>last_name</code> </li></ol><br><h3 id="izmeneniya-bd-2">  Cambios de DB </h3><br><p>  No hay cambios estructurales en la base de datos.  Se ejecuta el siguiente script, que realiza la migraci√≥n final de datos antiguos: </p><br><pre> <code class="plaintext hljs">-- WE'RE ASSUMING THAT IT'S A FAST MIGRATION - OTHERWISE WE WOULD HAVE TO MIGRATE IN BATCHES -- ALSO WE'RE NOT CHECKING IF WE'RE NOT OVERRIDING EXISTING ENTRIES. WE WOULD HAVE TO COMPARE -- ENTRY VERSIONS TO ENSURE THAT IF THERE IS ALREADY AN ENTRY WITH A HIGHER VERSION NUMBER -- WE WILL NOT OVERRIDE IT. UPDATE PERSON SET PERSON.surname = PERSON.last_name; -- DROPPING THE NOT NULL CONSTRAINT; OTHERWISE YOU WILL TRY TO INSERT NULL VALUE OF THE LAST_NAME -- WITH A NOT_NULL CONSTRAINT. ALTER TABLE PERSON MODIFY COLUMN last_name varchar(255) NULL DEFAULT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-3">  Cambios de c√≥digo </h3><br><p>  <em>Nota</em>  <em>trans .: La descripci√≥n de este bloque tambi√©n fue copiada err√≥neamente por el autor del paso 2. De acuerdo con la l√≥gica de la historia del art√≠culo, los cambios en el c√≥digo en este paso deben estar dirigidos a eliminar de √©l elementos que funcionan con la columna <code>last_name</code> .</em> </p><br><p>  Almacenamos datos tanto en <code>surname.</code> como en <code>surname.</code>  Adem√°s, leemos de la columna <code>last_name</code> , ya que es m√°s relevante.  Durante el proceso de implementaci√≥n, algunas solicitudes pueden ser procesadas por una instancia que a√∫n no se ha actualizado. </p><br><pre> <code class="plaintext hljs">/* * Copyright 2012-2016 the original author or authors. * * Licensed under the Apache License, Version 2.0 (the "License"); * you may not use this file except in compliance with the License. * You may obtain a copy of the License at * * http://www.apache.org/licenses/LICENSE-2.0 * * Unless required by applicable law or agreed to in writing, software * distributed under the License is distributed on an "AS IS" BASIS, * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. * See the License for the specific language governing permissions and * limitations under the License. */ package sample.flyway; import javax.persistence.Entity; import javax.persistence.GeneratedValue; import javax.persistence.Id; @Entity public class Person { @Id @GeneratedValue private Long id; private String firstName; private String surname; public String getFirstName() { return this.firstName; } public void setFirstName(String firstName) { this.firstName = firstName; } public String getSurname() { return this.surname; } public void setSurname(String lastname) { this.surname = lastname; } @Override public String toString() { return "Person [firstName=" + this.firstName + ", surname=" + this.surname + "]"; } }</code> </pre> <br><h3 id="shag-4-udalenie-last_name-iz-bd">  Paso 4: eliminar last_name de la base de datos </h3><br><p>  Versi√≥n de aplicaci√≥n: <code>4.0.0</code> </p><br><p>  Versi√≥n DB: <code>v4</code> </p><br><h3 id="kommentariy-4">  Comentario </h3><br><p>  Debido al hecho de que el c√≥digo de la versi√≥n <code>3.0.0</code> no us√≥ la columna <code>last_name</code> , no ocurrir√° nada malo durante la ejecuci√≥n si volvemos a <code>3.0.0</code> despu√©s de eliminar la columna de la base de datos. </p><br><h3 id="logi-ispolneniya-skripta-1">  Registros de ejecuci√≥n de script </h3><br><pre> <code class="plaintext hljs">We will do it in the following way: 01) Run 1.0.0 02) Wait for the app (1.0.0) to boot 03) Generate a person by calling POST localhost:9991/person to version 1.0.0 04) Run 2.0.0 05) Wait for the app (2.0.0) to boot 06) Generate a person by calling POST localhost:9991/person to version 1.0.0 07) Generate a person by calling POST localhost:9992/person to version 2.0.0 08) Kill app (1.0.0) 09) Run 3.0.0 10) Wait for the app (3.0.0) to boot 11) Generate a person by calling POST localhost:9992/person to version 2.0.0 12) Generate a person by calling POST localhost:9993/person to version 3.0.0 13) Kill app (3.0.0) 14) Run 4.0.0 15) Wait for the app (4.0.0) to boot 16) Generate a person by calling POST localhost:9993/person to version 3.0.0 17) Generate a person by calling POST localhost:9994/person to version 4.0.0 Starting app in version 1.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2","lastName":"52b6e125-4a5c-429b-a47a-ef18bbc639d2"} Starting app in version 2.0.0 Generate a person in version 1.0.0 Sending a post to 127.0.0.1:9991/person. This is the response: {"firstName":"e41ee756-4fa7-4737-b832-e28827a00deb","lastName":"e41ee756-4fa7-4737-b832-e28827a00deb"} Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","lastName":"0c1240f5-649a-4bc5-8aa9-cff855f3927f","surname":"0c1240f5-649a-4bc5-8aa9-cff855f3927f"} Killing app 1.0.0 Starting app in version 3.0.0 Generate a person in version 2.0.0 Sending a post to 127.0.0.1:9992/person. This is the response: {"firstName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","lastName":"74d84a9e-5f44-43b8-907c-148c6d26a71b","surname":"74d84a9e-5f44-43b8-907c-148c6d26a71b"} Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"c6564dbe-9ab5-40ae-9077-8ae6668d5862","surname":"c6564dbe-9ab5-40ae-9077-8ae6668d5862"} Killing app 2.0.0 Starting app in version 4.0.0 Generate a person in version 3.0.0 Sending a post to 127.0.0.1:9993/person. This is the response: {"firstName":"cbe942fc-832e-45e9-a838-0fae25c10a51","surname":"cbe942fc-832e-45e9-a838-0fae25c10a51"} Generate a person in version 4.0.0 Sending a post to 127.0.0.1:9994/person. This is the response: {"firstName":"ff6857ce-9c41-413a-863e-358e2719bf88","surname":"ff6857ce-9c41-413a-863e-358e2719bf88"}</code> </pre> <br><h3 id="izmeneniya-db-1">  Cambios de DB </h3><br><p>  Para <code>v3</code> simplemente <code>last_name</code> columna <code>last_name</code> y agregamos las restricciones que faltan. </p><br><pre> <code class="plaintext hljs">-- REMOVE THE COLUMN ALTER TABLE PERSON DROP last_name; -- ADD CONSTRAINTS UPDATE PERSON SET surname='' WHERE surname IS NULL; ALTER TABLE PERSON ALTER COLUMN surname VARCHAR NOT NULL;</code> </pre> <br><h3 id="izmeneniya-koda-4">  Cambios de c√≥digo </h3><br><p>  No hay cambios en el c√≥digo. </p><br><h3 id="vyvod">  Conclusi√≥n </h3><br><p>  Aplicamos con √©xito el cambio de nombre de columna incompatible con versiones anteriores al realizar varias implementaciones compatibles con versiones anteriores.  A continuaci√≥n se muestra un resumen de los pasos dados: </p><br><ol><li>  implementaci√≥n de la aplicaci√≥n versi√≥n <code>1.0.0</code> con esquema de base de datos <code>v1</code> (nombre de columna = <code>last_name</code> ) </li><li>  <code>last_name</code> versi√≥n <code>2.0.0,</code> aplicaci√≥n <code>2.0.0,</code> que guarda los datos en <code>surname</code> y <code>surname</code> .  La aplicaci√≥n lee desde <code>last_name</code> .  La base de datos est√° en la versi√≥n <code>v2</code> , que contiene las columnas de <code>surname. surname</code> y <code>surname. surname</code>  <code>surname. surname</code> es una copia de l <code>ast_name</code> .  (NOTA: esta columna no debe tener una restricci√≥n no nula) </li><li>    <code>3.0.0</code> ,      <code>surname</code>    surname.   ,     <code>last_name</code>  <code>surname</code> .   <strong>NOT NULL</strong>   <code>last_name</code> .     <code>v3</code> </li><li>    <code>4.0.0</code> ‚Äî      .    <code>v4</code> ,   <code>last_name</code> .         . </li></ol><br><p>   ,        ,      / . </p><br><h3 id="kod">  C√≥digo </h3><br><p>  ,    ,   <a href="https://github.com/spring-cloud-samples/zero-downtime-deployment">Github</a> .   . </p><br><h3 id="proekty">  Proyectos </h3><br><p>   ,     . </p><br><pre> <code class="plaintext hljs">‚îú‚îÄ‚îÄ boot-flyway-v1 - 1.0.0 version of the app with v1 of the schema ‚îú‚îÄ‚îÄ boot-flyway-v2 - 2.0.0 version of the app with v2 of the schema (backward-compatible - app can be rolled back) ‚îú‚îÄ‚îÄ boot-flyway-v2-bad - 2.0.0.BAD version of the app with v2bad of the schema (backward-incompatible - app cannot be rolled back) ‚îú‚îÄ‚îÄ boot-flyway-v3 - 3.0.0 version of the app with v3 of the schema (app can be rolled back) ‚îî‚îÄ‚îÄ boot-flyway-v4 - 4.0.0 version of the app with v4 of the schema (app can be rolled back)</code> </pre> <br><h3 id="skripty">  </h3><br><p>    ,    ,         . </p><br><p>   <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_compatible.sh</code> </pre> <br><p>    <strong>    </strong> , : </p><br><pre> <code class="plaintext hljs">./scripts/scenario_backward_incompatible.sh</code> </pre> <br><h3 id="spring-boot-sample-flyway"> Spring Boot Sample Flyway </h3><br><p>     <code>Spring Boot Sample Flyway.</code> </p><br><p>     <code>http://localhost:8080/flyway</code> ,   . </p><br><p>        H2 (  <code>http://localhost:8080/h2-console</code> ),        (URL jdbc   ‚Äî <code>jdbc:h2:mem:testdb</code> ). </p><br><h2 id="dopolnitelno">  Opcional </h2><br><ul><li> <a href="https://databaserefactoring.com/">Database Refactoring patterns</a> </li><li> <a href="https://martinfowler.com/bliki/ContinuousDelivery.html">Continuous Delivery</a> </li></ul><br><h2 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Lea tambi√©n otros art√≠culos en nuestro blog: </h2><br><ul><li>  <a href="https://habr.com/ru/company/nixys/blog/480072/">Kubernetes: ¬øpor qu√© es tan importante configurar la gesti√≥n de recursos del sistema?</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/481992/">Tuber√≠a Tekton - Tuber√≠as nativas de Kubernetes</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473578/">Construyendo M√≥dulos Din√°micos para Nginx</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/473014/">Introducci√≥n a la autorizaci√≥n de Kubernetes del c√≥nsul de Hashicorp</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/468779/">¬øCu√°l fue el resultado de la migraci√≥n de ClickHouse sin autorizaci√≥n a ClickHouse con autorizaci√≥n?</a> </li><li>  <a href="https://habr.com/ru/company/nixys/blog/470568/">Implementaci√≥n azul-verde de aplicaciones Spring con el servidor web Nginx</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/481932/">https://habr.com/ru/post/481932/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../481916/index.html">¬øPara qu√© fue recordado el a√±o 2019 en desarrollo?</a></li>
<li><a href="../481922/index.html">A√±o nuevo IMaskjs 6 - React Native, Pipes, ESM</a></li>
<li><a href="../481924/index.html">Apache Spark, evaluaci√≥n diferida y consultas SQL de varias p√°ginas</a></li>
<li><a href="../481926/index.html">Conozca la nueva soluci√≥n Veeam Backup para AWS</a></li>
<li><a href="../481930/index.html">Cultura de desarrollo: c√≥mo se eval√∫an el rendimiento y la eficiencia</a></li>
<li><a href="../481934/index.html">An√°lisis: por qu√© las acciones de Tesla est√°n creciendo en precio</a></li>
<li><a href="../481936/index.html">Pros y contras de las pruebas A / B: experiencia de grandes empresas</a></li>
<li><a href="../481940/index.html">Trabajo r√°pido y efectivo en l√≠nea de comando</a></li>
<li><a href="../481942/index.html">Regreso al futuro: qu√© juegos modernos se presentaron en 2010</a></li>
<li><a href="../481944/index.html">¬øQu√© determina la posici√≥n del sitio en la p√°gina de b√∫squeda?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>