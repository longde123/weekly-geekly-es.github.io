<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöµ üëàüèΩ ü§ï Ex√©cutez des scripts PHP via php-fpm sans serveur Web. Ou votre client FastCGI (sous le capot) üêøÔ∏è ü§æüèæ üôåüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je souhaite la bienvenue √† tous les lecteurs de "Habr". 
 Clause de non-responsabilit√© 


 L'article s'est av√©r√© assez long et pour ceux qui ne veulen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ex√©cutez des scripts PHP via php-fpm sans serveur Web. Ou votre client FastCGI (sous le capot)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472190/"><p>  Je souhaite la bienvenue √† tous les lecteurs de "Habr". </p><br><h4 id="diskleymer">  Clause de non-responsabilit√© </h4><br><p>  L'article s'est av√©r√© assez long et pour ceux qui ne veulent pas lire le fond, mais veulent aller droit au but, je vous pose directement le chapitre "Solution". </p><br><h3 id="vstuplenie">  Entr√©e </h3><br><p>  Dans cet article, je voudrais parler de la r√©solution d'un probl√®me plut√¥t non standard auquel j'ai d√ª faire face pendant le processus de travail.  √Ä savoir, nous devions ex√©cuter un tas de scripts php en boucle.  Je ne discuterai pas des raisons et de la controverse d'une telle solution architecturale dans cet article, car  en fait, il ne s‚Äôagissait pas du tout de √ßa, c‚Äô√©tait juste une t√¢che, il fallait la r√©soudre et la solution me semblait suffisamment int√©ressante pour que je puisse la partager avec vous, d‚Äôautant plus que je n‚Äôai trouv√© aucun mana sur cette question sur Internet (enfin, bien s√ªr, sauf les sp√©cifications officielles).  Speck, bien s√ªr, est bon, et bien s√ªr tout y est, mais je pense que vous conviendrez que si vous n'√™tes pas particuli√®rement familier avec le sujet, et m√™me limit√© dans le temps, alors les comprendre est toujours un plaisir. </p><a name="habracut"></a><br><h3 id="dlya-kogo-eta-statya">  √Ä qui s'adresse cet article? </h3><br><p>  Pour tous ceux qui travaillent avec le Web et le protocole <strong>FastCgi</strong> sait <strong>seulement</strong> que c'est le protocole selon lequel le serveur Web ex√©cute des scripts PHP, mais veut l'√©tudier plus en d√©tail et regarder sous le capot. </p><br><h3 id="obosnovanie-zachem-eta-statya">  Justification (pourquoi cet article) </h3><br><p>  En g√©n√©ral, comme je l'ai √©crit ci-dessus, lorsque nous avons √©t√© confront√©s √† la n√©cessit√© d'ex√©cuter de nombreux scripts php sans la participation d'un serveur Web (en gros, √† partir d'un autre script php), la premi√®re chose qui m'est venue √† l'esprit est ... </p><br><pre><code class="php hljs">shell_exec(<span class="hljs-string"><span class="hljs-string">'php \path\to\script.php'</span></span>)</code> </pre> <br><p>  Mais au d√©but de chaque script, un environnement sera cr√©√©, un processus s√©par√© sera lanc√©, en g√©n√©ral, cela semblait en quelque sorte co√ªteux pour les ressources.  Cette impl√©mentation a √©t√© rejet√©e.  La deuxi√®me chose qui m'est venue √† l'esprit est bien s√ªr <strong>php-fpm</strong> , c'est tellement cool, il ne d√©marre l'environnement qu'une seule fois, surveille la m√©moire, y enregistre tout correctement, d√©marre et arr√™te les scripts, en g√©n√©ral tout se refroidit, et bien s√ªr nous avons aim√© cette fa√ßon plus. </p><br><p>  Mais c'est de la malchance, en th√©orie, nous savions comment cela fonctionne, en termes g√©n√©raux (car il s'est av√©r√© tr√®s g√©n√©ral), mais il s'est av√©r√© assez difficile de mettre en ≈ìuvre ce protocole dans la pratique sans la participation d'un serveur Web.  La lecture des sp√©cifications et quelques heures de tentatives infructueuses ont montr√© que la mise en ≈ìuvre prendrait du temps, ce que nous n'avions pas √† l'√©poque.  Il n'y a pas de mana pour la mise en ≈ìuvre de cette entreprise dans laquelle cette interaction pourrait √™tre d√©crite simplement et clairement, nous ne pouvions pas non plus prendre de sp√©cifications, √† partir des solutions pr√™tes √† l'emploi, nous avons trouv√© un script Python et une biblioth√®que Pykhov sur le github, qui au final ne voulait pas √™tre tra√Æn√© dans mon projet (peut-√™tre ce n'est pas correct, mais pas vraiment, nous aimons toutes sortes de biblioth√®ques tierces et m√™me pas tr√®s populaires, et donc non test√©es).  En g√©n√©ral, √† la suite de cette id√©e, nous avons refus√© et mis en ≈ìuvre tout cela √† travers le bon vieux rabbitmq. </p><br><p>  Bien que le probl√®me ait finalement √©t√© r√©solu, j'ai quand m√™me d√©cid√© de comprendre FastCgi en d√©tail, et en plus j'ai d√©cid√© d'√©crire un article √† ce sujet, qui d√©crira simplement et en d√©tail comment obtenir <strong>php-fpm</strong> pour ex√©cuter un script php sans serveur web, ou plut√¥t, comme le serveur web aura un script diff√©rent, alors je l'appellerai le client Fcgi.  En g√©n√©ral, j'esp√®re que cet article aidera ceux qui sont confront√©s √† la m√™me t√¢che que nous et apr√®s avoir lu, il pourra √©crire rapidement tout ce dont il a besoin. </p><br><h3 id="tvorcheskiy-poisk-lozhnyy-put">  Recherche cr√©ative (faux chemin) </h3><br><p>  Donc, le probl√®me est indiqu√©, nous devons proc√©der √† la solution.  Naturellement, comme tout programmeur "normal", pour r√©soudre un probl√®me sur lequel il n'est √©crit nulle part quoi faire et quoi entrer dans la console, je n'ai pas lu et traduit la sp√©cification, mais j'ai imm√©diatement trouv√© ma propre solution "g√©niale".  Son essence est la suivante, je sais que <strong>nginx</strong> (nous utilisons nginx et pour ne pas √©crire plus de <strong>b√™tises</strong> - un serveur web, j'√©crirai nginx, car il est plus sympathique) transf√®re quelque chose √† <strong>php-fpm</strong> , il traite <strong>√©galement php-fpm</strong> √† il ex√©cute un script sur la base de celui-ci, eh bien, tout semble √™tre simple, je vais le prendre et le promettre de transmettre <strong>nginx</strong> et je passerai la m√™me chose. </p><br><p>  Un grand <strong>netcat vous</strong> aidera ici (utilitaire UNIX pour travailler avec le trafic r√©seau, qui √† mon avis peut faire presque n'importe quoi).  Donc, nous configurons <strong>netcat</strong> pour √©couter sur le port local, et configurons <strong>nginx</strong> pour fonctionner avec les fichiers php via le socket (naturellement, le socket sur le m√™me port que <strong>netcat</strong> √©coute) </p><br><p>  √©coute du port 9000 </p><br><pre> <code class="plaintext hljs">nc -l 9000</code> </pre> <br><p>  Vous pouvez v√©rifier que tout va bien, vous pouvez contacter l'adresse 127.0.0.1:9000 via un navigateur et l'image suivante doit √™tre </p><br><img src="https://habrastorage.org/webt/ux/9s/_f/ux9s_fkir12e0yn3arj010nnezw.png"><br><p>  configurer <strong>nginx</strong> pour qu'il traite les scripts php via une socket sur le port 9000 (dans les param√®tres '/ etc / nginx / sites-available / default', bien s√ªr, ils peuvent diff√©rer) </p><br><pre> <code class="plaintext hljs">location ~ \.php$ { include snippets/fastcgi-php.conf; fastcgi_pass 127.0.0.1:9000; }</code> </pre><br><p>  Apr√®s ces manipulations, nous v√©rifierons ce qui s'est pass√© en contactant le script php via le navigateur </p><br><img src="https://habrastorage.org/webt/u_/hf/j1/u_hfj1xa4tnqyb35rdmfu5nf-na.png"><br><p>  On peut voir que <strong>nginx a</strong> envoy√© des variables d'environnement, ainsi que des caract√®res non imprimables, c'est-√†-dire que les donn√©es ont √©t√© transmises en encodage binaire, ce qui signifie qu'elles ne peuvent pas √™tre copi√©es si facilement et envoy√©es au <strong>socket php-fpm</strong> .  Si vous les enregistrez dans un fichier, par exemple, puis ils sont enregistr√©s dans le codage hexad√©cimal, il semblera que cela s'applique </p><br><img src="https://habrastorage.org/webt/le/7e/9y/le7e9ycpkn8n3mezj7ksa9xhkki.png"><br><p>  Mais cela ne nous donne pas grand-chose non plus, probablement purement th√©oriquement, ils peuvent √™tre convertis en encodage binaire, d'une mani√®re ou d'une autre (je ne peux m√™me pas imaginer comment) pour les envoyer √† la prise fpm, et il y a m√™me une chance que cette moto enti√®re fonctionne d'une mani√®re ou d'une autre et m√™me d√©marre une sorte de un script, mais en quelque sorte tout est laid et maladroit. </p><br><p>  Il est devenu clair que ce chemin √©tait compl√®tement faux, vous pouvez voir par vous-m√™me √† quel point tout cela semble mis√©rable, et plus encore, toutes ces actions ne nous permettront pas de contr√¥ler la connexion, ni de nous rapprocher de la compr√©hension de l'interaction entre <strong>php-fpm</strong> et <strong>nginx</strong> . </p><br><p>  Tout est parti, la sp√©cification ne peut √™tre √©vit√©e! </p><br><h3 id="reshenie-tut-sobstvenno-nachinaetsya-vsya-sol-dannoy-stati">  Solution (ici commence tout le sel de cet article) </h3><br><h4 id="teoreticheskaya-podgotovka">  Formation th√©orique </h4><br><p>  Voyons maintenant comment il existe tout de m√™me une connexion et un √©change de donn√©es entre <strong>nginx</strong> et <strong>php-fpm</strong> .  Un peu de th√©orie, toutes les communications s'effectuent comme cela est d√©j√† clair √† travers les sockets, nous consid√©rerons plus sp√©cifiquement une connexion via une socket TCP. </p><br><p>  L'unit√© d'informations dans le protocole <strong>FastCgi</strong> est un <strong>enregistrement cgi</strong> .  Le serveur envoie ces enregistrements √† l'application et re√ßoit exactement les m√™mes enregistrements en r√©ponse. </p><br><h5 id="nemnogo-teorii-struktury">  Un peu de th√©orie (structure) </h5><br><p>  Ensuite, consid√©rez la structure de l'enregistrement.  Pour comprendre en quoi consiste un enregistrement, vous devez comprendre √† quoi ressemblent les structures C et comprendre leurs d√©signations.  Pour ceux qui ne savent pas plus, ce sera bri√®vement (mais suffisant pour comprendre) d√©crit.  Je vais essayer de le d√©crire aussi simple que possible, il est inutile d‚Äôentrer dans les d√©tails, et je crains de me perdre dans les d√©tails, l‚Äôessentiel est d‚Äôavoir une compr√©hension commune. </p><br><p>  Les structures sont simplement une collection d'octets et leur notation permet de les interpr√©ter.  Autrement dit, vous avez juste une s√©quence de z√©ros et de uns, et certaines donn√©es sont crypt√©es dans cette s√©quence, mais jusqu'√† pr√©sent, vous n'avez aucune annotation pour cette s√©quence, alors ces donn√©es ne repr√©sentent aucune valeur pour vous, car  vous ne pouvez pas les interpr√©ter. </p><br><pre> <code class="plaintext hljs">//     1101111000000010010110000010011100010000</code> </pre> <br><p>  Ce qui est visible ici, nous avons quelques bits, quel genre de bits nous n'avons aucune id√©e.  Eh bien, essayons par exemple de les diviser en octets et de les repr√©senter en syst√®me d√©cimal </p><br><pre> <code class="plaintext hljs">//   5  11011110 00000010 01011000 00100111 00010000 //    222 2 88 39 16</code> </pre> <br><p>  Eh bien, nous les avons interpr√©t√©s et avons obtenu des r√©sultats, disons que ces donn√©es sont responsables de la quantit√© d'√©lectricit√© qu'un appartement doit.  Il s'av√®re que dans la maison 222 l'appartement num√©ro 2 doit payer 88 roubles.  Et quoi d'autre pour deux chiffres, que faire avec juste pour laisser tomber?  Bien s√ªr que non!  le fait est que nous n'avions pas de notation (format) qui nous dirait comment interpr√©ter les donn√©es, et les interpr√©ter √† notre mani√®re, √† cet √©gard, nous avons re√ßu non seulement des r√©sultats inutiles, mais aussi nuisibles.  En cons√©quence, l'appartement 2 n'a absolument pas pay√© ce qu'il aurait d√ª.  (les exemples sont certainement farfelus et ne servent qu'√† expliquer plus clairement la situation) </p><br><p>  Voyons maintenant comment interpr√©ter correctement ces donn√©es, en ayant une notation (format).  De plus, j'appellerai un chat un chat, √† savoir notation = format ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici les formats</a> ). </p><br><pre> <code class="plaintext hljs">//  "Cnn" //  //C -   (char) (8 ) //n -  short (16 ) //      11011110 0000001001011000 0010011100010000 //    222 600 10000</code> </pre> <br><p>  Maintenant, tout converge dans la maison n ¬∞ 222 appartement 600 pour l'√©lectricit√© devrait √™tre de 1000 roubles. Je pense que maintenant l'importance du format est claire, et maintenant il est clair √† quoi ressemble √† peu pr√®s une structure similaire.  (veuillez faire attention, ici le but n'est pas d'expliquer en d√©tail ce que sont ces structures, mais de donner une compr√©hension g√©n√©rale de ce que c'est et comment cela fonctionne) </p><br><p>  Le symbole de cette structure sera </p><br><pre> <code class="plaintext hljs">struct { unsigned char houseNumber; unsigned char flatNumperA1; unsigned char flatNumperA2; unsigned char summB1; unsigned char summB2; }; // ,           // houseNumber -  // flatNumperA1 &amp;&amp; flatNumperA2 -  // summB1 &amp;&amp; summB2 -  </code> </pre> <br><h5 id="esche-nemnogo-teorii-fastcgi-zapisi">  Un peu plus de th√©orie (entr√©es FastCgi) </h5><br><p>  Comme je l'ai dit ci-dessus, l'unit√© d'information dans le protocole FastCgi est les enregistrements.  Le serveur envoie les enregistrements √† l'application et re√ßoit les m√™mes enregistrements en r√©ponse.  Un enregistrement se compose d'un en-t√™te et d'un corps contenant des donn√©es. </p><br><p>  Structure d'en-t√™te: </p><br><ol><li>  la version du protocole (toujours 1) est indiqu√©e par 1 octet ('C') </li><li>  type d'enregistrement.  Pour ouvrir, fermer la connexion, etc. Je ne consid√©rerai pas tout, alors je ne consid√©rerai que ce qui est n√©cessaire pour une t√¢che sp√©cifique, si d'autres sont n√©cessaires, accueillez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">sp√©cification</a> ici.  Il est indiqu√© par 1 octet (¬´C¬ª). </li><li>  L'ID de la demande, un nombre arbitraire, est d√©sign√© par 2 octets ('n') </li><li>  la longueur du corps de l'enregistrement (donn√©es), indiqu√©e par 2 octets ('n') </li><li>  la longueur des donn√©es d'alignement et des donn√©es r√©serv√©es, un octet chacune (il n'est pas n√©cessaire de porter une attention particuli√®re pour ne pas √™tre distrait de la principale dans notre cas il y aura toujours 0) </li></ol><br><p>  Vient ensuite le corps du dossier: </p><br><ol><li>  les donn√©es elles-m√™mes (ici ce sont pr√©cis√©ment les variables qui sont transf√©r√©es) peuvent √™tre assez volumineuses (jusqu'√† 65 535 octets) </li></ol><br><p>  Voici un exemple de l'enregistrement binaire FastCgi le plus simple au format </p><br><pre> <code class="plaintext hljs">struct { // unsigned char version; unsigned char type; unsigned char idA1; unsigned char idA2; unsigned char bodyLengthB1; unsigned char bodyLengthB2; unsigned char paddingLength; unsigned char reserved; //  unsigned char contentData; // 65535  unsigned char paddingData; };</code> </pre> <br><h4 id="praktika">  Pratique </h4><br><h5 id="skript-klient-i-peredayuschiy-soket">  Client de script et socket de transmission </h5><br><p>  Pour le transfert de donn√©es, nous utiliserons l'extension de socket php standard.  Et la premi√®re chose √† faire est de configurer <strong>php-fpm</strong> pour √©couter sur le port de l'h√¥te local, par exemple 9000. Cela se fait dans la plupart des cas dans le fichier '/etc/php/7.3/fpm/pool.d/www.conf', le chemin bien s√ªr D√©pend de vos param√®tres syst√®me.  L√†, vous devez enregistrer quelque chose comme le suivant (j'apporte tout le footcloth pour que vous puissiez naviguer, la section principale est √©couter ici) </p><br><pre> <code class="plaintext hljs">; The address on which to accept FastCGI requests. ; Valid syntaxes are: ; 'ip.add.re.ss:port' - to listen on a TCP socket to a specific IPv4 address on ; a specific port; ; '[ip:6:addr:ess]:port' - to listen on a TCP socket to a specific IPv6 address on ; a specific port; ; 'port' - to listen on a TCP socket to all addresses ; (IPv6 and IPv4-mapped) on a specific port; ; '/path/to/unix/socket' - to listen on a unix socket. ; Note: This value is mandatory. ;listen = /run/php/php7.3-fpm.sock listen = 127.0.0.1:9002</code> </pre> <br><p>  Apr√®s avoir configur√© fpm, l'√©tape suivante consiste √† se connecter √† la prise </p><br><pre> <code class="php hljs">$service_port = <span class="hljs-number"><span class="hljs-number">9000</span></span>; $address = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); $result = socket_connect($socket, $address, $service_port);</code> </pre> <br><h4 id="nachalo-zaprosa-fcgi_begin_request">  D√©but de la demande FCGI_BEGIN_REQUEST </h4><br><p>  Pour ouvrir une connexion, nous devons envoyer une entr√©e de type FCGI_BEGIN_REQUEST = 1 Le titre de l'entr√©e sera comme ceci (pour convertir les valeurs num√©riques en une cha√Æne binaire au format sp√©cifi√©, le pack fonction php () sera utilis√©) </p><br><pre> <code class="php hljs">socket_write($socket, pack(<span class="hljs-string"><span class="hljs-string">'CCnnCx'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//  - 1 //  - 1 - FCGI_BEGIN_REQUEST //id - 1 //   - 8  // - 0</span></span></code> </pre> <br><p>  Le corps d'enregistrement pour ouvrir une connexion doit contenir un r√¥le d'enregistrement et un indicateur contr√¥lant la connexion </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//      //struct { // unsigned char roleB1; // unsigned char roleB0; // unsigned char flags; // unsigned char reserved[5]; //}; //php  socket_write($socket, pack('nCxxxxx', 1, 0)); // - 1 -  // - 1 -    1   </span></span></code> </pre> <br><p>  Ainsi, l'enregistrement pour l'ouverture de la connexion a √©t√© envoy√© avec succ√®s, <strong>php-fpm</strong> l'acceptera et continuera √† attendre de nous un autre enregistrement dans lequel nous devons transf√©rer des donn√©es pour d√©ployer l'environnement et ex√©cuter le script. </p><br><h4 id="peredacha-parametrov-okruzheniya-fcgi_params">  Passage des param√®tres d'environnement FCGI_PARAMS </h4><br><p>  Dans cet enregistrement, nous transmettrons tous les param√®tres n√©cessaires au d√©ploiement de l'environnement, ainsi que le nom du script √† ex√©cuter. </p><br><p>  Param√®tres d'environnement minimum requis </p><br><pre> <code class="php hljs">$url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span> $env = [ <span class="hljs-string"><span class="hljs-string">'REQUEST_METHOD'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span> =&gt; $url, ];</code> </pre> <br><p>  La premi√®re chose que nous devons faire ici est de pr√©parer les variables n√©cessaires, c'est-√†-dire les paires nom =&gt; valeur que nous transmettrons √† l'application. </p><br><p>  La structure de la valeur du nom des paires sera telle </p><br><pre> <code class="plaintext hljs">//          128  typedef struct { unsigned char nameLength; unsigned char valueLength; unsigned char nameData unsigned char valueData; }; //    1 </code> </pre> <br><p>  Il y a 1 octet en premier - le nom est long, puis 1 octet est la valeur </p><br><pre> <code class="plaintext hljs">//         128  typedef struct { unsigned char nameLengthA1; unsigned char nameLengthA2; unsigned char nameLengthA3; unsigned char nameLengthA4; unsigned char valueLengthB1; unsigned char valueLengthB2; unsigned char valueLengthB3; unsigned char valueLengthB4; unsigned char nameData unsigned char valueData; }; //    4 </code> </pre> <br><p>  Dans notre cas, le nom et les significations sont courts et correspondent √† la premi√®re option, nous allons donc l'examiner. </p><br><p>  Encodez nos variables selon le format </p><br><pre> <code class="php hljs">$keyValueFcgiString = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($env <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-comment"><span class="hljs-comment">//        //  128         $keyLen = strlen($key); $lenKeyChar = $keyLen &lt; 128 ? chr($keyLen) : pack('N', $keyLen); $valLen = strlen($value); $valLenChar = $valLen &lt; 128 ? chr($valLen) : pack('N', $valLen); $keyValueFcgiString .= $lenKeyChar . $valLenChar . $key . $value; }</span></span></code> </pre> <br><p>  Ici, les valeurs inf√©rieures √† 128 bits sont cod√©es par la fonction <em>chr ($ keyLen)</em> , plus que <em>pack ('N', $ valLen)</em> , o√π 'N' repr√©sente 4 octets.  Et puis tout cela est coll√© sur une seule ligne conform√©ment au format de la structure.  Le corps de l'enregistrement est pr√™t. </p><br><p>  Dans l'en-t√™te de l'enregistrement, nous transf√©rons tout de la m√™me mani√®re que dans l'enregistrement pr√©c√©dent, √† l'exception du type (ce sera FCGI_PARAMS = 4) et de la longueur des donn√©es (elle sera √©gale √† la longueur des paires nom =&gt; valeur, ou √† la longueur de la cha√Æne $ keyValueFcgiString que nous avons form√©e plus t√¥t). </p><br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//  socket_write($socket, pack('CCnnCx', 1, 4, 1, strlen($keyValueFcgiString), 0)); // body socket_write($socket, $keyValueFcgiString); //             //  body socket_write($socket, pack('CCnnCx', 1, 4, 1, 0, 0));</span></span></code> </pre> <br><h4 id="poluchenie-otveta-fcgi_params">  Obtenir une r√©ponse de FCGI_PARAMS </h4><br><p>  En fait, apr√®s que tout ce qui pr√©c√®de a √©t√© fait, et que tout ce qu'il attend a √©t√© envoy√© √† l'application, il commence √† fonctionner et nous ne pouvons prendre le r√©sultat de ce travail que depuis le socket. <br>  N'oubliez pas qu'en r√©ponse, nous obtenons les m√™mes notes et nous devons √©galement les interpr√©ter. </p><br><p>  Nous obtenons l'en-t√™te, c'est toujours 8 octets (nous recevrons les donn√©es par octet) </p><br><pre> <code class="php hljs">$buf = <span class="hljs-string"><span class="hljs-string">''</span></span>; $arrData = []; $len = <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($len) { socket_recv($socket, $buf, <span class="hljs-number"><span class="hljs-number">1</span></span>, MSG_WAITALL); <span class="hljs-comment"><span class="hljs-comment">//   1       $arrData[] = $buf; $len--; } //      'CCnnCx' $protocol = unpack('C', $arrData[0]); $type = unpack('C', $arrData[1]); $id = unpack('n', $arrData[2] . $arrData[3]); $dataLen = unpack('n', $arrData[4] . $arrData[5])[1]; //   ,        (unpack  ,    ) $foo = unpack('C', $arrData[6]); var_dump($dataLen); //     </span></span></code> </pre> <br><p>  Maintenant, conform√©ment √† la longueur du corps de la r√©ponse re√ßue, nous ferons une autre lecture √† partir de la prise </p><br><pre> <code class="php hljs">$buf2 = <span class="hljs-string"><span class="hljs-string">''</span></span>; $result = []; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ($dataLen) { socket_recv($socket, $buf2, <span class="hljs-number"><span class="hljs-number">1</span></span>, MSG_WAITALL); $result[] = $buf2; $dataLen--; } var_dump(implode(<span class="hljs-string"><span class="hljs-string">''</span></span>, $result)); <span class="hljs-comment"><span class="hljs-comment">//       socket_close($socket);</span></span></code> </pre> <br><p>  Hourra, √ßa a march√©!  Enfin √ßa! <br>  Qu'avons-nous dans la r√©ponse, si par exemple dans ce fichier </p><br><pre> <code class="php hljs">$url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span> <span class="hljs-comment"><span class="hljs-comment">//    </span></span></code> </pre> <br><p>  nous √©crirons </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"My fcgi script"</span></span>;</code> </pre> <br><p>  puis dans la r√©ponse que nous obtenons √† la suite </p><br><p><img src="https://habrastorage.org/webt/dq/pc/ox/dqpcox1zbmcutdzxxeh69i_hbsc.png" alt="image"></p><br><h3 id="itogi">  R√©sum√© </h3><br><p>  Je n‚Äô√©crirai pas beaucoup ici, alors le long article s‚Äôest av√©r√©.  J'esp√®re qu'elle aide quelqu'un.  Et je vais donner le script final lui-m√™me, il s'est av√©r√© √™tre assez petit.  Bien s√ªr, il peut faire beaucoup de choses sous cette forme, et il ne g√®re pas les erreurs et tout cela, mais il n'en a pas besoin, il a besoin de lui comme exemple pour montrer les bases. </p><br><div class="spoiler">  <b class="spoiler_title">Version compl√®te du script</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $url = <span class="hljs-string"><span class="hljs-string">'/path/to/script.php'</span></span>; $env = [ <span class="hljs-string"><span class="hljs-string">'REQUEST_METHOD'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'SCRIPT_FILENAME'</span></span> =&gt; $url, ]; $service_port = <span class="hljs-number"><span class="hljs-number">9000</span></span>; $address = <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span>; $socket = socket_create(AF_INET, SOCK_STREAM, SOL_TCP); $result = socket_connect($socket, $address, $service_port); <span class="hljs-comment"><span class="hljs-comment">//  //     php-fpm //    ,   (    ), id ,   ,     socket_write($socket, pack('CCnnCx', 1, 1, 1, 8, 0)); //     // ,     socket_write($socket, pack('nCxxxxx', 1, 0)); $keyValueFcgiString = ''; foreach ($env as $key =&gt; $value) { //        //  128         $keyLen = strlen($key); $lenKeyChar = $keyLen &lt; 128 ? chr($keyLen) : pack('N', $keyLen); $valLen = strlen($value); $valLenChar = $valLen &lt; 128 ? chr($valLen) : pack('N', $valLen); $keyValueFcgiString .= $lenKeyChar . $valLenChar . $key . $value; } // ,      php-fpm           //      //1- ( ), 4-  (,    - FCGI_PARAMS), id  ( ),    (   -),     socket_write($socket, pack('CCnnCx', 1, 4, 1, strlen($keyValueFcgiString), 0)); //      socket_write($socket, $keyValueFcgiString); //  socket_write($socket, pack('CCnnCx', 1, 4, 1, 0, 0)); $buf = ''; $arrData = []; $len = 8; while ($len) { socket_recv($socket, $buf, 1, MSG_WAITALL); //   1       $arrData[] = $buf; $len--; } //      'CCnnCx' $protocol = unpack('C', $arrData[0]); $type = unpack('C', $arrData[1]); $id = unpack('n', $arrData[2] . $arrData[3]); $dataLen = unpack('n', $arrData[4] . $arrData[5])[1]; //   ,        (unpack  ,    ) $foo = unpack('C', $arrData[6]); $buf2 = ''; $result = []; while ($dataLen) { socket_recv($socket, $buf2, 1, MSG_WAITALL); $result[] = $buf2; $dataLen--; } var_dump(implode('', $result)); //       socket_close($socket);</span></span></code> </pre></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr472190/">https://habr.com/ru/post/fr472190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr472178/index.html">Holivar. Histoire de Runet. Partie 7. YouTube: com√©diens, couinements et Silicon Valley</a></li>
<li><a href="../fr472182/index.html">Annonce de l'aper√ßu 1 de .NET Core 3.1</a></li>
<li><a href="../fr472184/index.html">SSH √† distance: trucs et astuces</a></li>
<li><a href="../fr472186/index.html">Principe ouvert-ferm√©</a></li>
<li><a href="../fr472188/index.html">Ce que vous devez savoir sur la v√©rification des ch√®ques sur l'App Store (re√ßu de l'App Store)</a></li>
<li><a href="../fr472196/index.html">Du ¬´sucre¬ª fait maison pour un projet Android ou ¬´Comment ne pas le faire¬ª</a></li>
<li><a href="../fr472198/index.html">Localisation des messages push dans les applications mobiles</a></li>
<li><a href="../fr472200/index.html">Modernisation du cours d'informatique dans une √©cole russe sur une framboise: pas cher et gai</a></li>
<li><a href="../fr472202/index.html">Windows 10 + Python = VS Code + WSL</a></li>
<li><a href="../fr472204/index.html">Exp√©riences simples avec le microcontr√¥leur STM32F103 (Blue Tablet)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>