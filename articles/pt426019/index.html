<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üèáüèª üññüèª üî∏ Esta√ß√£o meteorol√≥gica no Arduino de A a Z. Parte 5 üçÑ üéÅ üë©üèΩ‚Äçüè≠</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O final. A parte anterior . 


 Sum√°rio: 


- Parte 1. Requisitos. A escolha do ferro. Esquema geral 
- Parte 2. Software. Unidade central, ferro 
- P...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Esta√ß√£o meteorol√≥gica no Arduino de A a Z. Parte 5</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426019/"><p>  O final.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A parte anterior</a> . </p><br><p>  Sum√°rio: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 1. Requisitos.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A escolha do ferro.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Esquema geral</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 2. Software.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Unidade central, ferro</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 3. Unidade central, software</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 4. Sensor de Janela</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Parte 5. MySQL, PHP, WWW, Android</a> </li></ul><br><h1 id="zaokonnyy-datchik-programmnoe-obespechenie">  Sensor externo.  De software </h1><br><p>  Fale sobre o software para o sensor no exterior.  Depois disso, voc√™ obter√° um sistema completo com o qual voc√™ j√° pode experimentar. </p><br><p>  Deixe-me lembr√°-lo de que o <em>servidor</em> √© uma unidade dom√©stica central que pode se comunicar com a Internet via Wi-Fi e que o <em>cliente</em> √© um sensor remoto e pronto para uso que transmite dados para o servidor pelo ar. </p><br><p> O c√≥digo fonte do servidor e do cliente <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° aqui</a> . <br>  Os textos de origem s√£o fornecidos com coment√°rios detalhados. </p><br><p>  Quase nada precisa ser configurado no cliente. </p><a name="habracut"></a><br><p>  O transmissor de r√°dio nRF24L01 +, mais precisamente a biblioteca RadioHead, exige que os endere√ßos do servidor e do cliente sejam especificados.  Os endere√ßos s√£o fornecidos caso voc√™ tenha mais de um servidor e cliente.  Um endere√ßo √© qualquer n√∫mero inteiro.  Quando um cliente envia um pacote de dados para um servidor, indica para qual servidor esse pacote se destina.  O servidor, sabendo seu pr√≥prio endere√ßo, por sua vez, determina se esse pacote √© destinado a ele. </p><br><p> Portanto, <code>SERVER_ADDRESS</code> no servidor e no cliente deve ser o mesmo, mas <code>CLIENT_ADDRESS</code> para clientes diferentes deve ser diferente.  Em outras palavras, se voc√™ conectar outro novo sensor ao nosso sistema no futuro, <code>CLIENT_ADDRESS</code> precisar√° ser alterado para ele. </p><br><pre> <code class="hljs erlang-repl">//     #define SERVER_ADDRESS <span class="hljs-number"><span class="hljs-number">10</span></span> #define CLIENT_ADDRESS <span class="hljs-number"><span class="hljs-number">20</span></span> //     !!!</code> </pre> <br><p>  O <code>RF_CHANNEL</code> canal de r√°dio <code>RF_CHANNEL</code> deve ser o mesmo para todos.  Por padr√£o, √© 2. Alterei o n√∫mero padr√£o, voc√™ pode escolher qualquer outro. </p><br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//  .       #define RF_CHANNEL 73</span></span></code> </pre> <br><p>  As configura√ß√µes do volt√≠metro para medir a tens√£o de alimenta√ß√£o da bateria devem ser alteradas: </p><br><pre> <code class="hljs ruby">/<span class="hljs-regexp"><span class="hljs-regexp">/   ,   const float r1 = 100400; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 100K const float r2 = 9960; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ 10K /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    http:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/localhost/arduino</span></span>-secret-<span class="hljs-literal"><span class="hljs-literal">true</span></span>-voltmeter/ const float typVbg = <span class="hljs-number"><span class="hljs-number">1.082</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>    <span class="hljs-number"><span class="hljs-number">1.0</span></span> -- <span class="hljs-number"><span class="hljs-number">1.2</span></span> </code> </pre> <br><p>  Para economizar energia, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca Lightweight low power para Arduino √© usada</a> . </p><br><p>  Aqui est√£o minhas medi√ß√µes de consumo reais para o Arduino Pro Mini com esta lib: </p><br><ul><li>  geralmente 25mA </li><li>  ao trabalhar com DHT o mesmo </li><li>  com transmiss√£o de r√°dio 38 mA </li><li>  em LowPower.idle 15 mA </li><li>  em LowPower.powerdown 7,5 mA </li></ul><br><p>  O cliente faz medi√ß√µes de temperatura, umidade e tens√£o de alimenta√ß√£o, agrupa tudo isso em uma estrutura de dados, envia os dados para o servidor e "adormece".  Se ocorrerem erros durante a transfer√™ncia, a transfer√™ncia √© repetida imediatamente. </p><br><p>  O servidor (central, unidade dom√©stica), por sua vez, recebe dados, confirma a recep√ß√£o e os processa. </p><br><h1 id="baza-dannyh-mysql-php-www-server">  Banco de dados, MySQL, PHP, servidor WWW </h1><br><p>  Ap√≥s o trabalho, temos um design totalmente funcional da esta√ß√£o meteorol√≥gica.  Mas agora h√° uma d√∫zia dessas esta√ß√µes meteorol√≥gicas, o artesanato local n√£o est√° mais na moda.  Afinal, temos uma Internet das coisas. </p><br><p>  Portanto, falaremos sobre como o acesso a essa Internet √© realizado, anexaremos um banco de dados e uma face da Web a nossa esta√ß√£o meteorol√≥gica. </p><br><p>  A declara√ß√£o do problema para a "webcam": </p><br><ul><li>  receber e armazenar dados da esta√ß√£o meteorol√≥gica: temperatura, umidade, press√£o atmosf√©rica, tens√£o de alimenta√ß√£o </li><li>  exibir esses dados </li><li>  construir gr√°ficos. </li></ul><br><p>  Neste caso, precisamos de hospedagem com suporte para Apache, PHP e MySQL com o m√≥dulo mysqli.  E essas condi√ß√µes s√£o satisfeitas por quase qualquer hospedagem no planeta Terra.  Ou, em vez de hospedar, o computador desempenhar√° o papel de servidor conectado a um roteador de rede dom√©stica e ter√° acesso √† Internet. </p><br><h2 id="sozdanie-bazy-dannyh">  Cria√ß√£o de banco de dados </h2><br><p>  Vamos come√ßar desde o in√≠cio, ou seja, com o design e a cria√ß√£o do banco de dados. </p><br><p>  Os bancos de dados s√£o o seu mundo e voc√™ pode estud√°-lo por um longo per√≠odo de tempo. Assim, tocaremos brevemente apenas no que precisamos diretamente. </p><br><p>  Todos os scripts SQL est√£o no diret√≥rio <code>weather-station/server/php-sql/</code> </p><br><p>  Onde o design do banco de dados come√ßa?  Com uma representa√ß√£o l√≥gica e f√≠sica. </p><br><p>  Visualiza√ß√£o l√≥gica ou esquema do banco de dados: </p><br><ul><li>  Tabela de temperatura e umidade DHT </li><li>  tabela de dados BMP do sensor de press√£o e temperatura </li><li>  as tabelas indicadas n√£o t√™m nenhum relacionamento entre si; mais precisamente, os links n√£o s√£o necess√°rios. </li></ul><br><p>  O esquema f√≠sico se baseia em um DBMS e tipos de dados espec√≠ficos.  √â mais f√°cil desmontar com um exemplo espec√≠fico.  O script SQL <code>make_tables.sql</code> os esquemas l√≥gicos e f√≠sicos. </p><br><p>  Cada tabela deve ter um campo de tipo </p><br><pre> <code class="sql hljs">id INTEGER UNSIGNED NOT NULL AUTO_INCREMENT</code> </pre> <br><p>  O nome do campo pode diferir em bancos de dados diferentes, mas h√° apenas um sentido - este √© um identificador exclusivo, uma chave de registro.  Para o futuro, se voc√™ vir um banco de dados em tabelas que n√£o possuem esse contador, saiba que esse banco de dados foi projetado por uma pessoa muito longe da programa√ß√£o, provavelmente de humanidades. </p><br><p>  Armazenamos os dados dos sensores do mesmo tipo em uma tabela; para sensores de outro tipo, criamos outra tabela.  Isso complica um pouco o banco de dados e a liga√ß√£o do PHP a ele, mas simplifica a extens√£o ou modifica√ß√£o de todo o sistema no futuro. </p><br><p>  Existem duas tabelas em nosso projeto.  A tabela <code>arduino_dht</code> armazena dados do (s) sensor (es) do tipo DHT (temperatura, umidade), a tabela <code>arduino_bmp</code> armazena dados do (s) sensor (es) do tipo BMP (temperatura, press√£o).  Se no futuro voc√™ quiser ter, por exemplo, um sensor de g√°s ou um detector de movimento, crie tabelas adicionais, n√£o seja pregui√ßoso.  Se voc√™ conectar outro sensor do tipo DHT11 ou DHT22, n√£o precisar√° criar uma tabela adicional, use a tabela <code>arduino_dht</code> .  Espero que o princ√≠pio seja claro: uma entidade f√≠sica separada √© uma tabela separada. </p><br><p>  Se os dados de v√°rios sensores do mesmo tipo ser√£o armazenados em uma tabela, como eles podem ser distinguidos?  Para fazer isso, insira um campo em cada tabela </p><br><pre> <code class="hljs pgsql">idSensor <span class="hljs-type"><span class="hljs-type">INTEGER</span></span></code> </pre> <br><p>  De fato, √© <code>CLIENT_ADDRESS</code> que registramos no <code>client/client.ino</code> para cada inst√¢ncia do cliente-cliente remoto e em <code>server/server.ino</code> para o sensor conectado diretamente ao servidor - a unidade central. </p><br><p>  Nos sistemas industriais, deve haver outra tabela - a correspond√™ncia do <code>idSensor</code> e sua descri√ß√£o verbal leg√≠vel por humanos.  Por exemplo, um sensor com <code>idSensor</code> = 2 √© <em>"Temperatura, umidade no apartamento"</em> , etc.  Mas em nosso projeto n√£o vamos complicar, basta lembrar que: </p><br><ul><li>  um sensor com <code>idSensor</code> , √© <code>CLIENT_ADDRESS</code> , igual a 11 - este √© o sensor dom√©stico no servidor - a unidade central, </li><li>  um sensor com <code>idSensor</code> , tamb√©m √© <code>CLIENT_ADDRESS</code> , igual a 20 - este √© o primeiro (em nosso projeto e o √∫nico) cliente de sensor baseado em janela. </li></ul><br><p>  Pr√≥ximo.  As tabelas armazenam os seguintes dados: </p><br><ul><li>  ipRemote - endere√ßo IP da esta√ß√£o meteorol√≥gica (servidor) da qual os dados vieram, √∫til para depura√ß√£o e monitoramento, </li><li>  dateCreate - data em que o registro foi criado, </li><li>  millis - √∫til para depura√ß√£o, √© o tempo em milissegundos desde o in√≠cio do esbo√ßo no Arduino, </li><li>  temperatura - temperatura </li><li>  umidade - umidade </li><li>  tens√£o - tens√£o de alimenta√ß√£o, </li><li>  press√£o - press√£o </li><li>  erros - o n√∫mero de erros (n√£o usado).  O objetivo era armazenar o n√∫mero de erros de transmiss√£o, etc., para que voc√™ pudesse avaliar remotamente o estado de todo o sistema. </li></ul><br><p>  Como voc√™ pode ver, as <code>arduino_bmp</code> e <code>arduino_bmp</code> muito semelhantes, a diferen√ßa est√° apenas nos campos de press√£o e umidade, e h√° um desejo de despejar tudo em uma pilha (tabela).  Mas a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">primeira forma normal</a> n√£o ordena fazer isso, muitos programadores iniciantes tentaram contorn√°-la, mas nenhum deles conseguiu, e n√≥s n√£o.  √â assim que n√£o se deve observar a lei da gravita√ß√£o universal, por enquanto ela pode resultar. </p><br><p>  A tabela <code>arduino_error_log</code> √∫til para depura√ß√£o - √© um log de erros e outras mensagens do sistema. </p><br><p>  A cria√ß√£o de um banco de dados e de seu usu√°rio com direitos √© descrita em <code>make_db.sql</code> </p><br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- .  config.php --   CREATE DATABASE IF NOT EXISTS db_weather; --   CREATE USER 'u_weather'@'localhost' IDENTIFIED BY '***PASSWORD***'; GRANT ALL ON db_weather.* TO 'u_weather'@'localhost';</span></span></code> </pre> <br><p>  Isso √© feito uma vez, o nome do banco de dados e o nome de usu√°rio podem aparecer com os seus.  E o que exatamente precisa ser feito √© definir sua senha. </p><br><h2 id="php-i-veb-server">  PHP e servidor web </h2><br><p>  Todas as configura√ß√µes da interface da web s√£o armazenadas em <code>config.php</code> .  Modifique-o de acordo com as configura√ß√µes do seu banco de dados. </p><br><p>  Defina seu fuso hor√°rio no formato PHP </p><br><pre> <code class="hljs lisp">date_default_timezone_set('Europe/Prague')<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Todos os <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fusos hor√°rios</a> dispon√≠veis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">s√£o descritos aqui</a> . </p><br><p>  Defina sua chave secreta para acesso (como um n√∫mero) que deve corresponder √† constante <code>SOURCE_KEY</code> no <code>SOURCE_KEY</code> de <code>server.ino</code> </p><br><pre> <code class="hljs perl">$access_key = <span class="hljs-string"><span class="hljs-string">'***KEY***'</span></span>;</code> </pre> <br><p>  No nosso servidor web, n√£o h√° autoriza√ß√£o, entrada de senha, isso complicaria todo o design.  Para um prot√≥tipo, isso n√£o √© necess√°rio.  Portanto, toda a prote√ß√£o √© constru√≠da no arquivo <code>robots.txt</code> , na aus√™ncia de <code>index.php</code> e nessa chave secreta de acesso. </p><br><p>  O principal script PHP <code>weather.php</code> aceita uma solicita√ß√£o HTTP GET simples com dados e a armazena nas tabelas correspondentes do banco de dados.  Se a chave <code>$access_key</code> n√£o corresponder, a solicita√ß√£o ser√° rejeitada. </p><br><p>  O <code>weather-view.php</code> usado para exibir tabelas de dados e cont√©m links para outros scripts de interface da web.  Ligue para ele assim </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">// / /weather-view.php?k= access_key</span></span></code> </pre> <br><p>  Por exemplo </p><br><pre> <code class="hljs objectivec">http:<span class="hljs-comment"><span class="hljs-comment">//yourhost/iot/weather-view.php?k=12345</span></span></code> </pre> <br><p>  <code>weather-view.php</code> exibe r√≥tulos simples, nos quais √© necess√°rio lembrar que: </p><br><ul><li>  o sensor com o ID 11 √© o sensor dom√©stico no servidor, </li><li>  O sensor com id 20 √© um sensor de janela. </li></ul><br><p>  O script <code>function.php</code> cont√©m fun√ß√µes comuns a todos os scripts PHP. </p><br><p>  O <code>chart-dht.php</code> √© respons√°vel pelos gr√°ficos usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Google Charts</a> .  Aqui, por exemplo, est√° um gr√°fico da tens√£o de alimenta√ß√£o do sensor no exterior.  A tens√£o aumenta em um dia ensolarado devido √† bateria solar e, em seguida, a fonte de alimenta√ß√£o das baterias √© descarregada gradualmente. </p><br><p><img src="https://habrastorage.org/webt/fb/ne/sg/fbnesguoqhfpwcgfa--lcrtpf4m.png" alt="Graph"></p><br><p>  <code>export-dht.php</code> exporta dados das tabelas do banco de dados MySQL para um arquivo CSV.  Para importa√ß√£o e an√°lise adicionais em planilhas. </p><br><p>  <code>export-voltage.php</code> exporta dados sobre a tens√£o de alimenta√ß√£o do sensor de janela do banco de dados MySQL para um arquivo CSV.  √ötil para depura√ß√£o. </p><br><p>  <code>truncate.php</code> limpa todas as tabelas, ou seja,  exclui todos os nossos dados.  √ötil para depura√ß√£o.  Como n√£o h√° links para este script no <code>weather-view.php</code> , √© necess√°rio cham√°-lo atrav√©s de um link direto na barra de endere√ßos do seu navegador com <code>$access_key</code> . </p><br><p>  Ao receber dados, a fun√ß√£o <code>mysqli_real_escape_string()</code> √© comumente usada para impedir que valores incorretos entrem no banco de dados. </p><br><p>  N√£o se esque√ßa de colocar o <code>robots.txt</code> na raiz do seu site para impedir que ele entre nos mecanismos de pesquisa. </p><br><h1 id="esp8266-wifi-i-peredacha-dannyh">  ESP8266, WiFi e transfer√™ncia de dados </h1><br><p>  E agora, de volta ao esbo√ßo <code>server.ino</code> , √† parte dele que se conecta ao ponto de acesso WiFi e envia dados ao servidor web. </p><br><p>  Como j√° escrevi, n√£o consegui encontrar uma biblioteca normal para o Arduino controlar o m√≥dulo ESP8266 usando os comandos AT, tive que "fazer uma fazenda coletiva".  Deixe-me lembr√°-lo tamb√©m de que voc√™ precisa atualizar uma vers√£o espec√≠fica do firmware no ESP8266-01.  E agora, quando tudo estiver pronto, vamos ver como funciona. </p><br><p>  Para acessar o servidor da web no esbo√ßo <code>server.ino</code> , <code>server.ino</code> necess√°rio alterar essas constantes </p><br><pre> <code class="hljs julia"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_HOST = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  habr.com <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_PORT = <span class="hljs-string"><span class="hljs-string">" "</span></span>; //  <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> DEST_URL = <span class="hljs-string"><span class="hljs-string">"/ /weather.php"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> SOURCE_KEY= <span class="hljs-string"><span class="hljs-string">"  "</span></span>; //    $access_key  config.php</code> </pre> <br><p>  No <code>server.ino</code> na fun√ß√£o <code>void setup()</code> , o ESP8266 √© primeiro alternado para o modo Station, ou seja,  come√ßa a trabalhar como cliente WiFi </p><br><pre> <code class="hljs lisp">espSendCmd(¬´AT+CWMODE_CUR=1¬ª, ¬´OK¬ª, <span class="hljs-number"><span class="hljs-number">3000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  e segue a conex√£o com o ponto de acesso </p><br><pre> <code class="hljs lisp">espState = espConnectToWiFi()<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Se a conex√£o n√£o ocorrer, a tentativa ser√° repetida (uma vez) </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( espState != <span class="hljs-type"><span class="hljs-type">ESP_SUCCESS</span></span> ) { delay(<span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi not connected! Try again ..."</span></span>); espConnectToWiFi(); }</code> </pre> <br><p>  Em seguida, selecione o modo de conex√£o √∫nica TCP / IP </p><br><pre> <code class="hljs lisp">espSendCmd(<span class="hljs-string"><span class="hljs-string">"AT+CIPMUX=0"</span></span>, <span class="hljs-string"><span class="hljs-string">"OK"</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Ao enviar dados de sensores do tipo DHT para o servidor da web, √© usada uma fun√ß√£o que indica o <code>type=dht</code> dados como <code>type=dht</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=dht&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.temperature) + <span class="hljs-string"><span class="hljs-string">"&amp;h="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.humidity) + <span class="hljs-string"><span class="hljs-string">"&amp;v="</span></span> + String(<span class="hljs-name"><span class="hljs-name">dhtData</span></span>.voltage) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Ao enviar dados de sensores BMP para um servidor da web, a mesma fun√ß√£o √© usada com o tipo de dados indicado como <code>type=bmp</code> </p><br><pre> <code class="hljs lisp">espSendData( <span class="hljs-string"><span class="hljs-string">"type=bmp&amp;t="</span></span> + String(<span class="hljs-name"><span class="hljs-name">temperature_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;p="</span></span> + String(<span class="hljs-name"><span class="hljs-name">pressure_bmp</span></span>) + <span class="hljs-string"><span class="hljs-string">"&amp;s="</span></span> + String(<span class="hljs-name"><span class="hljs-name">CLIENT_ADDRESS</span></span>) )<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  A fun√ß√£o <code>espSendData()</code> aceita uma string de solicita√ß√£o HTTP GET e a envia para o servidor da Web conforme pretendido. </p><br><p>  Dentro de si, <code>espSendData()</code> verifica a disponibilidade do m√≥dulo ESP enviando o comando ‚ÄúAT‚Äù, depois verifica a conex√£o WiFi e reconecta, se necess√°rio.  Em seguida, os dados s√£o enviados e a conex√£o TCP √© fechada. </p><br><h1 id="android-prilozhenie">  Aplicativo para Android </h1><br><p>  Atualmente, quando todos podem piscar um LED, voc√™ n√£o surpreende ningu√©m com uma esta√ß√£o meteorol√≥gica.  Mas se o of√≠cio sabe como se comunicar com o servidor via Wi-Fi, possui uma face da Web e um aplicativo m√≥vel, isso √© algo!  Por servidor aqui, queremos dizer, √© claro, o servidor de aplicativos, ou seja,  no nosso caso, isso √© uma liga√ß√£o PHP e um MySQL DBMS.  N√£o h√° cerejas suficientes no bolo, a saber, o aplicativo Android, que escreveremos agora. </p><br><h2 id="arhitektura">  Arquitetura </h2><br><p>  A arquitetura de toda a plataforma de software das esta√ß√µes meteorol√≥gicas √© simples: </p><br><ul><li>  a parte do servidor (unidade central) da esta√ß√£o meteorol√≥gica coleta dados de clientes de sensores remotos </li><li>  depois transfere dados para o servidor web de aplicativos, que salva esses dados no banco de dados </li><li>  O aplicativo Android (ou qualquer outro aplicativo remoto: iOS, navegador) solicita dados de um servidor da Web e os exibe na tela. </li></ul><br><p>  Na tela do dispositivo Android, exibiremos as leituras atuais e mais recentes dos sensores. </p><br><h2 id="http-get-i-json">  HTTP GET e JSON </h2><br><p>  A quest√£o que precisa ser resolvida em primeiro lugar √© como os dados ser√£o transferidos do servidor da Web para o aplicativo Android. </p><br><p>  N√£o h√° necessidade de inventar nada aqui, tudo j√° foi inventado para n√≥s - estes s√£o HTTP GET e JSON. </p><br><p>  No nosso caso, uma simples solicita√ß√£o GET para o servidor da Web pode ser compilada e depurada manualmente enquanto o aplicativo Android ainda n√£o est√° pronto. </p><br><p>  Em Java e Android, existem bibliotecas prontas para o processamento de dados no formato JSON.  JSON √© um formato de texto leg√≠vel por humanos, √∫til para depura√ß√£o. </p><br><p>  Para gerar dados atuais dos sensores das esta√ß√µes meteorol√≥gicas, crie um novo script PHP <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">last-data-to-json.php</a> no servidor da web. </p><br><p>  Chamada de script: </p><br><pre> <code class="hljs powershell">http://&lt;&gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  onde <code>&lt;access_key&gt;</code> , como lembramos, √© a chave de acesso secreta ao banco de dados. </p><br><p>  Exemplo de resposta no formato JSON: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"DHT 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:03"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"5.01"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"DHT 20"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"20"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-18 07:36:26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"humidity"</span></span>:<span class="hljs-string"><span class="hljs-string">"26"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"voltage"</span></span>:<span class="hljs-string"><span class="hljs-string">"3.7"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"BMP 11"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"idSensor"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dateCreate"</span></span>:<span class="hljs-string"><span class="hljs-string">"2016-04-20 18:06:22"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"temperature"</span></span>:<span class="hljs-string"><span class="hljs-string">"19"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pressure"</span></span>:<span class="hljs-string"><span class="hljs-string">"987.97"</span></span> } }</code> </pre> <br><p>  Deve-se lembrar que temos 3 sensores.  Seu ID e tipo (DHT ou BMP) s√£o codificados em todo o c√≥digo da esta√ß√£o meteorol√≥gica.  Esse m√©todo de codifica√ß√£o hardcore √© ideologicamente incorreto, mas para um prot√≥tipo de joelho (onde √© necess√°ria uma solu√ß√£o r√°pida e f√°cil), esse √© um compromisso razo√°vel. </p><br><pre> <code class="hljs ruby">$idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT  $idSensor = <span class="hljs-number"><span class="hljs-number">11</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  BMP  $idSensor = <span class="hljs-number"><span class="hljs-number">20</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>  DHT </code> </pre> <br><p>  O <code>last-data-to-json.php</code> pega os dados mais recentes desses sensores heterog√™neos do banco de dados e os compacta no formato JSON.  A sele√ß√£o dos dados do banco de dados "do final" prossegue desta maneira: </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre> <br><h2 id="android">  Android </h2><br><p>  Agora, escreveremos um aplicativo Android simples que solicita, recebe, decodifica dados JSON e exibe informa√ß√µes na tela. </p><br><p>  Nosso aplicativo para Android ser√° o mais simples poss√≠vel, apenas a ess√™ncia da tecnologia.  Mais adiante neste "esqueleto" j√° ser√° poss√≠vel terminar v√°rias "belezas". </p><br><p>  Aqui est√° uma captura de tela do que deve resultar em </p><br><p><img src="https://habrastorage.org/webt/ca/qb/wx/caqbwxzdlsu2a83atqsmzslebvy.jpeg" alt="Android"></p><br><p>  Como voc√™ pode ver, a interface do usu√°rio √© apenas espartana, baseada em LinearLayout, nada mais. </p><br><p>  No topo do TextView, mostra o ID dos sensores e seus dados meteorol√≥gicos.  O bot√£o Atualizar inicia uma segunda solicita√ß√£o para o servidor web.  A seguir, no EditText, √© a √∫nica configura√ß√£o do programa - este √© o URL da solicita√ß√£o no formul√°rio </p><br><pre> <code class="hljs powershell">http://&lt; &gt;/last<span class="hljs-literal"><span class="hljs-literal">-data</span></span><span class="hljs-literal"><span class="hljs-literal">-to</span></span><span class="hljs-literal"><span class="hljs-literal">-json</span></span>.php?k=&lt;access_key&gt;</code> </pre> <br><p>  O que deve ser observado? </p><br><p>  No manifesto, adicione linhas permitindo a Internet e verificando o status da conex√£o de rede: </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.ACCESS_NETWORK_STATE"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">uses-permission</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"android.permission.INTERNET"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br><p>  Trabalhar com a rede e receber dados do site √© o seguinte. </p><br><p>  Usamos o AsyncTask para criar uma tarefa em segundo plano separada do thread principal da interface do usu√°rio.  Essa tarefa em segundo plano pega a URL da solicita√ß√£o e a usa para criar a <code>HttpURLConnection</code> . </p><br><p>  Depois que a conex√£o √© estabelecida, o AsyncTask carrega o conte√∫do da p√°gina da web (JSON) como um InputStream.  Em seguida, o InputStream √© convertido em uma sequ√™ncia, que √© decodificada usando JSONObject e exibida na interface do usu√°rio usando o m√©todo <code>onPostExecute()</code> . </p><br><p>  Em MainActivity.java, altere o URL para: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String defUrl = <span class="hljs-string"><span class="hljs-string">"http://host/dir/last-data-to-json.php?k=&lt; &gt;"</span></span>;</code> </pre> <br><p>  ele ser√° usado por padr√£o na primeira vez que voc√™ executar um aplicativo Android. </p><br><h2 id="epilog">  Ep√≠logo </h2><br><p>  Bem, algo j√° funcionou.  Ent√£o voc√™ pode otimizar algo, substituir algo, voc√™ pode jogar tudo fora, mas tamb√©m emprestar algo. </p><br><p>  Um grande ponto dolorido separado √© <strong>o consumo de energia</strong> .  Eu recomendo a leitura de coment√°rios em postagens onde existem muitas dicas pr√°ticas. </p><br><p>  <em>Para o infinito ... e al√©m.</em> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt426019/">https://habr.com/ru/post/pt426019/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt426001/index.html">Curso MIT "Seguran√ßa de sistemas de computadores". Aula 11: Linguagem de Programa√ß√£o Ur / Web, Parte 3</a></li>
<li><a href="../pt426009/index.html">A resist√™ncia √©pica √† falha 1 ou a Fox estava passando despercebida. Testando o anonimato e a seguran√ßa + VPN para o usu√°rio</a></li>
<li><a href="../pt426013/index.html">Ester√≥ides da carreira</a></li>
<li><a href="../pt426015/index.html">O uso de drones civis serrados para fotografia a√©rea geod√©sica profissional da √°rea</a></li>
<li><a href="../pt426017/index.html">Como reduzir o n√∫mero de experi√™ncias em animais</a></li>
<li><a href="../pt426021/index.html">libgdx e sentimentos</a></li>
<li><a href="../pt426023/index.html">Li√ß√£o aberta "Laborat√≥rio virtual no Vagrant"</a></li>
<li><a href="../pt426025/index.html">Usando m√©todos ofensivos para enriquecer a Intelig√™ncia de Amea√ßas</a></li>
<li><a href="../pt426027/index.html">An√°lise de portf√≥lio de investimentos e servi√ßos em nuvem da Amazon</a></li>
<li><a href="../pt426029/index.html">Voc√™ desiste e quer sair da tarefa? √â assim que o treinamento eficaz para desenvolvedores se parece</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>