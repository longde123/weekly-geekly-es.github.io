<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üóº üé£ üí≠ LLVM em termos de Go üí™üèº üçä üöµüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O desenvolvimento do compilador √© uma tarefa muito dif√≠cil. Mas, felizmente, com o desenvolvimento de projetos como o LLVM, a solu√ß√£o para esse proble...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>LLVM em termos de Go</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ruvds/blog/451476/">  O desenvolvimento do compilador √© uma tarefa muito dif√≠cil.  Mas, felizmente, com o desenvolvimento de projetos como o LLVM, a solu√ß√£o para esse problema √© bastante simplificada, o que permite que um √∫nico programador crie uma nova linguagem com desempenho pr√≥ximo ao C. Trabalhar com o LLVM √© complicado pelo fato de esse sistema ser representado por uma enorme quantidade de c√≥digo, equipada com pequena documenta√ß√£o.  Para tentar corrigir essa falha, o autor do material, que publicamos hoje, demonstrar√° exemplos de c√≥digo escritos em Go e mostrar√° como eles s√£o transmitidos primeiro ao <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Go SSA</a> e depois ao LLVM IR usando o compilador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TinyGO</a> .  O c√≥digo IR Go SSA e LLVM foi ligeiramente editado, algo que n√£o pertence √†s explica√ß√µes fornecidas aqui foi removido, a fim de tornar essas explica√ß√µes mais compreens√≠veis. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f4a/50e/d6d/f4a50ed6d13e445eaf3d9c55293e7999.jpg" alt="imagem"></div><a name="habracut"></a><br><h2>  <font color="#3AC1EF">Primeiro exemplo</font> </h2><br>  A primeira fun√ß√£o que vou analisar aqui √© um mecanismo simples para adicionar n√∫meros: <br><br><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span>{    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b }</code> </pre> <br>  Essa fun√ß√£o √© muito simples e, talvez, nada seja mais f√°cil de n√£o surgir.  Ele se traduz no seguinte c√≥digo Go SSA: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">myAdd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, b </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">b</span></span></span><span class="hljs-function">                                                    </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span></span></code> </pre> <br>  Com essa representa√ß√£o da fun√ß√£o, as dicas sobre os tipos de dados s√£o colocadas √† direita; na maioria dos casos, voc√™ pode ignor√°-las. <br><br>  Este pequeno exemplo j√° permite que voc√™ veja a ess√™ncia de um aspecto do SSA.  Ou seja, ao converter c√≥digo para o formato SSA, cada express√£o √© dividida nas partes mais elementares das quais consiste.  No nosso caso, o comando <code>return a + b</code> , de fato, representa duas opera√ß√µes: adicionando dois n√∫meros e retornando o resultado. <br><br>  Al√©m disso, aqui voc√™ pode ver os blocos b√°sicos do programa, neste c√≥digo h√° apenas um bloco - a entrada (bloco de entrada).  Falaremos mais sobre os blocos abaixo. <br><br>  O c√≥digo Go SSA pode ser facilmente convertido em LLVM IR: <br><br><pre> <code class="go hljs">define i64 @myAdd(i64 %a, i64 %b) { entry: %<span class="hljs-number"><span class="hljs-number">0</span></span> = add i64 %a, %b ret i64 %<span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br>  Voc√™ pode perceber que, embora outras constru√ß√µes sint√°ticas sejam usadas aqui, a estrutura da fun√ß√£o basicamente n√£o foi alterada.  O c√≥digo IR LLVM √© um pouco mais forte que o c√≥digo Go SSA, semelhante a C. Aqui, na declara√ß√£o de fun√ß√£o, primeiro vem uma descri√ß√£o do tipo de dados retornado, o tipo de argumento √© indicado antes do nome do argumento.  Al√©m disso, para simplificar a an√°lise de IR, os nomes das entidades globais s√£o precedidos pelo s√≠mbolo <code>@</code> e, antes dos nomes das entidades locais, pelo caractere <code>%</code> (a fun√ß√£o tamb√©m √© considerada uma entidade global). <br><br>  Um dos recursos desse c√≥digo que voc√™ precisa prestar aten√ß√£o √© que a decis√£o de representar o tipo Go <code>int</code> , que pode ser representado por um valor de 32 ou 64 bits, dependendo do compilador e da finalidade da compila√ß√£o, √© tomada ao criar o LLVM C√≥digo IR.  Esse √© um dos muitos motivos pelos quais o c√≥digo LLVM IR n√£o √© independente da plataforma.  Esse c√≥digo criado para uma plataforma n√£o pode simplesmente ser utilizado e compilado para outra plataforma (a menos que voc√™ fa√ßa essa tarefa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">com extrema cautela</a> ). <br><br>  Outro ponto interessante a ser observado √© que o tipo <code>i64</code> n√£o √© um n√∫mero inteiro assinado: √© neutro em termos de representa√ß√£o do sinal do n√∫mero.  Dependendo da instru√ß√£o, ele pode representar n√∫meros assinados e n√∫meros n√£o assinados.  No caso de representar a opera√ß√£o de adi√ß√£o, isso n√£o desempenha um papel; portanto, n√£o h√° diferen√ßa em trabalhar com n√∫meros com ou sem sinal.  Aqui, eu gostaria de observar que em C, o excesso de uma vari√°vel inteira assinada leva a um comportamento indefinido; portanto, o front-end Clang adiciona o sinalizador <code>nsw</code> (sem quebra autom√°tica assinada) √† opera√ß√£o, o que indica ao LLVM que ele pode prosseguir com a suposi√ß√£o de que com adi√ß√£o nunca ocorre transbordamento. <br><br>  Isso pode ser importante para algumas otimiza√ß√µes.  Por exemplo, a adi√ß√£o de dois valores <code>i16</code> em uma plataforma de 32 bits (com registros de 32 bits) requer, ap√≥s a conclus√£o da adi√ß√£o, a opera√ß√£o de extens√£o de sinal para permanecer no intervalo <code>i16</code> .  Por esse motivo, geralmente √© mais eficiente executar opera√ß√µes inteiras, levando em considera√ß√£o o tamanho da m√°quina do registro. <br><br>  O que acontece no futuro com esse c√≥digo de RI n√£o √© particularmente interessante para n√≥s agora.  O c√≥digo √© otimizado (mas, no caso de um exemplo t√£o simples como o nosso, nada j√° est√° otimizado) e, em seguida, √© convertido em c√≥digo de m√°quina. <br><br><h2>  <font color="#3AC1EF">Segundo exemplo</font> </h2><br>  O exemplo a seguir, que examinaremos, ser√° um pouco mais complicado.  Ou seja, estamos falando de uma fun√ß√£o que soma a fatia de n√∫meros inteiros: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span></span> {   n := <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>(numbers); i++ {       n += numbers[i]   }   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n }</code> </pre> <br>  Este c√≥digo √© convertido no seguinte c√≥digo Go SSA: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">: 0:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t6</span></span></span><span class="hljs-function">] #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">n</span></span></span><span class="hljs-function">                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">phi</span></span></span><span class="hljs-function"> [</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">entry</span></span></span><span class="hljs-function">: 0:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">, </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t7</span></span></span><span class="hljs-function">] #</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">i</span></span></span><span class="hljs-function">                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t2</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">len</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(numbers)</span></span></span><span class="hljs-function">                                              </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t3</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> &lt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t2</span></span></span><span class="hljs-function">                                                  </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t3</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">goto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">else</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">body</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t4</span></span></span><span class="hljs-function"> = &amp;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">numbers</span></span></span><span class="hljs-function">[</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function">]                                             *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t5</span></span></span><span class="hljs-function"> = *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t4</span></span></span><span class="hljs-function">                                                       </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t6</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span><span class="hljs-function"> + </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t5</span></span></span><span class="hljs-function">                                                   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t7</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t1</span></span></span><span class="hljs-function"> + 1:</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">                                                </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">int</span></span></span><span class="hljs-function">   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jump</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">for</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">done</span></span></span><span class="hljs-function">:   </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">return</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">t0</span></span></span></span></code> </pre> <br>  Aqui voc√™ j√° pode ver mais constru√ß√µes espec√≠ficas para a apresenta√ß√£o do c√≥digo na forma de SSA.  Provavelmente, o recurso mais √≥bvio desse c√≥digo √© o fato de que n√£o h√° comandos estruturados de controle de fluxo.  Para controlar o fluxo de c√°lculos, existem apenas saltos condicionais e incondicionais e, se considerarmos esse comando como um comando para controlar o fluxo, um comando de retorno. <br><br>  De fato, aqui voc√™ pode prestar aten√ß√£o ao fato de que o programa n√£o √© dividido em blocos usando chaves (como nos idiomas da fam√≠lia C).  √â dividido por etiquetas, que se assemelha a linguagens de montagem, e √© apresentado na forma de blocos de base.  No SSA, os blocos base s√£o sequ√™ncias cont√≠guas de c√≥digo que come√ßam com um r√≥tulo e terminam com instru√ß√µes para concluir o bloco base, por exemplo, <code>return</code> e <code>jump</code> . <br><br>  Outro detalhe interessante desse c√≥digo √© a instru√ß√£o <code>phi</code> .  A instru√ß√£o √© bastante incomum, pode levar algum tempo para descobrir.  Lembre-se de que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SSA</a> √© a abrevia√ß√£o de Atribui√ß√£o √∫nica est√°tica.  Essa √© uma representa√ß√£o intermedi√°ria do c√≥digo usado pelos compiladores, no qual cada vari√°vel √© atribu√≠da apenas uma vez.  Isso √© √≥timo para expressar fun√ß√µes simples como nossa fun√ß√£o <code>myAdd</code> mostrada acima, mas n√£o para fun√ß√µes mais complexas, como a fun√ß√£o <code>sum</code> , discutida nesta se√ß√£o.  Em particular, durante a execu√ß√£o do loop, as vari√°veis <code>i</code> e <code>n</code> mudam. <br><br>  O SSA ignora a restri√ß√£o em uma √∫nica atribui√ß√£o de valores de vari√°veis ‚Äã‚Äãusando a chamada instru√ß√£o <code>phi</code> (seu nome √© retirado do alfabeto grego).  O fato √© que, para que a representa√ß√£o SSA do c√≥digo possa ser formada para idiomas como C, √© necess√°rio recorrer a alguns truques.  O resultado da chamada desta instru√ß√£o √© o valor atual da vari√°vel ( <code>i</code> ou <code>n</code> ) e uma lista de blocos base √© usada como seus par√¢metros.  Por exemplo, considere esta instru√ß√£o: <br><br><pre> <code class="go hljs">t0 = phi [entry: <span class="hljs-number"><span class="hljs-number">0</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body: t6] #n</code> </pre> <br>  Seu significado √© o seguinte: se o bloco base anterior era um bloco de <code>entry</code> (entrada), <code>t0</code> √© constante <code>0</code> e se o bloco base anterior era <code>for.body</code> , √© necess√°rio pegar o valor <code>t6</code> desse bloco.  Tudo isso pode parecer bastante misterioso, mas gra√ßas a esse mecanismo, o SSA √© garantido.  Do ponto de vista humano, tudo isso complica a compreens√£o do c√≥digo, mas o fato de cada valor ser atribu√≠do apenas uma vez simplifica bastante muitas otimiza√ß√µes. <br><br>  Observe que se voc√™ estiver escrevendo seu pr√≥prio compilador, normalmente n√£o precisar√° lidar com essas coisas.  Mesmo Clang n√£o gera todas essas instru√ß√µes <code>phi</code> , usa o mecanismo <code>alloca</code> (se assemelha a trabalhar com vari√°veis ‚Äã‚Äãlocais comuns).  Em seguida, ao executar um passo de otimiza√ß√£o do LLVM, chamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mem2reg</a> , as instru√ß√µes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">alloca</a> s√£o convertidas para o formul√°rio SSA.  O TinyGo, no entanto, recebe entrada do Go SSA, que, convenientemente, j√° foi convertido para o formato SSA. <br><br>  Outra inova√ß√£o dessa parte do c√≥digo intermedi√°rio √© que o acesso aos elementos da fatia pelo √≠ndice √© apresentado na forma da opera√ß√£o de c√°lculo do endere√ßo e da opera√ß√£o de desreferenciamento do ponteiro obtido.  Aqui voc√™ pode ver a adi√ß√£o direta de constantes ao c√≥digo IR (por exemplo - <code>1:int</code> ).  No exemplo com a fun√ß√£o <code>myAdd</code> isso n√£o foi usado.  Agora que descobrimos esses recursos, veremos o que esse c√≥digo se tornar√° ao convert√™-lo para o formul√°rio de IR do LLVM: <br><br><pre> <code class="go hljs">define i64 @sum(i64* %ptr, i64 %<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>, i64 %<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>) { entry: br label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body, %entry %<span class="hljs-number"><span class="hljs-number">0</span></span> = phi i64 [ <span class="hljs-number"><span class="hljs-number">0</span></span>, %entry ], [ %<span class="hljs-number"><span class="hljs-number">5</span></span>, %deref.next ] %<span class="hljs-number"><span class="hljs-number">1</span></span> = phi i64 [ <span class="hljs-number"><span class="hljs-number">0</span></span>, %entry ], [ %<span class="hljs-number"><span class="hljs-number">6</span></span>, %deref.next ] %<span class="hljs-number"><span class="hljs-number">2</span></span> = icmp slt i64 %<span class="hljs-number"><span class="hljs-number">1</span></span>, %<span class="hljs-built_in"><span class="hljs-built_in">len</span></span> br i1 %<span class="hljs-number"><span class="hljs-number">2</span></span>, label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body, label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.done <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.body:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop %<span class="hljs-number"><span class="hljs-number">3</span></span> = getelementptr i64, i64* %ptr, i64 %<span class="hljs-number"><span class="hljs-number">1</span></span> %<span class="hljs-number"><span class="hljs-number">4</span></span> = load i64, i64* %<span class="hljs-number"><span class="hljs-number">3</span></span> %<span class="hljs-number"><span class="hljs-number">5</span></span> = add i64 %<span class="hljs-number"><span class="hljs-number">0</span></span>, %<span class="hljs-number"><span class="hljs-number">4</span></span> %<span class="hljs-number"><span class="hljs-number">6</span></span> = add i64 %<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span> br label %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.done:                                         ; preds = %<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>.loop ret i64 %<span class="hljs-number"><span class="hljs-number">0</span></span> }</code> </pre> <br>  Aqui, como antes, podemos ver a mesma estrutura, que inclui outras constru√ß√µes sint√°ticas.  Por exemplo, nas chamadas <code>phi</code> , valores e etiquetas s√£o trocados.  No entanto, tamb√©m h√° algo que vale a pena prestar aten√ß√£o especial. <br><br>  Para iniciantes, aqui voc√™ pode ver uma assinatura completamente diferente da fun√ß√£o.  O LLVM n√£o suporta fatias, como resultado, na forma de otimiza√ß√£o, o compilador TinyGo, que gerou esse c√≥digo intermedi√°rio, dividiu a descri√ß√£o dessa estrutura de dados em partes.  Ele poderia representar tr√™s elementos de fatia ( <code>ptr</code> , <code>len</code> e <code>cap</code> ) como uma estrutura (struct), mas apresent√°-los como tr√™s entidades separadas permite algumas otimiza√ß√µes.  Outros compiladores podem apresentar a fatia de alguma outra maneira, isso depende das conven√ß√µes para chamar fun√ß√µes da plataforma de destino. <br><br>  Outra caracter√≠stica interessante desse c√≥digo √© o uso da <code>getelementptr</code> (geralmente chamada de GEP para abreviar). <br><br>  Esta instru√ß√£o funciona com ponteiros e √© usada para obter um ponteiro para um elemento de fatia.  Por exemplo, vamos compar√°-lo com o seguinte c√≥digo escrito em C: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* sliceptr(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *ptr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> &amp;ptr[index]; }</code> </pre> <br>  Ou com o seguinte equivalente a isso: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span>* sliceptr(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *ptr, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index) {   <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ptr + index; }</code> </pre> <br>  O mais importante aqui √© que a instru√ß√£o <code>getelementptr</code> n√£o executa opera√ß√µes de desrefer√™ncia.  Ele calcula apenas um novo ponteiro com base no existente.  Pode ser interpretado como <code>mul</code> e <code>add</code> no n√≠vel do hardware.  Detalhes sobre as instru√ß√µes do GEP podem ser encontrados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Outra caracter√≠stica interessante desse c√≥digo intermedi√°rio √© o uso da instru√ß√£o <code>icmp</code> .  Esta √© uma instru√ß√£o de uso geral usada para implementar compara√ß√µes de n√∫meros inteiros.  O resultado desta instru√ß√£o √© sempre um valor do tipo <code>i1</code> - um valor l√≥gico.  Nesse caso, √© feita uma compara√ß√£o usando a palavra-chave <code>slt</code> (com <code>slt</code> menor que), pois estamos comparando dois n√∫meros anteriormente representados pelo tipo <code>int</code> .  Se compar√°ssemos dois n√∫meros inteiros n√£o assinados, <code>icmp</code> como uma instru√ß√£o, e a palavra-chave usada na compara√ß√£o seria <code>ult</code> .  Para comparar n√∫meros de ponto flutuante, outra instru√ß√£o √© usada, <code>fcmp</code> , que funciona de maneira semelhante. <br><br><h2>  <font color="#3AC1EF">Sum√°rio</font> </h2><br>  Acredito que neste artigo examinei os recursos mais importantes do LLVM IR.  Claro, ainda h√° muitas coisas.  Em particular, na representa√ß√£o intermedi√°ria do c√≥digo, pode haver muitas anota√ß√µes que permitem levar em considera√ß√£o certos recursos do c√≥digo conhecidos pelo compilador durante as passagens de otimiza√ß√£o que n√£o podem ser expressos de outra maneira no IR.  Por exemplo, esses s√£o os sinalizadores <code>inbounds</code> instru√ß√£o <code>inbounds</code> ou os <code>nuw</code> <code>nsw</code> e <code>nuw</code> , que podem ser adicionados √† instru√ß√£o <code>add</code> .  O mesmo se aplica √† palavra-chave <code>private</code> , que indica ao otimizador que a fun√ß√£o marcada por ele n√£o ser√° referenciada de fora da unidade de compila√ß√£o atual.  Isso permite que voc√™ execute muitas otimiza√ß√µes interprocedimentais interessantes, como a elimina√ß√£o de argumentos n√£o utilizados. <br><br>  Voc√™ pode ler mais sobre o LLVM na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> , √† qual voc√™ frequentemente se refere ao desenvolver seu pr√≥prio compilador baseado em LLVM.  Aqui est√° um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">guia</a> que discute o desenvolvimento do compilador para uma linguagem muito simples.  Ambas as fontes de informa√ß√£o ser√£o √∫teis ao criar seu pr√≥prio compilador. <br><br>  <b>Caros leitores!</b>  Voc√™ usa LLVM? <br><br><div style="text-align:center;"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><img src="https://habrastorage.org/files/1ba/550/d25/1ba550d25e8846ce8805de564da6aa63.png"></a> </div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt451476/">https://habr.com/ru/post/pt451476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt451460/index.html">Julia no labirinto</a></li>
<li><a href="../pt451462/index.html">Escreva menos c√≥digo duplicado usando binders no Laravel</a></li>
<li><a href="../pt451464/index.html">Frontend Weekly Digest (6-12 maio 2019)</a></li>
<li><a href="../pt451466/index.html">graphql - armadilhas</a></li>
<li><a href="../pt451468/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 364 (6 a 12 de maio de 2019)</a></li>
<li><a href="../pt451478/index.html">Acelerando a explora√ß√£o de dados usando a biblioteca de cria√ß√£o de perfil de pandas</a></li>
<li><a href="../pt451480/index.html">Por que o Minist√©rio da Ind√∫stria e Com√©rcio pro√≠be o armazenamento de dados em equipamentos estrangeiros</a></li>
<li><a href="../pt451482/index.html">Compet√™ncias de um programador moderno de um √¢ngulo diferente</a></li>
<li><a href="../pt451488/index.html">C√°lculo da canibaliza√ß√£o com base no teste A / B cl√°ssico e no m√©todo de autoinicializa√ß√£o</a></li>
<li><a href="../pt451492/index.html">Sete vari√°veis ‚Äã‚Äãinesperadas do bash</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>