<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛴️ 🐩 🤨 De Skype a WebRTC: cómo organizamos la comunicación de video web 🖖🏿 ◼️ 🏑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Las videollamadas son la forma principal en que los profesores y los estudiantes se comunican en la plataforma Vimbox. Abandonamos Skype hace mucho ti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>De Skype a WebRTC: cómo organizamos la comunicación de video web</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/skyeng/blog/446444/"><p><img src="https://habrastorage.org/webt/x2/8r/sa/x28rsajn_qhclxrijy3jx5xynca.jpeg"></p><br><p>  Las videollamadas son la forma principal en que los profesores y los estudiantes se comunican en la plataforma Vimbox.  Abandonamos Skype hace mucho tiempo, probamos varias soluciones de terceros y finalmente nos decidimos por un montón de WebRTC: Janus-gateway.  Por un tiempo, todo estuvo bien con nosotros, pero aún así algunos puntos negativos continuaron reptando.  Como resultado, se creó una dirección de video separada. </p><br><p>  Le pedí a Kirill Rogovoy, jefe de la nueva dirección, que hablara sobre la evolución de las comunicaciones de video en Skyeng, los problemas, las soluciones y las muletas que eventualmente aplicamos.  Esperamos que este artículo sea útil para las empresas que también hacen videos por su cuenta a través de una aplicación web. </p><a name="habracut"></a><br><h2 id="nemnogo-istorii">  Un poco de historia </h2><br><p>  En el verano de 2017, Sergey Safonov, jefe de desarrollo de Skyeng, habló en Backend Conf sobre cómo "abandonamos Skype e implementamos WebRTC".  Aquellos que lo deseen pueden ver la grabación de la actuación por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">referencia</a> (~ 45 min), pero aquí resumiré brevemente su esencia. </p><br><p>  Para Skyeng, la comunicación por video siempre ha sido un método de comunicación maestro-alumno prioritario.  Al principio, se usó Skype, pero categóricamente no era adecuado por varias razones, principalmente debido a la falta de registros y la incapacidad de integrarse directamente en la aplicación web.  Por lo tanto, realizamos todo tipo de experimentos. </p><br><p>  En realidad, los requisitos para la comunicación por video fueron aproximadamente los siguientes: <br>  - estabilidad; <br>  - bajo precio por clase; <br>  - grabación de lecciones; <br>  - rastrear quién dice cuánto (es importante para nosotros que los estudiantes hablen más en el aula que el profesor); <br>  - escala lineal; <br>  - La capacidad de usar tanto UDP como TCP. </p><br><p>  El primero en 2013 intentó implementar Tokbox.  Todo estaba bien, pero resultó muy costoso, 113 rublos por lección, y se comió la ganancia. </p><br><p>  Luego, en 2015, se integró Voximplant.  Aquí estaba la función de seguimiento que necesitábamos, quién dice cuánto y, al mismo tiempo, la solución era mucho más barata: siempre que solo se grabara el sonido, salían 20 rublos por lección.  Sin embargo, funcionaba solo a través de UDP; cambiar a TCP no era una habilidad.  Sin embargo, al final, alrededor del 40% de los estudiantes lo usaron. </p><br><p>  Un año después, los clientes corporativos comenzaron a aparecer con sus requisitos específicos.  Por ejemplo, todo debería funcionar a través de un navegador, solo http y https están abiertos en la empresa;  es decir, no Skype y UDP.  Clientes corporativos = dinero, por lo que regresaron a Tokbox, pero el problema del precio no ha desaparecido. </p><br><h2 id="reshenie----webrtc-i-janus">  Solución - WebRTC y Janus </h2><br><p>  Decidimos usar la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">plataforma</a> del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">navegador para comunicaciones de video punto a punto WebRTC</a> .  Es responsable de establecer conexiones, codificar y decodificar secuencias, sincronizar pistas y controlar la calidad con el procesamiento de fallas en la red.  Por nuestra parte, debemos asegurarnos de que se lean los flujos de la cámara y el micrófono, se dibuje el video, se establezca la conexión, se establezca la conexión WebRTC y se transmitan los flujos, así como la transmisión de mensajes de señal entre los clientes para establecer la conexión (el propio WebRTC describe solo el formato de datos, pero no su mecanismo transmisión).  En caso de que los clientes estén detrás de NAT, WebRTC conecta los servidores STUN, si esto no ayuda, los servidores TURN. </p><br><p>  La conexión p2p habitual no es suficiente para nosotros, porque queremos grabar lecciones para su posterior análisis en caso de quejas.  Por lo tanto, enviamos transmisiones WebRTC a través <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">del repetidor Janus Gateway de Meetecho</a> .  Como resultado, los clientes no conocen las direcciones de los demás y solo ven la dirección del servidor Janus;  También realiza las funciones de un servidor de señales.  Janus tiene muchas características que necesitamos: cambia automáticamente a TCP si UDP está bloqueado en el cliente;  capaz de grabar secuencias de UDP y TCP;  escalable  Incluso hay un complemento incorporado para las pruebas de eco.  Si es necesario, los servidores STUN y TURN de Twilio se conectan automáticamente. </p><br><p>  En el verano de 2017, teníamos dos servidores Janus, más un servidor adicional para procesar archivos de audio y video en bruto grabados, para no ocupar los procesadores principales.  Al conectarse, los servidores Janus se seleccionaron de manera impar (número de conexión).  En ese momento, esto era suficiente, de acuerdo con nuestros sentimientos, daba alrededor de cuatro veces el margen de seguridad, el porcentaje de implementación era de aproximadamente 80. Al mismo tiempo, el precio bajó a ~ 2 rublos por lección, más desarrollo y soporte. </p><br><p><img src="https://habrastorage.org/webt/es/gs/r4/esgsr45zdgwhshnajhff5cq6ve8.png"></p><br><h2 id="vozvraschenie-k-teme-videosvyazi">  Regrese al tema de las videollamadas </h2><br><p>  Monitoreamos constantemente los comentarios de los estudiantes y maestros para identificar y detener los problemas a tiempo.  Para el verano de 2018, en primer lugar entre las quejas, la calidad de la comunicación estaba firmemente arraigada.  Por un lado, esto significaba que habíamos tratado con éxito otras deficiencias.  Por otro lado, había una necesidad urgente de hacer algo: si se rompe la lección, corremos el riesgo de perder su costo, a veces junto con el costo de comprar el siguiente paquete, y si se pierde la lección introductoria, perdemos al cliente potencial por completo. </p><br><p>  En ese momento, la comunicación por video todavía estaba en modo MVP.  En pocas palabras, lo lanzaron, funcionó, escalaron una vez, descubrieron cómo hacerlo, bueno, eso es bueno.  Si funciona, no lo arregles.  Nadie trató deliberadamente el tema de la calidad de la comunicación.  En agosto, quedó claro que esto no podía continuar más, y lanzamos un área separada para descubrir qué estaba pasando con WebRTC y Janus. </p><br><p>  En la entrada, esta dirección recibió: solución MVP, sin métricas, sin objetivos, sin procesos de mejora, mientras que el 7% de los maestros se quejan de la calidad de la comunicación (tampoco hubo datos sobre los estudiantes). </p><br><p><img src="https://habrastorage.org/webt/un/1-/fs/un1-fs1ld_vqjqos_ciwnctapog.png"></p><br><h2 id="novoe-napravlenie-beretsya-za-rabotu">  Se toma una nueva dirección para el trabajo </h2><br><p>  El comando se ve así: </p><br><ul><li>  El jefe de la dirección, él es el desarrollador principal. </li><li>  QA ayuda a probar los cambios, busca nuevas formas de crear condiciones inestables para la comunicación, informa problemas desde la primera línea. </li><li>  El analista busca constantemente diferentes correlaciones en los datos técnicos, mejora el análisis de los comentarios de los usuarios, verifica los resultados de los experimentos. </li><li>  El gerente de producto ayuda con la dirección general y la asignación de recursos para experimentos. </li><li>  Con la programación misma y las tareas relacionadas, un segundo desarrollador a menudo ayuda. </li></ul><br><p>  Para comenzar, establecimos una métrica relativamente confiable que rastreó los cambios en la evaluación de la calidad de la comunicación (promedio por días, semanas, meses).  En ese momento, estas eran calificaciones de los maestros, y se les agregaron calificaciones adicionales de los estudiantes.  Luego comenzaron a construir hipótesis de lo que no funciona, para corregir y observar los cambios en la dinámica.  Optamos por frutas bajas: por ejemplo, reemplazamos el códec vp8 con vp9, el rendimiento mejoró.  Intentamos jugar con la configuración de Janus, realizar otros experimentos, en la mayoría de los casos, sin resultado. </p><br><p>  En la segunda etapa, apareció una hipótesis: WebRTC es una solución punto a punto, y usamos el servidor en el medio.  Quizás el problema yace aquí?  Comenzaron a cavar y encontraron aquí la mejora más significativa hasta ahora. </p><br><p>  En ese momento, el servidor del grupo se seleccionó de acuerdo con un algoritmo bastante estúpido: cada uno tenía su propio "peso", dependiendo del canal y la potencia, e intentamos enviar al usuario a aquel en el que el "peso" es mayor, sin prestar atención a la ubicación geográfica del usuario .  Como resultado, un maestro de San Petersburgo podría comunicarse con un estudiante de Siberia a través de Moscú, y no a través de nuestro servidor Janus en San Petersburgo. </p><br><p>  El algoritmo se rehizo: ahora, cuando el usuario abre nuestra plataforma, usamos Ajax para recopilar pings de él en todos los servidores.  Al establecer una conexión, seleccionamos un par de pings (maestro-servidor y alumno-servidor) con la menor cantidad.  Menos ping: menos distancia de red al servidor;  menos distancia: menos posibilidades de perder paquetes;  la pérdida de paquetes es el mayor factor negativo en las videollamadas.  La proporción de negatividad cayó dos veces en tres meses (para ser justos, también se llevaron a cabo otros experimentos en este momento, pero este casi seguramente afectó más). </p><br><p><img src="https://habrastorage.org/webt/41/ij/4l/41ij4lpfz5hsfbbmyy4sxegowdg.png"></p><br><p><img src="https://habrastorage.org/webt/52/xf/6l/52xf6ljwsrqhlq7ad8bvoeyf_00.png"></p><br><p>  Recientemente, descubrimos otra cosa no obvia, pero aparentemente importante: en lugar de un poderoso servidor Janus en un canal grueso, dos son más simples con un ancho de banda mejor.  Esto resultó después de que compramos máquinas potentes con la esperanza de llenar tantas salas (sesiones de comunicación) como fuera posible al mismo tiempo.  Los servidores tienen un límite de ancho de banda que podemos traducir con precisión en la cantidad de habitaciones; sabemos cuánto puede abrir, por ejemplo, a 300 Mbps.  Tan pronto como se abran demasiadas salas en el servidor, dejamos de elegirlo para nuevas actividades hasta que la carga disminuya.  La idea era que, después de haber comprado una máquina potente, cargaremos el canal al máximo para que al final descanse en el procesador y la memoria, y no en el ancho de banda.  Pero resultó que después de un cierto número de salas abiertas (420), a pesar de que la carga en el procesador, la memoria y el disco aún está muy lejos de los límites, la negatividad comienza a volar hacia el soporte técnico.  Aparentemente, algo está empeorando dentro de Janus, tal vez también hay algunas restricciones.  Comenzaron a experimentar, redujeron el límite de ancho de banda de 300 a 200 Mbps, los problemas desaparecieron.  Ahora compramos tres nuevos servidores a la vez con bajos límites y características, creemos que esto conducirá a una mejora estable en la calidad de la comunicación.  Por supuesto, no comenzamos a descubrir qué pasaba allí, las muletas eran nuestras.  En nuestra defensa, decimos que en ese momento era necesario resolver el problema urgente lo más rápido posible, y no hacerlo bellamente;  Además, Janus es una caja negra para nosotros, escrita en C, es muy costoso profundizar en ella. </p><br><p><img src="https://habrastorage.org/webt/jy/n_/xc/jyn_xcm_wkz7rmm_oemq5yvr8jo.png"></p><br><p>  Bueno, en el proceso nosotros: </p><br><ul><li>  actualizó todas las dependencias que podrían actualizarse, tanto en el servidor como en el cliente (estos también fueron experimentos, seguidos del resultado); </li><li>  Se corrigieron todos los errores identificados relacionados con casos específicos, por ejemplo, cuando se cortó la conexión y no se restableció automáticamente; </li><li>  mantuvimos muchas reuniones con empresas que trabajan en el campo de las comunicaciones de video y están familiarizadas con nuestros problemas: transmisión de juegos, organización de seminarios web;  probó todo lo que nos pareció útil; </li><li>  llevó a cabo una revisión técnica del hierro y la calidad de la comunicación con los maestros, de donde surgieron la mayoría de las quejas. </li></ul><br><p>  Los experimentos y los cambios posteriores permitieron reducir la insatisfacción con la comunicación entre los docentes del 7,1% en enero de 2018 al 2,5% en enero de 2019. </p><br><h2 id="chto-dalshe">  Que sigue </h2><br><p>  La estabilización de nuestra plataforma Vimbox es uno de los principales proyectos de la compañía para 2019.  Tenemos grandes esperanzas de que podremos mantener el impulso y no ver más la comunicación por video en las principales quejas.  Entendemos que una parte importante de estas quejas está relacionada con los retrasos de las computadoras y la Internet de los usuarios, pero debemos determinar esta parte y resolver todo lo demás.  Todo lo demás es un problema técnico, parece que deberíamos ser capaces de solucionarlo. </p><br><p>  La principal dificultad es que no sabemos a qué nivel es generalmente realista mejorar la calidad.  La aclaración de este techo es la tarea principal.  Por lo tanto, se planearon dos experimentos: </p><br><ol><li>  Compara el video a través de Janus con p2p regular en combate.  Este experimento ya se ha llevado a cabo; no se encontraron diferencias estadísticamente significativas entre nuestra solución y p2p; </li><li>  suministraremos servicios (caros) de compañías que ganen exclusivamente en soluciones de comunicaciones de video, y compararemos la cantidad de negativos de ellos con la existente. </li></ol><br><p>  Estos dos experimentos nos permitirán determinar un objetivo alcanzable y concentrarnos en él. </p><br><p>  Además, hay varias tareas resueltas en el orden de trabajo: </p><br><ul><li>  creamos una métrica técnica de calidad de comunicación en lugar de revisiones subjetivas; </li><li>  hacemos registros de sesiones más detallados para analizar con mayor precisión las fallas que ocurren, para comprender cuándo y dónde ocurrieron exactamente, qué eventos aparentemente no relacionados ocurrieron en ese momento; </li><li>  estamos preparando una prueba automática de la calidad de la comunicación antes de la clase, y también permitiremos que el cliente pruebe manualmente la conexión para reducir la cantidad de negativas causadas por su hierro y canal; </li><li>  Desarrollaremos y realizaremos más pruebas de estrés de comunicaciones de video en malas condiciones, con pérdida variable de paquetes, etc. </li><li>  Cambiamos el comportamiento de los servidores en caso de problemas para aumentar la tolerancia a fallas; </li><li>  advertiremos al usuario si tiene algún problema con la conexión, como lo hace el mismo Skype, para que comprenda que el problema está de su lado. </li></ul><br><p>  Desde abril, la dirección de comunicación por video se ha convertido en un proyecto independiente completo dentro de Skyeng, dedicado a su propio producto, no solo a una parte de Vimbox.  Y esto significa que estamos comenzando a buscar personas para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">trabajar con video en modo de tiempo completo</a> .  Bueno, como siempre, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estamos buscando mucha gente buena</a> . </p><br><p>  Bueno, por supuesto, continuamos comunicándonos activamente con personas y empresas que trabajan con comunicaciones de video.  Si desea intercambiar experiencias con nosotros, ¡estaremos encantados!  Comentario, contacto: responderemos a todos. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/446444/">https://habr.com/ru/post/446444/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446432/index.html">Se celebró un seminario sobre gestión de documentos técnicos en Crimea</a></li>
<li><a href="../446434/index.html">Escala de Zimbra Collaboration Suite</a></li>
<li><a href="../446436/index.html">Cómo generar hipótesis sobre las necesidades de los consumidores potenciales de su producto futuro</a></li>
<li><a href="../446438/index.html">Nuestra experiencia de creación de API de puerta de enlace</a></li>
<li><a href="../446440/index.html">El libro Reacciona rápido. Aplicaciones web en React, JSX, Redux y GraphQL »</a></li>
<li><a href="../446446/index.html">Conceptos básicos del motor de JavaScript: formularios generales y almacenamiento en caché en línea. Parte 1</a></li>
<li><a href="../446448/index.html">5 reglas básicas para realizar entrevistas problemáticas para identificar las necesidades del consumidor</a></li>
<li><a href="../446452/index.html">Misión lunar "Bereshit": el 4 de abril de 2019, se completó la transición a la órbita lunar, 7 días de vuelo por delante, 6 maniobras y 1 aterrizaje</a></li>
<li><a href="../446454/index.html">Desarrollo del servidor web de Golang: de fácil a complejo</a></li>
<li><a href="../446456/index.html">Sustitución de importaciones en la práctica. Parte 1. Opciones</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>