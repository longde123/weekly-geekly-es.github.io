<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ•ºğŸ¼ â›¹ğŸ» ğŸ‘¼ğŸ¿ é€šè¿‡Djangoåº”ç”¨ç¨‹åºä½¿ç”¨asyncioå’Œaiohttpå‘é€ç”µå­é‚®ä»¶ ğŸ—³ï¸ ğŸ° ğŸ•™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ï¼ 

 æˆ‘æ­£åœ¨Ostrovok.ruä¸­å¼€å‘å’Œæ”¯æŒé€šçŸ¥æœåŠ¡ã€‚ è¯¥æœåŠ¡ä½¿ç”¨Python3å’ŒDjangoç¼–å†™ã€‚ é™¤äº†äº¤æ˜“ä¿¡ä»¶ï¼Œæ¨é€å’Œæ¶ˆæ¯å¤–ï¼Œè¯¥æœåŠ¡è¿˜æ‰¿æ‹…å‘åŒæ„çš„ç”¨æˆ·æ‰¹é‡å‘é€å•†ä¸šæŠ¥ä»·ï¼ˆä¸æ˜¯åƒåœ¾é‚®ä»¶ï¼ç›¸ä¿¡æˆ‘ï¼Œé€€è®¢æ¯”è®¢é˜…æ›´å¥½çš„å·¥ä½œï¼‰çš„ä»»åŠ¡ã€‚ éšç€æ—¶é—´çš„æµé€ï¼Œæ´»åŠ¨æ”¶ä»¶äººçš„æ•°é‡å¢åŠ åˆ°è¶…è¿‡ä¸€ç™¾ä¸‡ï¼Œè€Œé‚®ä»¶æœåŠ¡å°š...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>é€šè¿‡Djangoåº”ç”¨ç¨‹åºä½¿ç”¨asyncioå’Œaiohttpå‘é€ç”µå­é‚®ä»¶</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/482114/"> å¤§å®¶å¥½ï¼ <br><br> æˆ‘æ­£åœ¨<a href="https://www.ostrovok.ru/%3Futm_source%3Dhabr%26utm_medium%3Dpr%26utm_campaign%3Dporyvaev_dec19%26utm_content%3Darticle">Ostrovok.ruä¸­</a>å¼€å‘å’Œæ”¯æŒé€šçŸ¥æœåŠ¡ã€‚ è¯¥æœåŠ¡ä½¿ç”¨Python3å’ŒDjangoç¼–å†™ã€‚ é™¤äº†äº¤æ˜“ä¿¡ä»¶ï¼Œæ¨é€å’Œæ¶ˆæ¯å¤–ï¼Œè¯¥æœåŠ¡è¿˜æ‰¿æ‹…å‘åŒæ„çš„ç”¨æˆ·æ‰¹é‡å‘é€å•†ä¸šæŠ¥ä»·ï¼ˆä¸æ˜¯åƒåœ¾é‚®ä»¶ï¼ç›¸ä¿¡æˆ‘ï¼Œé€€è®¢æ¯”è®¢é˜…æ›´å¥½çš„å·¥ä½œï¼‰çš„ä»»åŠ¡ã€‚ éšç€æ—¶é—´çš„æµé€ï¼Œæ´»åŠ¨æ”¶ä»¶äººçš„æ•°é‡å¢åŠ åˆ°è¶…è¿‡ä¸€ç™¾ä¸‡ï¼Œè€Œé‚®ä»¶æœåŠ¡å°šæœªå‡†å¤‡å¥½ã€‚ æˆ‘æƒ³è°ˆè°ˆæ–°çš„PythonåŠŸèƒ½å¦‚ä½•ä½¿åŠ é€Ÿå¤§é‡é‚®ä»¶å‘é€å’ŒèŠ‚çœèµ„æºæˆä¸ºå¯èƒ½ï¼Œä»¥åŠåœ¨ä½¿ç”¨å®ƒä»¬æ—¶æˆ‘ä»¬å¿…é¡»è§£å†³å“ªäº›é—®é¢˜ã€‚ <br><br><img src="https://habrastorage.org/webt/qj/b-/xa/qjb-xaiilstmnucwa2xko6onw34.png"><br><a name="habracut"></a><br><h3> æºå®ç° </h3><br> æœ€åˆï¼Œä»¥æœ€ç®€å•çš„æ–¹å¼å®ç°ç¾¤å‘é‚®ä»¶ï¼šå¯¹äºæ¯ä¸ªæ”¶ä»¶äººï¼Œå°†ä¸€ä¸ªä»»åŠ¡æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè¯¥é˜Ÿåˆ—ç”±60ä¸ªç¾¤å‘å·¥ä½œè€…ä¹‹ä¸€æ‰¿æ‹…ï¼ˆæˆ‘ä»¬çš„é˜Ÿåˆ—çš„åŠŸèƒ½æ˜¯æ¯ä¸ªå·¥ä½œè€…åœ¨å•ç‹¬çš„è¿›ç¨‹ä¸­å·¥ä½œï¼‰ï¼Œä¸ºå…¶å‡†å¤‡ä¸Šä¸‹æ–‡ï¼Œå‘ˆç°æ¨¡æ¿ï¼Œç„¶åå‘é€å‘Mailgunå‘é€HTTPè¯·æ±‚ä»¥å‘é€ä¸€å°ä¿¡ï¼Œå¹¶åœ¨æ•°æ®åº“ä¸­åˆ›å»ºäº†å‘é€è¯¥ä¿¡çš„è®°å½•ã€‚ æ•´ä¸ªé‚®ä»¶è¿‡ç¨‹æœ€å¤šéœ€è¦12ä¸ªå°æ—¶ï¼Œæ¯ä¸ªå·¥äººæ¯ç§’å‘é€å¤§çº¦0.3å°ä¿¡ï¼Œå¹¶é˜»æ­¢äº†å°å‹æ´»åŠ¨çš„é‚®å¯„ã€‚ <br><br><img src="https://habrastorage.org/webt/qk/7p/sg/qk7psgslwi6wa0vyhjaafg7bqkq.png"><br><br><h3> å¼‚æ­¥è§£å†³æ–¹æ¡ˆ </h3><br> å¿«é€Ÿå‰–ææ˜¾ç¤ºï¼Œå·¥ä½œäººå‘˜å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨ä¸Mailgunå»ºç«‹è¿æ¥ä¸Šï¼Œå› æ­¤æˆ‘ä»¬å¼€å§‹å°†ä»»åŠ¡æŒ‰å·¥ä½œäººå‘˜åˆ†ç»„ã€‚ å·¥äººå¼€å§‹ä¸Mailgunä½¿ç”¨ä¸€ç§è¿æ¥ï¼Œè¿™ä½¿é‚®ä»¶å‘é€æ—¶é—´å‡å°‘åˆ°9å°æ—¶ï¼Œå¹³å‡æ¯ä½å·¥äººæ¯ç§’å‘é€0.5ä¸ªå­—æ¯ã€‚ éšåçš„åˆ†æå†æ¬¡è¡¨æ˜ï¼Œä½¿ç”¨ç½‘ç»œä»ç„¶éœ€è¦èŠ±è´¹å¤§éƒ¨åˆ†æ—¶é—´ï¼Œè¿™ä¿ƒä½¿æˆ‘ä»¬ä½¿ç”¨asyncioã€‚ <br><br> åœ¨å°†æ‰€æœ‰å¤„ç†æ”¾å…¥å¼‚æ­¥å‘¨æœŸä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»ä»”ç»†è€ƒè™‘ä»¥ä¸‹é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼š <br><br><ol><li>  Django ORMå°šä¸èƒ½ä½¿ç”¨asyncioï¼Œä½†æ˜¯ï¼Œå®ƒåœ¨æŸ¥è¯¢æ‰§è¡ŒæœŸé—´é‡Šæ”¾äº†GILã€‚ è¿™æ„å‘³ç€æ•°æ®åº“æŸ¥è¯¢å¯ä»¥åœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œè€Œä¸ä¼šé˜»å¡ä¸»å¾ªç¯ã€‚ </li><li> å½“å‰ç‰ˆæœ¬çš„aiohttpéœ€è¦Python 3.6åŠæ›´é«˜ç‰ˆæœ¬ï¼Œåœ¨å®ç°æ—¶éœ€è¦æ›´æ–°dockeræ˜ åƒã€‚ åœ¨è¾ƒæ—§ç‰ˆæœ¬çš„aiohttpå’ŒPython 3.5ä¸Šè¿›è¡Œçš„å®éªŒè¡¨æ˜ï¼Œè¿™äº›ç‰ˆæœ¬çš„å‘é€é€Ÿåº¦è¿œä½äºè¾ƒæ–°ç‰ˆæœ¬çš„å‘é€é€Ÿåº¦ï¼Œä¸é¡ºåºå‘é€ç›¸å½“ã€‚ </li><li> å¿«é€Ÿå­˜å‚¨å¤§é‡å¼‚æ­¥corutinä¼šå¯¼è‡´æ‰€æœ‰å†…å­˜æ¶ˆè€—ã€‚ è¿™æ„å‘³ç€ä¸å¯èƒ½é¢„å…ˆå‡†å¤‡å¥½æ‰€æœ‰åç¨‹ä¸­çš„å­—æ¯å¹¶å¼•èµ·ä¸€ä¸ªå¤„ç†å®ƒä»¬çš„å‘¨æœŸï¼Œæœ‰å¿…è¦åœ¨å‘é€å·²ç»å½¢æˆçš„å­—æ¯æ—¶å‡†å¤‡æ•°æ®ã€‚ </li></ol><br> è€ƒè™‘åˆ°æ‰€æœ‰åŠŸèƒ½ï¼Œæˆ‘ä»¬å°†åœ¨æ¯ä¸ªå·¥äººå†…éƒ¨åˆ›å»ºä¸ThreadPoolæ¨¡å¼ç›¸ä¼¼çš„å¼‚æ­¥å‘¨æœŸï¼ŒåŒ…æ‹¬ï¼š <br><br><ul><li> ä¸€ä¸ªæˆ–å¤šä¸ªç”Ÿäº§è€…é€šè¿‡Django ORMåœ¨asyncio.ThreadPoolExecutorçš„å•ç‹¬çº¿ç¨‹ä¸­ä½¿ç”¨æ•°æ®åº“ã€‚ åˆ¶é€ å•†å°è¯•å°†æ•°æ®è·å–è¯·æ±‚èšåˆä¸ºå°æ‰¹é‡ï¼Œé€šè¿‡Jinja2æ¸²æŸ“æ¥æ”¶æ•°æ®çš„æ¨¡æ¿ï¼Œå¹¶å°†è¦å‘é€çš„æ•°æ®æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—ã€‚ </li></ul><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_campaign_send_data</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ids: Iterable[int])</span></span></span><span class="hljs-function"> -&gt; Iterable[Mapping[str, Any]]:</span></span> <span class="hljs-string"><span class="hljs-string">"""    ,     Django ORM   ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [{<span class="hljs-string"><span class="hljs-string">'id'</span></span>: id} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ids] <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_campaign_producer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ids: Iterable[int], task_queue: asyncio.Queue)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""           ,    .      ,     ThreadPoolExecutor. """</span></span> loop = asyncio.get_event_loop() total = len(ids) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> subchunk_start <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(<span class="hljs-number"><span class="hljs-number">0</span></span>, total, PRODUCER_SUBCHUNK_SIZE): subchunk_ids = ids[subchunk_start : min(subchunk_start + PRODUCER_SUBCHUNK_SIZE, total)] send_tasks = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> loop.run_in_executor(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, get_campaign_send_data, subchunk_ids) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> send_tasks: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> task_queue.put(task)</code> </pre> <br><ul><li> æ•°ç™¾ä¸ªä¿¡ä»¶å‘é€è€…-å¼‚æ­¥åç¨‹ï¼Œå®ƒä»¬æ— ä¼‘æ­¢åœ°ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è¯»å–æ•°æ®ï¼Œä¸ºæ¯ä¸ªä»»åŠ¡å‘é€ç½‘ç»œè¯·æ±‚ï¼Œå¹¶å°†ç»“æœï¼ˆå“åº”æˆ–å¼‚å¸¸ï¼‰æ”¾å…¥æŠ¥å‘Šé˜Ÿåˆ—ã€‚ <br></li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_mail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data: Mapping[str, Any], session: aiohttp.ClientSession)</span></span></span><span class="hljs-function"> -&gt; Union[Mapping[str, Any], Exception]:</span></span> <span class="hljs-string"><span class="hljs-string">"""    ."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> session.post(REQUEST_URL, data=data) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> response: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> response.status_code != <span class="hljs-number"><span class="hljs-number">200</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> Exception <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_campaign_sender</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( task_queue: asyncio.Queue, result_queue: asyncio.Queue, session: aiohttp.ClientSession )</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""        .     task_done,    ,   . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: task_data = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> task_queue.get() result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> send_mail(task_data, session) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> result_queue.put(result) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.CancelledError: <span class="hljs-comment"><span class="hljs-comment">#     raise except Exception as exception: #     await result_queue.put(exception) finally: task_queue.task_done()</span></span></code> </pre><br><ul><li> ä¸€ä¸ªæˆ–å¤šä¸ªå·¥ä½œäººå‘˜ï¼Œè´Ÿè´£å¯¹æŠ¥å‘Šé˜Ÿåˆ—ä¸­çš„æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œå¹¶æ ¹æ®è¯·æ±‚å‘å¤§å®¹é‡æ•°æ®åº“å‘é€ä¿¡ä»¶çš„ç»“æœæ”¾å…¥ä¿¡æ¯ã€‚ </li></ul><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">process_campaign_results</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(results: Iterable[Union[Mapping[str, Any], Exception]])</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  :         """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_campaign_reporter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(task_queue: asyncio.Queue, result_queue: asyncio.Queue)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""          ThreadPoolExecutor,        . """</span></span> loop = asyncio.get_event_loop() results_chunk = [] <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: results_chunk.append(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> result_queue.get()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(results_chunk) &gt;= REPORTER_BATCH_SIZE: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> loop.run_in_executor(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, process_campaign_results, results_chunk) results_chunk.clear() <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> asyncio.CancelledError: <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> loop.run_in_executor(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, process_campaign_results, results_chunk) results_chunk.clear() <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: result_queue.task_done()</code> </pre><br><ul><li> ä»»åŠ¡é˜Ÿåˆ—æ˜¯asyncio.Queueçš„ä¸€ä¸ªå®ä¾‹ï¼Œå—æœ€å¤§å…ƒç´ æ•°é‡é™åˆ¶ï¼Œä»¥ä¾¿åˆ¶é€ å•†ä¸ä¼šè¿‡åº¦å¡«å……å®ƒï¼Œè€Œæµªè´¹æ‰€æœ‰å†…å­˜ã€‚ </li><li> æŠ¥å‘Šé˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯asyncio.Queueçš„å®ä¾‹ï¼Œå…·æœ‰æœ€å¤§é¡¹ç›®æ•°é™åˆ¶ã€‚ </li><li> ä¸€ç§å¼‚æ­¥æ–¹æ³•ï¼Œå®ƒåˆ›å»ºé˜Ÿåˆ—ï¼Œå·¥ä½œå™¨å¹¶é€šè¿‡åœæ­¢å®ƒä»¬æ¥å®Œæˆåˆ†é…ã€‚ </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send_mail_campaign</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( recipient_ids: Iterable[int], session: aiohttp.ClientSession, loop: asyncio.AbstractEventLoop = None )</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""       .    ,       . """</span></span> executor = ThreadPoolExecutor(max_workers=PRODUCERS_COUNT + <span class="hljs-number"><span class="hljs-number">1</span></span>) loop = loop <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> asyncio.get_event_loop() loop.set_default_executor(executor) task_queue = asyncio.Queue(maxsize=<span class="hljs-number"><span class="hljs-number">2</span></span> * SENDERS_COUNT, loop=loop) result_queue = asyncio.Queue(maxsize=<span class="hljs-number"><span class="hljs-number">2</span></span> * SENDERS_COUNT, loop=loop) producers = [ asyncio.ensure_future(mail_campaign_producer(recipient_ids, task_queue)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(PRODUCERS_COUNT) ] consumers = [ asyncio.ensure_future(mail_campaign_sender(task_queue, result_queue, session)) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _ <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(SENDERS_COUNT) ] reporter = asyncio.ensure_future(mail_campaign_reporter(task_queue, result_queue)) <span class="hljs-comment"><span class="hljs-comment"># ,      done, _ = await asyncio.wait(producers) #    ,   await task_queue.join() while consumers: consumers.pop().cancel() #    ,     await result_queue.join() reporter.cancel()</span></span></code> </pre><br><ul><li> åˆ›å»ºå¾ªç¯å¹¶å¼€å§‹åˆ†å‘çš„åŒæ­¥ä»£ç ã€‚ </li></ul><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">close_session</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(future: asyncio.Future, session: aiohttp.ClientSession)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  ,    .  aiohttp      . """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.wait([future]) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> asyncio.sleep(<span class="hljs-number"><span class="hljs-number">0.250</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> session.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_campaign_send_chunk</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(recipient_ids: Iterable[int])</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""     .   ,  asyncio     . """</span></span> loop = asyncio.new_event_loop() asyncio.set_event_loop(loop) <span class="hljs-comment"><span class="hljs-comment"># Session connector = aiohttp.TCPConnector(limit_per_host=0, limit=0) session = aiohttp.ClientSession( connector=connector, auth=aiohttp.BasicAuth('api', API_KEY), loop=loop, read_timeout=60 ) send_future = asyncio.ensure_future(send_mail_campaign(recipient_ids, session, loop=loop)) cleanup_future = asyncio.ensure_future(close_session(send_future, session)) loop.run_until_complete(asyncio.wait([send_future, cleanup_future])) loop.close()</span></span></code> </pre><br> å®æ–½æ­¤è§£å†³æ–¹æ¡ˆåï¼Œåœ¨å‘é€ç›¸åŒæ•°é‡çš„é‚®ä»¶å’Œ12åå·¥ä½œäººå‘˜çš„æƒ…å†µä¸‹ï¼Œå‘é€å¤§é‡é‚®ä»¶çš„æ—¶é—´å‡å°‘åˆ°ä¸€ä¸ªå°æ—¶ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯ä¸ªå·¥äººæ¯ç§’å‘é€20-25ä¸ªå­—æ¯ï¼Œè¿™æ¯”åŸå§‹è§£å†³æ–¹æ¡ˆçš„ç”Ÿäº§ç‡é«˜50-80å€ã€‚ å·¥ä½œäººå‘˜çš„å†…å­˜æ¶ˆè€—ä¿æŒåœ¨åˆå§‹æ°´å¹³ï¼Œå¤„ç†å™¨è´Ÿè½½ç•¥æœ‰å¢åŠ ï¼Œç½‘ç»œåˆ©ç”¨ç‡å¢åŠ äº†å¾ˆå¤šå€ï¼Œè¿™æ˜¯é¢„æœŸçš„æ•ˆæœã€‚ ç”±äºå·¥äººç”Ÿäº§è€…å’Œä¿å­˜æŠ¥å‘Šçš„å·¥äººçš„æ¯ä¸ªæµç¨‹éƒ½ç§¯æåœ°ä¸æ•°æ®åº“ä¸€èµ·å·¥ä½œï¼Œå› æ­¤ä¸æ•°æ®åº“çš„è¿æ¥æ•°é‡ä¹Ÿå¢åŠ äº†ã€‚ åŒæ—¶ï¼Œåœ¨å¼€å±•å¤§è§„æ¨¡è¿åŠ¨çš„åŒæ—¶ï¼Œè‡ªç”±å·¥ä½œè€…å¯ä»¥å‘é€å°é‚®ä»¶ã€‚ <br><br><img src="https://habrastorage.org/webt/xl/uh/uk/xluhuk6q37flgfyywloujb40eda.png"><br><br> å°½ç®¡å…·æœ‰æ‰€æœ‰ä¼˜ç‚¹ï¼Œä½†è¿™æ ·çš„å®ç°ä»å­˜åœ¨è®¸å¤šå¿…é¡»è€ƒè™‘çš„å›°éš¾ï¼š <br><br><ol><li> å¤„ç†é”™è¯¯æ—¶å¿…é¡»å°å¿ƒã€‚ æœªå¤„ç†çš„å¼‚å¸¸å¯èƒ½ä¼šç»ˆæ­¢å·¥ä½œäººå‘˜ï¼Œä»è€Œå¯¼è‡´æ´»åŠ¨å†»ç»“ã€‚ </li><li> å‘é€å®Œæˆåï¼Œæ²¡æœ‰å¿…è¦ä¸¢å¤±å°šæœªå®Œæˆå—çš„æ”¶ä»¶äººçš„æŠ¥å‘Šï¼Œå¹¶å°†å…¶ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚ </li><li> å¼ºåˆ¶åœæ­¢æ´»åŠ¨æ¢å¤çš„é€»è¾‘å˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œå› ä¸ºåœæ­¢å‘é€å·¥ä½œäººå‘˜ä¹‹åï¼Œæœ‰å¿…è¦æ¯”è¾ƒå“ªäº›æ”¶ä»¶äººæ”¶åˆ°äº†ä¿¡ä»¶ï¼Œå“ªäº›æ”¶ä»¶äººæ²¡æœ‰æ”¶åˆ°ã€‚ </li><li> ä¸€æ®µæ—¶é—´åï¼ŒMailgunæ”¯æŒäººå‘˜ä¸æˆ‘ä»¬è”ç³»å¹¶è¦æ±‚æˆ‘ä»¬é™ä½å‘é€é€Ÿåº¦ï¼Œå› ä¸ºå¦‚æœé‚®ä»¶æœåŠ¡çš„å‘é€é¢‘ç‡è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™å®ƒä»¬ä¼šå¼€å§‹ä¸´æ—¶æ‹’ç»é‚®ä»¶ã€‚ å‡å°‘å·¥äººæ•°é‡å¾ˆå®¹æ˜“åšåˆ°è¿™ä¸€ç‚¹ã€‚ </li><li> å¦‚æœå‘é€ä¿¡ä»¶çš„æŸäº›é˜¶æ®µå°†æ‰§è¡Œå¤„ç†å™¨è¦æ±‚çš„æ“ä½œï¼Œåˆ™å°†æ— æ³•ä½¿ç”¨asyncioã€‚ äº‹å®è¯æ˜ï¼Œä½¿ç”¨jinja2æ¸²æŸ“æ¨¡æ¿ä¸æ˜¯éå¸¸è€—è´¹èµ„æºçš„æ“ä½œï¼Œå®é™…ä¸Šå¯¹å‘é€é€Ÿåº¦æ²¡æœ‰å½±å“ã€‚ </li><li> ä½¿ç”¨asyncioå‘é€é‚®ä»¶åˆ—è¡¨è¦æ±‚åˆ†å‘é˜Ÿåˆ—å¤„ç†ç¨‹åºç”±å•ç‹¬çš„è¿›ç¨‹å¯åŠ¨ã€‚ </li></ol><br> å¸Œæœ›æˆ‘ä»¬çš„ç»éªŒå¯¹æ‚¨æœ‰æ‰€å¸®åŠ©ï¼ å¦‚æœæ‚¨æœ‰ä»»ä½•ç–‘é—®æˆ–æƒ³æ³•ï¼Œè¯·åœ¨è¯„è®ºä¸­å†™ä¸‹ï¼ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482114/">https://habr.com/ru/post/zh-CN482114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482102/index.html">Habr Qï¼†A 2019ï¼šå¹´åº¦ä¸šç»©</a></li>
<li><a href="../zh-CN482104/index.html">å¦‚ä½•åº”å¯¹æœ‰è®¡åˆ’çš„äººçš„ä¹ æƒ¯</a></li>
<li><a href="../zh-CN482106/index.html">Habr Freelance 2019ï¼šå¹´åº¦ä¸šç»©</a></li>
<li><a href="../zh-CN482108/index.html">å®‰é™çš„æƒ…æŠ¥ã€‚ è¯†åˆ«æ½œåœ¨çš„WEBæ¼æ´çš„æ–¹æ³•</a></li>
<li><a href="../zh-CN482110/index.html">Linuxåœ¨æˆ‘çš„åç‰‡ä¸Šè¿è¡Œ</a></li>
<li><a href="../zh-CN482126/index.html">Keraså®¡æŸ¥TensorFlow</a></li>
<li><a href="../zh-CN482128/index.html">gReebokå·²æ£€æµ‹åˆ°ã€‚ çš®è‚¤çš®è‚¤ç§‘åŒ»ç”Ÿè‡ªå·±</a></li>
<li><a href="../zh-CN482130/index.html">å‘æ¥è‡ªä¸åŒæ—çš„åŸŸç”¨æˆ·å¤§è§„æ¨¡åˆ†é…æƒé™</a></li>
<li><a href="../zh-CN482132/index.html">ç‰¹æ–¯æ‹‰Cyberâ€‹â€‹truckå‰¯æœ¬åœ¨è«æ–¯ç§‘è¢«å‘ç°ã€‚ è¿™æ˜¯ä¸€ä¸ªå®šåˆ¶çš„...ä¿„ç½—æ–¯LADAè¨é©¬æ‹‰</a></li>
<li><a href="../zh-CN482134/index.html">æ··åˆåŠ¨åŠ›è½¦çš„æ¯”è¾ƒæˆ–ç½—é©¬å°¼äºšMezeè€³æœºçš„æ‰€æœ‰è€…çš„æœŸæœ›ä»·æ ¼ä¸º84990å’Œ239990å¢å¸ƒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>