<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§í üë©üèæ‚Äçüíª üë®üèæ‚Äçü§ù‚Äçüë®üèº Experiencia en la construcci√≥n de infraestructura en arquitectura de microservicios üíÉ üì® üë®‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Durante el a√±o pasado, ha habido tantas publicaciones sobre microservicios que ser√≠a una p√©rdida de tiempo decir qu√© es y por qu√©, por lo que el resto...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Experiencia en la construcci√≥n de infraestructura en arquitectura de microservicios</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441310/"><p><img src="https://habrastorage.org/webt/vn/kb/qn/vnkbqnbwlqbmim3tn1ipiy_rhri.jpeg"></p><br><p>  Durante el a√±o pasado, ha habido tantas publicaciones sobre microservicios que ser√≠a una p√©rdida de tiempo decir qu√© es y por qu√©, por lo que el resto de la discusi√≥n se centrar√° en la cuesti√≥n de c√≥mo implementar esta arquitectura y por qu√© se enfrent√≥ exactamente y qu√© problemas encontr√≥. </p><br><p>  Tuvimos grandes problemas en un banco peque√±o: 3 monolitos de python conectados por una cantidad monstruosa de interacciones RPC sincr√≥nicas con un gran volumen de legado.  Para resolver al menos parcialmente todos los problemas que surgen al mismo tiempo, se decidi√≥ cambiar a una arquitectura de microservicio.  Pero antes de decidirse por tal paso, debe responder 3 preguntas principales: </p><br><ul><li>  C√≥mo dividir un monolito en microservicios y qu√© criterios se deben seguir. </li><li>  ¬øC√≥mo interactuar√°n los microservicios? </li><li>  ¬øC√≥mo monitorear? </li></ul><br><p>  En realidad, las respuestas breves a estas preguntas se dedicar√°n a este art√≠culo. </p><a name="habracut"></a><br><h2 id="kak-razbit-monolit-na-mikroservisy-i-kakimi-kriteriyami-sleduet-pri-etom-rukovodstvovatsya">  C√≥mo dividir un monolito en microservicios y qu√© criterios se deben seguir. </h2><br><p>  Esta pregunta aparentemente simple finalmente determin√≥ toda la arquitectura futura. </p><br><p>  Somos un banco, por lo que todo el sistema gira en torno a operaciones con finanzas y varias cosas auxiliares.  Ciertamente es posible transferir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">transacciones financieras de ACID a un sistema distribuido con sagas</a> , pero en el caso general es extremadamente dif√≠cil.  As√≠ desarrollamos las siguientes reglas: </p><br><ul><li>  Cumplir con S de SOLID para microservicios </li><li>  La transacci√≥n debe llevarse a cabo en su totalidad en el microservicio, sin transacciones distribuidas por el da√±o de la base de datos. </li><li>  Para funcionar, el microservicio necesita informaci√≥n de su propia base de datos o de una solicitud </li><li>  Trate de garantizar la limpieza (en el sentido de los lenguajes funcionales) para microservicios </li></ul><br><p>  Naturalmente, al mismo tiempo, era imposible satisfacerlos por completo, pero incluso la implementaci√≥n parcial simplifica enormemente el desarrollo. </p><br><h2 id="kakim-obrazom-mikroservisy-budut-vzaimodeystvovat">  ¬øC√≥mo interactuar√°n los microservicios? </h2><br><p>  Hay muchas opciones, pero al final, todas se pueden extraer mediante simples "mensajes de intercambio de microservicios", pero si implementa un protocolo s√≠ncrono (por ejemplo, RPC a trav√©s de REST), la mayor√≠a de las desventajas del monolito permanecer√°n, pero las ventajas de los microservicios dif√≠cilmente aparecer√°n.  Entonces, la soluci√≥n obvia era tomar cualquier intermediario de mensajes y comenzar.  Elegir entre RabbitMQ y Kafka se decidi√≥ por este √∫ltimo, y aqu√≠ est√° el por qu√©: </p><br><ul><li>  Kafka es m√°s simple y proporciona un √∫nico modelo de mensajer√≠a - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Publicar - suscribirse</a> </li><li>  Es relativamente f√°cil obtener datos de Kafka por segunda vez.  Esto es extremadamente conveniente para depurar o corregir errores durante el procesamiento incorrecto, as√≠ como para monitorear y registrar. </li><li>  Una forma clara y simple de escalar el servicio: particiones agregadas al tema, lanz√≥ m√°s suscriptores; el resto lo har√° kafka. </li></ul><br><p>  Adem√°s, quiero llamar la atenci√≥n sobre una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">comparaci√≥n detallada y de muy alta calidad</a> . </p><br><p>  Las colas en kafka + asynchrony nos permiten: </p><br><ul><li>  Apague cualquier microservicio para actualizaciones brevemente sin consecuencias notables para el resto </li><li>  Apague cualquier servicio durante mucho tiempo y no se moleste con la recuperaci√≥n de datos.  Por ejemplo, el microservicio de fiscalizaci√≥n cay√≥ recientemente.  Fue reparado despu√©s de 2 horas, tom√≥ las cuentas en bruto de Kafka y proces√≥ todo.  No era necesario, como antes, restaurar lo que se supon√≠a que suceder√≠a all√≠ y llevar a cabo manualmente registros HTTP y una tabla separada en la base de datos. </li><li>  Ejecute versiones de prueba de los servicios con los datos actuales de la venta y compare los resultados de su procesamiento con la versi√≥n del servicio de la venta. </li></ul><br><p>  Como sistema de serializaci√≥n de datos, elegimos AVRO, por qu√©, descrito en un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culo separado</a> . </p><br><p>  Pero independientemente del m√©todo de serializaci√≥n elegido, es importante comprender c√≥mo se actualizar√° el protocolo.  Aunque AVRO admite la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resoluci√≥n de esquema,</a> no utilizamos esto y decidimos puramente administrativamente: </p><br><ul><li>  Los datos en los temas se escriben y leen solo a trav√©s de AVRO, el nombre del tema corresponde al nombre del esquema (y Confluent tiene un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">enfoque diferente</a> : escriben esquemas de ID AVRO desde el registro en los bytes altos del mensaje, por lo que pueden tener diferentes tipos de mensajes en un tema </li><li>  Si necesita agregar o cambiar datos, se crea un nuevo esquema con un nuevo tema en kafka, despu√©s de lo cual todos los productores cambian a un nuevo tema y los siguen. </li></ul><br><p>  Almacenamos los circuitos AVRO en subm√≥dulos git y nos conectamos a todos los proyectos kafka.  Decidieron no implementar todav√≠a un registro centralizado de esquemas. </p><br><p>  PD: los colegas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hicieron la opci√≥n de c√≥digo abierto, pero solo con el esquema JSON en lugar de AVRO</a> . </p><br><h3 id="nekotorye-tonkosti">  Algunas sutilezas </h3><br><h4 id="kazhdyy-podpischik-poluchaet-vse-soobscheniya-iz-topika">  Cada suscriptor recibe todos los mensajes del tema </h4><br><p>  Esta es la especificidad del modelo de interacci√≥n Publicar - suscribirse - cuando se suscribe a un tema, el suscriptor los recibir√° a todos.  Como resultado, si el servicio solo necesita algunos de los mensajes, tendr√° que filtrarlos.  Si esto se convierte en un problema, ser√° posible crear un enrutador de servicio separado que presente los mensajes en varios temas diferentes, implementando as√≠ parte de la funcionalidad RabbitMQ que no est√° en el kafka.  Ahora tenemos un suscriptor en Python en un hilo que procesa aproximadamente 7-5 mil mensajes por segundo, pero si se ejecuta desde PyPy, entonces la velocidad aumenta a 11-15 mil / seg. </p><br><h4 id="ogranichenie-vremeni-zhizni-ukazatelya-v-topike">  Limite la vida √∫til de un puntero en un tema </h4><br><p>  En la configuraci√≥n del kafka hay un par√°metro que limita el tiempo que el kafka "recuerda" d√≥nde se detuvo el lector; el valor predeterminado es 2 d√≠as.  Ser√≠a bueno aumentarlo a una semana, de modo que si el problema surge durante las vacaciones y no se resuelven 2 d√≠as, esto no conducir√≠a a una p√©rdida de posici√≥n en el tema. </p><br><h4 id="ogranichenie-vremeni-na-podtverzhdenie-chteniya">  L√≠mite de tiempo de confirmaci√≥n de lectura </h4><br><p>  Si el lector Kafka no confirma la lectura en 30 segundos (un par√°metro configurable), entonces el agente cree que algo sali√≥ mal y se produce un error al intentar confirmar la lectura.  Para evitar esto, cuando procesamos un mensaje durante mucho tiempo, enviamos confirmaciones de lectura sin mover el puntero. </p><br><h4 id="graf-svyazey-poluchaetsya-trudnym-dlya-vospriyatiya">  El gr√°fico de conexiones es dif√≠cil de entender. </h4><br><p>  Si honestamente dibuja todas las relaciones en graphviz, entonces hay un erizo del apocalipsis tradicional para microservicios con docenas de conexiones en un nodo.  Para al menos de alguna manera hacer que (la gr√°fica de conexiones) sea legible, acordamos la siguiente notaci√≥n: microservicios - √≥valos, temas de kafka - rect√°ngulos.  Por lo tanto, en un gr√°fico, es posible mostrar tanto el hecho de la interacci√≥n como su tipo.  Pero, por desgracia, no est√° mejorando mucho.  Entonces esta pregunta a√∫n est√° abierta. </p><br><p><img src="https://habrastorage.org/webt/fy/lw/qf/fylwqfrc5nspiw_ci170mvntzku.png"></p><br><h2 id="kak-osuschestvlyat-monitoring">  ¬øC√≥mo monitorear? </h2><br><p>  Incluso como parte del monolito, ten√≠amos registros en archivos y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Centinela,</a> pero a medida que pasamos a la interacci√≥n a trav√©s de Kafka y desplegamos a k8s, los registros se trasladaron a ElasticSearch y, en consecuencia, primero se monitorearon leyendo los registros del suscriptor en Elastic.  Sin registros, sin trabajo. <br>  Despu√©s de eso, comenzaron a usar Prometheus y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">kafka-exporter</a> modific√≥ ligeramente su tablero: <a href="">https://github.com/kkirsanov/articles/blob/master/2019-habr-kafka/dashboard.json</a> </p><br><p>  Como resultado, obtenemos estas im√°genes: <br><img src="https://habrastorage.org/webt/lg/bg/k5/lgbgk5zs7fzl_3hrhork-ybejjw.png"><br>  Puede ver qu√© servicio ha dejado de procesar qu√© mensajes. </p><br><p>  Adem√°s, todos los mensajes de los temas clave (transacciones de pago, notificaciones de socios, etc.) se copian a InfluxDB, que se configura en la misma grafana.  Por lo tanto, no solo podemos registrar el hecho del paso del mensaje, sino tambi√©n hacer varias muestras de acuerdo con el contenido.  Por lo tanto, las respuestas a preguntas como "¬øcu√°l es el tiempo de demora promedio para una respuesta de un servicio" o "¬øEs el flujo de transacciones muy diferente hoy de ayer en esta tienda" siempre est√°n a la mano. </p><br><p>  Adem√°s, para simplificar el an√°lisis de incidentes, utilizamos el siguiente enfoque: cada servicio, cuando procesa un mensaje, lo complementa con metainformaci√≥n que contiene el UUID emitido cuando el sistema muestra una serie de registros del tipo: </p><br><ul><li>  nombre del servicio </li><li>  UUID del proceso de procesamiento en este microservicio </li><li>  marca de tiempo de inicio del proceso </li><li>  tiempo de proceso </li><li>  conjunto de etiquetas </li></ul><br><p>  Como resultado, a medida que el mensaje pasa por el gr√°fico computacional, el mensaje se enriquece con informaci√≥n sobre la ruta recorrida en el gr√°fico.  Resulta un an√°logo de zipkin / opentracing para MQ, que permite recibir un mensaje para restaurar f√°cilmente su ruta en el gr√°fico.  Esto adquiere un valor especial en aquellos casos en que aparecen ciclos en el gr√°fico.  Recuerde el ejemplo de un servicio peque√±o, cuya parte de los pagos es de solo 0.0001%. Al analizar la metainformaci√≥n en el mensaje, puede determinar si fueron los iniciadores del pago, sin contactar a la base de datos para su verificaci√≥n. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441310/">https://habr.com/ru/post/441310/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441296/index.html">OpenStreetMap Part Medium: visualizaci√≥n de datos ocultos</a></li>
<li><a href="../441298/index.html">Cisco Live EMEA 2019: cambiando la vieja bicicleta de TI a BMW en las nubes</a></li>
<li><a href="../441300/index.html">Anacronismos, crujidos, mala estructura organizativa: tres dolores de liderazgo de equipo en una corporaci√≥n</a></li>
<li><a href="../441302/index.html">AMA con Habr (l√≠nea directa con TM, v 6.0)</a></li>
<li><a href="../441306/index.html">C√≥mo obtener una oferta en Mosc√∫ en 1 d√≠a para un ingeniero de control de calidad (y es costoso vivir aqu√≠)</a></li>
<li><a href="../441312/index.html">El difuso mundo de ruido de Perlin</a></li>
<li><a href="../441314/index.html">PyCon Rusia 2019: respuestas a preguntas clave</a></li>
<li><a href="../441316/index.html">Elegir verdaderos auriculares inal√°mbricos: 6 meses despu√©s ...</a></li>
<li><a href="../441318/index.html">Extensiones populares de c√≥digo de Visual Studio</a></li>
<li><a href="../441320/index.html">Domestica tu soporte t√©cnico</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>