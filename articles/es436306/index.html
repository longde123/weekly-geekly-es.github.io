<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>   Machine Learning para Vertica 烩  </title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anotaci贸n 
 En este art铆culo quiero compartir mi propia experiencia con el aprendizaje autom谩tico en un almac茅n de datos en Vertica. 

 Francamente, n...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Machine Learning para Vertica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436306/"><h2>  Anotaci贸n </h2><br>  En este art铆culo quiero compartir mi propia experiencia con el aprendizaje autom谩tico en un almac茅n de datos en Vertica. <br><br>  Francamente, no soy un analista experto que podr谩 describir en detalle toda la variedad de m茅todos de investigaci贸n y algoritmos de predicci贸n de datos.  Pero a煤n as铆, como soy un experto en Vertica y tengo experiencia b谩sica con ML, tratar茅 de hablar sobre formas de trabajar con el an谩lisis predictivo en Vertica utilizando la funcionalidad del servidor incorporado y el lenguaje R. <br><br><h2>  Biblioteca de aprendizaje autom谩tico Vertica </h2><br>  A partir de la versi贸n 7, Vertica se ha ampliado con la biblioteca Machine Learning, con la que puede: <br><br><ul><li>  Prepare ejemplos de datos para el aprendizaje autom谩tico </li><li> entrenar modelos de aprendizaje autom谩tico sobre datos preparados; </li><li>  Realizar an谩lisis predictivos de datos de almacenamiento en modelos de aprendizaje autom谩tico guardados. </li></ul><br>  La biblioteca viene inmediatamente con la instalaci贸n de Vertica para todas las versiones, incluida la Comunidad gratuita.  Trabajar con 茅l se enmarca en forma de una llamada a funciones desde SQL, que se describen en detalle en la documentaci贸n con ejemplos de uso en datos de demostraci贸n preparados. <br><a name="habracut"></a><br><h2>  Un ejemplo de trabajo con ML en Vertica </h2><br>  Como un ejemplo simple de c贸mo funciona ML, tom茅 los datos de demostraci贸n de mtcars que forman parte del ejemplo de datos ML para Vertica.  Estos datos incluyen dos tablas: <br><br><ul><li>  mtcars_train: datos preparados para entrenar modelos de aprendizaje autom谩tico </li><li>  mtcars - datos para an谩lisis </li></ul><br>  Veamos los datos para el entrenamiento: <br><br><pre><code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars_train;</code> </pre> <br><img src="https://habrastorage.org/webt/mu/4_/o0/mu4_o0ovpeupz4c3qkf1uvnegya.jpeg"><br><br>  En el conjunto de datos sobre modelos de autom贸viles, se describen sus caracter铆sticas.  Intentemos entrenar el aprendizaje autom谩tico para que, de acuerdo con las caracter铆sticas de los autom贸viles, sea posible predecir qu茅 tipo de caja de cambios est谩 involucrada en el autom贸vil: una caja manual o una caja de cambios autom谩tica.  Para hacer esto, necesitaremos construir un modelo de regresi贸n log铆stica en los datos preparados, encontrando la dependencia del tipo de caja del campo "am" y los campos de peso del veh铆culo "wt", el n煤mero de cilindros "cyl" y el n煤mero de velocidades en el cuadro "gear": <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> LOGISTIC_REG(<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>, <span class="hljs-string"><span class="hljs-string">'mtcars_train'</span></span>, <span class="hljs-string"><span class="hljs-string">'am'</span></span>, <span class="hljs-string"><span class="hljs-string">'cyl, wt, gear'</span></span>); Finished in 19 iterations</code> </pre> <br>  La funci贸n llamada analiz贸 la relaci贸n entre am y los campos cyl, wt, gear, revel贸 la f贸rmula de dependencia y escribi贸 el resultado de la simulaci贸n de la dependencia en la base de datos Vertica en el modelo "logistic_reg_mtcars".  Con este modelo guardado, ahora puede analizar datos sobre autom贸viles y predecir la disponibilidad de cajas de cambios autom谩ticas. <br><br>  Se puede ver informaci贸n sobre el modelo: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> GET_MODEL_SUMMARY(<span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> model_name=<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>);</code> </pre> <br><img src="https://habrastorage.org/webt/hd/aj/gp/hdajgpkb3a4jvlq2-czafzt9mv0.jpeg"><br><br>  Ahora usamos el modelo en los datos para autom贸viles, guardando el resultado en una nueva tabla: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> mtcars_predict_results <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> car_model, am, PREDICT_LOGISTIC_REG(cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> model_name=<span class="hljs-string"><span class="hljs-string">'logistic_reg_mtcars'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">prediction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars );</code> </pre> <br>  Y comparando los valores reales de am con los obtenidos en la predicci贸n predicci贸n: <br><br><pre> <code class="sql hljs">=&gt;<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> mtcars_predict_results;</code> </pre> <br><img src="https://habrastorage.org/webt/48/rt/zh/48rtzhy3c4ahjfqrupulpfy_mqy.jpeg"><br><br>  En este caso, el pron贸stico para el 100% coincidi贸 con el tipo real de cuadro en los modelos presentados.  En el caso de preparar nuevos datos para la capacitaci贸n, deber谩 eliminar y volver a guardar el modelo. <br><br><h2>  Funcionalidad ML en Vertica </h2><br>  La biblioteca Vertica ML admite los siguientes tipos de an谩lisis predictivo: <br><br><ul><li>  <b>Previsi贸n:</b> <br><ul><li>  Regresi贸n lineal </li><li>  Bosque aleatorio para regresi贸n </li><li>  SVM (M谩quina de vectores de soporte) para regresi贸n </li></ul></li><li>  <b>Clasificaci贸n:</b> <br><ul><li>  Regresi贸n log铆stica </li><li>  Bayes ingenuos </li><li>  Bosque aleatorio para clasificaci贸n </li><li>  SVM (M谩quina de vectores de soporte) para clasificaci贸n </li></ul></li><li>  <b>Agrupamiento:</b> <br><ul><li>  k-significa </li></ul></li></ul><br>  Para preparar los datos para el entrenamiento, se presenta la siguiente funcionalidad: <br><br><ul><li>  Balance de datos </li><li>  Limpieza de emisiones </li><li>  Codificaci贸n de valores de columna categ贸ricos (textuales) </li><li>  Reemplazar datos faltantes </li><li>  Normalizaci贸n de datos. </li><li>  An谩lisis de componentes principales </li><li>  Muestreo de datos </li><li>  Descomposici贸n de valores singulares </li></ul><br>  Teniendo en cuenta la funcionalidad de ML en Vertica, podemos decir que la biblioteca incorporada nos permite resolver una amplia gama de problemas, pero no tiene el trabajo atrasado para estudiar los patrones y las dependencias en los datos.  Existen funciones para preparar datos para el aprendizaje autom谩tico, pero sin visualizar la distribuci贸n de datos en forma de gr谩ficos, solo los gur煤s del an谩lisis con conocimiento experto de los datos analizados pueden "preparar" dichos datos y entrenar modelos de aprendizaje en ellos. <br><br><h2>  R Studio con Vertica </h2><br>  Para un an谩lisis de datos predictivos m谩s completo e interactivo, el lenguaje R es ideal, ya que tiene un entorno visual para trabajar con datos de R Studio.  Las ventajas tangibles de usar R con Vertica ser谩n: <br><br><ul><li>  interactividad del entorno con la capacidad de guardar el estado para un an谩lisis posterior despu茅s de la pr贸xima ejecuci贸n; </li><li>  visualizaci贸n visual de datos en forma de tablas y gr谩ficos; </li><li>  Potencia de lenguaje R para trabajar con conjuntos de datos; </li><li>  Una variedad de algoritmos de an谩lisis predictivo similares a los presentados en Vertica ML. </li></ul><br>  Las desventajas de trabajar con R con big data son los requisitos de RAM, la velocidad de trabajar con grandes arrays de datos y la necesidad de importar y exportar datos Vertica.  Estas deficiencias est谩n cubiertas por la capacidad de incrustar funciones R escritas para la ejecuci贸n directa en un cl煤ster en Vertica, que se describir谩 a continuaci贸n. <br><br><h2>  Una peque帽a introducci贸n a R </h2><br>  Reproduciremos el pron贸stico para cuadros autom谩ticos en datos Vertica usando R. Para no asustar a los programadores que no est谩n familiarizados con este lenguaje, conducir茅 un curso corto de un joven luchador R. <br><br>  Entonces, el lenguaje R es el mismo lenguaje de procedimiento que tiene objetos, clases y funciones. <br>  Un objeto puede ser un conjunto de datos (vector, lista, conjunto de datos ...), valor (texto, n煤mero, fecha, hora ...) o una funci贸n.  Para los valores, se admiten los tipos num茅ricos, de cadena, booleanos y de fecha y hora.  Para los conjuntos de datos, la numeraci贸n de la matriz comienza en 1, no en 0. <br><br>  Cl谩sicamente, en lugar de "=" en R, se usa el operador de asignaci贸n "&lt;-".  Aunque no est谩 prohibido utilizar la asignaci贸n al otro lado "-&gt;" e incluso el habitual "=".  El operador "=" en s铆 mismo se usa cuando se llaman funciones para especificar par谩metros con nombre. <br><br>  En lugar de "."  "$" se utiliza para acceder a los campos de los conjuntos de datos.  Un punto no es una palabra clave y se usa en nombres de objetos para aumentar su legibilidad.  Por lo tanto, "my.data $ field" se descifrar谩 como una matriz de registros del campo "field" del conjunto de datos "my.data". <br><br>  Puede usar comillas simples o dobles para enmarcar textos. <br><br>  <b>Lo m谩s importante:</b> R est谩 orientado a trabajar con conjuntos de datos.  Incluso si el c贸digo dice "a &lt;-1", aseg煤rese de que R dentro de s铆 cree que "a" es una matriz de 1 elemento.  El dise帽o del lenguaje le permite trabajar con conjuntos de datos, como con variables ordinarias: sumar y restar, conectar y desconectar, filtrar por medidas.  La forma m谩s f谩cil de crear una matriz que enumere sus elementos es llamar a la funci贸n "c (elementos de matriz separados por comas)".  El nombre "c" aparentemente se toma como una abreviatura corta de Collection, pero no lo dir茅 con certeza. <br><br><h2>  Cargando datos de un DBMS en R </h2><br>  Para usar RDBMS a trav茅s de ODBC para R, debe instalar el paquete RODBC.  Se puede instalar en R Studio en la pesta帽a de paquetes o usando el comando R: <br><br><pre> <code class="plaintext hljs">install.packages('RODBC') library('RODBC')</code> </pre> <br><br>  Ahora podemos trabajar con Vertica.  Creamos un alias ODBC para el servidor y obtenemos los datos de prueba y el conjunto de datos completo para el autom贸vil: <br><br><pre> <code class="plaintext hljs">#    Vertica con &lt;- odbcConnect(dsn='VerticaDSN') #    mtcars_train mtcars.train &lt;- sqlQuery(con, "SELECT * FROM public.mtcars_train") #    mtcars&lt;/b&gt; mtcars.data &lt;- sqlQuery(con, "SELECT * FROM public.mtcars") #   odbcClose(con)</code> </pre> <br>  Al cargar datos de fuentes R para campos de tipos de texto y fecha-hora, su pertenencia a factores se establece autom谩ticamente.  El campo "am" es de tipo num茅rico y R se percibe como un indicador num茅rico, y no como un factor, que no permitir谩 una regresi贸n log铆stica.  Por lo tanto, convertimos este campo a un factor num茅rico: <br><br><pre> <code class="plaintext hljs">mtcars.data$am = factor(mtcars.data$am) mtcars.train$am = factor(mtcars.train$am)</code> </pre> <br>  En R Studio, es conveniente ver interactivamente los datos, construir gr谩ficos de an谩lisis predictivo y escribir c贸digo en R con consejos: <br><br> <a href=""><img src="https://habrastorage.org/webt/r2/ft/b8/r2ftb85rnjcmpiblxomwdiicr7k.jpeg"></a> <br><br><h2>  Construyendo un modelo en R </h2><br>  Construiremos un modelo de regresi贸n log铆stica sobre el conjunto de datos preparado para las mismas dimensiones que en Vertica: <br><br><pre> <code class="plaintext hljs">mtcars.model &lt;- glm(formula = am ~ cyl + wt + gear, family = binomial(), data = mtcars.train)</code> </pre> <br>  <b>Explicaci贸n:</b> en el lenguaje R, la f贸rmula de an谩lisis predictivo se indica como: <br><br><pre> <code class="plaintext hljs">&lt;  &gt;~&lt;   &gt;</code> </pre> <br><h2>  An谩lisis de datos del modelo en R </h2><br>  Inicializamos el conjunto de datos resultante, tomando de mtcars todos los registros para los campos requeridos: <br><br><pre> <code class="plaintext hljs">mtcars.result &lt;- data.frame(car_model = mtcars.data$car_model, am = mtcars.data$am, predict = 0)</code> </pre> <br>  Ahora, basado en el modelo construido, puede realizar un an谩lisis de los datos en s铆: <br><br><pre> <code class="plaintext hljs">mtcars.result$predict &lt;- predict.glm(mtcars.model, newdata = subset(mtcars.data, select = c('cyl', 'wt', 'gear')), type = 'response' )</code> </pre> <br>  El resultado del an谩lisis se devuelve al campo de predicci贸n como un porcentaje de la probabilidad del pron贸stico.  Simplifique por analog铆a con Vertica a valores 0 o 1, considerando el pron贸stico positivo con una probabilidad de m谩s del 50%: <br><br><pre> <code class="plaintext hljs">mtcars.result$predict &lt;- ifelse(mtcars.result$predict &gt; 0.5, 1, 0)</code> </pre> <br>  Calculamos el n煤mero total de registros para los cuales el campo de predicci贸n predicho no coincide con el valor real en am: <br><br><pre> <code class="plaintext hljs">nrow(mtcars[mtcars.result$am != mtcars.result$predict, ])</code> </pre> <br>  R devolvi贸 cero.  Por lo tanto, el pron贸stico convergi贸 en todos los modelos de autom贸viles, como en el ML de Vertica. <br><br>  <b>Tenga en cuenta:</b> el filtro devolvi贸 los registros de mtcars (el primer par谩metro entre corchetes) con todas las columnas (el segundo par谩metro se omiti贸 despu茅s de la coma entre corchetes). <br><br><h2>  Guardar y cargar datos localmente en R </h2><br>  Al salir de R, el estudio sugiere guardar el estado de todos los objetos para continuar trabajando despu茅s de un reinicio.  Si por alguna raz贸n necesita guardar y luego restaurar el estado de objetos individuales, para esto se proporcionan funciones especiales en R: <br><br><pre> <code class="plaintext hljs">#      save(mtcars.model, file = 'mtcars.model') #      load('mtcars.model')</code> </pre> <br><h2>  Guardar datos de R a Vertica </h2><br>  Si R Studio se us贸 para preparar datos para entrenar modelos ML Vertica, o si el an谩lisis se realiz贸 directamente en 茅l, que luego se usar谩 en la base de datos Vertica, los conjuntos de datos R se pueden escribir en la tabla Vertica. <br><br>  Dado que la biblioteca ODBC para R est谩 dise帽ada para RDTPMS OLTP, no puede generar correctamente consultas de creaci贸n de tablas para Vertica.  Por lo tanto, para registrar datos con 茅xito, deber谩 crear manualmente la tabla necesaria en Vertica utilizando SQL, cuyo conjunto de campos y tipos coincide con el conjunto de datos grabables R. <br><br>  Adem谩s, el proceso de grabaci贸n en s铆 parece simple (no olvide abrir y luego cerrar la conexi贸n): <br><br><pre> <code class="plaintext hljs">sqlSave(con, mtcars.result, tablename = 'public.mtcars_result', append = TRUE, rownames = FALSE, colnames = FALSE)</code> </pre> <br><h2>  Usando Vertica con R </h2><br>  El trabajo interactivo con datos en R Studio es adecuado para el modo de investigaci贸n y preparaci贸n de datos.  Pero es completamente inadecuado para el an谩lisis de flujos de datos y grandes matrices en modo autom谩tico.  Una de las opciones para el esquema de an谩lisis predictivo h铆brido R con Vertica es la preparaci贸n de datos para aprender sobre R e identificar dependencias para construir modelos.  Luego, utilizando las funciones ML integradas en Vertica, los modelos de pron贸stico para los datos preparados en R se entrenan teniendo en cuenta las dependencias identificadas de las variables. <br><br>  Hay una opci贸n m谩s flexible cuando toda la potencia del lenguaje R se usa directamente desde debajo de Vertica.  Para esto, Vertica desarroll贸 la distribuci贸n R en forma de una biblioteca de complementos que le permite utilizar funciones de transformaci贸n escritas directamente en el lenguaje R en consultas SQL. La documentaci贸n describe en detalle la instalaci贸n del soporte R para Vertica y los paquetes R adicionales necesarios para la operaci贸n, si los hay. <br><br><h2>  Guardar el modelo R en Vertica </h2><br>  Para utilizar el modelo de an谩lisis preparado previamente por R Studio en las funciones de R que se ejecutan en Vertica, debe guardarlas en los servidores de Vertica.  Guardar localmente en cada servidor del cl煤ster con un archivo no es conveniente ni confiable, se pueden agregar nuevos servidores al cl煤ster y, al cambiar el modelo, deber谩 recordar volver a escribir todos los archivos nuevamente. <br><br>  La forma m谩s conveniente es serializar el modelo R en texto y guardar la funci贸n Vertica como UDF, que devolver谩 este texto como una constante (no olvide abrir y luego cerrar la conexi贸n): <br><br><pre> <code class="plaintext hljs">#     mtcars.model.text &lt;- rawToChar( serialize(mtcars.model, connection = NULL, ascii = TRUE)) #       Vertica # (     ) mtcars.func &lt;- paste0( "CREATE OR REPLACE FUNCTION public.MtCarsAnalizeModel() RETURN varchar(65000) AS BEGIN RETURN '", gsub("'", "''", mtcars.model.text), "'; END; GRANT EXECUTE ON FUNCTION public.MtCarsAnalizeModel() TO public;" ) #    Vertica sqlQuery(con, mtcars.func)</code> </pre> <br>  El m茅todo propuesto permite eludir la restricci贸n de Vertica en los par谩metros transmitidos en la funci贸n de transformaci贸n, donde solo se requiere la transferencia de constantes o expresiones de constantes.  Vertica UDF SQL compila no como funciones, sino como expresiones calculadas, es decir, al pasar un par谩metro, en lugar de llamar a la funci贸n, se transferir谩 su texto (en este caso una constante), que se guard贸 en el c贸digo anterior. <br><br>  Si cambia el modelo, deber谩 recrear su funci贸n en Vertica.  Tiene sentido envolver este c贸digo en una funci贸n universal que genera una funci贸n en Vertica con el nombre especificado del modelo pasado. <br><br><h2>  Funciones R para Vertica </h2><br>  Para conectar las funciones R a Vertica, debe escribir funciones de an谩lisis y registro de datos en Vertica. <br><br>  La funci贸n de trabajar con datos desde la propia Vertica debe tener dos par谩metros: el conjunto de datos resultante (como data.frame) y los par谩metros de trabajo (como la lista): <br><br><pre> <code class="plaintext hljs">MtCarsAnalize &lt;- function(data, parameters) { if ( is.null(parameters[['model']]) ) { stop("NULL value for model! Model cannot be NULL.") } else { model &lt;- unserialize(charToRaw(parameters[['model']])) } names(data) &lt;- c('car_model', 'cyl', 'wt', 'gear') result &lt;- data.frame(car_model = data$car_model, predict = 0) result$predict &lt;- predict.glm(model, newdata = subset(data, select = c('cyl', 'wt', 'gear')), type = 'response' ) result$predict &lt;- ifelse(result$predict &gt; 0.5, TRUE, FALSE) return(result) }</code> </pre> <br>  En el cuerpo de la funci贸n, se verifica que se pasa el par谩metro del modelo, cuyo texto se traduce en forma binaria y se deserializa en el objeto del modelo de an谩lisis.  Como Vertica transfiere sus propios nombres de campo al conjunto de datos para la funci贸n, los nombres de campo expl铆citos se establecen en el conjunto de datos.  En base a los datos obtenidos, se construye un conjunto de resultados con el nombre del modelo de m谩quina y cero predicci贸n.  A continuaci贸n, se construye un pron贸stico utilizando solo los campos necesarios para el an谩lisis del conjunto de datos obtenido.  El campo de predicci贸n del conjunto de resultados se establece en valores booleanos (para un cambio en lugar de valores num茅ricos) y el resultado se devuelve desde la funci贸n. <br><br>  Ahora queda por describir el registro de esta funci贸n en Vertica: <br><br><pre> <code class="plaintext hljs">MtCarsAnalizeFactory &lt;- function() { list(name = MtCarsAnalize, udxtype = c("transform"), intype = c("varchar", "int", "float", "int"), outtype = c("varchar", "boolean"), outnames = c("car_model", "predict"), parametertypecallback=MtCarsAnalizeParameters) } MtCarsAnalizeParameters &lt;- function() { parameters &lt;- list(datatype = c("varchar"), length = 65000, scale = c("NA"), name = c("model")) return(parameters) }</code> </pre> <br>  La funci贸n MtCarsAnalizeFactory describe el nombre de la funci贸n utilizada para la operaci贸n, el campo para el conjunto de datos entrantes y salientes, y la segunda funci贸n describe el par谩metro "modelo" pasado.  Los tipos de campo son tipos de datos Vertica.  Al transmitir y devolver datos, Vertica convierte autom谩ticamente los valores a los tipos de datos necesarios para el lenguaje R. Puede ver la tabla de compatibilidad de tipos en la documentaci贸n de Vertica. <br><br>  Puede probar el funcionamiento de la funci贸n escrita para Vertica en los datos cargados en R studio: <br><br><pre> <code class="plaintext hljs">test.data = subset(mtcars.data, select = c('car_model', 'cyl', 'wt', 'gear')) test.params = list(model = mtcars.model.text) test.result = MtCarsAnalize(test.data, test.params)</code> </pre> <br><h2>  Conecte la biblioteca de caracter铆sticas a Vertica </h2><br>  Guardamos todas las funciones anteriores en un archivo "mtcars_func.r" y lo subimos a uno de los servidores desde el cl煤ster Vertica en "/ home / dbadmin". <br><br>  <b>Un punto importante:</b> en R Studio, debe configurar la opci贸n para guardar la traducci贸n de l铆neas en archivos en modo Posix (LF).  Esto se puede hacer en las opciones globales, secci贸n C贸digo, pesta帽a Guardar.  Si est谩 trabajando en Windows, de manera predeterminada, el archivo se guardar谩 con un retorno de carro y no podr谩 cargarse en Vertica. <br><br>  Nos conectamos al servidor desde el cl煤ster Vertica, en el que guardamos el archivo y cargamos la biblioteca: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIBRARY</span></span> MtCarsLibs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-string"><span class="hljs-string">'/home/dbadmin/mtcars_func.r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'R'</span></span>;</code> </pre> <br>  Ahora desde esta biblioteca puedes registrar la funci贸n R: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> TRANSFORM <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.MtCarsAnalize <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LANGUAGE</span></span> <span class="hljs-string"><span class="hljs-string">'R'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> <span class="hljs-string"><span class="hljs-string">'MtCarsAnalizeFactory'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIBRARY</span></span> MtCarsLibs; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> TRANSFORM <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> public.MtCarsAnalize(<span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>;</code> </pre> <br><h2>  Funciones de llamada R en Vertica </h2><br>  Llamamos a la funci贸n R, pas谩ndole el texto del modelo, que se guard贸 previamente como una funci贸n UDF: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MtCarsAnalize(car_model, cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">model</span></span> = public.MtCarsAnalizeModel()) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars;</code> </pre> <br><img src="https://habrastorage.org/webt/8a/om/ve/8aomvezlxe_-0n4gnyonxkr25om.jpeg"><br><br>  Se puede verificar que, al igual que en los casos anteriores, el pron贸stico es 100% consistente con el estado real de las cosas: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> c.*, p.predict, p.predict = c.am::<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> valid <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars c <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> MtCarsAnalize(car_model, cyl, wt, gear <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PARAMETERS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">model</span></span> = public.MtCarsAnalizeModel()) <span class="hljs-keyword"><span class="hljs-keyword">OVER</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> public.mtcars ) p <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> c.car_model = p.car_model</code> </pre> <br>  <b>Tenga en cuenta que</b> las funciones de transformaci贸n en Vertica devuelven su propio conjunto de datos de los campos y registros definidos dentro de las funciones, sin embargo, pueden usarse en consultas si se envuelven en una subconsulta. <br><br>  Cuando las funciones R est谩n conectadas, Vertica copia el c贸digo fuente a su instalaci贸n, que compila en c贸digo m谩quina.  El archivo R de origen cargado en el servidor despu茅s de conectarse a la biblioteca no es necesario para seguir trabajando.  La velocidad de las funciones, teniendo en cuenta la compilaci贸n binaria, es lo suficientemente alta como para trabajar con grandes conjuntos de datos, sin embargo, vale la pena recordar que todas las operaciones R se llevan a cabo en la memoria y existe el riesgo de intercambio si falta memoria del sistema operativo para satisfacer las necesidades de colaboraci贸n de Vertica y R . <br><br>  Si se llama a la funci贸n en la partici贸n de los datos especificados en PARTITION BY para OVER, Vertica paraleliza la ejecuci贸n de cada partici贸n en los servidores del cl煤ster.  Por lo tanto, si un fabricante a煤n estuviera presente en el conjunto de datos adem谩s del modelo de m谩quina, puede especificarlo en PARTICIN POR y paralelizar el an谩lisis para cada fabricante. <br><br><h2>  Otras oportunidades de aprendizaje autom谩tico de Vertica </h2><br>  Adem谩s de R, Vertica puede desarrollar sus propias funciones de transformaci贸n en C, Java y Python.  Cada idioma tiene sus propios matices y caracter铆sticas de escritura y conexi贸n con Vertica.  Junto con su propio ML, todo esto le da a Vertica una buena reserva para el an谩lisis predictivo de datos. <br><br><h2>  Gracias y enlaces </h2><br>  Quiero agradecer sinceramente a mi amigo y colega Vlad Malofeev de Perm, quien me present贸 a R y me ayud贸 a resolverlo en uno de nuestros proyectos conjuntos. <br><br>  Inicialmente, en un proyecto donde se realiz贸 un pron贸stico sobre condiciones dif铆ciles para el futuro utilizando datos del a帽o pasado, los desarrolladores intentaron utilizar SQL y Java.  Esto caus贸 grandes dificultades teniendo en cuenta la calidad de estas fuentes y ralentiz贸 en gran medida el desarrollo del proyecto.  Vlad lleg贸 al proyecto con R, conectamos R con Vertica, condujo los datos al estudio y todo gir贸 y gir贸 maravillosamente de inmediato.  Literalmente en semanas, todo lo que dur贸 meses fue rastrillado, salvando el proyecto del c贸digo complejo. <br><br>  Los datos de ejemplo con autom贸viles se pueden descargar desde el repositorio de GIT: <br><br><pre> <code class="plaintext hljs">git clone https://github.com/vertica/Machine-Learning-Examples</code> </pre> <br>  y subir a Vertica: <br><br><pre> <code class="plaintext hljs">/opt/vertica/bin/vsql -d &lt;name of your database&gt; -f load_ml_data.sql</code> </pre> <br>  Si desea profundizar en ML y aprender a trabajar con R, le recomiendo un libro en ruso <b>"R en acci贸n".</b>  <b>An谩lisis y visualizaci贸n de datos en el lenguaje R "</b> .  Est谩 escrito en un lenguaje humano simple y accesible y es adecuado para principiantes que no se han encontrado con el aprendizaje autom谩tico. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Aqu铆</a> puede ver informaci贸n sobre c贸mo conectar la biblioteca R a Vertica. <br><br>  Para aquellos que ya han comenzado a aprender y usar ML en Python, vale la pena prestar atenci贸n al IDE Rodeo, este es un an谩logo de R Studio, porque sin un an谩lisis de calidad interactivo es imposible.  Creo que todo lo descrito en este art铆culo bajo R de una manera similar se puede desarrollar en Python, incluido guardar el modelo en funciones UDF y desarrollar funciones de an谩lisis para Vertica.  Si marca, no olvide darse de baja de los resultados en los comentarios, le agradecer茅 la informaci贸n. <br><br>  Gracias por su tiempo y espero haber podido demostrar la simplicidad y las incre铆bles capacidades de la simbiosis de R y Vertica. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es436306/">https://habr.com/ru/post/es436306/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es436296/index.html">expl铆cito en detalle</a></li>
<li><a href="../es436298/index.html">Ideas de la mesa: vinilo virtual</a></li>
<li><a href="../es436300/index.html">9 mejores pr谩cticas de seguridad en Kubernetes</a></li>
<li><a href="../es436302/index.html">Experiencia de sustituci贸n real de importaciones utilizando el sistema de almacenamiento ruso AERODISK</a></li>
<li><a href="../es436304/index.html">Zimbra Collaboration Suite y la lucha contra el phishing</a></li>
<li><a href="../es436308/index.html">Rostelecom puede convertirse en un monopolista en el mercado de centros de datos</a></li>
<li><a href="../es436310/index.html">Como lo hizo Ivan Metrics, DevOps lo hizo. Objeto de influencia</a></li>
<li><a href="../es436312/index.html">S铆ntesis de voz de la red neuronal utilizando la arquitectura Tacotron 2, o "Obtener alineaci贸n o morir en el intento"</a></li>
<li><a href="../es436314/index.html">Robo-hotel japon茅s "dispar贸" la mitad de sus robots debido a los problemas que crean</a></li>
<li><a href="../es436316/index.html">C贸mo las tarjetas inteligentes ayudan a impulsar proyectos de TI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>