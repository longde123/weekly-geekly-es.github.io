<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äç‚öñÔ∏è üé° üç´ Schreiben Sie Ihre Netzwerkschicht in Swift: Protokollorientierter Ansatz üÜñ üïµüèº üßóüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mittlerweile verwenden fast 100% der Anwendungen Netzwerke, sodass jeder mit der Organisation und Verwendung der Netzwerkschicht konfrontiert ist. Es ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Schreiben Sie Ihre Netzwerkschicht in Swift: Protokollorientierter Ansatz</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443514/"><img src="https://habrastorage.org/webt/gg/rb/pk/ggrbpkas55pf0eigg33hin46i0g.png"><br><br>  Mittlerweile verwenden fast 100% der Anwendungen Netzwerke, sodass jeder mit der Organisation und Verwendung der Netzwerkschicht konfrontiert ist.  Es gibt zwei Hauptans√§tze zur L√∂sung dieses Problems: Sie verwenden entweder Bibliotheken von Drittanbietern oder Ihre eigene Implementierung der Netzwerkschicht.  In diesem Artikel werden wir die zweite Option betrachten und versuchen, eine Netzwerkschicht unter Verwendung der neuesten Funktionen der Sprache unter Verwendung von Protokollen und Aufz√§hlungen zu implementieren.  Dadurch wird das Projekt vor unn√∂tigen Abh√§ngigkeiten in Form zus√§tzlicher Bibliotheken gesch√ºtzt.  Diejenigen, die Moya jemals gesehen haben, werden sofort viele √§hnliche Details bei der Implementierung und Verwendung erkennen, so wie es ist. Nur dieses Mal werden wir es selbst tun, ohne Moya und Alamofire zu ber√ºhren. <br><a name="habracut"></a><br><br>  In diesem Handbuch erfahren Sie, wie Sie eine Netzwerkschicht auf reinem Swift implementieren, ohne Bibliotheken von Drittanbietern zu verwenden.  Sobald Sie diesen Artikel gelesen haben, wird Ihr Code <br><br><ul><li>  protokollorientiert </li><li>  einfach zu bedienen </li><li>  einfach zu bedienen </li><li>  Typ sicher </li><li>  F√ºr Endpunkte werden Aufz√§hlungen verwendet </li></ul><br><br>  Nachfolgend finden Sie ein Beispiel daf√ºr, wie die Verwendung unserer Netzwerkschicht nach ihrer Implementierung aussehen wird: <br><br><img src="https://habrastorage.org/webt/zg/f5/jy/zgf5jybl_jika5ljlt-h3pcdg1e.png"><br><br>  Durch einfaches Schreiben von <i><b>router.request (.</b></i> Und unter Verwendung aller M√∂glichkeiten von Aufz√§hlungen werden alle m√∂glichen Abfrageoptionen und ihre Parameter <i><b>angezeigt</b></i> . <br><br>  <b>Zun√§chst ein wenig zur Struktur des Projekts</b> <br><br>  Wann immer Sie etwas Neues schaffen und um in Zukunft alles leicht verstehen zu k√∂nnen, ist es sehr wichtig, alles richtig zu organisieren und zu strukturieren.  Ich bin der √úberzeugung, dass eine ordnungsgem√§√ü organisierte Ordnerstruktur ein wichtiges Detail beim Erstellen der Anwendungsarchitektur ist.  Damit wir alles richtig in Ordnern anordnen k√∂nnen, erstellen wir sie im Voraus.  Dies sieht wie die allgemeine Ordnerstruktur im Projekt aus: <br><br><img src="https://habrastorage.org/webt/vw/fz/y0/vwfzy0nlpqmg6mccy85s2q6iqrg.png"><br><br>  <b>Endpointtype-Protokoll</b> <br><br>  Zun√§chst m√ºssen wir unser <i><b>EndPointType-</b></i> Protokoll definieren.  Dieses Protokoll enth√§lt alle erforderlichen Informationen zum Konfigurieren der Anforderung.  Was ist eine Anfrage (Endpunkt)?  Im Wesentlichen handelt es sich um eine URLRequest mit allen zugeh√∂rigen Komponenten wie Headern, Anforderungsparametern und Anforderungshauptteil.  Das <i><b>EndPointType-</b></i> Protokoll ist der wichtigste Teil unserer Implementierung auf Netzwerkebene.  Erstellen wir eine Datei und nennen sie <i><b>EndPointType</b></i> .  Legen Sie diese Datei in den Dienstordner (nicht in den EndPoint-Ordner, warum - es wird etwas sp√§ter klar sein). <br><br><img src="https://habrastorage.org/webt/-9/j0/ul/-9j0ulvgk-w_hftxxyqwolmbujy.png"><br><br>  <b>HTTP-Protokolle</b> <br><br>  Unser <i><b>EndPointType</b></i> enth√§lt mehrere Protokolle, die wir zum Erstellen einer Anforderung ben√∂tigen.  Mal sehen, was diese Protokolle sind. <br><br>  <b>HTTPMethod</b> <br><br>  Erstellen Sie eine Datei, nennen Sie sie <i><b>HTTPMethod</b></i> und legen Sie sie im Ordner Service ab.  Diese Auflistung wird verwendet, um die HTTP-Methode unserer Anfrage festzulegen. <br><br><img src="https://habrastorage.org/webt/j2/3x/nr/j23xnrcovqknw9dzxhf-xva898q.png"><br><br>  <b>HTTPTask</b> <br>  Erstellen Sie eine Datei, nennen Sie sie <i><b>HTTPTask</b></i> und legen Sie sie im <i><b>Dienstordner ab</b></i> .  HTTPTask ist f√ºr die Konfiguration der Parameter einer bestimmten Anforderung verantwortlich.  Sie k√∂nnen so viele verschiedene Abfrageoptionen hinzuf√ºgen, wie Sie ben√∂tigen, aber ich werde im Gegenzug regelm√§√üige Abfragen, Abfragen mit Parametern, Abfragen mit Parametern und √úberschriften durchf√ºhren, sodass ich nur diese drei Arten von Abfragen ausf√ºhren werde. <br><br><img src="https://habrastorage.org/webt/v5/4m/j6/v54mj6yxsvdwuiossyq3em2biia.png"><br><br>  Im n√§chsten Abschnitt werden wir die <i><b>Parameter</b></i> diskutieren und wie wir mit ihnen arbeiten werden <br><br>  <b>HTTPHeaders</b> <br><br>  <i><b>HTTPHeaders</b></i> sind nur Typealias f√ºr ein W√∂rterbuch.  Sie k√∂nnen es oben in Ihrer <i><b>HTTPTask-</b></i> Datei erstellen. <br><br><pre><code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">HTTPHeaders</span></span> = [<span class="hljs-type"><span class="hljs-type">String</span></span>:<span class="hljs-type"><span class="hljs-type">String</span></span>]</code> </pre> <br><br>  <b>Parameter &amp; Kodierung</b> <br><br>  Erstellen Sie eine Datei, nennen Sie sie <i><b>ParameterEncoding</b></i> und legen Sie sie im Ordner Encoding ab.  Erstellen Sie Typealien f√ºr <i><b>Parameter</b></i> , es wird wieder ein regul√§res W√∂rterbuch sein.  Wir tun dies, um den Code verst√§ndlicher und lesbarer zu machen. <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">Parameters</span></span> = [<span class="hljs-type"><span class="hljs-type">String</span></span>:<span class="hljs-type"><span class="hljs-type">Any</span></span>]</code> </pre> <br><br>  Definieren Sie als N√§chstes ein <i><b>ParameterEncoder-</b></i> Protokoll mit einer einzelnen Codierungsfunktion.  Die Codierungsmethode verf√ºgt √ºber zwei Parameter: <i><b>inout URLRequest</b></i> und <i><b>Parameters</b></i> .  <b>INOUT</b> ist ein Swift-Schl√ºsselwort, das einen Funktionsparameter als Referenz definiert.  In der Regel werden Parameter als Werte an die Funktion √ºbergeben.  Wenn Sie in einem Aufruf vor einem Funktionsparameter <i><b>inout</b></i> schreiben, definieren Sie diesen Parameter als Referenztyp.  Um mehr √ºber inout Argumente zu erfahren, k√∂nnen Sie diesem Link folgen.  Kurz gesagt, mit <i><b>inout</b></i> k√∂nnen Sie den Wert der Variablen selbst √§ndern, die an die Funktion √ºbergeben wurde, und nicht nur ihren Wert im Parameter <i><b>abrufen</b></i> und innerhalb der Funktion damit arbeiten.  Das <i><b>ParameterEncoder-</b></i> Protokoll wird in <i><b>JSONParameterEncoder</b></i> und in <i><b>URLPameterEncoder implementiert</b></i> . <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">protocol</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParameterEncoder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(urlRequest: </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">inout</span></span></span></span><span class="hljs-function"><span class="hljs-params"> URLRequest, with parameters: Parameters)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> }</code> </pre> <br><br>  <i><b>ParameterEncoder</b></i> enth√§lt eine einzelne Funktion, deren Aufgabe es ist, Parameter zu codieren.  Diese Methode kann einen Fehler ausl√∂sen, der behandelt werden muss, daher verwenden wir throw. <br><br>  Es kann auch n√ºtzlich sein, keine Standardfehler, sondern benutzerdefinierte Fehler zu erzeugen.  Es ist immer ziemlich schwierig zu entschl√ºsseln, was Xcode Ihnen bietet.  Wenn Sie alle Fehler angepasst und beschrieben haben, wissen Sie immer genau, was passiert ist.  Definieren wir dazu eine Aufz√§hlung, die von <i><b>Error</b></i> erbt. <br><br><img src="https://habrastorage.org/webt/tl/bj/dd/tlbjddm7l48ho1alexej8rrj15q.png"><br><br>  Erstellen Sie eine Datei, nennen Sie sie <i><b>URLParameterEncoder</b></i> und legen Sie sie im Ordner <i><b>Encoding ab</b></i> . <br><br><img src="https://habrastorage.org/webt/s-/eh/tg/s-ehtgdznm1pcdjyrhn3r4fibjs.png"><br><br>  Dieser Code nimmt eine Liste von Parametern auf, konvertiert und formatiert sie zur Verwendung als URL-Parameter.  Wie Sie wissen, sind einige Zeichen in der URL nicht zul√§ssig.  Die Parameter werden auch durch das Symbol "&amp;" getrennt, daher m√ºssen wir uns darum k√ºmmern.  Wir m√ºssen auch den Standardwert f√ºr die Header festlegen, wenn sie nicht in der Anforderung festgelegt sind. <br><br>  Dies ist der Teil des Codes, der durch Unit-Tests abgedeckt werden soll.  Das Erstellen einer URL-Anfrage ist der Schl√ºssel, da wir sonst viele unn√∂tige Fehler provozieren k√∂nnen.  Wenn Sie die offene API verwenden, m√∂chten Sie offensichtlich nicht das gesamte m√∂gliche Volumen an Anforderungen f√ºr fehlgeschlagene Tests verwenden.  Wenn Sie mehr √ºber Unit-Tests erfahren m√∂chten, k√∂nnen Sie mit diesem Artikel beginnen. <br><br>  <b>JSONParameterEncoder</b> <br><br>  Erstellen Sie eine Datei, nennen Sie sie <i><b>JSONParameterEncoder</b></i> und legen Sie sie im Ordner Encoding ab. <br><br><img src="https://habrastorage.org/webt/qf/nc/gp/qfncgpv0juhwx6xnvn4llxqv0eu.png"><br><br>  Alles ist das gleiche wie im Fall von <i><b>URLParameter</b></i> , nur hier werden wir die Parameter f√ºr JSON konvertieren und die Parameter, die die Codierung "application / json" definieren, erneut zum Header hinzuf√ºgen. <br><br>  <b>Netzwerkrouter</b> <br><br>  Erstellen Sie eine Datei, nennen Sie sie <i><b>NetworkRouter</b></i> und legen Sie sie im Dienstordner ab.  Beginnen wir mit der Definition von Typealien f√ºr den Abschluss. <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typealias</span></span> <span class="hljs-type"><span class="hljs-type">NetworkRouterCompletion</span></span> = (<span class="hljs-number"><span class="hljs-number">_</span></span> data: <span class="hljs-type"><span class="hljs-type">Data?</span></span>,<span class="hljs-number"><span class="hljs-number">_</span></span> response: <span class="hljs-type"><span class="hljs-type">URLResponse?</span></span>,<span class="hljs-number"><span class="hljs-number">_</span></span> error: <span class="hljs-type"><span class="hljs-type">Error?</span></span>)-&gt;()</code> </pre><br><br>  Als n√§chstes definieren wir das <i><b>NetworkRouter-</b></i> Protokoll. <br><br><img src="https://habrastorage.org/webt/uf/zd/s0/ufzds0f3ci0fvx9mr0hingvxjtc.png"><br><br>  <i><b>NetworkRouter</b></i> verf√ºgt √ºber einen <i><b>EndPoint</b></i> , den es f√ºr Anforderungen verwendet. Sobald die Anforderung abgeschlossen ist, wird das Ergebnis dieser Anforderung an den <i><b>NetworkRouterCompletion-</b></i> Abschluss √ºbergeben.  Das Protokoll verf√ºgt au√üerdem √ºber eine <i><b>Abbruchfunktion</b></i> , mit der langfristige Lade- und Entladeanforderungen unterbrochen werden k√∂nnen.  Wir haben hier auch den <i><b>zugeh√∂rigen</b></i> Typ verwendet, da unser <i><b>Router</b></i> alle Arten von <i><b>EndPointType unterst√ºtzen soll</b></i> .  Ohne den zugeh√∂rigen Typ m√ºsste der Router einen bestimmten Typ haben, der <i><b>EndPointType</b></i> implementiert.  Wenn Sie mehr √ºber den zugeh√∂rigen Typ erfahren m√∂chten, k√∂nnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesen Artikel</a> lesen. <br><br>  <b>Router</b> <br><br>  Erstellen Sie eine Datei, nennen Sie sie <i><b>Router</b></i> und legen Sie sie im Ordner Service ab.  Wir deklarieren eine private Variable vom Typ <i><b>URLSessionTask</b></i> .  Alle Arbeiten werden daran sein.  Wir machen es privat, weil wir nicht m√∂chten, dass jemand au√üerhalb es √§ndern kann. <br><br><img src="https://habrastorage.org/webt/gb/wk/cx/gbwkcxouam1y86i-sruvzyhub_c.png"><br><br>  <b>Anfrage</b> <br><br>  Hier erstellen wir <i><b>URLSession</b></i> mit <i><b>URLSession.shared</b></i> . Dies ist der einfachste Weg zum Erstellen.  Denken Sie jedoch daran, dass diese Methode nicht die einzige ist.  Sie k√∂nnen komplexere <i><b>URLSession-</b></i> Konfigurationen verwenden, die das Verhalten √§ndern k√∂nnen.  Mehr dazu in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Artikel</a> . <br><br>  Die Anforderung wird durch Aufrufen der Funktion <i>buildRequest erstellt.</i> Der Funktionsaufruf wird in do-try-catch eingeschlossen, da die Codierungsfunktionen in <i>buildRequest</i> m√∂glicherweise Ausnahmen <i>ausl√∂sen</i> .  <i>Antwort</i> , <i>Daten</i> und <i>Fehler</i> werden vollst√§ndig √ºbergeben. <br><br><img src="https://habrastorage.org/webt/oi/3c/jl/oi3cjllxhvs7n_m39kmy9r7q29k.png"><br><br>  <b>Build-Anfrage</b> <br><br>  Wir erstellen unsere Anfrage mit der Funktion <i>buildRequest</i> .  Diese Funktion ist f√ºr alle wichtigen Arbeiten in unserer Netzwerkschicht verantwortlich.  Konvertiert <i><b>EndPointType</b></i> im Wesentlichen in <i><b>URLRequest</b></i> .  Sobald sich <i><b>EndPoint</b></i> in eine Anfrage verwandelt, k√∂nnen wir diese an die <i><b>Sitzung weitergeben</b></i> .  Hier passiert viel, also schauen wir uns die Methoden an.  <i>Lassen Sie uns zun√§chst</i> die <i>buildRequest-</i> Methode untersuchen: <br><br>  1. Wir initialisieren die <i><b>URLRequest-</b></i> Anforderungsvariable.  Wir legen unsere Basis-URL darin fest und f√ºgen den Pfad der spezifischen Anfrage hinzu, die dazu verwendet wird. <br><br>  2. <i>Weisen Sie request.httpMethod die</i> http-Methode aus unserem <i><b>EndPoint zu</b></i> . <br><br>  3. Wir erstellen einen Do-Try-Catch-Block, da unsere Encoder m√∂glicherweise einen Fehler ausl√∂sen.  Durch das Erstellen eines gro√üen Do-Try-Catch-Blocks entf√§llt die Notwendigkeit, f√ºr jeden Versuch einen separaten Block zu erstellen. <br><br>  4. √úberpr√ºfen <i><b>Sie</b></i> in switch <i><b>route.task</b></i> . <br><br>  5. Je nach Art der Aufgabe rufen wir den entsprechenden Encoder auf. <br><br><img src="https://habrastorage.org/webt/pt/ij/58/ptij58jibcjvvawtyb44axo5mq4.png"><br><br>  <b>Parameter konfigurieren</b> <br><br>  Erstellen Sie die Funktion <i><b>configureParameters</b></i> im Router. <br><br><img src="https://habrastorage.org/webt/fb/gf/fy/fbgffycewgssxqrnxglvsvftl0w.png"><br><br>  Diese Funktion ist f√ºr die Konvertierung unserer Abfrageparameter verantwortlich.  Da unsere API die Verwendung von <i><b>bodyParameters</b></i> in Form von JSON und <i><b>URLParameters voraussetzt,</b></i> die in das URL-Format konvertiert wurden, √ºbergeben wir einfach die entsprechenden Parameter an die entsprechenden Konvertierungsfunktionen, die wir am Anfang des Artikels beschrieben haben.  Wenn Sie eine API verwenden, die verschiedene Arten von Codierungen enth√§lt, w√ºrde ich in diesem Fall empfehlen, <i><b>HTTPTask mit</b></i> einer zus√§tzlichen Aufz√§hlung mit dem Codierungstyp hinzuzuf√ºgen.  Diese Auflistung sollte alle m√∂glichen Arten von Codierungen enthalten.  F√ºgen Sie danach in configureParameters ein weiteres Argument mit dieser Aufz√§hlung hinzu.  Wechseln Sie je nach Wert mit switch und stellen Sie die gew√ºnschte Codierung ein. <br><br>  <b>Zus√§tzliche √úberschriften hinzuf√ºgen</b> <br><br>  Erstellen Sie die Funktion <i>addAdditionalHeaders</i> im Router. <br><br><img src="https://habrastorage.org/webt/ow/07/8a/ow078aeoow6qlavpxiobwl6nbh0.png"><br><br>  F√ºgen Sie der Anfrage einfach alle erforderlichen Header hinzu. <br><br>  <b>Abbrechen</b> <br><br>  Die <i>Abbruchfunktion</i> sieht ziemlich einfach aus: <br><br><img src="https://habrastorage.org/webt/v4/3t/mm/v43tmm1dlso_cwstw6sy444vyu4.png"><br><br>  <b>Anwendungsbeispiel</b> <br><br>  Versuchen wir nun, unsere Netzwerkschicht anhand eines realen Beispiels zu verwenden.  Wir werden uns mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">TheMovieDB verbinden</a> , um Daten f√ºr unsere Anwendung zu erhalten. <br><br>  <b>MovieEndPoint</b> <br><br>  Erstellen Sie eine <i><b>MovieEndPoint-</b></i> Datei und legen Sie sie im EndPoint-Ordner ab.  MovieEndPoint ist dasselbe wie <br>  und TargetType in Moya.  Hier implementieren wir stattdessen unseren eigenen EndPointType.  Ein Artikel, der beschreibt, wie Moya f√ºr ein √§hnliches Beispiel verwendet wird, finden Sie unter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Link</a> . <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation enum NetworkEnvironment { case qa case production case staging } public enum MovieApi { case recommended(id:Int) case popular(page:Int) case newMovies(page:Int) case video(id:Int) } extension MovieApi: EndPointType { var environmentBaseURL : String { switch NetworkManager.environment { case .production: return "https:<span class="hljs-comment"><span class="hljs-comment">//api.themoviedb.org/3/movie/" case .qa: return "https://qa.themoviedb.org/3/movie/" case .staging: return "https://staging.themoviedb.org/3/movie/" } } var baseURL: URL { guard let url = URL(string: environmentBaseURL) else { fatalError("baseURL could not be configured.")} return url } var path: String { switch self { case .recommended(let id): return "\(id)/recommendations" case .popular: return "popular" case .newMovies: return "now_playing" case .video(let id): return "\(id)/videos" } } var httpMethod: HTTPMethod { return .get } var task: HTTPTask { switch self { case .newMovies(let page): return .requestParameters(bodyParameters: nil, urlParameters: ["page":page, "api_key":NetworkManager.MovieAPIKey]) default: return .request } } var headers: HTTPHeaders? { return nil } }</span></span></code> </pre><br><br>  <b>Moviemodel</b> <br><br>  Um das <i><b>MovieModel-</b></i> und JSON-Datenmodell in das Modell zu analysieren, wird das Decodable-Protokoll verwendet.  Legen Sie diese Datei im Ordner <i><b>Modell ab</b></i> . <br><br>  <i>Hinweis</i> : F√ºr eine detailliertere Kenntnis der Protokolle Codable, Decodable und Encodable k√∂nnen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">meinen anderen Artikel</a> lesen, in dem alle Funktionen der Arbeit mit ihnen ausf√ºhrlich beschrieben werden. <br><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Foundation struct MovieApiResponse { let page: Int let numberOfResults: Int let numberOfPages: Int let movies: [Movie] } extension MovieApiResponse: Decodable { private enum MovieApiResponseCodingKeys: String, CodingKey { case page case numberOfResults = "total_results" case numberOfPages = "total_pages" case movies = "results" } init(from decoder: Decoder) throws { let container = try decoder.container(keyedBy: MovieApiResponseCodingKeys.self) page = try container.decode(Int.self, forKey: .page) numberOfResults = try container.decode(Int.self, forKey: .numberOfResults) numberOfPages = try container.decode(Int.self, forKey: .numberOfPages) movies = try container.decode([Movie].self, forKey: .movies) } } struct Movie { let id: Int let posterPath: String let backdrop: String let title: String let releaseDate: String let rating: Double let overview: String } extension Movie: Decodable { enum MovieCodingKeys: String, CodingKey { case id case posterPath = "poster_path" case backdrop = "backdrop_path" case title case releaseDate = "release_date" case rating = "vote_average" case overview } init(from decoder: Decoder) throws { let movieContainer = try decoder.container(keyedBy: MovieCodingKeys.self) id = try movieContainer.decode(Int.self, forKey: .id) posterPath = try movieContainer.decode(String.self, forKey: .posterPath) backdrop = try movieContainer.decode(String.self, forKey: .backdrop) title = try movieContainer.decode(String.self, forKey: .title) releaseDate = try movieContainer.decode(String.self, forKey: .releaseDate) rating = try movieContainer.decode(Double.self, forKey: .rating) overview = try movieContainer.decode(String.self, forKey: .overview) } }</code> </pre><br><br>  <b>Netzwerkmanager</b> <br><br>  Erstellen Sie eine <i><b>NetworkManager-</b></i> Datei im Manager-Ordner.  Derzeit enth√§lt NetworkManager nur zwei statische Eigenschaften: einen API-Schl√ºssel und eine Aufz√§hlung, die den Servertyp beschreibt, zu dem eine Verbindung hergestellt werden soll.  <i><b>NetworkManager</b></i> enth√§lt auch einen <i><b>Router</b></i> vom Typ <i><b>MovieApi</b></i> . <br><br><img src="https://habrastorage.org/webt/yj/it/-b/yjit-b1afnahwsvjkkjnaezgpdu.png"><br><br>  <b>Netzwerkantwort</b> <br><br>  Erstellen Sie die <i><b>NetworkResponse-</b></i> Enumeration in NetworkManager. <br><br><img src="https://habrastorage.org/webt/vv/fv/7s/vvfv7sl-q-dmnz289jdcntmhs0k.png"><br><br>  Wir verwenden diese Aufz√§hlung bei der Verarbeitung von Antworten auf Anfragen und zeigen die entsprechende Nachricht an. <br><br>  <b>Ergebnis</b> <br><br>  Erstellen Sie eine <i><b>Ergebnisaufz√§hlung</b></i> in NetworkManager. <br><br><img src="https://habrastorage.org/webt/en/oj/ad/enojad3e4jxk2jgkntgblqftivu.png"><br><br>  Wir verwenden das <i><b>Ergebnis,</b></i> um festzustellen, ob die Anfrage erfolgreich war oder nicht.  Wenn nicht, geben wir eine Fehlermeldung mit dem Grund zur√ºck. <br><br>  <b>Antwortverarbeitung anfordern</b> <br><br>  Erstellen Sie die Funktion <i><b>handleNetworkResponse</b></i> .  Diese Funktion verwendet ein Argument, z. B. eine <i><b>HTTP-Antwort,</b></i> und gibt das Ergebnis zur√ºck. <br><br><img src="https://habrastorage.org/webt/wt/uv/5f/wtuv5f7cptiudu69o8mn16psbsy.png"><br><br>  In dieser Funktion geben wir abh√§ngig vom empfangenen statusCode von HTTPResponse eine Fehlermeldung oder ein Zeichen f√ºr eine erfolgreiche Anforderung zur√ºck.  In der Regel bedeutet ein Code im Bereich von 200 bis 299 Erfolg. <br><br>  <b>Netzwerkanfrage stellen</b> <br><br>  Wir haben also alles getan, um unsere Netzwerkschicht zu nutzen. Versuchen wir, eine Anfrage zu stellen. <br><br>  Wir werden eine Liste neuer Filme anfordern.  Erstellen Sie eine Funktion und nennen Sie sie <i><b>getNewMovies</b></i> . <br><br><img src="https://habrastorage.org/webt/ei/yn/fn/eiynfnoketqomcziq5nzv6ulaao.png"><br><br>  Gehen wir Schritt f√ºr Schritt vor: <br><br>  1. Wir definieren die Methode <i><b>getNewMovies</b></i> mit zwei Argumenten: der Paginierungsseitenzahl und dem Vervollst√§ndigungshandler, der ein optionales Array von <i><b>Filmmodellen</b></i> zur√ºckgibt, oder einen optionalen Fehler. <br><br>  2. Rufen Sie den <i><b>Router an</b></i> .  Wir √ºbergeben die Seitenzahl und den Prozessabschluss im Abschluss. <br><br>  3. <i><b>URLSession</b></i> gibt einen Fehler zur√ºck, wenn kein Netzwerk vorhanden ist oder aus irgendeinem Grund keine Anfrage gestellt werden konnte.  Bitte beachten Sie, dass dies kein API-Fehler ist. Solche Fehler treten auf dem Client auf und treten normalerweise aufgrund der schlechten Qualit√§t der Internetverbindung auf. <br><br>  4. Wir m√ºssen unsere <i><b>Antwort</b></i> in <i><b>HTTPURLResponse umwandeln</b></i> , da wir auf die <i>statusCode-</i> Eigenschaft zugreifen <i>m√ºssen</i> . <br><br>  5. Deklarieren Sie das <i><b>Ergebnis</b></i> und initialisieren Sie es mit der <i><b>handleNetworkResponse-</b></i> Methode <br><br>  6. <i><b>Erfolg</b></i> bedeutet, dass die Anfrage erfolgreich war und wir die erwartete Antwort erhalten haben.  Dann pr√ºfen wir, ob die Daten mit der Antwort geliefert wurden, und wenn nicht, beenden wir die Methode einfach √ºber return. <br><br>  7. Wenn die Antwort Daten enth√§lt, m√ºssen die empfangenen Daten in das Modell analysiert werden.  Danach √ºbergeben wir das resultierende Array von Modellen vollst√§ndig. <br><br>  8. √úbergeben Sie den Fehler im Fehlerfall <i>vollst√§ndig</i> . <br><br>  So funktioniert unsere eigene Netzwerkschicht auf reinem Swift, ohne Abh√§ngigkeiten in Form von Pods und Bibliotheken von Drittanbietern zu verwenden.  Um eine Test-API-Anforderung zum Abrufen einer Liste von Filmen zu erstellen, erstellen Sie einen MainViewController mit der <i><b>NetworkManager-</b></i> Eigenschaft und rufen Sie die <i><b>getNewMovies-</b></i> Methode auf. <br><br><pre> <code class="swift hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainViewController</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIViewController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> networkManager: <span class="hljs-type"><span class="hljs-type">NetworkManager!</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(networkManager: <span class="hljs-type"><span class="hljs-type">NetworkManager</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>(nibName: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>, bundle: <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.networkManager = networkManager } <span class="hljs-keyword"><span class="hljs-keyword">required</span></span> <span class="hljs-keyword"><span class="hljs-keyword">init</span></span>?(coder aDecoder: <span class="hljs-type"><span class="hljs-type">NSCoder</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">fatalError</span></span>(<span class="hljs-string"><span class="hljs-string">"init(coder:) has not been implemented"</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">viewDidLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.viewDidLoad() view.backgroundColor = .green networkManager.getNewMovies(page: <span class="hljs-number"><span class="hljs-number">1</span></span>) { movies, error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> error = error { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(error) } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> movies = movies { <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(movies) } } } }</code> </pre> <br><br>  <b>Kleiner Bonus</b> <br><br>  Sie hatten Situationen in Xcode, in denen Sie nicht verstanden haben, welche Art von Platzhalter an einem bestimmten Ort verwendet wird?  Schauen Sie sich zum Beispiel den Code an, den wir gerade f√ºr <i><b>Router geschrieben haben</b></i> . <br><br><img src="https://habrastorage.org/webt/sd/cb/ga/sdcbgacxit9y-j4zk8w32slxqm8.png"><br><br>  Wir haben die <i><b>NetworkRouterCompletion</b></i> selbst festgelegt, aber selbst in diesem Fall kann man leicht vergessen, um welchen Typ es sich handelt und wie man ihn verwendet.  Aber unser geliebter Xcode hat sich um alles gek√ºmmert, und es reicht aus, nur auf den Platzhalter zu doppelklicken, und Xcode ersetzt den gew√ºnschten Typ. <br><br><img src="https://habrastorage.org/webt/la/wo/oj/lawoojq5qsvsdzzvfzarqc-wnsk.png"><br><br>  <b>Fazit</b> <br><br>  Jetzt haben wir eine Implementierung einer protokollorientierten Netzwerkschicht, die sehr einfach zu verwenden ist und die Sie jederzeit an Ihre Bed√ºrfnisse anpassen k√∂nnen.  Wir haben seine Funktionalit√§t verstanden und wie alle Mechanismen funktionieren. <br><br>  Sie finden den Quellcode in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Repository</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de443514/">https://habr.com/ru/post/de443514/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de443502/index.html">Warum genau vor 4 Jahren hat die NASA mit der Atlas V-Rakete den Nachthimmel von Cape Canaveral abgeschossen?</a></li>
<li><a href="../de443504/index.html">Das World Wide Web ist drei√üig Jahre alt - was wird als n√§chstes damit geschehen?</a></li>
<li><a href="../de443508/index.html">P√§dagogische Brettspiele f√ºr Programmierer</a></li>
<li><a href="../de443510/index.html">Compaq Armada 7700 Notebook - als Weiterentwicklung der Compaq LTE-Linie</a></li>
<li><a href="../de443512/index.html">Datenanalyse-Hackathon in Nischni Nowgorod</a></li>
<li><a href="../de443516/index.html">Hacker Geohot hat beschlossen, Menschen von der KI-Simulation zu befreien</a></li>
<li><a href="../de443518/index.html">RBKmoney Zahlungen unter der Haube - Microservices, Protokolle und Plattformkonfiguration</a></li>
<li><a href="../de443520/index.html">W√§hlen Sie ein Auto f√ºr einen IT-Spezialisten oder Tipps f√ºr Teekannen aus einer Teekanne</a></li>
<li><a href="../de443522/index.html">Hosting: Optionen, Vergleiche, Benutzerstatistiken</a></li>
<li><a href="../de443524/index.html">Do-it-yourself-Flash-Animationen in Unity3D. Erster Teil, Lyrisch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>