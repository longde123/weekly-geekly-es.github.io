<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🕛 🎋 🏹 Contrôle automatique à l'aide de l'accès à distance au registre Windows ◽️ 🧑🏽‍🤝‍🧑🏻 🦐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La prise en charge du fonctionnement correct et correct des ordinateurs et des logiciels des utilisateurs ordinaires est une routine des employés et /...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Contrôle automatique à l'aide de l'accès à distance au registre Windows</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/426873/"><p>  La prise en charge du fonctionnement correct et correct des ordinateurs et des logiciels des utilisateurs ordinaires est une routine des employés et / ou administrateurs du support technique.  Si l'entreprise est petite et que tout le monde est dans une ou deux pièces, il est généralement facile d'aller vous-même et de résoudre le problème ou de vérifier ce dont vous avez besoin. </p><br><p>  Mais que se passe-t-il si l'entreprise est grande et que l'utilisateur se trouve sur un autre site / dans une autre ville / pays? </p><br><p><img src="https://habrastorage.org/webt/wt/ie/d-/wtied-3-4doen9ma6k3gbtzee2u.png" alt="image"></p><a name="habracut"></a><br><p>  L'un des outils classiques pour un tel travail est une connexion à distance (en utilisant RDP, un logiciel comme TeamViewer / Skype avec une démo de bureau, etc.).  Mais ce n'est pas sans défauts fondamentaux: </p><br><ul><li>  dans tous les cas, l'utilisateur final sera distrait de son travail (dans certains cas, sans même voir son bureau) </li><li>  ces outils ne fonctionneront pas toujours s'il y a des erreurs sur l'ordinateur distant </li><li>  l'installation de logiciels tiers (y compris propriétaires, dans le cas de TeamViewer) est loin d'être toujours bien accueillie par la politique de l'entreprise </li><li>  la méthode n'est pratiquement pas automatisée </li></ul><br><p>  Enfin - cette approche est utilisée lorsque l'incident a déjà eu lieu (il est difficile d'imaginer que l'administrateur se connecte de temps en temps «préventivement» à chaque utilisateur).  C'est pourquoi le mécanisme de contrôle (surveillance) des ordinateurs distants est important. </p><br><p>  Une solution possible consiste à utiliser l'accès à distance au registre Windows.  Il stocke les données sous la forme d'une base de données hiérarchique, ce qui vous permet de les recevoir rapidement et de les stocker de manière compacte.  Ils utilisent le registre pour stocker leurs propres paramètres et paramètres, à la fois le système d'exploitation et les services intégrés, ainsi que la plupart des programmes tiers.  Par conséquent, le contenu du registre affecte à bien des égards le fonctionnement du système. </p><br><p>  Sur cette base, le registre peut très bien être utilisé comme un «indicateur» de surveillance (vous pouvez détecter une erreur si elle est associée à des paramètres incorrects dans le registre ou simuler une situation problématique). </p><br><p>  Une autre possibilité que cette solution offre est la possibilité d'un contrôle administratif des utilisateurs (par exemple, la lecture à distance vous permet de voir les faits d'installer des programmes indésirables et de modifier les paramètres) - n'oubliez pas l'influence du "facteur humain" sur le système.  En pratique, cela était utile dans le cadre du projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SkypeTime</a> , où il était nécessaire de suivre la correction des paramètres dans Skype Entreprise. </p><br><p><img src="https://habrastorage.org/webt/eb/jt/9l/ebjt9lhsnvxoead9su8n64gzyqq.jpeg" alt="image"></p><br><p>  Mais le registre contient des milliers d'entrées, il est extrêmement difficile de les contrôler toutes.  Par conséquent, tout d'abord, il est nécessaire de limiter le sujet du contrôle - pour déterminer quels paramètres nous intéressent et pour savoir dans quelles branches de registre particulières se trouvent les valeurs correspondantes.  En règle générale, ce dernier n'est pas difficile à trouver dans la documentation / Internet, ou à déterminer indépendamment en fonction des noms des clés. </p><br><p>  Après avoir décidé du sujet du contrôle, vous pouvez procéder à la configuration directe de l'accès à distance.  Pour ce faire, vous devez activer le service d'appel de procédure distante sur des ordinateurs distants et configurer le pare-feu si nécessaire, ce qui se fait facilement à l'aide de stratégies de groupe.  Compte tenu des exigences de sécurité, l'accès nécessite les droits d'un administrateur de domaine ou d'un administrateur local sur chacun des appareils. </p><br><div class="spoiler">  <b class="spoiler_title">Configurer l'accès à distance</b> <div class="spoiler_text"><p>  Pour activer le service lui-même, dans la section Configuration ordinateur&gt; Préférences&gt; Paramètres du panneau de configuration&gt; Services, définissez les paramètres du service RpcSs, comme dans une capture d'écran </p><br><p><img src="https://habrastorage.org/webt/oy/j8/k-/oyj8k-xbkjvb6yurtx-_ejk_0gc.jpeg" alt="image"></p><br><p>  Il reste à ajouter les exceptions de pare-feu appropriées.  Dans la même stratégie, sous Configuration ordinateur&gt; Stratégies&gt; Paramètres Windows&gt; Paramètres de sécurité&gt; Pare-feu Windows avec sécurité avancée&gt; Règles entrantes, créez une nouvelle règle: <br>  Type de règle - Personnalisé </p><br><p><img src="https://habrastorage.org/webt/s1/wo/hk/s1wohkk7ldbibzqrim7qrcki-rs.jpeg" alt="image"></p><br><p>  Spécifiez le chemin du programme -% SystemRoot% \ system32 \ svchost.exe <br>  Dans les paramètres supplémentaires de la section Services, définissez Appliquer au service avec le nom abrégé suivant - Winmgmt </p><br><p><img src="https://habrastorage.org/webt/ef/fg/wv/effgwvovrv1eqr9btfiy-dv9dzo.jpeg" alt="image"></p><br><p>  Sur les pages suivantes, nous spécifions TCP sans spécifier de ports spécifiques et pour toutes les adresses </p><br><p><img src="https://habrastorage.org/webt/0z/-5/ef/0z-5ef-xfzxapqdbl8mln_9hu6u.jpeg" alt="image"></p><br><p><img src="https://habrastorage.org/webt/7k/y6/ks/7ky6kso0xwqyamgqb14i3uvkxxi.jpeg" alt="image"></p><br><p>  et autoriser la connexion ( <em>Autoriser la connexion</em> ) pour le profil de domaine </p><br><p><img src="https://habrastorage.org/webt/ry/hg/e7/ryhge7d26xy8gjkmlneq6cqjg6w.jpeg" alt="image"></p><br><p><img src="https://habrastorage.org/webt/ui/fq/-a/uifq-aqdmohmt-omff0ctcgm1mq.jpeg" alt="image"></p></div></div><br><p>  Cependant, contrôler manuellement le registre de dizaines et de centaines d'ordinateurs «manuellement» (même avec quelques entrées) est une tâche ingrate et insensée.  Heureusement, ce processus est assez simple à automatiser à l'aide de scripts.  Par exemple, le script PowerShell suivant vous permet de savoir quel utilisateur a modifié les paramètres AwayThreshold et IdleThreshold (le temps de passer à l'état «Out of Place» et «Inactive») pour Skype for Business. </p><br><div class="spoiler">  <b class="spoiler_title">Code de script</b> <div class="spoiler_text"><pre><code class="hljs mel">Param ( [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"c"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$FromFileComputers, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"r"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$OutputRPCErrorsFile, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"u"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$FromFileUsers, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"o"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$OutputFile=<span class="hljs-string"><span class="hljs-string">"output.csv"</span></span>, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"a"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>]$MinAway, [<span class="hljs-keyword"><span class="hljs-keyword">alias</span></span>(<span class="hljs-string"><span class="hljs-string">"i"</span></span>)] [<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>]$MinIdle ) $RPCErrorsArray = @() $result = @() $HKU = <span class="hljs-number"><span class="hljs-number">2147483651</span></span> $RegistryForCheckArray = <span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\13.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\14.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\15.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Office\16.0\Lync"</span></span>,<span class="hljs-string"><span class="hljs-string">"SOFTWARE\Microsoft\Communicator"</span></span> $CurrentComputerNumber = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($FromFileUsers)) { $Users = Get-Content $FromFileUsers; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($FromFileComputers)) { $Comps = Get-Content $FromFileComputers; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $date = (get-<span class="hljs-keyword"><span class="hljs-keyword">date</span></span>).AddMonths(<span class="hljs-number"><span class="hljs-number">-1</span></span>) $Comps = Get-ADComputer -<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> { lastlogontimestamp -ge $date } | <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> name | ForEach-Object {$_.name} #$Comps = <span class="hljs-string"><span class="hljs-string">"NB_CY"</span></span> } $ServersCount = ($Comps).Count; Foreach ($Comp <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $Comps) { $CurrentComputerNumber++ try { Write-Host <span class="hljs-string"><span class="hljs-string">"Checking: $Comp [$CurrentComputerNumber/$ServersCount]"</span></span>; $profiles = Get-WmiObject Win32_UserProfile -<span class="hljs-keyword"><span class="hljs-keyword">filter</span></span> <span class="hljs-string"><span class="hljs-string">"Loaded=$true and special=$false"</span></span> -ComputerName $Comp -ErrorAction Stop $reg = [wmiclass]<span class="hljs-string"><span class="hljs-string">"\\$Comp\root\default:stdregprov"</span></span> Foreach ($profile <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $profiles) { $username = Split-Path $profile.LocalPath -Leaf <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($FromFileUsers)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$Users.Contains($username)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } } Foreach( $registry <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> $RegistryForCheckArray) { $hkey = <span class="hljs-string"><span class="hljs-string">"$($profile.sid)\$registry"</span></span> #Write-Host <span class="hljs-string"><span class="hljs-string">"KEY: $hkey"</span></span> $away = $reg.GetDWORDValue($hku,$hkey,<span class="hljs-string"><span class="hljs-string">"AwayThreshold"</span></span>).uValue $idle = $reg.GetDWORDValue($hku,$hkey,<span class="hljs-string"><span class="hljs-string">"IdleThreshold"</span></span>).uValue $sip = $reg.GetStringValue($hku,$hkey,<span class="hljs-string"><span class="hljs-string">"ServerSipUri"</span></span>).sValue <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($away) -and [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($idle)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(($MinAway -gt <span class="hljs-number"><span class="hljs-number">0</span></span> -and $away -lt $MinAway) -or ($MinIdle -gt <span class="hljs-number"><span class="hljs-number">0</span></span> -and $idle -lt $MinIdle)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } $result += New-Object PsObject -Property @{ <span class="hljs-string"><span class="hljs-string">"PC"</span></span> = $Comp <span class="hljs-string"><span class="hljs-string">"Username"</span></span> = $username <span class="hljs-string"><span class="hljs-string">"SIP"</span></span> = $sip <span class="hljs-string"><span class="hljs-string">"SFB_Away"</span></span> = $away <span class="hljs-string"><span class="hljs-string">"SFB_Idle"</span></span> = $idle } } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($_.Exception.GetType().Name -eq <span class="hljs-string"><span class="hljs-string">"COMException"</span></span>) { $RPCErrorsArray += $Comp; } Write-Host <span class="hljs-string"><span class="hljs-string">"Error: ($_.Exception.GetType().Name)"</span></span>; $_.Exception } } $result | Export-csv -Path $OutputFile $result | Format-Table -Property PC,Username,SIP,SFB_Away,SFB_Idle -AutoSize Write-Host <span class="hljs-string"><span class="hljs-string">"Saved to: $OutputFile"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(![<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]::IsNullOrEmpty($OutputRPCErrorsFile)) { $RPCErrorsArray | out-<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> $OutputRPCErrorsFile Write-Host <span class="hljs-string"><span class="hljs-string">"RPC errors saved to: $OutputRPCErrorsFile"</span></span> }</code> </pre> </div></div><br>  Pour plus de commodité, le script peut être exécuté avec les paramètres: <br><br>  -c chemin d'accès au fichier avec une liste d'ordinateurs de nom d'hôte à vérifier, s'il n'est pas spécifié - récupérez les ordinateurs d'AD avec une activité de 30 jours. <br>  -r chemin d'accès au fichier dans lequel le nom d'hôte des ordinateurs ayant une erreur RPC sera écrit. <br>  -u chemin vers le fichier avec une liste d'utilisateurs (connexion), s'il n'est pas spécifié, vérifie tout. <br>  -o chemin vers le fichier dans lequel le résultat du script sera exécuté, la valeur par défaut est output.csv. <br>  -une valeur minimale pour le paramètre AwayThreshold, les enregistrements avec une valeur inférieure à la valeur spécifiée n'obtiendront pas le résultat de l'exécution du script. <br>  -i la valeur minimale pour le paramètre IdleThreshold, les enregistrements avec une valeur inférieure à la valeur spécifiée n'obtiendront pas le résultat du script. <br><br>  En outre, le script peut être automatisé en l'ajoutant au Planificateur de tâches Windows (Planificateur de tâches) ou via la fonctionnalité Sheduled Job dans PowerShell. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr426873/">https://habr.com/ru/post/fr426873/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr426853/index.html">«S in IoT Stands for Security»: la première loi au monde sur la protection des gadgets intelligents a été adoptée - nous comprenons ce qu'est l'essence</a></li>
<li><a href="../fr426861/index.html">Une nouvelle chasse à la matière noire prend place sous la montagne</a></li>
<li><a href="../fr426863/index.html">Disponible sur les quaternions et leurs avantages</a></li>
<li><a href="../fr426865/index.html">Une conception claire du tableau de bord pour un système de gestion des annonces sophistiqué</a></li>
<li><a href="../fr426869/index.html">Comment mener efficacement des vidéoconférences avec des clients étrangers</a></li>
<li><a href="../fr426875/index.html">Architecture de méta-serveur de tir en ligne mobile Tacticool</a></li>
<li><a href="../fr426879/index.html">Mise en place d'un système de restriction électrique pour les projets utilisant des interfaces haut débit</a></li>
<li><a href="../fr426881/index.html">Lancement de programmes de développement en ligne</a></li>
<li><a href="../fr426889/index.html">Comment participer à des compétitions d'apprentissage automatique. Conférence à Yandex</a></li>
<li><a href="../fr426891/index.html">Exploration de processus SAP ou comment comprendre vos processus métier</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>