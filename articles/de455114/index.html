<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>⛲️ 👩‍👩‍👧 🎉 Implementierung eines Integer-Typs in CPython 👨🏽‍🎤 🛸 🧕🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es gab bereits Artikel über Habré über die Implementierungsdetails von CPythons Speichermanager Pandas . Ich schrieb einen Artikel über die Implementi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Implementierung eines Integer-Typs in CPython</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/455114/"> Es gab bereits Artikel über Habré über die Implementierungsdetails von CPythons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Speichermanager</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pandas</a> . Ich schrieb einen Artikel über die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Implementierung des Wörterbuchs</a> . <br><br>  Es scheint, dass Sie über einen regulären Integer-Typ schreiben können?  Es ist jedoch nicht alles so einfach und der ganzzahlige Typ ist nicht so offensichtlich. <br><br>  Wenn Sie sich fragen, warum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">x * 2 schneller als x &lt;&lt; 1 ist</a> . <br><br>  Und wie man den folgenden Trick ankurbelt: <br><br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-number"><span class="hljs-number">42</span></span> == <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> &gt;&gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span> + <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span></code> </pre> <br>  Dann sollten Sie diesen Artikel lesen. <br><a name="habracut"></a><br>  In Python gibt es keine primitiven Typen - alle Variablen sind Objekte und werden im dynamischen Speicher zugeordnet.  Gleichzeitig werden Ganzzahlen nur durch einen Typ dargestellt (wir berücksichtigen keine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dezimalzahl</a> ) - PyLongObject.  Die Implementierung und Deklarationen davon liegen in den Dateien longobject.h, longintrepr.h und longobject.c. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">longobject</span></span></span><span class="hljs-class"> {</span></span> PyObject_VAR_HEAD <span class="hljs-comment"><span class="hljs-comment">//       digit ob_digit[1]; //   };</span></span></code> </pre><br>  In jedem Objekt in CPython gibt es zwei Felder: ob_refcnt - Zähler für Verweise auf das Objekt und ob_type - Zeiger auf den Typ des Objekts; für Objekte, die ihre Länge ändern können, wird das Feld ob_size hinzugefügt - die aktuell zugewiesene Größe (verwendet wird möglicherweise weniger). <br><br>  Daher wird der Integer-Typ durch ein Array mit variabler Länge aus separaten Ziffern dargestellt. Python out of the Box unterstützt also lange Arithmetik. In der zweiten Version der Sprache gab es einen separaten Typ von "normalen" Integer. "Long" Integer wurden mit dem Buchstaben L oder, wenn das Ergebnis von Operationen mit verursachte Überlauf durch gewöhnliche, in der dritten Version wurde beschlossen, es abzulehnen. <br><br><pre> <code class="python hljs"> <span class="hljs-comment"><span class="hljs-comment"># python2 num1 = 42 print num1, type(num1) # 42 &lt;type 'int'&gt; num2 = 42L print num2, type(num2) # 42 &lt;type 'long'&gt; num3 = 2 ** 100 print num3, type(num3) # 1267650600228229401496703205376 &lt;type 'long'&gt;</span></span></code> </pre><br>  Der von der _longobject-Struktur gespeicherte ganzzahlige Wert ist gleich: <p></p><p><math></math><span class="MathJax_Preview" style="color: inherit; display: none;"></span><div class="MathJax_SVG_Display" style="text-align: center;"><span class="MathJax_SVG" id="MathJax-Element-1-Frame" tabindex="0" style="font-size: 100%; display: inline-block;"><svg xmlns:xlink="http://www.w3.org/1999/xlink" width="34.768ex" height="3.624ex" viewBox="0 -1143.2 14969.4 1560.2" role="img" focusable="false" style="vertical-align: -0.969ex;"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="matrix(1 0 0 -1 0 0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-73" x="250" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-75" x="719" y="0"></use><g transform="translate(1292,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-6D" x="0" y="0"></use><g transform="translate(878,521)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-61" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-62" x="529" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-73" x="959" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-28" x="1428" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-6F" x="1818" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-62" x="2303" y="0"></use><g transform="translate(1932,0)"><use transform="scale(0.5)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-73" x="499" y="-213"></use></g><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-69" x="3518" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-7A" x="3864" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-65" x="4332" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-29" x="4799" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-2212" x="5188" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-31" x="5967" y="0"></use></g><g transform="translate(878,-308)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-69" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-3D" x="345" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-30" x="1124" y="0"></use></g></g><g transform="translate(6843,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-6F" x="0" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-62" x="485" y="0"></use><g transform="translate(915,0)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-64" x="353" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-69" x="1635" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-67" x="1980" y="0"></use><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-69" x="2461" y="0"></use><g transform="translate(2806,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-74" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-69" x="511" y="-213"></use></g><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-2217" x="3734" y="0"></use><g transform="translate(4457,0)"><use xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-32" x="0" y="0"></use><g transform="translate(500,412)"><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-53" x="0" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-48" x="645" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-49" x="1534" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-46" x="2038" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-54" x="2788" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMAIN-2217" x="3492" y="0"></use><use transform="scale(0.707)" xlink:href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://habr.com/ru/post/455114/&amp;usg=ALkJrhjOXgQV7t24FumJU0i6jMbPtxY2yA#MJMATHI-69" x="3993" y="0"></use></g></g></g></g></svg></span></div><script type="math/tex;mode=display" id="MathJax-Element-1"> \ sum_ {i = 0} ^ {abs (ob \ _size) -1} {ob \ _digit_i * 2 ^ {SHIFT * i}} </script></p><br>  Als Bit wird der 32-Bit-Typ ohne Vorzeichen (uint32_t) auf 64-Bit-Systemen und der 16-Bit-Kurztyp ohne Vorzeichen auf 32-Bit-Systemen verwendet. <br><br>  Die in der Implementierung verwendeten Algorithmen legen strenge Einschränkungen für SHIFT gegenüber der vorherigen Formel fest, insbesondere sollte sie durch 15 geteilt werden. Daher unterstützt cpython jetzt zwei Werte: 30 bzw. 15 für 64- und 32-Bit-Systeme.  Für negative Werte hat ob_size einen negativen Wert, Null wird durch eine Zahl gegeben, für die ob_size = 0 ist. <br><br>  Bei der Ausführung von arithmetischen Operationen überprüft der Interpreter die aktuelle Länge der Operanden. Wenn beide aus einem Bit bestehen, wird die Standardarithmetik ausgeführt. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">long_add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyLongObject *a, PyLongObject *b)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">//   -     if (Py_ABS(Py_SIZE(a)) &lt;= 1 &amp;&amp; Py_ABS(Py_SIZE(b)) &lt;= 1) { //      return PyLong_FromLong(MEDIUM_VALUE(a) + MEDIUM_VALUE(b)); } ... };</span></span></code> </pre><br>  Die Multiplikation hat eine ähnliche Struktur. Außerdem implementiert der Interpreter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">den Karatsuba-Algorithmus</a> und das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">schnelle Quadrieren</a> . Sie werden jedoch nicht für jede „lange Multiplikation“ durchgeführt, sondern nur für ausreichend große Zahlen, deren Anzahl durch zwei Konstanten angegeben wird: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//     #define KARATSUBA_CUTOFF 70 //      #define KARATSUBA_SQUARE_CUTOFF (2 * KARATSUBA_CUTOFF)</span></span></code> </pre><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">long_mul</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyLongObject *a, PyLongObject *b)</span></span></span><span class="hljs-function"> </span></span>{ ... <span class="hljs-comment"><span class="hljs-comment">//   -     if (Py_ABS(Py_SIZE(a)) &lt;= 1 &amp;&amp; Py_ABS(Py_SIZE(b)) &lt;= 1) { // stwodigits -  ,    // int64_t  64-   long  32-. stwodigits v = (stwodigits)(MEDIUM_VALUE(a)) * MEDIUM_VALUE(b); return PyLong_FromLongLong((long long)v); } ... // ""    O(N^2),     . i = a == b ? KARATSUBA_SQUARE_CUTOFF : KARATSUBA_CUTOFF; if (asize &lt;= i) { if (asize == 0) return (PyLongObject *)PyLong_FromLong(0); else return x_mul(a, b); } ... };</span></span></code> </pre><br>  Verschiebungsbefehle haben jedoch keine Prüfung für den Fall von "kurzen" ganzen Zahlen, sie werden immer für den Fall von langer Arithmetik ausgeführt.  Daher ist das Multiplizieren mit 2 schneller als die Verschiebung.  Es ist interessant festzustellen, dass die Division langsamer ist als die Rechtsverschiebung, wodurch auch der Fall von einstelligen Ganzzahlen nicht überprüft wird.  Die Unterteilung ist jedoch komplizierter: Es gibt eine Methode, die zuerst den Quotienten berechnet, dann wird der Rest NULL an ihn übergeben. Wenn Sie eine Sache berechnen müssen, dh die Methode muss auch diesen Fall prüfen, erhöht dies den Overhead. <br><br>  Die Vergleichsfunktion hat auch keinen Sonderfall für "kurze" ganze Zahlen. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">long_compare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyLongObject *a, PyLongObject *b)</span></span></span><span class="hljs-function"> </span></span>{ Py_ssize_t sign; <span class="hljs-comment"><span class="hljs-comment">// ,        //        if (Py_SIZE(a) != Py_SIZE(b)) { sign = Py_SIZE(a) - Py_SIZE(b); } else { Py_ssize_t i = Py_ABS(Py_SIZE(a)); //  ""        while (--i &gt;= 0 &amp;&amp; a-&gt;ob_digit[i] == b-&gt;ob_digit[i]) ; if (i &lt; 0) sign = 0; else { sign = (sdigit)a-&gt;ob_digit[i] - (sdigit)b-&gt;ob_digit[i]; if (Py_SIZE(a) &lt; 0) sign = -sign; } } return sign &lt; 0 ? -1 : sign &gt; 0 ? 1 : 0; }</span></span></code> </pre><br><h3>  Arrays (Listen) von Zahlen </h3><br>  Beim Erstellen einer Variablen vom Typ Integer sollte der Interpreter ausreichend Speicherplatz im dynamischen Speicher zuweisen, dann den Referenzzähler (Typ ssize_t), einen Zeiger auf den Typ PyLongObject, die aktuelle Größe des Bit-Arrays (auch ssize_t) festlegen und das Array selbst initialisieren.  Bei 64-Bit-Systemen beträgt die minimale Strukturgröße: 2 * ssize_t + Zeiger + Ziffer = 2 * 8 + 8 + 4 = 28 Byte.  Zusätzliche Probleme treten beim Erstellen von Zahlenlisten auf: Da Zahlen kein primitiver Typ sind und Listen in Python Speicherverweise auf Objekte enthalten, befinden sich die Objekte nicht nacheinander im dynamischen Speicher. <br><br>  Diese Anordnung verlangsamt die Iteration über das Array: Tatsächlich wird ein Direktzugriff durchgeführt, was es unmöglich macht, Übergänge vorherzusagen. <br><br>  Um eine übermäßige Zuweisung von dynamischem Speicher zu vermeiden, die die Betriebszeit verlangsamt und zur Speicherfragmentierung beiträgt, wird die Optimierung in cpython implementiert: In der Startphase wird ein Array kleiner Ganzzahlen vorab zugewiesen: von -5 bis 256. <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> NSMALLPOSINTS #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> NSMALLPOSINTS 257 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//     python    . #endif #ifndef NSMALLNEGINTS #define NSMALLNEGINTS 5 #endif</span></span></span></span></code> </pre><br>  Infolgedessen wird die Liste der Zahlen in cpython im Speicher wie folgt dargestellt: <br><br><img src="https://habrastorage.org/webt/k2/1m/hj/k21mhjawz4oerssjqvnhpdz3pq4.png"><br><br>  Es besteht die Möglichkeit, die vorgewählte Liste kleiner Ganzzahlen aus dem Skript zu erreichen, die mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diesem Artikel</a> und dem Standardmodul ctypes ausgestattet ist: <br><br>  Haftungsausschluss: Der folgende Code wird so geliefert, wie er ist. Der Autor übernimmt keine Verantwortung und kann den Status des Dolmetschers sowie die psychische Gesundheit von Ihnen und Ihren Kollegen nach dem Ausführen dieses Codes nicht garantieren. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ctypes <span class="hljs-comment"><span class="hljs-comment">#  PyLongObject class IntStruct(ctypes.Structure): #   _fields_ = [("ob_refcnt", ctypes.c_long), ("ob_type", ctypes.c_void_p), ("ob_size", ctypes.c_long), ("ob_digit", ctypes.c_int)] def __repr__(self): return ("IntStruct(ob_digit={self.ob_digit}, ob_size={self.ob_size}, " "refcount={self.ob_refcnt})").format(self=self) if __name__ == '__main__': #    42 int42 = IntStruct.from_address(id(42)) print(int42) int_minus_2 = IntStruct.from_address(id(-2)) print(int_minus_2) # ob_digit=2, ob_size=-1 #       int42.ob_digit = 4 print(4 == 42) # True print(1 + 41) # 4</span></span></code> </pre><br>  Honest PyLongObject ist in dieser Liste gespeichert, dh sie haben einen Referenzzähler. Sie können beispielsweise herausfinden, wie viele Nullen Ihr Skript und der Interpreter verwenden. <br><br>  Aus der internen Implementierung von Ganzzahlen folgt, dass die Arithmetik in cpython nicht schnell sein kann, wenn andere Sprachen nacheinander über das Array iterieren, Zahlen in Register lesen und mehrere Prozessoranweisungen direkt aufrufen. Cpython wird im gesamten Speicher markiert und führt ziemlich komplizierte Methoden aus.  Im einfachsten Fall von Einzelbit-Ganzzahlen, bei denen es ausreichen würde, einen Befehl aufzurufen, muss der Interpreter die Größen vergleichen, dann ein Objekt im dynamischen Speicher erstellen, die Servicefelder ausfüllen und einen Zeiger darauf zurückgeben. Außerdem erfordern diese Aktionen eine GIL-Sperre.  Jetzt verstehen Sie, warum die Numpy-Bibliothek entstanden ist und warum sie so beliebt ist. <br><br>  Ich möchte den Artikel über den gesamten Typ in cpython plötzlich mit Informationen über den Booleschen Typ beenden. <br><br>  Tatsache ist, dass es in Python lange Zeit keinen separaten Typ für boolesche Variablen gab. Alle logischen Funktionen gaben 0 und 1 zurück. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Sie beschlossen jedoch, einen</a> neuen Typ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einzuführen</a> .  Gleichzeitig wurde es als untergeordneter Typ für das Ganze implementiert. <br><br><pre> <code class="cpp hljs">PyTypeObject PyBool_Type = { PyVarObject_HEAD_INIT(&amp;PyType_Type, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-comment"><span class="hljs-comment">//       // ,       //     ob_size "bool", //   sizeof(struct _longobject), //    ... &amp;PyLong_Type, //   ... bool_new, //  };</span></span></code> </pre><br>  Darüber hinaus ist jeder der Werte des Booleschen Typs ein Singleton, eine Boolesche Variable ist ein Zeiger auf eine Instanz von True oder False (None wird auf ähnliche Weise implementiert). <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">longobject</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Py_FalseStruct</span></span></span><span class="hljs-class"> = {</span></span> PyVarObject_HEAD_INIT(&amp;PyBool_Type, <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-number"><span class="hljs-number">0</span></span> } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">longobject</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Py_TrueStruct</span></span></span><span class="hljs-class"> = {</span></span> PyVarObject_HEAD_INIT(&amp;PyBool_Type, <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-number"><span class="hljs-number">1</span></span> } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> PyObject * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bool_new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PyTypeObject *type, PyObject *args, PyObject *kwds)</span></span></span><span class="hljs-function"> </span></span>{ PyObject *x = Py_False; <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> ok; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_PyArg_NoKeywords(<span class="hljs-string"><span class="hljs-string">"bool"</span></span>, kwds)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!PyArg_UnpackTuple(args, <span class="hljs-string"><span class="hljs-string">"bool"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, &amp;x)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; ok = PyObject_IsTrue(x); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ok &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PyBool_FromLong(ok); } <span class="hljs-function"><span class="hljs-function">PyObject *</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PyBool_FromLong</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ok)</span></span></span><span class="hljs-function"> </span></span>{ PyObject *result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ok) result = Py_True; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> result = Py_False; Py_INCREF(result); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre><br>  PyObject_IsTrue (x) ist ein kniffliger Mechanismus zur Berechnung eines Booleschen Werts. Sie können ihn im Abschnitt über die Bool-Funktion oder in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Dokumentation sehen</a> . <br><br>  Ein solches Erbe führt zu einigen lustigen Effekten, wie der exakten Gleichheit von True und 1, der Unfähigkeit, True und 1 als Schlüssel im Wörterbuch und in der Menge zu haben, und der Zulässigkeit von arithmetischen Operationen für den Booleschen Typ: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">&gt;&gt;&gt; </span></span><span class="hljs-keyword"><span class="hljs-keyword">True</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &gt;&gt;&gt; {<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-string"><span class="hljs-string">"true"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-string"><span class="hljs-string">"one"</span></span>} {<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: <span class="hljs-string"><span class="hljs-string">'one'</span></span>} &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> * <span class="hljs-number"><span class="hljs-number">2</span></span> + <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> / (<span class="hljs-number"><span class="hljs-number">5</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) - (<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-number"><span class="hljs-number">-6.0</span></span> &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre><br>  Die Python-Sprache ist großartig für ihre Flexibilität und Lesbarkeit. Es muss jedoch berücksichtigt werden, dass all dies einen Preis hat, zum Beispiel in Form von überflüssigen Abstraktionen und Overhead, über die wir oft nicht nachdenken oder raten.  Ich hoffe, dieser Artikel hat es Ihnen ermöglicht, den „Nebel des Krieges“ ein wenig über den Quellcode des Dolmetschers zu zerstreuen und Sie vielleicht sogar dazu zu bewegen, ihn zu studieren.  Der Interpreter-Code ist sehr einfach zu lesen, fast wie der Code auf Python selbst, und seine Studie ermöglicht es Ihnen, nicht nur zu lernen, wie der Interpreter implementiert ist, sondern auch interessante Algorithmus- und Systemlösungen, sowie möglicherweise effizienteren Code zu schreiben oder Entwickler von cpython selbst zu werden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de455114/">https://habr.com/ru/post/de455114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de455100/index.html">Wie man Kaffee im Büro organisiert</a></li>
<li><a href="../de455102/index.html">Serielle Schnittstellen über IP verbinden</a></li>
<li><a href="../de455106/index.html">Softwareentwicklung. 2019 Trends</a></li>
<li><a href="../de455110/index.html">Hängt die Zufriedenheit der Mitarbeiter von interessanten Aufgaben ab? Erzählen Sie Badoo, SKB Kontur, Dodo Pizza, Staply und Alternativa Games</a></li>
<li><a href="../de455112/index.html">Bitrix24: "Schnell angehoben gilt nicht als gefallen"</a></li>
<li><a href="../de455120/index.html">Wi-Fi ist nicht jedermanns Sache. Wie kann man Ausländer im Netzwerk gesetzlich autorisieren?</a></li>
<li><a href="../de455122/index.html">Schnellere Java-Reflexionsalternative</a></li>
<li><a href="../de455126/index.html">Intelligente Kleidung der Zukunft: Gibt es Potenzial?</a></li>
<li><a href="../de455128/index.html">Wie wir Anzeigen moderieren</a></li>
<li><a href="../de455130/index.html">3 beliebte Tools zum Organisieren der kontinuierlichen Bereitstellung (Continuous Deployment)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>