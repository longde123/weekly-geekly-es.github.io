<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üê™ üèª üë®üèæ‚Äç‚öïÔ∏è Sandboxing aprimorado para scripts interessantes üí® üë©üèª‚Äçüéì üçë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="De um tradutor: ao desenvolver a Plataforma CUBA, colocamos nessa estrutura a capacidade de executar scripts personalizados para uma configura√ß√£o mais...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Sandboxing aprimorado para scripts interessantes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/haulmont/blog/445114/"><p><img src="https://habrastorage.org/webt/l7/d9/cg/l7d9cgoh4tjgptdfr68phnooab4.jpeg"></p><br><p>  <em>De um tradutor: ao desenvolver a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Plataforma CUBA,</a> colocamos nessa estrutura a capacidade de executar scripts personalizados para uma configura√ß√£o mais flex√≠vel da l√≥gica de neg√≥cios do aplicativo.</em>  <em>Se essa oportunidade √© boa ou ruim (e n√£o estamos falando apenas de CUBA) est√° sendo debatida h√° muito tempo, mas o fato de que o controle sobre a execu√ß√£o de scripts de usu√°rio √© necess√°rio n√£o levanta nenhuma d√∫vida.</em>  <em>Um dos recursos √∫teis do Groovy para gerenciar a execu√ß√£o de scripts personalizados √© apresentado nesta tradu√ß√£o de C√©dric Champeau.</em>  <em>Apesar de ele ter deixado recentemente a equipe de desenvolvimento do Groovy, a comunidade de programadores parece estar aproveitando seus trabalhos por um longo tempo.</em> </p><br><p>  Uma das maneiras mais usadas de usar o Groovy √© por meio de scripts, pois o Groovy facilita a execu√ß√£o din√¢mica de c√≥digo em tempo de execu√ß√£o.  Dependendo da aplica√ß√£o, os scripts podem estar localizados em locais diferentes: o sistema de arquivos, o banco de dados, os servi√ßos remotos ... mas o mais importante √© que o desenvolvedor do aplicativo que executa os scripts n√£o os escreve necessariamente.  Al√©m disso, os scripts podem funcionar em um ambiente limitado (mem√≥ria limitada, limite no n√∫mero de descritores de arquivo, tempo de execu√ß√£o ...), ou voc√™ pode impedir o usu√°rio de usar todos os recursos de idioma no script. </p><br><p>  <strong>Este post ir√° lhe dizer.</strong> </p><br><ul><li>  por que o groovy √© bom para escrever dsl interno </li><li>  quais s√£o seus recursos em termos de seguran√ßa do seu aplicativo </li><li>  como configurar a compila√ß√£o para melhorar o DSL </li><li> sobre o valor do <code>SecureASTCustomizer</code> </li><li>  sobre extens√µes de controle de tipo </li><li>  como usar extens√µes de controle de tipo para tornar o sandbox eficaz </li></ul><a name="habracut"></a><br><p>  Por exemplo, imagine o que voc√™ precisa fazer para que o usu√°rio possa calcular express√µes matem√°ticas.  Uma op√ß√£o de implementa√ß√£o √© incorporar uma DSL interna, criar um analisador e, finalmente, um int√©rprete para essas express√µes.  Para fazer isso, √© claro, voc√™ ter√° que trabalhar, mas se precisar aumentar a produtividade, por exemplo, gerando bytecode para express√µes em vez de calcul√°-las no int√©rprete ou usar o cache de classes geradas em tempo de execu√ß√£o, o Groovy √© uma √≥tima op√ß√£o. </p><br><p>  Existem muitas op√ß√µes descritas na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">documenta√ß√£o</a> , mas o exemplo mais simples √© apenas o uso da classe <code>Eval</code> : </p><br><p> <code>Example.java</code> </p> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = (Integer) Eval.me(<span class="hljs-string"><span class="hljs-string">"1+1"</span></span>);</code> </pre> <br><p>  O c√≥digo <code>1+1</code> √© analisado, compilado no bytecode, carregado e executado pelo Groovy em tempo de execu√ß√£o.  Obviamente, o c√≥digo neste exemplo √© muito simples e voc√™ precisar√° adicionar par√¢metros, mas a id√©ia √© que o c√≥digo execut√°vel possa ser arbitr√°rio.  E isso pode n√£o ser exatamente o que voc√™ precisa.  Na calculadora, voc√™ precisa permitir algo como isto: </p><br><pre> <code class="plaintext hljs">1+1 x+y 1+(2*x)**y cos(alpha)*r v=1+x</code> </pre> <br><p>  mas certamente n√£o </p><br><pre> <code class="plaintext hljs">println 'Hello' (0..100).each { println 'Blah' } Pong p = new Pong() println(new File('/etc/passwd').text) System.exit(-1) Eval.me('System.exit(-1)') // a script within a script!</code> </pre> <br><p>  √â aqui que as dificuldades come√ßam, e tamb√©m fica claro que precisamos resolver v√°rios problemas: </p><br><ul><li>  limitar a gram√°tica de um idioma a um subconjunto de seus recursos </li><li>  impedir que os usu√°rios executem o c√≥digo que n√£o √© fornecido </li><li>  impedir a execu√ß√£o de c√≥digo malicioso </li></ul><br><p>  O exemplo da calculadora √© bastante simples, mas para DSLs mais complexas, as pessoas podem n√£o perceber que est√£o escrevendo c√≥digo problem√°tico, especialmente se o DSL √© t√£o simples que <em>nem os desenvolvedores</em> podem us√°- <em>lo</em> . </p><br><p>  Alguns anos atr√°s eu estava nessa situa√ß√£o.  Eu desenvolvi um mecanismo que executava "scripts" Groovy escritos por linguistas.  Um problema, por exemplo, era que eles poderiam criar inadvertidamente um loop infinito.  O c√≥digo foi executado no servidor e apareceu um encadeamento que consumia 100% da CPU, ap√≥s o qual foi necess√°rio reiniciar o servidor de aplicativos.  Eu tive que procurar uma maneira de resolver o problema sem afetar o DSL, as ferramentas ou o desempenho do aplicativo. </p><br><p>  De fato, muitas pessoas t√™m necessidades semelhantes.  Nos √∫ltimos 4 anos, conversei com muitas pessoas que tiveram a mesma pergunta: <em>como posso impedir que usu√°rios fa√ßam besteiras em scripts Groovy?</em> </p><br><h2 id="kastomayzery-kompilyacii">  Compiladores de personaliza√ß√£o </h2><br><p>  Naquela √©poca, eu j√° tinha minha pr√≥pria decis√£o e sabia que outras pessoas tamb√©m desenvolviam algo semelhante.  No final, Guillaume Laforge sugeriu que eu criasse um mecanismo no kernel do Groovy para ajudar a resolver esses problemas.  Ele apareceu no Groovy 1.8.0 como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">personalizadores de compila√ß√£o</a> . </p><br><p>  Os personalizadores de compila√ß√£o s√£o um conjunto de classes que modificam o processo de compila√ß√£o dos scripts do Groovy.  Voc√™ pode escrever seu pr√≥prio personalizador, mas o Groovy fornece: </p><br><ul><li>  personalizador de importa√ß√£o que adiciona implicitamente importa√ß√µes a scripts para que os usu√°rios n√£o precisem adicionar descri√ß√µes de importa√ß√£o </li><li>  transforma√ß√µes AST (Abstract Syntax Tree) do personalizador, permitindo adicionar transforma√ß√µes AST diretamente aos scripts </li><li>  Customizador AST seguro que restringe constru√ß√µes gramaticais e de sintaxe de um idioma </li></ul><br><p>  O personalizador de transforma√ß√µes AST me ajudou a resolver o problema de loop infinito com a transforma√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>@ThreadInterrupt</code></a> , mas o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SecureASTCustomizer</a> √© a coisa que provavelmente √© mais mal compreendida na grande maioria dos casos. </p><br><p>  Eu deveria me desculpar por isso.  Ent√£o n√£o consegui encontrar um nome melhor.  A parte mais importante no nome ‚ÄúSecureASTCustomizer‚Äù √© o <strong>AST</strong> .  O objetivo desse mecanismo era limitar o acesso a determinadas fun√ß√µes AST.  A palavra "seguro" no t√≠tulo √© geralmente sup√©rflua, e vou explicar o porqu√™.  Existe at√© um post de blog do famoso Kosuke Kawaguchi de Jenkins, intitulado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúFatal Groovy SecureASTCustomizer‚Äù</a> .  E tudo est√° escrito muito corretamente l√°.  O SecureASTCustomizer n√£o foi projetado para sandbox.  Foi criado para limitar o idioma no tempo de compila√ß√£o, mas n√£o na execu√ß√£o.  Agora acho que o melhor nome seria <em>GrammarCustomizer</em> .  Mas, como voc√™ certamente sabe, existem tr√™s dificuldades na ci√™ncia da computa√ß√£o: invalida√ß√£o de cache, inventar nomes e um erro por unidade. </p><br><p>  Agora imagine que voc√™ est√° considerando o personalizador AST seguro como um meio de garantir a seguran√ßa do seu script, e sua tarefa √© impedir que o usu√°rio <code>System.exit</code> no script.  A documenta√ß√£o diz que as chamadas podem ser barradas em receptores especiais criando listas negras ou brancas.  Se for necess√°ria seguran√ßa, eu sempre recomendo listas brancas que declarem estritamente o que √© permitido, mas n√£o listas negras que pro√≠bem qualquer coisa.  Porque os hackers sempre pensam no que voc√™ pode n√£o ter considerado.  Eu darei um exemplo </p><br><p>  Veja como configurar um mecanismo de script de sandbox primitivo usando o <code>SecureASTCustomizer</code> .  Embora eu possa escrev√™-los no Groovy, dou exemplos de configura√ß√£o do Java para tornar a diferen√ßa entre c√≥digo de integra√ß√£o e scripts mais expl√≠cita. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sandbox</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ CompilerConfiguration conf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerConfiguration(); SecureASTCustomizer customizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SecureASTCustomizer(); customizer.setReceiversBlackList(Arrays.asList(System.class.getName())); conf.addCompilationCustomizers(customizer); GroovyShell shell = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GroovyShell(conf); Object v = shell.evaluate(<span class="hljs-string"><span class="hljs-string">"System.exit(-1)"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"Result = "</span></span> +v); } }</code> </pre> <br><ol><li>  criar configura√ß√£o do compilador </li><li>  criar personalizador AST seguro </li><li>  declarar que a classe <code>System</code> como um receptor de chamadas de m√©todo est√° na lista negra </li><li>  adicionar personalizador √† configura√ß√£o do compilador </li><li>  vincule a configura√ß√£o ao script de shell, ou seja, tente criar uma sandbox </li><li>  execute o script "ruim" </li><li>  exibir o resultado da execu√ß√£o do script </li></ol><br><p>  Se voc√™ executar esta classe, ocorrer√° um erro durante a execu√ß√£o do script: </p><br><pre> <code class="plaintext hljs">General error during canonicalization: Method calls not allowed on [java.lang.System] java.lang.SecurityException: Method calls not allowed on [java.lang.System]</code> </pre> <br><p>  Esta conclus√£o √© emitida por um aplicativo com um personalizador AST seguro, que n√£o permite a execu√ß√£o de m√©todos da classe <code>System</code> .  Sucesso!  Portanto, protegemos nosso script!  Mas espere um minuto ... </p><br><h2 id="secureastcustomizer-vzloman">  O SecureASTCustomizer foi hackeado! </h2><br><p>  Prote√ß√£o, diz?  Mas e se eu fizer isso: </p><br><pre> <code class="java hljs">def c = System c.exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Se voc√™ executar o programa novamente, ver√° que ele falha <strong>sem</strong> erro e <strong>sem</strong> exibir o resultado na tela.  O c√≥digo de sa√≠da do processo √© -1, o que significa que o script do usu√°rio foi executado!  O que aconteceu  Em tempo de compila√ß√£o, o personalizador AST seguro n√£o consegue reconhecer que o <code>c.exit</code> √© uma chamada ao m√©todo <code>System</code> em princ√≠pio porque funciona no n√≠vel AST!  Ele analisa a chamada do m√©todo e, nesse caso, a chamada do m√©todo √© <code>c.exit(-1)</code> , depois determina o receptor e verifica se est√° na lista branca (ou preta).  Nesse caso, o receptor √© <code>c</code> , essa vari√°vel √© <strong>declarada via def</strong> e √© o mesmo que declarar como um <code>Object</code> , e o personalizador AST seguro pensar√° que o tipo da vari√°vel <code>c</code> √© <code>Object</code> , n√£o <code>System</code> ! </p><br><p>  Em geral, existem <strong>muitas</strong> maneiras de contornar as v√°rias configura√ß√µes criadas no personalizador AST seguro.  Aqui est√£o alguns legais: </p><br><pre> <code class="java hljs">((Object)System).exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) Class.forName(<span class="hljs-string"><span class="hljs-string">'java.lang.System'</span></span>).exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) (<span class="hljs-string"><span class="hljs-string">'java.lang.System'</span></span> as Class).exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> java.lang.System.<span class="hljs-function"><span class="hljs-function">exit </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">-1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span></code> </pre> <br><p>  e pode haver <strong>muito</strong> mais.  A natureza din√¢mica do Groovy exclui a capacidade de corrigir esses problemas em tempo de compila√ß√£o.  No entanto, existe uma solu√ß√£o.  Uma op√ß√£o √© confiar no gerenciador de seguran√ßa JVM padr√£o.  No entanto, essa √© uma solu√ß√£o pesada e volumosa imediatamente para todo o sistema, e isso √© equivalente a disparar um canh√£o contra pardais.  Al√©m disso, ele n√£o funciona em todos os casos, por exemplo, se voc√™ deseja proibir a leitura de arquivos, mas n√£o criar ... </p><br><p>  Essa limita√ß√£o - um pouco decepcionante para muitos de n√≥s - levou √† cria√ß√£o de uma solu√ß√£o baseada em <strong>verifica√ß√µes em tempo de execu√ß√£o</strong> .  Esse tipo de verifica√ß√£o n√£o tem esses problemas.  Por exemplo, porque voc√™ saber√° o tipo de receptor real da mensagem antes de iniciar a valida√ß√£o da chamada do m√©todo.  De particular interesse s√£o as seguintes implementa√ß√µes: </p><br><ul><li>  <a href="">SecureScript</a> por Jim White </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Groovy Sandbox</a> por Kosuke Kawaguchi </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Groovy Sandbox</a> por Simon Temple </li></ul><br><p>  No entanto, nenhuma dessas implementa√ß√µes √© totalmente confi√°vel e segura.  Por exemplo, a vers√£o do Kosuke √© baseada no hack da implementa√ß√£o interna do site de chamada em cache.  O problema √© que ele n√£o √© compat√≠vel com a vers√£o din√¢mica invocada do Groovy e essas classes internas n√£o estar√£o nas vers√µes futuras do Groovy.  A vers√£o de Simon, por outro lado, √© baseada em transforma√ß√µes AST, mas deixa muitos buracos em potencial. </p><br><p>  Como resultado, meus amigos Corinne Crisch, Fabrice Matrat e Sebastian Blanc, e eu decidimos criar um novo mecanismo de sandbox em tempo de execu√ß√£o, que n√£o ter√° problemas como esses projetos.  Come√ßamos a implement√°-lo em uma hackathon em Nice, e na confer√™ncia Greach no ano passado, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fizemos um relat√≥rio sobre isso</a> .  Esse mecanismo √© baseado em transforma√ß√µes AST e essencialmente reescreve o c√≥digo para verificar antes de cada chamada de m√©todo, tentar acessar o campo de classe, incrementar uma vari√°vel, express√£o bin√°ria ... Essa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">implementa√ß√£o</a> ainda n√£o est√° pronta e n√£o h√° muito trabalho feito, portanto como percebi que o problema com m√©todos e par√¢metros chamados atrav√©s de "isto impl√≠cito" ainda n√£o foi resolvido, como, por exemplo, em construtores: </p><br><pre> <code class="plaintext hljs">xml { cars { // cars is a method call on an implicit this: "this".cars(...) car(make:'Renault', model: 'Clio') } }</code> </pre> <br><p>  At√© o momento, ainda n√£o encontrei uma maneira de resolver esse problema devido √† arquitetura do protocolo de meta-objeto no Groovy, que se baseia no fato de que o receptor lan√ßa uma exce√ß√£o quando n√£o consegue encontrar o m√©todo antes de alternar para outro receptor.  Em resumo, isso significa que voc√™ n√£o pode descobrir o tipo de receptor antes da chamada do m√©todo real.  E se a liga√ß√£o j√° passou, √© tarde demais ... </p><br><p>  E at√© recentemente, eu n√£o tinha uma solu√ß√£o ideal para esse problema no caso em que o script execut√°vel usa as propriedades din√¢micas da linguagem.  Mas agora √© a hora de explicar como voc√™ pode melhorar significativamente a situa√ß√£o se estiver pronto para sacrificar um pouco do dinamismo da linguagem. </p><br><h2 id="proverka-tipov">  Verifica√ß√£o de tipo </h2><br><p>  Voltemos ao problema principal do SecureASTCustomizer: ele funciona com uma √°rvore de sintaxe abstrata e n√£o possui informa√ß√µes sobre tipos de mensagens e receptores espec√≠ficos.  Mas com o Groovy 2, o Groovy adicionou compila√ß√£o e, no Groovy 2.1, adicionamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">extens√µes para verifica√ß√£o de tipo</a> . </p><br><p>  Extens√µes para verifica√ß√£o de tipo s√£o uma coisa muito poderosa: permitem que o desenvolvedor do Groovy DSL ajude o compilador com a infer√™ncia de tipo e tamb√©m permita a gera√ß√£o de erros de compila√ß√£o nos casos em que geralmente n√£o ocorrem.  Essas extens√µes s√£o usadas internamente pelo Groovy para oferecer suporte a um compilador est√°tico, por exemplo, ao implementar caracter√≠sticas ou um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mecanismo de modelo de marca√ß√£o</a> . </p><br><p>  E se, em vez de usar os resultados do analisador, pud√©ssemos confiar nas informa√ß√µes do mecanismo de verifica√ß√£o de tipo?  Pegue o c√≥digo que nosso hacker tentou escrever: </p><br><p> <code>((Object)System).exit(-1)</code> </p> <br><p>  Se voc√™ ativar as verifica√ß√µes de tipo, o c√≥digo n√£o ser√° compilado: </p><br><pre> <code class="plaintext hljs">1 compilation error: [Static type checking] - Cannot find matching method java.lang.Object#exit(java.lang.Integer). Please check if the declared type is right and if the method exists.</code> </pre> <br><p>  Portanto, esse c√≥digo n√£o √© mais compilado.  E se pegarmos este c√≥digo: </p><br><pre> <code class="java hljs">def c = System c.exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Como voc√™ pode ver, ele passa na verifica√ß√£o de tipo, agrupada em um m√©todo e executada usando o comando <code>groovy</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@groovy</span></span>.transform.TypeChecked <span class="hljs-comment"><span class="hljs-comment">// or even @CompileStatic void foo() { def c = System c.exit(-1) } foo()</span></span></code> </pre> <br><p>  O verificador de tipos detecta que o m√©todo de <code>exit</code> √© chamado da classe <code>System</code> e √© v√°lido.  Isso n√£o vai nos ajudar aqui.  Mas o que sabemos √© que, se esse c√≥digo passa na verifica√ß√£o de tipo, significa que o compilador reconhece a chamada para o receptor com o tipo <code>System</code> .  Em geral, a id√©ia √© proibir uma chamada com um ramal para verifica√ß√£o de tipo. </p><br><h2 id="prostoe-rasshirenie-dlya-proverki-tipov">  Extens√£o simples para verifica√ß√£o de tipo </h2><br><p>  Antes de nos aprofundarmos no sandboxing em detalhes, vamos tentar "proteger" nosso script com a ajuda de uma extens√£o padr√£o para verifica√ß√£o de tipo.  √â f√°cil registrar essa extens√£o: basta definir o par√¢metro <code>extensions</code> para a anota√ß√£o <code>@TypeChecked</code> (ou <code>@CompileStatic</code> se voc√™ estiver usando compila√ß√£o est√°tica): </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@TypeChecked</span></span>(extensions=[<span class="hljs-string"><span class="hljs-string">'SecureExtension1.groovy'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ def c = System c.exit(-<span class="hljs-number"><span class="hljs-number">1</span></span>) } foo()</code> </pre> <br><p>  A pesquisa de extens√µes ocorrer√° no caminho de classe no formato de c√≥digo-fonte (voc√™ pode criar extens√µes pr√©-compiladas para verifica√ß√£o de tipo, mas n√£o as consideraremos neste artigo): </p><br><p> <code>SecureExtension1.groovy</code> </p> <br><pre> <code class="java hljs">onMethodSelection { expr, methodNode -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (methodNode.declaringClass.name==<span class="hljs-string"><span class="hljs-string">'java.lang.System'</span></span>) { addStaticTypeError(<span class="hljs-string"><span class="hljs-string">"Method call is not allowed!"</span></span>, expr) } }</code> </pre> <br><ol><li>  quando o tipo verificador seleciona um m√©todo para chamar </li><li>  se o m√©todo pertencer √† classe <code>System</code> </li><li>  ent√£o deixe o verificador de tipos gerar um erro </li></ol><br><p>  √â tudo o que voc√™ precisa.  Agora execute o c√≥digo novamente e voc√™ ver√° um erro de compila√ß√£o! </p><br><pre> <code class="plaintext hljs">/home/cchampeau/tmp/securetest.groovy: 6: [Static type checking] - Method call is not allowed! @ line 6, column 3. c.exit(-1) ^ 1 error</code> </pre> <br><p>  Desta vez, gra√ßas ao tipo verificador, <code>c</code> reconhecido como uma inst√¢ncia da classe <code>System</code> e podemos proibir a chamada.  Este √© um exemplo muito simples e n√£o demonstra tudo o que pode ser feito com o personalizador AST seguro em termos de configura√ß√£o.  Na extens√£o que <strong>escrevemos</strong> , as verifica√ß√µes s√£o <strong>codificadas</strong> , mas pode ser melhor torn√°-las personaliz√°veis.  Ent√£o, vamos tornar o exemplo mais complicado. </p><br><p>  Suponha que seu aplicativo calcule determinadas m√©tricas para um documento e permita que os usu√°rios as personalizem.  Nesse caso, DSL: </p><br><ul><li>  operar√° (pelo menos) a vari√°vel de <code>score</code> </li><li>  permite que os usu√°rios realizem opera√ß√µes matem√°ticas (incluindo chamar m√©todos <em>cos</em> , <em>abs</em> , ...) </li><li>  deve proibir todos os outros m√©todos </li></ul><br><p>  Exemplo de script do usu√°rio: </p><br><p> <code>abs(cos(1+score))</code> </p> <br><p>  Esse DSL √© f√°cil de configurar.  Esta √© uma variante do que definimos acima: </p><br><p> <code>Sandbox.java</code> </p> <br><pre> <code class="java hljs">CompilerConfiguration conf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerConfiguration(); ImportCustomizer customizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImportCustomizer(); customizer.addStaticStars(<span class="hljs-string"><span class="hljs-string">"java.lang.Math"</span></span>); conf.addCompilationCustomizers(customizer); Binding binding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding(); binding.setVariable(<span class="hljs-string"><span class="hljs-string">"score"</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>d); GroovyShell shell = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GroovyShell(binding,conf); Double userScore = (Double) shell.evaluate(<span class="hljs-string"><span class="hljs-string">"abs(cos(1+score))"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"userScore = "</span></span> + userScore);</code> </pre> <br><ol><li>  adicione personalizador de importa√ß√£o que adicionar√° <code>import static java.lang.Math.*</code> a todos os scripts </li><li>  disponibilizar vari√°vel de <code>score</code> para script </li><li>  executar script </li></ol><br><p>  <em>Existem maneiras de armazenar em cache scripts em vez de analis√°-los e compil√°-los sempre.</em>  <em>Veja a documenta√ß√£o para detalhes.</em> </p><br><p>  Portanto, nosso script funciona, mas nada impede o hacker de lan√ßar c√≥digo malicioso.  Como planejamos usar a verifica√ß√£o de tipo, eu recomendaria o uso da transforma√ß√£o <code>@CompileStatic</code> : </p><br><ul><li>  ativa a verifica√ß√£o de tipo no script, e poderemos realizar verifica√ß√µes adicionais gra√ßas √† extens√£o para verifica√ß√£o de tipo </li><li>  melhorar o desempenho do script </li></ul><br><p>  Adicionar <code>@CompileStatic</code> anota√ß√£o <code>@CompileStatic</code> aos seus scripts √© bastante simples.  Voc√™ s√≥ precisa atualizar a configura√ß√£o do compilador: </p><br><pre> <code class="java hljs">ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer(CompileStatic.class); conf.addCompilationCustomizers(astcz);</code> </pre> <br><p>  Agora, se voc√™ tentar executar o script novamente, ver√° um erro de compila√ß√£o: </p><br><pre> <code class="plaintext hljs">Script1.groovy: 1: [Static type checking] - The variable [score] is undeclared. @ line 1, column 11. abs(cos(1+score)) ^ Script1.groovy: 1: [Static type checking] - Cannot find matching method int#plus(java.lang.Object). Please check if the declared type is right and if the method exists. @ line 1, column 9. abs(cos(1+score)) ^ 2 errors</code> </pre> <br><p>  O que aconteceu  Se voc√™ ler o script do ponto de vista do compilador, fica claro que ele n√£o sabe nada sobre a vari√°vel "score".  Mas <strong>voc√™,</strong> como desenvolvedor, sabe que essa √© uma vari√°vel <code>double</code> , mas o compilador n√£o pode produzi-la.  Para isso, s√£o criadas extens√µes para verifica√ß√£o de tipo: voc√™ pode fornecer informa√ß√µes adicionais ao compilador e a compila√ß√£o funcionar√° bem.  Nesse caso, precisamos indicar que a vari√°vel <code>score</code> √© do tipo <code>double</code> . </p><br><p>  Portanto, voc√™ pode alterar um pouco a maneira <code>@CompileStatic</code> anota√ß√£o <code>@CompileStatic</code> √© <code>@CompileStatic</code> : </p><br><pre> <code class="java hljs">ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer( singletonMap(<span class="hljs-string"><span class="hljs-string">"extensions"</span></span>, singletonList(<span class="hljs-string"><span class="hljs-string">"SecureExtension2.groovy"</span></span>)), CompileStatic.class);</code> </pre> <br><p>  Isso "emula" o c√≥digo anotado por <code>@CompileStatic(extensions=['SecureExtension2.groovy'])</code> .  Agora, √© claro, precisamos escrever uma extens√£o que reconhe√ßa a vari√°vel <code>score</code> : </p><br><p> <code>SecureExtension2.groovy</code> </p> <br><pre> <code class="java hljs">unresolvedVariable { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name==<span class="hljs-string"><span class="hljs-string">'score'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> makeDynamic(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>, double_TYPE) } }</code> </pre> <br><ol><li>  caso o verificador de tipos n√£o possa determinar a vari√°vel </li><li>  se o nome da vari√°vel for <code>score</code> </li><li>  deixe o compilador definir a vari√°vel dinamicamente com o tipo <code>double</code> </li></ol><br><p>  Uma descri√ß√£o completa das extens√µes DSL para verifica√ß√£o de tipo pode ser encontrada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nesta se√ß√£o da documenta√ß√£o</a> , mas h√° um exemplo de um modo de compila√ß√£o combinado: o compilador n√£o pode definir uma vari√°vel de <code>score</code> .  Voc√™, como desenvolvedor de DSL, <strong>sabe</strong> que a vari√°vel √© realmente o seu tipo - <code>double</code> , ent√£o a chamada para <code>makeDynamic</code> aqui para dizer: "ok, n√£o se preocupe, eu sei o que estou fazendo, essa vari√°vel pode ser definida dinamicamente com o tipo <code>double</code> "  Isso √© tudo! </p><br><h2 id="pervoe-zavershennoe-secure-rasshirenie">  Primeira extens√£o "segura" conclu√≠da </h2><br><p>  Agora vamos juntar tudo.  Escrevemos uma extens√£o de verifica√ß√£o de tipo que impede chamadas para m√©todos da classe <code>System</code> por um lado, e outra que define a vari√°vel <code>score</code> , por outro.  Portanto, se os conectarmos, obteremos a primeira extens√£o completa para verifica√ß√£o de tipo: </p><br><p> <code>SecureExtension3.groovy</code> </p> <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// disallow calls on System onMethodSelection { expr, methodNode -&gt; if (methodNode.declaringClass.name=='java.lang.System') { addStaticTypeError("Method call is not allowed!", expr) } } // resolve the score variable unresolvedVariable { var -&gt; if (var.name=='score') { return makeDynamic(var, double_TYPE) } }</span></span></code> </pre> <br><p>  Lembre-se de atualizar a configura√ß√£o em sua classe Java para usar a nova extens√£o para verifica√ß√£o de tipo: </p><br><pre> <code class="java hljs">ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer( singletonMap(<span class="hljs-string"><span class="hljs-string">"extensions"</span></span>, singletonList(<span class="hljs-string"><span class="hljs-string">"SecureExtension3.groovy"</span></span>)), CompileStatic.class);</code> </pre> <br><p>  Execute o c√≥digo novamente - ele ainda funciona.  Agora tente o seguinte: </p><br><pre> <code class="plaintext hljs">abs(cos(1+score)) System.exit(-1)</code> </pre> <br><p>  A compila√ß√£o do script falhar√° com um erro: </p><br><pre> <code class="plaintext hljs">Script1.groovy: 1: [Static type checking] - Method call is not allowed! @ line 1, column 19. abs(cos(1+score));System.exit(-1) ^ 1 error</code> </pre> <br><p>  Parab√©ns, voc√™ acabou de escrever a primeira extens√£o de verifica√ß√£o de tipo que impede a execu√ß√£o de c√≥digos maliciosos! </p><br><h2 id="uluchshenie-konfiguracii-rasshireniya">  Configura√ß√£o de extens√£o aprimorada </h2><br><p>  Portanto, tudo est√° indo bem, podemos proibir chamadas para m√©todos da classe <code>System</code> , mas parece que novas vulnerabilidades ser√£o descobertas em breve e precisaremos impedir o lan√ßamento de c√≥digo malicioso.  Ent√£o, em vez de codificar tudo na extens√£o, tentaremos tornar nossa extens√£o universal e personaliz√°vel.  Provavelmente, √© o mais dif√≠cil, porque n√£o h√° maneira direta de passar o contexto para a extens√£o para verifica√ß√£o de tipo.  A ideia, portanto, √© baseada no uso de uma vari√°vel local de encadeamento (m√©todo de curva, sim) para passar dados de configura√ß√£o para digitar verificadores. </p><br><p>  Primeiro, tornaremos a lista de vari√°veis ‚Äã‚Äãpersonaliz√°vel.  √â assim que o c√≥digo Java ser√°: </p><br><p> <code>Sandbox.java</code> </p> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sandbox</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String VAR_TYPES = <span class="hljs-string"><span class="hljs-string">"sandboxing.variable.types"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; COMPILE_OPTIONS = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadLocal&lt;&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ CompilerConfiguration conf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerConfiguration(); ImportCustomizer customizer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImportCustomizer(); customizer.addStaticStars(<span class="hljs-string"><span class="hljs-string">"java.lang.Math"</span></span>); ASTTransformationCustomizer astcz = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ASTTransformationCustomizer( singletonMap(<span class="hljs-string"><span class="hljs-string">"extensions"</span></span>, singletonList(<span class="hljs-string"><span class="hljs-string">"SecureExtension4.groovy"</span></span>)), CompileStatic.class); conf.addCompilationCustomizers(astcz); conf.addCompilationCustomizers(customizer); Binding binding = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Binding(); binding.setVariable(<span class="hljs-string"><span class="hljs-string">"score"</span></span>, <span class="hljs-number"><span class="hljs-number">2.0</span></span>d); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Map&lt;String,ClassNode&gt; variableTypes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, ClassNode&gt;(); variableTypes.put(<span class="hljs-string"><span class="hljs-string">"score"</span></span>, ClassHelper.double_TYPE); Map&lt;String,Object&gt; options = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashMap&lt;String, Object&gt;(); options.put(VAR_TYPES, variableTypes); COMPILE_OPTIONS.set(options); GroovyShell shell = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GroovyShell(binding, conf); Double userScore = (Double) shell.evaluate(<span class="hljs-string"><span class="hljs-string">"abs(cos(1+score));System.exit(-1)"</span></span>); System.out.println(<span class="hljs-string"><span class="hljs-string">"userScore = "</span></span> + userScore); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { COMPILE_OPTIONS.remove(); } } }</code> </pre> <br><ol><li>  <code>ThreadLocal</code> ,          </li><li>    ‚Äî <code>SecureExtension4.groovy</code> </li><li> <code>variableTypes</code> ‚Äî   ‚Äú  ‚Üí  ‚Äù </li><li>      <code>score</code> </li><li> <code>options</code> ‚Äî     </li><li>   "variable types"     VAR_TYPES </li><li>     thread local </li><li> ,    ,     thread local </li></ol><br><p>          : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Sandbox.* def typesOfVariables = COMPILE_OPTIONS.get()[VAR_TYPES] unresolvedVariable { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> makeDynamic(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>, typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) } }</code> </pre> <br><ol><li>        thread local </li><li>      ,      , </li><li>   type checker       </li></ol><br><p>         thread local,    ,  type checker  . ,      <code>unresolvedVariable</code> ,    ,  ,    type checker,   .  ,     .   ! </p><br><p>           .        ,       . </p><br><h2 id="konfiguraciya-belogo-spiska-metodov">     </h2><br><p>    .   ,       .      ,         ,     . ,  <code>System.exit</code> ,   : </p><br><pre> <code class="plaintext hljs">java.lang.System#exit(int)</code> </pre> <br><p> ,     Java,    : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sandbox</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String WHITELIST_PATTERNS = <span class="hljs-string"><span class="hljs-string">"sandboxing.whitelist.patterns"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... public static void main(String[] args) { // ... try { Map&lt;String,ClassNode&gt; variableTypes = new HashMap&lt;String, ClassNode&gt;(); variableTypes.put("score", ClassHelper.double_TYPE); Map&lt;String,Object&gt; options = new HashMap&lt;String, Object&gt;(); List&lt;String&gt; patterns = new ArrayList&lt;String&gt;(); patterns.add("java\\.lang\\.Math#"); options.put(VAR_TYPES, variableTypes); options.put(WHITELIST_PATTERNS, patterns); COMPILE_OPTIONS.set(options); GroovyShell shell = new GroovyShell(binding, conf); Double userScore = (Double) shell.evaluate("abs(cos(1+score));System.exit(-1)"); System.out.println("userScore = " + userScore); } finally { COMPILE_OPTIONS.remove(); } } }</span></span></code> </pre> <br><ol><li>    </li><li>    <code>java.lang.Math</code>   </li><li>        </li></ol><br><p>       : </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.transform.CompileStatic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.MethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.Parameter <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.ExtensionMethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Sandbox.* <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prettyPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassNode node)</span></span></span><span class="hljs-function"> </span></span>{ node.isArray()?<span class="hljs-string"><span class="hljs-string">"${prettyPrint(node.componentType)}[]"</span></span>:node.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toMethodDescriptor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodNode node)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ExtensionMethodNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> toMethodDescriptor(node.extensionMethodNode) } def sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder() sb.append(node.declaringClass.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">"#"</span></span>) sb.append(node.name) sb.append(<span class="hljs-string"><span class="hljs-string">'('</span></span>) sb.append(node.parameters.collect { Parameter it -&gt; prettyPrint(it.originType) }.join(<span class="hljs-string"><span class="hljs-string">','</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">')'</span></span>) sb } def typesOfVariables = COMPILE_OPTIONS.get()[VAR_TYPES] def whiteList = COMPILE_OPTIONS.get()[WHITELIST_PATTERNS] onMethodSelection { expr, MethodNode methodNode -&gt; def descr = toMethodDescriptor(methodNode) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!whiteList.any { descr =~ it }) { addStaticTypeError(<span class="hljs-string"><span class="hljs-string">"You tried to call a method which is not allowed, what did you expect?: $descr"</span></span>, expr) } } unresolvedVariable { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> makeDynamic(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>, typesOfVariables[<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>.name]) } }</code> </pre> <br><ol><li>       <code>MethodNode</code> </li><li>     thread local </li><li>       </li><li>        ,   </li></ol><br><p>      ,    : </p><br><pre> <code class="plaintext hljs">Script1.groovy: 1: [Static type checking] - You tried to call a method which is not allowed, what did you expect?: java.lang.System#exit(int) @ line 1, column 19. abs(cos(1+score));System.exit(-1) ^ 1 error</code> </pre> <br><p> ,  !        ,   <strong>  </strong> , <strong>  </strong>  .    ,      !     ,       ,       . ,   (  <code>foo.text</code> ,     <code>foo.getText()</code> ). </p><br><h2 id="sobiraem-vse-vmeste">    </h2><br><p>     ,    type checker'    "property selection", ,   .      ,         ,  .         ,     ,       ‚Äî    .     . </p><br><p> <code>SandboxingTypeCheckingExtension.groovy</code> </p> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> groovy.transform.CompileStatic <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassCodeVisitorSupport <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassHelper <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.ClassNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.MethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.Parameter <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.ast.expr.PropertyExpression <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.control.SourceUnit <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.sc.StaticCompilationMetadataKeys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.ExtensionMethodNode <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.GroovyTypeCheckingExtensionSupport <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> org.codehaus.groovy.transform.stc.StaticTypeCheckingSupport <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Sandbox.* <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SandboxingTypeCheckingExtension</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GroovyTypeCheckingExtensionSupport</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TypeCheckingDSL</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prettyPrint</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassNode node)</span></span></span><span class="hljs-function"> </span></span>{ node.isArray()?<span class="hljs-string"><span class="hljs-string">"${prettyPrint(node.componentType)}[]"</span></span>:node.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) } <span class="hljs-meta"><span class="hljs-meta">@CompileStatic</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toMethodDescriptor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(MethodNode node)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (node <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> ExtensionMethodNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> toMethodDescriptor(node.extensionMethodNode) } def sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder() sb.append(node.declaringClass.toString(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">"#"</span></span>) sb.append(node.name) sb.append(<span class="hljs-string"><span class="hljs-string">'('</span></span>) sb.append(node.parameters.collect { Parameter it -&gt; prettyPrint(it.originType) }.join(<span class="hljs-string"><span class="hljs-string">','</span></span>)) sb.append(<span class="hljs-string"><span class="hljs-string">')'</span></span>) sb } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Fetch white list of regular expressions of authorized method calls def whiteList = COMPILE_OPTIONS.get()[WHITELIST_PATTERNS] def typesOfVariables = COMPILE_OPTIONS.get()[VAR_TYPES] onMethodSelection { expr, MethodNode methodNode -&gt; def descr = toMethodDescriptor(methodNode) if (!whiteList.any { descr =~ it }) { addStaticTypeError("You tried to call a method which is not allowed, what did you expect?: $descr", expr) } } unresolvedVariable { var -&gt; if (isDynamic(var) &amp;&amp; typesOfVariables[var.name]) { storeType(var, typesOfVariables[var.name]) handled = true } } // handling properties (like foo.text) is harder because the type checking extension // does not provide a specific hook for this. Harder, but not impossible! afterVisitMethod { methodNode -&gt; def visitor = new PropertyExpressionChecker(context.source, whiteList) visitor.visitMethod(methodNode) } } private class PropertyExpressionChecker extends ClassCodeVisitorSupport { private final SourceUnit unit private final List&lt;String&gt; whiteList PropertyExpressionChecker(final SourceUnit unit, final List&lt;String&gt; whiteList) { this.unit = unit this.whiteList = whiteList } @Override protected SourceUnit getSourceUnit() { unit } @Override void visitPropertyExpression(final PropertyExpression expression) { super.visitPropertyExpression(expression) ClassNode owner = expression.objectExpression.getNodeMetaData(StaticCompilationMetadataKeys.PROPERTY_OWNER) if (owner) { if (expression.spreadSafe &amp;&amp; StaticTypeCheckingSupport.implementsInterfaceOrIsSubclassOf(owner, classNodeFor(Collection))) { owner = typeCheckingVisitor.inferComponentType(owner, ClassHelper.int_TYPE) } def descr = "${prettyPrint(owner)}#${expression.propertyAsString}" if (!whiteList.any { descr =~ it }) { addStaticTypeError("Property is not allowed: $descr", expression) } } } } }```     sandbox',     assert' ,  ,     : ``Sandbox.java`` ```java public class Sandbox { public static final String WHITELIST_PATTERNS = "sandboxing.whitelist.patterns"; public static final String VAR_TYPES = "sandboxing.variable.types"; public static final ThreadLocal&lt;Map&lt;String, Object&gt;&gt; COMPILE_OPTIONS = new ThreadLocal&lt;Map&lt;String, Object&gt;&gt;(); public static void main(String[] args) { CompilerConfiguration conf = new CompilerConfiguration(); ImportCustomizer customizer = new ImportCustomizer(); customizer.addStaticStars("java.lang.Math"); ASTTransformationCustomizer astcz = new ASTTransformationCustomizer( singletonMap("extensions", singletonList("SandboxingTypeCheckingExtension.groovy")), CompileStatic.class); conf.addCompilationCustomizers(astcz); conf.addCompilationCustomizers(customizer); Binding binding = new Binding(); binding.setVariable("score", 2.0d); try { Map&lt;String, ClassNode&gt; variableTypes = new HashMap&lt;String, ClassNode&gt;(); variableTypes.put("score", ClassHelper.double_TYPE); Map&lt;String, Object&gt; options = new HashMap&lt;String, Object&gt;(); List&lt;String&gt; patterns = new ArrayList&lt;String&gt;(); // allow method calls on Math patterns.add("java\\.lang\\.Math#"); // allow constructors calls on File patterns.add("File#&lt;init&gt;"); // because we let the user call each/times/... patterns.add("org\\.codehaus\\.groovy\\.runtime\\.DefaultGroovyMethods"); options.put(VAR_TYPES, variableTypes); options.put(WHITELIST_PATTERNS, patterns); COMPILE_OPTIONS.set(options); GroovyShell shell = new GroovyShell(binding, conf); Object result; try { result = shell.evaluate("Eval.me('1')"); // error assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("System.exit(-1)"); // error assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("((Object)Eval).me('1')"); // error assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("new File('/etc/passwd').getText()"); // getText is not allowed assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } try { result = shell.evaluate("new File('/etc/passwd').text"); // getText is not allowed assert false; } catch (MultipleCompilationErrorsException e) { System.out.println("Successful sandboxing: "+e.getMessage()); } Double userScore = (Double) shell.evaluate("abs(cos(1+score))"); System.out.println("userScore = " + userScore); } finally { COMPILE_OPTIONS.remove(); } } }</span></span></code> </pre> <br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>      Groovy       JVM.        ,      . ,    ,    ,      .  ,    Groovy,      sandboxing'          (,       ,   ). </p><br><p>  ,            ,          .      ,            .  ,      ,        . </p><br><p>    ,   sandboxing',   , ‚Äî  <strong></strong>  <code>SecureASTCustomizer</code> .    <strong> ,  </strong> ,       : secure AST customizer    ,      (,       ),              (   ,   ). </p><br><p> ,    : ,   , .   Groovy   .          Groovy,   ,  -      pull request,      -  ! <br></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt445114/">https://habr.com/ru/post/pt445114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt445104/index.html">Uma breve hist√≥ria da marca de √°udio Klipsch</a></li>
<li><a href="../pt445106/index.html">Mesa-redonda: Tecnologia aditiva como alternativa √† fabrica√ß√£o tradicional</a></li>
<li><a href="../pt445108/index.html">Nem um Falcon - projetos ESA e ULA reutiliz√°veis ‚Äã‚Äãfundamentalmente diferentes</a></li>
<li><a href="../pt445110/index.html">Um computador com uma unidade terminal do tipo Fallout</a></li>
<li><a href="../pt445112/index.html">Desvendando um emaranhado de vulnerabilidades em sites</a></li>
<li><a href="../pt445116/index.html">For√ßa A√©rea dos EUA est√° trabalhando em um drone de IA chamado Skyborg</a></li>
<li><a href="../pt445118/index.html">Em um bate-papo privado por telegrama, voc√™ pode excluir qualquer mensagem - at√© mesmo estranhos (um resultado da vota√ß√£o foi adicionado)</a></li>
<li><a href="../pt445120/index.html">Frontend Weekly Digest (18 a 24 de mar√ßo de 2019)</a></li>
<li><a href="../pt445122/index.html">O resumo de materiais frescos do mundo do front-end da √∫ltima semana n ¬∞ 357 (18 a 24 de mar√ßo de 2019)</a></li>
<li><a href="../pt445124/index.html">Prote√ß√£o moderada para Firefox</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>