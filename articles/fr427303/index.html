<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üåà üê¶ üñêüèæ Ralentissement de Windows, partie 2: cr√©ation de processus ‚õπüèæ üíà üéÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Windows a longtemps √©t√© bl√¢m√© pour la lenteur des op√©rations sur les fichiers et la cr√©ation de processus. Avez-vous d√©j√† essay√© de les ralentir encor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ralentissement de Windows, partie 2: cr√©ation de processus</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427303/"><img src="https://habrastorage.org/getpro/habr/post_images/b55/8f1/93c/b558f193cbc015bf35b2b068ff1c8e65.jpg"><br><br>  Windows a longtemps √©t√© bl√¢m√© pour la lenteur des op√©rations sur les fichiers et la cr√©ation de processus.  Avez-vous d√©j√† essay√© de les ralentir encore plus?  Cet article montrera la technique pour ralentir progressivement la cr√©ation de processus dans Windows (√† l'infini) de mani√®re invisible pour la plupart des utilisateurs! <br><br>  Et bien s√ªr, l'article vous expliquera √©galement comment d√©tecter et √©viter ce probl√®me. <br><br>  C'est un vrai probl√®me que j'ai rencontr√© au d√©but de l'ann√©e, et l'article explique comment je l'ai d√©couvert et trouv√© une solution de contournement.  Articles pr√©c√©dents sur le ralentissement de Windows: <br><br><ul><li>  Ralentir Windows, partie 0: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">d√©c√©l√©ration arbitraire de VirtualAlloc</a> </li><li>  Ralentir Windows, partie 1: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">acc√®s aux fichiers</a> </li></ul><a name="habracut"></a><br><h1>  Quelque chose ne va pas </h1><br>  Je ne cherche pas de probl√®mes, mais je pense que je les ai trouv√©s.  Peut-√™tre parce que je r√©cup√®re Chrome des sources des centaines de fois au cours du week-end, ou que je n'ai pas de chance dans la vie.  Je suppose que nous ne le saurons jamais.  D'une mani√®re ou d'une autre, cet article d√©crit le <i>cinqui√®me</i> probl√®me grave que j'ai rencontr√© dans Windows lors de la cr√©ation de Chrome. <br><br><ol><li>  S√©rialisation non planifi√©e, ce qui conduit √† une interface utilisateur de blocage compl√®te: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"Processeur 24 c≈ìurs, mais je ne peux pas d√©placer le curseur</a> . <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">"</a> </li><li>  Une fuite de descripteur de processus dans l'un des modules compl√©mentaires de Microsoft pour Windows: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Les processus zombies mangent votre m√©moire¬ª</a> . </li><li>  Une erreur de correction de longue date dans le cache de fichiers Windows: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Erreur du compilateur?</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Erreur de l'√©diteur de liens?</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bogue du noyau Windows. "</a> </li><li>  √âchec des performances lors de l'utilisation incorrecte des notifications de fichiers: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">¬´Ralentissement de Windows, partie 1: acc√®s aux fichiers¬ª</a> . </li><li>  Et ceci: une √©trange solution architecturale qui ralentit la cr√©ation de processus au fil du temps. </li></ol><br><h1>  Suivi des accidents rares </h1><br>  Les ordinateurs doivent √™tre fiables et pr√©visibles, et quelque chose d'autre m'ennuie.  Si je cr√©e Chrome plusieurs centaines de fois de suite, j'aimerais que chaque assemblage r√©ussisse.  Par cons√©quent, lorsque notre processus de compilation distribu√©e (gomacc.exe) se bloque parfois, je souhaite enqu√™ter sur cela.  J'ai configur√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">l'enregistrement automatique des vidages sur incident</a> , donc je vois que des plantages se produisent lorsqu'une corruption de tas est d√©tect√©e.  Un moyen simple de v√©rifier consiste √† activer le segment de page afin que le segment de m√©moire Windows place chaque allocation de m√©moire sur une page distincte.  Cela signifie que l'utilisation apr√®s lib√©ration et les d√©bordements de tampon provoquent une d√©faillance instantan√©e au lieu de dommages difficiles √† diagnostiquer.  J'ai d√©j√† √©crit sur l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">activation de pageheap en utilisant App Verifier</a> . <br><br>  App Verifier ralentit le programme pour deux raisons: les allocations de m√©moire sont ralenties et les allocations align√©es sur les pages d√©sactivent pratiquement le cache du processeur.  Ainsi, un l√©ger ralentissement de l'assemblage √©tait pr√©visible, et c'est arriv√©. <br><br>  Mais quand je suis arriv√© plus tard, l'assembl√©e a sembl√© s'arr√™ter compl√®tement.  Apr√®s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">environ 7 000 √©tapes d'assemblage</a> , aucun progr√®s n'a √©t√© observ√©. <br><br><h1>  O (n ^ 2) n'est g√©n√©ralement pas bon </h1><br>  Il s'av√®re que Application Verifier aime cr√©er des fichiers journaux.  Et peu importe que personne ne regarde ces fichiers, il les cr√©e au cas o√π.  Et ces fichiers doivent avoir des noms uniques.  Je suis s√ªr que cela semblait √™tre une bonne id√©e de simplement donner aux journaux des noms num√©riques dans l'ordre croissant, tels que gomacc.exe.0.dat, gomacc.exe.1.dat, etc. <br><br>  Pour obtenir des noms num√©riques dans l'ordre croissant, vous devez d√©terminer le num√©ro √† utiliser ensuite.  Le moyen le plus simple consiste <i>√† essayer</i> les noms / num√©ros possibles jusqu'√† ce que vous en trouviez un qui n'a pas encore √©t√© utilis√©.  Autrement dit, essayez de cr√©er un nouveau fichier appel√© gomacc.exe.0.dat, et s'il existe d√©j√†, essayez gomacc.exe.1.dat et ainsi de suite. <br><br>  Qu'est-ce qui pourrait mal tourner? <br><br><h1>  En fait, dans le pire des cas, tout est plut√¥t mauvais </h1><br>  Il s'av√®re que si vous effectuez une recherche lin√©aire d'un nom de fichier inutilis√© lors de la cr√©ation d'un processus, le d√©marrage de N processus n√©cessite <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">O (N ^ 2)</a> op√©rations.  Le bon sens veut que les algorithmes O (N ^ 2) soient trop lents si vous ne pouvez pas garantir que N reste toujours relativement petit. <br><br>  La gravit√© de la situation d√©pend du temps qu'il faut pour v√©rifier l'existence du fichier.  J'ai pris des mesures et constat√© que sur Windows, cela prend environ 80 microsecondes (80 Œºs ou 0,08 ms).  Le d√©marrage du premier processus est rapide, mais le d√©marrage du 1000e processus n√©cessite l'analyse de 1000 fichiers journaux d√©j√† cr√©√©s.  Cela prend 80 ms, puis plus. <br><br>  Une version typique de Chrome n√©cessite que le compilateur s'ex√©cute environ 30 000 fois.  Chaque ex√©cution du compilateur n√©cessite l'analyse de N fichiers journaux cr√©√©s pr√©c√©demment, 0,08 ms pour v√©rifier chaque fichier.  Une recherche lin√©aire du prochain nom de fichier journal disponible signifie que l'ex√©cution de N processus n√©cessite (N ^ 2) / 2 v√©rifie l'existence du fichier, c'est-√†-dire 30000 * 30000/2, soit 450 millions.  √âtant donn√© que chaque v√©rification de l'existence d'un fichier prend 0,08 ms, cela repr√©sente 36 millions de millisecondes, soit 36 ‚Äã‚Äã000 secondes.  Autrement dit, le temps de construction de Chrome, qui est g√©n√©ralement de cinq √† dix minutes, augmentera de dix heures suppl√©mentaires. <br><br>  Merde. <br><br>  En √©crivant cet article, j'ai reproduit l'erreur en ex√©cutant un fichier ex√©cutable vide environ 7000 fois - et j'ai vu une courbe O (n ^ 2) claire comme ceci: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/284/66c/102/28466c1029f0ee82d675bd6547f40811.png"><br><br>  Curieusement, si nous prenons la trace ETW et regardons le temps d'appel moyen √† CreateFile, alors pour presque tous les fichiers, le r√©sultat est inf√©rieur √† cinq microsecondes (une moyenne de 4,386 Œºs dans l'exemple ci-dessous): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac8/5f7/4d4/ac85f74d465251bed5287d2534cd397e.png"><br><br>  Il semble que cela montre uniquement la restriction ETW sur le suivi des E / S de fichiers.  Les √©v√©nements d'E / S de fichiers suivent uniquement le niveau le plus bas du syst√®me de fichiers, et au-dessus de Ntfs.sys, il existe de nombreux autres niveaux, notamment FLTMGR.SYS et ntoskrnl.exe.  Cependant, le ralentissement ne peut pas √™tre compl√®tement masqu√© - l'utilisation du processeur est visible sur le graphique d'utilisation du processeur.  La capture d'√©cran ci-dessous montre l'intervalle de temps de 548 ms, ce qui repr√©sente la cr√©ation d'un seul processus.  Fondamentalement, tout le temps qu'il faut pour analyser environ 6850 noms de fichiers journaux possibles: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a6/5e7/2d4/7a65e72d48e0527911fc9c1171212a1e.png"><br><br><h1>  Un disque plus productif sera-t-il utile? </h1><br>  Non. <br><br>  La quantit√© de donn√©es trait√©es est faible et la quantit√© d'√©criture sur le disque est encore moindre.  Lors de mes tests pour reproduire un bug, le disque √©tait presque compl√®tement inactif.  Ce probl√®me est li√© au processeur car toutes les donn√©es de disque pertinentes sont mises en cache.  Et m√™me si les frais g√©n√©raux √©taient r√©duits d'un ordre de grandeur, ils seraient encore trop importants.  Vous ne pouvez pas am√©liorer l'algorithme O (N ^ 2). <br><br><h1>  D√©couverte </h1><br>  Ce probl√®me particulier peut √™tre d√©tect√© en recherchant% userprofile% \ appverifierlogs pour les fichiers .dat.  En <i>g√©n√©ral,</i> vous pouvez d√©tecter un ralentissement de la cr√©ation de processus en examinant la trace ETW, et vous savez maintenant quoi rechercher. <br><br><h1>  Solution </h1><br>  La solution la plus simple consiste √† d√©sactiver la journalisation.  Cela arr√™tera √©galement de remplir le disque avec des gigaoctets de journaux.  Il est d√©sactiv√© par la commande suivante: <br><br> <code>appverif.exe -logtofile disable</code> <br> <br>  Apr√®s avoir d√©sactiv√© la journalisation, j'ai constat√© que mes processus ont d√©marr√© environ trois fois plus vite (!) Qu'au d√©but du test, et le ralentissement a compl√®tement disparu.  7000 processus Application Verifier surveill√©s sont cr√©√©s en 1,5 minute et non 40 minutes.  Avec mon simple fichier batch pour les tests et un processus simple, je vois les vitesses de cr√©ation de processus suivantes: <br><br><ul><li>  g√©n√©ralement 200 par seconde (5 ms par processus) </li><li>  75 par seconde avec Application Verifier activ√© mais la journalisation d√©sactiv√©e (13 ms par processus) </li><li>  40 par seconde avec Application Verifier activ√© et la journalisation activ√©e, dans un premier temps ... (25 ms par processus, le temps augmente progressivement √† l'infini) </li><li>  0,4 par seconde apr√®s une version de Chrome </li></ul><br>  Microsoft peut r√©soudre ce probl√®me en abandonnant l'augmentation monotone du nombre de fichiers journaux.  S'ils utilisaient la date et l'heure actuelles comme nom de fichier (jusqu'√† une milliseconde ou en r√©solution sup√©rieure), ils obtiendraient des noms plus s√©mantiquement significatifs de journaux cr√©√©s tr√®s rapidement sans pratiquement aucune logique de recherche pour un fichier unique. <br><br>  Mais Application Verifier n'est plus pris en charge et les fichiers journaux sont de toute fa√ßon inutiles, il suffit donc de les d√©sactiver. <br><br><h1>  Informations compl√©mentaires </h1><br>  Des fichiers batch et un script pour recr√©er le bogue apr√®s avoir activ√© Application Verifier pour empty.exe se trouvent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  La trace ETW vers la fin de l'exp√©rience est <a href="">ici</a> . <br><br>  Autres liens: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Donn√©es de synchronisation brutes utilis√©es pour cr√©er un graphique.</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Discussion sur Reddit</a> <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Discussion chez Hacker News</a> <br><br>  Pour des exemples d'autres algorithmes O (n ^ 2) qui colportent, voir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Accidentally Quadratic</a> <br><br>  Pour un plaisir plus banal, voir une compilation vid√©o de mes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">19 fa√ßons diff√©rentes de me rendre au travail en septembre</a> - j'√©tais trop occup√© pour continuer l'exp√©rience ce mois-ci. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr427303/">https://habr.com/ru/post/fr427303/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr427293/index.html">Mod√®les de conception JavaScript</a></li>
<li><a href="../fr427295/index.html">Fonctions de currying JavaScript</a></li>
<li><a href="../fr427297/index.html">Apache Ignite + Apache Spark Data Frames: ensemble plus de plaisir</a></li>
<li><a href="../fr427299/index.html">Allons chercher autre chose √† collectionner? Constructeur 3 en 1 "Flotte Lunaire"</a></li>
<li><a href="../fr427301/index.html">Base de donn√©es crash de GitHub</a></li>
<li><a href="../fr427307/index.html">Pratique de test du backend Java + Rest-Assured</a></li>
<li><a href="../fr427309/index.html">Comment PVS-Studio s'est av√©r√© plus attentif que trois programmeurs et demi</a></li>
<li><a href="../fr427311/index.html">Comment devenir un centre de donn√©es si vous avez plus de 40 ans et que vous n'√™tes pas programmeur</a></li>
<li><a href="../fr427313/index.html">Comment SoftBank investit 50 milliards de dollars par an dans les startups et pourquoi cela d√©concerte les investisseurs</a></li>
<li><a href="../fr427315/index.html">Salle de lecture Izba ou une s√©lection de litt√©rature professionnelle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>