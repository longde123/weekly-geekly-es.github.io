<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐱 🏾 ✍️ De minuscules images Docker qui croyaient en elles-mêmes * 🏙️ 🔝 ✍🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[référence au conte de fées américain pour enfants "Le petit moteur qui pourrait" - env. par.] * 





 Comment créer automatiquement de minuscules im...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>De minuscules images Docker qui croyaient en elles-mêmes *</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/469947/"><p>  [référence au conte de fées américain pour enfants "Le petit moteur qui pourrait" - env.  par.] * </p><br><p><img src="https://habrastorage.org/webt/dh/gb/qd/dhgbqdfhxud0uidunstrjj2cj1e.jpeg"></p><br><p>  <strong>Comment créer automatiquement de minuscules images de docker pour vos besoins</strong> </p><br><h3 id="neobychnaya-oderzhimost">  Obsession inhabituelle </h3><br><p>  Depuis quelques mois, je suis obsédé par une obsession: combien puis-je réduire l'image Docker pour que l'application fonctionne? </p><br><p>  Je comprends que l'idée est étrange. </p><br><p>  Avant de plonger dans les détails et les désastres techniques, je voudrais expliquer pourquoi ce problème m'a tellement accroché et comment il vous concerne. </p><br><h3 id="pochemu-razmer-imeet-znachenie">  Pourquoi la taille est importante </h3><br><p>  En raccourcissant le contenu de l'image Docker, nous raccourcissons la liste des vulnérabilités.  De plus, nous rendons les images plus propres, car elles ne contiennent que ce dont vous avez besoin pour exécuter les applications. </p><a name="habracut"></a><br><p>  Il y a un autre petit avantage - les images se téléchargent un peu plus vite, mais, pour moi, ce n'est pas si important. </p><br><blockquote>  Remarque: si vous vous souciez de la taille, les looks alpins sont petits en eux-mêmes et vous conviendront probablement. </blockquote><br><h3 id="distroless-obrazy">  Images sans distraction </h3><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le projet Distroless</a> propose une sélection d'images de base "sans distraction"; elles ne contiennent pas les gestionnaires de packages, les shells ou autres utilitaires que vous avez l'habitude de voir sur la ligne de commande.  Par conséquent, l'utilisation de gestionnaires de packages comme <code>pip</code> et <code>apt</code> échouera: </p><br><pre> <code class="plaintext hljs">FROM gcr.io/distroless/python3 RUN pip3 install numpy</code> </pre> <br><p>  <em>Dockerfile utilisant une image sans distraction Python 3</em> </p><br><pre> <code class="plaintext hljs">Sending build context to Docker daemon 2.048kB Step 1/2 : FROM gcr.io/distroless/python3 ---&gt; 556d570d5c53 Step 2/2 : RUN pip3 install numpy ---&gt; Running in dbfe5623f125 /bin/sh: 1: pip3: not found</code> </pre> <br><p>  <em>Pas de pip dans l'image</em> </p><br><p>  En règle générale, ce problème est résolu par une génération en plusieurs étapes: </p><br><pre> <code class="plaintext hljs">FROM python:3 as builder RUN pip3 install numpy FROM gcr.io/distroless/python3 COPY --from=builder /usr/local/lib/python3.7/site-packages /usr/local/lib/python3.5/</code> </pre> <br><p>  <em>Assemblage en plusieurs étapes</em> </p><br><p>  Le résultat est une image de taille 130 Mo.  Pas si mal!  A titre de comparaison: l'image Python par défaut pèse 929 Mo et l'image «plus mince» ( <code>3,7-slim</code> ) - 179 Mo, l'image alpine ( <code>3,7-alpine</code> ) - 98,6 Mo, tandis que l'image sans distraction de base utilisée dans l'exemple est 50,9 Mo. </p><br><p>  Nous pouvons à juste titre souligner que dans l'exemple précédent, nous copions tout le répertoire <code>/usr/local/lib/python3.7/site-packages</code> , qui peut contenir des dépendances inutiles pour nous.  Bien qu'il soit clair que la différence de taille de toutes les images de base Python existantes varie. </p><br><blockquote>  Au moment d'écrire ces lignes, Google distroless ne prend pas en charge de nombreuses images: Java et Python sont encore au stade expérimental, et Python n'existe que pour 2.7 et 3.5. </blockquote><br><h3 id="krohotnye-obrazy">  De minuscules images </h3><br><p>  Revenons à mon obsession de créer de petites images. </p><br><p>  En fait, je voulais voir comment fonctionnent les images sans distraction.  Le projet sans distraction utilise l' <code>bazel</code> construction Google bazel.  Cependant, pour installer Bazel et écrire vos propres images, j'ai dû transpirer (et pour être tout à fait honnête, réinventer la roue est amusant et instructif).  Je voulais simplifier la création d'images réduites: l'acte de créer une image devait être extrêmement simple, <em>banal</em> .  Pour ne pas avoir de fichiers de configuration, une seule ligne dans la console: il <code>    &lt;&gt;</code> . </p><br><p>  Donc, si vous voulez créer vos propres images, sachez: il y a une telle image unique de docker, <code>scratch</code> .  Scratch est une image "vide", elle n'a pas de fichiers, bien qu'elle pèse par défaut - wow!  - 77 octets. </p><br><pre> <code class="plaintext hljs">FROM scratch</code> </pre> <br><p>  <em>Scratch image</em> </p><br><p>  L'idée d'une image de travail est que vous pouvez y copier toutes les dépendances à partir de la machine hôte et les utiliser à l'intérieur du Dockerfile (c'est comment les copier dans <code>apt</code> et installer à partir de zéro), ou plus tard, lorsque l'image Docker est matérialisée.  Cela vous permet de contrôler entièrement le contenu du conteneur Docker et, par conséquent, de contrôler complètement la taille de l'image. </p><br><p>  Et maintenant, nous devons en quelque sorte collecter ces dépendances.  Les outils existants comme <code>apt</code> vous permettent de télécharger des packages, mais ils sont liés à la machine actuelle et, au final, ne prennent pas en charge Windows ou MacOS. </p><br><p>  Et j'ai donc entrepris d'assembler mon propre outil, qui assemblerait automatiquement l'image de base de la plus petite taille possible et de manière à pouvoir lancer n'importe quelle application.  J'ai utilisé des paquets Ubuntu / Debian, fait une sélection (obtenir des paquets directement à partir des référentiels) et trouvé récursivement leurs dépendances.  Le programme devrait télécharger automatiquement la dernière version stable du package, minimisant les risques de sécurité. </p><br><p>  J'ai appelé l' <code>fetchy</code> , car il ... trouve et apporte ... ce dont vous avez besoin [ <em>de l'anglais.</em>  <em>"chercher", "apporter" - env.</em>  <em>trans.</em>  ].  L'outil fonctionne via l'interface de ligne de commande, mais offre en même temps une API. </p><br><p>  Afin de construire une image en utilisant <code>fetchy</code> (prenons une image Python cette fois), il vous suffit d'utiliser la CLI comme ceci: <code>fetchy dockerize python</code> .  On peut vous demander le système d'exploitation cible et le nom de code, car <code>fetchy</code> n'utilise pour l'instant que des packages basés sur Debian et Ubuntu. </p><br><p>  Vous pouvez maintenant choisir les dépendances qui ne sont pas du tout nécessaires (dans notre contexte) et les exclure.  Par exemple, Python dépend de Perl, bien qu'il fonctionne très bien sans Perl installé. </p><br><h3 id="rezultaty">  Résultats </h3><br><p>  L'image Python créée avec la <code>fetchy dockerize python3.5</code> ne pèse que 35 Mo (je suis plus que sûr qu'elle peut être encore plus facile à l'avenir).  Il s'avère qu'avec une image sans distraction, nous avons réussi à «raser» 15 Mo supplémentaires. </p><br><p>  Toutes les images actuellement collectées peuvent être consultées <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Le projet est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . </p><br><p>  Si vous n'avez pas assez de fonctions, créez simplement une application - je serai heureux de vous aider :) Encore plus, je travaille actuellement sur l'intégration d'autres gestionnaires de paquets dans fetchy, de sorte que le besoin de builds en plusieurs étapes n'est plus nécessaire. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr469947/">https://habr.com/ru/post/fr469947/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr469931/index.html">Qu'est-ce qu'un facteur de vitesse d'apprentissage et comment améliore-t-il les caractéristiques d'apprentissage en profondeur?</a></li>
<li><a href="../fr469935/index.html">Cours "Fondamentaux d'un travail efficace avec les technologies Wolfram": plus de 13 heures de cours vidéo, théorie et problèmes</a></li>
<li><a href="../fr469939/index.html">Routeur CNC domestique comme alternative à une imprimante 3D, quatrième partie. Concepts généraux de traitement</a></li>
<li><a href="../fr469941/index.html">Nématodes extrêmes du lac Mono: nagez dans l'arsenic et survivez</a></li>
<li><a href="../fr469945/index.html">Est-il important que les ordinateurs et les gens voient le monde différemment?</a></li>
<li><a href="../fr469949/index.html">Le jour de l'anniversaire de Yuri Knorozov: nous étudions les bases de l'écriture maya</a></li>
<li><a href="../fr469955/index.html">Custdev, services sophistiqués et art de la présentation: ce que nous avons enseigné aux participants de l'accélérateur VTB</a></li>
<li><a href="../fr469961/index.html">Rust chez Microsoft (ou la création de Security Daemon Azure IoT Edge)</a></li>
<li><a href="../fr469967/index.html">Structures de données pour le stockage des graphes: un examen de l'existant et deux "presque nouveaux"</a></li>
<li><a href="../fr469975/index.html">Chemin de Santiago avec ordinateur portable</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>