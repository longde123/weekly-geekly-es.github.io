<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßëüèº‚Äçü§ù‚Äçüßëüèª üí™üèΩ üßíüèø Mock-Server f√ºr die mobile Testautomatisierung üéûÔ∏è ü§æüèª üò∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="W√§hrend ich an dem neuesten Projekt arbeitete, musste ich eine mobile Anwendung testen, die auf der Ebene der Gesch√§ftslogik mit verschiedenen Dienste...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mock-Server f√ºr die mobile Testautomatisierung</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/maxilect/blog/430530/">  W√§hrend ich an dem neuesten Projekt arbeitete, musste ich eine mobile Anwendung testen, die auf der Ebene der Gesch√§ftslogik mit verschiedenen Diensten von Drittanbietern verbunden war.  Das Testen dieser Dienste war nicht Teil meiner Aufgabe, jedoch blockierten Probleme mit ihrer API die Arbeit der Anwendung selbst - die Tests fielen nicht aufgrund von Problemen im Inneren, sondern aufgrund der Inoperabilit√§t der API, noch bevor die Pr√ºfung auf die erforderliche Funktionalit√§t abgeschlossen wurde. <br><br>  Traditionell werden St√§nder verwendet, um solche Anwendungen zu testen.  Sie funktionieren jedoch nicht immer normal, was die Arbeit beeintr√§chtigt.  Als alternative L√∂sung habe ich Moki verwendet.  Ich m√∂chte heute √ºber diesen dornigen Weg sprechen. <br><br><img src="https://habrastorage.org/webt/kn/uf/vw/knufvwqxahfwy6zkqxrkgeirrga.jpeg" alt="Bild"><br><a name="habracut"></a><br>  Um den Code eines realen Projekts (unter NDA) nicht zu ber√ºhren, habe ich zur Klarheit der weiteren Diskussion einen einfachen REST-Client f√ºr Android erstellt, mit dem HTTP-Anforderungen (GET / POST) mit den von mir ben√∂tigten Parametern an eine bestimmte Adresse gesendet werden k√∂nnen.  Wir werden es testen. <br>  Client-Anwendungscode, Dispatcher und Tests k√∂nnen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">von GitLab heruntergeladen werden</a> . <br><br><h2>  Welche M√∂glichkeiten gibt es? </h2><br>  In meinem Fall gab es zwei Ans√§tze zum Rauchen: <br><br><ul><li>  Bereitstellen eines Mock-Servers in der Cloud oder auf einem Remotecomputer (wenn es sich um vertrauliche Entwicklungen handelt, die nicht in die Cloud √ºbertragen werden k√∂nnen); </li><li>  Starten Sie den Mock-Server lokal - direkt auf dem Telefon, auf dem die mobile Anwendung getestet wird. </li></ul><br>  Die erste Option unterscheidet sich nicht wesentlich vom Pr√ºfstand.  Es ist zwar m√∂glich, eine Workstation im Netzwerk f√ºr den Mock-Server zuzuweisen, diese muss jedoch wie jeder Teststand unterst√ºtzt werden.  Und hier ist es notwendig, auf die Hauptfallen dieses Ansatzes zu sto√üen.  Die Remote-Workstation ist gestorben, reagiert nicht mehr, etwas hat sich ge√§ndert - Sie m√ºssen √ºberwachen, die Konfiguration √§ndern, d. H.  Machen Sie es genauso wie mit der Unterst√ºtzung eines normalen Pr√ºfstands.  Wir k√∂nnen die Situation nicht f√ºr uns selbst korrigieren, und es wird sicherlich mehr Zeit in Anspruch nehmen als lokale Manipulationen.  Speziell in meinem Projekt war es daher bequemer, den Mock-Server lokal zu erh√∂hen. <br><br><h2>  Ausw√§hlen eines Mock-Servers </h2><br>  Es gibt viele verschiedene Werkzeuge.  Ich habe versucht, mit mehreren zu arbeiten, und bei fast allen bin ich auf bestimmte Probleme gesto√üen: <br><br><ul><li>  <b>Mock-Server</b> , <b>Wiremock</b> - zwei Mock-Server, die ich unter Android nicht normal ausf√ºhren konnte.  Da alle Experimente im Rahmen eines Live-Projekts stattfanden, war die Zeit f√ºr die Auswahl begrenzt.  Nachdem ich ein paar Tage mit ihnen gegraben hatte, gab ich es auf, es zu versuchen. </li><li>  <b>Restmock</b> ist ein Wrapper √ºber <b>okhttpmockwebserver</b> , auf den sp√§ter noch n√§her eingegangen wird.  Es sah gut aus, es begann, aber der Entwickler dieses Wrappers versteckte "unter der Haube" die M√∂glichkeit, die IP-Adresse und den Port des Mock-Servers festzulegen, und f√ºr mich war es entscheidend.  Restmock wurde an einem zuf√§lligen Port gestartet.  Beim St√∂bern im Code stellte ich fest, dass der Entwickler bei der Initialisierung des Servers eine Methode verwendete, mit der der Port zuf√§llig festgelegt wurde, wenn er bei der Eingabe nicht empfangen wurde.  Im Prinzip k√∂nnte man von dieser Methode erben, aber das Problem lag im privaten Konstruktor.  Infolgedessen lehnte ich die Verpackung ab. </li><li>  <b>Okhttpmockwebserver</b> - Nachdem ich verschiedene Tools ausprobiert hatte, hielt ich am Mock-Server an, der normalerweise zusammenkam und lokal auf dem Ger√§t gestartet wurde. </li></ul><br><h2>  Wir analysieren das Prinzip der Arbeit </h2><br>  Mit der aktuellen Version von okhttpmockwebserver k√∂nnen Sie verschiedene Arbeitsszenarien implementieren: <br><br><ul><li>  <b>Warteschlange der Antworten</b> .  Mock-Server-Antworten werden der FIFO-Warteschlange hinzugef√ºgt.  Es spielt keine Rolle, auf welche API und auf welchen Pfad ich zugreifen werde, der Mock-Server wirft abwechselnd Nachrichten in diese Warteschlange. </li><li> <b>Mit dem Dispatcher</b> k√∂nnen <b>Sie</b> Regeln erstellen, die bestimmen, welche Antwort gegeben werden soll.  Angenommen, eine Anfrage stammt von einer URL, die einen Pfad enth√§lt, z. B. / get-login /.  Auf diesem / get-login / mock-Server und gibt eine einzelne, vordefinierte Antwort. </li><li>  <b>Anforderungsverifizierer</b> .  Basierend auf dem vorherigen Szenario kann ich die Anforderungen √ºberpr√ºfen, die die Anwendung sendet (dass unter den gegebenen Bedingungen eine Anforderung mit bestimmten Parametern wirklich abl√§uft).  Die Antwort ist jedoch unwichtig, da sie von der Funktionsweise der API abh√§ngt.  Dieses Skript implementiert die Anforderungsverifizierung. </li></ul><br>  Betrachten Sie jedes der Szenarien genauer. <br><br><h3>  Antwortwarteschlange </h3><br>  Die einfachste Implementierung des Mock-Servers ist die Antwortwarteschlange.  Vor dem Test bestimme ich die Adresse und den Port, an dem der Mock-Server bereitgestellt werden soll, sowie die Tatsache, dass er nach dem Prinzip einer Nachrichtenwarteschlange - FIFO (first in first out) - funktioniert. <br><br>  F√ºhren Sie als N√§chstes den Mock-Server aus. <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Before</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-class">() </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>)) mockServer.start(ip, port) } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queueTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>) returnFromResponseActivity() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>) returnFromResponseActivity() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>) returnFromResponseActivity() } }</code> </pre> <br>  Tests werden mit dem Espresso-Framework geschrieben, mit dem Aktionen in mobilen Anwendungen ausgef√ºhrt werden k√∂nnen.  In diesem Beispiel w√§hle ich Anforderungstypen aus und sende sie nacheinander. <br>  Nach dem Starten des Tests gibt der Mock-Server Antworten gem√§√ü der vorgeschriebenen Warteschlange, und der Test besteht fehlerfrei. <br><br><h3>  Dispatcher-Implementierung </h3><br>  Ein Dispatcher ist eine Reihe von Regeln, nach denen ein Mock-Server arbeitet.  Der Einfachheit halber habe ich drei verschiedene Dispatcher erstellt: SimpleDispatcher, OtherParamsDispatcher und ListingDispatcher. <br><br><h4>  Simpledispatcher </h4><br>  Okhttpmockwebserver stellt die <code>Dispatcher()</code> -Klasse zur Implementierung des Dispatchers bereit.  Sie k√∂nnen davon erben, indem Sie die <code>dispatch</code> auf Ihre eigene Weise √ºberschreiben. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"GET"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) } }</code> </pre><br>  Die Logik in diesem Beispiel ist einfach: Wenn ein GET eintrifft, gebe ich eine Nachricht zur√ºck, dass dies eine GET-Anforderung ist.  Bei POST erhalte ich eine POST-Anforderungsnachricht.  In anderen Situationen gebe ich eine leere Anfrage zur√ºck. <br><br>  <code>SimpleDispatcher</code> erscheint im Test - ein Objekt der <code>SimpleDispatcher</code> Klasse, die ich oben beschrieben habe.  Wie im vorherigen Beispiel wird der Mock-Server gestartet. Nur dieses Mal wird nur eine Art Regel f√ºr die Arbeit mit diesem Mock-Server angegeben - derselbe Dispatcher. <br><br>  <code>SimpleDispatcher</code> mit <code>SimpleDispatcher</code> finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">im Repository</a> . <br><br><h4>  OtherParamsDispatcher </h4><br>  Durch √úberschreiben der <code>dispatch</code> kann ich mich von anderen Anforderungsparametern entfernen, um Antworten zu senden: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OtherParamsDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> when { request.path.contains(<span class="hljs-string"><span class="hljs-string">"?queryKey=value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request with query parameter queryKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request with body parameter bodyKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.headers.toString().contains(<span class="hljs-string"><span class="hljs-string">"header: value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was some request with header equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ Wrong response }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } } }</code> </pre><br>  In diesem Fall zeige ich verschiedene Optionen f√ºr die Bedingungen. <br><br>  Zun√§chst k√∂nnen Sie Parameter in der Adressleiste an die API √ºbergeben.  Daher kann ich eine Bedingung f√ºr den Eintrag eines beliebigen Bundles im Pfad <code>‚Äú?queryKey=value‚Äù</code> , z. B. <code>‚Äú?queryKey=value‚Äù</code> . <br>  Zweitens k√∂nnen Sie mit dieser Klasse in den Hauptteil der POST- oder PUT-Anforderungen eindringen.  Sie k√∂nnen beispielsweise <code>toString()</code> verwenden, indem Sie zuerst <code>toString()</code> ausf√ºhren.  In meinem Beispiel wird die Bedingung ausgel√∂st, wenn eine POST-Anforderung mit <code>‚ÄúbodyKey‚Äù:‚Äùvalue‚Äù</code> .  Ebenso kann ich den Anforderungsheader ( <code>header : value</code> ) validieren. <br><br>  F√ºr Testbeispiele empfehle ich, auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">das Repository zu</a> verweisen. <br><br><h4>  ListingDispatcher </h4><br>  Bei Bedarf k√∂nnen Sie eine komplexere Logik implementieren - ListingDispatcher.  Ebenso √ºberschreibe ich die <code>dispatch</code> .  Jetzt habe ich jedoch direkt in der Klasse den Standardsatz von <code>stubsList</code> ( <code>stubsList</code> ) - mok f√ºr verschiedene Gelegenheiten festgelegt. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stubsList: ArrayList&lt;RequestClass&gt; = defaultRequests() <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { stubsList.first { it.matcher(request.path, request.body.toString()) }.response() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: NoSuchElementException) { Log.e(<span class="hljs-string"><span class="hljs-string">"Unexisting request path ="</span></span>, request.path) MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">404</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultRequests</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: ArrayList&lt;RequestClass&gt; </span></span>{ val allStubs = ArrayList&lt;RequestClass&gt;() allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/get"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /get url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and body contains bodyParam:value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allStubs } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ stubsList.add(stub) } }</code> </pre><br>  Zu diesem <code>RequestClass</code> ich eine offene Klasse <code>RequestClass</code> , deren Felder standardm√§√üig leer sind.  F√ºr diese Klasse definiere ich eine <code>response</code> , die ein <code>MockResponse</code> Objekt erstellt (eine 200-Antwort oder einen anderen <code>responseText</code> zur√ºckgibt), und eine <code>matcher</code> Funktion, die <code>true</code> oder <code>false</code> zur√ºckgibt. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">open class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val path:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val query: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val body:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val responseText: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code: Int = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">200</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: MockResponse </span></span>= MockResponse() .setResponseCode(code) .setBody(responseText) <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(apiCall: String, apiBody: String)</span></span></span><span class="hljs-function">: Boolean </span></span>= apiCall.startsWith(path)&amp;&amp;apiCall.contains(query)&amp;&amp;apiBody.contains(body) }</code> </pre><br>  Infolgedessen kann ich komplexere Kombinationen von Bedingungen f√ºr Stubs erstellen.  Dieses Design erschien mir flexibler, obwohl das Prinzip im Kern sehr einfach ist. <br><br>  Vor allem aber hat mir bei diesem Ansatz gefallen, dass ich einige Stubs direkt unterwegs ersetzen kann, wenn bei einem Test etwas an der Antwort des Mock-Servers ge√§ndert werden muss.  Beim Testen gro√üer Projekte tritt dieses Problem h√§ufig auf, beispielsweise beim √úberpr√ºfen bestimmter Szenarien. <br>  Der Austausch kann wie folgt erfolgen: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) }</code> </pre><br>  Mit dieser Implementierung des Dispatchers bleiben die Tests einfach.  Ich <code>ListingDispatcher</code> auch den Mock-Server, w√§hle nur <code>ListingDispatcher</code> . <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcherTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dispatcher</span></span></span><span class="hljs-class"> </span></span>= ListingDispatcher() <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.setDispatcher(dispatcher) mockServer.start(ip, port) } . . . }</code> </pre><br>  Aus Versuchsgr√ºnden habe ich den Stub durch POST ersetzt: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postReplacedStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyParam"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) replacePostStub() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, params = params) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br>  <code>replacePostStub</code> Funktion <code>replacePostStub</code> von einem regul√§ren <code>dispatcher</code> und <code>replacePostStub</code> eine neue <code>response</code> . <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacePostStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.replaceMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br>  Im obigen Test √ºberpr√ºfe ich, ob der Stub ersetzt wurde. <br>  Dann habe ich einen neuen Stub hinzugef√ºgt, der nicht in der Standardeinstellung war. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNewStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ addSomeStub() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/some_specific_url"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSomeStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.addMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/some_specific_url"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br><h3>  Anforderungsverifizierer </h3><br>  Der letzte Fall - Request Verifier - sieht kein Snooping vor, sondern pr√ºft auf von der Anwendung gesendete Anfragen.  Dazu starte ich den Mock-Server einfach, indem ich den Dispatcher so implementiere, dass die Anwendung zumindest etwas zur√ºckgibt. <br>  Wenn Sie eine Anfrage von einem Test senden, wird diese an den Mock-Server gesendet.  Dadurch kann ich mit <code>takeRequest()</code> auf die Anforderungsparameter <code>takeRequest()</code> . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestVerifierTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyKey"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) val headers: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"header"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, headers = headers, params = params) val request = mockServer.takeRequest() assertEquals(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, request.method) assertEquals(<span class="hljs-string"><span class="hljs-string">"value"</span></span>, request.getHeader(<span class="hljs-string"><span class="hljs-string">"header"</span></span>)) assertTrue(request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>)) assertTrue(request.path.startsWith(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>)) }</code> </pre><br>  Oben habe ich den Test anhand eines einfachen Beispiels gezeigt.  Genau der gleiche Ansatz kann f√ºr komplexes JSON verwendet werden, einschlie√ülich zum √úberpr√ºfen der gesamten Struktur der Anforderung (Sie k√∂nnen auf JSON-Ebene vergleichen oder JSON in Objekte analysieren und die Gleichheit auf Objektebene √ºberpr√ºfen). <br><br><h2>  Zusammenfassung </h2><br>  Im Allgemeinen hat mir das Tool (okhttpmockwebserver) gefallen und ich verwende es f√ºr ein gro√ües Projekt.  Nat√ºrlich gibt es einige kleine Dinge, die ich √§ndern m√∂chte. <br>  Zum Beispiel gef√§llt mir nicht, dass Sie in den Konfigurationen Ihrer Anwendung auf die lokale Adresse (in unserem Beispiel localhost: 8080) klopfen m√ºssen.  Vielleicht kann ich immer noch einen Weg finden, alles so zu konfigurieren, dass der Mock-Server reagiert, wenn er versucht, eine Anfrage an eine beliebige Adresse zu senden. <br>  Au√üerdem kann ich Anforderungen nicht umleiten - wenn der Mock-Server eine Anforderung weiter sendet, wenn er keinen geeigneten Stub daf√ºr hat.  In diesem Mock-Server gibt es keinen solchen Ansatz.  Es kam jedoch noch nicht einmal zu ihrer Umsetzung, da das "Kampf" -Projekt derzeit keine solche Aufgabe hat. <br><br>  Artikelautor: Ruslan Abdulin <br><br>  PS Wir ver√∂ffentlichen unsere Artikel auf mehreren Websites der Runet.  Abonnieren Sie unsere Seiten auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">VK</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">FB</a> oder <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Telegramm-Kanal</a> , um mehr √ºber unsere Ver√∂ffentlichungen und andere Maxilect-Nachrichten zu erfahren. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de430530/">https://habr.com/ru/post/de430530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de430520/index.html">Einf√ºhrung in Spring Data MongoDB</a></li>
<li><a href="../de430522/index.html">Ben√∂tigen Sie eine Unternehmenskultur in der IT? Gest√§ndnis des Markenmanagers des Krasnodar-Studios Plarium</a></li>
<li><a href="../de430524/index.html">Neuronale Netzwerkarchitektur</a></li>
<li><a href="../de430526/index.html">Spielautomaten: Woher kamen sie in der UdSSR und wie sind sie angeordnet?</a></li>
<li><a href="../de430528/index.html">Programmieren mit PyUSB 1.0</a></li>
<li><a href="../de430532/index.html">Sicherheit in iOS-Apps</a></li>
<li><a href="../de430534/index.html">Erstellen einer Vorlage f√ºr Zabbix am Beispiel des DVR Trassir SDK</a></li>
<li><a href="../de430536/index.html">Entwerfen von Fensterfunktionen, die zu einer Einheit mit einem bestimmten √úberlappungsgrad zusammengefasst werden</a></li>
<li><a href="../de430538/index.html">Lesen Sie Scaladoc f√ºr ‚Äûoffensichtliche‚Äú Erfassungsmethoden? Oder warum Faulheit nicht immer gut ist</a></li>
<li><a href="../de430542/index.html">Offenes Webinar ‚ÄûInfrastruktur als Code‚Äú</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>