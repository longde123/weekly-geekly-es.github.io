<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÇ üè´ ü§Ωüèæ N'oubliez pas d'augmenter les chances de r√©ponse au client en utilisant une demande r√©p√©t√©e dans l'√©quilibrage L7 üìö ü¶É ‚úÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En utilisant nginx pour √©quilibrer le trafic HTTP au niveau L7, il est possible d'envoyer une demande client au serveur d'applications suivant si la c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>N'oubliez pas d'augmenter les chances de r√©ponse au client en utilisant une demande r√©p√©t√©e dans l'√©quilibrage L7</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458594/">  En utilisant nginx pour √©quilibrer le trafic HTTP au niveau L7, il est possible d'envoyer une demande client au serveur d'applications suivant si la cible ne renvoie pas de r√©ponse positive.  Un test du m√©canisme de v√©rification passive de l'√©tat de sant√© du serveur d'application a montr√© l'ambigu√Øt√© de la documentation et la sp√©cificit√© des algorithmes d'exclusion du serveur du pool de serveurs de production. <br><a name="habracut"></a><br><h2>  R√©sum√© de l'√©quilibrage du trafic HTTP </h2><br>  Il existe diff√©rentes mani√®res d'√©quilibrer le trafic HTTP.  Aux niveaux du mod√®le OSI, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">il existe des technologies d'√©quilibrage</a> au niveau du r√©seau, du transport et des applications.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Des combinaisons peuvent √™tre utilis√©es en</a> fonction de la taille de l'application. <br><br>  La technologie d'√©quilibrage du trafic donne des effets positifs dans l'application et sa maintenance.  En voici quelques uns.  Mise √† l'√©chelle horizontale de l'application, dans laquelle la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">charge est r√©partie sur plusieurs n≈ìuds</a> .  Planification de la mise hors service du serveur d'applications en supprimant le flux des demandes des clients.  Mise en ≈ìuvre de la strat√©gie de test A / B pour la fonctionnalit√© modifi√©e de l'application.  Am√©lioration de la tol√©rance aux pannes des applications en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">envoyant des demandes √† des serveurs d'applications qui fonctionnent bien</a> . <br><br>  La derni√®re fonction est impl√©ment√©e en deux modes.  En mode passif, l'√©quilibreur du trafic client √©value les r√©ponses du serveur d'applications cible et l'exclut du pool de serveurs de production sous certaines conditions.  En mode actif, l'√©quilibreur envoie p√©riodiquement de mani√®re ind√©pendante des requ√™tes au serveur d'applications √† un URI donn√© et, pour certains signes de r√©ponse, d√©cide de l'exclure du pool de serveurs de production.  Par la suite, l'√©quilibreur, sous certaines conditions, renvoie le serveur d'applications au pool de serveurs de production. <br><br><h2>  V√©rification passive du serveur d'applications et son exclusion du pool de serveurs de production </h2><br>  Examinons de plus pr√®s la v√©rification passive du serveur d'applications dans l'√©dition freeware de nginx / 1.17.0.  Les serveurs d'applications sont s√©lectionn√©s tour √† tour par l'algorithme Round Robin, leurs poids sont les m√™mes. <br><br>  Le diagramme en trois √©tapes montre une section de temps commen√ßant par l'envoi d'une demande client au serveur d'applications n ¬∞ 2.  Un indicateur lumineux caract√©rise les demandes / r√©ponses entre le client et l'√©quilibreur.  Indicateur sombre - demandes / r√©ponses entre nginx et les serveurs d'applications. <br><br><img src="https://habrastorage.org/webt/vg/dl/yl/vgdlylmjdofsxs-iktkfimfaqr8.gif"><br><br>  La troisi√®me √©tape du diagramme montre comment l‚Äô√©quilibreur redirige la demande du client vers le serveur d‚Äôapplications suivant, au cas o√π le serveur cible aurait donn√© une r√©ponse d‚Äôerreur ou n‚Äôaurait pas r√©pondu du tout. <br><br>  La liste des erreurs HTTP et TCP dans lesquelles le serveur utilise le serveur suivant est sp√©cifi√©e dans la directive <i>proxy_next_upstream</i> . <br><br>  Par d√©faut, nginx redirige uniquement les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">demandes avec des m√©thodes HTTP idempotentes</a> vers le serveur d'applications suivant. <br><br>  Qu'obtient le client?  D'une part, la possibilit√© de rediriger une demande vers le serveur d'applications suivant augmente les chances de fournir une r√©ponse satisfaisante au client lorsque le serveur cible tombe en panne.  D'un autre c√¥t√©, il est √©vident qu'un appel s√©quentiel d'abord vers le serveur cible, puis vers le suivant augmente le temps de r√©ponse total au client. <br><br>  Au final, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_">la r√©ponse du serveur d'applications est renvoy√©e au</a> client <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_">, o√π</a> <i>se termine le</i> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_">compteur de tentatives autoris√©es</a> <i>proxy_next_upstream_tries</i> . <br><br>  Lorsque vous utilisez la fonction de redirection vers le serveur de travail suivant, vous devez en outre harmoniser les d√©lais d'expiration sur les serveurs d'√©quilibrage et d'application.  La limite sup√©rieure du temps pour une demande de ¬´d√©placement¬ª entre les serveurs d'applications et l'√©quilibreur est le d√©lai d'expiration du client ou le temps d'attente sp√©cifi√© par l'entreprise.  Lors du calcul des d√©lais d'attente, il est √©galement n√©cessaire de prendre en compte la marge pour les √©v√©nements du r√©seau (retards / pertes lors de la livraison des paquets).  Si le client termine √† chaque fois la session par timeout pendant que l'√©quilibreur obtient une r√©ponse garantie, la bonne intention de fiabiliser l'application sera vaine. <br><br><img src="https://habrastorage.org/webt/th/wt/da/thwtdayvqkzx3tr6dvlbmou1a3q.jpeg"><br><br>  Le contr√¥le d'int√©grit√© passif des serveurs d'applications est contr√¥l√© par des directives, par exemple, avec les options suivantes pour leurs valeurs: <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> backend { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> app01:<span class="hljs-number"><span class="hljs-number">80</span></span> weight=<span class="hljs-number"><span class="hljs-number">1</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">5</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">100s</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> app02:<span class="hljs-number"><span class="hljs-number">80</span></span> weight=<span class="hljs-number"><span class="hljs-number">1</span></span> max_fails=<span class="hljs-number"><span class="hljs-number">5</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">100s</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://backend; <span class="hljs-attribute"><span class="hljs-attribute">proxy_next_upstream</span></span> timeout http_500; <span class="hljs-attribute"><span class="hljs-attribute">proxy_next_upstream_tries</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; ... } ... }</code> </pre> <br>  √Ä compter du 2 juillet <i>2019</i> , la documentation a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://nginx.org/ru/docs/http/ngx_">√©tabli</a> que le param√®tre <i>max_fails</i> d√©finit le nombre de tentatives infructueuses de travail avec le serveur qui devraient se produire dans le d√©lai sp√©cifi√© par le param√®tre <i>fail_timeout</i> . <br><br>  Le param√®tre <i>fail_timeout</i> d√©finit la dur√©e pendant laquelle le nombre sp√©cifi√© de tentatives infructueuses de travailler avec le serveur doit se produire pour que le serveur soit consid√©r√© comme indisponible;  et le temps pendant lequel le serveur sera consid√©r√© comme indisponible. <br><br>  Dans l'exemple donn√©, faisant partie du fichier de configuration, l'√©quilibreur est configur√© pour intercepter 5 appels ayant √©chou√© en 100 secondes. <br><br><h2>  Retour du serveur d'applications au pool de serveurs de production </h2><br>  Comme indiqu√© dans la documentation, l'√©quilibreur apr√®s <i>fail_timeout</i> ne peut pas consid√©rer le serveur comme √©tant inop√©rant.  Mais, malheureusement, la documentation n'√©tablit pas explicitement comment les performances du serveur sont √©valu√©es. <br><br>  Sans exp√©rience, on ne peut que supposer que le m√©canisme de v√©rification de l'√©tat est similaire √† celui d√©crit pr√©c√©demment. <br><br><h2>  Attentes et r√©alit√© </h2><br>  Dans la configuration pr√©sent√©e, le comportement suivant est attendu de l'√©quilibreur: <br><br><ol><li>  Jusqu'√† ce que l'√©quilibreur exclue le serveur d'applications n ¬∞ 2 du pool de serveurs de production, les demandes des clients lui seront envoy√©es. </li><li>  Les demandes renvoy√©es avec une erreur 500 du serveur d'applications n ¬∞ 2 seront transmises au serveur d'applications suivant et le client recevra des r√©ponses positives. </li><li>  D√®s que l'√©quilibreur re√ßoit 5 r√©ponses avec le code 500 dans les 100 secondes, il exclut le serveur d'applications n ¬∞ 2 du pool de serveurs de production.  Toutes les demandes suivant une fen√™tre de 100 secondes seront imm√©diatement envoy√©es aux serveurs d'applications restants sans d√©lai suppl√©mentaire. </li><li>  Apr√®s 100 secondes, l'√©quilibreur doit en quelque sorte √©valuer les performances du serveur d'applications et le renvoyer au pool de serveurs de production. </li></ol><br>  Apr√®s avoir effectu√© des tests en nature, selon les magazines de l'√©quilibreur, il a √©t√© √©tabli que la d√©claration n ¬∞ 3 ne fonctionne pas.  L'√©quilibreur exclut un serveur inactif d√®s que la condition du param√®tre <i>max_fails</i> est <i>remplie</i> .  Ainsi, un serveur d√©faillant est exclu du service sans attendre le d√©lai de 100 secondes.  Le param√®tre <i>fail_timeout</i> joue uniquement le r√¥le de la limite sup√©rieure du temps d'accumulation d'erreur. <br><br>  Dans le cadre de l'assertion n ¬∞ 4, il s'av√®re que nginx v√©rifie la fonctionnalit√© d'une application qui √©tait auparavant exclue de la maintenance du serveur avec une seule demande.  Et si le serveur r√©pond toujours avec une erreur, la v√©rification suivante <i>√©chouera</i> apr√®s <i>fail_timeout</i> . <br><br><h2>  Qu'est-ce qui manque? </h2><br><ol><li>  L'algorithme impl√©ment√© dans nginx / 1.17.0 n'est peut-√™tre pas le moyen le plus juste de v√©rifier les performances du serveur avant de le retourner dans le pool de serveurs de travail.  Au moins, selon la documentation actuelle, pas 1 demande n'est attendue, mais le montant sp√©cifi√© dans <i>max_fails</i> . </li><li>  L'algorithme de v√©rification d'√©tat ne prend pas en compte la vitesse des requ√™tes.  Plus il est grand, plus le spectre est fort avec des tentatives infructueuses se d√©pla√ßant vers la gauche, et le serveur d'applications abandonne trop rapidement le pool de serveurs de travail.  Je suppose que cela peut nuire aux applications qui se permettent de produire des erreurs ¬´de caillots courts¬ª.  Par exemple, lors de la collecte des ordures. </li></ol><br><img src="https://habrastorage.org/webt/dg/5k/t2/dg5kt2myincbznycsx2owz_rh6w.jpeg"><br><br>  Je voulais vous demander s'il y avait un avantage pratique √† l'algorithme de v√©rification de l'int√©grit√© du serveur, qui mesure la vitesse des tentatives infructueuses? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458594/">https://habr.com/ru/post/fr458594/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458576/index.html">Gestion et localisation de texte dans une application web</a></li>
<li><a href="../fr458582/index.html">Un ing√©nieur d'Amazon a cr√©√© un dispositif de blocage de l'IA qui emp√™che les chats de sortir de la rue</a></li>
<li><a href="../fr458584/index.html">11 juillet, Webinaire Group-IB ¬´Analyse des logiciels malveillants pour les d√©butants: approches de base¬ª</a></li>
<li><a href="../fr458590/index.html">Approches architecturales dans les applications iOS</a></li>
<li><a href="../fr458592/index.html">De la latence Ceph √©lev√©e au patch du noyau avec eBPF / BCC</a></li>
<li><a href="../fr458596/index.html">Petty Little Joy # 6: OpenAI Gym - Jouez √† des jeux et contr√¥lez des robots</a></li>
<li><a href="../fr458598/index.html">Reconnaissance des sources lumineuses sur les cartes de l'environnement</a></li>
<li><a href="../fr458600/index.html">Que sont les v√©los √©lectriques (examen de groupe en deux parties de cinq mod√®les de deux fabricants), partie 1</a></li>
<li><a href="../fr458602/index.html">Comment nous avons perc√© le grand pare-feu chinois (partie 1)</a></li>
<li><a href="../fr458604/index.html">Pourquoi les deux plus grands fabricants d'√©lectronique ont uni leurs forces dans un nouveau projet de GPU</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>