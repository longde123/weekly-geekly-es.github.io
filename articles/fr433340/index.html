<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¥üèª üéÖüèæ üò∏ Appareils sans fil Xiaomi dans la maison intelligente ioBroker üèä üò∞ ü¶Å</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Salutations √† tous les amoureux de la domotique. J'ai d√©cid√© de partager l'exp√©rience de l'utilisation d'appareils sans fil Xiaomi avec l'interface Zi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Appareils sans fil Xiaomi dans la maison intelligente ioBroker</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iobroker/blog/433340/">  Salutations √† tous les amoureux de la domotique.  J'ai d√©cid√© de partager l'exp√©rience de l'utilisation d'appareils sans fil Xiaomi avec l'interface ZigBee.  Honn√™tement, je suis contre l'utilisation de tous les appareils sans fil dans n'importe quelle automatisation, des syst√®mes de contr√¥le de processus s√©rieux de gros objets √† de petites automatisations telles que les alarmes incendie ou les maisons intelligentes, mais ... pour essayer. <br><br>  Ce message doit √™tre consid√©r√© comme une instruction √©tape par √©tape pour l'int√©gration des appareils ZigBee dans l'infrastructure de la maison intelligente.  D√©crit ici n'est en aucun cas un axiome et vous pouvez trouver de nombreuses autres fa√ßons de connecter des appareils ZigBee.  Si vous ignorez toujours la description d√©taill√©e, vous pouvez avoir l'impression de la complexit√© ou de la facilit√© de combiner des appareils de diff√©rents fabricants dans une seule plateforme locale en utilisant l'exemple de ZigBee et ioBroker (plus √† ce sujet plus tard).  Je dirai dans cet article comment connecter des appareils √† une maison intelligente, afficher leurs informations sur une tablette ou simplement dans un navigateur et envoyer des messages via des t√©l√©grammes sur le changement d'√©tat de l'appareil.  Si je vous int√©resse, alors je demande un chat. <br><a name="habracut"></a><br>  Selon le fabricant de Xiaomi, les utilisateurs devraient utiliser une application native avec une connexion cloud et une passerelle Wi-Fi pour les appareils ZigBee.  Cependant, une m√©thode pour activer le mode d√©veloppeur dans une application pour obtenir un jeton de contr√¥le est connue depuis longtemps.  Ainsi, √† l'int√©rieur du r√©seau local, vous pouvez communiquer avec la passerelle, ce qui vous permet de faire le pilote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mihome</a> , qui fait partie d'ioBroker. <br><br>  ioBroker est une plate-forme ouverte pour l'IoT, y compris pour la construction de syst√®mes de maison intelligente.  Qu'est-ce que ioBroker peut √™tre trouv√© dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> pr√©c√©dent. <br><br>  Maintenant, ma maison intelligente tourne sur une carte ARM Cubietruck avec un ¬´kit de carrosserie¬ª sous la forme d'un disque dur de 80 Go, de batteries rechargeables de 5000 mAh, d'un ma√Ætre USB √† 1 fil, d'un convertisseur USB-RS485 pour les appareils de sondage utilisant le protocole Modbus.  Armbian OS est install√© sur le disque dur avec le transfert de la partition racine, seul le bootloader reste sur la carte m√©moire microSD. <br><br>  J'ai commenc√© ma connaissance des appareils sans fil Xiaomi en achetant des capteurs de temp√©rature et d'humidit√©.  √Ä cette √©poque, la seule possibilit√© de leur int√©gration √©tait le pilote <b>mihome</b> , mentionn√© ci-dessus. <br><br><h4>  Pilote Mihome </h4><br>  L'ajout d'un pilote au syst√®me est tr√®s simple, vous devez cliquer sur le bouton ¬´+¬ª dans la liste des pilotes disponibles et observer le processus d'installation. <br><br><img src="https://habrastorage.org/webt/1q/uv/gs/1quvgskqfsscaszi1df_weidl_k.png"><br><br>  Je ne d√©crirai pas l'installation et la configuration initiale de l'application Android native Mi Home, vous pouvez la voir sur la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> du pilote ou sur Internet.  Ainsi, le mode d√©veloppeur est activ√©, le jeton est re√ßu, nous configurons l'adaptateur mihome, l'enregistrons et l'ex√©cutons s'il n'a pas √©t√© d√©marr√©. <br><br><img src="https://habrastorage.org/webt/hg/gi/uz/hggiuzkuphbirpnjp1xdcwcxy2e.png"><br><br>  La passerelle Xiaomi et les appareils connect√©s dans l'application Mi Home doivent appara√Ætre dans l'arborescence des objets. <br><br><img src="https://habrastorage.org/webt/tm/wf/gs/tmwfgsbmgvfncvw-gyezzdjhamw.png"><br><br>  Ensuite, vous pouvez configurer les objets nouvellement cr√©√©s.  Par exemple, stocker l'historique des capteurs de temp√©rature et d'humidit√©.  J'utilise un pilote SQL pour les donn√©es historiques qui est configur√© sur une base de donn√©es SQLite. <br><br><img src="https://habrastorage.org/webt/wv/op/yk/wvopykrwhlu2pcgdru82m1yv8sg.png"><br><br>  Le stockage de l'historique de la variable est configur√© dans la fen√™tre des objets syst√®me: dans la hi√©rarchie des objets, vous devez acc√©der √† la variable elle-m√™me et appuyer sur le bouton avec une cl√© √† droite.  Sur l'onglet "Param√®tres", j'ai le stockage de l'historique activ√© par les capteurs - ne change que la variable. <br><br>  Autres param√®tres: <br><br><ul><li>  intervalle minimum de 10 secondes - si la variable change plus souvent, l'entr√©e dans la base de donn√©es sera ignor√©e </li><li>  enregistrement des valeurs toutes les 300 secondes (5 minutes) - si la variable ne change pas pendant plus de 5 minutes, la valeur actuelle est toujours √©crite dans la base de donn√©es </li><li>  type de valeur - nombre </li><li>  dur√©e de conservation - 1 an </li></ul><br><img src="https://habrastorage.org/webt/a2/6n/ed/a26nedcztddt2fo4vofcdndkadu.png"><br><br>  L'ajout de nouveaux appareils s'effectue via l'application native.  C'est-√†-dire  vous devez coupler le nouveau p√©riph√©rique avec la passerelle selon les instructions jointes et apr√®s cela, il appara√Ætra automatiquement dans la liste des objets ioBroker. <br><br><h4>  Pilote Zigbee </h4><br>  Cela ne me convenait pas d'utiliser l'application native Xiaomi, d'autant plus que je devais acheter une passerelle avec une prise chinoise, ce qui, dans mon cas, sauf pour communiquer avec des appareils, ne servait √† rien.  Oui, il peut √™tre utilis√© comme veilleuse ou utiliser un capteur de lumi√®re dans certains sc√©narios.  Sur Internet, vous pouvez trouver des instructions sur la fa√ßon de ¬´transmettre¬ª une liste de lecture √† une passerelle pour lire ses propres stations de radio, mais rien de tout cela ne me reste.  De plus, la pens√©e que mes donn√©es fuyaient quelque part, qu'elles √©taient trait√©es et stock√©es quelque part √©tait obs√©dante. <br><br>  L'un des utilisateurs actifs de la plate-forme ioBroker a trouv√© sur Internet la biblioth√®que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">zigbee-shepherd</a> sur node.js, dans laquelle il √©tait fait mention de la connexion d'appareils Xiaomi.  Un pilote pour ioBroker a √©t√© √©crit sur sa base, et l'auteur de ce pilote ne se limitait pas uniquement aux appareils Xiaomi, la liste des appareils pris en charge est constamment mise √† jour et est disponible sur la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> du projet. <br><br>  Il est cens√© utiliser des dispositifs pr√™ts √† l'emploi peu co√ªteux bas√©s sur les puces <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CC25xx</a> de TI en tant que coordinateur de r√©seau.  Vous pouvez acheter des modules ZigBee pr√™ts √† l'emploi avec connexion USB et une antenne int√©gr√©e, ainsi que des mod√®les plus chers et plus s√©rieux: avec une antenne externe, un amplificateur et une connexion via UART. <br><br>  Pour travailler avec le pilote, il vous suffit de changer le firmware.  Ainsi, il s'av√®re que ce pilote n'a pas besoin d'une passerelle co√ªteuse, les r√©seaux Wi-Fi ne sont pas n√©cessaires.  Le "point d'entr√©e" est le coordinateur - un appareil bas√© sur la puce SS25xx avec un firmware sp√©cial.  Gr√¢ce au coordinateur, il y a une communication directe des appareils zigbee et du syst√®me Smart Home, ainsi que la liaison de nouveaux appareils. <br><br>  En tant que coordinatrice, j'utilise une carte m√®re pr√™te √† l'emploi bas√©e sur une puce CC2530 avec une antenne externe, que j'ai connect√©e au serveur via UART. <br><br>  Pour le micrologiciel de l'appareil, un d√©bogueur sp√©cial SmartRF04EB a √©t√© achet√©, le port microUSB dont je me suis connect√© √† l'ordinateur et le module ZigBee connect√© √† l'aide d'un c√¢blage pour le d√©bogage selon le sch√©ma: <br><table><tbody><tr><th>  SS2530 </th><th>  SmartRF04EB Board </th></tr><tr><td>  P22 </td><td>  DC </td></tr><tr><td>  P21 </td><td>  DD </td></tr><tr><td>  Rst </td><td>  R√âINITIALISER </td></tr><tr><td>  GND </td><td>  GND </td></tr><tr><td>  Vcc </td><td>  3,3 V </td></tr></tbody></table><br><br><img src="https://habrastorage.org/webt/zy/g3/mf/zyg3mfircqqapiz8vz59afyrm5g.jpeg"><br><br>  Sur la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> du projet, t√©l√©chargez le firmware (le fichier s'appelle CC2530ZNP-Pro-Secure_LinkKeyJoin.hex pour cet appareil) et le firmware (flash-programmer), apr√®s quoi les pilotes n√©cessaires sont ajout√©s au syst√®me. <br>  Lorsque vous connectez la carte de d√©bogage au port USB de l'ordinateur, le programme affiche imm√©diatement le p√©riph√©rique connect√©.  Il vous suffit de sp√©cifier le chemin d'acc√®s au fichier du firmware et de cliquer sur le bouton ¬´Effectuer des actions¬ª <br><br><img src="https://habrastorage.org/webt/7z/rd/w8/7zrdw8e3iwpyvisw6dzohkfn3zs.png"><br><br>  Les ports P03 (Rx) et P02 (Tx) du module ZigBee sont connect√©s dans des cartes cubietruck UART4 (dans le syst√®me d'exploitation comme ttyS4), aliment√©es en 3V3, GND a pris la broche voisine.  Pour un fonctionnement stable, vous devez toujours tirer les ports P20, P4, P5 du coordinateur vers le sol.  Comme je l'ai √©crit ci-dessus, j'utilise le syst√®me d'exploitation Armbian, le port UART est activ√© tr√®s simplement, en utilisant la commande <b>armbian-config</b> dans la section <b>Syst√®me</b> - <b>Mat√©riel</b> , vous devez activer le port souhait√© et red√©marrer le syst√®me. <br><br><img src="https://habrastorage.org/webt/ic/7l/il/ic7lilxwfsext55fvjnpdyxfiuq.png"><br><br>  Le pilote zigbee est ajout√© √† partir du panneau d'administration en un seul clic. <br><br><img src="https://habrastorage.org/webt/uw/-d/zm/uw-dzmkdrsbgnunfmchqtzqq8ta.png"><br><br>  Dans mon cas, le coordinateur est connect√© au port <b>/ dev / ttyS4</b> (comme je l'ai √©crit plus haut), nous le pr√©cisons dans les param√®tres. <br><br><img src="https://habrastorage.org/webt/eu/2i/bo/eu2ibog5mba2paet4ecec7jo7aw.png"><br><br>  D'autres param√®tres peuvent √™tre laiss√©s par d√©faut.  Apr√®s le premier lancement du pilote, vous devez coupler (ajouter) des p√©riph√©riques.  L'instruction compl√®te sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> , l'appairage via ce pilote est un peu plus compliqu√©e que via l'application native, mais je n'ai eu aucun probl√®me. <br><br>  Ainsi, par exemple, ajoutez le bouton Xiaomi (s√©rie Mijia), pour cela, nous appuyons sur le bouton vert dans les param√®tres du pilote et, en suivant les instructions, maintenez d'abord le bouton de couplage √† l'arri√®re avec un trombone jusqu'√† ce que la LED commence √† clignoter, puis cliquez sur ce bouton environ une fois toutes les 2 secondes, voir la progression du jumelage. <br><br><img src="https://habrastorage.org/webt/mm/vq/ok/mmvqokw8ors3oszymkuqv5jsswq.png"><br><br>  Mon appartement n'est pas grand, avec tous les appareils la connexion est stable, m√™me avec un capteur de porte ouverte sur le palier (mur en b√©ton arm√© de 100 mm et 5 m en ligne droite).  Les probl√®mes ont commenc√© lorsque j'ai d√©cid√© d'ajouter un capteur de temp√©rature et d'humidit√© √† l'air de la rue, que j'ai install√© sur le mur ext√©rieur de la maison du c√¥t√© de la loggia isol√©e.  Le signal d'un capteur faible, qui se trouvait √©galement dans la rue, n'a pas atteint l'armoire d'automatisation.  Le probl√®me peut √™tre r√©solu simplement - vous devez ajouter un routeur au r√©seau ZigBee et le rapprocher du capteur.  Certains appareils sans fil, par exemple la prise Xiaomi, peuvent fonctionner comme un routeur, mais je n'avais pas de tels appareils.  Je ne voulais pas acheter une prise co√ªteuse ou une lumi√®re contr√¥l√©e juste pour ¬´transmettre¬ª les donn√©es d'un capteur dans la rue.  Il s'est av√©r√© que, pour les m√™mes terminaux bas√©s sur la puce SS25xx, il existe un firmware sp√©cial qui permet de les utiliser comme routeur dans le syst√®me.  En cons√©quence, j'ai ajout√© un routeur bas√© sur la puce CC2531 avec une connexion USB.  Je ne m'attarderai pas sur le processus du firmware, le sch√©ma et le fichier du firmware lui-m√™me se trouvent sur la page <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">github</a> du projet. <br><br>  Puisque, en fait, la communication avec le module via le port USB ne se produit pas, je l'ai branch√© temporairement sur la charge avec le port USB et l'ai branch√© sur une prise de la cuisine.  Dans un avenir proche, je pr√©vois de le placer √† l'arr√™t dans un b√¢timent normal sur la loggia et avec une alimentation normale √† partir d'un onduleur domestique. <br><br><img src="https://habrastorage.org/webt/kh/an/8v/khan8vzw8f5ueqs2n-jf-9kc2e4.jpeg"><br><br>  Le processus d'ajout d'un routeur au syst√®me est simple: appuyez sur le bouton d'appairage dans le pilote et sur le routeur allum√©, appuyez plusieurs fois sur le bouton S2 jusqu'√† ce que les appareils se connectent. <br><br><img src="https://habrastorage.org/webt/6g/x_/gf/6gx_gfpctjiecwfz8mtz3ah8bne.png"><br><br>  Ajoutons un exemple de capteur de temp√©rature / humidit√©, que j'ai situ√© sur la loggia √† l'ext√©rieur et qui devrait fonctionner via un routeur. <br><br>  Vous pouvez simplement effectuer l'appairage via le pilote et le capteur doit se connecter via le routeur, s'il est plus proche.  Mais vous pouvez sp√©cifier de force que le couplage passe par un routeur sp√©cifique, pour cela, dans la liste des p√©riph√©riques sur l'ic√¥ne du routeur, cliquez sur le bouton de couplage vert. <br><br><img src="https://habrastorage.org/webt/bz/df/tr/bzdftrouwfsmd3qq0yyztpsfyee.png"><br><br>  Assurez-vous que le capteur est correctement connect√© - voir la carte du r√©seau. <br><br><img src="https://habrastorage.org/webt/g9/bj/ru/g9bjruowwwdc7tvq03p0vychauo.png"><br><br>  La carte montre les lignes d'appariement des appareils indiquant la qualit√© du signal entre les segments du r√©seau.  Comme je l'ai √©crit ci-dessus, j'ai une petite odnushka de 35 m¬≤, donc la carte est assez modeste.  Avec la permission d'autres utilisateurs, je publierai les options possibles avec une carte plus grande. <br><br><img src="https://habrastorage.org/webt/9b/r9/g6/9br9g6psblxtppn56-khinqtf90.png"><br><br><img src="https://habrastorage.org/webt/jo/--/ux/jo--uxxcnxpn_qtlah5yd4awl_g.png"><br><br><img src="https://habrastorage.org/webt/p0/lg/ba/p0lgba6-rpbvnqkcttsabf6wnaa.jpeg"><br><br>  La fonctionnalit√© de certains appareils Xiaomi via cet adaptateur est m√™me un peu plus que via l'application native et le pilote mihome.  √Ä l'avenir, je souhaite √©tendre un peu le r√©seau et essayer de nouveaux appareils, en particulier un lecteur intelligent pour rideaux et un cube de capteurs. <br><br><h4>  Pilote de mat√©riau </h4><br>  Nous avons obtenu les donn√©es, les actionneurs li√©s, que faire maintenant avec eux?  Tout d'abord, affichons dans une belle interface.  J'ai un grand projet dans le pilote VIS, qui existe en plusieurs versions pour diff√©rentes autorisations, mais il y a suffisamment de mat√©riel pour un article s√©par√©.  Elle sera peut-√™tre la prochaine. <br><br>  Pour un affichage simple et rapide des donn√©es et le contr√¥le de divers appareils, j'utilise le pilote de mat√©riel.  Installation comme d'habitude en quelques clics.  Les tuiles d'interface affichent les donn√©es en fonction des param√®tres de cat√©gorie, qui sont ajout√©s dans la fen√™tre d'administration d'interface du m√™me nom.  La liste des cat√©gories n'est limit√©e que par l'imagination, j'utilise le sch√©ma ¬´room-function¬ª, et le regroupement se fait selon elles.  Ajout de toutes les pi√®ces (cuisine, couloir, pi√®ce, balcon, etc.) et des fonctions (√©clairage, capteurs, syst√®me, etc.). <br><br><img src="https://habrastorage.org/webt/le/nt/7p/lent7pos1th-k5mzz9yezdmug-m.png"><br><br>  Maintenant, dans la fen√™tre des param√®tres des objets syst√®me, il est n√©cessaire que les variables qui seront affich√©es √† l'√©cran indiquent la pi√®ce, la fonction et assignent un r√¥le (pour un affichage correct).  Un exemple est le capteur de temp√©rature et d'humidit√© du mur int√©rieur de Xiaomi, connect√© via Bluetooth. <br><br><img src="https://habrastorage.org/webt/by/2u/ws/by2uwskolk1rxomzcm-mvg_rccw.png"><br><br>  En fonction de ces param√®tres, la vignette affichera des donn√©es √† l'√©cran, l'ic√¥ne se resserrera et, pour les objets d'un certain type, un contr√¥le sera disponible. <br><br>  <b>Exemple 1.</b> La sortie de toutes les informations dans une cat√©gorie - fonction.  √âclairage dans tout l'appartement. <br><br><img src="https://habrastorage.org/webt/jp/xs/m3/jpxsm3v67xbi7otryix6xqemigu.png"><br><br>  <b>Exemple 2.</b> La sortie de toutes les informations sur la pi√®ce - Salle de bain. <br><br><img src="https://habrastorage.org/webt/5x/ce/2m/5xce2mjrmxjetxojelprdg95chg.png"><br><br>  <b>Exemple 3. La</b> tension et le niveau de d√©charge de la batterie de tous les appareils sans fil Xiaomi. <br><br><img src="https://habrastorage.org/webt/40/t4/p3/40t4p3d-ggn71albkiy7aarsylo.png"><br><br>  Ce pilote travaille pour moi pour le contr√¥le local du syst√®me √† partir d'un t√©l√©phone mobile, d'une tablette fixe sur le mur.  Parfois, je me connecte via VPN.  Pour contr√¥ler et afficher les √©tats √† distance, pour recevoir des notifications, j'utilise le pilote de t√©l√©gramme. <br><br><h4>  Pilote de t√©l√©gramme </h4><br>  Je ne d√©crirai pas l'installation, il suffit de parcourir les param√®tres.  J'utilise le mode de fonctionnement via une interrogation p√©riodique (300 ms par d√©faut) et une connexion via un serveur proxy.  Pour obtenir des jetons, vous devez ¬´parler¬ª avec le cr√©ateur de bots, BotFather.  Le processus est simple - recherchez une recherche pour ce bot, donnez une commande pour en cr√©er un nouveau, sp√©cifiez son nom unique et votre cl√©, indiquez-le dans les param√®tres du pilote et, pour des raisons de s√©curit√©, assurez-vous de sp√©cifier le mot de passe "de bienvenue".  Votre bot lui demandera lors de la communication avec un nouvel utilisateur. <br><br><img src="https://habrastorage.org/webt/du/nw/jt/dunwjtmlt874q5t1hma81lpz0qs.png"><br><br>  Vous devez maintenant configurer les cas de communication via le bot.  Pour ce faire, vous pouvez utiliser le pilote text2command ou JavaScript.  Il est arriv√© historiquement que j'utilise JavaScript √† la fois sous forme de texte et de blocs Blockly.  L'installation du pilote JS ne devrait pas causer de difficult√©s, la configuration dans ce cas n'est pas n√©cessaire.  Apr√®s l'installation et le lancement, vous devez activer l'affichage du menu pour cr√©er et modifier des scripts. <br><br><img src="https://habrastorage.org/webt/wj/tc/pb/wjtcpbty2ro46bn6a5orrwbvpis.png"><br><br>  <b>Exemple 1.</b> Alertes. <br><br>  Tout d'abord, essayons d'envoyer une notification sur l'ouverture, par exemple, de la porte d'entr√©e.  J'ai un interrupteur reed sans fil Xiaomi sur la porte avant.  Je surveille la marche de ma femme avec le petit pendant que je travaille.  Cr√©ez un nouveau script dans le groupe commun. <br><br><img src="https://habrastorage.org/webt/cu/l6/5j/cul65jefd-k794nct-cicju7x64.png"><br><br>  Sp√©cifiez ce qui sera "dessin√©" en bloc et appelez-le "telegram_bot". <br><br><img src="https://habrastorage.org/webt/os/ed/kq/osedkqplopwii7ckmd3eftjliwo.png"><br><br>  Dans le groupe "Ev√©nements", nous prenons l'unit√© de r√©action pour changer la variable et la faisons glisser sur le champ de travail. <br><br><img src="https://habrastorage.org/webt/1h/o6/yq/1ho6yq_kluvryjb48bdo9iijn-a.png"><br><br>  Ensuite, s√©lectionnez l'ID de l'objet auquel nous sommes abonn√©s, ins√©rez la v√©rification de l'objet via ¬´si¬ª - ¬´sinon si¬ª sur vrai / faux.  Le r√©sultat devrait ressembler √† ce qui suit. <br><br><img src="https://habrastorage.org/webt/9u/-r/0s/9u-r0sajaneojinyzpgojw2lnoa.png"><br><br>  Ok, maintenant on court, on ouvre la porte - on ferme la porte et on voit des messages dans le t√©l√©gramme. <br><br><img src="https://habrastorage.org/webt/ae/07/u6/ae07u62jmarzp0nw1hv2a3bhv9y.png"><br><br>  <b>Exemple 2.</b> Contr√¥le d'√©clairage via le menu. <br>  Un exemple est plus compliqu√©, faisons un contr√¥le d'√©clairage en utilisant les boutons de menu dans le t√©l√©gramme.  Ici, vous devez tra√Æner un peu, c'est-√†-dire  lors de la cr√©ation d'un script, vous devez s√©lectionner JS.  La t√¢che est approximativement la suivante: cr√©er des boutons sous la forme d'un menu avec le statut des appareils affich√©s imm√©diatement dans le texte de signature du bouton.  Essayez toujours de vous assurer que lorsque vous appuyez sur le bouton, le statut d'√©clairage est invers√© et le statut est imm√©diatement mis √† jour dans le texte du bouton avec l'apparition / la disparition de l'ampoule.  De plus, si le menu est d√©j√† en cours et allume / √©teint manuellement la lumi√®re avec le bouton, il est n√©cessaire que le menu soit √©galement mis √† jour avec l'√©tat des luminaires. <br>  Le code contient des commentaires et est relativement simple: <br><div class="oembed"><script type="text/javascript" src="https://gist.github.com/c980b9dd1c2e9d050810b11ed712b0c0.js"></script><link rel="stylesheet" href="https://github.githubassets.com/assets/gist-embed-31007ea0d3bd9f80540adfbc55afc7bd.css"><div id="gist93669305" class="gist">
    <div class="gist-file">
      <div class="gist-data">
        <div class="js-gist-file-update-container js-task-list-container file-box">
  <div id="file-telegram_bot" class="file">
    

  <div itemprop="text" class="Box-body p-0 blob-wrapper data type-text ">
      
<table class="highlight tab-size js-file-line-container" data-tab-size="8" data-paste-markdown-skip="">
      <tbody><tr>
        <td id="file-telegram_bot-L1" class="blob-num js-line-number" data-line-number="1"></td>
        <td id="file-telegram_bot-LC1" class="blob-code blob-code-inner js-file-line">//    ID   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L2" class="blob-num js-line-number" data-line-number="2"></td>
        <td id="file-telegram_bot-LC2" class="blob-code blob-code-inner js-file-line">const LIGHT1 = ' ',     CH_LIGHT1 = 'mqtt.0.PLC55_Lighting.lighting.MainRoom_main1';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L3" class="blob-num js-line-number" data-line-number="3"></td>
        <td id="file-telegram_bot-LC3" class="blob-code blob-code-inner js-file-line">const LIGHT2 = ' ',      CH_LIGHT2 = 'mqtt.0.PLC55_Lighting.lighting.MainRoom_main2';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L4" class="blob-num js-line-number" data-line-number="4"></td>
        <td id="file-telegram_bot-LC4" class="blob-code blob-code-inner js-file-line">const LIGHT3 = ' ',    CH_LIGHT3 = 'mqtt.0.PLC55_Lighting.lighting.MainRoom_sec';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L5" class="blob-num js-line-number" data-line-number="5"></td>
        <td id="file-telegram_bot-LC5" class="blob-code blob-code-inner js-file-line">const LIGHT4 = ' ',      CH_LIGHT4 = 'mqtt.0.PLC55_Lighting.lighting.Kitchen_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L6" class="blob-num js-line-number" data-line-number="6"></td>
        <td id="file-telegram_bot-LC6" class="blob-code blob-code-inner js-file-line">const LIGHT5 = ' 1',  	CH_LIGHT5 = 'mqtt.0.PLC55_Lighting.lighting.Kitchen_sec_top';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L7" class="blob-num js-line-number" data-line-number="7"></td>
        <td id="file-telegram_bot-LC7" class="blob-code blob-code-inner js-file-line">const LIGHT6 = ' 2',    CH_LIGHT6 = 'mqtt.0.PLC55_Lighting.lighting.Kitchen_sec_bottom';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L8" class="blob-num js-line-number" data-line-number="8"></td>
        <td id="file-telegram_bot-LC8" class="blob-code blob-code-inner js-file-line">const LIGHT7 = ' ',     CH_LIGHT7 = 'mqtt.0.PLC55_Lighting.lighting.BathRoom_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L9" class="blob-num js-line-number" data-line-number="9"></td>
        <td id="file-telegram_bot-LC9" class="blob-code blob-code-inner js-file-line">const LIGHT8 = ' ',       CH_LIGHT8 = 'mqtt.0.PLC55_Lighting.lighting.Hall_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L10" class="blob-num js-line-number" data-line-number="10"></td>
        <td id="file-telegram_bot-LC10" class="blob-code blob-code-inner js-file-line">const LIGHT9 = ' ',    CH_LIGHT9 = 'mqtt.0.PLC55_Lighting.lighting.Balcon_main';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L11" class="blob-num js-line-number" data-line-number="11"></td>
        <td id="file-telegram_bot-LC11" class="blob-code blob-code-inner js-file-line">
</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L12" class="blob-num js-line-number" data-line-number="12"></td>
        <td id="file-telegram_bot-LC12" class="blob-code blob-code-inner js-file-line">//    </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L13" class="blob-num js-line-number" data-line-number="13"></td>
        <td id="file-telegram_bot-LC13" class="blob-code blob-code-inner js-file-line">function sendLightMenu(message_text) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L14" class="blob-num js-line-number" data-line-number="14"></td>
        <td id="file-telegram_bot-LC14" class="blob-code blob-code-inner js-file-line">	//   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L15" class="blob-num js-line-number" data-line-number="15"></td>
        <td id="file-telegram_bot-LC15" class="blob-code blob-code-inner js-file-line">    var l1 = getState(CH_LIGHT1).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L16" class="blob-num js-line-number" data-line-number="16"></td>
        <td id="file-telegram_bot-LC16" class="blob-code blob-code-inner js-file-line">    var l2 = getState(CH_LIGHT2).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L17" class="blob-num js-line-number" data-line-number="17"></td>
        <td id="file-telegram_bot-LC17" class="blob-code blob-code-inner js-file-line">    var l3 = getState(CH_LIGHT3).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L18" class="blob-num js-line-number" data-line-number="18"></td>
        <td id="file-telegram_bot-LC18" class="blob-code blob-code-inner js-file-line">    var l4 = getState(CH_LIGHT4).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L19" class="blob-num js-line-number" data-line-number="19"></td>
        <td id="file-telegram_bot-LC19" class="blob-code blob-code-inner js-file-line">    var l5 = getState(CH_LIGHT5).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L20" class="blob-num js-line-number" data-line-number="20"></td>
        <td id="file-telegram_bot-LC20" class="blob-code blob-code-inner js-file-line">    var l6 = getState(CH_LIGHT6).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L21" class="blob-num js-line-number" data-line-number="21"></td>
        <td id="file-telegram_bot-LC21" class="blob-code blob-code-inner js-file-line">    var l7 = getState(CH_LIGHT7).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L22" class="blob-num js-line-number" data-line-number="22"></td>
        <td id="file-telegram_bot-LC22" class="blob-code blob-code-inner js-file-line">    var l8 = getState(CH_LIGHT8).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L23" class="blob-num js-line-number" data-line-number="23"></td>
        <td id="file-telegram_bot-LC23" class="blob-code blob-code-inner js-file-line">    var l9 = getState(CH_LIGHT9).val ? 'üí°' : '';</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L24" class="blob-num js-line-number" data-line-number="24"></td>
        <td id="file-telegram_bot-LC24" class="blob-code blob-code-inner js-file-line">    // </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L25" class="blob-num js-line-number" data-line-number="25"></td>
        <td id="file-telegram_bot-LC25" class="blob-code blob-code-inner js-file-line">	sendTo('telegram.0', {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L26" class="blob-num js-line-number" data-line-number="26"></td>
        <td id="file-telegram_bot-LC26" class="blob-code blob-code-inner js-file-line">        text:   message_text,</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L27" class="blob-num js-line-number" data-line-number="27"></td>
        <td id="file-telegram_bot-LC27" class="blob-code blob-code-inner js-file-line">        reply_markup: {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L28" class="blob-num js-line-number" data-line-number="28"></td>
        <td id="file-telegram_bot-LC28" class="blob-code blob-code-inner js-file-line">            keyboard: [</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L29" class="blob-num js-line-number" data-line-number="29"></td>
        <td id="file-telegram_bot-LC29" class="blob-code blob-code-inner js-file-line">                [LIGHT1+l1, LIGHT2+l2, LIGHT3+l3],</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L30" class="blob-num js-line-number" data-line-number="30"></td>
        <td id="file-telegram_bot-LC30" class="blob-code blob-code-inner js-file-line">                [LIGHT4+l4, LIGHT5+l5, LIGHT6+l6],</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L31" class="blob-num js-line-number" data-line-number="31"></td>
        <td id="file-telegram_bot-LC31" class="blob-code blob-code-inner js-file-line">                [LIGHT7+l7, LIGHT8+l8, LIGHT9+l9]</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L32" class="blob-num js-line-number" data-line-number="32"></td>
        <td id="file-telegram_bot-LC32" class="blob-code blob-code-inner js-file-line">            ],</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L33" class="blob-num js-line-number" data-line-number="33"></td>
        <td id="file-telegram_bot-LC33" class="blob-code blob-code-inner js-file-line">            resize_keyboard:   true,</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L34" class="blob-num js-line-number" data-line-number="34"></td>
        <td id="file-telegram_bot-LC34" class="blob-code blob-code-inner js-file-line">            one_time_keyboard: true</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L35" class="blob-num js-line-number" data-line-number="35"></td>
        <td id="file-telegram_bot-LC35" class="blob-code blob-code-inner js-file-line">        }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L36" class="blob-num js-line-number" data-line-number="36"></td>
        <td id="file-telegram_bot-LC36" class="blob-code blob-code-inner js-file-line">    });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L37" class="blob-num js-line-number" data-line-number="37"></td>
        <td id="file-telegram_bot-LC37" class="blob-code blob-code-inner js-file-line">}</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L38" class="blob-num js-line-number" data-line-number="38"></td>
        <td id="file-telegram_bot-LC38" class="blob-code blob-code-inner js-file-line">//  </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L39" class="blob-num js-line-number" data-line-number="39"></td>
        <td id="file-telegram_bot-LC39" class="blob-code blob-code-inner js-file-line">function changeLight(room, channel) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L40" class="blob-num js-line-number" data-line-number="40"></td>
        <td id="file-telegram_bot-LC40" class="blob-code blob-code-inner js-file-line">	//   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L41" class="blob-num js-line-number" data-line-number="41"></td>
        <td id="file-telegram_bot-LC41" class="blob-code blob-code-inner js-file-line">    var alive = getState("mqtt.0.info.connection").val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L42" class="blob-num js-line-number" data-line-number="42"></td>
        <td id="file-telegram_bot-LC42" class="blob-code blob-code-inner js-file-line">    if (alive.includes("PLC55_Lighting")) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L43" class="blob-num js-line-number" data-line-number="43"></td>
        <td id="file-telegram_bot-LC43" class="blob-code blob-code-inner js-file-line">        if (getState(channel).val) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L44" class="blob-num js-line-number" data-line-number="44"></td>
        <td id="file-telegram_bot-LC44" class="blob-code blob-code-inner js-file-line">            setState(channel, false, false, function () {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L45" class="blob-num js-line-number" data-line-number="45"></td>
        <td id="file-telegram_bot-LC45" class="blob-code blob-code-inner js-file-line">                sendLightMenu(room+' ');</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L46" class="blob-num js-line-number" data-line-number="46"></td>
        <td id="file-telegram_bot-LC46" class="blob-code blob-code-inner js-file-line">            });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L47" class="blob-num js-line-number" data-line-number="47"></td>
        <td id="file-telegram_bot-LC47" class="blob-code blob-code-inner js-file-line">        } else { </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L48" class="blob-num js-line-number" data-line-number="48"></td>
        <td id="file-telegram_bot-LC48" class="blob-code blob-code-inner js-file-line">            setState(channel, true, false, function () {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L49" class="blob-num js-line-number" data-line-number="49"></td>
        <td id="file-telegram_bot-LC49" class="blob-code blob-code-inner js-file-line">                sendLightMenu(room+' ');</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L50" class="blob-num js-line-number" data-line-number="50"></td>
        <td id="file-telegram_bot-LC50" class="blob-code blob-code-inner js-file-line">            });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L51" class="blob-num js-line-number" data-line-number="51"></td>
        <td id="file-telegram_bot-LC51" class="blob-code blob-code-inner js-file-line">        }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L52" class="blob-num js-line-number" data-line-number="52"></td>
        <td id="file-telegram_bot-LC52" class="blob-code blob-code-inner js-file-line">    } else {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L53" class="blob-num js-line-number" data-line-number="53"></td>
        <td id="file-telegram_bot-LC53" class="blob-code blob-code-inner js-file-line">        sendLightMenu('  OFFLINE');</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L54" class="blob-num js-line-number" data-line-number="54"></td>
        <td id="file-telegram_bot-LC54" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L55" class="blob-num js-line-number" data-line-number="55"></td>
        <td id="file-telegram_bot-LC55" class="blob-code blob-code-inner js-file-line">}</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L56" class="blob-num js-line-number" data-line-number="56"></td>
        <td id="file-telegram_bot-LC56" class="blob-code blob-code-inner js-file-line">//   request  ,    </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L57" class="blob-num js-line-number" data-line-number="57"></td>
        <td id="file-telegram_bot-LC57" class="blob-code blob-code-inner js-file-line">on({id: "telegram.0.communicate.request", ack: false, change: 'any'}, function (obj) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L58" class="blob-num js-line-number" data-line-number="58"></td>
        <td id="file-telegram_bot-LC58" class="blob-code blob-code-inner js-file-line">    var msg = obj.state.val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L59" class="blob-num js-line-number" data-line-number="59"></td>
        <td id="file-telegram_bot-LC59" class="blob-code blob-code-inner js-file-line">    var command = obj.state.val.substring(obj.state.val.indexOf(']')+1);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L60" class="blob-num js-line-number" data-line-number="60"></td>
        <td id="file-telegram_bot-LC60" class="blob-code blob-code-inner js-file-line">    var user = obj.state.val.substring(obj.state.val.indexOf('[')+1,obj.state.val.indexOf(']'));</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L61" class="blob-num js-line-number" data-line-number="61"></td>
        <td id="file-telegram_bot-LC61" class="blob-code blob-code-inner js-file-line">    var chat_id = getState("telegram.0.communicate.requestChatId").val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L62" class="blob-num js-line-number" data-line-number="62"></td>
        <td id="file-telegram_bot-LC62" class="blob-code blob-code-inner js-file-line">    var message_id = getState("telegram.0.communicate.requestMessageId").val;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L63" class="blob-num js-line-number" data-line-number="63"></td>
        <td id="file-telegram_bot-LC63" class="blob-code blob-code-inner js-file-line">    var handled = false;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L64" class="blob-num js-line-number" data-line-number="64"></td>
        <td id="file-telegram_bot-LC64" class="blob-code blob-code-inner js-file-line">    //     </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L65" class="blob-num js-line-number" data-line-number="65"></td>
        <td id="file-telegram_bot-LC65" class="blob-code blob-code-inner js-file-line">	if (command == '/start' || command == '/menu' || command == '' || command == '') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L66" class="blob-num js-line-number" data-line-number="66"></td>
        <td id="file-telegram_bot-LC66" class="blob-code blob-code-inner js-file-line">        sendLightMenu("");</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L67" class="blob-num js-line-number" data-line-number="67"></td>
        <td id="file-telegram_bot-LC67" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L68" class="blob-num js-line-number" data-line-number="68"></td>
        <td id="file-telegram_bot-LC68" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L69" class="blob-num js-line-number" data-line-number="69"></td>
        <td id="file-telegram_bot-LC69" class="blob-code blob-code-inner js-file-line">//######################## Lighting menu and commands ################</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L70" class="blob-num js-line-number" data-line-number="70"></td>
        <td id="file-telegram_bot-LC70" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT1 || command == LIGHT1+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L71" class="blob-num js-line-number" data-line-number="71"></td>
        <td id="file-telegram_bot-LC71" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT1, CH_LIGHT1);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L72" class="blob-num js-line-number" data-line-number="72"></td>
        <td id="file-telegram_bot-LC72" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L73" class="blob-num js-line-number" data-line-number="73"></td>
        <td id="file-telegram_bot-LC73" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L74" class="blob-num js-line-number" data-line-number="74"></td>
        <td id="file-telegram_bot-LC74" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT2 || command == LIGHT2+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L75" class="blob-num js-line-number" data-line-number="75"></td>
        <td id="file-telegram_bot-LC75" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT2, CH_LIGHT2);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L76" class="blob-num js-line-number" data-line-number="76"></td>
        <td id="file-telegram_bot-LC76" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L77" class="blob-num js-line-number" data-line-number="77"></td>
        <td id="file-telegram_bot-LC77" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L78" class="blob-num js-line-number" data-line-number="78"></td>
        <td id="file-telegram_bot-LC78" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT3 || command == LIGHT3+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L79" class="blob-num js-line-number" data-line-number="79"></td>
        <td id="file-telegram_bot-LC79" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT3, CH_LIGHT3);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L80" class="blob-num js-line-number" data-line-number="80"></td>
        <td id="file-telegram_bot-LC80" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L81" class="blob-num js-line-number" data-line-number="81"></td>
        <td id="file-telegram_bot-LC81" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L82" class="blob-num js-line-number" data-line-number="82"></td>
        <td id="file-telegram_bot-LC82" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT4 || command == LIGHT4+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L83" class="blob-num js-line-number" data-line-number="83"></td>
        <td id="file-telegram_bot-LC83" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT4, CH_LIHT4);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L84" class="blob-num js-line-number" data-line-number="84"></td>
        <td id="file-telegram_bot-LC84" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L85" class="blob-num js-line-number" data-line-number="85"></td>
        <td id="file-telegram_bot-LC85" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L86" class="blob-num js-line-number" data-line-number="86"></td>
        <td id="file-telegram_bot-LC86" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT5 || command == LIGHT5+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L87" class="blob-num js-line-number" data-line-number="87"></td>
        <td id="file-telegram_bot-LC87" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT5, CH_LIGHT5);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L88" class="blob-num js-line-number" data-line-number="88"></td>
        <td id="file-telegram_bot-LC88" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L89" class="blob-num js-line-number" data-line-number="89"></td>
        <td id="file-telegram_bot-LC89" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L90" class="blob-num js-line-number" data-line-number="90"></td>
        <td id="file-telegram_bot-LC90" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT6 || command == LIGHT6+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L91" class="blob-num js-line-number" data-line-number="91"></td>
        <td id="file-telegram_bot-LC91" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT6, CH_LIGHT6);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L92" class="blob-num js-line-number" data-line-number="92"></td>
        <td id="file-telegram_bot-LC92" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L93" class="blob-num js-line-number" data-line-number="93"></td>
        <td id="file-telegram_bot-LC93" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L94" class="blob-num js-line-number" data-line-number="94"></td>
        <td id="file-telegram_bot-LC94" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT7 || command == LIGHT7+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L95" class="blob-num js-line-number" data-line-number="95"></td>
        <td id="file-telegram_bot-LC95" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT7, CH_LIGHT7);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L96" class="blob-num js-line-number" data-line-number="96"></td>
        <td id="file-telegram_bot-LC96" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L97" class="blob-num js-line-number" data-line-number="97"></td>
        <td id="file-telegram_bot-LC97" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L98" class="blob-num js-line-number" data-line-number="98"></td>
        <td id="file-telegram_bot-LC98" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT8 || command == LIGHT8+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L99" class="blob-num js-line-number" data-line-number="99"></td>
        <td id="file-telegram_bot-LC99" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT8, CH_LIGHT8);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L100" class="blob-num js-line-number" data-line-number="100"></td>
        <td id="file-telegram_bot-LC100" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L101" class="blob-num js-line-number" data-line-number="101"></td>
        <td id="file-telegram_bot-LC101" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L102" class="blob-num js-line-number" data-line-number="102"></td>
        <td id="file-telegram_bot-LC102" class="blob-code blob-code-inner js-file-line">    if (command == LIGHT9 || command == LIGHT9+'üí°') {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L103" class="blob-num js-line-number" data-line-number="103"></td>
        <td id="file-telegram_bot-LC103" class="blob-code blob-code-inner js-file-line">        changeLight(LIGHT9, CH_LIGHT9);</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L104" class="blob-num js-line-number" data-line-number="104"></td>
        <td id="file-telegram_bot-LC104" class="blob-code blob-code-inner js-file-line">        handled = true;</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L105" class="blob-num js-line-number" data-line-number="105"></td>
        <td id="file-telegram_bot-LC105" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L106" class="blob-num js-line-number" data-line-number="106"></td>
        <td id="file-telegram_bot-LC106" class="blob-code blob-code-inner js-file-line">	//       ,      text2command</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L107" class="blob-num js-line-number" data-line-number="107"></td>
        <td id="file-telegram_bot-LC107" class="blob-code blob-code-inner js-file-line">    if (!handled) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L108" class="blob-num js-line-number" data-line-number="108"></td>
        <td id="file-telegram_bot-LC108" class="blob-code blob-code-inner js-file-line">        sendTo('text2command.0', {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L109" class="blob-num js-line-number" data-line-number="109"></td>
        <td id="file-telegram_bot-LC109" class="blob-code blob-code-inner js-file-line">            text: command.replace(/\//g, '#').replace(/_/g, ' '),</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L110" class="blob-num js-line-number" data-line-number="110"></td>
        <td id="file-telegram_bot-LC110" class="blob-code blob-code-inner js-file-line">            id: chat_id,</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L111" class="blob-num js-line-number" data-line-number="111"></td>
        <td id="file-telegram_bot-LC111" class="blob-code blob-code-inner js-file-line">            user: user</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L112" class="blob-num js-line-number" data-line-number="112"></td>
        <td id="file-telegram_bot-LC112" class="blob-code blob-code-inner js-file-line">        }, function (response) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L113" class="blob-num js-line-number" data-line-number="113"></td>
        <td id="file-telegram_bot-LC113" class="blob-code blob-code-inner js-file-line">            if (response &amp;&amp; response.response) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L114" class="blob-num js-line-number" data-line-number="114"></td>
        <td id="file-telegram_bot-LC114" class="blob-code blob-code-inner js-file-line">                sendTo('telegram.0', {user: user, text: response.response});</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L115" class="blob-num js-line-number" data-line-number="115"></td>
        <td id="file-telegram_bot-LC115" class="blob-code blob-code-inner js-file-line">            }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L116" class="blob-num js-line-number" data-line-number="116"></td>
        <td id="file-telegram_bot-LC116" class="blob-code blob-code-inner js-file-line">        });</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L117" class="blob-num js-line-number" data-line-number="117"></td>
        <td id="file-telegram_bot-LC117" class="blob-code blob-code-inner js-file-line">    }</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L118" class="blob-num js-line-number" data-line-number="118"></td>
        <td id="file-telegram_bot-LC118" class="blob-code blob-code-inner js-file-line">});</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L119" class="blob-num js-line-number" data-line-number="119"></td>
        <td id="file-telegram_bot-LC119" class="blob-code blob-code-inner js-file-line">//   ,   </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L120" class="blob-num js-line-number" data-line-number="120"></td>
        <td id="file-telegram_bot-LC120" class="blob-code blob-code-inner js-file-line">on({id: /^mqtt\.0\.PLC55_Lighting\.lighting\..*$/, ack: true, change: 'ne'}, function (obj) {</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L121" class="blob-num js-line-number" data-line-number="121"></td>
        <td id="file-telegram_bot-LC121" class="blob-code blob-code-inner js-file-line">    sendLightMenu(" ");</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L122" class="blob-num js-line-number" data-line-number="122"></td>
        <td id="file-telegram_bot-LC122" class="blob-code blob-code-inner js-file-line">});</td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L123" class="blob-num js-line-number" data-line-number="123"></td>
        <td id="file-telegram_bot-LC123" class="blob-code blob-code-inner js-file-line">//       </td>
      </tr>
      <tr>
        <td id="file-telegram_bot-L124" class="blob-num js-line-number" data-line-number="124"></td>
        <td id="file-telegram_bot-LC124" class="blob-code blob-code-inner js-file-line">sendLightMenu("");</td>
      </tr>
</tbody></table>


  </div>

  </div>
</div>

      </div>
      <div class="gist-meta">
        <a href="" style="float:right">view raw</a>
        <a href="">telegram_bot</a>
        hosted with ‚ù§ by <a href="">GitHub</a>
      </div>
    </div>
</div>
</div><br><br>  Le r√©sultat devrait √™tre quelque chose comme ceci: <br><br><img src="https://habrastorage.org/webt/wm/kw/dj/wmkwdjedebx86h6ujqutsik93sa.png"><br><br><h4>  Conclusion </h4><br>  L'article s'est av√©r√© long, mais j'esp√®re qu'il est utile, et peut-√™tre qu'il facilitera la vie de certains utilisateurs ou encouragera quelqu'un √† cr√©er sa propre maison intelligente. <br>  En ce moment, mon syst√®me de maison intelligente bas√© sur ioBroker tourne depuis 4 ans et j'en suis tr√®s satisfait.  En plus de ZigBee, plusieurs contr√¥leurs maison via MQTT et HTTP y sont √©galement connect√©s pour contr√¥ler l'√©clairage, la ventilation et d'autres syst√®mes, un r√©seau de capteurs de temp√©rature sur le bus 1 fil, un dispositif de surveillance de l'alimentation sur le bus RS485 et le protocole RTU Modbus, et bien plus encore. <br><br>  Dans ma tirelire de solutions pour une maison intelligente, j'ai accumul√© de nombreuses id√©es, m√™me si, probablement, elles devraient √™tre per√ßues davantage comme une tirelire de probl√®mes pour une maison intelligente (ceux qui comprennent le sujet de ce que je veux dire).  Laissez vos souhaits dans les commentaires pour m'aider √† d√©cider du sujet du prochain article. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433340/">https://habr.com/ru/post/fr433340/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433330/index.html">R√©solvez les mots crois√©s japonais avec SAT Solver</a></li>
<li><a href="../fr433332/index.html">Prise en charge de Python dans Azure Functions</a></li>
<li><a href="../fr433334/index.html">Comportements XAML pour WPF est d√©sormais Open Source</a></li>
<li><a href="../fr433336/index.html">L'impl√©mentation de la biblioth√®que babylonienne</a></li>
<li><a href="../fr433338/index.html">Pr√©sentation du fabricant d'imprimantes 3D Creality</a></li>
<li><a href="../fr433342/index.html">Un autre processeur Verilog simple</a></li>
<li><a href="../fr433344/index.html">Deux succ√®s de l'espace priv√©</a></li>
<li><a href="../fr433346/index.html">Passer de Redshift √† ClickHouse</a></li>
<li><a href="../fr433348/index.html">DSL typ√© en TypeScript de JSX</a></li>
<li><a href="../fr433350/index.html">√âv√©nements num√©riques √† Moscou du 17 au 23 d√©cembre</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>