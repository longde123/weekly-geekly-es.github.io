<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💂🏼 🍦 👶🏼 Adblock für Radio 🏦 🤰🏾 🔏</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Der Autor des Artikels ist der polnische Programmierer Tomek Rekavek, der das Jackrabbit Oak- Projekt im Rahmen der Apache Software Foundation für Ado...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Adblock für Radio</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/415469/">  <font color="gray">Der Autor des Artikels ist der polnische Programmierer Tomek Rekavek, der das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Jackrabbit Oak-</a> Projekt im Rahmen der Apache Software Foundation für Adobe entwickelt.</font>  <font color="gray">Der Artikel wurde am 24. Februar 2016 im persönlichen Blog des Autors veröffentlicht.</font> <br><br>  Das polnische „Radio-3“ (die sogenannte „Troika“) ist berühmt für gute Musik und intelligente Moderatoren.  Auf der anderen Seite leidet es unter dem Vorhandensein von lauten und nervigen Anzeigenblöcken in Sendungen, die normalerweise für irgendeine Art von Elektronik oder Medizin werben.  Ich höre Troika fast ständig bei der Arbeit und zu Hause und habe mich gefragt: Wie entferne ich Anzeigen?  Ich glaube, ich habe es geschafft, eine Lösung zu finden. <br><br><h2>  Digitale Signalverarbeitung </h2><br>  Mein Ziel ist es, eine Anwendung zu erstellen, die Anzeigen stummschaltet.  Der kommerzielle Block <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">beginnt</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">endet mit</a> Jingles, daher sollte das Programm diese spezifischen Sounds erkennen und den Sound zwischen ihnen ausschalten. <br><br>  Ich weiß, dass dieser Bereich der Mathematik / Informatik als <i>digitale Signalverarbeitung bezeichnet wird</i> , aber DSP schien mir immer magisch.  Nun, eine großartige Gelegenheit, etwas Neues zu lernen.  Ich habe ein oder zwei Tage damit verbracht, herauszufinden, mit welchem ​​Mechanismus der Audiostream analysiert werden soll.  Und am Ende habe ich gefunden, was ich brauchte: Es ist <i>Kreuzkorrelation</i> oder Kreuzkorrelation (Kreuzkorrelation). <br><a name="habracut"></a><br><h2>  Oktave </h2><br>  Normalerweise bezieht sich jeder auf die Implementierung von MATLAB.  MATLAB ist jedoch eine teure Anwendung, die die Ausführung komplexer mathematischer Operationen, einschließlich DSP, vereinfacht.  Glücklicherweise gibt es eine kostenlose Alternative namens <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Octave</a> .  Es scheint, dass es in Octave einfach ist, eine Kreuzkorrelation für zwei Audiodateien durchzuführen.  Es müssen nur die folgenden Befehle ausgeführt werden: <br><br><pre><code class="matlab hljs">pkg load signal jingle = wavread(<span class="hljs-string"><span class="hljs-string">'jingle.wav'</span></span>)(:,<span class="hljs-number"><span class="hljs-number">1</span></span>); audio = wavread (<span class="hljs-string"><span class="hljs-string">'audio.wav'</span></span>)(:,<span class="hljs-number"><span class="hljs-number">1</span></span>); [R, lag] = xcorr(jingle, audio); <span class="hljs-built_in"><span class="hljs-built_in">plot</span></span>(R);</code> </pre> <br>  Sie erhalten folgende Tabelle: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1db/aaa/43d/1dbaaa43df7a6a696836208158e085f4.png"><br><br>  Ein Peak ist deutlich sichtbar, der die Position von <code>jingle.wav</code> in <code>audio.wav</code> .  Was mich überrascht hat, war die Einfachheit der Methode: <code>xcorr()</code> erledigt die ganze Arbeit, der Rest des Codes dient nur zum Lesen von Dateien und zum Anzeigen des Ergebnisses. <br><br>  Ich wollte den gleichen Algorithmus in Java implementieren, und dann werde ich ein Tool haben, das: <br><br><ol><li>  liest den Audiostream vom Standardeingang (z. B. von ffmpeg), </li><li>  analysiert es auf der Suche nach Jingles, </li><li>  druckt denselben Stream auf stdout und / oder deaktiviert ihn. </li></ol><br>  Mit stdin und stdout können Sie den neuen <i>Analysator</i> an andere Anwendungen anschließen, die für die Audioübertragung und Wiedergabe des Ergebnisses verantwortlich sind. <br><br><h2>  Audiodateien lesen </h2><br>  Das erste, was ein Java-Programm lesen sollte, ist ein Jingle (als <code>.wav</code> Datei gespeichert) in einem Array.  Die Datei enthält einige zusätzliche Informationen wie Header, Metadaten und mehr, aber wir benötigen nur Sound.  Ein geeignetes Format heißt PCM, es ist nur eine Liste von Zahlen, die Töne darstellen.  WAV in PCM konvertieren kann ffmpeg: <br><br><pre> <code class="java hljs">ffmpeg -i input.wav -f s16le -acodec pcm_s16le output.raw</code> </pre> <br>  Hier wird jeder Abtastwert als 16-Bit-Zahl mit umgekehrter Bytereihenfolge (Little Endian) gespeichert.  In Java wird diese Nummer als <code>short</code> der <code>ByteBuffer</code> Klasse können Sie den <code>ByteBuffer</code> automatisch in eine Liste mit <code>short</code> Werten konvertieren: <br><br><pre> <code class="hljs axapta">ByteBuffer buf = ByteBuffer.allocate(<span class="hljs-number"><span class="hljs-number">4</span></span>); buf.<span class="hljs-keyword"><span class="hljs-keyword">order</span></span>(ByteOrder.LITTLE_ENDIAN); buf.put(bytes); <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> leftChannel = buf.readShort(); <span class="hljs-comment"><span class="hljs-comment">// stereo stream short rightChannel = buf.readShort();</span></span></code> </pre> <br><h2>  Xcorr Reverse Engineering </h2><br>  Um die Funktion <code>xcorr()</code> in Java zu implementieren, habe ich den Octave- <a href="">Quellcode untersucht</a> .  Ohne das Endergebnis zu ändern, konnte ich den Aufruf von xcorr () durch die folgenden Zeilen ersetzen - sie müssen in Java neu geschrieben werden: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">N</span></span> = length(audio); <span class="hljs-attribute"><span class="hljs-attribute">M</span></span> = <span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> nextpow2(<span class="hljs-number"><span class="hljs-number">2</span></span> * N - <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-attribute"><span class="hljs-attribute">pre</span></span> = fft(postpad(prepad(jingle(:), length(jingle) + N - <span class="hljs-number"><span class="hljs-number">1</span></span>), M)); <span class="hljs-attribute"><span class="hljs-attribute">post</span></span> = fft(postpad(audio(:), M)); <span class="hljs-attribute"><span class="hljs-attribute">cor</span></span> = ifft(pre .* conj(post)); <span class="hljs-attribute"><span class="hljs-attribute">R</span></span> = real(cor(<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span> * N));</code> </pre> <br>  Es sieht beängstigend aus, aber die meisten Funktionen sind triviale Operationen mit Arrays.  Die Kreuzkorrelation basiert auf der Anwendung der <i>schnellen Fourier-Transformation</i> auf ein Klangbeispiel. <br><br><h2>  Schnelle Fourier-Transformation </h2><br>  Als Person, die keine Erfahrung mit DSP hat, sehe ich FFT nur als eine Funktion, die ein Array mit einer Beschreibung eines Klangbeispiels verwendet - und ein Array mit komplexen Zahlen zurückgibt, die Frequenzen darstellen.  Dieser minimalistische Ansatz hat gut funktioniert: Ich habe die FFT-Implementierung aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">JTransforms-</a> Paket <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gestartet</a> und die gleichen Ergebnisse wie in Octave erzielt.  Ich denke, das ist teilweise ein <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Frachtkult</a> , aber verdammt, es funktioniert! <br><br><h2>  Xcorr in einem Thread ausführen </h2><br>  Der obige Algorithmus geht davon aus, dass <code>audio</code> das Array ist, in dem wir nach <code>jingle</code> suchen.  Dies ist nicht ganz für den Rundfunk geeignet, bei dem wir einen kontinuierlichen Tonstrom haben.  Um die Analyse auszuführen, habe ich einen zyklischen Puffer erstellt, der etwas länger ist als die Dauer des zu erkennenden Jingles.  Der eingehende Stream füllt den Puffer und sobald er voll ist, wird der Kreuzkorrelationstest ausgeführt.  Wenn nichts gefunden wird, wird der älteste Teil des Puffers verworfen - und wir erwarten erneut, dass er gefüllt wird. <br><br>  Ich habe ein wenig mit der Länge des Puffers experimentiert und die besten Ergebnisse mit einer Puffergröße erzielt, die das 1,5-fache der Größe des Jingles beträgt. <br><br><h2>  Alles zusammenfügen </h2><br>  Das Abrufen eines Streams im PCM-Format ist einfach.  Dies kann mit dem obigen <code>ffmpeg</code> .  Der folgende Befehl leitet den Stream zur Standard- <code>java</code> Eingabe um und gibt dann <code>Got jingle 0</code> oder <code>Got jingle 1</code> wenn das entsprechende Muster im Stream gefunden wird. <br><br><pre> <code class="hljs powershell">ffmpeg <span class="hljs-literal"><span class="hljs-literal">-loglevel</span></span> <span class="hljs-literal"><span class="hljs-literal">-8</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-i</span></span> http://stream3.polskieradio.pl:<span class="hljs-number"><span class="hljs-number">8904</span></span>/\;stream \ <span class="hljs-operator"><span class="hljs-operator">-f</span></span> s16le <span class="hljs-literal"><span class="hljs-literal">-acodec</span></span> pcm_s16le - \ | java <span class="hljs-literal"><span class="hljs-literal">-jar</span></span> target/analyzer<span class="hljs-literal"><span class="hljs-literal">-1</span></span>.<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-literal"><span class="hljs-literal">-SNAPSHOT</span></span><span class="hljs-literal"><span class="hljs-literal">-jar</span></span><span class="hljs-literal"><span class="hljs-literal">-with</span></span><span class="hljs-literal"><span class="hljs-literal">-dependencies</span></span>.jar \ <span class="hljs-number"><span class="hljs-number">2</span></span> \ src/test/resources/commercial<span class="hljs-literal"><span class="hljs-literal">-start</span></span><span class="hljs-literal"><span class="hljs-literal">-44</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>k.raw <span class="hljs-number"><span class="hljs-number">500</span></span> \ src/test/resources/commercial<span class="hljs-literal"><span class="hljs-literal">-end</span></span><span class="hljs-literal"><span class="hljs-literal">-44</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>k.raw <span class="hljs-number"><span class="hljs-number">700</span></span></code> </pre> <br><h2>  Standalone-Version </h2><br>  Ich habe auch eine einfache Standalone-Version des Analysators vorbereitet, die selbst eine Verbindung zum Troika-Stream (ohne externes <code>ffmpeg</code> ) herstellt und das Ergebnis mit <code>javax.sound</code> .  Alles passt in eine einzelne JAR-Datei und enthält eine grundlegende Benutzeroberfläche mit den Tasten Star und Stop.  Es kann hier heruntergeladen <a href="">werden</a> .  Wenn Sie nicht gerne die JARs anderer Personen auf Ihrem Computer ausführen (was absolut korrekt ist), befinden sich alle Quellen auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/468/6e2/c69/4686e2c69e432bcd3fec6576302021c1.png"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Alles</a> scheint so <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zu funktionieren wie es sollte</a> :) <br><br><h2>  Weitere Arbeit </h2><br>  Das ultimative Ziel besteht darin, Anzeigen auf der Ebene eines Hardwareverstärkers zu deaktivieren und ein „echtes“ FM-Signal und keinen Internet-Stream zu empfangen.  Dies wird im <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">nächsten Artikel beschrieben</a> . <br><br><h2>  Update (Juni 2018) </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Diskussion bei Hacker News</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Diskussion über Wykop</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Diskussion über Reddit</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de415469/">https://habr.com/ru/post/de415469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de415459/index.html">Hat Chinesisch Aberglauben?</a></li>
<li><a href="../de415461/index.html">OpenAI macht Fortschritte in Dota 2: Semiprofessionelle Teams besiegt</a></li>
<li><a href="../de415463/index.html">HPE Superdome Flex: Ein neues Maß an Leistung und Skalierung</a></li>
<li><a href="../de415465/index.html">Wie viele Leben haben Elektrolyte, alte Kleidung und Flaschenverschlüsse?</a></li>
<li><a href="../de415467/index.html">Programmierwettbewerb: Handel (Ankündigungen)</a></li>
<li><a href="../de415471/index.html">Erweiterung PHP und Kotlin Native. Teil eins, naiv</a></li>
<li><a href="../de415473/index.html">Wer scannt das Internet? Zeit, Eisen zu schmieden</a></li>
<li><a href="../de415475/index.html">Analyse von Legacy-Code bei Verlust des Quellcodes: zu tun oder nicht zu tun?</a></li>
<li><a href="../de415477/index.html">Überwachung des Betriebs von Vorort-Heimsystemen: Die ersten Schritte zu einem Smart Home</a></li>
<li><a href="../de415481/index.html">Venezuela blockiert direkte Verbindungen nach Tor und verschleiert den Verkehr zu Brücken</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>