<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üö¥üèæ üêÄ üîÅ OpenVPN, dont vous saviez si peu üåü ‚ô¶Ô∏è üßóüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="OpenVPN, combien dans ce mot. Un serveur VPN open source gratuit, multiplateforme et configurable de mani√®re flexible, qui est en fait la norme de fac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>OpenVPN, dont vous saviez si peu</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435802/"><p>  OpenVPN, combien dans ce mot.  Un serveur VPN open source gratuit, multiplateforme et configurable de mani√®re flexible, qui est en fait la norme de facto pour organiser l'acc√®s aux r√©seaux d'entreprise internes.  La plupart des administrateurs l'utilisent avec des param√®tres par d√©faut ou avec des configurations typiques qui sont largement d√©crites dans diff√©rents HOW-TO.  Mais OpenVPN est-il aussi simple qu'il y para√Æt √† premi√®re vue?  Dans cet article, nous consid√©rerons les m√©canismes internes d'OpenVPN, cach√©s aux yeux, qui changent radicalement l'id√©e de ses capacit√©s. </p><a name="habracut"></a><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le</a> serveur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">OpenVPN</a> est distribu√© sous forme de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">code source</a> ou de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">packages compil√©s</a> pr√™ts √† installer pour diff√©rents syst√®mes d'exploitation.  OpenSSL est utilis√© comme une biblioth√®que fournissant le cryptage. </p><br><p> La plupart des configurations de connexion des clients au serveur, ainsi qu'entre les serveurs, impliquent l'utilisation d'un tas de cl√©s priv√©es ou priv√©es / publiques pour assurer la s√©curit√© du trafic interne.  Pour les r√©seaux d'entreprise en mode MultiPoint-To-SinglePoint, une autorit√© de certification PKI est g√©n√©ralement utilis√©e, ce qui est facile √† construire en utilisant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">easy-rsa</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">XCA</a> .  Pour la communication inter-serveur point √† point, une configuration √† cl√© partag√©e est principalement utilis√©e.  Rappelez-vous les m√©canismes et capacit√©s de base bien connus. </p><br><h1 id="osnovnye-mehanizmy-i-vozmozhnosti">  M√©canismes et capacit√©s cl√©s </h1><br><ul><li><h3 id="sertifikatnaya-autentifikaciya">  Authentification par certificat </h3><br><p>  Une √©norme quantit√© de documentation a √©t√© √©crite √† ce sujet.  Le point est simple.  Une autorit√© de certification est en cours de cr√©ation qui √©met des certificats utilisateur.  √Ä l'aide d'une autorit√© de certification, un contr√¥le est fourni pour connecter les utilisateurs au serveur OpenVPN.  Lorsque le certificat expire ou est r√©voqu√©, l'acc√®s utilisateur est bloqu√©.  Les cl√©s priv√©es avec un mot de passe d√©fini dessus, √©mises conjointement avec le certificat, offrent une s√©curit√© contre les connexions non autoris√©es aux ressources internes. </p><br></li><li><h3 id="privatnye-point-to-point-klyuchi">  Cl√©s point √† point priv√©es </h3><br><p>  Du point de vue de la connexion d'un seul utilisateur / serveur aux ressources de l'entreprise, un sch√©ma avec des cl√©s priv√©es est utilis√©.  Une cl√© est g√©n√©r√©e sur l'un des h√¥tes, qui est partag√©e entre le serveur et le client. </p><br></li></ul><br><p>  Dans tous les cas de connexion pour la s√©curit√© de la "prise de contact" entre le client et le serveur, le protocole Diffie-Hellmann est utilis√©. </p><br><ul><li><h3 id="vneshnyaya-autentifikaciya-polzovateley">  Authentification des utilisateurs externes </h3><br><p>  Pour simplifier le contr√¥le des connexions utilisateur, au lieu d'un sch√©ma avec sa propre PKI, vous pouvez utiliser un sch√©ma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avec authentification externe des utilisateurs par login / mot de passe</a> .  Ce sch√©ma est pratique pour authentifier les utilisateurs par, par exemple, un identifiant / mot de passe de domaine.  Pour se connecter au serveur, le certificat de serveur et la cl√© de signature de paquet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">HARDENING OPENVPN SECURITY</a> sont ajout√©s au fichier de configuration client. <br>  exemple de configuration client </p><br><pre><code class="plaintext hljs">dev tun proto udp #  IP  OpenVPN remote 172.16.111.166 # Port  port 1200 client resolv-retry infinite tls-client key-direction 1 auth SHA1 cipher BF-CBC #comp-lzo persist-key persist-tun # auth-user-pass c:/temp/pass.txt # # just create a file with name pass.txt # and put to it two lines # ------------- #username #password # ------------- #auth-user-pass verb 3 &lt;ca&gt; -----BEGIN CERTIFICATE----- MIIE5jCCA86gAwIBAgIJAOt3kFH7PxA0MA0GCSqGSIb3DQEBCwUAMIGjMQswCQYD .... -----END CERTIFICATE----- &lt;/ca&gt; &lt;tls-auth&gt; -----BEGIN OpenVPN Static key V1----- 83ddd29fa82212f3059d85a41490134c .... a4f2c7df3a22364a49093bca102dedeb -----END OpenVPN Static key V1----- &lt;/tls-auth&gt;</code> </pre> <br><p>  Une partie de la configuration du serveur pour l'authentification du client via un fichier <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Utilisation de m√©thodes d'authentification alternatives</a> </p><br><pre> <code class="plaintext hljs">verify-client-cert none #client-cert-not-required username-as-common-name tls-server tls-auth /usr/local/etc/openvpn/ssl/tlsauth.key key-direction 0 tls-timeout 120 auth SHA1 cipher BF-CBC auth-user-pass-verify /usr/local/etc/openvpn/auth/auth-static-file.pl via-file</code> </pre> <br><p>  Ce sch√©ma est pratique, mais tr√®s dangereux. </p><br></li><li><h3 id="pam">  PAM </h3><br><p>  Pour augmenter la s√©curit√©, vous pouvez utiliser des plug-ins qui fournissent une v√©rification de connexion / mot de passe dans les syst√®mes externes.  La m√©thode la plus courante est le syst√®me PAM (Pluggable Authentication Modules). <br>  Ajoutez la ligne au fichier de configuration OpenVPN </p><br><pre> <code class="plaintext hljs">plugin /usr/share/openvpn/plugin/lib/openvpn-auth-pam.so login</code> </pre> <br></li><li><h3 id="marshrutizaciya">  Acheminement </h3><br><p>  Parce que  la t√¢che principale du serveur est de fournir aux utilisateurs / serveurs distants un acc√®s aux ressources internes, le serveur vous permet de d√©terminer le routage statique des clients vers le serveur et du serveur vers les clients.  Du point de vue de l'acc√®s client aux ressources internes, le serveur utilisant DHCP et les directives "route" ou "push route" permet de transf√©rer des routes r√©seau internes au client.  Pour notifier le serveur lui-m√™me des r√©seaux distants c√¥t√© client, le "r√©pertoire de configuration client" (ccd) est utilis√©, un m√©canisme qui permet d'utiliser la directive "iroute" pour d√©crire la liste des r√©seaux internes client qui doivent se trouver dans la table de routage du serveur pour acheminer le trafic vers eux. </p><br></li></ul><br><p>  Sur cette fin ¬´r√©guli√®re¬ª des fonctionnalit√©s largement utilis√©es et la personnalisation locale pour chaque cas sp√©cifique commence. </p><br><h1 id="dopolnitelnye-vozmozhnosti-openvpn">  Fonctionnalit√©s OpenVPN suppl√©mentaires </h1><br><p>  Consid√©rez les fonctionnalit√©s suppl√©mentaires d'OpenVPN, dont quelqu'un a peut-√™tre entendu parler, mais en r√©alit√© n'a pas vu ou utilis√©. </p><br><ul><li><h3 id="bezopasnost-seteypacket-filtering">  S√©curit√© r√©seau / filtrage de paquets </h3><br><p>  Parce que  OpenVPN achemine le trafic, il a deux modes de fonctionnement r√©guliers mutuellement exclusifs.  Le premier mode est le routage √† l'int√©rieur du serveur OpenVPN, le deuxi√®me mode est le routage nucl√©aire inter-interface.  Dans le premier cas, OpenVPN est responsable de la commutation et du filtrage des paquets entre les clients / r√©seaux, dans le second cas, tout filtre de paquets syst√®me pris en charge sur l'h√¥te (pf, iptables, etc.). <br>  Peu de gens savent qu'OpenVPN poss√®de un filtre de paquets int√©gr√© qui vous permet d'autoriser ou d'isoler les connexions entre les utilisateurs et les r√©seaux. <br>  Oui oui  Vous avez bien lu.  OpenVPN a son propre filtre de paquets int√©gr√©.  La possibilit√© de filtrer le trafic a √©t√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mise en place en 2010</a> . <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le filtre de paquets OpenVPN est</a> contr√¥l√© soit via l'interface de gestion, soit via des plug-ins connect√©s √† OpenVPN. <br>  Les r√®gles de circulation sont g√©r√©es via un fichier.  Le format de fichier est simple. </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP|ACCEPT] {+|-}common_name1 {+|-}common_name2 . . . [SUBNETS DROP|ACCEPT] {+|-}subnet1 {+|-}subnet2 . . . [END]</code> </pre> <br><p>  Les directives de bloc (ACCEPT / DENY) d√©finissent l'action par d√©faut pour tous les clients non sp√©cifi√©s √† l'int√©rieur du bloc. <br>  Par exemple, fichier pour le client user2 </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP] +user1 [SUBNETS DROP] [END]</code> </pre> <br><p>  bloquera le trafic vers tous les utilisateurs et r√©seaux, mais autorisera le trafic vers le c√¥t√© client1.  Si user1 ne d√©crit pas explicitement l'autorisation de transf√©rer le trafic vers user2, alors le trafic ira seulement dans une direction user2-&gt; user1. </p><br></li></ul><br><p>  Ou un autre exemple. <br>  Tout d√©sactiver sauf l'acc√®s entre les utilisateurs et le serveur DNS situ√© sur le r√©seau local et le circuit de test sur le r√©seau 192.168.0.0/24 </p><br><pre> <code class="plaintext hljs">[CLIENTS DROP] +user1 +user2 [SUBNETS DROP] +10.150.0.1 +10.150.1.1 +192.168.0.0/24 [END]</code> </pre> <br><p>  Le m√©canisme de filtrage est activ√© via le fichier de configuration, ou lors de la connexion du plugin qui "positionne" le drapeau "OPENVPN_PLUGIN_ENABLE_PF". <br>  Nous discuterons de cette opportunit√© plus tard. <br>  Le deuxi√®me mode de filtrage du trafic est le filtre de paquets int√©gr√© au syst√®me.  Pour l'activer, la configuration ne doit pas avoir de directive "client √† client".  Du point de vue de l'automatisation de l'activation / d√©sactivation des r√®gles n√©cessaires lors de la connexion / d√©connexion des clients, il est plus pratique d'utiliser des insertions distinctes dans la liste des r√®gles, impl√©ment√©es soit via CHAINS dans Iptables (Linux) ou dans Anchors dans PF (FreeBSD).  L'activation / d√©sactivation des r√®gles se fait g√©n√©ralement via les directives client-connect / client-d√©connect du fichier de configuration du serveur, qui appellent les scripts correspondants lorsque l'utilisateur se connecte / se d√©connecte. </p><br><ul><li><h3 id="rasshirennaya-pam-autentifikaciya">  Authentification PAM avanc√©e </h3><br><p>  L'authentification PAM √©tendue signifie changer la logique de la connexion de l'utilisateur et la v√©rification du mot de passe.  Ceci est r√©alis√© soit en installant les plug-ins appropri√©s pour OpenVPN, qui fournissent la lecture et la v√©rification des donn√©es dans des sources externes, soit en connectant des biblioth√®ques au syst√®me qui permettent √† toute logique d'√™tre script√©e.  L'une de ces biblioth√®ques est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">pam_python</a> , qui aide √† scripter toute logique de v√©rification de connexion / mot de passe via des scripts Python. <br>  S'il est utilis√©, la cha√Æne de v√©rification de l'utilisateur change comme suit. </p><br><pre> <code class="plaintext hljs">plugin openvpn-plugin-auth-pam.so pam_python login USERNAME password PASSWORD domain mydomain.com</code> </pre> <br><p>  Les ¬´sous le capot¬ª de PAM √©tant les algorithmes de dialogue du syst√®me avec l'utilisateur ou les biblioth√®ques externes, ces dialogues peuvent √™tre contr√¥l√©s.  Par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">connectez les jetons OTP au syst√®me</a> .  La biblioth√®que LinOTP est simplement prise comme exemple, car  J'ai perdu ma propre biblioth√®que auto-√©crite lors des tests quelque part ¬Ø \ <em>(„ÉÑ)</em> / ¬Ø <br>  En outre, des exemples sont facilement googl√© par le mot "pam_python". <br>  Le principal probl√®me lorsque vous travaillez avec des modules PAM externes est l'impossibilit√© d'obtenir l'environnement de session OpenVPN √† l'int√©rieur du Python appel√© ou de tout autre script appel√© via le pam syst√®me.  C'est-√†-dire  le script ne fournit que les fonctions de v√©rification du login / mot de passe qui lui sont attribu√©es. </p><br></li><li><h3 id="otlozhennaya-autentifikaciya">  Authentification diff√©r√©e </h3><br><p>  Le serveur OpenVPN prend en charge l'authentification dite "diff√©r√©e".  L'authentification ¬´diff√©r√©e¬ª est utilis√©e dans les cas o√π le service d'authentification ne peut pas traiter la demande de v√©rification de connexion / mot de passe en temps r√©el. </p><br></li><li><h3 id="plaginy-openvpn">  Plugins OpenVPN </h3><br><p>  Il s'agit d'un univers parall√®le s√©par√©, sur lequel il peut √™tre connu, mais en raison d'une certaine confusion, ils ne peuvent pas ou ont peur d'utiliser.  En effet, √©crire un plug-in fonctionnel pour OpenVPN n√©cessite une programmation en C avec tout ce que cela implique.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Des exemples de plugins simples sont inclus dans l'arborescence source d'OpenVPN,</a> ou par exemple, il existe un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin pour d√©montrer les appels de m√©thode depuis OpenVPN</a> . </p><br></li></ul><br><p>  Essayons de comprendre comment les plugins fonctionnent √† partir d'OpenVPN. <br>  Les fonctions et param√®tres utilis√©s pour travailler avec les plugins sont d√©crits dans un <a href="">fichier</a> s√©par√© <br>  La t√¢che principale du plugin, lorsqu'il est initialis√© par le serveur OpenVPN, est de transf√©rer la liste des fonctions prises en charge par le plugin et, lors de l'appel de l'une des fonctions, de renvoyer le code de r√©ponse correct, qui sera clair pour le serveur. </p><br><pre> <code class="plaintext hljs">#define OPENVPN_PLUGIN_FUNC_SUCCESS 0 #define OPENVPN_PLUGIN_FUNC_ERROR 1 #define OPENVPN_PLUGIN_FUNC_DEFERRED 2</code> </pre> <br><p>  Arr√™tons-nous plus en d√©tail sur chaque groupe.  Nous consid√©rerons la logique de travail bas√©e sur l'authentification par mot de passe de l'utilisateur. <br>  Au d√©marrage du serveur, apr√®s lecture du fichier de configuration, le serveur appelle les fonctions OPENVPN_PLUGIN_UP et OPENVPN_PLUGIN_ROUTE_UP.  Dans l'environnement variable des fonctions appel√©es, les principaux param√®tres du serveur en cours d'ex√©cution sont transf√©r√©s. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_UP { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><pre> <code class="json hljs">OPENVPN_PLUGIN_ROUTE_UP { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Ces fonctions peuvent √™tre utilis√©es pour les alertes au d√©marrage du serveur ou les changements de configuration. <br>  Lors de la connexion d'un client, OpenVPN demande la possibilit√© d'activer un filtre de paquets interne. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_ENABLE_PF { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"11"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Comme vous pouvez le voir sur le vidage, la variable pf_file est apparue.  Ce fichier doit contenir les r√®gles du filtre de paquets interne pour la session en cours de traitement. <br>  Ensuite, le nom d'utilisateur et le mot de passe de l'utilisateur sont v√©rifi√©s dans la fonction OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_AUTH_USER_PASS_VERIFY { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_a3d0650a43b88ca1b5f305ce2c8f682.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>:<span class="hljs-string"><span class="hljs-string">"12312312312312"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  C'est le seul endroit o√π le mot de passe dans l'environnement variable est pr√©sent en clair. <br>  Le r√©sultat de cette fonction devrait √™tre trois r√©ponses possibles. </p><br><pre> <code class="plaintext hljs">#define OPENVPN_PLUGIN_FUNC_SUCCESS 0 #define OPENVPN_PLUGIN_FUNC_ERROR 1 #define OPENVPN_PLUGIN_FUNC_DEFERRED 2</code> </pre> <br><p>  Si le serveur re√ßoit une r√©ponse OPENVPN_PLUGIN_FUNC_DEFERRED, alors le m√©canisme d'authentification "retard√©e" entre en action.  Comme on le voit, la variable "auth_control_file" est apparue dans l'environnement variable, le contenu de cette variable contient le nom du fichier dans lequel une r√©ponse du syst√®me d'authentification sera attendue.  La r√©ponse est le symbole 0 (pour autoriser l'acc√®s), 1 (pour refuser l'acc√®s) plac√© dans le fichier sp√©cifi√©.  Le param√®tre serveur "hand-window" d√©termine le d√©lai d'expiration en secondes, pendant lequel le serveur attendra une r√©ponse.  Pendant l'attente, le trafic provenant d'autres clients n'est pas interrompu. </p><br><p>  Puisque nous travaillons avec l'authentification par mot de passe, la fonction de v√©rification de certificat OPENVPN_PLUGIN_TLS_VERIFY n'est pas appel√©e.  Au lieu de cela, OPENVPN_PLUGIN_TLS_FINAL est appel√© imm√©diatement, confirmant l'√©tablissement de la session. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_TLS_FINAL { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1545994898"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_b7a18ca8fac838679ca87ada6b8a356.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_a3d0650a43b88ca1b5f305ce2c8f682.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"626"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Ensuite, l'appel OPENVPN_PLUGIN_IPCHANGE est appel√©, qui est appel√© avant de changer l'adresse IP du client. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_IPCHANGE { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_321bb12075dc0e1b5440d227220bac5d.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  La fonction OPENVPN_PLUGIN_CLIENT_CONNECT_V2 est appel√©e lorsque l'adresse IP est d√©finie par le serveur DHCP interne. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_CLIENT_CONNECT_V<span class="hljs-number"><span class="hljs-number">2</span></span> { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_ascii"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sat Jan 12 18:54:48 2019"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_321bb12075dc0e1b5440d227220bac5d.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_unix"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319288"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_local_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"9"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_remote_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Dans un environnement variable, des variables apparaissent contenant les param√®tres du tunnel "ifconfig_pool_local_ip" et "ifconfig_pool_remote_ip". </p><br><p>  La fonction OPENVPN_PLUGIN_LEARN_ADDRESS est appel√©e lorsque le serveur OpenVPN apprend la connexion des adresses IP et les achemine vers celles-ci.  Apr√®s avoir quitt√© cette fonction, la proc√©dure d'application des param√®tres de filtrage de paquets √† partir du fichier est activ√©e.  La variable d'environnement OPENVPN_PLUGIN_LEARN_ADDRESS correspond dans ce cas √† la phase OPENVPN_PLUGIN_CLIENT_CONNECT_V2. </p><br><pre> <code class="plaintext hljs">fa56bf61-.../172.16.111.168:1200 ----- pf_check_reload : struct pf_context ----- fa56bf61-.../172.16.111.168:1200 enabled=1 fa56bf61-.../172.16.111.168:1200 filename='/tmp/openvpn_pf_343330698e4acdea34c8a8c7fb87d861.tmp' fa56bf61-.../172.16.111.168:1200 file_last_mod=1547319124 fa56bf61-.../172.16.111.168:1200 n_check_reload=1 fa56bf61-.../172.16.111.168:1200 reload=[1,15,1547319125] fa56bf61-.../172.16.111.168:1200 ----- struct pf_set ----- fa56bf61-.../172.16.111.168:1200 kill=0 fa56bf61-.../172.16.111.168:1200 ----- struct pf_subnet_set ----- fa56bf61-.../172.16.111.168:1200 default_allow=ACCEPT fa56bf61-.../172.16.111.168:1200 ----- struct pf_cn_set ----- fa56bf61-.../172.16.111.168:1200 default_allow=DROP fa56bf61-.../172.16.111.168:1200 12345678-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 fa56bf61-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 ---------- fa56bf61-.../172.16.111.168:1200 fa56bf61-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 12345678-90da-11e8-bf33-005056a12a82-1234567 ACCEPT fa56bf61-.../172.16.111.168:1200 --------------------</code> </pre> <br><p>  Lorsqu'un client est d√©connect√©, la fonction OPENVPN_PLUGIN_CLIENT_DISCONNECT est appel√©e. </p><br><pre> <code class="json hljs">OPENVPN_PLUGIN_CLIENT_DISCONNECT { <span class="hljs-attr"><span class="hljs-attr">"route_netmask_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"255.255.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_gateway_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"link_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1622"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUB"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_start_time"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319280"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun150"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"common_name"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_ascii"</span></span>:<span class="hljs-string"><span class="hljs-string">"Sat Jan 12 18:54:48 2019"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bytes_received"</span></span>:<span class="hljs-string"><span class="hljs-string">"30893"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_NCP"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_remote"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZ4v2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.139"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"script_context"</span></span>:<span class="hljs-string"><span class="hljs-string">"init"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"untrusted_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.111.168"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"config"</span></span>:<span class="hljs-string"><span class="hljs-string">"/usr/local/etc/openvpn/server150.conf"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>:<span class="hljs-string"><span class="hljs-string">"fa56bf61-90da-11e8-bf33-005056a12a82-1234568"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"trusted_port"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pf_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_pf_4fcad505693b33f97c4fe105df8681cb.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_local"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tun_mtu"</span></span>:<span class="hljs-string"><span class="hljs-string">"1500"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auth_control_file"</span></span>:<span class="hljs-string"><span class="hljs-string">"/tmp/openvpn_acf_4bdddbada2885cde42cd3cb1b85d77e5.tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_COMP_STUBv2"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"verb"</span></span>:<span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PLAT"</span></span>:<span class="hljs-string"><span class="hljs-string">"win"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_pid"</span></span>:<span class="hljs-string"><span class="hljs-string">"52435"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_unix"</span></span>:<span class="hljs-string"><span class="hljs-string">"1547319288"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"redirect_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_vpn_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proto_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"udp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_net_gateway"</span></span>:<span class="hljs-string"><span class="hljs-string">"172.16.100.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_PROTO"</span></span>:<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"daemon_log_redirect"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"time_duration"</span></span>:<span class="hljs-string"><span class="hljs-string">"3781"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dev_type"</span></span>:<span class="hljs-string"><span class="hljs-string">"tun"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_VER"</span></span>:<span class="hljs-string"><span class="hljs-string">"2.4.3"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_LZO"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bytes_sent"</span></span>:<span class="hljs-string"><span class="hljs-string">"22684"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"remote_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_local_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.5"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pluginid"</span></span>:<span class="hljs-string"><span class="hljs-string">"7"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ifconfig_pool_remote_ip"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.6"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"local_port_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"1200"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"IV_TCPNL"</span></span>:<span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"route_network_1"</span></span>:<span class="hljs-string"><span class="hljs-string">"10.150.0.0"</span></span> }</code> </pre> <br><p>  Dans un environnement variable, la dur√©e de connexion et le trafic utilisateur sont ajout√©s. </p><br><p>  Comme vous pouvez le voir, en raison de l'abondance de donn√©es dans diff√©rents appels, l'√©criture et le d√©bogage d'un plug-in dans le langage de programmation C (C ++) sera une t√¢che assez longue. <br>  Pour √©tendre la fonctionnalit√©, il a √©t√© d√©cid√© de faire un "miracle" d'abord pour le projet interne, puis de le mettre dans le domaine public :) <br>  Apr√®s une longue lecture des codes source OpenVPN et divers exemples de plugins hautement sp√©cialis√©s, un projet a √©t√© √©crit qui utilise Python comme langage de programmation pour la logique de traitement de session.  Le code est un plug-in en langage C qui se connecte √† OpenVPN, qui envoie toutes les requ√™tes au plug-in, envoie le module √† Python via la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">r√©f√©rence c-api</a> . </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Proxy python du plugin OpenVPN</a> </p><br><h2 id="pochemu-python-modul-">  Pourquoi le module Python? </h2><br><p>  La r√©f√©rence c-api Python travaillant directement avec des fichiers python ne fonctionne pas correctement avec le chargement de biblioth√®ques python. </p><br><h2 id="kak-eto-rabotaet-">  Comment √ßa marche? </h2><br><p>  Lorsque le plugin est initialis√© dans OpenVPN, le plugin renvoie une liste masqu√©e de toutes les fonctions qu'il peut servir.  Lorsque la prochaine phase de connexion ou √©v√©nement interne se produit, OpenVPN appelle les fonctions correspondantes √† partir du plugin.  Le plugin convertit la variable d'environnement et les param√®tres pass√©s √† la fonction en une structure, initialise python et passe la structure √† la proc√©dure correspondante du module python.  La proc√©dure renvoie l'une des trois r√©ponses au plugin (0 - Succ√®s, 1 - Erreur, 2 - Diff√©r√©).  La r√©ponse est transform√©e et renvoy√©e par OpenVPN. </p><br><p>  Veuillez noter que tous les appels de module sont "sans √©tat", ce qui signifie que les proc√©dures ne se souviennent pas et ne savent pas ce qui s'est pass√© plus t√¥t dans les autres appels.  Vous ne pouvez vous concentrer que sur l'environnement variable transmis au plugin depuis OpenVPN. </p><br><p>  √Ä l'int√©rieur du module python, vous pouvez impl√©menter n'importe quelle logique en connectant les biblioth√®ques et les ressources n√©cessaires.  Si vous n'√™tes pas s√ªr de la vitesse des contr√¥les, utilisez les confirmations ¬´en attente¬ª. </p><br><p>  En utilisant le regroupement des utilisateurs connect√©s au service, gr√¢ce √† pf_file, vous pouvez r√©gler avec pr√©cision l'interaction r√©seau entre les utilisateurs et d'autres ressources.  √Ä son tour, en connectant le plug-in pour la surveillance, il sera toujours possible de g√©rer les sessions client via l'interface de gestion OpenVPN. </p><br><p>  Pendant les tests du projet, un m√©canisme de g√©n√©ration de mot de passe a √©t√© d√©velopp√©, similaire aux jetons jwt, mais avec une taille plus petite. </p><br><p>  Le point est simple.  Le jeton contient l'identifiant client et la date d'expiration de l'acc√®s.  Pour signer le jeton, HMAC_SHA1 avec une cl√© priv√©e est utilis√©.  Une fois le jeton sign√©, le contenu du texte est corrompu par la signature et converti en base64.  Ainsi, le "scellement" du jeton est obtenu.  Un jeton scell√© est utilis√© comme mot de passe de l'utilisateur.  Si un changement non autoris√© d'un bloc de donn√©es se produit, xor se casse, si xor se brise, alors la v√©rification de la signature se rompt.  Sans cl√© priv√©e, la signature ne peut pas √™tre modifi√©e. </p><br><p>  Si vous ne souhaitez pas contr√¥ler l'heure de validit√© du mot de passe avec vos mains, g√©n√©rez un tel jeton et v√©rifiez la validit√© √† l'int√©rieur du plugin sans appeler de services externes.  Ce sch√©ma est tr√®s pratique pour la g√©n√©ration de mot de passe de session pendant un certain temps.  Dans le m√™me temps, vous pouvez transf√©rer le contenu du jeton vers un syst√®me de contr√¥le externe et il se configurera pour d√©connecter l'utilisateur apr√®s l'expiration du jeton. </p><br><p>  J'esp√®re que les informations contenues dans cet article vous ont √©t√© utiles. <br>  Merci d'avoir pris le temps de le lire. <br>  Si vous avez des questions, je vais essayer de r√©pondre √† ce que je peux. </p><br><p>  ¬© Aborche 2019 <br><img src="https://habrastorage.org/getpro/habr/post_images/7c5/e49/ede/7c5e49ede95e47e91424dbb9bafbb7bb.jpg" alt="Aborche"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435802/">https://habr.com/ru/post/fr435802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435792/index.html">Ces mecs toxiques: ils empoisonnent les projets</a></li>
<li><a href="../fr435794/index.html">¬´Pourquoi avez-vous besoin de faire semblant rapidement¬ª: Steve Cotton de Bungie sur le processus cr√©atif dans l'entreprise</a></li>
<li><a href="../fr435796/index.html">A propos de la fa√ßon dont je suis pass√© de C # √† Elixir / Phoenix</a></li>
<li><a href="../fr435798/index.html">Sony WH-1000XM3 - le meilleur casque sans fil?</a></li>
<li><a href="../fr435800/index.html">Lettre du d√©cembriste 11</a></li>
<li><a href="../fr435804/index.html">Intel Cyclone n'enregistre pas la configuration apr√®s le red√©marrage</a></li>
<li><a href="../fr435806/index.html">Japon: des essais cliniques de patchwork de bio-ing√©nierie sur le c≈ìur annonc√©s</a></li>
<li><a href="../fr435810/index.html">Rejoignez la collection locale et DbSet dans Entity Framework</a></li>
<li><a href="../fr435812/index.html">Th√©orie du bonheur. La statistique comme moyen scientifique de ne rien savoir</a></li>
<li><a href="../fr435814/index.html">[The Old New Thing] Puis-je utiliser ma pile √† ma guise?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>