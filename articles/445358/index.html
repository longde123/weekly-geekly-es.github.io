<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêï üìÉ üèûÔ∏è Organizaci√≥n del sistema de eventos en Unity - a trav√©s de los ojos de un dise√±ador de juegos. üïé üßìüèΩ üßõüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos! 

 Me disculpo de antemano por el amateurismo, pero le√≠ un art√≠culo sobre c√≥mo una persona trat√≥ de lidiar con una conectividad de entid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Organizaci√≥n del sistema de eventos en Unity - a trav√©s de los ojos de un dise√±ador de juegos.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445358/">  Hola a todos! <br><br>  Me disculpo de antemano por el amateurismo, pero le√≠ un art√≠culo sobre c√≥mo una persona trat√≥ de lidiar con una conectividad de entidad excesiva en Unity, y pens√© que ser√≠a interesante hablar sobre mi bicicleta, que reun√≠ para crear prototipos de juegos como dise√±ador de juegos. <br><br>  Mi tarea era crear un sistema de eventos y mensajes de varias entidades, evitando la coherencia cuando cada objeto tiene una gran cantidad de enlaces a otros objetos. <br><br>  Como resultado, mi sistema me permite no hacer tales enlaces en absoluto.  Resuelve el problema principal: es conveniente para m√≠ trabajar con √©l, no ensucia el c√≥digo con basura innecesaria y, al parecer, no tiene un rendimiento tan terrible como las constantes llamadas a GetComponent (). <br><br>  Estar√© encantado de cualquier cr√≠tica sobre el tema de por qu√© esto no es necesario y c√≥mo hacerlo de todos modos. <br><a name="habracut"></a><br>  Para comenzar, redefin√≠ la funcionalidad est√°ndar de los eventos de Unity para pasar dos GameObject como par√°metros: el sujeto y el objeto del evento: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">System.Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Event</span></span> : <span class="hljs-title"><span class="hljs-title">UnityEvent</span></span>&lt;<span class="hljs-title"><span class="hljs-title">GameObject</span></span>, <span class="hljs-title"><span class="hljs-title">GameObject</span></span>&gt; {}</code> </pre> <br>  Almacene tipos de eventos en una clase est√°tica con todo tipo de constantes: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EventTypes { TargetLock, TargetLost, TargetInRange, TargetOutOfRange, Attack, }</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">La clase de controlador de estos eventos es trivial.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">EventManager</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { Dictionary&lt;EventTypes, Event&gt; events; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> EventManager eventManager; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> EventManager Instance { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!eventManager) { eventManager = FindObjectOfType(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventManager)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> EventManager; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!eventManager) { print(<span class="hljs-string"><span class="hljs-string">"no event manager"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { eventManager.Init(); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> eventManager; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Init</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (events == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { events = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;EventTypes, Event&gt;(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StartListening</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventTypes eventType, UnityAction&lt;GameObject, GameObject&gt; listener</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Instance.events.TryGetValue(eventType, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Event thisEvent)) { thisEvent.AddListener(listener); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { thisEvent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Event(); thisEvent.AddListener(listener); Instance.events.Add(eventType, thisEvent); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StopListening</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventTypes eventType, UnityAction&lt;GameObject, GameObject&gt; listener</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (eventManager == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Instance.events.TryGetValue(eventType, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Event thisEvent)) { thisEvent.RemoveListener(listener); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TriggerEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">EventTypes eventType, GameObject obj1, GameObject obj2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Instance.events.TryGetValue(eventType, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Event thisEvent)) { thisEvent.Invoke(obj1, obj2); } } }</code> </pre> <br></div></div><br>  Luego cre√© el componente Eventos, que se adjunta a cada objeto en el juego. <br>  En √©l, creo pares de Event-Handler para todo tipo de eventos en el juego. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Events</span></span> : <span class="hljs-title"><span class="hljs-title">MonoBehaviour</span></span> { Dictionary&lt;EventTypes, UnityAction&lt;GameObject, GameObject&gt;&gt; eventHandlers; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandlersInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { eventHandlers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;EventTypes, UnityAction&lt;GameObject, GameObject&gt;&gt; { { EventTypes.TargetLock, TargetLock }, { EventTypes.TargetLost, TargetLost }, { EventTypes.TargetInRange, TargetInRange }, { EventTypes.TargetOutOfRange, TargetOutOfRange }, { EventTypes.Attack, Attack }, }; } }</code> </pre><br>  Como resultado, el archivo es engorroso, pero es conveniente para m√≠ que sea uno, para todos los objetos a la vez. <br><br>  Le agrego oyentes para todos los eventos del diccionario, por lo que todos los objetos del juego escuchan todos los eventos del juego, lo que no es √≥ptimo, pero, de nuevo, es conveniente para la creaci√≥n de prototipos cuando cambio el comportamiento de ciertas entidades sobre la marcha: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnEnable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (KeyValuePair&lt;EventTypes, UnityAction&lt;GameObject, GameObject&gt;&gt; pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> eventHandlers) StartListening(pair.Key, pair.Value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDisable</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (KeyValuePair&lt;EventTypes, UnityAction&lt;GameObject, GameObject&gt;&gt; pair <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> eventHandlers) StopListening(pair.Key, pair.Value); }</code> </pre> <br>  Ahora necesito entender a qu√© objeto est√° conectada esta instancia de Eventos. <br><br>  Para hacer esto, busco enlaces a componentes de gameObject: por ejemplo, si nuestro objeto es Character, el campo correspondiente se convertir√° en! = Nulo: <br><br><pre> <code class="cs hljs"> Monster _mob; Character _char; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ComponentsInit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _mob = GetComponent&lt;Monster&gt;(); _char = GetComponent&lt;Character&gt;(); }</code> </pre> <br>  Esta es una operaci√≥n costosa, pero solo lo hago una vez en Awake (). <br><br>  Ahora queda por describir los controladores para todo tipo de eventos: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TargetLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameObject g1, GameObject g2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_char) _char.TargetLock(g1, g2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_mob) _mob.TargetLock(g1, g2); }</code> </pre> <br>  El resultado es una gran lista de m√©todos, uno para cada tipo de evento, dentro de cada uno de los cuales se llama al controlador correspondiente dentro del componente, dependiendo del tipo de evento al que se adjunte esta instancia. <br><br>  En consecuencia, dentro de los componentes de Personaje o Monstruo, ya estoy escribiendo algo as√≠: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TargetLock</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GameObject g1, GameObject g2</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (g1 == gameObject) target = g2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (g2 == gameObject) TargetedBy(g1); }</code> </pre> <br>  Al mismo tiempo, no necesito mantener referencias cruzadas entre objetos, mantengo todos los eventos nuevos y sus controladores "primarios" en un solo lugar, y los objetos finales reciben toda la informaci√≥n que necesitan junto con el evento. <br><br>  Hasta ahora, no he encontrado ning√∫n problema de rendimiento notable: el sistema "imperceptiblemente" funciona con m√°s de 100 tipos de eventos y docenas de objetos en la pantalla, procesando incluso eventos sensibles al tiempo como recibir da√±os de una colisi√≥n con una flecha a un personaje. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/445358/">https://habr.com/ru/post/445358/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../445348/index.html">SNA Hackathon 2019: Simplify Architecture - Simplify Features</a></li>
<li><a href="../445350/index.html">Sonata: servidor de aprovisionamiento SIP</a></li>
<li><a href="../445352/index.html">Spark Structured Streaming Applications en Kubernetes. Experimenta FASTEN RUS</a></li>
<li><a href="../445354/index.html">Encontrar objetos en im√°genes</a></li>
<li><a href="../445356/index.html">Descripci√≥n general de la secci√≥n M√≥vil en DUMP-2019: m√°xima aplicada y √∫til en el trabajo diario</a></li>
<li><a href="../445360/index.html">5 tareas t√≠picas para las entrevistas de JavaScript: an√°lisis y soluciones</a></li>
<li><a href="../445362/index.html">El libro "Sistemas distribuidos. Patrones de dise√±o</a></li>
<li><a href="../445366/index.html">C√≥mo acelerar el cifrado seg√∫n GOST 28147-89 en el procesador Baikal-T1 debido al bloque SIMD</a></li>
<li><a href="../445368/index.html">Prueba de carga de un juego con un par de cientos de miles de usuarios virtuales</a></li>
<li><a href="../445370/index.html">An√°lisis de TSDB en Prometheus 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>