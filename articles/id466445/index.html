<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüî¨ üëµüèæ üë®üèø‚Äç‚öñÔ∏è Serangan antara trust di antara domain üö∑ üõ£Ô∏è üìã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Cepat atau lambat, selama pentest, tugas muncul untuk mengkompromikan seluruh hutan - asalkan ada hak di salah satu domain. Pada saat-saat seperti itu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Serangan antara trust di antara domain</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jetinfosystems/blog/466445/"><img src="https://habrastorage.org/webt/ki/6u/o8/ki6uo88vz8xcqbapiyvfwn4sc-s.jpeg"><br><br>  Cepat atau lambat, selama pentest, tugas muncul untuk mengkompromikan seluruh hutan - asalkan ada hak di salah satu domain.  Pada saat-saat seperti itu, banyak pertanyaan muncul tentang kepercayaan, sifat mereka dan serangan itu sendiri.  Mari kita coba mencari tahu semuanya. <br><a name="habracut"></a><br>  Kepercayaan antar domain digunakan untuk mengautentikasi pengguna dari satu domain pada pengontrol domain lain.  Dengan kata lain, agar pengguna dari domain A dapat memiliki akses ke sumber daya domain B. Struktur domain dapat terdiri dari dua jenis: <br><br><ul><li>  Pohon domain </li><li>  hutan domain. </li></ul><br><img src="https://habrastorage.org/webt/5w/zx/4c/5wzx4cfoai1nwiwk6rissbhy4cu.png"><br><br>  Saat membuat pohon domain antar domain, secara default trust transitif dibuat.  Semua komputer memiliki kesamaan: <br><br><ul><li>  katalog global </li><li>  namespace </li><li>  skema </li></ul><br>  Pohon domain dapat digabungkan menjadi hutan.  Saat membuat hutan domain, trust transitif didirikan, dan semua komputer di hutan berbagi yang berikut: <br><br><ul><li>  katalog global </li><li>  skema </li></ul><br>  Tabel di bawah ini menunjukkan jenis kepercayaan antara domain dan propertinya. <br><br><div class="scrollable-table"><table><tbody><tr><td>  Tidak. </td><td>  Jenis kepercayaan </td><td>  Transitivitas </td><td>  Arahan </td><td>  Mekanisme Otentikasi </td><td>  Deskripsi </td></tr><tr><td>  1 </td><td>  Eksternal </td><td>  Non-transitif </td><td>  Satu arah atau dua arah </td><td>  Hanya NTLM </td><td>  Mereka diinstal antara domain milik hutan yang berbeda, atau dengan domain Windows NT 4.0. </td></tr><tr><td>  2 </td><td>  Ranah </td><td>  Transitif atau non-transitif </td><td>  Satu arah atau dua arah </td><td>  Hanya Kerberos </td><td>  Diinstal antara Windows dan domain non-Windows menggunakan protokol Kerberos.  Jenis kepercayaan ini dapat digunakan untuk menyediakan otentikasi ujung ke ujung pada sistem Windows dan UNIX. </td></tr><tr><td>  3 </td><td>  Hutan </td><td>  Transitif </td><td>  Satu arah atau dua arah </td><td>  Kerberos atau NTLM </td><td>  Diatur di antara hutan.  Pada saat yang sama, administrator memutuskan sendiri apakah hubungan itu bilateral atau unilateral. </td></tr><tr><td>  4 </td><td> Jalan pintas </td><td>  Transitif </td><td>  Satu arah atau dua arah </td><td>  Kerberos atau NTLM </td><td>  Tetapkan di antara domain berbagai pohon milik hutan yang sama.  Digunakan untuk mengurangi jalur kepercayaan, sehingga meningkatkan efisiensi interaksi antara kedua domain. </td></tr><tr><td>  5 </td><td>  Orangtua-anak </td><td>  Transitif </td><td>  Dua arah </td><td>  Kerberos atau NTLM </td><td>  Mereka diinstal secara otomatis ketika domain baru dibuat di pohon.  Di dalam pohon domain, hubungan dijelaskan oleh skema Orangtua-Anak. </td></tr><tr><td>  6 </td><td>  Kepercayaan pohon-root </td><td>  Transitif </td><td>  Dua arah </td><td>  Kerberos atau NTLM </td><td>  Secara otomatis diinstal ketika pohon domain baru dibuat di hutan yang ada.  Bahkan, kepercayaan dibangun antara domain akar hutan dan domain yang dibuat, yang akan menjadi root untuk pohon baru. </td></tr></tbody></table></div><br>  Lebih jelasnya, jenis perwalian antar domain diilustrasikan dalam gambar di bawah ini. <br><br><img src="https://habrastorage.org/webt/jp/mc/eo/jpmceokjm7kwra_mhgfrw3n8tc0.png"><br><br><h4>  Transitivitas </h4><br>  Transitivitas diperlukan untuk mendefinisikan kepercayaan di luar dua domain di mana ia dibentuk, dan digunakan untuk memperluas hubungan kepercayaan dengan domain lain.  Jika kami menambahkan domain anak ke domain, hubungan kepercayaan dua arah dibuat antara domain induk dan anak.  Hubungan ini bersifat transitif, mis.  jika domain A mempercayai domain D dan domain D mempercayai domain E, maka domain A juga mempercayai domain E. <br><br><img src="https://habrastorage.org/webt/xv/wb/wf/xvwbwfp8-uopt2k_bmlk5y0onci.png"><br><br>  Kepercayaan nontransitif dapat digunakan untuk menolak kepercayaan dengan domain lain. <br><br><h4>  Arahan </h4><br>  Jalur hubungan trust adalah serangkaian hubungan trust antara domain tempat permintaan otentikasi harus diterima.  Dengan kata lain, sebelum mengautentikasi pengguna, kepercayaan antar domain ditentukan.  Bagi pengguna domain A untuk mengakses sumber daya domain D, domain D harus mempercayai domain A. <br><br>  Arah kepercayaan ada dua jenis: <br><br><ul><li>  satu sisi; </li><li>  bilateral. </li></ul><br>  Kepercayaan satu arah adalah jalur otentikasi satu arah yang dibuat antara dua domain.  Dalam kepercayaan searah antara domain A dan domain B, pengguna di domain B memiliki akses ke sumber daya di domain A. Namun, pengguna di domain A tidak memiliki akses ke sumber daya di domain B. Jenis kepercayaan ini tidak transitif. <br><br>  Kepercayaan bilateral adalah kombinasi dari dua hubungan kepercayaan searah.  Dalam kepercayaan dua arah antara domain A dan B, pengguna mereka memiliki akses ke sumber daya dari kedua domain.  Jenis kepercayaan ini transitif. <br><br>  Arah kepercayaan selalu berlawanan dengan arah akses.  Diagram perwakilan Microsoft di bawah ini: <br><img src="https://habrastorage.org/webt/r2/d6/jo/r2d6jope8ji-ivoblptob-s5y94.png"><br>  Tautan untuk jenis kepercayaan yang lebih mendalam: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kepercayaan eksternal</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Ranah</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hutan</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Jalan pintas</a> </li></ul><br><h4>  Kerberos antara domain tepercaya </h4><br>  Pertimbangkan sebuah contoh.  Klien sedang mencoba mengakses Server. <br><br><div class="spoiler">  <b class="spoiler_title">Dari poin 1 hingga 3, tindakan standar terjadi saat menggunakan protokol Kerberos.</b> <div class="spoiler_text"><ul><li>  Kata sandi dikonversi ke hash NTLM, cap waktu dienkripsi dengan hash dan dikirim ke KDC sebagai autentikator dalam permintaan tiket TGT (AS-REQ).  Pengontrol domain (KDC) memeriksa informasi pengguna dan membuat tiket TGT. </li><li>  Tiket TGT dienkripsi, ditandatangani, dan dikirim ke pengguna (AS-REP).  Hanya layanan Kerberos (KRBTGT) yang dapat membuka dan membaca data dari tiket TGT. </li><li>  Seorang pengguna mengirimkan tiket TGT ke pengontrol domain saat meminta tiket TGS (TGS-REQ).  Pengontrol domain membuka tiket TGT dan memeriksa checksum PAC. </li></ul><br></div></div><br>  Perubahan dimulai dari poin 4: tiket TGT antar-wilayah muncul, yang disebut tiket rujukan, yang dienkripsi / ditandatangani dengan kunci antar-wilayah yang dibuat dari kata sandi tepercaya.  Kata sandi tepercaya ditetapkan saat kepercayaan dibangun dan diketahui oleh kedua pengontrol domain.  Menggunakan tiket TGT antar-wilayah, pengguna domain 1 dapat meminta tiket TGS untuk mengakses sumber daya domain 2. <br><br><img src="https://habrastorage.org/webt/s4/3v/hj/s43vhjcgbdqvzebpjmra7d2cr_g.png"><br><br><h4>  NTLM antara domain tepercaya </h4><br><img src="https://habrastorage.org/webt/v2/2c/x4/v22cx4pt6iw7mlgxrlus2t3xdqs.png"><br><br><ol><li>  Klien mengirim permintaan untuk otentikasi langsung ke sumber daya itu sendiri, yang terletak di domain lain, yang ingin diakses. </li><li>  Server menerima permintaan dari klien dan mengirimkannya respons CHALLENGE_MESSAGE, yang berisi urutan acak 8 byte.  Ini disebut Tantangan Server. </li><li>  Klien, setelah menerima urutan Server Challenge dari server, mengenkripsi urutan ini dengan kata sandinya, dan kemudian mengirim respons ke server yang berisi 24 byte. </li><li>  Server mengirimkan permintaan dan respons ke pengontrol domain B. </li><li>  Dalam kasus otentikasi antar trust, logika berikut dilakukan: <br><br><ul><li>  Memeriksa Hubungan Trust Arah. <br><ul><li>  Kredensial klien dikirim ke domain A untuk mengautentikasi. </li><li>  Jika tidak ada hubungan kepercayaan, maka Transitivitas diperiksa dengan domain A. </li></ul><br></li><li>  Verifikasi Transitivitas antar Domain <br><ul><li>  Jika ada transitivitas antar domain, permintaan otentikasi dikirim ke domain berikutnya di jalur kepercayaan.  Pengontrol domain ini mengulangi prosesnya, memeriksa kredensial pengguna terhadap database akun keamanannya. </li><li>  Jika tidak ada transitivitas, pesan akses ditolak dikembalikan ke klien. </li></ul><br></li></ul><br>  6-8.  Jawaban dengan keputusan untuk mengotentikasi klien. <br><br><h1>  Serangan antara trust di antara domain </h1><br>  Jadi, untuk melakukan serangan, kami membutuhkan informasi tentang mempercayai hubungan di domain kami. <br><br><h4>  Daftar Trust </h4><br>  Ada 3 metode utama untuk daftar kepercayaan di domain: <br><br><ol><li>  melalui API Win32; </li><li>  melalui metode .NET; </li><li>  melalui LDAP. </li></ol><br>  <b><i>Win32 API</i></b> <br><br>  Enumerasi dilakukan dengan memanggil fungsi <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DsEnumerateDomainTrusts</a> , yang mengembalikan struktur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">DS_DOMAIN_TRUSTSA</a> .  Dengan menggunakan metode ini, SID dan GUID dari domain target, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tanda</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">atribut yang</a> menandai kepercayaan saat ini di domain dikembalikan. <br><br><div class="spoiler">  <b class="spoiler_title">Bendera</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  DS_DOMAIN_DIRECT_INBOUND </td><td>  Menghitung domain yang secara langsung mempercayai domain yang memiliki ServerName sebagai anggota. </td></tr><tr><td>  DS_DOMAIN_DIRECT_OUTBOUND </td><td>  Menghitung domain yang dipercaya langsung oleh domain yang memiliki ServerName sebagai anggota. </td></tr><tr><td>  DS_DOMAIN_IN_FOREST </td><td>  Menghitung domain yang merupakan anggota dari hutan yang sama yang memiliki ServerName sebagai anggota. </td></tr><tr><td>  DS_DOMAIN_NATIVE_MODE </td><td>  Menghitung domain tempat domain utama berjalan dalam mode asli Windows 2000. </td></tr><tr><td>  DS_DOMAIN_PRIMARY </td><td>  Menghitung domain yang merupakan domain utama dari domain yang memiliki ServerName sebagai anggota. </td></tr><tr><td>  DS_DOMAIN_TREE_ROOT </td><td>  Menghitung domain yang berada di akar hutan yang memiliki ServerName sebagai anggota. </td></tr></tbody></table></div><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Atribut</b> <div class="spoiler_text"><br><br><div class="scrollable-table"><table><tbody><tr><td>  TRUST_ATTRIBUTE_NON_TRANSITIVE </td><td>  Larang transitivitas. </td></tr><tr><td>  TRUST_ATTRIBUTE_UPLEVEL_ONLY </td><td>  Tautan trust tidak valid untuk sistem operasi klien lebih awal dari Windows 2000. </td></tr><tr><td>  TRUST_ATTRIBUTE_FILTER_SIDS </td><td>  Domain karantina. </td></tr><tr><td>  TRUST_ATTRIBUTE_FOREST_TRANSITIVE </td><td>  Tautan trust dapat berisi informasi kepercayaan hutan. </td></tr><tr><td>  TRUST_ATTRIBUTE_CROSS_ORGANISATION </td><td>  Kepercayaan ini adalah untuk domain / hutan yang bukan bagian dari perusahaan ini. </td></tr><tr><td>  TRUST_ATTRIBUTE_TREAT_AS_EXTERNAL </td><td>  Kepercayaan diperlakukan sebagai eksternal untuk tujuan batas kepercayaan. </td></tr><tr><td>  TRUST_ATTRIBUTE_WITHIN_FOREST </td><td>  Kepercayaan adalah internal dari hutan ini. </td></tr></tbody></table></div><br></div></div><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">BloodHound</a> mengumpulkan informasi menggunakan metode Win32 API. <br><br><img src="https://habrastorage.org/webt/d4/hq/df/d4hqdf50vvyi6k4b2bv6dbcnekw.png"><br><br>  <b><i>.Net</i></b> <br><br>  Metode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GetCurrentDomain</a> dari namespace [System.DirectoryServices.ActiveDirectory.Domain] digunakan, yang mengembalikan sebuah instance dari kelas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">System.DirectoryServices.ActiveDirectory.Domain</a> .  Kelas ini mengimplementasikan metode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GetAllTrustRelationships</a> , yang mengembalikan semua trust untuk domain saat ini. <br><br><pre><code class="bash hljs">([System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()).GetAllTrustRelationships()</code> </pre> <br>  Menggunakan metode ini diimplementasikan dalam modul Get-DomainTrust di <a href="">PowerView</a> . <br><br><img src="https://habrastorage.org/webt/bv/px/vf/bvpxvf6de-v4o3f04sp5mtrgdd0.png"><br><br>  Salah satu kelebihan dari metode ini adalah kesederhanaannya.  Informasi mudah dibaca dan dipahami, tetapi volumenya jauh lebih kecil daripada saat melakukan penghitungan dengan metode lain. <br><br>  <b><i>LDAP</i></b> <br><br>  Informasi kepercayaan domain disimpan di Active Directory sebagai objectClass dari kelas <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Domain tepercaya</a> . <br><br>  Contoh penggunaan: <br><br><pre> <code class="bash hljs">dsquery * -filter <span class="hljs-string"><span class="hljs-string">"(objectClass=trustedDomain)"</span></span> -attr *</code> </pre> <br><img src="https://habrastorage.org/webt/oa/xc/2x/oaxc2xunppmfjl7vpjztuudgm5e.png"><br><br>  <a href="">PowerView</a> menggunakan metode ini secara default. <br><br><img src="https://habrastorage.org/webt/cx/p1/_w/cxp1_w24rxlh7-naqk5swez6vc4.png"><br><br>  Dengan informasi tentang domain dan jenis kepercayaan, Anda dapat langsung menuju ke serangan itu sendiri.  Pertimbangkan 2 opsi: <br><br><ol><li>  Kami berhasil mengompromikan domain, dan kami memiliki hak administrator domain. </li><li>  Kami tidak memiliki hak administrator domain. </li></ol><br><h2>  Dengan hak administrator ke salah satu domain </h2><br>  Bergantung pada domain yang disusupi, beberapa vektor serangan dapat dibedakan: <br><br><br><div class="scrollable-table"><table><tbody><tr><td>  Tidak. </td><td>  Mulai Domain  Posisi penyerang </td><td>  Domain yang diserang </td><td>  Teknik serangan </td><td>  Hubungan saling percaya </td></tr><tr><td>  1 </td><td>  Rooting </td><td>  Anak </td><td>  Tiket Emas + Grup Admin Perusahaan </td><td>  Inter-ranah (2 arah) </td></tr><tr><td>  2 </td><td>  Anak </td><td>  Anak </td><td>  Operasi Riwayat SID </td><td>  Anak-Orangtua Antar-Kerajaan (2 arah) </td></tr><tr><td>  3 </td><td>  Anak </td><td>  Rooting </td><td>  Operasi Riwayat SID <br>  Operasi Tiket Percaya </td><td>  Inter-ranah Tree-Root (2 arah) </td></tr><tr><td>  4 </td><td>  Hutan 1 </td><td>  Hutan 2 </td><td>  Bug printer </td><td>  Hutan Antar Dunia atau Kepercayaan Eksternal (2 arah) </td></tr></tbody></table></div><br>  Perlu dicatat bahwa untuk keberhasilan implementasi semua vektor, diperlukan kepercayaan bilateral antar domain. <br><br><h4>  <i>1. Riwayat Operasi SID</i> </h4><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">SID History</a> diperkenalkan untuk memfasilitasi migrasi pengguna dari satu domain ke domain lain.  Atribut berisi objek SID sebelumnya.  Setiap kali suatu objek bergerak dari satu domain ke domain lain, SID baru dibuat, yang menjadi objectSID.  SID sebelumnya ditambahkan ke properti sIDHistory. <br><br>  Setiap hutan memiliki grup pengguna Admin Perusahaan yang hanya ada di domain root dan memiliki hak administrator lokal pada pengontrol domain semua domain anak di hutan.  Serangan ini pertama kali ditunjukkan oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Sean Metcalf</a> di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">BlackHat USA 2015</a> .  Inti dari serangan itu adalah kami mengeluarkan tiket Emas dengan tambahan SID tambahan dari grup Admin Perusahaan.  Ini dilakukan dengan menambahkan ExtraSids dalam struktur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">KERB_SID_AND_ATTRIBUTES</a> , yang dikirim dalam struktur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">KERB_VALIDATION_INFO</a> . <br><br><img src="https://habrastorage.org/webt/kl/hy/fj/klhyfjzath65qptysuylgzft-fk.png"><br><br>  Demo Serangan: <br><br><img src="https://habrastorage.org/webt/v6/ia/1g/v6ia1gvjk-sxs7x8plq6uvwojjk.gif"><br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Impacket</a> memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">skrip</a> yang mengotomatiskan semua ini. <br><br><h4>  <i>2. Tiket Emas + Grup Admin Perusahaan</i> </h4><br>  Memiliki hak administrator dalam domain Root, kami dapat membuat Tiket Emas dengan tambahan pengguna ke grup Admin Perusahaan (519). <br><br><pre> <code class="bash hljs">Kerberos::golden /domain:&lt;domain&gt; /sid:&lt;domain_SID&gt; /krbtgt:&lt;ntlm_hash_krbtgt_user&gt; /user:&lt;user&gt; /groups:500,501,513,512,520,518,519 /ptt</code> </pre> <br>  Seperti dijelaskan di atas, Admin Perusahaan memiliki hak administrator lokal untuk domain DC Child.  Dengan demikian, kami akan dapat mengkompromikan semua domain Anak di hutan. <br><br><h4>  <i>3. Pengoperasian tiket trust</i> </h4><br>  Untuk mengakses sumber daya menggunakan protokol Kerberos, Anda memerlukan tiket TGS, yang dienkripsi dengan hash NTLM dari kata sandi akun layanan.  Pengontrol domain hanya menyimpan hash kata sandi pengguna untuk domainnya, jadi ketika pengguna dari domain A membutuhkan akses ke sumber daya di domain B, kunci antar-dunia digunakan.  Kunci ini dibuat berdasarkan kata sandi tepercaya, yang ditetapkan saat membuat hubungan saling percaya antara domain di hutan yang sama.  Di basis data kata sandi (NTDS.dit) pada pengontrol domain, Anda dapat menemukan pengguna dengan tanda $ di bagian akhir.  Kata sandi mereka juga digunakan untuk membuat kunci antar-dunia.  Untuk membuat tiket TGT antar-wilayah, kita memerlukan kata sandi akun ini. <br><br><pre> <code class="bash hljs">Kerberos::golden /user:&lt;user&gt; /domain:&lt;domain&gt; /sid:&lt;sid_domain&gt; /sids:&lt;extra_sid_entrprice_admin_group_from _another_domain&gt; /aes256:&lt;aes256_trust_user_password&gt; /service:krbtgt /target:&lt;target_domain&gt; /ptt</code> </pre> <br>  Demo Serangan: <br><br><img src="https://habrastorage.org/webt/fk/cv/ji/fkcvjizxaup946gngi9zsk6xqm8.gif"><br><br>  Serangan itu sangat relevan ketika layanan IS memperhatikan ancaman dan mengubah kata sandi krbtgt 2 kali.  Dalam hal ini, kami akan dapat membuat tiket emas menggunakan kata sandi tepercaya antar domain. <br><br><h4>  <i>4. Bug Printer</i> </h4><br>  Protokol Remote Sistem Cetak Windows (MS-RPRN) memiliki metode RpcRemoteFindFirstPrinterChangeNotification (Ex) diaktifkan secara default, yang memungkinkan Anda untuk memaksa otentikasi pada komputer mana pun yang menjalankan layanan Pengumpul Informasi di host yang ditentukan menggunakan host Kerberos atau protokol NTLM.  Dalam kasus c NTLM, kita dapat menjalankan NTLM-relay, atau mulai memecahkan kata sandi komputer (tidak pernah dihapus).  Dalam kasus Kerberos, diperlukan mesin kompromi dengan delegasi tanpa batas.  Lalu kita bisa mengambil tiket TGT dan mengembangkan serangan. <br><br>  Demo Serangan: <br><br><img src="https://habrastorage.org/webt/3g/h9/gf/3gh9gfnx0b6k8hucav8zy964ap0.gif"><br><br>  Gambar di bawah ini menunjukkan langkah-langkah yang ditunjukkan dalam video. <br><br><img src="https://habrastorage.org/webt/cu/e0/0l/cue00l2_x_fdpsxj0vyalrvjscs.png"><br><br><h2>  Kami tidak memiliki hak administrator domain </h2><br>  Sedikit teori.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Carlos Garsia</a> dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">laporannya</a> memberikan tabel yang sangat bagus yang menggambarkan sifat-sifat berbagai jenis kelompok. <br><br><img src="https://habrastorage.org/webt/jz/5x/jc/jz5xjcruevdpcv_jnz1knoyh1oi.png"><br><br>  Dari fitur-fiturnya, perlu dipertimbangkan <a href="">bahwa AD Domain Lokal dan Grup AD Global direplikasi tanpa anggota grup ke katalog global, dan grup AD Universal direplikasi dengan pengguna.</a> <br><blockquote>  Karena cara kelompok-kelompok tersebut disebutkan oleh Katalog Global, hasil dari tautan balik [yaitu pencarian dapat bervariasi, tergantung pada apakah Anda mencari Katalog Global (port 3268) atau domain (port 389), jenis dari grup milik pengguna (grup global vs. grup lokal domain). </blockquote>  Jika kami tidak memiliki hak administrator domain, kami menghitung objek.  Kami tertarik pada: <br><ol><li>  Pengguna domain lain yang memiliki hak administrator lokal pada mesin di domain kami. </li><li>  Pengguna dari domain lain yang merupakan anggota grup domain pengguna.  Grup yang berisi pengguna dari domain lain. </li><li>  Kepala Sekolah ACL Asing. </li></ol><br><h4>  <i>1. Pengguna domain lain yang memiliki hak administrator lokal pada mesin di domain kami</i> </h4><br>  Cari pengguna dari domain lain yang merupakan administrator lokal di host di domain kami di BloodHound: <br><br><pre> <code class="bash hljs">MATCH (c:Computer) OPTIONAL MATCH p1 = (u1)-[:AdminTo]-&gt;(c) WHERE NOT u1.domain = c.domain WITH p1,c OPTIONAL MATCH p2 = (u2)-[:MemberOf*1..]-&gt;(:Group)-[:AdminTo]-&gt;(c) WHERE NOT u2.domain = c.domain RETURN p1,p2</code> </pre><br><img src="https://habrastorage.org/webt/07/2y/92/072y92dgtftil5yz9uvrgv8ui3a.png"><br><br>  Perintah di <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-NetLocalGroupMember &lt;server&gt;</code> </pre> <br><h4>  <i>2. Pengguna dari domain lain, terdiri dari grup domain pengguna.</i>  <i>Grup yang berisi pengguna dari domain lain</i> </h4><br>  Seperti disebutkan di atas, pengguna yang hanya anggota grup Universal direplikasi ke katalog global.  Untuk mendemonstrasikan fitur ini, kami akan meminta grup dalam katalog global yang berisi setidaknya satu pengguna dan permintaan ldap langsung ke pengontrol domain. <br><br><pre> <code class="bash hljs">Get-DomainGroup -Properties name, grouptype, member, DistinguishedName -LDAPFilter <span class="hljs-string"><span class="hljs-string">'(member=*)'</span></span> -SearchBase <span class="hljs-string"><span class="hljs-string">"GC://jet.lab"</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/vr/zv/sd/vrzvsdj1pez6rn-ndb4_zcklpdu.png"><br><br>  Saat menjalankan kueri ke katalog global, kami hanya melihat satu grup Grup Universal dengan tipe AD Universal dari domain one.jet.lab. <br><br>  Jika kami menjalankan kueri LDAP langsung ke one.jet.lab, kami akan melihat grup lain dengan tipe AD Domain lokal dan AD Global. <br><br><img src="https://habrastorage.org/webt/jf/3n/ku/jf3nkumv72dhsoyhb8kpqntq9ba.png"><br><br>  Ini penting untuk dipertimbangkan saat menghitung pengguna dan grup. <br><br>  Perintah di <a href="">PowerView</a> : <br><br><pre> <code class="bash hljs">Get-DomainForeignUser -Domain &lt;Domain&gt; Get-DomainForeignGroupMember -Domain &lt;Domain&gt;</code> </pre> <br><img src="https://habrastorage.org/webt/ia/no/24/iano24rfj4ldithcbqhapwts4uk.png"><br><br><img src="https://habrastorage.org/webt/zf/2n/f-/zf2nf-tutgsxrzz99pdp6199fw0.png"><br><br><h4>  <i>3. Prinsipal ACL Asing</i> </h4><br>  Deskriptor keamanan ntSecurityDescriptor (https://docs.microsoft.com/en-us/windows/win32/adschema/a-ntsecuritydescriptor) dapat diakses oleh semua pengguna dari domain tepercaya dan direplikasi ke katalog global.  Dengan demikian, kami dapat meminta semua DACL untuk semua objek dalam mempercayai domain dan memfilter pengguna dari domain lain. <br><br><pre> <code class="bash hljs">Get-DomainObjectAcl -Domain jet.lab -ResolveGuids | ?{<span class="hljs-variable"><span class="hljs-variable">$_</span></span>.SecurityIdentifier -like <span class="hljs-string"><span class="hljs-string">'SID_Domain*'</span></span>}</code> </pre> <br><img src="https://habrastorage.org/webt/fw/kn/si/fwknsimcsrubz0tputfddzosgr0.png"><br><br>  Jadi, kami berhasil mengidentifikasi pengguna Mike dari domain forestc.lab, yang memiliki hak untuk Grup Global di domain jet.lab. <br><br>  Penyaringan PS SID dan Otentikasi Selektif digunakan untuk perlindungan antar hutan.  Serangan antara hutan dengan SID Filtering <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">mengaktifkan dirkjan</a> di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">blog</a> - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">nya</a> .  Juga pada 9 Juli, Microsoft merilis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pembaruan</a> yang menonaktifkan delegasi TGT antar hutan secara default.  Sekarang semuanya, cerita dengan delegasi tanpa batas dan kompromi satu hutan dari yang lain menggunakan protokol Kerberos tidak lagi berfungsi. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id466445/">https://habr.com/ru/post/id466445/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id466435/index.html">Pelatihan Cisco 200-125 CCNA v3.0. Hari 42. Routing Antar-VLAN dan SVI</a></li>
<li><a href="../id466437/index.html">Pelatihan Cisco 200-125 CCNA v3.0. Hari 43. Protokol Routing Distance Vector dan Link State</a></li>
<li><a href="../id466439/index.html">Periksa diri Anda: berapa banyak pertanyaan yang dapat Anda jawab ChGK?</a></li>
<li><a href="../id466441/index.html">Kode kereta python: 10 kesalahan paling umum yang dilakukan pengembang</a></li>
<li><a href="../id466443/index.html">ShIoTiny dan dunia: sensor analog atau ADC untuk yang terkecil</a></li>
<li><a href="../id466447/index.html">Untuk apa kita membangun CDN?</a></li>
<li><a href="../id466449/index.html">Pelatihan Cisco 200-125 CCNA v3.0. Hari 44. Pengantar OSPF</a></li>
<li><a href="../id466451/index.html">Baca_Anda tidak bisa_menghapus</a></li>
<li><a href="../id466453/index.html">Pelatihan Cisco 200-125 CCNA v3.0. Hari 45. Mengkonfigurasi OSPF</a></li>
<li><a href="../id466455/index.html">Layanan, layanan microser dan pemrograman berorientasi batch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>