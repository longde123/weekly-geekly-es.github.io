<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüíº ü•å üêö C√≥mo romper una c√°mara cara para que tu esposa no te mate üßû üë©üèº‚Äçü§ù‚Äçüë®üèæ üßú</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Descargo de responsabilidad: el estudio comenz√≥ en 2013, por lo que si cree que algunos m√©todos son est√∫pidos y peligrosos, tiene raz√≥n, eso fue todo....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo romper una c√°mara cara para que tu esposa no te mate</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438168/"> <i>Descargo de responsabilidad: el estudio comenz√≥ en 2013, por lo que si cree que algunos m√©todos son est√∫pidos y peligrosos, tiene raz√≥n, eso fue todo.</i>  <i>Sin embargo, aprend√≠ mucho en el proceso.</i> <br><br>  <b>Entrada</b> <br>  Todo comenz√≥ unos meses antes del nacimiento de mi primer hijo.  Mi esposa y yo siempre quisimos comprar una c√°mara Leica genial y de repente nos dimos cuenta de que si no la compramos ahora, no podr√≠amos hacerlo por mucho tiempo.  Por lo tanto, pedimos la c√°mara M240 y ... boom, nos pusieron en l√≠nea durante seis meses.  Pronto me cans√© de esperar y comenc√© a estudiar su sitio.  Mi atenci√≥n se dirigi√≥ inmediatamente a la secci√≥n del archivo.  Bueno, puedes adivinar por qu√© ... ¬°Firmware! <br><br>  Vi un archivo sin cifrar y sin comprimir ( <code>m8-2_005.upd</code> ) que comienza con la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">magia PWAD</a> .  ¬øLo reconoces?  S√≠, as√≠ es, este es el formato Doom Patch WAD.  Los chicos parecen amar los cl√°sicos.  El formato est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">muy bien documentado</a> , por lo que no fue dif√≠cil analizarlo. <br><a name="habracut"></a><br><h1>  Archivos de firmware de Leica </h1><br><h3>  Firmware Leica M8 </h3><br>  Esto es realmente muy divertido, porque cuando m√°s tarde estudi√© el archivo comprimido de firmware Leica T, primero decid√≠ probar los m√©todos de compresi√≥n que el software id us√≥ en el pasado. <br><br>  Wikipedia dice que usaron <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el formato LHA</a> , que esencialmente es LZW.  Pero los descompresores comunes LZW no encajaban, as√≠ que comenc√© a buscar una implementaci√≥n espec√≠fica del software de identificaci√≥n, y voila, encontr√© <a href="">Catacomb Armageddon</a> en el <a href="">c√≥digo fuente</a> .  Debo admitir, por suerte. <br><br>  En cualquier caso, de vuelta al M8.  Aqu√≠ est√° la estructura del firmware: <br><br><pre>  REGLAS: 0x0000008C (3036: 0x00000BDC) - Descripci√≥n XML
 LUTS: 0x00000C68 (183274: 0x0002CBEA)
  GAMMA: 0x0000007C (31760: 0x00007C10)
  GANANCIA: 0x00007C8C (50344: 0x0000C4A8)
  LEICA: 0x00014134 (7000: 0x00001B58)
  BLEMISH: 0x00015C8C (250: 0x000000FA)
  WREF: 0x00015D88 (82480: 0x00014230)
  OBJ: 0x00029FB8 (11268: 0x00002C04)
  VERSI√ìN: 0x0002CBBC (46: 0x0000002E)
 PXA: 0x0002D854 (858384: 0x000D1910)
 BF: 0x000FF164 (134522: 0x00020D7A) - Familia de procesadores Blackfin de Analog Devices
 GUI: 0x0011FEE0 (3574180: 0x003689A4)
  TRANS: 0x0000005C (59988: 0x0000EA54) - localizaci√≥n
  IM√ÅGENES: 0x0000EAB0 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB): fotograf√≠a de JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - imagen de JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA): fotograf√≠a de JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - imagen de JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - imagen de JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - imagen de JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D): fotograf√≠a de JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - imagen de JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - imagen de JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - imagen de JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC): fotograf√≠a de JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - imagen de JFIF
  FUENTE1: 0x0004FF5C (1522988: 0x00173D2C)
  FUENTE2: 0x001C3C88 (1723676: 0x001A4D1C)
  VERSI√ìN: 0x003689A4 (0: 0x00000000)
 M16C: 0x00488884 (130406: 0x0001FD66) - Familia Renesas M16C (Motorola S-record)
 FPGA: 0x004A85EC (131604: 0x00020214) - Xilinx Spartan 3
 FSL: 0x004C8800 (814: 0x0000032E): el gestor de arranque de la primera etapa </pre><br>  Fuera de la caja IDA no es compatible con los procesadores Blackfin, pero hay un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">complemento de terceros</a> . <br><br><h3>  Firmware Leica M9 </h3><br>  El archivo de firmware Leica M9 ( <code>m9-1_196.upd</code> ) parece cifrado: el histograma muestra una distribuci√≥n de aproximadamente 0,45%. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ac1/6fc/17d/ac16fc17df9bfb0c9c63bdefaecc83d9.png"><br><br>  El final de la historia?  Quiz√°s no.  El hecho es que Leica usaba procesadores bastante d√©biles en las c√°maras, y en ese momento el cifrado XOR a menudo se usaba en la electr√≥nica de consumo, por lo que decid√≠ escribir una herramienta simple para la operaci√≥n XOR para comparar el firmware conmigo mismo y calcular algunas estad√≠sticas. <br><br>  La longitud de la clave se determin√≥ buscando el patr√≥n repetitivo m√°s largo.  Esto tiene sentido, ya que cualquier firmware generalmente incluye grandes bloques de datos repetidos, como un pad 0x00 / 0xFF o gr√°ficos con p√≠xeles LUT.  La clave misma se calcula por la frecuencia de bytes dentro de la longitud de la clave, donde el byte m√°s com√∫n va al b√∫fer de clave.  El resultado del programa indica claramente el cifrado XOR.  Luego tuve que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">modificar un</a> poco <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la herramienta</a> para obtener la clave potencial y descifrar el c√≥digo.  Esto nuevamente result√≥ ser un archivo PWAD. <br><br>  El contenido de PWAD revel√≥ la siguiente estructura: <br><br><pre>  REGLAS: 0x0000007C (2788: 0x00000AE4) - Descripci√≥n XML
 LUTS: 0x00000B60 (4060616: 0x003DF5C8)
  PROCESO: 0x0000004C (3900572: 0x003B849C)
   CREATE: 0x0000004C (20: 0x00000014) - marca de tiempo
   LUTS: 0x00000060 (427744: 0x000686E0)
   GAINMAP: 0x00068740 (20008: 0x00004E28)
   LENTE: 0x0006D568 (3452724: 0x0034AF34)
  CCD: 0x003B84E8 (148662: 0x000244B6)
   CREATE: 0x0000004C (20: 0x00000014) - marca de tiempo
   BLEMISH: 0x00000060 (1092: 0x00000444)
   WREF: 0x000004A4 (147452: 0x00023FFC)
   LIN: 0x000244A0 (22: 0x00000016)
  ICCPROF: 0x003DC9A0 (4304: 0x000010D0)
   ECI-RGB: 0x0000003C (540: 0x0000021C)
   sRGB: 0x00000258 (3144: 0x00000C48)
   A-RGB: 0x00000EA0 (560: 0x00000230)
  WBPARAM: 0x003DDA70 (7000: 0x00001B58)
 BF561: 0x003E0128 (289128: 0x00046968) - Familia de procesadores Blackfin de Analog Devices
  bf0: 0x0000004C (117846: 0x0001CC56) - procesador principal
  bf1: 0x0001CCA4 (117826: 0x0001CC42) - firmware del subprocesador
  bf0.map: 0x000398E8 (27072: 0x000069C0) - tarjeta de firmware del procesador principal con caracteres: D
  bf1.map: 0x000402A8 (26304: 0x000066C0) - tarjeta de firmware de subprocesador con caracteres: D
 CUERPO: 0x00426A90 (143280: 0x00022FB0) - Familia Renesas M16C (Motorola S-record)
 GUI: 0x00449A40 (3647624: 0x0037A888)
  TRANS: 0x0000005C (131656: 0x00020248) - localizaci√≥n
  IM√ÅGENES: 0x000202A4 (267433: 0x000414A9)
   21_1PRT: 0x000000CC (18411: 0x000047EB): fotograf√≠a de JFIF
   21_2GRP: 0x000048B8 (23172: 0x00005A84) - imagen de JFIF
   21_3PAN: 0x0000A33C (23034: 0x000059FA): fotograf√≠a de JFIF
   24_1PRT: 0x0000FD38 (18489: 0x00004839) - imagen de JFIF
   24_2GRP: 0x00014574 (23230: 0x00005ABE) - imagen de JFIF
   24_3PAN: 0x0001A034 (22998: 0x000059D6) - imagen de JFIF
   28_1PRT: 0x0001FA0C (22605: 0x0000584D): fotograf√≠a de JFIF
   28_2GRP: 0x0002525C (23081: 0x00005A29) - imagen de JFIF
   28_3PAN: 0x0002AC88 (23282: 0x00005AF2) - imagen de JFIF
   35_1PRT: 0x0003077C (22496: 0x000057E0) - imagen de JFIF
   35_2GRP: 0x00035F5C (23532: 0x00005BEC): fotograf√≠a de JFIF
   35_3PAN: 0x0003BB48 (22881: 0x00005961) - imagen de JFIF
  FUENTE1: 0x00061750 (1522988: 0x00173D2C)
  USBLOGO: 0x001D547C (1775: 0x000006EF): fotograf√≠a de JFIF
  FUENTE2: 0x001D5B6C (1723676: 0x001A4D1C)
 FPGA: 0x007C42C8 (150176: 0x00024AA0) - Xilinx Spartan 3A
 BF547: 0x007E8D68 (937576: 0x000E4E68) - Familia de procesadores de aleta negra de dispositivos anal√≥gicos (FSL?) </pre><br><br><h3>  Firmware Leica M240 </h3><br>  Tengo la costumbre de revisar la p√°gina de descarga con el firmware de Leica todas las ma√±anas.  Pronto apareci√≥ un nuevo archivo: <b>FW_M240_1_1_0_2.FW</b> . <br><br>  No parec√≠a cifrado, pero estaba comprimido ... <br><br><h4>  Compresi√≥n </h4><br>  El histograma muestra una gran explosi√≥n a 0x9D. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6cb/025/ef7/6cb025ef734f60b1d4104b7301798cad.png"><br><br>  Quiz√°s esto es alg√∫n tipo de magia de compresi√≥n.  Una b√∫squeda en Internet [compresi√≥n 9D +] no arroj√≥ nada, excepto que 0x1F9D se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">utiliza como firma para la compresi√≥n LZW</a> .  En todo caso, entiendo los tipos de compresi√≥n LZ y decid√≠ mirar los bytes despu√©s de 0x9D.  Y vi cuatro opciones: <br><br><ol><li> <code>9D 70 C4</code> <br> </li><li> <code>9D 00</code> <br> </li><li> <code>9D XX YY</code> <br> </li><li> <code>9D XX 8Y YY</code> </li> </ol><br>  ¬øQu√© m√°s lograste notar? <br><br><ul><li>  la primera opci√≥n aparece solo una vez en la direcci√≥n 0x30: probablemente se usa como un indicador de datos comprimidos; <br></li><li>  XX nunca excede 0x7F; <br></li><li>  el √∫ltimo byte de YY en el tercer y cuarto casos nunca excede 0x7F </li></ul><br>  Por lo que s√© sobre LZ, esto es muy similar a LZ77 o LZSS, donde YY es el paso de sangr√≠a y XX es el n√∫mero de bytes para copiar.  Y la segunda opci√≥n es un caso especial de emisi√≥n de 0x9D.  Escrib√≠ una funci√≥n C simple que implementa esta l√≥gica.  Ella confirm√≥ que nos estamos moviendo en la direcci√≥n correcta, pero la cuarta opci√≥n a√∫n no encaja en el esquema. <br><br>  Trat√© de interpretarlo en todos los sentidos, pero no sali√≥ nada.  Por lo tanto, recurr√≠ a mis camaradas para pedirles consejo.  Un tipo not√≥ que, seg√∫n mis propias observaciones, el cuarto byte de YY aparece solo cuando se establece el bit m√°s alto 0x8Y: esta es solo la distancia extra para el paso de sangr√≠a.  Estaba avergonzado, todo result√≥ tan obvio ... <br><br>  Finalmente, el descompresor comenz√≥ a emitir una secuencia v√°lida ... hasta que se atasc√≥ en el medio del archivo.  Esto sucedi√≥ debido a la longitud desconocida de la ventana deslizante.  Depuraci√≥n y pruebas adicionales arreglaron la situaci√≥n. <br><br>  As√≠ que hab√≠a una <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">herramienta para analizar el firmware M240</a> . <br><br><h4>  Estructura de firmware </h4><br>  Para trabajar con un formato desconocido, no se me ocurri√≥ nada mejor que medir algunos desplazamientos y tama√±os de secciones de c√≥digo, y tratar de encontrar los valores m√°s cercanos en el encabezado del archivo.  Por ejemplo, este bloque: <br><br> <code>0x00: 1E 1C AF 2E 01 01 00 02 07 E1 EA 5E 00 5C 1A B1 <br> 0x10: 01 29 1A 7E AE 38 73 65 9C 3D 75 B4 34 2F 44 6E <br> 0x20: 13 17 8E 6B 00 00 00 01 00 00 00 30 E1 E3 50 D1</code> <br> <br>  finalmente se convirti√≥ en: <br><br> <code>1E1CAF2E ‚Äî   "LEICA FILE" <br> 01010002 - 1.1.0.2 <br> 005C1AB1 ‚Äî    (big endian) <br> 01291A7E ‚Äî    (big endian) <br> AE3873659C3D75B4342F446E13178E6B ‚Äî  MD5 <br> 00000001 ‚Äî    <br> 00000030 ‚Äî    </code> <br> <br>  Cuando entend√≠ la estructura del firmware, mejor√© mi herramienta, y al final, produjo esto: <br><br> <code>Running with options: <br> + firmware folder: M240_FIRMWARE <br> + verbose enabled <br> <br> Open firmware file: FW_M240_1_1_0_2.FW <br> File size: 6036193 | 0x005C1AE1 <br> <br> Parse container header: <br> version: 1.1.0.2 <br> packed size: 6036145 | 0x005C1AB1 <br> unpacked size: 19470974 | 0x01291A7E <br> body blocks: 1 | 0x00000001 <br> body offset: 48 | 0x00000030 <br> MD5: AE387365 9C3D75B4 342F446E 13178E6B <br> MD5 check: PASSED <br> <br> Uncompress container body: <br> 6036145 -&gt; 19470974 <br> Uncompression: DONE <br> <br> Split container: <br> Number of sections: 9 | 0x00000009 <br> Section table size: 612 | 0x00000264 <br> Section table offset: 36 | 0x00000024 <br> Section 1 <br> Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000 <br> MD5: A8D55AA2 B0ACDB14 0673AD79 707674F3 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG_LOKI-212.bin <br> <br> ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ <br> <br> Section 9 <br> Section Name: "[A]IMG-LENSDATA-213" <br> Section offset: 19214844 | 0x012531FC <br> Section size: 255478 | 0x0003E5F6 <br> Section base: 16252928 | 0x00F80000 <br> MD5: 39C2BEC0 27ED23F6 2C1C8513 EEE697B9 <br> MD5 check: PASSED <br> Create file: M240_FIRMWARE/IMG-LENSDATA-213.bin <br> Splitting container: DONE <br> Extraction COMPLETE!</code> <br> <br>  El firmware M240 incluye un contenedor con nueve elementos: <br><br> <code>IMG_LOKI-212.bin -    <br> IMG_LOKI-213.bin -    <br> CTRL_SYS-11.bin -   - <br> IMG-FPGA-212.bin -     () <br> IMG-FPGA-213.bin -     () <br> IMG-DSP-212.bin -  DSP <br> IMG-DSP-213.bin -  DSP <br> IMG-LENSDATA-212.bin -    <br> IMG-LENSDATA-213.bin -   </code> <br> <br>  Como puede ver, en un firmware hay dos conjuntos de archivos.  M√°s tarde supe que 212 es una versi√≥n del microcircuito de procesamiento de im√°genes, y dos versiones del Leica M240 entraron en producci√≥n.  Este estudio se basa en la versi√≥n 212. <br><br><h1>  Gesti√≥n del sistema: CTRL_SYS-11.bin </h1><br>  La √∫nica parte com√∫n es el firmware para el chip de control del sistema.  Este es un binario realmente grande, y el c√≥digo puede adivinar f√°cilmente para qu√© est√° destinado. <br><br> <code>$ strings CTRL_SYS-11.bin | rg SH <br> -&gt; Test SH7216 data flash driver <br> -&gt; Test SH7216 SCI driver <br> -&gt; Test SH7216 I2C driver <br> -&gt; Test SH7216 MTU2 driver <br> -&gt; Test SH7216 ADC functions <br> -&gt; Test SH7216 CMT driver</code> <br> <br>  Por lo tanto, tenemos el procesador Renesas SH7216 (SH-2A), que es responsable de la etapa inicial de carga, pruebas de E / S y actualizaciones de firmware.  Fuera de la caja IDA admite este tipo de procesador.  Solo quedaba encontrar la direcci√≥n de carga base correcta, conocida por la descripci√≥n de las secciones de firmware: esto es <code>0x0</code> . <br><br> <code>Section Name: "[A]CTRL_SYS-11" <br> Section offset: 14680064 | 0x00E00000 <br> Section size: 917277 | 0x000DFF1D <br> Section base: 0 | 0x00000000</code> <br> <br>  Lo cargu√© en la IDA y reconoc√≠ todas las funciones, pero no lo investig√© especialmente, porque el firmware del procesador principal es mucho m√°s interesante. <br><br>  Aqu√≠ tambi√©n se puede observar que el UART de este chip se abre en el puerto de servicio, donde muestra el registro de descarga.  Volveremos a esto m√°s tarde. <br><br><h1>  Chip principal: IMG_LOKI-212.bin </h1><br>  Para iniciar la ingenier√≠a inversa de este firmware, primero debe responder algunas preguntas: <br><br><ol><li>  que tipo de procesador <br></li><li>  ¬øCu√°l es la direcci√≥n de carga base? <br></li><li>  en qu√© sistema operativo se basa, si corresponde </li></ol><br>  Gracias a nuestra herramienta, ya conocemos la direcci√≥n de la carga base: esto es <code>0x100000</code> . <br><br> <code>Section Name: "[A]IMG_LOKI-212" <br> Section offset: 0 | 0x00000000 <br> Section size: 7340032 | 0x00700000 <br> Section base: 1048576 | 0x00100000</code> <br> <br>  El firmware almacena las respuestas restantes en una forma legible.  Por ejemplo, esta l√≠nea: <br><br> <code>$ strings ./IMG_LOKI-212.bin | rg Softune <br> 6Softune REALOS/FR is Realtime OS for FR Family, based on micro-ITRON COPYRIGHT(C) FUJITSU LIMITED 1994-1999 <br> ...</code> <br> <br>  Por lo tanto, estamos tratando con un procesador personalizado <b>Fujitsu FR</b> (Leica lo llama <b>Maestro</b> ) y el <b>sistema</b> operativo <b>Softune REALOS</b> .  De hecho, esto es mucho mejor que Blackfin, porque la IDA lista para usar admite FR. <br><br><h2>  M√≥dulo de procesador FR </h2><br>  La realidad no era tan brillante, porque despu√©s de descargar el archivo de firmware, el programa IDA no mostr√≥ ninguna instrucci√≥n, enlaces externos, etc. <br><br>  Decid√≠ arreglarlo, pero al final tuve que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">reescribir completamente algunas partes del firmware</a> .  Aqu√≠ est√° el resultado: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9f3/728/c76/9f3728c769d29aa02e2f405c08d8bb9a.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a08/2ea/81d/a082ea81d9056b07935398a19d4df294.png"><br><br>  Adem√°s de las correcciones en <code>ana</code> , <code>ins</code> y <code>out</code> , un c√≥digo <code>emu</code> completamente nuevo puede: <br><br><ul><li>  reconocer varios tipos de c√≥digo y enlaces externos a datos; <br></li><li>  Reconocer declaraciones de cambio <br></li><li>  realizar el seguimiento de la pila; <br></li><li>  Separar los argumentos de la pila y las variables locales. <br></li><li>  reconocer funciones correctamente </li></ul><br>  Pero el cambio m√°s grande, como notaron, es letras may√∫sculas para instrucciones :) <br><br>  ¬øQuieres ver el conjunto completo de instrucciones?  Aqu√≠ esta: <br><br><pre>  AGREGAR O BTSTH LSR MOV BN LDRES EXTSH   
 AGREGAR ORH MUL LSR2 JMP BP STRES EXTUH   
 ADDC ORB MULU ASR CALL BV COPOP SRCH0   
 ADDN EOR MULH ASR2 RET BNV COPLD SRCH1   
 ADDN2 EORH MULUH LDI INT BLT COPST SRCHC   
 SUB EORB DIV0S LDI INTE BGE COPSV LDM0    
 SUBC BANDL DIV0U LDI RETI BLE NOP LDM1    
 SUBN BANDH DIV1 LD BRA BGT ANDCCR STM0    
 CMP BORL DIV2 LDUH BNO BLS ORCCR STM1    
 CMP2 BORH DIV3 LDUB BEQ BHI STILM ENTER   
 Y BEORL DIV4S ST BNE DMOV ADDSP SALIR   
 ANDH BEORH LSL STH BC DMOVH EXTSB XCHB    
 ANDB BTSTL LSL2 STB BNC DMOVB EXTUB </pre><br>  Entonces, simple y hermoso. <br><br>  Por cierto, es posible que hayas notado que algunas instrucciones no est√°n alineadas: <br><br><pre>  BRA: D loc_xxx
     LDI: 8 # 0x64, R5 </pre><br>  Esto no es un error en el m√≥dulo del procesador, sino una caracter√≠stica de la familia Fujitsu FR.  Se llama <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un intervalo de retraso</a> y es bastante t√≠pico para los procesadores RISC. <br><br>  Del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">manual del procesador FR80</a> (nota: el enlace ya no funciona): <br><br><blockquote>  La instrucci√≥n que se encuentra inmediatamente despu√©s de la instrucci√≥n de bifurcaci√≥n (su ubicaci√≥n se denomina "intervalo de retardo") se ejecuta antes de la bifurcaci√≥n, y la instrucci√≥n en la direcci√≥n de destino se ejecuta despu√©s de la bifurcaci√≥n.  Dado que la instrucci√≥n en el intervalo de retraso se ejecuta antes de la operaci√≥n de bifurcaci√≥n, la velocidad de ejecuci√≥n aparente es de 1 ciclo. </blockquote><br>  Por lo tanto, esto es, en esencia, la optimizaci√≥n de la tuber√≠a, y es mejor recordarlo, porque se usa en todas partes en el firmware de Leica. <br><br><h2>  Softune REALOS </h2><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">De la wiki</a> : <br><br><blockquote>  Softune es el entorno de desarrollo integrado de Fujitsu para las familias de procesadores Fujitsu FR, FR-V y F2MC.  Desarrollado por REALOS ¬µITRON kernel en tiempo real.  Por ejemplo, se usa en c√°maras Nikon DSLR (ver Nikon EXPEED) y algunas c√°maras Pentax con K. </blockquote><br>  As√≠ que este es un RTOS decente bastante popular con tareas, sem√°foros y otras cosas.  Me preguntaba si es posible reconocer algunas funciones de biblioteca est√°ndar en el firmware de Leica. <br><br>  Tengo que llamar a la primera parte del estudio una gran p√©rdida de tiempo, y he aqu√≠ por qu√©. <br><br>  El IDE de Softune result√≥ ser muy dif√≠cil de encontrar, pero al final logr√© obtener algo.  Como se esperaba, el IDE inclu√≠a bibliotecas.  Hab√≠a cuatro binarios: <br><br><ul><li>  lib911.lib <br></li><li>  lib911e.lib <br></li><li>  lib911if.lib <br></li><li>  lib911p.lib </li></ul><br>  No s√© por qu√©, tal vez por inercia, cuando pirate√© todo lo relacionado con Leica, comenc√© de nuevo la ingenier√≠a inversa del formato.  S√≠, un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">formato de m√≥dulo de objeto</a> muy bien documentado.  Y s√≠, por supuesto, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escrib√≠ una herramienta especial para esto</a> : <br><br> <code>Fujitsu RISC Library Tool v1.0 <br> Usage: FRLibTool [-s start] [-i imagebase] [-o output] [-f index] [-dv] FIRMWARE.BIN LIBRARY.LIB <br> <br> This tool will help you to find Softune REALOS library functions in FR (Fujitsu RISC) firmware. <br> Use following arguments: <br> -f Specify firmware image file <br> -s Specify firmware image scan offset <br> -b Specify firmware imagebase <br> -o Specify output type (exclusively) <br> list - list of functions <br> idc - IDC script <br> py - IDA python script <br> pat - FLAIR pattern file <br> -i xxx Specify index of particular function <br> -d Dump library <br> -v Be verbose</code> <br> <br>  Utiliz√°ndolo, puede crear archivos <code>*.pat</code> y usarlos como entrada en <b>IDA FLAIR</b> para generar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">archivos de firma</a> . <br><br> <code>$ FRLibTool -o pat lib911.lib <br> $ FRLibTool -o pat lib911e.lib <br> $ FRLibTool -o pat lib911if.lib <br> $ FRLibTool -o pat lib911p.lib <br> ... <br> $ sigmake -n "SOFTUNE C/C++ Library" lib911.pat lib911e.pat lib911if.pat lib911p.pat softune.sig</code> <br> <br>  Despu√©s de aplicar esta firma, finalmente felizmente vi la correspondencia en <b>IMG_LOKI-212.idb</b> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/189/618/145/189618145ab302edfff51fa222ed89b3.png"><br><br><h4>  Dise√±o </h4><br>  El n√∫mero de l√≠neas en el firmware llama inmediatamente la atenci√≥n.  Muchas funciones se nombran por su funcionalidad.  Esto es muy √∫til en el proceso de ingenier√≠a inversa para comprender el patr√≥n general. <br><br>  Tambi√©n es importante tener en cuenta que algunas partes del archivo de firmware se copian a una direcci√≥n diferente en el controlador de reinicio.  Por ejemplo, el cargador incorporado en tiempo de ejecuci√≥n se mueve m√°s alto en RAM. <br><br>  Tuve que crear manualmente secciones adicionales, como resultado, obtuve el siguiente dise√±o: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/70f/d9d/ca3/70fd9dca36e610c7dea2e1c2fd29090c.png"><br><br><h4>  Interrupciones </h4><br>  La tabla de vectores de interrupci√≥n se puede encontrar accediendo a TBR (Table Base Register): <br><br> <code>LDI:32 #int_table, R0 <br> MOV R0, TBR</code> <br> <br>  Por lo general, ocurre en el controlador de reinicio de vector al comienzo del firmware. <br><br>  Las direcciones de los manejadores en la tabla se almacenan en orden inverso de acuerdo con la f√≥rmula <code>TBR + (0x3FC - 4 √ó inum)</code> , por lo que el vector de reinicio al final de la tabla se desplaza <code>0x3FC</code> . <br><br>  Encontr√© la mayor√≠a de las interrupciones del manual de FR y suger√≠ que Leica Maestro tiene un dise√±o similar.  Luego tom√≥ cada controlador e intent√≥ encontrar una cuerda o cualquier otra pista que revelara el prop√≥sito de la interrupci√≥n. <br><br>  Como resultado, hice esta lista: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bd7/eb8/c29/bd7eb8c291d5368d44576466400cb34b.png"><br><br>  Se esperan muchas interrupciones, como AUDIO / SDIO / VIDEO / JPEG / RAW, pero ¬øtrata de identificar la m√°s misteriosa?  Estoy hablando de interrumpir <code>int_uart_in</code> .  Parece que la c√°mara admite alg√∫n tipo de modo de consola UART CLI. <br><br><h4>  Sistema de llamadas </h4><br>  Como casi cualquier sistema operativo, Softline REALOS utiliza llamadas del sistema.  En ensamblador, se ven as√≠: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/22f/a92/9e3/22fa929e311af81f43be57bf0bbbbc74.png"><br><br>  La direcci√≥n real del manejador de llamadas del sistema se calcula de la siguiente manera.  Comencemos buscando el controlador de interrupci√≥n <code>INT #0x40</code> .  Como se describi√≥ anteriormente, esto <br><br> <code>(0x3FC - 4 √ó inum) = (0x3FC - 4 √ó 0x40) = 0x2FC = int_realos_syscall</code> <br> <br>  En el controlador, es f√°cil encontrar un enlace a la parte inferior de la tabla de llamadas del sistema con palabras de 16 bits.  El registro espec√≠fico en esta tabla se calcula mediante la f√≥rmula <code>syscall_table_bottom + (num * 2)</code> : <br><br> <code>[syscall_table_bottom + (-23 * 2)] = [syscall_table_bottom - 0x2E] = [0x1012EA] = 0xE68</code> <br> <br>  Esto no parece una direcci√≥n, porque la direcci√≥n real del manejador de llamadas del sistema se calcula como <code>syscall_table_bottom + offset</code> .  Todo el proceso se muestra en el diagrama. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c5a/240/2bb/c5a2402bb00a171532dabf9ef9aa45ea.png"><br><br>  Todas las llamadas al sistema y su funcionalidad se indican en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">el manual del n√∫cleo Softline REALOS / FR</a> , por lo que logr√© restaurar todos los controladores implementados en la tabla y mejorar un poco m√°s el BID. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c6a/b81/57a/c6ab8157a83a3e00613b4a000de45e54.png"><br><br>  Por supuesto, puede hacer que el c√≥digo sea a√∫n m√°s hermoso definiendo los tipos de llamadas al sistema en la IDA. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e0/75c/099/1e075c099f1bdcb70388427705dd25c0.png"><br><br>  Escrib√≠ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un script de Python</a> para buscar autom√°ticamente estas llamadas al sistema y m√°s. <br><br><h4>  Las tareas </h4><br>  En la <code>sta_tsk</code> sistema <code>sta_tsk</code> not√© que no se pasa la funci√≥n principal como par√°metro, sino pid.  Esto significa que es hora de buscar una gran variedad de descriptores de tareas.  Y tiene sentido comenzar con el propio <code>sta_tsk</code> . <br><br><pre>  ROM: 102180 sys_sta_tsk:
 ROM: 102180 ST RP, @ -R15
 ROM: 102182 LDUB @ (R14, 0x4F), R3
 ROM: 102184 LDI: 32 # word_100B80, R14 </pre><br>  Al principio vemos algunos enlaces.  Tuve que jugar un poco con los tipos de datos, pero al final las piezas se unieron: <br><br><pre>  ROM: 100B80 word_100B80: .word 0xF;  cantidad de tareas
 ROM: 100B82 .word 0x1C;  tama√±o del descriptor de tarea<font></font>
<font></font>
 ROM: 100B84 .long 0x82A09F5C;  descriptor de tarea 1
 ROM: 100B88 .long 0x1000D
 ROM: 100B8C .long 0
 ROM: 100B90 .long 0x40000000
 ROM: 100B94 .long sub_1A7DB2;  tarea principal
 ROM: 100B98 .long 0x8286EEC0
 ROM: 100B9C .long 0<font></font>
<font></font>
 ROM: 100BA0 .long 0x82A09F88;  descriptor de tarea 2
 ROM: 100BA4 .long 0x20010
 ROM: 100BA8 .long 0
 ROM: 100BAC .long 0x40000000
 ROM: 100BB0 .long sub_1A6BD2;  tarea principal
 ROM: 100BB4 .long 0x8287EEC0
 ROM: 100BB8 .long 0
 ... </pre><br>  Y as√≠ sucesivamente.  Solo 15 tareas.  Era cuesti√≥n de tiempo examinar cada funci√≥n principal, determinar el nombre y el prop√≥sito de la tarea (excepto la √∫ltima).  Aqu√≠ est√° la lista completa: <br><br><ol><li>  <b>SubCPU</b> <br>  Aparentemente, esta tarea es responsable de las operaciones de captura, como la exposici√≥n, el avistamiento en pantalla, etc. <br></li><li>  <b>Keymanager</b> <br>  Lo m√°s probable es que esta tarea est√© asociada con botones de hardware. <br></li><li>  <b>Guimanager</b> <br>  Una tarea bastante grande, en la que se implementan la m√°quina de estado de la interfaz de usuario y la representaci√≥n de la interfaz. <br></li><li>  <b>Debugmanager</b> <br>  S√≠, hay algo que depurar.  √ëam √±am. <br></li><li>  <b>Administrador de archivos</b> <br>  Esta tarea se trata de operaciones de archivos. <br></li><li>  <b>Fammanager</b> <br>  Yo dir√≠a que la tarea es responsable de los archivos y la memoria, porque depende de las tareas del administrador de archivos y el administrador de memoria. <br></li><li>  <b>Administrador de memoria</b> <br>  Sin sorpresas: operaciones de memoria, gesti√≥n de agrupaciones, etc. <br></li><li>  <b>Imagemanager</b> <br>  Esta tarea gestiona los procesos de codificaci√≥n / decodificaci√≥n y otros procesos de procesamiento de im√°genes. <br></li><li>  <b>Usbmanager</b> <br>  El desaf√≠o actual es el procesamiento de comunicaciones USB, que incluye MassStorage, PTP y el propio protocolo de Leica. <br></li><li>  <b>IOManager</b> <br>  Esta tarea parece estar administrando dispositivos de almacenamiento como tarjetas SD y CF (¬øqu√©? ¬øQu√© otros CF? Quiz√°s sea del modelo 213). <br></li><li>  <b>Administrador del sistema</b> <br>  Diversas tareas como operaciones generales del sistema, administraci√≥n de energ√≠a, etc. <br></li><li>  <b>Administrador de configuraciones</b> <br>  Maneja el estado y la configuraci√≥n de la c√°mara. <br></li><li>  <b>Monitormanager</b> <br>  Rastrea los cambios de estado de la c√°mara e informa otras tareas. <br></li><li>  <b>Gerente Perif√©rico</b> <br>  Esta tarea controla el GPS, el brillo y algunos otros sensores. <br></li><li>  <b>Desconocido</b> <br>  Desafortunadamente, no encontr√© nada significativo para ella. </li></ol><br>  Es interesante notar que despu√©s de la matriz principal hay otro descriptor destacado. <br><br> <code>ROM:100D28 dword_100D28: .long 0x82A0A1F0 <br> ROM:100D2C .long 0x21 <br> ROM:100D30 .long 0 <br> ROM:100D34 .long 0x80000000 <br> ROM:100D38 .long tid16_task <br> ROM:100D3C .long 0x8285EEC0 <br> ROM:100D40 .long 0</code> <br> <br>  Y la funci√≥n de la tarea es simplemente ramificarse. <br><br> <code>ROM:101494 sub_101494: <br> ROM:101494 BRA sub_101494 ; CODE XREF: sub_101494</code> <br> <br>  Se hace referencia a este descriptor al final de la funci√≥n de <code>start</code> , que es responsable de crear otras tareas y configurar el firmware.  Entonces, esta es probablemente la tarea de la inacci√≥n del sistema. <br><br><h4>  M√≥dulos y Mensajes </h4><br>  Adem√°s de las tareas, puede definir algunos objetos l√≥gicos, como IO y m√≥dulos perif√©ricos.  Los m√≥dulos se presentan como un grupo de manejadores de mensajes como parte de una de las tareas. <br><br>  El grupo IO parece incluir: <br><br><ul><li>  Gerente de IO </li><li>  Subprocesador </li><li>  Administrador de USB </li><li>  USB PTP </li><li>  Protocolo USB Leica </li><li>  Almacenamiento masivo USB </li><li>  Administrador de botones </li><li>  Administrador de depuraci√≥n </li><li>  Gerente de lentes </li></ul><br>  Y en el grupo perif√©rico: <br><br><ul><li>  Gerente Perif√©rico </li><li>  Sensor de luz </li><li>  LEDs </li><li>  Orador </li><li>  Sensor de inclinaci√≥n </li><li>  Reconocimiento de cierre de tapa </li><li>  M√≥dulo GPS </li><li>  M√≥dulo 3DAxis </li></ul><br>  El sistema de mensajer√≠a en s√≠ utiliza las estructuras est√°ndar de SOFTUNE: <br><br><pre> <code class="plaintext hljs">struct RealOS_MsgPayload { uint32_t msgID; // +0x0 uint32_t data[]; // +0x4 } struct RealOS_Message { uint32_t os_reserved1; // +0x0 uint32_t os_reserved2; // +0x4 uint32_t to; // +0x8 uint32_t from; // +0xC RealOS_MsgPayload* payload; // +0x10 }</code> </pre> <br>  Como se esperaba, IPC tambi√©n tiene varios grupos de mensajes.  Como muchos mensajes se procesan en tareas y m√≥dulos, pude recuperar solo algunos de estos grupos: <br><br><pre>  0x1101xxxx - mensajes globales del sistema:
              0x11010002 = SYS_UPDATE_BOOTLOADER o
              0x11010005 = SYS_ERASE_SETTINGS
 0x1102xxxx - mensajes relacionados con la captura de im√°genes:
              0x11020001 = CMD_CAP_CAPTURE o
              0x11020008 = IMAGE_STATUS_CHANGED  
 0x1104xxxx: mensajes sobre eventos relacionados con la reproducci√≥n:  <font></font>
             0x11040002 = PLY_DISABLE_PLAY_MODE <font></font>
             0x11040004 = PLY_IMAGE_READY  <font></font>
0x1108xxxx -     PTP  .:<font></font>
             0x11080002 = DBG_CHANGE_LEVEL <font></font>
             0x11080012 = DBG_WRITE_ROM_DUMP_SD  <font></font>
0x2201xxxx -  USB PTP<font></font>
             0x22010108 =    <font></font>
             0x22010118 =  DebugObject  <font></font>
0x2202xxxx -     SUBCPU:<font></font>
             0x22020002 = E_SUBCPU_REQUEST_M_EXPOSURE_REQUEST  <font></font>
             0x22020015 = E_IO_SUBCPU_COMMAND_CLEANING_SENSOR  <font></font>
0x2203xxxx -    :<font></font>
             0x22030001 =   <font></font>
0x2204xxxx -   IO:<font></font>
             0x2204000C = / Mass Storage <font></font>
             0x22040012 =    <font></font>
0x330000xx -     UI:<font></font>
             0x33000001 =  <font></font>
             0x33000007 =  <font></font>
0x440000xx -   ,     <font></font>
             0x44000013 = E_IMG_CMD_CHANGE_PINFO  <font></font>
0x55xxxxxx ‚Äî   FAM:  <font></font>
             0x558800xx = - FAM <font></font>
             0x558888xx =     FAM<font></font>
0x6602xxxx ‚Äî     LED, :<font></font>
             0x66020001 -  LED  X <font></font>
             0x66020002 =   LED  <font></font>
0x6604xxxx -  :<font></font>
             0x66040001 =  <font></font>
             0x66040007 =    <font></font>
0x6611xxxx -  ,   <font></font>
0x6622xxxx -   ,   <font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x6660xxxx - algunos otros mensajes relacionados con la memoria:</font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600006 = HISTOGRAMA  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
             0x66600011 = RAWCOMP  </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x771100xx y 0x77AA00xx: mensajes relacionados con el cambio de modo de c√°mara </font></font></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Desafortunadamente, muchas otras publicaciones siguen siendo desconocidas. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GUI </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el archivo de firmware, tambi√©n veremos las siguientes secciones: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CTRL_SYS-11</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-DSP-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-FPGA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LENSDATA-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo que me sorprendi√≥ fue la falta total de recursos de la GUI. Pero deber√≠an estar en alg√∫n lugar y, muy probablemente, est√°n integrados en </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IMG-LOKI-212</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Uno de mis enfoques habituales para invertir el desarrollo del firmware es restaurar todas las referencias cruzadas posibles. No solo en el c√≥digo, sino tambi√©n en la secci√≥n de datos. Luego miro a trav√©s de ellos, tratando de encontrar algunos patrones o enlaces a partes conocidas del c√≥digo.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El firmware de Leica no fue la excepci√≥n. </font><font style="vertical-align: inherit;">Hay muchas secuencias de datos similares con direcciones a otras secuencias de datos que van m√°s all√°, etc. A medida que ascend√≠a en la jerarqu√≠a de enlaces, finalmente vi una funci√≥n familiar. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por ejemplo, encontr√© una estructura de datos sin ning√∫n enlace:</font></font><br><br><pre> <code class="plaintext hljs">g_data = { ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Otra estructura lo abord√≥: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct1 = { ... , &amp;g_data }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lo que a su vez se refiere a otra estructura: </font></font><br><br><pre> <code class="plaintext hljs">g_data_struct2 = { &amp;g_data, ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Esta estructura de datos tiene un enlace desde el c√≥digo, y se pasa como par√°metro a otra funci√≥n: </font></font><br><br><pre> <code class="plaintext hljs">func1() ‚ï∞ func2(..., &amp;g_data_struct2, ...)</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin embargo, </font></font><code>func1()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no se llama directamente desde otra funci√≥n, sino que se almacena en una matriz:</font></font><br><br><pre> <code class="plaintext hljs">g_func_list1[] = { ..., func1(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Mirando arriba, encontr√© una llamada en el c√≥digo </font></font><code>g_func_list1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><pre> <code class="plaintext hljs">func3() { g_func_list1[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Y nuevamente, esta funci√≥n se almacena en una matriz: </font></font><br><br><pre> <code class="plaintext hljs">g_func_list2[] = { ..., func3(), ... }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alg√∫n otro c√≥digo accede a la matriz en s√≠: </font></font><br><br><pre> <code class="plaintext hljs">func4() { g_func_list2[x] }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afortunadamente, esta vez la funci√≥n se llama desde otra funci√≥n, y as√≠ sucesivamente </font></font><code>gui_MADE_ApplicationRun</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><pre> <code class="plaintext hljs">gui_Statemachine_DoStateChange() ‚ï∞ gui_MADE_ApplicationRun() ‚ï∞ func5() ‚ï∞ func4()</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Algunas l√≠neas indican que el subsistema GUI se llama "MADE", y las transiciones de p√°gina se manejan usando </font></font><code>MADE_GetSysTri</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">lo que eso signifique. </font><font style="vertical-align: inherit;">La m√°quina de estado GUI se implementa b√°sicamente en una funci√≥n </font></font><code>gui_Statemachine_DoStateChange</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Despu√©s de recopilar informaci√≥n sobre la GUI, surgi√≥ la imagen general: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4d4/33e/3cf/4d433e3cf679dba11141d58d080daf5b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como puede ver, la funci√≥n principal de los recursos de la GUI es </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(aunque este no es un nombre real). </font><font style="vertical-align: inherit;">Ella tiene los siguientes argumentos:</font></font><br><br><pre> <code class="plaintext hljs">gui_CopyImageDesc( uint32_t dstAddress; // R4 - destination address UIDescType type; // R5 - description type UITarget target; // R6 - rendering target uint32_t descAddress; // R7 - description address uint8_t always0; // (SP + 0x0) - always 0 uint8_t index1; // (SP + 0x4) - index 1 uint8_t index2; // (SP + 0x8) - index 2 uint16_t x_offset; // (SP + 0xC) - x offset uint16_t y_offset; // (SP + 0x10) - y offset uint16_t unknown2; // (SP + 0x14) - uint32_t language1; // (SP + 0x18) - language id 1 uint32_t language2; // (SP + 0x1C) - language id 2 uint32_t funcAddress; // (SP + 0x20) - function address )</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hay cuatro tipos de descripciones de recursos: </font></font><br><br><pre> <code class="plaintext hljs">struct UIDescType0Header struct UIDescType1Header struct UIDescType2 struct UIDescType3 { { { { uint32_t address; uint32_t address; uint32_t reg; uint16_t x_offset; uint16_t entries; uint16_t entries; uint32_t address; uint16_t y_offset; uint16_t unknown; uint16_t unknown; uint16_t unknown1; uint32_t address; } } uint16_t unknown2; } uint16_t unknown3; struct UIDescType0Entry struct UIDescType1Entry uint16_t tableoff; { { } uint16_t x_offset; uint16_t x_offset; uint16_t y_offset; uint16_t y_offset; uint32_t address; uint32_t address; } uint16_t objects; uint16_t total_w; uint16_t total_h; uint16_t unknown; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El primer tipo tiene un encabezado con una referencia a una matriz de registros. Cada registro tiene coordenadas y una direcci√≥n para datos de p√≠xeles. El tipo actual parece describir elementos dependientes del estado, como iconos, que pueden estar atenuados o desaparecer de la interfaz de usuario. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El segundo tipo tambi√©n comienza con un encabezado y se utiliza para localizar, describir l√≠neas o bloques de texto. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El tercer tipo describe mapas de caracteres para diferentes idiomas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El √∫ltimo tipo es responsable de todos los dem√°s recursos est√°ticos, como im√°genes, fondos, etc. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora echemos un vistazo a los datos de las im√°genes mismas. </font><font style="vertical-align: inherit;">Los primeros seis bytes se ven como un encabezado peque√±o, seguido de alg√∫n tipo de patr√≥n repetitivo, donde cada segundo byte es </font><font style="vertical-align: inherit;">, o </font><font style="vertical-align: inherit;">. Es l√≥gico suponer que </font><font style="vertical-align: inherit;">y</font></font><br><br> <code>+0x00: 00 08 00 14 00 01 A2 FF 0A 04 05 FF 0C 04 03 FF <br> +0x10: 0D 04 03 FF 0E 04 02 FF 0E 04 02 FF 04 04 06 FF <br> +0x20: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x30: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x40: 04 04 02 FF 04 04 06 FF 04 04 02 FF 04 04 06 FF <br> +0x50: 04 04 02 FF 04 04 06 FF 04 04 02 FF 0E 04 02 FF <br> +0x60: 0E 04 02 FF 0D 04 03 FF 0D 04 03 FF 0C 04 04 FF <br> +0x70: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x80: 04 04 0C FF 04 04 0C FF 04 04 0C FF 04 04 0C FF <br> +0x90: 04 04 0D FF 02 04 2D FF 00 06 00 14 00 01 79 FF</code> <br> <br><font style="vertical-align: inherit;"></font><code>0xFF</code><font style="vertical-align: inherit;"></font><code>0x04</code><font style="vertical-align: inherit;"></font><code>0x0008</code><font style="vertical-align: inherit;"></font><code>0x0014</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- ancho y alto en una vista con orden de bytes directo (big endian). Al final de este volcado, vemos el comienzo de otra secuencia </font></font><code>00 06 00 14 00 01</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Lo m√°s probable es que este sea el pr√≥ximo recurso (como lo confirma un enlace). Por lo tanto, el tama√±o de los datos reales de la imagen es de 146 bytes. Pero el tama√±o de la imagen debe ser 0x8 * 0x14 = 0xA0 = 160. Est√° claro que los datos no son p√≠xeles puros y ni siquiera un LUT de 8 bits, porque es 14 bytes m√°s peque√±o.</font></font> Entonces que?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablemente alg√∫n tipo de compresi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al observar este volcado hexadecimal, es dif√≠cil creer que se utilice alg√∫n tipo de esquema complejo. La GUI de Leica no es muy colorida, por lo que, en mi experiencia, es mejor usar la tabla LUT aqu√≠. En este caso, los recursos de la interfaz de usuario repetir√°n completamente los √≠ndices LUT como </font></font><code>03 03 03</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">o </font></font><code>1 1 1</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Por lo general, el compresor intenta deshacerse de la duplicaci√≥n de datos, reemplaz√°ndolos con un enlace. Estas matrices de √≠ndice son ideales para la compresi√≥n incluso con un m√©todo simple como RLE </font></font><code>[data][number]</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Un comando simple para escribir </font></font><code>data</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(valor) </font></font><code>number</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">veces. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con todo esto en mente, suger√≠ que probablemente veamos una imagen simple con dos colores LUT ( </font></font><code>0xFF</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>0x04</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">), y el byte delante del color es el n√∫mero de p√≠xeles que se dibujar√°n.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">"Y luego escribiste otro instrumento", piensas. Pero no, tom√© un bol√≠grafo y papel y comenc√© a llenar las celdas. Es curioso que todav√≠a tenga esa foto. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/743/b4a/1f3/743b4a1f3a65f485760e8a4f0584d2e6.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En alg√∫n momento, me di cuenta de que 160 p√≠xeles no son suficientes para esta imagen, por lo que 0x8 y 0x14 deben multiplicarse por dos. La tercera palabra 0x0001 indica si la imagen es un car√°cter ASCII, por lo que la estructura final de ImageAsset es la siguiente:</font></font><br><br><pre> <code class="plaintext hljs">struct ImageAsset { uint16_t width; // /2 (big endian) uint16_t height; // /2 (big endian) uint16_t ascii; // 1,   ASCII struct image_data { uint8_t number; //     uint8_t color; //     LUT } data[]; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero todav√≠a falta una parte: LUT. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No fue tan dif√≠cil de encontrar, ya que muchos enlaces y estructuras ya se restauraron manualmente, por lo que lentamente me desplac√© por las secciones de datos, buscando una matriz de 256 elementos de valores de 16 bits o 32 bits, hasta que me encontr√© con esto: de </font><font style="vertical-align: inherit;">nuevo, gracias En mi trabajo con Blackmagic Design, inmediatamente reconoc√≠ los p√≠xeles YUV (por ejemplo, todos los valores con los n√∫meros 8080). </font><font style="vertical-align: inherit;">No soy un tonto para volver a dibujar toda la interfaz de usuario manualmente en papel, as√≠ que s√≠, escrib√≠ otra herramienta: </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">M240UITool</font></a><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Adem√°s de restablecer todos los recursos de imagen del archivo de firmware a BMP / PNG, esta herramienta puede crear scripts IDC en IDA para determinar todos los recursos de la interfaz de usuario.</font></font><br><br> <code>.long 0x7008080, 0x72D8080, 0x73C8080, 0x75A8080, 0x79B8080, 0x71DFF6B, 0x7BE8080, 0x7FF8080 <br> .long 0x77BBD27, 0x75B60E7, 0x7835F4A, 0x7D3089F, 0x7018080, 0x7028080, 0x7038080, 0x7048080 <br> .long 0x7058080, 0x7068080, 0x7078080, 0x7088080, 0x7098080, 0x70A8080, 0x70B8080, 0x70C8080 <br> .long 0x70D8080, 0x70E8080, 0x70F8080, 0x7108080, 0x7118080, 0x7128080, 0x7952B15, 0x7138080 <br> .long 0x7148080, 0x7158080, 0x7168080, 0x7178080, 0x7188080, 0x7198080, 0x71A8080, 0x71C8080 <br> .long 0x71D8080, 0x71E8080, 0x71F8080, 0x7338080, 0x7208080, 0x7218080, 0x7228080, 0x7238080 <br> .long 0x7248080, 0x7248080, 0x7268080, 0x7278080, 0x7288080, 0x7298080, 0x72A8080, 0x72B8080 <br> .long 0x72C8080, 0x75E8080, 0x7608080, 0x7628080, 0x7648080, 0x7678080, 0x7688080, 0x7698080 <br> .long 0x76B8080, 0x76E8080, 0x7708080, 0x7728080, 0x7758080, 0x7778080, 0x7798080, 0x77C8080 <br> .long 0x77E8080, 0x7818080, 0x7838080, 0x7868080, 0x7888080, 0x78B8080, 0x78D8080, 0x7908080 <br> .long 0x7928080, 0x7958080, 0x7978080, 0x7998080, 0x79C8080, 0x79D8080, 0x7668080, 0x79E8080 <br> .long 0x7A18080, 0x7A28080, 0x7A38080, 0x7A68080, 0x7A78080, 0x7A88080, 0x7AB8080, 0x7AC8080 <br> .long 0x7AD8080, 0x7B08080, 0x7B28080, 0x7B58080, 0x7B88080, 0x7B98080, 0x7BC8080, 0x7CC8080 <br> .long 0x7AB3BBB, 0x7E10094, 0x7E4556E, 0x4008080, 0x2922D17, 0x7B2AB00, 0x7C2A262, 0x71DFF6B <br> .long 0x768D4A2, 0x769D4EA, 0x7BD88AE, 0x705997B, 0x70BB377, 0x711CC73, 0x717E66F, 0x7238866 <br> .long 0x729A262, 0x72FBB5E, 0x735D55A, 0x7417751, 0x747914D, 0x74DAA48, 0x753C444, 0x75F663B <br> .long 0x76B9933, 0x7998080, 0x771B32F, 0x77D5526, 0x7836F22, 0x789881E, 0x78FA21A, 0x7159095 <br> .long 0x71AAA91, 0x720C38D, 0x726DD88, 0x7506F6A, 0x7568866, 0x75CA262, 0x762BB5E, 0x76E5E55 <br> .long 0x7747751, 0x77A914D, 0x780AA48, 0x78C4D3F, 0x792663B, 0x7988037, 0x79E9933, 0x7AA3C2A <br> .long 0x7B05526, 0x7B66F22, 0x7BC881E, 0x72488AE, 0x72AA1AA, 0x72FBBA6, 0x735D4A2, 0x7427799 <br> .long 0x7489095, 0x74DAA91, 0x753C38D, 0x77E556E, 0x7836F6A, 0x7898866, 0x78FA262, 0x79C4459 <br> .long 0x7A15E55, 0x7A77751, 0x7AD914D, 0x7BF4D3F, 0x7CC8080, 0x7C5663B, 0x7CB8037, 0x7337FC8 <br> .long 0x73999C4, 0x73FB2C0, 0x745CCBB, 0x7757799, 0x74C54FF, 0x77B9095, 0x780AA91, 0x7AB3C72 <br> .long 0x7B1556E, 0x7B66F6A, 0x7BC8866, 0x74277E1, 0x74890DD, 0x74EAAD9, 0x754C3D5, 0x76066CC <br> .long 0x7667FC8, 0x76C99C4, 0x772B2C0, 0x77E55B7, 0x7846EB3, 0x78A88AE, 0x790A1AA, 0x7526EFB <br> .long 0x75787F7, 0x75DA1F3, 0x763BAEE, 0x76F5DE6, 0x77577E1, 0x77B90DD, 0x781AAD9, 0x78D4CD0 <br> .long 0x79366CC, 0x79F99C4, 0x7E10094, 0x7CF44A1, 0x7DB7799, 0x7E71A90, 0x7ED338C, 0x7FF8080 <br> .long 0x7328080, 0x7DC8080, 0x7C88080, 0x7508080, 0x775CD2C, 0x76944EA, 0x7808080, 0x71A61FF <br> .long 0x7244D40, 0x7242C15, 0xFFF8080, 0xF338080, 0xF668080, 0xF998080, 0xFCC8080, 0xF008080 <br> .long 0xF4C54FF, 0xFAB3BBB, 0xFE10094, 0xFE4556E, 0xF952B15, 0xFDA7751, 0xFB2AB00, 0xFC2A262 <br> .long 0xF1DFF6B, 0xF68D4A2, 0xF69D4EA, 0xFBD88AE, 0xA922D17, 0xC6E4130, 0xE286963, 0x74C55FF <br> .long 0x768D536, 0x7FF8080, 0x7FF8080, 0x7FF8080, 0x2922D17, 0x46E4130, 0x6286963, 0x8080</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><br><br> <code>Leica M (typ 240) UI Tool v1.0 <br> Usage: ./M240UITool [-a address] [-i imagebase] [-s script] [-d dump] [-f folder] [-l LUT] [-rbv] FIRMWARE.BIN <br> <br> This tool will help you to find UI resources in firmware. <br> Use following arguments: <br> -a Specify address of the gui_CopyImageDesc function (ex. 0x2F95E0) <br> -i Specify firmware imagebase <br> -s Specify IDC file name <br> -c Specify container file name <br> -d Specify dump image format <br> png - PNG format <br> bmp - BMP (ARGB) format <br> -f Specify folder for dumped images <br> -l Specify LUT for images (filename of address) <br> -b Specify number of bytes to display in verbose mode <br> -r Try to recover string characters <br> -v Be verbose</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya sabemos que por la funci√≥n que crea una p√°gina de IU, se llama varias veces </font></font><code>gui_CopyImageDesc</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Pens√© que ser√≠a genial hacer un navegador de recursos de interfaz de usuario y definir todas las caracter√≠sticas de representaci√≥n de la p√°gina. </font><font style="vertical-align: inherit;">La opci√≥n </font></font><code>-c</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">est√° </font><font style="vertical-align: inherit;">destinada a esto </font><font style="vertical-align: inherit;">: crea un contenedor especial para ver recursos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øY qui√©n dijo que un navegador de recursos de la interfaz de usuario podr√≠a no parecer inusual? </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b6/5f7/6c3/8b65f76c30a4d4a037719e805141573a.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al ser interactiva (botones transl√∫cidos en la captura de pantalla), esta herramienta le permite no solo desplazarse por las p√°ginas del men√∫ EVF / LCD, sino tambi√©n ver los pasos de representaci√≥n dentro de una p√°gina. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desafortunadamente, el c√≥digo fuente de esta obra maestra se perdi√≥ en alguna parte, pero los archivos de encabezado todav√≠a est√°n en el c√≥digo M240UITool, por lo que t√©cnicamente puede recrearlo desde cero.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Men√∫ de depuraci√≥n </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQu√© l√≠nea estamos buscando principalmente cuando la ingenier√≠a inversa? En mi opini√≥n, esta palabra </font></font><code>debug</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y sus derivados. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hab√≠a muchas l√≠neas interesantes en el firmware, pero estas son especiales: </font><font style="vertical-align: inherit;">parece que puede ingresar al modo de depuraci√≥n usando alguna combinaci√≥n de teclas. Todas estas l√≠neas se llaman desde una funci√≥n gigante </font><font style="vertical-align: inherit;">, que implementa una m√°quina de estado de exploraci√≥n de botones. As√≠ es como se ve en la IDA:</font></font><br><br> <code>$ strings ./IMG_LOKI-212_1.1.0.2.bin | grep "Debug Mode" <br> GUI: State: %d! Scanning for Debug Mode successful <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> GUI: Scanning for Debug Mode: State: %d, Ignore long DEL <br> GUI: Scanning for Debug Mode: State: %d <br> ... <br> GUI: ScanningForDebugWithKeyAndJoyStick(): g_GUI_CheckForDebugWithKeyAndJoyStick = %d</code> <br> <br><font style="vertical-align: inherit;"></font><code>ScanningForDebugWithKeyAndJoyStick</code><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e9e/525/cd2/e9e525cd2bc493e7bb8cc4b3710b1334.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No mentir√©, me tom√≥ un tiempo entender c√≥mo se procesan los botones de hardware en el firmware y luego restaurar los tipos enumerados para los botones y el joystick. Pero cuando obtuve la combinaci√≥n, descubr√≠ con disgusto que ella no estaba haciendo nada. Probablemente solo funciona desde una p√°gina GUI espec√≠fica. Un par de noches m√°s de rastreo manual de la m√°quina de estado GUI, y el problema est√° resuelto, y tambi√©n logramos encontrar la p√°gina del men√∫ Restablecer. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, bienvenido al modo de depuraci√≥n. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/526/74d/068/52674d068ae127cc7b90b5b1172de325.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pens√© mucho en anunciar esta combinaci√≥n, pero decid√≠ abstenerme. Respeto el arduo trabajo que realiza Leica, lanzando sus dispositivos √∫nicos, y no quiero ser responsable del hecho de que sus centros de servicio llenen los cad√°veres rotos de las c√°maras como resultado de una curiosidad irreflexiva.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pero a√∫n as√≠, proporcionar√© algunos tipos enumerados para simplificar la ingenier√≠a inversa para aquellos que est√°n listos para seguir este camino. </font></font><br><br><pre> <code class="plaintext hljs">enum ControlActionType { kControlAction_Idle, // 0 kControlAction_Push, // 1 kControlAction_Release, // 2 kControlAction_LongPush // 3 }; enum ControlBtnType { kControlBtn_LV, // 0 kControlBtn_PLAY, // 1 kControlBtn_DEL, // 2 kControlBtn_ISO, // 3 kControlBtn_MENU, // 4 kControlBtn_SET // 5 }; enum ControlJoystickType { kControlJoy_INFO, // 0 kControlJoy_Up, // 1 kControlJoy_Down, // 2 kControlJoy_Left, // 3 kControlJoy_Right // 4 };</code> </pre> <br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pensando en la tarea USB, defin√≠ tres modos (que tambi√©n se confirma en el men√∫ de depuraci√≥n): </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Ptp </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> MSC (clase de almacenamiento masivo) </font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Leica personalizada </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PTP es muy interesante porque est√° bien documentado y le permite controlar la c√°mara. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es bastante f√°cil encontrar controladores PTP en el firmware, porque hay muchas llamadas de este c√≥digo. </font><font style="vertical-align: inherit;">Todas las llamadas PTP se dividen en tres grupos: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Legacy</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica Extended (LE)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Production</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los mensajes de depuraci√≥n ayudaron a establecer nombres para casi todo el c√≥digo.</font></font><br><br><pre><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Legado: Leica Extendido: Producci√≥n:                           </font></font><font></font><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
0x1001 - GetDeviceInfo 0x9001 - Establecer la configuraci√≥n de la c√°mara 0x9100 - Abrir sesi√≥n de producci√≥n      </font></font><font></font>
0x1002 - OpenSession 0x9002 - Get Camera Settings 0x9101 - Close Production Session     <font></font>
0x1003 - CloseSession 0x9003 - Get Lens Parameter 0x9102 - UpdateFirmware               <font></font>
0x1004 - Get Storage ID 0x9004 - Release Stage 0x9103 - Open OSD Session             <font></font>
0x1005 - Get Storage Info 0x9005 - Open LE Session 0x9104 - Close OSD Session            <font></font>
0x1006 - GetNumObjects 0x9006 - Close LE Session 0x9105 - Get OSD Data                 <font></font>
0x1007 - GetObjectHandles 0x9007 - RequestObjectTransferReady 0x9106 - GetFirmwareStruct            <font></font>
0x1008 - GetObjectInfo 0x9008 - GetGeoTackingData 0x910B - GetDebugMenu                 <font></font>
0x1009 - GetObject 0x900A - Open Debug Session 0x910C - SetDebugMenu                 <font></font>
0x100A - Get Thumb 0x900B - Close Debug Session 0x910D - ODIN Message                 <font></font>
0x100B - Delete Object 0x900C - Get Debug Buffer 0x910E - GetDebugObjectHandles        <font></font>
0x100E - Initiate Capture 0x900D - Debug Command String 0x910F - GetDebugObject               <font></font>
0x1014 - GetDevicePropDesc 0x900E - Get Debug Route 0x9110 - DeleteDebugObject            <font></font>
0x1015 - GetDevicePropV 0x900F - SetIPTCData 0x9111 - GetDebugObjectInfo           <font></font>
0x101C - Initiate Open Capture 0x9010 - GetIPTCData 0x9112 - WriteDebugObject             <font></font>
                                   0x9020 - Get3DAxisData 0x9113 - CreateDebugObject            <font></font>
                                   0x9030 - OpenLiveViewSession 0x9114 - Calibrate 3Daxis             <font></font>
                                   0x9031 - CloseLiveViewSession 0x9115 - Magnetic calibration         <font></font>
                                   0x9033 - Unknown 0x9116 - Get Viewfinder Data </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La implementaci√≥n de la interfaz PTP en s√≠ misma parece est√°ndar, pero algunos comandos tienen limitaciones que omito intencionalmente aqu√≠. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En cualquier caso, todo lo anterior es bastante emocionante. </font><font style="vertical-align: inherit;">Puede pensar: "Solo conectemos la c√°mara a trav√©s de USB y comencemos a sondear con libptp".</font></font> Eso es correcto <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maldita sea ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica M240 no tiene un puerto USB.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Puerto de la manija </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Leica ofrece algunos accesorios para esta c√°mara, pero hay uno especialmente interesante. </font><font style="vertical-align: inherit;">Estamos hablando del </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mango multifunci√≥n Leica M (14495)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Reemplaza la parte met√°lica inferior de la carcasa, proporciona GPS incorporado y varios conectores como USB, un terminal de flash SCA, DIN / ISO-X y una toma de corriente. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fab/250/1b6/fab2501b6e69cb6caf3f62528e413bdb.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y usted dice de nuevo: "Genial, ahora solo c√≥mprelo, con√©ctelo a la c√°mara, conecte la c√°mara a trav√©s de USB y comience a probar usando libptp".</font></font> Eso es correcto <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maldita sea ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cuesta casi 900 d√≥lares. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Estas son casi novecientas razones para crear su propio adaptador. </font><font style="vertical-align: inherit;">Sin embargo, por si acaso, configur√© notificaciones de eBay para este accesorio.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Conector </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El conector de la c√°mara es el siguiente: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a29/4f0/388/a294f0388ad2c5ac3d355d0838e01586.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">intent√© encontrarlo en Internet, pero en serio, ¬øc√≥mo lo describir√≠as en Google? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Desesperado un poco, comenc√© a pensar en algunas cosas locas, como pegar papel de aluminio o agujas a una goma de borrar. Pero una vez en el trabajo en Blackmagic Design, mirando la placa de circuito de la c√°mara, not√© que uno de los conectores ten√≠a una forma muy familiar. Al d√≠a siguiente traje mi Leica M240 al trabajo, y s√≠, se ve√≠a similar, mucho m√°s tiempo con muchas almohadillas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Queda por solicitar el n√∫mero de pieza de nuestro administrador de componentes y luego encontrarlo en el cat√°logo de Samtec: </font></font><b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ERM8-013-05.0-L-DV-TR</font></font></a></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a60/dc3/d36/a60dc3d36d12216f74690577507fc6db.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambi√©n le preguntamos a Samtec si era posible obtener una muestra, y ellos aceptaron amablemente.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/dda/752/0d6/dda7520d6691fc48f3f1aaa026e49635.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Un poco de trabajo con un soldador, cart√≥n y cinta aislante, y mi propio enchufe est√° listo (muestra de 2013). </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ddd/243/fe5/ddd243fe596648709c3f9dccb76f15ea.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cinco a√±os despu√©s, en 2018, decid√≠ pedirle personalmente a Samtec que enviara otra muestra. </font><font style="vertical-align: inherit;">Quer√≠a hacer algo mejor. </font></font><br><br> <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ERCD-013-05.00-TTR-TTR-1-D</font></font></a></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/e1a/56a/995/e1a56a9958b1dda50aca34f0ecac8863.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Nuevamente, mucho trabajo con un soldador, jurar, cortar alambre, jurar, nuevamente trabajar con un soldador para hacer una opci√≥n nueva y m√°s atractiva:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/1a5/b78/10d/1a5b7810d3a2ccea73bf4e2d75cad8cd.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Pinout </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay 26 contactos en el conector: 13 en cada lado. Incluso antes de soldar mi parte, prob√© el conector de la c√°mara con un mult√≠metro y un analizador l√≥gico. Por cierto, debe colocar un im√°n en el sensor de la cubierta inferior para que la c√°mara considere que la cubierta est√° en su lugar. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tierra (c√°mara apagada, sin bater√≠a)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Siempre comienzo desde el suelo porque es seguro y muy f√°cil de encontrar. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ead/140/15c/ead14015c97177d6717e198616c9114b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, tenemos ocho l√≠neas de tierra (gris oscuro). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Potencial (c√°mara encendida)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Cuando la c√°mara est√° encendida, puede medir el potencial en cada pin y tener una idea de la l√≥gica y los niveles de potencia. </font></font><br><br> <a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alexhude.github.io/assets/2019/2019-01-24-hacking-leica-m240/probe2_potential.png</font></font></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El rendimiento en los pines 8‚Äì9 y 11‚Äì13 es demasiado alto para los pines l√≥gicos, por lo que los defin√≠ como potencia (rojo). </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Resistencia (c√°mara apagada, sin bater√≠a)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es √∫til para medir la resistencia. En algunos casos, esto ayuda a identificar las entradas y agrupar algunas l√≠neas. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/fa7/fde/1a6/fa7fde1a623a5f13d264a5127a3083d2.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Salidas conectadas (c√°mara apagada, sin bater√≠a)</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Luego decid√≠ verificar todas las almohadillas externas en el cuerpo de la c√°mara para verificar si est√°n conectadas al puerto de servicio. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f75/61e/c06/f7561ec060796fa8e39a15d533e3de03.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El contacto de sincronizaci√≥n del flash se conect√≥ directamente a la l√≠nea 10. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Analizador l√≥gico (c√°mara encendida) Los</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> datos de cada l√≠nea se registraron en la siguiente secuencia: encienda, la c√°mara debe estar en modo LV, tomar una foto, iniciar la grabaci√≥n de video.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/494/33c/27c/49433c27cf94be5cb9430e4ba518560c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dos l√≠neas muestran la transmisi√≥n de algunos datos: 01 y 21. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">01</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmisi√≥n de 8 bits, 1 bit de parada, bit de paridad, LSB primero. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bf7/3a2/fdf/bf73a2fdfbbfeab571c354f2a6d50c9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cada 500 ms, env√≠a un contador </font></font><code>C3 3C 02 81 00 01 00 82, C3 3C 02 81 01 01 00 83, C3 3C 02 81 02 01 00 80</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">... </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">21</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - 115200, transmisi√≥n de 8 bits, 1 bit de parada, sin bit de verificaci√≥n de paridad, LSB primero. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f00/423/2dd/f004232dd3f1b8c8f0e665fd63f3fa9b.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Env√≠a el registro del cargador de arranque a SH7216 ("Leica Camera AG" en la captura de pantalla anterior). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos a marcarlos de azul oscuro. Es bastante triste que el registro de Maestro no salga incluso con la configuraci√≥n m√°xima de depuraci√≥n en el men√∫ Depurar. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c44/541/bb9/c44541bb98c4388f151bdc3faffa1dfe.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En estos contactos, la resistencia es de aproximadamente 310kOhm.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">No s√© por qu√©, pero suger√≠ que otras l√≠neas de datos pueden tener una resistencia similar o se cerrar√°n. Por lo tanto, defin√≠ las l√≠neas ~ 300kOhm, ~ 200kOhm y ~ 100kOhm como l√≠neas de datos (sombras de azul en la imagen). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En general, se dibuj√≥ la siguiente imagen. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e7e/31f/f2c/e7e31ff2cc7da6ae304652488ca9db4c.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">12 candidatos en la l√≠nea de datos. ¬øPero c√≥mo verificarlos? Despu√©s de una breve conversaci√≥n con los expertos en hierro sobre la protecci√≥n el√©ctrica de los circuitos integrados, comenc√© a introducir contactos a trav√©s de una resistencia de 4kOhm, lo que reduce la corriente a un nivel que las entradas no deber√≠an quemar.</font></font><br><br><h4>  UART </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hice otra suposici√≥n de que la l√≠nea RX deber√≠a estar cerca del TX. </font><font style="vertical-align: inherit;">Las l√≠neas 02, 03 y 20 parecen buenas candidatas porque ambas tienen un voltaje de 3.3 V como TX. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Inicialmente, intent√© explorar estas l√≠neas usando Bus Pirate. </font><font style="vertical-align: inherit;">Lamentablemente, el resultado fue bastante sucio. </font><font style="vertical-align: inherit;">Luego tom√© los cables basados ‚Äã‚Äãen SiLabs como m√°s confiables y no conflictivos en macOS. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Primero, conect√© el cable TX al pin 20 y comenc√© a escribir </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">despu√©s del gestor de arranque. </font><font style="vertical-align: inherit;">Como era de esperar, despu√©s de un breve retraso, la c√°mara repiti√≥ los personajes. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/a16/445/c00/a16445c00b6a22a6b37b74c97fc97ca5.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los contactos 02 y 03 fueron los pr√≥ximos candidatos para UART. </font><font style="vertical-align: inherit;">Desafortunadamente, no hab√≠a se√±ales de que estas l√≠neas estuvieran siendo tocadas. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En el diagrama, los UART conocidos est√°n indicados por un tono m√°s oscuro de verde.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/733/f68/fa1/733f68fa1950518017ad2c09971ac1f8.png"><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> USB </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo comenz√≥ con cortar un cable USB por la mitad con un encabezado en el medio y resistencias de 4kOhm para la detecci√≥n. </font><font style="vertical-align: inherit;">Integridad de la se√±al de un par diferencial? </font><font style="vertical-align: inherit;">No, entonces no me importaba.</font></font> :) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/891/930/5d3/8919305d35cd2525d420313c2b0e7555.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego prob√© varios dispositivos dom√©sticos USB en casa para tener una idea de c√≥mo son las comunicaciones en este puerto. </font><b><font style="vertical-align: inherit;">C√°mara </font></b></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canon </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/c49/f85/cf8/c49f85cf89650352531c83c970eb609c.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Blackmagic </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/8b7/7e5/bc8/8b77e5bc8c2fa3387083a8e8ec12c3db.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Videoc√°mara de </font></font></b> <font style="vertical-align: inherit;"><b><font style="vertical-align: inherit;">bolsillo </font></b><b><font style="vertical-align: inherit;">Canon </font></b></font><br><img src="https://habrastorage.org/getpro/habr/post_images/17f/dd4/67a/17fdd467a6627a4129f38d6e476d4ffc.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Videoc√°mara JVC Videoc√°mara </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/757/80d/4c8/75780d4c8a85c55c04afe5de9209e09d.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Llavero </font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/ad9/3a6/382/ad93a63828797eaea1f5d906367b792f.png"><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C√°mara KidiZoom</font></font></b> <br><img src="https://habrastorage.org/getpro/habr/post_images/32e/d73/13a/32ed7313a12ef1cef1444a87c22f3c77.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Todos son un poco diferentes, pero el estado inicial D-D + es bajo. </font><font style="vertical-align: inherit;">Bueno, lo sabremos, y ahora comprobaremos que tenemos:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">22</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - poco probable, porque D-D + es un par diferencial y deber√≠a estar bastante cerca;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">04/05</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - es poco probable porque tienen resistencia diferente;</font></font><br></li><li> <b>14/15</b> ‚Äî ,      ; <br></li><li> <b>15/16</b> ‚Äî ,        . </li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">As√≠ que conect√© el USB D-D + a los pines 15/16 y lo conect√© al iMac ... </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/777/491/b7f/777491b7f4a3b4b0f8376931db78c6c8.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En la pantalla USB PTP, pero la c√°mara no apareci√≥ en el host. Trat√© de configurar diferentes opciones en el dise√±o del circuito electr√≥nico, pero nada funcion√≥. Beagle mostr√≥ muchos paquetes da√±ados y otros errores. Al final, me di por vencido y volv√≠ a la ingenier√≠a inversa del firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es el pinout final, el USB est√° marcado en verde oscuro. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/2ad/07d/289/2ad07d289a684e6db69a02ae9e50c294.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬øQui√©n hubiera pensado que unos a√±os m√°s tarde esa misma notificaci√≥n de eBay vendr√° a m√≠ y comprar√© el accesorio deseado de forma bastante econ√≥mica? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finalmente, puedo probar mis suposiciones sobre PTP. Pero al principio era muy curioso c√≥mo se ve el USB PHY dentro del dispositivo. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/afe/0b1/afc/afe0b1afc09953f7f9c6dbc451c47c56.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dentro estaba el hub </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">SMSC 2512b</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">justo en el camino desde el conector de la manija al conector Mini USB. El chip funciona en modo predeterminado porque no hay pines EEPROM o SCL / SDA. El primer puerto descendente se enruta a un z√≥calo en el cuerpo de la c√°mara, pero el segundo no est√° conectado a nada. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Probablemente me perd√≠ algo, pero para m√≠ esa soluci√≥n no tiene mucho sentido. El pasaporte t√©cnico dice que el chip tiene "pines USB completamente integrados, as√≠ como resistencias para subir y bajar el voltaje". Quiz√°s los ingenieros de Leica decidieron no implementar su propio PHY USB, pero usaron el que est√° en el concentrador, que est√° bien probado y funciona de inmediato. De hecho, no puedo culparlos, porque antes intent√© hacer esto, y result√≥ ser una tarea dif√≠cil. Tal vez esta es una caracter√≠stica de protecci√≥n contra la falsificaci√≥n, qui√©n sabe.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> En cualquier caso, si comprende USB PHY y est√° listo para ayudar, no dude en escribirme: deber√≠a ser posible trabajar a trav√©s de un puerto USB sin este accesorio de marca :) </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> PTP nuevamente </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como dije, es hora de jugar con la extensi√≥n Leica PTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Afortunadamente, encontr√© una biblioteca C ++ bastante buena en lugar de libptp: es </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">libEasyPTP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Tampoco me llev√≥ mucho tiempo escribir una herramienta basada en esta biblioteca: ya conoc√≠a algunas limitaciones en la interfaz Leica PTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y aunque M240PTPTool es bastante defectuoso, es bastante adecuado para el papel de prueba de concepto ( </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">c√≥digo de programa</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Solo dos solicitudes pasan por PTP: </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GetDebugBuffer (0x900C)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">DebugCommandString (0x900D)</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por cierto, para que los m√≥dulos completen el registro de depuraci√≥n, debe establecer el Nivel de depuraci√≥n como "Debug" o "Debug RAW" en el men√∫. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hay varias opciones en la interfaz M240PTPTool:</font></font><br><br><ul><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">salir</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : cierra la herramienta;</font></font><br></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">flush</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - fusionar el b√∫fer de depuraci√≥n de la c√°mara:</font></font></li></ul><br> <code>M240&gt; flush <br> I:[00:11:468]|01| DATE/TIME CORRECTED by 5921 sec <br> D:[00:12:079]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:179]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:282]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:283]|11| Message received from TID 0 for TID 1 over MBX 3 <br> D:[00:12:301]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:402]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> D:[00:12:502]|00| Send message from TID 0 to TID 1 over MBX 3 - length: 4 - MesgID: 0x22020103 <br> ...</code> <br> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cualquier otro texto se env√≠a a la c√°mara como un comando de depuraci√≥n. </font><font style="vertical-align: inherit;">Por ejemplo, </font></font><code>help</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muestra todos los comandos posibles con argumentos: la </font><font style="vertical-align: inherit;">lista completa es bastante grande, pero mira, ¬°puedes enviar mensajes directos a Softune para cualquier tarea! </font><font style="vertical-align: inherit;">Qu√© ser√≠a tan interesante enviar all√≠ ... </font><font style="vertical-align: inherit;">Otra l√≠nea popular que a menudo se busca en el firmware es </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">A ver si tenemos uno. </font><font style="vertical-align: inherit;">Aparentemente, puede volcar el firmware en la tarjeta SD. </font><font style="vertical-align: inherit;">Usando el enlace a la l√≠nea "Volcar archivos a la tarjeta", es f√°cil encontrar el c√≥digo responsable de esto. </font><font style="vertical-align: inherit;">Se encuentra en el bloque gigante de tareas del sistema (pid 11, como ya sabemos) y el mensaje lo invoca </font><font style="vertical-align: inherit;">sin argumentos. </font><font style="vertical-align: inherit;">Dial </font><font style="vertical-align: inherit;">en </font><b><font style="vertical-align: inherit;">M240PTPTool</font></b><font style="vertical-align: inherit;"> , pulse Intro y vistazo a la pantalla.</font></font><br><br> <code>M240&gt; help <br> ********* debug command description ******** <br> <br> exposure request <br> Description: requests a release from Sub CPU <br> Parameter 1: Exposure Time TV <br> <br> still request <br> Description: simulates the -still request- command flow of Sub CPU <br> Parameter: no <br> <br> ... <br> <br> send Message;[Parameter1];[Parameter2];[Parameter2];...;... <br> Description: Sending Message to Task <br> Parameter 1: Receiver Task ID <br> Parameter 2: Command ID <br> Parameter 3: Command Data[0] (32 Bit) <br> Parameter 4: Command Data[1] (32 Bit) <br> Parameter 5: . <br> Parameter 6: . <br> use maximum 10 Parameter <br> <br> ...</code> <br> <br><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>dump</code><font style="vertical-align: inherit;"></font><br><br> <code>$ strings IMG_LOKI-212_1.1.0.2.bin | rg -i dump <br> GUI: HEX DUMP: Address: %x, Length: %d <br> HSK: DBG_WRITE_ROM_DUMP_SD: File was properly opened, but it seems to be empty. <br> ROM_DUMP <br> HSK: DBG_WRITE_ROM_DUMP_SD: Flushing Dump to ROM. Size %d <br> SD:\ROM_DUMP.bin <br> HSK: DBG_WRITE_ROM_DUMP_SD Command received! <br> ROM_DUMP.bin <br> HSK: DUMP failed, no cards inserted! <br> HSK: DUMP FlashROM to SD card. <br> HSK: DUMP FlashROM to CF card. <br> Dumping files to card</code> <br> <br><font style="vertical-align: inherit;"></font><code>0x11080006</code><font style="vertical-align: inherit;"></font><br><br><font style="vertical-align: inherit;"></font><code>send Message;11;0x11080006</code><font style="vertical-align: inherit;"></font><b><font style="vertical-align: inherit;"></font></b><font style="vertical-align: inherit;"></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/4de/1cc/e2e/4de1cce2e0ee47a67645df790a7e581c.jpg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Luego, retire la tarjeta SD y verifique qu√© contiene. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/209/2a8/25e/2092a825e23cb93c4845b416ea11b0e4.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ est√°, un volcado completo, incluido el firmware. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto abre infinitas posibilidades. </font><font style="vertical-align: inherit;">Por ejemplo, puede hacer un dispositivo peque√±o con un MCU, soporte para un host USB y botones para lanzar secuencias complejas de mensajes ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Y luego tuvimos un segundo hijo.</font></font> :) <br><br><h1>  Ep√≠logo </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si no desea romper el dispositivo, generalmente hay una manera de examinarlo sin abrir la carcasa o soldar los cables a la placa de circuito. </font><font style="vertical-align: inherit;">A continuaci√≥n est√°n mis consejos si est√° interesado:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">encuentre toda la informaci√≥n p√∫blica sobre el dispositivo: especificaciones t√©cnicas, datos sobre componentes, fotos del interior, </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">video de f√°brica</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ;)</font></font><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> si tiene firmware, profundice en √©l y busque consejos sobre salidas externas; </font></font><br></li><li>        ,     ; <br></li><li>  GND//    ,  ; <br></li><li>     ; <br></li><li>     ,   ; <br></li><li>   ,     (, ); <br></li><li>        ,    Google   (USB/UART/SPI/I2C/1Wire); <br></li><li>      ,      ; <br></li><li>  <s></s>  ,      ; <br></li><li>  ,    . </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/18b/006/166/18b006166a4070202c1be3a9b946c3e9.png"><br><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">github.com/alexhude</a> <br><br> <b>  !</b> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/438168/">https://habr.com/ru/post/438168/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../438152/index.html">"Puedo contarte sobre el dolor que cada desarrollador de iOS tiene en el culo" - 10 preguntas para un desarrollador, episodio 2</a></li>
<li><a href="../438158/index.html">Los corredores de datos de EE. UU. Venden datos de ubicaci√≥n sin el consentimiento del usuario: su trabajo estar√° regulado</a></li>
<li><a href="../438162/index.html">La tupla de una persona sana.</a></li>
<li><a href="../438164/index.html">Gen√©tica y pollos: prote√≠na CSF1-Fc humana en prote√≠na de huevo</a></li>
<li><a href="../438166/index.html">Interacci√≥n entre un sitio en un navegador y un programa que se ejecuta localmente</a></li>
<li><a href="../438170/index.html">Premio que lleva el nombre de Ilya Segalovich. Historia sobre inform√°tica y publicaciones de lanzamiento</a></li>
<li><a href="../438172/index.html">Apple no puede trasladar la producci√≥n de sus dispositivos a los EE. UU.</a></li>
<li><a href="../438174/index.html">Amarillo - Vac√≠o - Nube</a></li>
<li><a href="../438176/index.html">Descripci√≥n general de IPSec en Mikrotik</a></li>
<li><a href="../438178/index.html">Creando su primera aplicaci√≥n ARCore</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>