<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>๐ ๐ซ ๐ถ๐ฝ ูุญุงููุฉ ุฃุฏูุงุช ุฌุฏูุฏุฉ ูุจูุงุก ูุฃุชูุชุฉ ุงููุดุฑ ูู Kubernetes ๐๐ป โ ๐ผ๐ป</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="ุชุญูุฉ! ูู ุงูุขููุฉ ุงูุฃุฎูุฑุฉ ุ ุชู ุฅุทูุงู ุงูุนุฏูุฏ ูู ุฃุฏูุงุช ุงูุชุดุบูู ุงูุขูู ุงูุฑุงุฆุนุฉ ูุจูุงุก ุตูุฑ Docker ููููุดุฑ ุนูู Kubernetes. ูู ูุฐุง ุงูุตุฏุฏ ุ ูุฑุฑุช ุงููุนุจ ูุน gitlab ุ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ูุญุงููุฉ ุฃุฏูุงุช ุฌุฏูุฏุฉ ูุจูุงุก ูุฃุชูุชุฉ ุงููุดุฑ ูู Kubernetes</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481662/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/fu/wy/ia/fuwyia7huxrflvry8lzz2dbl2tw.png"></p><br><p style=";text-align:right;direction:rtl">  ุชุญูุฉ!  ูู ุงูุขููุฉ ุงูุฃุฎูุฑุฉ ุ ุชู ุฅุทูุงู ุงูุนุฏูุฏ ูู ุฃุฏูุงุช ุงูุชุดุบูู ุงูุขูู ุงูุฑุงุฆุนุฉ ูุจูุงุก ุตูุฑ Docker ููููุดุฑ ุนูู Kubernetes.  ูู ูุฐุง ุงูุตุฏุฏ ุ ูุฑุฑุช ุงููุนุจ ูุน gitlab ุ ูููููุฉ ุฏุฑุงุณุฉ ูุฏุฑุงุชู ุ ูุจุทุจูุนุฉ ุงูุญุงู ุ ุชูููู ุฎุท ุงูุฃูุงุจูุจ. </p><br><p style=";text-align:right;direction:rtl">  ูุงู ูุตุฏุฑ ุฅููุงู ูุฐุง ุงูุนูู ูู ูููุน <a href="https://kubernetes.io/" rel="nofollow">kubernetes.io</a> ุ ุงูุฐู ูุชู ุฅูุดุงุคู ุชููุงุฆููุง ูู <a href="http://github.com/kubernetes/website" rel="nofollow">ุฃููุงุฏ ุงููุตุฏุฑ</a> ุ ูููู ุชุฌูุน ูุชู ุฅุฑุณุงูู ุ ูููู ุงูุฑูุจูุช ุชููุงุฆููุง ุจุฅูุดุงุก ูุณุฎุฉ ูุนุงููุฉ ูููููุน ูุน ุชุบููุฑุงุชู ููููุฑ ุฑุงุจุทูุง ููุนุฑุถ. </p><br><p style=";text-align:right;direction:rtl">  ุญุงููุช ุฅูุดุงุก ุนูููุฉ ููุงุซูุฉ ูู ุงูุตูุฑ ุ ููููู ุงุนุชูุฏุช ุจุงููุงูู ุนูู Gitlab CI ูุงูุฃุฏูุงุช ุงููุฌุงููุฉ ุงูุชู ุงุนุชุฏุช ุงุณุชุฎุฏุงููุง ููุดุฑ ุงูุชุทุจููุงุช ูู Kubernetes.  ุงูููู ุณูู ุฃุฎุจุฑูู ุฃุฎูุฑูุง ุนููู. </p><br><p style=";text-align:right;direction:rtl">  ุณูู ุชูุธุฑ ุงูููุงูุฉ ูู ุฃุฏูุงุช ูุซู: <br>  <strong>Hugo</strong> ุ <strong>qbec</strong> ุ <strong>kaniko</strong> ุ <strong>git-crypt</strong> ู <strong>GitLab CI</strong> ูุน ุฅูุดุงุก ุจูุฆุงุช ุฏููุงููููุฉ. </p><a name="habracut"></a><br><hr><br><h1 id="coderzhanie" style=";text-align:right;direction:rtl">  ูุญุชููุงุช </h1><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุชูุฏูู ููุบู</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุฅุนุฏุงุฏ Dockerfile</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุงูุชุนุงุฑู ูุน ูุงูููู</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุชูุฏูู qbec</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ูุญุงููุฉ Gitlab- ุนุฏุงุก ูุน Kubernetes- ุงููููุฐ</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ูุดุฑ ูููู ุงูุฎุฑุงุฆุท ูุน qbec</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุฅุฏุฎุงู ุจูุงุจุฉ ุงููุจู</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุฅูุดุงุก ุตูุฑุฉ ูุฑุจุน ุงูุฃุฏูุงุช</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ูุฏููุง ุฃูู ุฎุท ุฃูุงุจูุจ ูุชุฌููุน ุงูุตูุฑ ุจุงูุนูุงูุงุช</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุฃุชูุชุฉ ุงููุดุฑ</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุงููุทุน ุงูุฃุซุฑูุฉ ูุฏูุน ุจูุงุก ูู ุงููุงุฌุณุชูุฑ</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ุงูุจูุฆุงุช ุงูุฏููุงููููุฉ</strong></a> </li><li style=";text-align:right;direction:rtl">  <a href="https://habr.com/ru/post/481662/"><strong>ูุฑุงุฌุนุฉ ุงูุชุทุจููุงุช</strong></a> </li></ol><br><hr><br><h1 id="1-znakomstvo-s-hugoanchorhugoanchor" style=";text-align:right;direction:rtl">  1. ุชูุฏูู ููุบู <a name="hugo"></a></h1><br><p style=";text-align:right;direction:rtl">  ููุซุงู ุนูู ูุดุฑูุนูุง ุ ุณูุญุงูู ุฅูุดุงุก ูููุน ููุจ ููุดุฑ ุงููุซุงุฆู ุงููุจููุฉ ุนูู Hugo.  ููุบู ูู ูููุฏ ูุญุชูู ุซุงุจุช. </p><br><p style=";text-align:right;direction:rtl">  ุจุงููุณุจุฉ ูุฃููุฆู ุงูุฐูู ููุณูุง ุนูู ุฏุฑุงูุฉ ุจูููุฏุงุช ุงูููุฑุจุงุก ุงูุณุงููุฉ ุ ุณูู ุฃุฎุจุฑูู ููููุงู ุนููู.  ุจุฎูุงู ูุญุฑูุงุช ูููุน ูุงุนุฏุฉ ุงูุจูุงูุงุช ุงูุนุงุฏูุฉ ูุจุนุถ ูุญุฑูุงุช php ุงูุชู ุ ุนูุฏ ุงููุทุงูุจุฉ ูู ูุจู ุงููุณุชุฎุฏู ุ ุชููู ุจุฅูุดุงุก ุตูุญุงุช ุฃุซูุงุก ุงูุทูุฑุงู ุ ูุชู ุชุฑุชูุจ ุงููููุฏุงุช ุงูุซุงุจุชุฉ ุจุดูู ูุฎุชูู ููููุงู.  ุฅููุง ุชุณูุญ ูู ุจุฃุฎุฐ ุงููุตุฏุฑ ุ ููุงุนุฏุฉ ุ ููู ุนุจุงุฑุฉ ุนู ูุฌููุนุฉ ูู ุงููููุงุช ูู ุนูุงูุงุช ุงูุชูููุฒ ูุงูููุงูุจ ุ ุซู ุชุฌููุนูุง ูู ูููุน ูุงูู ุงูุชุดุทูุจ. </p><br><p style=";text-align:right;direction:rtl">  ูุฐุง ูู ุ ูู ุงูุฅุฎุฑุงุฌ ุ ุณุชุญุตู ุนูู ุจููุฉ ุฏููู ููุฌููุนุฉ ูู ูููุงุช html ุงูุชู ุชู ุฅูุดุงุคูุง ุ ูุงูุชู ูููู ุชุญููููุง ุจุจุณุงุทุฉ ุฅูู ุฃู ุงุณุชุถุงูุฉ ุฑุฎูุตุฉ ูุงูุญุตูู ุนูู ูููุน ุนูู. </p><br><p style=";text-align:right;direction:rtl">  ูููู ุชุซุจูุช ููุบู ูุญูููุง ูุชุฌุฑุจุชู: </p><br><p style=";text-align:right;direction:rtl">  ูููุฆ ุงููููุน ุงูุฌุฏูุฏ: </p><br><pre style=";text-align:right;direction:rtl"><code class="bash hljs">hugo new site docs.example.org</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููู ุงูููุช ููุณู ูุณุชูุฏุน ุจูุงุจุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> docs.example.org git init</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุญุชู ุงูุขู ุ ูุนุฏ ูููุนูุง ุฃุณุงุณููุง ุ ูููู ูุธูุฑ ุนููู ุฃููุงู ุ ูุญุชุงุฌ ุฅูู ุชูุตูู ุณูุฉ ุฃู ุณูุฉ - ุฅููุง ูุฌุฑุฏ ูุฌููุนุฉ ูู ุงูููุงูุจ ูุงูููุงุนุฏ ุงููุญุฏุฏุฉ ูุณุจููุง ูุงูุชู ูุชู ูู ุฎูุงููุง ุฅูุดุงุก ูููุนูุง. </p><br><p style=";text-align:right;direction:rtl">  ูููุถูุน ุ ุณูู ูุณุชุฎุฏู <a href="https://themes.gohugo.io/hugo-theme-learn/" rel="nofollow"><strong>Learn</strong></a> ุ ูุงูุชู ุ ูู ุฑุฃูู ุ ูู ุงูุฃูุณุจ ููููุน ูุน ุงููุซุงุฆู. </p><br><p style=";text-align:right;direction:rtl">  ุฃูุฏ ุฅููุงุก ุงูุชูุงู ุฎุงุต ูุญูููุฉ ุฃููุง ูุณูุง ุจุญุงุฌุฉ ุฅูู ุญูุธ ูููุงุช ุงูุณูุงุช ูู ูุณุชูุฏุน ูุดุฑูุนูุง ุ ุจุฏูุงู ูู ุฐูู ูููููุง ุจุจุณุงุทุฉ ุชูุตููู ุจุงุณุชุฎุฏุงู <strong>git subodule</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git submodule add https://github.com/matcornic/hugo-theme-learn themes/learn</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุจุงูุชุงูู ุ ูุฅู ุงููููุงุช ุงููุฑุชุจุทุฉ ูุจุงุดุฑุฉ ุจูุดุฑูุนูุง ููุท ุณุชููู ูู ูุณุชูุฏุนูุง ุ ูุณูุธู ุงูููุถูุน ุงููุชุตู ูู ุดูู ุฑุงุจุท ุฅูู ูุณุชูุฏุน ูุญุฏุฏ ูุงูุงูุชุฒุงู ุจู ุ ุฃู ุฃูู ูููู ุฏุงุฆููุง ุณุญุจู ูู ุงููุตุฏุฑ ุงูุฃุตูู ูุนุฏู ุงูุฎูู ูู ุงูุชุบููุฑุงุช ุบูุฑ ุงููุชูุงููุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุฅุตูุงุญ <strong>config.toml</strong> ุงูุชูููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">baseURL = "http://docs.example.org/" languageCode = "en-us" title = "My Docs Site" theme = "learn"</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุจุงููุนู ูู ูุฐู ุงููุฑุญูุฉ ุ ููููู ุชุดุบูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">hugo server</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุนูู ุงููููุน <a href="http://localhost:1313/" rel="nofollow">http: // localhost: 1313 /</a> ุชุญูู ูู ูููุนูุง ุงูุฐู ุชู ุฅูุดุงุคู ุญุฏูุซูุง ุ ูุชู ุชุญุฏูุซ ุฌููุน ุงูุชุบููุฑุงุช ุงูุชู ุชู ุฅุฌุฑุงุคูุง ุนูู ุงูุฏููู ุชููุงุฆููุง ูุชููู ุงูุตูุญุฉ ุงูููุชูุญุฉ ูู ุงููุชุตูุญ ูุฑูุญุฉ ููุบุงูุฉ! </p><br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ูุญุงูู ุฅูุดุงุก ุตูุญุฉ ุบูุงู ูู <strong>ุงููุญุชูู / _index.md</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="markdown hljs"><span class="hljs-section"><span class="hljs-section"># My docs site ## Welcome to the docs! You will be very smart :-)</span></span></code> </pre> <br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ููุทุฉ ุดุงุดุฉ ููุตูุญุฉ ุงูุชู ุชู ุฅูุดุงุคูุง ุญุฏูุซูุง</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/gb/yx/nv/gbyxnvagfs6bks4iqbwcrrovumu.png"></p></div></div><br><p style=";text-align:right;direction:rtl">  ูุฅูุดุงุก ูููุน ุ ููุท ูู ุจุชุดุบูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">hugo</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุญุชููุงุช <strong>ุงูุนุงู /</strong> ุงูุฏููู ุณูููู ูููุนู. <br>  ูุนู ุ ุจุงูููุงุณุจุฉ ุ ุฏุนูุง ูุถูููุง ุนูู ุงูููุฑ ุฅูู <strong>.gitignore</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">echo /public &gt; .gitignore</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุง ุชูุณ ุฃู ุชูุชุฒู ุชุบููุฑุงุชูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git add . git commit -m "New site created"</code> </pre> <br><hr><br><h1 id="2-podgotovka-dockerfileanchordockerfileanchor" style=";text-align:right;direction:rtl">  2. ุฅุนุฏุงุฏ Dockerfile <a name="dockerfile"></a></h1><br><p style=";text-align:right;direction:rtl">  ููุฏ ุญุงู ุงูููุช ูุชุญุฏูุฏ ูููู ูุณุชูุฏุนูุง.  ุนุงุฏุฉู ูุง ุฃุณุชุฎุฏู ุดูุฆูุง ูุซู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">. โโโ deploy โ โโโ app1 โ โโโ app2 โโโ dockerfiles โโโ image1 โโโ image2</code> </pre> <br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>dockerfiles /</strong> - ุชุญุชูู ุนูู ุฃุฏูุฉ ูุน Dockerfiles ููู ูุง ุชุญุชุงุฌู ูุจูุงุก ุตูุฑ ุนุงูู ูููุงุก ูุฏููุง. </li><li style=";text-align:right;direction:rtl">  <strong>ูุดุฑ /</strong> - ูุญุชูู ุนูู ุฃุฏูุฉ ููุดุฑ ุชุทุจููุงุชูุง ุนูู Kubernetes </li></ul><br><p style=";text-align:right;direction:rtl">  ูุจุงูุชุงูู ุ ุณูููู ุจุฅูุดุงุก ุฃูู Dockerfile ูุฏููุง ุนูู ุทูู ูุณุงุฑ <strong>dockerfiles / website / Dockerfile</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">FROM alpine:3.11 as builder ARG HUGO_VERSION=0.62.0 RUN wget -O- https://github.com/gohugoio/hugo/releases/download/v<span class="hljs-variable"><span class="hljs-variable">${HUGO_VERSION}</span></span>/hugo_<span class="hljs-variable"><span class="hljs-variable">${HUGO_VERSION}</span></span>_linux-64bit.tar.gz | tar -xz -C /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin ADD . /src RUN hugo -s /src FROM alpine:3.11 RUN apk add --no-cache darkhttpd COPY --from=builder /src/public /var/www ENTRYPOINT [ <span class="hljs-string"><span class="hljs-string">"/usr/bin/darkhttpd"</span></span> ] CMD [ <span class="hljs-string"><span class="hljs-string">"/var/www"</span></span> ]</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ุ ูุญุชูู Dockerfile ุนูู ุงุซููู ูู FROMs ุ ุชุณูู ูุฐู ุงูููุฒุฉ <a href="https://docs.docker.com/develop/develop-images/multistage-build/" rel="nofollow"><strong>ุจูุงุก ูุชุนุฏุฏ ุงููุฑุงุญู</strong></a> ููุณูุญ ูู ุจุงุณุชุจุนุงุฏ ูู ุดูุก ุบูุฑ ุถุฑูุฑู ูู ุตูุฑุฉ ุนุงูู ุงูุฅุฑุณุงุก ุงูููุงุฆู. <br>  ูุจุงูุชุงูู ุ ุณูู ุชุญุชูู ุงูุตูุฑุฉ ุงูููุงุฆูุฉ ุนูู <strong>darkhttpd</strong> ููุท (ุฎุงุฏู HTTP ุฎููู ุงููุฒู) <strong>ูุนุงูุฉ /</strong> - ูุญุชูู ูููุนูุง ุงูุฐู ุชู ุฅูุดุงุคู ุจุดูู ุซุงุจุช. </p><br><p style=";text-align:right;direction:rtl">  ูุง ุชูุณ ุฃู ุชูุชุฒู ุชุบููุฑุงุชูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git add dockerfiles/website git commit -m "Add Dockerfile for website"</code> </pre> <br><hr><br><h1 id="3-znakomstvo-s-kanikoanchorkanikoanchor" style=";text-align:right;direction:rtl">  3. ุงูุชุนุงุฑู ูุน kaniko <a name="kaniko"></a></h1><br><p style=";text-align:right;direction:rtl">  ููุฌููุน ูู ุตูุฑ ุนุงูู ุงููููุงุก ุ ูุฑุฑุช ุงุณุชุฎุฏุงู <strong><a href="https://github.com/GoogleContainerTools/kaniko" rel="nofollow">kaniko</a></strong> ุ ูุธุฑูุง ูุฃูู ูุง ูุชุทูุจ ุชุดุบูู ุจุฑูุงูุฌ ุชุดุบูู ุนุงูู ุงููููุงุก ุ ููููู ุชูููุฐ ุงูุชุฌููุน ููุณู ุนูู ุฃู ุฌูุงุฒ ูุชุฎุฒูู ุฐุงูุฑุฉ ุงูุชุฎุฒูู ุงููุคูุช ูุจุงุดุฑุฉู ูู ุงูุณุฌู ุ ููุง ููุบู ุงูุญุงุฌุฉ ุฅูู ุชุฎุฒูู ูุงูู ุซุงุจุช . </p><br><p style=";text-align:right;direction:rtl">  ูุฅูุดุงุก ุงูุตูุฑุฉ ุ ูุง <strong>ุนููู</strong> ุณูู ุจุฏุก ุชุดุบูู ุงูุญุงููุฉ ุจุงุณุชุฎุฏุงู <strong>kaniko execate</strong> ูุชูุฑูุฑ ุณูุงู <strong>ุงูุฅูุดุงุก</strong> ุงูุญุงูู ุฅูููุง ุ ูููููู ุงูููุงู ุจุฐูู ูุญูููุง ุ ุนุจุฑ ุนุงูู ูููุงุก: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">docker run -ti --rm \ -v <span class="hljs-variable"><span class="hljs-variable">$PWD</span></span>:/workspace \ -v ~/.docker/config.json:/kaniko/.docker/config.json:ro \ gcr.io/kaniko-project/executor:v0.15.0 \ --cache \ --dockerfile=dockerfiles/website/Dockerfile \ --destination=registry.gitlab.com/kvaps/docs.example.org/website:v0.0.1</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุญูุซ <strong>registry.gitlab.com/kvaps/docs.example.org/website</strong> ูู ุงุณู ุตูุฑุฉ ุนุงูู ุงููููุงุก ุงูุฎุงุต ุจู ุ ูุจุนุฏ ุงูุชุฌููุน ุณูุชู ุฏูุนู ุชููุงุฆููุง ุฅูู ุณุฌู ุนุงูู ุงููููุงุก. </p><br><p style=";text-align:right;direction:rtl">  ุชุชูุญ ูู ุงููุนููุฉ - cache ุชุฎุฒูู ุทุจูุงุช ูู ุณุฌู ุนุงูู ุงููููุงุก ุ ุนูู ุณุจูู ุงููุซุงู ุ ุณูุชู ุญูุธูุง ูู <strong>registry.gitlab.com/kvaps/docs.example.org/website/cache</strong> ุ ูููู ููููู ุชุญุฏูุฏ ูุณุงุฑ ุขุฎุฑ ุจุงุณุชุฎุฏุงู <strong>--cache-</strong> ุงููุนููุฉ <strong>ุงูุฑูุจู</strong> . </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ููุทุฉ ุนุงูู ูููุงุก ุงูุชุณุฌูู</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/0-/31/qx/0-31qxfta2gk7-colutf2l_qtmm.png"></p></div></div><br><hr><br><h1 id="4-znakomstvo-s-qbecanchorqbecanchor" style=";text-align:right;direction:rtl">  4. ุงูุชุนุงุฑู ูุน qbec <a name="qbec"></a></h1><br><p style=";text-align:right;direction:rtl">  <a href="https://qbec.io/" rel="nofollow">Qbec</a> ูู ุฃุฏุงุฉ ูุดุฑ ุชุชูุญ ูู ูุตู ุจูุงู ุงูุชุทุจูู ุงูุฎุงุต ุจู ููุดุฑู ุนูู Kubernetes.  ูุชูุญ ูู ุงุณุชุฎุฏุงู Jsonnet ุจุงุนุชุจุงุฑู ุจูุงุก ุงูุฌููุฉ ุงูุฑุฆูุณู ุชุจุณูุท ูุตู ุงูุงุฎุชูุงูุงุช ุฅูู ุญุฏ ูุจูุฑ ูู ุงูุนุฏูุฏ ูู ุงูุจูุฆุงุช ุ ูุฃูุถูุง ุชูุฑูุจูุง ุฅุฒุงูุฉ ุงูุชูุฑุงุฑ ุงููุงูู ููููุฏ. </p><br><p style=";text-align:right;direction:rtl">  ูููู ุฃู ูููู ูุฐุง ุตุญูุญูุง ุจุดูู ุฎุงุต ูู ุงูุญุงูุงุช ุงูุชู ุชุญุชุงุฌ ูููุง ุฅูู ูุดุฑ ุชุทุจูู ูุง ูู ุนุฏุฉ ูุฌููุนุงุช ุฐุงุช ูุนููุงุช ูุฎุชููุฉ ูุชุฑูุฏ ูุตููุง ุจุดูู ุชุนุฑููู ูู Git. </p><br><p style=";text-align:right;direction:rtl">  ูุชูุญ ูู Qbec ุฃูุถูุง ุชูุฏูู ูุฎุทุทุงุช Helm ุนู ุทุฑูู ุชูุฑูุฑ ุงููุนููุงุช ุงููุงุฒูุฉ ููุง ูุชุดุบูููุง ูุงุญููุง ุจุงูุฅุถุงูุฉ ุฅูู ุงูุจูุงูุงุช ุงูุนุงุฏูุฉ ุ ุจูุง ูู ุฐูู ุงูุทูุฑุงุช ุงููุฎุชููุฉ ุงูุชู ูููู ูุฑุถูุง ุนูููุง ุ ููุฐุง ุจุฏูุฑู ููุบู ุงูุญุงุฌุฉ ุฅูู ุงุณุชุฎุฏุงู ChartMuseum.  ูุฐุง ูู ุ ููููู ุชุฎุฒูู ูุนุฑุถ ุงููุฎุทุทุงุช ูุจุงุดุฑุฉ ูู ุจูุงุจุฉ ุ ุญูุซ ูุฏููู ุงูููุงู. </p><br><p style=";text-align:right;direction:rtl">  ููุง ููุช ูู ูุจู ุ ุณูุฎุฒู ุฌููุน ุนูููุงุช ุงููุดุฑ ูู ุฏููู ุงููุดุฑ <strong>/</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">mkdir deploy <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ุชููุฆุฉ ุงูุชุทุจูู ุงูุฃูู ูุฏููุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec init website <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> website</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุขู ูุจุฏู ูููู ุชุทุจูููุง ููุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">. โโโ components โโโ environments โ  โโโ base.libsonnet โ  โโโ default.libsonnet โโโ params.libsonnet โโโ qbec.yaml</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุธุฑ ุฅูู ููู <strong>qbec.yaml</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">apiVersion: qbec.io/v1alpha1 kind: App metadata: name: website spec: environments: default: defaultNamespace: docs server: https://kubernetes.example.org:8443 vars: {}</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุญู ููุง ููุชููู ุจุดูู ุฃุณุงุณู <strong>ุจุงูููุงุตูุงุช</strong> ุ ููุฏ ุฃูุดุฃุช qbec ุจุงููุนู ุจูุฆุฉ ุงูุชุฑุงุถูุฉ ููุง ูุฃุฎุฐูุง ุนููุงู ุงูุฎุงุฏู ุ ููุฐูู ูุณุงุญุฉ ุงูุงุณู ูู kubeconfig ุงูุญุงูู. <br>  ุงูุขู ุ ุนูุฏ ุงููุดุฑ ูู ุงูุจูุฆุฉ <strong>ุงูุงูุชุฑุงุถูุฉ</strong> ุ ุณุชูุดุฑ qbec ุฏุงุฆููุง ููุท ูู ูุฌููุนุฉ Kubernetes ุงููุญุฏุฏุฉ ูุฅูู ูุณุงุญุฉ ุงูุงุณู ุงููุญุฏุฏุฉ ุ ุฃู ุฃูู ูู ุชุนุฏ ุจุญุงุฌุฉ ุฅูู ุงูุชุจุฏูู ุจูู ุงูุณูุงูุงุช ููุณุงุญุงุช ุงูุฃุณูุงุก ูู ุฃุฌู ุฅุฌุฑุงุก ุนูููุฉ ูุดุฑ. <br>  ุฅุฐุง ูุฒู ุงูุฃูุฑ ุ ููููู ุฏุงุฆููุง ุชุญุฏูุซ ุงูุฅุนุฏุงุฏุงุช ูู ูุฐุง ุงูููู. </p><br><p style=";text-align:right;direction:rtl">  ูุชู ูุตู ุฌููุน ุงูุจูุฆุงุช ุงูุฎุงุตุฉ ุจู ูู <strong>qbec.yaml</strong> ุ ููู ููู <strong>params.libsonnet</strong> ุ ุญูุซ <strong>ููุถุญ</strong> ุงูููุงู ุงูุฐู ุชุญุชุงุฌ ุฅูู ุฃุฎุฐ ุงููุนููุงุช ูู. </p><br><p style=";text-align:right;direction:rtl">  ุงูุชุงูู ูุฑู ุฏููููู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>ุงูููููุงุช /</strong> - ุณูุชู ุชุฎุฒูู ุฌููุน ุงูุจูุงูุงุช ุงูุฎุงุตุฉ ุจุชุทุจูููุง ููุง ุ ููููู ูุตููุง ูู ูููุงุช jsonnet ููููุงุช yaml ุงูุนุงุฏูุฉ </li><li style=";text-align:right;direction:rtl">  <strong>ุงูุจูุฆุงุช /</strong> - ุณูููู ููุง ุจูุตู ุฌููุน ุงููุชุบูุฑุงุช (ุงููุนููุงุช) ูุจูุฆุงุชูุง. </li></ul><br><p style=";text-align:right;direction:rtl">  ุจุดูู ุงูุชุฑุงุถู ุ ูุฏููุง ูููุงู: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>ุงูุจูุฆุงุช / base.libsonnet</strong> - ุณูุชุถูู ูุนููุงุช ุนุงูุฉ ูุฌููุน ุงูุจูุฆุงุช </li><li style=";text-align:right;direction:rtl">  <strong>ุงูุจูุฆุงุช / default.libsonnet</strong> - ูุญุชูู ุนูู ูุนููุงุช ุชู ุชุฌุงูุฒูุง ููุจูุฆุฉ <strong>ุงูุงูุชุฑุงุถูุฉ</strong> </li></ul><br><p style=";text-align:right;direction:rtl">  ุฏุนูุง ููุชุญ <strong>ุงูุจูุฆุงุช / base.libsonnet</strong> ูุฃุถู ุงููุนููุงุช ูููููู ุงูุฃูู ูุฏููุง ููุงู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">website</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'example-docs'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/website:v0.0.1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">ingressClass</span></span>: <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'docs.example.org'</span></span>, }, }, }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุณูููู ุฃูุถูุง ุจุฅูุดุงุก ููููุงุช <strong>ุงููููู</strong> ุงูุฃูู <strong>/ website.jsonnet</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.website; [ { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'apps/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Deployment'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: params.replicas, <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: { <span class="hljs-attr"><span class="hljs-attr">matchLabels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, }, <span class="hljs-attr"><span class="hljs-attr">template</span></span>: { <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">containers</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'darkhttpd'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: params.image, <span class="hljs-attr"><span class="hljs-attr">ports</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: params.containerPort, }, ], }, ], <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: params.nodeSelector, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: params.tolerations, <span class="hljs-attr"><span class="hljs-attr">imagePullSecrets</span></span>: [{ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'regsecret'</span></span> }], }, }, }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Service'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">selector</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">ports</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">port</span></span>: params.servicePort, <span class="hljs-attr"><span class="hljs-attr">targetPort</span></span>: params.containerPort, }, ], }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'extensions/v1beta1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Ingress'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">annotations</span></span>: { <span class="hljs-string"><span class="hljs-string">'kubernetes.io/ingress.class'</span></span>: params.ingressClass, }, <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">spec</span></span>: { <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">host</span></span>: params.domain, <span class="hljs-attr"><span class="hljs-attr">http</span></span>: { <span class="hljs-attr"><span class="hljs-attr">paths</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">backend</span></span>: { <span class="hljs-attr"><span class="hljs-attr">serviceName</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: params.servicePort, }, }, ], }, }, ], }, }, ]</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ูุฐุง ุงูููู ูุตููุง ุนูู ุงูููุฑ ุซูุงุซุฉ ููุงูุงุช Kubernetes ุ ููู: <strong>ุงููุดุฑ</strong> ุ <strong>ุงูุฎุฏูุฉ</strong> ูุงูุฏุฎูู.  ุฅุฐุง ุฑุบุจุช ูู ุฐูู ุ ูููููุง ููููุง ุฅูู ููููุงุช ูุฎุชููุฉ ุ ูููู ูู ูุฐู ุงููุฑุญูุฉ ุ ูุงุญุฏ ูููู ุจุงููุณุจุฉ ููุง. </p><br><p style=";text-align:right;direction:rtl">  <strong>ูุดุจู</strong> ุจูุงุก ุฌููุฉ <strong>jsonnet</strong> ุฅูู ุญุฏ ูุจูุฑ json ุงูุนุงุฏูุฉ ุ ูู ุญูุซ ุงููุจุฏุฃ jsonnet ุตุญูุญ ุจุงููุนู jsonnet ุ ูุฐูู ูู ุงูุจุฏุงูุฉ ูุฏ ูููู ูู ุงูุฃุณูู ุงุณุชุฎุฏุงู ุงูุฎุฏูุงุช ุนุจุฑ ุงูุฅูุชุฑูุช ูุซู <strong>yaml2json</strong> ูุชุญููู yaml ุงููุนุชุงุฏ ุฅูู json ุ ุฃู ุฅุฐุง ูุงูุช ููููุงุชู ูุง ุชุญุชูู ุนูู ุฃู ูุชุบูุฑุงุช ุ ูููู ูุตููุง ูู ุดูู yaml ุงูุนุงุฏู. </p><br><blockquote style=";text-align:right;direction:rtl">  ุนูุฏ ุงูุนูู ูุน <strong>jsonnet ุ</strong> ุฃูุตู ุจุดุฏุฉ ุจุชุซุจูุช ูููู ุฅุถุงูู <strong>ููุญุฑุฑู</strong> <br><br>  ุนูู ุณุจูู ุงููุซุงู ุ ุจุงููุณุจุฉ ูู vim ุ ููุฌุฏ <strong>ูููู ุฅุถุงูู ูู vim-jsonnet</strong> ูููู <strong>ุจุชุดุบูู</strong> ุชุณููุท ุงูุถูุก ุนูู ุจูุงุก ุงูุฌููุฉ ููููู ุชููุงุฆููุง ุจุชูููุฐ <strong>jsonnet fmt ูู</strong> ูู ูุฑุฉ ูุชู ุญูุธู (ูุชุทูุจ ุชุซุจูุช jsonnet). </blockquote><p style=";text-align:right;direction:rtl">  ูู ุดูุก ุฌุงูุฒ ุ ูุงูุขู ูููููุง ุจุฏุก ุงููุดุฑ: </p><br><p style=";text-align:right;direction:rtl">  ููุฑู ูุง ุญุฏุซ ุ ุณููุนู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec show default</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุงูุฅุฎุฑุงุฌ ุ ุณุชุฑู ุจูุงูุงุช yaml ุงูููุฏูุฉ ูุงูุชู ุณูุชู ุชุทุจูููุง ุนูู ุงููุชูุฉ ุงูุงูุชุฑุงุถูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ุญุณููุง ุ ูู ุจุงูุชุทุจูู ุงูุขู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec apply default</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุนูุฏ ุงูุฎุฑูุฌ ุ ุณุชุฑู ุฏุงุฆููุง ูุง ุงูุฐู ุณูุชู ุงูููุงู ุจู ูู ูุฌููุนุชู ุ ุณูุทูุจ ููู qbec ูุจูู ุงูุชุบููุฑุงุช ุ ุจูุชุงุจุฉ <strong>y</strong> ููููู ุชุฃููุฏ ููุงูุงู. </p><br><p style=";text-align:right;direction:rtl">  ุชู ุ ุงูุขู ุฑุณุช ุทูุจูุง! </p><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ููุช ุจุฅุฌุฑุงุก ุชุบููุฑุงุช ุ ููููู ุฏุงุฆููุง ุงูููุงู ุจูุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec diff default</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุนุฑูุฉ ููู ุณุชุคุซุฑ ูุฐู ุงูุชุบููุฑุงุช ุนูู ุงููุดุฑ ุงูุญุงูู </p><br><p style=";text-align:right;direction:rtl">  ูุง ุชูุณ ุฃู ุชูุชุฒู ุชุบููุฑุงุชูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">cd ../.. git add deploy/website git commit -m "Add deploy for website"</code> </pre> <br><hr><br><h1 id="5-probuem-gitlab-runner-s-kubernetes-executoranchorgitlab-runneranchor" style=";text-align:right;direction:rtl">  5. ูุญุงููุฉ Gitlab ุนุฏุงุก ูุน Kubernetes ุงููููุฐ <a name="gitlab-runner"></a></h1><br><p style=";text-align:right;direction:rtl">  ุญุชู ููุช ูุฑูุจ ุ ููุช ุฃุณุชุฎุฏู ููุท <strong>ุนุฏุงุก gitlab</strong> ุงููุนุชุงุฏ ุนูู ุฌูุงุฒ <strong>ููุฌูุฒ</strong> ูุณุจููุง (ุญุงููุฉ LXC) ูุน ูุดุฑุฉ ุฃู ููููุฐุฉ ูููุงุก.  ูู ุงูุจุฏุงูุฉ ุ ูุงู ูุฏููุง ุงูุนุฏูุฏ ูู ูุคูุงุก ุงููุชุณุงุจููู ุงูุฐูู ุชู ุชุนุฑูููู ุนุงููููุง ูู ูุฑูููุง.  ูุงููุง ุจุฌูุน ุตูุฑ ุนุงูู ูููุงุก ูุฌููุน ุงููุดุงุฑูุน. </p><br><p style=";text-align:right;direction:rtl">  ูููู ููุง ุฃุธูุฑุช ุงูููุงุฑุณุฉ ุ ูุฅู ูุฐุง ุงูุฎูุงุฑ ููุณ ูู ุงูุฃูุซุฑ ูุซุงููุฉ ุ ุณูุงุก ูู ุญูุซ ุงูุชุทุจูู ุงูุนููู ุฃู ูู ุญูุซ ุงูุฃูู.  ูู ุงูุฃูุถู ูุซูุฑูุง ูุงูุฃูุฏููููุฌููุง ุฃู ูุชู ูุดุฑ ุนุฏุงุฆูู ูููุตููู ููู ูุดุฑูุน ูุญุชู ููู ุจูุฆุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูุญุณู ุงูุญุธ ุ ูุฐู ููุณุช ูุดููุฉ ุนูู ุงูุฅุทูุงู ุ ุญูุซ ุฃููุง ุณููุดุฑ ุงูุขู <strong>gitlab-runner</strong> ูุจุงุดุฑุฉ ูุฌุฒุก ูู ูุดุฑูุนูุง ูุจุงุดุฑุฉ ุฅูู Kubernetes. </p><br><p style=";text-align:right;direction:rtl">  ูููุฑ Gitlab ูุฎุทุท ุฑุฃุณ ุฌุงูุฒ ููุดุฑ ุนุฏุงุก gitlab ูู Kubernetes.  ูุจุงูุชุงูู ุ ูู ูุง ุนููู ูุนูู ูู ูุนุฑูุฉ <strong>ุฑูุฒ ุงูุชุณุฌูู</strong> ุงูุฎุงุต <strong>ุจูุดุฑูุนูุง</strong> ูู <strong>ุงูุฅุนุฏุงุฏุงุช -&gt; CI / CD -&gt; ุงูุนุฏุงุคูู</strong> ูุชูุฑูุฑู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">helm repo add gitlab https://charts.gitlab.io helm install gitlab-runner \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> gitlabUrl=https://gitlab.com \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> runnerRegistrationToken=yga8y-jdCusVDn_t4Wxc \ --<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rbac.create=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \ gitlab/gitlab-runner</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุญูุซ: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong><a href="https://gitlab.com/" rel="nofollow">https://gitlab.com</a></strong> ูู ุนููุงู ุฎุงุฏู Gitlab ุงูุฎุงุต ุจู. </li><li style=";text-align:right;direction:rtl">  <strong>yga8y-jdCusVDn_t4Wxc</strong> - ุฑูุฒ ุงูุชุณุฌูู ุงูุฎุงุต <strong>ุจูุดุฑูุนู</strong> . </li><li style=";text-align:right;direction:rtl">  <strong>rbac.create = true</strong> - ูููุญ ุงูุนุฏุงุก ุงูุนุฏุฏ ุงููุทููุจ ูู ุงูุงูุชูุงุฒุงุช ููููู ูุงุฏุฑูุง ุนูู ุฅูุดุงุก ูุฑูู ูุฃุฏุงุก ููุงููุง ุจุงุณุชุฎุฏุงู ุงููููุฐ kubernetes. </li></ul><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ุชู ูู ุดูุก ุจุดูู ุตุญูุญ ุ ูุฌุจ ุฃู ุชุดุงูุฏ ุงูุนุฏุงุก ุงููุณุฌู ูู ูุณู " <strong>ุงูุนุฏุงุฆูู"</strong> ุ ูู ุฅุนุฏุงุฏุงุช ูุดุฑูุนู. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ููุทุฉ ุดุงุดุฉ ููุนุฏุงุก ุงููุถุงูุฉ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/at/lx/g_/atlxg_u6rjn4n0pkcpn8--2gare.png"></p></div></div><br><p style=";text-align:right;direction:rtl">  ูู ูุฐุง ุจุณูุทุ  - ูุนู ุจุณูุท ุฌุฏุง!  ูุง ูุฒูุฏ ูู ุงููุชุงุนุจ ูุน ุชุณุฌูู ุงููุชุณุงุจููู ูุฏููุง ุ ูู ุงูุขู ูุตุงุนุฏุง ุณูุชู ุฅูุดุงุก ุงููุชุณุงุจููู ูุชุฏููุฑูุง ุชููุงุฆูุง. </p><br><hr><br><h1 id="6-deploy-helm-chartov-s-qbecanchorqbec-helmanchor" style=";text-align:right;direction:rtl">  6. ูุดุฑ ูุฎุทุทุงุช ูููู ูุน QBEC <a name="qbec-helm"></a></h1><br><p style=";text-align:right;direction:rtl">  ูุธุฑูุง ูุฃููุง ูุฑุฑูุง ุงุนุชุจุงุฑ <strong>gitlab-runner</strong> ุฌุฒุกูุง ูู ูุดุฑูุนูุง ุ ููุฏ ุญุงู ุงูููุช <strong>ููุตูู</strong> ูู ูุณุชูุฏุน Git ุงูุฎุงุต ุจูุง. </p><br><p style=";text-align:right;direction:rtl">  ูููููุง ูุตูู ุนูู ุฃูู ูููู ูููุตู ูู <strong>ูููุน ุงูููุจ</strong> ุ ูููู ูู ุงููุณุชูุจู ูุฎุทุท ููุดุฑ ูุณุฎ ูุฎุชููุฉ ูู <strong>ุงููููุน ูู</strong> ูุซูุฑ ูู ุงูุฃุญูุงู ุ ุนูู ุนูุณ <strong>gitlab-runner</strong> ุ ุงูุฐู ุณูุชู ูุดุฑู ูุฑุฉ ูุงุญุฏุฉ ููุท ููู ูุฌููุนุฉ Kubernetes.  ูุฐูู ุฏุนููุง ุชููุฆุฉ ุชุทุจูู ูููุตู ูุฐูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy qbec init gitlab-runner <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> gitlab-runner</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฐู ุงููุฑุฉ ูู ูุตู ููุงูุงุช Kubernetes ูุฏูููุง ุ ููู ูุฃุฎุฐ ูุฎุทุท ูููู ุงูุฌุงูุฒ.  ูุงุญุฏุฉ ูู ูุฒุงูุง qbec ูู ุงููุฏุฑุฉ ุนูู ุชูุฏูู ูุฎุทุทุงุช Helm ูุจุงุดุฑุฉ ูู ูุณุชูุฏุน Git. </p><br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ุชูุตููู ุจุงุณุชุฎุฏุงู git subodule: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git submodule add https://gitlab.com/gitlab-org/charts/gitlab-runner vendor/gitlab-runner</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุขู ูุญุชูู ุฏููู <strong>ุงูุจุงุฆุน / gitlab-runner</strong> ุนูู ูุณุชูุฏุนูุง ุจุฑุณู ุจูุงูู ูู gitlab-runner. </p><br><blockquote style=";text-align:right;direction:rtl">  ูุจุงููุซู ุ ููููู ุชูุตูู ูุณุชูุฏุนุงุช ุฃุฎุฑู ุ ุนูู ุณุจูู ุงููุซุงู ุ ุงููุณุชูุฏุน ุจุฃูููู ุจุงููุฎุทุทุงุช ุงูุฑุณููุฉ <strong><a href="https://github.com/helm/charts" rel="nofollow">https://github.com/helm/charts</a></strong> </blockquote><p style=";text-align:right;direction:rtl">  <strong>ููุตู ุงูููููุงุช / gitlab-runner.jsonnet</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.gitlabRunner; std.native(<span class="hljs-string"><span class="hljs-string">'expandHelmTemplate'</span></span>)( <span class="hljs-string"><span class="hljs-string">'../vendor/gitlab-runner'</span></span>, params.values, { <span class="hljs-attr"><span class="hljs-attr">nameTemplate</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: env.namespace, <span class="hljs-attr"><span class="hljs-attr">thisFile</span></span>: std.thisFile, <span class="hljs-attr"><span class="hljs-attr">verbose</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, } )</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงููุณูุทุฉ ุงูุฃููู <strong>ูุชูุณูุนHelmTemplate</strong> ูููู ุจุชูุฑูุฑ ุงููุณุงุฑ ุฅูู ุงููุฎุทุท ุ ุซู <strong>params.values</strong> ุ ุงูุชู ูุฃุฎุฐูุง ูู ูุนููุงุช ุงูุจูุฆุฉ ุ ุซู ูุงุฆููุง ุจู </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <strong>nameTemplate</strong> - ุงุณู ุงูุฅุตุฏุงุฑ </li><li style=";text-align:right;direction:rtl">  <strong>ูุณุงุญุฉ ุงูุงุณู</strong> - ูุณุงุญุฉ ุงูุงุณู ุงูุชู ูุฑุช ุนูู ุฑุฃุณ </li><li style=";text-align:right;direction:rtl">  <strong>thisFile</strong> - ุงููุนููุฉ ุงููุทููุจุฉ ุชูุฑูุฑ ุงููุณุงุฑ ุฅูู ุงูููู ุงูุญุงูู </li><li style=";text-align:right;direction:rtl">  <strong>ูุทููู</strong> - ูุนุฑุถ ุงูุฃูุฑ <strong>ุงููุงูุจ helm</strong> ูุน ูุงูุฉ ุงููุณุงุฆุท ุนูุฏ ุชูุฏูู ุงููุฎุทุท </li></ul><br><p style=";text-align:right;direction:rtl">  ุณูููู ุงูุขู ุจูุตู ุงูุนูุงูู ุงูุฎุงุตุฉ <strong>ุจูููููุง</strong> ูู <strong>ุงูุจูุฆุงุช / base.libsonnet</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">local secrets = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../secrets/base.libsonnet'</span></span>; { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabRunner</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner'</span></span>, <span class="hljs-attr"><span class="hljs-attr">values</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'https://gitlab.com/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: secrets.runnerRegistrationToken, }, }, }, }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงูุชุจู ุฅูู <strong>runnerRegistrationToken</strong> ุงูุชู ูุฃุฎุฐูุง ูู <strong>ููู secrets / base.libsonnet</strong> ุงูุฎุงุฑุฌู ุ <strong>ููููุดุฆู</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: <span class="hljs-string"><span class="hljs-string">'yga8y-jdCusVDn_t4Wxc'</span></span>, }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุชุญูู ููุง ุฅุฐุง ูุงู ูู ุดูุก ูุนูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec show default</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงู ูู ุดูุก ุนูู ูุง ูุฑุงู ุ ููููููุง ุฅุฒุงูุฉ ุงูุฅุตุฏุงุฑ ุงูุณุงุจู ูู ุฎูุงู ุฅุตุฏุงุฑ Helm: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">helm uninstall gitlab-runner</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุดุฑูุง ุ ูููู ุจุงููุนู ูู ุฎูุงู qbec: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec apply default</code> </pre> <br><hr><br><h1 id="7-znakomstvo-s-git-cryptanchorgit-cryptanchor" style=";text-align:right;direction:rtl">  7. ุฅุฏุฎุงู ุจูุงุจุฉ ุงููุจู <a name="git-crypt"></a></h1><br><p style=";text-align:right;direction:rtl">  <strong><a href="https://github.com/AGWA/git-crypt" rel="nofollow">Git-crypt</a></strong> ูู ุฃุฏุงุฉ ุชุชูุญ ูู ุฅุนุฏุงุฏ ุชุดููุฑ ุดูุงู ููุณุชูุฏุน ุงูุชุฎุฒูู ุงูุฎุงุต ุจู. </p><br><p style=";text-align:right;direction:rtl">  ูู ุงูููุช ุงูุญุงูู ุ ูุจุฏู ูููู ุฏููููุง ุงูุฎุงุต ุจุนุฏุงุก ุงูุฌูุชูุงุจ ููุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">. โโโ components โ  โโโ gitlab-runner.jsonnet โโโ environments โ  โโโ base.libsonnet โ  โโโ default.libsonnet โโโ params.libsonnet โโโ qbec.yaml โโโ secrets โ  โโโ base.libsonnet โโโ vendor โโโ gitlab-runner (submodule)</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูููู ุงูุญูุงุธ ุนูู ุงูุฃุณุฑุงุฑ ูู ุจูุงุจุฉ ููุณุช ุขููุฉ ุ ุฃููุณ ูุฐููุ  ูุฐูู ูุญู ุจุญุงุฌุฉ ุฅูู ุชุดููุฑูุง ุจุดูู ุตุญูุญ. </p><br><blockquote style=";text-align:right;direction:rtl">  ุนุงุฏุฉู ูู ุฃุฌู ูุชุบูุฑ ูุงุญุฏ ุ ูุฐุง ุบูุฑ ููุทูู ุฏุงุฆููุง.  ููููู ุชูุฑูุฑ ุงูุฃุณุฑุงุฑ ุฅูู <strong>qbec</strong> ูุนุจุฑ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ููุธุงู CI ุงูุฎุงุต ุจู. <br>  ููู ุชุฌุฏุฑ ุงูุฅุดุงุฑุฉ ุฅูู ุฃู ููุงู ุงููุฒูุฏ ูู ุงููุดุงุฑูุน ุงููุนูุฏุฉ ุงูุชู ูููู ุฃู ุชุญุชูู ุนูู ุฃุณุฑุงุฑ ุฃูุซุฑ ุจูุซูุฑ ุ ุณูููู ูู ุงูุตุนุจ ููุบุงูุฉ ููููุง ุฌููุนูุง ูู ุฎูุงู ูุชุบูุฑุงุช ุงูุจูุฆุฉ. <br><br>  ุจุงูุฅุถุงูุฉ ุฅูู ุฐูู ุ ูู ูุฐู ุงูุญุงูุฉ ุ ูู ุฃุชููู ูู ุฅุฎุจุงุฑู ุนู ูุฐู ุงูุฃุฏุงุฉ ุงูุฑุงุฆุนุฉ ูุซู <strong>git-crypt</strong> . <br><br>  <strong>ูุนุฏ git-crypt</strong> ููุงุณุจูุง ุฃูุถูุง ูุฃูู ูุชูุญ ูู ุญูุธ ุชุงุฑูุฎ ุงูุฃุณุฑุงุฑ ุจุงููุงูู ุ ููุฐูู ููุงุฑูุฉ ุงูุชุนุงุฑุถุงุช ูุฏูุฌูุง ูุญููุง ุจููุณ ุงูุทุฑููุฉ ุงูุชู ุงุนุชุฏูุง ุงูููุงู ุจูุง ูู ุญุงูุฉ Git. </blockquote><p style=";text-align:right;direction:rtl">  ุฃููุงู ููุจู ูู ุดูุก ุ ุจุนุฏ ุชุซุจูุช <strong>git-crypt ุ</strong> ูุญุชุงุฌ ุฅูู ุฅูุดุงุก ููุงุชูุญ ููุณุชูุฏุนูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git crypt init</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูุงู ูุฏูู ููุชุงุญ PGP ุ ูููููู ุฅุถุงูุฉ ููุณู ููุฑูุง ููุชุนุงูู ููุฐุง ุงููุดุฑูุน: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git-crypt add-gpg-user kvapss@gmail.com</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุจุงูุชุงูู ุ ููููู ุฏุงุฆููุง ูู ุชุดููุฑ ูุฐุง ุงููุณุชูุฏุน ุจุงุณุชุฎุฏุงู ุงูููุชุงุญ ุงูุฎุงุต. </p><br><p style=";text-align:right;direction:rtl">  ุฅุฐุง ูู ููู ูุฏูู ููุชุงุญ PGP ููู ููู ูุชููุนูุง ุ ูููููู ุงูุฐูุงุจ ูู ุงูุงุชุฌุงู ุงูุขุฎุฑ ูุชุตุฏูุฑ ููุชุงุญ ุงููุดุฑูุน: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git crypt export-key /path/to/keyfile</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุจูุฐู ุงูุทุฑููุฉ ุ ุณูุชููู ุฃู ุดุฎุต ูุฏูู ููู <strong>ููุชุงุญ</strong> ุชุตุฏูุฑ ูู ูู ุชุดููุฑ ูุณุชูุฏุนู. </p><br><p style=";text-align:right;direction:rtl">  ููุฏ ุญุงู ุงูููุช ูุฅุนุฏุงุฏ ุฃูู ุณุฑ ูุฏููุง. <br>  ุงุณูุญูุง ูู ุฃู ุฃุฐูุฑู ุจุฃููุง ูุง ุฒููุง ูู ุฏููู <strong>ูุดุฑ / gitlab-runner /</strong> ุ ุญูุซ ูุฏููุง <strong>ุฃุณุฑุงุฑ /</strong> ุฏููู ุ <strong>ูููุดููุฑ</strong> ุฌููุน ุงููููุงุช ุงูููุฌูุฏุฉ ููู ุ ูููุฐุง ูููู ุจุฅูุดุงุก <strong>ููู ุฃุณุฑุงุฑ / .gitattributes</strong> ุจุงููุญุชููุงุช ุงูุชุงููุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">* filter=git-crypt diff=git-crypt .gitattributes !filter !diff</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑูู ูู ุงููุญุชูู ุ ุณูุชู ุชุดุบูู ุฌููุน ุงููููุงุช ุนู ุทุฑูู ููุงุน <strong>*</strong> ูู ุฎูุงู <strong>git-crypt</strong> ุ ุจุงุณุชุซูุงุก <strong>.gitattributes</strong> ููุณูุง </p><br><p style=";text-align:right;direction:rtl">  ูููููุง ุงูุชุญูู ูู ุฐูู ุนู ุทุฑูู ุชุดุบูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git crypt status -e</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูู ุงููุฎุฑุฌุงุช ุ ูุญุตู ุนูู ูุงุฆูุฉ ุจุฌููุน ุงููููุงุช ูู ุงููุณุชูุฏุน ุงูุฐู ุชู ุชูููู ุงูุชุดููุฑ </p><br><p style=";text-align:right;direction:rtl">  ูุฐุง ูู ุดูุก ุ ุงูุขู ูููููุง ุงูุงูุชุฒุงู ุจุฃูุงู ุจุชุบูุฑุงุชูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ../.. git add . git commit -m <span class="hljs-string"><span class="hljs-string">"Add deploy for gitlab-runner"</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุญุธุฑ ุงููุณุชูุฏุน ุ ูู ููุท ุจูุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git crypt lock</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุซู ุชุชุญูู ุฌููุน ุงููููุงุช ุงููุดูุฑุฉ ุฅูู ุดูุก ุซูุงุฆู ุ ุณูููู ูู ุงููุณุชุญูู ูุฑุงุกุชูุง. <br>  ููู ุชุดููุฑ ูุณุชูุฏุน ุงูุชุฎุฒูู ุ ูู ุจูุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git crypt unlock</code> </pre> <br><hr><br><h1 id="8-sozdayom-toolbox-obrazanchortoolboxanchor" style=";text-align:right;direction:rtl">  8. ุฅูุดุงุก ุตูุฑุฉ ูุฑุจุน ุงูุฃุฏูุงุช <a name="toolbox"></a></h1><br><p style=";text-align:right;direction:rtl">  ุตูุฑุฉ ูุฑุจุน ุงูุฃุฏูุงุช ุนุจุงุฑุฉ ุนู ุตูุฑุฉ ุจูุง ุฌููุน ุงูุฃุฏูุงุช ุงูุชู ุณูุณุชุฎุฏููุง ููุดุฑ ูุดุฑูุนูุง.  ุณูุชู ุงุณุชุฎุฏุงูู ูู ูุจู ุนุฏุงุก gitlab ูุชูููุฐ ููุงู ุงููุดุฑ ุงููุนุชุงุฏุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูู ุดูุก ุจุณูุท ููุง ุ ูู ุจุฅูุดุงุก <strong>dockerfiles / toolbox / Dockerfile ุฌุฏูุฏ</strong> ูุน ุงููุญุชูู ุงูุชุงูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">FROM alpine:3.11 RUN apk add --no-cache git git-crypt RUN QBEC_VER=0.10.3 \ &amp;&amp; wget -O- https://github.com/splunk/qbec/releases/download/v<span class="hljs-variable"><span class="hljs-variable">${QBEC_VER}</span></span>/qbec-linux-amd64.tar.gz \ | tar -C /tmp -xzf - \ &amp;&amp; mv /tmp/qbec /tmp/jsonnet-qbec /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/ RUN KUBECTL_VER=1.17.0 \ &amp;&amp; wget -O /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/kubectl \ https://storage.googleapis.com/kubernetes-release/release/v<span class="hljs-variable"><span class="hljs-variable">${KUBECTL_VER}</span></span>/bin/linux/amd64/kubectl \ &amp;&amp; chmod +x /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/kubectl RUN HELM_VER=3.0.2 \ &amp;&amp; wget -O- https://get.helm.sh/helm-v<span class="hljs-variable"><span class="hljs-variable">${HELM_VER}</span></span>-linux-amd64.tar.gz \ | tar -C /tmp -zxf - \ &amp;&amp; mv /tmp/linux-amd64/helm /usr/<span class="hljs-built_in"><span class="hljs-built_in">local</span></span>/bin/helm</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ุชุฑู ุ ูุซุจุช ูู ูุฐู ุงูุตูุฑุฉ ุฌููุน ุงูุฃุฏูุงุช ุงููุณุงุนุฏุฉ ุงูุชู ุงุณุชุฎุฏููุงูุง ููุดุฑ ุชุทุจูููุง.  ูุง ูุญุชุงุฌ ุฅูู <strong>kubectl ููุง</strong> ุ ูููู ูุฏ ุชุฑุบุจ ูู ุงููุนุจ ุจูุง ูู ูุฑุญูุฉ ุฅุนุฏุงุฏ ุฎุท ุงูุฃูุงุจูุจ. </p><br><p style=";text-align:right;direction:rtl">  ุฃูุถูุง ุ ููู ูุชููู ูู ุงูุชูุงุตู ูุน Kubernetes ูุฅุฌุฑุงุก ุนูููุฉ ูุดุฑ ููู ุ ูุญุชุงุฌ ุฅูู ุชูููู ุงูุฏูุฑ ุงูุฎุงุต ุจุงููุฑูู ุงูุชู ุชู ุฅูุดุงุคูุง ุจูุงุณุทุฉ ุนุฏุงุก gitlab. </p><br><p style=";text-align:right;direction:rtl">  ููููุงู ุจุฐูู ุ ุงูุชูู ุฅูู ุงูุฏููู ุจุงุณุชุฎุฏุงู gitlab-runner: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> deploy/gitlab-runner</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฃุถู ูููููุง ุฌุฏูุฏูุง <strong>ููููููุงุช / rbac.jsonnet</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">local env = { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>), <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/defaultNs'</span></span>), }; local p = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../params.libsonnet'</span></span>; local params = p.components.rbac; [ { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'ServiceAccount'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Role'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">rules</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">apiGroups</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], <span class="hljs-attr"><span class="hljs-attr">resources</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], <span class="hljs-attr"><span class="hljs-attr">verbs</span></span>: [ <span class="hljs-string"><span class="hljs-string">'*'</span></span>, ], }, ], }, { <span class="hljs-attr"><span class="hljs-attr">apiVersion</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io/v1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'RoleBinding'</span></span>, <span class="hljs-attr"><span class="hljs-attr">metadata</span></span>: { <span class="hljs-attr"><span class="hljs-attr">labels</span></span>: { <span class="hljs-attr"><span class="hljs-attr">app</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">roleRef</span></span>: { <span class="hljs-attr"><span class="hljs-attr">apiGroup</span></span>: <span class="hljs-string"><span class="hljs-string">'rbac.authorization.k8s.io'</span></span>, <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'Role'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, }, <span class="hljs-attr"><span class="hljs-attr">subjects</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">kind</span></span>: <span class="hljs-string"><span class="hljs-string">'ServiceAccount'</span></span>, <span class="hljs-attr"><span class="hljs-attr">name</span></span>: params.name, <span class="hljs-attr"><span class="hljs-attr">namespace</span></span>: env.namespace, }, ], }, ]</code> </pre> <br><p style=";text-align:right;direction:rtl">  <strong>ุณูุตู</strong> ุฃูุถูุง ุงููุนููุงุช ุงูุฌุฏูุฏุฉ ูู <strong>ุงูุจูุฆุงุช / base.libsonnet</strong> ุ ูุงูุชู ุชุจุฏู ุงูุขู ููุง ููู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">local secrets = <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'../secrets/base.libsonnet'</span></span>; { <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabRunner</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner'</span></span>, <span class="hljs-attr"><span class="hljs-attr">values</span></span>: { <span class="hljs-attr"><span class="hljs-attr">gitlabUrl</span></span>: <span class="hljs-string"><span class="hljs-string">'https://gitlab.com/'</span></span>, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">create</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, }, <span class="hljs-attr"><span class="hljs-attr">runnerRegistrationToken</span></span>: secrets.runnerRegistrationToken, <span class="hljs-attr"><span class="hljs-attr">runners</span></span>: { <span class="hljs-attr"><span class="hljs-attr">serviceAccountName</span></span>: $.components.rbac.name, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/toolbox:v0.0.1'</span></span>, }, }, }, <span class="hljs-attr"><span class="hljs-attr">rbac</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'gitlab-runner-deploy'</span></span>, }, }, }</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุงุญุธุฉ ูุดูุฑ <strong>$ .components.rbac.name</strong> ุฅูู <strong>ุงุณู</strong> ูููู <strong>rbac</strong> </p><br><p style=";text-align:right;direction:rtl">  ุฏุนููุง ูุชุญูู ููุง ุชุบูุฑ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec diff default</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุชุทุจูู ุชุบููุฑุงุชูุง ุนูู Kubernetes: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">qbec apply default</code> </pre> <br><p style=";text-align:right;direction:rtl">  ููุง ูุง ุชูุณู ุฃู ุชูุชุฒู ุชุบููุฑุงุชูุง ูู ุจูุงุจุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">cd ../.. git add dockerfiles/toolbox git commit -m "Add Dockerfile for toolbox" git add deploy/gitlab-runner git commit -m "Configure gitlab-runner to use toolbox"</code> </pre> <br><hr><br><h1 id="9-nash-pervyy-payplayn-i-sborka-obrazov-po-tegamanchorpipeline-buildanchor" style=";text-align:right;direction:rtl">  9. ูุฏููุง ุฃูู ุฎุท ุฃูุงุจูุจ ูุชุฌููุน ุงูุตูุฑ ุจุงูุนูุงูุงุช <a name="pipeline-build"></a></h1><br><p style=";text-align:right;direction:rtl">  ูู ุฌุฐุฑ ุงููุดุฑูุน ุ <strong>ุณููุดุฆ .gitlab-ci.yml</strong> ูุน ุงููุญุชูู ุงูุชุงูู: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">.build_docker_image: stage: build image: name: gcr.io/kaniko-project/executor:debug-v0.15.0 entrypoint: [""] before_script: - echo "{\"auths\":{\"$CI_REGISTRY\":{\"username\":\"$CI_REGISTRY_USER\",\"password\":\"$CI_REGISTRY_PASSWORD\"}}}" &gt; /kaniko/.docker/config.json build_toolbox: extends: .build_docker_image script: - /kaniko/executor --cache --context $CI_PROJECT_DIR/dockerfiles/toolbox --dockerfile $CI_PROJECT_DIR/dockerfiles/toolbox/Dockerfile --destination $CI_REGISTRY_IMAGE/toolbox:$CI_COMMIT_TAG only: refs: - tags build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_TAG only: refs: - tags</code> </pre> <br><p style=";text-align:right;direction:rtl">  ูุฑุฌู ููุงุญุธุฉ ุฃููุง ูุณุชุฎุฏู <strong>GIT_SUBMODULE_STRATEGY: ุนุงุฏู</strong> ูุชูู ุงููุธุงุฆู ุงูุชู ุชุญุชุงุฌ ูููุง ุฅูู ุชููุฆุฉ ุงููุญุฏุงุช ุงููุฑุนูุฉ ุจุดูู ุตุฑูุญ ูุจู ุงูุชูููุฐ. </p><br><p style=";text-align:right;direction:rtl">  ูุง ุชูุณ ุฃู ุชูุชุฒู ุชุบููุฑุงุชูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git add .gitlab-ci.yml git commit -m "Automate docker build"</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุฃุนุชูุฏ ุฃูู ูููู ุฃู ูุณูููุง ุจุฃูุงู ุงูุฅุตุฏุงุฑ <strong>v0.0.1</strong> ูุดูู ุนูุงูุฉ: </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git tag v0.0.1</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุณูุนูู ุงูุนูุงูุงุช ุนูุฏูุง ูุญุชุงุฌ ุฅูู ุฅุตุฏุงุฑ ูุณุฎุฉ ุฌุฏูุฏุฉ.  ุณูุชู ุฑุจุท ุงูุนูุงูุงุช ุงูููุฌูุฏุฉ ูู Docker ุจุนูุงูุงุช Git.  ูู ุฏูุนุฉ ุจุนูุงูุฉ ุฌุฏูุฏุฉ ุณุชููู ุจุชููุฆุฉ ูุฌููุนุฉ ุงูุตูุฑ ุจูุฐู ุงูุนูุงูุฉ. </p><br><p style=";text-align:right;direction:rtl">  ูู ุจุชุดุบูู <strong>git push - ุนูุงูุงุช</strong> ุ ูุงูุธุฑ ุฅูู ุฎุท ุงูุฃูุงุจูุจ ุงูุฃูู ูุฏููุง: </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">ููุทุฉ ุดุงุดุฉ ูุฃูู ุฎุท ุฃูุงุจูุจ</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/5u/ce/fg/5ucefgejcfjz7jpwvou206mwufy.png"></p></div></div><br><blockquote style=";text-align:right;direction:rtl">  ูุฌุฏุฑ ุงูุงูุชุจุงู ุฅูู ุญูููุฉ ุฃู ุงูุชุฌููุน ุจุงูุนูุงูุงุช ููุงุณุจ ูุชุฌููุน ุตูุฑ ุนุงูู ูููุงุก ุ ููููู ุบูุฑ ููุงุณุจ ููุดุฑ ุชุทุจูู ูู Kubernetes.  ูุธุฑูุง ูุฃูู ูููู ุฃูุถูุง ุชุนููู ุนูุงูุงุช ุฌุฏูุฏุฉ ุนูู ุนูููุงุช ุงุฑุชูุงุจ ูุฏููุฉ ุ ูู ูุฐู ุงูุญุงูุฉ ุ ุณูุคุฏู ุชููุฆุฉ ุฎุท ุงูุฃูุงุจูุจ ููุง ุฅูู ูุดุฑ ุงูุฅุตุฏุงุฑ ุงููุฏูู. <br><br>  ูุญู ูุฐู ุงููุดููุฉ ุ ุนุงุฏุฉู ูุง ูุชู ุฅุฑูุงู ุชุฌููุน ุตูุฑ ุนุงูู ุงูุฅุฑุณุงุก ุจุงูุนูุงูุงุช ุ ููุดุฑ ุงูุชุทุจูู ุนูู ุงููุฑุน <strong>ุงูุฑุฆูุณู</strong> ุ ุญูุซ ุชููู ุฅุตุฏุงุฑุงุช ุงูุตูุฑ ุงูุชู ุชู ุชุฌููุนูุง ูุถุบูุทุฉ.  ูู ูุฐู ุงูุญุงูุฉ ุ ููููู ุชููุฆุฉ ุงูุชุฑุงุฌุน ุจุงุณุชุฎุฏุงู ุนูุงูุฉ ุงูุฑุฌูุน <strong>ุงูุฑุฆูุณูุฉ</strong> ุงูุจุณูุทุฉ. </blockquote><br><hr><br><h1 id="10-avtomatizaciya-deployaanchorpipeline-deployanchor" style=";text-align:right;direction:rtl">  10. ูุดุฑ ุงูุชุดุบูู ุงูุขูู <a name="pipeline-deploy"></a></h1><br><p style=";text-align:right;direction:rtl">  ููู ูููู Gitlab-runner ุจูู ุชุดููุฑ ุฃุณุฑุงุฑูุง ุ ูุญุชุงุฌ ุฅูู ุชุตุฏูุฑ ููุชุงุญ ุงููุณุชูุฏุน ุ ูุฅุถุงูุชู ุฅูู ูุชุบูุฑุงุช ุจูุฆุฉ CI ุงูุฎุงุตุฉ ุจูุง: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git crypt export-key /tmp/docs-repo.key base64 -w0 /tmp/docs-repo.key; echo</code> </pre> <br><p style=";text-align:right;direction:rtl">  ุงุญูุธ ุงูุณูุณูุฉ ุงููุงุชุฌุฉ ูู Gitlab ุ ููุฐุง ุณููุชูู ุฅูู ุฅุนุฏุงุฏุงุช ูุดุฑูุนูุง: <br>  <strong>ุงูุฅุนุฏุงุฏุงุช -&gt; CI / CD -&gt; ุงููุชุบูุฑุงุช</strong> </p><br><p style=";text-align:right;direction:rtl">    : </p><br><div class="scrollable-table" style=";text-align:right;direction:rtl"><table style=";text-align:right;direction:rtl"><thead><tr><th>  ููุน </th><th> Key </th><th> Value </th><th> Protected </th><th> Masked </th><th> Scope </th></tr></thead><tbody><tr><td> <code>File</code> </td> <td> <code>GITCRYPT_KEY</code> </td> <td> <code>&lt;your string&gt;</code> </td> <td> <code>true</code> <em>(     <code>false</code> )</em> </td><td> <code>true</code> </td> <td> <code>All environments</code> </td> </tr></tbody></table></div><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/vj/li/ea/vjliealfwwsmiy4-nvjfvcf89ig.png"></p></div></div><br><p style=";text-align:right;direction:rtl">    <strong>.gitlab-ci.yml</strong>   : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">.deploy_qbec_app: stage: deploy only: refs: - master deploy_gitlab_runner: extends: .deploy_qbec_app variables: GIT_SUBMODULE_STRATEGY: normal before_script: - base64 -d "$GITCRYPT_KEY" | git-crypt unlock - script: - qbec apply default --root deploy/gitlab-runner --force:k8s-context __incluster__ --wait --yes deploy_website: extends: .deploy_qbec_app script: - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes</code> </pre> <br><p style=";text-align:right;direction:rtl">        qbec: </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl"> <strong>--root some/app</strong> โ      </li><li style=";text-align:right;direction:rtl"> <strong>--force:k8s-context __incluster__</strong> โ   ,             gtilab-runner.   ,      qbec     Kubernetes-   kubeconfig </li><li style=";text-align:right;direction:rtl"> <strong>--wait</strong> โ  qbec ,        Ready       exit-code. </li><li style=";text-align:right;direction:rtl"> <strong>--yes</strong> โ     <strong>Are you sure?</strong>  . </li></ul><br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git add .gitlab-ci.yml git commit -m "Automate deploy"</code> </pre> <br><p style=";text-align:right;direction:rtl">   <strong>git push</strong>       : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/0p/aj/vs/0pajvs-a-lrxvfuw8zylnj6lleg.png"></p></div></div><br><hr><br><h1 id="11-artefakty-i-sborka-pri-push-v-masteranchorartifactsanchor" style=";text-align:right;direction:rtl"> 11.     push  master <a name="artifacts"></a></h1><br><p style=";text-align:right;direction:rtl">            ,             .           digest  master-. </p><br><p style=";text-align:right;direction:rtl">  :    <strong>website</strong>      push  <strong>master</strong> ,       Kubernetes. </p><br><p style=";text-align:right;direction:rtl">        <strong>.gitlab-ci.yml</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - mkdir -p $CI_PROJECT_DIR/artifacts - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_REF_NAME --digest-file $CI_PROJECT_DIR/artifacts/website.digest artifacts: paths: - artifacts/ only: refs: - master - tags deploy_website: extends: .deploy_qbec_app script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST"</code> </pre> <br><p style=";text-align:right;direction:rtl">  ,    <strong>master</strong>  <strong>refs</strong>   <strong>build_website</strong>     <strong>$CI_COMMIT_REF_NAME</strong>  <strong>$CI_COMMIT_TAG</strong> ,        Git           .  ,        ,           docker-registry. </p><br><p style=";text-align:right;direction:rtl">   docker-       ,        Kubernetes,           ,         . </p><br><p style=";text-align:right;direction:rtl">  <strong>--vm:ext-str digest="$DIGEST"</strong>  qbec โ      jsonnet.            .   ,     ,     ,               . </p><br><p style=";text-align:right;direction:rtl">     Kaniko  digest    ( <strong>--digest-file</strong> ) <br>          . </p><br><p style=";text-align:right;direction:rtl">     <strong>deploy/website/environments/base.libsonnet</strong>     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">{ <span class="hljs-attr"><span class="hljs-attr">components</span></span>: { <span class="hljs-attr"><span class="hljs-attr">website</span></span>: { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'example-docs'</span></span>, <span class="hljs-attr"><span class="hljs-attr">image</span></span>: <span class="hljs-string"><span class="hljs-string">'registry.gitlab.com/kvaps/docs.example.org/website@'</span></span> + std.extVar(<span class="hljs-string"><span class="hljs-string">'digest'</span></span>), <span class="hljs-attr"><span class="hljs-attr">replicas</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">containerPort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">servicePort</span></span>: <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">nodeSelector</span></span>: {}, <span class="hljs-attr"><span class="hljs-attr">tolerations</span></span>: [], <span class="hljs-attr"><span class="hljs-attr">ingressClass</span></span>: <span class="hljs-string"><span class="hljs-string">'nginx'</span></span>, <span class="hljs-attr"><span class="hljs-attr">domain</span></span>: <span class="hljs-string"><span class="hljs-string">'docs.example.org'</span></span>, }, }, }</code> </pre> <br><p style=";text-align:right;direction:rtl"> ,     <strong>master</strong>   docker-  <strong>website</strong> ,      Kubernetes. </p><br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git add . git commit -m <span class="hljs-string"><span class="hljs-string">"Configure dynamic build"</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl"> ,  <strong>git push</strong>    - : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">   master</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/7_/ry/nh/7_rynh5lgu_8hqnnl_gasx73zwq.png"></p></div></div><br><p style=";text-align:right;direction:rtl">       gitlab-runner   push, , ,      ,     <strong>.gitlab-ci.yml</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">deploy_gitlab_runner: extends: .deploy_qbec_app variables: GIT_SUBMODULE_STRATEGY: normal before_script: - base64 -d "$GITCRYPT_KEY" | git-crypt unlock - script: - qbec apply default --root deploy/gitlab-runner --force:k8s-context __incluster__ --wait --yes only: changes: - deploy/gitlab-runner/**/*</code> </pre> <br><p style=";text-align:right;direction:rtl"> <strong>changes</strong>      <strong>deploy/gitlab-runner/</strong>          </p><br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="bash hljs">git add .gitlab-ci.yml git commit -m <span class="hljs-string"><span class="hljs-string">"Reduce gitlab-runner deploy"</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl"> <strong>git push</strong> , - : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  </b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/-t/9b/3m/-t9b3mtofbunu7xfogpmb0pacsm.png"></p></div></div><br><hr><br><h1 id="12-dynamic-environmentsanchordynamic-environmentsanchor" style=";text-align:right;direction:rtl"> 12. Dynamic environments <a name="dynamic-environments"></a></h1><br><p style=";text-align:right;direction:rtl">       . </p><br><p style=";text-align:right;direction:rtl">     <strong>build_website</strong>   <strong>.gitlab-ci.yml</strong> ,     <strong>only</strong> ,   Gitlab        : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">build_website: extends: .build_docker_image variables: GIT_SUBMODULE_STRATEGY: normal script: - mkdir -p $CI_PROJECT_DIR/artifacts - /kaniko/executor --cache --context $CI_PROJECT_DIR --dockerfile $CI_PROJECT_DIR/dockerfiles/website/Dockerfile --destination $CI_REGISTRY_IMAGE/website:$CI_COMMIT_REF_NAME --digest-file $CI_PROJECT_DIR/artifacts/website.digest artifacts: paths: - artifacts/</code> </pre> <br><p style=";text-align:right;direction:rtl">    <strong>deploy_website</strong> ,    <strong>environment</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">deploy_website: extends: .deploy_qbec_app environment: name: prod url: https://docs.example.org script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST"</code> </pre> <br><p style=";text-align:right;direction:rtl">   Gitlab    <strong>prod</strong>       . </p><br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">deploy_website: extends: .deploy_qbec_app environment: name: prod url: https://docs.example.org script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply default --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST" deploy_review: extends: .deploy_qbec_app environment: name: review/$CI_COMMIT_REF_NAME url: http://$CI_ENVIRONMENT_SLUG.docs.example.org on_stop: stop_review script: - DIGEST="$(cat artifacts/website.digest)" - qbec apply review --root deploy/website --force:k8s-context __incluster__ --wait --yes --vm:ext-str digest="$DIGEST" --vm:ext-str subdomain="$CI_ENVIRONMENT_SLUG" --app-tag "$CI_ENVIRONMENT_SLUG" only: refs: - branches except: refs: - master stop_review: extends: .deploy_qbec_app environment: name: review/$CI_COMMIT_REF_NAME action: stop stage: deploy before_script: - git clone "$CI_REPOSITORY_URL" master - cd master script: - qbec delete review --root deploy/website --force:k8s-context __incluster__ --yes --vm:ext-str digest="$DIGEST" --vm:ext-str subdomain="$CI_ENVIRONMENT_SLUG" --app-tag "$CI_ENVIRONMENT_SLUG" variables: GIT_STRATEGY: none only: refs: - branches except: refs: - master when: manual</code> </pre> <br><p style=";text-align:right;direction:rtl">     push     master    preview  . </p><br><p style=";text-align:right;direction:rtl">      qbec: <strong>--app-tag</strong> โ             ,       Kubernetes qbec    . <br>           review,       . </p><br><p style=";text-align:right;direction:rtl">      <strong>qbec apply review</strong> ,  <strong>qbec apply default</strong> โ               (review  default): </p><br><p style=";text-align:right;direction:rtl">  <strong>review</strong>   <strong>deploy/website/qbec.yaml</strong> </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">spec: environments: review: defaultNamespace: docs server: https://kubernetes.example.org:8443</code> </pre> <br><p style=";text-align:right;direction:rtl">     <strong>deploy/website/params.libsonnet</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs">local env = std.extVar(<span class="hljs-string"><span class="hljs-string">'qbec.io/env'</span></span>); local paramsMap = { <span class="hljs-attr"><span class="hljs-attr">_</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/base.libsonnet'</span></span>, <span class="hljs-attr"><span class="hljs-attr">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/default.libsonnet'</span></span>, <span class="hljs-attr"><span class="hljs-attr">review</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./environments/review.libsonnet'</span></span>, }; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> std.objectHas(paramsMap, env) then paramsMap[env] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> error <span class="hljs-string"><span class="hljs-string">'environment '</span></span> + env + <span class="hljs-string"><span class="hljs-string">' not defined in '</span></span> + std.thisFile</code> </pre> <br><p style=";text-align:right;direction:rtl">        <strong>deploy/website/environments/review.libsonnet</strong> : </p><br><pre style=";text-align:right;direction:rtl"> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// this file has the param overrides for the default environment local base = import './base.libsonnet'; local slug = std.extVar('qbec.io/tag'); local subdomain = std.extVar('subdomain'); base { components+: { website+: { name: 'example-docs-' + slug, domain: subdomain + '.docs.example.org', }, }, }</span></span></code> </pre> <br><p style=";text-align:right;direction:rtl">       <strong>stop_review</strong> ,         gitlab    checkout    <strong>GIT_STRATEGY: none</strong> ,    <strong>master</strong> -   review  . <br>  ,        . <br>       review   ,     . </p><br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git add . git commit -m "Enable automatic review"</code> </pre> <br><p style=";text-align:right;direction:rtl"> <strong>git push</strong> , <strong>git checkout -b test</strong> , <strong>git push origin test</strong> , : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  environments  Gitlab</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/wc/pz/ce/wcpzcedcwgfqvr0h_thgcw4ylqk.png"></p></div></div><br><p style=";text-align:right;direction:rtl">  ? โ ,    : <strong>git checkout master</strong> , <strong>git push origin :test</strong> ,      environment   . </p><br><blockquote style=";text-align:right;direction:rtl">    ,        ,     <strong>.gitlab-ci.yml</strong>       . <br>          protected-,   <strong>master</strong> ,        . </blockquote><br><hr><br><h1 id="13-review-appsanchorreview-appsanchor" style=";text-align:right;direction:rtl"> 13. Review Apps <a name="review-apps"></a></h1><br><p style=";text-align:right;direction:rtl"> <strong><a href="https://docs.gitlab.com/ee/ci/review_apps/" rel="nofollow">Review Apps</a></strong>    ,                . </p><br><p style=";text-align:right;direction:rtl">      ,    <strong>.gitlab/route-map.yml</strong>       ,       : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"># Indices - source: /content\/(.+?)_index\.(md|html)/ public: '\1' # Pages - source: /content\/(.+?)\.(md|html)/ public: '\1/'</code> </pre> <br><p style=";text-align:right;direction:rtl">     : </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">git add .gitlab/ git commit -m "Enable review apps"</code> </pre> <br><p style=";text-align:right;direction:rtl"> <strong>git push</strong> ,  : </p><br><div class="spoiler" style=";text-align:right;direction:rtl"> <b class="spoiler_title">  Review App</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/ns/wi/za/nswizajvjjozyoluazo21pzq7t8.png"></p></div></div><br><h1 id="job-is-done" style=";text-align:right;direction:rtl"> Job is done! </h1><br><p style=";text-align:right;direction:rtl"> <strong> :</strong> </p><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  Gitlab: <a href="" rel="nofollow">https://gitlab.com/kvaps/docs.example.org</a> </li><li style=";text-align:right;direction:rtl">  GitHub: <a href="" rel="nofollow">https://github.com/kvaps/docs.example.org</a> </li></ul><br><p style=";text-align:right;direction:rtl">   ,    <img src="https://habrastorage.org/getpro/habr/post_images/cd7/2c7/9c3/cd72c79c3eeb7355e20bba58e9088654.gif" alt="ุตูุฑุฉ"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar481662/">https://habr.com/ru/post/ar481662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar481644/index.html">ููููุฉ ุงูุจูุงุก ุนูู ููุฏ ุงูุญูุงุฉ ูู ูุงุนุฏุฉ ุจูุงูุงุช SQL ูู ุงููุฑู ุงูุญุงุฏู ูุงูุนุดุฑูู: ุงูุณุญุจ ุ Kubernetes ู PostgreSQL multimaster</a></li>
<li><a href="../ar481648/index.html">Junos PyEZ ุนูู ุณุจูู ุงููุซุงู ูููุฉ ุงูุนุซูุฑ ุนูู ุดุจูุงุช IPv4 ุงููุฌุงููุฉ</a></li>
<li><a href="../ar481652/index.html">Backdoor (ุ) ุนูู ููุงุชู BlackBerry Android ุงูุฐููุฉ</a></li>
<li><a href="../ar481654/index.html">ุญูุงูุฉ ููู ุฌุนู QA Engineer ุงูุญูุงุฉ ุฃุณูู ุจุงููุณุจุฉ ูู ุจูุณุงุนุฏุฉ Test IT ุ ุจุงุณุชุฎุฏุงู Bot Framework</a></li>
<li><a href="../ar481656/index.html">PagerDuty ุ ุฃู ููุงุฐุง ูุฏ ูุง ุชูุงู ุฅุฏุงุฑุฉ ุงูุนูููุงุช ูููุงู</a></li>
<li><a href="../ar481664/index.html">Serverless ุงูุชุณุนูุฑ ูุงูุชูุงููู: AWS Lambda</a></li>
<li><a href="../ar481666/index.html">ููุงุนุฏ ุณูููุช ูููุช ุงููุฎุตุตุฉ</a></li>
<li><a href="../ar481668/index.html">ูุดููุฉ ุงูุนุงุฑุถ ุงูุฃูู ุ ุฃู ุตุนูุจุงุช ุชุญููู ุชุฏููุงุช ุงูููุฏูู WebRTC ุฅูู HLS</a></li>
<li><a href="../ar481670/index.html">ูู ุจุฅูุดุงุก ุฎุทุฉ ุนูู ุจุงุณุชุฎุฏุงู AWS Cloud Adoption Framework</a></li>
<li><a href="../ar481672/index.html">ุงูุขูู ุงูุฎูููุฉ ูู ุงููุชุตูุญ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>