<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🤦🏾 👶🏾 🙋🏽 Niveau de journalisation distinct pour chaque demande 🐪 🏇 🎖️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En lisant le radar de la technologie ThoughtWorks , je suis tombé sur la technique de la « journalisation séparée par demande ». Chez Confirmit, nous ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Niveau de journalisation distinct pour chaque demande</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436340/">  En lisant le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">radar de la</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">technologie</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ThoughtWorks</a> , je suis tombé sur la technique de la « <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">journalisation séparée par demande</a> ».  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Chez Confirmit, nous</a> utilisons largement la journalisation, et je me demandais comment cette fonctionnalité pouvait être implémentée. <br><a name="habracut"></a><br><h2>  Description du problème </h2><br>  Voyons ce qui est en jeu.  Supposons que nous ayons un service Web.  À un moment donné, il commence à planter sur les serveurs de production, mais uniquement pour certaines demandes.  Par exemple, les plantages se produisent uniquement pour un utilisateur spécifique.  Ou seulement sur un point d'accès séparé ... Nous devons trouver une raison.  Dans ce cas, la journalisation vient à notre aide. <br><br>  Nous pouvons insérer suffisamment d'instructions de journalisation dans notre code pour comprendre la cause du problème.  Ces instructions correspondent généralement à votre message avec un certain niveau de journal (Debug, Info, Warning, ...).  De plus, le journal lui-même a également son propre niveau.  Tous les messages avec des niveaux supérieurs au niveau du journal seront enregistrés dans le stockage du journal (fichier, base de données, ...).  Si le niveau du message est inférieur au niveau du journal, le message sera simplement rejeté. <br><br>  Lorsque notre application fonctionne correctement, nous voulons voir le moins d'entrées de journal possible afin que sa taille reste petite.  En même temps, si l'application plante, nous voulons que le journal contienne suffisamment d'entrées pour que nous puissions comprendre la cause du problème.  La difficulté ici est que nous définissons généralement un niveau d'enregistrement pour tous les enregistreurs dans notre application.  Si tout est en ordre, nous maintenons ce niveau élevé (par exemple, Avertissement).  Si nous devons rechercher la cause de l'échec, nous l'installons ci-dessous (par exemple, Debug). <br><br><h2>  Un niveau de journalisation par application </h2><br>  Lorsque nous définissons un niveau de journalisation bas dans l'application, nos magasins de journaux sont remplis d'une masse de messages.  Ces messages proviennent de différentes demandes et sont mélangés entre eux, car les demandes peuvent être servies simultanément.  Cela entraîne un certain nombre de problèmes potentiels: <br><br><ul><li>  Comment séparer les messages des requêtes problématiques des messages des autres requêtes? </li><li>  Les demandes qui n'entraînent pas de plantages passent toujours leur temps à écrire dans le référentiel de journaux, bien que ces messages ne soient jamais utilisés. </li><li>  Les messages des demandes réussies prendront de la place dans les référentiels de journaux, bien que ces messages ne soient jamais utilisés. </li></ul><br>  Honnêtement, ces difficultés ne sont pas insurmontables.  Pour séparer les messages des «bonnes» demandes des messages des «mauvaises» demandes, vous pouvez utiliser l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ID de corrélation</a> .  Tous les systèmes modernes de traitement des journaux permettent de filtrer les enregistrements selon divers critères, y compris celui-ci. <br><br>  La performance n'est généralement pas non plus un problème majeur.  Les systèmes de journalisation prennent en charge l'enregistrement asynchrone, donc l'effet d'une journalisation massive n'est généralement pas perturbateur. <br><br>  Et l'espace disque est maintenant relativement bon marché, donc le stockage de nombreux enregistrements n'est pas un problème.  Surtout si nous pouvons supprimer de temps à autre d'anciens enregistrements. <br><br>  Cependant, pouvons-nous améliorer ce système?  Pouvons-nous définir un niveau d'enregistrement distinct pour chaque demande, en fonction de certaines conditions?  Je voudrais considérer ce problème ici. <br><br><h2>  Niveau de journalisation distinct pour chaque demande </h2><br>  Permettez-moi d'indiquer les exigences de la solution que je mettrai en œuvre.  Il doit exister un moyen d'établir un niveau d'enregistrement distinct pour chaque demande.  Il doit exister un moyen flexible de spécifier les conditions qui déterminent le choix de ce niveau pour une demande spécifique.  Et il devrait être possible de modifier ces conditions pendant l'exécution du programme sans avoir à le redémarrer. <br><br>  Ainsi, la tâche est définie.  Commençons. <br><br>  Je vais créer un service Web simple basé sur .NET Core.  Il aura un seul contrôleur: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"api/[controller]"</span></span></span><span class="hljs-meta">)</span></span>] [ApiController] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValuesController</span></span> : <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { ... <span class="hljs-comment"><span class="hljs-comment">// GET api/values [HttpGet] public ActionResult&lt;IEnumerable&lt;string&gt;&gt; Get() { Logger.Info("Executing Get all"); return new[] { "value1", "value2" }; } // GET api/values/5 [HttpGet("{id}")] public ActionResult&lt;string&gt; Get(int id) { Logger.Info($"Executing Get {id}"); return "value"; } }</span></span></code> </pre> <br>  Nous discuterons plus tard de l'implémentation de la propriété <i>Logger</i> .  Pour cette application, j'utiliserai la bibliothèque <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">log4net</a> pour la journalisation.  Cette bibliothèque offre une opportunité intéressante.  Je parle de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">héritage de niveau</a> .  En bref, si dans la configuration de cette bibliothèque vous dites que le journal avec le nom <i>X</i> doit avoir le niveau de journalisation <i>Info</i> , cela signifie que tous les journaux avec des noms commençant par <i>X.</i> (par exemple, <i>XY</i> , <i>XZ</i> , <i>XAB</i> ) hériteront de ce même niveau. <br><br>  De là vient l'idée originale.  Pour chaque demande, je déterminerai en quelque sorte le niveau de journalisation requis.  Ensuite, je vais créer un nouveau journal nommé dans la configuration <i>log4net</i> .  Ce journal aura le niveau de journalisation requis.  Après cela, tous les objets d'enregistreur créés dans le cadre de la demande en cours doivent avoir des noms commençant par le nom de ce nouveau journal que j'ai créé.  Le seul problème ici est que <i>log4net</i> ne supprime jamais les journaux.  Une fois créés, ils existent tout au long de la vie de l'application.  Pour cette raison, je crée initialement un journal pour chaque niveau de journalisation possible: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="utf-8" ?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4net</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Console"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Appender.ConsoleAppender"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Layout.PatternLayout"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Pattern to output the caller's file name and line number --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">conversionPattern</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"%5level [%thread] (%file:%line) - %message%newline"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"RollingFile"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Appender.RollingFileAppender"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">file</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"RequestLoggingLog.log"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appendToFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maximumFileSize</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100KB"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">maxSizeRollBackups</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"log4net.Layout.PatternLayout"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">conversionPattern</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"%level %thread %logger - %message%newline"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">layout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WARN"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Console"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">appender-ref</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"RollingFile"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">root</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EdlinSoftware.Log.Error"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ERROR"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EdlinSoftware.Log.Warning"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WARN"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EdlinSoftware.Log.Info"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"INFO"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"EdlinSoftware.Log.Debug"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DEBUG"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logger</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">log4net</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Maintenant, j'ai plusieurs journaux avec les noms <i>EdlinSoftware.Log.XXXX</i> .  Ces noms serviront de préfixes des noms de journaux utilisés dans les requêtes.  Pour éviter les collisions entre les demandes, je stocke le préfixe calculé pour cette demande dans une instance <i>AsyncLocal</i> .  La valeur de cet objet sera définie dans le nouveau middleware OWIN: <br><br><pre> <code class="cs hljs">app.Use(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> (context, next) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { LogSupport.LogNamePrefix.Value = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> LogSupport.GetLogNamePrefix(context); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> next(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { LogSupport.LogNamePrefix.Value = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } });</code> </pre><br>  Lorsque cette valeur est définie, il est très facile de créer des enregistreurs avec le préfixe de nom souhaité: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogSupport</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> AsyncLocal&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; LogNamePrefix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncLocal&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ILog </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLogger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetLoggerWithPrefixedName(name); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ILog </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLogger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type type</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> GetLoggerWithPrefixedName(type.FullName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ILog </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLoggerWithPrefixedName</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(LogNamePrefix.Value)) { name = <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{LogNamePrefix.Value}</span></span></span><span class="hljs-string">.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{name}</span></span></span><span class="hljs-string">"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LogManager.GetLogger(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(LogSupport).Assembly, name); } .... }</code> </pre><br>  Maintenant, il est clair comment obtenir une instance d'enregistreur dans notre contrôleur: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Route(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"api/[controller]"</span></span></span><span class="hljs-meta">)</span></span>] [ApiController] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValuesController</span></span> : <span class="hljs-title"><span class="hljs-title">ControllerBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ILog _logger; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ILog Logger { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> =&gt; _logger ?? (_logger = LogSupport.GetLogger(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ValuesController))); } .... }</code> </pre><br>  Il ne reste qu'une seule chose: définir en quelque sorte les règles selon lesquelles nous choisissons le niveau de journalisation pour chaque demande.  Ce devrait être un mécanisme assez flexible.  L'idée de base est d'utiliser des scripts C #.  Je vais créer un <i>fichier LogLevelRules.json</i> , où je définirai un ensemble de paires «règle - niveau de journalisation»: <br><br><pre> <code class="json hljs">[ { <span class="hljs-attr"><span class="hljs-attr">"logLevel"</span></span>: <span class="hljs-string"><span class="hljs-string">"Debug"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ruleCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"context.Request.Path.Value == \"/api/values/1\""</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"logLevel"</span></span>: <span class="hljs-string"><span class="hljs-string">"Debug"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ruleCode"</span></span>: <span class="hljs-string"><span class="hljs-string">"context.Request.Path.Value == \"/api/values/3\""</span></span> } ]</code> </pre><br>  Ici <i>logLevel</i> est le niveau de journalisation souhaité, et <i>ruleCode</i> est un code C # qui renvoie une valeur booléenne pour la demande donnée.  L'application exécutera les codes de règles un par un.  La première règle, dont le code retourne vrai, sera utilisée pour définir le niveau de journalisation approprié.  Si toutes les règles retournent false, le niveau par défaut sera utilisé. <br><br>  Pour créer des délégués à partir d'une représentation sous forme de chaîne de règles, la classe <i>CSharpScript</i> est <i>utilisée</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Globals</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HttpContext context; } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogLevelRulesCompiler</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IReadOnlyList&lt;LogLevelRule&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Compile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReadOnlyList&lt;LogLevelRuleDescription&gt; levelRuleDescriptions</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;LogLevelRule&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> levelRuleDescription <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> levelRuleDescriptions ?? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LogLevelRuleDescription[<span class="hljs-number"><span class="hljs-number">0</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> script = CSharpScript.Create&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;(levelRuleDescription.RuleCode, globalsType: <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(Globals)); ScriptRunner&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt; runner = script.CreateDelegate(); result.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LogLevelRule(levelRuleDescription.LogLevel, runner)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } } <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogLevelRule</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LogLevel { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ScriptRunner&lt;<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt; Rule { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogLevelRule</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> logLevel, ScriptRunner&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; rule</span></span></span><span class="hljs-function">)</span></span> { LogLevel = logLevel ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(logLevel)); Rule = rule ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(rule)); } }</code> </pre><br>  Ici, la méthode <i>Compile</i> récupère une liste d'objets lus dans le <i>fichier LogLevelRules.json</i> .  Il crée un délégué <i>coureur</i> pour chaque règle. <br><br>  Cette liste de délégués peut être enregistrée: <br><br><pre> <code class="cs hljs">LogSupport.LogLevelSetters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LogLevelRulesCompiler().Compile( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LogLevelRulesFileReader().ReadFile(<span class="hljs-string"><span class="hljs-string">"LogLevelRules.json"</span></span>) );</code> </pre><br>  et utilisé à l'avenir: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">LogSupport</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IReadOnlyList&lt;LogLevelRule&gt; LogLevelSetters = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LogLevelRule[<span class="hljs-number"><span class="hljs-number">0</span></span>]; ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLogNamePrefix</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> globals = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Globals { context = context }; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logLevelSetter <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> LogLevelSetters) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> logLevelSetter.Rule(globals)) { result = <span class="hljs-string"><span class="hljs-string">$"EdlinSoftware.Log.</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{logLevelSetter.LogLevel}</span></span></span><span class="hljs-string">"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } }</code> </pre><br>  Ainsi, lorsque l'application démarre, nous lisons <i>LogLevelRules.json</i> , convertissons son contenu dans la liste des délégués à l'aide de la classe <i>CSharpScript</i> et enregistrons cette liste dans le champ <i>LogSupport.LogLevelSetters</i> .  Ensuite, pour chaque demande, nous exécutons des délégués à partir de cette liste pour obtenir le niveau de journalisation. <br><br>  La seule chose qui reste à faire est de suivre les modifications dans le <i>fichier LogLevelRules.json</i> .  Si nous voulons définir le niveau de journalisation pour certaines requêtes, nous ajoutons une nouvelle règle à ce fichier.  Pour forcer notre application à appliquer ces modifications sans redémarrer, il est nécessaire de surveiller le fichier: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watcher = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileSystemWatcher { Path = Directory.GetCurrentDirectory(), Filter = <span class="hljs-string"><span class="hljs-string">"*.json"</span></span>, NotifyFilter = NotifyFilters.LastWrite }; watcher.Changed += (sender, eventArgs) =&gt; { <span class="hljs-comment"><span class="hljs-comment">// ,  ,  ,   . Thread.Sleep(1000); LogSupport.LogLevelSetters = new LogLevelRulesCompiler().Compile( new LogLevelRulesFileReader().ReadFile("LogLevelRules.json") ); }; watcher.EnableRaisingEvents = true;</span></span></code> </pre><br>  Il convient de noter que, par souci de concision, j'ai omis le code de synchronisation de flux lorsque je travaillais avec le champ <i>LogSupport.LogLevelSetters</i> .  Mais en pratique, une telle synchronisation est nécessaire. <br><br>  Le code d'application complet peut être trouvé sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . <br><br><h2>  Inconvénients </h2><br>  Le code ci-dessus vous permet de résoudre le problème de la définition d'un niveau de journalisation distinct pour chaque demande.  Mais il a un certain nombre de lacunes.  Discutons-en. <br><br>  1. Cette approche modifie les noms des journaux.  Ainsi, dans le référentiel de journaux au lieu de " <i>MyClassLogger</i> ", quelque chose comme " <i>Edlinsoft.Log.Debug.MyClassLogger</i> " sera stocké.  Vous pouvez vivre avec, mais ce n'est pas très pratique.  Le problème peut peut-être être résolu en modifiant la disposition du journal (disposition du journal). <br><br>  2. Il est désormais impossible d'utiliser des instances statiques des classes de consignateurs, car elles doivent être créées séparément pour chaque demande.  Le problème le plus grave ici, à mon avis, est que les développeurs doivent toujours garder cela à l'esprit.  Quelqu'un pourrait accidentellement créer un champ statique avec un enregistreur et obtenir des résultats étranges.  Vous pouvez surmonter cette situation en créant une classe wrapper pour les enregistreurs au lieu d'utiliser directement les classes <i>log4net</i> .  Un tel wrapper peut toujours créer de nouvelles instances d'enregistreurs <i>log4net</i> pour chaque opération.  Dans ce cas, il peut être librement utilisé dans des champs statiques. <br><br>  3. L'approche décrite crée de nombreuses instances d'enregistreurs.  Cela consomme de la mémoire et des cycles de processeur à la fois lors de la création et pendant la récupération de place.  Selon votre application, cela peut ou non être un problème important. <br><br>  4. Lorsque nous modifions le fichier JSON avec les règles, le code de la règle peut contenir des erreurs.  Il est très simple d'utiliser des blocs try-catch pour que ces erreurs ne détruisent pas notre application principale.  Cependant, nous devons d'une manière ou d'une autre découvrir que quelque chose s'est mal passé.  Il existe deux types d'erreurs: <br><br><ul><li>  Erreurs de temps de compilation pour le code de règle dans les délégués. </li><li>  Erreurs d'exécution de ces délégués. </li></ul><br>  D'une manière ou d'une autre, nous devons découvrir ces erreurs, sinon notre enregistrement ne fonctionnera tout simplement pas et nous ne le saurons même pas. <br><br>  5. Le code de règle dans le fichier JSON peut, en principe, contenir toutes les instructions.  Cela pourrait potentiellement entraîner des problèmes de sécurité.  Il est nécessaire de limiter en quelque sorte les capacités de ce code.  En revanche, si un attaquant est capable d'écrire directement dans les fichiers de votre application, le problème de sécurité est évident. <br><br><h2>  Conclusion </h2><br>  En général, je n'ai pas eu l'impression qu'une telle solution devrait remplacer l'approche actuelle de la journalisation.  Un bon outil avec la possibilité de filtrer les entrées de journal peut aider ici même lorsque vous utilisez un seul niveau de journalisation pour l'application entière.  J'espère néanmoins que l'analyse de ce problème vous donnera matière à réflexion. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr436340/">https://habr.com/ru/post/fr436340/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr436328/index.html">PVS-Studio 7.00</a></li>
<li><a href="../fr436330/index.html">Création d'un jeu pour Game Boy</a></li>
<li><a href="../fr436332/index.html">PVS-Studio 7.00</a></li>
<li><a href="../fr436334/index.html">Apprentissage de concepts par interaction sensorimotrice</a></li>
<li><a href="../fr436338/index.html">Comment fonctionne l'aéroport de Vnoukovo</a></li>
<li><a href="../fr436342/index.html">Une introduction à l'optimisation robuste [... et une petite liste de courses que j'ai oublié ...]</a></li>
<li><a href="../fr436344/index.html">Fibaro Home Center 2 et thermostat pour chauffage au sol HeatIt. Comment augmenter la température</a></li>
<li><a href="../fr436346/index.html">Avez-vous toujours besoin de Docker, de microservices et d'une programmation réactive?</a></li>
<li><a href="../fr436348/index.html">Développer une équipe pour demander des données à partir d'une base de données - partie 2</a></li>
<li><a href="../fr436350/index.html">Apprenez les tactiques, techniques et connaissances communes contradictoires (ATT @ CK). Tactiques d'entreprise. Partie 7</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>