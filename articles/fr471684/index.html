<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüëß üõµ üö£üèæ Pourquoi vous devez cr√©er des modules pour Nginx üé≠ üë©üèº‚Äçüî¨ üê∑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nginx est un serveur Web qui r√©sout des dizaines de t√¢ches commerciales, est configur√©, mis √† l'√©chelle de mani√®re flexible et fonctionne sur presque ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pourquoi vous devez cr√©er des modules pour Nginx</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/oleg-bunin/blog/471684/">  Nginx est un serveur Web qui r√©sout des dizaines de t√¢ches commerciales, est configur√©, mis √† l'√©chelle de mani√®re flexible et fonctionne sur presque tous les syst√®mes d'exploitation et plates-formes.  Une liste des fonctionnalit√©s, capacit√©s et probl√®mes √† r√©soudre hors de la bo√Æte peut √™tre d√©crite dans une petite brochure.  Mais parfois, un certain nombre de t√¢ches commerciales ne peuvent √™tre r√©solues qu'en d√©veloppant vos propres modules pour nginx.  Ce sont des modules qui sont orient√©s m√©tier et contiennent une logique m√©tier, et pas seulement une solution syst√®me g√©n√©ralis√©e. <br><br><img src="https://habrastorage.org/webt/_g/qx/cl/_gqxcl-ni0gc2f2rsr7thf4tici.jpeg"><br><br>  En g√©n√©ral, tout dans nginx est constitu√© de modules qui ont √©t√© √©crits par quelqu'un.  Par cons√©quent, l'√©criture de modules sous nginx est non seulement possible, mais √©galement n√©cessaire.  Quand il est n√©cessaire de le faire et pourquoi, <strong>Vasily Soshnikov</strong> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">dedokOne</a> ) racontera sur l'exemple de plusieurs cas. <br><br>  Parlons des raisons qui encouragent l'√©criture de modules en C, de l'architecture et du noyau de nginx, de l'anatomie des modules HTTP, des modules C, NJS, Lua et nginx.conf.  Ceci est important √† savoir non seulement pour ceux qui d√©veloppent sous nginx, mais aussi pour ceux qui utilisent nginx-configs, Lua ou une autre langue √† l'int√©rieur de nginx. <br><br>  <em>Remarque: l'article est bas√© sur un rapport de Vasily Soshnikov.</em>  <em>Le rapport est constamment mis √† jour et mis √† jour.</em>  <em>Les informations contenues dans le mat√©riel sont assez techniques et afin d'en tirer le meilleur parti, les lecteurs doivent avoir une exp√©rience de travail avec le code nginx √† un niveau moyen et sup√©rieur.</em> <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/82CyWPpjNNY" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h2>  En bref sur nginx </h2><br>  <strong>Tout ce que vous utilisez avec nginx sont des modules</strong> .  Chaque directive dans la configuration nginx est un module distinct, qui a √©t√© soigneusement √©crit par des coll√®gues de la communaut√© nginx. <br><br>  <strong>Les directives dans nginx.conf sont √©galement des modules</strong> qui r√©solvent un probl√®me sp√©cifique.  Par cons√©quent, dans les modules nginx sont tout.  add_header, proxy_pass, toute directive - ce sont des modules ou des combinaisons de modules qui fonctionnent selon certaines r√®gles. <br><br>  <strong>Nginx est un framework</strong> qui a: E / S r√©seau et fichier, m√©moire partag√©e, configuration et script.  Il s'agit d'une √©norme couche de biblioth√®ques de bas niveau, sur laquelle vous pouvez tout faire pour travailler avec les lecteurs r√©seau. <br><br>  <strong>Nginx est rapide et stable, mais complexe</strong> .  Vous devriez √©crire un tel code pour ne pas perdre ces qualit√©s de nginx.  Les nginx instables en production sont des clients insatisfaits, et tout cela en d√©coule. <br><br><h2>  Pourquoi cr√©er vos propres modules </h2><br>  <strong>Convertissez le protocole HTTP en un autre protocole.</strong>  C'est la raison principale qui motive souvent la cr√©ation d'un module particulier. <br><br>  Par exemple, le module memcached_pass convertit HTTP en un autre protocole et vous pouvez travailler avec d'autres syst√®mes externes.  Le module proxy_pass vous permet √©galement de convertir, bien que de HTTP (s) √† HTTP (s).  Un autre bon exemple est fastcgi_pass. <br><br>  Ce sont toutes des directives du formulaire: "aller √† tel ou tel backend, o√π pas HTTP (mais dans le cas de proxy_pass HTTP)." <br><br>  <strong>Insertion de contenu dynamique: contournement AdBlock, insertion d'annonces.</strong>  Par exemple, nous avons un backend et il est n√©cessaire de modifier le contenu qui en d√©coule.  Par exemple, AdBlock, qui analyse le code d'insertion d'annonce, et nous devons y faire face - pour le r√©gler d'une mani√®re ou d'une autre. <br><br>  Une autre chose que vous devez souvent faire pour int√©grer du contenu est le probl√®me de la mise en cache HLS.  Lorsque les param√®tres sont mis en cache dans HLS, deux utilisateurs peuvent obtenir la m√™me session ou les m√™mes param√®tres.  De l√†, vous coupez ou ajoutez des param√®tres lorsque vous avez besoin de suivre quelque chose. <br><br>  <strong>Collecte de donn√©es Clickstream √† partir de compteurs Internet / mobiles.</strong>  Un cas populaire dans ma pratique.  Le plus souvent, cela se fait sur nginx, mais pas sur access.log, mais un peu plus intelligent. <br><br>  <strong>Conversion de toutes sortes de contenus.</strong>  Par exemple, le module rtmp pour vous permet de travailler non seulement avec rtmp, mais aussi avec HLS.  Ce module peut faire beaucoup avec du contenu vid√©o. <br><br>  <strong>Point d'autorisation g√©n√©rique: SEP ou Api Gateway.</strong>  C'est le cas lorsque nginx fonctionne dans le cadre de l'infrastructure: autorise, collecte des m√©triques, envoie des donn√©es √† la surveillance et √† ClickStream.  Nginx fonctionne ici comme un hub d'infrastructure - un point d'entr√©e unique pour les backends. <br><br>  <strong>Enrichissement des demandes pour leur tra√ßage ult√©rieur.</strong>  Les syst√®mes modernes sont tr√®s complexes, avec plusieurs types de backends qui forment diff√©rentes √©quipes.  En r√®gle g√©n√©rale, ils sont difficiles √† d√©buter, parfois il est m√™me difficile de comprendre d'o√π vient la demande et o√π elle va.  Pour simplifier le d√©bogage, certaines grandes entreprises utilisent une technique d√©licate - elles ajoutent certaines donn√©es aux demandes.  L'utilisateur ne les verra pas, mais √† partir de ces donn√©es, il est facile de tracer le chemin de demande √† l'int√©rieur du syst√®me.  C'est ce qu'on appelle une <strong>trace</strong> . <br><br>  <strong>Proxy S3.</strong>  Cette ann√©e, je vois souvent des gens travailler avec leurs objets via s3.  Mais il n'est pas n√©cessaire de le faire sur les modules C, l'infrastructure est √©galement suffisante dans nginx.  Pour r√©soudre certains de ces probl√®mes, vous pouvez utiliser Lua, quelque chose est en train d'√™tre r√©solu sur NJS.  Mais parfois il faut √©crire des modules en C. <br><br><h2>  Quand est-il temps de cr√©er des modules </h2><br>  Il y a deux crit√®res pour comprendre que le moment est venu. <br><br>  <strong>G√©n√©ralisation des fonctionnalit√©s.</strong>  Lorsque vous comprenez que quelqu'un d'autre a besoin de votre produit, vous devez le faire passer en Open Source, cr√©er des fonctionnalit√©s g√©n√©ralis√©es, le publier et le laisser √™tre utilis√©. <br><br>  <strong>R√©solution des probl√®mes commerciaux.</strong>  Lorsqu'une entreprise d√©finit de telles exigences qui ne peuvent √™tre satisfaites qu'en √©crivant son propre module pour nginx.  Par exemple, l'insertion / modification dynamique de contenu, la collecte ClickStream peut √™tre effectu√©e sur Lua, mais tr√®s probablement, cela ne fonctionnera pas normalement. <br><br><h2>  Architecture Nginx </h2><br>  J'√©cris du code nginx depuis longtemps.  Neuf de mes modules tournent en production, l'un d'eux est en Open Source, et en production pour beaucoup.  Par cons√©quent, j'ai de l'exp√©rience et de la compr√©hension. <br><blockquote>  Nginx est une poup√©e gigogne dans laquelle tout est construit autour du noyau. </blockquote>  Je comprends donc nginx. <br><blockquote>  Les noyaux sont des enveloppes sur epoll. </blockquote>  Epoll est une m√©thode qui vous permet de travailler de mani√®re asynchrone avec n'importe quel fichier descripteur, pas seulement avec des sockets, car un descripteur n'est pas seulement une socket. <br><br>  Au-dessus du c≈ìur se trouvent les amonts, HTTP et les scripts.  Par script, je veux dire nginx.conf, pas NJS.  En plus des amonts, du HTTP et des scripts, des modules HTTP sont d√©j√† construits, dont nous parlerons. <br><br><img src="https://habrastorage.org/webt/d7/b6/ff/d7b6ffhplgm4ddkbvncbfh4umym.jpeg"><br><br>  Un exemple classique d'amont et de HTTP sont les serveurs amont - directives √† l'int√©rieur de la configuration.  Un exemple de modules pour HTTP est add_header.  Un exemple de script est le fichier de configuration lui-m√™me.  Le fichier contient les modules qui composent nginx; il est interpr√©t√© d'une mani√®re ou d'une autre et vous permet de faire quelque chose en tant qu'administrateur ou en tant qu'utilisateur. <br><br>  Nous ne consid√©rerons pas le noyau et nous attarderons tr√®s bri√®vement sur les amonts, car il s'agit d'un univers s√©par√© √† l'int√©rieur de nginx.  L'histoire √† leur sujet m√©rite plusieurs articles. <br><br><h2>  Anatomie des modules HTTP </h2><br>  M√™me si vous n'√©crivez pas de code C dans nginx, mais que vous l'utilisez, n'oubliez pas la r√®gle principale. <br><blockquote>  Dans nginx, tout ob√©it au mod√®le de cha√Æne de responsabilit√© - COR. </blockquote>  Je ne sais pas comment traduire cela en russe, mais je vais d√©crire la logique.  Votre demande passe par une galaxie de modules de cha√Æne configur√©s, √† partir de l'emplacement.  Chacun de ces modules renvoie un r√©sultat.  Si le r√©sultat est mauvais, la cha√Æne est interrompue. <br><br><img src="https://habrastorage.org/webt/ky/sf/zj/kysfzj-evntyaf8v8q53ygxgrr4.jpeg"><br><br>  Lorsque vous d√©veloppez des modules ou utilisez une sorte de directive dans NJS et Lua, n'oubliez pas que votre code peut planter l'ex√©cution de cette cha√Æne. <br><br>  L'analogie la plus proche de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cha√Æne de responsabilit√©</a> est une ligne de code Bash: <br><br><pre><code class="bash hljs">grep -RI pool nginx | awk -F<span class="hljs-string"><span class="hljs-string">":"</span></span> <span class="hljs-string"><span class="hljs-string">'{print $1}'</span></span> | sort -u | wc -l</code> </pre> <br>  Dans le code, tout est assez simple: si AWK est tomb√© au milieu de la ligne, puis <code>sort</code> et les commandes suivantes √©choueront.  Le module nginx fonctionne de mani√®re similaire, mais la v√©rit√© est dans nginx et vous pouvez contourner cela - red√©marrez le code.  Mais vous devez √™tre pr√™t √† planter et √† ex√©cuter, tout comme vos modules que vous utilisez dans la configuration, mais pas le fait qu'il en soit ainsi. <br><br><h3>  Types de modules HTTP </h3><br><blockquote>  HTTP et nginx sont un tas de PHASES diff√©rentes. </blockquote><br><ul><li>  <strong>Gestion des phases - gestionnaires PHASE</strong> . </li><li>  <strong>Filtres - Filtres corps / en-t√™tes</strong> .  Ce filtrage est soit des en-t√™tes, soit des corps de demande. </li><li>  <strong>Les procurations</strong> .  Les modules proxy typiques sont proxy_pass, fastcgi_pass, memcached_pass. </li><li>  <strong>Modules pour un √©quilibrage de charge sp√©cifique - Equilibreurs de charge</strong> .  C'est le type de modules le plus sans torsion, ils ne sont pas beaucoup d√©velopp√©s.  Un exemple est le module Ketama CHash, qui vous permet de faire un hachage coh√©rent √† l'int√©rieur de nginx pour distribuer les requ√™tes aux backends. </li></ul><br>  Je vais parler de chacun de ces types et de leur objectif. <br><br><h3>  Gestionnaires de phases </h3><br>  Imaginez que nous ayons plusieurs phases, √† partir de la phase d'acc√®s.  Il y a plusieurs modules dans chaque phase.  Par exemple, la phase ACCESS est divis√©e en une connexion, une demande √† nginx, une v√©rification de l'autorisation de l'utilisateur.  Chaque module est une cellule de la cha√Æne.  Il peut y avoir un nombre infini de tels modules en phase. <br><br><img src="https://habrastorage.org/webt/pn/6b/t9/pn6bt9m3khwxmsxgnqjvyzwfcb0.jpeg"><br><br>  Le dernier et dernier gestionnaire est la phase CONTENT dans laquelle le contenu est livr√© √† la demande. <br><blockquote>  Le chemin est toujours le suivant: demande - une cha√Æne de gestionnaires - contenu de sortie. </blockquote>  Phases disponibles pour les d√©veloppeurs de modules √† partir des <a href="https://github.com/nginx/nginx/blob/master/src/http/ngx_">sources NGINX</a> : <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> { NGX_HTTP_POST_READ_PHASE = <span class="hljs-number"><span class="hljs-number">0</span></span>, NGX_HTTP_SERVER_REWRITE_PHASE, NGX_HTTP_FIND_CONFIG_PHASE, NGX_HTTP_REWRITE_PHASE, NGX_HTTP_POST_REWRITE_PHASE, NGX_HTTP_PREACCESS_PHASE, NGX_HTTP_ACESS_PHASE, NGX_HTTP_POST_ACESS_PHASE, NGX_HTTP_PRECONTENT_PHASE, NGX_HTTP_CONTENT_PHASE, NGX_HTTP_LOG_PHASE, } ngx_http_phases;</code> </pre> <br>  Les phases peuvent √™tre √©cras√©es, ajoutez votre propre gestionnaire.  Tous ne sont pas n√©cessaires dans la vie r√©elle, si vous n'√™tes pas le d√©veloppeur de Nginx Core.  Par cons√©quent, je ne parlerai pas de chaque phase, mais seulement des principales que j'ai utilis√©es. <br><br>  Le principal est <strong>ACCESS_PHASE.</strong>  Il est particuli√®rement utile d'ajouter votre autorisation √† nginx - pour v√©rifier l'ex√©cution de la demande en termes d'acc√®s. <br><br>  Les prochaines phases importantes que j'exploite souvent sont les phases de pr√©-contenu et de contenu.  <strong>PRECONTENT_PHASE vous</strong> permet de collecter des m√©triques sur le contenu qui est sur le point d'√™tre envoy√© en r√©ponse au client.  <strong>CONTENT_PHASE vous</strong> permet de g√©n√©rer votre propre contenu unique bas√© sur quelque chose. <br><br>  La derni√®re phase que j'utilise souvent est la phase d'enregistrement <strong>LOG_PHASE.</strong>  Par ailleurs, la directive ACCESS_LOG y fonctionne.  La phase de journalisation a les restrictions les plus folles qui me rendent fou: vous ne pouvez pas utiliser de sous-demande et g√©n√©ralement vous ne pouvez utiliser aucune demande.  Vous avez d√©j√† laiss√© le contenu √† l'utilisateur, et les gestionnaires, les posthandlers et toute sous-demande ne seront pas ex√©cut√©s. <br><br>  Je vais vous expliquer pourquoi c'est ennuyeux.  Disons quand vous voulez croiser nginx et Kafka dans la phase de journalisation.  Dans cette phase, tout est d√©j√† termin√©: il y a une taille calcul√©e du contenu, du statut, de toutes les donn√©es, mais vous ne pouvez pas le faire sur demande.  Ils n'y travaillent pas.  Vous devez √©crire sur des sockets nus dans la phase de journalisation pour envoyer des donn√©es √† Kafka. <br><br><h3>  Filtres corps / en-t√™tes </h3><br>  Il existe deux types de filtres: les filtres de corps et les filtres d'en-t√™tes. <br><br>  Un exemple de <strong>filtre Body</strong> est le module de filtre gzip.  Pourquoi des filtres corporels sont-ils n√©cessaires?  Imaginez que vous ayez un certain proxy_pass et que vous souhaitiez transformer le contenu ou l'analyser d'une mani√®re ou d'une autre.  Dans ce cas, vous devez utiliser le filtre Corps. <br><br>  Cela fonctionne comme ceci: de nombreux morceaux viennent √† vous, vous faites quelque chose avec eux, regardez le contenu, agr√©gez, etc.  Mais le filtre a √©galement des limites importantes.  Par exemple, si vous d√©cidez de changer le corps - pour ins√©rer ou couper le corps de la r√©ponse, n'oubliez pas que les attributs HTTP, par exemple, un flux de contenu, seront remplac√©s.  Cela peut conduire √† des effets √©tranges si vous ne pr√©voyez pas de restrictions et si vous r√©fl√©chissez correctement dans votre code. <br><br>  Un exemple de <strong>filtre d'en-t√™te</strong> est l'add_header que tout le monde a utilis√©.  L'algorithme fonctionne comme dans le filtre Body.  Une r√©ponse est pr√©par√©e pour le client et le filtre add_header vous permet d'y faire quelque chose: ajouter un en-t√™te, supprimer un en-t√™te, remplacer un en-t√™te, envoyer une sous-demande. <br><br>  Soit dit en passant, dans le filtre Corps et dans le filtre En-t√™te, des sous-demandes sont disponibles, vous pouvez m√™me envoyer des identifications internes √† un emplacement suppl√©mentaire. <br><br><h3>  Proxy </h3><br>  Il s'agit du type de modules le plus complexe et le plus controvers√© qui vous permet de mandater des requ√™tes vers des syst√®mes externes, par exemple, de <strong>convertir HTTP en un autre protocole</strong> .  Exemples: proxy_pass, redis_pass, tnt_pass. <br><br>  Le proxy est une interface que les d√©veloppeurs du noyau nginx ont propos√©e pour faciliter l'√©criture des modules proxy.  Si cela se fait de mani√®re classique, alors pour un tel proxy, les gestionnaires PHASES, les filtres, les √©quilibreurs seront ex√©cut√©s.  Cependant, si le protocole auquel vous souhaitez convertir HTTP est en quelque sorte diff√©rent des classiques, alors de gros probl√®mes commencent.  L'API proxy fournie par nginx n'est tout simplement pas adapt√©e - vous devez inventer ce module proxy √† partir de z√©ro. <br><br>  Un bon exemple d'un tel module est postgres_pass.  Il permet √† nginx de communiquer avec PostgreSQL.  Le module n'utilise pas du tout l'interface qui a √©t√© d√©velopp√©e dans nginx - il a son propre chemin. <br><blockquote>  N'oubliez pas le proxy, mais de pr√©f√©rence n'√©crivez pas.  Pour √©crire un proxy, vous devrez apprendre tous les nginx par c≈ìur - c'est tr√®s long et difficile. </blockquote><br><h3>  √âquilibreurs de charge </h3><br>  La t√¢che des √©quilibreurs de charge est tr√®s simple - travailler en mode round-robin.  Imaginez que vous avez une section en amont, certains serveurs, vous sp√©cifiez des poids et des m√©thodes d'√©quilibrage.  Il s'agit d'un √©quilibreur de charge typique. <br><br>  Ce mode n'est pas toujours adapt√©.  Par cons√©quent, le module Ketama CHash a √©t√© d√©velopp√©, o√π il est conditionnellement possible d'arriver √† une demande de hachage coh√©rente √† un serveur.  Parfois, c'est pratique.  Nginx Lua propose balancer_by_lua.  Sur Lua, vous pouvez √©crire n'importe quel √©quilibreur en g√©n√©ral. <br><br><h2>  Modules C </h2><br>  Vient ensuite mon opinion absolument subjective sur le d√©veloppement des modules C.  Pour commencer - mes r√®gles subjectives. <br><br>  <strong>Le module d√©marre avec les directives nginx.conf.</strong>  M√™me si vous cr√©ez un module C qui ne sera exploit√© que par votre entreprise, pensez toujours aux directives.  Commencez √† concevoir le module avec eux, car c'est avec cela que l'administrateur syst√®me communiquera.  C'est important - coordonnez toutes les nuances avec lui ou avec la personne qui fera fonctionner votre module C.  NGINX est un produit bien connu, ses directives ob√©issent √† certaines lois que les administrateurs syst√®me connaissent.  Par cons√©quent, pensez-y toujours. <br><br>  <strong>Utilisez le style de code nginx.</strong>  Imaginez que votre module sera pris en charge par une autre personne.  S'il conna√Æt d√©j√† nginx et son style de code, il lui sera beaucoup plus facile de lire et de comprendre votre code. <br><br>  R√©cemment, un bon ami d'Allemagne m'a demand√© de l'aider √† g√©rer un bug dans son code nginx.  Je ne sais pas pour quel style de code il l'a √©crit, mais je ne pouvais m√™me pas lire le code normalement. <br><br>  <strong>Utilisez le pool de m√©moire correct.</strong>  Gardez toujours cela √† l'esprit, m√™me si vous avez beaucoup d'exp√©rience avec nginx.  Une erreur typique d'un d√©veloppeur de module C novice pour nginx est d'obtenir le mauvais pool. <br><br>  Petit rappel: nginx utilise g√©n√©ralement l'id√©ologie des allocateurs faibles.  Vous pouvez y utiliser malloc, mais ce n'est pas recommand√©.  Il a ses propres dalles, son propre allocateur de m√©moire, vous devez l'utiliser.  Par cons√©quent, chaque objet a un lien vers son pool, et ce pool doit √™tre utilis√©.  Une erreur de novice typique consiste √† utiliser une connexion de pool dans le filtre d'en-t√™te, pas une demande de pool.  Cela signifie que si nous avons une connexion permanente, le pool se gonflera jusqu'√† ce qu'il n'y ait plus de m√©moire ou d'autres effets secondaires.  C'est donc important. <br><br>  De plus, de telles erreurs sont extr√™mement difficiles √† d√©buter.  Valgrind ("syshniks" comprendra) ne fonctionne pas avec l'allocation de dalles - cela affichera une image √©trange. <br><br>  <strong>N'utilisez pas les E / S bloquantes.</strong>  Une erreur typique de ceux qui souhaitent appliquer quelque chose d'ext√©rieur plus rapidement est d'utiliser le blocage des E / S et des sockets de blocage.  Vous ne pouvez jamais faire cela dans nginx - il contient de nombreux processus, mais chaque processus utilise un thread. <br><br>  Vous pouvez faire du multi-threading, mais, en r√®gle g√©n√©rale, cela ne fait qu'empirer les choses.  Si vous utilisez le blocage des E / S dans une telle architecture, alors tout le monde attendra cette pi√®ce de blocage. <br><br>  Je vais d√©chiffrer ce que j'ai dit ci-dessus. <br><br><h3>  Le module d√©marre avec les directives nginx.conf </h3><blockquote>  D√©cidez dans quels tableaux votre directive doit vivre: Principal, Serveur, HTTP, emplacement, emplacement si. </blockquote>  Essayez d'√©viter l'emplacement si - en r√®gle g√©n√©rale, cela conduit √† une utilisation tr√®s √©trange de la configuration nginx. <br><br>  Toutes les directives de nginx vivent dans diff√©rents contextes et dans diff√©rentes √©tendues.  La directive add_header peut fonctionner au niveau HTTP, au niveau emplacement, au niveau emplacement si niveau.  Ceci est g√©n√©ralement d√©crit dans la documentation. <br><blockquote>  Comprenez √† quels niveaux votre directive peut fonctionner, o√π la directive est ex√©cut√©e: gestionnaire PHASE, filtre corps / en-t√™te. </blockquote>  Ceci est important car dans nginx la configuration est gel√©e.  Par convention, lorsque vous √©crivez add_header quelque part au-dessus, cette valeur est liss√©e dans le bas add_header, que vous avez d√©j√† √† l'emplacement.  En cons√©quence, vous ajouterez deux en-t√™tes.  Cela s'applique √† toute directive. <br><br>  Si vous sp√©cifiez quelque chose comme port d'h√¥te, alors vice versa - pool de sockets.  Cela devrait √™tre indiqu√© une fois. <br><br>  En g√©n√©ral, j'interdirais toute fusion - vous n'en avez tout simplement pas besoin.  Par cons√©quent, vous devez toujours d√©terminer clairement dans quels tableaux nginx de la configuration r√©side votre directive ou votre ensemble de directives. <br><br>  Bon exemple: <br><br><pre> <code class="cpp hljs">location /my_location/ { add_header ‚ÄúMy-Header‚Äù ‚Äúmy value‚Äù; }</code> </pre> <br>  Ici, add_header est simplement ajout√© √† l'emplacement.  Le m√™me add_header pourrait √™tre quelque part au-dessus, et tout serait simplement contorsionn√©.  Il s'agit d'un comportement document√© et compr√©hensible. <br><blockquote>  R√©fl√©chissez √† ce qui pourrait entraver la mise en ≈ìuvre de la directive. </blockquote>  Imaginez que vous d√©veloppez un filtre Body.  Comme je l'ai dit ci-dessus, nginx place simplement votre module dans une cha√Æne commune, et vous n'avez aucune garantie que le module gzip ne soit pas entr√© dans la cha√Æne devant votre filtre Body au moment de la compilation.  Dans ce cas, si quelqu'un active le module gzip, les donn√©es seront envoy√©es √† votre module pour le gzip.  Cela menace que vous ne puissiez tout simplement rien faire avec le contenu.  Vous pouvez le recompresser, par exemple, mais c'est une moquerie du point de vue du CPU. <br><br>  Les m√™mes r√®gles s'appliquent √† tous les gestionnaires de phase - il n'y a aucune garantie qui sera appel√© avant et qui sera apr√®s.  Par cons√©quent, respectez celui qui sera appel√© apr√®s, et rappelez-vous que certains gzip ou autre chose peuvent vous arriver de fa√ßon inattendue. <br><br><h3>  Style de code Nginx </h3><br><blockquote>  Lorsque vous avez cr√©√© le produit, n'oubliez pas que quelqu'un le soutiendra.  N'oubliez pas le style de code nginx. </blockquote>  Avant d'√©crire votre module nginx, familiarisez-vous avec la source: l' <a href="">une</a> et la <a href="">seconde</a> . <br><br>  Si √† l'avenir vous vous lancez dans le d√©veloppement de modules nginx, alors vous serez bien au courant des sources nginx.  Vous les adorerez car il <strong>n'y a pas de documentation</strong> .  Vous apprendrez bien la structure du r√©pertoire nginx, apprendrez √† utiliser Grep, √©ventuellement Sed, lorsque vous aurez besoin de transf√©rer quelques morceaux de nginx vers vos modules. <br><br><h3>  Pool de m√©moire </h3><br>  Les piscines doivent √™tre utilis√©es correctement.  <strong>Par exemple, "r-&gt; connexion-&gt; pool! = R-&gt; pool".</strong>  En aucun cas, vous ne pouvez utiliser la configuration du pool de m√©moire lors du traitement des demandes, elle gonflera jusqu'au red√©marrage de nginx. <br><br>  Comprenez la dur√©e de vie de l'objet.  Supposons que la relecture de la demande ait exactement cette dur√©e de vie du pipeline.  Dans cette piscine, vous pouvez placer beaucoup de choses et faire de la place.  La connexion peut vivre th√©oriquement ind√©finiment - il vaut mieux y placer quelque chose de vraiment important. <br><br>  <strong>Essayez de ne pas utiliser d'allocateurs externes, par exemple, malloc / free</strong> .  Cela a un mauvais effet sur la fragmentation de la m√©moire.  Si vous travaillez avec de gros volumes de donn√©es et utilisez beaucoup de malloc, ce nginx ralentit assez bien. <br><br>  <strong>Pour les fans de Valgrind, il existe un</strong> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><strong>hack</strong></a> qui vous permet de d√©boguer les pools de nginx √† l'aide de Valgrind.  Ceci est important si vous avez beaucoup de code C sur nginx, car m√™me un d√©veloppeur exp√©riment√© dans l'utilisation de la m√©moire peut faire une erreur. <br><br><h3>  Blocage des E / S </h3><blockquote>  Ici, tout est simple - n'utilisez pas les E / S bloquantes. </blockquote>  Sinon, au moins il y aura des probl√®mes avec les connexions persistantes, mais au maximum, tout fonctionnera tr√®s longtemps. <br><br>  Je connais le cas o√π une personne a utilis√© Quora √† l'int√©rieur de nginx en mode blocage (ne demandez pas pourquoi).  Cela a conduit au fait que les connexions de maintien en vie ont abandonn√© leur activit√© et ont expir√© tout le temps.  Il vaut mieux ne pas le faire - tout fonctionnera longtemps, de mani√®re inefficace et vous devrez imm√©diatement tordre un million de d√©lais, car nginx d√©marrera le d√©lai sur de nombreuses choses. <br><br>  Mais il existe une alternative aux modules C - NJS et Lua. <br><br><h2>  Lorsque vous n'avez pas besoin de d√©velopper des modules C </h2><br>  Cette ann√©e, j'ai eu ma premi√®re exp√©rience de travail sur NJS, j'ai eu une impression subjective √† ce sujet et j'ai m√™me r√©alis√© ce qui manquait l√†-bas, pour que tout se passe bien.  Je voudrais √©galement parler de mon exp√©rience de travail sur Lua sous nginx et, en outre, partager les probl√®mes qui sont pr√©sents dans Lua. <br><br><h3>  Lua / LuaJit Essentials </h3><br>  Nginx n'utilise pas Lua, mais LuaJit.  Mais ce n'est pas Lua, car Lua a d√©j√† avanc√© deux versions, et LuaJit est coinc√© quelque part dans le pass√©.  <strong>L'auteur ne d√©veloppe pratiquement pas LuaJit - il vit souvent dans des fourchettes.</strong>  La fourche la plus r√©cente est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">LuaJit2</a> .  Cela ajoute des situations √©tranges dans le m√™me OpenResty. <br><br>  <strong>Garbage Collector a besoin d'attention</strong> .  LuaJit ne peut pas surmonter ce probl√®me - il suffit de trouver des solutions de contournement.  Avec une charge √©norme, lorsque de nombreux Garbage Collector persistants seront visibles sur le client avec des √©checs sur le graphique et 500 erreurs. Il existe de nombreuses fa√ßons de traiter le Garbage Collector √† Lua, je ne me concentrerai pas sur eux ici.  Il y a beaucoup d'informations √† ce sujet sur Internet. <br><br>  <strong>L'impl√©mentation de cha√Ænes entra√Æne des probl√®mes de performances</strong> .  C'est juste le mal de LuaJit, et √† Lua il a √©t√© r√©par√©.  L'impl√©mentation de cha√Ænes dans LuaJit d√©fie simplement toute logique.  Les lignes ralentissent de la mani√®re la plus folle, ce qui est associ√© √† l'impl√©mentation interne. <br><br>  <strong>Incapacit√© √† utiliser de nombreuses biblioth√®ques pr√™tes √† l'emploi</strong> .  Lua bloque initialement, donc la plupart des biblioth√®ques sur Lua et LuaJit utilisent des E / S de blocage.  En raison du fait que nginx ne bloque pas, il est impossible d'utiliser des biblioth√®ques pr√™tes √† l'emploi √† l'int√©rieur de nginx qui utilisent des E / S de blocage.  Cela ralentira nginx. <br><br>  Les raisons d'utiliser LuaJit sont identiques aux raisons d'utiliser des modules: <br><br><ul><li>  prototypage de modules complexes; </li><li>  Calculs HMAC, SHA pour les autorisations; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√©quilibreurs</a> ; </li><li>  petites applications: gestionnaires d'en-t√™te, r√®gles de redirection; </li><li>  calcul des variables pour nginx.conf. </li></ul><br>  O√π est-il pr√©f√©rable de ne pas utiliser LuaJit? <br><blockquote>  La r√®gle principale: ne traitez pas un √©norme corps sur Lua - cela ne fonctionne pas. </blockquote>  <strong>Les gestionnaires de contenu sur Lua ne fonctionnent pas non plus</strong> .  Essayez de minimiser la logique √† quelques <code>if</code> .  Un simple √©quilibreur fonctionnera, mais une barre lat√©rale sur Lua fonctionnera tr√®s mal. <br><br>  <strong>La m√©moire partag√©e ou Garbage Collector viendra.</strong>  N'utilisez pas la m√©moire partag√©e avec Lua - Garbage Collector va rapidement et avec garantie sortir tout le cerveau en production. <br><br>  <strong>N'utilisez pas de coroutines</strong> contenant beaucoup de compos√©s persistants.  Les coroutines g√©n√®rent encore plus de d√©chets √† l'int√©rieur du r√©cup√©rateur de d√©chets LuaJit, ce qui est mauvais. <br><br>  Si vous utilisez d√©j√† LuaJit, n'oubliez pas: <br><br><ul><li>  sur la surveillance de la m√©moire; </li><li>  sur le suivi et l'optimisation du travail de Garbage Collector; </li><li>  sur le fonctionnement de Garbage Collector, si vous avez √©crit une application compliqu√©e pour LuaJit, car vous devez ajouter quelque chose de nouveau. </li></ul><br><h3>  Njs </h3><br>  Quand j'√©tais √† NGINX Conf, ils m'ont convaincu que ce serait cool de ne pas √©crire de code en C. Je pensais que je devais essayer, et c'est ce que j'ai obtenu. <br><br>  <strong>Autorisation</strong>  Cela fonctionne, le code est simple, il n'affecte pas la vitesse - tout est super.  Mon petit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">prototype</a> avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lequel</a> j'ai commenc√© est 10 lignes de code.  Mais ces 10 lignes font une autorisation avec s3. <br><br>  <strong>Variables de calcul pour nginx.conf.</strong>  De nombreuses variables peuvent √™tre calcul√©es √† l'aide de NJS.  √Ä l'int√©rieur de Nginx, c'est cool.  Il y a une telle fonctionnalit√© dans Lua, mais il y a un Garbage Collector, donc ce n'est pas si cool. <br><br>  Cependant, tout n'est pas si bon.  Pour faire des choses vraiment cool sur NJS, il lui manque quelques petites choses. <br><br>  <strong>M√©moire partag√©e</strong> .  J'ai patch√© la m√©moire partag√©e, c'est ma propre fourchette, alors maintenant √ßa suffit. <br><br>  <strong>Filtres prenant en charge plusieurs phases</strong> .  Dans NJS, il n'y a que la phase de contenu et les variables, et le filtre d'en-t√™te fait tr√®s d√©faut.  Vous devez √©crire des b√©quilles pour ajouter beaucoup d'en-t√™tes.  Il n'y a pas assez de filtre de corps pour une logique complexe ou pour travailler avec du contenu. <br><br>  <strong>Informations sur la fa√ßon de le surveiller et de le profiler</strong> .  Je sais maintenant comment, mais j'ai d√ª √©tudier la source.  Il n'y a pas suffisamment d'informations ou d'outils sur le profilage appropri√©.  Si c'est le cas, il est cach√© o√π il est introuvable.  Au m√™me moment, il n'y a pas assez d'informations sur <strong>o√π je peux utiliser NJS</strong> et o√π je ne peux pas? <br><br>  <strong>Modules C.</strong>  J'avais envie d'√©tendre NJS. <br><br><h2>  Postface </h2><br>  <strong>Pourquoi cr√©er vos propres modules?</strong>  Pour r√©soudre des probl√®mes g√©n√©raux et commerciaux. <br><br>  <strong>Quand dois-je impl√©menter des modules en C?</strong>  S'il n'y a pas d'autres options.  Par exemple, une lourde charge, l'insertion de contenu ou des √©conomies de base sur le mat√©riel.  Ensuite, cela doit √™tre fait garanti en C. Dans la plupart des cas, Lua ou NJS convient.  Mais vous devez toujours penser √† l'avenir. <br><br>  <strong>Et sur Lua?</strong>  Lorsque vous ne pouvez pas √©crire en C. Par exemple, vous n'avez pas besoin de convertir le corps de la demande avec un √©norme RPS.  Votre nombre de clients augmente, √† un moment donn√©, vous cesserez de faire face - pensez-y. <br><br>  <strong>NJS?</strong>  Quand LuaJit en a marre de son Garbage Collector et de ses cordes.  Par exemple, l'autorisation a g√©n√©r√© de nombreux objets Garbage sur Lua, mais ce n'√©tait pas critique.  Cependant, cela s'est refl√©t√© dans la surveillance et ennuyeux.  Maintenant, il a cess√© d'appara√Ætre dans ma surveillance, et tout est devenu bon. <br><br><blockquote>  √Ä HighLoad ++ 2019, Vasily Soshnikov poursuivra le sujet des modules nginx et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">parlera</a> davantage de NJS, sans oublier la comparaison avec LuaJit et C. <br><br>  Consultez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">liste</a> compl√®te <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">des</a> rapports sur le site Web et rendez-vous les 7 et 8 novembre √† la plus grande conf√©rence pour les d√©veloppeurs de syst√®mes hautement charg√©s.  Suivez nos nouvelles id√©es dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">newsletter</a> et le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">canal t√©l√©gramme</a> . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471684/">https://habr.com/ru/post/fr471684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471666/index.html">D√©couvrez un d√©veloppeur iOS qui d√©m√©nage en Allemagne avec un visa de travail</a></li>
<li><a href="../fr471668/index.html">Analyse technique de l'exploit checkm8</a></li>
<li><a href="../fr471670/index.html">Essayer Jetpack Compose au combat?</a></li>
<li><a href="../fr471676/index.html">Escrocs au t√©l√©phone. La deuxi√®me action, dans laquelle je tombe en panne et me dirige vers le distributeur de billets le plus proche</a></li>
<li><a href="../fr471678/index.html">Services aux ours sur demande</a></li>
<li><a href="../fr471686/index.html">Comment AWS fabrique ses services r√©silients. Mise √† l'√©chelle du serveur et de la base de donn√©es</a></li>
<li><a href="../fr471688/index.html">Comment AWS fabrique ses services r√©silients. Mise √† l'√©chelle du r√©seau</a></li>
<li><a href="../fr471700/index.html">Comment j'ai choisi une pile technologique avec une base pour l'avenir</a></li>
<li><a href="../fr471702/index.html">Applications Web cyber-am√©lior√©es</a></li>
<li><a href="../fr471704/index.html">Le livre ¬´Mitochondries √©go√Østes. Comment maintenir la sant√© et d√©placer la vieillesse "</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>