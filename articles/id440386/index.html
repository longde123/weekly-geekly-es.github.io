<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💫 ⚙️ 🎅🏻 Membebaskan penanganan kesalahan dengan menghilangkan kesalahan 🦆 ☕️ 🤽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Go2 bertujuan untuk mengurangi overhead penanganan kesalahan, tetapi apakah Anda tahu apa yang lebih baik daripada sintaksis yang ditingkatkan untuk p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membebaskan penanganan kesalahan dengan menghilangkan kesalahan</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440386/"><img src="https://habrastorage.org/webt/-t/wg/qf/-twgqf5sqhxuyrhnilflk-luxtc.jpeg"><br><br>  <i>Go2 bertujuan untuk mengurangi overhead penanganan kesalahan, tetapi apakah Anda tahu apa yang lebih baik daripada sintaksis yang ditingkatkan untuk penanganan kesalahan?</i> <i><br></i> <br>  Tidak perlu menangani kesalahan sama sekali.  Saya tidak mengatakan "hapus kode penanganan kesalahan Anda", sebagai gantinya saya menyarankan mengubah kode Anda sehingga Anda tidak memiliki banyak kesalahan untuk ditangani. <br><br>  Artikel ini mengambil inspirasi dari bab "Define Errors Out of Existence" "dari buku" <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">A filosofi Desain Perangkat Lunak</a> "oleh John Ousterhout.  Saya akan mencoba menerapkan sarannya untuk Go. <br><a name="habracut"></a><br><h3>  Contoh pertama </h3><br>  Berikut adalah fungsi untuk menghitung jumlah baris dalam file: <br><br><pre><code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountLines</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( br = bufio.NewReader(r) lines <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> err error ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> { _, err = br.ReadString(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) lines++ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != io.EOF { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, err } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lines, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre> <br>  Kami membuat bufio.Reader, lalu duduk dalam satu lingkaran, memanggil metode ReadString, menambah penghitung hingga kami mencapai akhir file, dan kemudian mengembalikan jumlah baris yang dibaca.  Ini adalah kode yang ingin kami tulis, alih-alih CountLines dipersulit oleh penanganan kesalahan. <br><br>  Misalnya, ada konstruksi yang aneh: <br><br><pre> <code class="go hljs">_, err = br.ReadString(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>) lines++ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> }</code> </pre><br>  Kami menambah jumlah baris sebelum memeriksa kesalahan - ini terlihat aneh.  Alasan kita harus menuliskannya dengan cara ini adalah karena ReadString akan mengembalikan kesalahan jika menemui akhir file - io.EOF - sebelum menekan karakter baris baru.  Ini juga dapat terjadi jika tidak ada baris baru. <br><br>  Untuk mengatasi masalah ini, kami akan mengatur ulang logika untuk meningkatkan jumlah baris, dan kemudian melihat apakah kami perlu keluar dari loop (logika ini masih tidak benar, dapatkah Anda menemukan kesalahan?). <br><br>  Namun kami belum selesai memeriksa kesalahan.  ReadString akan mengembalikan io.EOF ketika sudah mencapai akhir file.  Ini diharapkan, ReadString perlu beberapa cara untuk mengatakan berhenti, tidak ada lagi yang bisa dibaca.  Oleh karena itu, sebelum mengembalikan kesalahan ke pemanggil CountLine, kita perlu memeriksa apakah kesalahan io.EOF tidak ditemukan, dan dalam kasus ini mengembalikannya ke pemanggil, jika tidak kita akan mengembalikan nol ketika semuanya baik-baik saja.  Inilah sebabnya mengapa fungsi baris terakhir tidak mudah <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lines, err</code> </pre> <br>  Saya pikir ini adalah contoh yang baik dari pengamatan Russ Cox bahwa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">penanganan kesalahan dapat membuat fungsi lebih sulit</a> .  Mari kita lihat versi yang ditingkatkan. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CountLines</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(r io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { sc := bufio.NewScanner(r) lines := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> sc.Scan() { lines++ } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lines, sc.Err() }</code> </pre> <br>  Versi ini meningkatkan transisi dari menggunakan bufio.Reader ke bufio.Scanner.  Di bawah tenda, bufio.Scanner menggunakan bufio.Reader, menambahkan lapisan abstraksi yang membantu menghapus penanganan kesalahan, yang menghambat pekerjaan CountLines versi kami sebelumnya (bufio.Scanner dapat memindai template apa pun, secara default ia mencari baris baru). <br><br>  Metode sc.Scan () mengembalikan true jika pemindai menemukan satu baris teks dan tidak menemukan kesalahan.  Dengan demikian, isi loop for kami akan dipanggil hanya ketika ada baris teks di buffer pemindai.  Ini berarti bahwa kami me-reset CountLines kami dengan benar menangani case ketika tidak ada karakter baris baru.  Juga sekarang kasus ketika file kosong ditangani dengan benar. <br><br>  Kedua, karena sc.Scan mengembalikan false ketika kesalahan terjadi, loop for kami akan berakhir ketika akhir file tercapai atau kesalahan terjadi.  Ketik bufio.Scanner mengingat kesalahan terdeteksi kesalahan pertama, dan kami memperbaiki kesalahan ini setelah keluar dari loop menggunakan metode sc.Err (). <br><br>  Akhirnya, buffo.Scanner mengurus pemrosesan io.EOF dan mengubahnya menjadi nol jika akhir file tercapai tanpa kesalahan. <br><br><h3>  Contoh kedua </h3><br>  Contoh kedua saya terinspirasi oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Kesalahan</a> Rob Pikes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">adalah nilai-nilai</a> posting blog. <br><br>  Saat bekerja dengan membuka, menulis, dan menutup file, penanganan kesalahan adalah, tetapi tidak terlalu mengesankan, karena operasi dapat disimpulkan pada pembantu seperti ioutil.ReadFile dan ioutil.WriteFile.  Namun, ketika bekerja dengan protokol jaringan tingkat rendah, seringkali perlu untuk membangun respons secara langsung menggunakan primitif I / O, sehingga penanganan kesalahan dapat mulai diulang.  Pertimbangkan fragmen server HTTP ini yang membuat respons HTTP / 1.1: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Header <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Key, Value <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> Status <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { Code <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Reason <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, st Status, headers []Header, body io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { _, err := fmt.Fprintf(w, <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 %d %s\r\n"</span></span>, st.Code, st.Reason) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, h := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> headers { _, err := fmt.Fprintf(w, <span class="hljs-string"><span class="hljs-string">"%s: %s\r\n"</span></span>, h.Key, h.Value) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> _, err := fmt.Fprint(w, <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>); err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err } _, err = io.Copy(w, body) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> err }</code> </pre> <br>  Pertama kita membuat bilah status menggunakan fmt.Fprintf dan memeriksa kesalahan.  Kemudian, untuk setiap tajuk, kami mencatat kunci dan nilai tajuk, setiap kali memeriksa kesalahan.  Terakhir, kita akhiri bagian tajuk dengan \ r \ n tambahan, periksa kesalahan, dan salin badan respons ke klien.  Akhirnya, meskipun kita tidak perlu memeriksa kesalahan dari io.Copy, kita perlu mengonversinya dari formulir dengan dua nilai kembali, yang io.Copy kembali ke nilai pengembalian tunggal yang diharapkan oleh WriteResponse. <br><br>  Ini tidak hanya banyak pekerjaan yang berulang, setiap operasi, yang pada dasarnya menulis byte ke io.Writer, memiliki bentuk penanganan kesalahan yang berbeda.  Tapi kita bisa membuat tugas kita lebih mudah dengan memperkenalkan pembungkus kecil. <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">type</span></span> errWriter <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { io.Writer err error } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(e *errWriter)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(buf []</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, error)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> e.err != <span class="hljs-literal"><span class="hljs-literal">nil</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>, e.err } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> n <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n, e.err = e.Writer.Write(buf) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n, <span class="hljs-literal"><span class="hljs-literal">nil</span></span> }</code> </pre><br>  errWriter memenuhi kontrak io.Writer, sehingga dapat digunakan untuk memigrasikan io.Writer yang ada.  errWriter mentransfer rekaman ke perekam yang mendasarinya hingga kesalahan terdeteksi.  Mulai sekarang, ia membuang semua entri dan mengembalikan kesalahan sebelumnya. <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(w io.Writer, st Status, headers []Header, body io.Reader)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">error</span></span></span></span> { ew := &amp;errWriter{Writer: w} fmt.Fprintf(ew, <span class="hljs-string"><span class="hljs-string">"HTTP/1.1 %d %s\r\n"</span></span>, st.Code, st.Reason) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, h := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> headers { fmt.Fprintf(ew, <span class="hljs-string"><span class="hljs-string">"%s: %s\r\n"</span></span>, h.Key, h.Value) } fmt.Fprint(ew, <span class="hljs-string"><span class="hljs-string">"\r\n"</span></span>) io.Copy(ew, body) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ew.err }</code> </pre><br>  Menerapkan errWriter ke WriteResponse sangat meningkatkan kejelasan kode.  Masing-masing operasi tidak lagi perlu membatasi diri untuk pengecekan kesalahan.  Pesan kesalahan bergerak ke akhir fungsi, memeriksa bidang ew.err dan menghindari terjemahan yang mengganggu dari nilai io.Copy yang dikembalikan <br><br><h3>  Kesimpulan </h3><br>  Saat Anda mengalami penanganan kesalahan yang berlebihan, cobalah mengekstraksi beberapa operasi sebagai jenis pembungkus tambahan. <br><br><h2>  Tentang penulis </h2><br>  Penulis artikel ini, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Dave Cheney</a> , adalah penulis banyak paket populer untuk Go, misalnya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">github.com/pkg/errors</a> dan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://github.com/davecheney/">github.com/davecheney/httpstat</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id440386/">https://habr.com/ru/post/id440386/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id440372/index.html">Kompilator Pascal saya dan seni kontemporer Polandia</a></li>
<li><a href="../id440374/index.html">Fungsi Yandex mengirim email</a></li>
<li><a href="../id440376/index.html">20 game untuk mengajarkan pemrograman anak Anda</a></li>
<li><a href="../id440378/index.html">Kembali ke layanan microser dengan Istio. Bagian 2</a></li>
<li><a href="../id440382/index.html">Apakah 200 baik atau buruk?</a></li>
<li><a href="../id440388/index.html">Interval: Evolusi C ++ yang Mendatang</a></li>
<li><a href="../id440390/index.html">Dunia beragam sistem embedded dan tempat Embox di dalamnya</a></li>
<li><a href="../id440392/index.html">WebRTC di situs Anda - tanpa bug dan tanpa anggaran</a></li>
<li><a href="../id440394/index.html">Eskalasi hak istimewa PostgreSQL - parsing CVE-2018-10915</a></li>
<li><a href="../id440398/index.html">Sejarah partisipasi (dan kemenangan) di Piala AI Rusia 2018 - CodeBall</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>