<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üàπ üë®üèΩ‚Äç‚úàÔ∏è üë¶üèª IPSec √úbersicht bei Mikrotik üèß ü•â üíø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IPSec (IP Security) - eine Reihe von Protokollen und Algorithmen zum Verschl√ºsseln von Daten in IPv4- und IPv6-Netzwerken. Es klingt nicht kompliziert...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>IPSec √úbersicht bei Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438176/"><p>  IPSec (IP Security) - eine Reihe von Protokollen und Algorithmen zum Verschl√ºsseln von Daten in IPv4- und IPv6-Netzwerken.  Es klingt nicht kompliziert, aber IPSec legt keine klaren Regeln f√ºr die Verschl√ºsselung des Datenverkehrs fest. Stattdessen implementieren Entwickler eine Reihe von Tools (Protokolle und Algorithmen), mit denen der Administrator einen sicheren Datenkanal erstellt. </p><br><p>  Ich m√∂chte IPSec in RouterOS etwas tiefer als ein einfaches HOWTO ansprechen, mit minimaler Theorie und Beispielen zum Konfigurieren und Debuggen von IPSec.  Dies ist keine Anleitung, und ohne √úbung auf einem Pr√ºfstand wird nicht empfohlen, mit der Einrichtung echter Tunnel und VPN-Server zu beginnen. </p><a name="habracut"></a><br><h3 id="preimuschestva-i-nedostatki-ipsec">  Vor- und Nachteile von IPSec </h3><br><p>  Starke Seiten: </p><br><ul><li>  Funktioniert auf Netzwerkebene des OSI-Modells </li><li>  Es kann das Quellpaket vollst√§ndig oder von der Transportschicht und h√∂her verschl√ºsseln </li><li>  Es gibt einen Mechanismus, um NAT zu √ºberwinden </li><li>  Eine breite Palette von Verschl√ºsselungs- und Traffic-Hashing-Algorithmen zur Auswahl </li><li>  IPSec - Eine Reihe offener, erweiterbarer Standards </li><li>  Im Fall von Mikrotik ist der Kauf zus√§tzlicher Geb√ºhren oder Lizenzen nicht erforderlich </li></ul><br><p>  Schw√§chen: </p><br><ul><li>  Schwierigkeit </li><li>  Unterschiedliche Terminologie- und Konfigurationstools f√ºr verschiedene Anbieter </li><li>  Die Verwendung starker Verschl√ºsselungsalgorithmen erfordert eine gute Rechenleistung. </li><li>  DPI leicht zu erkennen </li></ul><br><h3 id="protokoly-v-sostave-ipsec">  Protokolle in IPSec </h3><br><p><img src="https://habrastorage.org/webt/nd/k6/0m/ndk60mwkllka7jpnl2flzdqt8ce.png"></p><br><p>  Weltweit k√∂nnen alle Protokolle, mit denen Sie sich w√§hrend der Konfiguration befassen, in zwei Gruppen unterteilt werden: Schl√ºsselaustauschprotokolle und Datenschutzprotokolle. </p><br><p>  <strong>Schl√ºsselaustauschprotokolle (IKE)</strong> <br>  Die Hauptaufgabe besteht darin, die Teilnehmer an der Verbindung zu authentifizieren und Verschl√ºsselungsparameter und -schl√ºssel zu vereinbaren, um die √ºbertragenen Informationen zu sch√ºtzen. </p><br><ul><li>  IKE (Internet Key Exchange) - definiert 1998.  Viele Funktionen (z. B. NAT-Bridging) wurden sp√§ter als Add-Ons hinzugef√ºgt und k√∂nnen m√∂glicherweise nicht bei verschiedenen Anbietern implementiert werden.  Die Basis f√ºr Schl√ºsselverhandlungen ist ISAKMP. </li><li>  IKEv2 (Internet Key Exchange Version 2) - neueste Version von 2014.  Es handelt sich um eine Weiterentwicklung des IKE-Protokolls, bei der einige Probleme behoben, der Schl√ºsselvereinbarungsmechanismus vereinfacht und Erweiterungen (NAT-T, Keepalives, Mode Config) Teil des Protokolls wurden. </li></ul><br><p>  In der Praxis werden die meisten IPSec-Verbindungen mithilfe von IKE implementiert, da die Ger√§te veraltet sind oder Administratoren nicht bereit sind, √Ñnderungen vorzunehmen. </p><br><p>  <strong>Datenschutzprotokolle (ESP, AH)</strong> <br>  Die Hauptaufgabe besteht darin, Benutzerdaten zu sch√ºtzen. </p><br><ul><li>  ESP (Encapsulating Security Payload) - verschl√ºsselt und authentifiziert √ºbertragene Daten teilweise </li><li>  AH (Authentication Header) - authentifiziert das gesamte Paket (mit Ausnahme von ver√§nderlichen Feldern), verschl√ºsselt keine Daten, stellt jedoch sicher, dass das Paket w√§hrend der √úbertragung √ºber das Netzwerk nicht ge√§ndert wurde </li></ul><br><h3 id="poryadok-ustanovki-ipsec-soedineniya">  Installationsverfahren f√ºr die IPSec-Verbindung </h3><br><p><img src="https://habrastorage.org/webt/lu/rv/ps/lurvpsvrdub2tcgkmpx8ut5ep58.png"></p><br><p>  Teilnehmer einer IPSec-Verbindung werden normalerweise als Peers bezeichnet, was ihre √Ñquivalenz in der hergestellten Verbindung anzeigt.  Eine Konfiguration in der N√§he des Client-Servers ist m√∂glich, aber beim Erstellen permanenter IPSec-Tunnel kann jeder der Peers ein Initialisierer sein. </p><br><ol><li>  Einer der Peers initiiert eine IPSec-Verbindung </li><li>  Es gibt einen Austausch von Schl√ºsselinformationen, Peer-Authentifizierung und Koordination der Verbindungsparameter </li><li>  Basierend auf den empfangenen Schl√ºsselinformationen wird ein zus√§tzlicher verschl√ºsselter Tunnel gebildet </li><li>  Mithilfe eines verschl√ºsselten Tunnels bestimmen Peers die Parameter der Datenverschl√ºsselung und tauschen Informationen aus, um Schl√ºssel zu generieren </li><li>  Das Ergebnis der vorherigen Phase ist ein Satz von Regeln und Schl√ºsseln f√ºr den Datenschutz (SA). </li><li>  Peers aktualisieren regelm√§√üig die Verschl√ºsselungsschl√ºssel </li></ol><br><p>  Eines der Schl√ºsselkonzepte in IPSec ist SA (Security Association) - eine Reihe von Verschl√ºsselungsalgorithmen zum Verschl√ºsseln und Hashing von Informationen sowie Verschl√ºsselungsschl√ºssel. </p><br><p>  Manchmal finden Sie eine Unterteilung in: </p><br><ul><li>  ISAKMP SA - Parameter und Schl√ºssel f√ºr den Hilfstunnel </li><li>  Data SA (oder einfach SA) - Parameter und Schl√ºssel f√ºr die Verkehrsverschl√ºsselung </li></ul><br><h3 id="poryadok-raboty-protokolov-soglasovaniya-klyuchey">  Schl√ºsselvereinbarungsprotokolle </h3><br><p>  Das IKE-Protokoll kann in zwei Modi arbeiten: main (main) und aggressiv (aggressiv). Das IKEv2-Protokoll enth√§lt einen Modus. </p><br><h4 id="ike-main">  IKE Main </h4><br><p><img src="https://habrastorage.org/webt/zw/jb/yv/zwjbyvrpmup5t7nfgaol329rudi.png"></p><br><p>  Die erste Phase besteht aus sechs Paketen: <br>  1-2: Ausrichtung der Einstellungen f√ºr die sekund√§re Tunnelverschl√ºsselung und verschiedener IPSec-Optionen <br>  3-4: Informationen teilen, um einen geheimen Schl√ºssel zu generieren <br>  5-6: Peer-Authentifizierung mit Auxiliary Encrypted Channel </p><br><p>  Die zweite Phase besteht aus drei Paketen: <br>  1-3: Verwenden eines verschl√ºsselten Hilfskanals.  Koordination der Verkehrsschutzparameter, Informationsaustausch zur Generierung eines geheimen Schl√ºssels </p><br><h3 id="ike-aggressive">  IKE Aggressiv </h3><br><p><img src="https://habrastorage.org/webt/xu/wz/qu/xuwzqu4qle5lxlcvb-hnvuhqehg.png"></p><br><p>  Die erste Phase besteht aus drei Paketen: <br>  1: Einreichen eines Angebots zur Installation eines zus√§tzlichen verschl√ºsselten Kanals und von Informationen zum Generieren eines privaten Schl√ºssels <br>  2: Antwort auf das Angebot, Informationen zum Generieren des geheimen Schl√ºssels, Daten zur Authentifizierung <br>  3: Authentifizierungsdaten </p><br><p>  Die zweite Phase besteht aus drei Paketen: <br>  1-3: Verwenden eines verschl√ºsselten Hilfskanals.  Koordination der Verkehrsschutzparameter, Informationsaustausch zur Generierung eines geheimen Schl√ºssels </p><br><p>  Im aggressiven Modus sendet der Initiator nur einen Parametersatz im Satz.  Der Informationsaustausch zur Peer-Authentifizierung erfolgt vor der Installation eines sicheren Hilfstunnels.  Der aggressive Modus ist schneller konsistent, aber weniger sicher. </p><br><h3 id="ikev2">  IKEv2 </h3><br><p><img src="https://habrastorage.org/webt/ev/mq/ni/evmqnimq5_sdeybuz63x3ddssbu.png"></p><br><p>  In IKEv2 hei√üen die Phasen: IKE_SA_INIT und IKE_AUTH.  <em>Wenn ich jedoch sp√§ter im Text √ºber Phase1 und Phase2 spreche, gilt dies auch f√ºr die Phasen von IKEv2.</em> </p><br><p>  Jede Phase von IKEv2 besteht aus zwei Paketen: <br>  IKE_SA_INIT: Koordination der Hilfstunnelverschl√ºsselungsparameter, Informationsaustausch zur Generierung eines privaten Schl√ºssels </p><br><p>  IKE_AUTH: Verwenden des verschl√ºsselten Hilfskanals.  Authentifizierung von Peers, Koordination von Verkehrsschutzparametern, Informationsaustausch zur Generierung eines geheimen Schl√ºssels </p><br><h3 id="security-assotiations-database-sad">  Security Assotiations Database (SAD) </h3><br><p>  Das Ergebnis von IKE (und IKEv2) sind Security Assotiations (SA), die Verkehrsschutzeinstellungen und Verschl√ºsselungsschl√ºssel definieren.  Jede SA ist unidirektional und die IPSec-Verbindung enth√§lt ein Paar SAs.  Alle SAs werden in der SAD-Datenbank gespeichert und stehen dem Administrator zum Anzeigen und Zur√ºcksetzen zur Verf√ºgung. </p><br><h3 id="inkapsulyaciya-dannyh">  Datenkapselung </h3><br><p><img src="https://habrastorage.org/webt/3z/3k/aa/3z3kaaj2rwmnx59apvueigp3lno.png"></p><br><p>  IPSec bietet zwei Optionen zum Einkapseln von Daten: </p><br><ul><li>  Transportmodus - Nur die Nutzdaten des Pakets sind gesch√ºtzt, der urspr√ºngliche Header bleibt erhalten.  Zum Erstellen von Tunneln wird der Transportmodus normalerweise in Verbindung mit ipip oder gre verwendet, dessen Nutzdaten bereits das gesamte Quellpaket enthalten. </li><li>  Tunnelmodus - kapselt das Originalpaket vollst√§ndig in ein neues (√§hnlich wie gre oder ipip).  F√ºr Tunnel-IPSec wird jedoch keine explizite Schnittstelle im System erstellt. Dies kann ein Problem sein, wenn dynamisches oder komplexes statisches Routing verwendet wird. </li></ul><br><h3 id="security-policy-database-spd">  Sicherheitsrichtliniendatenbank (SPD) </h3><br><p>  Eine Datenbank mit Regeln, die festlegen, welcher Datenverkehr verschl√ºsselt werden soll, das Datenschutzprotokoll, den Kapselungstyp und eine Reihe anderer Parameter. <br>  Die Position der SPD-Pr√ºfung kann im Paketflussdiagramm angezeigt werden. </p><br><p><img src="https://habrastorage.org/webt/nh/jo/rm/nhjorm-je866yymx0_cxwdnyop8.png"></p><br><h3 id="preodolenie-nat">  NAT-√úberbr√ºckung </h3><br><p>  IPSec verwendet Protokolle auf Netzwerkebene, um Daten zu √ºbertragen, die NAT nicht verarbeiten kann.  Um das Problem zu l√∂sen, wird das NAT-T-Protokoll verwendet (eine Erweiterung in IKE und Teil von IKEv2).  Die Essenz von NAT-T liegt in der zus√§tzlichen Kapselung von IPSec-Paketen in UDP-Paketen, die NAT verarbeitet. </p><br><h3 id="ipsec-v-mikrotik">  IPSec bei Mikrotik </h3><br><p>  IPSec ist kostenlos auf jedem Ger√§t verf√ºgbar, auf dem RouterOS mit installiertem Sicherheitspaket ausgef√ºhrt wird. </p><br><h3 id="apparatnoe-shifrovanie">  Hardware-Verschl√ºsselung </h3><br><p>  Um die CPU zu entlasten, wird einigen Modellen von MikroTik-Routern eine Hardwarebeschleunigung der Verschl√ºsselung hinzugef√ºgt. Eine vollst√§ndige Liste finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">im Wiki</a> . <br>  Die meisten <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Budgetoptionen</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RB750Gr3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">RB3011</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">HAP AC ^ 2</a> . </p><br><p>  Ich habe alleine die IPSec-Geschwindigkeit zwischen zwei RB1100AHx2 und zwischen zwei RB750Gr3 √ºberpr√ºft. </p><br><p>  Um maximale Ergebnisse mit RB1100AHx2 zu erzielen, m√ºssen Sie: </p><br><ul><li>  Verwenden Sie Port 11, der direkt mit der CPU verbunden ist, und konfigurieren Sie einen CPU-Kern f√ºr den 11-Port-Verkehr </li><li>  Verwenden Sie nur Hardware-Warteschlangen f√ºr Schnittstellen. Deaktivieren Sie RPS </li><li>  Aktivieren Sie Layer3 FastPath (ca. 800 MB / Sek.) Oder schlie√üen Sie IPSec-Datenverkehr vom Conntrack aus (ca. 700 MB / Sek.) <br>  Ohne die beschriebenen Manipulationen am langsamsten Port (Ether13) ist es m√∂glich, ~ 170 MBit / s bei den √ºblichen ~ 400 MBit / s zu erreichen. </li></ul><br><p>  Auf RB750Gr3 ohne Optimierungen ca. 200Mb / Sek. </p><br><p>  Qualcomm Single-Core-Router zeigen je nach Modell, Optimierungen und Arbeitslast anderer Prozesse ein Ergebnis von 10-40 MB / s. </p><br><p>  Ich empfehle Ihnen, sich mit der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Pr√§sentation</a> eines Mikrotik-Mitarbeiters vertraut zu machen. Er hat Themen wie die Optimierung von Einstellungen zur Reduzierung der CPU-Auslastung und zur Erh√∂hung der Geschwindigkeit angesprochen, die ich dem Text nicht hinzugef√ºgt habe. </p><br><h3 id="razlichiya-642x-i-643x">  Unterschiede 6.42.X und 6.43.X. </h3><br><p>  Abh√§ngig von der von Ihnen verwendeten RouterOS-Version variiert das IPSec-Konfigurationsmen√º. </p><br><p><img src="https://habrastorage.org/webt/6q/pz/5c/6qpz5cgthate04bihl8gq2zr9t8.png"></p><br><p><img src="https://habrastorage.org/webt/ng/ug/hi/ngughirhx6nwd1v8mjaa9omfb7g.png"></p><br><p><img src="https://habrastorage.org/webt/kv/ow/3-/kvow3-bmivzfr_tf6bqnywr5wu8.png"></p><br><p>  Es gibt bereits neue √Ñnderungen in der Testversion. Lesen Sie daher vor dem Upgrade die Versionshinweise. </p><br><p><img src="https://habrastorage.org/webt/ri/rd/gu/rirdgucrebbf1ucxjqbj65gzf-s.png"></p><br><h3 id="konfiguraciya-ipsec">  IPSec-Konfiguration </h3><br><p><img src="https://habrastorage.org/webt/r6/lf/j5/r6lfj5hlclkbx9qmph0owsqf_ak.png"><br>  Das Men√º [IP] -&gt; [IPSec] ist nicht so be√§ngstigend, wie es auf den ersten Blick scheint.  Das Diagramm zeigt, dass die Hauptkonfigurationselemente sind: Peers und Profile. <br>  Die Registerkarten Remote Peers und Installed SAs dienen nur zur Information. </p><br><h4 id="peers-i-peers-profiles">  Peers und Peers-Profile </h4><br><p>  IPSec-Peer-Konfiguration zum Herstellen einer IKE-Verbindung und zum Erstellen eines zus√§tzlichen sicheren Tunnels. </p><br><p><img src="https://habrastorage.org/webt/e2/kj/e1/e2kje1zwzhubqsyriypavj3bmfm.png" alt="Bild"></p><br><p>  <strong>Konfigurieren Sie IPSec Remote Peers</strong> </p><br><p><img src="https://habrastorage.org/webt/pq/9d/cv/pq9dcvyqrf64pdklohgf1eapoze.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anmerkungen</b> <div class="spoiler_text"><ul><li>  Ab 6.43 schw√∂rt RouterOS, wenn das PSK ohne zus√§tzliche Authentifizierung verwendet wird.  Wenn Sie keine Schl√ºssel, Zertifikate oder xAuth zus√§tzlich konfigurieren m√∂chten, k√∂nnen Sie zu IKEv2 wechseln oder die Warnung ignorieren. </li><li>  Als Peers k√∂nnen Sie bestimmte IPs oder Subnetze angeben (relevant f√ºr Client-Server-VPN). </li><li>  Wenn es widerspr√ºchliche Regeln gibt, wird eine Regel mit einem genaueren Subnetz verwendet, um eine Verbindung zum Peer herzustellen (√§hnlich wie bei Routen). </li><li>  Die XAuth- und RSA-Schl√ºsselauthentifizierung funktioniert in IKEv2 nicht </li><li>  F√ºr IKEv2 hat Mikrotik die Implementierung von xAuth mit anderen Plattformen nicht kompatibel gemacht </li><li>  Der passive Modus wird normalerweise zum Erstellen eines Client-Server-VPN (L2TP / IPsec- oder IKEv2-Modus-Konfiguration) verwendet. Er kann jedoch hilfreich sein, wenn eine gro√üe Anzahl von Site-to-Site-Tunneln an einen einzelnen Punkt angeschlossen wird, um st√∂renden Datenverkehr zu reduzieren. </li><li>  Wenn Sie xAuth verwenden m√∂chten, sollte der "Server" passiv sein.  Benutzer f√ºr den Server werden in [IPSec] -&gt; [Benutzer] erstellt. </li><li>  W√§hlen Sie bei Verwendung der Richtlinie "Generieren" den port-strengen Modus aus </li></ul></div></div><br><p>  <strong>Erstellung von Profilen (Vorschl√§gen) f√ºr die Harmonisierungsphase 1</strong> </p><br><p><img src="https://habrastorage.org/webt/w8/s9/vj/w8s9vjxiguir63a_hfpci1ih1bi.png" alt="Bild"></p><br><p><img src="https://habrastorage.org/webt/_v/x3/ff/_vx3ff1ogwsxjggebdjqazfqhve.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anmerkungen</b> <div class="spoiler_text"><ul><li>  Zus√§tzliche Optionen f√ºr IKE werden Teil von IKEv2, Einstellungen werden ignoriert </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Korrelation von DH-Gruppen mit ihren Nummern</a> (Gruppennummern werden von anderen Anbietern verwendet) </li><li>  Beim Senden von Vorschl√§gen sortiert das System den Paaralgorithmus + die Gruppe dh von best√§ndiger zu weniger best√§ndig <br><img src="https://habrastorage.org/webt/7i/h8/fj/7ih8fjegurxodmq-daxuwxfhpii.png"></li></ul></div></div><br><h4 id="policies-i-policy-proposals">  Richtlinien und Richtlinienvorschl√§ge </h4><br><p>  Politiker √ºberpr√ºfen die √ºbergebenen Pakete auf √úbereinstimmung mit den Bedingungen und wenden die angegebenen Ma√ünahmen an.  Wenn Sie zum Paketfluss zur√ºckkehren, sind die Bl√∂cke mit der IPSec-Richtlinie die Abstimmung mit den Richtlinien.  Die Aktionen spezifizieren: IPSec-Sicherheitsprotokoll (ESP oder AH), Vorschl√§ge f√ºr die SA-Aushandlung, Kapselungsmodus. <br><img src="https://habrastorage.org/webt/tp/bk/1n/tpbk1nrkowlvaqdnrfvgpvbaxg0.png" alt="Bild"></p><br><p>  Das Paket √ºbergibt die Richtlinie nacheinander, bis sie den Bedingungen einer von ihnen entspricht. </p><br><p>  <strong>Richtlinieneinstellung</strong> <br><img src="https://habrastorage.org/webt/yw/cp/nj/ywcpnjdyjonrxpnfel79irfov4g.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anmerkungen</b> <div class="spoiler_text"><ul><li>  Normalerweise ist kein spezifischer Src erforderlich.  und Dst.  Port, aber im Allgemeinen ist die F√§higkeit, den Verkehr einer einzelnen Anwendung zu verschl√ºsseln, interessant </li><li>  Die Protokollliste enth√§lt nicht alle IP-Protokolle (z. B. gibt es kein Gre). Sie k√∂nnen die Nummer des erforderlichen Protokolls manuell angeben. </li><li>  Vorlagen sind keine Politiker!  Sie werden verwendet, wenn die Generierungsrichtlinie in der Peer-Konfiguration festgelegt ist. </li><li>  Was tun, wenn keine bestimmten Sicherheitszuordnungen f√ºr eine Richtlinie gefunden wurden?  Bisher gab es ein Problem mit L2TP / IPSec, bei dem mehrere Clients aufgrund desselben NAT keine Verbindung herstellen konnten (bei Verwendung von IKE). Dieser Fehler wurde behoben (vorausgesetzt, diese Clients sind keine Fenster), wenn Sie level = unique festlegen.  Andernfalls wechseln Sie zu IKEv2 </li><li>  Verwenden Sie beim Einrichten von Richtlinien den [abgesicherten Modus], eine umst√§ndliche Bewegung, und Sie riskieren, den Zugriff auf den Router mit Level3 zu verlieren </li></ul></div></div><br><p>  <strong>Richten Sie Vorschl√§ge f√ºr die SA-Genehmigung ein</strong> <br><img src="https://habrastorage.org/webt/mh/yf/cd/mhyfcd2-2nsxbouuxhgbecj3kyu.png"></p><br><p><img src="https://habrastorage.org/webt/0n/xk/tw/0nxktwxmxyu2quyanfw-rco-yqa.png"></p><br><h4 id="groups">  Gruppen </h4><br><p>  Wird zum Zuordnen von Richtlinienvorlagen und Peers verwendet. </p><br><p><img src="https://habrastorage.org/webt/do/r7/gc/dor7gc6s4zuwlo2mmz5irrc3alm.png" alt="Bild"></p><br><p>  In einer der √§lteren Versionen von RouterOS gab es einen Fehler mit der nicht funktionierenden Standardgruppe. </p><br><h4 id="mode-config">  Moduskonfiguration </h4><br><p>  Senden und Empfangen von IP-Parametern ohne Verwendung zus√§tzlicher Protokolle.  Erm√∂glicht das Erstellen eines eigenst√§ndigen Client-zu-Server-VPN nur f√ºr IPSec. </p><br><p><img src="https://habrastorage.org/webt/sr/s2/dl/srs2dl4tcpixxiwi2mrletlguva.png"></p><br><p><img src="https://habrastorage.org/webt/os/r2/gg/osr2ggrnm_0-vqtoukxb5hnzfjs.png"></p><br><h4 id="keys-i-users">  Schl√ºssel und Benutzer </h4><br><p>  Wird f√ºr die erweiterte Peer-Authentifizierung verwendet. <br>  <strong>Schl√ºssel</strong> <br>  RSA-Schl√ºssel: Generierung, Import, Export.  Wird in IKEv2 nicht unterst√ºtzt. </p><br><p><img src="https://habrastorage.org/webt/ec/7z/j4/ec7zj4doiqkdgwe4soh7lrk21f8.png"></p><br><p>  <strong>Benutzer</strong> <br>  XAuth-Benutzerdatenbank f√ºr den "Server".  Der Client gibt die xAuth-Einstellungen in der Peer-Konfiguration an.  Es ist m√∂glich, die xAuth-Authentifizierung an einen RADIUS-Server weiterzuleiten. </p><br><p><img src="https://habrastorage.org/webt/pi/wl/vq/piwlvq80v1cnndmhyjg91jzrqle.png"></p><br><h4 id="remote-peers">  Remote-Peers </h4><br><p>  Liste aller Peers, die einen Hilfstunnel installieren und installieren (Phase 1).  Sie k√∂nnen Peers entfernen, um die Schl√ºssel des Hilfstunnels zu aktualisieren. </p><br><p><img src="https://habrastorage.org/webt/j2/-g/ct/j2-gct_8wrf7bl2zgtzqsswwbgk.png" alt="Bild"></p><br><p><img src="https://habrastorage.org/webt/2k/37/3m/2k373mg8qxox4y-ruph-jza_d0m.png" alt="Bild"></p><br><h4 id="installed-sas">  Installierte SAs </h4><br><p>  SAD-Datenbank oder eine Liste aller ausgehandelten SAs.  Sie k√∂nnen die verwendeten Datenschutzalgorithmen und -schl√ºssel sehen. </p><br><p><img src="https://habrastorage.org/webt/jw/jb/su/jwjbsuorsms85vw656xfgvcneuc.png" alt="Bild"></p><br><p><img src="https://habrastorage.org/webt/wd/8x/gr/wd8xgrc-h0ngxcfq77qun4ymuhk.png" alt="Bild"></p><br><p>  Das Hardware-AEAD-Flag zeigt die Verwendung der Hardwareverschl√ºsselung an. </p><br><p><img src="https://habrastorage.org/webt/jz/5-/yv/jz5-yv-xaw_a8gx5zrxz1hlesye.png" alt="Bild"></p><br><p>  Ein Administrator kann SA zur√ºcksetzen, jedoch nur alle vom selben Typ (esp oder ah) gleichzeitig. </p><br><h4 id="ipsec-i-firewall">  IPSec und Firewall </h4><br><p>  In der Firewall k√∂nnen Sie √ºberpr√ºfen, ob der Datenverkehr eine eingehende oder ausgehende IPSec-Richtlinie ist oder nicht.  Eine offensichtliche Anwendung ist L2TP / IPSec. Sie k√∂nnen die Installation von L2TP-Verbindungen verbieten, wenn der Datenverkehr zuvor nicht verschl√ºsselt wurde. </p><br><p><img src="https://habrastorage.org/webt/xt/06/sw/xt06swif3vlsv_vjcyywb1lepf0.png"></p><br><p>  <strong>In IPSec verwendete Protokolle und Ports</strong> </p><br><ul><li>  IKE - UDP: 500 </li><li>  IKEv2 - UDP: 4500 </li><li>  NAT-T - UDP: 4500 </li><li>  ESP - ipsec-esp (50) </li><li>  AH - ipsec-ah (51) </li></ul><br><h3 id="ipsec-i-endpoinds">  IPSec und Endpoinds </h3><br><p>  Und jetzt √ºber die wunden ... <br>  Die Wiki-Mikrotik enth√§lt Tabellen mit Hashing- und Verschl√ºsselungsalgorithmen f√ºr: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Windows</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">iOS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">OS-X</a> . </p><br><p>  Ich habe keine Informationen √ºber den eingebauten Android VPN-Client gefunden, aber im Allgemeinen funktioniert es mit Vorschl√§gen von Windows.  Es gibt keine IKEv2-Unterst√ºtzung in Android, Sie m√ºssen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">StrongSwan verwenden</a> . </p><br><h3 id="primery-konfiguracii">  Konfigurationsbeispiele </h3><br><p>  Schema und Grundkonfiguration f√ºr Beispiele mit Site-to-Site-Tunneln: </p><br><p><img src="https://habrastorage.org/webt/bn/a7/xu/bna7xud0pazv4ipia2k0083wqom.png"></p><br><pre><code class="plaintext hljs">#Mikrotik1 /ip address add address=10.10.10.10/24 interface=ether1 network=10.10.10.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.10.10.1 dst-address=0.0.0.0/0 #Mikrotik2 /ip address add address=10.20.20.20/24 interface=ether1 network=10.20.20.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.20.20.1 dst-address=0.0.0.0/0</code> </pre> <br><h4 id="ipsec-v-tunnelnom-rezhime">  IPSec im Tunnelmodus </h4><br><p><img src="https://habrastorage.org/webt/wy/cg/ad/wycgadjksxuyftckhoctoxciub4.png"></p><br><p>  Schrittweise Konfiguration: </p><br><ol><li>  Erstellen Sie Vorschl√§ge f√ºr IKE Phase1 </li><li>  Erstellen Sie ein Fest.  Wir geben die Adresse, Vorschl√§ge, den Austauschmodus und den PSK-Schl√ºssel an.  Ich habe IKEv2 gew√§hlt, Sie k√∂nnen main / agressive wie gew√ºnscht verwenden </li><li>  Erstellen Sie Vorschl√§ge f√ºr SA </li><li>  Geben Sie die Subnetze an, zwischen denen wir den Tunnel erstellen </li><li>  Geben Sie SA-Adressen, Tunnelmodus und Vorschl√§ge f√ºr die Verkehrsverschl√ºsselung an </li><li>  Bearbeiten der NAT-Regel </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/c2/tg/at/c2tgatfqb3bgw5qer0u6lvi_jt0.png"></a> </p><br><p>  Konsolenoption: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=192.168.200.0/24 proposal=ipsec-tunnel-sa sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10 src-address=192.168.100.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/je/5y/gq/je5ygqbnhfjklyqxu8pg1kf2saq.png"></a> </p><br><p>  Konsolenoption: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=192.168.100.0/24 proposal=tets-ipsec-sa sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20 src-address=192.168.200.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Und hier NAT?</b> <div class="spoiler_text"><p>  Um im Tunnelmodus arbeiten zu k√∂nnen, ben√∂tigen Sie eine gef√§lschte Route zum Remote-Subnetz oder eine Standardroute. Andernfalls gehen die Pakete nicht weiter als bis zur Routing-Entscheidung.  Normalerweise gibt es keine Probleme mit der ersten Option, aber mit der Standardroute und dem Quell-NAT (die erste und die zweite sind auf der √ºberwiegenden Mehrheit der Heim- und B√ºrorouter vorhanden) treten Probleme auf. </p><br><p>  Paketfluss abrufen.  Pakete durchlaufen Source NAT fr√ºher als IPSec-Richtlinien. Die Regel mit Maskerade wei√ü nichts dar√ºber, dass Datenverkehr an den "kurzlebigen" Tunnel gesendet werden soll, und sendet Paket-Header, die an IPSec gesendet werden sollen, wenn das Paket mit dem ge√§nderten Header in der Quelladresse der Richtlinien eingecheckt wird Der Header entspricht nicht der Regel und das Paket fliegt zur Standardroute, die, nachdem die Zieladresse aus dem privaten Netzwerk gesehen wurde, h√∂chstwahrscheinlich verworfen wird. </p><br><p>  Es gibt verschiedene L√∂sungen f√ºr das Problem: </p><br><ul><li>  Mit gef√§lschter Route </li><li>  Verwenden einer optionalen Akzeptanzregel vor SourceNAT </li><li>  Betreff src-nat nur den Paketen, f√ºr die es keine IPSec-Richtlinien gibt (im Beispiel) </li><li>  Schlie√üen Sie den Datenverkehr mithilfe von RAW von der Verbindungsverfolgung aus </li></ul></div></div><br><p>  <strong>√úberpr√ºfen Sie die hergestellte Verbindung</strong> <br><img src="https://habrastorage.org/webt/no/xd/cn/noxdcnqrsbftj6mfsxlmpruizmq.png" alt="Bild"></p><br><ol><li>  Wir sehen einen Nachbarn in Remote Peers </li><li>  Wir sehen die installierte SA (Verkehrsz√§hler √§ndern sich erst, wenn Sie sie starten). </li><li>  In der Politik etablierter Status und Flagge (A) aktiv </li></ol><br><h4 id="ipipipsec">  IPIP / IPSec </h4><br><p><img src="https://habrastorage.org/webt/2b/hy/1d/2bhy1d1tnwd57iyppymvb8dbkww.png"></p><br><p>  Voreingestellter IPIP-Tunnel: </p><br><pre> <code class="plaintext hljs">#Mikrotik1 #  ipip /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.20.20.20 # ip   ipip  /ip address add address=10.30.30.1/30 interface=ipip-vpn #     /ip route add distance=1 dst-address=192.168.200.0/24 gateway=10.30.30.2 #Mikrotik2 # ,      /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.10.10.10 /ip address add address=10.30.30.2/30 interface=ipip-vpn /ip route add distance=1 dst-address=192.168.100.0/24 gateway=10.30.30.1</code> </pre> <br><p>  Schrittweise IPSec-Konfiguration: </p><br><ol><li>  Erstellen Sie Vorschl√§ge f√ºr IKE Phase1 </li><li>  Erstellen Sie ein Fest.  Geben Sie die Adresse, Vorschl√§ge, den Austauschmodus und den PSK-Schl√ºssel an </li><li>  Erstellen Sie Vorschl√§ge f√ºr SA </li><li>  Geben Sie die Subnetze an, zwischen denen wir den Tunnel erstellen </li><li>  Wir geben die Adressen von SA, die Art des zu verschl√ºsselnden Datenverkehrs und Vorschl√§ge an </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/5e/mf/_w/5emf_wcxb3ulnjv3fykuino9stg.png"></a> </p><br><p>  Konsolenoption: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=10.20.20.20/32 proposal=ipsec-tunnel-sa protocol=ipencap src-address=10.10.10.10/32 sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/9o/dk/oy/9odkoy8krqem4mck9rkfibhm220.png"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=10.10.10.10/32 proposal=tets-ipsec-sa protocol=ipencap src-address=10.20.20.20/32 sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20</code> </pre> </div></div><br><p>  F√ºr unaufmerksam ist der wirkliche Unterschied in der Konfiguration des Tunnels und des Transportmodus in IPSec-Richtlinien: <br><img src="https://habrastorage.org/webt/5v/ka/fg/5vkafg3ca8vilvv0s-lv1tdbxhw.png" alt="Bild"></p><br><p>  Die Verbindungspr√ºfung √§hnelt dem Tunnelmodus. </p><br><h4 id="l2tpipsec">  L2TP / IPSec </h4><br><p>  Die vorherigen Beispiele eignen sich gut zum Erstellen permanenter VPNs zwischen zwei Peers mit statischen externen IP-Adressen. </p><br><p>  Wenn die Adresse eines der Peers dynamisch ist (und sich normalerweise hinter NAT befindet), m√ºssen Sie ein anderes Client-zu-Server-VPN verwenden. <br><img src="https://habrastorage.org/webt/ms/l5/3a/msl53ahdcdv8fl2vd-62m1exdmk.png" alt="Bild"></p><br><p>  L2TP-Vorkonfiguration: </p><br><pre> <code class="plaintext hljs">#     /ip pool add name=pool-l2tp ranges=192.168.77.10-192.168.77.20 #    /ppp profile add change-tcp-mss=yes local-address=192.168.77.1 name=l2tp-ipsec only-one=yes remote-address=pool-l2tp use-compression=no use-encryption=no use-mpls=no use-upnp=no #   /ppp secret add name=user1 password=test1 profile=l2tp-ipsec service=l2tp add name=user2 password=test2 profile=l2tp-ipsec service=l2tp add name=user3 password=test3 profile=l2tp-ipsec service=l2tp #  L2TP (  ipsec) /interface l2tp-server server set authentication=chap,mschap2 default-profile=l2tp-ipsec enabled=yes</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Warum ignoriere ich die automatische IPSec-Optimierung?</b> <div class="spoiler_text"><p>  In der Konfiguration von ipip, gre, eoip, l2tp gibt es eine automatische Konfiguration der ipsec-Verbindung. Tats√§chlich erstellt das System dynamische Regeln f√ºr Peers und Richtlinien f√ºr Sie, aber erstens suchen wir nicht nach einfachen M√∂glichkeiten, und zweitens werden beim Upgrade von 6.42 auf 6.43 automatisch Tunnel erstellt pleite und nicht die Tatsache, dass dies nicht wieder passieren wird. </p></div></div><br><p>  Schrittweise IPSec-Konfiguration: </p><br><ol><li>  Erstellen Sie eine neue Gruppe (Sie k√∂nnen die Standardeinstellung verwenden). </li><li>  Erstellen Sie Vorschl√§ge f√ºr IKE Phase1 </li><li>  Wir schaffen ein Fest oder vielmehr ein Subnetz.  Schw√∂rt auf den PSK-Schl√ºssel, aber wenn wir als Client mit Windows zu tun haben, haben wir die Wahl: Zertifikate oder PSK. </li><li>  Setzen Sie passiv = Ja und send-init-contact = nein in generate-policy = port-strict (Port vom Client akzeptieren). </li><li>  Erstellen Sie Vorschl√§ge f√ºr SA </li><li>  Erstellen Sie eine Vorlage zum Generieren von Richtlinien </li><li>  Geben Sie den Vorschlag f√ºr SA an </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik-Konfiguration</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/ua/a8/ph/uaa8phm-3iy-qvrxuc6m4kbirr8.png" alt="Bild"></a> <br>  <em>Im Screenshot besteht der Fehler darin, dst anzugeben.</em>  <em>port und src.</em>  <em>Port wird nicht ben√∂tigt</em> </p><br><p>  Konsolenoption: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec policy group add name=l2tp-ipsec #2 /ip ipsec peer profile add dh-group=modp1024 enc-algorithm=aes-256 hash-algorithm=sha256 name=l2tp-ipsec-ike #3-4 /ip ipsec peer add address=0.0.0.0/0 generate-policy=port-strict passive=yes policy-template-group=l2tp-ipsec profile=l2tp-ipsec-ike secret=secret-ipsec-pass send-initial-contact=no #5 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=l2tp-ipsec-sa pfs-group=none #6-7 /ip ipsec policy add dst-address=0.0.0.0/0 group=l2tp-ipsec proposal=l2tp-ipsec-sa protocol=udp src-address=0.0.0.0/0 template=yes</code> </pre> </div></div><br><p>  <strong>Firewall-Konfiguration zum Erstellen von L2TP-Verbindungen erst nach IPSec</strong> </p><br><pre> <code class="plaintext hljs">/ip firewall filter # IKE, NAT-T  ipsec-esp add chain=input protocol=17 dst-port=500,4500 action=accept add chain=input protocol=50 action=accept # L2TP,     ipsec    add chain=input protocol=17 dst-port=1701 ipsec-policy=in,ipsec action=accept add chain=input protocol=17 dst-port=1701 action-drop</code> </pre> <br><h4 id="ikev2-vpn">  IKEv2 VPN </h4><br><p>  Die L2TP-Option ist beliebt, aber dank der Moduskonfiguration k√∂nnen Sie den VPN-Server nur mit IPSec konfigurieren.  Dies ist eine vielversprechende Art von VPN, die bisher jedoch nur selten verwendet wird. Zus√§tzlich zur Konfiguration der Serverseite werde ich ein Beispiel f√ºr die Einrichtung des strongSwan-Clients auf Android geben. </p><br><p><img src="https://habrastorage.org/webt/el/un/fu/elunfukm2k6qajijslvcfd-zvuy.png" alt="Bild"></p><br><p>  Nat√ºrlich ist nicht alles so rosig.  Die meisten "Benutzer" -Betriebssysteme (insbesondere Windows und Android) stimmen der Arbeit mit einem solchen VPN nur zu, wenn sie durch Zertifikate oder EAP authentifiziert sind. </p><br><p>  <em>Zertifikate sind meine Schwachstelle. Wenn jemand wei√ü, wie man ein selbstsigniertes Zertifikat, das Windows importiert und in der Verbindung verwendet, korrekt generiert, schreiben Sie in die Kommentare.</em> </p><br><p>  Vorl√§ufige Erstellung von Zertifikaten: </p><br><pre> <code class="plaintext hljs">#Root CA   /certificate add name=ca common-name="IKEv2 CA" days-valid=6928 /certificate sign ca ca-crl-host=&lt;IP &gt; #   vpn /certificate add common-name=&lt;IP &gt; subject-alt-name=IP:&lt;IP &gt; key-usage=tls-server name=vpn days-valid=6928 #   /certificate sign vpn ca=ca #   #       ,       #     Revoke   /certificate add common-name=client key-usage=tls-client name=client days-valid=6928 #   /certificate sign client ca=ca</code> </pre> <br><p>  Schrittweise Konfiguration von IKEv2 VPN: </p><br><ol><li>  Wir erstellen einen Adresspool f√ºr die Verteilung an Kunden </li><li>  Erstellen Sie ein Moduskonfigurationsprofil zum Verteilen von IP-Parametern an Clients </li><li>  Erstellen Sie Gruppen, um Peers und Richtlinienvorlagen zu verkn√ºpfen </li><li>  Erstellen Sie Vorschl√§ge f√ºr IKE Phase1 </li><li>  Erstellen Sie ein Profil zum Verbinden von Peers.  Zertifikatauthentifizierung, IKEv2-Protokoll, passiver Modus </li><li>  Geben Sie das Moduskonfigurationsprofil in drei Gruppen an und aktivieren Sie die Richtliniengenerierung </li><li>  Erstellen Sie Vorschl√§ge f√ºr SA </li><li>  Erstellen Sie eine Vorlage zum Generieren von Richtlinien </li><li>  Geben Sie Vorschl√§ge f√ºr SA an </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik konfigurieren</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/1r/8w/vj/1r8wvjsgjjwhijje2dhwb90qv78.png" alt="Bild"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip pool add name=pool-ike ranges=192.168.77.10-192.168.77.20 #2 /ip ipsec mode-config add address-pool=pool-ike address-prefix-length=32 name=ikev2-vpn static-dns=77.88.8.8 system-dns=no #3 /ip ipsec policy group add name=ikev2-vpn #4 /ip ipsec peer profile add enc-algorithm=aes-256,aes-128 hash-algorithm=sha256 name=ikev2-vpn #5-6 /ip ipsec peer add address=0.0.0.0/0 auth-method=rsa-signature certificate=vpn exchange-mode=ike2 generate-policy=port-strict mode-config=ikev2-vpn passive=yes policy-template-group=ikev2-vpn profile=ikev2-vpn send-initial-contact=no #7 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=ikev2-vpn #8-9 /ip ipsec policy add dst-address=0.0.0.0/0 group=ikev2-vpn proposal=ikev2-vpn src-address= 0.0.0.0/0 template=yes</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">StrongSwan Konfiguration auf Android.</b> <div class="spoiler_text"><p>  <em>Zuerst m√ºssen Sie Client- und CA-Zertifikate auf das Telefon √ºbertragen.</em> <br>  <a href="">https://habrastorage.org/webt/tp/pk/ad/tppkadaifd1k7xi6hf3jxgg7vcs.png</a> </p><br><p>  <em>F√ºr gro√üe Augen: Ein Kreuz in der N√§he von Wi-Fi steht da</em>  <em>Die meisten Systemanwendungen werden von AFWall + blockiert.</em> </p></div></div><br><p>  Wenn die Verbindung erfolgreich ist, sehen Sie: dynamische Richtlinie, Schreiben an Remote-Peers und ein Paar SA. </p><br><p><img src="https://habrastorage.org/webt/89/ov/4w/89ov4wsqvw7r-dvsoz2crontmlk.png" alt="Bild"></p><br><p><img src="https://habrastorage.org/webt/cc/b2/ic/ccb2icr_nqz32btmghwptrz7svc.png" alt="Bild"></p><br><p><img src="https://habrastorage.org/webt/sl/cn/gz/slcngz0e3objej8x3fw4-m3wypc.png" alt="Bild"></p><br><p>  <em>RouterOS x86-Demolizenzen unterliegen keinen Einschr√§nkungen hinsichtlich der Anzahl der IPSec-Tunnel, einschlie√ülich IKEv2 VPN.</em>  <em>Sie k√∂nnen die RouterOS x86-Demo (nicht mit RouterOS CHR kostenlos verwechseln, alles ist traurig) auf VPS bereitstellen und mit minimalem Verwaltungsaufwand einen pers√∂nlichen VPN-Server erwerben, ohne eine Lizenz f√ºr RouterOS oder RouterOS CHR zu erwerben.</em> </p><br><h3 id="para-slov-pro-analiz-logov-ipsec">  Ein paar Worte zur IPSec-Protokollanalyse </h3><br><p>  Protokolle in Mikrotik sind eine separate Geschichte, manchmal sind sie detailliert genug, um Probleme zu analysieren, aber das Fehlen banaler Funktionen: Bereinigen, Kopieren, Finden zwingt Sie, einen separaten Syslog-Server zu installieren. </p><br><p>  F√ºr IPSec gibt es hier eine schnelle Option zur Protokollanalyse (wir lassen nur das Notwendige auf einer separaten Registerkarte): </p><br><p><img src="https://habrastorage.org/webt/05/rz/_g/05rz_grffjd7zz1r-a8zhsi87cy.png" alt="Bild"></p><br><pre> <code class="plaintext hljs">/system logging action add memory-lines=100000 name=ipsec target=memory /system logging add action=ipsec topics=ipsec,error add action=ipsec topics=ipsec,debug,!packet add action=ipsec topics=ipsec,info</code> </pre> <br><p>  Und einige Beispiele f√ºr typische IPSec-Konfigurationsprobleme: </p><br><div class="spoiler">  <b class="spoiler_title">Konsistenzproblem der Vorschl√§ge in Phase 1</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bp/jm/y1/bpjmy12i4eieobnfhrnj3hlvpcq.png" alt="Bild"></p><br><ol><li>  Lesen Sie die Fehlermeldung.  Das Problem ist, wenn Vorschl√§ge in der ersten Phase abgeglichen werden. </li><li>  Wir schauen oben, der Router selbst schl√§gt vor, dass er ein Fest gesendet hat, und was lokal konfiguriert ist </li></ol></div></div><br><div class="spoiler">  <b class="spoiler_title">Problem bei der Abstimmung IKE_SA_INIT</b> <div class="spoiler_text"><p>  In den Protokollen sehen Sie ungef√§hr Folgendes: </p><br><p><img src="https://habrastorage.org/webt/8i/d9/gh/8id9ghqgdgxsjjsfhn3zcn5_vtq.png"></p><br><p>  Verkehr analysieren </p><br><p>  In der Anfrage sehen Sie Vorschl√§ge vom Bankett: </p><br><p><img src="https://habrastorage.org/webt/pw/u2/ib/pwu2ibw3dyxswemrr74wcbphcoy.png"></p><br><p>  In der Antwort sehen wir, dass keine geeigneten Vorschl√§ge gefunden wurden: </p><br><p><img src="https://habrastorage.org/webt/q2/lb/qk/q2lbqkcr8qvtd1hgia4fj0hrb44.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Vorschlag zur Abstimmung der Vorschl√§ge f√ºr SA</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/2y/yg/7m/2yyg7ma7ko4lce5vsyef4nmojdi.png"><br>  Der Router fordert in Phase 2 zu Vorschlagsfehlern auf und zeigt an, was lokal konfiguriert und was remote ist. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Vorschl√§ge IKE_AUTH Abstimmungsproblem</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bn/pk/vn/bnpkvnfazxyqmpbvdg78e26mfgy.png"><br>  Wir sehen, dass es eine Verbindung und Authentifizierung von Peers gab, aber weiter einen Vorschlagsfehler.  Beim Debuggen werden auch im Wireshark keine Details angezeigt (der IKE_AUTH-Datenverkehr ist verschl√ºsselt). </p></div></div><br><div class="spoiler">  <b class="spoiler_title">PSK-Authentifizierungsfehler</b> <div class="spoiler_text"><p>  F√ºr IKE: </p><br><p><img src="https://habrastorage.org/webt/cp/wm/b5/cpwmb55qp8qyjmba_xijboxmiwa.png"></p><br><p>  F√ºr IKEv2: <br><img src="https://habrastorage.org/webt/ks/fn/k0/ksfnk0qdgmgizzusfsyrlwxvcfs.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Falscher IKE-Modus</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/md/fb/ll/mdfbllmvedawn5ptdd-yvjcsrpw.png" alt="Bild"><br>  Wir sehen, dass Phase1 im Timeout unterbrochen wird, obwohl Pakete zwischen Peers gesendet werden.  Die Gr√∂√üe des eingehenden Pakets ist jedoch viel gr√∂√üer. Wenn wir √ºber Wireshark analysieren, werden wir feststellen, dass der Remote-Peer den aggressiven Modus verwendet. </p><br><p><img src="https://habrastorage.org/webt/3g/ke/ii/3gkeiidaj8m-fs0ky7ucxqjxx6k.png"><br>  Wir sehen, dass Pakete von uns an UDP: 500 gesendet werden, und sie kommen an UDP: 4500 und sind ziemlich gro√ü.  Hier hat der Remote-Peer den IKEv2-Modus. </p></div></div><br><p>  Lesen Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">abschlie√üend den</a> Abschnitt zur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Fehlerbehebung im Wiki</a> .  Und alles Material √ºber IPSec ist f√ºr die Bekanntschaft w√ºnschenswert. Ich habe nur die grundlegenden Tools und Einstellungen beschrieben. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de438176/">https://habr.com/ru/post/de438176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de438166/index.html">Interaktion zwischen einer Site in einem Browser und einem lokal ausgef√ºhrten Programm</a></li>
<li><a href="../de438168/index.html">Wie man eine teure Kamera knackt, damit deine Frau dich nicht umbringt</a></li>
<li><a href="../de438170/index.html">Preis benannt nach Ilya Segalovich. Geschichte √ºber Informatik und Ver√∂ffentlichungen</a></li>
<li><a href="../de438172/index.html">Apple kann die Produktion seiner Ger√§te nicht in die USA verlagern</a></li>
<li><a href="../de438174/index.html">Gelb - Vakuum - Wolke</a></li>
<li><a href="../de438178/index.html">Erstellen Ihrer ersten ARCore-Anwendung</a></li>
<li><a href="../de438180/index.html">Registrieren Sie eine Immobilientransaktion online</a></li>
<li><a href="../de438182/index.html">Die Studie fand die Vorteile einer moderaten Piraterie f√ºr Produzenten und Vertreiber von Inhalten</a></li>
<li><a href="../de438184/index.html">Bericht der Bank of America: 700 Billionen Dollar aus dem All</a></li>
<li><a href="../de438186/index.html">Checkliste: Was musste getan werden, bevor Microservices f√ºr die Produktion bereitgestellt wurden?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>