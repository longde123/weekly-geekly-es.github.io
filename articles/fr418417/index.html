<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíî ü¶Ö üé≥ Apollo: 9 mois - vol normal üë®üèª‚Äç‚öñÔ∏è üôÖüèæ üèÅ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous, je m'appelle Semyon Levenson, je travaille en tant que chef d'√©quipe sur le projet Stream du Rambler Group et je veux parler de notre ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Apollo: 9 mois - vol normal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/rambler-co/blog/418417/"><p><img src="https://habrastorage.org/webt/ww/0p/je/ww0pjeoegdfxhlx-zfh54jbxvyw.png" alt="image"></p><br><p>  Bonjour √† tous, je m'appelle Semyon Levenson, je travaille en tant que chef d'√©quipe sur le projet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Stream</a> du Rambler Group et je veux parler de notre exp√©rience avec Apollo. </p><br><p>  Je vais vous expliquer ce qu'est le "Stream".  Il s'agit d'un service automatis√© pour les entrepreneurs, qui vous permet d'attirer des clients d'Internet vers l'entreprise sans vous impliquer dans la publicit√©, et de cr√©er rapidement des sites simples sans √™tre un expert en mise en page. </p><a name="habracut"></a><br><p>  La capture d'√©cran montre l'une des √©tapes de la cr√©ation d'une page de destination. </p><br><p><img src="https://habrastorage.org/webt/rf/vg/dj/rfvgdjmcvzpwydgz9qcdu8_3eay.png"></p><br><h3 id="chto-bylo-vnachale">  Quel a √©t√© le d√©but? </h3><br><p> Et au d√©but, il y avait MVP, beaucoup de Twig, jQuery et des d√©lais tr√®s serr√©s.  Mais nous sommes all√©s d'une mani√®re non standard et avons d√©cid√© de faire une refonte.  La refonte n'est pas dans le sens de "styles corrig√©s", mais a d√©cid√© de revoir compl√®tement le syst√®me.  Et ce fut une bonne √©tape pour nous afin d'assembler le frontend parfait.  Apr√®s tout, nous, l'√©quipe de d√©veloppement, continuons √† soutenir cela et √† mettre en ≈ìuvre d'autres t√¢ches sur la base de cela, √† atteindre les nouveaux objectifs fix√©s par l'√©quipe produit. </p><br><p>  Notre d√©partement a d√©j√† accumul√© suffisamment d'expertise dans l'utilisation de React.  Je ne voulais pas passer 2 semaines √† configurer le webpack, j'ai donc d√©cid√© d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">CRA</a> (Create React App).  Pour les styles, les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">composants stylis√©s ont</a> √©t√© pris, et o√π sans taper - ils ont pris <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Flow</a> .  Ils ont pris <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Redux</a> pour la gestion de l'√âtat, mais il s'est av√©r√© que nous n'en avons pas besoin du tout, mais plus √† ce sujet plus tard. </p><br><p>  Nous avons mis en place notre interface parfaite et r√©alis√© que nous avions oubli√© quelque chose.  Il s'est av√©r√© que nous avons oubli√© le backend, ou plut√¥t l'interaction avec lui.  Lorsque vous avez r√©fl√©chi √† ce que nous pouvons utiliser pour organiser cette interaction, la premi√®re chose qui m'est venue √† l'esprit - bien s√ªr, c'est le repos.  Non, nous ne sommes pas all√©s nous reposer (sourire), mais nous avons commenc√© √† parler de l'API RESTful.  En principe, l'histoire est famili√®re, s'√©tire depuis longtemps, mais nous connaissons aussi les probl√®mes avec elle.  Nous en parlerons. </p><br><p>  Le premier probl√®me est la documentation.  RESTful, bien s√ªr, ne dit pas comment organiser la documentation.  Ici, il y a une option pour utiliser le m√™me swagger, mais en fait c'est l'introduction d'une entit√© suppl√©mentaire et la complication des processus. </p><br><p>  Le deuxi√®me probl√®me est de savoir comment organiser la prise en charge de la gestion des versions de l'API. </p><br><p>  Le troisi√®me probl√®me important est un grand nombre de requ√™tes ou de points de terminaison personnalis√©s que nous pouvons r√©compenser.  Supposons que nous devions demander des articles, pour ces articles - des commentaires et plus d'auteurs de ces commentaires.  Dans le Rest classique, nous devons faire au moins 3 requ√™tes.  Oui, nous pouvons r√©compenser les points de terminaison personnalis√©s, et tout cela peut √™tre r√©duit √† 1 demande, mais c'est d√©j√† une complication. </p><br><p><img src="https://habrastorage.org/webt/mo/os/uv/moosuvdayfwhr7r2dqswlg9nuuk.png"><br>  <em>Merci <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Sashko Stubailo</a> pour l'illustration <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">.</a></em> </p><br><h3 id="reshenie">  Solution </h3><br><p>  Et en ce moment, Facebook vient √† notre aide avec GraphQL.  Qu'est-ce que GraphQL?  Il s'agit d'une plate-forme, mais aujourd'hui, nous allons examiner l'une de ses parties - c'est le langage de requ√™te pour votre API, juste un langage et assez primitif.  Et cela fonctionne aussi simplement que possible - comme nous demandons une sorte d'entit√©, nous l'obtenons √©galement. </p><br><p>  Demande: </p><br><pre><code class="hljs objectivec">{ me { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> isAcceptedFreeOffer balance } }</code> </pre> <br><p>  La r√©ponse est: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"me"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isAcceptedFreeOffer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"balance"</span></span>: <span class="hljs-number"><span class="hljs-number">100000</span></span> } }</code> </pre> <br><p>  Mais GraphQL ne concerne pas seulement la lecture, il s'agit √©galement de modifier les donn√©es.  Pour ce faire, il existe des mutations dans GraphQL.  Les mutations sont remarquables en ce que nous pouvons d√©clarer la r√©ponse souhait√©e du backend, avec un changement r√©ussi.  Cependant, il y a quelques nuances.  Par exemple, si notre mutation affecte des donn√©es en dehors des limites du graphique. </p><br><p>  Un exemple de mutation dans laquelle nous utilisons une offre gratuite: </p><br><pre> <code class="hljs nginx"><span class="hljs-section"><span class="hljs-section">mutation</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">acceptOffer</span></span> (_type: FREE) { <span class="hljs-attribute"><span class="hljs-attribute">id</span></span> isAcceptedFreeOffer } }</code> </pre> <br><p>  En r√©ponse, nous obtenons la m√™me structure que celle demand√©e </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"acceptOffer"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"isAcceptedFreeOffer"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span> } }</code> </pre> <br><p>  L'interaction avec le backend GraphQL peut √™tre effectu√©e en utilisant la r√©cup√©ration r√©guli√®re. </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span>(<span class="hljs-string"><span class="hljs-string">'/graphql'</span></span>, { <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>: <span class="hljs-string"><span class="hljs-string">'POST'</span></span>, headers: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json'</span></span> }, body: <span class="hljs-type"><span class="hljs-type">JSON</span></span>.stringify({ query: <span class="hljs-string"><span class="hljs-string">'{me { id balance } }'</span></span> }) });</code> </pre> <br><h3 id="kakie-zhe-plyusy-u-graphql">  Quels sont les avantages de GraphQL? </h3><br><p>  Le premier avantage tr√®s cool qui peut √™tre appr√©ci√© lorsque vous commencez √† travailler avec lui est que cette langue est fortement typ√©e et auto-document√©e.  En concevant le sch√©ma GraphQL sur le serveur, nous pouvons imm√©diatement d√©crire les types et les attributs directement dans le code. </p><br><p><img src="https://habrastorage.org/webt/7l/oh/ze/7lohze1ioujv7qchctics80_qd8.png"></p><br><p>  Comme mentionn√© ci-dessus, RESTful a un probl√®me de version.  GraphQL a impl√©ment√© une solution tr√®s √©l√©gante pour cela - obsol√®te. </p><br><p><img src="https://habrastorage.org/webt/zr/la/rr/zrlarrevkaenkyjdx7yzm6wbm5a.png"></p><br><p>  Supposons que nous ayons un film, nous le d√©veloppons, nous avons donc un r√©alisateur.  Et √† un moment donn√©, nous faisons simplement du r√©alisateur un type distinct.  La question est, que faire du dernier champ de r√©alisateur?  Il y a deux r√©ponses: soit nous supprimons ce champ, soit nous le marquons obsol√®te, et il dispara√Æt automatiquement de la documentation. </p><br><p>  Nous d√©cidons ind√©pendamment de ce dont nous avons besoin. </p><br><p>  Nous rappelons l'image pr√©c√©dente, o√π tout s'est pass√© avec REST, mais ici tout est combin√© en une seule demande et ne n√©cessite aucune personnalisation du d√©veloppement backend.  Une fois qu'ils l'ont tous d√©crit, et nous nous tordons, nous tordons, jonglons. </p><br><p><img src="https://habrastorage.org/webt/k2/rs/rp/k2rsrp234e3xoe6gs8jmwpy1rse.png"></p><br><p>  Mais pas sans une mouche dans la pommade.  En principe, il n'y a pas autant d'inconv√©nients √† GraphQL sur le frontend, car il a √©t√© d√©velopp√© √† l'origine pour r√©soudre les probl√®mes du frontend.  Mais le backend ne va pas si bien ... Ils ont un probl√®me comme N + 1.  Prenons l'exemple de la requ√™te: </p><br><pre> <code class="hljs objectivec">{ landings(_page: <span class="hljs-number"><span class="hljs-number">0</span></span>, limit: <span class="hljs-number"><span class="hljs-number">20</span></span>) { nodes { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> title } totalCount } }</code> </pre> <br><p>  Une simple demande, nous demandons 20 sites et le nombre de sites que nous avons.  Et dans le backend, cela peut se transformer en 21 requ√™tes de base de donn√©es.  Ce probl√®me est connu, r√©solu.  Pour Node JS, il existe un package de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">chargeur</a> de donn√©es de Facebook.  Pour les autres langues, vous pouvez trouver vos propres solutions. </p><br><p>  Il y a aussi le probl√®me de la nidification profonde.  Par exemple, nous avons des albums, ces albums ont des chansons, et gr√¢ce √† la chanson, nous pouvons √©galement obtenir des albums.  Pour ce faire, effectuez les requ√™tes suivantes: </p><br><pre> <code class="hljs objectivec">{ album(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>) { songs { title artists } } }</code> </pre> <br><pre> <code class="hljs dos">{ song(id: <span class="hljs-number"><span class="hljs-number">1337</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">title</span></span> album { <span class="hljs-built_in"><span class="hljs-built_in">title</span></span> } } }</code> </pre> <br><p>  Ainsi, nous obtenons une requ√™te r√©cursive, qui nous √©tablit √©galement √©l√©mentairement une base. </p><br><pre> <code class="hljs objectivec">query evil { album(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>: <span class="hljs-number"><span class="hljs-number">42</span></span>) { songs { album { songs { album {</code> </pre> <br><p>  Ce probl√®me est √©galement connu, la solution pour Node JS est la limite de profondeur GraphQL, pour d'autres langages il existe √©galement des solutions. </p><br><p>  Ainsi, nous avons opt√© pour GraphQL.  Il est temps de choisir une biblioth√®que qui fonctionnera avec l'API GraphQL.  L'exemple de quelques lignes avec fetch, illustr√© ci-dessus, n'est qu'un transport.  Mais gr√¢ce au sch√©ma et √† la d√©clarativit√©, nous pouvons √©galement mettre en cache les requ√™tes √† l'avant et travailler avec de meilleures performances avec le backend GraphQL. </p><br><p>  Nous avons donc deux acteurs principaux - Relay et Apollo. </p><br><h3 id="relay">  Relais </h3><br><p>  Relay est un d√©veloppement Facebook, ils l'utilisent eux-m√™mes.  Comme Oculus, Circle CI, Arsti et Friday. </p><br><h4 id="kakie-plyusy-est-u-relay">  Quels sont les avantages du relais? </h4><br><p>  L'avantage imm√©diat est que le d√©veloppeur est Facebook.  React, Flow et GraphQL sont des d√©veloppements Facebook, qui sont tous des puzzles adapt√©s les uns aux autres.  O√π en sommes-nous sans √©toiles sur Github, Relay en a presque 11 000, Apollo en a 7600. La chose sympa que Relay a est Relay-compiler, un outil qui optimise et analyse vos requ√™tes GraphQL au niveau de la construction de votre projet .  Nous pouvons supposer que ce n'est uglify que pour GraphQL: </p><br><pre> <code class="hljs scala">#  <span class="hljs-type"><span class="hljs-type">Relay</span></span>-compiler foo { # <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">on</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FooType</span></span></span><span class="hljs-class"> </span></span>{ # matches the parent <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">so</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">is</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extraneous</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">id</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">#</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title"></span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foo</span></span></span><span class="hljs-class"> </span></span>{ id }</code> </pre> <br><h4 id="kakie-minusy-u-relay">  Quels sont les inconv√©nients du relais? </h4><br><p>  Le premier inconv√©nient * est le manque de SSR pr√™t √† l'emploi.  Github a toujours un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">probl√®me</a> ouvert.  Pourquoi sous l'ast√©risque - car il existe d√©j√† des solutions, mais elles sont tierces, et en plus, assez ambigu√´s. </p><br><p><img src="https://habrastorage.org/webt/ee/1b/rc/ee1brchbmmgdpqka4kpf3ogo2my.png"></p><br><p>  Encore une fois, Relay est une sp√©cification.  Le fait est que GraphQL est d√©j√† une sp√©cification, et Relay est une sp√©cification sur une sp√©cification. </p><br><p><img src="https://habrastorage.org/webt/f6/ds/nl/f6dsnlwzog77hrwpboaru95u7_y.png"></p><br><p>  Par exemple, la pagination de relais est impl√©ment√©e diff√©remment, des curseurs apparaissent ici. </p><br><pre> <code class="hljs pgsql">{ friends(first: <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">after</span></span>: "opaqueCursor") { edges { <span class="hljs-keyword"><span class="hljs-keyword">cursor</span></span> node { id <span class="hljs-type"><span class="hljs-type">name</span></span> } } pageInfo { hasNextPage } } }</code> </pre> <br><p>  Nous n'utilisons plus les d√©calages et limites habituels.  Pour les flux dans le flux, c'est un excellent sujet, mais lorsque nous commen√ßons √† faire toutes sortes de grilles, il y a de la douleur. </p><br><p>  Facebook a r√©solu son probl√®me en √©crivant une biblioth√®que pour React.  Il existe des solutions pour d'autres biblioth√®ques, pour vue.js, par exemple - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vue-relay</a> .  Mais si nous pr√™tons attention au nombre d'√©toiles et d'engagements, ici aussi, tout n'est pas si fluide et peut √™tre instable.  Par exemple, la cr√©ation de l'application React √† partir de la zone CRA vous emp√™che d'utiliser le compilateur de relais.  Mais vous pouvez contourner cette limitation avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">react-app-rewired</a> . </p><br><p><img src="https://habrastorage.org/webt/dj/wb/i2/djwbi2it6brz4qxdipg0wcdyhpa.png"></p><br><h2 id="apollo">  Apollo </h2><br><p>  Notre deuxi√®me candidat est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Apollo</a> .  D√©velopp√© par son √©quipe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Meteor</a> .  Apollo utilise des commandes bien connues telles que: AirBnB, ticketmaster, Opentable, etc. </p><br><h3 id="kakie-est-plyusy-u-apollo">  Quels sont les avantages d'Apollo? </h3><br><p>  Le premier avantage significatif est qu'Apollo a √©t√© d√©velopp√© comme une biblioth√®que agnostique de framework.  Par exemple, si nous voulons maintenant tout r√©√©crire sur Angular, ce ne sera pas un probl√®me, Apollo fonctionne avec cela.  Et vous pouvez m√™me tout √©crire en vanille. </p><br><p>  Apollo a une documentation int√©ressante, il existe des solutions toutes faites aux probl√®mes courants. </p><br><p><img src="https://habrastorage.org/webt/tq/wu/ko/tqwukoydh-b7fem6dwusyuwklgw.png"></p><br><p>  Un autre plus Apollo - une puissante API.  En principe, ceux qui ont travaill√© avec Redux trouveront ici des approches communes: il y a ApolloProvider (comme Provux pour Redux), et au lieu de stocker pour Apollo, cela s'appelle client: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ApolloProvider } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { ApolloClient } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./ApolloClient'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> App = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ApolloProvider</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">client</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">{ApolloClient}</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ApolloProvider</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> );</code> </pre> <br><p>  Au niveau du composant lui-m√™me, nous avons graphql HOC fourni comme connect.  Et nous √©crivons la requ√™te GraphQL d√©j√† √† l'int√©rieur, comme MapStateToProps dans Redux. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { graphql } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> gql <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'graphql-tag'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Landing } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./Landing'</span></span>; graphql(gql<span class="hljs-string"><span class="hljs-string">` { landing(id: 1) { id title } } `</span></span>)(Landing);</code> </pre> <br><p>  Mais quand nous faisons MapStateToProps dans Redux, nous r√©cup√©rons les donn√©es locales.  S'il n'y a pas de donn√©es locales, Apollo va lui-m√™me au serveur.  Des accessoires tr√®s pratiques tombent dans le composant lui-m√™me. </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Landing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ data, loading, error, refetch, </span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...other</span></span></span></span><span class="hljs-function"><span class="hljs-params"> })</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><p>  C‚Äôest: <br>  ‚Ä¢ donn√©es; <br>  ‚Ä¢ √©tat du t√©l√©chargement; <br>  ‚Ä¢ une erreur si elle s'est produite; <br>  des fonctions d'assistance comme refetch pour recharger les donn√©es ou fetchMore pour paginer.  Il y a aussi un √©norme avantage pour Apollo et Relay, qui est l'interface utilisateur optimiste.  Il vous permet de valider annuler / r√©tablir au niveau de la demande: </p><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.props.setNotificationStatusMutation({ variables: { ‚Ä¶ }, optimisticResponse: { ‚Ä¶ } });</code> </pre> <br><p>  Par exemple, l'utilisateur a cliqu√© sur le bouton ¬´J'aime¬ª, et ¬´J'aime¬ª a imm√©diatement compt√©.  Dans ce cas, une demande au serveur sera envoy√©e en arri√®re-plan.  Si une erreur se produit pendant le processus d'envoi, les donn√©es mutables reviendront √† leur √©tat d'origine par elles-m√™mes. </p><br><p>  Le rendu c√¥t√© serveur est bien impl√©ment√©, nous avons d√©fini un indicateur sur le client et tout est pr√™t. </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ApolloClient</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">ssrMode</span></span>: true, ... });</code> </pre> <br><p>  Mais ici, je voudrais parler de l'√©tat initial.  Quand Apollo le cuisine pour lui-m√™me, tout fonctionne bien. </p><br><pre> <code class="hljs javascript">&lt;script&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__ = client.extract(); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApolloClient({ <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InMemoryCache().restore(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__), link });</code> </pre> <br><p>  Mais nous n'avons pas de rendu c√¥t√© serveur, et le backend pousse une requ√™te GraphQL sp√©cifique dans la variable globale.  Ici, vous avez besoin d'une petite b√©quille, vous devez √©crire une fonction de transformation que la r√©ponse GraphQL du backend deviendra d√©j√† au format n√©cessaire pour Apollo. </p><br><pre> <code class="hljs javascript">&lt;script&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__ = transform({‚Ä¶}); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApolloClient({ <span class="hljs-attr"><span class="hljs-attr">cache</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InMemoryCache().restore(<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.__APOLLO_STATE__), link });</code> </pre> <br><p>  Un autre avantage d'Apollo est qu'il est bien personnalisable.  Nous nous souvenons tous du middleware de Redux, tout est pareil ici, seulement cela s'appelle un lien. </p><br><p><img src="https://habrastorage.org/webt/va/gw/-z/vagw-zeeg2j0t7pjuawtw4tllq8.png"></p><br><p>  Je voudrais noter s√©par√©ment deux liens: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">apollo-link-state</a> , qui est n√©cessaire pour stocker l'√©tat local en l'absence de Redux, et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">apollo-link-rest</a> , si nous voulons √©crire des requ√™tes GraphQL dans l'API Rest.  Cependant, avec ce dernier, vous devez √™tre extr√™mement prudent, car  certains probl√®mes peuvent survenir. </p><br><h4 id="minusy-u-apollo-tozhe-est">  Apollo a aussi des inconv√©nients </h4><br><p>  Regardons un exemple.  Un probl√®me de performance inattendu s'est produit: 2 000 √©l√©ments ont √©t√© demand√©s sur le frontend (c'√©tait un r√©pertoire) et des probl√®mes de performances ont commenc√©.  Apr√®s l'avoir vu dans le d√©bogueur, il s'est av√©r√© qu'Apollo ronge beaucoup de ressources en lisant, le probl√®me est fondamentalement clos, maintenant tout va bien, mais il y avait un tel p√©ch√©. </p><br><p>  De plus, le refetch s'est av√©r√© tr√®s peu √©vident ... </p><br><pre> <code class="hljs actionscript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Landing</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">({ loading, refetch, </span></span><span class="hljs-rest_arg"><span class="hljs-function"><span class="hljs-params"><span class="hljs-rest_arg">...other</span></span></span></span><span class="hljs-function"><span class="hljs-params"> })</span></span></span><span class="hljs-function"> </span></span>{ ... }</code> </pre> <br><p>  Il semblerait que lorsque nous effectuons une nouvelle demande de donn√©es, en outre, si la demande pr√©c√©dente se terminait par une erreur, le chargement devrait devenir vrai.  Mais non! </p><br><p>  Pour que cela se produise, vous devez sp√©cifier notifyOnNetworkStatusChange: true dans le graphql HOC ou stocker l'√©tat de refetch localement. </p><br><h3 id="apollo-vs-relay">  Apollo contre  Relais </h3><br><p>  Ainsi, nous avons eu une telle table, nous avons tous pes√©, compt√©, et nous avions 76% de retard sur Apollo. </p><br><p><img src="https://habrastorage.org/webt/ry/if/wx/ryifwxtkdmb4yvc2xczme5xoqkc.png"></p><br><p>  Nous avons donc choisi la biblioth√®que et nous sommes all√©s travailler. </p><br><p>  Mais je voudrais en dire plus sur la cha√Æne d'outils. </p><br><p>  Tout est tr√®s bien ici, il existe diff√©rents modules compl√©mentaires pour les √©diteurs, quelque part mieux, quelque part pire.  Il existe √©galement apollo-codegen, qui g√©n√®re des fichiers utiles, par exemple, des types de flux, et extrait essentiellement le sch√©ma de l'API GraphQL. </p><br><h3 id="rubrika-ochumelye-ruchki-ili-chto-my-sdelali-u-sebya">  La rubrique "Crazy Hands" ou ce que nous faisions √† la maison </h3><br><p>  La premi√®re chose que nous avons rencontr√©e est que nous devons essentiellement demander des donn√©es. </p><br><pre> <code class="hljs lisp">graphql(<span class="hljs-name"><span class="hljs-name">BalanceQuery</span></span>)(<span class="hljs-name"><span class="hljs-name">BalanceItem</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Nous avons des conditions communes: chargement, gestion des erreurs.  Nous avons √©crit notre propre faucon (asyncCard), qui est connect√© via la composition de graqhql et asyncCard. </p><br><pre> <code class="hljs lisp">compose( <span class="hljs-name"><span class="hljs-name">graphql</span></span>(<span class="hljs-name"><span class="hljs-name">BalanceQuery</span></span>), AsyncCard )(<span class="hljs-name"><span class="hljs-name">BalanceItem</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br><p>  Je voudrais √©galement parler des fragments.  Il existe un composant LandingItem et il sait de quelles donn√©es il a besoin √† partir de l'API GraphQL.  Nous d√©finissons la propri√©t√© de fragment, o√π nous avons sp√©cifi√© les champs de l'entit√© Landing. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LandingItem = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content }: Props</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ‚Ä¶ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); LandingItem.fragment = gql<span class="hljs-string"><span class="hljs-string">` fragment LandingItem on Landing { ... } `</span></span>;</code> </pre> <br><p>  Maintenant, au niveau de l'utilisation du composant, nous utilisons son fragment dans la requ√™te finale. </p><br><pre> <code class="hljs bash">query LandingsDashboard { landings(...) { nodes { ...LandingItem } totalCount } <span class="hljs-variable"><span class="hljs-variable">${LandingItem.Fragment}</span></span> }</code> </pre> <br><p>  Et disons qu'une t√¢che vole pour ajouter du statut √† cette page de destination - ce n'est pas un probl√®me.  Nous ajoutons une propri√©t√© au rendu et au fragment.  Et tout est pr√™t.  Principe de responsabilit√© unique dans toute sa splendeur. </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LandingItem = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{ content }: Props</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ‚Ä¶ </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStatus</span></span></span></span><span class="xml"><span class="hljs-tag"> ‚Ä¶ /&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LandingItemStyle</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ); LandingItem.fragment = gql` fragment LandingItem on Landing { ... status } `;</span></span></code> </pre> <br><h4 id="kakaya-u-nas-esche-byla-problema">  Quel autre probl√®me avions-nous? </h4><br><p>  Nous avons un certain nombre de widgets sur notre site qui ont fait leurs demandes individuelles. </p><br><p><img src="https://habrastorage.org/webt/ab/li/-x/abli-xjzcmoq9_p2rtnorl-y3qu.png"></p><br><p>  Lors des tests, il s'est av√©r√© que tout cela ralentit.  Nous avons de tr√®s longs contr√¥les de s√©curit√© et chaque demande co√ªte tr√®s cher.  Cela s'est √©galement av√©r√© ne poser aucun probl√®me, il y a Apollo-link-batch-http </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">new</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">BatchHttpLink</span></span>({ <span class="hljs-attribute"><span class="hljs-attribute">batchMax</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span>, batchInterval: <span class="hljs-number"><span class="hljs-number">10</span></span> });</code> </pre> <br><p>  Il est configur√© comme suit: nous transmettons le nombre de requ√™tes que nous pouvons combiner et combien de temps ce lien attendra apr√®s l'apparition de la premi√®re requ√™te. <br>  Et cela s'est av√©r√© comme ceci: en m√™me temps tout se charge, et en m√™me temps tout vient.  Il convient de noter que si au cours de cette fusion, l'une des sous-requ√™tes revient avec une erreur, l'erreur ne sera que pour lui, et non pour la demande enti√®re. </p><br><h4 id="hochetsya-otdelno-rasskazat-chto-proshloy-osenyu-proizoshlo-obnovlenie-s-pervogo-apollo-na-vtoroy">  Je voudrais dire s√©par√©ment que l'automne dernier, il y a eu une mise √† jour du premier Apollo au second </h4><br><p>  Au d√©but √©tait Apollo et Redux </p><br><pre> <code class="hljs cs"><span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span> <span class="hljs-string"><span class="hljs-string">'redux'</span></span></code> </pre> <br><p>  Puis Apollo est devenu plus modulaire et extensible, ces modules peuvent √™tre d√©velopp√©s ind√©pendamment.  La m√™me apollo-cache-inmemory. </p><br><pre> <code class="hljs cs"><span class="hljs-string"><span class="hljs-string">'react-apollo'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-client'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-link-batch-http'</span></span> <span class="hljs-string"><span class="hljs-string">'apollo-cache-inmemory'</span></span> <span class="hljs-string"><span class="hljs-string">'graphql-tag'</span></span></code> </pre> <br><p>  Il convient de noter que Redux ne l'est pas, et il s'est av√©r√© que, en principe, il n'est pas n√©cessaire. </p><br><h2 id="vyvody">  Conclusions: </h2><br><ol><li>  Le d√©lai de livraison des fonctionnalit√©s a diminu√©, nous ne perdons pas de temps √† d√©crire l'action, √† r√©duire dans Redux et √† moins toucher au backend </li><li>  L'antifragilit√© est apparue parce que  L'analyse statique de l'API vous permet d'annuler les probl√®mes lorsque le frontend attend une chose et que le backend en retourne une compl√®tement diff√©rente. </li><li>  Si vous commencez √† travailler avec GraphQL - essayez Apollo, ne soyez pas d√©√ßu. </li></ol><br><p>  PS Vous pouvez √©galement regarder une vid√©o de ma pr√©sentation sur Rambler Front &amp; Meet up # 4 </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/rCEoy-V3x8k" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418417/">https://habr.com/ru/post/fr418417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418403/index.html">Exemple de programmation d'acc√©l√©rateur FPGA</a></li>
<li><a href="../fr418405/index.html">Le principe de la pyramide invers√©e en analytique. Nous construisons un tableau de bord compr√©hensible</a></li>
<li><a href="../fr418407/index.html">L'extraction de cloud Hashflare a ferm√©. L'argent ne revient pas</a></li>
<li><a href="../fr418411/index.html">Tireur de r√©seau de navigateur sur Node.js</a></li>
<li><a href="../fr418415/index.html">Telegram a pr√©sent√© son propre service de passeport pour la v√©rification et l'autorisation des utilisateurs</a></li>
<li><a href="../fr418419/index.html">Comment Dodo Pizza r√©sout les probl√®mes commerciaux √† l'aide de l'apprentissage automatique</a></li>
<li><a href="../fr418423/index.html">Maison intelligente: une nouvelle dimension de confort et la recherche de l'excellence. Premi√®re partie</a></li>
<li><a href="../fr418427/index.html">Indexation mobile d'abord. Comment et pourquoi le graphique des liens va-t-il changer?</a></li>
<li><a href="../fr418429/index.html">Mon exp√©rience professionnelle pour le r√¥le de coach agile en Europe, deuxi√®me partie</a></li>
<li><a href="../fr418431/index.html">Probl√®mes imaginaires - la racine des mauvais logiciels</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>