<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ãŠ—ï¸ ğŸ‘©ğŸ»â€ğŸŒ¾ ğŸ¥‡ Base de datos ClickHouse para humanos, o Alien Technology ğŸ•¡ ğŸ¤ ğŸš§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alexey Lizunov, jefe del centro de competencia de canales de servicios remotos de la DirecciÃ³n de TecnologÃ­as de la InformaciÃ³n del ICD 



 Como alte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Base de datos ClickHouse para humanos, o Alien Technology</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mkb/blog/472912/"> <b>Alexey Lizunov, jefe del centro de competencia de canales de servicios remotos de la DirecciÃ³n de TecnologÃ­as de la InformaciÃ³n del ICD</b> <br><br><img src="https://habrastorage.org/webt/bs/gu/k0/bsguk03an99lspkpmtkoks2bkvg.png"><br><br>  Como alternativa a la pila ELK (ElasticSearch, Logstash, Kibana), estamos realizando investigaciones sobre el uso de la base de datos ClickHouse como un almacÃ©n de datos para registros. <br><br>  En este artÃ­culo, nos gustarÃ­a hablar sobre nuestra experiencia en el uso de la base de datos ClickHouse y sobre los resultados preliminares de la operaciÃ³n piloto.  Cabe seÃ±alar de inmediato que los resultados fueron impresionantes. <br><br><a name="habracut"></a><br><img src="https://habrastorage.org/webt/uy/mc/ip/uymcipeis_jm2piqsaqdjmu9_l8.jpeg"><br><br>  A continuaciÃ³n, describiremos con mÃ¡s detalle cÃ³mo estÃ¡ configurado nuestro sistema y en quÃ© componentes consta.  Pero ahora me gustarÃ­a hablar un poco sobre esta base de datos en su conjunto, y por quÃ© deberÃ­a prestarle atenciÃ³n.  La base de datos ClickHouse es una base de datos de columnas analÃ­ticas de alto rendimiento de Yandex.  Se utiliza en los servicios de Yandex, inicialmente es el almacÃ©n de datos principal de Yandex.Metrica.  El sistema de cÃ³digo abierto es gratuito.  Desde el punto de vista del desarrollador, siempre me interesÃ³ cÃ³mo lo implementaron, porque hay datos increÃ­blemente grandes.  Y la interfaz de usuario mÃ©trica en sÃ­ es muy flexible y rÃ¡pida.  Al primer contacto con esta base de datos, la impresiÃ³n: â€œÂ¡Bueno, finalmente!  Hecho "para personas"!  Comenzando desde el proceso de instalaciÃ³n y terminando con el envÃ­o de solicitudes ". <br><br>  Esta base de datos tiene un umbral de entrada muy bajo.  Incluso un desarrollador experto promedio puede instalar esta base de datos en unos minutos y comenzar a usarla.  Todo funciona con claridad.  Incluso las personas que son nuevas en Linux pueden completar rÃ¡pidamente la instalaciÃ³n y realizar operaciones simples.  Anteriormente, cuando la palabra Big Data, Hadoop, Google BigTable, HDFS, el desarrollador habitual tenÃ­a la idea de que estaban hablando de algunos terabytes, petabytes, que algunos superhumanos estaban involucrados en la configuraciÃ³n y el desarrollo de estos sistemas, luego con el advenimiento de la base de datos ClickHouse obtuvimos Una herramienta simple y comprensible con la que puede resolver el rango de tareas previamente inalcanzable.  Solo un automÃ³vil bastante promedio y cinco minutos para instalar.  Es decir, tenemos una base de datos como, por ejemplo, MySql, Â¡pero solo para almacenar miles de millones de registros!  AlgÃºn tipo de supervisor SQL.  Es como si a las personas se les dieran armas de extraterrestres. <br><br><h4>  Sobre nuestro sistema de recopilaciÃ³n de registros </h4><br>  Para recopilar informaciÃ³n, se utilizan archivos de registro IIS de aplicaciones web de formato estÃ¡ndar (tambiÃ©n estamos involucrados en analizar registros de aplicaciones, pero el objetivo principal en la etapa de operaciÃ³n piloto con nosotros es recopilar registros IIS). <br><br>  Por varias razones, no pudimos abandonar completamente la pila ELK, y continuamos usando los componentes LogStash y Filebeat, que han demostrado ser buenos y funcionan de manera bastante confiable y predecible. <br><br>  El esquema general de registro se presenta en la siguiente figura: <br><br><img src="https://habrastorage.org/webt/ah/kr/qg/ahkrqgjij-tfce_455jhjikjfg8.jpeg"><br><br>  Una caracterÃ­stica de escribir datos en la base de datos ClickHouse es la inserciÃ³n infrecuente (una vez por segundo) de registros en grandes lotes.  Aparentemente, esta es la parte mÃ¡s "problemÃ¡tica" que encuentra la primera vez que trabaja con la base de datos ClickHouse: el esquema es un poco complicado. <br>  El complemento LogStash ayudÃ³ mucho aquÃ­, que inserta datos directamente en ClickHouse.  Este componente se implementa en el mismo servidor que la base de datos en sÃ­.  Por lo tanto, en tÃ©rminos generales, no se recomienda hacerlo, sino desde un punto de vista prÃ¡ctico, para no producir servidores separados mientras se implementa en el mismo servidor.  No observamos fallas o conflictos de recursos con la base de datos.  AdemÃ¡s, debe tenerse en cuenta que el complemento tiene un mecanismo de retransmisiÃ³n en caso de errores.  Y en caso de errores, el complemento escribe en el disco un paquete de datos que no se pudo insertar (el formato de archivo es conveniente: despuÃ©s de la ediciÃ³n, puede insertar fÃ¡cilmente el paquete corregido usando clickhouse-client). <br><br>  La lista completa de software utilizado en el esquema se presenta en la tabla: <br><br><div class="spoiler">  <b class="spoiler_title">Lista de software usado</b> <div class="spoiler_text"><div class="scrollable-table"><table><tbody><tr><td>  <b>Titulo</b> <br></td><td>  <b>DescripciÃ³n</b> <br></td><td>  <b>Enlace de distribuciÃ³n</b> <br></td></tr><tr><td><p>  Nginx </p><br></td><td><p>  Reverse-proxy para restringir el acceso al puerto y la autorizaciÃ³n </p><br><br><p>  Actualmente no se usa en el circuito. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://nginx.org/en/download.html</a> </p><br></td><td><p>  <a href="">https://nginx.org/download/nginx-1.16.0.tar.gz</a> </p><br></td></tr><tr><td><p>  Filebeat </p><br></td><td><p>  Transferir registros de archivos. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.elastic.co/downloads/beats/filebeat</a> (distribuciÃ³n para Windows de 64 bits). </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.3.0-windows-x86_64.zip</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p>  Recolector de troncos. </p><br><br><p>  Se utiliza para recopilar registros de FileBeat, asÃ­ como para recopilar registros de la cola RabbitMQ (para servidores que estÃ¡n en la DMZ). </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Logstash- salida- clickhouse </p><br></td><td><p>  Complemento Loagstash para transferir registros a la base de datos ClickHouse en lotes </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://github.com/mikechris/logstash-output-clickhouse</a> </p><br></td><td><p>  / usr / share / logstash / bin / logstash-plugin install logstash-output-clickhouse </p><br><p>  / usr / share / logstash / bin / logstash-plugin install logstash-filter-prune </p><br><p>  / usr / share / logstash / bin / logstash-plugin install logstash-filter-multiline </p><br></td></tr><tr><td><p>  Clickhouse </p><br></td><td><p>  Repositorio de registros <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://clickhouse.yandex/docs/ru/</a> </p><br></td><td><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-server-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  <a href="">https://packagecloud.io/Altinity/clickhouse/packages/el/7/clickhouse-client-19.5.3.8-1.el7.x86_64.rpm</a> </p><br><p>  Nota  Desde agosto de 2018, los ensamblajes rpm "normales" para RHEL han aparecido en el repositorio de Yandex, por lo que puede intentar usarlos.  En el momento de la instalaciÃ³n, utilizamos paquetes compilados por Altinity. </p><br></td></tr><tr><td><p>  Grafana </p><br></td><td><p>  VisualizaciÃ³n de registro.  Configurar paneles </p><br><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://grafana.com/</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://grafana.com/grafana/download</a> </p><br><br><p>  Redhat &amp; Centos (64 Bit) - Ãšltima versiÃ³n </p><br></td></tr><tr><td><p>  Fuente de datos ClickHouse para Grafana 4.6+ </p><br></td><td><p>  Complemento Grafana con fuente de datos ClickHouse </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://grafana.com/plugins/vertamedia-clickhouse-datasource</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://grafana.com/api/plugins/vertamedia-clickhouse-datasource/versions/1.8.1/download</a> </p><br></td></tr><tr><td><p>  Logstash </p><br></td><td><p>  Registre el enrutador de FileBeat en la cola RabbitMQ. </p><br><p>  Nota  Desafortunadamente, FileBeat no tiene salida directamente en RabbitMQ, por lo que se requiere un enlace intermedio en forma de Logstash </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.elastic.co/products/logstash</a> </p><br></td><td><p>  <a href="">https://artifacts.elastic.co/downloads/logstash/logstash-7.0.1.rpm</a> </p><br></td></tr><tr><td><p>  Rabbitmq </p><br></td><td><p>  Cola de mensajes  Este es un bÃºfer de entradas de registro en DMZ </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.rabbitmq.com/download.html</a> </p><br></td><td><p>  <a href="">https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-3.7.14-1.el7.noarch.rpm</a> </p><br></td></tr><tr><td><p>  Erlang Runtime (requerido para RabbitMQ) </p><br></td><td><p>  Erlang runtime.  Requerido para que RabbitMQ funcione </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">http://www.erlang.org/download.html</a> </p><br></td><td><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://www.rabbitmq.com/install-rpm.html#install-erlang</a> <a href="">http://www.erlang.org/downloads/21.3</a> </p><br></td></tr></tbody></table></div><br></div></div><br>  La configuraciÃ³n del servidor con la base de datos ClickHouse se presenta en la siguiente tabla: <br><div class="scrollable-table"><table><tbody><tr><td>  <b>Titulo</b> <br></td><td>  <b>Valor</b> <br></td><td>  <b>Nota</b> <br></td></tr><tr><td><p>  Configuracion </p><br></td><td><p>  HDD: 40 GB <br>  RAM: 8 GB <br>  Procesador: Core 2 2Ghz </p><br></td><td><p>  Es necesario prestar atenciÃ³n a los consejos sobre el funcionamiento de la base de datos ClickHouse ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">https://clickhouse.yandex/docs/ru/operations/tips/</a> ) </p><br></td></tr><tr><td><p>  Software de todo el sistema </p><br></td><td><p>  Sistema operativo: Red Hat Enterprise Linux Server (Maipo) </p><br><p>  JRE (Java 8) </p><br></td><td><p></p><br></td></tr></tbody></table></div><br>  Como puede ver, esta es una estaciÃ³n de trabajo normal. <br><br>  La estructura de la tabla para almacenar registros es la siguiente: <br><br><div class="spoiler">  <b class="spoiler_title">log_web.sql</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> log_web ( logdate <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>, logdatetime DateTime CODEC(Delta, LZ4HC), fld_log_file_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_server_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_app_module LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), fld_website_name LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), serverIP LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), method LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), uriStem <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, uriQuery <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, port UInt32, username LowCardinality( <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ), clientIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, clientRealIP <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, userAgent <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, referer <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, subresponse <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, win32response <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>, timetaken UInt64 , uriQuery__utm_medium <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_source <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_campaign <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_term <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__utm_content <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__yclid <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> , uriQuery__region <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">Engine</span></span> = MergeTree() <span class="hljs-keyword"><span class="hljs-keyword">PARTITION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> toYYYYMM(logdate) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> (fld_app_name, fld_app_module, logdatetime) <span class="hljs-keyword"><span class="hljs-keyword">SETTINGS</span></span> index_granularity = <span class="hljs-number"><span class="hljs-number">8192</span></span>;</code> </pre> <br></div></div><br>  Utilizamos valores predeterminados para la particiÃ³n (por meses) y la granularidad del Ã­ndice.  Todos los campos corresponden prÃ¡cticamente a las entradas de registro de IIS para registrar solicitudes http.  Por separado, campos separados para almacenar etiquetas utm (se analizan en la etapa de inserciÃ³n en la tabla desde el campo de cadena de consulta). <br><br>  TambiÃ©n en la tabla se agregan varios campos del sistema para almacenar informaciÃ³n sobre sistemas, componentes, servidores.  Consulte la tabla a continuaciÃ³n para obtener una descripciÃ³n de estos campos.  En una tabla, almacenamos registros para varios sistemas. <br><br><div class="scrollable-table"><table><tbody><tr><td>  <b>Titulo</b> <br></td><td>  <b>DescripciÃ³n</b> <br></td><td>  <b>Ejemplo</b> <br></td></tr><tr><td><p>  fld_app_name </p><br></td><td><p>  Nombre de aplicaciÃ³n / sistema <br>  Valores vÃ¡lidos: </p><br><ul><li>  site1.domain.com Sitio externo 1 </li><li>  site2.domain.com Sitio externo 2 </li><li>  internal-site1.domain.local Sitio interno 1 </li></ul><br></td><td>  site1.domain.com <br></td></tr><tr><td><p>  fld_app_module </p><br></td><td><p>  MÃ³dulo del sistema <br>  Valores vÃ¡lidos: </p><br><ul><li>  web - Sitio web </li><li>  svc - Servicio de sitio web </li><li>  intgr - Servicio de integraciÃ³n web </li><li>  bo - Admin (BackOffice) </li></ul><br></td><td><p>  web </p><br></td></tr><tr><td><p>  fld_website_name </p><br></td><td><p>  Nombre del sitio web en IIS </p><br><p>  Se pueden implementar varios sistemas en un servidor, o incluso varias instancias de un mÃ³dulo de sistema </p><br></td><td><p>  web-main </p><br></td></tr><tr><td><p>  fld_server_name </p><br></td><td><p>  Nombre del servidor </p><br></td><td><p>  web1.domain.com </p><br></td></tr><tr><td><p>  fld_log_file_name </p><br></td><td><p>  La ruta al archivo de registro en el servidor </p><br></td><td>  C: \ inetpub \ logs \ LogFiles <br>  \ W3SVC1 \ u_ex190711.log <br></td></tr></tbody></table></div><br>  Esto le permite construir grÃ¡ficos de manera efectiva en Grafana.  Por ejemplo, vea las solicitudes de la interfaz de un sistema especÃ­fico.  Esto es similar al contador del sitio en Yandex.Metrica. <br><br>  AquÃ­ hay algunas estadÃ­sticas sobre el uso de la base de datos durante dos meses. <br><br><div class="spoiler">  <b class="spoiler_title">NÃºmero de registros por sistema y componente.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> fld_app_name, fld_app_module, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(fld_app_name) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> rows_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> log_web <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name, fld_app_module <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> TOTALS <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fld_app_name <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, rows_count <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> â”Œâ”€fld_app_nameâ”€â”€â”€â”€â”€â”¬â”€fld_app_moduleâ”€â”¬â”€rows_countâ”€â” â”‚ site1.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">131441</span></span> â”‚ â”‚ site2.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">1751081</span></span> â”‚ â”‚ site3.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">106887543</span></span> â”‚ â”‚ site3.domain.ru â”‚ svc â”‚ <span class="hljs-number"><span class="hljs-number">44908603</span></span> â”‚ â”‚ site3.domain.ru â”‚ intgr â”‚ <span class="hljs-number"><span class="hljs-number">9813911</span></span> â”‚ â”‚ site4.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">772095</span></span> â”‚ â”‚ site5.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">17037221</span></span> â”‚ â”‚ site5.domain.ru â”‚ intgr â”‚ <span class="hljs-number"><span class="hljs-number">838559</span></span> â”‚ â”‚ site5.domain.ru â”‚ bo â”‚ <span class="hljs-number"><span class="hljs-number">7404</span></span> â”‚ â”‚ site6.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">595877</span></span> â”‚ â”‚ site7.domain.ru â”‚ web â”‚ <span class="hljs-number"><span class="hljs-number">27778858</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ Totals: â”Œâ”€fld_app_nameâ”€â”¬â”€fld_app_moduleâ”€â”¬â”€rows_countâ”€â” â”‚ â”‚ â”‚ <span class="hljs-number"><span class="hljs-number">210522593</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">4.874</span></span> sec. Processed <span class="hljs-number"><span class="hljs-number">210.52</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>, <span class="hljs-number"><span class="hljs-number">421.67</span></span> MB (<span class="hljs-number"><span class="hljs-number">43.19</span></span> million <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>/s., <span class="hljs-number"><span class="hljs-number">86.51</span></span> MB/s.)</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">La cantidad de datos en el disco.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_uncompressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(<span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(data_compressed_bytes)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total_rows <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.parts <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> â”Œâ”€uncompressedâ”€â”¬â”€compressedâ”€â”¬â”€total_rowsâ”€â” â”‚ <span class="hljs-number"><span class="hljs-number">54.50</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">4.86</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">211427094</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.035</span></span> sec.</code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">El grado de compresiÃ³n de datos en columnas.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, formatReadableSize(data_uncompressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> uncompressed, formatReadableSize(data_compressed_bytes) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compressed, data_uncompressed_bytes / data_compressed_bytes <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> compress_ratio <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> system.columns <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> = <span class="hljs-string"><span class="hljs-string">'log_web'</span></span> â”Œâ”€<span class="hljs-keyword"><span class="hljs-keyword">name</span></span>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€uncompressedâ”€â”¬â”€compressedâ”€â”¬â”€â”€â”€â”€â”€compress_ratioâ”€â” â”‚ logdate â”‚ <span class="hljs-number"><span class="hljs-number">401.53</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">1.80</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">223.16665968777315</span></span> â”‚ â”‚ logdatetime â”‚ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">35.91</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">22.363966401202305</span></span> â”‚ â”‚ fld_log_file_name â”‚ <span class="hljs-number"><span class="hljs-number">220.66</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">2.60</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">84.99905736932571</span></span> â”‚ â”‚ fld_server_name â”‚ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">50.63</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">3.980924816977078</span></span> â”‚ â”‚ fld_app_name â”‚ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">969.17</span></span> KiB â”‚ <span class="hljs-number"><span class="hljs-number">212.55518183686877</span></span> â”‚ â”‚ fld_app_module â”‚ <span class="hljs-number"><span class="hljs-number">201.17</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">968.60</span></span> KiB â”‚ <span class="hljs-number"><span class="hljs-number">212.67805817411906</span></span> â”‚ â”‚ fld_website_name â”‚ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">1.24</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">162.7204926761546</span></span> â”‚ â”‚ serverIP â”‚ <span class="hljs-number"><span class="hljs-number">201.54</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">50.25</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">4.010824061219731</span></span> â”‚ â”‚ method â”‚ <span class="hljs-number"><span class="hljs-number">201.53</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">43.64</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">4.617721053304486</span></span> â”‚ â”‚ uriStem â”‚ <span class="hljs-number"><span class="hljs-number">5.13</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">832.51</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">6.311522291936919</span></span> â”‚ â”‚ uriQuery â”‚ <span class="hljs-number"><span class="hljs-number">2.58</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">501.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">5.269731450124478</span></span> â”‚ â”‚ port â”‚ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">3.98</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">201.91673864241824</span></span> â”‚ â”‚ username â”‚ <span class="hljs-number"><span class="hljs-number">318.08</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">26.93</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">11.812513794583598</span></span> â”‚ â”‚ clientIP â”‚ <span class="hljs-number"><span class="hljs-number">2.35</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">82.59</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">29.132328640073343</span></span> â”‚ â”‚ clientRealIP â”‚ <span class="hljs-number"><span class="hljs-number">2.49</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">465.05</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">5.478382297052563</span></span> â”‚ â”‚ userAgent â”‚ <span class="hljs-number"><span class="hljs-number">18.34</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">764.08</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">24.57905114484208</span></span> â”‚ â”‚ referer â”‚ <span class="hljs-number"><span class="hljs-number">14.71</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">1.37</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">10.736792723669906</span></span> â”‚ â”‚ response â”‚ <span class="hljs-number"><span class="hljs-number">803.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">83.81</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">9.582334090987247</span></span> â”‚ â”‚ subresponse â”‚ <span class="hljs-number"><span class="hljs-number">399.87</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">1.83</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">218.4831068635027</span></span> â”‚ â”‚ win32response â”‚ <span class="hljs-number"><span class="hljs-number">407.86</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">7.41</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">55.050315514606815</span></span> â”‚ â”‚ timetaken â”‚ <span class="hljs-number"><span class="hljs-number">1.57</span></span> GiB â”‚ <span class="hljs-number"><span class="hljs-number">402.06</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">3.9947395692010637</span></span> â”‚ â”‚ uriQuery__utm_medium â”‚ <span class="hljs-number"><span class="hljs-number">208.17</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">12.29</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">16.936148912472955</span></span> â”‚ â”‚ uriQuery__utm_source â”‚ <span class="hljs-number"><span class="hljs-number">215.18</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">13.00</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">16.548367623199912</span></span> â”‚ â”‚ uriQuery__utm_campaign â”‚ <span class="hljs-number"><span class="hljs-number">381.46</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">37.94</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">10.055156353418509</span></span> â”‚ â”‚ uriQuery__utm_term â”‚ <span class="hljs-number"><span class="hljs-number">231.82</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">10.78</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">21.502540454070672</span></span> â”‚ â”‚ uriQuery__utm_content â”‚ <span class="hljs-number"><span class="hljs-number">441.34</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">87.60</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">5.038260760449327</span></span> â”‚ â”‚ uriQuery__yclid â”‚ <span class="hljs-number"><span class="hljs-number">216.88</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">16.58</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">13.07721335008116</span></span> â”‚ â”‚ uriQuery__region â”‚ <span class="hljs-number"><span class="hljs-number">204.35</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">9.49</span></span> MiB â”‚ <span class="hljs-number"><span class="hljs-number">21.52661903446796</span></span> â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ <span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> set. Elapsed: <span class="hljs-number"><span class="hljs-number">0.005</span></span> sec.</code> </pre> <br></div></div><br><h4>  DescripciÃ³n de los componentes utilizados. <br><br>  FileBeat.  Transferencia de registro de archivos </h4><br>  Este componente supervisa los cambios en los archivos de registro en el disco y transfiere informaciÃ³n a LogStash.  Se instala en todos los servidores donde se escriben los archivos de registro (generalmente IIS).  Funciona en modo de cola (es decir, solo transfiere registros agregados a un archivo).  Pero por separado, puede configurar toda la transferencia de archivos.  Esto es Ãºtil cuando necesita descargar datos de meses anteriores.  Simplemente coloque el archivo de registro en una carpeta y Ã©l lo leerÃ¡ en su totalidad. <br><br>  Cuando el servicio se detiene, los datos dejan de transferirse al almacenamiento. <br><br>  Un ejemplo de configuraciÃ³n es el siguiente: <br><br><div class="spoiler">  <b class="spoiler_title">filebeat.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs">filebeat.inputs: - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/W3SVC1<span class="hljs-comment"><span class="hljs-comment">/*.log exclude_files: ['.gz$','.zip$'] tail_files: true ignore_older: 24h fields: fld_server_name: "site1.domain.ru" fld_app_name: "site1.domain.ru" fld_app_module: "web" fld_website_name: "web-main" - type: log enabled: true paths: - C:/inetpub/logs/LogFiles/__Import/access_log-* exclude_files: ['.gz$','.zip$'] tail_files: false fields: fld_server_name: "site2.domain.ru" fld_app_name: "site2.domain.ru" fld_app_module: "web" fld_website_name: "web-main" fld_logformat: "logformat__apache" filebeat.config.modules: path: ${path.config}/modules.d/*.yml reload.enabled: false reload.period: 2s output.logstash: hosts: ["log.domain.com:5044"] ssl.enabled: true ssl.certificate_authorities: ["C:/filebeat/certs/ca.pem", "C:/filebeat/certs/ca-issuing.pem"] ssl.certificate: "C:/filebeat/certs/site1.domain.ru.cer" ssl.key: "C:/filebeat/certs/site1.domain.ru.key" #================================ Processors ===================================== processors: - add_host_metadata: ~ - add_cloud_metadata: ~</span></span></code> </pre> <br></div></div><br><h4>  LogStash  Colector de registro </h4><br>  Este componente estÃ¡ diseÃ±ado para recibir entradas de registro de FileBeat (o a travÃ©s de la cola RabbitMQ), analizar e insertar paquetes en la base de datos ClickHouse. <br><br>  Para insertar en ClickHouse, se utiliza el complemento Logstash-output-clickhouse.  El complemento Logstash tiene un mecanismo para recuperar solicitudes, pero con un apagado regular, es mejor detener el servicio en sÃ­.  Cuando se detiene, los mensajes se acumularÃ¡n en la cola RabbitMQ, por lo que si se detiene durante un tiempo prolongado, es mejor detener Filebeats en los servidores.  En un esquema donde RabbitMQ no se usa (en la red local, Filebeat envÃ­a registros directamente a Logstash), Filebeats funciona de manera bastante aceptable y segura, por lo que para ellos la inaccesibilidad de la salida no tiene consecuencias. <br><br>  Un ejemplo de configuraciÃ³n es el siguiente: <br><br><div class="spoiler">  <b class="spoiler_title">log_web__filebeat_clickhouse.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/logstash/certs/ca.cer", "/etc/logstash/certs/ca-issuing.cer"] ssl_certificate =&gt; "/etc/logstash/certs/server.cer" ssl_key =&gt; "/etc/logstash/certs/server-pkcs8.key" ssl_verify_mode =&gt; "peer" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } rabbitmq { host =&gt; "queue.domain.com" port =&gt; 5671 user =&gt; "q-reader" password =&gt; "password" queue =&gt; "web_log" heartbeat =&gt; 30 durable =&gt; true ssl =&gt; true <span class="hljs-comment"><span class="hljs-comment">#ssl_certificate_path =&gt; "/etc/logstash/certs/server.p12" #ssl_certificate_password =&gt; "password" add_field =&gt; { "fld_server_name" =&gt; "%{[fields][fld_server_name]}" "fld_app_name" =&gt; "%{[fields][fld_app_name]}" "fld_app_module" =&gt; "%{[fields][fld_app_module]}" "fld_website_name" =&gt; "%{[fields][fld_website_name]}" "fld_log_file_name" =&gt; "%{source}" "fld_logformat" =&gt; "%{[fields][fld_logformat]}" } } } filter { if [message] =~ "^#" { drop {} } if [fld_logformat] == "logformat__iis_with_xrealip" { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken} %{NOTSPACE:xrealIP} %{NOTSPACE:xforwarderfor}"] } } else { grok { match =&gt; ["message", "%{TIMESTAMP_ISO8601:log_timestamp} %{IP:serverIP} %{WORD:method} %{NOTSPACE:uriStem} %{NOTSPACE:uriQuery} %{NUMBER:port} %{NOTSPACE:username} %{IPORHOST:clientIP} %{NOTSPACE:userAgent} %{NOTSPACE:referer} %{NUMBER:response} %{NUMBER:subresponse} %{NUMBER:win32response} %{NUMBER:timetaken}"] } } date { match =&gt; [ "log_timestamp", "YYYY-MM-dd HH:mm:ss" ] timezone =&gt; "Etc/UTC" remove_field =&gt; [ "log_timestamp", "@timestamp" ] target =&gt; [ "log_timestamp2" ] } ruby { code =&gt; "tstamp = event.get('log_timestamp2').to_i event.set('logdatetime', Time.at(tstamp).strftime('%Y-%m-%d %H:%M:%S')) event.set('logdate', Time.at(tstamp).strftime('%Y-%m-%d'))" } if [bytesSent] { ruby { code =&gt; "event['kilobytesSent'] = event['bytesSent'].to_i / 1024.0" } } if [bytesReceived] { ruby { code =&gt; "event['kilobytesReceived'] = event['bytesReceived'].to_i / 1024.0" } } ruby { code =&gt; "event.set('clientRealIP', event.get('clientIP'))" } if [xrealIP] { ruby { code =&gt; "event.set('clientRealIP', event.get('xrealIP'))" } } if [xforwarderfor] { ruby { code =&gt; "event.set('clientRealIP', event.get('xforwarderfor'))" } } mutate { convert =&gt; ["bytesSent", "integer"] convert =&gt; ["bytesReceived", "integer"] convert =&gt; ["timetaken", "integer"] convert =&gt; ["port", "integer"] add_field =&gt; { "clientHostname" =&gt; "%{clientIP}" } } useragent { source=&gt; "useragent" prefix=&gt; "browser" } kv { source =&gt; "uriQuery" prefix =&gt; "uriQuery__" allow_duplicate_values =&gt; false field_split =&gt; "&amp;" include_keys =&gt; [ "utm_medium", "utm_source", "utm_campaign", "utm_term", "utm_content", "yclid", "region" ] } mutate { join =&gt; { "uriQuery__utm_source" =&gt; "," } join =&gt; { "uriQuery__utm_medium" =&gt; "," } join =&gt; { "uriQuery__utm_campaign" =&gt; "," } join =&gt; { "uriQuery__utm_term" =&gt; "," } join =&gt; { "uriQuery__utm_content" =&gt; "," } join =&gt; { "uriQuery__yclid" =&gt; "," } join =&gt; { "uriQuery__region" =&gt; "," } } } output { #stdout {codec =&gt; rubydebug} clickhouse { headers =&gt; ["Authorization", "Basic abcdsfks..."] http_hosts =&gt; ["http://127.0.0.1:8123"] save_dir =&gt; "/etc/logstash/tmp" table =&gt; "log_web" request_tolerance =&gt; 1 flush_size =&gt; 10000 idle_flush_time =&gt; 1 mutations =&gt; { "fld_log_file_name" =&gt; "fld_log_file_name" "fld_server_name" =&gt; "fld_server_name" "fld_app_name" =&gt; "fld_app_name" "fld_app_module" =&gt; "fld_app_module" "fld_website_name" =&gt; "fld_website_name" "logdatetime" =&gt; "logdatetime" "logdate" =&gt; "logdate" "serverIP" =&gt; "serverIP" "method" =&gt; "method" "uriStem" =&gt; "uriStem" "uriQuery" =&gt; "uriQuery" "port" =&gt; "port" "username" =&gt; "username" "clientIP" =&gt; "clientIP" "clientRealIP" =&gt; "clientRealIP" "userAgent" =&gt; "userAgent" "referer" =&gt; "referer" "response" =&gt; "response" "subresponse" =&gt; "subresponse" "win32response" =&gt; "win32response" "timetaken" =&gt; "timetaken" "uriQuery__utm_medium" =&gt; "uriQuery__utm_medium" "uriQuery__utm_source" =&gt; "uriQuery__utm_source" "uriQuery__utm_campaign" =&gt; "uriQuery__utm_campaign" "uriQuery__utm_term" =&gt; "uriQuery__utm_term" "uriQuery__utm_content" =&gt; "uriQuery__utm_content" "uriQuery__yclid" =&gt; "uriQuery__yclid" "uriQuery__region" =&gt; "uriQuery__region" } } }</span></span></code> </pre> <br></div></div><div class="spoiler">  <b class="spoiler_title">pipelines.yml</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment"># This file is where you define your pipelines. You can define multiple. # For more information on multiple pipelines, see the documentation: # https://www.elastic.co/guide/en/logstash/current/multiple-pipelines.html - pipeline.id: log_web__filebeat_clickhouse path.config: "/etc/logstash/log_web__filebeat_clickhouse.conf"</span></span></code> </pre> <br></div></div><br><h4>  ClickHouse.  Almacenamiento de registro </h4><br>  Los registros de todos los sistemas se guardan en una tabla (consulte el comienzo del artÃ­culo).  EstÃ¡ destinado a almacenar informaciÃ³n sobre solicitudes: todos los parÃ¡metros son similares para diferentes formatos, por ejemplo, registros IIS, registros apache y nginx.  Para los registros de aplicaciones en los que, por ejemplo, se registran errores, mensajes informativos, advertencias, se proporcionarÃ¡ una tabla separada con la estructura correspondiente (ahora en la etapa de diseÃ±o). <br><br>  Al diseÃ±ar una tabla, es muy importante determinar la clave primaria (por la cual los datos se ordenarÃ¡n durante el almacenamiento).  El grado de compresiÃ³n de datos y la velocidad de consulta dependen de esto.  En nuestro ejemplo, la clave es <br>  ORDER BY (fld_app_name, fld_app_module, logdatetime) <br>  Es decir, por el nombre del sistema, el nombre del componente del sistema y la fecha del evento.  La fecha original del evento fue en primer lugar.  DespuÃ©s de moverlo al Ãºltimo lugar, las consultas comenzaron a funcionar aproximadamente dos veces mÃ¡s rÃ¡pido.  Cambiar la clave principal requerirÃ¡ volver a crear la tabla y volver a cargar los datos para que ClickHouse vuelva a ordenar los datos en el disco.  Esta es una operaciÃ³n difÃ­cil, por lo que es aconsejable pensar con anticipaciÃ³n quÃ© debe incluirse en la clave de clasificaciÃ³n. <br><br>  TambiÃ©n debe tenerse en cuenta que relativamente en las versiones recientes ha aparecido el tipo de datos LowCardinality  Al usarlo, el tamaÃ±o de los datos comprimidos se reduce drÃ¡sticamente para aquellos campos que tienen baja cardinalidad (pocas opciones). <br><br>  Ahora se usa la versiÃ³n 19.6, y planeamos intentar actualizar la versiÃ³n a la Ãºltima.  Incluyeron caracterÃ­sticas tan maravillosas como Adaptive Granularity, Skipping indices y el cÃ³dec DoubleDelta, por ejemplo. <br><br>  De forma predeterminada, durante la instalaciÃ³n, el nivel de registro de configuraciÃ³n estÃ¡ configurado para rastrear.  Los registros se rotan y archivan, pero se expanden a un gigabyte.  Si no es necesario, puede establecer el nivel de advertencia, luego el tamaÃ±o del registro disminuye drÃ¡sticamente.  La configuraciÃ³n de registro se establece en el archivo config.xml: <br><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- Possible levels: https://github.com/pocoproject/poco/blob/develop/Foundation/include/Poco/Logger. h#L105 --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span>warning<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">level</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Algunos comandos Ãºtiles</b> <div class="spoiler_text"><pre> <code class="sql hljs">      Debian,     Linux      Altinity.           : https://www.altinity.com/blog/2017/12/18/logstash-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-clickhouse sudo yum <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> sudo yum <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> clickhouse-server.noarch <span class="hljs-number"><span class="hljs-number">1.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">2.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> <span class="hljs-number"><span class="hljs-number">3.</span></span>   sudo systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>        (   <span class="hljs-string"><span class="hljs-string">";"</span></span>) clickhouse-<span class="hljs-keyword"><span class="hljs-keyword">client</span></span> <span class="hljs-comment"><span class="hljs-comment">--multiline clickhouse-client --multiline --host 127.0.0.1 --password pa55w0rd clickhouse-client --multiline --host 127.0.0.1 --port 9440 --secure --user default --password pa55w0rd                /tmp/log_web_failed.json            : clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed.json /etc/logstash/tmp/log_web_failed__fixed.json sudo chown user_dev /etc/logstash/tmp/log_web_failed__fixed.json sudo clickhouse-client --host 127.0.0.1 --password password --query="INSERT INTO log_web FORMAT JSONEachRow" &lt; /etc/logstash/tmp/log_web_failed__fixed.json sudo mv /etc/logstash/tmp/log_web_failed__fixed.json /etc/logstash/tmp/log_web_failed__fixed_.json     quit; ##  TLS https://www.altinity.com/blog/2019/3/5/clickhouse-networking-part-2 openssl s_client -connect log.domain.com:9440 &lt; /dev/null</span></span></code> </pre> <br></div></div><br><h4>  LogStash  FileBeat log router a la cola RabbitMQ </h4><br>  Este componente se utiliza para enrutar registros que vienen de FileBeat a la cola RabbitMQ.  Hay dos puntos: <br><br><ol><li>  Desafortunadamente, FileBeat no tiene un complemento de salida para escribir directamente en RabbitMQ.  Y tal funcionalidad, a juzgar por el ish en su github, no estÃ¡ planificada para su implementaciÃ³n.  Hay un complemento para Kafka, pero por alguna razÃ³n no podemos usarlo en casa. </li><li>  Hay requisitos para recopilar registros en la DMZ.  En funciÃ³n de ellos, los registros primero deben agregarse a la cola y luego LogStash desde el exterior lee las entradas de la cola. </li></ol><br>  Por lo tanto, es precisamente para el caso de la ubicaciÃ³n del servidor en la DMZ que debe usar un esquema tan ligeramente complicado.  Un ejemplo de configuraciÃ³n es el siguiente: <br><br><div class="spoiler">  <b class="spoiler_title">iis_w3c_logs__filebeat_rabbitmq.conf</b> <div class="spoiler_text"><pre> <code class="sql hljs">input { beats { port =&gt; 5044 type =&gt; 'iis' ssl =&gt; true ssl_certificate_authorities =&gt; ["/etc/pki/tls/certs/app/ca.pem", "/etc/pki/tls/certs/app/ca-issuing.pem"] ssl_certificate =&gt; "/etc/pki/tls/certs/app/queue.domain.com.cer" ssl_key =&gt; "/etc/pki/tls/certs/app/queue.domain.com-pkcs8.key" ssl_verify_mode =&gt; "peer" } } output { <span class="hljs-comment"><span class="hljs-comment">#stdout {codec =&gt; rubydebug} rabbitmq { host =&gt; "127.0.0.1" port =&gt; 5672 exchange =&gt; "monitor.direct" exchange_type =&gt; "direct" key =&gt; "%{[fields][fld_app_name]}" user =&gt; "q-writer" password =&gt; "password" ssl =&gt; false } }</span></span></code> </pre> <br></div></div><br><h4>  RabbitMQ.  Cola de mensajes </h4><br>  Este componente se utiliza para almacenar las entradas de registro en la DMZ.  La grabaciÃ³n se realiza a travÃ©s de un montÃ³n de Filebeat â†’ LogStash.  La lectura se realiza desde fuera de la DMZ a travÃ©s de LogStash.  Cuando se opera a travÃ©s de RabboitMQ, se procesan aproximadamente 4 mil mensajes por segundo. <br><br>  El enrutamiento de mensajes se configura segÃºn el nombre del sistema, es decir, segÃºn los datos de configuraciÃ³n de FileBeat.  Todos los mensajes caen en una cola.  Si, por alguna razÃ³n, el servicio de cola se detiene, esto no conducirÃ¡ a la pÃ©rdida de mensajes: FileBeats recibirÃ¡ errores de conexiÃ³n y suspenderÃ¡ el envÃ­o temporal.  Y LogStash, que lee desde la cola, tambiÃ©n recibirÃ¡ errores de red y esperarÃ¡ a que se reanude la conexiÃ³n.  Los datos en este caso, por supuesto, ya no se escribirÃ¡n en la base de datos. <br><br>  Las siguientes instrucciones se utilizan para crear y configurar colas: <br><br><pre> <code class="sql hljs">sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin <span class="hljs-keyword"><span class="hljs-keyword">declare</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exchange</span></span> <span class="hljs-comment"><span class="hljs-comment">--vhost=/ name=monitor.direct type=direct sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin declare queue --vhost=/ name=web_log durable=true sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site1.domain.ru" sudo /usr/local/bin/rabbitmqadmin/rabbitmqadmin --vhost="/" declare binding source="monitor.direct" destination_type="queue" destination="web_log" routing_key="site2.domain.ru"</span></span></code> </pre> <br><h4>  Grafana  Tableros </h4><br>  Este componente se utiliza para visualizar datos de monitoreo.  En este caso, debe instalar la fuente de datos ClickHouse para el complemento Grafana 4.6+.  Tuvimos que ajustarlo un poco para aumentar la eficiencia del procesamiento de los filtros SQL en un tablero. <br><br>  Por ejemplo, usamos variables, y si no estÃ¡n establecidas en el campo de filtro, nos gustarÃ­a que no genere una condiciÃ³n en la forma WHERE (uriStem = `` AND uriStem! = '').  En este caso, ClickHouse leerÃ¡ la columna uriStem.  En general, probamos diferentes opciones y finalmente arreglamos el complemento (macro $ valueIfEmpty) para que, en caso de un valor vacÃ­o, devuelva 1, sin mencionar la columna en sÃ­. <br><br>  Y ahora puedes usar esta consulta para el grÃ¡fico <br><br><pre> <code class="sql hljs">$columns(response, count(*) c) from $table where $adhoc and $valueIfEmpty($fld_app_name, 1, fld_app_name = '$fld_app_name') and $valueIfEmpty($fld_app_module, 1, fld_app_module = '$fld_app_module') and $valueIfEmpty($fld_server_name, 1, fld_server_name = '$fld_server_name') and $valueIfEmpty($uriStem, 1, uriStem like '%$uriStem%') and $valueIfEmpty($clientRealIP, 1, clientRealIP = '$clientRealIP')</code> </pre> <br>  que se convierte a dicho SQL (tenga en cuenta que los campos uriStem vacÃ­os se convirtieron a solo 1) <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t, groupArray((response, c)) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> groupArr <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> (intDiv(toUInt32(logdatetime), <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">60</span></span>) * <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> t, response, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> default.log_web <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> (logdate &gt;= toDate(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (logdatetime &gt;= toDateTime(<span class="hljs-number"><span class="hljs-number">1565061982</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_name = <span class="hljs-string"><span class="hljs-string">'site1.domain.ru'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (fld_app_module = <span class="hljs-string"><span class="hljs-string">'web'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t, response <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span>, response <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span></code> </pre> <br><h4>  ConclusiÃ³n </h4><br>  La apariciÃ³n de la base de datos ClickHouse se ha convertido en un evento histÃ³rico en el mercado.  Era difÃ­cil imaginar que de forma gratuita en un instante, estuviÃ©ramos armados con una herramienta poderosa y prÃ¡ctica para trabajar con big data.  Por supuesto, con las crecientes necesidades (por ejemplo, fragmentaciÃ³n y replicaciÃ³n en mÃºltiples servidores), el esquema se volverÃ¡ mÃ¡s complejo.  Pero a primera vista, trabajar con esta base de datos es muy bueno.  Se puede ver que el producto estÃ¡ hecho "para personas". <br><br>  En comparaciÃ³n con ElasticSearch, el costo de almacenar y procesar registros, segÃºn estimaciones preliminares, se reduce de cinco a diez veces.  En otras palabras, si para la cantidad actual de datos tendrÃ­amos que configurar un clÃºster de varias mÃ¡quinas, cuando usemos ClickHouse solo necesitamos una mÃ¡quina de bajo consumo.  SÃ­, por supuesto, ElasticSearch tambiÃ©n tiene mecanismos para comprimir datos en el disco y otras caracterÃ­sticas que pueden reducir significativamente el consumo de recursos, pero en comparaciÃ³n con ClickHouse, esto serÃ¡ costoso. <br><br>  Sin ninguna optimizaciÃ³n especial por su parte, en la configuraciÃ³n predeterminada, cargar datos y recuperar datos de la base de datos funciona a una velocidad sorprendente.  Hasta ahora tenemos algunos datos (alrededor de 200 millones de registros), pero el servidor en sÃ­ es dÃ©bil.  En el futuro, podemos usar esta herramienta para otros fines no relacionados con el almacenamiento de registros.  Por ejemplo, para anÃ¡lisis de extremo a extremo, en el campo de la seguridad, el aprendizaje automÃ¡tico. <br><br>  Al final, un poco sobre los pros y los contras. <br><br><h4>  Contras </h4><br><ol><li>  Descarga de registros en grandes paquetes.  Esto, por un lado, es una caracterÃ­stica, pero aÃºn debe usar componentes adicionales para almacenar registros.  Esta tarea no siempre es simple, pero aÃºn tiene soluciÃ³n.  Y me gustarÃ­a simplificar el esquema. </li><li>  Algunas funciones exÃ³ticas o nuevas caracterÃ­sticas a menudo se rompen en nuevas versiones.  Esto plantea preocupaciones, reduciendo el deseo de actualizar a una nueva versiÃ³n.  Por ejemplo, el motor de tabla Kafka es una caracterÃ­stica muy Ãºtil que le permite leer directamente eventos de Kafka, sin la implementaciÃ³n de los consumidores.  Pero a juzgar por la cantidad de problemas en el github, aÃºn desconfiamos de usar este motor en la producciÃ³n.  Sin embargo, si no realiza movimientos bruscos hacia un lado y utiliza la funcionalidad bÃ¡sica, entonces funciona de manera estable. </li></ol><br><h4>  Pros </h4><br><ol><li>  No se ralentiza. </li><li>  Umbral de entrada bajo. </li><li>  CÃ³digo abierto </li><li>  Es gratis </li><li>  Escala bien (fragmentaciÃ³n / replicaciÃ³n de fÃ¡brica) </li><li>  EstÃ¡ incluido en el registro de software ruso recomendado por el Ministerio de Comunicaciones. </li><li>  La presencia de apoyo oficial de Yandex. </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/472912/">https://habr.com/ru/post/472912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../472896/index.html">HelicÃ³ptero desde una impresora: por primera vez, los cientÃ­ficos "imprimieron" una caja de gran tamaÃ±o de un motor de helicÃ³ptero</a></li>
<li><a href="../472902/index.html">Windows para IoT: soporte de hardware mejorado y nuevas caracterÃ­sticas de dispositivos inteligentes</a></li>
<li><a href="../472904/index.html">CÃ³mo Amazon convirtiÃ³ las acciones en un juego</a></li>
<li><a href="../472908/index.html">Dagaz: Episodios (Parte 2)</a></li>
<li><a href="../472910/index.html">Encuentra texto en carteles y paquetes usando un telÃ©fono inteligente</a></li>
<li><a href="../472914/index.html">Wolfram Function Repository: plataforma de acceso abierto para extensiones de lenguaje Wolfram</a></li>
<li><a href="../472916/index.html">Backend, machine learning y serverless son los mÃ¡s interesantes de la conferencia de julio Habr</a></li>
<li><a href="../472918/index.html">ZX Spectrum en Rusia y la CEI: cÃ³mo se transformÃ³ la bÃºsqueda en lÃ­nea fuera de lÃ­nea</a></li>
<li><a href="../472922/index.html">Programador defensor mÃ¡s fuerte que la entropÃ­a</a></li>
<li><a href="../472926/index.html">La ley de los retornos acelerados (parte 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>