<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚ÄçüöÄ üëêüèø üñ•Ô∏è Descripci√≥n general de IPSec en Mikrotik üë©üèø‚Äçüî¨ üôè ‚òÄÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="IPSec (seguridad IP): un conjunto de protocolos y algoritmos para cifrar datos en redes IPv4 e IPv6. No parece complicado, pero IPSec no establece reg...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Descripci√≥n general de IPSec en Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438176/"><p>  IPSec (seguridad IP): un conjunto de protocolos y algoritmos para cifrar datos en redes IPv4 e IPv6.  No parece complicado, pero IPSec no establece reglas claras para cifrar el tr√°fico; en cambio, los desarrolladores implementan un conjunto de herramientas (protocolos y algoritmos), mediante los cuales el administrador crea un canal seguro para los datos. </p><br><p>  Quiero tocar IPSec en RouterOS un poco m√°s profundo que un simple C√ìMO, con una teor√≠a m√≠nima y ejemplos sobre c√≥mo configurar y depurar IPSec.  Esto no es una gu√≠a, y sin pr√°ctica en un banco de pruebas, no se recomienda comenzar a configurar t√∫neles reales y servidores VPN. </p><a name="habracut"></a><br><h3 id="preimuschestva-i-nedostatki-ipsec">  Ventajas y desventajas de IPSec </h3><br><p>  Fortalezas: </p><br><ul><li>  Funciona a nivel de red del modelo OSI </li><li>  Puede encriptar el paquete fuente completamente o desde la capa de transporte y superior </li><li>  Hay un mecanismo para superar NAT </li><li>  Una amplia gama de algoritmos de cifrado y hash de tr√°fico para elegir </li><li>  IPSec: un conjunto de est√°ndares abiertos y extensibles </li><li>  En el caso de Mikrotik, no requiere la compra de tarifas o licencias adicionales </li></ul><br><p>  Debilidades: </p><br><ul><li>  Dificultad </li><li>  Diferentes herramientas de terminolog√≠a y configuraci√≥n para diferentes proveedores. </li><li>  El uso de algoritmos de cifrado fuertes requiere una buena potencia inform√°tica. </li><li>  DPI f√°cil de detectar </li></ul><br><h3 id="protokoly-v-sostave-ipsec">  Protocolos en IPSec </h3><br><p><img src="https://habrastorage.org/webt/nd/k6/0m/ndk60mwkllka7jpnl2flzdqt8ce.png"></p><br><p>  A nivel mundial, todos los protocolos que abordar√° durante la configuraci√≥n se pueden dividir en dos grupos: protocolos de intercambio de claves y protocolos de protecci√≥n de datos. </p><br><p>  <strong>Protocolos de intercambio de claves (IKE)</strong> <br>  La tarea principal es autenticar a los participantes en la conexi√≥n y acordar los par√°metros y claves de cifrado para proteger la informaci√≥n transmitida. </p><br><ul><li>  IKE (Intercambio de claves de Internet): definido en 1998.  Muchas caracter√≠sticas (por ejemplo, bridging NAT) se agregaron m√°s tarde como complementos y es posible que no se implementen con varios proveedores.  La base para la negociaci√≥n clave es ISAKMP. </li><li>  IKEv2 (Internet Key Exchange versi√≥n 2) - √∫ltima revisi√≥n de 2014.  Es un desarrollo del protocolo IKE, en el que se resolvieron algunos problemas, se simplific√≥ el mecanismo de acuerdo clave y las extensiones (NAT-T, Keepalives, Mode Config) se convirtieron en parte del protocolo. </li></ul><br><p>  En la pr√°ctica, la mayor√≠a de las conexiones IPSec se implementan utilizando IKE debido a equipos obsoletos o la renuencia de los administradores a cambiar algo. </p><br><p>  <strong>Protocolos de protecci√≥n de datos (ESP, AH)</strong> <br>  La tarea principal es proteger los datos del usuario. </p><br><ul><li>  ESP (Carga de seguridad de encapsulaci√≥n): cifra y autentica parcialmente los datos transmitidos </li><li>  AH (Encabezado de autenticaci√≥n): autentica todo el paquete (excepto los campos mutables), no cifra los datos, pero le permite asegurarse de que el paquete no se modific√≥ durante la transmisi√≥n a trav√©s de la red </li></ul><br><h3 id="poryadok-ustanovki-ipsec-soedineniya">  Procedimiento de instalaci√≥n de la conexi√≥n IPSec </h3><br><p><img src="https://habrastorage.org/webt/lu/rv/ps/lurvpsvrdub2tcgkmpx8ut5ep58.png"></p><br><p>  Los participantes de una conexi√≥n IPSec generalmente se llaman pares, lo que indica su equivalencia en la conexi√≥n establecida.  Es posible una configuraci√≥n cercana al cliente-servidor, pero al construir t√∫neles IPSec permanentes, cualquiera de los pares puede ser un inicializador. </p><br><ol><li>  Uno de los pares inicia una conexi√≥n IPSec </li><li>  Existe un intercambio de informaci√≥n clave, autenticaci√≥n de pares, coordinaci√≥n de par√°metros de conexi√≥n. </li><li>  Seg√∫n la informaci√≥n clave recibida, se forma un t√∫nel cifrado auxiliar </li><li>  Usando un t√∫nel encriptado, los pares determinan los par√°metros de encriptaci√≥n de datos e intercambian informaci√≥n para generar claves </li><li>  El resultado de la fase anterior es un conjunto de reglas y claves para la protecci√≥n de datos (SA) </li><li>  Peri√≥dicamente, los pares actualizan las claves de cifrado </li></ol><br><p>  Uno de los conceptos clave en IPSec es SA (Asociaci√≥n de seguridad), un conjunto de algoritmos de cifrado para cifrar y cifrar informaci√≥n, as√≠ como claves de cifrado, acordadas por pares. </p><br><p>  A veces puedes encontrar una divisi√≥n en: </p><br><ul><li>  ISAKMP SA - par√°metros y claves relacionadas con el t√∫nel auxiliar </li><li>  Data SA (o simplemente SA): par√°metros y claves relacionadas con el cifrado de tr√°fico </li></ul><br><h3 id="poryadok-raboty-protokolov-soglasovaniya-klyuchey">  Protocolos de acuerdo clave </h3><br><p>  El protocolo IKE puede funcionar en dos modos: principal (principal) y agresivo (agresivo), el protocolo IKEv2 contiene un modo. </p><br><h4 id="ike-main">  IKE Main </h4><br><p><img src="https://habrastorage.org/webt/zw/jb/yv/zwjbyvrpmup5t7nfgaol329rudi.png"></p><br><p>  La primera fase consta de seis paquetes: <br>  1-2: Alineaci√≥n de la configuraci√≥n de cifrado del t√∫nel secundario y varias opciones de IPSec <br>  3-4: Compartir informaci√≥n para generar una clave secreta <br>  5-6: Autenticaci√≥n entre pares mediante el canal cifrado auxiliar </p><br><p>  La segunda fase consta de tres paquetes: <br>  1-3: Uso de un canal auxiliar encriptado.  Coordinaci√≥n de los par√°metros de protecci√≥n del tr√°fico, intercambio de informaci√≥n para generar una clave secreta. </p><br><h3 id="ike-aggressive">  IKE agresivo </h3><br><p><img src="https://habrastorage.org/webt/xu/wz/qu/xuwzqu4qle5lxlcvb-hnvuhqehg.png"></p><br><p>  La primera fase consta de tres paquetes: <br>  1: Enviar una oferta para instalar un canal encriptado auxiliar e informaci√≥n para generar una clave privada <br>  2: Respuesta a la oferta, informaci√≥n para generar la clave secreta, datos para autenticaci√≥n <br>  3: datos de autenticaci√≥n </p><br><p>  La segunda fase consta de tres paquetes: <br>  1-3: Uso de un canal auxiliar encriptado.  Coordinaci√≥n de los par√°metros de protecci√≥n del tr√°fico, intercambio de informaci√≥n para generar una clave secreta. </p><br><p>  En modo agresivo, el iniciador env√≠a solo un conjunto de par√°metros en la oraci√≥n.  El intercambio de informaci√≥n para la autenticaci√≥n entre pares ocurre antes de la instalaci√≥n de un t√∫nel auxiliar seguro.  El modo agresivo es consistente m√°s r√°pido, pero menos seguro. </p><br><h3 id="ikev2">  IKEv2 </h3><br><p><img src="https://habrastorage.org/webt/ev/mq/ni/evmqnimq5_sdeybuz63x3ddssbu.png"></p><br><p>  En IKEv2, las fases se denominan: IKE_SA_INIT e IKE_AUTH.  <em>Pero si me refiero a Phase1 y Phase2 m√°s adelante en el texto, esto tambi√©n se aplica a las fases de IKEv2.</em> </p><br><p>  Cada fase de IKEv2 consta de dos paquetes: <br>  IKE_SA_INIT: Coordinaci√≥n de par√°metros de cifrado de t√∫nel auxiliar, intercambio de informaci√≥n para generar una clave privada </p><br><p>  IKE_AUTH: utilizando el canal auxiliar encriptado.  Autenticaci√≥n de pares, coordinaci√≥n de par√°metros de protecci√≥n de tr√°fico, intercambio de informaci√≥n para generar una clave secreta </p><br><h3 id="security-assotiations-database-sad">  Base de datos de negociaciones de seguridad (SAD) </h3><br><p>  El resultado de IKE (e IKEv2) son las Asignaciones de seguridad (SA), que definen la configuraci√≥n de protecci√≥n del tr√°fico y las claves de cifrado.  Cada SA es unidireccional y la conexi√≥n IPSec contiene un par de SA.  Todos los SA se almacenan en la base de datos SAD y el administrador puede acceder a ellos para verlos y restablecerlos. </p><br><h3 id="inkapsulyaciya-dannyh">  Encapsulaci√≥n de datos </h3><br><p><img src="https://habrastorage.org/webt/3z/3k/aa/3z3kaaj2rwmnx59apvueigp3lno.png"></p><br><p>  IPSec proporciona dos opciones para encapsular datos: </p><br><ul><li>  Modo de transporte: solo la carga √∫til del paquete est√° protegida, dejando el encabezado original.  Para construir t√∫neles, el modo de transporte generalmente se usa junto con ipip o gre, cuya carga √∫til ya contiene todo el paquete fuente. </li><li>  Modo de t√∫nel: encapsula completamente el paquete original en uno nuevo (similar a gre o ipip).  Pero para el t√∫nel ipsec, no se crea una interfaz expl√≠cita en el sistema, esto puede ser un problema si se utiliza un enrutamiento est√°tico din√°mico o complejo. </li></ul><br><h3 id="security-policy-database-spd">  Base de datos de pol√≠ticas de seguridad (SPD) </h3><br><p>  Una base de datos de reglas que determinan qu√© tr√°fico se debe cifrar, el protocolo de protecci√≥n de datos, el tipo de encapsulaci√≥n y una serie de otros par√°metros. <br>  La posici√≥n de verificaci√≥n de SPD se puede mostrar en el diagrama de flujo de paquetes. </p><br><p><img src="https://habrastorage.org/webt/nh/jo/rm/nhjorm-je866yymx0_cxwdnyop8.png"></p><br><h3 id="preodolenie-nat">  Puente NAT </h3><br><p>  IPSec utiliza protocolos de capa de red para transferir datos que NAT no puede manejar.  Para resolver el problema, se utiliza el protocolo NAT-T (una extensi√≥n en IKE y parte de IKEv2).  La esencia de NAT-T est√° en la encapsulaci√≥n adicional de paquetes IPSec en paquetes UDP que procesa NAT. </p><br><h3 id="ipsec-v-mikrotik">  IPSec en Mikrotik </h3><br><p>  IPSec est√° disponible de forma gratuita en cualquier dispositivo que ejecute RouterOS con el paquete de seguridad instalado. </p><br><h3 id="apparatnoe-shifrovanie">  Cifrado de hardware </h3><br><p>  Para descargar la CPU, se agrega aceleraci√≥n de hardware de cifrado a algunos modelos de enrutadores MikroTik; se puede encontrar una lista completa <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en la wiki</a> . <br>  La mayor√≠a de las opciones de presupuesto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RB750Gr3</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">RB3011</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HAP AC ^ 2</a> . </p><br><p>  Por mi cuenta, verifiqu√© la velocidad de IPSec entre dos RB1100AHx2 y entre dos RB750Gr3. </p><br><p>  Para lograr los m√°ximos resultados en RB1100AHx2 debe: </p><br><ul><li>  Use el puerto 11 conectado directamente a la CPU y configure un n√∫cleo de CPU para manejar el tr√°fico de 11 puertos </li><li>  Use solo colas de hardware en las interfaces, deshabilite RPS </li><li>  Habilite Layer3 FastPath (aproximadamente 800 mb / s) o excluya el tr√°fico IPSec del conntrack (aproximadamente 700 mb / s) <br>  Sin las manipulaciones descritas en el puerto m√°s lento (ether13), es posible obtener ~ 170Mb / seg, en los ~ 400Mb / seg habituales. </li></ul><br><p>  En RB750Gr3 sin optimizaciones de aproximadamente 200Mb / seg. </p><br><p>  Los enrutadores de un solo n√∫cleo de Qualcomm muestran un resultado de 10-40 mb / s seg√∫n el modelo, las optimizaciones y la carga de trabajo de otros procesos. </p><br><p>  Le recomiendo que se familiarice con la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">presentaci√≥n</a> del empleado de mikrotik, se refirieron a temas de optimizaci√≥n de configuraciones para reducir la carga en la CPU y aumentar la velocidad, que no agregu√© al texto. </p><br><h3 id="razlichiya-642x-i-643x">  Diferencias 6.42.X y 6.43.X </h3><br><p>  Dependiendo de la versi√≥n de RouterOS que est√© utilizando, el men√∫ de configuraci√≥n de IPSec variar√°. </p><br><p><img src="https://habrastorage.org/webt/6q/pz/5c/6qpz5cgthate04bihl8gq2zr9t8.png"></p><br><p><img src="https://habrastorage.org/webt/ng/ug/hi/ngughirhx6nwd1v8mjaa9omfb7g.png"></p><br><p><img src="https://habrastorage.org/webt/kv/ow/3-/kvow3-bmivzfr_tf6bqnywr5wu8.png"></p><br><p>  Ya hay nuevos cambios en la versi√≥n de prueba, as√≠ que lea las Notas de la versi√≥n antes de actualizar. </p><br><p><img src="https://habrastorage.org/webt/ri/rd/gu/rirdgucrebbf1ucxjqbj65gzf-s.png"></p><br><h3 id="konfiguraciya-ipsec">  Configuraci√≥n de IPsec </h3><br><p><img src="https://habrastorage.org/webt/r6/lf/j5/r6lfj5hlclkbx9qmph0owsqf_ak.png"><br>  El men√∫ [IP] -&gt; [IPSec] no da tanto miedo como parece a primera vista.  El diagrama muestra que los principales elementos de configuraci√≥n son: Pares y perfiles. <br>  Las pesta√±as Remote Peers y SA instaladas son informativas. </p><br><h4 id="peers-i-peers-profiles">  Pares y perfiles de pares </h4><br><p>  Configuraci√≥n de pares IPSec para establecer una conexi√≥n IKE y crear un t√∫nel seguro auxiliar. </p><br><p><img src="https://habrastorage.org/webt/e2/kj/e1/e2kje1zwzhubqsyriypavj3bmfm.png" alt="imagen"></p><br><p>  <strong>Configurar pares remotos IPSec</strong> </p><br><p><img src="https://habrastorage.org/webt/pq/9d/cv/pq9dcvyqrf64pdklohgf1eapoze.png"></p><br><div class="spoiler">  <b class="spoiler_title">Notas</b> <div class="spoiler_text"><ul><li>  A partir de 6.43, RouterOS jura cuando usa el PSK sin autenticaci√≥n adicional.  Si no desea configurar adicionalmente claves, certificados o xAuth, puede cambiar a IKEv2 o ignorar la advertencia. </li><li>  Como pares, puede especificar IP o subredes espec√≠ficas (relevantes para VPN de cliente-servidor) </li><li>  Si hay reglas en conflicto, se usar√° una regla con una subred m√°s precisa para conectarse al igual (similar a las rutas) </li><li>  La autenticaci√≥n de claves XAuth y rsa no funciona en IKEv2 </li><li>  Para IKEv2, Mikrotik hizo su implementaci√≥n de xAuth incompatible con otras plataformas </li><li>  El modo pasivo generalmente se usa para crear una VPN cliente-servidor (configuraci√≥n de modo L2TP / IPsec o IKEv2), pero puede ser √∫til cuando se conecta una gran cantidad de t√∫neles de sitio a sitio a un solo punto, para reducir el tr√°fico espurio. </li><li>  Si planea usar xAuth, entonces el "servidor" debe ser pasivo.  Los usuarios para el servidor se crean en [IPSec] -&gt; [Usuarios] </li><li>  Cuando use la pol√≠tica Generate, seleccione el modo de puerto estricto </li></ul></div></div><br><p>  <strong>Configuraci√≥n de perfiles (Propuestas) para la armonizaci√≥n Fase 1</strong> </p><br><p><img src="https://habrastorage.org/webt/w8/s9/vj/w8s9vjxiguir63a_hfpci1ih1bi.png" alt="imagen"></p><br><p><img src="https://habrastorage.org/webt/_v/x3/ff/_vx3ff1ogwsxjggebdjqazfqhve.png"></p><br><div class="spoiler">  <b class="spoiler_title">Notas</b> <div class="spoiler_text"><ul><li>  Las opciones adicionales para IKE se convierten en parte de IKEv2, la configuraci√≥n se ignora </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Correlaci√≥n de grupos DH con sus n√∫meros</a> (los n√∫meros de grupo son utilizados por otros proveedores) </li><li>  Al enviar propuestas, el sistema ordena el algoritmo de pares + grupo dh de m√°s persistente a menos persistente <br><img src="https://habrastorage.org/webt/7i/h8/fj/7ih8fjegurxodmq-daxuwxfhpii.png"></li></ul></div></div><br><h4 id="policies-i-policy-proposals">  Pol√≠ticas y propuestas de pol√≠ticas </h4><br><p>  Los pol√≠ticos verifican el cumplimiento de las condiciones de los paquetes aprobados y aplican las acciones especificadas.  Si vuelve al flujo de paquetes, los bloques con la Pol√≠tica IPSec son la reconciliaci√≥n con las pol√≠ticas.  Las acciones especifican: protocolo de seguridad IPSec (ESP o AH), propuestas para negociaci√≥n de SA, modo de encapsulaci√≥n. <br><img src="https://habrastorage.org/webt/tp/bk/1n/tpbk1nrkowlvaqdnrfvgpvbaxg0.png" alt="imagen"></p><br><p>  El paquete pasa la pol√≠tica uno por uno hasta que coincida con las condiciones de uno de ellos. </p><br><p>  <strong>Establecimiento de pol√≠ticas</strong> <br><img src="https://habrastorage.org/webt/yw/cp/nj/ywcpnjdyjonrxpnfel79irfov4g.png"></p><br><div class="spoiler">  <b class="spoiler_title">Anotaciones</b> <div class="spoiler_text"><ul><li>  Por lo general, no se requiere Src espec√≠fico.  y Dst.  Puerto, pero en general, la capacidad de cifrar el tr√°fico de una aplicaci√≥n individual es interesante </li><li>  No todos los protocolos ip se presentan en la lista de Protocolos (por ejemplo, no hay gre), puede especificar el n√∫mero del protocolo requerido manualmente. </li><li>  ¬°Las plantillas no son pol√≠ticas!  Se usan si la pol√≠tica de generaci√≥n se establece en la configuraci√≥n de igual. </li><li>  Qu√© hacer si no se encuentran SA espec√≠ficas para una pol√≠tica.  Anteriormente, hab√≠a un problema con L2TP / IPSec cuando varios clientes no pod√≠an conectarse debido a la misma NAT (cuando se usa IKE), este error se resuelve (suponiendo que estos clientes no son ventanas) si establece level = unique.  De lo contrario, cambie a IKEv2 </li><li>  Al configurar pol√≠ticas, use [Modo seguro], un movimiento inc√≥modo y corre el riesgo de perder el acceso al enrutador con Level3 </li></ul></div></div><br><p>  <strong>Configurar propuestas para aprobaci√≥n de SA</strong> <br><img src="https://habrastorage.org/webt/mh/yf/cd/mhyfcd2-2nsxbouuxhgbecj3kyu.png"></p><br><p><img src="https://habrastorage.org/webt/0n/xk/tw/0nxktwxmxyu2quyanfw-rco-yqa.png"></p><br><h4 id="groups">  Grupos </h4><br><p>  Se utiliza para asociar plantillas de pol√≠ticas y pares. </p><br><p><img src="https://habrastorage.org/webt/do/r7/gc/dor7gc6s4zuwlo2mmz5irrc3alm.png" alt="imagen"></p><br><p>  En una de las versiones anteriores de RouterOS, hab√≠a un error con el grupo predeterminado que no funcionaba. </p><br><h4 id="mode-config">  Configuraci√≥n de modo </h4><br><p>  Enviar y recibir par√°metros IP sin utilizar protocolos adicionales.  Le permite crear una VPN de cliente a servidor aut√≥noma solo IPSec. </p><br><p><img src="https://habrastorage.org/webt/sr/s2/dl/srs2dl4tcpixxiwi2mrletlguva.png"></p><br><p><img src="https://habrastorage.org/webt/os/r2/gg/osr2ggrnm_0-vqtoukxb5hnzfjs.png"></p><br><h4 id="keys-i-users">  Claves y usuarios </h4><br><p>  Se usa para la autenticaci√≥n avanzada por pares. <br>  <strong>Llaves</strong> <br>  Claves RSA: generaci√≥n, importaci√≥n, exportaci√≥n.  No es compatible con IKEv2. </p><br><p><img src="https://habrastorage.org/webt/ec/7z/j4/ec7zj4doiqkdgwe4soh7lrk21f8.png"></p><br><p>  <strong>Los usuarios</strong> <br>  Base de datos de usuarios de XAuth para el "servidor".  El cliente especifica la configuraci√≥n de xAuth en la configuraci√≥n de igual.  Es posible reenviar la autenticaci√≥n xAuth a un servidor RADIUS. </p><br><p><img src="https://habrastorage.org/webt/pi/wl/vq/piwlvq80v1cnndmhyjg91jzrqle.png"></p><br><h4 id="remote-peers">  Compa√±eros remotos </h4><br><p>  Lista de todos los pares que instalan e instalan un t√∫nel auxiliar (Fase 1).  Puede eliminar pares para actualizar las claves del t√∫nel auxiliar. </p><br><p><img src="https://habrastorage.org/webt/j2/-g/ct/j2-gct_8wrf7bl2zgtzqsswwbgk.png" alt="imagen"></p><br><p><img src="https://habrastorage.org/webt/2k/37/3m/2k373mg8qxox4y-ruph-jza_d0m.png" alt="imagen"></p><br><h4 id="installed-sas">  SA instaladas </h4><br><p>  Base de datos SAD o una lista de todas las SA negociadas.  Puede ver los algoritmos y claves de protecci√≥n de datos utilizados. </p><br><p><img src="https://habrastorage.org/webt/jw/jb/su/jwjbsuorsms85vw656xfgvcneuc.png" alt="imagen"></p><br><p><img src="https://habrastorage.org/webt/wd/8x/gr/wd8xgrc-h0ngxcfq77qun4ymuhk.png" alt="imagen"></p><br><p>  El indicador AEAD de hardware indica el uso de cifrado de hardware. </p><br><p><img src="https://habrastorage.org/webt/jz/5-/yv/jz5-yv-xaw_a8gx5zrxz1hlesye.png" alt="imagen"></p><br><p>  Un administrador puede restablecer SA, pero solo todos del mismo tipo (esp o ah) al mismo tiempo. </p><br><h4 id="ipsec-i-firewall">  IPSec y firewall </h4><br><p>  En Firewall, puede verificar si el tr√°fico es una pol√≠tica IPSec entrante o saliente o no.  Una aplicaci√≥n obvia es L2TP / IPSec, puede prohibir la instalaci√≥n de conexiones L2TP si el tr√°fico no se ha cifrado previamente. </p><br><p><img src="https://habrastorage.org/webt/xt/06/sw/xt06swif3vlsv_vjcyywb1lepf0.png"></p><br><p>  <strong>Protocolos y puertos utilizados en IPSec</strong> </p><br><ul><li>  IKE - UDP: 500 </li><li>  IKEv2 - UDP: 4500 </li><li>  NAT-T - UDP: 4500 </li><li>  ESP - ipsec-esp (50) </li><li>  AH - ipsec-ah (51) </li></ul><br><h3 id="ipsec-i-endpoinds">  IPSec y Endpoinds </h3><br><p>  Y ahora sobre el dolor ... <br>  El wiki mikrotik tiene tablas con algoritmos de cifrado y hashing para: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Windows</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">iOS</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">OS-X</a> . </p><br><p>  No encontr√© informaci√≥n sobre el cliente vpn de Android incorporado, pero en general funciona con propuestas de Windows.  No hay soporte IKEv2 en Android, debe usar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">StrongSwan</a> . </p><br><h3 id="primery-konfiguracii">  Ejemplos de configuraci√≥n </h3><br><p>  Esquema y configuraci√≥n b√°sica para ejemplos con t√∫neles de sitio a sitio: </p><br><p><img src="https://habrastorage.org/webt/bn/a7/xu/bna7xud0pazv4ipia2k0083wqom.png"></p><br><pre><code class="plaintext hljs">#Mikrotik1 /ip address add address=10.10.10.10/24 interface=ether1 network=10.10.10.0 add address=192.168.100.1/24 interface=ether2 network=192.168.100.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.10.10.1 dst-address=0.0.0.0/0 #Mikrotik2 /ip address add address=10.20.20.20/24 interface=ether1 network=10.20.20.0 add address=192.168.200.1/24 interface=ether2 network=192.168.200.0 /ip firewall nat add action=masquerade chain=srcnat out-interface=ether1 /ip route add distance=1 gateway=10.20.20.1 dst-address=0.0.0.0/0</code> </pre> <br><h4 id="ipsec-v-tunnelnom-rezhime">  IPSec en modo t√∫nel </h4><br><p><img src="https://habrastorage.org/webt/wy/cg/ad/wycgadjksxuyftckhoctoxciub4.png"></p><br><p>  Configuraci√≥n paso a paso: </p><br><ol><li>  Crear propuestas para IKE Phase1 </li><li>  Crea una fiesta.  Indicamos la direcci√≥n, propuestas, modo de intercambio, clave PSK.  Eleg√≠ IKEv2, puedes usar main / agresivo como lo desees </li><li>  Crear propuestas para SA </li><li>  Especifique las subredes entre las que creamos el t√∫nel. </li><li>  Especifique las direcciones SA, el modo de t√∫nel y las propuestas para el cifrado del tr√°fico. </li><li>  Edici√≥n de la regla NAT </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/c2/tg/at/c2tgatfqb3bgw5qer0u6lvi_jt0.png"></a> </p><br><p>  Opci√≥n de consola: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=192.168.200.0/24 proposal=ipsec-tunnel-sa sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10 src-address=192.168.100.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/je/5y/gq/je5ygqbnhfjklyqxu8pg1kf2saq.png"></a> </p><br><p>  Opci√≥n de consola: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=192.168.100.0/24 proposal=tets-ipsec-sa sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20 src-address=192.168.200.0/24 tunnel=yes #6 /ip firewall nat set 0 ipsec-policy=out,none</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">¬øY aqu√≠ NAT?</b> <div class="spoiler_text"><p>  Para trabajar en modo t√∫nel, necesita una ruta falsa a la subred remota, o una ruta predeterminada, de lo contrario los paquetes no ir√°n m√°s all√° de la decisi√≥n de Enrutamiento.  Con la primera opci√≥n, generalmente no hay problemas, pero con la ruta predeterminada y el NAT de origen (el primero y el segundo est√°n presentes en la gran mayor√≠a de los enrutadores dom√©sticos y de oficina) habr√° problemas. </p><br><p>  Recuperar flujo de paquetes.  Los paquetes pasan por Source NAT antes que las pol√≠ticas de IPSec, la regla con enmascarado no sabe nada de que el tr√°fico est√° destinado a ser enviado al t√∫nel "ef√≠mero" y transmitir√° los encabezados de paquetes para ser enviados a IPSec cuando el paquete con el encabezado modificado se verifica en la direcci√≥n de origen de las Pol√≠ticas en el encabezado no se ajustar√° a la regla y el paquete volar√° a la ruta predeterminada, que, habiendo visto la direcci√≥n de destino desde la red privada, lo m√°s probable es que lo descarte. </p><br><p>  Hay varias soluciones al problema: </p><br><ul><li>  Usando ruta falsa </li><li>  Usar una regla de aceptaci√≥n opcional antes de SourceNAT </li><li>  Sujete src-nat solo a aquellos paquetes para los que no hay pol√≠ticas IPSec (en el ejemplo) </li><li>  Excluir el tr√°fico del seguimiento de la conexi√≥n con RAW </li></ul></div></div><br><p>  <strong>Verificar la conexi√≥n establecida</strong> <br><img src="https://habrastorage.org/webt/no/xd/cn/noxdcnqrsbftj6mfsxlmpruizmq.png" alt="imagen"></p><br><ol><li>  Vemos a un vecino en Compa√±eros remotos </li><li>  Vemos el SA instalado (los contadores de tr√°fico no cambiar√°n hasta que lo inicie) </li><li>  En pol√≠tica, estado establecido y bandera (A) ctive </li></ol><br><h4 id="ipipipsec">  IPIP / IPSec </h4><br><p><img src="https://habrastorage.org/webt/2b/hy/1d/2bhy1d1tnwd57iyppymvb8dbkww.png"></p><br><p>  T√∫nel IPIP preestablecido: </p><br><pre> <code class="plaintext hljs">#Mikrotik1 #  ipip /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.20.20.20 # ip   ipip  /ip address add address=10.30.30.1/30 interface=ipip-vpn #     /ip route add distance=1 dst-address=192.168.200.0/24 gateway=10.30.30.2 #Mikrotik2 # ,      /interface ipip add allow-fast-path=no clamp-tcp-mss=no name=ipip-vpn remote-address=10.10.10.10 /ip address add address=10.30.30.2/30 interface=ipip-vpn /ip route add distance=1 dst-address=192.168.100.0/24 gateway=10.30.30.1</code> </pre> <br><p>  Configuraci√≥n paso a paso de IPSec: </p><br><ol><li>  Crear propuestas para IKE Phase1 </li><li>  Crea una fiesta.  Indique la direcci√≥n, propuestas, modo de intercambio, clave PSK </li><li>  Crear propuestas para SA </li><li>  Especifique las subredes entre las que creamos el t√∫nel. </li><li>  Especificamos las direcciones de SA, el tipo de tr√°fico que encriptaremos y las propuestas. </li></ol><br><div class="spoiler">  <b class="spoiler_title">Mikrotik1</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/5e/mf/_w/5emf_wcxb3ulnjv3fykuino9stg.png"></a> </p><br><p>  Opci√≥n de consola: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.20.20.20/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=ipsec-tunnel-sa #4-5 /ip ipsec policy add dst-address=10.20.20.20/32 proposal=ipsec-tunnel-sa protocol=ipencap src-address=10.10.10.10/32 sa-dst-address=10.20.20.20 sa-src-address=10.10.10.10</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Mikrotik2</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/9o/dk/oy/9odkoy8krqem4mck9rkfibhm220.png"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec peer profile add dh-group=modp2048 enc-algorithm=aes-128 hash-algorithm=sha256 name=ipsec-tunnel-ike nat-traversal=no #2 /ip ipsec peer add address=10.10.10.10/32 exchange-mode=ike2 profile=ipsec-tunnel-ike secret=test-ipsec #3 /ip ipsec proposal add auth-algorithms=sha256 enc-algorithms=aes-256-cbc name=tets-ipsec-sa #4-5 /ip ipsec policy add dst-address=10.10.10.10/32 proposal=tets-ipsec-sa protocol=ipencap src-address=10.20.20.20/32 sa-dst-address=10.10.10.10 sa-src-address=10.20.20.20</code> </pre> </div></div><br><p>  Por falta de atenci√≥n, la diferencia real en la configuraci√≥n del t√∫nel y el modo de transporte en las pol√≠ticas IPSec: <br><img src="https://habrastorage.org/webt/5v/ka/fg/5vkafg3ca8vilvv0s-lv1tdbxhw.png" alt="imagen"></p><br><p>  La verificaci√≥n de conexi√≥n es similar al modo t√∫nel. </p><br><h4 id="l2tpipsec">  L2TP / IPSec </h4><br><p>  Los ejemplos anteriores son adecuados para crear VPN permanentes entre dos pares, con direcciones IP externas est√°ticas. </p><br><p>  Si la direcci√≥n de uno de los pares es din√°mica (y generalmente se encuentra detr√°s de NAT), debe usar otra VPN de cliente a servidor. <br><img src="https://habrastorage.org/webt/ms/l5/3a/msl53ahdcdv8fl2vd-62m1exdmk.png" alt="imagen"></p><br><p>  Preconfiguraci√≥n L2TP: </p><br><pre> <code class="plaintext hljs">#     /ip pool add name=pool-l2tp ranges=192.168.77.10-192.168.77.20 #    /ppp profile add change-tcp-mss=yes local-address=192.168.77.1 name=l2tp-ipsec only-one=yes remote-address=pool-l2tp use-compression=no use-encryption=no use-mpls=no use-upnp=no #   /ppp secret add name=user1 password=test1 profile=l2tp-ipsec service=l2tp add name=user2 password=test2 profile=l2tp-ipsec service=l2tp add name=user3 password=test3 profile=l2tp-ipsec service=l2tp #  L2TP (  ipsec) /interface l2tp-server server set authentication=chap,mschap2 default-profile=l2tp-ipsec enabled=yes</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">¬øPor qu√© ignoro el autoajuste de IPsec?</b> <div class="spoiler_text"><p>  En la configuraci√≥n de ipip, gre, eoip, l2tp hay una configuraci√≥n autom√°tica de conexi√≥n ipsec, de hecho, el sistema crea reglas din√°micas para pares y pol√≠ticas para usted, pero en primer lugar no buscamos formas f√°ciles, y en segundo lugar, al actualizar de 6.42 a 6.43, crea autom√°ticamente t√∫neles rompi√≥ y no el hecho de que esto no volver√° a suceder. </p></div></div><br><p>  Configuraci√≥n paso a paso de IPSec: </p><br><ol><li>  Crear un nuevo grupo (puede usar el predeterminado) </li><li>  Crear propuestas para IKE Phase1 </li><li>  Creamos una fiesta, o m√°s bien una subred.  Jura por la clave PSK, pero si estamos tratando con Windows como cliente, entonces tenemos una opci√≥n: Certificados o PSK. </li><li>  Establezca passive = yes y send-init-contact = no, en generate-policy = port-strictly (acepte el puerto del cliente) </li><li>  Crear propuestas para SA </li><li>  Crear una plantilla para generar pol√≠ticas </li><li>  Especificar propuesta para SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Configuraci√≥n de Mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/ua/a8/ph/uaa8phm-3iy-qvrxuc6m4kbirr8.png" alt="imagen"></a> <br>  <em>En la captura de pantalla, el error es especificar dst.</em>  <em>puerto y src.</em>  <em>el puerto no es necesario</em> </p><br><p>  Opci√≥n de consola: </p><br><pre> <code class="plaintext hljs">#1 /ip ipsec policy group add name=l2tp-ipsec #2 /ip ipsec peer profile add dh-group=modp1024 enc-algorithm=aes-256 hash-algorithm=sha256 name=l2tp-ipsec-ike #3-4 /ip ipsec peer add address=0.0.0.0/0 generate-policy=port-strict passive=yes policy-template-group=l2tp-ipsec profile=l2tp-ipsec-ike secret=secret-ipsec-pass send-initial-contact=no #5 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=l2tp-ipsec-sa pfs-group=none #6-7 /ip ipsec policy add dst-address=0.0.0.0/0 group=l2tp-ipsec proposal=l2tp-ipsec-sa protocol=udp src-address=0.0.0.0/0 template=yes</code> </pre> </div></div><br><p>  <strong>Configuraci√≥n de firewall para crear conexiones L2TP solo despu√©s de IPSec</strong> </p><br><pre> <code class="plaintext hljs">/ip firewall filter # IKE, NAT-T  ipsec-esp add chain=input protocol=17 dst-port=500,4500 action=accept add chain=input protocol=50 action=accept # L2TP,     ipsec    add chain=input protocol=17 dst-port=1701 ipsec-policy=in,ipsec action=accept add chain=input protocol=17 dst-port=1701 action-drop</code> </pre> <br><h4 id="ikev2-vpn">  VPN IKEv2 </h4><br><p>  La opci√≥n L2TP es popular, pero gracias a la configuraci√≥n del modo, puede configurar el servidor VPN utilizando solo IPSec.  Este es un tipo prometedor de VPN, pero hasta ahora rara vez se usa, as√≠ que adem√°s de configurar el lado del servidor, dar√© un ejemplo de c√≥mo configurar el cliente strongSwan en Android. </p><br><p><img src="https://habrastorage.org/webt/el/un/fu/elunfukm2k6qajijslvcfd-zvuy.png" alt="imagen"></p><br><p>  Por supuesto, no todo es tan color de rosa.  La mayor√≠a de los sistemas operativos de "usuarios" (en particular Windows y Android) aceptan trabajar con una VPN de este tipo solo si est√°n autenticados por certificados o EAP. </p><br><p>  <em>Los certificados son mi punto d√©bil, si alguien sabe c√≥mo generar correctamente un certificado autofirmado que Windows importe y usar√° en la conexi√≥n, escriba los comentarios.</em> </p><br><p>  Generaci√≥n preliminar de certificados: </p><br><pre> <code class="plaintext hljs">#Root CA   /certificate add name=ca common-name="IKEv2 CA" days-valid=6928 /certificate sign ca ca-crl-host=&lt;IP &gt; #   vpn /certificate add common-name=&lt;IP &gt; subject-alt-name=IP:&lt;IP &gt; key-usage=tls-server name=vpn days-valid=6928 #   /certificate sign vpn ca=ca #   #       ,       #     Revoke   /certificate add common-name=client key-usage=tls-client name=client days-valid=6928 #   /certificate sign client ca=ca</code> </pre> <br><p>  Configuraci√≥n IKEv2 VPN paso a paso: </p><br><ol><li>  Creamos un grupo de direcciones para distribuir a los clientes. </li><li>  Cree un perfil de configuraci√≥n de modo para distribuir par√°metros IP a clientes </li><li>  Crear grupos para vincular pares y plantillas de pol√≠ticas </li><li>  Crear propuestas para IKE Phase1 </li><li>  Cree un perfil para conectar pares.  Autenticaci√≥n de certificado, protocolo IKEv2, modo pasivo </li><li>  Especifique el perfil de configuraci√≥n del modo, un grupo de 3 pasos y habilite la generaci√≥n de pol√≠ticas </li><li>  Crear propuestas para SA </li><li>  Crear una plantilla para generar pol√≠ticas </li><li>  Especificar propuestas para SA </li></ol><br><div class="spoiler">  <b class="spoiler_title">Configurar Mikrotik</b> <div class="spoiler_text"><p> <a href=""><img src="https://habrastorage.org/webt/1r/8w/vj/1r8wvjsgjjwhijje2dhwb90qv78.png" alt="imagen"></a> </p><br><pre> <code class="plaintext hljs">#1 /ip pool add name=pool-ike ranges=192.168.77.10-192.168.77.20 #2 /ip ipsec mode-config add address-pool=pool-ike address-prefix-length=32 name=ikev2-vpn static-dns=77.88.8.8 system-dns=no #3 /ip ipsec policy group add name=ikev2-vpn #4 /ip ipsec peer profile add enc-algorithm=aes-256,aes-128 hash-algorithm=sha256 name=ikev2-vpn #5-6 /ip ipsec peer add address=0.0.0.0/0 auth-method=rsa-signature certificate=vpn exchange-mode=ike2 generate-policy=port-strict mode-config=ikev2-vpn passive=yes policy-template-group=ikev2-vpn profile=ikev2-vpn send-initial-contact=no #7 /ip ipsec proposal add auth-algorithms=sha256,sha1 enc-algorithms=aes-256-cbc,aes-128-cbc name=ikev2-vpn #8-9 /ip ipsec policy add dst-address=0.0.0.0/0 group=ikev2-vpn proposal=ikev2-vpn src-address= 0.0.0.0/0 template=yes</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Configuraci√≥n de StrongSwan en Android.</b> <div class="spoiler_text"><p>  <em>Primero debe transferir los certificados de cliente y ca al tel√©fono.</em> <br>  <a href="">https://habrastorage.org/webt/tp/pk/ad/tppkadaifd1k7xi6hf3jxgg7vcs.png</a> </p><br><p>  <em>Para los ojos grandes: una cruz cerca de wi-fi se encuentra porque</em>  <em>AFWall + bloquea la mayor√≠a de las aplicaciones del sistema.</em> </p></div></div><br><p>  Si la conexi√≥n es exitosa, ver√°: pol√≠tica din√°mica, escritura en pares remotos y un par de SA. </p><br><p><img src="https://habrastorage.org/webt/89/ov/4w/89ov4wsqvw7r-dvsoz2crontmlk.png" alt="imagen"></p><br><p><img src="https://habrastorage.org/webt/cc/b2/ic/ccb2icr_nqz32btmghwptrz7svc.png" alt="imagen"></p><br><p><img src="https://habrastorage.org/webt/sl/cn/gz/slcngz0e3objej8x3fw4-m3wypc.png" alt="imagen"></p><br><p>  <em>Las licencias de demostraci√≥n de RouterOS x86 no tienen restricciones en la cantidad de t√∫neles IPSec, incluida la VPN IKEv2.</em>  <em>Puede implementar la demostraci√≥n RouterOS x86 (no confunda con RouterOS CHR gratis, todo es triste) en VPS y obtenga un servidor VPN personal con un m√≠nimo esfuerzo administrativo, sin comprar una licencia para RouterOS o RouterOS CHR.</em> </p><br><h3 id="para-slov-pro-analiz-logov-ipsec">  Algunas palabras sobre el an√°lisis de registro IPSec </h3><br><p>  Los registros en Mikrotik son una historia separada, a veces son lo suficientemente detallados como para analizar problemas, pero la falta de caracter√≠sticas banales: limpiar, copiar, encontrar te obliga a instalar un servidor syslog separado. </p><br><p>  En cuanto a IPSec, aqu√≠ hay una opci√≥n de an√°lisis de registro r√°pido (dejamos solo lo necesario en una pesta√±a separada): </p><br><p><img src="https://habrastorage.org/webt/05/rz/_g/05rz_grffjd7zz1r-a8zhsi87cy.png" alt="imagen"></p><br><pre> <code class="plaintext hljs">/system logging action add memory-lines=100000 name=ipsec target=memory /system logging add action=ipsec topics=ipsec,error add action=ipsec topics=ipsec,debug,!packet add action=ipsec topics=ipsec,info</code> </pre> <br><p>  Y un par de ejemplos de problemas t√≠picos de configuraci√≥n de IPSec: </p><br><div class="spoiler">  <b class="spoiler_title">Problema de coherencia de propuestas en la fase 1</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bp/jm/y1/bpjmy12i4eieobnfhrnj3hlvpcq.png" alt="imagen"></p><br><ol><li>  Lee el mensaje de error.  El problema es al conciliar propuestas en la primera fase. </li><li>  Miramos arriba, el enrutador en s√≠ sugiere que envi√≥ una fiesta, y lo que est√° configurado localmente </li></ol></div></div><br><div class="spoiler">  <b class="spoiler_title">Emitir problema de conciliaci√≥n IKE_SA_INIT</b> <div class="spoiler_text"><p>  En los registros ver√° algo como lo siguiente: </p><br><p><img src="https://habrastorage.org/webt/8i/d9/gh/8id9ghqgdgxsjjsfhn3zcn5_vtq.png"></p><br><p>  Analizando el tr√°fico </p><br><p>  En la solicitud, puede ver las propuestas del banquete: </p><br><p><img src="https://habrastorage.org/webt/pw/u2/ib/pwu2ibw3dyxswemrr74wcbphcoy.png"></p><br><p>  En la respuesta vemos que no se encontraron propuestas adecuadas: </p><br><p><img src="https://habrastorage.org/webt/q2/lb/qk/q2lbqkcr8qvtd1hgia4fj0hrb44.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Problema de conciliaci√≥n de propuestas para SA</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/2y/yg/7m/2yyg7ma7ko4lce5vsyef4nmojdi.png"><br>  El enrutador pregunta sobre el error de propuestas en la fase 2 y muestra qu√© est√° configurado localmente y qu√© es remoto. </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Propuesta de problema de conciliaci√≥n IKE_AUTH</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/bn/pk/vn/bnpkvnfazxyqmpbvdg78e26mfgy.png"><br>  Vemos que hubo una conexi√≥n y autenticaci√≥n de pares, pero adem√°s un error de propuestas.  No ver√° ning√∫n detalle en la depuraci√≥n, ni en Wirehark (el tr√°fico IKE_AUTH est√° encriptado). </p></div></div><br><div class="spoiler">  <b class="spoiler_title">Error de autenticaci√≥n de PSK</b> <div class="spoiler_text"><p>  Para IKE: </p><br><p><img src="https://habrastorage.org/webt/cp/wm/b5/cpwmb55qp8qyjmba_xijboxmiwa.png"></p><br><p>  Para IKEv2: <br><img src="https://habrastorage.org/webt/ks/fn/k0/ksfnk0qdgmgizzusfsyrlwxvcfs.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Modo IKE incorrecto</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/md/fb/ll/mdfbllmvedawn5ptdd-yvjcsrpw.png" alt="imagen"><br>  Vemos que la Fase 1 se rompe en el tiempo de espera, aunque los paquetes van entre pares.  Pero el tama√±o del paquete entrante es mucho mayor, si analizamos a trav√©s de wireshark, veremos que el par remoto usa el modo agresivo. </p><br><p><img src="https://habrastorage.org/webt/3g/ke/ii/3gkeiidaj8m-fs0ky7ucxqjxx6k.png"><br>  Vemos que los paquetes se env√≠an de nosotros a UDP: 500, y llegan a UDP: 4500 y son bastante grandes.  Aqu√≠ el par remoto tiene el modo IKEv2. </p></div></div><br><p>  Finalmente, lea la secci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">de soluci√≥n de problemas de la wiki</a> .  Y todo el material sobre IPSec es deseable para conocer, describ√≠ solo el conjunto b√°sico de herramientas y configuraciones. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/438176/">https://habr.com/ru/post/438176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../438166/index.html">Interacci√≥n entre un sitio en un navegador y un programa que se ejecuta localmente</a></li>
<li><a href="../438168/index.html">C√≥mo romper una c√°mara cara para que tu esposa no te mate</a></li>
<li><a href="../438170/index.html">Premio que lleva el nombre de Ilya Segalovich. Historia sobre inform√°tica y publicaciones de lanzamiento</a></li>
<li><a href="../438172/index.html">Apple no puede trasladar la producci√≥n de sus dispositivos a los EE. UU.</a></li>
<li><a href="../438174/index.html">Amarillo - Vac√≠o - Nube</a></li>
<li><a href="../438178/index.html">Creando su primera aplicaci√≥n ARCore</a></li>
<li><a href="../438180/index.html">Registre una transacci√≥n de bienes ra√≠ces en l√≠nea</a></li>
<li><a href="../438182/index.html">El estudio encontr√≥ los beneficios de la pirater√≠a moderada para los productores y distribuidores de contenido.</a></li>
<li><a href="../438188/index.html">Bill gates y reactor de sodio r√°pido</a></li>
<li><a href="../438190/index.html">¬øCu√°les son los procedimientos de adquisici√≥n (en palabras simples)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>