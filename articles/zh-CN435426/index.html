<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🌩️ 💛 🛠️ Microsoft Excel如何与行高一起使用 🛐 🤷🏾 🕙</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="有时我很无聊，并且配备了调试器，然后开始研究不同的程序。 这次，我的选择落在Excel上，希望弄清楚它如何处理行的高度，它存储的内容，如何考虑单元格范围的高度等。 我解析了Excel 2010（excel.exe，32位，版本14.0.4756.1000，SHA1 a805cf60a5542f210...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Microsoft Excel如何与行高一起使用</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/435426/"><p>有时我很无聊，并且配备了调试器，然后开始研究不同的程序。 这次，我的选择落在Excel上，希望弄清楚它如何处理行的高度，它存储的内容，如何考虑单元格范围的高度等。 我解析了Excel 2010（excel.exe，32位，版本14.0.4756.1000，SHA1 a805cf60a5542f21001b0ea5d142d1cd0ee00b28）。 </p><a name="habracut"></a><br><h2 id="nachnyom-s-teorii"> 让我们从理论开始 </h2><br><p> 如果转到Microsoft Office的VBA文档，则可以看到行高度可以通过两个属性以一种或另一种方式获得： </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="行高">RowHeight-</a>返回或设置指定范围内的第一行的高度，以<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="行高">磅</a>为单位。 读/写Double; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="身高">高度</a> -返回一个Double值，该值表示范围的高度（以磅为单位）。 只读的。 </li></ul><br><p> 如果您也在此处查看： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" title="Excel规格和限制">Excel规范和限制</a> 。 您可以找到最大行高为409点。 不幸的是，这远非唯一的Microsoft官方文件具有误导性的情况。 实际上，在Excel代码中，最大行高设置为2047像素，以点为1535.25。 且最大字体大小为409.55磅。 仅通过在VBA / Interop中分配行就不可能获得如此高的行，但是您可以一行，在其第一个单元格中设置Cambria Math字体，并将字体大小设置为409.55点。 然后，Excel及其狡猾算法将根据单元格格式计算行高，获取超过2047像素（相信单词）的数字，并将行设置为最大可能的高度。 如果通过UI询问该系列的高度，则Excel会认为该高度是409.5点，但是如果您通过VBA请求该系列的高度，则您会得到1535.25点，等于2047像素。 是的，保存文档后，高度仍将降至409.5点。 可以在以下视频中看到此操作： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//recordit.co/ivnFEsELLI</a> </p><br><p> 我在上一段中提到像素是有原因的。  Excel实际上以整数形式存储和计算单元格的大小（通常，它会尽可能多地执行整数操作）。 最常见的是像素乘以某个因子。 有趣的是，Excel以普通分数的形式存储外观比例，例如，比例比例75％将被存储为两个数字3和4。当需要显示行时，Excel将行高作为整数像素，乘以3并除以乘以4，但是他将在最后执行此操作，由此产生的效果是，所有内容均以小数形式考虑。 要验证这一点，请在VBA中编写以下代码： </p><br><pre><code class="vbscript hljs">w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).RowHeight = <span class="hljs-number"><span class="hljs-number">75.375</span></span> Debug.Print w.Rows(<span class="hljs-number"><span class="hljs-number">1</span></span>).Height</code> </pre> <br><p>  VBA会给出75，因为  75.375像素将为100.5像素，Excel无法承受，并且会将小数部分最多减少100像素。 当VBA要求以点为单位的行高时，Excel会诚实地将100像素转换为点并返回75。 </p><br><p> 原则上，我们已经用C＃编写了一个类来描述有关行高的信息： </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowHeightInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Value { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//    ,   4. public ushort Flags { get; set; } //  }</span></span></code> </pre> <br><p> 您现在必须说出我的话，但是在Excel中，行高度是以这种方式存储的。 也就是说，如果指定行高为75点，将以像素为单位，则为100，然后将400存储在Value中。我还没有完全弄清楚Flags中的所有位的含义（要弄清楚Flags的值很困难而且很长），但是我肯定知道手动设置高度的行设置为0x4000，隐藏行的设置为0x2000。 通常，对于具有手动设置的高度的可见行，Flags通常等于0x4005，对于根据Flags格式计算高度的行，其值为0xA或0x800E。 </p><br><h2 id="sprashivaem-vysotu-ryada"> 我们问行高 </h2><br><p> 现在，原则上，现在您可以看一下excel.exe中的方法，该方法通过其索引返回行高（这要归功于HexRays的漂亮代码）： </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge GetRowHeight@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowIndex@&lt;edx&gt;, SheetLayoutInfo *sheetLayoutInfo@&lt;esi&gt;, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> flag) { RowHeightInfo *rowHeightInfo; <span class="hljs-comment"><span class="hljs-comment">// eax int result; // ecx if ( sheetLayoutInfo-&gt;dword1A0 ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); if ( rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); if ( !rowHeightInfo ) return sheetLayoutInfo-&gt;defaultFullRowHeightMul4 | (~(sheetLayoutInfo-&gt;defaultRowDelta2 &gt;&gt; 14 &lt;&lt; 15) &amp; 0x8000); result = 0; if ( flag || !(rowHeightInfo-&gt;Flags &amp; 0x2000) ) result = rowHeightInfo-&gt;Value; if ( !(rowHeightInfo-&gt;Flags &amp; 0x4000) ) result |= 0x8000u; return result; }</span></span></code> </pre> <br><p>  dword1A0是什么，我仍然没有弄清楚。 找不到设置此标志的地方:( <br> 对我来说，defaultRowDelta2仍然是个谜。 当excel根据格式计算行高时，它表示为两个数字的总和。  defaultRowDelta2是此总和中第二个数字（标准行高度）。  flag参数的值也很神秘，因为 无论我在哪里看到在flag中传递给此方法的调用都传递false。 <br>  SheetLayoutInfo类也出现在此方法中。 我之所以这样命名，是因为它存储了大量有关工作表外观的信息。 在SheetLayoutInfo中，有如下字段： </p><br><ul><li>  DefaultFullRowHeightMul4-标准行高； </li><li>  MinRowIndexNonDefault-第一行的索引，高度不同于标准行； </li><li>  MaxRowIndexNonDefault-最后一个序列之后的序列的索引，该序列的高度不同于标准； </li><li>  DefaultRowDelta2与标准行高的总和相同。 </li><li>  GroupIndexDelta-稍后会详细介绍 </li></ul><br><p> 原则上，这种方法的逻辑是可以理解的： </p><br><ol><li> 如果系列的索引小于非标准高度的第一个索引，则返回标准；否则，返回标准。 </li><li> 如果系列的索引大于具有非标准高度的最后一个索引，则返回标准；否则，返回标准。 </li><li> 否则，我们将从GetRowHeightCore方法获取该系列的rowHeightInfo对象； </li><li> 如果rowHeightInfo == null，则返回标准行高。 </li><li> 带有标志的魔术，但是通常，如果没有手动设置行高，我们将返回rowHeightInfo.Value中的内容，并在响应中设置第16位。 </li></ol><br><p> 如果用C＃重写此代码，则会得到如下所示的内容： </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> HiddenRowMask = <span class="hljs-number"><span class="hljs-number">0x2000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> CustomHeightMask = <span class="hljs-number"><span class="hljs-number">0x4000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> DefaultHeightMask = <span class="hljs-number"><span class="hljs-number">0x8000</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ushort</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> defaultHeight = (<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>) (sheetLayoutInfo.DefaultFullRowHeightMul4 | (~(sheetLayoutInfo.DefaultRowDelta2 &gt;&gt; <span class="hljs-number"><span class="hljs-number">14</span></span> &lt;&lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) &amp; DefaultHeightMask)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; RowHeightInfo rowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultHeight; <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> result = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; HiddenRowMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result = rowHeightInfo.Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((rowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) result |= DefaultHeightMask; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br><p> 现在，您可以看一下GetRowHeightCore内部发生的情况： </p><br><pre> <code class="cpp hljs">RowHeightInfo *__<span class="hljs-function"><span class="hljs-function">fastcall </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SheetLayoutInfo *sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">signed</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex)</span></span></span><span class="hljs-function"> </span></span>{ RowHeightInfo *result; <span class="hljs-comment"><span class="hljs-comment">// eax RowsGroupInfo *rowsGroupInfo; // ecx int rowInfoIndex; // edx result = 0; if ( rowIndex &lt; sheetLayoutInfo-&gt;MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo-&gt;MaxRowIndexNonDefault ) return result; rowsGroupInfo = sheetLayoutInfo-&gt;RowsGroups[sheetLayoutInfo-GroupIndexDelta + (rowIndex &gt;&gt; 4)]; result = 0; if ( !rowsGroupInfo ) return result; rowInfoIndex = rowsGroupInfo-&gt;Indices[rowIndex &amp; 0xF]; if ( rowInfoIndex ) result = (rowsGroupInfo + 8 * (rowInfoIndex + rowsGroupInfo-&gt;wordBA + rowsGroupInfo-&gt;wordBC - rowsGroupInfo-&gt;wordB8)); return result; }</span></span></code> </pre> <br><ol><li> 再次，在开始时，Excel将检查该系列的索引是否在高度已修改的行之间，如果不是，则返回null。 </li><li> 查找所需的行组；如果没有这样的组，则返回null。 </li><li> 获取组中系列的索引。 </li><li> 此外，通过系列的索引，它找到RowHeightInfo类的所需对象。  wordBA，wordBC，wordB8-一些常量。 它们仅随着历史而改变。 原则上，它们不会影响对算法的理解。 </li></ol><br><p> 在这里值得偏离本主题，并更多地介绍RowsGroupInfo。  Excel以16件为一组存储RowHeightInfo，其中以RowsGroupInfo类表示的第i组将存储有关从i×16到i×16 + 15（含）的行的信息。 </p><br><p> 但是RowsGroupInfo中的行高信息以某种不寻常的方式存储。 最有可能是由于需要在Excel中维护历史记录。 </p><br><p>  RowsGroupInfo中有三个重要字段：Indices，HeightInfos和RowsCount，第二个在上面的代码中不可见（它应该在此行中：（rowsGroupInfo + 8×（...）），因为rowInfoIndex可以采用非常不同的值，我已经看过1000多个，而且我不知道如何在IDA中设置这样的结构。RowsCount字段没有出现在上面的代码中，但这是组中存储了多少个真正的非标准行。 <br> 另外，在SheetLayoutInfo中有GroupIndexDelta-组的实际索引与具有更改的行高的第一个组的索引之间的差。 </p><br><p> 索引字段存储组中系列的每个索引的RowHeightInfo偏移量。 它们按顺序存储在此处，但是在HeightInfos中，RowHeightInfo已按更改顺序存储。 </p><br><p> 假设我们有一个新的空白表，并且以某种方式更改了行号23的高度。此行位于第二组的16行中，然后： </p><br><ol><li>  Excel将确定该系列的组索引。 在当前情况下，索引将为1，并将更改GroupIndexDelta = -1。 </li><li> 为一系列行创建RowsGroupInfo类的对象，并将其放在索引0（sheetLayoutInfo-&gt; GroupIndexDelta + 1）下的sheetLayoutInfo-&gt; RowsGroups中； </li><li> 在RowsGroupInfo中，Excel将为16个4字节索引分配内存，分别用于RowsCount，wordBA，wordBC和wordB8等。 </li><li> 然后，Excel通过按位与运算（比采用除法的其余部分要快得多）来计算组中系列的索引：rowIndex＆0xF。 该组中的期望索引为：23＆0xF = 7; </li><li> 之后，Excel获得索引7的偏移量：offset = Indices [7]。 如果offset = 0，则Excel在RowsGroupInto的末尾分配8个字节，将RowsCount增加1，然后将新的偏移量写入索引[7]。 无论如何，最后，Excel都会在RowsGroupInfo中的偏移处写入有关新行高和标志的信息。 </li></ol><br><p>  C＃本身中的RowsGroupInfo类看起来像这样： </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RowsGroupInfo</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] Indices { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;RowHeightInfo&gt; HeightInfos { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RowsGroupInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Indices = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[SheetLayoutInfo.MaxRowsCountInGroup]; HeightInfos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;RowHeightInfo&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; SheetLayoutInfo.MaxRowsCountInGroup; i++) { Indices[i] = <span class="hljs-number"><span class="hljs-number">-1</span></span>; } } }</code> </pre> <br><p>  GetRowHeightCore方法将如下所示： </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> RowHeightInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRowHeightCore</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &lt; sheetLayoutInfo.MinRowIndexNonDefault || rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + (rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>)]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rowInfoIndex != <span class="hljs-number"><span class="hljs-number">-1</span></span> ? rowsGroupInfo.HeightInfos[rowInfoIndex] : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br><p> 这就是SetRowHeight的样子（我没有从excel.exe中列出其代码）： </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRowHeight</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newRowHeight, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ushort</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags, SheetLayoutInfo sheetLayoutInfo</span></span></span><span class="hljs-function">)</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Max(sheetLayoutInfo.MaxRowIndexNonDefault, rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>); sheetLayoutInfo.MinRowIndexNonDefault = Math.Min(sheetLayoutInfo.MinRowIndexNonDefault, rowIndex); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.RowsGroups.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sheetLayoutInfo.RowsGroups.Add(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = -(sheetLayoutInfo.GroupIndexDelta + realGroupIndex); sheetLayoutInfo.RowsGroups.InsertRange(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); sheetLayoutInfo.GroupIndexDelta = -realGroupIndex; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sheetLayoutInfo.GroupIndexDelta + realGroupIndex &gt;= sheetLayoutInfo.RowsGroups.Count) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bucketSize = sheetLayoutInfo.GroupIndexDelta + realGroupIndex - sheetLayoutInfo.RowsGroups.Count + <span class="hljs-number"><span class="hljs-number">1</span></span>; sheetLayoutInfo.RowsGroups.AddRange(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo[bucketSize]); } RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[sheetLayoutInfo.GroupIndexDelta + realGroupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>]; RowHeightInfo rowHeightInfo; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { rowHeightInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowHeightInfo(); rowsGroupInfo.HeightInfos.Add(rowHeightInfo); rowsGroupInfo.Indices[rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { rowHeightInfo = rowsGroupInfo.HeightInfos[rowInfoIndex]; } rowHeightInfo.Value = newRowHeight; rowHeightInfo.Flags = flags; }</code> </pre> <br><h2 id="nemnogo-praktiki"> 一点练习 </h2><br><p> 在上面的示例之后，更改了第23行的高度，Excel将看起来像这样（我将第23行的高度设置为75点）： </p><br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 23 </li><li>  GroupIndexDelta = -1 </li><li>  RowsGroups Count = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  HeightInfos计数= 1 <br><ul><li>  [0] RowHeightInfo </li><li> 标志= 0x4005 </li><li> 价值= 100 </li></ul></li><li> 指标 <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = -1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br> 在这里和下面的示例中，我将布局一个示意图，说明Excel内存中的数据是如何通过自写类在Visual Studio中生成的，因为从内存中直接转储的信息不多。 <br> 现在，让我们尝试隐藏第23行。为此，将Flags设置为0x2000。 我们将改变生活的记忆。 结果可以在以下视频中看到： <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">http</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//recordit.co/79vYIbwbzB</a> 。 <br> 每当您隐藏行时，Excel都会执行相同的操作。 <br> 现在，我们不通过行格式来显式设置行高。 让单元格A20中的字体变为40点的高度，然后以点为单位的单元格高度将为45.75，并且在Excel内存中将是这样的： <br><div class="spoiler">  <b class="spoiler_title">sheetLayoutInfo</b> <div class="spoiler_text"><ul><li>  DefaultFullRowHeightMul4 = 80 </li><li>  DefaultRowDelta2 = 5 </li><li>  MaxRowIndexNonDefault = 24 </li><li>  MinRowIndexNonDefault = 20 </li><li>  GroupIndexDelta = -1 </li><li>  RowsGroups Count = 1 <br><ul><li>  [0] RowsGroupInfo </li><li>  HeightInfos计数= 2 <br><ul><li>  [0] RowHeightInfo </li><li> 标志= 0x4005 </li><li> 价值= 100 </li><li>  [1] RowHeightInfo </li><li> 标志= 0x800E </li><li> 价值= 244 </li></ul></li><li> 指标 <br><ul><li>  [0] = -1 </li><li>  [1] = -1 </li><li>  [2] = -1 </li><li>  [3] = -1 </li><li>  [4] = 1 </li><li>  [5] = -1 </li><li>  [6] = -1 </li><li>  [7] = 0 </li><li>  [8] = -1 </li><li>  [9] = -1 </li><li>  [10] = -1 </li><li>  [11] = -1 </li><li>  [12] = -1 </li><li>  [13] = -1 </li><li>  [14] = -1 </li><li>  [15] = -1 </li></ul></li></ul></li></ul></div></div><br><p> 您可能会注意到，如果不是标准行，Excel总是存储行高。 即使未明确设置高度，而是根据单元格或格式的内容计算出的高度，Excel仍然会对其进行一次计算并将结果放入适当的组中。 </p><br><h2 id="razbiraemsya-so-vstavkoyudaleniem-ryadov"> 我们处理行的插入/删除 </h2><br><p> 解析插入/删除行时会发生什么会很有趣。 在excel.exe中对应的代码并不难找到，但是没有反汇编的欲望，您可以看一下其中的一部分： </p><br><div class="spoiler">  <b class="spoiler_title">sub_305EC930</b> <div class="spoiler_text"><p> 标志a5确定当前正在执行哪个操作。 </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __userpurge sub_305EC930@&lt;eax&gt;(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a1@&lt;eax&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a2@&lt;edx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a3@&lt;ecx&gt;, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a4, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a5, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> a6) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> v6; <span class="hljs-comment"><span class="hljs-comment">// esi int v7; // ebx int v8; // edi int v9; // edx int v10; // ecx size_t v11; // eax _WORD *v12; // ebp size_t v13; // eax size_t v14; // eax int v15; // eax unsigned __int16 *v16; // ecx _WORD *v17; // eax _WORD *v18; // ecx int v19; // edx __int16 v20; // bx int v21; // eax _WORD *v22; // ecx int v24; // edx int v25; // eax int v26; // esi int v27; // ebx size_t v28; // eax int v29; // ebp size_t v30; // eax int v31; // esi size_t v32; // eax int v33; // eax unsigned __int16 *v34; // ecx int v35; // eax _WORD *v36; // edx _WORD *v37; // ecx int v38; // eax __int16 v39; // bx int v40; // eax _WORD *v41; // ecx int v42; // [esp+10h] [ebp-48h] int v43; // [esp+10h] [ebp-48h] int v44; // [esp+14h] [ebp-44h] char v45; // [esp+14h] [ebp-44h] int Dst[16]; // [esp+18h] [ebp-40h] int v47; // [esp+5Ch] [ebp+4h] int v48; // [esp+60h] [ebp+8h] v6 = a1; v7 = a1 &amp; 0xF; v8 = a2; if ( !a5 ) { v24 = a4 - a1; v25 = a1 - a3; v43 = a4 - v6; if ( v7 &gt;= v25 ) v7 = v25; v47 = a4 - v7; v26 = v6 - v7; v27 = v7 + 1; v48 = v27; if ( !v8 ) return v27; v28 = 4 * v24; if ( (4 * v24) &gt; 0x40 ) v28 = 64; v45 = v27 + v26; v29 = (v27 + v26) &amp; 0xF; memmove(Dst, (v8 + 4 * v29), v28); v30 = 4 * v27; if ( (4 * v27) &gt; 0x40 ) v30 = 64; v31 = v26 &amp; 0xF; memmove((v8 + 4 * (v47 &amp; 0xF)), (v8 + 4 * v31), v30); v32 = 4 * v43; if ( (4 * v43) &gt; 0x40 ) v32 = 64; memmove((v8 + 4 * v31), Dst, v32); if ( !a6 ) return v48; v33 = v29; if ( v29 &lt; v29 + v43 ) { v34 = (v8 + 4 * v29 + 214); do { Dst[v33++] = *v34 &gt;&gt; 15; v34 += 2; } while ( v33 &lt; v29 + v43 ); } v35 = (v45 - 1) &amp; 0xF; if ( v35 &gt;= v31 ) { v36 = (v8 + 4 * ((v27 + v47 - 1) &amp; 0xF) + 214); v37 = (v8 + 4 * ((v45 - 1) &amp; 0xF) + 214); v38 = v35 - v31 + 1; do { v39 = *v37 ^ (*v37 ^ *v36) &amp; 0x7FFF; v37 -= 2; *v36 = v39; v36 -= 2; --v38; } while ( v38 ); v27 = v48; } v40 = v31; if ( v31 &gt;= v31 + v43 ) return v27; v41 = (v8 + 4 * v31 + 214); do { *v41 = *v41 &amp; 0x7FFF | (LOWORD(Dst[v40++]) &lt;&lt; 15); v41 += 2; } while ( v40 &lt; v31 + v43 ); return v27; } v9 = a1 - a4; v10 = a3 - a1; v42 = a1 - a4; v48 = 16 - v7; if ( 16 - v7 &gt;= v10 ) v48 = v10; if ( !v8 ) return v48; v11 = 4 * v9; if ( (4 * v9) &gt; 0x40 ) v11 = 64; v12 = (v8 + 4 * (a4 &amp; 0xF)); v44 = a4 &amp; 0xF; memmove(Dst, v12, v11); v13 = 4 * v48; if ( (4 * v48) &gt; 0x40 ) v13 = 64; memmove(v12, (v8 + 4 * v7), v13); v14 = 4 * v42; if ( (4 * v42) &gt; 0x40 ) v14 = 64; memmove((v8 + 4 * ((a4 + v48) &amp; 0xF)), Dst, v14); if ( !a6 ) return v48; v15 = a4 &amp; 0xF; if ( v44 &lt; v44 + v42 ) { v16 = (v8 + 4 * v44 + 214); do { Dst[v15++] = *v16 &gt;&gt; 15; v16 += 2; } while ( v15 &lt; v44 + v42 ); } if ( v7 &lt; v48 + v7 ) { v17 = (v8 + 4 * v7 + 214); v18 = v12 + 107; v19 = v48; do { v20 = *v17 ^ (*v17 ^ *v18) &amp; 0x7FFF; v17 += 2; *v18 = v20; v18 += 2; --v19; } while ( v19 ); } v21 = a4 &amp; 0xF; if ( v44 &gt;= v44 + v42 ) return v48; v22 = (v8 + 4 * (v44 + v48) + 214); do { *v22 = *v22 &amp; 0x7FFF | (LOWORD(Dst[v21++]) &lt;&lt; 15); v22 += 2; } while ( v21 &lt; v44 + v42 ); return v48; }</span></span></code> </pre> </div></div><br><p> 此外，从外观上，您可以大致了解那里发生的事情，其余的可以通过间接标志来结束。 <br> 我们尝试识别这些间接功能。 首先，以随机顺序将第16行的高度设置为64（含）。 然后，在索引39下的行的前面插入新行。 新行将复制第38行的高度。 <br> 让我们看一下添加系列之前和之后的系列分组中的信息，我重点介绍了粗体的区别： </p><br><table><thead><tr><th> 在添加行之前 </th><th> 添加一行后 </th></tr></thead><tbody><tr><td> 第一组的排量： </td><td> 第一组的排量： </td></tr><tr><td>  0E，04、07、00、05、0A，09、0F，03、06、08、0D，01、0B，0C，02 </td><td>  0E，04、07、00、05、0A，09、0F，03、06、08、0D，01、0B，0C，02 </td></tr><tr><td> 第一组中各行的高度值： </td><td> 第一组中各行的高度值： </td></tr><tr><td>  05、2B，35、45、4B，50、5B，6B，7B，8B，A5，AB，B0，B5，E0、100 </td><td>  05、2B，35、45、4B，50、5B，6B，7B，8B，A5，AB，B0，B5，E0、100 </td></tr><tr><td> 第二组位移： </td><td> 第二组位移： </td></tr><tr><td>  06、02、0E， <strong>09、01、07、0F，0C</strong> ，00、0A，04、0B， <strong>03、08、0D，05</strong> </td><td>  06、02、0E， <strong>09、01、07、0F</strong> ，05、0C，00、0A，04、0B， <strong>03、08、0D</strong> </td></tr><tr><td> 第二组中的行的高度值： </td><td> 第二组中的行的高度值： </td></tr><tr><td>  10、15、20、25、30、75、85、90、9B，A0，C5，CB，D0，D5，E5，F0 </td><td>  10、15、20、25、30，F0、85、90、9B，A0，C5，CB，D0，D5，E5，F0 </td></tr><tr><td> 第三组位移： </td><td> 第三组位移： </td></tr><tr><td>  0C，08、0E，07、0A，01、06、0F，09、0D，00、05、0B，02、04、03 </td><td>  03，0C，08，0E，07，0A，01，06，0F，09，0D，00，05，0B，02，04 </td></tr><tr><td> 第三组中的行的高度值： </td><td> 第三组中的行的高度值： </td></tr><tr><td>  0B，1B，3B，40、55、60、65、70、80、95，BB，C0，DB，EB，F5，FB </td><td>  0B，1B，3B，75、55、60、65、70、80、95，BB，C0，DB，EB，F5，FB </td></tr><tr><td> 第四组的偏移量： </td><td> 第四组的偏移量： </td></tr><tr><td>  _ </td><td>  <strong>00</strong> </td></tr><tr><td> 第四组中的行的高度值： </td><td> 第四组中的行的高度值： </td></tr><tr><td>  _ </td><td>  <strong>40</strong> </td></tr></tbody></table><br><p> 这是预期的：Excel将第二行插入索引为7（39＆0xF）的新行，其偏移量为0x05，将行高度复制到索引6，而最后一行（偏移量为05）被推到下一行组，然后从那里将最后一行推到第四行，依此类推。 </p><br><p> 现在让我们看看如果删除第29行会发生什么。 </p><br><table><thead><tr><th> 删除行之前 </th><th> 删除行后 </th></tr></thead><tbody><tr><td> 第一组的排量： </td><td> 第一组的排量： </td></tr><tr><td>  0E，04、07、00、05、0A，09、0F，03、06、08、0D， <strong>01、0B，0C，02</strong> </td><td>  0E，04、07、00、05、0A，09、0F，03、06、08、0D，01、0C <strong>，02、0B</strong> </td></tr><tr><td> 第一组中各行的高度值： </td><td> 第一组中各行的高度值： </td></tr><tr><td>  05、2B，35、45、4B，50、5B，6B，7B，8B，A5， <strong>AB</strong> ，B0，B5，E0、100 </td><td>  05、2B，35、45、4B，50、5B，6B，7B，8B，A5、85，B0，B5，E0、100 </td></tr><tr><td> 第二组位移： </td><td> 第二组位移： </td></tr><tr><td>  06，02，0E，09，01，07，0F，05，0C，00，0A，04，0B，03，08，0D </td><td>  02，0E，09，01，07，0F，05，0C，00，0A，04，0B，03，08，0D， <strong>06</strong> </td></tr><tr><td> 第二组中的行的高度值： </td><td> 第二组中的行的高度值： </td></tr><tr><td>  10、15、20、25、30，F0、85、90、9B，A0，C5，CB，D0，D5，E5，F0 </td><td>  10、15、20、25、30，F0、75、90、9B，A0，C5，CB，D0，D5，E5，F0 </td></tr><tr><td> 第三组位移： </td><td> 第三组位移： </td></tr><tr><td>  03，0C，08，0E，07，0A，01，06，0F，09，0D，00，05，0B，02，04 </td><td>  0C，08、0E，07、0A，01、06、0F，09、0D，00、05、0B，02、04、03 </td></tr><tr><td> 第三组中的行的高度值： </td><td> 第三组中的行的高度值： </td></tr><tr><td>  0B，1B，3B，75、55、60、65、70、80、95，BB，C0，DB，EB，F5，FB </td><td>  0B，1B，3B，40、55、60、65、70、80、95，BB，C0，DB，EB，F5，FB </td></tr><tr><td> 第四组的偏移量： </td><td> 第四组的偏移量： </td></tr><tr><td>  00 </td><td>  00 </td></tr><tr><td> 第四组中的行的高度值： </td><td> 第四组中的行的高度值： </td></tr><tr><td>  <strong>40</strong> </td><td>  <strong>50</strong> </td></tr></tbody></table><br><p> 原则上，当删除一行时，会发生反向操作。 在这种情况下，第四组继续存在，并且该行的高度值被标准高度填充，并带有相应的标志-0x8005。 </p><br><p> 这些数据足以在C＃中重现此算法： </p><br><div class="spoiler">  <b class="spoiler_title">插入行</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InsertRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; RowHeightInfo etalonRowHeightInfo = GetRowHeightCore(sheetLayoutInfo, rowIndex); RowHeightInfo newRowHeightInfo = etalonRowHeightInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? etalonRowHeightInfo.Clone() : CreateDefaultRowHeight(sheetLayoutInfo); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = (rowIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; RowHeightInfo lastRowHeightInGroup; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span> || rowsGroupInfo.HeightInfos.Count &lt; SheetLayoutInfo.MaxRowsCountInGroup) { lastRowHeightInGroup = GetRowHeightCore(sheetLayoutInfo, ((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>); Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[newRowInGroupIndex] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastIndex = rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>]; lastRowHeightInGroup = rowsGroupInfo.HeightInfos[lastIndex]; Array.Copy(rowsGroupInfo.Indices, newRowInGroupIndex, rowsGroupInfo.Indices, newRowInGroupIndex + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span> - newRowInGroupIndex); rowsGroupInfo.HeightInfos[lastIndex] = newRowHeightInfo; rowsGroupInfo.Indices[newRowInGroupIndex] = lastIndex; } newRowHeightInfo = lastRowHeightInGroup ?? CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((newRowHeightInfo.Flags &amp; CustomHeightMask) != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; groupIndex != SheetLayoutInfo.MaxGroupsCount) { SetRowHeight(((groupIndex - sheetLayoutInfo.GroupIndexDelta) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>) + newRowInGroupIndex, newRowHeightInfo.Value, newRowHeightInfo.Flags, sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sheetLayoutInfo.MaxRowIndexNonDefault = Math.Min(sheetLayoutInfo.MaxRowIndexNonDefault + <span class="hljs-number"><span class="hljs-number">1</span></span>, SheetLayoutInfo.MaxRowsCount); } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">删除行</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">SheetLayoutInfo sheetLayoutInfo, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowIndex</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowIndex &gt;= sheetLayoutInfo.MaxRowIndexNonDefault) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> realGroupIndex = rowIndex &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> newRowInGroupIndex = rowIndex &amp; <span class="hljs-number"><span class="hljs-number">0xF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> groupIndex; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (groupIndex = realGroupIndex + sheetLayoutInfo.GroupIndexDelta; groupIndex &lt; sheetLayoutInfo.RowsGroups.Count; groupIndex++, newRowInGroupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex &lt; <span class="hljs-number"><span class="hljs-number">-1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { sheetLayoutInfo.RowsGroups.Insert(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); sheetLayoutInfo.GroupIndexDelta++; groupIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (groupIndex == SheetLayoutInfo.MaxGroupsCount) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> newRowHeightInfo = groupIndex == SheetLayoutInfo.MaxGroupsCount - <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-literal"><span class="hljs-literal">null</span></span> : GetRowHeightCore(sheetLayoutInfo, (groupIndex - sheetLayoutInfo.GroupIndexDelta + <span class="hljs-number"><span class="hljs-number">1</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>); RowsGroupInfo rowsGroupInfo = sheetLayoutInfo.RowsGroups[groupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowsGroupInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || (newRowHeightInfo.Flags &amp; CustomHeightMask) == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; rowsGroupInfo = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RowsGroupInfo(); sheetLayoutInfo.RowsGroups[groupIndex] = rowsGroupInfo; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (newRowHeightInfo == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { newRowHeightInfo = CreateDefaultRowHeight(sheetLayoutInfo); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rowInfoIndex = rowsGroupInfo.Indices[newRowInGroupIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowInfoIndex == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.HeightInfos.Add(newRowHeightInfo); rowsGroupInfo.Indices[SheetLayoutInfo.MaxRowsCountInGroup - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = newRowInGroupIndex; i &lt; rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { rowsGroupInfo.Indices[i] = rowsGroupInfo.Indices[i + <span class="hljs-number"><span class="hljs-number">1</span></span>]; } rowsGroupInfo.Indices[rowsGroupInfo.HeightInfos.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>] = rowInfoIndex; rowsGroupInfo.HeightInfos[rowInfoIndex] = newRowHeightInfo; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(rowIndex &lt;= sheetLayoutInfo.MinRowIndexNonDefault) { sheetLayoutInfo.MinRowIndexNonDefault = Math.Max(sheetLayoutInfo.MinRowIndexNonDefault - <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); } }</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><strong>您可以在GitHub上找到上述所有代码</strong></a> </p><br><h2 id="vyvody"> 结论 </h2><br><p> 这不是Excel代码第一次对有趣的技巧感到惊讶。 这次，我发现了他如何存储有关行高的信息。 如果社区感兴趣，那么在下一篇文章中，我将展示Excel如何考虑像元范围的高度（扰流器：有些类似于SQRT分解，但由于某种原因而没有求和缓存），您可以看到它如何将整数按比例缩放。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN435426/">https://habr.com/ru/post/zh-CN435426/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN435416/index.html">DIY项目技术。 入门部分</a></li>
<li><a href="../zh-CN435418/index.html">在Flutter中使用SQLite</a></li>
<li><a href="../zh-CN435420/index.html">打击犯罪的未来是对家谱的研究</a></li>
<li><a href="../zh-CN435422/index.html">硅谷的人如何有经验</a></li>
<li><a href="../zh-CN435424/index.html">解析和Android：对新手开发人员的建议</a></li>
<li><a href="../zh-CN435428/index.html">使用Python远程控制Fceux仿真器</a></li>
<li><a href="../zh-CN435430/index.html">CES 2019最酷的新闻</a></li>
<li><a href="../zh-CN435432/index.html">新年，新的GitHub：无限的免费私人存储库</a></li>
<li><a href="../zh-CN435436/index.html">IT基础架构的5大趋势：2019年的预测</a></li>
<li><a href="../zh-CN435438/index.html">PHP：在团队开发中更改数据库结构</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>