<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé¶ üçè ü§≠ Toque "osu!", Mas cuidado com os bugs üî° üë®üèΩ‚Äçü§ù‚Äçüë®üèª üêå</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, todos voc√™s colecionadores de insetos ex√≥ticos e comuns! Hoje temos uma amostra rara em nosso banco de testes do PVS-Studio - um jogo chamado "os...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Toque "osu!", Mas cuidado com os bugs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pvs-studio/blog/483436/"><p><img src="https://habrastorage.org/getpro/habr/post_images/3ac/9da/a12/3ac9daa12b519fc14e45f7f65abdd204.png" alt="Quadro 1" align="left"></p><br>  Ol√°, todos voc√™s colecionadores de insetos ex√≥ticos e comuns!  Hoje temos uma amostra rara em nosso banco de testes do PVS-Studio - um jogo chamado "osu!", Escrito em C #.  Como sempre, estaremos procurando por bugs, analisando-os e jogando. <br><a name="habracut"></a><br><h2>  O jogo </h2><br>  Osu!  √© um jogo de ritmo de c√≥digo aberto.  De acordo com o <a href="https://osu.ppy.sh/home">site</a> do jogo, √© bastante popular, com mais de 15 milh√µes de contas de jogadores.  O projeto apresenta jogabilidade gratuita, design colorido, personaliza√ß√£o de mapas, um sistema avan√ßado de classifica√ß√£o de jogadores on-line, modo multiplayer e um rico conjunto de pe√ßas musicais.  N√£o faz sentido aprofundar o jogo;  voc√™ pode ler tudo sobre isso na Internet.  Comece com <a href="https://en.wikipedia.org/wiki/Osu!">esta p√°gina</a> . <br><br>  Estou mais interessado no c√≥digo-fonte do projeto, dispon√≠vel no <a href="https://github.com/ppy/osu">GitHub</a> .  Uma coisa que chama a sua aten√ß√£o imediatamente √© o grande n√∫mero de confirma√ß√µes de reposit√≥rio (mais de 24 mil), o que √© um sinal de intenso desenvolvimento cont√≠nuo (o jogo foi lan√ßado em 2007, mas o trabalho deve ter come√ßado ainda mais cedo).  O projeto n√£o √© grande: apenas 1813 arquivos .cs com o total de 135 mil LOC n√£o vazios.  Esse n√∫mero tamb√©m inclui testes, que eu normalmente n√£o considero ao executar verifica√ß√µes.  Os testes comp√µem 306 dos arquivos .cs com 25 mil LOC.  O projeto √© realmente pequeno: por exemplo, o n√∫cleo C # do PVS-Studio tem cerca de 300 mil LOC. <br><br>  Deixando os arquivos de teste, verifiquei 1507 arquivos com 110 mil LOC.  A verifica√ß√£o revelou alguns bugs interessantes, que estou disposto a mostrar. <br><br><h2>  Os insetos </h2><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Existem <a href="https://www.viva64.com/en/w/v3001/">subexpress√µes</a> id√™nticas 'result == HitResult.Perfect' √† esquerda e √† direita da '||'  operador.  DrawableHoldNote.cs 266 <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckForResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... ApplyResult(r =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (holdNote.hasBroken &amp;&amp; (result == HitResult.Perfect || result == HitResult.Perfect)) result = HitResult.Good; .... }); }</code> </pre> <br>  Este √© um bom exemplo de programa√ß√£o orientada para copiar e colar, que √© um termo bem-humorado usado recentemente por minha colega de trabalho Valeriy Komarov em seu artigo " <a href="https://www.viva64.com/en/b/0699/">Os 10 principais erros encontrados em projetos Java em 2019</a> ". <br><br>  De qualquer forma, duas verifica√ß√µes id√™nticas s√£o executadas em uma linha.  Um deles provavelmente deveria verificar alguma outra constante da enumera√ß√£o <i>HitResult</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> HitResult { None, Miss, Meh, Ok, Good, Great, Perfect, }</code> </pre> <br>  Qual constante deveria ser verificada?  Ou talvez o segundo cheque n√£o deva estar presente?  Estas s√£o as perguntas que somente os autores podem responder.  Enfim, este √© um erro que distorce a l√≥gica de execu√ß√£o do programa. <br><br>  <a href="https://www.viva64.com/en/w/v3001/">V3001</a> Existem <a href="https://www.viva64.com/en/w/v3001/">subexpress√µes</a> id√™nticas 'family! = GetFamilyString (TournamentTypeface.Aquatico)' √† esquerda e √† direita do operador '&amp;&amp;'.  TournamentFont.cs 64 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetWeightString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> family, FontWeight weight</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (weight == FontWeight.Regular &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico) &amp;&amp; family != GetFamilyString(TournamentTypeface.Aquatico)) weightString = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty; .... }</code> </pre> <br>  Copie e cole novamente.  Refatorei o c√≥digo para que o erro seja facilmente percebido agora, mas originalmente ele havia sido escrito em uma linha.  Assim como no exemplo anterior, n√£o posso dizer com certeza como exatamente esse deve ser corrigido.  A enumera√ß√£o <i>TournamentTypeface</i> cont√©m apenas uma constante: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> TournamentTypeface { Aquatico }</code> </pre> <br>  Talvez o erro seja verificar a vari√°vel da <i>fam√≠lia</i> duas vezes, mas posso estar errado. <br><br>  <a href="https://www.viva64.com/en/w/v3009/">V3009</a> [CWE-393] √â estranho que esse m√©todo sempre retorne um e o mesmo valor de 'false'.  KeyCounterAction.cs 19 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> forwards</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!EqualityComparer&lt;T&gt;.Default.Equals(action, Action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; IsLit = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (forwards) Increment(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; }</code> </pre> <br>  Esse m√©todo retorna sempre <i>falso</i> .  Em casos como esse, normalmente eu checava a chamada de fun√ß√£o, porque muitas vezes voc√™ descobre que o chamador n√£o usa o valor de retorno, o que significa que n√£o h√° problema (exceto o estilo ruim).  √â assim que a chamada se parece neste caso: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T action</span></span></span><span class="hljs-function">)</span></span> =&gt; Target.Children .OfType&lt;KeyCounterAction&lt;T&gt;&gt;() .Any(c =&gt; c.OnPressed(action, Clock.Rate &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>));</code> </pre> <br>  Como voc√™ pode ver, o chamador usa o valor retornado pelo m√©todo <i>OnPressed</i> .  Como esse valor √© sempre <i>falso</i> , o chamador tamb√©m sempre retorna <i>falso</i> .  √â muito prov√°vel que esse c√≥digo contenha um erro e deve ser revisado. <br><br>  Outro bug semelhante: <br><br><ul><li>  V3009 [CWE-393] √â estranho que esse m√©todo sempre retorne um e o mesmo valor de 'false'.  KeyCounterAction.cs 30 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Poss√≠vel NullReferenceException.  O '?'  e '.'  operadores s√£o usados ‚Äã‚Äãpara acessar membros do objeto 'val.NewValue' TournamentTeam.cs 41 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TournamentTeam</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Acronym.ValueChanged += val =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (....) FlagName.Value = val.NewValue.Length &gt;= <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-comment"><span class="hljs-comment">// &lt;= ? val.NewValue?.Substring(0, 2).ToUpper() : string.Empty; }; .... }</span></span></code> </pre> <br>  A vari√°vel <i>val.NewValue</i> √© tratada de maneira perigosa na condi√ß√£o do operador <i>?:</i> .  O que faz o analisador pensar assim √© o fato de que mais tarde na ramifica√ß√£o <i>then</i> , a mesma vari√°vel √© tratada de maneira segura usando o operador de acesso condicional: <i>val.NewValue? .Substring (....)</i> . <br><br>  Outro bug semelhante: <br><br><ul><li>  V3042 [CWE-476] Poss√≠vel NullReferenceException.  O '?'  e '.'  operadores s√£o usados ‚Äã‚Äãpara acessar membros do objeto 'val.NewValue' TournamentTeam.cs 48 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3042/">V3042</a> [CWE-476] Poss√≠vel NullReferenceException.  O '?'  e '.'  operadores s√£o usados ‚Äã‚Äãpara acessar membros do objeto 'api' SetupScreen.cs 77 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActionableInfo { Label = <span class="hljs-string"><span class="hljs-string">"Current User"</span></span>, ButtonText = <span class="hljs-string"><span class="hljs-string">"Change Login"</span></span>, Action = () =&gt; { api.Logout(); <span class="hljs-comment"><span class="hljs-comment">// &lt;= .... }, Value = api?.LocalUser.Value.Username, .... }, .... } private class ActionableInfo : LabelledDrawable&lt;Drawable&gt; { .... public Action Action; .... }</span></span></code> </pre> <br>  Este √© mais amb√≠guo, mas acredito que seja um bug tamb√©m.  O programador cria um objeto do tipo <i>ActionableInfo</i> .  O campo <i>A√ß√£o</i> √© inicializado usando uma fun√ß√£o lambda, que lida com a <i>API</i> potencialmente nula de refer√™ncia de uma maneira perigosa.  O analisador considera esse padr√£o um erro porque a vari√°vel <i>api</i> √© tratada de maneira segura mais tarde, ao inicializar o par√¢metro <i>Value</i> .  Eu chamei esse caso de amb√≠guo porque o c√≥digo na fun√ß√£o lambda implica na execu√ß√£o atrasada, no momento em que o desenvolvedor pode de alguma forma garantir que a refer√™ncia da <i>API</i> seja nula.  Mas n√£o tenho certeza disso porque o corpo da fun√ß√£o lambda parece n√£o usar nenhum tratamento de refer√™ncia seguro, como verifica√ß√µes anteriores. <br><br>  <a href="https://www.viva64.com/en/w/v3066/">V3066</a> [CWE-683] Poss√≠vel ordem incorreta de argumentos passada para o m√©todo 'Atan2': 'diff.X' e 'diff.Y'.  SliderBall.cs 182 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> completionProgress</span></span></span><span class="hljs-function">)</span></span> { .... Rotation = <span class="hljs-number"><span class="hljs-number">-90</span></span> + (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)(-Math.Atan2(diff.X, diff.Y) * <span class="hljs-number"><span class="hljs-number">180</span></span> / Math.PI); .... }</code> </pre> <br>  O analisador suspeita que os argumentos do m√©todo <i>Atan2</i> sejam passados ‚Äã‚Äãna ordem errada.  Esta √© a declara√ß√£o do m√©todo: <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">// Parameters: // y: // The y coordinate of a point. // // x: // The x coordinate of a point. public static double Atan2(double y, double x);</span></span></code> </pre> <br>  Os valores foram passados ‚Äã‚Äãna ordem inversa.  N√£o tenho certeza se isso √© um erro, porque o m√©todo <i>UpdateProgress</i> cont√©m muitos c√°lculos n√£o triviais;  Estou apenas mencionando isso como um poss√≠vel bug. <br><br>  <a href="https://www.viva64.com/en/w/v3080/">V3080</a> [CWE-476] Poss√≠vel desrefer√™ncia nula.  Considere inspecionar 'Beatmap'.  WorkingBeatmap.cs 57 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Track </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetVirtualTrack</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObject = Beatmap.HitObjects.LastOrDefault(); .... }</code> </pre> <br>  O analisador aponta uma poss√≠vel desrefer√™ncia nula do <i>Beatmap</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IBeatmap Beatmap { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LoadBeatmapAsync().Result; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (TaskCanceledException) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } }</code> </pre> <br>  Bem, o analisador est√° correto. <br><br>  Para saber mais sobre como o PVS-Studio detecta bugs como esse e sobre os novos recursos adicionados no C # 8.0 que t√™m a ver com o tratamento de refer√™ncias potencialmente nulas, consulte o artigo " <a href="https://www.viva64.com/en/b/0631/">Tipos de refer√™ncia nulos no C # 8.0 e an√°lise est√°tica</a> ". <br><br>  <a href="https://www.viva64.com/en/w/v3083/">V3083</a> [CWE-367] <a href="https://www.viva64.com/en/w/v3083/">Chamada n√£o segura</a> do evento 'ObjectConverted', NullReferenceException √© poss√≠vel.  Considere atribuir um evento a uma vari√°vel local antes de invoc√°-lo.  BeatmapConverter.cs 82 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ObjectConverted != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { converted = converted.ToList(); ObjectConverted.Invoke(obj, converted); } .... }</code> </pre> <br>  Este √© um erro menor e bastante comum.  Os assinantes podem cancelar a inscri√ß√£o do evento entre a verifica√ß√£o nula e a invoca√ß√£o do evento, resultando em uma falha.  Esta √© uma maneira de corrigir o erro: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> List&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">convertHitObjects</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">....</span></span></span><span class="hljs-function">)</span></span> { .... converted = converted.ToList(); ObjectConverted?.Invoke(obj, converted); .... }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3095/">V3095</a> [CWE-476] O objeto 'colunas' foi usado antes de ser verificado com rela√ß√£o a nulo.  Verifique as linhas: 141, 142. SquareGraph.cs 141 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">redrawProgress</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; ColumnCount; i++) columns[i].State = i &lt;= progress ? ColumnState.Lit : ColumnState.Dimmed; columns?.ForceRedraw(); }</code> </pre> <br>  A itera√ß√£o sobre a cole√ß√£o de <i>colunas</i> √© feita de maneira perigosa.  O desenvolvedor assumiu que a refer√™ncia das <i>colunas</i> poderia ser nula, o que √© indicado pelo uso do operador de acesso condicional para acessar ainda mais a cole√ß√£o no c√≥digo. <br><br>  <a href="https://www.viva64.com/en/w/v3119/">V3119</a> Chamar o evento substitu√≠do 'OnNewResult' pode levar a um comportamento imprevis√≠vel.  Considere implementar explicitamente os acessadores de eventos ou use a palavra-chave 'selada'.  DrawableRuleset.cs 256 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addHitObject</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TObject hitObject</span></span></span><span class="hljs-function">)</span></span> { .... drawableObject.OnNewResult += (_, r) =&gt; OnNewResult?.Invoke(r); .... } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> Action&lt;JudgementResult&gt; OnNewResult;</code> </pre> <br>  O analisador diz que √© perigoso usar um evento substitu√≠do ou virtual.  Veja a <a href="https://www.viva64.com/en/w/v3119/">descri√ß√£o</a> do diagn√≥stico para explica√ß√£o.  Tamb√©m escrevi um artigo sobre este t√≥pico: " <a href="https://www.viva64.com/en/b/0453/">Eventos virtuais em C #: algo deu errado</a> ". <br><br>  Aqui est√° outra constru√ß√£o insegura semelhante: <br><br><ul><li>  V3119 A chamada de um evento substitu√≠do pode levar a um comportamento imprevis√≠vel.  Considere implementar explicitamente os acessadores de eventos ou use a palavra-chave 'selada'.  DrawableRuleset.cs 257 </li></ul><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Talvez o '??'  O operador trabalha de uma maneira diferente da esperada.  Sua prioridade √© inferior √† prioridade de outros operadores na parte esquerda.  OsuScreenStack.cs 45 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * ((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>; }</code> </pre> <br>  Para uma melhor compreens√£o, aqui est√° um exemplo sint√©tico que demonstra a l√≥gica original deste c√≥digo: <br><br><pre> <code class="cs hljs">x = (c * a) ?? b;</code> </pre> <br>  O bug decorre do fato de que a preced√™ncia do operador "*" √© maior que a do "??"  operador.  √â assim que o c√≥digo fixo deve se parecer (com par√™nteses adicionados): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onScreenChange</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IScreen prev, IScreen next</span></span></span><span class="hljs-function">)</span></span> { parallaxContainer.ParallaxAmount = ParallaxContainer.DEFAULT_PARALLAX_AMOUNT * (((IOsuScreen)next)?.BackgroundParallaxAmount ?? <span class="hljs-number"><span class="hljs-number">1.0f</span></span>); }</code> </pre> <br>  Outro bug semelhante: <br><br>  <a href="https://www.viva64.com/en/w/v3123/">V3123</a> [CWE-783] Talvez o '??'  O operador trabalha de uma maneira diferente da esperada.  Sua prioridade √© inferior √† prioridade de outros operadores na parte esquerda.  FramedReplayInputHandler.cs 103 <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime - NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  Como no caso anterior, o programador tinha suposi√ß√µes erradas sobre a preced√™ncia dos operadores.  A express√£o original passada para o m√©todo <i>Math.Abs</i> avalia da seguinte maneira: <br><br><pre> <code class="cs hljs">(a ‚Äì b) ?? <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Eis como deve ser corrigido: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> inImportantSection { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IsImportant(frame) &amp;&amp; Math.Abs(CurrentTime ‚Äì (NextFrame?.Time ?? <span class="hljs-number"><span class="hljs-number">0</span></span>)) &lt;= AllowedImportantTimeSpan; } }</code> </pre> <br>  <a href="https://www.viva64.com/en/w/v3142/">V3142</a> [CWE-561] C√≥digo inacess√≠vel detectado.  √â poss√≠vel que haja um erro.  DrawableHoldNote.cs 214 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.OnPressed(action)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Result.Type == HitResult.Miss) <span class="hljs-comment"><span class="hljs-comment">// &lt;= holdNote.hasBroken = true; .... }</span></span></code> </pre> <br>  O analisador acredita que o c√≥digo do manipulador <i>OnPressed</i> est√° inacess√≠vel, come√ßando com a segunda instru√ß√£o <i>if</i> .  Isso decorre do fato de que a primeira condi√ß√£o √© sempre verdadeira, ou seja, que o m√©todo <i>base.OnPressed</i> sempre retornar√° <i>falso</i> .  Vamos dar uma olhada no m√©todo <i>base.OnPressed</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnPressed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ManiaAction action</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (action != Action.Value) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateResult(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }</code> </pre> <br>  E agora no m√©todo <i>UpdateResult</i> : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">UpdateResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userTriggered</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Time.Elapsed &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Judged) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; .... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Judged; }</code> </pre> <br>  Observe que a implementa√ß√£o da propriedade <i>Judged</i> n√£o importa aqui porque a l√≥gica do m√©todo <i>UpdateResult</i> implica que a √∫ltima declara√ß√£o de <i>retorno</i> √© equivalente ao seguinte: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  Isso significa que o m√©todo <i>UpdateResult</i> retornar√° <i>false</i> o tempo todo, levando ao problema de c√≥digo inacess√≠vel anteriormente na pilha. <br><br>  <a href="https://www.viva64.com/en/w/v3146/">V3146</a> [CWE-476] Poss√≠vel desrefer√™ncia nula de 'conjunto de regras'.  O 'FirstOrDefault' pode retornar o valor nulo padr√£o.  APILegacyScoreInfo.cs 24 <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ScoreInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateScoreInfo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">RulesetStore rulesets</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ruleset = rulesets.GetRuleset(OnlineRulesetID); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mods = Mods != <span class="hljs-literal"><span class="hljs-literal">null</span></span> ? ruleset.CreateInstance() <span class="hljs-comment"><span class="hljs-comment">// &lt;= .GetAllMods().Where(....) .ToArray() : Array.Empty&lt;Mod&gt;(); .... }</span></span></code> </pre> <br>  O analisador acredita que a chamada <i>ruleset.CreateInstance ()</i> n√£o √© segura.  Antes desta chamada, a vari√°vel do <i>conjunto de regras</i> recebe um valor como resultado da chamada do m√©todo <i>GetRuleset</i> : <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> RulesetInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRuleset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span> =&gt; AvailableRulesets.FirstOrDefault(....);</code> </pre> <br>  Como voc√™ pode ver, o aviso √© v√°lido, pois a sequ√™ncia de chamadas inclui o m√©todo <i>FirstOrDefault</i> , que pode retornar <i>nulo</i> . <br><br><h2>  Conclus√£o </h2><br>  N√£o h√° muitos bugs no c√≥digo de "osu!", E isso √© bom.  Mas eu ainda recomendo que os autores verifiquem os problemas relatados pelo analisador.  Espero que isso ajude a manter a alta qualidade e que o jogo continue a trazer alegria aos jogadores. <br><br>  Como lembrete, o PVS-Studio √© uma boa op√ß√£o se voc√™ gosta de mexer no c√≥digo-fonte.  O analisador est√° dispon√≠vel para <a href="https://www.viva64.com/en/pvs-studio-download/">download</a> no site oficial.  Outra coisa que voc√™ gostaria de ter em mente √© que verifica√ß√µes √∫nicas como essa n√£o t√™m nada a ver com o uso normal da an√°lise est√°tica no processo de desenvolvimento real.  √â mais eficaz somente quando usado regularmente no servidor de compila√ß√£o e nos computadores dos desenvolvedores (isso √© chamado de an√°lise incremental).  Seu objetivo final √© evitar que os erros entrem no sistema de controle de vers√£o, capturando-os no est√°gio de codifica√ß√£o. <br><br>  Boa sorte e seja criativo! <br><br><h2>  Refer√™ncias </h2><br>  Este √© o nosso primeiro artigo em 2020. Enquanto estamos no assunto, aqui est√£o os links para as verifica√ß√µes dos projetos C # realizados no ano passado: <br><br><ul><li>  <a href="https://www.viva64.com/en/b/0605/">Procurando por erros no c√≥digo-fonte do Amazon Web Services SDK para .NET</a> </li><li>  <a href="https://www.viva64.com/en/b/0622/">Verificando o c√≥digo fonte de Roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0631/">Tipos de refer√™ncia anul√°veis ‚Äã‚Äãem C # 8.0 e an√°lise est√°tica</a> </li><li>  <a href="https://www.viva64.com/en/b/0653/">WinForms: erros, Holmes</a> </li><li>  <a href="https://www.viva64.com/en/b/0654/">A hist√≥ria de como o PVS-Studio encontrou um erro na biblioteca usada em ... PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0656/">Verificando o c√≥digo-fonte das bibliotecas do .NET Core pelo analisador est√°tico PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0664/">Verifica√ß√£o dos analisadores roslyn</a> </li><li>  <a href="https://www.viva64.com/en/b/0677/">Verificando a interface do usu√°rio da Telerik quanto √† UWP como uma maneira de iniciar o PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0678/">Azure PowerShell: Principalmente inofensivo</a> </li><li>  <a href="https://www.viva64.com/en/b/0681/">Digitalizando o c√≥digo do Orchard CMS for Bugs</a> </li><li>  <a href="https://www.viva64.com/en/b/0683/">Verificando o OpenCvSharp Wrapper para OpenCV com PVS-Studio</a> </li><li>  <a href="https://www.viva64.com/en/b/0692/">Azure SDK for .NET: hist√≥ria sobre uma pesquisa de erro dif√≠cil</a> </li><li>  <a href="https://www.viva64.com/en/b/0694/">SARIF SDK e seus erros</a> </li><li>  <a href="https://www.viva64.com/en/b/0698/">Os 10 principais erros encontrados em projetos C # em 2019</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt483436/">https://habr.com/ru/post/pt483436/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt483416/index.html">Tentando automatizar processos usando o Powershell</a></li>
<li><a href="../pt483418/index.html">Sistemas de ingressos: como voc√™ conseguiu tr√™s OTRS gratuitos pagos?</a></li>
<li><a href="../pt483424/index.html">DBA: transferindo valores de SEQUENCE entre bancos de dados PostgreSQL</a></li>
<li><a href="../pt483426/index.html">Friday Tab Survey</a></li>
<li><a href="../pt483428/index.html">Qual ser√° o gerenciamento de documentos eletr√¥nicos ap√≥s a entrada em vigor de altera√ß√µes √† lei sobre assinatura eletr√¥nica?</a></li>
<li><a href="../pt483438/index.html">Toque "osu!", N√£o se esque√ßa dos erros</a></li>
<li><a href="../pt483440/index.html">√öltimos compiladores D</a></li>
<li><a href="../pt483444/index.html">Relat√≥rio DORA 2019: Como melhorar o desempenho do DevOps</a></li>
<li><a href="../pt483446/index.html">Cientistas descobriram uma nova maneira de diminuir os n√≠veis de ferro na √°gua pot√°vel</a></li>
<li><a href="../pt483448/index.html">Disney - A maior via dupla da hist√≥ria da humanidade</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>