<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üó∫Ô∏è üë®üèæ‚Äçüé§ ‚ùóÔ∏è Migration d'un sch√©ma de base de donn√©es sans interruption pour postgresql en utilisant django comme exemple üå≥ üëäüèº üë®üèø‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©sentation 


 Bonjour, Habr! 


 Je veux partager l'exp√©rience de l'√©criture de migrations pour postgres et django. Il s'agira principalement de po...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migration d'un sch√©ma de base de donn√©es sans interruption pour postgresql en utilisant django comme exemple</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/425063/"><h1 id="vvedenie">  Pr√©sentation </h1><br><p>  Bonjour, Habr! </p><br><p>  Je veux partager l'exp√©rience de l'√©criture de migrations pour postgres et django.  Il s'agira principalement de postgres, django est un bon ajout ici, car il a une migration automatique du sch√©ma de donn√©es pour les changements de mod√®le hors de la bo√Æte, c'est-√†-dire qu'il a une liste assez compl√®te d'op√©rations de travail pour changer le sch√©ma.  Django peut √™tre remplac√© par n'importe quel framework / biblioth√®que pr√©f√©r√© - les approches seront tr√®s probablement similaires. </p><br><p>  Je ne d√©crirai pas comment j'en suis arriv√© √† cela, mais maintenant, en lisant la documentation, j'ai compris l'id√©e qu'il √©tait n√©cessaire de le faire plus t√¥t avec plus de soin et de sensibilisation, donc je le recommande vivement. </p><br><p>  Avant d'aller plus loin, permettez-moi de faire les hypoth√®ses suivantes. </p><br><p>  Vous pouvez diviser la logique de travail avec la base de donn√©es de la plupart des applications en 3 parties: </p><br><ol><li> Migrations - modification du sch√©ma de la base de donn√©es (tables), supposons que nous les ex√©cutions toujours dans un seul thread. </li><li>  Logique d'entreprise - travail direct avec les donn√©es (dans les tableaux d'utilisateurs), fonctionne avec les m√™mes donn√©es en permanence et de mani√®re comp√©titive. </li><li>  Migrations de donn√©es - ne modifient pas les sch√©mas de donn√©es, ils fonctionnent essentiellement comme la logique m√©tier, par d√©faut, lorsque nous parlons de logique m√©tier, nous entendons √©galement les migrations de donn√©es. </li></ol><br><p>  Le temps d'arr√™t est un √©tat lorsqu'une partie de notre logique m√©tier n'est pas disponible / tombe / est charg√©e pendant un temps notable pour l'utilisateur, supposons que cela dure quelques secondes. </p><br><p>  L'absence de temps d'arr√™t peut √™tre une condition critique pour une entreprise, qui doit √™tre respect√©e par tous les efforts. <a name="habracut"></a></p><br><h1 id="process-vykatki">  Processus de d√©ploiement </h1><br><p>  Les principales exigences lors du d√©ploiement: </p><br><ol><li>  nous avons une base de travail. </li><li>  nous avons plusieurs machines o√π la logique m√©tier tourne. </li><li>  les voitures √† logique m√©tier sont cach√©es derri√®re l'√©quilibreur. </li><li>  notre application fonctionne bien avant, pendant et apr√®s la migration continue (l'ancien code fonctionne correctement avec l'ancien et le nouveau sch√©ma de base de donn√©es). </li><li>  Notre application fonctionne bien avant, pendant et apr√®s la mise √† jour du code sur les voitures (l'ancien et le nouveau code fonctionnent correctement avec le sch√©ma de base de donn√©es actuel). </li></ol><br><p>  S'il y a un grand nombre de modifications et que le d√©ploiement cesse de satisfaire √† ces conditions, il est divis√© en le nombre requis de d√©ploiements plus petits satisfaisant √† ces conditions, sinon nous avons un temps d'arr√™t. </p><br><p>  Ordre de d√©ploiement direct: </p><br><ol><li>  inond√© la migration; </li><li>  supprim√© une machine de l'√©quilibreur, mis √† jour la machine et red√©marr√©, renvoy√© la machine √† l'√©quilibreur; </li><li>  a r√©p√©t√© l'√©tape pr√©c√©dente pour mettre √† jour toutes les voitures. </li></ol><br><p>  L'ordre de d√©ploiement invers√© est pertinent pour supprimer des tables et des colonnes dans une table, lorsque nous cr√©ons automatiquement des migrations conform√©ment au sch√©ma modifi√© et validons la pr√©sence de toutes les migrations vers CI: </p><br><ol><li>  supprim√© une machine de l'√©quilibreur, mis √† jour la machine et red√©marr√©, renvoy√© la machine √† l'√©quilibreur; </li><li>  a r√©p√©t√© l'√©tape pr√©c√©dente pour mettre √† jour toutes les voitures; </li><li>  inond√© la migration. </li></ol><br><h1 id="teoriya">  Th√©orie </h1><br><p>  Postgres est une excellente base de donn√©es, nous pouvons √©crire une application qui va √©crire et lire les m√™mes donn√©es dans des centaines et des milliers de flux, et avec une forte probabilit√©, nous pouvons √™tre s√ªrs que nos donn√©es resteront valides et ne seront pas corrompues, en g√©n√©ral, ACID complet.  Postgres met en ≈ìuvre plusieurs m√©canismes pour y parvenir, dont l'un bloque. </p><br><p>  Postgres a plusieurs types de verrous, vous pouvez voir plus de d√©tails <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> , dans le cadre du sujet, je ne couvrirai que les verrous de table et d'√©criture. </p><br><h2 id="blokirovki-na-urovne-tablicy">  Verrous de niveau de table </h2><br><p>  Au niveau de la table, postgres a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plusieurs types de verrous</a> , la principale caract√©ristique est qu'ils ont des conflits, c'est-√†-dire que deux op√©rations avec des verrous en conflit ne peuvent pas √™tre effectu√©es simultan√©ment: </p><br><table><thead><tr><th></th><th><code>ACCESS SHARE</code> </th> <th> <code>ROW SHARE</code> </th> <th> <code>ROW EXCLUSIVE</code> </th> <th> <code>SHARE UPDATE EXCLUSIVE</code> </th> <th> <code>SHARE</code> </th> <th> <code>SHARE ROW EXCLUSIVE</code> </th> <th> <code>EXCLUSIVE</code> </th> <th> <code>ACCESS EXCLUSIVE</code> </th> </tr></thead><tbody><tr><td> <code>ACCESS SHARE</code> </td> <td></td><td></td><td></td><td></td><td></td><td></td><td></td><td>  X </td></tr><tr><td> <code>ROW SHARE</code> </td> <td></td><td></td><td></td><td></td><td></td><td></td><td>  X </td><td>  X </td></tr><tr><td> <code>ROW EXCLUSIVE</code> </td> <td></td><td></td><td></td><td></td><td>  X </td><td>  X </td><td>  X </td><td>  X </td></tr><tr><td> <code>SHARE UPDATE EXCLUSIVE</code> </td> <td></td><td></td><td></td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td></tr><tr><td> <code>SHARE</code> </td> <td></td><td></td><td>  X </td><td>  X </td><td></td><td>  X </td><td>  X </td><td>  X </td></tr><tr><td> <code>SHARE ROW EXCLUSIVE</code> </td> <td></td><td></td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td></tr><tr><td> <code>EXCLUSIVE</code> </td> <td></td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td></tr><tr><td> <code>ACCESS EXCLUSIVE</code> </td> <td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td><td>  X </td></tr></tbody></table><br><p>  Par exemple, <code>ALTER TABLE tablename ADD COLUMN newcolumn integer</code> et <code>SELECT COUNT(*) FROM tablename</code> doivent √™tre strictement ex√©cut√©s un par un, sinon nous ne pouvons pas trouver les colonnes √† retourner √† <code>COUNT(*)</code> . </p><br><p>  Dans les migrations django (liste compl√®te ci-dessous), il existe les op√©rations suivantes et leurs verrous correspondants: </p><br><table><thead><tr><th>  blocage </th><th>  op√©rations </th></tr></thead><tbody><tr><td> <code>ACCESS EXCLUSIVE</code> </td> <td>  <code>CREATE SEQUENCE</code> , <code>CREATE SEQUENCE</code> <code>DROP SEQUENCE</code> , <code>CREATE TABLE</code> <code>DROP SEQUENCE</code> <code>CREATE TABLE</code> , <code>DROP SEQUENCE</code> <code>CREATE TABLE</code> <code>DROP SEQUENCE</code> , <code>DROP SEQUENCE</code> <code>ALTER TABLE</code> , <code>DROP INDEX</code> </td></tr><tr><td> <code>SHARE</code> </td> <td> <code>CREATE INDEX</code> </td> </tr><tr><td> <code>SHARE UPDATE EXCLUSIVE</code> </td> <td>  <code>CREATE INDEX CONCURRENTLY</code> , <code>DROP INDEX CONCURRENTLY</code> , <code>ALTER TABLE VALIDATE CONSTRAINT</code> </td></tr></tbody></table><br><p>  Parmi les commentaires, tous les <code>ALTER TABLE</code> n'ont pas de verrou <code>ACCESS EXCLUSIVE</code> , les migrations django n'ont pas non plus <code>CREATE INDEX CONCURRENTLY</code> et <code>ALTER TABLE VALIDATE CONSTRAINT</code> , mais elles seront n√©cessaires pour une alternative plus s√ªre aux op√©rations standard un peu plus tard. </p><br><p>  Si les migrations sont effectu√©es s√©quentiellement dans un thread, tout semble correct, car la migration n'entrera pas en conflit avec une autre migration, mais notre logique m√©tier fonctionnera uniquement pendant la migration et le conflit. </p><br><table><thead><tr><th>  blocage </th><th>  op√©rations </th><th>  conflits avec les verrous </th><th>  conflits avec les op√©rations </th></tr></thead><tbody><tr><td> <code>ACCESS SHARE</code> </td> <td> <code>SELECT</code> </td> <td> <code>ACCESS EXCLUSIVE</code> </td> <td>  <code>ALTER TABLE</code> , <code>DROP INDEX</code> </td></tr><tr><td> <code>ROW SHARE</code> </td> <td> <code>SELECT FOR UPDATE</code> </td> <td>  <code>ACCESS EXCLUSIVE</code> , <code>EXCLUSIVE</code> </td><td>  <code>ALTER TABLE</code> , <code>DROP INDEX</code> </td></tr><tr><td> <code>ROW EXCLUSIVE</code> </td> <td>  <code>INSERT</code> , <code>UPDATE</code> , <code>DELETE</code> </td><td>  <code>ACCESS EXCLUSIVE</code> , <code>EXCLUSIVE</code> , <code>SHARE ROW EXCLUSIVE</code> , <code>SHARE</code> </td><td>  <code>ALTER TABLE</code> , <code>DROP INDEX</code> , <code>CREATE INDEX</code> </td></tr></tbody></table><br><p>  Deux points peuvent √™tre r√©sum√©s ici: </p><br><ol><li>  s'il existe une alternative avec un verrouillage plus facile, vous pouvez l'utiliser comme <code>CREATE INDEX</code> et <code>CREATE INDEX CONCURRENTLY</code> . </li><li>  la plupart des migrations pour modifier le sch√©ma de donn√©es entrent en conflit avec la logique m√©tier, en outre, elles entrent en conflit avec <code>ACCESS EXCLUSIVE</code> , c'est-√†-dire que nous ne serons m√™me pas en mesure de s√©lectionner tout en maintenant ce verrou et potentiellement attendre un temps d'arr√™t ici, sauf dans le cas o√π cette op√©ration ne fonctionne pas instantan√©ment et notre temps d'arr√™t sera quelques secondes. </li></ol><br><p>  Il doit y avoir un choix, ou nous √©vitons toujours <code>ACCESS EXCLUSIVE</code> , c'est-√†-dire que nous cr√©ons de nouvelles plaques et copions les donn√©es l√†-bas - de mani√®re fiable, mais pendant longtemps pour une grande quantit√© de donn√©es, ou <code>ACCESS EXCLUSIVE</code> aussi rapide que possible et √©mettons des avertissements suppl√©mentaires contre les temps d'arr√™t - potentiellement dangereux, mais rapides. </p><br><h2 id="blokirovki-na-urovne-zapisi">  Verrous d'enregistrement </h2><br><p>  Au niveau de l'enregistrement, il existe √©galement des verrous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.postgresql.org/docs/current/static/explicit-locking.html#LOCKING-ROWS</a> , ils sont √©galement en conflit, mais ils n'affectent que notre logique m√©tier: </p><br><table><thead><tr><th></th><th> <code>FOR KEY SHARE</code> </th> <th> <code>FOR SHARE</code> </th> <th> <code>FOR NO KEY UPDATE</code> </th> <th> <code>FOR UPDATE</code> </th> </tr></thead><tbody><tr><td> <code>FOR KEY SHARE</code> </td> <td></td><td></td><td></td><td>  X </td></tr><tr><td> <code>FOR SHARE</code> </td> <td></td><td></td><td>  X </td><td>  X </td></tr><tr><td> <code>FOR NO KEY UPDATE</code> </td> <td></td><td>  X </td><td>  X </td><td>  X </td></tr><tr><td> <code>FOR UPDATE</code> </td> <td>  X </td><td>  X </td><td>  X </td><td>  X </td></tr></tbody></table><br><p>  C'est le point principal des migrations de donn√©es, c'est-√†-dire que si nous effectuons une <code>UPDATE</code> la migration des donn√©es sur toute la plaque, le reste de la logique m√©tier, qui met √† jour les donn√©es, attendra que le verrou soit lib√©r√© et peut d√©passer notre seuil d'indisponibilit√©, il est donc pr√©f√©rable de faire des mises √† jour en partie pour les migrations de donn√©es.  Il convient √©galement de noter que lors de l'utilisation de requ√™tes SQL plus complexes pour les migrations de donn√©es, la division en parties peut fonctionner plus rapidement, car elle peut utiliser un plan et des index plus optimaux. </p><br><h2 id="ocheryodnost-vypolneniya-operaciy">  L'ordre des op√©rations </h2><br><p>  Une autre connaissance importante est de savoir comment les op√©rations seront effectu√©es, quand et comment elles prennent et lib√®rent les verrous: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/889/8f9/adb/8898f9adbf4eab0350517d07177b7257.png" alt="image"></p><br><p>  Ici, vous pouvez mettre en √©vidence les √©l√©ments suivants: </p><br><ol><li>  temps d'ex√©cution de l'op√©ration - pour la migration, c'est le temps de maintenir le verrou, si le verrou lourd est maintenu pendant une longue p√©riode, nous aurons un temps d'arr√™t, par exemple, cela peut √™tre avec <code>CREATE INDEX</code> ou <code>ALTER TABLE ADD COLUMN SET DEFAULT</code> (dans postgres 11 c'est mieux). </li><li>  le temps d'attente pour les verrous conflictuels - c'est-√†-dire que la migration attend jusqu'√† ce que toutes les demandes conflictuelles fonctionnent, et √† ce moment, de nouvelles demandes attendront notre migration, les demandes lentes peuvent √™tre tr√®s dangereuses ici, simplement non optimales ou analytiques, donc il ne devrait pas y avoir de demandes lentes pendant la migration. </li><li>  le nombre de demandes par seconde - si nous avons beaucoup de demandes en cours de traitement pendant une longue p√©riode, alors les connexions gratuites peuvent se terminer rapidement et au lieu d'un endroit probl√©matique, la base de donn√©es enti√®re peut entrer en temps d'arr√™t (il n'y aura qu'une limite de connexion pour le superutilisateur), ici vous devez √©viter les demandes lentes, r√©duire le nombre de demandes par exemple, d√©marrez les migrations pendant la charge minimale, s√©parez les composants critiques en diff√©rents services avec leurs propres bases de donn√©es. </li><li>  il y a beaucoup d'op√©rations de migrations dans une transaction - plus il y a d'op√©rations dans une transaction, plus le verrou lourd est maintenu, il est donc pr√©f√©rable de s√©parer les op√©rations lourdes, pas de <code>ALTER TABLE VALIDATE CONSTRAINT</code> ou de migration de donn√©es dans une transaction avec un verrou lourd. </li></ol><br><h2 id="taymauty">  D√©lais </h2><br><p>  <code>lock_timeout</code> a des param√®tres tels que <code>lock_timeout</code> et <code>statement_timeout</code> , qui peuvent prot√©ger le d√©but des migrations, √† la fois contre une migration mal √©crite et contre de mauvaises conditions dans lesquelles la migration peut √™tre d√©clench√©e.  Ils peuvent √™tre install√©s globalement et pour la connexion actuelle. </p><br><p>  <code>SET lock_timeout TO '2s'</code> √©vitera les temps d'arr√™t en attendant des demandes / transactions lentes avant la migration: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.postgresql.org/docs/current/static/runtime-config-client.html#GUC-LOCK-TIMEOUT</a> . </p><br><p>  <code>SET statement_timeout TO '2s'</code> √©vitera les temps d'arr√™t lors du d√©marrage d'une migration lourde avec un verrou lourd: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.postgresql.org/docs/current/static/runtime-config-client.html#GUC-STATEMENT-TIMEOUT</a> . </p><br><h2 id="dedloki">  Deadlocks </h2><br><p>  Les blocages dans les migrations ne concernent pas les temps d'arr√™t, mais ce n'est pas agr√©able lors de l'√©criture de la migration, cela fonctionne bien dans un environnement de test, mais il intercepte les blocages lors du roulement sur le prod.  Les principales sources de probl√®mes peuvent √™tre un grand nombre d'op√©rations dans une transaction et une cl√© √©trang√®re, car il cr√©e des verrous dans les deux tables, il est donc pr√©f√©rable de s√©parer les op√©rations de migration, plus atomique est meilleur. </p><br><h2 id="hranenie-zapisey">  Stockage des enregistrements </h2><br><p>  Postgres <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">stocke les valeurs de diff√©rents types de diff√©rentes mani√®res</a> : si les types sont stock√©s diff√©remment, la conversion entre eux n√©cessitera une r√©√©criture compl√®te de toutes les valeurs, heureusement certains types sont stock√©s de la m√™me mani√®re et n'ont pas besoin d'√™tre r√©√©crits lorsqu'ils sont modifi√©s.  Par exemple, les lignes sont stock√©es de la m√™me mani√®re quelle que soit la taille et la diminution / augmentation de la dimension d'une ligne ne n√©cessitera pas de r√©√©criture, mais la diminution n√©cessite de v√©rifier que toutes les lignes ne d√©passent pas une taille plus petite.  D'autres types peuvent √©galement √™tre stock√©s de mani√®re similaire et avoir des caract√©ristiques similaires. </p><br><h2 id="multiversion-concurrency-control-mvcc">  Contr√¥le d'acc√®s simultan√© multiversion (MVCC) </h2><br><p>  Selon la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> , la coh√©rence postgres est bas√©e sur le multiversion des donn√©es, c'est-√†-dire que chaque transaction et op√©ration voit sa propre version des donn√©es.  Cette fonctionnalit√© g√®re l'acc√®s concurrentiel et donne √©galement un effet int√©ressant lors de la modification d'un sch√©ma comme l'ajout et la suppression de colonnes ne modifie que le sch√©ma, s'il n'y a pas d'op√©rations suppl√©mentaires pour modifier les donn√©es, les index ou les constantes, apr√®s quoi les op√©rations d'insertion et de mise √† jour √† un bas niveau cr√©eront de nouvelles enregistrements avec toutes les valeurs n√©cessaires, la suppression marquera l'enregistrement correspondant supprim√©.  VACUUM ou AUTO VACUUM est responsable du nettoyage des d√©bris restants. </p><br><h1 id="primer-django">  Exemple Django </h1><br><p>  Nous avons maintenant une id√©e de ce dont les temps d'arr√™t peuvent d√©pendre et comment les √©viter, mais avant d'appliquer les connaissances, vous pouvez regarder ce que django donne hors de la bo√Æte ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/django/django/blob/2.1.2/django /db/backends/base/schema.py</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/django/django/blob/2.1.2/django/db/backends/postgresql/schema.py</a> ): </p><br><table><thead><tr><th></th><th>  op√©ration </th></tr></thead><tbody><tr><td>  1 </td><td> <code>CREATE SEQUENCE</code> </td> </tr><tr><td>  2 </td><td> <code>DROP SEQUENCE</code> </td> </tr><tr><td>  3 </td><td> <code>CREATE TABLE</code> </td> </tr><tr><td>  4 </td><td> <code>DROP TABLE</code> </td> </tr><tr><td>  5 </td><td> <code>ALTER TABLE RENAME TO</code> </td> </tr><tr><td>  6 </td><td> <code>ALTER TABLE SET TABLESPACE</code> </td> </tr><tr><td>  7 </td><td> <code>ALTER TABLE ADD COLUMN [SET DEFAULT] [SET NOT NULL] [PRIMARY KEY] [UNIQUE]</code> </td> </tr><tr><td>  8 </td><td> <code>ALTER TABLE ALTER COLUMN [TYPE] [SET NOT NULL|DROP NOT NULL] [SET DEFAULT|DROP DEFAULT]</code> </td> </tr><tr><td>  9 </td><td> <code>ALTER TABLE DROP COLUMN</code> </td> </tr><tr><td>  10 </td><td> <code>ALTER TABLE RENAME COLUMN</code> </td> </tr><tr><td>  11 </td><td> <code>ALTER TABLE ADD CONSTRAINT CHECK</code> </td> </tr><tr><td>  12 </td><td> <code>ALTER TABLE DROP CONSTRAINT CHECK</code> </td> </tr><tr><td>  13 </td><td> <code>ALTER TABLE ADD CONSTRAINT FOREIGN KEY</code> </td> </tr><tr><td>  14 </td><td> <code>ALTER TABLE DROP CONSTRAINT FOREIGN KEY</code> </td> </tr><tr><td>  15 </td><td> <code>ALTER TABLE ADD CONSTRAINT PRIMARY KEY</code> </td> </tr><tr><td>  16 </td><td> <code>ALTER TABLE DROP CONSTRAINT PRIMARY KEY</code> </td> </tr><tr><td>  17 </td><td> <code>ALTER TABLE ADD CONSTRAINT UNIQUE</code> </td> </tr><tr><td>  18 </td><td> <code>ALTER TABLE DROP CONSTRAINT UNIQUE</code> </td> </tr><tr><td>  19 </td><td> <code>CREATE INDEX</code> </td> </tr><tr><td>  20 </td><td> <code>DROP INDEX</code> </td> </tr></tbody></table><br><p>  Django couvre tr√®s bien mes besoins de migration, maintenant nous pouvons discuter des op√©rations s√ªres et dangereuses pour les migrations sans temps d'arr√™t √† notre connaissance. </p><br><p>  Nous appellerons des migrations plus s√ªres avec le verrouillage <code>SHARE UPDATE EXCLUSIVE</code> ou <code>ACCESS EXCLUSIVE</code> , qui fonctionne instantan√©ment. <br>  Nous appellerons des migrations dangereuses avec des verrous <code>SHARE</code> et <code>ACCESS EXCLUSIVE</code> , qui prennent un temps consid√©rable. </p><br><p>  Je vais laisser un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">lien</a> utile <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">vers la documentation</a> √† l'avance avec de bons exemples. </p><br><h2 id="sozdanie-i-udalenie-tablicy">  Cr√©er et supprimer une table </h2><br><p>  <code>CREATE SEQUENCE</code> , <code>DROP SEQUENCE</code> , <code>CREATE TABLE</code> , <code>DROP TABLE</code> peuvent √™tre appel√©s s√ªrs, car la logique m√©tier ne fonctionne plus avec la table migr√©e, le comportement de suppression d'une table avec FOREIGN KEY sera un peu plus tard. </p><br><h2 id="tyazhelo-podderzhivaemye-operacii-na-rabochih-tablicah">  Op√©rations de feuille de calcul fortement prises en charge </h2><br><p>  <code>ALTER TABLE RENAME TO</code> - Je ne peux pas appeler cela s√ªr, car il est difficile d'√©crire une logique qui fonctionne avec une telle table avant et apr√®s la migration. </p><br><p>  <code>ALTER TABLE SET TABLESPACE</code> - dangereux, car il d√©place physiquement la plaque, ce qui peut prendre beaucoup de temps sur un grand volume. </p><br><p>  En revanche, ces op√©rations sont assez rares, comme alternative vous pouvez proposer la cr√©ation d'une nouvelle table et la copie des donn√©es dans celle-ci. </p><br><h2 id="sozdanie-i-udalenie-kolonki">  Cr√©er et supprimer des colonnes </h2><br><p>  <code>ALTER TABLE ADD COLUMN</code> , <code>ALTER TABLE DROP COLUMN</code> - peut √™tre appel√© s√ªr (cr√©ation sans DEFAULT / NOT NULL / PRIMARY KEY / UNIQUE), car la logique m√©tier ne fonctionne plus avec une colonne migr√©e, le comportement de suppression d'une colonne avec FOREIGN KEY, d'autres constantes et index viendront plus tard. </p><br><p>  <code>ALTER TABLE ADD COLUMN SET DEFAULT</code> , <code>ALTER TABLE ADD COLUMN SET NOT NULL</code> , <code>ALTER TABLE ADD COLUMN PRIMARY KEY</code> , <code>ALTER TABLE ADD COLUMN UNIQUE</code> - op√©rations dangereuses, car elles ajoutent une colonne et, sans rel√¢cher les verrous, mettent √† jour les donn√©es avec des valeurs par d√©faut ou cr√©ent des constructions comme alternatives, colonnes nullables et modifications suppl√©mentaires. </p><br><p>  Il convient de mentionner le <code>SET DEFAULT</code> plus rapide dans postgres 11, il peut √™tre consid√©r√© comme s√ªr, mais il ne devient pas tr√®s utile dans django, car django utilise <code>SET DEFAULT</code> uniquement pour remplir la colonne, puis cr√©e <code>DROP DEFAULT</code> , et dans l'intervalle entre la migration et la mise √† jour des machines avec la logique m√©tier, des enregistrements peuvent √™tre cr√©√©s dans lesquels la valeur par d√©faut sera absente, c'est-√†-dire, tout de m√™me, faire la migration des donn√©es. </p><br><h2 id="tyazhelo-podderzhivaemye-operacii-na-rabochey-tablice">  Op√©rations fortement prises en charge sur une feuille de calcul </h2><br><p>  <code>ALTER TABLE RENAME COLUMN</code> - Je ne peux pas non plus l'appeler s√ªr, car il est difficile d'√©crire une logique qui fonctionne avec une telle colonne avant et apr√®s la migration.  Au contraire, cette op√©ration ne sera pas non plus fr√©quente, car une alternative peut √™tre propos√©e pour cr√©er une nouvelle colonne et y copier des donn√©es. </p><br><h2 id="izmenenie-kolonki">  Changement de colonne </h2><br><p>  <code>ALTER TABLE ALTER COLUMN TYPE</code> - l'op√©ration peut √™tre √† la fois dangereuse et s√ªre.  S√ªr si postgres ne modifie que le sch√©ma et que les donn√©es sont d√©j√† stock√©es au format requis et que des v√©rifications de type suppl√©mentaires ne sont pas n√©cessaires, par exemple: </p><br><ul><li>  changement de type de <code>varchar(LESS)</code> √† <code>varchar(MORE)</code> ; </li><li>  changement de type de <code>varchar(ANY)</code> en <code>text</code> ; </li><li>  tapez le changement de <code>numeric(LESS, SAME)</code> √† <code>numeric(MORE, SAME)</code> . </li></ul><br><p>  <code>ALTER TABLE ALTER COLUMN SET NOT NULL</code> est dangereux, car il passe √† travers les donn√©es √† l'int√©rieur et v√©rifie NULL, heureusement cette construction peut √™tre remplac√©e par un autre <code>CHECK IS NOT NULL</code> .  Il est √† noter que ce remplacement conduira √† un sch√©ma diff√©rent, mais avec des propri√©t√©s identiques. </p><br><p>  <code>ALTER TABLE ALTER COLUMN DROP NOT NULL</code> , <code>ALTER TABLE ALTER COLUMN SET DEFAULT</code> , <code>ALTER TABLE ALTER COLUMN DROP DEFAULT</code> - op√©rations s√ªres. </p><br><h2 id="sozdanie-i-udalenie-indeksov-i-konstreyntov">  Cr√©ation et suppression d'index et de constantes </h2><br><p>  <code>ALTER TABLE ADD CONSTRAINT CHECK</code> et <code>ALTER TABLE ADD CONSTRAINT FOREIGN KEY</code> sont des op√©rations dangereuses, mais elles peuvent √™tre d√©clar√©es <code>NOT VALID</code> , puis <code>ALTER TABLE VALIDATE CONSTRAINT</code> . </p><br><p>  <code>ALTER TABLE ADD CONSTRAINT PRIMARY KEY</code> et <code>ALTER TABLE ADD CONSTRAINT UNIQUE</code> pas s√ªrs, car ils cr√©ent un index unique √† l'int√©rieur, mais vous pouvez cr√©er un index unique comme <code>CONCURRENTLY</code> , puis cr√©er la constante correspondante √† l'aide d'un index pr√™t √† l'emploi via <code>USING INDEX</code> . </p><br><p>  <code>CREATE INDEX</code> est une op√©ration dangereuse, mais un index peut √™tre cr√©√© de mani√®re <code>CONCURRENTLY</code> . </p><br><p>  <code>ALTER TABLE DROP CONSTRAINT CHECK</code> , <code>ALTER TABLE DROP CONSTRAINT FOREIGN KEY</code> , <code>ALTER TABLE DROP CONSTRAINT PRIMARY KEY</code> , <code>ALTER TABLE DROP CONSTRAINT UNIQUE</code> , <code>DROP INDEX</code> - op√©rations s√ªres. </p><br><p>  Il convient de noter que <code>ALTER TABLE ADD CONSTRAINT FOREIGN KEY</code> et <code>ALTER TABLE DROP CONSTRAINT FOREIGN KEY</code> verrouillent deux tables √† la fois. </p><br><h2 id="primenyaem-znaniya-v-django">  Appliquer les connaissances dans Django </h2><br><p>  Django a une op√©ration dans les migrations pour ex√©cuter n'importe quel SQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://docs.djangoproject.com/en/2.1/ref/migration-operations/#django.db.migrations.operations.RunSQL</a> .  Gr√¢ce √† lui, vous pouvez d√©finir les d√©lais d' <code>state_operations</code> n√©cessaires et appliquer des op√©rations alternatives pour les migrations, en indiquant <code>state_operations</code> - la migration que nous <code>state_operations</code> . </p><br><p>  Cela fonctionne bien pour son code, bien qu'il n√©cessite des √©critures suppl√©mentaires, mais vous pouvez laisser le sale boulot sur le back-end db, par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/tbicr/django-pg-zero-downtime-migrations/blob/master/django_zero_downtime_migrations_postgres_backend/schema .py</a> recueille les pratiques d√©crites et remplace les op√©rations dangereuses par des homologues s√©curis√©es, et cela fonctionnera pour les biblioth√®ques tierces. </p><br><h1 id="naposledok">  En fin de compte </h1><br><p>  Ces pratiques m'ont permis d'obtenir un sch√©ma identique cr√©√© par django hors de la bo√Æte, √† l'exception du remplacement de la construction <code>CHECK IS NOT NULL</code> au lieu de <code>NOT NULL</code> et de certains noms de construction (par exemple, pour <code>ALTER TABLE ADD COLUMN UNIQUE</code> et une alternative).  Un autre compromis peut √™tre le manque de transactionnalit√© pour les op√©rations de migration alternatives, en particulier lorsque <code>CREATE INDEX CONCURRENTLY</code> et <code>ALTER TABLE VALIDATE CONSTRAINT</code> . </p><br><p>  Si vous n'allez pas au-del√† des postgres, il peut y avoir de nombreuses options pour modifier le sch√©ma de donn√©es, et elles peuvent √™tre modifi√©es en combinaison dans des conditions sp√©cifiques: </p><br><ul><li>  utiliser jsonb comme solution sans faille </li><li>  la possibilit√© d'aller aux temps d'arr√™t </li><li>  obligation d'effectuer des migrations sans interruption </li></ul><br><p>  En tout cas, j'esp√®re que le mat√©riel s'est av√©r√© utile soit pour augmenter la disponibilit√© soit pour √©tendre la conscience. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr425063/">https://habr.com/ru/post/fr425063/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr425053/index.html">SSR: quand, pourquoi et pour quoi. Sur l'exemple de Vue</a></li>
<li><a href="../fr425055/index.html">Qu√™te Oculus</a></li>
<li><a href="../fr425057/index.html">Pr√™t pr√©f√©rentiel pour l'√©ducation pour tous les programmes GeekUniversity de GeekBrains et Alfa Bank</a></li>
<li><a href="../fr425059/index.html">Hackathon n ¬∞ 1 sur Tinkoff.ru</a></li>
<li><a href="../fr425061/index.html">CodeRainbow: apprentissage interactif du code et documentation</a></li>
<li><a href="../fr425069/index.html">Test d'un pr√©sentateur √† l'aide de PromiseKit</a></li>
<li><a href="../fr425071/index.html">Comment se prot√©ger contre le d√©bordement de pile (sur Cortex M)?</a></li>
<li><a href="../fr425073/index.html">Cr√©ation facile de r√©f√©rentiel git sur OneDrive</a></li>
<li><a href="../fr425075/index.html">Vision industrielle: installation, configuration et utilisation de Google Cloud Vision en PHP</a></li>
<li><a href="../fr425077/index.html">Kotlin sous le capot - voir bytecode d√©compil√©</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>