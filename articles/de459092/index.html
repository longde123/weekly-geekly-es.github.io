<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✍🏻 🥖 🛌🏾 X.Spectator - Statusüberwachung in .NET 👨🏻‍⚖️ 🤘🏾 🍻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Heutzutage sind die meisten Informationssysteme komplexe Lösungen mit einer ziemlich komplexen Architektur und einer großen Anzahl gegenseitiger Abhän...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>X.Spectator - Statusüberwachung in .NET</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/459092/"><img src="https://habrastorage.org/webt/7o/ze/ym/7ozeymv3v4yjpenayz7cwhfjavi.png"><br><br>  Heutzutage sind die meisten Informationssysteme komplexe Lösungen mit einer ziemlich komplexen Architektur und einer großen Anzahl gegenseitiger Abhängigkeiten.  Während des Betriebs solcher Systeme können zum Zeitpunkt von Spitzenlasten einige der Module ausfallen oder nicht richtig funktionieren.  In diesem Fall ist das System nicht mehr stabil und verarbeitet möglicherweise nicht mehr alle eingehenden Anforderungen korrekt.  Um einen stabilen Betrieb des Systems zu gewährleisten, können verschiedene Strategien implementiert werden. <br><a name="habracut"></a><br>  In einigen Fällen (sofern dies zulässig ist) erfolgt die Übersetzung des Systems in das sogenannte.  "Abgesicherter Modus".  In diesem Modus kann das System eine größere Anzahl von Anrufen verarbeiten, wobei die Genauigkeit der Ergebnisse der Abfrageverarbeitung geringfügig abnimmt.  In anderen Fällen kann die Skalierung der Rechenressourcen und die Erhöhung der Anzahl der einzelnen Systemmodule, die für die Verarbeitung eingehender Anforderungen verantwortlich sind, hilfreich sein.  In diesem Fall besteht die wichtigste Aufgabe darin <b>, den Zustand des Systems</b> zu <b>bestimmen</b> , je nachdem, welche Maßnahmen bereits ergriffen werden müssen, um seine Arbeit zu stabilisieren. <br><br>  In meinen Projekten habe ich seit einiger Zeit ein ähnliches Problem auf verschiedene Weise gelöst.  Seit ich an der Universität war, hatte ich ein kleines Projekt in .NET 4.0 geschrieben, von dem ich von Zeit zu Zeit kleine Codestücke für echte Projekte nahm.  Ich habe lange geplant, dieses Projekt umzugestalten, zu bereinigen und in Form eines separaten Mini-Frameworks anzuordnen, mit dem wir das Problem der Überwachung des Systemzustands auf schöne und minimalistische Weise lösen können.  Nachdem ich einige Abende und ein paar Tage frei verbracht hatte, ordnete ich diesen Code und postete ihn auf <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> .  Des Weiteren schlage ich vor, genauer zu prüfen, was und wie in diesem Projekt umgesetzt wird. <br><br>  Um festzustellen, ob der Betriebsmodus des Systems geändert werden muss, wird vorgeschlagen, einen Ansatz zu verwenden, bei dem virtuelle „Sensoren“ und „Beobachter“ verwendet werden. <br><br><img src="https://habrastorage.org/webt/ro/x1/zt/rox1ztsyy4gvvg85e-hkxdja9uy.png"><br><br><h2>  <font color="#ff9c00">▌</font> Entitäten und Definitionen </h2><br>  Zu verwendende Basisentitäten: <br><br><ul><li>  <b>Sensor</b> - ist verantwortlich für die Überprüfung des Status einer der Anzeigen des Systems; </li><li>  <b>Beobachter</b> - fragt einen oder mehrere Sensoren ab.  Ändert seinen Zustand in Abhängigkeit von den aktuellen Messwerten der Sensoren. </li><li>  <b>Statusrechner</b> - berechnet den aktuellen Status basierend auf dem Metrikprotokoll. </li><li>  <b>Statusprotokoll</b> - Eine Reihe von Anzeigen für jeden der Sensoren, die die Abrufzeit anzeigen. </li></ul><br>  Für jede Abstraktion gibt es eine grundlegende Implementierung sowie Mechanismen für eine einfache und bequeme Erweiterung.  Betrachten wir sie genauer. <br><br><h3>  Sensor </h3><br>  Grundlegende <i>IProbe-</i> Schnittstelle.  Klassen, die IProbe implementieren, geben auf Anfrage den Wert der von ihnen beobachteten Systemparameter oder eines bestimmten Moduls / Dienstes an. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IProbe</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-function">Task&lt;ProbeResult&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br>  Als Ergebnis der <i>Check-</i> Methode gibt die IProbe-Instanz eine ProbeResult-Struktur zurück <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> ProbeResult { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ProbeName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Time { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Success { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Data { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Exception Exception { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Time}</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Success}</span></span></span><span class="hljs-string">"</span></span>; }</code> </pre><br>  Dabei bestimmt das Feld Erfolg, ob der Parameter aus Sicht des Sensors erfolgreich getestet wurde, und die Felder Daten und Ausnahme können zusätzliche Informationen speichern, falls dies zum Debuggen oder Protokollieren erforderlich ist. <br><br><h3>  Beobachter </h3><br>  Die grundlegende Schnittstelle von <i>ISpectator</i> .  Es überwacht das System und generiert Ereignisse zum Zeitpunkt der Änderung des Systemstatus, um alle Module zu benachrichtigen, die diese Ereignisse abonniert haben.  Es verwendet eine Instanz einer Klasse, die die IStateEvaluator-Schnittstelle implementiert, um den aktuellen Status zu berechnen. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ISpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;StateEventArgs&lt;TState&gt;&gt; StateChanged; <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;HealthCheckEventArgs&gt; HealthChecked; TState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } TimeSpan Uptime { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProbe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProbe probe</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckHealth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  Während jeder der Sensorabfragen löst der Beobachter das Ereignis StateChanged aus, und ein Objekt vom Typ <a href="">StateEventArgs</a> wird an die Abonnenten dieses Ereignisses übergeben, das Informationen über den aktuellen Status des Systems enthält. <br><br><h3>  Zustandsrechner </h3><br>  Die Basis- <i>IEvaluator-</i> Schnittstelle.  Berechnet den aktuellen Status des Systems basierend auf dem Sensorstatusprotokoll. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IStateEvaluator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; { <span class="hljs-function"><span class="hljs-function">TState </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Evaluate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TState currentState, DateTime stateChangedLastTime, IReadOnlyCollection&lt;JournalRecord&gt; journal</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><h3>  Statusprotokoll </h3><br>  Eine Sammlung von Instanzen der JournalRecord-Struktur.  Die JournalRecord-Instanz speichert Informationen zu allen Sensoren, die zum Zeitpunkt der Abfrage durch den Beobachter abgefragt wurden. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> JournalRecord { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">JournalRecord</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DateTime time, IEnumerable&lt;ProbeResult&gt; values</span></span></span><span class="hljs-function">)</span></span> { Time = time; Values = values.ToImmutableList(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Time { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyCollection&lt;ProbeResult&gt; Values { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Time}</span></span></span><span class="hljs-string">: [</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{</span></span><span class="hljs-keyword"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.Join(</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">","</span></span></span></span><span class="hljs-string"><span class="hljs-subst">, Values)}</span></span></span><span class="hljs-string">]"</span></span>; }</code> </pre><br><h2>  <font color="#ff9c00">▌</font> Wie es funktioniert </h2><br>  Der Prozess der Berechnung des Systemzustands kann wie folgt beschrieben werden: Jeder der im System eingebetteten Sensoren kann einen der Parameter des beobachteten Systems / Moduls / Dienstes bestimmen.  Beispielsweise kann es die Anzahl der externen aktiven Anforderungen an die API, die Menge des verwendeten RAM, die Anzahl der Einträge im Cache usw. festlegen. <br><br>  Jeder Sensor kann einem oder mehreren Beobachtern zugeordnet werden.  Jeder Beobachter kann mit einem oder mehreren Sensoren arbeiten.  Der Beobachter muss die ISpectator-Schnittstelle implementieren und Ereignisse im Falle einer Zustandsänderung oder einer Abfrage von Sensoren generieren. <br><br>  Bei der nächsten Überprüfung des Systemzustands fragt der Beobachter alle seine „Sensoren“ ab und bildet ein Array zum Schreiben in das Statusprotokoll.  Wenn sich der Status des Systems geändert hat, generiert der Beobachter ein geeignetes Ereignis.  Ereignisteilnehmer, die Informationen über die Änderung erhalten, können die Betriebsparameter des Systems ändern.  Gleichzeitig können "Computer" verschiedener Typen verwendet werden, um den Status des Systems zu bestimmen. <br><br><h3>  Synchrone und asynchrone Betriebsarten </h3><br>  Stellen Sie sich zwei Hauptszenarien vor, in denen der Beobachter eine Untersuchung der „Sensoren“ initiiert. <br><br><h4>  Synchroner Modus </h4><br>  Eine Untersuchung der Sensoren, gefolgt von einer Neuberechnung des Systemzustands, wird durch die direkte Anziehungskraft eines der Systemmodule auf den Beobachter verursacht. <br>  In diesem Fall arbeiten der Beobachter und die Sensoren im selben Thread.  Die Fehleinschätzung des Zustands des Systems wird als Teil einer Operation innerhalb des Systems durchgeführt. <br><br>  Das Projekt hat bereits eine grundlegende Implementierung eines solchen Beobachters - <b>SpectatorBase</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Code anzeigen</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpectatorBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ISpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TState _state; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IList&lt;IProbe&gt; _probes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IStateEvaluator&lt;TState&gt; _stateEvaluator; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> List&lt;JournalRecord&gt; _journal; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim _journalLock; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ReaderWriterLockSlim _stateLock; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Stopwatch _stopwatch; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;StateEventArgs&lt;TState&gt;&gt; StateChanged; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;HealthCheckEventArgs&gt; HealthChecked; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> TState State { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { _stateLock.EnterReadLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _state; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _stateLock.ExitReadLock(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan Uptime =&gt; _stopwatch.Elapsed; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Name { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyCollection&lt;JournalRecord&gt; Journal { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { _journalLock.EnterReadLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _journal; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _journalLock.ExitReadLock(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime StateChangedDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan RetentionPeriod { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SpectatorBase</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IStateEvaluator&lt;TState&gt; stateEvaluator, TimeSpan retentionPeriod, TState initialState</span></span></span><span class="hljs-function">)</span></span> { RetentionPeriod = retentionPeriod; _state = initialState; StateChangedDate = DateTime.UtcNow; _stateEvaluator = stateEvaluator; _stopwatch = Stopwatch.StartNew(); _probes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;IProbe&gt;(); _journal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;JournalRecord&gt;(); _journalLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(); _stateLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReaderWriterLockSlim(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddProbe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IProbe probe</span></span></span><span class="hljs-function">)</span></span> =&gt; _probes.Add(probe); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ChangeState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TState state, IEnumerable&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; failedProbes</span></span></span><span class="hljs-function">)</span></span> { _stateLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { _state = state; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { _stateLock.ExitWriteLock(); } StateChangedDate = DateTime.UtcNow; StateChanged?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StateEventArgs&lt;TState&gt;(state, StateChangedDate, failedProbes)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CheckHealth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> results = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stack&lt;ProbeResult&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tasks = _probes .Select(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span> o =&gt; { results.Push(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> o.Check().ConfigureAwait(<span class="hljs-literal"><span class="hljs-literal">false</span></span>)); }) .ToArray(); Task.WaitAll(tasks); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> now = DateTime.UtcNow; _journalLock.EnterWriteLock(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-comment"><span class="hljs-comment">//cleanup state records _journal.RemoveAll(o =&gt; o.Time &lt; now.Subtract(RetentionPeriod)); _journal.Add(new JournalRecord(now, results)); } finally { _journalLock.ExitWriteLock(); } //Recalculate state var state = _stateEvaluator.Evaluate(State, StateChangedDate, _journal); if (!EqualityComparer&lt;TState&gt;.Default.Equals(State, state)) { ChangeState(state, results.Where(o =&gt; !o.Success).Select(o =&gt; o.ProbeName)); } OnHealthChecked(now, results); } protected virtual void OnHealthChecked(DateTime now, IReadOnlyCollection&lt;ProbeResult&gt; results) =&gt; HealthChecked?.Invoke(this, new HealthCheckEventArgs(now, results)); }</span></span></code> </pre><br></div></div><br><h4>  Asynchroner Modus </h4><br>  In diesem Fall erfolgt die Abfrage von Sensoren asynchron zu den Prozessen des Systems und kann in einem separaten Thread durchgeführt werden.  Die grundlegende Implementierung eines solchen Beobachters ist ebenfalls bereits ein Projekt - <b>AutomatedSpectator</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Code anzeigen</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AutomatedSpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">SpectatorBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt;, <span class="hljs-title"><span class="hljs-title">IAutomatedSpectator</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TState</span></span>&gt; <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TState</span></span> : <span class="hljs-title"><span class="hljs-title">struct</span></span>, <span class="hljs-title"><span class="hljs-title">IConvertible</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TimeSpan CheckHealthPeriod { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> System.Timers.Timer _timer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AutomatedSpectator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> TimeSpan checkHealthPeriod, TimeSpan retentionPeriod, IStateEvaluator&lt;TState&gt; stateEvaluator, TState initialState</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">stateEvaluator, retentionPeriod, initialState</span></span></span><span class="hljs-function">)</span></span> { CheckHealthPeriod = checkHealthPeriod; _timer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Timers.Timer(CheckHealthPeriod.TotalMilliseconds); _timer.Elapsed += (sender, args) =&gt; CheckHealth(); _timer.AutoReset = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Start</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> =&gt; _timer.Start(); }</code> </pre><br></div></div><br><h2>  <font color="#ff9c00">▌</font> Fazit </h2><br>  Die Verwendung von X.Spectator hat mir persönlich bei mehreren hoch ausgelasteten Projekten geholfen, die Stabilität einer Reihe von Diensten erheblich zu verbessern.  Das am besten vorgeschlagene Framework hat sich bei der Implementierung in verteilten Systemen bewährt, die auf der Microservice-Architektur basieren.  Die optimalste Integrationsoption ist die Verwendung des Prinzips der Umkehrung der Steuerung, nämlich die Implementierung von Abhängigkeiten, wenn der Prozess der Implementierung von Sensoren mithilfe eines IoC-Containers implementiert wird und die Beobachter in Form von Singletones dargestellt werden, auf die eine einzelne Instanz jedes Beobachters von verschiedenen Klassen von Modulen und Diensten zugegriffen werden kann. <br><br><h2>  <font color="#ff9c00">▌</font> Links und nützliche Informationen </h2><br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Projekt-Repository</a> <br>  → <a href="">Beispiele</a> <br>  → <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">NuGet-Paket</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de459092/">https://habr.com/ru/post/de459092/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de459082/index.html">Wer sind Eidetiker, wie falsche Erinnerungen funktionieren und drei populäre Mythen über das Gedächtnis</a></li>
<li><a href="../de459084/index.html">Ein wenig über Google Home Hub oder wie ich einen Fotorahmen für 130 Euro gekauft habe</a></li>
<li><a href="../de459086/index.html">Statische Verteilung von FreeRTOS-Objekten</a></li>
<li><a href="../de459088/index.html">Punktsegmentierungsmethoden in Punktwolken</a></li>
<li><a href="../de459090/index.html">Bringen Sie Ihre Linux-Entwicklungserfahrung in Windows mit WSL und Visual Studio Code Remote auf die nächste Stufe</a></li>
<li><a href="../de459094/index.html">C # oder Java? TypeScript oder JavaScript? Auf maschinellem Lernen basierende Klassifizierung von Programmiersprachen</a></li>
<li><a href="../de459098/index.html">GitHub Package Registry unterstützt Swift-Pakete</a></li>
<li><a href="../de459100/index.html">GitHub Package Registry unterstützt Swift-Pakete</a></li>
<li><a href="../de459102/index.html">Geschenkplatte oder kostenlose Musik für Cola-Liebhaber und fertiges Frühstück</a></li>
<li><a href="../de459104/index.html">C # oder Java? TypeScript oder JavaScript? Die Klassifizierung von Programmiersprachen basierend auf maschinellem Lernen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>