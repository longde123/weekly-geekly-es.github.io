<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏑 🎙️ 👸🏻 Ich gehe tiefer in den Untergrund oder was Sie wissen sollten, um die Netzwerkanwendung zu optimieren 🐾 🙃 👐🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Grüße Freunde! 

 In den beiden vorhergehenden Artikeln ( eins , zwei ) haben wir uns mit der Komplexität der Wahl zwischen Technologien befasst und i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ich gehe tiefer in den Untergrund oder was Sie wissen sollten, um die Netzwerkanwendung zu optimieren</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ostrovok/blog/440782/">  Grüße Freunde! <br><br>  In den beiden vorhergehenden Artikeln ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">eins</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">zwei</a> ) haben wir uns mit der Komplexität der Wahl zwischen Technologien befasst und in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Ostrovok.ru</a> nach den optimalen Einstellungen für unsere Lösung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">gesucht</a> .  Welches Thema werden wir heute ansprechen? <br><br>  Jeder Dienst sollte auf einem Server funktionieren und über die Tools des Betriebssystems mit der Hardware kommunizieren.  Es gibt sehr viele dieser Tools sowie Einstellungen für sie.  In den meisten Fällen sind ihre Standardeinstellungen mehr als ausreichend.  In diesem Artikel möchte ich über jene Fälle sprechen, in denen die Standardeinstellungen noch nicht ausreichten und ich das Betriebssystem etwas näher kennenlernen musste - in unserem Fall mit <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Linux</a> . <br><br><img src="https://habrastorage.org/webt/0w/me/l7/0wmel7l-0ya2c0kwfpsmxerm5sq.jpeg"><br><a name="habracut"></a><br><h3>  Wir setzen Kernel mit Bedacht ein </h3><br>  In einem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">früheren Artikel habe</a> ich über die <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Option</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">CPU-Map</a> in <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Haproxy gesprochen</a> .  Damit binden wir Haproxy-Prozesse an Threads eines Kerns auf einem Dual-Prozessor-Server.  Wir haben den zweiten Kern für die Interrupt-Behandlung von Netzwerkkarten gegeben. <br><br>  Unten sehen Sie einen Bildschirm, auf dem Sie eine ähnliche Trennung sehen können.  Links werden die Kernel von Haproxy im <code>user space</code> , und rechts werden Interrupts im Kernelbereich verarbeitet. <br><br><img src="https://habrastorage.org/webt/4g/lj/6v/4glj6vaeqz4yrna_dvlacxhp200.png"><br><br>  Das Binden von Interrupts an eine Netzwerkkarte erfolgt automatisch damit <div class="spoiler">  <b class="spoiler_title">Bash-Skript:</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash interface=${1} if [ -z "${interface}" ];then echo "no interface specified" echo "usage: ${0} eth1" exit 1 fi nproc=$(grep 'physical id' /proc/cpuinfo|sort -u|wc -l) ncpu=$(grep -c 'processor' /proc/cpuinfo) cpu_per_proc=$[ncpu / nproc] queue_threads=$[cpu_per_proc / 2] binary_map="" cpumap="" for(( i=0; i &lt; ncpu; i++ ));do cpumap=${cpumap}1 b+='{0..1}' done binary_map=($(eval echo ${b})) ###         ###    ,      . ethtool -L ${interface} combined ${queue_threads} || true count=${ncpu} while read irq queue;do let "cpu_num=$[count-1]" let "cpu_index=$[2**cpu_num]" printf "setting ${queue} to %d (%d)\n" $((2#${binary_map[${cpu_index}]})) ${cpu_num} printf "%x\n" "$((2#${binary_map[${cpu_index}]}))" &gt; /proc/irq/${irq}/smp_affinity [ ${interface} != ${queue} ] &amp;&amp; count=$[count-1] [ $[ncpu - count] -gt ${queue_threads} ] &amp;&amp; count=${ncpu} done &lt; &lt;(awk "/${interface}/ {if(NR &gt; 1){ sub(\":\", \"\", \$1); print \$1,\$(NF)} }" /proc/interrupts) exit 0</span></span></code> </pre><br></div></div><br>  Es gibt viele geeignete einfache und komplexere Skripte im Internet, die dieselbe Aufgabe erfüllen, aber dieses Skript reicht für unsere Anforderungen aus. <br><br>  Bei Haproxy haben wir Prozesse mit Kerneln verknüpft, beginnend mit dem ersten Kernel.  Das gleiche Skript bindet Interrupts, beginnend mit dem letzten.  Somit können wir die Serverprozessoren in zwei Lager aufteilen. <br><br>  Für einen tieferen Einblick in Unterbrechungen und Vernetzung empfehle ich dringend, diesen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel zu</a> lesen. <br><br><h3>  Wir zeigen die Fähigkeiten von Netzwerkgeräten </h3><br>  Es kommt vor, dass sehr viele Frames gleichzeitig über das Netzwerk fliegen können und die Kartenwarteschlange möglicherweise nicht für einen solchen Zustrom von Gästen bereit ist, selbst wenn sie die Möglichkeit dazu hat. <br><br>  Lassen Sie uns über den Netzwerkkartenpuffer sprechen.  In den meisten Fällen verwenden die Standardwerte nicht den gesamten verfügbaren Puffer.  Sie können die aktuellen Einstellungen mit dem leistungsstarken Dienstprogramm ethtool anzeigen. <br><br>  Beispiel für die Verwendung von Befehlen: <br><br><pre> <code class="bash hljs">&gt; ethtool -g eno1 Ring parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eno1: Pre-set maximums: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096 Current hardware settings: RX: 256 RX Mini: 0 RX Jumbo: 0 TX: 256</code> </pre><br>  Nehmen wir jetzt alles aus dem Leben: <br><br><pre> <code class="bash hljs">&gt; ethtool -G eno1 rx 4096 tx 4096 &gt; ethtool -g eno1 Ring parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> eno1: Pre-set maximums: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096 Current hardware settings: RX: 4096 RX Mini: 0 RX Jumbo: 0 TX: 4096</code> </pre><br>  Jetzt können Sie sicher sein, dass die Karte nicht zurückgehalten wird und maximal funktioniert. <br><br><h3>  Minimale Systemeinstellungen für maximalen Nutzen </h3><br>  Sysctl bietet eine Vielzahl von Optionen in allen erdenklichen Farben und Größen.  In der Regel decken Artikel im Internet, die sich mit dem Thema Optimierung befassen, einen ziemlich beeindruckenden Teil dieser Parameter ab.  Ich werde nur diejenigen betrachten, die in unserem Fall wirklich nützlich waren, um sie zu ändern. <br><br>  <b>net.core.netdev_max_backlog</b> - die Warteschlange, in der Frames von der Netzwerkkarte <b>abgerufen werden</b> , die dann vom Kernel verarbeitet werden.  Mit schnellen Schnittstellen und viel Verkehr kann es schnell voll werden.  <i>Standard</i> : 1000. <br>  Wir können den Überschuss dieser Warteschlange beobachten, indem wir uns die zweite Spalte in der Datei / proc / net / softnet_stat ansehen. <br><pre> <code class="bash hljs">awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> /proc/net/softnet_stat</code> </pre> <br>  Die Datei selbst beschreibt die Struktur von <a href="">netif_rx_stats</a> pro Zeile für jede CPU im System. <br>  Insbesondere beschreibt die zweite Spalte die Anzahl der Pakete im verworfenen Zustand.  Wenn der Wert in der zweiten Spalte mit der Zeit wächst, lohnt es sich wahrscheinlich, den Wert von <code>net.core.netdev_max_backlog</code> oder die CPU schneller zu machen. <br><br>  <b>net.core.rmem_default</b> / <b>net.core.rmem_max</b> &amp;&amp; <b>net.core.wmem_default</b> / <b>net.core.wmem_max</b> - Diese Parameter geben den Standardwert / Maximalwert für Socket-Lese- und Schreibpuffer an.  <i>Der Standardwert</i> kann auf Anwendungsebene zum Zeitpunkt der Erstellung des Sockets geändert werden (Haproxy verfügt übrigens über einen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Parameter</a> , der dies ausführt).  Wir hatten Fälle, in denen der Kernel mehr Pakete warf, als Haproxy harken konnte, und dann begannen die Probleme.  Daher ist die Sache wichtig. <br><br>  <b>net.ipv4.tcp_max_syn_backlog</b> - ist verantwortlich für die Begrenzung neuer Verbindungen, für die noch kein <code>SYN</code> Paket empfangen wurde.  Wenn es einen großen Strom neuer Verbindungen gibt (z. B. viele HTTP-Anforderungen von <code>Connection: close</code> ), ist es sinnvoll, diesen Wert zu erhöhen, um keine Zeit mit dem Senden weitergeleiteter Pakete zu verschwenden. <br><br>  <b>net.core.somaxconn</b> - hier handelt es sich um hergestellte Verbindungen, die jedoch noch nicht von der Anwendung verarbeitet wurden.  Wenn der Server Single-Threaded ist und zwei Anforderungen eingegangen sind, wird die erste Anforderung von der Funktion <code>accept()</code> , und die zweite hängt im <code>backlog</code> , dessen Größe für diesen Parameter verantwortlich ist. <br><br>  <b>nf_conntrack_max</b> ist wahrscheinlich der bekannteste aller Parameter.  Ich denke, fast jeder, der sich mit Iptables befasst hat, weiß davon.  Im Idealfall können Sie das Conntrack-Modul natürlich entladen und nicht darüber nachdenken, wenn Sie keine Maskierung für iptables verwenden müssen.  In meinem Fall wird <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Docker</a> verwendet, sodass Sie nichts Besonderes hochladen. <br><br><h3>  Überwachung  Offensichtlich und nicht sehr </h3><br>  Um nicht blind zu suchen, warum "Ihr Proxy langsamer wird", ist es hilfreich, einige Diagramme einzurichten und sie mit Triggern zu überlagern. <br><br>  <b>nf_conntrack_count</b> ist die offensichtlichste Metrik.  Darauf können Sie überwachen, wie viele Verbindungen sich jetzt in der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Conntrack-Tabelle befinden</a> .  Wenn die Tabelle überläuft, wird der Pfad für neue Verbindungen geschlossen. <br><br>  Den aktuellen Wert finden Sie hier: <br><br><pre> <code class="bash hljs">cat /proc/sys/net/netfilter/nf_conntrack_count</code> </pre> <br><img src="https://habrastorage.org/webt/qp/eg/1l/qpeg1lpltda2b1cos5bzwijprfq.png"><br><br>  <b>Tcp-Segmente erneut übertragen</b> - die Anzahl der <b>Segmentübertragungen</b> .  Die Metrik ist sehr umfangreich, da sie über Probleme auf verschiedenen Ebenen sprechen kann.  Die Zunahme der Übertragungen kann auf Netzwerkprobleme, die Notwendigkeit einer Optimierung der Systemeinstellungen oder sogar darauf hinweisen, dass die endgültige Software (z. B. Haproxy) ihre Aufgabe nicht erfüllt.  Wie dem auch sei, das abnormale Wachstum dieses Wertes kann als Grund für ein Verfahren dienen. <br><br><img src="https://habrastorage.org/webt/st/-m/vp/st-mvpahwxgcdord_zzvaml2dru.png"><br><br>  In unserem Land weist eine Wertsteigerung am häufigsten auf Probleme mit einem der Lieferanten hin, obwohl es Probleme mit der Leistung sowohl der Server als auch des Netzwerks gab. <br><br>  Beispiel zur Überprüfung: <br><br><pre> <code class="bash hljs">netstat -s|grep <span class="hljs-string"><span class="hljs-string">'segments retransmited'</span></span></code> </pre> <br>  <b>Socket Recv-Q</b> - <b>Denken Sie</b> daran, wir haben über Momente gesprochen, in denen eine Anwendung möglicherweise nicht genügend Zeit hat, um Anforderungen zu verarbeiten, und dann der <code>socket backlog</code> wächst.  Das Wachstum dieses Indikators macht deutlich, dass etwas mit der Anwendung nicht stimmt und nicht bewältigt werden kann. <br><br>  Ich habe Berge in Diagrammen mit dieser Metrik gesehen, als der Parameter maxconn in Haproxy einen Standardwert (2000) hatte und einfach keine neuen Verbindungen akzeptierte. <br><br>  Und noch einmal ein Beispiel: <br><br><pre> <code class="bash hljs">ss -lntp|awk <span class="hljs-string"><span class="hljs-string">'/LISTEN/ {print $2}'</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/9l/ni/be/9lnibeyuhs2qb0ta8w7rr2k9shs.png"><br><br>  Es ist nicht überflüssig, ein Diagramm mit einer Aufschlüsselung nach Status der TCP-Verbindungen zu haben: <br><br><img src="https://habrastorage.org/webt/uo/1i/aa/uo1iaapuogduuk-9bk5elmahaus.png"><br><br>  Und separat machen <code>time-wait/established</code> , weil  Ihre Werte unterscheiden sich in der Regel stark von den anderen: <br><br><img src="https://habrastorage.org/webt/np/v8/g-/npv8g-clm27mdnj4bhzlol7kshm.png"><br><br>  Zusätzlich zu diesen Metriken gibt es viele andere, aber offensichtlichere - zum Beispiel die Belastung der Netzwerkschnittstelle oder der CPU.  Ihre Wahl hängt bereits mehr von den Besonderheiten Ihrer Arbeitsbelastung ab. <br><br><h3>  Anstelle einer Schlussfolgerung </h3><br>  Im Allgemeinen ist das alles - ich habe versucht, die wichtigsten Punkte zu beschreiben, denen ich beim Einrichten des http-Reverse-Proxys begegnen musste.  Es scheint, dass die Aufgabe nicht schwierig ist, aber mit zunehmender Last steigt auch die Anzahl der Fallstricke, die immer zur falschen Zeit auftauchen.  Ich hoffe, dieser Artikel hilft Ihnen, die Schwierigkeiten zu vermeiden, mit denen ich konfrontiert war. <br><br>  Aller Frieden </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de440782/">https://habr.com/ru/post/de440782/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de440772/index.html">Domain-gesteuertes Design: ein Rezept für einen Pragmatiker</a></li>
<li><a href="../de440774/index.html">Schwerwiegende mathematische NHTSA-Fehler ermöglichen es Tesla, die Sicherheit des Autopiloten zu beanspruchen</a></li>
<li><a href="../de440776/index.html">E-Mail, Innenansicht</a></li>
<li><a href="../de440778/index.html">Zweites OpenStack-Treffen bei Mail.ru Group: 22. Februar</a></li>
<li><a href="../de440780/index.html">Google blockiert keine Werbeblocker von Drittanbietern im Chromium-Browser</a></li>
<li><a href="../de440784/index.html">Schalten Sie beim Verlassen das Licht aus und das Wasser aus</a></li>
<li><a href="../de440786/index.html">Ein neuer Blick auf das Lernen und Dokumentieren von Quellcode</a></li>
<li><a href="../de440788/index.html">Verwendung der Spring State Machine in einem praktischen Beispiel</a></li>
<li><a href="../de440790/index.html">Hi-Fi - Klassifizierungsproblem: über Geschichte, Standard, Marketing und Terminologie</a></li>
<li><a href="../de440792/index.html">SVG-Filtereffekte. Teil 5. Text mit feDisplacementMap an die Oberflächentextur anpassen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>