<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôá üëº üëäüèΩ RabbitMQ - SQL Server üßíüèø ü§πüèæ üë©‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="H√° uma ou duas semanas, vi uma mensagem no f√≥rum RabbitMQ Users sobre como configurar o envio de mensagens do SQL Server para o RabbitMQ. Como trabalh...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>RabbitMQ - SQL Server</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419457/">  H√° uma ou duas semanas, vi uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mensagem</a> no f√≥rum <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RabbitMQ Users</a> sobre como configurar o envio de mensagens do SQL Server para o RabbitMQ.  Como trabalhamos em estreita colabora√ß√£o com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Derivco</a> , deixei algumas sugest√µes l√° e tamb√©m disse que estou escrevendo um blog sobre como fazer isso.  Parte da minha mensagem n√£o era inteiramente verdadeira - pelo menos at√© aquele momento (desculpe, irm√£o, ele estava muito ocupado). <br><br>  Coisa impressionante, este √© o seu <b>SQL Server</b> .  √â muito f√°cil colocar informa√ß√µes em um banco de dados.  Recuperar dados de um banco de dados usando uma consulta √© igualmente f√°cil.  Mas obter os dados atualizados ou colados j√° √© um pouco mais dif√≠cil.  Pense em eventos em tempo real;  uma compra √© feita - algu√©m precisa ser notificado sobre isso no momento exato em que isso aconteceu.  Talvez algu√©m diga que esses dados n√£o devem ser retirados do banco de dados, mas de algum outro lugar.  Obviamente, esse √© o caso, mas muitas vezes simplesmente n√£o temos escolha. <br><a name="habracut"></a><br>  Tivemos uma tarefa: enviar eventos do banco de dados para fora para processamento adicional, e a pergunta era - como fazer isso? <br><br><h3>  SQL Server e comunica√ß√µes externas </h3><br>  Durante a exist√™ncia do SQL Server, houve v√°rias tentativas de organizar as comunica√ß√µes fora do banco de dados;  <b>Servi√ßos de Notifica√ß√£o do SQL Server</b> (NS), que apareceram no SQL Server 2000 e, posteriormente, no SQL Server 2005, o <b>SQL Server Service Broker</b> (SSB) apareceu.  Eu os descrevi em meu livro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A First Look at SQL Server 2005 for Developers</a> , juntamente com Bob Boshemen e Dan Sullivan.  O NS apareceu no SQL Server 2000, como eu disse, e foi redesenhado na vers√£o beta do SQL Server 2005. No entanto, o NS foi <s>completamente</s> exclu√≠do da vers√£o pronta para venda (RTM) do SQL Server 2005. <br><blockquote>  <b>Nota:</b> Se voc√™ ler o livro, encontrar√° v√°rios recursos que n√£o estavam na vers√£o RTM. </blockquote>  O SSB sobreviveu e a Microsoft lan√ßou o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Service Broker External Activator</a> (EA) em seu SQL Server 2008 Feature Pack.  Permite atrav√©s do SSB interagir fora do banco de dados local.  Teoricamente, parece bom, mas na pr√°tica - √© complicado e confuso.  Fizemos alguns testes e rapidamente percebemos que n√£o estava fazendo o que precis√°vamos.  Al√©m disso, o SSB n√£o nos deu o desempenho necess√°rio, por isso tivemos que inventar outra coisa. <br><br><h3>  SQLCLR </h3><br>  O que descobrimos como resultado foi baseado na tecnologia SQLCLR.  SQLCLR √© uma plataforma .NET integrada ao n√∫cleo do SQL Server e pode ser usada para executar o c√≥digo .NET dentro do kernel.  Como executamos o c√≥digo .NET, somos capazes de fazer quase tudo como em um aplicativo .NET comum. <br><blockquote>  <b>Nota:</b> eu escrevi "quase" acima, porque na verdade existem algumas limita√ß√µes.  Nesse contexto, essas restri√ß√µes quase n√£o t√™m efeito sobre o que vamos fazer. <br></blockquote>  O princ√≠pio de opera√ß√£o do SQLCLR √© o seguinte: o c√≥digo √© compilado em uma biblioteca DLL e, em seguida, essa biblioteca √© registrada usando as ferramentas do SQL Server: <br><br>  Construir Montagem <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ASSEMBLY</span></span> [RabbitMQ.SqlServer] AUTHORIZATION rmq <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-string"><span class="hljs-string">'F:\some_path\RabbitMQSqlClr4.dll'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> PERMISSION_SET = <span class="hljs-keyword"><span class="hljs-keyword">UNSAFE</span></span>; GO</code> </pre> <br>  <b>Fragmento de c√≥digo 1:</b> Criando uma montagem ao longo de um caminho absoluto <br><br>  O c√≥digo executa as seguintes a√ß√µes: <br><br><ul><li>  <code>CREATE ASSEMBLY</code> - Cria uma montagem com o nome fornecido (n√£o importa qual deve ser). </li><li>  <code>AUTHORIZATION</code> - Indica o propriet√°rio da montagem.  Nesse caso, rmq √© uma fun√ß√£o predefinida do SQL Server. </li><li>  <code>FROM</code> - Determina onde a montagem original est√° localizada.  Na <code>FROM</code> , voc√™ tamb√©m pode especificar o caminho nos formatos bin√°rio ou UNC.  Os arquivos de instala√ß√£o para este projeto usam uma representa√ß√£o bin√°ria. </li><li>  <code>WITH PERMISSION_SET</code> - Define permiss√µes.  <code>UNSAFE</code> √© o menos rigoroso e √© necess√°rio neste caso. </li></ul><br><blockquote>  <b>Nota:</b> independentemente da fun√ß√£o ou login usado na cl√°usula <code>AUTHORIZATION</code> , a classe appdomain deve ser criada com o mesmo nome que ao carregar o assembly no dom√≠nio.  √â recomend√°vel separar assemblies com nomes diferentes de classes de dom√≠nio de aplicativo para que, quando um assembly falhar, o restante n√£o caia.  No entanto, se as montagens dependem uma da outra, elas n√£o podem ser divididas em classes diferentes. <br></blockquote>  Quando o assembly √© criado, criamos wrappers de m√©todos .NET nele: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> rmq.pr_clr_PostRabbitMsg @EndpointID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @Message <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXTERNAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NAME</span></span> [RabbitMQ.SqlServer].[RabbitMQSqlClr.RabbitMQSqlServer].[pr_clr_PostRabbitMsg]; GO</code> </pre><br>  <b>Snippet de c√≥digo 2:</b> Wrapper do m√©todo .NET <br><br>  O c√≥digo executa as seguintes a√ß√µes: <br><br><ul><li>  Cria um procedimento armazenado T-SQL chamado <code>rmq.pr_clr_PostRabbitMsg</code> que usa dois par√¢metros;  <code>@EndpointID</code> e <code>@Message</code> . </li><li>  Em vez do corpo do procedimento, √© usada uma fonte externa, que consiste em: <br><ul><li>  Um assembly chamado <code>RabbitMQ.SqlServer</code> , ou seja, o agregado que criamos acima no <b>snippet de c√≥digo 1</b> . </li><li>  Tipo completo (namespace e classe): <code>RabbitMQSqlClr.RabbitMQSqlServer</code> </li><li>  O m√©todo do namespace e da classe acima √©: <code>pr_clr_PostRabbitMsg</code> . </li></ul></li></ul><br>  Quando <code>rmq.pr_clr_PostRabbitMsg</code> , o m√©todo <code>pr_clr_PostRabbitMsg</code> ser√° chamado. <br><blockquote>  <b>Nota:</b> ao criar um procedimento, o nome da montagem n√£o diferencia mai√∫sculas de min√∫sculas, ao contr√°rio do nome completo do tipo e m√©todo.  N√£o √© necess√°rio que o nome do procedimento que est√° sendo criado corresponda ao nome do m√©todo.  No entanto, os tipos de dados finais para os par√¢metros devem corresponder. </blockquote>  Como eu disse anteriormente, n√≥s da Derivco precisamos enviar dados para fora do SQL Server, ent√£o usamos SQLCLR e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RabbitMQ</a> (RMQ). <br><br><h3>  Rabbitmq </h3><br>  O RMQ √© um intermedi√°rio de mensagens de c√≥digo aberto que implementa o AMQP (Advanced Message Queuing Protocol) e √© gravado em Erlang. <br><br>  Como o RMQ √© um intermedi√°rio de mensagens, as bibliotecas do cliente AMQP s√£o necess√°rias para conectar-se a ele.  O aplicativo se refere √†s bibliotecas clientes e, com a ajuda deles, abre uma conex√£o e envia mensagens - como, por exemplo, h√° uma chamada atrav√©s do ADO.NET para o SQL Server.  Mas, diferentemente do ADO.NET, onde, provavelmente, a conex√£o √© aberta toda vez que voc√™ acessa o banco de dados, aqui a conex√£o permanece aberta por todo o per√≠odo do aplicativo. <br><br>  Portanto, para poder interagir do banco de dados com o RabbitMQ, precisamos do aplicativo e da biblioteca do cliente .NET para o RabbitMQ. <br><blockquote>  <b>Nota:</b> na pr√≥xima parte deste artigo, fragmentos de c√≥digo RabbitMQ ser√£o encontrados, mas sem explica√ß√µes detalhadas do que eles fazem.  Se voc√™ √© novo no trabalho com o RabbitMQ, sugiro dar uma olhada nos v√°rios <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tutoriais do RabbitMQ</a> para entender o objetivo do c√≥digo.  O tutorial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hello World</a> C # √© um bom come√ßo.  Uma das diferen√ßas entre livros did√°ticos e exemplos de c√≥digo √© que os trocadores n√£o s√£o declarados nos exemplos.  Eles devem ser predefinidos. </blockquote><h3>  RabbitMQ.SqlServer </h3><br>  <b>RabbitMQ.SqlServer</b> √© um assembly que usa a biblioteca cliente .NET para RabbitMQ e fornece a capacidade de enviar mensagens do banco de dados para um ou mais pontos de extremidade RabbitMQ (VHosts e trocadores).  O c√≥digo pode ser baixado / bifurcado no meu reposit√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RabbitMQ-SqlServer</a> no GitHub.  Ele cont√©m fontes de montagem e arquivos de instala√ß√£o (ou seja, voc√™ n√£o precisa compil√°-los). <br><blockquote>  <b>Nota:</b> este √© apenas um exemplo para mostrar como o SQL Server pode interagir com o RabbitMQ.  Este n√£o √© um produto acabado ou mesmo parte dele.  Se esse c√≥digo quebrar seu c√©rebro - n√£o me culpe, porque este √© apenas um exemplo. <br></blockquote><h3>  Funcionalidade </h3><br>  Quando o assembly √© carregado, ou quando sua inicializa√ß√£o √© explicitamente chamada, ou quando √© chamada indiretamente, no momento em que o procedimento do wrapper √© chamado, o assembly carrega a cadeia de conex√£o no banco de dados local em que foi instalado, bem como nos terminais do RabbitMQ aos quais se conectam: <br><br>  Liga√ß√£o <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InternalConnect</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { connFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConnectionFactory(); connFactory.Uri = connString; connFactory.AutomaticRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; connFactory.TopologyRecoveryEnabled = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; RabbitConn = connFactory.CreateConnection(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; channels; x++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ch = RabbitConn.CreateModel(); rabbitChannels.Push(ch); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } }</code> </pre> <br>  <b>Fragmento de c√≥digo 3:</b> conectar-se ao terminal <br><br>  Ao mesmo tempo, parte da conex√£o com o terminal tamb√©m cria IModels na conex√£o e eles s√£o usados ‚Äã‚Äãao enviar (adicionando √† fila) mensagens: <br><br>  Envio de mensagem <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> exchange, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] msg, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> topic</span></span></span><span class="hljs-function">)</span></span> { IModel <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> channelTryCount = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((!rabbitChannels.TryPop(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) &amp;&amp; channelTryCount &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>) { channelTryCount += <span class="hljs-number"><span class="hljs-number">1</span></span>; Thread.Sleep(<span class="hljs-number"><span class="hljs-number">50</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (channelTryCount == <span class="hljs-number"><span class="hljs-number">100</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> errMsg = <span class="hljs-string"><span class="hljs-string">$"Channel pool blocked when trying to post message to Exchange: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{exchange}</span></span></span><span class="hljs-string">."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(errMsg); } <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.BasicPublish(exchange, topic, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, msg); rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _rabbitChannels.Push(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  O m√©todo <code>Post</code> √© chamado a partir do m√©todo <code>pr_clr_PostRabbitMsg(int endPointId, string msgToPost)</code> , que foi apresentado como um procedimento usando a cl√°usula <code>CREATE PROCEDURE</code> no fragmento de c√≥digo 2: <br><br>  M√©todo de p√≥s-chamada <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pr_clr_PostRabbitMsg</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> endPointId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> msgToPost</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(endPointId == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">"EndpointId cannot be 0"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isInitialised) { pr_clr_InitialiseRabbitMq(); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> msg = Encoding.UTF8.GetBytes(msgToPost); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (endPointId == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rep <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> remoteEndpoints) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> exch = rep.Value.Exchange; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> topic = rep.Value.RoutingKey; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pub <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> rabbitPublishers.Values) { pub.Post(exch, msg, topic); } } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { RabbitPublisher pub; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rabbitPublishers.TryGetValue(endPointId, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> pub)) { pub.Post(remoteEndpoints[endPointId].Exchange, msg, remoteEndpoints[endPointId].RoutingKey); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApplicationException(<span class="hljs-string"><span class="hljs-string">$"EndpointId: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{endPointId}</span></span></span><span class="hljs-string">, does not exist"</span></span>); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } }</code> </pre> <br>  <b>Fragmento de c√≥digo 5:</b> Representando um m√©todo como um procedimento <br><br>  Quando o m√©todo √© executado, sup√µe-se que o chamador envie o identificador do terminal para o qual a mensagem deve ser transmitida e, de fato, a pr√≥pria mensagem.  Se o valor -1 for passado como o identificador do n√≥ de extremidade, iteramos sobre todos os pontos e enviamos uma mensagem para cada um deles.  A mensagem vem na forma de uma sequ√™ncia a partir da qual obtemos bytes usando <code>Encoding.UTF8.GetBytes</code> .  Em um ambiente de produ√ß√£o, a chamada <code>Encoding.UTF8.GetBytes</code> deve ser substitu√≠da pela serializa√ß√£o. <br><br><h3>  Instala√ß√£o </h3><br>  Para instalar e executar o exemplo, voc√™ precisa de todos os arquivos na pasta <code>src\SQL</code> .  Para instalar, siga estes passos: <br><br><ul><li>  Execute o script <code>01.create_database_and_role.sql</code> .  Ele criar√°: <br><ul><li>  Banco de dados de teste <code>RabbitMQTest</code> que o assembly ser√° criado. </li><li>  <code>rmq</code> a ser designada como propriet√°rio da montagem </li><li>  esquema, que tamb√©m ser√° chamado <code>rmq</code> .  Neste diagrama, v√°rios objetos de banco de dados s√£o criados. <br></li></ul><br></li><li>  Execute o arquivo <code>02.create_database_objects.sql</code> .  Ele criar√°: <br><br><ul><li>  a tabela <code>rmq.tb_RabbitSetting</code> , que armazenar√° a cadeia de conex√£o no banco de dados local. </li><li>  A tabela <code>rmq.tb_RabbitEndpoint</code> , na qual um ou mais pontos de extremidade do <code>RabbitMQ</code> ser√£o armazenados. </li></ul><br></li><li>  No arquivo <code>03.create_localhost_connstring.sql</code> altere o valor da vari√°vel <code>@connString</code> para a cadeia de conex√£o correta do banco de dados <code>RabbitMQTest</code> criado na etapa 1 e execute o script. <br></li></ul><br>  Antes de continuar, voc√™ deve ter uma inst√¢ncia em execu√ß√£o do broker RabbitMQ e do VHost (por padr√£o, o VHost √© representado como /).  Como regra, temos v√°rios VHost, apenas para isolamento.  Esse host tamb√©m precisa de um trocador, no exemplo usamos <code>amq.topic</code> .  Quando seu broker RabbitMQ estiver pronto, edite os <code>rmq.pr_UpsertRabbitEndpoint</code> procedimento <code>rmq.pr_UpsertRabbitEndpoint</code> , que est√£o localizados no arquivo <code>04.upsert_rabbit_endpoint.sql</code> : <br><br>  Endpoint RabbitMQ <br><br><pre> <code class="cs hljs">EXEC rmq.pr_UpsertRabbitEndpoint @Alias = <span class="hljs-string"><span class="hljs-string">'rabbitEp1'</span></span>, @ServerName = <span class="hljs-string"><span class="hljs-string">'RabbitServer'</span></span>, @Port = <span class="hljs-number"><span class="hljs-number">5672</span></span>, @VHost = <span class="hljs-string"><span class="hljs-string">'testHost'</span></span>, @LoginName = <span class="hljs-string"><span class="hljs-string">'rabbitAdmin'</span></span>, @LoginPassword = <span class="hljs-string"><span class="hljs-string">'some_secret_password'</span></span>, @Exchange = <span class="hljs-string"><span class="hljs-string">'amq.topic'</span></span>, @RoutingKey = <span class="hljs-string"><span class="hljs-string">'#'</span></span>, @ConnectionChannels = <span class="hljs-number"><span class="hljs-number">5</span></span>, @IsEnabled = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  <b>Fragmento de c√≥digo 6:</b> Criando um n√≥ de extremidade no RabbitMQ <br><br>  Neste ponto, √© hora de implantar assemblies.  Existem diferen√ßas nas op√ß√µes de implanta√ß√£o para vers√µes do SQL Server anteriores ao SQL Server 2014 (2005, 2008, 2008R2, 2012) e para 2014 e posteriores.  A diferen√ßa est√° na vers√£o suportada do CLR.  Antes do SQL Server 2014, a plataforma .NET estava em execu√ß√£o no CLR vers√£o 2 e, no SQL Server 2014 e superior, a vers√£o 4 era usada. <br><br><h3>  SQL Server 2005 - 2012 </h3><br>  Vamos come√ßar com as vers√µes do SQL Server executadas no CLR 2, pois elas t√™m suas pr√≥prias caracter√≠sticas.  Precisamos implantar o assembly criado e, ao mesmo tempo, implantar a biblioteca .NET do cliente <code>RabbitMQ.Client</code> ( <code>RabbitMQ.Client</code> ).  Da nossa montagem, nos referiremos √† biblioteca do cliente RabbitMQ.  Porque  Como planejamos usar o CLR 2, nosso assembly e o <code>RabbitMQ.Client</code> devem ser compilados com base no .NET 3.5.  H√° problemas <br><br>  Todas as vers√µes mais recentes da biblioteca <code>RabbitMQ.Client</code> s√£o compiladas para o ambiente CLR 4, portanto, n√£o podem ser usadas em nosso assembly.  A vers√£o mais recente das bibliotecas cliente para CLR 2 √© compilada no .NET 3.4.3.  Mas, mesmo se tentarmos implantar esse assembly, receberemos uma mensagem de erro: <br><br><img src="https://habrastorage.org/webt/db/yo/uj/dbyouj4az0fzhnwpkvtdkgj6i-q.png"><br>  <i><b>Figura 1:</b> Conjunto System.ServiceModel ausente</i> <br><br>  Esta vers√£o do <code>RabbitMQ.Client</code> refere-se a um assembly que n√£o faz parte do SQL Server CLR.  Este √© um assembly do WCF e esta √© uma das limita√ß√µes do SQLCLR que eu mencionei acima: esse assembly espec√≠fico √© para tipos de tarefas que n√£o podem ser executadas no SQL Server.  As vers√µes recentes do <code>RabbitMQ.Client</code> n√£o possuem essas depend√™ncias, portanto podem ser usadas sem problemas, exceto pelos requisitos irritantes do CLR 4. O que devo fazer? <br><br>  Como voc√™ sabe, o RabbitMQ √© de c√≥digo aberto, mas somos desenvolvedores, certo?  ;) Ent√£o vamos recompilar!  Na vers√£o anterior √†s vers√µes mais recentes (ou seja, vers√£o &lt;3.5.0) do <code>RabbitMQ.Client</code> exclu√≠ os links para <code>System.ServiceModel</code> e recompilei.  Eu tive que alterar algumas linhas de c√≥digo usando a funcionalidade <code>System.ServiceModel</code> , mas essas foram pequenas altera√ß√µes. <br><br>  Neste exemplo, eu n√£o usei a vers√£o 3.4.3 do cliente, mas peguei a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">vers√£o est√°vel 3.6.6</a> e recompilei usando o .NET 3.5 (CLR 2).  Quase funcionou :), exceto que as vers√µes posteriores do <code>RabbitMQ.Client</code> usam <code>Task</code> 'e que n√£o fazem parte originalmente do .NET 3.5. <br><br>  Felizmente, existe uma vers√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><code>System.Threading.dll</code></a> para .NET 3.5 que inclui a <code>Task</code> .  Eu baixei, configurei os links e tudo correu!  Aqui, o truque principal √© que o <code>System.Threading.dll</code> deve ser instalado com o assembly. <br><blockquote>  <b>Nota: a</b> fonte do <code>RabbitMQ.Client</code> , da qual compilei uma vers√£o do .NET 3.5, est√° no meu reposit√≥rio no GitHub <a href="">RabbitMQ Client 3.6.6 .NET 3.5</a> .  A DLL de bin√°rio, juntamente com <code>System.Threading.dll</code> para .NET 3.5, tamb√©m est√° no <code>lib\NET3.5</code> reposit√≥rio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">(RabbitMQ-SqlServer)</a> . <br></blockquote>  Para instalar os assemblies necess√°rios ( <code>System.Threading</code> , <code>RabbitMQ.Client</code> e <code>RabbitMQ.SqlServer</code> ), execute os scripts de instala√ß√£o no diret√≥rio <code>src\sql</code> na seguinte ordem: <br><br><ol><li>  <code>05.51.System.Threading.sql2k5-12.sql</code> - System.Threading </li><li>  <code>05.52.RabbitMQ.Client.sql2k5-12.sql</code> - RabbitMQ.Client </li><li>  <code>05.53.RabbitMQ.SqlServer.sql2k5-12.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  SQL Server 2014 ou superior </h3><br>  No SQL Server 2014 e posterior, o assembly √© compilado no .NET 4.XX (meu exemplo est√° no 4.5.2) e voc√™ pode fazer refer√™ncia a qualquer uma das vers√µes mais recentes do <code>RabbitMQ.Client</code> , que podem ser obtidas usando o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NuGet</a> .  No meu exemplo, estou usando o 4.1.1.  <code>RabbitMQ.Client</code> , que tamb√©m est√° no <code>lib\NET4</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio (RabbitMQ-SqlServer)</a> . <br><br>  Para instalar, execute os scripts no diret√≥rio <code>src\sql</code> na seguinte ordem: <br><br><ol><li>  <code>05.141.RabbitMQ.Client.sql2k14+.sql</code> - RabbitMQ.Client </li><li>  <code>05.142.RabbitMQ.SqlServer.sql2k14+.sql</code> - RabbitMQ.SqlServer </li></ol><br><h3>  Wrappers de m√©todo SQL </h3><br>  Para criar procedimentos que ser√£o usados ‚Äã‚Äãem nossa montagem (3.5 ou 4), execute o script <code>06.create_sqlclr_procedures.sql</code> .  Ele criar√° procedimentos T-SQL para tr√™s m√©todos .NET: <br><br><ul><li>  <code>rmq.pr_clr_InitialiseRabbitMq</code> chama <code>pr_clr_InitialiseRabbitMq</code> .  Usado para carregar e inicializar o assembly RabbitMQ.SqlServer. </li><li>  <code>rmq.pr_clr_ReloadRabbitEndpoints</code> chama <code>pr_clr_ReloadRabbitEndpoints</code> .  Carrega v√°rios pontos de extremidade do RabbitMQ. </li><li>  <code>rmq.pr_clr_PostRabbitMsg</code> chama <code>pr_clr_PostRabbitMsg</code> .  Usado para enviar mensagens para RabbitMQ. </li></ul><br>  O script tamb√©m cria um procedimento T-SQL simples - <code>rmq.pr_PostRabbitMsg</code> , que se aplica a <code>rmq.pr_clr_PostRabbitMsg</code> .  Este √© um procedimento de inv√≥lucro que sabe o que fazer com dados, manipula exce√ß√µes etc.  Em um ambiente de produ√ß√£o, temos v√°rios procedimentos semelhantes que processam v√°rios tipos de mensagens.  Leia mais sobre isso abaixo. <br><br><h3>  Use </h3><br>  De todas as <code>rmq.pr_PostRabbitMsg</code> acima, √© claro que, para enviar mensagens ao RabbitMQ, chamamos <code>rmq.pr_PostRabbitMsg</code> ou <code>rmq.pr_clr_PostRabbitMsg</code> , transmitindo nos par√¢metros o identificador do terminal e a pr√≥pria mensagem como uma string.  Tudo isso, √© claro, √© legal, mas eu gostaria de ver como isso funcionar√° na realidade. <br><br>  O que fazemos nos ambientes de produ√ß√£o √© que, nos procedimentos armazenados que processam os dados que devem ser enviados ao RabbitMQ, coletamos os dados a serem enviados e, no bloco de conex√£o, chamamos um procedimento como <code>rmq.pr_PostRabbitMsg</code> .  A seguir, √© apresentado um exemplo muito simplificado de tal procedimento: <br><br>  Procedimento de processamento de dados <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> dbo.pr_SomeProcessingStuff @<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> NOCOUNT <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-comment"><span class="hljs-comment">--     DECLARE @endPointId int; --    DECLARE @msg nvarchar(max) = '{' --        SET @msg = @msg + '"Id":' + CAST(@id AS varchar(10)) + ',' --  -  SET @msg = @msg + '"FName":"Hello",'; SET @msg = @msg + '"LName":"World"'; SET @msg = @msg + '}'; -- -  --     -,  -  SELECT @endPointId = 1; --    --     EXEC rmq.pr_PostRabbitMsg @Message = @msg, @EndpointID = @endPointId; END TRY BEGIN CATCH DECLARE @errMsg nvarchar(max); DECLARE @errLine int; SELECT @errMsg = ERROR_MESSAGE(), @errLine = ERROR_LINE(); RAISERROR('Error: %s at line: %d', 16, -1, @errMsg, @errLine); END CATCH END</span></span></code> </pre> <br>  No <b>fragmento de c√≥digo 7,</b> vemos como os dados necess√°rios s√£o capturados e processados ‚Äã‚Äãno procedimento e enviados ap√≥s o processamento.  Para usar este procedimento, execute o script <code>07.create_processing_procedure.sql</code> no diret√≥rio <code>src\SQL</code> . <br><br><h3>  Vamos rodar tudo </h3><br>  Neste ponto, voc√™ deve estar preparado para enviar algumas mensagens.  Antes do teste, verifique se voc√™ possui filas no RabbitMQ conectadas ao trocador de terminal em <code>rmq.tb_RabbitEndpoint</code> . <br><br>  Portanto, para come√ßar, voc√™ precisa fazer o seguinte: <br>  Abra o arquivo <code>99.test_send_message.sql</code> . <br>  Executar <br><br><pre> <code class="sql hljs">EXEC rmq.pr_clr_InitialiseRabbitMq;</code> </pre> <br>  para inicializar a montagem e carregar os pontos de extremidade do RabbitMQ.  Esta n√£o √© uma etapa necess√°ria, mas √© recomend√°vel pr√©-carregar a montagem ap√≥s criar ou modificar. <br><br>  Executar <br><br><pre> <code class="sql hljs">EXEC dbo.pr_SomeProcessingStuff @id = 101</code> </pre> <br>  (voc√™ pode usar qualquer outro identificador que desejar). <br><br>  Se tudo funcionou sem erros, uma mensagem deve aparecer na fila do RabbitMQ!  Ent√£o voc√™ usou o SQLCLR para enviar uma mensagem ao RabbitMQ. <br><br>  Parab√©ns! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt419457/">https://habr.com/ru/post/pt419457/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt419441/index.html">SpaceX reutiliza primeiro foguete Falcon 9 Block 5 hoje</a></li>
<li><a href="../pt419443/index.html">A NASA voar√° novamente para a lua, criando todos os elementos da aeronave</a></li>
<li><a href="../pt419449/index.html">API de contexto Redux vs. React</a></li>
<li><a href="../pt419451/index.html">Crie um pacote para o Symfony 4 passo a passo</a></li>
<li><a href="../pt419453/index.html">M√©todos num√©ricos para resolver sistemas de equa√ß√µes n√£o lineares</a></li>
<li><a href="../pt419459/index.html">Baterias de chumbo-√°cido: alfabeto de carga de pulso</a></li>
<li><a href="../pt419461/index.html">Ventila√ß√£o para banheiro</a></li>
<li><a href="../pt419467/index.html">De uma l√¢mpada a um aspirador de p√≥ e um drone - como ensinamos Alice a gerenciar centenas de dispositivos</a></li>
<li><a href="../pt419469/index.html">UE4 O ciclo do dia e da noite | Modifica√ß√£o do SkySphere</a></li>
<li><a href="../pt419471/index.html">Op√ß√£o de migra√ß√£o do jQuery para o javascript puro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>