<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õÑÔ∏è üë®üèΩ‚Äçüíº ‚ÜïÔ∏è Automatize a substitui√ß√£o do disco com o Ansible ‚èèÔ∏è üë®üèø‚Äçüè≠ ‚öìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√° pessoal. Trabalho como administrador l√≠der de sistema na OK e sou respons√°vel pela opera√ß√£o est√°vel do portal. Quero falar sobre como criamos o pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Automatize a substitui√ß√£o do disco com o Ansible</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/452110/"><img src="https://habrastorage.org/webt/s9/ga/q9/s9gaq9eke8gooeu1-nnsr5ocv7o.jpeg"><br><br>  Ol√° pessoal.  Trabalho como administrador l√≠der de sistema na OK e sou respons√°vel pela opera√ß√£o est√°vel do portal.  Quero falar sobre como criamos o processo de substitui√ß√£o autom√°tica de discos e, como administrador, foi exclu√≠do desse processo e substitu√≠do por um bot. <br><br>  Este artigo √© uma esp√©cie de translitera√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">desempenho</a> no HighLoad + 2018 <br><a name="habracut"></a><br><h2>  Construindo um processo de substitui√ß√£o de disco </h2><br><h3>  Primeiro alguns n√∫meros </h3><br>  OK √© um servi√ßo gigantesco usado por milh√µes de pessoas.  √â servido por cerca de 7 mil servidores, localizados em 4 data centers diferentes.  Os servidores custam mais de 70 mil unidades.  Se voc√™ as empilhar, uma torre ter√° uma altura superior a 1 km. <br><br>  Os discos r√≠gidos s√£o um componente do servidor que trava com mais freq√º√™ncia.  Com esses volumes, temos que trocar cerca de 30 discos por semana, e esse procedimento se tornou uma rotina n√£o muito agrad√°vel. <br><br><img src="https://habrastorage.org/webt/i8/92/cg/i892cglklhooat_z_qrsexsmzfu.png"><br><br><h3>  Incidentes </h3><br>  Introduzimos um gerenciamento completo de incidentes em nossa empresa.  Todo incidente que registramos em Jira e depois resolvemos e desmontamos.  Se o incidente teve algum efeito para os usu√°rios, definitivamente pensaremos em como responder mais rapidamente nesses casos, em como reduzir o efeito e, √© claro, em como evitar uma recorr√™ncia. <br><br>  Unidades n√£o s√£o exce√ß√£o.  Seu status √© monitorado pelo Zabbix.  Monitoramos as mensagens no Syslog quanto a erros de grava√ß√£o / leitura, analisamos o status de ataques HW / SW, monitoramos o SMART e calculamos o desgaste de SSDs. <br><br><h3>  Como os discos mudaram antes </h3><br>  Quando um gatilho acende no Zabbix, um incidente √© criado em Jira e automaticamente colocado nos engenheiros apropriados nos datacenters.  Fazemos isso com todos os incidentes de HW, ou seja, aqueles que exigem algum tipo de trabalho f√≠sico com o equipamento no data center. <br>  Um engenheiro de um data center √© uma pessoa que resolve problemas relacionados ao hardware, √© respons√°vel pela instala√ß√£o, manuten√ß√£o e desmontagem de servidores.  Depois de receber um ingresso, o engenheiro come√ßa a trabalhar.  Nas prateleiras de discos, ele troca os discos por conta pr√≥pria.  Mas se ele n√£o tiver acesso ao dispositivo desejado, o engenheiro recorre aos administradores do sistema de plant√£o para obter ajuda.  Primeiro de tudo, voc√™ precisa remover o disco da rota√ß√£o.  Para fazer isso, voc√™ precisa fazer as altera√ß√µes necess√°rias no servidor, parar o aplicativo e desmontar o disco. <br><br>  O administrador do sistema de plant√£o durante o turno √© respons√°vel pela opera√ß√£o de todo o portal.  Ele investiga incidentes, reparos, ajuda os desenvolvedores a realizar pequenas tarefas.  Ele n√£o lida apenas com discos r√≠gidos. <br><br>  Anteriormente, os engenheiros do data center conversavam com o administrador do sistema.  Os engenheiros enviaram links para os tickets do Jira, o administrador passou por eles, manteve um registro do trabalho em algum bloco de notas.  Mas os bate-papos s√£o inconvenientes para essas tarefas: as informa√ß√µes n√£o s√£o estruturadas e s√£o rapidamente perdidas.  E o administrador poderia simplesmente se afastar do computador e, por algum tempo, n√£o responder √†s solicita√ß√µes, e o engenheiro ficou no servidor com um monte de discos e esperou. <br><br>  Mas o pior foi que os administradores n√£o viram a imagem completa: quais incidentes de disco existem, onde o problema pode potencialmente surgir.  Isso se deve ao fato de fornecermos todos os incidentes de HW aos engenheiros.  Sim, foi poss√≠vel exibir todos os incidentes no painel do administrador.  Mas existem muitos, e o administrador estava envolvido apenas em alguns deles. <br><br>  Al√©m disso, o engenheiro n√£o p√¥de priorizar corretamente, porque ele n√£o sabe nada sobre a finalidade de servidores espec√≠ficos, sobre a distribui√ß√£o de informa√ß√µes entre unidades. <br><br><h3>  Novo procedimento de substitui√ß√£o </h3><br>  A primeira coisa que fizemos foi levar todos os incidentes de disco para um tipo separado de "disco HW" e adicionar os campos "nome do dispositivo de bloco", "tamanho" e "tipo de disco" a ele, para que essas informa√ß√µes fossem salvas no ticket e n√£o fossem necess√°rias. conversando constantemente. <br><br><div style="text-align:center;"><img width="300" height="400" src="https://habrastorage.org/webt/0y/uz/jm/0yuzjmgoz4hgulcpf5o5vhwde18.png"></div><br>  Tamb√©m concordamos que, no √¢mbito de um incidente, alteraremos apenas um disco.  Isso simplificou bastante o processo de automa√ß√£o, coleta de estat√≠sticas e trabalho. <br><br>  Al√©m disso, o campo "administrador respons√°vel" foi adicionado.  O administrador do sistema √© substitu√≠do automaticamente l√°.  Isso √© muito conveniente, porque agora o engenheiro sempre v√™ quem √© o respons√°vel.  N√£o h√° necessidade de ir ao calend√°rio e pesquisar.  Foi esse campo que permitiu colocar tickets no painel do administrador, no qual, talvez, sua ajuda fosse necess√°ria. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9x/b1/ue/9xb1ueokh0450wgkhq0ije1lfqa.png"></div><br>  Para garantir que todos os participantes recebam o m√°ximo benef√≠cio das inova√ß√µes, criamos filtros e pain√©is, informamos os caras sobre eles.  Quando as pessoas entendem as mudan√ßas, elas n√£o se distanciam delas como de algo desnecess√°rio.  √â importante que um engenheiro saiba o n√∫mero do rack em que o servidor est√° localizado, o tamanho e o tipo de disco.  O administrador precisa, antes de tudo, entender que tipo de grupo de servidores √© esse, que tipo de efeito pode ter ao substituir um disco. <br><br>  A presen√ßa de campos e sua exibi√ß√£o √© conveniente, mas isso n√£o nos salvou da necessidade de usar bate-papos.  Para fazer isso, tive que alterar o fluxo de trabalho. <br><br>  Costumava ser assim: <br><br><div style="text-align:center;"><img width="300" height="400" src="https://habrastorage.org/webt/we/wc/du/wewcdu4q8fqy-gd9wkbutorbabi.png"></div><br>  Hoje, os engenheiros continuam trabalhando assim quando n√£o precisam de ajuda do administrador. <br><br>  A primeira coisa que fizemos foi introduzir um novo status do <b>Investigate</b> .  O ticket est√° nesse status quando o engenheiro ainda n√£o decidiu se precisar√° de um administrador ou n√£o.  Por esse status, o engenheiro pode passar o ticket ao administrador.  Al√©m disso, marcamos tickets com esse status quando uma substitui√ß√£o de disco √© necess√°ria, mas n√£o existe um disco em si no site.  Isso acontece com CDNs e sites remotos. <br><br>  Tamb√©m adicionamos o status <b>Pronto</b> .  O ticket √© transferido para ele ap√≥s a substitui√ß√£o do disco.  Ou seja, tudo j√° foi feito, mas o HW / SW RAID est√° sincronizado no servidor.  Isso pode ser bastante demorado. <br><br>  Se um administrador estiver envolvido, o esquema √© um pouco mais complicado. <br><br><div style="text-align:center;"><img width="400" src="https://habrastorage.org/webt/ev/5a/58/ev5a58jyosbyuc8cfrhr7sru5zo.png"></div><br>  No status <b>Aberto</b> , um ticket pode ser transferido por um administrador do sistema e um engenheiro.  No status <b>Em andamento</b> , o administrador remove o disco da rota√ß√£o para que o engenheiro possa simplesmente remov√™-lo: acende a luz de fundo, desmonta o disco e interrompe os aplicativos, dependendo do grupo de servidores espec√≠fico. <br><br>  Em seguida, o ticket √© convertido em <b>Pronto para alterar</b> : este √© um sinal para o engenheiro de que o disco pode ser extra√≠do.  Todos os campos em Jira j√° est√£o preenchidos, o engenheiro sabe que tipo e tamanho do disco.  Esses dados s√£o afixados no status anterior automaticamente ou pelo administrador. <br><br>  Ap√≥s a substitui√ß√£o do disco, o ticket √© transferido para o status <b>Alterado</b> .  Verifica-se que o disco correto foi inserido, a marca√ß√£o foi conclu√≠da, o aplicativo foi iniciado e algumas tarefas de recupera√ß√£o de dados foram executadas.  Al√©m disso, o ticket pode ser transferido para o status <b>Pronto</b> ; nesse caso, o administrador permanecer√° respons√°vel, porque iniciou o disco em rota√ß√£o.  O esquema completo √© assim. <br><br><div style="text-align:center;"><img width="500" src="https://habrastorage.org/webt/xg/x7/_z/xgx7_zk2mlyubhzepgfw0oogbt4.png"></div><br>  A adi√ß√£o de novos campos tornou nossa vida muito mais f√°cil.  Os caras come√ßaram a trabalhar com informa√ß√µes estruturadas, ficou claro o que e em que est√°gio fazer.  As prioridades se tornaram muito mais relevantes, pois agora s√£o definidas pelo administrador. <br><br>  A necessidade de bate-papos desapareceu.  Obviamente, o administrador pode escrever para o engenheiro "voc√™ precisa substituir mais r√°pido aqui" ou "j√° √† noite, voc√™ ter√° tempo para substituir?".  Mas n√£o conversamos mais diariamente sobre essas quest√µes. <br><br>  Os discos come√ßaram a mudar de embalagem.  Se o administrador chegou ao trabalho um pouco antes, ele tem tempo livre e nada aconteceu, ele pode preparar v√°rios servidores para substitui√ß√£o: colocar campos, remover discos da rota√ß√£o e transferir a tarefa para o engenheiro.  Mais tarde, um engenheiro chega ao data center, v√™ a tarefa, pega as unidades necess√°rias no armaz√©m e as altera imediatamente.  Como resultado, a velocidade de substitui√ß√£o aumentou. <br><br><h3>  Li√ß√µes aprendidas na cria√ß√£o de fluxo de trabalho </h3><br><ul><li>  <b>Ao criar um procedimento, voc√™ precisa coletar informa√ß√µes de diferentes fontes.</b> <br>  Alguns de nossos administradores n√£o sabiam que o engenheiro alterou os discos por conta pr√≥pria.  Alguns pensaram que os engenheiros monitoravam a sincroniza√ß√£o MD RAID, embora alguns deles nem sequer tivessem acesso a isso.  Alguns engenheiros l√≠deres fizeram isso, mas nem sempre, porque o processo n√£o foi descrito em nenhum lugar. </li><li>  <b>O procedimento deve ser simples e direto.</b> <br>  √â dif√≠cil para uma pessoa manter muitos passos na cabe√ßa.  Os status vizinhos mais importantes em Jira precisam ser exibidos na tela principal.  Voc√™ pode renome√°-los, por exemplo, Em andamento, chamamos Pronto para alterar.  E os status restantes podem ser ocultados no menu suspenso para que n√£o causem calos nos olhos.  Mas √© melhor n√£o limitar as pessoas, dar a oportunidade de fazer a transi√ß√£o. <br>  Explique o valor da inova√ß√£o.  Quando as pessoas entendem, elas aceitam melhor o novo procedimento.  Era muito importante para n√≥s que as pessoas n√£o chamassem o processo inteiro, mas o seguissem.  Ent√£o constru√≠mos essa automa√ß√£o. </li><li>  <b>Espere, analise, entenda.</b> <br>  Levamos cerca de um m√™s para elaborar o procedimento, implementa√ß√£o t√©cnica, reuni√µes e discuss√µes.  E para implementa√ß√£o - mais de tr√™s meses.  Vi como as pessoas est√£o lentamente come√ßando a usar a inova√ß√£o.  Nos est√°gios iniciais, havia muita negatividade.  Mas ele era completamente independente do procedimento em si, sua implementa√ß√£o t√©cnica.  Por exemplo, um administrador n√£o usou o Jira, mas o plugin Jira no Confluence, e algumas coisas n√£o estavam dispon√≠veis para ele.  Mostrou a ele Jira, o administrador aumentou a produtividade, as tarefas gerais e a substitui√ß√£o de discos. </li></ul><br><h2>  Automa√ß√£o de substitui√ß√£o de unidades </h2><br>  Passamos para a automa√ß√£o de substitui√ß√£o de discos v√°rias vezes.  J√° t√≠nhamos tempo operacional, scripts, mas todos funcionavam interativamente ou no modo manual, eles exigiam o lan√ßamento.  E somente ap√≥s a introdu√ß√£o do novo procedimento, percebemos que est√°vamos faltando. <br><br>  Como agora o processo de substitui√ß√£o est√° dividido em est√°gios, cada um com um executor e uma lista de a√ß√µes, podemos ativar a automa√ß√£o por est√°gios, e n√£o todos de uma vez.  Por exemplo, a etapa mais simples - Ready (verifica√ß√£o de sincroniza√ß√£o RAID / dados) pode ser facilmente delegada ao bot.  Quando o bot aprende um pouco, voc√™ pode dar a ele uma tarefa mais respons√°vel - colocar o disco em rota√ß√£o etc. <br><br><h3>  Configura√ß√µes do zool√≥gico </h3><br>  Antes de falar sobre o bot, faremos uma pequena excurs√£o ao nosso zool√≥gico de instala√ß√£o.  Primeiro de tudo, √© devido ao tamanho gigantesco de nossa infraestrutura.  Em segundo lugar, para cada servi√ßo, tentamos escolher a configura√ß√£o ideal de ferro.  Temos cerca de 20 modelos RAID de hardware, principalmente LSI e Adaptec, mas existem HP e DELL de vers√µes diferentes.  Cada controlador RAID possui seu pr√≥prio utilit√°rio de gerenciamento.  O conjunto de comandos e a emiss√£o deles podem diferir de vers√£o para vers√£o de cada controlador RAID.  Onde o HW-RAID n√£o √© usado, pode haver medo. <br><br>  Quase todas as novas instala√ß√µes que fazemos sem backup em disco.  Tentamos n√£o usar mais o RAID de hardware e software, pois reservamos nossos sistemas no n√≠vel de data centers, n√£o servidores.  Mas √© claro que existem muitos servidores herdados que precisam ser suportados. <br><br>  Em algum lugar, os discos nos controladores RAID lan√ßam dispositivos brutos; em algum lugar, eles usam JBOD.  Existem configura√ß√µes com uma unidade de sistema no servidor e, se voc√™ precisar substitu√≠-lo, precisar√° reformatar o servidor com a instala√ß√£o do sistema operacional e dos aplicativos, com as mesmas vers√µes, adicionar arquivos de configura√ß√£o e iniciar aplicativos.  Tamb√©m existem muitos grupos de servidores nos quais a redund√¢ncia √© realizada n√£o no n√≠vel do subsistema de disco, mas diretamente nos pr√≥prios aplicativos. <br><br>  No total, temos mais de 400 grupos exclusivos de servidores que executam cerca de 100 aplicativos diferentes.  Para cobrir um n√∫mero t√£o grande de op√ß√µes, precis√°vamos de uma ferramenta de automa√ß√£o multifuncional.  √â aconselh√°vel com uma DSL simples, para que n√£o apenas a pessoa que escreveu isso possa apoi√°-la. <br><br>  Escolhemos o Ansible porque √© sem agente: n√£o havia necessidade de preparar a infraestrutura, in√≠cio r√°pido.  Al√©m disso, est√° escrito em Python, aceito como padr√£o na equipe. <br><br><h3>  Esquema geral </h3><br>  Vejamos um esquema geral de automa√ß√£o usando um incidente como exemplo.  O Zabbix detecta que a unidade sdb est√° com defeito, o gatilho acende e um ticket √© criado em Jira.  O administrador olhou para ele, percebeu que isso n√£o √© um duplicado e n√£o √© falso positivo, ou seja, voc√™ precisa alterar o disco e converte o ticket em andamento. <br><br><img src="https://habrastorage.org/webt/9s/fy/q5/9sfyq5cucem0dbbhahfd3_w7tac.png"><br>  O aplicativo DiskoBot escrito em Python pesquisa periodicamente Jira em busca de novos tickets.  Ele percebe que um novo t√≠quete em andamento apareceu, o encadeamento correspondente √© acionado, que inicia o manual no Ansible (isso √© feito para cada status no Jira).  Nesse caso, o Prepare2change √© iniciado. <br><br>  O Ansible vai para o host, remove o disco da rota√ß√£o e relata o status ao aplicativo por meio de retornos de chamada. <br><br><img src="https://habrastorage.org/webt/i2/bk/nq/i2bknqits8exw9dtr7sj4zydl58.png"><br>  De acordo com os resultados, o bot transfere automaticamente o ticket para Pronto para alterar.  O engenheiro recebe uma notifica√ß√£o e muda o disco, ap√≥s o que transfere o ticket para Alterado. <br><br><img src="https://habrastorage.org/webt/h9/m8/zw/h9m8zwfrzltmu0q1tz8opctrccu.png"><br>  De acordo com o esquema acima, o ticket retorna ao bot, lan√ßa outro manual, vai para o host e entra no disco em rota√ß√£o.  O bot fecha o ticket.  Viva! <br><br><img src="https://habrastorage.org/webt/cv/js/w1/cvjsw1y9qrpkra2twsx-sy4jokc.png"><br>  Agora vamos falar sobre alguns dos componentes do sistema. <br><br><h3>  Diskobot </h3><br>  Esta aplica√ß√£o est√° escrita em Python.  Ele seleciona tickets do Jira de acordo com o <abbr title="Idioma de Consulta do JIRA">JQL</abbr> .  Dependendo do status do ticket, o √∫ltimo chega ao manipulador correspondente, que, por sua vez, inicia o status correspondente do manual Ansible. <br><br>  Intervalos de pesquisa e JQL s√£o definidos no arquivo de configura√ß√£o do aplicativo. <br><br><pre><code class="plaintext hljs">jira_states: investigate: jql: '‚Ä¶ status = Open and "Disk Size" is EMPTY' interval: 180 inprogress: jql: '‚Ä¶ and "Disk Size" is not EMPTY and "Device Name" is not EMPTY' ready: jql: '‚Ä¶ and (labels not in ("dbot_ignore") or labels is EMPTY)' interval: 7200</code> </pre> <br>  Por exemplo, entre os tickets no status Em andamento, apenas aqueles com os campos Tamanho do disco e Nome do dispositivo s√£o preenchidos.  Nome do dispositivo √© o nome do dispositivo de bloco necess√°rio para executar o manual.  O tamanho do disco √© necess√°rio para que o engenheiro saiba qual o tamanho do disco. <br><br>  E entre os tickets com status Ready, os tickets com o r√≥tulo dbot_ignore s√£o filtrados.  A prop√≥sito, usamos r√≥tulos Jira tanto para essa filtragem quanto para marcar tickets duplicados e coletar estat√≠sticas. <br><br>  Se o manual falhar, Jira atribui o r√≥tulo dbot_failed para que voc√™ possa descobrir mais tarde. <br><br><h3>  Intera√ß√£o com Ansible </h3><br>  O aplicativo interage com o Ansible por meio da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">API Ansible Python</a> .  No playbook_executor, passamos o nome do arquivo e o conjunto de vari√°veis.  Isso permite que voc√™ mantenha o projeto Ansible na forma de arquivos yml regulares, em vez de descrev√™-lo no c√≥digo Python. <br><br>  Tamb√©m em Ansible, atrav√©s de * extra_vars *, o nome do dispositivo de bloco, o status do ticket, bem como callback_url, no qual a chave de emiss√£o √© costurada, √© usado - √© usado para retorno de chamada em HTTP. <br><br>  Para cada ativa√ß√£o, um invent√°rio tempor√°rio √© gerado, consistindo em um host e no grupo ao qual esse host pertence, para que group_vars seja aplicado. <br><br>  Aqui est√° um exemplo de uma tarefa na qual o retorno de chamada HTTP √© implementado. <br><br>  O resultado das cartilhas que usamos usando callaback (s).  Eles s√£o de dois tipos: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Plug-in de retorno de chamada aceit√°vel</a> , fornece dados sobre os resultados de um manual.  Ele descreve as tarefas que foram iniciadas, executadas com ou sem √™xito.  Esse retorno de chamada √© chamado no final do manual. </li><li>  Retorno de chamada HTTP para obter informa√ß√µes durante a reprodu√ß√£o de um manual.  No Ansible, realizamos uma solicita√ß√£o POST / GET ao lado de nosso aplicativo. </li></ul><br>  Por meio de retorno (s) de HTTP, s√£o transmitidas as vari√°veis ‚Äã‚Äãdefinidas durante a execu√ß√£o do manual e que queremos salvar e usar nas execu√ß√µes subseq√ºentes.  N√≥s escrevemos esses dados no sqlite. <br><br>  Tamb√©m por meio de retorno de chamada HTTP, deixamos coment√°rios e alteramos o status do ticket. <br><br><div class="spoiler">  <b class="spoiler_title">Retorno de chamada HTTP</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># Make callback to Diskobot App # Variables: # callback_post_body: # A dict with follow keys. All keys are optional # msg: If exist it would be posted to Jira as comment # data: If exist it would be saved in Incident.variables # desire_state: Set desire_state for incident # status: If exist Proceed issue to that status - name: Callback to Diskobot app (jira comment/status) uri: url: "{{ callback_url }}/{{ devname }}" user: "{{ diskobot_user }}" password: "{{ diskobot_pass }}" force_basic_auth: True method: POST body: "{{ callback_post_body | to_json }}" body_format: json delegate_to: 127.0.0.1</code> </pre><br></div></div><br>  Como muitas tarefas do mesmo tipo, colocamos em um arquivo comum separado e o inclu√≠mos, se necess√°rio, para n√£o repetir constantemente nos manuais.  Callback_ url aparece aqui, no qual a chave do problema e o nome do host est√£o protegidos.  Quando o Ansible executa essa solicita√ß√£o POST, o bot percebe que veio como parte de um incidente desse tipo. <br><br>  E aqui est√° um exemplo de um manual, no qual exibimos um disco de um dispositivo MD: <br><br><pre> <code class="plaintext hljs"> # Save mdadm configuration - include: common/callback.yml vars: callback_post_body: status: 'Ready to change' msg: "Removed disk from mdraid {{ mdadm_remove_disk.msg | comment_jira }}" data: mdadm_data: "{{ mdadm_remove_disk.removed }}" parted_info: "{{ parted_info | default() }}" when: - mdadm_remove_disk | changed - mdadm_remove_disk.removed</code> </pre><br>  Esta tarefa coloca o ticket Jira no status "Pronto para alterar" e adiciona um coment√°rio.  Al√©m disso, a vari√°vel mdam_data armazena a lista de dispositivos md dos quais o disco foi exclu√≠do e o despejo dividido em parted_info. <br><br>  Quando o engenheiro inserir um novo disco, poderemos usar essas vari√°veis ‚Äã‚Äãpara restaurar o despejo de parti√ß√£o, al√©m de inserir o disco nos dispositivos md dos quais ele foi exclu√≠do. <br><br><h3>  Modo de verifica√ß√£o Ansible </h3><br>  Ligar a automa√ß√£o foi assustador.  Portanto, decidimos executar todos os playbooks no modo <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">execu√ß√£o a seco</a> , na qual o Ansible n√£o executa nenhuma a√ß√£o nos servidores, mas apenas as emula. <br><br>  Esse lan√ßamento √© executado por meio de um m√≥dulo de retorno de chamada separado, e o resultado do manual √© salvo no Jira como um coment√°rio. <br><br><img src="https://habrastorage.org/webt/aa/rz/0s/aarz0srsrqqxbru88guob9spjqm.png"><br><br>  Em primeiro lugar, permitiu validar o trabalho do bot e playbooks.  Em segundo lugar, aumentou a confian√ßa dos administradores no bot. <br><br>  Quando passamos pela valida√ß√£o e percebemos que voc√™ pode executar o Ansible n√£o apenas no modo de execu√ß√£o a seco, criamos o bot√£o Executar Diskobot no Jira para iniciar o mesmo manual com as mesmas vari√°veis ‚Äã‚Äãno mesmo host, mas no modo normal. <br><br>  Al√©m disso, o bot√£o √© usado para reiniciar o manual em caso de falha. <br><br><h3>  Estrutura de Playbooks </h3><br>  Eu j√° mencionei que, dependendo do status do ingresso de Jira, o bot lan√ßa diferentes playbooks. <br><br>  Em primeiro lugar, √© muito mais f√°cil organizar a entrada. <br>  Em segundo lugar, em alguns casos, √© simplesmente necess√°rio. <br><br>  Por exemplo, ao substituir um disco do sistema, voc√™ primeiro precisa acessar o sistema de implanta√ß√£o, criar uma tarefa e, ap√≥s a implanta√ß√£o correta, o servidor estar√° acess√≠vel via ssh, e voc√™ poder√° aplicar o aplicativo nele.  Se fizermos tudo isso em um manual, o Ansible n√£o poder√° execut√°-lo devido √† inacessibilidade do host. <br><br>  Usamos fun√ß√µes Ansible para cada grupo de servidores.  Aqui voc√™ pode ver como os manuais est√£o organizados em um deles. <br><br><img src="https://habrastorage.org/webt/ef/0o/hu/ef0ohuo0obwa1htij7o4at6dvus.png"><br><br>  Isso √© conveniente, porque fica imediatamente claro onde est√£o localizadas as tarefas.  No main.yml, que √© a entrada para a fun√ß√£o Ansible, podemos incluir apenas pelo status do ticket ou tarefas gerais necess√°rias para todos, por exemplo, passar a identifica√ß√£o ou receber um token. <br><br><h4>  Investigation.yml </h4><br>  √â executado para tickets no status de Investiga√ß√£o e Aberto.  O mais importante para este manual √© o nome do dispositivo de bloco.  Esta informa√ß√£o nem sempre est√° dispon√≠vel. <br><br>  Para obt√™-lo, analisamos o resumo do Jira, o √∫ltimo valor do gatilho Zabbix.  Pode conter o nome do dispositivo de bloco - com sorte.  Ou pode conter um ponto de montagem, - ent√£o voc√™ precisa ir ao servidor, analisar e calcular a unidade desejada.  Al√©m disso, um gatilho pode transmitir um endere√ßo scsi ou alguma outra informa√ß√£o.  Mas tamb√©m acontece que n√£o h√° pistas e voc√™ precisa analisar. <br><br>  Ap√≥s descobrir o nome do dispositivo de bloco, coletamos informa√ß√µes sobre o tipo e tamanho do disco para preencher os campos em Jira.  Tamb√©m removemos informa√ß√µes sobre o fornecedor, modelo, firmware, ID, SMART e inserimos tudo isso em um coment√°rio no ticket Jira.  O administrador e o engenheiro n√£o precisam mais procurar esses dados.  :) <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/m6/64/kr/m664krcgyi4vkc-rq0almmqv6uy.png"></div><br><br><h4>  prepare2change.yml </h4><br>  A sa√≠da do disco da rota√ß√£o, prepara√ß√£o para substitui√ß√£o.  O est√°gio mais dif√≠cil e crucial.  √â aqui que voc√™ pode parar o aplicativo quando ele n√£o pode ser parado.  Ou retire um disco que n√£o possui r√©plicas suficientes e, portanto, tenha efeito sobre os usu√°rios, perca alguns dados.  Aqui temos o maior n√∫mero de verifica√ß√µes e notifica√ß√µes no chat. <br><br>  No caso mais simples, estamos falando sobre remover uma unidade do HW / MD RAID. <br><br>  Em situa√ß√µes mais complexas (em nossos sistemas de armazenamento), quando o backup √© realizado no n√≠vel do aplicativo, voc√™ precisa acessar o aplicativo usando a API, relatar a sa√≠da do disco, desativ√°-la e iniciar a recupera√ß√£o. <br><br>  Agora estamos migrando massivamente para a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nuvem</a> e, se o servidor estiver nublado, o Diskobot acessa a API da nuvem, diz que vai trabalhar com este minion - o servidor no qual os cont√™ineres est√£o sendo executados - e pergunta "migrar todos os cont√™ineres deste minion".  E, ao mesmo tempo, acende a luz de fundo para que o engenheiro veja imediatamente qual retirar. <br><br><h4>  changing.yml </h4><br>  Depois de substituir um disco, primeiro verificamos sua disponibilidade. <br><br>  Os engenheiros nem sempre colocam novos discos; portanto, adicionamos uma verifica√ß√£o dos valores SMART que nos satisfazem. <br><br><div class="spoiler">  <b class="spoiler_title">Quais atributos estamos vendo</b> <div class="spoiler_text">  Contagem de setores realocados (5) &lt;100 <br>  Contagem atual de setores pendentes (107) == 0 <br></div></div><br>  Se a unidade falhar no teste, o engenheiro √© notificado de uma substitui√ß√£o.  Se tudo estiver em ordem, a luz de fundo se apaga, a marca√ß√£o √© aplicada e o disco √© inserido em rota√ß√£o. <br><br><h4>  ready.yml </h4><br>  O caso mais simples: verificar a sincroniza√ß√£o de raides HW / SW ou encerrar a sincroniza√ß√£o de dados no aplicativo. <br><br><h3>  API do aplicativo </h3><br>  Mencionei v√°rias vezes que o bot geralmente acessa as APIs do aplicativo.  Obviamente, nem todos os aplicativos tinham os m√©todos necess√°rios, ent√£o eu tive que refin√°-los.  Aqui est√£o os m√©todos mais importantes que usamos: <br><ul><li>  Status  O status de um cluster ou disco para entender se √© poss√≠vel trabalhar com ele; <br></li><li>  Iniciar / parar.  Ativa√ß√£o-desativa√ß√£o do disco; <br></li><li>  Migrar / restaurar.  Migra√ß√£o e recupera√ß√£o de dados durante e ap√≥s a substitui√ß√£o. <br></li></ul><br><h3>  Li√ß√µes Aprendidas pela Ansible </h3><br>  Eu realmente amo Ansible.  Mas, muitas vezes, quando olho para diferentes projetos de c√≥digo aberto e vejo como as pessoas escrevem playbooks, fico um pouco assustada.  Tecido l√≥gico complexo a partir de quando / loop, falta de flexibilidade e idempot√™ncia devido ao uso frequente de shell / comando. <br><br>  Decidimos simplificar tudo o m√°ximo poss√≠vel, aproveitando o Ansible - modularidade.  No n√≠vel mais alto est√£o os playbooks, eles podem ser escritos por qualquer administrador, um desenvolvedor de terceiros que conhe√ßa Ansible um pouco. <br><br><pre> <code class="plaintext hljs">- name: Blink disk become: True register: locate_action disk_locate: locate: '{{ locate }}' devname: '{{ devname }}' ids: '{{ locate_ids | default(pd_id) | default(omit) }}'</code> </pre><br><br>  Se alguma l√≥gica √© dif√≠cil de implementar nos playbooks, a colocamos em um m√≥dulo ou filtro Ansible.  Os scripts podem ser escritos em Python e em qualquer outro idioma. <br><br>  Eles s√£o f√°ceis e r√°pidos de escrever.  Por exemplo, o m√≥dulo de destaque de disco, um exemplo do uso acima, consiste em 265 linhas. <br><br><img width="400" height="400" src="https://habrastorage.org/webt/c4/ma/bp/c4mabpsyezbjbfp2likixvta24k.png"><br><br>  No n√≠vel mais baixo √© a biblioteca.  Para este projeto, escrevemos um aplicativo separado, um tipo de abstra√ß√£o sobre os RAIDs de hardware e software que executam as solicita√ß√µes correspondentes. <br><br><img width="400" height="400" src="https://habrastorage.org/webt/qf/vt/pr/qfvtprdi9jw2vxserynmxbrmdg8.png"><br><br>  Os maiores pontos fortes da Ansible s√£o sua simplicidade e playbooks compreens√≠veis.  Eu acredito que voc√™ precisa usar isso e n√£o gerar arquivos yaml assustadores e um grande n√∫mero de condi√ß√µes, c√≥digo de shell e loops. <br><br>  Se voc√™ deseja repetir nossa experi√™ncia com a API Ansible, lembre-se de duas coisas: <br><br><ul><li>  Playbook_executor e geralmente o playbook n√£o pode ter o tempo limite esgotado.  H√° um tempo limite na sess√£o ssh, mas n√£o h√° tempo limite no manual.  Se tentarmos desmontar uma unidade que ainda n√£o existe no sistema, o playbook ser√° executado indefinidamente; portanto, tivemos que envolv√™-lo em um inv√≥lucro separado e eliminar por tempo limite. <br></li><li>  O Ansible √© bifurcado, portanto sua API n√£o √© segura para threads.  Lan√ßamos todos os nossos playbooks e single-threaded. <br></li></ul><br>  Como resultado, conseguimos automatizar a substitui√ß√£o de cerca de 80% das unidades.  Em geral, a taxa de substitui√ß√£o dobrou.  Hoje, o administrador apenas analisa o incidente e decide se deseja alterar o disco ou n√£o e, em seguida, d√° um clique. <br><br>  Mas agora estamos come√ßando a enfrentar outro problema: alguns novos administradores n√£o sabem como mudar de unidade.  :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452110/">https://habr.com/ru/post/pt452110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452094/index.html">.NET: Ferramentas para trabalhar com multithreading e assincronia. Parte 1</a></li>
<li><a href="../pt452098/index.html">Logs do desenvolvedor front-end Habr: refator e reflexo</a></li>
<li><a href="../pt452102/index.html">Jogo de fotos para quem gosta de drones: brevemente sobre o AirSelfie 2</a></li>
<li><a href="../pt452106/index.html">Convidamos palestrantes para a reuni√£o de bricolage de ver√£o em 16 de junho de 2019</a></li>
<li><a href="../pt452108/index.html">Docker: conselhos inofensivos</a></li>
<li><a href="../pt452112/index.html">CRM ++</a></li>
<li><a href="../pt452114/index.html">HolyJS 2019: Analisando a partir do SEMrush (Parte 1)</a></li>
<li><a href="../pt452116/index.html">√çndices no PostgreSQL - 8 (RUM)</a></li>
<li><a href="../pt452118/index.html">Cientista quebra o c√≥digo do misterioso manuscrito de Voynich</a></li>
<li><a href="../pt452122/index.html">"P√≠lula do dem√¥nio" em movimento</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>