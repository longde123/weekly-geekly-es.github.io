<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•´ ‚õ∞Ô∏è üôçüèæ Como atualizar um projeto existente do ASP.NET MVC para o ASP.NET Core. Guia pr√°tico üéÄ ‚úäüèΩ ü§∫</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta postagem nasceu da nossa experi√™ncia na migra√ß√£o de um projeto existente do ASP.NET MVC para o ASP.NET Core. Tentamos reunir todo o processo de m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como atualizar um projeto existente do ASP.NET MVC para o ASP.NET Core. Guia pr√°tico</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/472738/">  Esta postagem nasceu da nossa experi√™ncia na migra√ß√£o de um projeto existente do ASP.NET MVC para o ASP.NET Core.  Tentamos reunir todo o processo de migra√ß√£o de forma estruturada e descrever os v√°rios gargalos para que os desenvolvedores pudessem continuar confiando nesse material e seguir o roteiro para resolver esses problemas. <br><br>  Algumas palavras sobre o nosso projeto.  Somos uma plataforma de com√©rcio eletr√¥nico de c√≥digo aberto no ASP.NET, que na √©poca da transfer√™ncia j√° existia com sucesso h√° 9 anos.  Fizemos a migra√ß√£o h√° dois anos - mas nossas m√£os passaram a escrever sobre isso apenas agora.  Naquela √©poca, √©ramos um dos primeiros grandes projetos que decidiram dar esse passo. <br><br><h2>  Por que mudar para o ASP.NET Core? </h2><br>  Antes de prosseguir com as etapas para migrar do ASP.NET MVC para o ASP.NET Core, algumas palavras sobre os benef√≠cios desta plataforma. <br><br><img src="https://habrastorage.org/webt/wo/xg/ue/woxgueorhrjz_brki1qktunkqhe.png"><br><a name="habracut"></a><br><div class="spoiler"> <b class="spoiler_title">Benef√≠cios do ASP.NET Core</b> <div class="spoiler_text">  Portanto, o ASP.NET Core j√° √© uma estrutura bastante conhecida e desenvolvida, que j√° passou por v√°rias atualiza√ß√µes importantes, o que significa que hoje √© bastante est√°vel, tecnologicamente avan√ßado e resistente a ataques XSRF / CSRF. <br><br>  <b>A plataforma cruzada</b> √© uma das caracter√≠sticas que lhe permitem ganhar cada vez mais popularidade.  A partir de agora, seu aplicativo da Web poder√° ser executado nos ambientes Windows e Unix. <br><br>  <b>Modularidade</b> - O ASP.NET Core vem totalmente na forma de pacotes NuGet, permitindo otimizar o aplicativo, incluindo os pacotes necess√°rios selecionados.  Isso melhora o desempenho da solu√ß√£o e reduz o tempo necess√°rio para atualizar partes individuais.  Esse √© o segundo recurso importante que permite que os desenvolvedores integrem de maneira mais flex√≠vel novos recursos em suas solu√ß√µes. <br><br>  <b>O desempenho</b> √© outro passo para a cria√ß√£o de um aplicativo de alto desempenho. O ASP.NET Core processa 2300% mais solicita√ß√µes por segundo que o ASP.NET 4.6 e 800% mais solicita√ß√µes por segundo que node.js.  Voc√™ pode examinar os testes de desempenho detalhados <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><img src="https://habrastorage.org/webt/wb/vg/oi/wbvgoixwdbcfr0m8l0myjywrlpq.png"><br><br>  <b>Middleware</b> √© o novo pipeline modular leve e de alto desempenho para solicita√ß√µes no aplicativo.  Cada parte do middleware processa uma solicita√ß√£o HTTP e decide retornar o resultado ou passa a pr√≥xima parte do middleware.  Essa abordagem fornece ao desenvolvedor controle completo sobre o pipeline HTTP e contribui para o desenvolvimento de m√≥dulos simples para o aplicativo, o que √© importante para um crescente projeto de c√≥digo aberto. <br><br>  O ASP.NET Core MVC fornece recursos que simplificam o desenvolvimento da web.  O NopCommerce j√° usava recursos como o modelo Model-View-Controller, sintaxe Razor, vincula√ß√£o e valida√ß√£o de modelos, mas surgiram novas ferramentas: <br><br><ul><li>  Tag Helpers.  Este √© o c√≥digo do lado do servidor para contribuir com a cria√ß√£o e renderiza√ß√£o de elementos HTML nos arquivos do Razor. </li><li>  Exibir componentes.  Esta √© uma nova ferramenta, semelhante a visualiza√ß√µes parciais, mas muito mais poderosa.  O nopCommerce usa componentes de exibi√ß√£o quando a reutiliza√ß√£o da l√≥gica de renderiza√ß√£o √© necess√°ria e quando a tarefa √© muito complexa para uma exibi√ß√£o parcial. </li><li>  Vis√£o de DI.  Embora a maioria dos dados exibidos nas visualiza√ß√µes seja passada do controlador, o nopCommerce tem visualiza√ß√µes nas quais a inje√ß√£o de depend√™ncia √© mais conveniente. </li></ul><br>  Obviamente, o ASP.NET Core possui muito mais recursos, mas acabamos de examinar o mais interessante. </div></div><br>  Agora vamos falar sobre o que voc√™ deve considerar ao transportar seu aplicativo para uma nova plataforma. <br><br><h2>  A migra√ß√£o </h2><br>  O texto conter√° um grande n√∫mero de links para a documenta√ß√£o oficial do ASP.NET Core para ajudar a obter informa√ß√µes mais detalhadas sobre o t√≥pico.  Especialmente relevante para desenvolvedores que enfrentam uma tarefa semelhante pela primeira vez. <br><br><h3>  Etapa 1. Prepara√ß√£o das ferramentas </h3><br>  A primeira coisa que voc√™ precisa fazer √© atualizar o Visual Studio 2017 para a vers√£o 15.3 ou superior.  E instale a vers√£o mais recente do .NET Core SDK. <br><br>  Antes de iniciar a migra√ß√£o, √© recomend√°vel usar a ferramenta de an√°lise de portabilidade do .NET <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">.Net Portability Analyzer</a> .  Este √© um bom ponto de partida para entender o qu√£o trabalhosa ser√° a transi√ß√£o de uma plataforma para outra.  Mas, √© claro, essa ferramenta n√£o resolve todos os problemas e, no processo, haver√° muitas armadilhas.  A seguir, ser√£o descritos os principais est√°gios que precisar√£o ser aprovados e as solu√ß√µes utilizadas em nosso projeto ser√£o mostradas. <br><br>  A primeira coisa que voc√™ precisa √© atualizar os links para as bibliotecas usadas no projeto que suportam o .NET Standard. <br><br><h3>  Etapa 2. An√°lise de compatibilidade dos pacotes NuGet para suportar o padr√£o .Net </h3><br>  Se voc√™ usa pacotes NuGet em seu projeto, precisa verificar se eles s√£o compat√≠veis com o .NET Core.  Uma maneira de fazer isso √© usar a ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NuGetPackageExplorer</a> . <br><br><h3>  Etapa 3. O .NET Core usa o novo formato de arquivo csproj </h3><br>  √â importante usar a nova abordagem para adicionar links de terceiros introduzidos no .NET Core: quando uma nova biblioteca de classes for adicionada √† solu√ß√£o, voc√™ dever√° abrir o arquivo principal do projeto e substituir seu conte√∫do pelo seguinte: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Sdk</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.NET.Sdk"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span>netcoreapp2.2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TargetFramework</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PropertyGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PackageReference</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Include</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Microsoft.AspNetCore.App"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2.2.6"</span></span></span><span class="hljs-tag"> /&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ItemGroup</span></span></span><span class="hljs-tag">&gt;</span></span> ... <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Os links das bibliotecas conectadas ser√£o baixados automaticamente.  Mais informa√ß√µes sobre o mapeamento entre as propriedades project.json e CSPROJ podem ser encontradas na documenta√ß√£o oficial <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br><h3>  Etapa 4. Atualizando o espa√ßo para nome </h3><br>  Voc√™ deve remover todos os usos do System.Web e substitu√≠-los por Microsoft.AspNetCore. <br><br><h3>  Etapa 5. Voc√™ deve configurar o arquivo Startup.cs.  em vez de usar global.asax </h3><br>  O ASP.NET Core possui um novo mecanismo para carregar o aplicativo.  O ponto de entrada para o aplicativo se torna <code>Startup</code> e a depend√™ncia no arquivo <i>Global.asax</i> desaparece.  <code>Startup</code> registra o pacote de middleware no aplicativo.  <code>Startup</code> deve incluir o m√©todo <code>Configure</code> .  No <code>Configure</code> adicione o middleware necess√°rio ao pipeline. <br><br>  <b>Problemas com o Startup.cs</b> <br><br><ol><li>  Configurando Middleware para Solicita√ß√µes MVC e WebAPI </li><li>  Defini√ß√µes de configura√ß√£o para: </li></ol><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Manipula√ß√£o de exce√ß√£o</a> <br><p>  Como no processo de transi√ß√£o, voc√™ inevitavelmente ter√° que lidar com v√°rios tipos de colis√µes, deve preparar e configurar imediatamente o tratamento de exce√ß√µes no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ambiente de</a> desenvolvimento.  Usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">UseDeveloperExceptionPage</a> , o middleware √© adicionado para capturar exce√ß√µes. </p></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Roteamento MVC</a> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">O registro de novas rotas</a> tamb√©m foi alterado.  IRouteBuilder agora √© usado em vez de RouteCollection, uma nova maneira de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">registrar restri√ß√µes</a> (IActionConstraint) </p></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Filtros MVC / WebAPI</a> <br><p>  √â necess√°rio reescrever os filtros de acordo com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nova implementa√ß√£o do ASP.NET Core</a> . </p></li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Formatadores</a> MVC / <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">WebAPI</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Modelos de encaderna√ß√£o</a> </li></ul><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//add basic MVC feature var mvcBuilder = services.AddMvc(); //add custom model binder provider (to the top of the provider list) mvcBuilder.AddMvcOptions(options =&gt; options.ModelBinderProviders.Insert(0, new NopModelBinderProvider())); /// &lt;summary&gt; /// Represents model binder provider for the creating NopModelBinder /// &lt;/summary&gt; public class NopModelBinderProvider : IModelBinderProvider { /// &lt;summary&gt; /// Creates a nop model binder based on passed context /// &lt;/summary&gt; /// &lt;param name="context"&gt;Model binder provider context&lt;/param&gt; /// &lt;returns&gt;Model binder&lt;/returns&gt; public IModelBinder GetBinder(ModelBinderProviderContext context) { if (context == null) throw new ArgumentNullException(nameof(context)); var modelType = context.Metadata.ModelType; if (!typeof(BaseNopModel).IsAssignableFrom(modelType)) return null; //use NopModelBinder as a ComplexTypeModelBinder for BaseNopModel if (context.Metadata.IsComplexType &amp;&amp; !context.Metadata.IsCollectionType) { //create binders for all model properties var propertyBinders = context.Metadata.Properties .ToDictionary(modelProperty =&gt; modelProperty, modelProperty =&gt; context.CreateBinder(modelProperty)); return new NopModelBinder(propertyBinders, EngineContext.Current.Resolve&lt;ILoggerFactory&gt;()); } //or return null to further search for a suitable binder return null; } }</span></span></code> </pre> <br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">√Åreas de atua√ß√£o</a> </li></ul><br><br><pre> <code class="java hljs">app.UseMvc(routes =&gt; { routes.MapRoute(<span class="hljs-string"><span class="hljs-string">"areaRoute"</span></span>, <span class="hljs-string"><span class="hljs-string">"{area:exists}/{controller=Admin}/{action=Index}/{id?}"</span></span>); routes.MapRoute( name: <span class="hljs-string"><span class="hljs-string">"default"</span></span>, template: <span class="hljs-string"><span class="hljs-string">"{controller=Home}/{action=Index}/{id?}"</span></span>); });</code> </pre> <br>  Ao mesmo tempo, a pasta com o nome √Årea, dentro da qual a pasta Admin est√° localizada, deve ser colocada na raiz do aplicativo.  Agora, o atributo <code>[Area("Admin")] [Route("admin")]</code> ser√° usado para conectar o controlador a esta √°rea. <br>  Resta apenas criar visualiza√ß√µes para todas as a√ß√µes descritas no controlador. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/3o/eo/rp/3oeorp_vjlbwlisc1kbavvvaeoe.png"></div><br><pre> <code class="java hljs">[Area(<span class="hljs-string"><span class="hljs-string">"Admin"</span></span>)] [Route(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdminController</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(); } }</code> </pre> <br>  <b>Valida√ß√£o</b> <br><br>  Agora voc√™ n√£o precisa passar o IFormCollection para os controladores, pois, neste caso, a valida√ß√£o do servidor asp.net est√° desabilitada - o MVC est√° suprimindo a valida√ß√£o adicional se o IFormCollection n√£o for nulo.  A solu√ß√£o para o problema pode ser adicionar essa propriedade ao modelo, isso nos impedir√° de passar diretamente para o m√©todo do controlador.  Esta regra √© v√°lida apenas se um modelo estiver presente, mas se n√£o houver um modelo, n√£o haver√° valida√ß√£o. <br><br>  As propriedades filho n√£o s√£o mais validadas automaticamente.  Deve ser especificado manualmente. <br><br><h3>  Etapa 6. Transferindo manipuladores HTTP e m√≥dulos HTTP para Middleware </h3><br>  Os manipuladores HTTP e os m√≥dulos HTTP s√£o essencialmente muito semelhantes ao conceito de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://docs.microsoft.com/ru-ru/aspnet/core/migration/">Middleware no ASP.NET Core</a> , mas, diferentemente dos m√≥dulos, a ordem do middleware √© baseada na ordem em que eles s√£o inseridos no pipeline de solicita√ß√£o.  A ordem dos m√≥dulos, na maioria das vezes, √© baseada nos eventos do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ciclo de vida do aplicativo</a> .  A ordem do middleware para as respostas √© o oposto da ordem das solicita√ß√µes, e a ordem dos m√≥dulos para as solicita√ß√µes e respostas √© a mesma.Com base nisso, voc√™ pode prosseguir com a atualiza√ß√£o. <br><br>  Ent√£o, o que resta ser atualizado: <br><br><ul><li>  Migra√ß√£o de m√≥dulos para Middleware (AuthenticationMiddleware, CultureMiddleware, etc.) </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=https://docs.microsoft.com/en-us/aspnet/core/migration/">Manipuladores</a> para Middleware </li><li>  Usando o novo middleware </li></ul><br>  A autentica√ß√£o em nosso projeto n√£o usa o sistema de credenciais interno; para esses fins, √© usado o middleware AuthenticationMiddleware, desenvolvido de acordo com a nova estrutura do ASP.NET Core. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AuthenticationMiddleware</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly RequestDelegate _next; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AuthenticationMiddleware</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IAuthenticationSchemeProvider schemes, RequestDelegate next)</span></span></span><span class="hljs-function"> </span></span>{ Schemes = schemes ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(nameof(schemes)); _next = next ?? <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(nameof(next)); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IAuthenticationSchemeProvider Schemes { get; set; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> async Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpContext context)</span></span></span><span class="hljs-function"> </span></span>{ context.Features.Set&lt;IAuthenticationFeature&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationFeature { OriginalPath = context.Request.Path, OriginalPathBase = context.Request.PathBase }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> handlers = context.RequestServices.GetRequiredService&lt;IAuthenticationHandlerProvider&gt;(); foreach (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scheme in await Schemes.GetRequestHandlerSchemesAsync()) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (await handlers.GetHandlerAsync(context, scheme.Name) is IAuthenticationRequestHandler handler &amp;&amp; await handler.HandleRequestAsync()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ignored } } var defaultAuthenticate = await Schemes.GetDefaultAuthenticateSchemeAsync(); if (defaultAuthenticate != null) { var result = await context.AuthenticateAsync(defaultAuthenticate.Name); if (result?.Principal != null) { context.User = result.Principal; } } await _next(context); } }</span></span></code> </pre> <br>  O ASP.NET fornece muitos middlewares incorporados que voc√™ pode usar em seu aplicativo, mas observe que o desenvolvedor pode <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">criar seu pr√≥prio middleware</a> e adicion√°-lo ao pipeline de solicita√ß√£o HTTP.  Para simplificar esse mecanismo, adicionamos uma interface especial e agora basta criar uma classe que a implemente. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">INopStartup</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Add and configure any of the middleware /// &lt;/summary&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; /// &lt;param name="configuration"&gt;Configuration of the application&lt;/param&gt; void ConfigureServices(IServiceCollection services, IConfiguration configuration); /// &lt;summary&gt; /// Configure the using of added middleware /// &lt;/summary&gt; /// &lt;param name="application"&gt;Builder for configuring an application's request pipeline&lt;/param&gt; void Configure(IApplicationBuilder application); /// &lt;summary&gt; /// Gets order of this startup configuration implementation /// &lt;/summary&gt; int Order { get; } }</span></span></code> </pre> <br>  Aqui voc√™ pode adicionar e configurar seu middleware: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Represents object for the configuring authentication middleware on application startup /// &lt;/summary&gt; public class AuthenticationStartup : INopStartup { /// &lt;summary&gt; /// Add and configure any of the middleware /// &lt;/summary&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; /// &lt;param name="configuration"&gt;Configuration of the application&lt;/param&gt; public void ConfigureServices(IServiceCollection services, IConfiguration configuration) { //add data protection services.AddNopDataProtection(); //add authentication services.AddNopAuthentication(); } /// &lt;summary&gt; /// Configure the using of added middleware /// &lt;/summary&gt; /// &lt;param name="application"&gt;Builder for configuring an application's request pipeline&lt;/param&gt; public void Configure(IApplicationBuilder application) { //configure authentication application.UseNopAuthentication(); } /// &lt;summary&gt; /// Gets order of this startup configuration implementation /// &lt;/summary&gt; public int Order =&gt; 500; //authentication should be loaded before MVC }</span></span></code> </pre> <br><h3>  Etapa 7. Usando DI Integrado </h3><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A</a> inje√ß√£o de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">depend√™ncia</a> √© um dos principais recursos do processo de design do aplicativo no ASP.NET Core.  Ele permite que voc√™ crie aplicativos fracamente acoplados que sejam mais test√°veis, modulares e, como resultado, sustent√°veis.  Isso foi poss√≠vel seguindo o princ√≠pio da invers√£o de depend√™ncia.  Para instalar depend√™ncias, os cont√™ineres IoC (Inversion of Control) s√£o usados.  No ASP.NET Core, esse cont√™iner √© representado pela interface IServiceProvider.  Os servi√ßos s√£o instalados no aplicativo no m√©todo <code>Startup.ConfigureServices()</code> . <br><br>  Qualquer servi√ßo registrado pode ser configurado com tr√™s escopos: <br><br><ul><li>  transit√≥rio </li><li>  escopo </li><li>  singleton </li></ul><br><pre> <code class="java hljs">services.AddDbContext&lt;ApplicationDbContext&gt;(options =&gt; options.UseSqlServer(Configuration.GetConnectionString(<span class="hljs-string"><span class="hljs-string">"DefaultConnection"</span></span>))); services.AddSingleton&lt;Isingleton,MySingleton&gt;();</code> </pre> <br><h3>  Etapa 8. Usando conchas de compatibilidade do projeto WebAPI (cal√ßo) </h3><br>  Para simplificar a migra√ß√£o de uma implementa√ß√£o de API da Web existente, √© recomend√°vel usar o pacote <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Microsoft.AspNetCore.Mvc.WebApiCompatShim</a> NuGet.  As seguintes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">fun√ß√µes compat√≠veis s√£o</a> suportadas: <br><br><ul><li>  Adiciona o tipo ApiController </li><li>  Ativa a liga√ß√£o do modelo de estilo da API da web </li><li>  Estende a liga√ß√£o do modelo para que as a√ß√µes do controlador possam aceitar par√¢metros do tipo HttpRequestMessage. </li><li>  Adiciona formatadores de mensagens que permitem que as a√ß√µes retornem resultados do tipo HttpResponseMessage </li></ul><br><pre> <code class="java hljs">services.AddMvc().AddWebApiConventions(); routes.MapWebApiRoute(name: <span class="hljs-string"><span class="hljs-string">"DefaultApi"</span></span>, template: <span class="hljs-string"><span class="hljs-string">"api/{controller}/{id?}"</span></span> );</code> </pre> <br><h3>  Etapa 9. Transferir a configura√ß√£o do aplicativo </h3><br>  Anteriormente, algumas configura√ß√µes eram salvas no arquivo web.config.  Agora estamos adotando uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">nova abordagem</a> baseada em pares de valores-chave estabelecidos <i>pelos provedores de configura√ß√£o</i> .  Esse √© o mecanismo recomendado no ASP.NET Core e usamos o arquivo appsettings.json. <br><br>  Voc√™ tamb√©m pode usar o pacote NuGet <code>System.Configuration.ConfigurationManager</code> se, por algum motivo, quiser continuar usando * .config.  Nesse caso, voc√™ ter√° que abandonar a capacidade de executar o aplicativo nas plataformas Unix e execut√°-lo apenas no IIS. <br><br>  Se voc√™ deseja usar o provedor de configura√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Azure Key Vault</a> , consulte o conte√∫do da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Migra√ß√£o de</a> conte√∫do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">para o Azure Key Valut</a> .  Em nosso projeto, essa n√£o era a tarefa. <br><br><h3>  Etapa 10. Transferindo conte√∫do est√°tico para wwwroot </h3><br>  Para veicular <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">conte√∫do est√°tico,</a> voc√™ deve informar ao host a raiz do conte√∫do do diret√≥rio atual.  O padr√£o √© wwwroot.  Voc√™ pode personalizar seu diret√≥rio para armazenar arquivos est√°ticos, configurando o middleware. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/b7/z1/s7/b7z1s7pkzbd2yrkqukxcfholuus.png"></div><br><br><h3>  Etapa 11. Portando o EntityFramework para o EF Core </h3><br>  Se o projeto usa alguns <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">recursos</a> espec√≠ficos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">do Entity Framework 6</a> que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">n√£o</a> s√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">suportados</a> no <code>EF Core</code> , faz sentido executar o aplicativo no <code>NET Framework</code> .  Nesse caso, no entanto, voc√™ precisa sacrificar a multiplataforma.  O aplicativo funcionar√° apenas no Windows e no IIS. <br><br>  <b>Vamos dar uma olhada nas principais altera√ß√µes a serem levadas em considera√ß√£o:</b> <br><br><ul><li>  Namespace System.Data.Entity substitu√≠do por Microsoft.EntityFrameworkCore </li><li>  A assinatura do construtor DbContext foi alterada.  Agora voc√™ precisa injetar DbContextOptions </li><li>  M√©todo HasDatabaseGeneratedOption (DatabaseGeneratedOption.None) substitu√≠do por ValueGeneratedNever () </li><li>  M√©todo WillCascadeOnDelete (false) substitu√≠do por OnDelete (DeleteBehavior.Restrict) </li><li>  M√©todo OnModelCreating (DbModelBuilder modelBuilder) substitu√≠do por OnModelCreating (ModelBuilder modelBuilder) </li><li>  O m√©todo HasOptional n√£o est√° mais dispon√≠vel </li><li>  a configura√ß√£o dos objetos foi alterada, agora voc√™ precisa usar OnModelCreating, porque  EntityTypeConfiguration n√£o est√° mais dispon√≠vel </li><li>  O atributo ComplexType n√£o est√° mais dispon√≠vel </li><li>  Substitui√ß√µes da interface IDbSet com DbSet </li><li>  ComplexType - o suporte a tipos complexos apareceu no EF Core 2 com o tipo de Entidade Pr√≥pria ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://docs.microsoft.com/en-us/ef/core/modeling/owned-entities</a> ) e tabelas sem uma Chave Prim√°ria com QueryType no EF Core 2.1 ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://docs.microsoft.com/en-us/ef/core/modeling/query-types</a> ) </li><li>  chaves estrangeiras no EF Core geram <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">propriedades de sombra</a> usando o padr√£o de ID [Entity], diferente do EF6, que usa o padr√£o [Entity] _Id.  Portanto, primeiro adicione chaves estrangeiras como uma propriedade regular √† entidade. </li><li>  Para oferecer suporte ao DI para DbContext, configure seu DbContex em <code>ConfigureServices</code> </li></ul><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Register base object context /// &lt;/summary&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; public static void AddNopObjectContext(this IServiceCollection services) { services.AddDbContextPool&lt;NopObjectContext&gt;(optionsBuilder =&gt; { optionsBuilder.UseSqlServerWithLazyLoading(services); }); } /// &lt;summary&gt; /// SQL Server specific extension method for Microsoft.EntityFrameworkCore.DbContextOptionsBuilder /// &lt;/summary&gt; /// &lt;param name="optionsBuilder"&gt;Database context options builder&lt;/param&gt; /// &lt;param name="services"&gt;Collection of service descriptors&lt;/param&gt; public static void UseSqlServerWithLazyLoading(this DbContextOptionsBuilder optionsBuilder, IServiceCollection services) { var nopConfig = services.BuildServiceProvider().GetRequiredService&lt;NopConfig&gt;(); var dataSettings = DataSettingsManager.LoadSettings(); if (!dataSettings?.IsValid ?? true) return; var dbContextOptionsBuilder = optionsBuilder.UseLazyLoadingProxies(); if (nopConfig.UseRowNumberForPaging) dbContextOptionsBuilder.UseSqlServer(dataSettings.DataConnectionString, option =&gt; option.UseRowNumberForPaging()); else dbContextOptionsBuilder.UseSqlServer(dataSettings.DataConnectionString); }</span></span></code> </pre><br>  Use a ferramenta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Comparar SQL</a> para verificar se o <code>EF Core</code> gera um esquema de banco de dados semelhante ao <code>Entity Framework</code> durante a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">migra√ß√£o</a> . <br><br><h3>  Etapa 12. Removendo todas as refer√™ncias HttpContext, substituindo classes obsoletas e alterando o espa√ßo para nome </h3><br>  Durante a migra√ß√£o do seu projeto, voc√™ descobrir√° que um n√∫mero suficientemente grande de classes foi renomeado ou movido e agora √© necess√°rio alinhar tudo com os novos requisitos.  Aqui est√° uma lista das principais transi√ß√µes que voc√™ pode encontrar: <br><br><ul><li>  HttpPostedFileBase -&gt; IFormFile </li><li>  O acesso para acessar o HttpContext agora √© atrav√©s do IHttpContextAccessor </li><li>  HtmlHelper -&gt; IHtmlHelper </li><li>  ActionResult -&gt; IActionResult </li><li>  HttpUtility -&gt; WebUtility </li><li>  Em vez de HttpSessionStateBase - ISession, √© acess√≠vel a partir HttpContext.Session.  de Microsoft.AspNetCore.Http </li><li>  Request.Cookies retorna IRequestCookieCollection: IEnumerable &lt;KeyValuePair &lt;string, string &gt;&gt;, portanto, em vez de HttpCookie, KeyValuePair &lt;string, string&gt; de Microsoft.AspNetCore.Http </li></ul><br>  Substitui√ß√£o de namespace: <br><br><ul><li>  SelectList -&gt; Microsoft.AspNetCore.Mvc.Rendering </li><li>  UrlHelper -&gt; WebUtitlity </li><li>  MimeMapping -&gt; FileExtensionContentTypeProvider </li><li>  MvcHtmlString -&gt; IHtmlString e HtmlString </li><li>  ModelState, ModelStateDictionary, ModelError -&gt; Microsoft.AspNetCore.Mvc.ModelBinding </li><li>  FormCollection -&gt; IFormCollection </li><li>  Request.Url.Scheme -&gt; this.Url.ActionContext.HttpContext.Request.Scheme </li></ul><br>  Outro: <br><br><ul><li>  MvcHtmlString.IsNullOrEmpty (IHtmlString) -&gt; String.IsNullOrEmpty (variable.ToHtmlString ()) </li><li>  [ValidateInput (false)] - geralmente n√£o existe mais e n√£o √© necess√°rio </li><li>  HttpUnauthorizedResult -&gt; UnauthorizedResult </li><li>  [AllowHtml] - n√£o h√° mais diretiva e n√£o √© necess√°rio </li><li>  M√©todo TagBuilder.SetInnerText substitu√≠do - agora √© InnerHtml.AppendHtml </li><li>  JsonRequestBehavior.AllowGet ao retornar Json n√£o √© mais necess√°rio </li><li>  HttpUtility.JavaScriptStringEncode.  -&gt; JavaScriptEncoder.Default.Encode </li><li>  Request.RawUrl.  √â necess√°rio conectar separadamente Request.Path + Request.QueryString </li><li>  AllowHtmlAttribute - n√£o h√° mais classe </li><li>  XmlDownloadResult - agora voc√™ pode usar apenas retornar File (Encoding.UTF8.GetBytes (xml), "application / xml", "filename.xml"); </li><li>  [ValidateInput (false)] - n√£o h√° mais diretiva e n√£o √© necess√°rio </li></ul><br><h3>  Etapa 13. Atualizando autentica√ß√£o e autoriza√ß√£o </h3><br>  Eu j√° escrevi acima que em nosso projeto a autentica√ß√£o n√£o √© implementada usando o sistema de identidade interno, mas √© removida em uma camada separada de middleware.  No entanto, o ASP.NET Core possui seu pr√≥prio mecanismo para fornecer credenciais.  Mais detalhes podem ser encontrados na documenta√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Quanto √† prote√ß√£o de dados - n√£o usamos mais o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">MachineKey</a> .  Em vez disso, usamos o recurso interno de prote√ß√£o de dados.  Por padr√£o, as chaves s√£o geradas quando o aplicativo √© iniciado.  O armaz√©m de dados pode ser: <br><br><ul><li>  Sistema de arquivos - keystore baseado em sistema de arquivos </li><li>  Armazenamento do Azure - chaves de prote√ß√£o de dados no Armazenamento de Blob do Azure </li><li>  Redis - chaves de prote√ß√£o de dados no cache Redis </li><li>  Registro - deve ser usado se o aplicativo n√£o tiver acesso ao sistema de arquivos </li><li>  EF Core - chaves s√£o armazenadas no banco de dados </li></ul><br>  Se os mecanismos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">internos</a> n√£o forem adequados, voc√™ poder√° especificar seu pr√≥prio mecanismo de armazenamento de chaves fornecendo um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">IXmlRepository</a> personalizado. <br><br><h3>  Etapa 14. Atualizando JS / CSS </h3><br>  A maneira de trabalhar com recursos est√°ticos mudou: agora todos eles devem ser armazenados na pasta raiz do projeto <i>wwwroot</i> , a menos que, √© claro, outras configura√ß√µes sejam especificadas. <br><br>  Ao usar blocos embutidos javascript, √© recomend√°vel mov√™-los para o final da p√°gina.  Basta usar o atributo asp-location = "Footer" para suas tags.  A mesma regra se aplica aos arquivos js. <br><br>  Use a extens√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">BundlerMinifier</a> como um substituto para System.Web.Optimization - isso permitir√° vincular e minimizar JavaScript e CSS ao criar o projeto.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link</a> para a documenta√ß√£o. <br><br><h3>  Etapa 15. Migrando visualiza√ß√µes </h3><br>  A√ß√µes filho n√£o s√£o mais usadas.  Em vez disso, o ASP.NET Core oferece uma nova ferramenta poderosa - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ViewComponents</a> , chamada de forma ass√≠ncrona. <br><br>  Como obter uma string do ViewComponent: <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">/// &lt;summary&gt; /// Render component to string /// &lt;/summary&gt; /// &lt;param name="componentName"&gt;Component name&lt;/param&gt; /// &lt;param name="arguments"&gt;Arguments&lt;/param&gt; /// &lt;returns&gt;Result&lt;/returns&gt; protected virtual string RenderViewComponentToString(string componentName, object arguments = null) { if (string.IsNullOrEmpty(componentName)) throw new ArgumentNullException(nameof(componentName)); var actionContextAccessor = HttpContext.RequestServices.GetService(typeof(IActionContextAccessor)) as IActionContextAccessor; if (actionContextAccessor == null) throw new Exception("IActionContextAccessor cannot be resolved"); var context = actionContextAccessor.ActionContext; var viewComponentResult = ViewComponent(componentName, arguments); var viewData = ViewData; if (viewData == null) { throw new NotImplementedException(); } var tempData = TempData; if (tempData == null) { throw new NotImplementedException(); } using (var writer = new StringWriter()) { var viewContext = new ViewContext( context, NullView.Instance, viewData, tempData, writer, new HtmlHelperOptions()); // IViewComponentHelper is stateful, we want to make sure to retrieve it every time we need it. var viewComponentHelper = context.HttpContext.RequestServices.GetRequiredService&lt;IViewComponentHelper&gt;(); (viewComponentHelper as IViewContextAware)?.Contextualize(viewContext); var result = viewComponentResult.ViewComponentType == null ? viewComponentHelper.InvokeAsync(viewComponentResult.ViewComponentName, viewComponentResult.Arguments): viewComponentHelper.InvokeAsync(viewComponentResult.ViewComponentType, viewComponentResult.Arguments); result.Result.WriteTo(writer, HtmlEncoder.Default); return writer.ToString(); } }</span></span></code> </pre> <br>  N√£o √© mais necess√°rio usar o HtmlHelper - o ASP.NET Core possui um grande n√∫mero de fun√ß√µes de tag auxiliar ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tag Helpers</a> ) incorporadas.  Quando o aplicativo est√° em execu√ß√£o, eles s√£o processados ‚Äã‚Äãpelo mecanismo Razor no lado do servidor e, finalmente, s√£o convertidos em elementos html padr√£o.  Isso simplifica bastante o desenvolvimento de aplicativos.  E, √© claro, voc√™ pode implementar seus pr√≥prios auxiliares de tags. <br><br>  Come√ßamos a usar inje√ß√£o de depend√™ncia nas visualiza√ß√µes em vez de permitir configura√ß√µes e servi√ßos usando o <code>EngineContext</code> . <br><br>  Portanto, os principais pontos sobre a migra√ß√£o de visualiza√ß√µes: <br><br><ul><li>  Converter <code>Views/web.config  Views/_ViewImports.cshtml</code> - usado para importar namespaces e <code>Views/web.config  Views/_ViewImports.cshtml</code> depend√™ncias.  Este arquivo n√£o suporta outras fun√ß√µes do <code>Razor</code> , como defini√ß√µes de fun√ß√£o e se√ß√£o. </li><li>  Converter <code>namespaces.add</code> em <code>@using</code> </li><li>  Transferir quaisquer configura√ß√µes para a configura√ß√£o principal do aplicativo </li><li>  <code>Scripts.Render</code> e <code>Styles.Render</code> n√£o existe.  Substitua <code>libman</code> ou <code>BundlerMinifier</code> links para sa√≠da </li></ul><br><h2>  Em conclus√£o </h2><br>  Vimos pela nossa experi√™ncia que o processo de migra√ß√£o de um aplicativo Web grande √© uma tarefa que consome muito tempo e que dificilmente pode ser realizada sem armadilhas.  Planejamos mudar para uma nova estrutura assim que sua primeira vers√£o est√°vel foi lan√ßada, mas n√£o conseguimos finaliz√°-la imediatamente: havia algumas fun√ß√µes cr√≠ticas que ainda n√£o haviam sido transferidas para o .NET Core, em particular relacionadas ao EntityFramework.  Portanto, tivemos que lan√ßar o pr√≥ximo lan√ßamento usando uma abordagem mista - a arquitetura do .NET Core com as depend√™ncias do .NET Framework. <br><br>  Conseguimos adaptar completamente o projeto ap√≥s o lan√ßamento do .NET Core 2.1, tendo na √©poca uma solu√ß√£o est√°vel j√° trabalhando na nova arquitetura - tudo o que restava era substituir alguns pacotes e reescrever o trabalho com o EF Core.  Assim, a migra√ß√£o completa para a nova estrutura levou v√°rios meses de trabalho. <br><br>  Voc√™ pode aprender mais sobre o nosso projeto em nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">reposit√≥rio no GitHub</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt472738/">https://habr.com/ru/post/pt472738/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt472720/index.html">ERP n√£o funciona ... Qual √© a alternativa? ou na hora certa. Para a R√∫ssia?</a></li>
<li><a href="../pt472724/index.html">Introdu√ß√£o ao skydive.network</a></li>
<li><a href="../pt472726/index.html">Melhoria da imunidade ao ru√≠do do Arduino</a></li>
<li><a href="../pt472730/index.html">Ivanovo! Mitap em homenagem ao 10¬∫ anivers√°rio do Node.js</a></li>
<li><a href="../pt472736/index.html">Semin√°rio on-line aberto "Introdu√ß√£o √† automa√ß√£o de teste de aplicativos m√≥veis no Selenium e Appium"</a></li>
<li><a href="../pt472744/index.html">O MRP n√£o funciona ... Qual √© a alternativa?</a></li>
<li><a href="../pt472746/index.html">Servidor de terminal para administrador; Nem uma √∫nica lacuna SSH</a></li>
<li><a href="../pt472748/index.html">Navegador sem√¢ntico ou vida sem sites</a></li>
<li><a href="../pt472750/index.html">OK, eu realmente preciso do Kubernetes?</a></li>
<li><a href="../pt472752/index.html">CSE: Kubernetes para qualquer pessoa no vCloud</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>