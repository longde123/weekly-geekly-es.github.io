<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëó üéê üé∏ Outra biblioteca simulada üï¥üèΩ ‚ÑπÔ∏è üë®‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Boa tarde Estou envolvido na automa√ß√£o de testes. Como todos os engenheiros de automa√ß√£o, tenho um conjunto de bibliotecas e ferramentas que geralment...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Outra biblioteca simulada</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476904/"><p> Boa tarde  Estou envolvido na automa√ß√£o de testes.  Como todos os engenheiros de automa√ß√£o, tenho um conjunto de bibliotecas e ferramentas que geralmente escolho para escrever testes.  Periodicamente, por√©m, h√° situa√ß√µes em que nenhuma das bibliotecas familiares pode resolver o problema com o risco de tornar os autotestes inst√°veis ‚Äã‚Äãou fr√°geis.  Neste artigo, gostaria de dizer como a tarefa aparentemente padr√£o de usar zombarias me levou a escrever meu m√≥dulo.  Eu tamb√©m gostaria de compartilhar minha decis√£o e ouvir coment√°rios. </p><a name="habracut"></a><br><h1>  App </h1><br><p>  Um dos setores necess√°rios no setor financeiro √© a auditoria.  Os dados precisam ser verificados regularmente (reconcilia√ß√£o).  Nesse sentido, o aplicativo que eu testei apareceu.  Para n√£o falar sobre algo abstrato, vamos imaginar que nossa equipe esteja desenvolvendo um aplicativo para processar aplicativos de mensageiros instant√¢neos.  Para cada aplicativo, um evento apropriado deve ser criado na elasticsearch.  O aplicativo de verifica√ß√£o ser√° nosso monitoramento de que os aplicativos n√£o s√£o ignorados. </p><br><p>  Ent√£o, imagine que temos um sistema que possui os seguintes componentes: </p><br><ol><li>  Servidor de configura√ß√£o  Para o usu√°rio, este √© um √∫nico ponto de entrada em que ele configura n√£o apenas o aplicativo para verifica√ß√£o, mas tamb√©m outros componentes do sistema. </li><li>  Aplicativo de verifica√ß√£o. </li><li>  Dados dos aplicativos de processamento de aplicativos armazenados na elasticsearch. </li><li>  Dados de refer√™ncia.  O formato dos dados depende do messenger com o qual o aplicativo est√° integrado. </li></ol><br><h1>  Desafio </h1><br><p>  A automa√ß√£o de teste, neste caso, parece bastante direta: </p><br><ol><li>  Prepara√ß√£o do ambiente: <br><ul><li>  O Elasticsearch √© instalado com configura√ß√£o m√≠nima (usando o msi e a linha de comando). </li><li>  Um aplicativo de verifica√ß√£o est√° instalado. </li></ul></li><li>  Execu√ß√£o de teste: <br><ul><li>  Um aplicativo de verifica√ß√£o est√° configurado. </li><li>  O Elasticsearch √© preenchido com dados de teste para o teste correspondente (quantos aplicativos foram processados). </li><li>  O aplicativo recebe dados de "refer√™ncia" do messenger (quantos aplicativos supostamente eram realmente). </li><li>  O veredicto emitido pelo aplicativo √© verificado: o n√∫mero de aplicativos verificados com sucesso, o n√∫mero de aplicativos ausentes etc. </li></ul></li><li>  Limpando o meio ambiente. </li></ol><br><p>  O problema √© que estamos testando o monitoramento, mas para configur√°-lo, precisamos de dados do servidor de configura√ß√£o.  Em primeiro lugar, instalar e configurar um servidor para cada execu√ß√£o √© uma opera√ß√£o demorada (possui sua pr√≥pria base, por exemplo).  Em segundo lugar, quero isolar aplicativos para simplificar a localiza√ß√£o de problemas ao encontrar um defeito.  No final, foi decidido usar o mock. </p><br><p>  Aqui pode surgir a pergunta: "Se ainda simularmos o servidor, talvez n√£o possamos gastar tempo instalando e preenchendo a pesquisa el√°stica, mas substitu√≠-la por uma simula√ß√£o?".  Ainda assim, voc√™ sempre precisa lembrar que o uso de simula√ß√£o fornece flexibilidade, mas acrescenta uma obriga√ß√£o de monitorar a relev√¢ncia do comportamento da simula√ß√£o.  Portanto, recusei-me a substituir o elasticsearch: √© bastante simples de instalar e preencher. </p><br><h1>  Primeiro mock </h1><br><p> O servidor envia a configura√ß√£o para solicita√ß√µes GET de v√°rias maneiras em / configuration.  Estamos interessados ‚Äã‚Äãem duas maneiras.  O primeiro √© <code>/configuration/data_cluster</code> com configura√ß√£o de cluster </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } }</code> </pre> <br><p>  O segundo √© <code>/configuration/reconciliation</code> com a configura√ß√£o do aplicativo de perfura√ß√£o </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-attr"><span class="hljs-attr">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"credentials"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span> } } }</code> </pre> <br><p>  A dificuldade √© que voc√™ precisa alterar a resposta do servidor durante o teste ou entre testes para testar como o aplicativo reage a altera√ß√µes na configura√ß√£o, senhas incorretas etc. </p><br><p>  Portanto, zombarias est√°ticas e ferramentas para zombarias em testes de unidade (simula√ß√£o, monkeypatch do pytest etc.) n√£o funcionar√£o para n√≥s.  Encontrei uma √≥tima biblioteca de <code>pretenders</code> que achava certa para mim.  <a href="https://pretenders.readthedocs.io/en/latest/" title="Leia a documenta√ß√£o do Pretenders">Pretenders</a> fornece a capacidade de criar um servidor HTTP com regras que determinam como o servidor responder√° √†s solicita√ß√µes.  As regras s√£o armazenadas em predefini√ß√µes, o que permite isolar simula√ß√µes para diferentes su√≠tes de teste.  As predefini√ß√µes podem ser limpas e preenchidas novamente, permitindo que voc√™ atualize as respostas conforme necess√°rio.  Basta elevar o pr√≥prio servidor uma vez durante a prepara√ß√£o do ambiente: </p><br><pre> <code class="bash hljs">python -m pretenders.server.server --host 127.0.0.1 --port 8000</code> </pre> <br><p>  E nos testes, precisamos adicionar o uso do cliente.  No caso mais simples, quando as respostas s√£o completamente codificadas nos testes, pode ser assim: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPMock <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> pretenders.common.constants <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FOREVER @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> mock = HTTPMock(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">8000</span></span>, name=<span class="hljs-string"><span class="hljs-string">"server"</span></span>) request.addfinalizer(mock.reset) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/data_cluster"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) configuration_server_mock.when(<span class="hljs-string"><span class="hljs-string">"GET /configuration/reconciliation"</span></span>).reply( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, body=json.dumps({ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///c:/path"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, }), status=<span class="hljs-number"><span class="hljs-number">200</span></span>, times=FOREVER, ) <span class="hljs-comment"><span class="hljs-comment"># test application</span></span></code> </pre> <br><p>  Mas isso n√£o √© tudo.  Com sua flexibilidade, os <code>pretenders</code> t√™m duas limita√ß√µes que devem ser lembradas e devem ser tratadas em nosso caso: </p><br><ol><li>  As regras n√£o podem ser exclu√≠das uma de cada vez.  Para alterar a resposta, voc√™ deve excluir toda a predefini√ß√£o e recriar todas as regras novamente. </li><li>  Todos os caminhos usados ‚Äã‚Äãnas regras s√£o relativos.  As predefini√ß√µes t√™m um caminho exclusivo no formato / mockhttp / &lt;preset_name&gt;, e esse caminho √© um prefixo comum para todos os caminhos criados nas regras.  O aplicativo em teste recebe apenas o nome do host e n√£o pode saber sobre o prefixo. </li></ol><br><p>  A primeira limita√ß√£o √© muito desagrad√°vel, mas pode ser resolvida escrevendo um m√≥dulo que encapsula o trabalho com a configura√ß√£o.  Por exemplo, ent√£o </p><br><pre> <code class="python hljs">configuration.data_cluster.port = <span class="hljs-number"><span class="hljs-number">443</span></span></code> </pre> <br><p>  ou (para fazer solicita√ß√µes de atualiza√ß√£o com menos frequ√™ncia) </p><br><pre> <code class="python hljs">data_cluster_config = get_default_data_cluster_config() data_cluster_config.port = <span class="hljs-number"><span class="hljs-number">443</span></span> configuration.update_data_cluster(data_cluster_config)</code> </pre> <br><p>  Esse encapsulamento nos permite atualizar todos os caminhos quase sem dor.  Voc√™ tamb√©m pode criar uma predefini√ß√£o individual para cada terminal individual e uma predefini√ß√£o geral (principal), redirecionando (at√© 307 ou 308) para as individuais.  Em seguida, voc√™ pode limpar apenas uma predefini√ß√£o para atualizar a regra. </p><br><p>  Para se livrar dos prefixos, voc√™ pode usar a biblioteca <a href="https://mitmproxy.org/" title="Ir para o site mitmproxy">mitmproxy</a> .  Essa √© uma ferramenta poderosa que permite, entre outras coisas, redirecionar solicita√ß√µes.  Removeremos os prefixos da seguinte maneira: </p><br><pre> <code class="bash hljs">mitmdump --mode reverse:http://127.0.0.1:8000 --replacements :~http:^/:/mockhttp/server/ --listen-host 127.0.01 --listen-port 80</code> </pre> <br><p>  Os par√¢metros deste comando fazem o seguinte: </p><br><ol><li>  <code>--listen-host 127.0.0.1</code> e <code>--listen-port 80</code> √≥bvias.  O Mitmproxy eleva seu servidor e, com esses par√¢metros, determinamos a interface e a porta que esse servidor escutar√°. </li><li>  <code>--mode reverse:http://127.0.0.1:8000</code> significa que as solicita√ß√µes ao servidor mitproxy ser√£o redirecionadas para <code>http://127.0.0.1:8000</code> .  Leia mais <a href="https://docs.mitmproxy.org/stable/concepts-modes/" title="Documenta√ß√£o de v√°rios modos">aqui</a> . </li><li>  <code>--replacements :~http:^/:/mockhttp/server/</code> define um modelo pelo qual as solicita√ß√µes ser√£o alteradas.  Ele consiste em tr√™s partes: um filtro de solicita√ß√£o ( <code>~http</code> para solicita√ß√µes HTTP), um modelo para alterar ( <code>^/</code> para substituir o in√≠cio do caminho) e realmente substituir ( <code>/mockhttp/server</code> ).  Leia mais <a href="https://docs.mitmproxy.org/stable/overview-features/" title="Documenta√ß√£o de funcionalidade">aqui</a> . </li></ol><br><p>  No nosso caso, adicionamos <code>mockhttp/server</code> a todas as solicita√ß√µes HTTP e as redirecionamos para <code>http://127.0.0.1:8000</code> , ou seja,  para os nossos pretendentes servidor.  Como resultado, conseguimos que agora a configura√ß√£o possa ser obtida com uma solicita√ß√£o GET para <code>http://127.0.0.1/configuration/data_cluster</code> . </p><br><p>  Em geral, fiquei satisfeito com o design com <code>pretenders</code> e <code>mitmproxy</code> .  Com a aparente complexidade - afinal, 2 servidores em vez de um real - a prepara√ß√£o consiste em instalar 2 pacotes e executar 2 comandos na linha de comando para inici√°-los.  Nem tudo √© t√£o simples no gerenciamento de uma simula√ß√£o, mas toda a complexidade est√° em apenas um lugar (gerenciamento de predefini√ß√µes) e √© resolvida de maneira simples e confi√°vel.  No entanto, novas circunst√¢ncias surgiram no problema que me fez pensar em uma nova solu√ß√£o. </p><br><h1>  Segunda simula√ß√£o </h1><br><p>  At√© aquele momento, eu quase n√£o disse de onde vinham os dados de refer√™ncia.  Um leitor atento pode perceber que, no exemplo acima, o caminho para o sistema de arquivos √© usado como o endere√ßo da fonte de dados.  E realmente funciona algo assim, mas apenas para um dos fornecedores.  Outro fornecedor fornece uma API para o recebimento de aplicativos e foi com ele que surgiu um problema.  √â dif√≠cil elevar a API do fornecedor durante os testes, ent√£o planejei substitu√≠-la por simula√ß√£o de acordo com o mesmo esquema de antes.  Mas, para receber solicita√ß√µes, uma solicita√ß√£o do formul√°rio </p><br><pre> <code class="plaintext hljs">GET /application-history?page=2&amp;size=5&amp;start=1569148012&amp;end=1569148446</code> </pre> <br><p>  Existem 2 pontos aqui.  Em primeiro lugar, algumas op√ß√µes.  O fato √© que os par√¢metros podem ser especificados em qualquer ordem, o que complica bastante a express√£o regular da regra dos <code>pretenders</code> .  Tamb√©m √© necess√°rio lembrar que os par√¢metros s√£o opcionais, mas isso n√£o √© um problema como ordem aleat√≥ria.  Em segundo lugar, os √∫ltimos par√¢metros (in√≠cio e fim) especificam o intervalo de tempo para filtrar a ordem.  E o problema nesse caso √© que n√£o podemos prever com anteced√™ncia qual intervalo (n√£o a magnitude, mas a hora de in√≠cio) ser√° usado pelo aplicativo para formar a resposta simulada.  Simplificando, precisamos conhecer e usar os valores dos par√¢metros para formar uma resposta "razo√°vel".  A ‚Äúrazoabilidade‚Äù neste caso √© importante, por exemplo, para que possamos testar se o aplicativo percorre todas as p√°ginas da pagina√ß√£o: se respondermos a todos os pedidos da mesma maneira, n√£o conseguiremos encontrar defeitos devido ao fato de que apenas uma p√°gina em cada cinco √© solicitada . </p><br><p>  Tentei procurar solu√ß√µes alternativas, mas no final decidi tentar escrever as minhas.  Portanto, havia um <a href="https://github.com/KillAChicken/loose-server" title="V√° para o reposit√≥rio e a documenta√ß√£o">servidor solto</a> .  Este √© um aplicativo <a href="https://palletsprojects.com/p/flask/" title="V√° para a p√°gina do projeto">Flask</a> no qual os caminhos e as respostas podem ser configurados ap√≥s o in√≠cio.  Fora da caixa, ele sabe como trabalhar com regras para o tipo de solicita√ß√£o (GET, POST etc.) e para o caminho.  Isso permite substituir <code>pretenders</code> e <code>mitmproxy</code> na tarefa original.  Tamb√©m mostrarei como ele pode ser usado para criar uma simula√ß√£o para a API do fornecedor. </p><br><p>  Um aplicativo precisa de 2 caminhos principais: </p><br><ol><li>  Ponto final de base.  Este √© o mesmo prefixo que ser√° usado para todas as regras configuradas. </li><li>  Ponto de extremidade de configura√ß√£o.  Esse √© o prefixo daqueles pedidos com os quais voc√™ pode configurar o pr√≥prio servidor simulado. </li></ol><br><pre> <code class="bash hljs">python -m looseserver.default.server.run --host 127.0.0.1 --port 80 --base-endpoint / --configuration-endpoint /_mock_configuration/</code> </pre> <br><p>  Em geral, √© melhor n√£o configurar o ponto de extremidade base e o ponto de extremidade de configura√ß√£o para que um seja o pai do outro.  Caso contr√°rio, existe o risco de os caminhos de configura√ß√£o e teste entrarem em conflito.  O ponto de extremidade da configura√ß√£o ter√° preced√™ncia, pois as regras do Flask foram adicionadas para configura√ß√£o mais cedo do que para caminhos din√¢micos.  No nosso caso, poder√≠amos usar <code>--base-endpoint /configuration/</code> se n√£o formos incluir a API do fornecedor nesse mock. </p><br><p>  A vers√£o mais simples dos testes n√£o muda muito </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HTTPClient <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PathRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.response <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> FixedResponse @pytest.fixture <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configuration_server_mock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MockFactory</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self._client = HTTPClient(configuration_url=<span class="hljs-string"><span class="hljs-string">"http://127.0.0.1/_mock_configuration/"</span></span>) self._rule_ids = [] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, path, json_response)</span></span></span><span class="hljs-function">:</span></span> rule = self._client.create_rule(PathRule(path=path)) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>: <span class="hljs-string"><span class="hljs-string">"application/json"</span></span>}, status=<span class="hljs-number"><span class="hljs-number">200</span></span>, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_delete_rules</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> rule_id <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self._rule_ids: self._client.remove_rule(rule_id=rule_id) mock = MockFactory() request.addfinalizer(mock._delete_rules) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mock <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_something</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_server_mock)</span></span></span><span class="hljs-function">:</span></span> configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/data_cluster"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"host"</span></span>: <span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"port"</span></span>: <span class="hljs-number"><span class="hljs-number">443</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, } ) configuration_server_mock.create_rule( path=<span class="hljs-string"><span class="hljs-string">"configuration/reconciliation"</span></span>, json_response={ <span class="hljs-string"><span class="hljs-string">"reconciliation_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">3600</span></span>, <span class="hljs-string"><span class="hljs-string">"configuration_update_interval"</span></span>: <span class="hljs-number"><span class="hljs-number">60</span></span>, <span class="hljs-string"><span class="hljs-string">"source"</span></span>: { <span class="hljs-string"><span class="hljs-string">"address"</span></span>: <span class="hljs-string"><span class="hljs-string">"file:///applications"</span></span>, <span class="hljs-string"><span class="hljs-string">"credentials"</span></span>: { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"user"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: <span class="hljs-string"><span class="hljs-string">"pass"</span></span>, }, }, } )</code> </pre> <br><p>  O equipamento ficou mais dif√≠cil, mas agora as regras podem ser exclu√≠das uma de cada vez, o que simplifica o trabalho com elas.  O uso de <code>mitmproxy</code> n√£o <code>mitmproxy</code> mais necess√°rio. </p><br><p>  Vamos voltar √† API do fornecedor.  Criaremos um novo tipo de regras para um servidor solto que, dependendo do valor do par√¢metro, fornecer√° respostas diferentes.  Em seguida, usaremos essa regra para o par√¢metro da p√°gina. </p><br><p>  Novas regras e respostas precisam ser criadas para o servidor e o cliente.  Vamos come√ßar com o servidor: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ServerRule <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServerParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ServerRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> super(ServerParameterRule, self).__init__(rule_type=rule_type) self._parameter_name = parameter_name self._parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">is_match_found</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self._parameter_value <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self._parameter_name <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> request.args <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> request.args.get(self._parameter_name) == self._parameter_value</code> </pre> <br><p>  Cada regra deve definir um m√©todo <code>is_match_found</code> , que determina se deve funcionar para uma determinada solicita√ß√£o ou n√£o.  O par√¢metro de entrada para ele √© o objeto de solicita√ß√£o.  Ap√≥s a cria√ß√£o da nova regra, √© necess√°rio "ensinar" o servidor a aceit√°-la do cliente.  Para fazer isso, use <code>RuleFactory</code> : </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.server.application <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> configure_application <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_application</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(base_endpoint, configuration_endpoint)</span></span></span><span class="hljs-function">:</span></span> server_rule_factory = create_rule_factory(base_endpoint) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_parse_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule_type, parameters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServerParameterRule( rule_type=rule_type, parameter_name=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>], parameter_value=parameters[<span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>], ) server_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=_parse_param_rule, serializer=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, rule: <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configure_application( rule_factory=server_rule_factory, base_endpoint=base_endpoint, configuration_endpoint=configuration_endpoint, ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: application = _create_application(base_endpoint=<span class="hljs-string"><span class="hljs-string">"/"</span></span>, configuration_endpoint=<span class="hljs-string"><span class="hljs-string">"/_mock_configuration"</span></span>) application.run(host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>, port=<span class="hljs-number"><span class="hljs-number">80</span></span>)</code> </pre> <br><p>  Aqui, criamos uma f√°brica para as regras por padr√£o, para que ela contenha as regras que usamos antes e registramos um novo tipo.  Nesse caso, o cliente n√£o precisa das informa√ß√µes da regra; portanto, o <code>serializer</code> n√£o faz nada.  Al√©m disso, esta f√°brica √© transferida para a aplica√ß√£o.  E j√° pode ser executado como um aplicativo Flask comum. </p><br><p>  A situa√ß√£o com o cliente √© semelhante: criamos uma regra e uma f√°brica.  Mas para o cliente, em primeiro lugar, n√£o √© necess√°rio definir o m√©todo <code>is_match_found</code> e, em segundo lugar, o serializador nesse caso √© necess√°rio para enviar a regra ao servidor. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ClientRule <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> looseserver.default.client.rule <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> create_rule_factory <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClientParameterRule</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ClientRule)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parameter_name, parameter_value=None, rule_type=</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">"PARAMETER"</span></span></span></span><span class="hljs-function"><span class="hljs-params">, rule_id=None)</span></span></span><span class="hljs-function">:</span></span> super(ClientParameterRule, self).__init__(rule_type=rule_type, rule_id=rule_id) self.parameter_name = parameter_name self.parameter_value = parameter_value <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_create_client</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(configuration_url)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_serialize_param_rule</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(rule)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">"parameter_name"</span></span>: rule.parameter_name, <span class="hljs-string"><span class="hljs-string">"parameter_value"</span></span>: rule.parameter_value, } client_rule_factory = create_rule_factory() client_rule_factory.register_rule( rule_type=<span class="hljs-string"><span class="hljs-string">"PARAMETER"</span></span>, parser=<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> rule_type, parameters: ClientParameterRule(rule_type=rule_type, parameter_name=<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), serializer=_serialize_param_rule, ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HTTPClient(configuration_url=configuration_url, rule_factory=client_rule_factory)</code> </pre> <br><p>  Resta usar <code>_create_client</code> para criar o cliente, e as regras podem ser usadas em testes.  No exemplo abaixo, adicionei o uso de outra regra padr√£o: <code>CompositeRule</code> .  Ele permite combinar v√°rias regras em uma, para que funcionem apenas se cada uma retornar True para chamar <code>is_match_found</code> . </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.fixture def configuration_server_mock(request): class MockFactory: def __init__(self): self._client = _create_client("http://127.0.0.1/_mock_configuration/") self._rule_ids = [] def create_paged_rule(self, path, page, json_response): rule_prototype = CompositeRule( children=[ PathRule(path=path), ClientParameterRule(parameter_name="page", parameter_value=page), ] ) rule = self._client.create_rule(rule_prototype) self._rule_ids.append(rule.rule_id) response = FixedResponse( headers={"Content-Type": "application/json"}, status=200, body=json.dumps(json_response), ) self._client.set_response(rule_id=rule.rule_id, response=response) ... mock = MockFactory() request.addfinalizer(mock._delete_rules) return mock def test_something(configuration_server_mock): ... configuration_server_mock.create_paged_rule( path="application-history", page=None, json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="1", json_response=["1", "2", "3"], ) configuration_server_mock.create_paged_rule( path="application-history", page="2", json_response=["4", "5"], )</span></span></code> </pre> <br><h1>  Conclus√£o </h1><br><p>  Uma <code>mitmproxy</code> <code>pretenders</code> e <code>mitmproxy</code> fornece uma ferramenta poderosa e flex√≠vel o suficiente para criar zombarias.  Suas vantagens: </p><br><ol><li>  Configura√ß√£o f√°cil. </li><li>  Capacidade de isolar conjuntos de consultas usando predefini√ß√µes. </li><li>  Exclui um conjunto isolado inteiro de uma s√≥ vez. </li></ol><br><p>  Por contras incluem: </p><br><ol><li>  A necessidade de criar express√µes regulares para regras. </li><li>  A incapacidade de alterar as regras individualmente. </li><li>  A presen√ßa de um prefixo para todos os caminhos criados ou o uso de redirecionamento usando <code>mitmproxy</code> . </li></ol><br><p>  Links para documenta√ß√£o: <br>  <a href="https://pretenders.readthedocs.io/en/latest/">Pretenders</a> <br>  <a href="https://docs.mitmproxy.org/stable/">Mitmproxy</a> <br>  <a href="https://github.com/KillAChicken/loose-server/wiki">Servidor solto</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt476904/">https://habr.com/ru/post/pt476904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt476880/index.html">Ber√ßos de seguran√ßa: CSRF</a></li>
<li><a href="../pt476888/index.html">Quais tend√™ncias de design de UX seguir√£o em 2020</a></li>
<li><a href="../pt476890/index.html">Para quem trabalha na Houdini. Sobre os cursos Nature of Vex e Bites of Python</a></li>
<li><a href="../pt476900/index.html">Dispositivo aut√¥nomo no arduino, sinalizando um aumento (diminui√ß√£o) de temperatura</a></li>
<li><a href="../pt476902/index.html">Barrymore, o que h√° em torno do Voximplant? Soquetes da Web implementados, senhor</a></li>
<li><a href="../pt476906/index.html">Novidades do SOLIDWORKS 2020</a></li>
<li><a href="../pt476908/index.html">O Hadoop est√° morto? Parte 2</a></li>
<li><a href="../pt476910/index.html">Antiguidades: uma escolha dif√≠cil de placa de som para jogos do DOS</a></li>
<li><a href="../pt476912/index.html">Direitos da empresa para programadores</a></li>
<li><a href="../pt476914/index.html">Instalar o m√≥dulo Powershell a partir do reposit√≥rio Github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>