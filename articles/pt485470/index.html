<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ˜ â“ ğŸ˜§ HighLoad ++, Andrey Gushchin (Zabbix): alto desempenho e particionamento nativo ğŸ‘¨ğŸ¾â€ğŸ³ ğŸ‘ƒğŸ½ ğŸ’…ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Veremos como o Zabbix funciona com o banco de dados TimescaleDB como um back-end. Mostramos como comeÃ§ar do zero e como migrar com o PostgreSQL. TambÃ©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Andrey Gushchin (Zabbix): alto desempenho e particionamento nativo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/485470/">  Veremos como o Zabbix funciona com o banco de dados TimescaleDB como um back-end.  Mostramos como comeÃ§ar do zero e como migrar com o PostgreSQL.  TambÃ©m fornecemos testes de desempenho comparativos das duas configuraÃ§Ãµes. <br><br><img src="https://habrastorage.org/webt/h4/jl/nw/h4jlnwupm_dewx7jasafurn-ibm.jpeg"><br><br>  HighLoad ++ Siberia 2019. Tomsk Hall.  24 de junho, 16:00.  Resumos e <a href="https://www.highload.ru/siberia/2019/abstracts/5390">apresentaÃ§Ã£o</a> .  A prÃ³xima conferÃªncia HighLoad ++ serÃ¡ realizada nos dias 6 e 7 de abril de 2020 em SÃ£o Petersburgo.  Detalhes e ingressos <a href="http://bit.ly/2sSxgBx">aqui</a> . <br><br>  <b>Andrey Gushchin (doravante</b> denominado <b>AG):</b> - Sou engenheiro de suporte tÃ©cnico da ZABBIX (doravante denominado Zabbix), um treinador.  Trabalho com suporte tÃ©cnico hÃ¡ mais de 6 anos e fui diretamente confrontado com o desempenho.  Hoje vou falar sobre o desempenho que o TimescaleDB pode oferecer quando comparado ao PostgreSQL 10. regular. AlÃ©m disso, alguma parte introdutÃ³ria - sobre como ele funciona. <a name="habracut"></a><br><br><h3>  Principais desafios de desempenho: da coleta Ã  limpeza de dados </h3><br>  Para comeÃ§ar, existem certos desafios de desempenho que todo sistema de monitoramento encontra.  O primeiro desafio de desempenho Ã© a rÃ¡pida coleta e processamento de dados. <br><br><img src="https://habrastorage.org/webt/jl/xr/hv/jlxrhv3huan1s0w4otmxoknifzy.jpeg"><br><br>  Um bom sistema de monitoramento deve receber prontamente, em tempo hÃ¡bil, todos os dados, processÃ¡-los de acordo com as expressÃµes de gatilho, ou seja, processÃ¡-los de acordo com alguns critÃ©rios (em diferentes sistemas, Ã© diferente) e salvÃ¡-los no banco de dados para usar esses dados no futuro. <br><br><img src="https://habrastorage.org/webt/d5/vq/-l/d5vq-lgcwljaq50nc-zxfeugi3k.jpeg"><br><br>  O segundo desafio de desempenho Ã© manter a histÃ³ria.  Armazene no banco de dados com frequÃªncia e tenha acesso rÃ¡pido e conveniente a essas mÃ©tricas coletadas durante um perÃ­odo de tempo.  O mais importante Ã© que Ã© conveniente obter esses dados, usÃ¡-los em relatÃ³rios, grÃ¡ficos, gatilhos, em alguns valores limite, para alertas, etc. <br><br><img src="https://habrastorage.org/webt/k2/1l/3g/k21l3gg3vmeayv-d8oqpatgssv8.jpeg"><br><br>  O terceiro desafio de desempenho Ã© limpar o histÃ³rico, ou seja, quando seu dia Ã© tal que vocÃª nÃ£o precisa armazenar nenhuma mÃ©trica detalhada que foi coletada em cinco anos (atÃ© meses ou dois meses).  Alguns nÃ³s da rede foram excluÃ­dos ou, em alguns hosts, as mÃ©tricas nÃ£o sÃ£o mais necessÃ¡rias porque jÃ¡ estÃ£o desatualizadas e nÃ£o sÃ£o mais coletadas.  Tudo isso precisa ser limpo para que seu banco de dados nÃ£o cresÃ§a em um tamanho grande.  Em geral, limpar o histÃ³rico costuma ser um teste sÃ©rio para o armazenamento - muitas vezes afeta o desempenho. <br><br><h3>  Como resolver problemas de cache? </h3><br>  Agora vou falar especificamente sobre o Zabbix.  No Zabbix, a primeira e a segunda chamadas sÃ£o resolvidas usando o cache. <br><br><img src="https://habrastorage.org/webt/mg/2b/tb/mg2btblcs3cxvlnddc0yg6lwxrw.jpeg"><br><br>  Coleta e processamento de dados - usamos RAM para armazenar todos esses dados.  Agora esses dados serÃ£o discutidos em mais detalhes. <br><br>  TambÃ©m no lado do banco de dados, hÃ¡ um certo cache para as principais amostras - para grÃ¡ficos, outras coisas. <br><br>  Armazenamento em cache no lado do servidor Zabbix: temos ConfigurationCache, ValueCache, HistoryCache, TrendsCache.  O que Ã© isso <br><br><img src="https://habrastorage.org/webt/6j/4e/_a/6j4e_acyhx8ldzgjfziqhuzvwz0.jpeg"><br><br>  O ConfigurationCache Ã© o principal cache no qual armazenamos mÃ©tricas, hosts, itens de dados, gatilhos;  tudo o que vocÃª precisa para processar o prÃ©-processamento, coletar dados, de quais hosts coletar, com que frequÃªncia.  Tudo isso Ã© armazenado no ConfigurationCache, para nÃ£o ir ao banco de dados, nem criar solicitaÃ§Ãµes desnecessÃ¡rias.  ApÃ³s o inÃ­cio do servidor, atualizamos esse cache (criamos) e periodicamente (dependendo das configuraÃ§Ãµes). <br><br><img src="https://habrastorage.org/webt/q1/zc/dg/q1zcdgan2c5rcep47ebef24xrn0.jpeg"><br><br><h3>  Armazenamento em cache no Zabbix.  Coleta de dados </h3><br>  Aqui o esquema Ã© bastante grande: <br><br><img src="https://habrastorage.org/webt/88/mh/gd/88mhgd974zcj8eou8kghhodhwf0.jpeg"><br><br>  Os principais no esquema sÃ£o esses coletores: <br><br><img src="https://habrastorage.org/webt/2y/co/f7/2ycof750qb71iooc2qiahs-5i9y.jpeg"><br><br>  Estes sÃ£o os prÃ³prios processos de montagem, vÃ¡rios â€œpesquisadoresâ€ responsÃ¡veis â€‹â€‹por diferentes tipos de montagem.  Eles coletam dados via icmp, ipmi, de acordo com diferentes protocolos e transferem tudo para o prÃ©-processamento. <br><br><h3>  HistÃ³rico de PrÃ©-ProcessamentoCache </h3><br>  AlÃ©m disso, se tivermos calculado elementos de dados (quem conhece o Zabbix - sabe), ou seja, calculados, elementos de dados agregados, nÃ³s os retiramos diretamente do ValueCache.  Sobre como Ã© preenchido, direi mais tarde.  Todos esses coletores usam o ConfigurationCache para obter seus trabalhos e depois transmiti-los ao prÃ©-processamento. <br><br><img src="https://habrastorage.org/webt/b4/qb/mh/b4qbmhsqtxvrfli40n-espjba6c.jpeg"><br><br>  O prÃ©-processamento tambÃ©m usa o ConfigurationCache para obter etapas de prÃ©-processamento; processa esses dados de vÃ¡rias maneiras.  A partir da versÃ£o 4.2, nÃ³s a submetemos ao proxy.  Isso Ã© muito conveniente, porque o prÃ©-processamento Ã© uma operaÃ§Ã£o bastante difÃ­cil.  E se vocÃª possui um "Zabbix" muito grande, com um grande nÃºmero de elementos de dados e uma alta frequÃªncia de coleta, isso facilita muito o trabalho. <br><br>  Assim, depois de processarmos esses dados de alguma maneira usando o prÃ©-processamento, salvamos no HistoryCache para processÃ¡-los ainda mais.  Isso encerra a coleta de dados.  Passamos ao processo principal. <br><br><h3>  OperaÃ§Ã£o do sincronizador de histÃ³rico </h3><br><img src="https://habrastorage.org/webt/40/yj/9-/40yj9-h-hgm5wcd2hu2ygt5uyp4.jpeg"><br><br>  O principal processo no Zabbix (uma vez que Ã© uma arquitetura monolÃ­tica) Ã© o sincronizador de HistÃ³ria.  Este Ã© o processo principal que lida especificamente com o processamento atÃ´mico de cada elemento de dados, ou seja, de cada valor: <br><br><ul><li>  valor vem (Ã© usado no HistoryCache); </li><li>  verifica no Configuration syncer: existem gatilhos para o cÃ¡lculo? calcula-os; <br>  se houver, ele cria eventos, cria uma escalaÃ§Ã£o para criar um alerta, se necessÃ¡rio por configuraÃ§Ã£o; </li><li>  registra gatilhos para processamento subseqÃ¼ente, agregaÃ§Ã£o;  se vocÃª agrega na Ãºltima hora e assim por diante, esse valor lembra ValueCache, para nÃ£o ir para a tabela de histÃ³rico;  Assim, o ValueCache Ã© preenchido com os dados necessÃ¡rios para o cÃ¡lculo de gatilhos, elementos calculados, etc. </li><li>  o sincronizador de histÃ³rico grava todos os dados no banco de dados; </li><li>  o banco de dados os grava no disco - Ã© aqui que o processo de processamento termina. </li></ul><br><h3>  Bases de dados  Armazenamento em cache </h3><br>  No lado do banco de dados, quando vocÃª deseja visualizar grÃ¡ficos ou algum tipo de relatÃ³rio de evento, existem vÃ¡rios caches.  Mas, como parte deste relatÃ³rio, nÃ£o vou falar sobre eles. <br><br>  Para o MySQL, existe o Innodb_buffer_pool, um monte de caches diferentes que tambÃ©m podem ser configurados. <br>  Mas estes sÃ£o os principais: <br><br><ul><li>  shared_buffers; </li><li>  effective_cache_size; </li><li>  shared_pool. </li></ul><br><img src="https://habrastorage.org/webt/fw/7n/0z/fw7n0ziowm_jbvs--peokkswjdw.jpeg"><br><br>  Eu citei para todos os bancos de dados que existem certos caches que permitem manter na memÃ³ria os dados que geralmente sÃ£o necessÃ¡rios para consultas.  LÃ¡ eles tÃªm suas prÃ³prias tecnologias para isso. <br><br><h3>  Sobre o desempenho do banco de dados </h3><br>  Consequentemente, existe um ambiente competitivo, ou seja, o servidor Zabbix coleta dados e os registra.  Ao reiniciar, ele tambÃ©m lÃª o histÃ³rico para preencher o ValueCache e assim por diante.  Aqui vocÃª pode ter scripts e relatÃ³rios que usam a API do Zabbix, que Ã© criada com base na interface da web.  O "Zabbiks" -API Ã© incluÃ­do no banco de dados e recebe os dados necessÃ¡rios para obter grÃ¡ficos, relatÃ³rios ou alguma lista de eventos, problemas recentes. <br><br><img src="https://habrastorage.org/webt/gr/to/vp/grtovpkr0x6kkytkg5bw2zllpqw.jpeg"><br><br>  Uma soluÃ§Ã£o de visualizaÃ§Ã£o muito popular Ã© o Grafana, usado por nossos usuÃ¡rios.  Capaz de inserir diretamente atravÃ©s do "Zabbiks" -API e atravÃ©s do banco de dados.  Ele tambÃ©m cria uma certa competiÃ§Ã£o pela obtenÃ§Ã£o de dados: Ã© necessÃ¡rio um ajuste melhor e mais preciso do banco de dados para corresponder Ã  entrega rÃ¡pida de resultados e testes. <br><br><img src="https://habrastorage.org/webt/aj/ak/l-/ajakl-q1nyal8mce-xw4snwrgye.jpeg"><br><br><h3>  Limpar histÃ³rico.  Zabbix tem governanta </h3><br>  O terceiro desafio usado pelo Zabbix Ã© esclarecer a histÃ³ria com a governanta.  O Hauskiper estÃ¡ em conformidade com todas as configuraÃ§Ãµes, ou seja, em nossos elementos de dados, Ã© indicado quanto armazenar (em dias), quanto armazenar tendÃªncias, a dinÃ¢mica das mudanÃ§as. <br><br>  NÃ£o falei sobre o TrendCache, que calculamos em tempo real: os dados chegam, agregamos em uma hora (basicamente esses sÃ£o os nÃºmeros da Ãºltima hora), a quantidade mÃ©dia / mÃ­nima e anotamos uma vez por hora na tabela de dinÃ¢mica de alteraÃ§Ãµes (Trends) .  O Hauskiper inicia e exclui dados do banco de dados usando seleÃ§Ãµes regulares, o que nem sempre Ã© eficaz. <br><br>  Como entender que Ã© ineficiente?  VocÃª pode ver a figura a seguir nos grÃ¡ficos de desempenho de processos internos: <br><br><img src="https://habrastorage.org/webt/cw/au/u3/cwauu3n4dk0-u_nonnfzbf0og6g.jpeg"><br><br>  Seu sincronizador de histÃ³rico estÃ¡ constantemente ocupado (grÃ¡fico vermelho).  E o grÃ¡fico "vermelho" que fica no topo.  Este Ã© o Hauskiper, que inicia e aguarda o banco de dados quando ele exclui todas as linhas especificadas. <br><br>  Pegue um cÃ³digo de item: vocÃª precisa excluir os Ãºltimos 5 mil;  Claro, por Ã­ndices.  Mas geralmente o conjunto de dados Ã© grande o suficiente - o banco de dados ainda lÃª isso do disco e o eleva para o cache, e essa Ã© uma operaÃ§Ã£o muito cara para o banco de dados.  Dependendo do tamanho, isso pode levar a certos problemas de desempenho. <br><br>  VocÃª pode desativar o Hauskiper de uma maneira simples - nÃ³s temos uma interface web familiar para todos.  Definindo em AdministraÃ§Ã£o geral (configuraÃ§Ãµes para "Governanta"), desabilitamos as tarefas domÃ©sticas internas para o histÃ³rico e as tendÃªncias internas.  Assim, Hauskiper nÃ£o controla mais isso: <br><br><img src="https://habrastorage.org/webt/cp/si/jo/cpsijomx2kl2p1trw0it8ujvpga.jpeg"><br><br>  O que posso fazer a seguir?  VocÃª desconectou, seus agendamentos subiram de nÃ­vel ... Que problemas podem ser maiores nesse caso?  O que pode ajudar? <br><br><h3>  Particionamento (particionamento) </h3><br>  Isso geralmente Ã© configurado em todos os bancos de dados relacionais listados de uma maneira diferente.  O MySQL possui sua prÃ³pria tecnologia.  Mas no geral eles sÃ£o muito parecidos quando se trata de PostgreSQL 10 e MySQL.  Obviamente, existem muitas diferenÃ§as internas em como tudo Ã© implementado e como tudo isso afeta o desempenho.  Mas, em geral, a criaÃ§Ã£o de uma nova partiÃ§Ã£o tambÃ©m costuma levar a certos problemas. <br><br><img src="https://habrastorage.org/webt/g3/ru/gs/g3rugs9kazu4fcyk70inqtrnrd4.jpeg"><br><br>  Dependendo da sua configuraÃ§Ã£o (quantos dados vocÃª cria em um dia), eles geralmente definem o mÃ­nimo de 1 dia / partiÃ§Ã£o e, para tendÃªncias, a dinÃ¢mica das alteraÃ§Ãµes - 1 mÃªs / nova partiÃ§Ã£o.  Isso pode mudar se vocÃª tiver uma configuraÃ§Ã£o muito grande. <br><br>  Digamos imediatamente sobre o tamanho da configuraÃ§Ã£o: atÃ© 5 mil novos valores por segundo (os chamados nvps) - isso serÃ¡ considerado uma pequena "configuraÃ§Ã£o".  MÃ©dia - de 5 a 25 mil valores por segundo.  Tudo o que estÃ¡ acima jÃ¡ Ã© instalaÃ§Ãµes grandes e muito grandes que requerem uma configuraÃ§Ã£o muito cuidadosa do prÃ³prio banco de dados. <br><br>  Em instalaÃ§Ãµes muito grandes, 1 dia - isso pode nÃ£o ser o ideal.  Eu pessoalmente vi no MySQL partiÃ§Ãµes de 40 gigabytes por dia (e pode haver mais).  Essa Ã© uma quantidade muito grande de dados, que pode levar a alguns problemas.  Precisa ser reduzido. <br><br><h3>  Por que particionar? </h3><br>  O que o particionamento fornece, acho que todo mundo sabe, Ã© o particionamento de tabelas.  Geralmente, esses sÃ£o arquivos separados em solicitaÃ§Ãµes de disco e extensÃ£o.  Ele seleciona de maneira mais otimizada uma partiÃ§Ã£o, se isso faz parte da partiÃ§Ã£o usual. <br><br><img src="https://habrastorage.org/webt/nd/u2/6a/ndu26acwf_st_axq0rfws4t0yhu.jpeg"><br><br>  Para o Zabbix, em particular, ele Ã© usado por faixa, por faixa, ou seja, usamos um registro de data e hora (o nÃºmero Ã© comum, o horÃ¡rio desde o inÃ­cio da Ã©poca).  VocÃª especifica o inÃ­cio do dia / fim do dia e esta Ã© uma partiÃ§Ã£o.  Portanto, se vocÃª estÃ¡ solicitando dados hÃ¡ dois dias, tudo isso Ã© selecionado no banco de dados mais rapidamente, porque vocÃª sÃ³ precisa enviar um arquivo para o cache e emitir (em vez de uma tabela grande). <br><br><img src="https://habrastorage.org/webt/n8/-5/h0/n8-5h0inf3gdrt6fv2jaqeguoxm.jpeg"><br><br>  Muitos bancos de dados tambÃ©m aceleram a inserÃ§Ã£o (inserÃ§Ã£o em uma Ãºnica tabela filho).  Enquanto eu falo abstratamente, mas tambÃ©m Ã© possÃ­vel.  Particionar muitas vezes ajuda. <br><br><h3>  Elasticsearch para NoSQL </h3><br>  Recentemente, na 3.4, implementamos uma soluÃ§Ã£o para NoSQL.  Adicionada a capacidade de escrever no Elasticsearch.  VocÃª pode escrever alguns tipos separados: escolha - escreva nÃºmeros ou alguns sinais;  temos texto de string, vocÃª pode escrever logs no Elasticsearch ... Assim, a interface da web tambÃ©m acessarÃ¡ o Elasticsearch.  Isso funciona bem em alguns casos, mas no momento pode ser usado. <br><br><img src="https://habrastorage.org/webt/xq/f_/kc/xqf_kcj7pttjfkqtvykodkhf1ne.jpeg"><br><br><h3>  TimescaleDB.  Hypertables </h3><br>  Para a 4.4.2, notamos uma coisa como o TimescaleDB.  O que Ã© isso  Esta Ã© uma extensÃ£o para o Postgres, ou seja, possui uma interface nativa do PostgreSQL.  AlÃ©m disso, esta extensÃ£o permite trabalhar com dados de sÃ©ries temporais com muito mais eficiÃªncia e ter particionamento automÃ¡tico.  Como Ã©: <br><br><img src="https://habrastorage.org/webt/_q/nk/mz/_qnkmz4mbfzhveegk3d2hjzgafg.jpeg"><br><br>  Isso Ã© hipertabela - existe esse conceito na escala de tempo.  Essa Ã© a hipertabela que vocÃª cria e contÃ©m partes.  PedaÃ§os sÃ£o partiÃ§Ãµes, essas sÃ£o tabelas filho, se nÃ£o me engano.  Ã‰ realmente eficaz. <br><br><img src="https://habrastorage.org/webt/un/gu/pk/ungupk6uffgezcunuoaa4tjkk0g.jpeg"><br><br><h3>  TimescaleDB e PostgreSQL </h3><br>  Como os fabricantes do TimescaleDB asseguram, eles usam um algoritmo de processamento de solicitaÃ§Ã£o mais correto, em particular insert'ov, que permite que vocÃª tenha desempenho aproximadamente constante com um tamanho crescente da inserÃ§Ã£o do conjunto de dados.  Ou seja, apÃ³s 200 milhÃµes de linhas do "Postgres", o normal comeÃ§a a cair muito e perde o desempenho literalmente para zero, enquanto o "Timescale" permite inserir inserÃ§Ãµes da maneira mais eficiente possÃ­vel com qualquer quantidade de dados. <br><br><img src="https://habrastorage.org/webt/xo/zb/-o/xozb-o86ammklruo6wbmreoddga.jpeg"><br><br><h3>  Como instalar o TimescaleDB?  Tudo Ã© simples! </h3><br>  Ele estÃ¡ na documentaÃ§Ã£o, estÃ¡ descrito - pode ser entregue a partir de pacotes para qualquer ... Depende dos pacotes oficiais do Postgres.  Pode ser compilado manualmente.  Aconteceu que eu tive que compilar para o banco de dados. <br><br><img src="https://habrastorage.org/webt/vm/t8/ab/vmt8ab42ehsl-ne-cxb70skn9ik.jpeg"><br><br>  No Zabbix, apenas ativamos a extensÃ£o.  Eu acho que aqueles que usaram o Extention no Postgres ... VocÃª acabou de ativar o Extention, crie-o para o banco de dados do Zabbix que vocÃª usa. <br><br>  E o Ãºltimo passo ... <br><br><h3>  TimescaleDB.  Tabelas de histÃ³rico de migraÃ§Ã£o </h3><br>  VocÃª precisa criar uma hipertabela.  HÃ¡ uma funÃ§Ã£o especial para isso - Criar hipertabela.  Nele, o primeiro parÃ¢metro indica a tabela necessÃ¡ria neste banco de dados (para a qual vocÃª precisa criar uma hipertabela). <br><br><img src="https://habrastorage.org/webt/rs/p0/ja/rsp0ja0xplwviw9abiqvsody8zw.jpeg"><br><br>  O campo pelo qual vocÃª deseja criar e chunk_time_interval (este Ã© o intervalo de chunks (partiÃ§Ãµes a serem usadas). 86.400 Ã© de um dia. <br><br>  ParÃ¢metro migrate_data: se vocÃª inserir true, isso transferirÃ¡ todos os dados atuais para os pedaÃ§os criados anteriormente. <br><br>  Eu mesmo usei migrate_data - leva uma quantidade decente de tempo, dependendo do tamanho do seu banco de dados.  Eu tinha mais de um terabyte - a criaÃ§Ã£o levou mais de uma hora.  Em alguns casos, ao testar, excluÃ­ os dados histÃ³ricos do texto (history_text) e da string (history_str), para nÃ£o transferi-los - eles nÃ£o eram realmente interessantes para mim. <br><br>  E fazemos a Ãºltima atualizaÃ§Ã£o em nossa db_extention: configuramos timescaledb para que o banco de dados e, em particular, nosso Zabbix entendam o que Ã© db_extention.  Ele o ativa e usa a sintaxe correta e as consultas ao banco de dados, usando os â€œrecursosâ€ necessÃ¡rios para o TimescaleDB. <br><br><h3>  ConfiguraÃ§Ã£o do servidor </h3><br>  Eu usei dois servidores.  O primeiro servidor Ã© uma mÃ¡quina virtual pequena o suficiente, 20 processadores, 16 gigabytes de RAM.  Configure o Postgres 10.8: <br><br><img src="https://habrastorage.org/webt/q_/h-/fe/q_h-fey52vutiin_dcat3zezb1g.jpeg"><br><br>  O sistema operacional era o Debian, o sistema de arquivos era xfs.  Fiz configuraÃ§Ãµes mÃ­nimas para usar esse banco de dados especÃ­fico, menos o que o Zabbix usarÃ¡.  Na mesma mÃ¡quina, havia um servidor Zabbix, PostgreSQL e agentes de carregamento. <br><br><img src="https://habrastorage.org/webt/vl/jv/bu/vljvbuggjlj1vz5tvptvzsicauo.jpeg"><br><br>  Usei 50 agentes ativos que usam o LoadableModule para gerar rapidamente vÃ¡rios resultados.  Eles geraram linhas, nÃºmeros e assim por diante.  Entupi o banco de dados com muitos dados.  Inicialmente, a configuraÃ§Ã£o continha 5 mil elementos de dados por host e aproximadamente cada elemento de dados continha um gatilho - para que fosse uma configuraÃ§Ã£o real.  Ã€s vezes, Ã© preciso atÃ© mais de um gatilho para usar. <br><br><img src="https://habrastorage.org/webt/9e/z0/os/9ez0os1zg6wv3k3d176svhoauqe.jpeg"><br><br>  Regulei o intervalo de atualizaÃ§Ã£o, a carga em si, para nÃ£o apenas usar 50 agentes (adicionados mais), mas tambÃ©m usar elementos de dados dinÃ¢micos e reduzir o intervalo de atualizaÃ§Ã£o para 4 segundos. <br><br><h3>  Teste de desempenho.  PostgreSQL: 36 mil NVPs </h3><br>  O primeiro lanÃ§amento, a primeira configuraÃ§Ã£o que tive no PostreSQL 10 puro neste hardware (35 mil valores por segundo).  Em geral, como vocÃª pode ver na tela, a inserÃ§Ã£o de dados leva fraÃ§Ãµes de segundo - tudo estÃ¡ bem e rÃ¡pido, SSDs (200 gigabytes).  A Ãºnica coisa Ã© que 20 GB sÃ£o preenchidos rapidamente. <br><br><img src="https://habrastorage.org/webt/st/er/oh/sterohufqkrwjzwicbau9fxyeg8.jpeg"><br><br>  HaverÃ¡ muitos mais desses grÃ¡ficos.  Este Ã© o painel de desempenho padrÃ£o do servidor Zabbix. <br><br><img src="https://habrastorage.org/webt/2m/31/jy/2m31jys-j4bm3ocrwo7bqtp5ftu.jpeg"><br><br>  O primeiro grÃ¡fico Ã© o nÃºmero de valores por segundo (azul, canto superior esquerdo), 35 mil valores neste caso.  Este (centro de carregamento) Ã© o carregamento de processos de montagem e este (superior direito) Ã© o carregamento de processos internos: sincronizadores de histÃ³rico e governanta, que estÃ£o em execuÃ§Ã£o aqui hÃ¡ um tempo suficiente. <br><br>  Este grÃ¡fico (parte inferior central) mostra o uso do ValueCache - quantas ocorrÃªncias do ValueCache para acionadores (vÃ¡rios milhares de valores por segundo).  Outro grÃ¡fico importante Ã© o quarto (canto inferior esquerdo), que mostra o uso do HistoryCache, sobre o qual eu falei, que Ã© um buffer antes de inserir no banco de dados. <br><br><h3>  Teste de desempenho.  PostgreSQL: 50 mil NVPs </h3><br>  Em seguida, aumentei a carga para 50 mil valores por segundo no mesmo hardware.  Ao carregar com o Hauskiper, 10 mil valores jÃ¡ foram registrados em 2-3 segundos com o cÃ¡lculo.  Que, de fato, Ã© mostrado na seguinte captura de tela: <br><br><img src="https://habrastorage.org/webt/z7/ml/st/z7mlstfkfw8weobkfvj83zxy4w4.jpeg"><br><br>  Hauskiper jÃ¡ estÃ¡ comeÃ§ando a interferir no trabalho, mas em geral o carregamento de caÃ§adores de afundadores de histÃ³ria ainda estÃ¡ em 60% (terceiro grÃ¡fico, canto superior direito).  O HistoryCache jÃ¡ durante o trabalho de "Hauskiper" comeÃ§a a ser preenchido ativamente (canto inferior esquerdo).  Era cerca de meio gigabyte, preenchido a 20%. <br><br><img src="https://habrastorage.org/webt/mk/-k/q4/mk-kq4jre2iwk-6fdt9xlejoaje.jpeg"><br><br><h3>  Teste de desempenho.  PostgreSQL: 80 mil NVPs </h3><br>  Aumentou ainda mais para 80 mil valores por segundo: <br><br><img src="https://habrastorage.org/webt/7g/zj/jq/7gzjjqaa68jpj_9yltg7mhfvz0a.jpeg"><br><br>  Foram aproximadamente 400 mil elementos de dados, 280 mil gatilhos.  A inserÃ§Ã£o, como vocÃª pode ver, para o carregamento de chumbadas histÃ³ricas (havia 30 delas) jÃ¡ era bastante alta.  AlÃ©m disso, aumentei vÃ¡rios parÃ¢metros: histÃ³rico-afundadores, cache ... Nesse hardware, o carregamento dos afundadores de histÃ³ria comeÃ§ou a aumentar ao mÃ¡ximo, quase "atÃ© a prateleira" - de acordo com isso, o HistoryCache passou a uma carga muito alta: <br><br><img src="https://habrastorage.org/webt/xd/3z/ky/xd3zkydh5zu-vkewwstgk12qc-s.jpeg"><br><br>          (  ,  )  ,      â€“         ,    . Â«Â»        ,       , â€¦ <br><br><img src="https://habrastorage.org/webt/d7/3l/2z/d73l2zoa7tqmhkjoji9z4hx1poy.jpeg"><br><br>    ,    48  128   : <br><br><img src="https://habrastorage.org/webt/-x/-b/9d/-x-b9dzzor5kwaba8sloo01yhk0.jpeg"><br><br>    Â«Â» â€“  History syncer (60 )    .    Â« Â»,   , ,  ,    -   . <br><br><h3>  . TimescaleDB: 80  NVPs </h3><br>      â€“  TimescaleDB.     : <br><br><img src="https://habrastorage.org/webt/zr/2l/hb/zr2lhbdocfwqknn3sgd_4agzsus.jpeg"><br><br>   â€“    .    Â«Â»-   -,   ,   .    3         HistoryCache â€“ ,      .  , 80     â€“    rate (,   Â«Â»).      setup,   . <br><br><h3>   PostgreSQL: 120  NVPs </h3><br>              125   : <br><br><img src="https://habrastorage.org/webt/cd/ay/e6/cdaye6egnxctvuobxadw6hf7bhw.jpeg"><br><br>    : <br><br><img src="https://habrastorage.org/webt/ts/di/fg/tsdifgr_chfu20nox8il6o2dtha.jpeg"><br><br>     setup,      .          1,5 ,       .  ,         TimescaleDB,       ,     MySQL. <br><br>    ,          ,     .     !    â€“   TimescaleDB.   : 120    . <br><br>    Â«Â» : <br><br><img src="https://habrastorage.org/webt/rz/rn/m-/rzrnm-wfnbq8unwrcvozg8neccy.jpeg"><br><br>    TimescaleDB     io.weight   ;          TimescaleDB.     ,        ( SSD)! <br><br>  -  setup',     , TimescaleDB,   ,   .       ,         . <br><br>      : Conference â€“  , Summit â€“  .    â€“ Â«Â», , IRC.     -  â€“     ,    . <br><br><h3>   </h3><br>    ( â€“ ): â€“  TimescaleDB    ,      , , ,        Â«Â»  Â«Â»?    -      ,  -,      Â«Â»,     Â«Â»,   Â«Â» ,        ? <br><br><img src="https://habrastorage.org/webt/5j/k8/og/5jk8ogejgbixfe_a0tfxzh8vbmw.jpeg"><br><br> <b>:</b> â€“ ,   ,    :  Â«Â»    TimescaleDB.    ,   ,   ,   Â«Â» .      ,     ( TimescaleDB),   ,    !    ,        ,  . <br><br>           Â«Â»:       - .        ,         .         setup'.    MySQLâ€¦   setup'    . <br><br> <b>:</b> â€“   ,   community,    Â«Â»: <br><br><img src="https://habrastorage.org/webt/xh/pg/0j/xhpg0jw0a7davjqyru9gqg7xnx8.jpeg"><br><br>   .  Â«Â»     TimescaleDB? <br><br> <b>:</b> â€“      â€“      .     TimescaleDB    ,  - .         .      . <br><br> <b>:</b> â€“     â€“      Â«Â». <br>  (  ): â€“      ,      delete,       â€“ , ,     .  Â«Â»,     ,   .  ,    ,    big data: Â«!Â» <br><br> Â«Â»  ,     .        ,        select'       ,      â€“ Â«    !Â» ( ).   !         ,   . <br><br> <b>:</b> â€“     SQL.   , Â«Â»     ,    â€“ -  .     ,      ,      , ,  â€“ Clickhouse, , - -?.. Kafka â€“    !    - ? <br><br> <b>:</b> â€“   .     Â«Â»   3.4:        , ,  ;   -      .           .   -     ,      ,       Â«Â».     , , ,   NoSQL- (,  Â«Â»)  . <br><br> <b>:</b> â€“ , ,     ? <br><br> <b>:</b> â€“ ,     Â«Â» â€“   ,     ,  .   ,               -   ,     , ,  . <br><br> <b>:</b> â€“  ,     ,    Â«Â», ? <br><br> <b>:</b> â€“   . ,           , ,  Â«Â»   ,     .  .    :       .  â€“  ,       â€“ Grafana   -. <br><br> <b>:</b> â€“       ,        ? <br><br> <b>:</b> â€“ ,  ,    . <br><br> <b>:</b> â€“      RRD?       SQL?    RRD   . <br><br> <b>:</b> â€“  Â«ZabbixÂ» RRD,  ,     .   SQL-  â€“  .   â€“  MySQL, PostgreSQL (   ).        SQL  RRD     . <br><br><img src="https://habrastorage.org/webt/a4/oi/25/a4oi25ls8s9shibkxhx1ckuxfqk.jpeg"><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/umRk94j5M8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Um pouco de publicidade :) </h3><br>  Obrigado por ficar conosco.  VocÃª gosta dos nossos artigos?  Deseja ver materiais mais interessantes?  Ajude-nos fazendo um pedido ou recomendando aos seus amigos <a href="https://ua-hosting.company/cloudvps/nl">VPS baseado em nuvem para desenvolvedores a partir de US $ 4,99</a> , um <b>analÃ³gico exclusivo de servidores</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">bÃ¡sicos</a> <b>que foi inventado por nÃ³s para vocÃª:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">Toda a verdade sobre o VPS (KVM) E5-2697 v3 (6 nÃºcleos) 10GB DDR4 480GB SSD 1Gbps de 10GB de US $ 19 ou como dividir o servidor?</a>  (as opÃ§Ãµes estÃ£o disponÃ­veis com RAID1 e RAID10, atÃ© 24 nÃºcleos e atÃ© 40GB DDR4). <br><br>  <b>Dell R730xd 2 vezes mais barato no data center Equinix Tier IV em AmsterdÃ£?</b>  Somente temos <b><a href="https://ua-hosting.company/serversnl">2 TVs Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV a partir de US $ 199</a> na Holanda!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - a partir de US $ 99!</b></b>  Leia sobre <a href="https://habr.com/company/ua-hosting/blog/329618/">Como criar um prÃ©dio de infraestrutura.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">classe usando servidores Dell R730xd E5-2650 v4 custando 9.000 euros por um centavo?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485470/">https://habr.com/ru/post/pt485470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485458/index.html">Silencioso obus</a></li>
<li><a href="../pt485460/index.html">20 bibliotecas para um aplicativo iOS espetacular</a></li>
<li><a href="../pt485462/index.html">Lidamos com eSIM (+ entrevista com um especialista)</a></li>
<li><a href="../pt485464/index.html">Meu primeiro jogo html5, de Alice Yandex e premiaÃ§Ãµes a aplicativos mÃ³veis</a></li>
<li><a href="../pt485468/index.html">Variante de trabalhar com soquetes da Web no iOS no Swift / Escreveu um gerente para trabalhar com o websocket</a></li>
<li><a href="../pt485472/index.html">O que hÃ¡ de novo a esperar da AMD?</a></li>
<li><a href="../pt485476/index.html">TendÃªncias e negociaÃ§Ã£o na bolsa: 4 indicadores populares de anÃ¡lise tÃ©cnica</a></li>
<li><a href="../pt485480/index.html">Coluna portÃ¡til Z-poject Doublebeef - mono duplo em russo. Testar, desmontar e atualizar</a></li>
<li><a href="../pt485482/index.html">3 problemas na transferÃªncia de dados para o Google Analytics por meio do Protocolo de avaliaÃ§Ã£o</a></li>
<li><a href="../pt485484/index.html">[Locomizer de caso] Que conhecimento pode realmente ser extraÃ­do de um conjunto de dados anÃ´nimo com coordenadas do usuÃ¡rio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>