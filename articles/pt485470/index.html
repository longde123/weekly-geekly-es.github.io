<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòè ‚ùì üòß HighLoad ++, Andrey Gushchin (Zabbix): alto desempenho e particionamento nativo üë®üèæ‚Äçüç≥ üëÉüèΩ üíÖüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Veremos como o Zabbix funciona com o banco de dados TimescaleDB como um back-end. Mostramos como come√ßar do zero e como migrar com o PostgreSQL. Tamb√©...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Andrey Gushchin (Zabbix): alto desempenho e particionamento nativo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/485470/">  Veremos como o Zabbix funciona com o banco de dados TimescaleDB como um back-end.  Mostramos como come√ßar do zero e como migrar com o PostgreSQL.  Tamb√©m fornecemos testes de desempenho comparativos das duas configura√ß√µes. <br><br><img src="https://habrastorage.org/webt/h4/jl/nw/h4jlnwupm_dewx7jasafurn-ibm.jpeg"><br><br>  HighLoad ++ Siberia 2019. Tomsk Hall.  24 de junho, 16:00.  Resumos e <a href="https://www.highload.ru/siberia/2019/abstracts/5390">apresenta√ß√£o</a> .  A pr√≥xima confer√™ncia HighLoad ++ ser√° realizada nos dias 6 e 7 de abril de 2020 em S√£o Petersburgo.  Detalhes e ingressos <a href="http://bit.ly/2sSxgBx">aqui</a> . <br><br>  <b>Andrey Gushchin (doravante</b> denominado <b>AG):</b> - Sou engenheiro de suporte t√©cnico da ZABBIX (doravante denominado Zabbix), um treinador.  Trabalho com suporte t√©cnico h√° mais de 6 anos e fui diretamente confrontado com o desempenho.  Hoje vou falar sobre o desempenho que o TimescaleDB pode oferecer quando comparado ao PostgreSQL 10. regular. Al√©m disso, alguma parte introdut√≥ria - sobre como ele funciona. <a name="habracut"></a><br><br><h3>  Principais desafios de desempenho: da coleta √† limpeza de dados </h3><br>  Para come√ßar, existem certos desafios de desempenho que todo sistema de monitoramento encontra.  O primeiro desafio de desempenho √© a r√°pida coleta e processamento de dados. <br><br><img src="https://habrastorage.org/webt/jl/xr/hv/jlxrhv3huan1s0w4otmxoknifzy.jpeg"><br><br>  Um bom sistema de monitoramento deve receber prontamente, em tempo h√°bil, todos os dados, process√°-los de acordo com as express√µes de gatilho, ou seja, process√°-los de acordo com alguns crit√©rios (em diferentes sistemas, √© diferente) e salv√°-los no banco de dados para usar esses dados no futuro. <br><br><img src="https://habrastorage.org/webt/d5/vq/-l/d5vq-lgcwljaq50nc-zxfeugi3k.jpeg"><br><br>  O segundo desafio de desempenho √© manter a hist√≥ria.  Armazene no banco de dados com frequ√™ncia e tenha acesso r√°pido e conveniente a essas m√©tricas coletadas durante um per√≠odo de tempo.  O mais importante √© que √© conveniente obter esses dados, us√°-los em relat√≥rios, gr√°ficos, gatilhos, em alguns valores limite, para alertas, etc. <br><br><img src="https://habrastorage.org/webt/k2/1l/3g/k21l3gg3vmeayv-d8oqpatgssv8.jpeg"><br><br>  O terceiro desafio de desempenho √© limpar o hist√≥rico, ou seja, quando seu dia √© tal que voc√™ n√£o precisa armazenar nenhuma m√©trica detalhada que foi coletada em cinco anos (at√© meses ou dois meses).  Alguns n√≥s da rede foram exclu√≠dos ou, em alguns hosts, as m√©tricas n√£o s√£o mais necess√°rias porque j√° est√£o desatualizadas e n√£o s√£o mais coletadas.  Tudo isso precisa ser limpo para que seu banco de dados n√£o cres√ßa em um tamanho grande.  Em geral, limpar o hist√≥rico costuma ser um teste s√©rio para o armazenamento - muitas vezes afeta o desempenho. <br><br><h3>  Como resolver problemas de cache? </h3><br>  Agora vou falar especificamente sobre o Zabbix.  No Zabbix, a primeira e a segunda chamadas s√£o resolvidas usando o cache. <br><br><img src="https://habrastorage.org/webt/mg/2b/tb/mg2btblcs3cxvlnddc0yg6lwxrw.jpeg"><br><br>  Coleta e processamento de dados - usamos RAM para armazenar todos esses dados.  Agora esses dados ser√£o discutidos em mais detalhes. <br><br>  Tamb√©m no lado do banco de dados, h√° um certo cache para as principais amostras - para gr√°ficos, outras coisas. <br><br>  Armazenamento em cache no lado do servidor Zabbix: temos ConfigurationCache, ValueCache, HistoryCache, TrendsCache.  O que √© isso <br><br><img src="https://habrastorage.org/webt/6j/4e/_a/6j4e_acyhx8ldzgjfziqhuzvwz0.jpeg"><br><br>  O ConfigurationCache √© o principal cache no qual armazenamos m√©tricas, hosts, itens de dados, gatilhos;  tudo o que voc√™ precisa para processar o pr√©-processamento, coletar dados, de quais hosts coletar, com que frequ√™ncia.  Tudo isso √© armazenado no ConfigurationCache, para n√£o ir ao banco de dados, nem criar solicita√ß√µes desnecess√°rias.  Ap√≥s o in√≠cio do servidor, atualizamos esse cache (criamos) e periodicamente (dependendo das configura√ß√µes). <br><br><img src="https://habrastorage.org/webt/q1/zc/dg/q1zcdgan2c5rcep47ebef24xrn0.jpeg"><br><br><h3>  Armazenamento em cache no Zabbix.  Coleta de dados </h3><br>  Aqui o esquema √© bastante grande: <br><br><img src="https://habrastorage.org/webt/88/mh/gd/88mhgd974zcj8eou8kghhodhwf0.jpeg"><br><br>  Os principais no esquema s√£o esses coletores: <br><br><img src="https://habrastorage.org/webt/2y/co/f7/2ycof750qb71iooc2qiahs-5i9y.jpeg"><br><br>  Estes s√£o os pr√≥prios processos de montagem, v√°rios ‚Äúpesquisadores‚Äù respons√°veis ‚Äã‚Äãpor diferentes tipos de montagem.  Eles coletam dados via icmp, ipmi, de acordo com diferentes protocolos e transferem tudo para o pr√©-processamento. <br><br><h3>  Hist√≥rico de Pr√©-ProcessamentoCache </h3><br>  Al√©m disso, se tivermos calculado elementos de dados (quem conhece o Zabbix - sabe), ou seja, calculados, elementos de dados agregados, n√≥s os retiramos diretamente do ValueCache.  Sobre como √© preenchido, direi mais tarde.  Todos esses coletores usam o ConfigurationCache para obter seus trabalhos e depois transmiti-los ao pr√©-processamento. <br><br><img src="https://habrastorage.org/webt/b4/qb/mh/b4qbmhsqtxvrfli40n-espjba6c.jpeg"><br><br>  O pr√©-processamento tamb√©m usa o ConfigurationCache para obter etapas de pr√©-processamento; processa esses dados de v√°rias maneiras.  A partir da vers√£o 4.2, n√≥s a submetemos ao proxy.  Isso √© muito conveniente, porque o pr√©-processamento √© uma opera√ß√£o bastante dif√≠cil.  E se voc√™ possui um "Zabbix" muito grande, com um grande n√∫mero de elementos de dados e uma alta frequ√™ncia de coleta, isso facilita muito o trabalho. <br><br>  Assim, depois de processarmos esses dados de alguma maneira usando o pr√©-processamento, salvamos no HistoryCache para process√°-los ainda mais.  Isso encerra a coleta de dados.  Passamos ao processo principal. <br><br><h3>  Opera√ß√£o do sincronizador de hist√≥rico </h3><br><img src="https://habrastorage.org/webt/40/yj/9-/40yj9-h-hgm5wcd2hu2ygt5uyp4.jpeg"><br><br>  O principal processo no Zabbix (uma vez que √© uma arquitetura monol√≠tica) √© o sincronizador de Hist√≥ria.  Este √© o processo principal que lida especificamente com o processamento at√¥mico de cada elemento de dados, ou seja, de cada valor: <br><br><ul><li>  valor vem (√© usado no HistoryCache); </li><li>  verifica no Configuration syncer: existem gatilhos para o c√°lculo? calcula-os; <br>  se houver, ele cria eventos, cria uma escala√ß√£o para criar um alerta, se necess√°rio por configura√ß√£o; </li><li>  registra gatilhos para processamento subseq√ºente, agrega√ß√£o;  se voc√™ agrega na √∫ltima hora e assim por diante, esse valor lembra ValueCache, para n√£o ir para a tabela de hist√≥rico;  Assim, o ValueCache √© preenchido com os dados necess√°rios para o c√°lculo de gatilhos, elementos calculados, etc. </li><li>  o sincronizador de hist√≥rico grava todos os dados no banco de dados; </li><li>  o banco de dados os grava no disco - √© aqui que o processo de processamento termina. </li></ul><br><h3>  Bases de dados  Armazenamento em cache </h3><br>  No lado do banco de dados, quando voc√™ deseja visualizar gr√°ficos ou algum tipo de relat√≥rio de evento, existem v√°rios caches.  Mas, como parte deste relat√≥rio, n√£o vou falar sobre eles. <br><br>  Para o MySQL, existe o Innodb_buffer_pool, um monte de caches diferentes que tamb√©m podem ser configurados. <br>  Mas estes s√£o os principais: <br><br><ul><li>  shared_buffers; </li><li>  effective_cache_size; </li><li>  shared_pool. </li></ul><br><img src="https://habrastorage.org/webt/fw/7n/0z/fw7n0ziowm_jbvs--peokkswjdw.jpeg"><br><br>  Eu citei para todos os bancos de dados que existem certos caches que permitem manter na mem√≥ria os dados que geralmente s√£o necess√°rios para consultas.  L√° eles t√™m suas pr√≥prias tecnologias para isso. <br><br><h3>  Sobre o desempenho do banco de dados </h3><br>  Consequentemente, existe um ambiente competitivo, ou seja, o servidor Zabbix coleta dados e os registra.  Ao reiniciar, ele tamb√©m l√™ o hist√≥rico para preencher o ValueCache e assim por diante.  Aqui voc√™ pode ter scripts e relat√≥rios que usam a API do Zabbix, que √© criada com base na interface da web.  O "Zabbiks" -API √© inclu√≠do no banco de dados e recebe os dados necess√°rios para obter gr√°ficos, relat√≥rios ou alguma lista de eventos, problemas recentes. <br><br><img src="https://habrastorage.org/webt/gr/to/vp/grtovpkr0x6kkytkg5bw2zllpqw.jpeg"><br><br>  Uma solu√ß√£o de visualiza√ß√£o muito popular √© o Grafana, usado por nossos usu√°rios.  Capaz de inserir diretamente atrav√©s do "Zabbiks" -API e atrav√©s do banco de dados.  Ele tamb√©m cria uma certa competi√ß√£o pela obten√ß√£o de dados: √© necess√°rio um ajuste melhor e mais preciso do banco de dados para corresponder √† entrega r√°pida de resultados e testes. <br><br><img src="https://habrastorage.org/webt/aj/ak/l-/ajakl-q1nyal8mce-xw4snwrgye.jpeg"><br><br><h3>  Limpar hist√≥rico.  Zabbix tem governanta </h3><br>  O terceiro desafio usado pelo Zabbix √© esclarecer a hist√≥ria com a governanta.  O Hauskiper est√° em conformidade com todas as configura√ß√µes, ou seja, em nossos elementos de dados, √© indicado quanto armazenar (em dias), quanto armazenar tend√™ncias, a din√¢mica das mudan√ßas. <br><br>  N√£o falei sobre o TrendCache, que calculamos em tempo real: os dados chegam, agregamos em uma hora (basicamente esses s√£o os n√∫meros da √∫ltima hora), a quantidade m√©dia / m√≠nima e anotamos uma vez por hora na tabela de din√¢mica de altera√ß√µes (Trends) .  O Hauskiper inicia e exclui dados do banco de dados usando sele√ß√µes regulares, o que nem sempre √© eficaz. <br><br>  Como entender que √© ineficiente?  Voc√™ pode ver a figura a seguir nos gr√°ficos de desempenho de processos internos: <br><br><img src="https://habrastorage.org/webt/cw/au/u3/cwauu3n4dk0-u_nonnfzbf0og6g.jpeg"><br><br>  Seu sincronizador de hist√≥rico est√° constantemente ocupado (gr√°fico vermelho).  E o gr√°fico "vermelho" que fica no topo.  Este √© o Hauskiper, que inicia e aguarda o banco de dados quando ele exclui todas as linhas especificadas. <br><br>  Pegue um c√≥digo de item: voc√™ precisa excluir os √∫ltimos 5 mil;  Claro, por √≠ndices.  Mas geralmente o conjunto de dados √© grande o suficiente - o banco de dados ainda l√™ isso do disco e o eleva para o cache, e essa √© uma opera√ß√£o muito cara para o banco de dados.  Dependendo do tamanho, isso pode levar a certos problemas de desempenho. <br><br>  Voc√™ pode desativar o Hauskiper de uma maneira simples - n√≥s temos uma interface web familiar para todos.  Definindo em Administra√ß√£o geral (configura√ß√µes para "Governanta"), desabilitamos as tarefas dom√©sticas internas para o hist√≥rico e as tend√™ncias internas.  Assim, Hauskiper n√£o controla mais isso: <br><br><img src="https://habrastorage.org/webt/cp/si/jo/cpsijomx2kl2p1trw0it8ujvpga.jpeg"><br><br>  O que posso fazer a seguir?  Voc√™ desconectou, seus agendamentos subiram de n√≠vel ... Que problemas podem ser maiores nesse caso?  O que pode ajudar? <br><br><h3>  Particionamento (particionamento) </h3><br>  Isso geralmente √© configurado em todos os bancos de dados relacionais listados de uma maneira diferente.  O MySQL possui sua pr√≥pria tecnologia.  Mas no geral eles s√£o muito parecidos quando se trata de PostgreSQL 10 e MySQL.  Obviamente, existem muitas diferen√ßas internas em como tudo √© implementado e como tudo isso afeta o desempenho.  Mas, em geral, a cria√ß√£o de uma nova parti√ß√£o tamb√©m costuma levar a certos problemas. <br><br><img src="https://habrastorage.org/webt/g3/ru/gs/g3rugs9kazu4fcyk70inqtrnrd4.jpeg"><br><br>  Dependendo da sua configura√ß√£o (quantos dados voc√™ cria em um dia), eles geralmente definem o m√≠nimo de 1 dia / parti√ß√£o e, para tend√™ncias, a din√¢mica das altera√ß√µes - 1 m√™s / nova parti√ß√£o.  Isso pode mudar se voc√™ tiver uma configura√ß√£o muito grande. <br><br>  Digamos imediatamente sobre o tamanho da configura√ß√£o: at√© 5 mil novos valores por segundo (os chamados nvps) - isso ser√° considerado uma pequena "configura√ß√£o".  M√©dia - de 5 a 25 mil valores por segundo.  Tudo o que est√° acima j√° √© instala√ß√µes grandes e muito grandes que requerem uma configura√ß√£o muito cuidadosa do pr√≥prio banco de dados. <br><br>  Em instala√ß√µes muito grandes, 1 dia - isso pode n√£o ser o ideal.  Eu pessoalmente vi no MySQL parti√ß√µes de 40 gigabytes por dia (e pode haver mais).  Essa √© uma quantidade muito grande de dados, que pode levar a alguns problemas.  Precisa ser reduzido. <br><br><h3>  Por que particionar? </h3><br>  O que o particionamento fornece, acho que todo mundo sabe, √© o particionamento de tabelas.  Geralmente, esses s√£o arquivos separados em solicita√ß√µes de disco e extens√£o.  Ele seleciona de maneira mais otimizada uma parti√ß√£o, se isso faz parte da parti√ß√£o usual. <br><br><img src="https://habrastorage.org/webt/nd/u2/6a/ndu26acwf_st_axq0rfws4t0yhu.jpeg"><br><br>  Para o Zabbix, em particular, ele √© usado por faixa, por faixa, ou seja, usamos um registro de data e hora (o n√∫mero √© comum, o hor√°rio desde o in√≠cio da √©poca).  Voc√™ especifica o in√≠cio do dia / fim do dia e esta √© uma parti√ß√£o.  Portanto, se voc√™ est√° solicitando dados h√° dois dias, tudo isso √© selecionado no banco de dados mais rapidamente, porque voc√™ s√≥ precisa enviar um arquivo para o cache e emitir (em vez de uma tabela grande). <br><br><img src="https://habrastorage.org/webt/n8/-5/h0/n8-5h0inf3gdrt6fv2jaqeguoxm.jpeg"><br><br>  Muitos bancos de dados tamb√©m aceleram a inser√ß√£o (inser√ß√£o em uma √∫nica tabela filho).  Enquanto eu falo abstratamente, mas tamb√©m √© poss√≠vel.  Particionar muitas vezes ajuda. <br><br><h3>  Elasticsearch para NoSQL </h3><br>  Recentemente, na 3.4, implementamos uma solu√ß√£o para NoSQL.  Adicionada a capacidade de escrever no Elasticsearch.  Voc√™ pode escrever alguns tipos separados: escolha - escreva n√∫meros ou alguns sinais;  temos texto de string, voc√™ pode escrever logs no Elasticsearch ... Assim, a interface da web tamb√©m acessar√° o Elasticsearch.  Isso funciona bem em alguns casos, mas no momento pode ser usado. <br><br><img src="https://habrastorage.org/webt/xq/f_/kc/xqf_kcj7pttjfkqtvykodkhf1ne.jpeg"><br><br><h3>  TimescaleDB.  Hypertables </h3><br>  Para a 4.4.2, notamos uma coisa como o TimescaleDB.  O que √© isso  Esta √© uma extens√£o para o Postgres, ou seja, possui uma interface nativa do PostgreSQL.  Al√©m disso, esta extens√£o permite trabalhar com dados de s√©ries temporais com muito mais efici√™ncia e ter particionamento autom√°tico.  Como √©: <br><br><img src="https://habrastorage.org/webt/_q/nk/mz/_qnkmz4mbfzhveegk3d2hjzgafg.jpeg"><br><br>  Isso √© hipertabela - existe esse conceito na escala de tempo.  Essa √© a hipertabela que voc√™ cria e cont√©m partes.  Peda√ßos s√£o parti√ß√µes, essas s√£o tabelas filho, se n√£o me engano.  √â realmente eficaz. <br><br><img src="https://habrastorage.org/webt/un/gu/pk/ungupk6uffgezcunuoaa4tjkk0g.jpeg"><br><br><h3>  TimescaleDB e PostgreSQL </h3><br>  Como os fabricantes do TimescaleDB asseguram, eles usam um algoritmo de processamento de solicita√ß√£o mais correto, em particular insert'ov, que permite que voc√™ tenha desempenho aproximadamente constante com um tamanho crescente da inser√ß√£o do conjunto de dados.  Ou seja, ap√≥s 200 milh√µes de linhas do "Postgres", o normal come√ßa a cair muito e perde o desempenho literalmente para zero, enquanto o "Timescale" permite inserir inser√ß√µes da maneira mais eficiente poss√≠vel com qualquer quantidade de dados. <br><br><img src="https://habrastorage.org/webt/xo/zb/-o/xozb-o86ammklruo6wbmreoddga.jpeg"><br><br><h3>  Como instalar o TimescaleDB?  Tudo √© simples! </h3><br>  Ele est√° na documenta√ß√£o, est√° descrito - pode ser entregue a partir de pacotes para qualquer ... Depende dos pacotes oficiais do Postgres.  Pode ser compilado manualmente.  Aconteceu que eu tive que compilar para o banco de dados. <br><br><img src="https://habrastorage.org/webt/vm/t8/ab/vmt8ab42ehsl-ne-cxb70skn9ik.jpeg"><br><br>  No Zabbix, apenas ativamos a extens√£o.  Eu acho que aqueles que usaram o Extention no Postgres ... Voc√™ acabou de ativar o Extention, crie-o para o banco de dados do Zabbix que voc√™ usa. <br><br>  E o √∫ltimo passo ... <br><br><h3>  TimescaleDB.  Tabelas de hist√≥rico de migra√ß√£o </h3><br>  Voc√™ precisa criar uma hipertabela.  H√° uma fun√ß√£o especial para isso - Criar hipertabela.  Nele, o primeiro par√¢metro indica a tabela necess√°ria neste banco de dados (para a qual voc√™ precisa criar uma hipertabela). <br><br><img src="https://habrastorage.org/webt/rs/p0/ja/rsp0ja0xplwviw9abiqvsody8zw.jpeg"><br><br>  O campo pelo qual voc√™ deseja criar e chunk_time_interval (este √© o intervalo de chunks (parti√ß√µes a serem usadas). 86.400 √© de um dia. <br><br>  Par√¢metro migrate_data: se voc√™ inserir true, isso transferir√° todos os dados atuais para os peda√ßos criados anteriormente. <br><br>  Eu mesmo usei migrate_data - leva uma quantidade decente de tempo, dependendo do tamanho do seu banco de dados.  Eu tinha mais de um terabyte - a cria√ß√£o levou mais de uma hora.  Em alguns casos, ao testar, exclu√≠ os dados hist√≥ricos do texto (history_text) e da string (history_str), para n√£o transferi-los - eles n√£o eram realmente interessantes para mim. <br><br>  E fazemos a √∫ltima atualiza√ß√£o em nossa db_extention: configuramos timescaledb para que o banco de dados e, em particular, nosso Zabbix entendam o que √© db_extention.  Ele o ativa e usa a sintaxe correta e as consultas ao banco de dados, usando os ‚Äúrecursos‚Äù necess√°rios para o TimescaleDB. <br><br><h3>  Configura√ß√£o do servidor </h3><br>  Eu usei dois servidores.  O primeiro servidor √© uma m√°quina virtual pequena o suficiente, 20 processadores, 16 gigabytes de RAM.  Configure o Postgres 10.8: <br><br><img src="https://habrastorage.org/webt/q_/h-/fe/q_h-fey52vutiin_dcat3zezb1g.jpeg"><br><br>  O sistema operacional era o Debian, o sistema de arquivos era xfs.  Fiz configura√ß√µes m√≠nimas para usar esse banco de dados espec√≠fico, menos o que o Zabbix usar√°.  Na mesma m√°quina, havia um servidor Zabbix, PostgreSQL e agentes de carregamento. <br><br><img src="https://habrastorage.org/webt/vl/jv/bu/vljvbuggjlj1vz5tvptvzsicauo.jpeg"><br><br>  Usei 50 agentes ativos que usam o LoadableModule para gerar rapidamente v√°rios resultados.  Eles geraram linhas, n√∫meros e assim por diante.  Entupi o banco de dados com muitos dados.  Inicialmente, a configura√ß√£o continha 5 mil elementos de dados por host e aproximadamente cada elemento de dados continha um gatilho - para que fosse uma configura√ß√£o real.  √Äs vezes, √© preciso at√© mais de um gatilho para usar. <br><br><img src="https://habrastorage.org/webt/9e/z0/os/9ez0os1zg6wv3k3d176svhoauqe.jpeg"><br><br>  Regulei o intervalo de atualiza√ß√£o, a carga em si, para n√£o apenas usar 50 agentes (adicionados mais), mas tamb√©m usar elementos de dados din√¢micos e reduzir o intervalo de atualiza√ß√£o para 4 segundos. <br><br><h3>  Teste de desempenho.  PostgreSQL: 36 mil NVPs </h3><br>  O primeiro lan√ßamento, a primeira configura√ß√£o que tive no PostreSQL 10 puro neste hardware (35 mil valores por segundo).  Em geral, como voc√™ pode ver na tela, a inser√ß√£o de dados leva fra√ß√µes de segundo - tudo est√° bem e r√°pido, SSDs (200 gigabytes).  A √∫nica coisa √© que 20 GB s√£o preenchidos rapidamente. <br><br><img src="https://habrastorage.org/webt/st/er/oh/sterohufqkrwjzwicbau9fxyeg8.jpeg"><br><br>  Haver√° muitos mais desses gr√°ficos.  Este √© o painel de desempenho padr√£o do servidor Zabbix. <br><br><img src="https://habrastorage.org/webt/2m/31/jy/2m31jys-j4bm3ocrwo7bqtp5ftu.jpeg"><br><br>  O primeiro gr√°fico √© o n√∫mero de valores por segundo (azul, canto superior esquerdo), 35 mil valores neste caso.  Este (centro de carregamento) √© o carregamento de processos de montagem e este (superior direito) √© o carregamento de processos internos: sincronizadores de hist√≥rico e governanta, que est√£o em execu√ß√£o aqui h√° um tempo suficiente. <br><br>  Este gr√°fico (parte inferior central) mostra o uso do ValueCache - quantas ocorr√™ncias do ValueCache para acionadores (v√°rios milhares de valores por segundo).  Outro gr√°fico importante √© o quarto (canto inferior esquerdo), que mostra o uso do HistoryCache, sobre o qual eu falei, que √© um buffer antes de inserir no banco de dados. <br><br><h3>  Teste de desempenho.  PostgreSQL: 50 mil NVPs </h3><br>  Em seguida, aumentei a carga para 50 mil valores por segundo no mesmo hardware.  Ao carregar com o Hauskiper, 10 mil valores j√° foram registrados em 2-3 segundos com o c√°lculo.  Que, de fato, √© mostrado na seguinte captura de tela: <br><br><img src="https://habrastorage.org/webt/z7/ml/st/z7mlstfkfw8weobkfvj83zxy4w4.jpeg"><br><br>  Hauskiper j√° est√° come√ßando a interferir no trabalho, mas em geral o carregamento de ca√ßadores de afundadores de hist√≥ria ainda est√° em 60% (terceiro gr√°fico, canto superior direito).  O HistoryCache j√° durante o trabalho de "Hauskiper" come√ßa a ser preenchido ativamente (canto inferior esquerdo).  Era cerca de meio gigabyte, preenchido a 20%. <br><br><img src="https://habrastorage.org/webt/mk/-k/q4/mk-kq4jre2iwk-6fdt9xlejoaje.jpeg"><br><br><h3>  Teste de desempenho.  PostgreSQL: 80 mil NVPs </h3><br>  Aumentou ainda mais para 80 mil valores por segundo: <br><br><img src="https://habrastorage.org/webt/7g/zj/jq/7gzjjqaa68jpj_9yltg7mhfvz0a.jpeg"><br><br>  Foram aproximadamente 400 mil elementos de dados, 280 mil gatilhos.  A inser√ß√£o, como voc√™ pode ver, para o carregamento de chumbadas hist√≥ricas (havia 30 delas) j√° era bastante alta.  Al√©m disso, aumentei v√°rios par√¢metros: hist√≥rico-afundadores, cache ... Nesse hardware, o carregamento dos afundadores de hist√≥ria come√ßou a aumentar ao m√°ximo, quase "at√© a prateleira" - de acordo com isso, o HistoryCache passou a uma carga muito alta: <br><br><img src="https://habrastorage.org/webt/xd/3z/ky/xd3zkydh5zu-vkewwstgk12qc-s.jpeg"><br><br>          (  ,  )  ,      ‚Äì         ,    . ¬´¬ª        ,       , ‚Ä¶ <br><br><img src="https://habrastorage.org/webt/d7/3l/2z/d73l2zoa7tqmhkjoji9z4hx1poy.jpeg"><br><br>    ,    48  128   : <br><br><img src="https://habrastorage.org/webt/-x/-b/9d/-x-b9dzzor5kwaba8sloo01yhk0.jpeg"><br><br>    ¬´¬ª ‚Äì  History syncer (60 )    .    ¬´ ¬ª,   , ,  ,    -   . <br><br><h3>  . TimescaleDB: 80  NVPs </h3><br>      ‚Äì  TimescaleDB.     : <br><br><img src="https://habrastorage.org/webt/zr/2l/hb/zr2lhbdocfwqknn3sgd_4agzsus.jpeg"><br><br>   ‚Äì    .    ¬´¬ª-   -,   ,   .    3         HistoryCache ‚Äì ,      .  , 80     ‚Äì    rate (,   ¬´¬ª).      setup,   . <br><br><h3>   PostgreSQL: 120  NVPs </h3><br>              125   : <br><br><img src="https://habrastorage.org/webt/cd/ay/e6/cdaye6egnxctvuobxadw6hf7bhw.jpeg"><br><br>    : <br><br><img src="https://habrastorage.org/webt/ts/di/fg/tsdifgr_chfu20nox8il6o2dtha.jpeg"><br><br>     setup,      .          1,5 ,       .  ,         TimescaleDB,       ,     MySQL. <br><br>    ,          ,     .     !    ‚Äì   TimescaleDB.   : 120    . <br><br>    ¬´¬ª : <br><br><img src="https://habrastorage.org/webt/rz/rn/m-/rzrnm-wfnbq8unwrcvozg8neccy.jpeg"><br><br>    TimescaleDB     io.weight   ;          TimescaleDB.     ,        ( SSD)! <br><br>  -  setup',     , TimescaleDB,   ,   .       ,         . <br><br>      : Conference ‚Äì  , Summit ‚Äì  .    ‚Äì ¬´¬ª, , IRC.     -  ‚Äì     ,    . <br><br><h3>   </h3><br>    ( ‚Äì ): ‚Äì  TimescaleDB    ,      , , ,        ¬´¬ª  ¬´¬ª?    -      ,  -,      ¬´¬ª,     ¬´¬ª,   ¬´¬ª ,        ? <br><br><img src="https://habrastorage.org/webt/5j/k8/og/5jk8ogejgbixfe_a0tfxzh8vbmw.jpeg"><br><br> <b>:</b> ‚Äì ,   ,    :  ¬´¬ª    TimescaleDB.    ,   ,   ,   ¬´¬ª .      ,     ( TimescaleDB),   ,    !    ,        ,  . <br><br>           ¬´¬ª:       - .        ,         .         setup'.    MySQL‚Ä¶   setup'    . <br><br> <b>:</b> ‚Äì   ,   community,    ¬´¬ª: <br><br><img src="https://habrastorage.org/webt/xh/pg/0j/xhpg0jw0a7davjqyru9gqg7xnx8.jpeg"><br><br>   .  ¬´¬ª     TimescaleDB? <br><br> <b>:</b> ‚Äì      ‚Äì      .     TimescaleDB    ,  - .         .      . <br><br> <b>:</b> ‚Äì     ‚Äì      ¬´¬ª. <br>  (  ): ‚Äì      ,      delete,       ‚Äì , ,     .  ¬´¬ª,     ,   .  ,    ,    big data: ¬´!¬ª <br><br> ¬´¬ª  ,     .        ,        select'       ,      ‚Äì ¬´    !¬ª ( ).   !         ,   . <br><br> <b>:</b> ‚Äì     SQL.   , ¬´¬ª     ,    ‚Äì -  .     ,      ,      , ,  ‚Äì Clickhouse, , - -?.. Kafka ‚Äì    !    - ? <br><br> <b>:</b> ‚Äì   .     ¬´¬ª   3.4:        , ,  ;   -      .           .   -     ,      ,       ¬´¬ª.     , , ,   NoSQL- (,  ¬´¬ª)  . <br><br> <b>:</b> ‚Äì , ,     ? <br><br> <b>:</b> ‚Äì ,     ¬´¬ª ‚Äì   ,     ,  .   ,               -   ,     , ,  . <br><br> <b>:</b> ‚Äì  ,     ,    ¬´¬ª, ? <br><br> <b>:</b> ‚Äì   . ,           , ,  ¬´¬ª   ,     .  .    :       .  ‚Äì  ,       ‚Äì Grafana   -. <br><br> <b>:</b> ‚Äì       ,        ? <br><br> <b>:</b> ‚Äì ,  ,    . <br><br> <b>:</b> ‚Äì      RRD?       SQL?    RRD   . <br><br> <b>:</b> ‚Äì  ¬´Zabbix¬ª RRD,  ,     .   SQL-  ‚Äì  .   ‚Äì  MySQL, PostgreSQL (   ).        SQL  RRD     . <br><br><img src="https://habrastorage.org/webt/a4/oi/25/a4oi25ls8s9shibkxhx1ckuxfqk.jpeg"><br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/umRk94j5M8o" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Um pouco de publicidade :) </h3><br>  Obrigado por ficar conosco.  Voc√™ gosta dos nossos artigos?  Deseja ver materiais mais interessantes?  Ajude-nos fazendo um pedido ou recomendando aos seus amigos <a href="https://ua-hosting.company/cloudvps/nl">VPS baseado em nuvem para desenvolvedores a partir de US $ 4,99</a> , um <b>anal√≥gico exclusivo de servidores</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">b√°sicos</a> <b>que foi inventado por n√≥s para voc√™:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">Toda a verdade sobre o VPS (KVM) E5-2697 v3 (6 n√∫cleos) 10GB DDR4 480GB SSD 1Gbps de 10GB de US $ 19 ou como dividir o servidor?</a>  (as op√ß√µes est√£o dispon√≠veis com RAID1 e RAID10, at√© 24 n√∫cleos e at√© 40GB DDR4). <br><br>  <b>Dell R730xd 2 vezes mais barato no data center Equinix Tier IV em Amsterd√£?</b>  Somente temos <b><a href="https://ua-hosting.company/serversnl">2 TVs Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100 TV a partir de US $ 199</a> na Holanda!</b>  <b><b>Dell R420 - 2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB - a partir de US $ 99!</b></b>  Leia sobre <a href="https://habr.com/company/ua-hosting/blog/329618/">Como criar um pr√©dio de infraestrutura.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">classe usando servidores Dell R730xd E5-2650 v4 custando 9.000 euros por um centavo?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt485470/">https://habr.com/ru/post/pt485470/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt485458/index.html">Silencioso obus</a></li>
<li><a href="../pt485460/index.html">20 bibliotecas para um aplicativo iOS espetacular</a></li>
<li><a href="../pt485462/index.html">Lidamos com eSIM (+ entrevista com um especialista)</a></li>
<li><a href="../pt485464/index.html">Meu primeiro jogo html5, de Alice Yandex e premia√ß√µes a aplicativos m√≥veis</a></li>
<li><a href="../pt485468/index.html">Variante de trabalhar com soquetes da Web no iOS no Swift / Escreveu um gerente para trabalhar com o websocket</a></li>
<li><a href="../pt485472/index.html">O que h√° de novo a esperar da AMD?</a></li>
<li><a href="../pt485476/index.html">Tend√™ncias e negocia√ß√£o na bolsa: 4 indicadores populares de an√°lise t√©cnica</a></li>
<li><a href="../pt485480/index.html">Coluna port√°til Z-poject Doublebeef - mono duplo em russo. Testar, desmontar e atualizar</a></li>
<li><a href="../pt485482/index.html">3 problemas na transfer√™ncia de dados para o Google Analytics por meio do Protocolo de avalia√ß√£o</a></li>
<li><a href="../pt485484/index.html">[Locomizer de caso] Que conhecimento pode realmente ser extra√≠do de um conjunto de dados an√¥nimo com coordenadas do usu√°rio</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>