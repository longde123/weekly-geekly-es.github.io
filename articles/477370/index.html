<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüöí üíâ üë®üèΩ‚Äçüç≥ PHP sin servidor üëçüèº üîß üëñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En la v√≠spera del lanzamiento del curso Backend PHP Developer, tuvimos una lecci√≥n abierta tradicional . Esta vez nos familiarizamos con el concepto S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP sin servidor</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/477370/"><p>  En la v√≠spera del lanzamiento del curso <a href="https://otus.pw/PjYz/">Backend PHP Developer,</a> tuvimos una <a href="https://www.youtube.com/watch%3Fv%3DcGBggTdDmKI">lecci√≥n abierta tradicional</a> .  Esta vez nos familiarizamos con el concepto Serverless, hablamos sobre su implementaci√≥n en AWS, discutimos los principios de operaci√≥n, ensamblaje y lanzamiento, y tambi√©n construimos un simple PHP TG-bot basado en AWS Lambda. </p><br><p>  Profesor - <a href="https://otus.ru/teacher/491/">Alexander Pryakhin</a> , CTO de Westwing Rusia. </p><br><hr><br><p><img src="https://habrastorage.org/webt/fm/-y/de/fm-yde0vvpixphwgwoqfsumq-n4.jpeg"></p><a name="habracut"></a><br><h2 id="kratkiy-ekskurs-v-istoriyu">  Una breve excursi√≥n a la historia. </h2><br><p><img src="https://habrastorage.org/webt/w7/jh/mk/w7jhmkufvziqczxd8ppmbgjylpy.png"></p><br><p>  ¬øC√≥mo llegamos a tal vida que apareci√≥ la inform√°tica sin servidor?  Por supuesto, aparecieron no solo as√≠, sino que se convirtieron en una continuaci√≥n l√≥gica de las tecnolog√≠as de virtualizaci√≥n existentes. </p><br><p><img src="https://habrastorage.org/webt/am/jv/dt/amjvdt02rv2bv7_-yhbexlhejm0.png"></p><br><p>  ¬øQu√© solemos virtualizar?  Por ejemplo, un procesador.  Tambi√©n puede virtualizar la memoria resaltando ciertas √°reas de la memoria y haci√©ndolas accesibles para algunos usuarios e inaccesibles para otros.  Puede virtualizar una red VPN.  Y as√≠ sucesivamente. </p><br><p><img src="https://habrastorage.org/webt/il/2o/p_/il2op_dxfloq7om6r_czugnhebq.png"></p><br><p>  La virtualizaci√≥n es buena porque utilizamos mejor los recursos y aumentamos la productividad.  Pero tambi√©n hay desventajas, por ejemplo, en un momento hubo problemas de compatibilidad.  Sin embargo, pr√°cticamente no hay arquitecturas que sean incompatibles con las m√°quinas virtuales modernas. </p><br><p>  El siguiente inconveniente es que agregamos una capa adicional de abstracci√≥n, agregamos un hipervisor, agregamos una m√°quina virtual por s√≠ misma y, por supuesto, podemos perder un poco de velocidad.  Algo complicado y el uso del servidor. </p><br><p><img src="https://habrastorage.org/webt/yh/on/4j/yhon4j0ial2rlrdfq_grqgx6yjw.png"></p><br><p>  Si llevamos una m√°quina virtual est√°ndar con usted, se ver√° m√°s o menos as√≠: </p><br><p><img src="https://habrastorage.org/webt/rq/ii/at/rqiiat114asa0rziaowjsjp1amg.png"></p><br><p> En primer lugar, tenemos un servidor de hierro y, en segundo lugar, el sistema operativo en el que girar√° nuestro hipervisor.  Y adem√°s de todo esto, nuestras m√°quinas virtuales est√°n girando, en las que hay un sistema operativo invitado, bibliotecas y aplicaciones.  Si piensas l√≥gicamente, entonces vemos algunos gastos generales en presencia del sistema operativo invitado, porque de hecho gastamos recursos adicionales. </p><br><p>  ¬øC√≥mo puedo resolver el problema general?  Rechazar m√°quinas virtuales y colocar un sistema de administraci√≥n de contenedores encima del sistema operativo principal.  Por supuesto, el sistema m√°s popular ahora es el motor Docker.  Luego, las bibliotecas dentro del contenedor utilizar√°n el n√∫cleo del host del sistema operativo. </p><br><p><img src="https://habrastorage.org/webt/rb/wv/ce/rbwvceyh5h8mrsgsst9bu8acadk.png"></p><br><p>  De esta manera, eliminamos la sobrecarga, pero Docker tampoco es ideal, y tiene sus propios problemas y caracter√≠sticas de trabajo que no le gustan a todos. </p><br><p>  Lo principal a entender es que Docker y la m√°quina virtual son enfoques diferentes, y no hay necesidad de igualarlos.  Docker no es un microvirtual con el que puede trabajar como con una m√°quina virtual, porque el contenedor es para eso y el contenedor.  Pero el contenedor nos permite proporcionar flexibilidad y un enfoque completamente diferente a la entrega continua, cuando entregamos cosas a la producci√≥n y entendemos que ya est√°n probados y funcionando. </p><br><h2 id="oblachnye-tehnologii">  Tecnolog√≠a en la nube </h2><br><p>  Con el desarrollo adicional de la virtualizaci√≥n, las tecnolog√≠as en la nube tambi√©n comenzaron a desarrollarse.  Esta es una buena soluci√≥n, pero vale la pena mencionar de inmediato que las nubes no son una bala de plata ni una panacea para todos los males.  Aqu√≠ uno no puede evitar recordar una famosa cita: </p><br><blockquote>  "Cuando escucho a alguien promocionando la nube como una bala m√°gica para todos los problemas inform√°ticos, silenciosamente reemplazo" nube "con" payaso "y contin√∫o con una sonrisa zen". <br>  Amy rica </blockquote><p>  Sin embargo, para las empresas medianas que desean recibir un cierto nivel de servicio y tolerancia a fallas sin grandes inyecciones financieras, las nubes son una gran opci√≥n.  Y para muchas empresas, mantener su centro de datos con el mismo SLA ser√° mucho m√°s costoso que ser atendido en la nube.  Adem√°s, podemos usar las nubes para nuestras necesidades, ya que proporcionan algunas cosas con solo unos pocos clics del mouse, lo cual es muy conveniente.  Por ejemplo, la capacidad de levantar una m√°quina virtual o red en unos pocos clics. <br>  S√≠, existen restricciones, por ejemplo, la 152a Ley Federal que proh√≠be el almacenamiento de datos personales en el extranjero, por lo que el mismo Amazon no ser√° adecuado para nosotros durante una auditor√≠a.  No te olvides de Vendor-lock.  Muchas soluciones en la nube no se transfieren entre s√≠, aunque la mayor√≠a de los proveedores admiten el mismo almacenamiento compatible con S3. </p><br><p>  Las nubes nos brindan la oportunidad de recibir diferentes niveles de servicio sin un conocimiento limitado.  Cuanto menos conocimiento necesite, m√°s pagaremos.  En la figura siguiente, puede ver la pir√°mide, donde, de abajo hacia arriba, se muestra la disminuci√≥n de los requisitos de conocimiento t√©cnico al usar la nube: </p><br><p><img src="https://habrastorage.org/webt/ro/hi/aj/rohiajoeei87pirilzujxcaelqs.png"></p><br><h2 id="serverless-i-faas-function-as-a-service">  Sin servidor y FaaS (Funci√≥n como servicio) </h2><br><p>  Sin servidor es una forma bastante joven de ejecutar scripts en las nubes, por ejemplo, como AWS (en t√©rminos de AWS, el servidor se implementa en Lambda).  Los enfoques * aaS enumerados en la pir√°mide anterior ya son familiares: IaaS (EC2, VDS), PaaS (Hosting compartido), SaaS (Office 365, Tilda).  Entonces, Serverless es una implementaci√≥n del enfoque FaaS.  Y este enfoque consiste en proporcionar al usuario una plataforma preparada para el desarrollo, lanzamiento y administraci√≥n de ciertas funciones sin la necesidad de preparaci√≥n y configuraci√≥n. </p><br><p>  Imagine que tiene una m√°quina que se dedica al procesamiento nocturno de documentos, realiza tareas de 00:00 a 6:00, y durante el resto de las horas est√° inactiva.  La pregunta es: ¬øpor qu√© pagar durante el d√≠a?  ¬øY por qu√© no usar recursos gratuitos para otra cosa?  Este deseo de optimizaci√≥n y el deseo de gastar dinero solo en lo que realmente usa, condujo a la aparici√≥n de FaaS. </p><br><p>  Sin servidor es un recurso para ejecutar c√≥digo y nada m√°s.  Esto no significa que no haya un servidor detr√°s de nuestro script, lo es, pero, de hecho, no tenemos ning√∫n recurso asignado espec√≠ficamente en el que se lanzar√° nuestro Lambda.  Cuando ejecutamos nuestro script, la micro-infraestructura se despliega inmediatamente debajo de √©l, y este no es su problema en principio: solo piensa que tiene el c√≥digo ejecutado y no necesita pensar en nada m√°s. <br>  Esto requiere, por supuesto, un cierto enfoque para el desarrollo de su c√≥digo.  Por ejemplo, no puede almacenar nada en este entorno, debe eliminarlo todo.  Si se trata de datos, se necesita una base de datos externa, si es un registro, luego un servicio de registro externo, si es un archivo, luego un almacenamiento de archivos externo.  Afortunadamente, cualquier proveedor sin servidor proporciona la capacidad de conectarse a sistemas externos. </p><br><p>  Solo tienes c√≥digo, trabajas en el paradigma sin estado, no tienes estado.  Para el mismo mundo de PHP, esto significa, por ejemplo, que puede olvidarse del mecanismo de sesi√≥n est√°ndar.  En principio, incluso puede construir su Serverless, y recientemente en Habr√© hab√≠a <a href="https://habr.com/ru/company/southbridge/blog/475044/">un art√≠culo sobre este tema</a> . </p><br><p>  La idea principal de Serverless es que la infraestructura no requiere soporte del equipo.  Todo recae sobre los hombros de la plataforma, por lo que, de hecho, pagas dinero.  De las desventajas: usted no controla el entorno de ejecuci√≥n y no sabe d√≥nde se realiza lo que se realiza. </p><br><p>  Entonces sin servidor: </p><br><ul><li>  no significa ausencia f√≠sica del servidor; </li><li>  no es un asesino de virtualoks y Docker; </li><li>  No exagero aqu√≠ y ahora. <br>  Sin servidor debe ser empujado consciente y deliberadamente.  Por ejemplo, si necesita probar r√°pidamente una hip√≥tesis sin involucrar a la mitad del equipo.  Entonces obtienes Function As A Service.  La funci√≥n responder√° a algunos eventos, y dado que hay una reacci√≥n a los eventos, estos eventos deben ser llamados por algo; para esto, hay muchos desencadenantes en el mismo AWS. </li></ul><br><p>  Caracter√≠sticas de FaaS: </p><br><ul><li>  la infraestructura no requiere configuraci√≥n; </li><li>  Modelo de evento "fuera de la caja"; </li><li>  Ap√°trida; </li><li>  El escalado es muy f√°cil y se realiza autom√°ticamente de acuerdo con las necesidades del usuario. </li></ul><br><h2 id="aws-lambda">  AWS Lambda </h2><br><p>  La primera implementaci√≥n de FaaS disponible p√∫blicamente es AWS Lambda.  Si es una tesis, entonces tiene las siguientes caracter√≠sticas: <br>  - disponible desde 2014; <br>  - soporta Java, Node.js, Python, Go y tiempos de ejecuci√≥n personalizados listos para usar; <br>  - pagamos por: <br>  n√∫mero de llamadas; <br>  plazo de entrega <br>  AWS Lambda: por qu√© es necesario: <br>  Eliminaci√≥n  Paga solo por el tiempo cuando el servicio se est√° ejecutando. <br>  Velocidad.  Lambda se eleva y trabaja muy r√°pido. <br>  Funcional  Lambda tiene muchas caracter√≠sticas para integrarse con los servicios de AWS. <br>  Rendimiento  Poner una lambda es bastante dif√≠cil.  En paralelo, se puede realizar seg√∫n la regi√≥n desde un m√°ximo de 1000 a 3000 copias.  Y si lo desea, este l√≠mite puede incrementarse escribiendo apoyo. </p><br><p>  Tenemos un cuerpo lambda, un editor en l√≠nea, VPC como una cuadr√≠cula virtual de c√°lculos, registros, el c√≥digo en s√≠, variables de entorno y desencadenantes que causan lambda (por cierto, el control de versiones funciona muy bien).  Excelente anatom√≠a Lambda se describe en <a href="https://habr.com/ru/post/457100/">este art√≠culo</a> . </p><br><p>  El c√≥digo se almacena en el cuerpo (si se trata de idiomas admitidos de f√°brica) o en capas.  Tenemos un disparador que llama a la lambda, la lambda lee los entornos temporales, los atrae hacia s√≠ y ejecuta nuestro c√≥digo: </p><br><p><img src="https://habrastorage.org/webt/sr/py/zu/srpyzu9gzq6gfkekd-tbo5zkmyq.png"></p><br><p>  Si tenemos un tiempo de ejecuci√≥n personalizado, tendremos que colocar el c√≥digo en una capa.  Si trabaj√≥ con Docker, entonces la capa de Docker es muy similar a la capa en lambda, una especie de cuasi-dep√≥sito en el que se encuentra nuestro enlace necesario.  All√≠ tenemos el archivo ejecutable del entorno (si estamos hablando de PHP, debe colocar el binario PHP compilado de antemano), el archivo de arranque lambda (ubicado de forma predeterminada) y los scripts directamente llamados que se ejecutar√°n. </p><br><p><img src="https://habrastorage.org/webt/pj/es/fp/pjesfpgl0xix6psx4tqwegms_4m.png"></p><br><p>  Con la entrega, no todo es tan color de rosa: </p><br><p><img src="https://habrastorage.org/webt/xg/qt/km/xgqtkmwgjqrisunlmvwtgym2nkk.png"></p><br><p>  Es decir, se nos ofrece tomar archivos con el c√≥digo, subirlo al archivo zip, subirlo a la capa y ejecutar nuestro c√≥digo.  Es completamente genial que esto se ofrezca en la documentaci√≥n oficial de Amazon. </p><br><p><img src="https://habrastorage.org/webt/w2/ls/vr/w2lsvrvdjcbta6km5boxp3ntsgw.png"></p><br><p>  Por supuesto, esto no corresponde a las realidades modernas y al olor de dos mil√©simas en el aire.  Afortunadamente, personas amables probaron e hicieron varios frameworks, por lo que usaremos el framework Serverless desarrollado en Node.js y que nos permite administrar aplicaciones basadas en AWS Lambda.  Adem√°s, cuando hablamos de implementaci√≥n y desarrollo, por supuesto, realmente no quiero implementar manualmente, pero hay un deseo de hacer algo flexible y automatizado. </p><br><p>  Entonces, necesitamos: <br>  - AWS CLI: interfaz de l√≠nea de comandos para trabajar con servicios de AWS; <br>  - el framework Serverless ya mencionado anteriormente (la versi√≥n de desarrollo es gratuita y su funcionalidad es suficiente para los ojos); <br>  - La biblioteca Bref, necesaria para escribir c√≥digo.  Esta biblioteca se instala utilizando Composer, por lo que el c√≥digo ser√° compatible con cualquier marco.  Una gran soluci√≥n, especialmente teniendo en cuenta que AWS Lambda no admite la llamada a secuencias de comandos PHP listas para usar. </p><br><p><img src="https://habrastorage.org/webt/ke/de/4w/kede4wq7a7kupqj4zheld7ifkp0.png"></p><br><h2 id="nastraivaem-okruzhenie-i-aws">  Personaliza tu entorno y AWS </h2><br><h3 id="aws-cli">  AWS CLI </h3><br><p>  Comencemos creando una cuenta e instalando AWS CLI.  La consola de AWS se basa en Python 2.7+ o 3.4+.  Dado que AWS recomienda la versi√≥n 3 de Python, no discutiremos. <br>  Los siguientes ejemplos son para Ubuntu. </p><br><pre><code class="plaintext hljs">sudo apt-get -y install python3-pip</code> </pre> <br><p>  Luego instale directamente AWS CLI: </p><br><pre> <code class="plaintext hljs">pip3 install awscli --upgrade --user</code> </pre> <br><p>  Verifique la instalaci√≥n: </p><br><pre> <code class="plaintext hljs">aws --version</code> </pre> <br><p>  Ahora necesita conectar AWS CLI a su cuenta.  Puede usar su nombre de usuario y contrase√±a existentes, pero ser√≠a mejor si crea un usuario separado a trav√©s de AWS IAM, defini√©ndole solo los derechos de acceso necesarios.  Llamar a la configuraci√≥n no causar√° problemas: </p><br><pre> <code class="plaintext hljs">aws configure</code> </pre> <br><p>  A continuaci√≥n, necesitar√° AWS Secret y AWS Access Key.  Se pueden obtener en ASW IAM en la pesta√±a "Credenciales de seguridad" (ubicada en la p√°gina del usuario deseado).  El bot√≥n "Crear clave de acceso" ayudar√° a generar claves de acceso.  Mantenlos contigo. </p><br><p><img src="https://habrastorage.org/webt/yn/t3/0q/ynt30qaych_hosd73v0bl3yb51q.png"></p><br><p>  Para registrar un nuevo bot en Telegram, use @BotFather y el comando / newbot.  Como resultado, se le devolver√° el token necesario para conectarse a su bot.  Ci√©rralo tambi√©n. </p><br><p><img src="https://habrastorage.org/webt/mn/db/6_/mndb6_yarkg6ssd1cmfaykayuam.png"></p><br><h3 id="serverless-framework">  Marco sin servidor </h3><br><p>  Para instalar Serverless Framework, necesitar√° una cuenta en <a href="https://serverless.com/">https://serverless.com/</a> . <br>  Despu√©s de completar el registro, procederemos a la instalaci√≥n en nuestra estaci√≥n de trabajo.  Se requerir√° Node.js 6th y superior. </p><br><pre> <code class="plaintext hljs">sudo apt-get -y install nodejs</code> </pre> <br><p>  Para garantizar el lanzamiento correcto en nuestro entorno, seguimos los pasos recomendados: </p><br><pre> <code class="plaintext hljs">mkdir ~/.npm-global export PATH=~/.npm-global/bin:$PATH source ~/.profile npm config set prefix '~/.npm-global'</code> </pre> <br><p>  Tambi√©n agregue: </p><br><pre> <code class="plaintext hljs">~/.npm-global/bin:$PATH</code> </pre> <br><p>  al archivo / etc / environment. <br>  Ahora ponga sin servidor: </p><br><pre> <code class="plaintext hljs">npm install -g serverless</code> </pre> <br><h3 id="aws">  Aws </h3><br><p>  Bueno, es hora de cambiar a la interfaz de AWS y agregar un nombre de dominio.  Creamos una zona AWS Route 53, un registro DNS y un certificado SSL para ello. <br>  Adem√°s, necesita el ELB, que creamos en el servicio EC2 -&gt; Balanceadores de carga.  Por cierto, al crear un ELB, debe seguir todos los pasos del asistente, indicando el certificado creado. </p><br><p>  En cuanto al equilibrador, puede crearlo a trav√©s de la CLI de AWS con el siguiente comando: </p><br><pre> <code class="plaintext hljs">aws elb create-load-balancer --load-balancer-name my-load-balancer --listeners "Protocol=HTTP,LoadBalancerPort=80,InstanceProtocol=HTTP,InstancePort=80" "Protocol=HTTPS,LoadBalancerPort=443,InstanceProtocol=HTTP,InstancePort=80,SSLCertificateId=arn:aws:iam::123456789012:server-certificate/my-server-cert" --subnets subnet-15aaab61 --security-groups sg-a61988c3</code> </pre> <br><p>  Se necesitar√° un equilibrador despu√©s de la primera implementaci√≥n.  En este caso, debe enviarle solicitudes a nuestro dominio.  Para implementar esto, en la configuraci√≥n del registro DNS (campo "Alias ‚Äã‚Äãtarget"), comience a ingresar el nombre del ELB creado.  Como resultado, ver√° una lista desplegable, por lo que queda seleccionar la entrada deseada y guardarla. </p><br><p><img src="https://habrastorage.org/webt/-i/yr/8g/-iyr8gsoknvxwk0nsjvwtiolca0.png"></p><br><p>  Ahora ve al c√≥digo. </p><br><h3 id="pishem-kod">  Escribir un c√≥digo </h3><br><p>  Usaremos Bref para escribir el c√≥digo.  Como se mencion√≥ anteriormente, esta biblioteca se instala utilizando Composer, por lo que el c√≥digo ser√° compatible con cualquier marco.  Por cierto, los desarrolladores ya han descrito el proceso de uso de Bref con <a href="https://bref.sh/docs/frameworks/laravel.html">Laravel</a> y <a href="https://bref.sh/docs/frameworks/symfony.html">Symfony</a> .  Pero es aconsejable que trabajemos en el PHP "desnudo"; esto ayudar√° a comprender mejor la esencia. <br>  Comenzamos con las dependencias: </p><br><pre> <code class="plaintext hljs">{ "require": { "php": "&gt;=7.2", "bref/bref": "^0.5.9", "telegram-bot/api": "*" }, "autoload": { "psr-4": { "App\": "src/" } } }</code> </pre> <br><p>  Escribiremos en PHP 7.2 y versiones posteriores, y para trabajar con Telegram, este shell para la API es adecuado para nosotros: <a href="https://github.com/TelegramBot/Api">https://github.com/TelegramBot/Api</a> .  En cuanto al c√≥digo en s√≠, se colocar√° en el directorio src. </p><br><p>  Entonces, el entorno sin servidor est√° pasando por un di√°logo de consola.  Se requiere una aplicaci√≥n HTTP, y desde el punto de vista de Lambda, esto significar√° que las llamadas de script se ejecutar√°n de la misma manera que Nginx.  La interpretaci√≥n ser√° realizada por PHP-FPM.  En general, esto es m√°s como una llamada de script de consola est√°ndar.  Este es un punto importante, porque sin tener en cuenta esta caracter√≠stica, no podremos llamar a los scripts a trav√©s de HTTP. <br>  Realizamos: </p><br><pre> <code class="plaintext hljs">vendor/bin/bref init</code> </pre> <br><p>  En el cuadro de di√°logo, seleccione el elemento "Aplicaci√≥n HTTP" y no olvide especificar la regi√≥n, ya que la aplicaci√≥n deber√≠a funcionar en la misma regi√≥n en la que funciona el equilibrador. <br>  Despu√©s de la inicializaci√≥n, aparecer√°n 2 archivos nuevos: <br>  index.php - el archivo llamado; <br>  serverless.yml: archivo de configuraci√≥n de implementaci√≥n. <br>  La carpeta .serverless deber√° agregarse inmediatamente a .gitignore (aparecer√° despu√©s del primer intento de implementaci√≥n). </p><br><p>  Una vez que tengamos una aplicaci√≥n web, colocaremos index.php en la carpeta p√∫blica, cambiando inmediatamente a serverless.yml.  As√≠ es como se ver√≠a en nuestra implementaci√≥n: </p><br><pre> <code class="plaintext hljs">#  lambda- service: app #    provider: name: aws #   ! region: eu-central-1 #    runtime: provided # ,  bref  1024.         memoryLimit: 256 #   stage: dev #    environment: BOT_TOKEN: ${ssm:/app/bot-token} #  bref plugins: - ./vendor/bref/bref #  Lambda- functions: #       php-api-dev # service-function-stage api: handler: public/index.php description: '' # in seconds (API Gateway has a timeout of 29 seconds) timeout: 28 layers: - ${bref:layer.php-73-fpm} #     API Gateway events: - http: 'ANY /' - http: 'ANY /{proxy+}' #    environment: MY_VARIABLE: ${ssm:/app/my_variable}</code> </pre> <br><p>  Ahora analicemos las l√≠neas no obvias.  Necesitamos principalmente variables de entorno.  No queremos codificar conexiones de bases de datos, API externas, etc. Si nos conectamos a Telegram, tendremos nuestro propio token, que se recibe de BotFather.  Y no se recomienda almacenar este token en serverless.yml, por lo que es mejor enviarlo al almacenamiento de AWS ssm: </p><br><pre> <code class="plaintext hljs">aws ssm put-parameter --region eu-central-1 --name '/app/my_variable' --type String --value '___BOTFATHER'</code> </pre> <br><p>  Por cierto, nos referimos a √©l en la configuraci√≥n. <br>  Estas variables est√°n disponibles como variables de entorno, y puede acceder a ellas en PHP utilizando la funci√≥n getenv.  Si hablamos de nuestro ejemplo, entonces mantengamos el token bot en el alcance global para simplificar.  Tambi√©n podemos transferir el token al alcance de una sola funci√≥n, y la llamada en s√≠ no cambiar√° a partir de esto. </p><br><p>  Sigamos adelante.  Ahora creemos una clase simple de BotApp: ser√° responsable de generar una respuesta para el bot y responder√° a los comandos.  Los desarrolladores de Telegram recomiendan agregar soporte para los comandos / help y / start para todos los bots.  Agreguemos otro comando por diversi√≥n.  La clase en s√≠ es bastante simple y hace posible implementar el controlador frontal en index.php sin cargar el archivo de llamada en s√≠.  Para obtener una l√≥gica m√°s compleja, la arquitectura debe ser desarrollada y complicada. </p><br><pre> <code class="plaintext hljs">&lt;?php namespace App; use TelegramBot\Api\Client; use Telegram\Bot\Objects\Update; class BotApp { function run(): void{ $token = getenv('BOT_TOKEN'); $bot = new Client($token); //   start $bot-&gt;command('start', function ($message) use ($bot) { $answer = ' !'; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //    $bot-&gt;command('help', function ($message) use ($bot) { $answer = ': /help -  '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); //   $bot-&gt;command('hello', function ($message) use ($bot) { $answer = '-,  - ,   Serverless '; $bot-&gt;sendMessage($message-&gt;getChat()-&gt;getId(), $answer); }); $bot-&gt;run(); } }</code> </pre> <br><p>  Y aqu√≠ est√° la lista de index.php: </p><br><pre> <code class="plaintext hljs">&lt;?php require_once('../vendor/autoload.php'); use App\BotApp; try{ $botApp = new BotApp(); $botApp-&gt;run(); } catch (Exception $e){ echo $e-&gt;getMessage(); print_r($e-&gt;getTrace(), 1); }</code> </pre> <br><p>  Puede parecer extra√±o, pero todo est√° listo para que nos vayamos a Producci√≥n.  Hagamos esto ejecutando el comando en la carpeta serverless.yml: </p><br><pre> <code class="plaintext hljs">sls deploy</code> </pre> <br><p>  En modo normal, serverless empacar√° los archivos en archivos zip, crear√° un bucket de S3 donde colocarlos, luego crear√° o actualizar√° la Aplicaci√≥n AWS adjunta a Lambda, y colocar√° el c√≥digo y el tiempo de ejecuci√≥n en una capa separada. </p><br><p>  Durante el primer lanzamiento, se crear√° la API de Gateway (la dejamos para que sea m√°s f√°cil probar las llamadas, pero es recomendable eliminarla).  Tambi√©n deber√° configurar la llamada de Lambda a trav√©s de ELB, para lo cual seleccionamos "Agregar disparador" en la ventana de control de funciones y seleccionamos "Balanceador de carga de aplicaciones" en la lista desplegable.  Deber√° especificar el ELB creado anteriormente, establecer la conexi√≥n a trav√©s de HTTPS, dejar el Host vac√≠o y, en Ruta, especificar la ruta que Lambda llamar√° (por ejemplo, / lambda / mytgbot).  Como resultado, su Lambda estar√° disponible en la URL con la ruta especificada. </p><br><p>  Ahora puede registrar la parte de respuesta del bot en Telegram para que el mensajero entienda d√≥nde obtener los mensajes.  Para hacer esto, llame a la siguiente URL en el navegador, pero no olvide sustituir sus propios par√°metros: </p><br><pre> <code class="plaintext hljs">https://api.telegram.org/bot_/setWebhook?url=https://my-elb-host.com/lambda/mytgbot</code> </pre> <br><p>  Como resultado, la API devolver√° "OK", despu√©s de lo cual el bot estar√° disponible. </p><br><p><img src="https://habrastorage.org/webt/g-/rd/kl/g-rdkldh57hxw-sbbcl_ci9nmyk.png"></p><br><h2 id="testiruem-bota-na-lokali">  Probar el bot en locales </h2><br><p>  Bot se puede probar antes de la implementaci√≥n.  El hecho es que Serverless Framework admite el inicio en entornos locales que utilizan contenedores Docker para esto.  Comando de llamada: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction</code> </pre> <br><p>  No olvide que utilizamos variables de entorno, por lo que durante la llamada tambi√©n deben establecerse en el formato: </p><br><pre> <code class="plaintext hljs">sls invoke local --docker -f myFunction --env VAR1=val1</code> </pre> <br><h2 id="logi">  Registros </h2><br><p>  De forma predeterminada, la salida de la llamada se registrar√° en CloudWatch; est√° disponible en el panel Monitoreo de la funci√≥n Lambda correspondiente.  Aqu√≠ puede leer los rastreos de llamadas en caso de un volcado en el lado de PHP.  Adem√°s, puede conectar servicios de monitoreo avanzados, pero costar√°n unos pocos centavos adicionales cada mes. </p><br><h2 id="itogo">  Total </h2><br><p>  Como resultado, obtuvimos una soluci√≥n bastante r√°pida, flexible, escalable y tambi√©n relativamente econ√≥mica.  S√≠, Lambda no siempre gana en comparaci√≥n con las m√°quinas virtuales y los contenedores est√°ndar, pero hay situaciones en las que la aplicaci√≥n Serverless ayuda a "disparar" de manera r√°pida y eficiente.  Y el ejemplo del bot creado simplemente demuestra esto. <br>  Materiales √∫tiles sobre el tema: </p><br><ul><li>  <a href="http.html">Documentaci√≥n Bref</a> </li><li>  <a href="https://habr.com/ru/post/457100/">Teor√≠a lambda</a> ; </li><li>  <a href="https://dev.to/sosnowski/anatomy-of-aws-lambda-1i1e">Anatom√≠a lambda</a> ; </li><li>  <a href="https://serverless.com/">Marco sin servidor</a> </li><li>  <a href="https://devenergy.ru/archives/941">Bot de Telegram sin servidor basado en PHP y AWS Lambda</a> . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/477370/">https://habr.com/ru/post/477370/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../477358/index.html">Te invitamos a DINS DevOps TARDE el 5 de diciembre: estamos hablando de un sistema de procesamiento de eventos, compartiendo experiencias con Influx</a></li>
<li><a href="../477360/index.html">Novedades de SOLIDWORKS Simulation 2020</a></li>
<li><a href="../477362/index.html">M√°s que antispam: c√≥mo aprovechar al m√°ximo su Security Email Gateway</a></li>
<li><a href="../477364/index.html">¬øC√≥mo convertirse en un desarrollador de Java? ¬øO tal vez elegir Python?</a></li>
<li><a href="../477366/index.html">Cinco preguntas sobre el dise√±o de lenguajes de programaci√≥n</a></li>
<li><a href="../477372/index.html">Amazon pierde la guerra contra las falsificaciones</a></li>
<li><a href="../477374/index.html">Fuzzing Z-machines</a></li>
<li><a href="../477378/index.html">√Ågil mixto: enfoque de cascada al implementar aplicaciones comerciales (tambi√©n conocido como Agile-like)</a></li>
<li><a href="../477382/index.html">Esports: obtener ganancias: Mercedes, meg√°fono, apuestas y branding para esports</a></li>
<li><a href="../477384/index.html">Conferencia ‚ÄúSeguridad de la informaci√≥n. Amenazas del presente y del futuro ‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>