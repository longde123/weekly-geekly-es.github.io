<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â—½ï¸ âœ… ğŸ« ä¸ºLinuxåˆ›å»ºx86_64 ELFæ–‡ä»¶æ‰“åŒ…å™¨ ğŸŸ ğŸ¤¾ğŸ½ ğŸ“€</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¼•è¨€ 
 è¿™ç¯‡æ–‡ç« å°†æè¿°ä¸ºLinux x86_64åˆ›å»ºä¸€ä¸ªç®€å•çš„å¯æ‰§è¡Œæ–‡ä»¶æ‰“åŒ…ç¨‹åºã€‚ å‡å®šè¯»è€…ç†Ÿæ‚‰Cç¼–ç¨‹è¯­è¨€ï¼Œx86_64ä½“ç³»ç»“æ„çš„æ±‡ç¼–è¯­è¨€ä»¥åŠè®¾å¤‡ELFæ–‡ä»¶ã€‚ ä¸ºäº†ç¡®ä¿æ¸…æ™°ï¼Œæœ¬æ–‡ä¸­çš„ä»£ç å·²åˆ é™¤äº†é”™è¯¯å¤„ç†ï¼Œå¹¶ä¸”æœªæ˜¾ç¤ºæŸäº›åŠŸèƒ½çš„å®ç°ï¼Œå¯ä»¥é€šè¿‡å•å‡»æŒ‡å‘githubçš„é“¾æ¥ï¼ˆ loader ï¼Œ packer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ä¸ºLinuxåˆ›å»ºx86_64 ELFæ–‡ä»¶æ‰“åŒ…å™¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/483368/"><h2> å¼•è¨€ </h2><br> è¿™ç¯‡æ–‡ç« å°†æè¿°ä¸ºLinux x86_64åˆ›å»ºä¸€ä¸ªç®€å•çš„å¯æ‰§è¡Œæ–‡ä»¶æ‰“åŒ…ç¨‹åºã€‚ å‡å®šè¯»è€…ç†Ÿæ‚‰Cç¼–ç¨‹è¯­è¨€ï¼Œx86_64ä½“ç³»ç»“æ„çš„æ±‡ç¼–è¯­è¨€ä»¥åŠè®¾å¤‡ELFæ–‡ä»¶ã€‚ ä¸ºäº†ç¡®ä¿æ¸…æ™°ï¼Œæœ¬æ–‡ä¸­çš„ä»£ç å·²åˆ é™¤äº†é”™è¯¯å¤„ç†ï¼Œå¹¶ä¸”æœªæ˜¾ç¤ºæŸäº›åŠŸèƒ½çš„å®ç°ï¼Œå¯ä»¥é€šè¿‡å•å‡»æŒ‡å‘githubçš„é“¾æ¥ï¼ˆ <a href="https://github.com/cyberfined/cryload">loader</a> ï¼Œ <a href="https://github.com/cyberfined/cryptor">packer</a> ï¼‰æ‰¾åˆ°å®Œæ•´çš„ä»£ç ã€‚ <br><br> æƒ³æ³•æ˜¯è¿™æ ·çš„ï¼šæˆ‘ä»¬å°†ELFæ–‡ä»¶ä¼ è¾“åˆ°æ‰“åŒ…ç¨‹åºï¼Œç„¶ååœ¨è¾“å‡ºä¸­å¾—åˆ°ä¸€ä¸ªå…·æœ‰ä»¥ä¸‹ç»“æ„çš„æ–°æ–‡ä»¶ï¼š <br><div class="scrollable-table"><table><tbody><tr><td colspan="2">  ELFæ¥å¤´ </td></tr><tr><td colspan="2"> èŠ‚ç›®åç§° </td></tr><tr><td rowspan="3"> ä»£ç æ®µ </td><td> æ‰“åŒ…çš„ELFæ–‡ä»¶ä¸‹è½½å™¨ </td></tr><tr><td> æ‰“åŒ…çš„ELFæ–‡ä»¶ <br></td></tr><tr><td>  256ä¸ªå­—èŠ‚çš„éšæœºæ•°æ® </td></tr></tbody></table></div><a name="habracut"></a><br> ä¸ºäº†è¿›è¡Œå‹ç¼©ï¼Œå†³å®šä½¿ç”¨éœå¤«æ›¼ç®—æ³•è¿›è¡ŒåŠ å¯†-å…·æœ‰256ä½å¯†é’¥çš„AES-CTRï¼Œå³kokke <a href="https://github.com/kokke/tiny-AES-c">tiny-AES-cçš„å®ç°</a> ã€‚  256ä¸ªå­—èŠ‚çš„éšæœºæ•°æ®ç”¨äºä½¿ç”¨ä¼ªéšæœºæ•°ç”Ÿæˆå™¨åˆå§‹åŒ–AESå¯†é’¥å’Œåˆå§‹åŒ–å‘é‡ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">32</span></span>; i++) { seed = (<span class="hljs-number"><span class="hljs-number">1103515245</span></span>*seed + <span class="hljs-number"><span class="hljs-number">12345</span></span>) % <span class="hljs-number"><span class="hljs-number">256</span></span>; key[i] = buf[seed]; }</code> </pre> <br> è¯¥å†³å®šæ˜¯ç”±äºä½¿é€†å‘å·¥ç¨‹å¤æ‚åŒ–çš„æ„¿æœ›å¼•èµ·çš„ã€‚ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘æ„è¯†åˆ°å¹¶å‘ç—‡å¹¶ä¸é‡è¦ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰å¼€å§‹æ¶ˆé™¤å®ƒï¼Œå› ä¸ºæˆ‘ä¸æƒ³èŠ±æ—¶é—´å’Œç²¾åŠ›åœ¨å®ƒä¸Šé¢ã€‚ <br><br><h2> å¼•å¯¼ç¨‹åº </h2><br> é¦–å…ˆï¼Œå°†è€ƒè™‘å¼•å¯¼åŠ è½½ç¨‹åºçš„å·¥ä½œã€‚ åŠ è½½ç¨‹åºä¸åº”å…·æœ‰ä»»ä½•ä¾èµ–å…³ç³»ï¼Œå› æ­¤æ ‡å‡†Cåº“ä¸­çš„æ‰€æœ‰å¿…éœ€åŠŸèƒ½éƒ½å¿…é¡»ç‹¬ç«‹ç¼–å†™ï¼ˆè¿™äº›åŠŸèƒ½çš„å®ç°å¯é€šè¿‡<a href="">å‚è€ƒè·å¾—</a> ï¼‰ã€‚ å®ƒåœ¨ä½ç½®ä¸Šä¹Ÿåº”è¯¥ç‹¬ç«‹ã€‚ <br><br><h3>  _å¯åŠ¨åŠŸèƒ½ </h3><br> å¼•å¯¼åŠ è½½ç¨‹åºä»_startå‡½æ•°å¼€å§‹ï¼Œè¯¥å‡½æ•°ä»…å°†argcå’Œargvä¼ é€’ç»™mainï¼š <br><br><pre> <code class="plaintext hljs">.extern main .globl _start .text _start: movq (%rsp), %rdi movq %rsp, %rsi addq $8, %rsi call main</code> </pre><br><h3> ä¸»è¦åŠŸèƒ½ </h3><br>  main.cæ–‡ä»¶é¦–å…ˆå®šä¹‰å‡ ä¸ªexternå˜é‡ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* loader_end; <span class="hljs-comment"><span class="hljs-comment">//    , .   //  ELF . extern size_t payload_size; //   ELF  extern size_t key_seed; //     // -   . extern size_t iv_seed; //     // -    </span></span></code> </pre><br> ä¸ºäº†æ‰¾åˆ°ä¸æ‰“åŒ…ç¨‹åºä¸­çš„å˜é‡ï¼ˆElf64_Symï¼‰å¯¹åº”çš„å­—ç¬¦çš„ä½ç½®å¹¶æ›´æ”¹å…¶å€¼ï¼Œæ‰€æœ‰è¿™äº›å­—ç¬¦éƒ½å£°æ˜ä¸ºexternã€‚ <br><br> ä¸»è¦åŠŸèƒ½æœ¬èº«éå¸¸ç®€å•ã€‚ ç¬¬ä¸€æ­¥æ˜¯åˆå§‹åŒ–æŒ‡å‘æ‰“åŒ…çš„ELFæ–‡ä»¶ï¼Œ256å­—èŠ‚ç¼“å†²åŒºå’Œå †æ ˆé¡¶éƒ¨çš„æŒ‡é’ˆã€‚ ç„¶åå°†ELFæ–‡ä»¶è§£å¯†å¹¶å±•å¼€ï¼Œç„¶åä½¿ç”¨load_elfå‡½æ•°å°†å…¶æ”¾ç½®åœ¨å†…å­˜ä¸­çš„æ­£ç¡®ä½ç½®ï¼Œæœ€åï¼Œrspå¯„å­˜å™¨çš„å€¼è¿”å›å…¶åŸå§‹çŠ¶æ€ï¼Œå¹¶è·³åˆ°ç¨‹åºå…¥å£ç‚¹ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> SET_STACK(sp) __asm__ __volatile__ (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"movq %0, %%rsp"</span></span></span><span class="hljs-meta">::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta">(sp)) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> JMP(addr) __asm__ __volatile__ (</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"jmp *%0"</span></span></span><span class="hljs-meta">::</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"r"</span></span></span><span class="hljs-meta">(addr)) int main(int argc, char **argv) { uint8_t *payload = (uint8_t*)&amp;loader_end; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//    // ELF  uint8_t *entropy_buf = payload + payload_size; //   256- //  void *rsp = argv-1; //     struct AES_ctx ctx; AES_init_ctx_iv(&amp;ctx, entropy_buf, key_seed, iv_seed); //  AES AES_CTR_xcrypt_buffer(&amp;ctx, payload, payload_size); //  ELF memset(&amp;ctx, 0, sizeof(ctx)); //   AES size_t decoded_payload_size; //  ELF char *decoded_payload = huffman_decode((char*)payload, payload_size, &amp;decoded_payload_size); //     ELF  , //   ET_EXEC  NULL. void *load_addr = elf_load_addr(rsp, decoded_payload, decoded_payload_size); load_addr = load_elf(load_addr, decoded_payload); //  ELF  , //    //  . memset(decoded_payload, 0, decoded_payload_size); //   ELF munmap(decoded_payload, decoded_payload_size); //   //    //  ELF     AES AES_init_ctx_iv(&amp;ctx, entropy_buf, key_seed, iv_seed); AES_CTR_xcrypt_buffer(&amp;ctx, payload, payload_size); memset(&amp;ctx, 0, sizeof(ctx)); SET_STACK(rsp); //    JMP(load_addr); //       }</span></span></span></span></code> </pre><br> ä¸ºäº†å®‰å…¨èµ·è§ï¼Œé‡ç½®AESå’Œè§£å‹ç¼©çš„ELFæ–‡ä»¶çš„çŠ¶æ€æ˜¯ä¸ºäº†ä½¿å¯†é’¥å’Œè§£å¯†çš„æ•°æ®ä»…åœ¨ä½¿ç”¨æœŸé—´å­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†è€ƒè™‘ä¸€äº›åŠŸèƒ½çš„å®ç°ã€‚ <br><br><h3>  load_elf </h3><br> ç”±äºæœ€åˆçš„åŠŸèƒ½åœ¨ET_DYNä¹‹ç±»çš„æ–‡ä»¶ä¸Šå´©æºƒï¼Œå› æ­¤æˆ‘ä»githubç”¨æˆ·çš„æ˜µç§°bedigeré‚£é‡Œè·å–äº†è¯¥å‡½æ•°ï¼Œå¹¶å¯¹å…¶è¿›è¡Œäº†æœ€ç»ˆç¡®å®šã€‚ å‘ç”Ÿæ•…éšœæ˜¯ç”±äºä»¥ä¸‹äº‹å®ï¼šmmapç³»ç»Ÿè°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼è®¾ç½®ä¸ºNULLï¼Œå¹¶ä¸”è¿”å›çš„åœ°å€ä¸ä¸»ç¨‹åºéå¸¸æ¥è¿‘ï¼Œåœ¨éšåçš„mmapè°ƒç”¨ä¸­ï¼Œå°†æ®µå¤åˆ¶åˆ°å®ƒä»¬è¿”å›çš„åœ°å€ä¸­ï¼Œä¸»ç¨‹åºçš„ä»£ç è¢«è¦†ç›–ï¼Œå¹¶å‘ç”Ÿäº†æ®µé”™è¯¯ã€‚ å› æ­¤ï¼Œå†³å®šå°†èµ·å§‹åœ°å€ä½œä¸ºå‚æ•°æ·»åŠ åˆ°load_elfå‡½æ•°ã€‚ è¯¥å‡½æ•°æœ¬èº«éå†æ‰€æœ‰ç¨‹åºå¤´ï¼Œä¸ºELFæ–‡ä»¶çš„PT_LOADæ®µåˆ†é…å†…å­˜ï¼ˆå…¶æ•°é‡å¿…é¡»æ˜¯é¡µé¢å¤§å°çš„å€æ•°ï¼‰ï¼Œå°†å…¶å†…å®¹å¤åˆ¶åˆ°å·²åˆ†é…çš„å†…å­˜åŒºåŸŸï¼Œå¹¶ä¸ºè¿™äº›åŒºåŸŸè®¾ç½®ç›¸åº”çš„è¯»å–ï¼Œå†™å…¥ï¼Œæ‰§è¡Œæƒé™ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//      #define PAGEUP(x) (((unsigned long)x + 4095)&amp;(~4095)) //      #define PAGEDOWN(x) ((unsigned long)x&amp;(~4095)) void* load_elf(void *load_addr, void *mapped) { Elf64_Ehdr *ehdr = mapped; Elf64_Phdr *phdr = mapped + ehdr-&gt;e_phoff; void *text_segment = NULL; unsigned long initial_vaddr = 0; unsigned long brk_addr = 0; for(size_t i = 0; i &lt; ehdr-&gt;e_phnum; i++, phdr++) { unsigned long rounded_len, k; void *segment; //   PT_LOAD,    if(phdr-&gt;p_type != PT_LOAD) continue; if(text_segment != 0 &amp;&amp; ehdr-&gt;e_type == ET_DYN) { //  ET_DYN phdr-&gt;p_vaddr    , //        //    ,      //     load_addr = text_segment + phdr-&gt;p_vaddr - initial_vaddr; load_addr = (void*)PAGEDOWN(load_addr); } else if(ehdr-&gt;e_type == ET_EXEC) { //  ET_EXEC phdr-&gt;p_vaddr     load_addr = (void*)PAGEDOWN(phdr-&gt;p_vaddr); } //        rounded_len = phdr-&gt;p_memsz + (phdr-&gt;p_vaddr % 4096); rounded_len = PAGEUP(rounded_len); //        segment = mmap(load_addr, rounded_len, PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS | MAP_FIXED, -1, 0); if(ehdr-&gt;e_type == ET_EXEC) load_addr = (void*)phdr-&gt;p_vaddr; else load_addr = segment + (phdr-&gt;p_vaddr % 4096); //         memcpy(load_addr, mapped + phdr-&gt;p_offset, phdr-&gt;p_filesz); if(!text_segment) { text_segment = segment; initial_vaddr = phdr-&gt;p_vaddr; } unsigned int protflags = 0; if(phdr-&gt;p_flags &amp; PF_R) protflags |= PROT_READ; if(phdr-&gt;p_flags &amp; PF_W) protflags |= PROT_WRITE; if(phdr-&gt;p_flags &amp; PF_X) protflags |= PROT_EXEC; mprotect(segment, rounded_len, protflags); //   // , ,  k = phdr-&gt;p_vaddr + phdr-&gt;p_memsz; if(k &gt; brk_addr) brk_addr = k; } if (ehdr-&gt;e_type == ET_EXEC) { brk(PAGEUP(brk_addr)); //  ET_EXEC ehdr-&gt;e_entry     load_addr = (void*)ehdr-&gt;e_entry; } else { //  ET_DYN ehdr-&gt;e_entry    , //           load_addr = (void*)ehdr + ehdr-&gt;e_entry; } return load_addr; //       }</span></span></code> </pre><br><h3>  elf_load_addr </h3><br>  ET_EXEC ELFæ–‡ä»¶çš„æ­¤å‡½æ•°è¿”å›NULLï¼Œå› ä¸ºæ­¤ç±»å‹çš„æ–‡ä»¶åº”ä½äºæ–‡ä»¶ä¸­æŒ‡å®šçš„åœ°å€å¤„ã€‚ å¯¹äºET_DYNæ–‡ä»¶ï¼Œé¦–å…ˆè®¡ç®—ç­‰äºä¸»ç¨‹åºåŸºå€ï¼ˆå³å¼•å¯¼åŠ è½½ç¨‹åºï¼‰ï¼Œå°†ELFæ”¾å…¥å†…å­˜æ‰€éœ€çš„å†…å­˜é‡ä»¥åŠ4096ã€4096ä¹‹é—´çš„å·®å€¼çš„åœ°å€ï¼Œä»¥å…ELFæ–‡ä»¶ä¸ç´§æŒ¨ä¸»ç¨‹åºã€‚ è®¡ç®—å®Œè¯¥åœ°å€åï¼Œæ£€æŸ¥ä»ç»™å®šåœ°å€åˆ°ä¸»ç¨‹åºçš„åŸºåœ°å€ï¼Œå†…å­˜åŒºåŸŸæ˜¯å¦ä¸ä»è§£å‹ç¼©çš„ELFæ–‡ä»¶çš„å¼€å¤´åˆ°ç»“å°¾çš„åŒºåŸŸç›¸äº¤ã€‚ åœ¨ç›¸äº¤çš„æƒ…å†µä¸‹ï¼Œè¿”å›çš„åœ°å€ç­‰äºè§£å‹ç¼©çš„ELFçš„èµ·å§‹åœ°å€ä¸æ”¾ç½®è¯¥åœ°å€æ‰€éœ€çš„å†…å­˜é‡ä¹‹å·®ï¼Œå¦åˆ™è¿”å›å…ˆå‰è®¡ç®—çš„åœ°å€ã€‚ <br><br> é€šè¿‡ä»è¾…åŠ©å‘é‡ï¼ˆELFè¾…åŠ©å‘é‡ï¼‰ä¸­æå–ç¨‹åºå¤´çš„åœ°å€æ¥æ‰¾åˆ°ç¨‹åºçš„åŸºåœ°å€ï¼Œè¯¥è¾…åŠ©å‘é‡ä½äºå †æ ˆä¸­æŒ‡å‘ç¯å¢ƒå˜é‡çš„æŒ‡é’ˆä¹‹åï¼Œå¹¶ä»ä¸­å‡å»ELFå¤´çš„å¤§å°ï¼š <br><br><pre> <code class="plaintext hljs">      ---------------------------------------------------------------------------    -&gt; [ argc ] 8 [ argv[0] ] 8 [ argv[1] ] 8 [ argv[..] ] 8 * x [ argv[n â€“ 1] ] 8 [ argv[n] ] 8 (= NULL) [ envp[0] ] 8 [ envp[1] ] 8 [ envp[..] ] 8 [ envp[term] ] 8 (= NULL) [ auxv[0] (Elf64_auxv_t) ] 16 [ auxv[1] (Elf64_auxv_t) ] 16 [ auxv[..] (Elf64_auxv_t) ] 16 [ auxv[term] (Elf64_auxv_t) ] 16 (= AT_NULL) [  ] 0 - 16 [    ] &gt;= 0 [   ] &gt;= 0 [   ] 8 (= NULL) &lt;    &gt; 0 ---------------------------------------------------------------------------</code> </pre><br> æè¿°è¾…åŠ©å‘é‡çš„æ¯ä¸ªå…ƒç´ çš„ç»“æ„å…·æœ‰ä»¥ä¸‹å½¢å¼ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span> a_type; <span class="hljs-comment"><span class="hljs-comment">//   union { uint64_t a_val; //  } a_un; } Elf64_auxv_t;</span></span></code> </pre><br> æœ‰æ•ˆçš„a_typeå€¼ä¹‹ä¸€æ˜¯AT_PHDRï¼Œç„¶åa_valå°†æŒ‡å‘ç¨‹åºå¤´ã€‚ ä»¥ä¸‹æ˜¯elf_load_addrå‡½æ•°çš„ä»£ç ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">elf_base_addr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *rsp)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *base_addr = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> argc = *(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>*)rsp; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> **envp = rsp + (argc+<span class="hljs-number"><span class="hljs-number">2</span></span>)*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    //   while(*envp++); //        Elf64_auxv_t *aux = (Elf64_auxv_t*)envp; //    //  for(; aux-&gt;a_type != AT_NULL; aux++) { //        if(aux-&gt;a_type == AT_PHDR) { //   ELF ,     //      base_addr = (void*)(aux-&gt;a_un.a_val â€“ sizeof(Elf64_Ehdr)); break; } } return base_addr; } size_t elf_memory_size(void *mapped) { Elf64_Ehdr *ehdr = mapped; Elf64_Phdr *phdr = mapped + ehdr-&gt;e_phoff; size_t mem_size = 0, segment_len; for(size_t i = 0; i &lt; ehdr-&gt;e_phnum; i++, phdr++) { if(phdr-&gt;p_type != PT_LOAD) continue; segment_len = phdr-&gt;p_memsz + (phdr-&gt;p_vaddr % 4096); mem_size += PAGEUP(segment_len); } return mem_size; } void* elf_load_addr(void *rsp, void *mapped, size_t mapped_size) { Elf64_Ehdr *ehdr = mapped; if(ehdr-&gt;e_type == ET_EXEC) return NULL; size_t mem_size = elf_memory_size(mapped) + 0x1000; void *load_addr = elf_base_addr(rsp); if(mapped &lt; load_addr &amp;&amp; mapped + mapped_size &gt; load_addr - mem_size) load_addr = mapped; return load_addr - mem_size; }</span></span></code> </pre><br><h3> é“¾æ¥æè¿°æ–‡ä»¶ </h3><br> æœ‰å¿…è¦ä¸ºä¸Šè¿°externå˜é‡å®šä¹‰å­—ç¬¦ï¼Œå¹¶ç¡®ä¿ç¼–è¯‘åçš„ä»£ç å’ŒåŠ è½½å™¨æ•°æ®åœ¨åŒä¸€.textèŠ‚ä¸­ã€‚ é€šè¿‡ä»æ–‡ä»¶ä¸­ç®€å•åœ°åˆ‡å‡ºæœ¬èŠ‚çš„å†…å®¹ï¼Œä¾¿å¯ä»¥æ–¹ä¾¿åœ°æå–è£…è½½æœºçš„æœºå™¨ä»£ç ã€‚ ä¸ºäº†å®ç°è¿™äº›ç›®æ ‡ï¼Œç¼–å†™äº†ä»¥ä¸‹é“¾æ¥æè¿°æ–‡ä»¶ï¼š <br><br><pre> <code class="plaintext hljs">ENTRY(_start) SECTIONS { . = 0; .text :{ *(.text) *(.text.startup) *(.data) *(.rodata) payload_size = .; QUAD(0) key_seed = .; QUAD(0) iv_seed = .; QUAD(0) loader_end = .; } }</code> </pre><br> å€¼å¾—è¯´æ˜çš„æ˜¯ï¼ŒQUADï¼ˆ0ï¼‰æ”¾ç½®8ä¸ªå­—èŠ‚çš„é›¶ï¼Œè€Œä¸æ˜¯æ‰“åŒ…ç¨‹åºå°†æ›¿æ¢ç‰¹å®šå€¼çš„å­—èŠ‚ã€‚ ä¸ºäº†åˆ‡å‡ºæœºå™¨ä»£ç ï¼Œç¼–å†™äº†ä¸€ä¸ªå°å®ç”¨ç¨‹åºï¼Œè¯¥å®ç”¨ç¨‹åºè¿˜å°†æœºå™¨ä»£ç çš„å¼€å¤´å†™å…¥äº†ä»å¼•å¯¼åŠ è½½ç¨‹åºå¼€å§‹åˆ°å¼•å¯¼åŠ è½½ç¨‹åºçš„å…¥å£ç‚¹çš„åç§»é‡ï¼Œä»¥åŠè‡ªå¼•å¯¼åŠ è½½ç¨‹åºå¼€å§‹ä»¥æ¥æœ‰æ•ˆè´Ÿè½½_sizeï¼Œkey_seedå’Œiv_seedå­—ç¬¦å€¼çš„åç§»é‡ã€‚ æ­¤å®ç”¨ç¨‹åºçš„ä»£ç <a href="">åœ¨æ­¤å¤„æä¾›</a> ã€‚ è¿™æ ·å°±ç»“æŸäº†å¼•å¯¼åŠ è½½ç¨‹åºçš„æè¿°ã€‚ <br><br><h2> ç›´æ¥åŒ…è£… </h2><br> è€ƒè™‘æ‰“åŒ…æœºçš„ä¸»è¦åŠŸèƒ½ã€‚ å®ƒä½¿ç”¨ä¸¤ä¸ªå‘½ä»¤è¡Œå‚æ•°ï¼šè¾“å…¥æ–‡ä»¶çš„åç§°ä¸ºargv [1]ï¼Œè¾“å‡ºæ–‡ä»¶çš„åç§°ä¸ºargv [2]ã€‚ é¦–å…ˆï¼Œè¾“å…¥æ–‡ä»¶æ˜¾ç¤ºåœ¨å†…å­˜ä¸­ï¼Œå¹¶æ£€æŸ¥ä¸æ‰“åŒ…ç¨‹åºçš„å…¼å®¹æ€§ã€‚ è¯¥æ‰“åŒ…ç¨‹åºä»…é€‚ç”¨äºä¸¤ç§ç±»å‹çš„ELFæ–‡ä»¶ï¼šET_EXECå’ŒET_DYNï¼Œå¹¶ä¸”ä»…é€‚ç”¨äºé™æ€ç¼–è¯‘çš„æ–‡ä»¶ã€‚ å¼•å…¥æ­¤é™åˆ¶çš„åŸå› æ˜¯ä¸åŒçš„Linuxç³»ç»Ÿå…·æœ‰ä¸åŒç‰ˆæœ¬çš„å…±äº«åº“ï¼Œå³ åŠ¨æ€ç¼–è¯‘ç¨‹åºæ— æ³•åœ¨çˆ¶ç³»ç»Ÿä»¥å¤–çš„ç³»ç»Ÿä¸Šå¯åŠ¨çš„å¯èƒ½æ€§éå¸¸é«˜ã€‚ ä¸»è¦åŠŸèƒ½ä¸­çš„ç›¸åº”ä»£ç ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> mapped_size; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *mapped = map_file(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>], &amp;mapped_size); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(check_elf(mapped) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>;</code> </pre><br> æ­¤åï¼Œå¦‚æœè¾“å…¥æ–‡ä»¶é€šè¿‡å…¼å®¹æ€§æ£€æŸ¥ï¼Œåˆ™å°†å…¶å‹ç¼©ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> comp_size; <span class="hljs-keyword"><span class="hljs-keyword">uint8_t</span></span> *comp_buf = huffman_encode(mapped, &amp;comp_size);</code> </pre><br> æ¥ä¸‹æ¥ï¼Œç”ŸæˆAESçŠ¶æ€ï¼Œå¹¶å¯¹å‹ç¼©çš„ELFæ–‡ä»¶è¿›è¡ŒåŠ å¯†ã€‚  AESçš„çŠ¶æ€ç”±ä»¥ä¸‹ç»“æ„ç¡®å®šï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> AES_ENTROPY_BUFSIZE 256 typedef struct { uint8_t entropy_buf[AES_ENTROPY_BUFSIZE]; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// 256-  size_t key_seed; //      size_t iv_seed; //       struct AES_ctx ctx; //  AES-CTR } AES_state_t;</span></span></span></span></code> </pre><br>  mainä¸­çš„å¯¹åº”ä»£ç ï¼š <br><br><pre> <code class="cpp hljs">AES_state_t aes_st; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; AES_ENTROPY_BUFSIZE; i++) state.entropy_buf[i] = rand() % <span class="hljs-number"><span class="hljs-number">256</span></span>; state.key_seed = rand(); state.iv_seed = rand(); AES_init_ctx_iv(&amp;state.ctx, state.entropy_buf, state.key_seed, state.iv_seed); AES_CTR_xcrypt_buffer(&amp;aes_st.ctx, comp_buf, comp_size);</code> </pre><br> æ­¤åï¼Œå°†åˆå§‹åŒ–å­˜å‚¨æœ‰å…³å¼•å¯¼åŠ è½½ç¨‹åºä¿¡æ¯çš„ç»“æ„ï¼Œå¹¶å°†å¼•å¯¼åŠ è½½ç¨‹åºä¸­çš„payload_sizeï¼Œkey_seedå’Œiv_seedå€¼æ›´æ”¹ä¸ºä¸Šä¸€æ­¥ä¸­ç”Ÿæˆçš„å€¼ï¼Œç„¶åé‡ç½®AESçŠ¶æ€ã€‚ æœ‰å…³å¼•å¯¼åŠ è½½ç¨‹åºçš„ä¿¡æ¯å­˜å‚¨åœ¨ä»¥ä¸‹ç»“æ„ä¸­ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *loader_begin; <span class="hljs-comment"><span class="hljs-comment">//      size_t entry_offset; //       size_t *payload_size_patch_offset; //     // ELF    size_t *key_seed_pacth_offset; //     //       size_t *iv_seed_patch_offset; //     //     //    size_t loader_size; //     } loader_t;</span></span></code> </pre><br>  mainä¸­çš„å¯¹åº”ä»£ç ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">loader_t</span></span> loader; init_loader(&amp;loader); *loader.payload_size_patch_offset = comp_size; *loader.key_seed_pacth_offset = aes_st.key_seed; *loader.iv_seed_patch_offset = aes_st.iv_seed; <span class="hljs-built_in"><span class="hljs-built_in">memset</span></span>(&amp;aes_st.ctx, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(aes_st.ctx));</code> </pre><br> åœ¨æœ€åä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªè¾“å‡ºæ–‡ä»¶ï¼Œåœ¨å…¶ä¸­å†™å…¥ä¸€ä¸ªELFå¤´ï¼Œä¸€ä¸ªç¨‹åºå¤´ï¼Œä¸€ä¸ªåŠ è½½å™¨ä»£ç ï¼Œä¸€ä¸ªå‹ç¼©å’ŒåŠ å¯†çš„ELFæ–‡ä»¶ä»¥åŠä¸€ä¸ª256å­—èŠ‚çš„ç¼“å†²åŒºï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> out_fd = open(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>], O_WRONLY | O_CREAT | O_TRUNC, <span class="hljs-number"><span class="hljs-number">0755</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  //   write_elf_ehdr(out_fd, &amp;loader); //  ELF  write_elf_phdr(out_fd, &amp;loader, comp_size); //    write(out_fd, loader.loader_begin, loader.loader_size); //   write(out_fd, comp_buf, comp_size); //     ELF write(out_fd, aes_st.entropy_buf, AES_ENTROPY_BUFSIZE); //  // 256- </span></span></code> </pre><br> æ‰“åŒ…ç¨‹åºçš„ä¸»è¦ä»£ç åˆ°æ­¤ç»“æŸï¼Œç„¶åå°†è€ƒè™‘ä»¥ä¸‹åŠŸèƒ½ï¼šåˆå§‹åŒ–æœ‰å…³å¼•å¯¼åŠ è½½ç¨‹åºçš„ä¿¡æ¯çš„åŠŸèƒ½ï¼Œç¼–å†™ELFæ ‡å¤´çš„åŠŸèƒ½å’Œç¼–å†™ç¨‹åºæ ‡å¤´çš„åŠŸèƒ½ã€‚ <br><br><h3> åˆå§‹åŒ–å¼•å¯¼ç¨‹åºä¿¡æ¯ </h3><br> ä½¿ç”¨ä»¥ä¸‹ç®€å•ä»£ç ï¼Œå°†åŠ è½½ç¨‹åºæœºå™¨ä»£ç åµŒå…¥åˆ°packerå¯æ‰§è¡Œæ–‡ä»¶ä¸­ï¼š <br><br><pre> <code class="plaintext hljs">.data .globl _loader_begin .globl _loader_end _loader_begin: .incbin "loader" _loader_end:</code> </pre><br> ä¸ºäº†ç¡®å®šå…¶åœ¨å†…å­˜ä¸­çš„åœ°å€ï¼Œåœ¨main.cæ–‡ä»¶ä¸­å£°æ˜äº†ä»¥ä¸‹å˜é‡ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* _loader_begin; <span class="hljs-keyword"><span class="hljs-keyword">extern</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* _loader_end;</code> </pre><br> æ¥ä¸‹æ¥ï¼Œè€ƒè™‘init_loaderå‡½æ•°ã€‚ é¦–å…ˆï¼Œä»ä¸­ä¾æ¬¡è¯»å–ä»¥ä¸‹å€¼ï¼šå…¥å£ç‚¹ä¸å¼•å¯¼åŠ è½½ç¨‹åºèµ·å§‹ä½ç½®çš„åç§»é‡ï¼ˆentry_offsetï¼‰ï¼Œæ‰“åŒ…çš„ELFæ–‡ä»¶çš„å¤§å°ä¸å¼•å¯¼åŠ è½½ç¨‹åºèµ·å§‹ä½ç½®çš„åç§»é‡ï¼ˆpayload_size_patch_offsetï¼‰ï¼Œå¯†é’¥ç”Ÿæˆå™¨çš„åˆå§‹å€¼ä¸å¼•å¯¼åŠ è½½ç¨‹åºçš„èµ·å§‹ä½ç½®ä¹‹é—´çš„åç§»é‡ï¼ˆkey_seed_paâ€‹â€‹tch_offsetçš„çŸ¢é‡åç§»é‡ï¼‰ï¼Œä»å¼•å¯¼åŠ è½½ç¨‹åºï¼ˆiv_seed_paâ€‹â€‹tch_offsetï¼‰å¼€å§‹è¿›è¡Œåˆå§‹åŒ–ã€‚ ç„¶åï¼Œå°†åŠ è½½ç¨‹åºåœ°å€æ·»åŠ åˆ°æœ€åä¸‰ä¸ªå€¼ï¼Œå› æ­¤åœ¨å–æ¶ˆå¼•ç”¨æŒ‡é’ˆå¹¶ä¸ºå…¶åˆ†é…å€¼æ—¶ï¼Œæˆ‘ä»¬å°†ç”¨æ‰€éœ€çš„å€¼æ›¿æ¢åœ¨å¸ƒå±€é˜¶æ®µåˆ†é…çš„é›¶ï¼ˆQUADï¼ˆ0ï¼‰ï¼‰ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init_loader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loader_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *l)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *loader_begin = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)&amp;_loader_begin; l-&gt;entry_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>*)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>); l-&gt;payload_size_patch_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*); l-&gt;key_seed_pacth_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*); l-&gt;iv_seed_patch_offset = *(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>**)loader_begin; loader_begin += <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*); l-&gt;payload_size_patch_offset = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)l-&gt;payload_size_patch_offset + loader_begin; l-&gt;key_seed_pacth_offset = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)l-&gt;key_seed_pacth_offset + loader_begin; l-&gt;iv_seed_patch_offset = (<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span>)l-&gt;iv_seed_patch_offset + loader_begin; l-&gt;loader_begin = loader_begin; l-&gt;loader_size = (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*)&amp;_loader_end - loader_begin; }</code> </pre><br><br><h3>  write_elf_ehdr </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_elf_ehdr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loader_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *loader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ELF  Elf64_Ehdr ehdr; memset(ehdr.e_ident, 0, sizeof(ehdr.e_ident)); memcpy(ehdr.e_ident, ELFMAG, SELFMAG); ehdr.e_ident[EI_CLASS] = ELFCLASS64; ehdr.e_ident[EI_DATA] = ELFDATA2LSB; ehdr.e_ident[EI_VERSION] = EV_CURRENT; ehdr.e_ident[EI_OSABI] = ELFOSABI_NONE; ehdr.e_type = ET_DYN; ehdr.e_machine = EM_X86_64; ehdr.e_version = EV_CURRENT; ehdr.e_entry = sizeof(Elf64_Ehdr) + sizeof(Elf64_Phdr) + loader-&gt;entry_offset; ehdr.e_phoff = sizeof(Elf64_Ehdr); ehdr.e_shoff = 0; ehdr.e_flags = 0; ehdr.e_ehsize = sizeof(Elf64_Ehdr); ehdr.e_phentsize = sizeof(Elf64_Phdr); ehdr.e_phnum = 1; ehdr.e_shentsize = sizeof(Elf64_Shdr); ehdr.e_shnum = 0; ehdr.e_shstrndx = 0; write(fd, &amp;ehdr, sizeof(ehdr)); //     return 0; }</span></span></code> </pre><br> è¿™é‡Œå‘ç”ŸELFæ ‡å¤´çš„æ ‡å‡†åˆå§‹åŒ–ï¼Œå¹¶éšåå°†å…¶å†™å…¥æ–‡ä»¶ï¼Œå”¯ä¸€è¦æ³¨æ„çš„äº‹å®æ˜¯ï¼Œåœ¨ET_DYN ELFæ–‡ä»¶ä¸­ï¼Œç¬¬ä¸€ä¸ªç¨‹åºæ ‡å¤´æè¿°çš„æ®µä¸ä»…åŒ…æ‹¬å¯æ‰§è¡Œä»£ç ï¼Œè¿˜åŒ…æ‹¬ELFæ ‡å¤´å’Œæ‰€æœ‰æ ‡å¤´ã€‚ç¨‹åºã€‚ å› æ­¤ï¼Œå®ƒä¸èµ·å§‹ä½ç½®çš„åç§»é‡åº”ç­‰äºé›¶ï¼Œå…¶å¤§å°åº”ä¸ºELFæ ‡å¤´ï¼Œæ‰€æœ‰ç¨‹åºæ ‡å¤´å’Œå¯æ‰§è¡Œä»£ç çš„æ€»å’Œï¼Œè€Œå…¥å£ç‚¹åº”ç¡®å®šä¸ºELFæ ‡å¤´ï¼Œæ‰€æœ‰ç¨‹åºæ ‡å¤´çš„å¤§å°ä»¥åŠä¸å¯æ‰§è¡Œä»£ç å¼€å¤´çš„æ€»å’Œã€‚ <br><br><h3>  write_elf_phdr </h3><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write_elf_phdr</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> fd, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">loader_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *loader, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> payload_size)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    Elf64_Phdr phdr; phdr.p_type = PT_LOAD; phdr.p_offset = 0; phdr.p_vaddr = 0; phdr.p_paddr = 0; phdr.p_filesz = sizeof(Elf64_Ehdr) + sizeof(Elf64_Phdr) + loader-&gt;loader_size + payload_size + AES_ENTROPY_BUFSIZE; phdr.p_memsz = phdr.p_filesz; phdr.p_flags = PF_R | PF_W | PF_X; phdr.p_align = 0x1000; write(fd, &amp;phdr, sizeof(phdr)); //      }</span></span></code> </pre><br> åœ¨æ­¤ï¼Œç¨‹åºå¤´è¢«åˆå§‹åŒ–ï¼Œç„¶åå†™å…¥æ–‡ä»¶ã€‚ æ‚¨åº”æ³¨æ„ç›¸å¯¹äºæ–‡ä»¶å¼€å¤´çš„åç§»ä»¥åŠç¨‹åºå¤´æ–‡ä»¶æè¿°çš„æ®µçš„å¤§å°ã€‚ å¦‚å‰ä¸€æ®µæ‰€è¿°ï¼Œæ­¤æ ‡å¤´æè¿°çš„æ®µä¸ä»…åŒ…æ‹¬å¯æ‰§è¡Œä»£ç ï¼Œè¿˜åŒ…æ‹¬ELFæ ‡å¤´å’Œç¨‹åºæ ‡å¤´ã€‚ æˆ‘ä»¬è¿˜ä½¿å…·æœ‰å¯æ‰§è¡Œä»£ç çš„æ®µå¯è®¿é—®ä»¥è¿›è¡Œå†™å…¥ï¼Œè¿™æ˜¯å› ä¸ºåœ¨å¼•å¯¼åŠ è½½ç¨‹åºä¸­ä½¿ç”¨çš„AESå®ç°å¯¹æ•°æ®è¿›è¡Œäº†åŠ å¯†å’Œè§£å¯†ã€‚ <br><br><h2> å…³äºæ‰“åŒ…æœºå·¥ä½œçš„ä¸€äº›äº‹å® </h2><br> åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæ³¨æ„åˆ°ä½¿ç”¨glibcé™æ€ç¼–è¯‘çš„ç¨‹åºåœ¨å¯åŠ¨æ—¶æ ¹æ®ä»¥ä¸‹è¯´æ˜è¿›å…¥segfaultï¼š <br><br><pre>  movqï¼…fsï¼š0x28ï¼Œï¼…rax </pre><br> æˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œå¦‚æœæ‚¨åˆ†äº«æœ‰å…³æ­¤ä¸»é¢˜çš„ä¿¡æ¯ï¼Œæˆ‘å°†éå¸¸é«˜å…´ã€‚ å¯ä»¥ä½¿ç”¨musl-libcæ¥ä»£æ›¿glibcï¼Œä¸€åˆ‡éƒ½å¯ä»¥æ­£å¸¸ä½¿ç”¨ã€‚ å¦å¤–ï¼Œè¯¥æ‰“åŒ…ç¨‹åºè¿˜ä½¿ç”¨é™æ€ç¼–è¯‘çš„golangç¨‹åºï¼ˆä¾‹å¦‚ï¼ŒhttpæœåŠ¡å™¨ï¼‰è¿›è¡Œäº†æµ‹è¯•ã€‚ å¯¹äºgolangç¨‹åºå®Œå…¨é™æ€å´©æºƒï¼Œå¿…é¡»ä½¿ç”¨ä»¥ä¸‹æ ‡å¿—ï¼š <br><br><pre>  CGO_ENABLED = 0 go build -a -ldflags'-extldflagsâ€œ -staticâ€'ã€‚ </pre><br> æ‰“åŒ…ç¨‹åºæµ‹è¯•çš„æœ€åä¸€ä»¶äº‹æ˜¯æ²¡æœ‰åŠ¨æ€é“¾æ¥ç¨‹åºçš„ET_DYN ELFæ–‡ä»¶ã€‚ æ˜¯çš„ï¼Œä½¿ç”¨è¿™äº›æ–‡ä»¶æ—¶ï¼Œelf_load_addrå‡½æ•°å¯èƒ½ä¼šå¤±è´¥ã€‚ å®é™…ä¸Šï¼Œå¯ä»¥ä»å¼•å¯¼åŠ è½½ç¨‹åºä¸­å‰ªåˆ‡å®ƒï¼Œå¹¶ä½¿ç”¨å›ºå®šåœ°å€ï¼Œä¾‹å¦‚0x10000ã€‚ <br><br><h2> ç»“è®º </h2><br> æ˜¾ç„¶ï¼Œè¯¥æ‰“åŒ…ç¨‹åºæ²¡æœ‰ç”¨åœ¨é¢„æœŸçš„ç›®çš„ä¸Šï¼Œå› ä¸ºå—å…¶ä¿æŠ¤çš„æ–‡ä»¶å¾ˆå®¹æ˜“è§£å¯†ã€‚ è¯¥é¡¹ç›®çš„ç›®çš„æ˜¯æ›´å¥½åœ°æŒæ¡ä½¿ç”¨ELFæ–‡ä»¶ï¼Œç”Ÿæˆå®ƒä»¬çš„å®è·µä»¥åŠä¸ºåˆ›å»ºæ›´å®Œæ•´çš„æ‰“åŒ…ç¨‹åºåšå‡†å¤‡ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN483368/">https://habr.com/ru/post/zh-CN483368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN483354/index.html">ç¬¬äºŒä¸ªæœˆçš„è¯…å’’</a></li>
<li><a href="../zh-CN483356/index.html">ç¤¾åŒºè®¡æ•°â€œä»€ä¹ˆï¼Ÿâ€ åœ¨å“ª ä»€ä¹ˆæ—¶å€™ï¼Ÿâ€ï¼ˆChGKï¼‰æˆ–åœ¨æœ‹å‹é¢å‰è¿›è¡Œè¿‡å‡ æ¬¡æ¡æ‰‹ï¼Ÿ</a></li>
<li><a href="../zh-CN483360/index.html">ç”µåŠ›ç”µé©±åŠ¨æ§åˆ¶ã€‚ ä¸šä½™ç»éªŒ</a></li>
<li><a href="../zh-CN483364/index.html">æ‚¨å¯ä»¥åœ¨å·¥ä½œæ—¶ç¼–å†™ä»£ç ä»¥èŠ‚çœæ‚¨çš„ç©ºé—²æ—¶é—´ã€‚</a></li>
<li><a href="../zh-CN483366/index.html">äº’è”ç½‘å†å²è®°å½•ï¼šç½‘ç»œ</a></li>
<li><a href="../zh-CN483372/index.html">å¦‚ä½•ä½¿ç”¨GPUåœ¨ç¬”è®°æœ¬ç”µè„‘ä¸Šè®­ç»ƒDeepPavlovç¥ç»ç½‘ç»œ</a></li>
<li><a href="../zh-CN483374/index.html">REST APIå»ºè®®-Javaå’ŒSpringä¸­çš„WebæœåŠ¡è®¾è®¡ç¤ºä¾‹</a></li>
<li><a href="../zh-CN483376/index.html">åœ¨é»‘æ´çš„è¡¨é¢</a></li>
<li><a href="../zh-CN483378/index.html">ä½¿ç”¨å¯„å­˜å™¨è¿›è¡Œç±»å‹å®‰å…¨çš„å·¥ä½œï¼Œè€Œåœ¨C ++ 17ä¸­æ²¡æœ‰å¼€é”€ï¼šåŸºäºå€¼çš„å…ƒç¼–ç¨‹</a></li>
<li><a href="../zh-CN483380/index.html">å¾®æœåŠ¡ï¼šå¦‚ä½•éµå®ˆåˆåŒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>