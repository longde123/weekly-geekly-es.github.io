<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíØ üë§ üèß C√≥mo hicimos el motor y el juego durante un a√±o y medio. Segunda parte La infraestructura üöù üóÑÔ∏è üï∫üèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Primero, algunos comentarios sobre los rastros del art√≠culo anterior. Realmente sol√≠amos trabajar en Wargaming , donde desarrollamos un motor conocido...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo hicimos el motor y el juego durante un a√±o y medio. Segunda parte La infraestructura</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/465343/"> Primero, algunos comentarios sobre los rastros del art√≠culo anterior.  Realmente sol√≠amos trabajar en <b>Wargaming</b> , donde desarrollamos un motor conocido como <b>dava.framework</b> o <b>dava.engine</b> .  Por lo tanto, muchos viejos colegas, con quienes todav√≠a estamos en buenas relaciones, participan activamente en la discusi√≥n. <br><br>  Algunas personas tienen dudas: ¬øes esta la misma tecnolog√≠a u otra?  Respuesta: esta es una nueva tecnolog√≠a escrita desde cero. <br><br>  ¬øC√≥mo nos las arreglamos en solo un a√±o?  Nuestro equipo tiene una vasta experiencia.  Muchos han estado desarrollando motores y juegos durante m√°s de 15 a√±os. <br><br>  ¬øPor qu√© desde cero, si pudieras tomar nuestro viejo motor, que tambi√©n se encuentra en c√≥digo abierto?  Tiene unos 10 a√±os y la mayor parte del c√≥digo est√° desactualizado.  Incluso las mejores partes del motor, de las cuales estamos orgullosos, a veces conten√≠an piezas de c√≥digo y algunos rudimentos de 5, 7 y otras incluso hace 10 a√±os.  Muchas soluciones arquitect√≥nicas fueron dise√±adas para dispositivos de esa √©poca, comenzando con un iPhone 3G.  Ahora nos enfocamos al menos en el iPad Air 1 y similares en dispositivos Android potentes.  En consecuencia, los enfoques han cambiado algo. <br><a name="habracut"></a><br>  Y la pregunta m√°s com√∫n: ¬øpor qu√© tener motor propio?  En el √∫ltimo art√≠culo hubo varios argumentos de diversos grados de persuasi√≥n.  Quiero concentrarme en lo principal: solo nuestra propia tecnolog√≠a puede permitirte aprovechar al m√°ximo el hierro, hacer el m√°ximo n√∫mero de optimizaciones espec√≠ficamente para tu estilo de juego y visual.  Nos posicionamos, incluso como una empresa de tecnolog√≠a, no solo como desarrollador de juegos.  Creemos que con nuestro nivel de ingenieros y nuestra experiencia podemos competir seriamente en el mercado de productos m√≥viles de alta tecnolog√≠a. <br><br>  Y ahora al grano: ¬øqu√© herramientas y t√©cnicas nos han ayudado a lograr esta tarea bastante ambiciosa en poco tiempo? <br><br><h4>  La infraestructura </h4><br>  Elegimos Atlassian Bitbucket Server + Jenkins.  En el Bitbucket se encuentra el repositorio principal (maestro), al que est√° conectado Jenkins.  Cada desarrollador tiene su propio tenedor.  Para cada tarea, se crea una nueva bifurcaci√≥n en la bifurcaci√≥n, que se integra de nuevo a trav√©s de la solicitud de extracci√≥n.  En general, el esquema es bastante est√°ndar.  Cada solicitud de extracci√≥n se somete a una revisi√≥n obligatoria y pruebas autom√°ticas.  Y, si tiene √©xito, se fusiona autom√°ticamente con el maestro. <br><br><h4>  Jenkins </h4><br>  Jenkins tiene varias deficiencias: es un bozal web antiguo, no muy r√°pido, glot√≥n, que parece un portal de Internet de los a√±os 90.  Sin embargo, su flexibilidad, una gran cantidad de m√≥dulos y su uso gratuito lo convierten en una buena opci√≥n incluso en 2019.  Despu√©s de jugar con los m√≥dulos y la configuraci√≥n, puede lograr una apariencia digerible, una descripci√≥n declarativa de las tuber√≠as (en el repositorio).  Por cierto, ahora hay alrededor de 40 canales: pruebas, editores, un juego para todas las plataformas;  trabajar con infraestructura de servidor y metagame.  Recoge todo 20 buildagentov. <br><br>  En el futuro, por supuesto, quiero probar soluciones modernas de hipster, por ejemplo, GitLab o TravisCI autohospedado.  No consideramos soluciones completamente en la nube (Nevercode, Bitrise, CircleCI, etc.) debido al gran tama√±o de nuestro repositorio, los activos y, en consecuencia, el tiempo de construcci√≥n y el tama√±o de los artefactos. <br><br><h4>  Sistema de construcci√≥n </h4><br>  El principal requisito para el sistema era el siguiente: generaci√≥n de proyectos para iOS, MacOS, Android, Windows, Linux en un solo script.  Logramos probar Premake, SCons, Bazel y CMake.  Por varias razones, nos detuvimos en el CMake probado por tiempo. <br><br>  En los √∫ltimos a√±os, CMake se ha convertido casi en el est√°ndar para las bibliotecas C ++.  Casi todo, desde abseil hasta SDL, se puede conectar a su proyecto CMake en solo unas pocas l√≠neas.  Por supuesto, hay excepciones, como OpenSSL o V8, con las que tuve que sudar un poco.  Adem√°s del Zmeik desnudo, desarrollamos un peque√±o marco (alrededor de 3.000 l√≠neas en total).  Caracter√≠sticas clave: <br>  Modularidad  Las partes individuales del motor est√°n dise√±adas como m√≥dulos.  Por ejemplo, sonido, interfaz de usuario, f√≠sica, red, etc.  Cada m√≥dulo puede tener sus propios activos (por ejemplo, sombreadores) y puede depender de otros m√≥dulos. <br><br>  La aplicaci√≥n final en el motor (juego, editor, utilidades) conecta solo los m√≥dulos que necesita.  Un poco aparte es el m√≥dulo central, que es una dependencia para la mayor√≠a de los otros m√≥dulos.  Core implementa el punto de entrada, el ciclo de aplicaci√≥n principal, la interacci√≥n con el sistema operativo y otras entidades b√°sicas. <br>  M√≥dulos de terceros.  Nuestro marco le permite descargar un repositorio o archivo git en varias l√≠neas, descomprimir, compilar, copiar bibliotecas y / o fuentes.  Hoy tenemos 66 m√≥dulos de terceros de este tipo: an√°lisis, formatos de archivos de terceros, middleware como f√≠sica, una biblioteca de sonido, etc. <br><br><h4>  Proceso de desarrollo </h4><br>  En base a la experiencia previa, decidimos agregar tanto el motor como el juego en un repositorio.  Esto te permite realizar cambios sin problemas en la API del motor y adaptar sincr√≥nicamente el juego.  El resultado fue el denominado monorepository con sus ventajas y desventajas.  Pero, como planeamos de inmediato mantener un ritmo de desarrollo muy alto, la posibilidad de una refactorizaci√≥n sincr√≥nica del motor y del juego super√≥ todas las dem√°s desventajas de esta soluci√≥n. <br><br>  En promedio, agregamos m√°s de 20 solicitudes de extracci√≥n por d√≠a.  Esto significa que el maestro puede romperse potencialmente 20 veces al d√≠a.  Afortunadamente, en 1991, se les ocurri√≥ la t√©cnica de integraci√≥n continua.  ¬øA qu√© hemos llegado? <br><br><h4>  Integraci√≥n continua </h4><br>  Como se mencion√≥ anteriormente, se crea un brunch para cada tarea en la bifurcaci√≥n del desarrollador.  A continuaci√≥n, se crea una solicitud de extracci√≥n desde este brunch al repositorio principal.  Esta solicitud de extracci√≥n pasa una serie de pruebas automatizadas en Jenkins: <br><br><ol><li>  Pruebas unitarias para todas las plataformas (windows, linux, macos, ios, android).  Googletest se usa como base, y OpenCppCoverage, cuyo informe es verificado por un script de python adicional, se usa para verificar el porcentaje de cobertura.  Si el porcentaje de cobertura para un archivo en particular es inferior al 75%, la prueba se considera fallida.  Por lo tanto, hemos cubierto la mayor√≠a de las clases de motores de bajo nivel con pruebas. </li><li>  Formateador de c√≥digo  Para el c√≥digo C ++ usamos el formato clang.  El formateo del c√≥digo modificado primero ocurre autom√°ticamente cuando se confirma en la m√°quina del desarrollador, y luego se verifica en la prueba.  Para javascript, que se usa como lenguaje de script, se usa npm linter. </li><li>  Pruebas de activos.  Un grupo bastante grande de pruebas: desde la validaci√≥n de formatos de archivo hasta la verificaci√≥n de dependencias (por ejemplo, verificar que la textura utilizada en el nivel del juego existe). </li><li>  Pruebas unitarias y funcionales del editor.  Una parte integral del motor es el editor, donde se crean y editan los niveles de juego y otros activos.  Adem√°s de las pruebas unitarias, froglogic Squish for Qt se usa para probar el editor, una utilidad para pruebas autom√°ticas de GUI.  Todo esto nos permite prescindir de las pruebas manuales del editor.  Adem√°s, seg√∫n las rese√±as de artistas y dise√±adores de nivel, el nivel de su calidad y estabilidad es m√°s alto que en la compa√±√≠a anterior, cuando ten√≠amos un equipo de cinco evaluadores.  Al mismo tiempo, las liberaciones ocurren diariamente, y con las pruebas manuales, las liberaciones ocurren cada 2 semanas. </li><li>  Pruebas funcionales del juego.  Est√° claro que quiero usar pruebas funcionales autom√°ticas para el juego.  Por lo tanto, comenzamos a desarrollar el siguiente sistema: </li></ol><br><ul><li>  La aplicaci√≥n de prueba (espec√≠ficamente, un script de Python) lanza un servidor de juegos y un cliente con ciertos par√°metros </li><li>  el servidor y el cliente en ejecuci√≥n abren el puerto de red, </li><li>  La aplicaci√≥n de prueba se conecta a ellos y env√≠a comandos: descargue un mapa, seleccione un personaje y armas, mu√©vase a un punto, apunte, dispare, etc. </li><li>  la sintaxis de prueba en s√≠ es python pytest.  Este sistema se encuentra actualmente en desarrollo activo. </li></ul><br>  La mayor√≠a de los proyectos para pruebas se recopilan con el indicador "tratar advertencias como errores" activado y en la plataforma MacOS con el clang AddressSanitizer activado adicionalmente, lo que le permite detectar a√∫n m√°s errores en la etapa de preparaci√≥n de la solicitud de extracci√≥n. <br><br>  Adem√°s de las pruebas, cada solicitud de extracci√≥n es revisada por al menos otros dos desarrolladores y, si es necesario, se env√≠a para su revisi√≥n.  Cuando se hayan completado todas las pruebas y los revisores no tengan comentarios, la solicitud de extracci√≥n se congela autom√°ticamente. <br>  Dado que algunas pruebas pueden llevar un tiempo considerable (por ejemplo, una prueba completa del editor de GUI dura m√°s de una hora), se utiliza un script acortado en las solicitudes de extracci√≥n.  El conjunto completo de pruebas se inicia en el asistente cada 4 horas. <br><br>  Hasta la fecha, 6.600 misiones de extracci√≥n han sido creadas y mantenidas de tal manera. <br><br><img src="https://habrastorage.org/webt/sh/io/7k/shio7kkx60nm-urpb2sx97z9w0s.jpeg"><br><br><h4>  Entrega continua </h4><br>  Utilizamos el concepto de lanzamientos autom√°ticos diarios (o m√°s bien diarios).  C√≥mo sucede exactamente esto: <br><br><ol><li>  se crea la etiqueta git, </li><li>  ejecuta versiones completas de todas las pruebas, </li><li>  Si tiene √©xito, se recogen los artefactos: </li></ol><br><ul><li>  editores para MacOS y Windows.  Por lo tanto, cada ma√±ana todos tienen una versi√≥n nueva de las herramientas.  Y, gracias a las pruebas autom√°ticas, confiamos en su cierta calidad y estabilidad. </li><li>  Juego cliente y servidor para todas las plataformas.  El cliente para iOS se carga en TestFlight, en Android, en Google Play, en otras plataformas, en JFrog Artifactory, servidores de juegos y otros servicios, en la nube.  Es decir, todas las ma√±anas tenemos una nueva versi√≥n del juego, lista para pruebas y pruebas de juego. </li></ul><br>  Por supuesto, no todos los lanzamientos nocturnos finalizan con √©xito.  Algunas pruebas pueden fallar o se producir√° un error cr√≠tico al iniciar la aplicaci√≥n.  En este caso, el desarrollador de servicio repara los problemas encontrados durante el d√≠a y se reinicia el proceso de lanzamiento. <br>  Hay varios en servicio todos los d√≠as: <br><br><ol><li>  Asistente de 1er nivel.  Supervisa la estabilidad de las pruebas en el repositorio principal. </li><li>  Asistente de segundo nivel en el juego.  Reparaci√≥n de errores del juego. </li><li>  Asistente de segundo nivel en editores.  Corrige errores editoriales, aconseja a los usuarios (artistas, dise√±adores de niveles, dise√±adores de juegos). </li></ol><br>  Tambi√©n en el d√≠a de servicio, puede incurrir en deudas t√©cnicas: agregue las pruebas faltantes para la funcionalidad anterior, complemente la documentaci√≥n o realice la refactorizaci√≥n, lo que no toma tiempo durante la planificaci√≥n de lanzamiento habitual. <br><br><img src="https://habrastorage.org/webt/bu/kf/w-/bukfw-ef19i1in1woa5ozjxgecm.jpeg"><br><br>  En el pr√≥ximo art√≠culo, veremos m√°s de cerca la arquitectura de software del motor, as√≠ como los m√≥dulos y subsistemas principales. <br><br>  Continuar√° ... <br><br>  La primera parte: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/en/post/461623</a> <br><br><img src="https://habrastorage.org/webt/ic/l2/m8/icl2m8bbkuivjomsbt8ugzsibus.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/465343/">https://habr.com/ru/post/465343/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../465323/index.html">¬øQu√© ser√° la criptograf√≠a post-cu√°ntica?</a></li>
<li><a href="../465325/index.html">Objetos especiales que son dif√≠ciles de agarrar robots</a></li>
<li><a href="../465329/index.html">Modelo de aprendizaje autom√°tico interpretado. Parte 2</a></li>
<li><a href="../465333/index.html">C√≥mo mirar a los ojos de Cassandra y no perder datos, estabilidad y fe en NoSQL</a></li>
<li><a href="../465341/index.html">C√≥mo crear una nube privada para videovigilancia</a></li>
<li><a href="../465345/index.html">Evento de contrataci√≥n m√≥vil FunCorp</a></li>
<li><a href="../465349/index.html">¬øNecesita Agile: 5 modelos para probar</a></li>
<li><a href="../465351/index.html">Problemas comunes para quienes ganaron el Gostender</a></li>
<li><a href="../465353/index.html">Auditor√≠a de seguridad de ICS</a></li>
<li><a href="../465355/index.html">Cuando 'a' no es igual a 'a'. A ra√≠z de un truco</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>