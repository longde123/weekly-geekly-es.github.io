<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🔀 👐🏿 🕳️ 引导程序分析 💮 🏼 🤸🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="大家好！ 与“逆向工程”课程的启动有关，我们举办了有计划的公开课。 它在加载的不同阶段分解了bootkit操作算法 。 



 讲师-卡巴斯基实验室病毒分析师Arthur Pakulov 。 

 以下文章是介绍性文章，并且是该课程的一部分的纯文本版本，专门用于bootkit安装程序。 有关boo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>引导程序分析</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/482086/"> <i>大家好！</i>  <i>与<a href="https://otus.pw/1uOJ/">“逆向工程”</a>课程的启动有关<a href="https://otus.pw/1uOJ/">，</a>我们举办了有计划的公开课。</i>  <i>它在加载的不同阶段分解<b>了bootkit操作算法</b> 。</i> <br><br><img src="https://habrastorage.org/webt/do/x7/rb/dox7rbq794sk5rkgvwrpq42lq6g.jpeg"><br><br> 讲师-卡巴斯基实验室病毒分析师<a href="https://otus.pw/G9ih/">Arthur Pakulov</a> 。 <br><br>  <b><i>以下文章是介绍性文章，并且是该课程的一部分的纯文本版本，专门用于bootkit安装程序。</i></b>  <b><i>有关bootkit本身的详细分析，请参见视频。</i></b> <a name="habracut"></a><br><br> 引导程序包是一个恶意程序，会修改主引导记录，即第一个物理磁盘或引导扇区VBR的第一个扇区。 这类程序基本上具有Trojan功能，可用于执行系统中的任何隐藏操作。 在我们的示例中，bootkit将特权提升至系统级别的进程，该进程的名称以字母序列“ inte”开头。 实际上，bootkit是在0保护环中开始工作的rootkit，该保护环甚至在操作系统开始加载之前就已启动。 因此，他对研究产生了极大的兴趣。 <br><br> 要开发这样的程序，通常的逆向工程技能还不够。 仅仅能够阅读清单是不够的，您还需要了解处理器架构，内存寻址等内容。我们在一个公开课程中研究了Bootkit的关键位置。 <br><br> 为了工作，准备了一个特殊的示例bootkit-xp.exe，可在Windows XP下运行。 因此，除了研究bootkit之外，我们还对该操作系统有些怀旧。 但是总的来说，选择OS XP是为了使其更容易反转，因为XP具有很好的可视化效果并且没有不必要的复杂性。 好吧，根据其代码判断，该示例是专门为此操作系统编写的。 <br><br> 这<a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D425">是bootkit安装程序的样子</a> ： <br><br><img src="https://habrastorage.org/webt/f4/-4/lr/f4-4lrdezgkdeeokbuyk9w0-4jy.png"><br><br> 仅查看它，您就可以得出某些结论。 例如，很明显该文件的重量很小。 如果查看入口点，则可以看到该代码正在接收文件描述符，该文件描述符具有指向第一个物理磁盘的符号链接的名称-“ PhysicalDrive0”： <br><br><img src="https://habrastorage.org/webt/qy/3k/ug/qy3kugjvk78hnhogjugvfcf2ggc.png"><br><br> 此外，为了便于识别代码，我们<a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D612">切换到IDA</a> 。 很明显，对于典型的木马而言，可用功能很小。 甚至导入表也很小： <br><br><img src="https://habrastorage.org/webt/fa/jw/pm/fajwpmunsgdiuiicltttrjuum-q.png"><br><br> 这种图像通常在分析包装样品时出现。 但是，在我们的情况下，该文件看起来并不打包。 事实证明，该示例要么被某个保护器/加密器所覆盖，并且在其工作过程中以动态方式接收功能的地址，然后调用所需的功能，否则一切都很好，并且示例保持原样。 <br><br> 我们继续探索代码。 <br><br><img src="https://habrastorage.org/webt/dd/ap/6r/ddap6rpjjwbfz3zzamn_0folqro.png"><br><br> 正如我们在HIEW中看到的那样，使用一个有趣的参数作为第一个参数调用了<b>CreateFileA</b>函数。 在这里，应该回顾一下诸如<b>内核对象之</b>类的东西。 它们不能直接从用户模式进行操作，它们是由操作系统的内核控制的。 在用户模式下，程序只能发出请求以接收/更改任何内核对象的状态。 为了向系统指示程序将使用哪个特定的内核对象，需要获取所需内核对象的句柄。 在收到请求后，如果所有检查都通过，则操作系统将把<b>所</b>请求的OA的<b>句柄</b>返回给我们。 并且已经使用了handle，我们可以使用关联的OA。 <br><br> 因此，在上图中，使用CreateFile，符号链接被访问到第一个连接的物理硬盘。 如果授予访问权限，则可以像处理其他任何简单文件一样使用“文件”。 即，整个硬盘将显示为单个大文件。 <br><br> 因此，让我们继续。 句柄又回来了，我们发现自己在这里： <br><br><img src="https://habrastorage.org/webt/zr/1e/1x/zr1e1xk7dhetlxfyumiqyrfnvn4.png"><br><br> 接下来会发生什么？ 然后， <b>ReadFile</b>函数读取前0x200字节。 而且我们在第一个物理磁盘的第一个扇区。 <br><br><img src="https://habrastorage.org/webt/ev/p8/sc/evp8sct8igaytj9d3ardoecem3u.png"><br><br> 您可能已经猜到了，这是<a href="https://ru.wikipedia.org/wiki/%25D0%2593%25D0%25BB%25D0%25B0%25D0%25B2%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25B3%25D1%2580%25D1%2583%25D0%25B7%25D0%25BE%25D1%2587%25D0%25BD%25D0%25B0%25D1%258F_%25D0%25B7%25D0%25B0%25D0%25BF%25D0%25B8%25D1%2581%25D1%258C">主引导记录</a> （MBR）。  MBR由3部分组成：代码部分，分区表和签名。 在正常情况下，BIOS将MBR读入内存中的地址0：0x7c00h，并将控制权传递给它。 因此，MBR的代码部分开始执行。 在执行期间，它解析分区表，找到启动扇区并加载它。 对于引导程序，如果MBR被覆盖，则其代码现在将获得控制。 <br><br> 好的，已读取MBR， <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D1832">下一步</a>是<a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D1832">什么</a> ？ 然后，bootkit再次以写访问模式打开PhysicalDrive0。 <br><br><img src="https://habrastorage.org/webt/dx/ca/sd/dxcasdk2lmaimniy-ghxtmpwfmc.png"><br><br> 接下来，将指针设置在第600个偏移处。 即， <b>原始扇区被读取并复制到第三扇区</b> 。 <br><br> 为什么要备份一个扇区？ 显然，这对于将来将需要它是必要的。 <br><br> 然后循环开始。 自然地，看着代码，人们只能注意var_1C， <b>1BEh</b>等常量。 并且，与此同时，位于上方的MBR结构应在内存中刷新。 特别是，我们对“偏移”列感兴趣。 <br><br><img src="https://habrastorage.org/webt/rq/jl/ac/rqjlacxma7m_0m_ldqqbomiqhfa.png"><br><br> 请参阅，第一个扇区的读取缓冲区在<b>lpBuffer中</b> 。 然后将<b>1BEh</b>添加到其中，实际上指针指向分区表的开头。 从表到扇区末尾的所有数据均从相同的偏移量-1BE开始插入_marked_bytes中。 <br><br><img src="https://habrastorage.org/webt/yj/en/ot/yjenotuk4hp061oe0qldeeu0j98.png"><br><br> 也就是说，原始MBR的第二部分和第三部分被插入<b>_marked_bytes中</b> 。 <br><br> 接下来会发生什么？  <b>然后SetFilePointer</b>将指针设置为“文件”的开头，即MBR。 <br><br><img src="https://habrastorage.org/webt/eb/7z/vb/eb7zvba8zitins67gn2vtiiu8gs.png"><br><br> 然后是一个写入（WriteFile），形成了<i>_marked_bytes</i>并释放了内存。 至此，bootkit安装程序的功能结束。 <br><br> 但是很高兴<a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2429">看到</a> <b>_marked_bytes</b>的第一部分<a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2429">到底</a>是<a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2429">什么</a> 。 为此，请将其转储到磁盘并进行分析。 引起您注意的第一件事是地址0x413处的变量内容减少了2。 <br><br><img src="https://habrastorage.org/webt/pq/_w/3k/pq_w3kqifhqcrnmjtebzseacgpu.png"><br><br> 如果查看技术文档，您会发现0X413变量包含以千字节为单位安装的物理内存量。 因此，bootkit代码“切断”了两千字节的内存： <br><br><img src="https://habrastorage.org/webt/gc/ks/kb/gckskbwy16b2m0k8sgwv6lg__zk.png"><br><br> 现在，为了不做进一步的工作，将考虑比以前少2 KB的内存。 为什么-尚不清楚。 <br><br>  <a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2734">接下来，</a>使用6位按位左移<a href="https://youtu.be/dwR0Lf3sbRQ%3Ft%3D2734">来</a>计算物理地址到“位关闭”存储器中： <br><br><img src="https://habrastorage.org/webt/9i/ve/qb/9iveqb9zzdser14szx1vnercz20.png"><br><br> 移位6一次执行两个操作-将千字节转换为字节（将变量的值乘以2 ^ 10），从而获得被咬掉的内存的物理地址，并从中提取段号，将结果除以0x10（2 ^ 4）。 <br><br> 之后，您的身体将被复制到这一块内存中，并且由于bootkit代码位于“ bit off”部分中，因此<b>没有人会进一步干扰它</b> 。 此外，中断不会改变该存储区中写入的内容。 我们可以说该<b>代码对于系统几乎是不可见的</b> ，就像那里没有内存一样。 <br><br> 这仅仅是bootkit的开始。 然后将进行中断拦截，ntldr签名跟踪，操作系统内核模块的修改等。 <br><br> 因此，我们不会破坏它，最好<a href="https://otus.pw/1uOJ/">观看网络研讨会</a>的结尾，以免错过任何内容。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482086/">https://habr.com/ru/post/zh-CN482086/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482070/index.html">五个有助于维持大脑表现的习惯</a></li>
<li><a href="../zh-CN482076/index.html">客户，信任asoshnikov</a></li>
<li><a href="../zh-CN482078/index.html">IT项目和IT团队的风险</a></li>
<li><a href="../zh-CN482080/index.html">Wi-Fi和LoRa之间的UDP网关</a></li>
<li><a href="../zh-CN482084/index.html">假期读什么</a></li>
<li><a href="../zh-CN482088/index.html">拥抱开发人员，或者我如何去KotlinConf</a></li>
<li><a href="../zh-CN482094/index.html">软件架构师：为什么需要它，什么是诅咒</a></li>
<li><a href="../zh-CN482096/index.html">VR和创造力：Dell Precision工作站如何帮助英国设计研究生院的学生</a></li>
<li><a href="../zh-CN482100/index.html">电子邮件中的AMP技术：优点，缺点和可能的用途</a></li>
<li><a href="../zh-CN482102/index.html">Habr Q＆A 2019：年度业绩</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>