<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🖐️ 🎠 🧑🏻‍🤝‍🧑🏻 ترقيع كود جافا عند الإنتاج بدون تخدير 👩🏿‍🏭 🙌 📡</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="هنا سأتحدث عن جهاز واحد من العديد من الأدوات التي تساعد في تطوير الخدمات المختلفة لمشروع Odnoklassniki. داخل الشركة ، نسميها "Hot Code Replace" (HCR) ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ترقيع كود جافا عند الإنتاج بدون تخدير</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/429040/" style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/webt/di/gh/wc/dighwcvw92d2zysgdcdref8_ptg.png" alt="الصورة"><br><br>  هنا سأتحدث عن جهاز واحد من العديد من الأدوات التي تساعد في تطوير الخدمات المختلفة لمشروع Odnoklassniki.  داخل الشركة ، نسميها "Hot Code Replace" (HCR) ، وقد تم تصميم هذه الأداة لإصلاح الأخطاء الحرجة وغير المعقدة في خدمات الإنتاج العاملة دون إيقافها.  هذه ميزة مهمة للغاية ، لأنها تسمح لك بتجنب عملية مملة ومستهلكة للوقت إلى حد ما لوضع نسخة جديدة مصححة من الخدمة غير المرغوب فيها ، لتجنب توقف مؤقت طويل بما فيه الكفاية في توفر كل مضيف ، وتجنب مسح ذاكرة التخزين المؤقت. <br><br>  بشكل عام ، يوفر الكثير من الوقت ويقلل الفاصل الزمني من لحظة اكتشاف الخطأ إلى التصحيح من ساعات إلى دقائق.  في معظم الأحيان ، كما كان مخططًا ، يتم إصلاح الأخطاء الطفيفة في الرمز ، على سبيل المثال ، نسي المبرمج للتحقق من عدم وجود خطأ ، وبالنسبة لبعض المستخدمين تؤدي بعض الإجراءات على الموقع إلى حدوث خطأ.  أي عندما يتم التصحيح عن طريق تغيير عدة خطوط داخل الطريقة.  ومن أجل مثل هذه التغييرات الطفيفة ، لم تعد بحاجة إلى تشتيت انتباه زملائك والانتظار لساعات من الإنتاج. <br><a name="habracut"></a><br>  على سبيل المثال: <br><br><img src="https://habrastorage.org/webt/ra/dh/vz/radhvzc9u4d1q6dc8r4v6uhlekq.png" alt="الصورة"><br>  يمكنك إصلاحه بسهولة على: <br><br><img src="https://habrastorage.org/webt/rp/9i/ta/rp9itax-od_0ahz3yg8dxdxvf7u.png" alt="الصورة"><br>  بالطبع ، يمكنك إجراء المزيد من التغييرات ، وفي الوقت نفسه إضافة فئات جديدة ، وإجراء التغييرات بسرعة التي يطلبها المدير في نفس الوقت ، دون انتظار التحديث التالي.  لكن هذا بالفعل ، إذا كان السيد Monsieur يعرف الكثير عن الانحرافات. <br><br>  علاوة على ذلك ، من الممكن وضع "بقع" على بعضها البعض وإلى ما لا نهاية. <br><br>  لكن هذه الأداة ليست <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">كلية الوجود</a> وتستند إلى الوظائف القياسية التي توفرها فئة Java: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">java.lang.instrument.Instrumentation وأسلوبها باطل redefineClasses (ClassDefinition ... تعريفات)</a> . <br><br>  Instrumentation.redefineClasses يستبدل الفئات التي تم تحميلها مسبقًا برمز بايت جديد.  يمكنك تحميل عدة فئات مع تبعيات مختلفة في نفس الوقت.  لا يؤدي التحميل الزائد إلى تغيير مثيلات الصف الموجودة ، ولا يغير الميراث ، ولا يلمس مثيلات أو حقول الصف.  يمكنك فقط تغيير نص الطريقة ، ومجموعة الثوابت والسمات.  يمكنك إضافة فئات أو فئات فرعية جديدة.  لا يمكن تغيير توقيعات الطريقة وحقول المثيل وحقول الفئة.  إذا حاولت إجراء تغييرات غير متوافقة ، فلن تعمل redefineClasses من حيث المبدأ وستظهر خطأ.  يجب أن نتذكر أنه عندما يتم تحميل الفئات بشكل زائد ، لا يتم مقاطعة تنفيذ قسم التحميل الزائد من التعليمات البرمجية ، سيتم استخدام الرمز الثانوي الجديد في المرة التالية التي يتم فيها استدعاء نفس الطريقة.  وبالتالي ، إذا حاولت إصلاح رمز الطريقة التي تحتوي على دورة طويلة بشكل لا نهائي في الداخل ، فلن يتم الاستبدال الفعلي إلا بعد انتهاء هذه الدورة. <br><br>  إذا بكل بساطة: يمكنك تغيير الرمز فقط داخل الأساليب والنقطة. <br><br>  وهنا مثال على حلقة while ، والتي لن يتم إصلاحها حتى اكتمال الطريقة. <br><br><img src="https://habrastorage.org/webt/p7/rv/1a/p7rv1agfvd0f7phg4otdxedkohk.png" alt="الصورة"><br><br>  كانت الصعوبة الرئيسية هي إنشاء أداة تعمل في النظام البيئي Odnoklassniki ، وهي أداة تناسب جميع عمليات العمل القائمة.  والتي سوف تتفاعل باستمرار وشفافية مع جميع الخدمات على مئات من المضيفين ، وكذلك تكون مرنة وسهلة الاستخدام.  يجب أن تتوافق هذه الأداة مع عشرات التجارب والأعمال والتحديثات التي تحدث باستمرار عند الإنتاج. <br><br>  كيف تبدو عملية تثبيت التصحيح من مطور / مشرف يحاول إصلاح خطأ في الإنتاج ، ولكن بطريقة يمكن القيام بها باستخدام بعض الإجراءات القياسية والموثوقة على عشرات الخوادم.  نحذف عملية العثور على الأخطاء في التعليمات البرمجية وإصلاحها. <br><br>  1. يتم إنشاء غداء منفصل في GIT لإصلاحات التعليمات البرمجية.  استخدام الإصدار مهم للغاية ليس فقط بسبب الراحة ، ولكن أيضًا لإجراء تحقيقات لاحقة محتملة. <br><br>  2. تطلق TeamCity عملية بناء التصحيح.  أولاً ، يتم إنشاء تجميع مشروع من الإفطار المتأخر المحدد ، ثم تتم مقارنة التجميع الجديد بالتجميع المثبت على الإنتاج.  للقيام بذلك ، كتبت مكونًا إضافيًا لأداة الإنشاء ، والذي يستخرج جميع الملفات من الأرشيفات ويقارن التناقضات ويحدد فقط الملفات التي تغيرت أو تمت إضافتها.  في هذه الحالة ، يجب أن يكون إصدار مترجم Java في كلا التجميعين هو نفسه ، لأنه  سيقوم إصدار آخر من المحول البرمجي بإنشاء ملفات مختلفة وسيتم تضمين جميع ملفات المشروع تقريبًا في التصحيح.  من المهم جدًا إنشاء أرشيف صغير فقط ، حيث ستحصل على الملفات الضرورية فقط  سيؤدي ذلك إلى تسريع عملية تسليم التصحيح إلى عشرات الخوادم.  عملية البناء مناسبة ليس فقط من أجل تصحيح رمز المشروع ، ولكن يمكنك أيضًا استبدال المكتبة المصححة في المشروع.  عند مقارنة محتويات مجموعتين ، سيتم العثور على اختلافات في المكتبات (ملفات jar). <br><br>  3. في حالة التجميع الناجح ، يتم إرسال التصحيح إلى مستودع خاص ، وفي نافذة النتائج يتم إصدار مفتاح (أو تجزئة) ، وهو مطلوب لتعريف التصحيح بشكل فريد وبعض الضمانات بأن هذا الرمز سيصل إلى الإنتاج. <br><br><img src="https://habrastorage.org/webt/7v/c5/es/7vc5esvpyls4kbc-djqnyxp5owq.png" alt="الصورة"><br><br>  حسنًا ، ومرة ​​أخرى - يمكنك تصحيح عدد غير محدود من المرات ، وستختلف الإصدارات بنفس رقم الإصدار باختلاف التجزئة. <br><br>  4. بعد ذلك ، يتم نقل جميع الأنشطة إلى خدمة التهيئة ، حيث يمكنك في واجهة المستخدم المعتادة تحديد أي خدمة ، وأي مضيفين وإصدارات التطبيقات التي تحتاج إلى تصحيحها. <br><br><img src="https://habrastorage.org/webt/pd/qf/um/pdqfummd7yqcqr0igjjbdshtnqk.png" alt="الصورة"><br><br>  توفر هذه الوفرة من المعلمات المستوى الضروري من مرونة الإعدادات ، وهو أمر مهم جدًا في حديقة حيوانات كبيرة من العديد من الخوادم.  لنفترض أنه في جزء ما من الخوادم ، يختلف رقم إصدار التطبيق ، ولا تحتاج إلى تصحيح هذا الرمز على الإطلاق.  أو ، للتحقق ، يتم تشغيل Hot Code Rreplace لأول مرة على خادم واحد ، أو على مجموعة من الخوادم ، ثم يتم توزيعه عبر جميع مثيلات التطبيق. <br><br>  5. من خلال تغيير التكوين ، تتلقى الخدمات المحددة معلومات حول ما يلزم تثبيت التصحيح ، وإصداره وتجزئة التحقق.  الفكرة هي أن جميع الخدمات تتلقى الأمر "تثبيت التصحيح" ثم تعمل بشكل مستقل.  يقارنون بشكل مستقل نسختهم الخاصة وفقط إذا كان الإصدار متطابقًا وتجزئة التجزئة مفقودة أو مختلفة ، يقومون بتنزيل مجموعة التصحيح بشكل مستقل من المستودع.  تتم عملية التنزيل نفسها عبر HTTP ، ويمكنك تغيير عنوان المستودع وعدد محاولات التنزيل وفترة الانتظار بين عمليات إعادة المحاولة بسرعة. <br><br>  6. يتحقق كل تطبيق محليًا من تجزئة التجميع ويفككه.  في هذه الحالة ، يتم التحقق من وجود كل ملف في الصفيف من بين تلك التي تم إرجاعها بواسطة Instrumentation.getAllLoadedClasses () ، تتم كتابة جميع الفئات والملفات الجديدة إلى فئة جديدة - مسار مؤقت مؤقت ، وتتم إضافة مسار الصف هذا من خلال Instrumentation.appendToSystemClassLoaderSearch () ، وتتم قراءة الفئات الموجودة في الذاكرة و تمر من خلال طريقة redefineClasses. <br><br>  7. العملية برمتها: يتم تسجيل وصول إشارة حول الحاجة إلى تصحيح التطبيق وتحميله والتحقق منه وتفريغه وتسجيله بالتفصيل ، في كل من السجل العام مع التطبيق وفي حد ذاته ، بحيث يمكنك بسرعة وبدون إيماءات غير ضرورية مراقبة العملية. <br><br>  8. بعد تطبيق التصحيح بنجاح ، تنتهي العملية بتغيير إصدار التطبيق إلى الإصدار المرقع عن طريق إضافة خط مكون خصيصًا بما في ذلك تجزئة التصحيح.  في حالة عدم تغير الإصدار بالنسبة لبعض المضيف إلى الإصدار المتوقع ، ننتقل إلى سجل استبدال الرمز الساخن لهذا المضيف ونرى ما حدث هناك.  إذا كانت هذه مشاكل في الاتصال ، فيمكنك تكرار أمر التصحيح بأمان وسيحاول المضيف المطلوب مرة أخرى. <br><br>  ما هي المشاكل المحتملة التي قد تمنع التطبيق من الترقيع؟  هناك عدد غير قليل منها ، ومن بينها وظيفة فئة العدادات التي سأضعها في المركز الأخير.  حتى الآن ، تم دائمًا وميض التعليمات البرمجية المعوجة التي لا تستوفي الشروط الصارمة لإعادة تعريف الفئات من قبل JVM دون أي عواقب على التطبيق.  عند تطبيق طريقة redefineClasses ، توقف JVM التطبيق تمامًا ، لكن هذه العملية تستغرق جزءًا من الثانية.  لأنها ليست مخيفة على الإطلاق. <br><br>  اللحظة الأكثر خطورة هي تسليم التصحيح إلى الخادم ، والذي تم تحديده من خلال عمليات إعادة تدريب إضافية.  ولكن إذا لم تساعد عمليات إعادة التدريب ، فيمكنك تكرار الأمر لاستدعاء التصحيح وسيحاول كل مضيف تكرار العملية ، ولكن تثبيت التصحيح فقط إذا لزم الأمر ، أي  لم يتم تثبيت التصحيح مسبقًا أو إذا تغير مفتاح التجزئة. <br><br>  مشكلة أخرى محتملة هي عندما يقوم الإصلاح بإصلاح خطأ واحد وإضافة خطأ جديد.  لتقليل هذه المخاطر ، نقوم أولاً بتحميل التصحيح إلى عدد محدود من الخوادم ، ونلقي نظرة على السجلات والرسوم البيانية ونراقب النتيجة.  وعندها فقط نطرح التصحيحات على المضيفين الآخرين. <br><br>  ماذا تفعل مع إعادة تشغيل تطبيق أو خادم؟  هذا مضمن بالفعل في منطق جميع تطبيقات الزملاء: أحد التطبيقات الأولى في أي تطبيق هو وحدة HCR.  وإذا لوحظت أثناء التهيئة معلومات حول الحاجة إلى تصحيح التطبيق ، فسيتم تطبيق التصحيح أولاً. <br><br>  والآن قليلاً عن ما يتكون منه Hot Code Replace. <br><br><ol style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  JavaAgent لدينا.  JavaAgent ، <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">إذا نسي أي شخص</a> ، هذا هو أرشيف * .jar منفصل ، تم تشكيله خصيصًا والذي يتم التقاطه بواسطة JVM عندما يبدأ التطبيق باستخدام معلمة إضافية ، على سبيل المثال: -javaagent: /path/to/lib/my-agent.jar بفضل الميزات الإضافية لـ Javaagent- ومن الممكن استخدام سحر استبدال الرمز.  في الوكيل ، تتوفر فئة java.lang.instrument.Instrumentation.  ولكن ، لم أسد له (الوكيل) برمز إضافي ، لأن  تحديث الوكيل هو مهمة غير تافهة ، ولكن ببساطة نقل مثيل فئة Instrumentation إلى الحقل الثابت لفئة الأداة المساعدة.  وبالتالي ، يمكن البدء في جميع التلاعبات من أي مكان في التطبيق. </li><li style=";text-align:right;direction:rtl">  خدمة التهيئة - هي المسؤولة عن تهيئة أي من تطبيقاتنا ، وبالتالي تتم تهيئتها في كل تطبيق أولاً.  هناك يتم إخفاء الوظيفة الرئيسية لاستبدال الرمز الساخن.  عند بدء تشغيل التطبيق أو عند تغيير تكوين HCR لتطبيق معين ، يتم التحقق من توافق الإصدار ويتم تنفيذ جميع المعالجات المذكورة أعلاه. </li><li style=";text-align:right;direction:rtl">  TeamCity وبناء البرامج النصية - لإنشاء "تصحيحات" بشكل ملائم وحفظ الفئات والموارد المعدلة أو المضافة فقط فيها. </li></ol><br>  ما هي المزايا التي لدينا من هذه الأداة؟  الأول هو سرعة تصحيح الأخطاء الفادحة في همز.  من السجلات ، أرى أن الزملاء بدأوا تدريجياً في استخدام HCR في كثير من الأحيان ، بدلاً من انتظار الإصدارات.  التالي هو سرعة التطبيق.  لا يحتاج التطبيق إلى إيقاف ، يتجمد JVM فقط لجزء من الثانية وتبقى جميع الأشياء الخاصة بك في أماكنها وتستمر في العمل. <br><br>  وقد شفي المطورون لدينا بحرية وسعادة وقاموا بتصحيح أخطائهم على الفور وبشكل مستقل مباشرة في الإنتاج بغض النظر عن عدد الخوادم والحمل. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar429040/">https://habr.com/ru/post/ar429040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar429030/index.html">يجعل Logomachine شعارات مجانية لكل تعليق</a></li>
<li><a href="../ar429032/index.html">أساسيات Splunk لتطبيق صناعة الخدمات المالية ، أو كيفية دخول Splunk إلى سوق تحليلات التمويل</a></li>
<li><a href="../ar429034/index.html">بعض القصص عن المبرمجين تحت الأرض</a></li>
<li><a href="../ar429036/index.html">ثق بي ، أنا أعرف ما أفعله: التكيف الذاتي للروبوت المعياري مع بيئة تنفيذ المهام</a></li>
<li><a href="../ar429038/index.html">Rust News # 2 (أكتوبر 2018)</a></li>
<li><a href="../ar429042/index.html">نحن نقوم باختبار SharxBase ، وهي منصة افتراضية للبرامج والأجهزة من البائع الروسي SharxDC</a></li>
<li><a href="../ar429044/index.html">شهدت أسهم شركة Apple أسوأ انخفاض منذ عام 2014. لقد خسر كبار المستثمرين المليارات</a></li>
<li><a href="../ar429046/index.html">أربع سنوات من تطوير SObjectizer-5.5. كيف تغير SObjectizer خلال هذا الوقت؟</a></li>
<li><a href="../ar429048/index.html">نصائح لمضيف مبتدئ</a></li>
<li><a href="../ar429050/index.html">تم تسجيل هجوم صرف العملات المشفرة Gate.io</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>