<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§µüèæ ü§õüèæ ‚úåüèª Pengantar Otorisasi Kubernetes Konsul Hashicorp üë®üèø‚Äç‚úàÔ∏è üë®üèø‚Äçüé® üë®üèª‚Äç‚úàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Itu benar, setelah rilis Konsul Hashicorp 1.5.0 pada awal Mei 2019 di Konsul, Anda dapat mengotorisasi aplikasi dan layanan yang berjalan di Kubernet ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Pengantar Otorisasi Kubernetes Konsul Hashicorp</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/nixys/blog/473014/"><img src="https://habrastorage.org/webt/ge/q3/ey/geq3eyqujybgzgmalsngtz3azuu.png"><br><p>  Itu benar, setelah rilis <a href="">Konsul Hashicorp 1.5.0</a> pada awal Mei 2019 di Konsul, Anda dapat mengotorisasi aplikasi dan layanan yang berjalan di Kubernet secara asli. </p><br><p>  Dalam tutorial ini, kita akan selangkah demi selangkah membuat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">POC</a> (Proof of concept, PoC - proof of concept) - mendemonstrasikan fitur baru ini. Pengetahuan dasar tentang Kubernetes dan Konsul Hashicorp diharapkan dari Anda. Dan meskipun Anda Anda dapat menggunakan platform cloud apa pun atau lingkungan di tempat, dalam panduan ini kami akan menggunakan Platform Cloud Google. </p><a name="habracut"></a><br><h2>  Ulasan </h2><br><p>  Jika kita beralih ke <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi Konsul tentang metode otorisasi</a> , kami akan mendapatkan tinjauan singkat tentang tujuan dan kasus penggunaannya, serta beberapa rincian teknis dan gambaran umum umum dari logika.  Saya sangat merekomendasikan membacanya setidaknya sekali sebelum melanjutkan, karena saya akan menjelaskan dan mengunyah semuanya sekarang. </p><br><img src="https://habrastorage.org/webt/ca/xp/mp/caxpmprm5u-8bupb1_fpjgehvcw.png"><br><p>  <i>Gambar 1: Ikhtisar Metode Resmi Konsul Resmi</i> </p><br><p>  Mari kita lihat <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi untuk metode otorisasi Kubernetes tertentu</a> . </p><br><p>  Tentu saja, ada informasi yang bermanfaat, tetapi tidak ada panduan tentang bagaimana sebenarnya menggunakan semua ini.  Karena itu, seperti orang waras, Anda menjelajahi internet untuk mendapatkan panduan.  Dan kemudian ... Dikalahkan.  Itu terjadi.  Mari kita perbaiki. </p><br><p>  Sebelum kita melanjutkan untuk membuat POC kita, mari kita kembali ke gambaran umum metode otorisasi Konsul (Gambar 1) dan memperbaikinya dalam konteks Kubernetes. </p><br><h2 id="arhitektura">  Arsitektur </h2><br><p>  Dalam panduan ini, kami akan membuat server Konsul pada mesin terpisah yang akan berinteraksi dengan kluster Kubernetes dengan klien Konsul diinstal.  Kemudian kita akan membuat aplikasi boneka di perapian dan menggunakan metode otorisasi khusus untuk membaca dari gudang Konsul / nilai nilai kami. </p><br><p>  Diagram di bawah ini menunjukkan secara rinci arsitektur yang kita buat dalam panduan ini, serta logika metode otorisasi, yang akan dijelaskan nanti. </p><br><img src="https://habrastorage.org/webt/az/zn/kj/azznkjy-wrxrndezbwxezarbs-4.png"><br><p>  <em>Gambar 2: Tinjauan umum metode otorisasi di Kubernetes</em> </p><br><p>  Catatan singkat: Server konsul tidak perlu tinggal di luar cluster Kubernetes agar bisa berfungsi.  Tapi ya, dia bisa melakukan ini dan itu. </p><br><p> Jadi, dengan mengambil diagram ikhtisar Konsul (Skema 1) dan menerapkan Kubernet ke dalamnya, kita mendapatkan diagram di atas (Skema 2), dan di sini logikanya adalah sebagai berikut: </p><br><ol><li>  Setiap pod akan memiliki akun layanan terlampir yang berisi token JWT yang dihasilkan dan dikenal oleh Kubernetes.  Token ini juga dimasukkan ke dalam sub secara default. </li><li>  Aplikasi atau layanan kami di dalam perapian memulai perintah untuk memasuki klien Konsul kami.  Permintaan untuk masuk juga akan menunjukkan token kami dan nama metode otorisasi yang <strong>dibuat khusus</strong> (seperti Kubernetes).  Langkah No. 2 ini sesuai dengan langkah 1 skema Konsul (Skema 1). </li><li>  Klien Konsul kami kemudian akan meneruskan permintaan ini ke server Konsul kami. </li><li>  SIHIR!  Di sinilah server Konsul memverifikasi keaslian permintaan, mengumpulkan informasi tentang identitas permintaan dan membandingkannya dengan aturan yang telah ditentukan sebelumnya yang terkait.  Di bawah ini adalah diagram lain untuk menggambarkan ini.  Langkah ini sesuai dengan langkah 3, 4 dan 5 dari diagram ikhtisar Konsul (Skema 1). </li><li>  Server Konsul kami menghasilkan token Konsul dengan izin sesuai dengan aturan metode otorisasi yang kami tentukan (yang kami tentukan) mengenai identitas pemohon.  Kemudian dia akan mengirim token ini kembali.  Ini sesuai dengan langkah 6 skema Konsul (Skema 1). </li><li>  Klien Konsul kami mengalihkan token ke aplikasi atau layanan yang meminta. </li></ol><br><p>  Aplikasi atau layanan kami sekarang dapat menggunakan token Konsul ini untuk berkomunikasi dengan data Konsul kami, sebagaimana ditentukan oleh hak istimewa token. </p><br><h2 id="volshebstvo-raskryto">  Keajaiban terungkap! </h2><br><p>  Bagi Anda yang tidak senang hanya dengan kelinci di topi dan ingin tahu cara kerjanya ... biarkan saya "tunjukkan seberapa dalam <strong>lubang kelinci itu</strong> ." </p><br><p>  Seperti disebutkan sebelumnya, langkah "ajaib" kami (Skema 2: Langkah 4) adalah bahwa server Konsul memverifikasi keaslian permintaan, mengumpulkan informasi tentang permintaan tersebut dan membandingkannya dengan aturan yang telah ditentukan sebelumnya yang terkait.  Langkah ini sesuai dengan langkah 3, 4 dan 5 dari diagram ikhtisar Konsul (Skema 1).  Di bawah ini adalah diagram (Skema 3), yang tujuannya adalah untuk dengan jelas menunjukkan apa yang sebenarnya terjadi di <em>bawah tenda</em> metode otorisasi Kubernetes tertentu. </p><br><img src="https://habrastorage.org/webt/5e/5w/eg/5e5wegybhhtjkwkotfs1disgzc8.png"><br><p>  <em>Skema 3: Keajaiban terungkap!</em> </p><br><ol><li>  Sebagai titik awal, klien Konsul kami mengalihkan permintaan login ke server Konsul kami dengan token akun Kubernetes dan nama spesifik dari instance metode otorisasi yang dibuat sebelumnya.  Langkah ini sesuai dengan langkah 3 dalam penjelasan sirkuit sebelumnya. </li><li>  Sekarang server Konsul (atau pemimpin) perlu memverifikasi keaslian token yang diterima.  Oleh karena itu, ia akan berkonsultasi dengan kluster Kubernetes (melalui klien Konsul) dan, dengan izin yang sesuai, kami akan mencari tahu apakah token itu asli dan kepada siapa pemiliknya. </li><li>  Kemudian permintaan yang diverifikasi kembali ke pemimpin Konsul, dan server Konsul mencari contoh metode otorisasi dengan nama yang ditentukan dari permintaan login (dan ketik Kubernetes). </li><li>  Pemimpin konsul menentukan contoh spesifik dari metode otorisasi (jika ditemukan) dan membaca sekumpulan aturan yang mengikat yang dilampirkan padanya.  Dia kemudian membaca aturan-aturan ini dan membandingkannya dengan atribut identitas yang diverifikasi. </li><li>  Tada!  Lanjutkan ke langkah 5 dalam penjelasan sirkuit sebelumnya. </li></ol><br><h2 id="zapustite-consul-server-na-obychnoy-virtualnoy-mashine">  Jalankan Consul-server pada mesin virtual biasa </h2><br><p>  Mulai sekarang, saya terutama akan memberikan instruksi untuk membuat POC ini, seringkali dalam poin, tanpa seluruh kalimat yang jelas.  Juga, seperti disebutkan sebelumnya, saya akan menggunakan GCP untuk membuat seluruh infrastruktur, tetapi Anda dapat membuat infrastruktur yang sama di tempat lain. </p><br><ul><li>  Mulai mesin virtual (instance / server). </li></ul><br><img src="https://habrastorage.org/webt/gg/5m/j-/gg5mj-dyw9frdaglrfwizvbkna8.png"><br><ul><li>  Buat aturan untuk firewall (grup keamanan di AWS): </li><li>  Saya suka menetapkan nama mesin yang sama untuk aturan dan tag jaringan, dalam hal ini adalah "skywiz-consul-server-poc". </li><li>  Temukan alamat IP komputer lokal Anda dan tambahkan ke daftar alamat IP sumber sehingga kami dapat mengakses antarmuka pengguna (UI). </li><li>  Buka port 8500 untuk UI.  Klik Buat.  Kami akan segera mengubah firewall ini. </li><li>  Tambahkan aturan untuk firewall ke instance.  Kembali ke dasbor VM di server Konsul dan tambahkan "skywiz-consul-server-poc" ke bidang tag jaringan.  Klik Simpan. </li></ul><br><img src="https://habrastorage.org/webt/o3/7i/52/o37i52gc_8k8fxu4ve113oh7ljc.png"><br><ul><li>  Instal Konsul di mesin virtual, periksa di sini.  Ingat bahwa Anda memerlukan versi Konsul ‚â• 1,5 [tautan] </li><li>  Buat Konsul simpul tunggal - konfigurasinya adalah sebagai berikut. </li></ul><br><pre><code class="plaintext hljs">groupadd --system consul useradd -s /sbin/nologin --system -g consul consul mkdir -p /var/lib/consul chown -R consul:consul /var/lib/consul chmod -R 775 /var/lib/consul mkdir /etc/consul.d chown -R consul:consul /etc/consul.d</code> </pre> <br><ul><li>  Untuk panduan lebih rinci tentang cara menginstal Konsul dan mengatur sekelompok 3 simpul, lihat di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . </li><li>  Buat file /etc/consul.d/agent.json sebagai berikut [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> ]: </li></ul><br><pre> <code class="plaintext hljs">### /etc/consul.d/agent.json { "acl" : { "enabled": true, "default_policy": "deny", "enable_token_persistence": true } }</code> </pre> <br><ul><li>  Luncurkan server Konsul kami: </li></ul><br><pre> <code class="plaintext hljs">consul agent \ -server \ -ui \ -client 0.0.0.0 \ -data-dir=/var/lib/consul \ -bootstrap-expect=1 \ -config-dir=/etc/consul.d</code> </pre> <br><ul><li>  Anda akan melihat banyak output dan berakhir dengan "... pembaruan diblokir oleh ACL". </li><li>  Temukan alamat IP eksternal dari server Konsul dan buka browser dengan alamat IP ini pada port 8500. Pastikan UI terbuka. </li><li>  Coba tambahkan pasangan kunci / nilai.  Pasti ada kesalahan.  Ini karena kami memuat server Konsul menggunakan ACL dan menolak semua aturan. </li><li>  Kembali ke shell Anda di server Konsul dan mulai proses di latar belakang atau dengan beberapa cara lain agar bisa berfungsi, dan masukkan yang berikut ini: </li></ul><br><pre> <code class="plaintext hljs">consul acl bootstrap</code> </pre> <br><ul><li>  Temukan nilai "SecretID" dan kembali ke UI.  Pada tab ACL, masukkan pengidentifikasi rahasia token yang baru saja Anda salin.  Salin SecretID di tempat lain, kita akan membutuhkannya nanti. </li><li>  Sekarang tambahkan pasangan kunci / nilai.  Untuk POC ini, tambahkan berikut ini: kunci: "custom-ns / test_key", nilai: "Saya di folder custom-ns!" </li></ul><br><h2 id="zapusk-kubernetes-klastera-dlya-nashego-prilozheniya-s-consul-klientom-v-kachestve-daemonset">  Luncurkan Kubernetes Cluster untuk aplikasi kami dengan Klien Konsul sebagai Daemonset </h2><br><ul><li>  Buat cluster K8s (Kubernetes).  Kami akan membuatnya di zona yang sama dengan server untuk akses yang lebih cepat, dan karenanya kami dapat menggunakan subnet yang sama untuk koneksi yang mudah dengan alamat IP internal.  Kami akan menyebutnya skywiz-app-with-consul-client-poc. </li></ul><br><img src="https://habrastorage.org/webt/_l/vp/gu/_lvpgupywaktqzykauebirhibm0.png"><br><ul><li>  Sebagai catatan, berikut ini adalah panduan bagus yang saya temui ketika mengatur cluster Konsul POC dengan Consul Connect. </li><li>  Kami juga akan menggunakan grafik helm Hashicorp dengan file nilai yang diperluas. </li><li>  Instal dan konfigurasikan Helm.  Langkah-langkah konfigurasi: </li></ul><br><pre> <code class="plaintext hljs">kubectl create serviceaccount tiller --namespace kube-system kubectl create clusterrolebinding tiller-admin-binding \ --clusterrole=cluster-admin --serviceaccount=kube-system:tiller ./helm init --service-account=tiller ./helm update</code> </pre> <br><ul><li>  grafik kemudi: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.consul.io/docs/platform/k8s/helm.html</a> </li><li>  Gunakan file nilai berikut (perhatikan sebagian besar yang saya nonaktifkan): </li></ul><br><pre> <code class="plaintext hljs">### poc-helm-consul-values.yaml global: enabled: false image: "consul:latest" # Expose the Consul UI through this LoadBalancer ui: enabled: false # Allow Consul to inject the Connect proxy into Kubernetes containers connectInject: enabled: false # Configure a Consul client on Kubernetes nodes. GRPC listener is required for Connect. client: enabled: true join: ["&lt;PRIVATE_IP_CONSUL_SERVER&gt;"] extraConfig: | { "acl" : { "enabled": true, "default_policy": "deny", "enable_token_persistence": true } } # Minimal Consul configuration. Not suitable for production. server: enabled: false # Sync Kubernetes and Consul services syncCatalog: enabled: false</code> </pre> <br><ul><li>  Terapkan grafik helm: </li></ul><br><pre> <code class="plaintext hljs">./helm install -f poc-helm-consul-values.yaml ./consul-helm - name skywiz-app-with-consul-client-poc</code> </pre> <br><ul><li>  Ketika mencoba memulai, itu akan memerlukan izin untuk server Konsul, jadi mari kita tambahkan mereka. </li><li>  Perhatikan "Rentang alamat Pod" yang terletak di dasbor kluster dan kembali ke aturan kami untuk firewall skywiz-consul-server-poc. </li><li>  Tambahkan rentang alamat untuk IPA ke daftar alamat IP dan buka port 8301 dan 8300. </li></ul><br><img src="https://habrastorage.org/webt/gh/wu/bi/ghwubingk53amwe3qnbiendjgvm.png"><br><ul><li>  Pergi ke UI Konsul, dan dalam beberapa menit Anda akan melihat bahwa cluster kami akan muncul pada tab node. </li></ul><br><img src="https://habrastorage.org/webt/j1/l_/h5/j1l_h5fj5iusg3ea3rxc7qc_sb8.png"><br><h2 id="nastroyka-metoda-avtorizacii-putem-integracii-consul-s-kubernetes">  Konfigurasikan metode otorisasi dengan mengintegrasikan Konsul dengan Kubernetes </h2><br><ul><li>  Kembali ke shell server Konsul dan ekspor token yang Anda simpan sebelumnya: </li></ul><br><pre> <code class="plaintext hljs">export CONSUL_HTTP_TOKEN=&lt;SecretID&gt;</code> </pre> <br><ul><li>  Kami membutuhkan informasi dari cluster Kubernetes kami untuk membuat contoh metode auth: </li><li>  kubernet-host </li></ul><br><pre> <code class="plaintext hljs">kubectl get endpoints | grep kubernetes</code> </pre> <br><ul><li>  kubernetes-service-account-jwt </li></ul><br><pre> <code class="plaintext hljs">kubectl get sa &lt;helm_deployment_name&gt;-consul-client -o yaml | grep "\- name:" kubectl get secret &lt;secret_name_from_prev_command&gt; -o yaml | grep token:</code> </pre> <br><ul><li>  Token dikodekan dalam base64, jadi dekripsi menggunakan alat favorit Anda [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> ] </li><li>  kubernetes-ca-cert </li></ul><br><pre> <code class="plaintext hljs">kubectl get secret &lt;secret_name_from_prev_command&gt; -o yaml | grep ca.crt:</code> </pre> <br><ul><li>  Ambil sertifikat "ca.crt" (setelah decoding dengan base64) dan tuliskan ke file "ca.crt". </li><li>  Sekarang buat instance metode auth, mengganti placeholder dengan nilai yang baru saja Anda terima. </li></ul><br><pre> <code class="plaintext hljs">consul acl auth-method create \ -type "kubernetes" \ -name "auth-method-skywiz-consul-poc" \ -description "This is an auth method using kubernetes for the cluster skywiz-app-with-consul-client-poc" \ -kubernetes-host "&lt;k8s_endpoint_retrieved earlier&gt;" \ -kubernetes-ca-cert=@ca.crt \ -kubernetes-service-account- jwt="&lt;decoded_token_retrieved_earlier&gt;"</code> </pre> <br><ul><li>  Selanjutnya, kita perlu membuat aturan dan melampirkannya ke peran baru.  Anda dapat menggunakan UI Konsul untuk bagian ini, tetapi kami akan menggunakan baris perintah. </li><li>  Tulis aturan </li></ul><br><pre> <code class="plaintext hljs">### kv-custom-ns-policy.hcl key_prefix "custom-ns/" { policy = "write" }</code> </pre> <br><ul><li>  Terapkan aturannya </li></ul><br><pre> <code class="plaintext hljs">consul acl policy create \ -name kv-custom-ns-policy \ -description "This is an example policy for kv at custom-ns/" \ -rules @kv-custom-ns-policy.hcl</code> </pre> <br><ul><li>  Temukan pengidentifikasi aturan yang baru Anda buat dari output. </li><li>  Buat peran dengan aturan baru. </li></ul><br><pre> <code class="plaintext hljs">consul acl role create \ -name "custom-ns-role" \ -description "This is an example role for custom-ns namespace" \ -policy-id &lt;policy_id&gt;</code> </pre> <br><ul><li>  Sekarang kita akan mengasosiasikan peran baru kita dengan instance metode auth.  Harap perhatikan bahwa bendera pemilih menentukan apakah permintaan masuk kami akan menerima peran ini.  Lihat opsi pemilih lainnya di sini: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.consul.io/docs/acl/auth-methods/kubernetes.html#trusted-identity-attributes</a> </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='custom-ns-role' \ -selector='serviceaccount.namespace=="custom-ns"'</code> </pre> <br><h2 id="konfiguracii-naposledok">  Konfigurasi terakhir </h2><br><h3 id="prava-dostupa">  Hak akses </h3><br><ul><li>  Buat izin.  Kami perlu memberikan izin kepada Konsul untuk memverifikasi dan mengidentifikasi identitas token akun layanan K8. </li><li>  Tulis <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">[tautan]</a> berikut ke file: </li></ul><br><pre> <code class="plaintext hljs">###skywiz-poc-consul-server_rbac.yaml --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: review-tokens namespace: default subjects: - kind: ServiceAccount name: skywiz-app-with-consul-client-poc-consul-client namespace: default roleRef: kind: ClusterRole name: system:auth-delegator apiGroup: rbac.authorization.k8s.io --- kind: ClusterRole apiVersion: rbac.authorization.k8s.io/v1 metadata: name: service-account-getter namespace: default rules: - apiGroups: [""] resources: ["serviceaccounts"] verbs: ["get"] --- kind: ClusterRoleBinding apiVersion: rbac.authorization.k8s.io/v1 metadata: name: get-service-accounts namespace: default subjects: - kind: ServiceAccount name: skywiz-app-with-consul-client-poc-consul-client namespace: default roleRef: kind: ClusterRole name: service-account-getter apiGroup: rbac.authorization.k8s.io</code> </pre> <br><ul><li>  Buat hak akses </li></ul><br><pre> <code class="plaintext hljs">kubectl create -f skywiz-poc-consul-server_rbac.yaml</code> </pre> <br><h3 id="podklyuchenie-k-consul-client">  Terhubung ke Klien Konsul </h3><br><ul><li>  Seperti disebutkan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> , ada beberapa opsi untuk menghubungkan ke daemonset, tetapi kita akan beralih ke solusi sederhana berikut: </li><li>  Terapkan file berikut [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> ]. </li></ul><br><pre> <code class="plaintext hljs">### poc-consul-client-ds-svc.yaml apiVersion: v1 kind: Service metadata: name: consul-ds-client spec: selector: app: consul chart: consul-helm component: client hasDNS: "true" release: skywiz-app-with-consul-client-poc ports: - protocol: TCP port: 80 targetPort: 8500</code> </pre> <br><ul><li>  Kemudian gunakan perintah bawaan berikut untuk membuat configmap [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> ].  Harap perhatikan bahwa kami merujuk pada nama layanan kami, ganti jika perlu. </li></ul><br><pre> <code class="plaintext hljs">cat &lt;&lt;EOF | kubectl apply -f - apiVersion: v1 kind: ConfigMap metadata: labels: addonmanager.kubernetes.io/mode: EnsureExists name: kube-dns namespace: kube-system data: stubDomains: | {"consul": ["$(kubectl get svc consul-ds-client -o jsonpath='{.spec.clusterIP}')"]} EOF</code> </pre> <br><h2 id="testirovanie-auth-metoda">  Menguji metode auth </h2><br><p>  Sekarang mari kita lihat keajaiban dalam aksi! </p><br><ul><li>  Buat beberapa folder kunci lagi dengan kunci tingkat atas yang sama (mis. &lt;new_folder&gt; / sample_key) dan nilai pilihan Anda.  Buat kebijakan dan peran yang sesuai untuk jalur utama baru.  Kami akan melakukan binding nanti. </li></ul><br><img src="https://habrastorage.org/webt/qm/yi/jn/qmyijnz6f7yy4kx-3l6owupoulk.png"><br><h3 id="polzovatelskiy-test-prostranstva-imen">  Tes namespace khusus: </h3><br><ul><li>  Buat namespace kami sendiri: </li></ul><br><pre> <code class="plaintext hljs">kubectl create namespace custom-ns</code> </pre> <br><ul><li>  Buat di bawah di namespace baru kami.  Tulis konfigurasi untuk perapian. </li></ul><br><pre> <code class="plaintext hljs">###poc-ubuntu-custom-ns.yaml apiVersion: v1 kind: Pod metadata: name: poc-ubuntu-custom-ns namespace: custom-ns spec: containers: - name: poc-ubuntu-custom-ns image: ubuntu command: ["/bin/bash", "-ec", "sleep infinity"] restartPolicy: Never</code> </pre> <br><ul><li>  Buat di bawah: </li></ul><br><pre> <code class="plaintext hljs">kubectl create -f poc-ubuntu-custom-ns.yaml</code> </pre> <br><ul><li>  Setelah wadah dimulai, pergi ke sana dan instal keriting. </li></ul><br><pre> <code class="plaintext hljs">kubectl exec poc-ubuntu-custom-ns -n custom-ns -it /bin/bash apt-get update &amp;&amp; apt-get install curl -y</code> </pre> <br><ul><li>  Sekarang kami akan mengirim permintaan untuk masuk ke Konsul menggunakan metode otorisasi yang kami buat sebelumnya [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> ]. </li><li>  Untuk melihat token yang dimasukkan dari akun layanan Anda: </li></ul><br><pre> <code class="plaintext hljs">cat /run/secrets/kubernetes.io/serviceaccount/token</code> </pre> <br><ul><li>  Tuliskan yang berikut ke file di dalam wadah: </li></ul><br><pre> <code class="plaintext hljs">### payload.json { "AuthMethod": "auth-method-test", "BearerToken": "&lt;jwt_token&gt;" }</code> </pre> <br><ul><li>  Login! </li></ul><br><pre> <code class="plaintext hljs">curl \ --request POST \ --data @payload.json \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Untuk menyelesaikan langkah-langkah di atas pada satu baris (karena kami akan menjalankan beberapa tes), Anda dapat melakukan hal berikut: </li></ul><br><pre> <code class="plaintext hljs">echo "{ \ \"AuthMethod\": \"auth-method-skywiz-consul-poc\", \ \"BearerToken\": \"$(cat /run/secrets/kubernetes.io/serviceaccount/token)\" \ }" \ | curl \ --request POST \ --data @- \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Itu berhasil!  Setidaknya harus.  Sekarang ambil SecretID dan coba akses kunci / nilai yang harus kita akses. </li></ul><br><pre> <code class="plaintext hljs">curl \ consul-ds-client.default.svc.cluster.local/v1/kv/custom-ns/test_key --header ‚ÄúX-Consul-Token: &lt;SecretID_from_prev_response&gt;‚Äù</code> </pre> <br><ul><li>  Anda dapat mendekodekan "Nilai" base64 dan melihat bahwa itu cocok dengan nilai di custom-ns / test_key di UI.  Jika Anda menggunakan nilai yang sama di atas dalam manual ini, nilai Anda yang dikodekan adalah IkknbSBpbiB0aGUgY3VzdG9tLW5zIGZvbGRlciEi. </li></ul><br><h3 id="test-uchetnoy-zapisi-polzovatelskoy-sluzhby">  Tes Akun Layanan Pengguna: </h3><br><ul><li>  Buat ServiceAccount kustom dengan perintah [ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tautan</a> ] berikut. </li></ul><br><pre> <code class="plaintext hljs">kubectl apply -f - &lt;&lt;EOF apiVersion: v1 kind: ServiceAccount metadata: name: custom-sa EOF</code> </pre> <br><ul><li>  Buat file konfigurasi baru untuk perapian.  Harap dicatat bahwa saya menyalakan instalasi keriting untuk menghemat tenaga kerja :) </li></ul><br><pre> <code class="plaintext hljs">###poc-ubuntu-custom-sa.yaml apiVersion: v1 kind: Pod metadata: name: poc-ubuntu-custom-sa namespace: default spec: serviceAccountName: custom-sa containers: - name: poc-ubuntu-custom-sa image: ubuntu command: ["/bin/bash","-ec"] args: ["apt-get update &amp;&amp; apt-get install curl -y; sleep infinity"] restartPolicy: Never</code> </pre> <br><ul><li>  Setelah itu, jalankan shell di dalam wadah. </li></ul><br><pre> <code class="plaintext hljs">kubectl exec -it poc-ubuntu-custom-sa /bin/bash</code> </pre> <br><ul><li>  Login! </li></ul><br><pre> <code class="plaintext hljs">echo "{ \ \"AuthMethod\": \"auth-method-skywiz-consul-poc\", \ \"BearerToken\": \"$(cat /run/secrets/kubernetes.io/serviceaccount/token)\" \ }" \ | curl \ --request POST \ --data @- \ consul-ds-client.default.svc.cluster.local/v1/acl/login</code> </pre> <br><ul><li>  Izin ditolak.  Oh, kami lupa menambahkan aturan baru yang mengikat dengan izin yang sesuai, mari kita lakukan sekarang. </li></ul><br><p>  Ulangi langkah sebelumnya di atas: <br>  a) Buat Kebijakan identik untuk awalan "custom-sa /". <br>  b) Buat Peran, beri nama "custom-sa-role" <br>  c) Lampirkan Kebijakan untuk Berperan. </p><br><ul><li>  Buat Aturan-Mengikat (hanya mungkin dari cli / api).  Perhatikan nilai yang berbeda dari bendera pemilih. </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='custom-sa-role' \ -selector='serviceaccount.name=="custom-sa"'</code> </pre> <br><ul><li>  Masuk lagi dari wadah poc-ubuntu-custom-sa.  Sukses! </li><li>  Periksa akses kami ke jalur kustom-sa / kunci. </li></ul><br><pre> <code class="plaintext hljs">curl \ consul-ds-client.default.svc.cluster.local/v1/kv/custom-sa/test_key --header ‚ÄúX-Consul-Token: &lt;SecretID&gt;‚Äù</code> </pre> <br><ul><li>  Anda juga dapat memastikan bahwa token ini tidak menyediakan akses ke kv di "custom-ns /".  Cukup ulangi perintah di atas setelah mengganti "custom-sa" dengan awalan "custom-ns". <br>  Izin ditolak. </li></ul><br><h3 id="primer-overleya">  Contoh hamparan: </h3><br><ul><li>  Perlu dicatat bahwa semua pemetaan yang mengikat aturan akan ditambahkan ke token dengan hak-hak ini. </li><li>  Wadah poc-ubuntu-custom-sa kami ada di namespace default - jadi mari kita gunakan untuk mengikat aturan lain. </li><li>  Ulangi langkah sebelumnya: <br>  a) Buat Kebijakan identik untuk awalan kunci "default /". <br>  b) Buat Peran, beri nama "peran default-ns" <br>  c) Lampirkan Kebijakan untuk Berperan. </li><li>  Buat Aturan-Mengikat (hanya mungkin dari cli / api) </li></ul><br><pre> <code class="plaintext hljs">consul acl binding-rule create \ -method=auth-method-skywiz-consul-poc \ -bind-type=role \ -bind-name='default-ns-role' \ -selector='serviceaccount.namespace=="default"'</code> </pre> <br><ul><li>  Kembali ke wadah poc-ubuntu-custom-sa kami dan coba akses jalur default / kv. </li><li>  Izin ditolak. <br>  Anda dapat melihat kredensial yang ditentukan untuk setiap token di UI di bawah ACL&gt; Token.  Seperti yang Anda lihat, hanya satu "custom-sa-role" yang dilampirkan ke token kami saat ini.  Token yang kami gunakan saat ini dihasilkan saat kami masuk, dan kemudian hanya ada satu aturan yang mengikat, yang kemudian berhubungan.  Kita perlu masuk lagi dan menggunakan token baru. </li><li>  Pastikan Anda dapat membaca dari kedua jalur "custom-sa /" dan "default /" kv. <br>  Sukses! <br>  Ini karena poc-ubuntu-custom-sa kami cocok dengan binding dari aturan custom-sa dan default-ns. </li></ul><br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><h3 id="ttl-token-mgmt">  Token mgmt TTL? </h3><br><p>  Pada saat penulisan ini, tidak ada cara terintegrasi untuk menentukan TTL untuk token yang dihasilkan oleh metode otorisasi ini.  Ini akan menjadi kesempatan luar biasa untuk memberikan otomatisasi otorisasi Konsul yang aman. </p><br><p>  Dimungkinkan untuk secara manual membuat token dengan TTL: </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.consul.io/docs/acl/acl-system.html#acl-tokens</a> <br>  Waktu Kedaluwarsa - Waktu ketika token ini akan dicabut.  (Opsional; ditambahkan dalam Konsul 1.5.0) </li><li>  Hanya ada untuk pembuatan manual / memperbarui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.consul.io/api/acl/tokens.html#expirationtime</a> </li></ul><br><p>  Saya berharap bahwa dalam waktu dekat kita akan dapat mengontrol bagaimana token dihasilkan (untuk setiap aturan atau metode otorisasi) dan menambahkan TTL. </p><br><p>  Sampai saat itu, diusulkan untuk menggunakan dalam logika Anda titik akhir keluar dari sistem. </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.consul.io/api/acl/acl.html#logout-from-auth-method</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">https://www.consul.io/docs/acl/acl-auth-methods.html#overall-login-process</a> </li></ul><br><h3 id="takzhe-chitayte-drugie-stati-v-nashem-bloge">  Baca juga artikel lain di blog kami: </h3><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apa hasil migrasi dari ClickHouse tanpa otorisasi ke ClickHouse dengan otorisasi</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cara menjalankan beberapa saluran pipa menggunakan GitLab CI / CD</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Tiga trik sederhana untuk mengurangi gambar buruh pelabuhan</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Traefik sebagai Pengontrol Ingress untuk K8S</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mencadangkan sejumlah besar proyek web heterogen</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Bot Telegram untuk Redmine.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Cara menyederhanakan hidup untuk diri sendiri dan orang</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id473014/">https://habr.com/ru/post/id473014/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id472996/index.html">Pentagon mengembangkan teknologi kontrol drone dengan pikiran tentara</a></li>
<li><a href="../id473000/index.html">Panduan matematika singkat untuk orang asing</a></li>
<li><a href="../id473002/index.html">Penjelasan paradoks Fermi dalam kerangka sosiologi ruang Liu Qixin</a></li>
<li><a href="../id473008/index.html">Hukum Pengembalian yang Dipercepat (Bagian 2)</a></li>
<li><a href="../id473012/index.html">Hasil Konferensi Mitra Advantech di Moskow</a></li>
<li><a href="../id473016/index.html">Model bisnis naik-memanggil yang menguntungkan diimplementasikan dengan mengembangkan aplikasi taksi mirip Uber</a></li>
<li><a href="../id473018/index.html">Kiat untuk calon dari programmer yang melakukan wawancara di Facebook</a></li>
<li><a href="../id473024/index.html">Apa yang perlu Anda ketahui tentang Internet: program pendidikan dasar</a></li>
<li><a href="../id473026/index.html">Om-yum-yum dan validasi data</a></li>
<li><a href="../id473028/index.html">Di Rusia mulai mengimpor limbah radioaktif dari Eropa? Diurutkan</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>