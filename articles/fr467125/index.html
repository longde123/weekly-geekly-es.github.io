<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï∫üèΩ ü•ö üë¢ Jeu NES moderne √©crit dans un langage de type Lisp üë®üèº‚Äçüéì ü§ñ üë©üèª‚Äçüíº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What Remains est un jeu d'aventure narratif pour la console de jeu vid√©o NES 8 bits, sorti en mars 2019 sous forme de ROM gratuite ex√©cut√©e dans l'√©mu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Jeu NES moderne √©crit dans un langage de type Lisp</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/467125/">  What Remains est un jeu d'aventure narratif pour la console de jeu vid√©o NES 8 bits, sorti en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">mars 2019</a> sous forme de ROM gratuite ex√©cut√©e dans l'√©mulateur.  Il a √©t√© cr√©√© par une petite √©quipe de Iodine Dynamics pendant deux ans par intermittence.  Pour le moment, le jeu est au stade de la mise en ≈ìuvre du mat√©riel: nous cr√©ons un ensemble limit√© de cartouches √† partir de pi√®ces recycl√©es. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/db4/d1a/663/db4d1a6633208845a7e7ce5d670d82ac.jpg"></div><br>  Le jeu comporte 6 niveaux sur lesquels le joueur parcourt plusieurs sc√®nes avec des cartes de d√©filement √† quatre voies, communique avec le PNJ, recueille des indices, apprend √† conna√Ætre son monde, joue √† des mini-jeux et r√©sout des √©nigmes simples.  J'√©tais l'ing√©nieur en chef du projet, j'ai donc rencontr√© de nombreuses difficult√©s pour r√©aliser la vision de l'√©quipe.  Compte tenu des s√©rieuses limites de l'√©quipement NES, il est assez difficile de cr√©er un jeu pour celui-ci, sans parler d'un projet avec autant de contenu que dans What Remains.  Ce n'est que gr√¢ce aux sous-syst√®mes utiles cr√©√©s qui nous permettent de masquer cette complexit√© et de la g√©rer que nous avons pu travailler en √©quipe et terminer le jeu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/956/a4d/921/956a4d9217a209643bb35b68e25694b5.png"></div><br>  Dans cet article, je vais parler de certains d√©tails techniques de certaines parties du moteur de jeu.  J'esp√®re que d'autres d√©veloppeurs les trouveront utiles ou du moins curieux. <br><a name="habracut"></a><br><h2>  √âquipement NES </h2><br>  Avant de commencer le code, je vais vous parler un peu des sp√©cifications de l'√©quipement avec lequel nous travaillons.  NES est une console de jeu sortie en 1983 (Japon, 1985 - Am√©rique).  √Ä l'int√©rieur, il poss√®de un processeur 8 bits 6502 [1] avec une fr√©quence de 1,79 MHz.  √âtant donn√© que la console produit 60 images par seconde, il y a environ 30 000 cycles CPU par image, ce qui est assez petit pour calculer tout ce qui se passe dans le cycle de jeu principal. <br><br>  De plus, la console dispose d'un total de 2048 octets de RAM (qui peut √™tre √©tendue √† 10 240 octets en utilisant de la RAM suppl√©mentaire, ce que nous n'avons pas fait).  Il peut √©galement traiter 32 Ko de ROM √† la fois, ce qui peut √™tre √©tendu en changeant de banque (What Remains utilise 512 Ko de ROM).  Changer de banque est un sujet complexe [2] que les programmeurs modernes ne traitent pas.  En bref, l'espace d'adressage disponible pour le CPU est inf√©rieur aux donn√©es contenues dans la ROM, c'est-√†-dire qu'en cas de commutation manuelle, des blocs de m√©moire entiers restent inaccessibles.  Vouliez-vous appeler une fonction?  Ce n'est que lorsque vous remplacez la banque en appelant la commande de changement de banque.  Si cela n'est pas fait, alors lorsque la fonction est appel√©e, le programme se bloque. <br><br>  En fait, la chose la plus difficile lors du d√©veloppement d'un jeu pour NES est de consid√©rer tout cela en m√™me temps.  L'optimisation d'un aspect du code, comme l'utilisation de la m√©moire, peut souvent affecter autre chose, comme les performances du processeur.  Le code doit √™tre efficace et √† la fois pratique √† l'appui.  Habituellement, les jeux √©taient programm√©s en langage assembleur. <br><br><h2>  Co2 </h2><br>  Mais dans notre cas, ce n'√©tait pas le cas.  Au lieu de cela, un tandem avec le jeu aurait d√©velopp√© son propre langage.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Co2</a> est un langage de type Lisp construit sur Racket Scheme et compil√© dans l'assembleur 6502. Initialement, le langage a √©t√© cr√©√© par <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dave Griffiths</a> pour construire la d√©mo What Remains, et j'ai d√©cid√© de l'utiliser pour l'ensemble du projet. <br><br>  Co2 vous permet d'√©crire du code assembleur int√©gr√© si n√©cessaire, mais il poss√®de √©galement des capacit√©s de haut niveau qui simplifient certaines t√¢ches.  Il impl√©mente des variables locales efficaces √† la fois en termes de consommation de RAM et de vitesse d'acc√®s [2].  Il dispose d'un syst√®me de macros tr√®s simple qui vous permet d'√©crire du code lisible et en m√™me temps efficace [3].  Plus important encore, en raison de l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">homo-conicit√© de</a> Lisp, il simplifie consid√©rablement l'affichage des donn√©es directement dans la source. <br><br>  L'√©criture de vos propres outils est assez r√©pandue dans le d√©veloppement de jeux, mais la cr√©ation d'un langage de programmation complet est beaucoup moins courante.  Cependant, nous l'avons fait.  On ne sait pas tr√®s bien si la complexit√© du d√©veloppement et du support de Co2 a fait ses preuves, mais elle avait certainement des avantages qui nous ont aid√©s.  Dans le post, je ne parlerai pas en d√©tail du travail de Co2 (cela m√©rite un article s√©par√©), mais je le mentionnerai constamment car son utilisation est assez √©troitement li√©e au processus de d√©veloppement. <br><br>  Voici un exemple de code Co2 qui dessine l'arri√®re-plan d'une sc√®ne juste charg√©e avant de la r√©duire: <br><br><pre><code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Render the nametable for the scene at the camera position (defsub (create-initial-world) (camera-assign-cursor) (set! camera-cursor (+ camera-cursor 60)) (let ((preserve-camera-v)) (set! preserve-camera-v camera-v) (set! camera-v 0) (loop i 0 60 (set! delta-v #xff) (update-world-graphics) (when render-nt-span-has (set! render-nt-span-has #f) (apply-render-nt-span-buffer)) (when render-attr-span-has (set! render-attr-span-has #f) (apply-render-attr-span-buffer))) (set! camera-v preserve-camera-v)) (camera-assign-cursor))</span></span></code> </pre> <br><h2>  Syst√®me d'entit√© </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ee6/d87/ad4/ee6d87ad406879dbc9433c61fa4e3a5b.png"></div><br>  Tout jeu en temps r√©el plus complexe que Tetris est intrins√®quement un ¬´syst√®me d'entit√©s¬ª.  Il s'agit d'une fonctionnalit√© qui permet √† diff√©rents acteurs ind√©pendants d'agir simultan√©ment et d'√™tre responsables de leur propre condition.  Bien que What Remains ne soit en aucun cas un jeu actif, il a encore de nombreux acteurs ind√©pendants au comportement complexe: ils s'animent et se rendent, v√©rifient les collisions et provoquent des dialogues. <br><br>  L'impl√©mentation est assez typique: un grand tableau contient une liste d'entit√©s dans la sc√®ne, chaque enregistrement contient des donn√©es relatives aux entit√©s ainsi qu'une √©tiquette de type.  La fonction de mise √† jour du cycle de jeu principal contourne toutes les entit√©s et impl√©mente le comportement correspondant en fonction de leur type. <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Called once per frame, to update each entity (defsub (update-entities) (when (not entity-npc-num) (return)) (loop k 0 entity-npc-num (let ((type)) (set! type (peek entity-npc-data (+ k entity-field-type))) (when (not (eq? type #xff)) (update-single-entity k type)))))</span></span></code> </pre> <br>  La fa√ßon de stocker les donn√©es d'entit√© est plus int√©ressante.  En g√©n√©ral, le jeu poss√®de tellement d'entit√©s uniques que l'utilisation d'un grand nombre de ROM peut devenir un probl√®me.  Ici, Co2 montre sa puissance, nous permettant de pr√©senter chaque essence de la sc√®ne sous une forme concise mais lisible - comme un flux de paires cl√©-valeur.  En plus des donn√©es telles que la position initiale, presque chaque cl√© est facultative, ce qui permet de les d√©clarer aux entit√©s uniquement lorsque cela est n√©cessaire. <br><br><pre> <code class="lisp hljs">(<span class="hljs-name"><span class="hljs-name">bytes</span></span> npc-diner-a <span class="hljs-number"><span class="hljs-number">172</span></span> <span class="hljs-number"><span class="hljs-number">108</span></span> prop-palette <span class="hljs-number"><span class="hljs-number">1</span></span> prop-hflip prop-picture picture-smoker-c prop-animation simple-cycle-animation prop-anim-limit <span class="hljs-number"><span class="hljs-number">6</span></span> prop-head hair-flip-head-tile <span class="hljs-number"><span class="hljs-number">2</span></span> prop-dont-turn-around prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-stage-4 on-my-third my-dietician) prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-stage-3 have-you-tried-the-pasta the-real-deal) prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-diner-is-clean omg-this-cherry-pie its-like-a-party) prop-dialog-a (<span class="hljs-number"><span class="hljs-number">2</span></span> progress-stage-1 cant-taste-food puff-poof) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-4 tea-party-is-not) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-3 newspaper-owned-by-dnycorp) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-2 they-paid-a-pr-guy) prop-dialog-b (<span class="hljs-number"><span class="hljs-number">1</span></span> progress-stage-1 it-seems-difficult) prop-customize (<span class="hljs-name"><span class="hljs-name">progress-stage-2</span></span> stop-smoking) <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre> <br>  Dans ce code, <code>prop-palette</code> d√©finit la palette de couleurs utilis√©e pour l'entit√©, <code>prop-anim-limit</code> d√©finit le nombre d'images d'animation et <code>prop-dont-turn-around</code> emp√™che le PNJ de tourner si le joueur essaie de lui parler de l'autre c√¥t√©.  Il d√©finit √©galement quelques indicateurs de conditions qui modifient le comportement de l'entit√© lors du passage du jeu par le joueur. <br><br>  Ce type de pr√©sentation est tr√®s efficace pour le stockage en ROM, mais il est tr√®s lent lors de l'acc√®s au moment de l'ex√©cution et sera trop inefficace pour le gameplay.  Par cons√©quent, lorsqu'un joueur entre dans une nouvelle sc√®ne, toutes les entit√©s de cette sc√®ne sont charg√©es dans la RAM et traitent toutes les conditions qui peuvent affecter leur √©tat initial.  Mais vous ne pouvez pas t√©l√©charger de d√©tails pour chaque entit√©, car cela prendrait plus de RAM que ce qui est disponible.  Le moteur charge uniquement les √©l√©ments les plus n√©cessaires pour chaque entit√©, plus un pointeur sur sa structure compl√®te en ROM, qui est d√©r√©f√©renc√© dans des situations telles que la gestion des bo√Ætes de dialogue.  Cet ensemble sp√©cifique de compromis nous a permis de fournir un niveau de performance suffisant. <br><br><h2>  Portails </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c41/9dd/b90/c419ddb90349fbfb890c935e15bdfb95.png"></div><br>  Le jeu What Remains a de nombreux endroits diff√©rents, plusieurs sc√®nes dans la rue avec des cartes √† d√©filement et de nombreuses sc√®nes dans des pi√®ces qui restent statiques.  Pour passer de l'un √† l'autre, vous devez d√©terminer que le joueur a atteint la sortie, charger une nouvelle sc√®ne, puis placer le joueur au point souhait√©.  Dans les premiers stades de d√©veloppement, ces transitions √©taient d√©crites de mani√®re unique comme deux sc√®nes connect√©es, par exemple, ¬´premi√®re ville¬ª et ¬´caf√©¬ª et des donn√©es dans la d√©claration if sur l'emplacement des portes dans chaque sc√®ne.  Afin de d√©terminer o√π placer le joueur apr√®s avoir chang√© de sc√®ne, il vous suffit de v√©rifier o√π il allait et o√π, et de le placer √† c√¥t√© de la sortie correspondante. <br><br>  Cependant, lorsque nous avons commenc√© √† remplir la sc√®ne de la ¬´deuxi√®me ville¬ª, qui se connecte √† la premi√®re ville √† deux endroits diff√©rents, un tel syst√®me a commenc√© √† s'effondrer.  <code>(_, _)</code> coup, la paire <code>(_, _)</code> ne correspond plus.  Apr√®s avoir r√©fl√©chi √† cela, nous avons r√©alis√© que la connexion elle-m√™me est vraiment importante, ce qui dans le code du jeu appelle le ¬´portail¬ª.  Pour tenir compte de ces changements, le moteur a √©t√© r√©√©crit.  ce qui nous a conduit √† une situation semblable √† une entit√©.  Les portails pouvaient stocker des listes de paires cl√©-valeur et les charger au d√©but de la sc√®ne.  Lorsque vous entrez dans le portail, vous pouvez utiliser les m√™mes informations de position que lorsque vous quittez.  De plus, l'ajout de conditions a √©t√© simplifi√©, semblable √† ce que les entit√©s avaient: √† certains moments du jeu, nous pouvions modifier des portails, par exemple, ouvrir ou fermer des portes. <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; City A (bytes city-a-scene #x50 #x68 look-up portal-customize (progress-stage-5 remove-self) ; to Diner diner-scene #xc0 #xa0 look-down portal-width #x20 0)</span></span></code> </pre> <br>  Cela a √©galement simplifi√© le processus d'ajout de ¬´points de t√©l√©portation¬ª, qui √©taient souvent utilis√©s dans les encarts cin√©matographiques, o√π le joueur devait passer √† un autre dans la sc√®ne, selon ce qui se passait dans l'intrigue. <br><br>  Voici √† quoi ressemble la t√©l√©portation au d√©but du niveau 3: <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Jenny's home (bytes jenny-home-scene #x60 #xc0 look-up portal-teleport-only jenny-back-at-home-teleport 0)</span></span></code> </pre> <br>  Faites attention √† la valeur de recherche, qui indique la direction de l '"entr√©e" de ce portail.  En quittant le portail, le joueur regardera dans l'autre sens;  dans ce cas, Jenny (le personnage principal du jeu) est √† la maison, tout en regardant vers le bas. <br><br><h2>  Bloc de texte </h2><br>  Le rendu d'un bloc de texte s'est av√©r√© √™tre l'un des morceaux de code les plus complexes de l'ensemble du projet.  Les limitations graphiques de NES ont forc√© √† tromper.  Pour commencer, NES n'a qu'une seule couche pour les donn√©es graphiques, c'est-√†-dire que pour lib√©rer de l'espace pour un bloc de texte, vous devez effacer une partie de la carte en arri√®re-plan, puis la restaurer apr√®s avoir ferm√© le bloc de texte. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6b8/7a5/d6f/6b87a5d6f4f44f8eb4fa9cf3b3242392.png"></div><br>  De plus, la palette de chaque sc√®ne doit contenir des couleurs noir et blanc pour le rendu du texte, ce qui impose des restrictions suppl√©mentaires √† l'artiste.  Pour √©viter les conflits de couleurs avec le reste de l'arri√®re-plan, le bloc de texte doit √™tre align√© avec la grille 16 √ó 16 [5].  Dessiner un bloc de texte dans une sc√®ne avec une pi√®ce est beaucoup plus simple que dans une rue, o√π la cam√©ra peut se d√©placer, car dans ce cas, il est n√©cessaire de consid√©rer les tampons graphiques d√©filant verticalement et horizontalement.  Enfin, le message d'√©cran de pause est une bo√Æte de dialogue standard l√©g√®rement modifi√©e, car elle affiche des informations diff√©rentes, mais utilise presque le m√™me code. <br><br>  Apr√®s un nombre infini de versions bugg√©es du code, j'ai finalement r√©ussi √† trouver une solution dans laquelle le travail est divis√© en deux √©tapes.  Tout d'abord, tous les calculs sont effectu√©s pour d√©terminer o√π et comment dessiner le bloc de texte, y compris le code de traitement pour tous les cas de bordure.  Ainsi, toutes ces difficult√©s sont r√©unies au m√™me endroit. <br><br>  Ensuite, un bloc de texte avec conservation de l'√©tat est trac√© ligne par ligne et les calculs de la premi√®re √©tape sont utilis√©s pour ne pas compliquer le code. <br><br><pre> <code class="lisp hljs"><span class="hljs-comment"><span class="hljs-comment">; Called once per frame as the text box is being rendered (defsub (text-box-update) (when (or (eq? tb-text-mode 0) (eq? tb-text-mode #xff)) (return #f)) (cond [(in-range tb-text-mode 1 4) (if (not is-paused) ; Draw text box for dialog. (text-box-draw-opening (- tb-text-mode 1)) ; Draw text box for pause. (text-box-draw-pausing (- tb-text-mode 1))) (inc tb-text-mode)] [(eq? tb-text-mode 4) ; Remove sprites in the way. (remove-sprites-in-the-way) (inc tb-text-mode)] [(eq? tb-text-mode 5) (if (not is-paused) ; Display dialog text. (when (not (crawl-text-update)) (inc tb-text-mode) (inc tb-text-mode)) ; Display paused text. (do (create-pause-message) (inc tb-text-mode)))] [(eq? tb-text-mode 6) ; This state is only used when paused. Nothing happens, and the caller ; has to invoke `text-box-try-exiting-pause` to continue. #t] [(and (&gt;= tb-text-mode 7) (&lt; tb-text-mode 10)) ; Erase text box. (if (is-scene-outside scene-id) (text-box-draw-closing (- tb-text-mode 7)) (text-box-draw-restoring (- tb-text-mode 7))) (inc tb-text-mode)] [(eq? tb-text-mode 10) ; Reset state to return to game. (set! text-displaying #f) (set! tb-text-mode 0)]) (return #t))</span></span></code> </pre> <br>  Si vous vous habituez au style Lisp, le code est lu assez facilement. <br><br><h2>  Couches z Sprite </h2><br>  Au final, je vais parler d'un petit d√©tail qui n'affecte pas particuli√®rement le gameplay, mais ajoute une belle touche dont je suis fier.  NES n'a que deux composants graphiques: une table de noms (table de noms), qui est utilis√©e pour les arri√®re-plans statiques et align√©s sur la grille, et les sprites - objets de taille 8x8 pixels, qui peuvent √™tre plac√©s √† des endroits arbitraires.  Des √©l√©ments tels que le personnage du joueur et les PNJ sont g√©n√©ralement cr√©√©s sous forme de sprites s'ils doivent figurer au-dessus des graphiques de la table des noms. <br><br>  Cependant, l'√©quipement NES offre √©galement la possibilit√© de sp√©cifier une partie des sprites qui peuvent √™tre compl√®tement plac√©s sous la table des noms.  Cela vous permet sans effort de r√©aliser un effet 3D cool. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1c6/4e0/c48/1c64e0c481f82d2b6569aa6326ea00a1.png"></div><br>  Cela fonctionne comme suit: la palette utilis√©e pour la sc√®ne actuelle g√®re la couleur √† la position 0 d'une mani√®re sp√©ciale: c'est la couleur de fond globale.  Une table de noms est dessin√©e par-dessus, et les sprites avec un calque z sont dessin√©s entre deux autres calques. <br><br>  Voici la palette de cette sc√®ne: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/23c/2c6/391/23c2c6391ae6301f9b527259250ee0e5.png"></div><br>  Ainsi, la couleur gris fonc√© dans le coin tout √† gauche est utilis√©e comme couleur de fond globale. <br><br>  L'effet des calques fonctionne comme suit: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d30/0ae/f89/d300aef890a928421a48d94968a263f9.png"></div><br>  Dans la plupart des autres jeux, tout cela se termine, cependant, What Remains a fait un pas de plus.  Le jeu ne place pas Jenny compl√®tement devant ou sous les graphiques de la table des noms - son personnage est divis√© entre eux de la bonne mani√®re.  Comme vous pouvez le voir, les images-objets ont une taille de 8 x 8 et les graphiques du personnage entier se composent de plusieurs images-objets (de 3 √† 6, selon le cadre d'animation).  Chaque sprite peut d√©finir sa propre couche z, c'est-√†-dire que certains sprites seront devant la table des noms et d'autres derri√®re. <br><br>  Voici un exemple de cet effet en action: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/86b/3a3/ae5/86b3a3ae58931ef34d44640d7ff4c449.png"></div><br>  L'algorithme pour impl√©menter cet effet est assez d√©licat.  Tout d'abord, les donn√©es de collision entourant le joueur sont examin√©es, en particulier les tuiles, qui peuvent prendre un personnage entier √† dessiner.  Dans ce diagramme, les carreaux pleins sont repr√©sent√©s dans des carr√©s rouges et les carreaux jaunes indiquent la partie avec la couche z. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/10d/162/38c/10d16238cc137b14b8719479624f7245.png"></div><br>  Utilisant diverses heuristiques, ils sont combin√©s pour cr√©er un ¬´point de r√©f√©rence¬ª et un masque de bits de quatre bits.  Quatre quadrants par rapport au point de r√©f√©rence correspondent √† quatre bits: 0 signifie que le joueur doit √™tre devant la table des noms, 1 - qui est derri√®re. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ccb/3a4/ff9/ccb3a4ff911243e0e771c3bd64e10134.png"></div><br>  Lorsque vous placez des sprites individuels pour le rendu du joueur, leur position est compar√©e au point de r√©f√©rence pour d√©terminer la couche z de ce sprite particulier.  Certains d'entre eux sont dans la couche avant, d'autres √† l'arri√®re. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ee/f36/273/0eef362737679bb6483465264ada9ba4.png"></div><br><h2>  Conclusion </h2><br>  J'ai bri√®vement parl√© des diff√©rents aspects du fonctionnement interne de notre nouveau jeu r√©tro moderne.  Il y a beaucoup plus int√©ressant dans la base de code, mais j'ai d√©crit une partie importante de ce qui fait fonctionner le jeu. <br><br>  La le√ßon la plus importante que j'ai apprise de ce projet est les avantages qui peuvent √™tre tir√©s des moteurs bas√©s sur les donn√©es.  Plusieurs fois, j'ai r√©ussi √† remplacer une logique unique par une table et un mini-interpr√®te, et gr√¢ce √† cela, le code est devenu plus simple et plus lisible. <br><br>  J'esp√®re que l'article vous a plu! <br><br><hr><br><h3>  Remarques </h3><br>  [1] √Ä proprement parler, une sorte de CPU 6502 appel√©e Ricoh 2A03 a √©t√© install√©e dans NES. <br><br>  [2] En fait, ce projet m'a convaincu que le changement de banque / la gestion des ROM est la principale limitation pour tout projet NES qui d√©passe une certaine taille. <br><br>  [3] Pour cela, il faut remercier la ¬´pile compil√©e¬ª - un concept utilis√© dans la programmation de syst√®mes embarqu√©s, bien que j'aie √† peine r√©ussi √† trouver de la litt√©rature √† ce sujet.  En bref, vous devez cr√©er un graphique d'appel de projet complet, le trier des n≈ìuds feuilles √† la racine, puis affecter √† chaque n≈ìud une m√©moire √©gale √† ses besoins + nombre maximal de n≈ìuds enfants. <br><br>  [4] Les macros ont √©t√© ajout√©es √† des stades de d√©veloppement assez tardifs et, franchement, nous n'avons pas pu en tirer un avantage particulier. <br><br>  [5] Vous pouvez en savoir plus sur les graphiques NES dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ma s√©rie d'articles</a> .  Les conflits de couleurs sont caus√©s par les attributs d√©crits dans la premi√®re partie. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr467125/">https://habr.com/ru/post/fr467125/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr467111/index.html">Astuces radicales pour accrocher moins sur votre t√©l√©phone</a></li>
<li><a href="../fr467113/index.html">Comment garder l'utilisateur sur le site? Secrets d'utilisation</a></li>
<li><a href="../fr467115/index.html">¬´Ls¬ª atypique - √âdition Habr</a></li>
<li><a href="../fr467117/index.html">Les manuscrits ne br√ªlent pas: le secret de la long√©vit√© des rouleaux de la mer Morte remontant √† 250 av.</a></li>
<li><a href="../fr467119/index.html">Jouez √† IT-Alias ‚Äã‚Äãavec Badoo Engineers</a></li>
<li><a href="../fr467127/index.html">Test des API √† l'aide de Postman et Excel</a></li>
<li><a href="../fr467129/index.html">Redressement cognitif 2: apprentissage des illusions et des distorsions</a></li>
<li><a href="../fr467131/index.html">CLRium # 6: Rapport de paire sur Lock-Free, beaucoup de th√©orie et de connaissances pratiques</a></li>
<li><a href="../fr467135/index.html">P√©dale USB pour basculer entre les ordinateurs</a></li>
<li><a href="../fr467137/index.html">Assurer un fonctionnement fiable de l'√©quipe Zextras dans des r√©seaux d'entreprise complexes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>