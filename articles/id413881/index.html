<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üí¥ üßîüèø üëßüèø Gambar buruh pelabuhan 5,94 meter dengan Telegram MTProxy üë©üèø‚Äçüè≠ ‚ùï ü§õüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Seperti yang sudah didengar semua orang, pada akhir Mei Telegram meluncurkan server MTProto Proxy (alias MTProxy) resmi, yang ditulis dalam bahasa ber...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gambar buruh pelabuhan 5,94 meter dengan Telegram MTProxy</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413881/">  Seperti yang sudah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">didengar</a> semua orang, pada akhir Mei Telegram meluncurkan server MTProto Proxy (alias MTProxy) resmi, yang ditulis dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bahasa berikut</a> .  Pada tahun 2018, tidak ada banyak tempat tanpa Docker, karena disertai dengan cara "resmi" yang sama dalam format zero-config.  Semuanya akan baik-baik saja, tetapi tiga "tapi" merusak kesan rilis: gambar berbobot&gt; 130 Mb (ada Debian yang gemuk, bukan Alpine yang biasa), karena "zero-config" tidak selalu mudah dikonfigurasikan (hanya oleh pengaturan lingkungan) dan orang-orang lupa kampanye, lay out Dockerfile. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rz/xw/_i/rzxw_ixdvdpolcg2lifulaagwoq.png"></div><br><br>  <b>TL; DR</b> Kami akan membuat gambar docker resmi berbasis alpine 1-in-1 praktis berukuran 5.94MB dan meletakkannya di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> (dan Dockerfile di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> );  sepanjang jalan, kami akan mencari tahu bagaimana kadang-kadang Anda dapat berteman dengan perangkat lunak Alpine menggunakan jepit dan file, dan kami akan bermain sedikit dalam ukuran, khusus untuk bersenang-senang. <br><a name="habracut"></a><br><h2>  Konten Gambar </h2><br>  Sekali lagi, karena apa yang diributkan?  Mari kita lihat apa yang diwakili gambar resmi dengan perintah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sejarah</a> : <br><br><pre><code class="bash hljs">$ docker <span class="hljs-built_in"><span class="hljs-built_in">history</span></span> --no-trunc --format <span class="hljs-string"><span class="hljs-string">"{{.Size}}\t{{.CreatedBy}}"</span></span> telegrammessenger/proxy</code> </pre> <br>  Lapisan dibaca dari bawah ke atas, masing-masing: <br><br><img src="https://habrastorage.org/webt/ev/ma/nj/evmanj5adycr0whpsksqgyivw70.png"><br><br>  Yang paling tebal adalah Debian Jessie, dari mana gambar asli diwarisi, kita harus menyingkirkannya terlebih dahulu (alpine: 3.6, sebagai perbandingan, beratnya 3,97MB);  diikuti oleh dimensi adalah ikal dan sertifikat segar.  Untuk memahami apa arti dua file dan direktori lainnya, kita akan melihat ke dalam menggunakan perintah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">run</a> , mengganti CMD dengan bash (ini akan memungkinkan Anda berjalan di sekitar gambar yang diluncurkan, mengenal satu sama lain lebih dekat, menjalankan fragmen tertentu, menyalin sesuatu yang bermanfaat): <br><br><pre> <code class="bash hljs">$ docker run -it --rm telegrammessenger/proxy /bin/bash</code> </pre> <br>  Sekarang kita dapat dengan mudah mengembalikan gambar kejadian - sesuatu seperti Dockerfile resmi yang hilang terlihat seperti: <br><br><pre> <code class="hljs powershell">FROM debian:jessie<span class="hljs-literal"><span class="hljs-literal">-20180312</span></span> RUN set <span class="hljs-literal"><span class="hljs-literal">-eux</span></span> \ &amp;&amp; apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> update \ &amp;&amp; apt<span class="hljs-literal"><span class="hljs-literal">-get</span></span> install <span class="hljs-literal"><span class="hljs-literal">-y</span></span> -<span class="hljs-literal"><span class="hljs-literal">-no</span></span><span class="hljs-literal"><span class="hljs-literal">-install</span></span><span class="hljs-literal"><span class="hljs-literal">-recommends</span></span> curl ca<span class="hljs-literal"><span class="hljs-literal">-certificates</span></span> \ &amp;&amp; rm <span class="hljs-literal"><span class="hljs-literal">-rf</span></span> /var/lib/apt/lists/* COPY ./mtproto<span class="hljs-literal"><span class="hljs-literal">-proxy</span></span> /usr/local/bin RUN mkdir /<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> COPY ./secret/ /etc/telegram/ COPY ./run.sh /run.sh CMD [<span class="hljs-string"><span class="hljs-string">"/bin/sh"</span></span>, <span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"/bin/bash /run.sh"</span></span>]</code> </pre><br>  Di mana mtproto-proxy adalah server yang dikompilasi, folder rahasia hanya berisi file hello-explorers-how-are-you-do dengan kunci enkripsi AES (lihat perintah server, di sana, merupakan rekomendasi resmi untuk mendapatkan kunci melalui API, tetapi dengan kata lain mungkin untuk menghindari situasi ketika API juga diblokir), dan run.sh melakukan semua persiapan untuk memulai proxy. <br><br><div class="spoiler">  <b class="spoiler_title">Isi run.sh asli</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash if [ ! -z "$DEBUG" ]; then set -x; fi mkdir /data 2&gt;/dev/null &gt;/dev/null RANDOM=$(printf "%d" "0x$(head -c4 /dev/urandom | od -t x1 -An | tr -d ' ')") if [ -z "$WORKERS" ]; then WORKERS=2 fi echo "####" echo "#### Telegram Proxy" echo "####" echo SECRET_CMD="" if [ ! -z "$SECRET" ]; then echo "[+] Using the explicitly passed secret: '$SECRET'." elif [ -f /data/secret ]; then SECRET="$(cat /data/secret)" echo "[+] Using the secret in /data/secret: '$SECRET'." else if [[ ! -z "$SECRET_COUNT" ]]; then if [[ ! ( "$SECRET_COUNT" -ge 1 &amp;&amp; "$SECRET_COUNT" -le 16 ) ]]; then echo "[F] Can generate between 1 and 16 secrets." exit 5 fi else SECRET_COUNT="1" fi echo "[+] No secret passed. Will generate $SECRET_COUNT random ones." SECRET="$(dd if=/dev/urandom bs=16 count=1 2&gt;&amp;1 | od -tx1 | head -n1 | tail -c +9 | tr -d ' ')" for pass in $(seq 2 $SECRET_COUNT); do SECRET="$SECRET,$(dd if=/dev/urandom bs=16 count=1 2&gt;&amp;1 | od -tx1 | head -n1 | tail -c +9 | tr -d ' ')" done fi if echo "$SECRET" | grep -qE '^[0-9a-fA-F]{32}(,[0-9a-fA-F]{32}){,15}$'; then SECRET="$(echo "$SECRET" | tr '[:upper:]' '[:lower:]')" SECRET_CMD="-S $(echo "$SECRET" | sed 's/,/ -S /g')" echo -- "$SECRET_CMD" &gt; /data/secret_cmd echo "$SECRET" &gt; /data/secret else echo '[F] Bad secret format: should be 32 hex chars (for 16 bytes) for every secret; secrets should be comma-separated.' exit 1 fi if [ ! -z "$TAG" ]; then echo "[+] Using the explicitly passed tag: '$TAG'." fi TAG_CMD="" if [[ ! -z "$TAG" ]]; then if echo "$TAG" | grep -qE '^[0-9a-fA-F]{32}$'; then TAG="$(echo "$TAG" | tr '[:upper:]' '[:lower:]')" TAG_CMD="-P $TAG" else echo '[!] Bad tag format: should be 32 hex chars (for 16 bytes).' echo '[!] Continuing.' fi fi curl -s https://core.telegram.org/getProxyConfig -o /etc/telegram/backend.conf || { echo '[F] Cannot download proxy configuration from Telegram servers.' exit 2 } CONFIG=/etc/telegram/backend.conf IP="$(curl -s -4 "https://digitalresistance.dog/myIp")" INTERNAL_IP="$(ip -4 route get 8.8.8.8 | grep '^8\.8\.8\.8\s' | grep -Po 'src\s+\d+\.\d+\.\d+\.\d+' | awk '{print $2}')" if [[ -z "$IP" ]]; then echo "[F] Cannot determine external IP address." exit 3 fi if [[ -z "$INTERNAL_IP" ]]; then echo "[F] Cannot determine internal IP address." exit 4 fi echo "[*] Final configuration:" I=1 echo "$SECRET" | tr ',' '\n' | while read S; do echo "[*] Secret $I: $S" echo "[*] tg:// link for secret $I auto configuration: tg://proxy?server=${IP}&amp;port=443&amp;secret=${S}" echo "[*] t.me link for secret $I: https://t.me/proxy?server=${IP}&amp;port=443&amp;secret=${S}" I=$(($I+1)) done [ ! -z "$TAG" ] &amp;&amp; echo "[*] Tag: $TAG" || echo "[*] Tag: no tag" echo "[*] External IP: $IP" echo "[*] Make sure to fix the links in case you run the proxy on a different port." echo echo '[+] Starting proxy...' sleep 1 exec /usr/local/bin/mtproto-proxy -p 2398 -H 443 -M "$WORKERS" -C 60000 --aes-pwd /etc/telegram/hello-explorers-how-are-you-doing -u root $CONFIG --allow-skip-dh --nat-info "$INTERNAL_IP:$IP" $SECRET_CMD $TAG_CMD</span></span></code> </pre> </div></div><br><h2>  Majelis </h2><br>  Di bawah CentOS 7 MTProxy pada Habr√© yang sudah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dikumpulkan</a> , kami akan mencoba untuk mengumpulkan gambar di bawah Alpine dan untuk menyimpan megabyte, iklan, 130 di gambar buruh pelabuhan yang dihasilkan. <br><br>  Fitur khas Alpine Linux adalah penggunaan musl, bukan glibc.  Keduanya adalah pustaka C standar.  Musl kecil (tidak memiliki seperlima dari "standar" di dalamnya), tetapi volume dan kinerja (setidaknya dijanjikan) memutuskan ketika datang ke Docker.  Dan menempatkan glibc di Alpine tidak benar secara rasial, paman Jakub Jirutka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">tidak akan mengerti</a> , misalnya. <br><br>  Kami juga akan membangun buruh pelabuhan untuk mengisolasi dependensi dan mendapatkan kebebasan untuk eksperimen, jadi buatlah Dockerfile baru: <br><br><pre> <code class="hljs powershell">FROM alpine:<span class="hljs-number"><span class="hljs-number">3.6</span></span> RUN apk add -<span class="hljs-literal"><span class="hljs-literal">-no</span></span><span class="hljs-literal"><span class="hljs-literal">-cache</span></span> git make gcc musl<span class="hljs-literal"><span class="hljs-literal">-dev</span></span> linux<span class="hljs-literal"><span class="hljs-literal">-headers</span></span> openssl<span class="hljs-literal"><span class="hljs-literal">-dev</span></span> RUN git clone -<span class="hljs-literal"><span class="hljs-literal">-single</span></span><span class="hljs-literal"><span class="hljs-literal">-branch</span></span> -<span class="hljs-literal"><span class="hljs-literal">-depth</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> https://github.com/TelegramMessenger/MTProxy.git /mtproxy/sources RUN cd /mtproxy/sources \ &amp;&amp; make <span class="hljs-literal"><span class="hljs-literal">-j</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>(getconf _NPROCESSORS_ONLN)</code> </pre> <br>  Dari dependensi, git akan berguna (dan tidak hanya untuk kloning repositori resmi, file make akan melampirkan sha commit ke versi), make, gcc dan file header (set minimum diperoleh secara empiris).  Kami hanya mengkloning cabang master dengan kedalaman 1 komit (kami jelas tidak membutuhkan sejarah).  Baiklah, mari kita coba memanfaatkan semua sumber daya host saat kompilasi dengan -j switch.  Saya sengaja memecahnya menjadi lebih banyak lapisan untuk mendapatkan caching yang nyaman selama pembangunan kembali (biasanya ada banyak dari mereka). <br><br>  Kami akan menjalankan perintah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">build</a> (berada di direktori dengan Dockerfile): <br><br><pre> <code class="bash hljs">$ docker build -t mtproxy:<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> .</code> </pre> <br>  Dan inilah masalah pertama: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">In</span></span> file included <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ./net/net-connections.h:<span class="hljs-number"><span class="hljs-number">34</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> mtproto/mtproto-config.c:<span class="hljs-number"><span class="hljs-number">44</span></span>: ./jobs/jobs.h:<span class="hljs-number"><span class="hljs-number">234</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>: error: field <span class="hljs-string"><span class="hljs-string">'rand_data'</span></span> has incomplete <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> struct drand48_data rand_data; ^~~~~~~~~</code> </pre><br>  Sebenarnya, semua yang berikutnya akan terhubung dengannya.  Pertama, bagi mereka yang tidak terbiasa dengan diri mereka sendiri, kompiler sebenarnya bersumpah pada kurangnya deklarasi struktur drand48_data.  Kedua, pengembang musl mencetak skor pada fungsi acak thread-safe (dengan postfix _r) dan pada semua yang terhubung dengannya (termasuk struktur).  Dan pengembang Telegram, pada gilirannya, tidak repot-repot dengan kompilasi untuk sistem di mana random_r dan rekan-rekannya tidak diimplementasikan (di banyak pustaka OS Anda dapat melihat bendera HAVE_RANDOM_R atau kehadiran + tidak adanya yang sewenang-wenang atau tidak adanya kelompok fungsi ini biasanya diperhitungkan dalam konfigurasi otomatis). <br><br>  Nah, sekarang kita pasti akan menginstal glibc?  Tidak!  Kami akan menyalin apa yang kami butuhkan dari glibc ke minimum dan membuat tambalan untuk sumber MTProxy. <br><br>  Selain masalah dengan random_r, kami mengambil masalah dengan fungsi backtrace (execinfo.h), yang digunakan untuk menampilkan stack backtrace dalam kasus pengecualian: Anda dapat mencoba menggantinya dengan implementasi dari libunwind, tetapi tidak sepadan, karena panggilan dibingkai dengan memeriksa untuk __GLIBC__. <br><br><div class="spoiler">  <b class="spoiler_title">Konten tambalan Random_compat.patch</b> <div class="spoiler_text"><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">Index: jobs/jobs.h IDEA additional info: Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP &lt;+&gt;UTF-8 =================================================================== --- jobs/jobs.h (revision cdd348294d86e74442bb29bd6767e48321259bec) +++ jobs/jobs.h (date 1527996954000) @@ -28,6 +28,8 @@ #include "net/net-msg.h" #include "net/net-timers.h" +#include "common/randr_compat.h" + #define __joblocked #define __jobref Index: common/server-functions.c IDEA additional info: Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP &lt;+&gt;UTF-8 =================================================================== --- common/server-functions.c (revision cdd348294d86e74442bb29bd6767e48321259bec) +++ common/server-functions.c (date 1527998325000) @@ -35,7 +35,9 @@ #include &lt;arpa/inet.h&gt; #include &lt;assert.h&gt; #include &lt;errno.h&gt; +#ifdef __GLIBC__ #include &lt;execinfo.h&gt; +#endif #include &lt;fcntl.h&gt; #include &lt;getopt.h&gt; #include &lt;grp.h&gt; @@ -168,6 +170,7 @@ } void print_backtrace (void) { +#ifdef __GLIBC__ void *buffer[64]; int nptrs = backtrace (buffer, 64); kwrite (2, "\n------- Stack Backtrace -------\n", 33); @@ -178,6 +181,7 @@ kwrite (2, s, strlen (s)); kwrite (2, "\n", 1); } +#endif } pthread_t debug_main_pthread_id; Index: common/randr_compat.h IDEA additional info: Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP &lt;+&gt;UTF-8 =================================================================== --- common/randr_compat.h (date 1527998264000) +++ common/randr_compat.h (date 1527998264000) @@ -0,0 +1,72 @@ +/* + The GNU C Library is free software. See the file COPYING.LIB for copying + conditions, and LICENSES for notices about a few contributions that require + these additional notices to be distributed. License copyright years may be + listed using range notation, eg, 2000-2011, indicating that every year in + the range, inclusive, is a copyrightable year that would otherwise be listed + individually. +*/ + +#pragma once + +#include &lt;endian.h&gt; +#include &lt;pthread.h&gt; + +struct drand48_data { + unsigned short int __x[3]; /* Current state. */ + unsigned short int __old_x[3]; /* Old state. */ + unsigned short int __c; /* Additive const. in congruential formula. */ + unsigned short int __init; /* Flag for initializing. */ + unsigned long long int __a; /* Factor in congruential formula. */ +}; + +union ieee754_double +{ + double d; + + /* This is the IEEE 754 double-precision format. */ + struct + { +#if __BYTE_ORDER == __BIG_ENDIAN + unsigned int negative:1; + unsigned int exponent:11; + /* Together these comprise the mantissa. */ + unsigned int mantissa0:20; + unsigned int mantissa1:32; +#endif /* Big endian. */ +#if __BYTE_ORDER == __LITTLE_ENDIAN + /* Together these comprise the mantissa. */ + unsigned int mantissa1:32; + unsigned int mantissa0:20; + unsigned int exponent:11; + unsigned int negative:1; +#endif /* Little endian. */ + } ieee; + + /* This format makes it easier to see if a NaN is a signalling NaN. */ + struct + { +#if __BYTE_ORDER == __BIG_ENDIAN + unsigned int negative:1; + unsigned int exponent:11; + unsigned int quiet_nan:1; + /* Together these comprise the mantissa. */ + unsigned int mantissa0:19; + unsigned int mantissa1:32; +#else + /* Together these comprise the mantissa. */ + unsigned int mantissa1:32; + unsigned int mantissa0:19; + unsigned int quiet_nan:1; + unsigned int exponent:11; + unsigned int negative:1; +#endif + } ieee_nan; +}; + +#define IEEE754_DOUBLE_BIAS 0x3ff /* Added to exponent. */ + +int drand48_r (struct drand48_data *buffer, double *result); +int lrand48_r (struct drand48_data *buffer, long int *result); +int mrand48_r (struct drand48_data *buffer, long int *result); +int srand48_r (long int seedval, struct drand48_data *buffer); \ No newline at end of file Index: Makefile IDEA additional info: Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP &lt;+&gt;UTF-8 =================================================================== --- Makefile (revision cdd348294d86e74442bb29bd6767e48321259bec) +++ Makefile (date 1527998107000) @@ -40,6 +40,7 @@ DEPENDENCE_NORM := $(subst ${OBJ}/,${DEP}/,$(patsubst %.o,%.d,${OBJECTS})) LIB_OBJS_NORMAL := \ + ${OBJ}/common/randr_compat.o \ ${OBJ}/common/crc32c.o \ ${OBJ}/common/pid.o \ ${OBJ}/common/sha1.o \ Index: common/randr_compat.c IDEA additional info: Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP &lt;+&gt;UTF-8 =================================================================== --- common/randr_compat.c (date 1527998213000) +++ common/randr_compat.c (date 1527998213000) @@ -0,0 +1,120 @@ +/* + The GNU C Library is free software. See the file COPYING.LIB for copying + conditions, and LICENSES for notices about a few contributions that require + these additional notices to be distributed. License copyright years may be + listed using range notation, eg, 2000-2011, indicating that every year in + the range, inclusive, is a copyrightable year that would otherwise be listed + individually. +*/ + +#include &lt;stddef.h&gt; +#include "common/randr_compat.h" + +int __drand48_iterate (unsigned short int xsubi[3], struct drand48_data *buffer) { + uint64_t X; + uint64_t result; + + /* Initialize buffer, if not yet done. */ + if (!buffer-&gt;__init == 0) + { + buffer-&gt;__a = 0x5deece66dull; + buffer-&gt;__c = 0xb; + buffer-&gt;__init = 1; + } + + /* Do the real work. We choose a data type which contains at least + 48 bits. Because we compute the modulus it does not care how + many bits really are computed. */ + + X = (uint64_t) xsubi[2] &lt;&lt; 32 | (uint32_t) xsubi[1] &lt;&lt; 16 | xsubi[0]; + + result = X * buffer-&gt;__a + buffer-&gt;__c; + + xsubi[0] = result &amp; 0xffff; + xsubi[1] = (result &gt;&gt; 16) &amp; 0xffff; + xsubi[2] = (result &gt;&gt; 32) &amp; 0xffff; + + return 0; +} + +int __erand48_r (unsigned short int xsubi[3], struct drand48_data *buffer, double *result) { + union ieee754_double temp; + + /* Compute next state. */ + if (__drand48_iterate (xsubi, buffer) &lt; 0) + return -1; + + /* Construct a positive double with the 48 random bits distributed over + its fractional part so the resulting FP number is [0.0,1.0). */ + + temp.ieee.negative = 0; + temp.ieee.exponent = IEEE754_DOUBLE_BIAS; + temp.ieee.mantissa0 = (xsubi[2] &lt;&lt; 4) | (xsubi[1] &gt;&gt; 12); + temp.ieee.mantissa1 = ((xsubi[1] &amp; 0xfff) &lt;&lt; 20) | (xsubi[0] &lt;&lt; 4); + + /* Please note the lower 4 bits of mantissa1 are always 0. */ + *result = temp.d - 1.0; + + return 0; +} + +int __nrand48_r (unsigned short int xsubi[3], struct drand48_data *buffer, long int *result) { + /* Compute next state. */ + if (__drand48_iterate (xsubi, buffer) &lt; 0) + return -1; + + /* Store the result. */ + if (sizeof (unsigned short int) == 2) + *result = xsubi[2] &lt;&lt; 15 | xsubi[1] &gt;&gt; 1; + else + *result = xsubi[2] &gt;&gt; 1; + + return 0; +} + +int __jrand48_r (unsigned short int xsubi[3], struct drand48_data *buffer, long int *result) { + /* Compute next state. */ + if (__drand48_iterate (xsubi, buffer) &lt; 0) + return -1; + + /* Store the result. */ + *result = (int32_t) ((xsubi[2] &lt;&lt; 16) | xsubi[1]); + + return 0; +} + +int drand48_r (struct drand48_data *buffer, double *result) { + return __erand48_r (buffer-&gt;__x, buffer, result); +} + +int lrand48_r (struct drand48_data *buffer, long int *result) { + /* Be generous for the arguments, detect some errors. */ + if (buffer == NULL) + return -1; + + return __nrand48_r (buffer-&gt;__x, buffer, result); +} + +int mrand48_r (struct drand48_data *buffer, long int *result) { + /* Be generous for the arguments, detect some errors. */ + if (buffer == NULL) + return -1; + + return __jrand48_r (buffer-&gt;__x, buffer, result); +} + +int srand48_r (long int seedval, struct drand48_data *buffer) { + /* The standards say we only have 32 bits. */ + if (sizeof (long int) &gt; 4) + seedval &amp;= 0xffffffffl; + + buffer-&gt;__x[2] = seedval &gt;&gt; 16; + buffer-&gt;__x[1] = seedval &amp; 0xffffl; + buffer-&gt;__x[0] = 0x330e; + + buffer-&gt;__a = 0x5deece66dull; + buffer-&gt;__c = 0xb; + buffer-&gt;__init = 1; + + return 0; +} \ No newline at end of file</span></span></code> </pre></div></div><br>  Masukkan ke dalam folder ./patches dan modifikasi Dockerfile kita sedikit untuk menerapkan patch dengan cepat: <br><br><pre> <code class="hljs powershell">FROM alpine:<span class="hljs-number"><span class="hljs-number">3.6</span></span> COPY ./patches /mtproxy/patches RUN apk add -<span class="hljs-literal"><span class="hljs-literal">-no</span></span><span class="hljs-literal"><span class="hljs-literal">-cache</span></span> -<span class="hljs-literal"><span class="hljs-literal">-virtual</span></span> .build<span class="hljs-literal"><span class="hljs-literal">-deps</span></span> \ git make gcc musl<span class="hljs-literal"><span class="hljs-literal">-dev</span></span> linux<span class="hljs-literal"><span class="hljs-literal">-headers</span></span> openssl<span class="hljs-literal"><span class="hljs-literal">-dev</span></span> \ &amp;&amp; git clone -<span class="hljs-literal"><span class="hljs-literal">-single</span></span><span class="hljs-literal"><span class="hljs-literal">-branch</span></span> -<span class="hljs-literal"><span class="hljs-literal">-depth</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> https://github.com/TelegramMessenger/MTProxy.git /mtproxy/sources \ &amp;&amp; cd /mtproxy/sources \ &amp;&amp; patch <span class="hljs-literal"><span class="hljs-literal">-p0</span></span> <span class="hljs-literal"><span class="hljs-literal">-i</span></span> /mtproxy/patches/randr_compat.patch \ &amp;&amp; make <span class="hljs-literal"><span class="hljs-literal">-j</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>(getconf _NPROCESSORS_ONLN) \ &amp;&amp; cp /mtproxy/sources/objs/bin/mtproto<span class="hljs-literal"><span class="hljs-literal">-proxy</span></span> /mtproxy/ \ &amp;&amp; rm <span class="hljs-literal"><span class="hljs-literal">-rf</span></span> /mtproxy/{sources,patches} \ &amp;&amp; apk add -<span class="hljs-literal"><span class="hljs-literal">-no</span></span><span class="hljs-literal"><span class="hljs-literal">-cache</span></span> -<span class="hljs-literal"><span class="hljs-literal">-virtual</span></span> .rundeps libcrypto1.<span class="hljs-number"><span class="hljs-number">0</span></span> \ &amp;&amp; apk del .build<span class="hljs-literal"><span class="hljs-literal">-deps</span></span></code> </pre> <br>  Sekarang biner mtproto-proxy yang dirakit setidaknya diluncurkan, dan kita bisa melanjutkan. <br><br><h2>  Izin </h2><br>  Saatnya untuk mengubah run.sh asli menjadi docker-entrypoint.sh.  Menurut pendapat saya, ini logis ketika "pengikatan wajib" masuk ke ENTRYPOINT (selalu dapat kelebihan beban dari luar), dan argumen untuk meluncurkan aplikasi buruh pelabuhan sesuai dengan maksimum dalam CMD (+ variabel lingkungan sebagai pengganti). <br><br>  Kita bisa menginstal bash dan grep penuh di gambar alpine kita (saya akan jelaskan nanti) untuk menghindari sakit kepala dan menggunakan kode asli seperti apa adanya, tetapi itu akan mengembang gambar miniatur kita untuk memalukan, sehingga kita akan tumbuh nyata, ibunya, bonsai. <br><br>  Mari kita mulai dengan shebang, ganti <code>#!/bin/bash</code> dengan <code>#!/bin/sh</code> .  Default untuk alpine ash mampu mencerna hampir semua sintaks bash "sebagaimana adanya", tetapi kami masih menghadapi satu masalah - untuk alasan yang tidak diketahui, ia menolak menerima tanda kurung dalam salah satu kondisi, oleh karena itu kami akan memperluasnya dengan membalikkan logika perbandingan: <br><br><img src="https://habrastorage.org/webt/si/2-/so/si2-soeeicodmjyjpdo0f4u0sma.png"><br><br>  Sekarang kami sedang menunggu showdown dengan grep, yang dalam pengiriman busybox sedikit berbeda dari yang biasa (dan, omong-omong, jauh lebih lambat, ingatlah dalam proyek Anda).  Pertama, dia tidak mengerti ungkapan <code>{,15}</code> , dia harus secara eksplisit menentukan <code>{0,15}</code> .  Kedua, itu tidak mendukung flag <code>-P</code> (gaya perl), tetapi diam-diam mencerna ekspresi ketika extended (-E) diaktifkan. <br><br>  Dalam dependensi kami, hanya ada ikal (tidak ada gunanya menggantinya dengan wget dari busybox) dan libcrypto (cukup, langsung openssl tidak diperlukan sama sekali dalam perakitan ini). <br><br>  Bangunan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">multi-tahap yang</a> indah muncul di Docker beberapa tahun yang lalu, sangat ideal, misalnya, untuk aplikasi Go atau untuk situasi di mana perakitannya rumit dan lebih mudah untuk mentransfer artefak dari gambar ke gambar daripada melakukan pembersihan akhir.  Kami akan menggunakannya untuk menanam bonsai kami, ini akan menghemat sedikit. <br><br><pre> <code class="hljs 1c">FROM alpine:<span class="hljs-number"><span class="hljs-number">3.6</span></span> <span class="hljs-meta"><span class="hljs-meta">#       </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">  ( ) RUN apk add --no-cache --virtual .build-deps \ # ... ,    &amp;&amp; make -j$(getconf _NPROCESSORS_ONLN) FROM alpine:3.6 #   ,  ,   WORKDIR /mtproxy COPY --from=0 /mtproxy/sources/objs/bin/mtproto-proxy . #    </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">      #      </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta">   </span></span></code> </pre><br>  Bonsai harus bonsai - singkirkan instalasi libcrypto.  Ketika membangun, kami membutuhkan file header dari paket openssl-dev, yang dalam dependensi akan menarik libcrypto dan executable kami akan berorientasi pada penggunaan libcrypto.so.1.0.0.  Tapi ini adalah satu-satunya ketergantungan, selain itu, sudah diinstal di Alpine (dalam versi 3.6 itu libcrypto.so.41, 3.7 - libcrypto.so.42, ini ada di / lib /).  Mereka memarahi saya sekarang, ini bukan cara yang paling dapat diandalkan, tapi itu sepadan dan kami masih menambahkan symlink ke versi yang ada (jika Anda memiliki cara yang lebih baik, saya akan dengan senang hati menerima PR). <br><br>  Sentuhan akhir dan hasil: <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Hub docker</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Github</a> <br><br>  Saya akan berterima kasih atas saran dan kontribusi. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id413881/">https://habr.com/ru/post/id413881/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id413871/index.html">Agile praktik terbaik dan praktik untuk tim teknis dan non-teknis</a></li>
<li><a href="../id413873/index.html">Data yang dipulihkan dari misi Apollo membantu memecahkan misteri "memanaskan bulan"</a></li>
<li><a href="../id413875/index.html">SpaceX akan mengembangkan "pusat ruang angkasa masa depan"</a></li>
<li><a href="../id413877/index.html">Anda hanya memberi alasan. Atau dengan dalih apa mereka bisa merampokmu sekarang?</a></li>
<li><a href="../id413879/index.html">Belajar kuda (bagian 4)</a></li>
<li><a href="../id413885/index.html">Cavium ThunderX2 Evaluasi: Mimpi Server Arm Menjadi Nyata (Bagian 1, Pendahuluan)</a></li>
<li><a href="../id413889/index.html">Tenggat waktu terlewat, atau mengapa lebih dari setengah perusahaan tidak siap untuk GDPR</a></li>
<li><a href="../id413891/index.html">Bagaimana Daftar Entitas Hukum Negara Bersatu diorganisasikan - sebuah daftar entitas hukum negara yang bersatu</a></li>
<li><a href="../id413893/index.html">Lubang sebagai alat keamanan - 2, atau cara menangkap "umpan hidup" APT</a></li>
<li><a href="../id413895/index.html">Meretas Gelang Kebugaran Murah</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>