<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✂️ 👸🏼 🆘 Migration auf die Google Cloud Platform (Google Cloud Platform - GCP) 👩🏽‍🚒 🎥 🚛</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="[Teil 2 von 2] 


 [Teil 1 von 2] 





 Wie haben wir das gemacht? 


 Wir haben uns entschlossen, auf GCP umzusteigen , um die Anwendungsleistung zu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migration auf die Google Cloud Platform (Google Cloud Platform - GCP)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/430874/"><h3 id="chast-2-iz-2">  [Teil 2 von 2] </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">[Teil 1 von 2]</a> </p><br><img src="https://habrastorage.org/webt/6m/2c/sx/6m2csxdumpxfx00xrft85x4vdng.png"><br><p><br></p><br><h2 id="kak-nam-eto-udalos">  Wie haben wir das gemacht? </h2><br><p>  Wir haben uns entschlossen, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auf GCP umzusteigen</a> , um die Anwendungsleistung zu verbessern - und gleichzeitig den Umfang zu erhöhen, jedoch ohne erhebliche Kosten.  Der gesamte Prozess dauerte mehr als 2 Monate.  Um dieses Problem zu lösen, haben wir eine spezielle Gruppe von Ingenieuren gebildet. </p><br><p>  In dieser Veröffentlichung werden wir über den gewählten Ansatz und seine Implementierung sowie darüber sprechen, wie wir das Hauptziel erreicht haben - diesen Prozess so reibungslos wie möglich durchzuführen und die gesamte Infrastruktur auf die Google Cloud Platform zu übertragen, ohne die Qualität des Nutzerdienstes zu beeinträchtigen. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ee6/5d3/693/ee65d3693b51048de4322274109bd23d.png" alt="Bild"></p><a name="habracut"></a><br><h2 id="planirovanie">  Planung </h2><br><ol><li>  Es wurde eine detaillierte Checkliste erstellt, in der jeder mögliche Schritt aufgeführt ist.  Zur Beschreibung der Sequenz wurde ein Flussdiagramm erstellt. </li><li>  Es wurde ein Rücksetzplan entwickelt, den wir, wenn überhaupt, verwenden könnten. </li></ol><br><p> Einige Brainstorming-Sitzungen - und wir haben den verständlichsten und einfachsten Ansatz für die Implementierung des Aktiv-Aktiv-Schemas ermittelt.  Es besteht in der Tatsache, dass eine kleine Gruppe von Benutzern in einer Cloud und der Rest in einer anderen gehostet wird.  Dieser Ansatz verursachte jedoch Probleme, insbesondere auf der Clientseite (im Zusammenhang mit der DNS-Verwaltung), und führte zu Verzögerungen bei der Datenbankreplikation.  Aus diesem Grund war es fast unmöglich, es sicher umzusetzen.  Die offensichtliche Methode lieferte nicht die notwendige Lösung, und wir mussten eine spezielle Strategie entwickeln. </p><br><p>  Basierend auf dem Abhängigkeitsdiagramm und den Anforderungen an die Betriebssicherheit haben wir die Infrastrukturdienste in 9 Module unterteilt. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/290/5eb/c21/2905ebc2190ea9f8d480e5532a196a1f.jpg" alt="Bild"></p><br><p>  <em>(Grundmodule für die Bereitstellung der Hosting-Infrastruktur)</em> </p><br><p>  Jede Infrastrukturgruppe verwaltete gemeinsame interne und externe Dienste. </p><br><p>  ⊹ <strong>Infrastruktur-Messaging-Dienst</strong> : MQTT, HTTPs, Thrift, Gunicorn-Server, Warteschlangenmodul, Async-Client, Jetty-Server, Kafka-Cluster. <br>  ⊹ <strong>Data Warehouse-Dienste</strong> : Verteilte Cluster-MongoDB, Redis, Cassandra, Hbase, MySQL und MongoDB. <br>  ⊹ <strong>Infrastrukturanalysedienst</strong> : Kafka-Cluster, Data Warehouse-Cluster (HDFS, HIVE). </p><br><h2 id="podgotovka-k-znamenatelnomu-dnyu">  Vorbereitung auf einen wichtigen Tag: </h2><br><p>  ✓ Ein detaillierter Plan für den Wechsel zu GCP für jeden Dienst: Sequenz, Data Warehouse, Plan für das Zurücksetzen. <br>  ✓ Projektübergreifende Netzwerkinteraktionen (Shared Virtual Private Cloud VPC [XPN]) in GCP, um verschiedene Teile der Infrastruktur zu isolieren, das Management zu optimieren, die Sicherheit und Konnektivität zu verbessern. <br>  ✓ Mehrere VPN-Tunnel zwischen dem GCP und der laufenden Virtual Private Cloud (VPC), um die Übertragung großer Datenmengen über das Netzwerk während der Replikation sowie die mögliche spätere Bereitstellung eines parallelen Systems zu vereinfachen. <br>  ✓ Automatisieren Sie die Installation und Konfiguration des gesamten Stacks mithilfe des Chef-Systems. <br>  ✓ Skripte und Automatisierungstools für Bereitstellung, Überwachung, Protokollierung usw. <br>  ✓ Konfigurieren Sie alle erforderlichen Subnetze und verwalteten Firewall-Regeln für den Systemstrom. <br>  ✓ Replikation in mehreren Rechenzentren (Multi-DC) für alle Speichersysteme. <br>  ✓ Konfigurieren Sie Load Balancer (GLB / ILB) und verwaltete Instanzgruppen (MIG). <br>  ✓ Skripte und Code zum Übertragen des Objektspeichercontainers in den GCP Cloud Storage mit Prüfpunkten. </p><br><p>  Bald erfüllten wir alle notwendigen Voraussetzungen und erstellten eine Checkliste mit Elementen für die Verlagerung der Infrastruktur auf die GCP-Plattform.  Nach zahlreichen Diskussionen und unter Berücksichtigung der Anzahl der Dienste und ihrer Abhängigkeitsdiagramme haben wir beschlossen, die Cloud-Infrastruktur in drei Nächten auf GCP zu übertragen, um alle serverseitigen und Datenspeicherungsdienste abzudecken. </p><br><h2 id="perehod">  Übergang </h2><br><h3 id="strategiya-perenosa-balansirovschika-nagruzki">  Load Balancer Transfer Strategie: </h3><br><p>  Wir haben den zuvor verwendeten HAProxy-verwalteten Cluster durch einen globalen Load Balancer ersetzt, um täglich mehrere zehn Millionen aktive Benutzerverbindungen zu verarbeiten. </p><br><p>  ⊹ <strong>Stufe 1:</strong> </p><br><ul><li>  MIGs werden mit Paketweiterleitungsregeln erstellt, um den gesamten Datenverkehr an MQTT-IP-Adressen in der vorhandenen Cloud weiterzuleiten. </li><li>  Ein SSL- und TCP-Proxy-Balancer wurde mit MIG als Serverteil erstellt. </li><li>  Für MIG wird HAProxy mit MQTT-Servern als Serverteil gestartet. </li><li>  In DNS hat eine gewichtsbasierte Routing-Richtlinie eine externe GLB-IP-Adresse hinzugefügt. </li></ul><br><p>  Benutzerverbindungen werden schrittweise bereitgestellt, während ihre Leistung verfolgt wird. </p><br><p>  ⊹ <strong>Schritt 2:</strong> Meilensteinübergang: Starten Sie die Bereitstellung von Diensten in GCP. <br>  ⊹ <strong>Phase 3:</strong> In der letzten Phase des Übergangs werden alle Dienste an das GCP übertragen. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ebb/fcb/614/ebbfcb614345c40b20de5c9e8edd9a8e.png" alt="Bild"></p><br><p>  <em>(Übertragungsstufen des Load Balancers)</em> </p><br><p>  Zu diesem Zeitpunkt funktionierte alles wie erwartet.  Bald war es an der Zeit, mehrere interne HTTP-Dienste in GCP mit Routing bereitzustellen - angesichts des Gewichts der Koeffizienten.  Wir haben alle Indikatoren genau überwacht.  Als wir am Tag vor dem geplanten Übergang begannen, den Datenverkehr schrittweise zu erhöhen, nahmen die Verzögerungen bei der VPC-Interaktion über VPN (Verzögerungen von 40 ms - 100 ms wurden aufgezeichnet, obwohl sie früher weniger als 10 ms betrugen) zu. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b6c/af5/3bc/b6caf53bc304c2fd42c9342dd11faf82.png" alt="Bild"></p><br><p>  <em>(Momentaufnahme der Überprüfung der Netzwerkverzögerung, wenn zwei VPCs interagieren)</em> </p><br><p>  Die Überwachung zeigte deutlich: Bei beiden Cloud-Netzwerkkanälen mit VPN-Tunneln stimmte etwas nicht.  Selbst der Durchsatz des VPN-Tunnels erreichte nicht die optimale Marke.  Diese Situation hat begonnen, einige unserer Benutzerdienste negativ zu beeinflussen.  Wir haben alle zuvor migrierten HTTP-Dienste sofort in ihren ursprünglichen Zustand zurückversetzt.  Wir kontaktierten die Supportteams von TAM und Cloud Services, stellten die erforderlichen Anfangsdaten bereit und begannen zu verstehen, warum die Verzögerungen zunahmen.  Support-Spezialisten kamen zu dem Schluss, dass die maximale Netzwerkbandbreite im Cloud-Kanal zwischen zwei Cloud-Service-Providern erreicht wurde.  Daher die Zunahme von Netzwerkverzögerungen während der Übertragung interner Systeme. </p><br><p>  Dieser Vorfall zwang dazu, den Übergang zur Cloud auszusetzen.  Cloud-Dienstanbieter konnten die Bandbreite nicht schnell genug verdoppeln.  Daher sind wir zur Planungsphase zurückgekehrt und haben die Strategie überarbeitet.  Wir haben uns entschlossen, die Cloud-Infrastruktur in einer statt in drei Nächten auf GCP zu übertragen, und alle Dienste des Serverteils und des Datenspeichers in den Plan aufgenommen.  Als die Stunde „X“ eintraf, verlief alles reibungslos: Die Workloads wurden von unseren Nutzern unbemerkt erfolgreich in die Google Cloud übertragen! </p><br><h2 id="strategiya-perenosa-bazy-dannyh">  Datenbankmigrationsstrategie: </h2><br><p>  Es war erforderlich, mehr als 50 Datenbankendpunkte für ein relationales DBMS, In-Memory-Speicher sowie NoSQL und verteilte und skalierbare Cluster mit geringer Latenz zu übertragen.  Wir haben Replikate aller Datenbanken in GCP platziert.  Dies wurde für alle Bereitstellungen außer HBase durchgeführt. </p><br><p>  ⊹ <strong>Master-Slave-Replikation:</strong> Implementiert für MySQL-, Redis-, MongoDB- und MongoS-Cluster. <br>  <strong>Multi Multi-DC-Replikation:</strong> Implementiert für Cassandra-Cluster. <br>  ⊹ <strong>Duale Cluster:</strong> Für Gbase in GCP wurde <strong>ein</strong> paralleler Cluster konfiguriert.  Bestehende Daten wurden migriert, die doppelte Eingabe wurde gemäß der Strategie zur Aufrechterhaltung der Datenkonsistenz in beiden Clustern konfiguriert. </p><br><p>  Im Fall von HBase bestand das Problem darin, Ambari einzurichten.  Beim Platzieren von Clustern in mehreren Rechenzentren sind einige Schwierigkeiten aufgetreten. Beispielsweise gab es Probleme mit DNS, einem Rack-Erkennungsskript usw. </p><br><p>  Die letzten Schritte (nach dem Verschieben der Server) umfassten das Verschieben der Replikate auf die Hauptserver und das Herunterfahren der alten Datenbanken.  Um die Priorität der Datenbankübertragung zu bestimmen, haben wir wie geplant Zookeeper für die erforderliche Konfiguration von Anwendungsclustern verwendet. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/550/4e6/6d3/5504e66d3db5f8e35db7eccbfb1cfa6e.png" alt="Bild"></p><br><h2 id="strategiya-perenosa-sluzhb-prilozheniy">  Migrationsstrategie für Anwendungsdienste </h2><br><p>  Um die Arbeitslast der Anwendungsdienste vom aktuellen Hosting in die GCP-Cloud zu übertragen, haben wir den Lift-and-Shift-Ansatz verwendet.  Für jeden Anwendungsdienst haben wir eine Gruppe verwalteter Instanzen (MIG) mit automatischer Skalierung erstellt. </p><br><p>  In Übereinstimmung mit einem detaillierten Plan haben wir begonnen, Dienste nach GCP zu migrieren, wobei die Reihenfolge und Abhängigkeiten von Data Warehouses berücksichtigt wurden.  Alle Messaging-Stack-Dienste wurden ohne Ausfallzeiten auf GCP migriert.  Ja, es gab einige kleinere Störungen, aber wir haben uns sofort darum gekümmert. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b1b/70f/159/b1b70f159f2698731b5b6e166afa1079.png" alt="Bild"></p><br><p>  Am Morgen, als die Benutzeraktivität zunahm, folgten wir sorgfältig allen Dashboards und Indikatoren, um Probleme schnell zu identifizieren.  Einige Schwierigkeiten traten wirklich auf, aber wir konnten sie schnell beseitigen.  Eines der Probleme war auf die Einschränkungen des internen Load Balancers (ILB) zurückzuführen, der nicht mehr als 20.000 gleichzeitige Verbindungen verarbeiten kann.  Und wir brauchten 8 mal mehr!  Aus diesem Grund haben wir unserer Verbindungsverwaltungsschicht zusätzliche ILBs hinzugefügt. </p><br><p>  In den ersten Stunden der Spitzenlast nach dem Übergang haben wir alle Parameter besonders sorgfältig gesteuert, da die gesamte Last des Messaging-Stacks auf GCP übertragen wurde.  Es gab ein paar kleine Pannen, mit denen wir uns sehr schnell befasst haben.  Bei der Migration anderer Dienste haben wir den gleichen Ansatz gewählt. </p><br><h2 id="perenos-hranilischa-obektov">  Objektspeichermigration: </h2><br><p>  Wir verwenden den Objektspeicherdienst hauptsächlich auf drei Arten. </p><br><p>  ⊹ Speicherung von Mediendateien, die an einen persönlichen oder Gruppenchat gesendet wurden.  Die Aufbewahrungsdauer wird durch die Lebenszyklusmanagementrichtlinie festgelegt. <br>  ⊹ Speicherung von Bildern und Miniaturansichten des Benutzerprofils. <br>  ⊹ Speicherung von Mediendateien aus den Abschnitten "Verlauf" und "Zeitleiste" sowie den entsprechenden Miniaturansichten. </p><br><p>  Wir haben das Speicherübertragungstool von Google verwendet, um alte Objekte von S3 nach GCS zu kopieren.  Wir haben auch eine benutzerdefinierte Kafka-basierte MIG verwendet, um Objekte von S3 nach GCS zu übertragen, wenn eine spezielle Logik erforderlich war. </p><br><h3 id="perehod-s-s3-na-gcs-vklyuchal-sleduyuschie-shagi">  Der Übergang von S3 zu GCS umfasste die folgenden Schritte: </h3><br><p>  ● Für den ersten Anwendungsfall des Objektspeichers haben wir begonnen, neue Daten sowohl in S3 als auch in GCS zu schreiben, und nach Ablauf haben wir begonnen, Daten aus GCS mithilfe der Logik auf der Anwendungsseite zu lesen.  Das Übertragen alter Daten ist nicht sinnvoll und dieser Ansatz ist kostengünstig. <br>  ● Für den zweiten und dritten Anwendungsfall haben wir begonnen, neue Objekte in GCS zu schreiben, und den Pfad zum Lesen von Daten so geändert, dass die Suche zuerst in GCS und erst dann in S3 durchgeführt wird, wenn das Objekt nicht gefunden wird. <br>  Es dauerte <strong>Monate</strong> , um <strong>zu</strong> planen, die Richtigkeit des Konzepts zu überprüfen, vorzubereiten und Prototypen zu erstellen, aber dann haben wir uns für den Übergang entschieden und ihn sehr schnell umgesetzt.  Wir haben die Risiken bewertet und festgestellt, dass eine schnelle Migration vorzuziehen und kaum wahrnehmbar ist. <br>  Dieses Großprojekt hat uns geholfen, eine starke Position zu erlangen und die Teamproduktivität in vielen Bereichen zu steigern, da die meisten manuellen Vorgänge zur Verwaltung der Cloud-Infrastruktur in der Vergangenheit liegen. <br>  ● Was die Benutzer betrifft, haben wir jetzt alles Notwendige erhalten, um die höchste Qualität ihres Dienstes sicherzustellen.  Die Ausfallzeiten sind fast verschwunden und neue Funktionen werden schneller implementiert. <br>  ● Unser Team verbringt weniger Zeit mit Wartungsaufgaben und kann sich auf Automatisierungsprojekte und die Erstellung neuer Tools konzentrieren. <br>  ● Wir haben Zugriff auf eine beispiellose Reihe von Tools für die Arbeit mit Big Data sowie auf vorgefertigte Funktionen für maschinelles Lernen und Analyse.  Details finden Sie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">hier.</a> <br>  ● Das Engagement von Google Cloud für die Zusammenarbeit mit dem Open Source-Projekt von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Kubernetes entspricht</a> auch unserem Entwicklungsplan für dieses Jahr. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de430874/">https://habr.com/ru/post/de430874/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de430864/index.html">Streichhölzer sind kein Spielzeug?</a></li>
<li><a href="../de430866/index.html">Peking wird 2020 ein soziales Rating für Einwohner einführen</a></li>
<li><a href="../de430868/index.html">Was ist beim Kauf von NGFW zu beachten? Checkliste</a></li>
<li><a href="../de430870/index.html">Installieren Sie BigBlueButton unter Ubuntu 16.04</a></li>
<li><a href="../de430872/index.html">Wer wird die Mesh-Debatte gegen ESB gewinnen?</a></li>
<li><a href="../de430876/index.html">Entwicklung durch Testen: Verbesserung der Fähigkeiten</a></li>
<li><a href="../de430878/index.html">Verfügbares PhpStorm 2018.3</a></li>
<li><a href="../de430880/index.html">Eine weitere Implementierung der Datenverarbeitung</a></li>
<li><a href="../de430882/index.html">Xiaomi Aqara Wechseln Sie von ZigBee zu Z-Wave</a></li>
<li><a href="../de430884/index.html">Druckerei: Warum "LANIT-Integration" eine eigene "Druckerei" eröffnete</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>