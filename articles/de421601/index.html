<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏸 🎷 🧘🏿 In gcc gibt es 16-Bit-Adressen, und plötzlich beträgt der Speicher 256 KB ⛷️ 😎 👩‍💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="... oder wie man sich auf einem Arduino in den Fuß schießt 


 In der Sommer-Computerschule verwenden wir einen alten Computer, der von uns selbst her...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>In gcc gibt es 16-Bit-Adressen, und plötzlich beträgt der Speicher 256 KB</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/421601/"><h3>  ... oder wie man sich auf einem Arduino in den Fuß schießt </h3><br><img src="https://habrastorage.org/webt/au/ls/xe/aulsxefr4dfzff3oo9-nkcn5ep4.jpeg"><br><br>  In der Sommer-Computerschule verwenden wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen alten Computer, der von</a> uns selbst hergestellt wurde, um die Spieleentwicklung zu unterrichten. <br><br>  Jetzt verfügt es über eine Arduino Mega-Karte mit einem ATmega2560-Prozessor, in dem bis zu 256 Kilobyte Flash-Speicher gespeichert sind.  Es wurde angenommen, dass dies sehr lange dauern würde, da die Spiele einfach sind (der Bildschirm ist nur 64x64 Pixel groß).  In der Realität traten einige Probleme auf, als die Firmware ungefähr 128 Kilobyte erreichte. <br><a name="habracut"></a><br>  Im Programmspeicher werden trotz des Namens neben dem ausführbaren Code der Spiele alle Arten von unveränderten Daten wie Sprites und Level-Tabellen gespeichert.  Diese Daten sind nicht so sehr. <br><br>  Aber als wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">den YM2149F-Soundchip an unseren Computer angeschlossen</a> und ein paar Dutzend Musikstücke in denselben Programmspeicher heruntergeladen haben, begannen Probleme. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/25m7so4vmKQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Das Präfix stürzte ab, wenn versucht wurde, eine Melodie abzuspielen, oder es wurde Müll in das Spielmenü gezogen.  Es war nicht klar, wie dies überhaupt zu debuggen ist, da der Prozessor nicht nur die Logik des Spiels behandelt, sondern auch Bild und Ton anzeigt.  Als Ergebnis stellte sich heraus, dass der gcc-avr-Compiler Variablen mit einer Größe von zwei Bytes zum Speichern von Zeigern verwendet.  Es ist jedoch unmöglich, 256 Kilobyte mit nur zwei Bytes zu adressieren!  Wie kommt er raus? <br><br><h3>  Code-Zeiger </h3><br>  Erstens können Funktionsaufrufanweisungen und Sprünge Drei-Byte-Adressen verwenden.  Daher reicht es für den Linker aus, die vollständige Adresse in einer solchen Anweisung zu ersetzen, und es wird funktionieren.  Wenn die Adresse der Funktion über einen Zeiger übergeben wird, wird eine solche Nummer nicht übergeben - da wir einen Doppelbyte-Zeiger haben. <br><br>  In dieser Situation fügt gcc ein „Sprungbrett“ in die unteren 64 KB ein - den Befehl jmp, der auf die gewünschte Funktion umschaltet.  Dann fungiert die Adresse dieses Sprungbretts als Adresse der Funktion, die in der Variablen gespeichert werden muss - schließlich wird sie in zwei Bytes platziert.  Und wenn es angerufen wird, wird es bei Bedarf einen Übergang geben. <br><br><h3>  Datenzeiger </h3><br>  Wir speichern aber nicht nur den ausführbaren Code im Programmspeicher.  Die Sprünge werden hier also nicht helfen - wir dereferenzieren Zeiger, gehen aber nicht zu ihnen. <br><br>  Die AVR-Bibliothek verfügt sogar über Funktionen / Makros wie pgm_read_byte_far (addr), um den vollständigen Zeiger zu dereferenzieren (ihnen werden Vier-Byte-Werte übergeben).  Aber gcc weiß nicht, wie man diese Zeiger mit der C-Sprache bekommt. <br><br>  Glücklicherweise gibt es ein Makro pgm_get_far_address (var), um die vollständige Adresse einer Variablen abzurufen.  Dies erfolgt mit dem integrierten Assembler (der Fall, wenn der Assembler schlauer als der Compiler ist). <br><br>  Der gesamte Code, der die Daten im ROM verwendet, muss noch neu geschrieben werden.  Das heißt, ein Musik-Player, der Sprites rendert, Text ausgibt, ... Keine sehr angenehme Erfahrung.  Ja, und der Code wird hemmender, und für Grafiken ist er sehr kritisch.  Daher ist <br><br><h3>  Wir verteilen Daten auf ROM </h3><br>  Linker ist sehr bemüht, Daten für den Programmspeicher in den unteren 64 KB zu speichern.  Dies funktioniert nicht, wenn zu viele Daten vorhanden sind.  Aber die größten Daten, die wir haben, sind Musikdateien.  Wenn Sie also nur sie entfernen, passt alles andere in den unteren Speicher und Sie müssen den Hauptteil des Codes nicht wiederholen. <br><br>  Dazu nutzen wir die Funktionen des Linker-Skripts.  Einer der letzten Abschnitte, die der Linker im ROM platziert, heißt .fini7.  Speichern Sie alle Musik-Arrays in diesem Abschnitt: <br><br><pre><code class="hljs cpp"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> MUSICMEM __attribute__((section(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">".fini7"</span></span></span><span class="hljs-meta">))) const uint8_t tetris2[] MUSICMEM = { ... };</span></span></code> </pre> <br>  Jetzt sagt uns avr-nm, dass alles in Ordnung ist - die Daten mit Sprites und Levels befinden sich unten im ROM und die Musik oben. <br><br><pre> <code class="hljs lisp"><span class="hljs-number"><span class="hljs-number">00002f9</span></span>c <span class="hljs-literal"><span class="hljs-literal">t</span></span> _ZL10level_menu <span class="hljs-number"><span class="hljs-number">00002e0</span></span>f <span class="hljs-literal"><span class="hljs-literal">t</span></span> _ZL10rope_lines <span class="hljs-number"><span class="hljs-number">000006</span></span>de <span class="hljs-literal"><span class="hljs-literal">t</span></span> _ZL10ShipSprite <span class="hljs-number"><span class="hljs-number">00023</span></span>a09 <span class="hljs-literal"><span class="hljs-literal">t</span></span> tetris2 <span class="hljs-number"><span class="hljs-number">00024714</span></span> T the_last_v8</code> </pre><br>  Es bleibt, den Player zu wiederholen, um Vier-Byte-Zeiger zu verwenden, und anstatt einen Zeiger auf ein Array mit dem Melodiecode zu verwenden, verwenden Sie die Funktion, um seine Adresse abzurufen.  Funktionen sind erforderlich, da wir eine Player-Anwendung haben, mit der Sie alle Musikstücke Ihrer Wahl anhören können.  Es speichert jetzt Zeiger auf Funktionen dieser Art: <br><br><pre> <code class="hljs xml">00006992 <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">_Z12tetris2_addrv</span></span></span><span class="hljs-tag">&gt;</span></span>: 6992: 61 ef ldi r22, 0xF1 ; 241 6994: 7a e3 ldi r23, 0x3A ; 58 6996: 82 e0 ldi r24, 0x02 ; 2 6998: 99 27 eor r25, r25 699a: 08 95 ret</code> </pre><br>  Das Ende der Welt wird verzögert, bis die Sprites die unteren 64k erreichen.  Dies ist unwahrscheinlich, da immer noch mehr Code als Sprites vorhanden ist, was bedeutet, dass der Speicher wahrscheinlich im Allgemeinen endet. <br><br><h2>  Bonus </h2><br>  Diesen Sommer haben wir ein Spiel im Stil von Sokoban geschrieben.  Einige Level erwiesen sich als ziemlich schwierig.  Versuchen Sie zum Beispiel, diese zu bestehen: <br><br><img src="https://habrastorage.org/webt/iz/cf/pc/izcfpcl-yyvvomrv4l-tqowuemo.png"><br><br><h2>  Referenzen </h2><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Github-Projektseite</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arduino und LED-Anzeige</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Arduino und der musikalische Stein des <s>Philosophen</s></a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Die letzten Spiele des letzten Jahres</a> </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de421601/">https://habr.com/ru/post/de421601/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de421589/index.html">Metamorphosen: molekulare Programmierung der Form</a></li>
<li><a href="../de421591/index.html">Budget-System für die drahtlose (Wi-Fi) autonome Videoüberwachung (ohne Batterie)</a></li>
<li><a href="../de421593/index.html">SandboxEscaper / PoC-LPE: Was ist drin?</a></li>
<li><a href="../de421595/index.html">Wie IT-Mitarbeiter in den USA und in der EU Arbeit finden: 9 beste Ressourcen</a></li>
<li><a href="../de421599/index.html">Intel Crimson Canyon - NUC mit diskreter Grafik und 10-nm-Prozessor</a></li>
<li><a href="../de421603/index.html">Google und DevOps: zwei Bücher über SRE</a></li>
<li><a href="../de421607/index.html">"Wir versuchen nicht einmal, den alten Code auszuführen, wir haben im Prinzip keine solche Aufgabe" - Roman Elizarov über die Entwicklung von Kotlin</a></li>
<li><a href="../de421611/index.html">Wie World of Warcraft geschaffen wurde: Ein Einblick in 20 Jahre Entwicklung</a></li>
<li><a href="../de421613/index.html">Wie wir Artikel über Habr schreiben: Erfahrungen von EastBanc Technologies-Entwicklern</a></li>
<li><a href="../de421615/index.html">Die Lösung für das Fehlen von prevProps in getDerivedStateFromProps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>