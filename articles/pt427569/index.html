<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèº‚Äç‚úàÔ∏è üç≤ üï§ Ajuste o OpenStack sob alta carga üë®üèæ‚Äçü§ù‚Äçüë®üèΩ üèÜ ü§∑üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ol√°, meu nome √© Maxim, sou administrador de sistemas. Tr√™s anos atr√°s, meus colegas e eu come√ßamos a transferir produtos para microsservi√ßos e decidim...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ajuste o OpenStack sob alta carga</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yamoney/blog/427569/"><p>  Ol√°, meu nome √© Maxim, sou administrador de sistemas.  Tr√™s anos atr√°s, meus colegas e eu come√ßamos a transferir produtos para microsservi√ßos e decidimos usar o Openstack como plataforma, e encontramos v√°rios ancinhos n√£o √≥bvios ao automatizar circuitos de teste.  Este post √© sobre as nuances da configura√ß√£o do OpenStack, que dificilmente s√£o encontradas na quinta p√°gina dos resultados dos mecanismos de pesquisa (ou melhor, s√£o facilmente na primeira). </p><br><p><img src="https://habrastorage.org/webt/mq/7k/0o/mq7k0oanmmzmtasnicu6ra237po.png"><br>  <em>A carga nos n√∫cleos: foi - tornou-se</em> </p><br><h3 id="nat">  NAT </h3><br><p>  Em alguns casos, usamos dualstack.  √â quando a m√°quina virtual recebe dois endere√ßos ao mesmo tempo - IPv4 e IPv6.  Primeiro, garantimos que o endere√ßo v4 ‚Äúflutuante‚Äù fosse atribu√≠do na rede interna por NAT e a m√°quina recebesse v6 por BGP, mas h√° alguns problemas com isso. </p><br><p> NAT - um n√≥ adicional na rede, onde, mesmo sem ele, voc√™ precisa monitorar a distribui√ß√£o de carga normal.  A apar√™ncia do NAT na rede quase sempre leva a dificuldades com a depura√ß√£o - no host, um IP, no banco de dados, e fica dif√≠cil rastrear a solicita√ß√£o.  As pesquisas em massa s√£o iniciadas e a solu√ß√£o ainda estar√° dentro do OpenStack. </p><br><p>  Ainda assim, o NAT n√£o permite fazer uma segmenta√ß√£o normal de acesso entre projetos.  Todos os projetos t√™m suas pr√≥prias sub-redes, os IPs flutuantes migram constantemente e, com o NAT, torna-se absolutamente imposs√≠vel gerenciar isso.  Algumas instala√ß√µes falam sobre o uso do NAT 1 em 1 (o endere√ßo interno n√£o difere do externo), mas isso ainda deixa links desnecess√°rios na cadeia de intera√ß√£o com servi√ßos externos.  Chegamos √† conclus√£o de que para n√≥s a melhor op√ß√£o √© uma rede BGP. </p><a name="habracut"></a><br><h2 id="chem-prosche-tem-luchshe">  Quanto mais simples, melhor </h2><br><p>  Tentamos v√°rias ferramentas de automa√ß√£o, mas optamos pelo Ansible.  Essa √© uma boa ferramenta, mas sua funcionalidade padr√£o (mesmo levando em considera√ß√£o m√≥dulos adicionais) pode n√£o ser suficiente em algumas situa√ß√µes dif√≠ceis. </p><br><p>  Por exemplo, atrav√©s do m√≥dulo Ansible, voc√™ n√£o pode especificar de quais endere√ßos de sub-rede ser√£o alocados.  Ou seja, voc√™ pode especificar uma rede, mas n√£o pode definir um pool de endere√ßos espec√≠fico.  O comando shell que cria o IP flutuante ajudar√° aqui: </p><br><pre><code class="bash hljs">openstack floating ip create -c floating_ip_address -f value -project \ {{ project name }} ‚Äîsubnet private-v4 CLOUD_NET</code> </pre> <br><p>  Outro exemplo de funcionalidade ausente: devido ao dualstack, n√£o podemos criar corretamente um roteador com duas portas para v4 e v6.  √â aqui que um script bash √© √∫til: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#! /bin/bash # $1 - router_name # $2 - router_project # $3 - router_network # echo "${@:4}" - private subnet lists FIXED4_SUBNET="subnet-bgp-nexthop-v4" FIXED6_SUBNET="subnet-bgp-nexthop-v6" openstack --os-project-name $2 router show $1 if [ $? -eq 0 ] then echo "router is exist" exit 0 fi openstack --os-project-name $2 router create --project $2 $1 for subnet in "${@:4}"; do openstack --os-project-name $2 router add subnet $1 $subnet done openstack --os-project-name $2 router set $1 --external-gateway $3 --fixed-ip subnet=$FIXED4_SUBNET --fixed-ip subnet=$FIXED6_SUBNET</span></span></code> </pre> <br><p>  O script cria um roteador, adiciona sub-redes v4 e v6 e atribui um gateway externo. </p><br><h3 id="retry">  Repetir </h3><br><p>  Em qualquer situa√ß√£o incompreens√≠vel - reinicie.  Tente novamente, crie uma inst√¢ncia, um roteador ou um registro DNS, porque voc√™ nem sempre entende rapidamente qual √© o seu problema.  A nova tentativa pode atrasar a degrada√ß√£o do servi√ßo e, nesse momento, voc√™ pode, com calma e sem nervos, resolver o problema. </p><br><p>  Todas as dicas acima realmente funcionam muito bem com Terraform, Puppet e qualquer outra coisa. </p><br><h2 id="vsemu-svoyo-mesto">  Tudo tem o seu lugar </h2><br><p>  Qualquer servi√ßo grande (o OpenStack n√£o √© uma exce√ß√£o) combina muitos servi√ßos menores que podem interferir no trabalho um do outro.  Aqui est√° um exemplo. </p><br><p>  Agente de rede O agente Neutron-L2 √© respons√°vel pela conectividade de rede no OpenStack.  Se todos os outros agentes estiverem parcialmente nos controladores, L2, devido √†s especificidades, estar√° presente em todos os lugares. </p><br><p><img src="https://habrastorage.org/webt/ae/dx/uh/aedxuhggl2u8fyrtqgwkfphjjle.png"><br>  <em>Foi assim que nossa infraestrutura ficou no in√≠cio, at√© o n√∫mero de esquemas exceder 50</em> </p><br><p>  Nesse ponto, percebemos que, devido a esse arranjo de agentes, os controladores n√£o podiam lidar com a carga e transferimos os agentes para os n√≥s de computa√ß√£o.  Eles s√£o mais poderosos que os controladores e, al√©m disso, o controlador n√£o precisa lidar com o processamento de tudo - deve dar a tarefa ao n√≥ de execu√ß√£o e o n√≥ ir√° execut√°-lo. </p><br><p><img src="https://habrastorage.org/webt/63/mh/8v/63mh8vrzvrqv3w5exan5tw8npba.png"><br>  <em>Agentes transferidos para calcular n√≥s</em> </p><br><p>  No entanto, isso n√£o foi suficiente, porque esse arranjo teve um efeito ruim no desempenho das m√°quinas virtuais.  Com uma densidade de 14 n√∫cleos virtuais por f√≠sico, se um agente de rede come√ßar a carregar o fluxo, isso poder√° afetar v√°rias m√°quinas virtuais ao mesmo tempo. </p><br><p><img src="https://habrastorage.org/webt/br/z5/zi/brz5ziy4mpmlr2ijectmrezvgtw.png"><br>  <em>Terceira itera√ß√£o.</em>  <em>N√≥s selecionados apareceram.</em> </p><br><p>  Pensamos e movemos os agentes para separar os n√≥s da rede.  Agora, apenas os servi√ßos para m√°quinas virtuais permanecem nos n√≥s de computa√ß√£o, todos os agentes trabalham nos n√≥s da rede e apenas os agentes bgp que lidam com a rede v6 permanecem nos controladores (j√° que um agente bgp pode servir apenas um tipo de rede).  L2 permaneceu em todo lugar, porque sem ele, como escrevemos acima, n√£o haveria conectividade na rede. </p><br><p><img src="https://habrastorage.org/webt/pu/yg/ie/puygieqmiyz9zi8dlovcu_j88ma.png"><br>  <em>Carregue o gr√°fico dos n√≥s de computa√ß√£o antes que tudo seja misturado.</em>  <em>Era cerca de 60%, mas a carga caiu insignificante</em> </p><br><p><img src="https://habrastorage.org/webt/y5/im/t2/y5imt2_c5e-7xoha7crtboepbd4.png"><br>  <em>A carga no softirq antes que os agentes de rede removessem os n√≥s de computa√ß√£o.</em>  <em>Tr√™s n√∫cleos permaneceram carregados.</em>  <em>Naquela √©poca, pens√°vamos que era normal</em> </p><br><h2 id="code-asdocumentation">  C√≥digo como documenta√ß√£o </h2><br><p>  √Äs vezes acontece que o c√≥digo √© a documenta√ß√£o, especialmente em servi√ßos grandes como o OpenStack.  Com um ciclo de lan√ßamento de seis meses, os desenvolvedores esquecem ou simplesmente n√£o t√™m tempo para documentar algumas coisas, e isso acontece como no exemplo abaixo. </p><br><h4 id="pro-taymauty">  Sobre tempos limite </h4><br><p>  Uma vez que vimos que as chamadas da Neutron para o Open vSwitch n√£o cabem em cinco segundos e caem no tempo limite. </p><br><pre> <code class="bash hljs">127.0.0.1:29696: no response to inactivity probe after 10 seconds, disconnecting neutron.agent.ovsdb.native.commands TimeoutException: Commands [DbSetCommand(table=Port, col_values=((<span class="hljs-string"><span class="hljs-string">'tag'</span></span>, 11),), record=qtoq69a81c6-e2)] exceeded timeout 5 seconds</code> </pre> <br><p>  Obviamente, assumimos que em algum lugar nas configura√ß√µes isso √© corrigido.  Examinamos as configura√ß√µes, a documenta√ß√£o e o pacote deb, mas a princ√≠pio eles n√£o encontraram nada.  Como resultado, a descri√ß√£o da configura√ß√£o desejada foi encontrada na quinta p√°gina dos resultados da pesquisa - examinamos o c√≥digo novamente e encontramos o lugar certo.  A configura√ß√£o √© esta: </p><br><pre> <code class="bash hljs">ovs_vsctl_timeout = 30</code> </pre> <br><p>  <em>Definimos por 30 segundos (eram 5) e tudo come√ßou a funcionar um pouco melhor.</em> </p><br><p>  Aqui est√° outro argumento: quando voc√™ reinicia os componentes de rede, algumas configura√ß√µes do Open vSwitch podem ser redefinidas.  Isso, por exemplo, acontece com ovs-vsctl inactivity_probe.  Tamb√©m √© um tempo limite, mas afeta as chamadas do pr√≥prio ovs-vsctl para o banco de dados.  N√≥s o adicionamos ao systemd init, o que nos permitiu iniciar todos os switches com os par√¢metros necess√°rios na inicializa√ß√£o. </p><br><pre> <code class="bash hljs">ovs-vsctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> Controller <span class="hljs-string"><span class="hljs-string">"br-int"</span></span> inactivity_probe=30000</code> </pre> <br><h4 id="pro-nastroyki-setevogo-steka">  Sobre as configura√ß√µes da pilha de rede </h4><br><p>  Tamb√©m tivemos que nos afastar um pouco das configura√ß√µes geralmente aceitas na pilha de rede, que usamos em nossos outros servidores. </p><br><p>  Aqui est√° a configura√ß√£o de quanto tempo leva para armazenar registros ARP em uma tabela: </p><br><pre> <code class="bash hljs">net.ipv4.neigh.default.base_reachable_time = 60 net.ipv4.neigh.default.gc_stale_time=60</code> </pre> <br><p>  O valor padr√£o √© 1 dia.  Em geral, um esquema pode durar algumas semanas, mas por um dia, os esquemas podem ser recriados 4-6 vezes, enquanto a correspond√™ncia do endere√ßo MAC e do endere√ßo IP est√° mudando constantemente.  Para que o lixo n√£o se acumule, definimos o tempo para um minuto. </p><br><pre> <code class="bash hljs">net.ipv4.conf.default.arp_notify = 1 net.nf_conntrack_max = 1000000 (default 262144) net.netfilter.nf_conntrack_max = 1000000 (default 262144)</code> </pre> <br><p>  Al√©m disso, for√ßamos o envio de notifica√ß√µes ARP ao elevar a interface de rede.  Tamb√©m aumentamos a tabela conntrack, porque ao usar NAT e ip flutuante, n√£o t√≠nhamos o valor padr√£o.  Aumentado para um milh√£o (com o padr√£o em 262 144), tudo ficou ainda melhor. </p><br><p>  Corrigimos o tamanho da tabela MAC do pr√≥prio Open vSwitch: </p><br><pre> <code class="bash hljs">ovs-vsctl <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> bridge bt-int other-config:mac-table-size=50000 (default 2048)</code> </pre> <br><p><img src="https://habrastorage.org/webt/px/oi/px/pxoipxvpkzuou-twlr5uf0r28k8.png"><br>  <em>Depois de todas as configura√ß√µes, 40% da carga se transformou em quase zero</em> </p><br><h4 id="rx-flow-hash">  rx-fluxo-hash </h4><br><p>  Para distribuir o processamento do tr√°fego udp entre todas as filas e threads do processador, inclu√≠mos rx-flow-hash.  Nas placas de rede Intel, ou seja, no driver i40e, esta op√ß√£o est√° desativada por padr√£o.  Temos hipervisores com 72 n√∫cleos em nossa infraestrutura e, se apenas um estiver ocupado, isso n√£o ser√° o ideal. </p><br><p>  √â feito assim: </p><br><pre> <code class="bash hljs">ethtool -N eno50 rx-flow-hash udp4 sdfn</code> </pre> <br><p><img src="https://habrastorage.org/webt/zj/qp/16/zjqp16xvvxmawd1irfjbwaeia9q.png"></p><br><p>  <strong>Uma conclus√£o importante: voc√™ pode configurar tudo.</strong>  A configura√ß√£o padr√£o se ajustar√° em algum momento (como fizemos), mas o problema com tempos limite tornou necess√°rio a pesquisa.  E isso √© normal. </p><br><h3 id="pravila-bezopasnosti">  Regras de seguran√ßa </h3><br><p>  De acordo com os requisitos do servi√ßo de seguran√ßa, todos os projetos na empresa t√™m regras pessoais e globais - existem muitos deles.  Quando nos mudamos para o exterior de 300 m√°quinas virtuais para um hypervisor, tudo isso se transformou em 80 mil regras para iptables.  Para o pr√≥prio iptables, isso n√£o √© um problema, mas o Neutron carrega essas regras do RabbitMQ em um fluxo (porque est√° escrito em Python e tudo fica triste com o multithreading).  O agente de n√™utrons congela, perde a conex√£o com o RabbitMQ e uma rea√ß√£o em cadeia por tempos limite. Ap√≥s a recupera√ß√£o, o Neutron solicita novamente todas as regras, inicia a sincroniza√ß√£o e tudo come√ßa novamente. </p><br><p>  Junto com isso, o tempo para a cria√ß√£o de stands aumentou de 20 a 40 minutos para, no m√°ximo, uma hora. </p><br><p>  No in√≠cio, acabamos de empacotar tudo com recupera√ß√µes (j√° nesse est√°gio percebemos que o problema n√£o podia ser resolvido t√£o rapidamente) e, em seguida, come√ßamos a usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">FWaaS</a> .  Com isso, adotamos regras de seguran√ßa com n√≥s de computa√ß√£o para separar os n√≥s da rede onde o roteador est√° localizado. </p><br><p><img src="https://habrastorage.org/webt/ou/dg/r_/oudgr_riwann3smyytraqiommpe.png"><br>  <em>Fonte - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">docs.openstack.org</a></em> </p><br><p>  Assim, dentro do projeto, h√° acesso total a tudo o que √© necess√°rio e regras de seguran√ßa s√£o aplicadas para conex√µes externas.  Portanto, reduzimos a carga no Neutron e voltamos a 20 a 30 minutos para criar um ambiente de teste. </p><br><h2 id="itog">  Sum√°rio </h2><br><p>  O OpenStack √© uma coisa interessante em que voc√™ pode reciclar ferro, criar uma nuvem interna e criar algo mais com base nela.  Al√©m disso, h√° uma grande comunidade e um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grupo</a> ativo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">no Telegram</a> , onde eles nos informavam sobre o tempo limite. </p><br><p>  Isso √© tudo.  Fa√ßa perguntas, meus colegas e eu estamos prontos para responder e compartilhar nossa experi√™ncia. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt427569/">https://habr.com/ru/post/pt427569/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt427557/index.html">Resumo dos eventos de TI em novembro (primeira parte)</a></li>
<li><a href="../pt427561/index.html">Direito de reparo: os primeiros passos na dire√ß√£o certa da Motorola</a></li>
<li><a href="../pt427563/index.html">Padr√£o SNI criptografado implementado no Firefox Nightly</a></li>
<li><a href="../pt427565/index.html">‚ÄúMinha conquista foi que geralmente voltei √† profiss√£o‚Äù - 10 perguntas ao programador, edi√ß√£o 10</a></li>
<li><a href="../pt427567/index.html">Mapas hexagonais no Unity: ciclo da √°gua, eros√£o, biomas, mapa cil√≠ndrico</a></li>
<li><a href="../pt427571/index.html">A uni√£o do R e do PostgreSQL. Analisamos o trabalho dos aeroportos, calculamos pens√µes</a></li>
<li><a href="../pt427573/index.html">Candy or Life: Halloween como uma raz√£o para atrair seu filho para a ci√™ncia</a></li>
<li><a href="../pt427575/index.html">Por que o Wi-Fi n√£o funcionar√° conforme o planejado e por que saber qual telefone o funcion√°rio usa</a></li>
<li><a href="../pt427577/index.html">Aprendizado de m√°quina versus an√°lise de assinatura ao detectar ataques em um aplicativo Web</a></li>
<li><a href="../pt427579/index.html">Distribui√ß√£o de aplicativos para iOS dentro da empresa (Enterprise Distribute iOS App in house)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>