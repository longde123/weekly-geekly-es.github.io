<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ üîò üèµÔ∏è Modification du sch√©ma des tables PostgreSQL sans longs verrous. Conf√©rence Yandex üõå ü§´ ü§üüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Si en m√™me temps de nombreuses op√©rations sont effectu√©es pour modifier le sch√©ma de la base de donn√©es, le service ne peut pas fonctionner correcteme...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Modification du sch√©ma des tables PostgreSQL sans longs verrous. Conf√©rence Yandex</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/435880/">  Si en m√™me temps de nombreuses op√©rations sont effectu√©es pour modifier le sch√©ma de la base de donn√©es, le service ne peut pas fonctionner correctement lors de l'enregistrement.  Le d√©veloppeur Vladimir Kolyasinsky a expliqu√© quelles op√©rations dans PostgreSQL n√©cessitent des verrous √† long terme et comment l'√©quipe Yandex.Connect fournit un acc√®s en √©criture √† presque 100% au service pendant de telles op√©rations.  De plus, vous d√©couvrirez la biblioth√®que de Django, con√ßue pour automatiser une partie des processus d√©crits. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/P3ctIoICkOc" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><blockquote>  Nous avons des charges lourdes, des milliers de RPS et des temps d'arr√™t en quelques minutes, sans parler de plus de temps, sont inacceptables.  Il est n√©cessaire que les migrations se passent inaper√ßues par l'utilisateur.  Et avec de telles charges, il ne sera pas possible de se lever √† quatre heures du matin, de rouler quelque chose quand il n'y a pas de charge et de se recoucher - parce que la charge circule 24 heures sur 24. </blockquote><br><a name="habracut"></a>  - Bonsoir √† tous!  Je m'appelle Vladimir, je travaille chez Yandex depuis cinq ans.  Au cours des deux derni√®res ann√©es, j'ai d√©velopp√© des services internes et des services pour les organisations. <br><br>  Un peu sur ce que ces services sont pour les organisations.  Depuis un certain temps, nous utilisons un grand nombre de services internes: un wiki pour stocker et √©changer des donn√©es, un messager pour une communication rapide avec des coll√®gues, un tracker pour organiser le processus de travail, des formulaires pour mener des enqu√™tes √† l'int√©rieur et √† l'ext√©rieur, et de nombreux autres services. <br><br>  Il y a quelque temps, nous avons d√©cid√© que nos services sont sympas et qu'ils peuvent √™tre utiles non seulement √† l'int√©rieur de Yandex, mais aussi √† des personnes √† l'ext√©rieur.  Nous avons commenc√© √† les int√©grer √† une plate-forme unifi√©e Yandex.Connect, en y ajoutant des services externes existants, tels que Mail pour un domaine. <br><br><img src="https://habrastorage.org/webt/k-/sd/cz/k-sdczg1lnedmrhjfyujg6dkiyu.jpeg"><br><br>  Je d√©veloppe actuellement le Form Designer et le Wiki.  La pile utilis√©e est principalement des services √©crits en Python des deuxi√®me et troisi√®me versions;  Django 1.9-1.11.  En tant que base de donn√©es, la plupart est PostgreSQL.  C'est aussi du c√©leri avec MongoDB et SQS comme courtiers.  Tout cela fonctionne dans Docker. <br><br>  Passons au probl√®me auquel nous sommes confront√©s.  Les services sont populaires, ils sont utilis√©s par des centaines de milliers de personnes chaque jour, les donn√©es s'accumulent, les tables sont de plus en plus nombreuses et, au fil du temps, de nombreuses op√©rations de modification des sch√©mas de base de donn√©es, qui ont √©t√© effectu√©es inaper√ßues par les utilisateurs hier, commencent √† entraver le fonctionnement normal des services. <br><br>  Aujourd'hui, nous allons parler de la fa√ßon dont nous g√©rons ces situations et de la mani√®re dont nous atteignons une haute disponibilit√© des services de lecture et d'√©criture. <br><br>  Tout d'abord, consid√©rons quelles op√©rations avec PostgreSQL n√©cessitent de longs verrous sur la table.  Par verrouillage, j'entends tout type de verrou qui interf√®re avec le fonctionnement normal de la table - que ce soit l'acc√®s exclusif, qui interf√®re avec l'√©criture et la lecture, ou des niveaux de verrouillage plus faibles qui emp√™chent uniquement l'√©criture. <br><br>  Ensuite, nous verrons comment √©viter les verrous lors de telles op√©rations.  Ensuite, nous parlerons des op√©rations avec PostgreSQL qui sont initialement rapides et ne n√©cessitent pas de longs verrous.  Et √† la fin, parlons de notre biblioth√®que zero_downtime_migrations, que nous utilisons pour automatiser certaines des techniques d√©crites pr√©c√©demment pour √©viter de longs verrous. <br><br>  Op√©rations n√©cessitant un verrouillage long: <br><br><img src="https://habrastorage.org/webt/zp/wv/xa/zpwvxagaus_ajxsaqixpwe-w7sw.jpeg"><br><br>  Cr√©ation d'un index.  Par d√©faut, il ne bloque pas les op√©rations de lecture dans la table, mais toutes les op√©rations d'√©criture seront bloqu√©es pendant toute la dur√©e de cr√©ation de l'index; en cons√©quence, le service sera en lecture seule. <br><br>  De plus, de telles op√©rations incluent l'ajout d'une nouvelle colonne avec une valeur par d√©faut, car sous le capot, PostgreSQL va √©craser la table enti√®re, et pour cette fois, elle sera bloqu√©e √† la fois en lecture et en √©criture.  De plus, tous ses indices seront √©cras√©s. <br><br>  √Ä propos du changement de type de colonne - une chose similaire se produira, la plaque sera √©galement √©cras√©e √† nouveau.  Il convient de noter que cela prend non seulement beaucoup de temps sur les grandes tables, mais aussi pour une courte p√©riode n√©cessite jusqu'√† doubler la quantit√© de m√©moire libre occup√©e par la table. <br><br>  En outre, l'op√©ration VACUUM FULL n√©cessite le m√™me niveau de verrouillage que les op√©rations pr√©c√©dentes - c'est un acc√®s exclusif.  VACUUM FULL bloquera √©galement toutes les op√©rations de lecture et d'√©criture dans la table. <br><br>  Les deux derni√®res op√©rations ajoutent des propri√©t√©s uniques √† la colonne et, en g√©n√©ral, ajoutent CONSTRAINT.  Ils n√©cessitent √©galement un verrouillage pour la dur√©e de la v√©rification des donn√©es, bien qu'ils prennent beaucoup moins de temps que ceux consid√©r√©s pr√©c√©demment, car ils n'√©crasent pas les tables sous le capot. <br><br><img src="https://habrastorage.org/webt/hl/7j/ui/hl7juizqgpqqzpnhr_byptzs_xw.jpeg"><br><br><img src="https://habrastorage.org/webt/ji/w4/lt/jiw4lt2-5fcmeyd9qfururhscs4.jpeg"><br><br>  Cr√©ation d'un index.  C'est assez simple ici, il peut √™tre cr√©√© en utilisant le mot cl√© CONCURRENTLY.  Quelle est la diff√©rence?  Cette op√©ration prendra plus de temps, car pas un, mais plusieurs passages dans la table seront effectu√©s, et elle attendra √©galement la fin de toutes les op√©rations en cours qui peuvent potentiellement modifier l'index.  Et il peut √©galement √©chouer - par exemple, si un index unique est viol√© lors de la cr√©ation d'un index unique.  Ensuite, l'index sera marqu√© comme non valide, et il devra √™tre supprim√© et recr√©√©.  La commande REINDEX n'est pas recommand√©e, car elle fonctionne de la m√™me mani√®re que la CREATE INDEX normale, c'est-√†-dire qu'elle verrouille la table pour l'√©criture. <br><br>  En ce qui concerne la suppression de l'index - √† partir de la version 9.3, vous pouvez √©galement supprimer l'index de mani√®re CONCURRENTE pour √©viter le blocage lors de sa suppression, bien qu'en g√©n√©ral, cette op√©ration soit si rapide. <br><br><img src="https://habrastorage.org/webt/vy/yi/w8/vyyiw8m8oz-dn5gmy7-v9q8m32i.jpeg"><br><br>  Examinons l'ajout d'une nouvelle colonne avec une valeur par d√©faut.  Voici une op√©ration standard qui est effectu√©e lorsque nous voulons ex√©cuter une telle commande, y compris Django effectue une telle op√©ration. <br><br>  Comment puis-je le r√©√©crire pour √©viter d'√©craser la table?  Tout d'abord, dans une transaction, ajoutez une nouvelle colonne sans valeur par d√©faut et ajoutez une valeur par d√©faut dans une demande distincte.  Quelle est la diff√©rence ici?  Lorsque nous ajoutons une valeur par d√©faut √† une colonne existante, cela ne change pas les donn√©es existantes dans le tableau.  Seules les m√©tadonn√©es changent.  Autrement dit, pour toutes les nouvelles lignes, cette valeur par d√©faut sera d√©j√† garantie.  Il nous reste √† mettre √† jour toutes les lignes existantes qui √©taient dans la table au moment o√π cette commande a √©t√© ex√©cut√©e.  Ce que nous ferons par lots de plusieurs milliers de copies afin de ne pas bloquer pendant longtemps une grande quantit√© de donn√©es. <br><br>  Apr√®s avoir mis √† jour toutes les donn√©es, il ne reste plus qu'√† ex√©cuter SET NOT NULL si nous cr√©ons une colonne NOT NULL.  Si nous ne cr√©ons pas, alors ne le faisons pas.  De cette fa√ßon, vous pouvez √©viter d'√©craser la table lors de ce type de modification. <br><br>  Une telle s√©quence de commandes prend plus de temps que l'ex√©cution d'une commande r√©guli√®re, car elle d√©pend de la taille de la table et du nombre d'index qu'elle contient, et la commande habituelle bloque simplement toutes les op√©rations et √©crase la table quelle que soit la charge, car il n'y a pas de charge pour le moment.  Mais cela n'a pas tellement d'importance, car pendant l'op√©ration, la table est disponible pour la lecture et l'√©criture.  Cela prend beaucoup de temps, il vous suffit de suivre cela et c'est tout. <br><br><img src="https://habrastorage.org/webt/e-/yp/gj/e-ypgjv5j7u5skjfmixtw_ie9oq.jpeg"><br><br>  √Ä propos de la modification du type de colonne.  L'approche est similaire √† l'ajout d'une colonne avec une valeur par d√©faut.  Nous ajoutons d'abord une colonne distincte du type dont nous avons besoin, puis ajoutons des d√©clencheurs pour modifier les donn√©es de la colonne d'origine pour √©crire dans les deux colonnes √† la fois, dans une nouvelle avec le type de donn√©es dont nous avons besoin.  Pour toutes les nouvelles entr√©es, elles iront imm√©diatement dans ces deux colonnes.  Nous devons mettre √† jour tous ceux existants.  Ce que nous faisons par portions, comme sur la diapositive pr√©c√©dente, √©tait similaire. <br><br>  Apr√®s cela, il reste dans une transaction pour supprimer le d√©clencheur, supprimer l'ancienne colonne et renommer l'ancienne colonne en une nouvelle.  Ainsi, nous avons obtenu le m√™me r√©sultat: nous avons chang√© le type de la colonne, tout en verrouillant la table n'√©tait pas long. <br><br><img src="https://habrastorage.org/webt/3n/n3/ge/3nn3geu-vzcexvckvzsoomxx1ns.jpeg"><br><br>  √Ä propos de l'ajout d'une colonne unique.  Un verrou est pris au moment de la cr√©ation.  Cela peut √™tre √©vit√© si vous savez que l'unicit√© dans PostgreSQL est garantie en cr√©ant un index unique.  Nous pouvons nous-m√™mes construire l'index unique requis √† l'aide de CONCURRENTLY.  Et apr√®s avoir construit cet index, cr√©ez CONSTRAINT √† l'aide de cet index.  Apr√®s cela, la d√©finition de l'index initial de la table dispara√Ætra et le r√©sultat que la d√©finition de la table nous montrera ne sera pas diff√©rent apr√®s avoir effectu√© ces deux op√©rations. <br><br><img src="https://habrastorage.org/webt/o4/uz/lt/o4uzltwdxqnag3c0uwvvo9hw7uw.jpeg"><br><br>  Et en g√©n√©ral, lors de l'ajout de CONTRAINTE.  Vous pouvez utiliser cette technique pour √©viter le blocage lors de la v√©rification des donn√©es.  Nous ajoutons d'abord CONSTRAINT avec le mot cl√© NOT VALID.  Cela signifie que cette CONTRAINTE n'est pas garantie d'√™tre ex√©cut√©e pour toutes les lignes de la table.  Mais en m√™me temps, pour toutes les nouvelles lignes, cette CONTRAINTE sera d√©j√† appliqu√©e et les exceptions correspondantes seront lev√©es si elle n'est pas ex√©cut√©e. <br><br>  Nous ne pouvons valider que toutes les valeurs existantes, ce qui peut √™tre fait avec une commande VALIDATE CONSTRAINT distincte, et en m√™me temps, cette commande n'interf√®re plus avec la lecture ou l'√©criture dans la table.  Un tableau pour cette fois sera disponible. <br><br>  Op√©rations qui fonctionnent initialement rapidement dans PostgreSQL et ne n√©cessitent pas de longs verrous: <br><br><img src="https://habrastorage.org/webt/l1/z1/tq/l1z1tq5nwf1l9jhoushtujix-t8.jpeg"><br><br>  L'une de ces op√©rations consiste √† ajouter une colonne sans valeurs par d√©faut et sans restrictions.  √âtant donn√© qu'aucune modification n'est apport√©e √† la table elle-m√™me, seules ses m√©tadonn√©es changent.  Et toutes les valeurs NULL que nous voyons √† la suite de SELECT sont m√©lang√©es simplement dans la sortie. <br><br>  De plus, l'ajout de valeurs par d√©faut √† une √©tiquette existante est une op√©ration rapide car seules les m√©tadonn√©es changent.  La table et le verrou sont pris litt√©ralement pendant les quelques millisecondes n√©cessaires pour entrer ces informations. <br><br>  De plus, l'op√©ration rapide de d√©finition de SET NOT NULL, ici, prend un peu plus de temps que d√©crit pr√©c√©demment, environ quelques secondes par table de 30 millions d'enregistrements.  Ce temps peut √©galement √™tre √©vit√© si cela est important. <br><br>  Renommer une colonne, modifier la longueur d'une colonne ne conduit pas non plus √† √©craser une colonne.  La suppression d'une colonne et, en g√©n√©ral, de nombreuses entit√©s dans PostgreSQL est √©galement une op√©ration rapide. <br><br><img src="https://habrastorage.org/webt/fq/rq/0z/fqrq0zlgqqbszyo7aajzsmzrtjy.jpeg"><br><br>  Concernant l'ajout d'une colonne NOT NULL.  Afin d'√©viter le blocage lors de la validation, vous pouvez effectuer la m√©thode mentionn√©e pr√©c√©demment - ajoutez CONSTRAINT correspondant √† CHECK (colonne IS NOT NULL) NOT VALID, et validez-le avec une commande distincte. <br><br>  La diff√©rence en g√©n√©ral est que cette restriction existera au niveau de la table et non au niveau de la colonne dans la d√©finition de la table.  Une autre diff√©rence est qu'elle peut affecter les performances, environ 1%.  Dans ce cas, il n'y aura pas de blocage, si le service est tr√®s charg√©, m√™me quelques secondes de blocage peuvent conduire √† une √©norme file d'attente de transactions s'accumulant et il y aura un probl√®me sur le service. <br><br><img src="https://habrastorage.org/webt/qj/oy/sb/qjoysbcnasbr3xz0komagdri2oe.jpeg"><br><br>  La suppression de donn√©es dans PostgreSQL est g√©n√©ralement une op√©ration rapide, car les donn√©es ne sont pas supprim√©es imm√©diatement, seule la colonne est marqu√©e comme obsol√®te dans les attributs de la table, et les donn√©es ne seront r√©ellement supprim√©es qu'apr√®s le d√©but du prochain vide. <br><br><img src="https://habrastorage.org/webt/v3/75/n5/v375n5xmrwzhinew6obppnsdgeq.jpeg"><br><br>  Parlons de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">biblioth√®que</a> .  Je parle de Django, de la migration.  En g√©n√©ral, Django est une biblioth√®que pour Python, un framework web, √† l'origine, il a √©t√© cr√©√© pour cr√©er rapidement des sites Web comme des nouvelles, depuis lors, il a √©t√© consid√©rablement mis √† niveau.  Il existe un syst√®me ORM qui vous permet de communiquer avec les enregistrements de la base de donn√©es, avec les tables, comme s'il s'agissait d'objets ou de classes Python.  Autrement dit, chaque table a sa propre classe en Python.  Et lorsque nous apportons des modifications √† notre code Python, c'est-√†-dire que nous ajoutons de nouveaux attributs tels que des colonnes √† la table, Django pendant le processus de cr√©ation de la migration remarque ces modifications, et cr√©e les fichiers de migration pour apporter des modifications en miroir √† la base de donn√©es elle-m√™me afin qu'elles ne divergent pas. <br><br>  La biblioth√®que a √©t√© √©crite pour automatiser certaines des techniques discut√©es pr√©c√©demment pour √©viter de longs verrous sur la table lors de telles migrations.  Il fonctionne avec Django depuis la version 1.8 √† 2.1 inclus, et Python de 2.7 √† 3.7 inclus. <br><br>  En ce qui concerne les fonctionnalit√©s actuelles de la biblioth√®que, cela ajoute une colonne avec une valeur par d√©faut sans verrous, nullable ou non, cela cr√©e un index CONCURRENTLY, ainsi que la possibilit√© de red√©marrer en cas de plantage.  Dans l'impl√©mentation Django standard, si nous ajoutons une colonne avec une valeur par d√©faut, la table est verrouill√©e, et si elle est grande, cela pourrait prendre 40 minutes de verrouillage selon mon exp√©rience.  La table est verrouill√©e, et c'est tout, attendez que les modifications soient copi√©es et effectu√©es.  30 minutes se sont √©coul√©es - ils ont d√©tect√© l'erreur de connexion √† la base de donn√©es, la migration tombe, les modifications ne sont pas valid√©es et vous devez recommencer, attendre √† nouveau 40 minutes, bloquant √† nouveau la table pendant ce temps. <br><br><img src="https://habrastorage.org/webt/vg/xy/lz/vgxylzlxerxosettf26nbtrqo9u.jpeg"><br><h5>  <sup><sub><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Lien GitHub</a></sub></sup> </h5><br>  La biblioth√®que vous permet de reprendre la migration depuis l'endroit o√π elle a √©t√© interrompue.  Lorsque vous vous plantez et red√©marrez, une bo√Æte de dialogue s'affiche avec diff√©rentes options d'action, c'est-√†-dire que vous pouvez dire de continuer la mise √† jour des donn√©es.  Il s'agit g√©n√©ralement d'une mise √† jour des donn√©es car il s'agit du processus le plus long.  La migration se poursuivra simplement l√† o√π elle s'√©tait arr√™t√©e.  Une telle op√©ration prend √©galement plus de temps qu'une op√©ration standard avec verrouillage de table, mais en m√™me temps, le service reste op√©rationnel √† ce moment. <br><br><img src="https://habrastorage.org/webt/kp/d2/bp/kpd2bpbqlehlnxps9ozwj3iuv4g.jpeg"><br><br>  √Ä propos de la connexion dans son ensemble.  Il y a de la documentation;  en bref, vous devez remplacer le moteur dans les param√®tres de la base de donn√©es Django par le moteur de la biblioth√®que.  Il existe √©galement divers mixins si vous utilisez vos moteurs pour vous connecter. <br><br><img src="https://habrastorage.org/webt/x1/fc/gh/x1fcghzaqinnjq-hela3v1aarie.jpeg"><br><br>  Un exemple de travail consiste √† ajouter une colonne avec une valeur par d√©faut.  Ici, nous ajoutons des colonnes avec une valeur bool√©enne, True par d√©faut.  Quelles op√©rations sont effectu√©es par le SchemaEditor standard?  Les op√©rations que vous pouvez voir si vous ex√©cutez la migration SQL.  Ceci est assez utile, par le type m√™me de migration, on ne sait pas toujours ce que Django peut r√©ellement y changer.  Et il est utile de commencer et de voir si les op√©rations que nous attendons sont termin√©es et si quelque chose de superflu et inutile est arriv√©. <br><br>  Quelles commandes SchemaEditor ex√©cute-t-il?  Tout d'abord, une nouvelle colonne est ajout√©e √† une transaction, la valeur par d√©faut est ajout√©e.  Ensuite, jusqu'√† ce qu'une telle mise √† jour renvoie qu'elle a mis √† jour z√©ro, les donn√©es seront mises √† jour. <br><br>  Ensuite, SET NOT NULL est d√©fini dans la colonne et la valeur par d√©faut sera supprim√©e, r√©p√©tant le comportement de Django, qui stocke la valeur par d√©faut non pas dans la base de donn√©es, mais au niveau logique dans le code. <br><br>  Ici, en g√©n√©ral, il y a aussi de la place pour grandir.  Par exemple, vous pouvez cr√©er un index auxiliaire pour trouver rapidement ces lignes avec une valeur NULL √† l'approche de la mise √† jour de la table enti√®re. <br><br><img src="https://habrastorage.org/webt/je/a8/h3/jea8h37vcuylfp-eut209sdpsse.jpeg"><br><br>  Vous pouvez √©galement fixer l'ID maximum pour l'heure de mise √† jour lorsque nous avons commenc√© la migration, de sorte que par id, vous puissiez trouver rapidement des valeurs que nous n'avons pas encore mises √† jour. <br><br>  En g√©n√©ral, la biblioth√®que se d√©veloppe, nous acceptons les demandes de pool.  Peu importe - rejoignez-nous. <br><br>  Il convient de noter qu'avec la croissance des bases de donn√©es, les migrations ont une propri√©t√© in√©vitable √† ralentir.  Vous devez garder une trace des verrous pris par la table, ex√©cuter des migrations SQL pour voir quelles op√©rations sont appliqu√©es.  Pour notre part, dans Yandex.Connect, nous utilisons cette biblioth√®que l√† o√π ses capacit√©s le permettent.  Et l√† o√π ils ne le permettent pas, nous-m√™mes, de nos propres mains, fausses migrations Django, ex√©cutons nos requ√™tes SQL. <br><br>  Ainsi, nous atteignons une haute disponibilit√© des services de lecture et d'√©criture.  Nous avons des charges lourdes, des milliers de RPS et des temps d'arr√™t en quelques minutes, sans parler de plus de temps, sont inacceptables.  Il est n√©cessaire que les migrations se passent inaper√ßues par l'utilisateur.  Et avec de telles charges, il ne sera pas possible de se lever √† quatre heures du matin, de rouler quelque chose quand il n'y a pas de charge, et de se recoucher - car la charge circule 24h / 24. <br><br>  Il convient de noter que m√™me des op√©rations rapides dans PostgreSQL peuvent toujours provoquer un ralentissement du service et des erreurs en raison du fonctionnement de la file d'attente de verrouillage dans PostgreSQL. <br><br>  Imaginez qu'une op√©ration soit lanc√©e qui, m√™me pendant quelques millisecondes, n√©cessite un acc√®s exclusif.  Un exemple d'une telle op√©ration est l'ajout d'une colonne sans valeur par d√©faut.  Imaginez qu'au moment de son lancement dans une autre transaction, il y ait une autre op√©ration longue - disons SELECT avec agr√©gation.  Dans ce cas, notre op√©ration fera la queue pour elle.  Cela se produira car l'acc√®s exclusif entre en conflit avec tous les autres types de verrous. <br><br>  Pendant que notre op√©ration d'ajout d'une colonne attend un verrou, toutes les autres le feront dans la file d'attente et ne seront pas ex√©cut√©es tant qu'elle ne sera pas termin√©e.  Dans le m√™me temps, l'op√©ration en cours - SELECT avec agr√©gation - peut ne pas entrer en conflit avec les autres, et sans notre cr√©ation de la colonne, elles ne se seraient pas retrouv√©es dans la file d'attente, mais auraient √©t√© ex√©cut√©es en parall√®le. <br><br>  Cette situation peut cr√©er de gros probl√®mes sur le service.  Par cons√©quent, avant de d√©marrer ALTER TABLE ou toute autre op√©ration n√©cessitant un verrouillage exclusif d'acc√®s, vous devez v√©rifier que les longues requ√™tes ne sont pas envoy√©es √† la base de donn√©es pour le moment.  Ou vous pouvez simplement ins√©rer un tr√®s petit d√©lai d'expiration du journal.  Ensuite, s'il n'√©tait pas possible de prendre rapidement la serrure, l'op√©ration tomberait.  Nous pourrions simplement le red√©marrer et ne pas verrouiller la table pendant longtemps, tandis que l'op√©ration attendra l'octroi d'une autorisation pour les verrous.  C'est tout, merci. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr435880/">https://habr.com/ru/post/fr435880/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr435868/index.html">Slush 2018. Preview Day</a></li>
<li><a href="../fr435870/index.html">Orchestre cybern√©tique. Docker Container Orchestration avec des applications .NET Core dans le cloud</a></li>
<li><a href="../fr435872/index.html">Langage de programmation Zig</a></li>
<li><a href="../fr435876/index.html">Param√®tres d√©taill√©s du navigateur Firefox</a></li>
<li><a href="../fr435878/index.html">Amateur en open source - le√ßons apprises en 3 ans</a></li>
<li><a href="../fr435882/index.html">Test du Xiaomi Mi Box S et petite comparaison avec la Mi Box 3</a></li>
<li><a href="../fr435884/index.html">Recherche de m√©taux et ... r√©seau neuronal</a></li>
<li><a href="../fr435886/index.html">SpaceX a pr√©sent√© un prototype de vaisseau spatial et r√©duira 10% du personnel</a></li>
<li><a href="../fr435890/index.html">Les c√¥t√©s sombres d'une personne active</a></li>
<li><a href="../fr435892/index.html">Le condens√© de mat√©riaux int√©ressants pour le d√©veloppeur mobile # 281 (du 7 au 13 janvier)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>