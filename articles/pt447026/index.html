<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèø‚Äçüîß üê≥ ü§∂üèø Escrevemos o carregador OTA para ATmega128RFA1 (como parte do dispositivo Smart Response XE) üíÑ üõê üï°</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tudo come√ßou com a aquisi√ß√£o pelo autor no mercado secund√°rio de um dispositivo interessante - Smart Response XE ( breve descri√ß√£o ). Destina-se √†s es...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escrevemos o carregador OTA para ATmega128RFA1 (como parte do dispositivo Smart Response XE)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447026/"><img src="https://habrastorage.org/webt/ie/eb/sz/ieebszdo1m1pcoy6jx1gvxww3ao.jpeg"><br><br>  Tudo come√ßou com a aquisi√ß√£o pelo autor no mercado secund√°rio de um dispositivo interessante - Smart Response XE ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">breve descri√ß√£o</a> ).  Destina-se √†s escolas: cada aluno da classe recebe um dispositivo semelhante a um caderno ou tradutor eletr√¥nico dos anos 90, o professor faz uma pergunta e os alunos digitam nos teclados dos dispositivos as respostas recebidas pelo canal de r√°dio (802.15.4) ao receptor conectado ao PC do professor. <br><br>  O suporte para esses dispositivos foi descontinuado h√° v√°rios anos e o fato de as escolas comprarem entre US $ 100 e 200 a cada uma agora aparece no eBay por 10 ou menos.  Ferro l√° √© muito adequado para experimentos geek: <br><br><ul><li>  Teclado de 60 teclas </li><li>  tela com uma resolu√ß√£o de 384x136, 2 bits por pixel - semelhante a BK, CGA, mas 4 n√£o s√£o cores, mas grada√ß√µes de brilho </li><li>  Microcontrolador ATmega128RFA1 (mem√≥ria flash de 128 kB, ROM de 4 kB, RAM de 16 kB, transceptor padr√£o 802.15.4) </li><li>  mem√≥ria flash externa (em rela√ß√£o ao microcontrolador e n√£o ao dispositivo inteiro) por 1 megabit (128 kilobytes) com SPI </li><li>  compartimento para 4 elementos AAA. </li></ul><br>  Pelo nome do microcontrolador, fica claro que pertence √† fam√≠lia AVR, o que significa que fabricar um dispositivo compat√≠vel com Arduino √© uma tarefa mais que trivial ... <a name="habracut"></a><br><br>  A partir das not√≠cias sobre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Hackaday, o</a> autor descobriu que eles <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">j√° fizeram isso</a> (o mesmo link diz com o que conectar), tendo a oportunidade de executar jogos para Arduboy: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/6VqPGFtIT8Q" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Mas o autor est√° mais interessado na oportunidade de n√£o jogar no dispositivo, mas estudar: <br><br><ul><li>  SPI de flash serial </li><li>  downloaders para AVR </li><li>  padr√£o 802.15.4 </li></ul><br>  O autor come√ßou escrevendo uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca</a> (GPL v3) que permite inicializar a exibi√ß√£o, exibir texto e ret√¢ngulos e tamb√©m acessar a mem√≥ria flash com a interface SPI.  Ent√£o, ele come√ßou a ter id√©ias para o uso pr√°tico do dispositivo: um terminal de bolso compat√≠vel com VT-100, jogos para v√°rios jogadores.  Depois de refazer os tr√™s dispositivos, ele decidiu ‚Äúensin√°-los‚Äù a obter esbo√ßos ‚Äúpelo ar‚Äù.  O que seria n√£o apenas interessante, mas tamb√©m muito conveniente: √© dif√≠cil abrir a caixa do dispositivo a cada vez e, sob a tampa da bateria, existem apenas orif√≠cios que permitem conectar um programador JTAG √† placa. <br><br><img src="https://habrastorage.org/webt/ds/tb/zn/dstbzns76vsm4pfjogzjsyo9mla.jpeg"><br><br>  Isso √© suficiente para preencher o gerenciador de inicializa√ß√£o do Arduino, mas n√£o √© um esbo√ßo - a porta serial n√£o √© exibida l√°, voc√™ ainda n√£o pode abrir a caixa.  Al√©m disso, as linhas TX0 e RX0 da primeira porta serial est√£o alinhadas com as linhas de polling da matriz do teclado, ou seja, aquelas ao longo das quais as teclas de fun√ß√£o s√£o pesquisadas nas laterais da tela.  Mas o que fazer - o autor construiu isso: <br><br><img src="https://habrastorage.org/webt/8f/xa/-q/8fxa-qo6dgerkd3ghgh4g-tbjak.jpeg"><br><br>  L√° ele trouxe as linhas JTAG, e agora n√£o √© necess√°rio abrir o compartimento da bateria.  E, para poder preencher os esbo√ßos, trouxe as duas portas seriais para o mesmo conector, adicionando tamb√©m um comutador, porque quando as baterias s√£o instaladas, o dispositivo n√£o pode ser fisicamente desligado de uma maneira diferente. <br><br>  Demorou um pouco para trabalhar com um ferro de solda, uma faca de escrit√≥rio e uma pistola de cola.  Em geral, esbo√ßos de derramamento ‚Äúover the air‚Äù s√£o muito mais convenientes, √© urgente inventar algo para isso. <br><br>  O Arduino IDE usa o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">avrdude</a> para preencher esbo√ßos.  Ele interage com o microcontrolador atrav√©s do protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">STK500</a> , que permite transferir arquivos nas duas dire√ß√µes.  √â pouco compat√≠vel com canais onde s√£o poss√≠veis atrasos vari√°veis, distor√ß√£o e perda de dados.  Se algo sair ou farfalhar no canal serial, voc√™ pode enlouquecer em busca de uma causa.  Uma vez o autor atormentou por meio dia at√© perceber que o problema estava no cabo defeituoso, bem como no conversor caprichoso da interface do CP2102.  Mesmo um microcontrolador com um conversor de interface embutido, por exemplo, ATmega32u4, √†s vezes pode ser t√£o desobediente.  Cada usu√°rio do Arduino notou que erros ao fazer upload de esbo√ßos n√£o s√£o t√£o raros.  √Äs vezes, a grava√ß√£o √© boa e um erro √© detectado durante a leitura da verifica√ß√£o.  Isso n√£o significa que houve um erro durante a grava√ß√£o - a falha ocorreu durante a leitura.  Agora imagine que, ao trabalhar "no ar", a mesma coisa acontecer√°, mas com muito mais frequ√™ncia. <br><br>  Tendo tentado diferentes maneiras de superar esse problema, o autor apresentou o seguinte.  O dispositivo possui uma mem√≥ria flash de 128 kilobytes com interface SPI - recebemos dados por meio de cabos (lembre-se de que o autor j√° possui um dispositivo com um conector ao lado), usamos essa mem√≥ria como um buffer e enviamos dados para outro dispositivo por um canal de r√°dio.  Um ol√° de Cybiko. <br><br>  Depois de escrever o c√≥digo para trabalhar com o canal de r√°dio e a fonte, o carregador de inicializa√ß√£o passou a ter mais de 4 kilobytes.  Portanto, o valor HFUSE teve que ser alterado de 0xDA para 0xD8.  Agora, o carregador de inicializa√ß√£o pode ter at√© 8 kilobytes e o endere√ßo inicial tornou-se 0x1E000.  Isso √© refletido no Makefile, mas deve ser levado em considera√ß√£o ao preencher o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gerenciador de inicializa√ß√£o</a> com avrdude. <br><br>  O transceptor padr√£o 802.15.4 no ATmega128RFA1 foi originalmente projetado para operar no protocolo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ZigBee</a> , que √© bastante complicado, ent√£o o autor decidiu, em vez disso, simplesmente transmitir pacotes.  Como o hardware √© implementado no ATmega128RFA1, √© necess√°rio um pouco de c√≥digo.  Al√©m disso, por simplicidade, o autor decidiu usar um canal fixo, impedindo-o de escolh√™-lo mesmo manualmente.  O padr√£o 802.15.4 suporta 16 canais com n√∫meros de 11 a 26. Eles est√£o bastante obstru√≠dos, alguns tamb√©m se sobrep√µem aos canais Wi-Fi (vermelho indica canais ZigBee, azul, verde e amarelo - Wi-Fi). <br><br><img src="https://habrastorage.org/webt/nn/vx/fn/nnvxfnxaptwvpgbllq60zkfh2bq.png"><br><br>  Verificou-se que os canais 15 e 26 s√£o os menos suscet√≠veis √† interfer√™ncia do WiFi. O autor escolheu o segundo deles.  Isen√ß√£o de responsabilidade: o tradutor n√£o sabe se o ZigBee √© t√£o simplificado.  Talvez valha a pena um pouco mais de programa√ß√£o e sua implementa√ß√£o completa? <br><br>  No primeiro dos dispositivos, √© necess√°rio implementar uma m√°quina de estado que transmita dados usando o protocolo STK500.  Na maioria das vezes, as mensagens enviadas e recebidas s√£o auto-suficientes, mas algumas est√£o vinculadas √†quelas que passaram pelo canal anteriormente.  Uma descri√ß√£o do di√°logo √© dada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br><br>  Um componente importante desse di√°logo √© a transfer√™ncia de pacotes destinados √† grava√ß√£o na mem√≥ria flash do dispositivo de destino.  Os microcontroladores simples da fam√≠lia AVR t√™m um tamanho de p√°gina de 128 bytes, mas o ATmega128RFA1 tem um tamanho de 256. E a mem√≥ria flash conectada atrav√©s do protocolo SPI tem o mesmo tamanho.  O programa no primeiro dispositivo ao derramar o esbo√ßo n√£o o transfere imediatamente para o segundo, mas o grava nessa mem√≥ria.  Quando o IDE do Arduino verifica a exatid√£o da grava√ß√£o, eles enviam o que foi escrito l√°.  Agora voc√™ precisa transferir os dados recebidos pelo ar para o segundo dispositivo.  Ao mesmo tempo, a mudan√ßa da recep√ß√£o para a transmiss√£o e vice-versa ocorre com bastante frequ√™ncia.  O protocolo STK500 √© indiferente a atrasos, mas n√£o tolera a perda de dados (estranho, mas √© dito acima que atrasos na transmiss√£o de dados tamb√©m afetam).  E as perdas de transmiss√£o sem fio s√£o inevit√°veis.  ATmega128RFA1 possui uma implementa√ß√£o de hardware embutida de solicita√ß√µes repetidas com d√∫vidas sobre a transmiss√£o correta, mas o autor decidiu implementar o mesmo programaticamente por conta pr√≥pria.  Ele desenvolveu um protocolo no qual muito mais dados passam em uma dire√ß√£o do que na outra. <br><br>  √â imperfeito, mas tudo funciona.  Uma p√°gina de 256 bytes √© dividida em quatro segmentos, cada um transmitido pelo ar como um pacote.  Um pacote comporta at√© 125 bytes de dados, mais um byte - length e dois - CRC.  Portanto, fragmentos de 64 bytes de comprimento, juntamente com os n√∫meros de p√°gina e segmento (de 0 a 3), s√£o colocados l√°.  No dispositivo de recebimento, √© fornecida uma vari√°vel que permite rastrear quantos segmentos s√£o recebidos e, quando todos os quatro s√£o recebidos, a confirma√ß√£o √© enviada ao dispositivo de envio de que toda a p√°gina foi recebida.  Sem confirma√ß√£o (o CRC n√£o correspondeu) - envie a p√°gina inteira novamente.  A velocidade ao mesmo tempo √© ainda maior do que na transmiss√£o via cabo.  Veja: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/d-ObUCnRmQU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Mas, na verdade, seria necess√°rio fornecer uma maneira conveniente de conectar o cabo aos dispositivos para carregar esbo√ßos e nele.  Por exemplo, coloque um conversor de interface no CP2102, como na foto, e cole-o na placa para que ele possa suportar a for√ßa ao conectar e desconectar o cabo Micro USB. <br><br><img src="https://habrastorage.org/webt/vd/qj/e7/vdqje7zvkvnkzoggl7nvoezzzry.jpeg"><br><br>  Ele tamb√©m possui um estabilizador de 3,3 volts (e como us√°-lo em um dispositivo com fonte de alimenta√ß√£o de 6 volts - se houver apenas o mesmo estabilizador, e voc√™ pode adicionar dois diodos para escolher automaticamente de qual dispositivo o dispositivo ser√° alimentado).  Todos os tr√™s LEDs devem ser removidos da placa conversora de interface, caso contr√°rio, eles carregar√£o adicionalmente as baterias ao trabalhar com elas e tamb√©m interferir√£o na pesquisa do teclado e funcionar√£o com mem√≥ria flash com a interface SPI. <br><br>  A busca pelo objetivo acabou sendo ainda mais interessante do que a conquista (e voc√™ n√£o precisa dessa piada sobre o √¥nibus).  O autor aprendeu muito sobre os gerenciadores de inicializa√ß√£o do AVR, mem√≥ria flash com SPI, protocolo STK500 e padr√£o 802.15.4. <br><br>  Todo o outro c√≥digo, al√©m da biblioteca descrita acima, est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> e tamb√©m est√° na GPL v3.  O twitter do autor est√° <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt447026/">https://habr.com/ru/post/pt447026/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt447016/index.html">25 anos depois: uma entrevista com Linus Torvalds</a></li>
<li><a href="../pt447018/index.html">Enriquecimento qu√¢ntico em uma interpreta√ß√£o multi-mundo</a></li>
<li><a href="../pt447020/index.html">Produtividade n√£o √© sobre gerenciamento de tempo, mas sobre gerenciamento de aten√ß√£o</a></li>
<li><a href="../pt447022/index.html">N√£o force os ouvintes a refletir</a></li>
<li><a href="../pt447024/index.html">Como combinar as vantagens de um laptop e um computador desktop? An√°lise do problema e solu√ß√µes</a></li>
<li><a href="../pt447028/index.html">Arquivos antigos da esteganografia: ocultamos dados diretamente em setores</a></li>
<li><a href="../pt447034/index.html">Novo bug no Telegram Desktop permite que voc√™ leia a √∫ltima mensagem</a></li>
<li><a href="../pt447036/index.html">Um coquetel para uma dieta saud√°vel - √© feito por uma startup do acelerador da ITMO University</a></li>
<li><a href="../pt447038/index.html">Na lista de amea√ßas: "Game of Thrones" - uma das capas mais populares para cibercriminosos</a></li>
<li><a href="../pt447040/index.html">Pesquisa: o custo m√©dio dos switches √© reduzido - entendemos por que</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>