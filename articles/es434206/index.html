<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äçüé® üç§ ü•ó Distribuidor de chorro ok.ru/music üì∑ üéµ üëºüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Trabajo en el equipo de la plataforma Odnoklassniki y hoy hablar√© sobre los detalles de arquitectura, dise√±o e implementaci√≥n del servicio de distribu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Distribuidor de chorro ok.ru/music</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/odnoklassniki/blog/434206/"><img src="https://habrastorage.org/webt/m8/yb/sn/m8ybsnu0c1bqakexungs-hkisui.png"><br><br>  Trabajo en el equipo de la plataforma Odnoklassniki y hoy hablar√© sobre los detalles de arquitectura, dise√±o e implementaci√≥n del servicio de distribuci√≥n de m√∫sica. <br><a name="habracut"></a><br><blockquote>  El art√≠culo es una transcripci√≥n del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe</a> en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Joker 2018</a> . </blockquote><br><h1>  Algunas estad√≠sticas </h1><br>  Primero, algunas palabras sobre OK.  Este es un servicio gigantesco que utilizan m√°s de 70 millones de usuarios.  Son atendidos por 7 mil autom√≥viles en 4 centros de datos.  Recientemente, hemos superado la marca de tr√°fico a 2 Tb / s sin tener en cuenta los numerosos sitios de CDN.  Exprimimos al m√°ximo nuestro hardware, los servicios m√°s cargados atienden hasta 100,000 solicitudes por segundo desde un nodo de cuatro n√∫cleos.  Adem√°s, casi todos los servicios est√°n escritos en Java. <br><br>  Hay muchas secciones en OK, una de las m√°s populares es "M√∫sica".  En √©l, los usuarios pueden subir sus pistas, comprar y descargar m√∫sica en diferentes calidades.  La secci√≥n tiene un maravilloso cat√°logo, sistema de recomendaci√≥n, radio y mucho m√°s.  Pero el objetivo principal del servicio, por supuesto, es reproducir m√∫sica. <br><br>  El distribuidor de m√∫sica es responsable de transferir datos a reproductores de usuarios y aplicaciones m√≥viles.  Puede verlo en el inspector web si observa las solicitudes al dominio musicd.mycdn.me.  La API del distribuidor es extremadamente simple.  Responde a las solicitudes <code>GET</code> HTTP y emite el rango de seguimiento solicitado. <br><br><img src="https://habrastorage.org/webt/j9/va/ze/j9vazesvr2fuqtpvhec0uj7gbmq.png"><br><br>  En el pico, la carga alcanza los 100 Gb / s a ‚Äã‚Äãtrav√©s de medio mill√≥n de conexiones.  De hecho, el distribuidor de m√∫sica es una interfaz de almacenamiento en cach√© frente a nuestro repositorio de pistas interno, que se basa en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">One Blob Storage</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">One Cold Storage</a> y contiene petabytes de datos. <br><br>  Como he hablado sobre el almacenamiento en cach√©, veamos las estad√≠sticas de reproducci√≥n.  Vemos un TOP pronunciado. <br><br><img src="https://habrastorage.org/webt/q6/jv/pc/q6jvpcopw2t0xt29sl84lwp1gkg.png"><br><br>  Aproximadamente 140 pistas cubren el 10% de todas las reproducciones por d√≠a.  Si queremos que nuestro servidor de cach√© tenga un impacto de cach√© de al menos el 90%, entonces necesitamos medio mill√≥n de pistas para encajar en √©l.  95%: casi un mill√≥n de canciones. <br><br><h1>  Requisitos del distribuidor </h1><br>  ¬øQu√© objetivos nos propusimos al desarrollar la pr√≥xima versi√≥n del distribuidor? <br><br>  Quer√≠amos que un nodo pudiera contener 100 mil conexiones.  Y estas son conexiones de cliente lentas: un mont√≥n de navegadores y aplicaciones m√≥viles a trav√©s de redes con velocidades variables.  Al mismo tiempo, el servicio, como todos nuestros sistemas, debe ser escalable y tolerante a fallas. <br><br>  En primer lugar, necesitamos escalar el ancho de banda del cl√∫ster para mantenernos al d√≠a con la creciente popularidad del servicio y poder dar m√°s y m√°s tr√°fico.  Tambi√©n es necesario poder escalar la capacidad total de la memoria cach√© del cl√∫ster, porque el impacto de la memoria cach√© y el porcentaje de solicitudes que caer√°n en el almacenamiento de pistas dependen directamente de √©l. <br><br>  Hoy es necesario poder escalar cualquier sistema distribuido horizontalmente, es decir, agregar m√°quinas y centros de datos.  Pero tambi√©n quer√≠amos implementar el escalado vertical.  Nuestro servidor moderno t√≠pico contiene 56 n√∫cleos, 0.5-1 TB de RAM, una interfaz de red de 10 o 40 Gb y una docena de discos SSD. <br><br>  Hablando de escalabilidad horizontal, surge un efecto interesante: cuando tienes miles de servidores y decenas de miles de discos, algo se rompe constantemente.  La falla del disco es una rutina, los cambiamos a 20-30 piezas por semana.  Y las fallas del servidor no sorprenden a nadie; se reemplazan 2-3 autom√≥viles por d√≠a.  Tambi√©n tuve que lidiar con fallas del centro de datos, por ejemplo, en 2018 hubo tres fallas de este tipo, y esta probablemente no sea la √∫ltima vez. <br><br>  ¬øPor qu√© soy todo esto?  Cuando dise√±amos cualquier sistema, sabemos que tarde o temprano se romper√°n.  Por lo tanto, siempre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">estudiamos cuidadosamente los</a> escenarios de falla de todos los componentes del sistema.  La principal forma de lidiar con las fallas es a trav√©s de la replicaci√≥n de datos: varias copias de datos se almacenan en diferentes nodos. <br><br>  Tambi√©n reservamos ancho de banda de red.  Esto es importante porque si un componente del sistema falla, no se puede permitir que la carga de los componentes restantes se colapse. <br><br><h1>  Equilibrio </h1><br>  Primero, debe aprender a equilibrar las consultas de los usuarios entre los centros de datos y hacerlo autom√°ticamente.  Esto es en caso de que necesite realizar un trabajo de red, o si el centro de datos ha fallado.  Pero el equilibrio tambi√©n es necesario dentro de los centros de datos.  Y queremos distribuir solicitudes entre nodos no al azar, sino con pesos.  Por ejemplo, cuando cargamos una nueva versi√≥n de un servicio y queremos ingresar sin problemas un nuevo nodo en rotaci√≥n.  Los pesos tambi√©n ayudan mucho durante las pruebas de estr√©s: aumentamos el peso y ponemos una carga mucho m√°s pesada en el nodo para comprender los l√≠mites de sus capacidades.  Y cuando un nodo falla bajo carga, r√°pidamente ponemos a cero el peso y lo retiramos de la rotaci√≥n utilizando mecanismos de equilibrio. <br><br>  ¬øC√≥mo se ve la ruta de solicitud del usuario al nodo, que devolver√° los datos teniendo en cuenta el equilibrio? <br><br><img src="https://habrastorage.org/webt/uu/tz/uf/uutzuf3bnfpetnns91ca-rcf5mc.png"><br><br>  El usuario inicia sesi√≥n a trav√©s del sitio web o la aplicaci√≥n m√≥vil y recibe la URL de la pista: <br><br> <code>musicd.mycdn.me/v0/stream?id=...</code> <br> <br>  Para obtener la direcci√≥n IP del nombre de host en la URL, el cliente se pone en contacto con nuestro DNS GSLB, que conoce todos nuestros centros de datos y sitios CDN.  GSLB DNS le da al cliente la direcci√≥n IP del equilibrador de uno de los centros de datos, y el cliente establece una conexi√≥n con √©l.  El equilibrador conoce todos los nodos dentro de los centros de datos y su peso.  En nombre del usuario, establece una conexi√≥n con uno de los nodos.  Utilizamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">balanceadores L4 basados ‚Äã‚Äãen N4Ware</a> .  Noda proporciona los datos del usuario directamente, sin pasar por el equilibrador.  En servicios como un distribuidor, el tr√°fico saliente es significativamente mayor que el entrante. <br><br>  Si un centro de datos falla, el GSLB DNS lo detecta y lo elimina r√°pidamente de la rotaci√≥n: deja de proporcionar a los usuarios la direcci√≥n IP del equilibrador de este centro de datos.  Si falla un nodo en el centro de datos, su peso se restablece y el equilibrador dentro del centro de datos deja de enviarle solicitudes. <br><br>  Ahora considere equilibrar pistas por nodos dentro de un centro de datos.  Consideraremos los centros de datos como unidades aut√≥nomas independientes, cada uno de ellos vivir√° y trabajar√°, incluso si todos los dem√°s murieron.  Las pistas deben equilibrarse en todas las m√°quinas de manera uniforme para que no haya distorsiones de carga y replicarlas en diferentes nodos.  Si un nodo falla, la carga debe distribuirse de manera uniforme entre los restantes. <br><br>  Este problema se puede <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resolver de diferentes maneras</a> .  Nos decidimos por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un hashing constante</a> .  Envolvemos todo el rango posible de hash de identificadores de pista en un anillo, y luego cada pista se muestra en un punto de este anillo.  Luego distribuimos m√°s o menos uniformemente los rangos de anillo entre los nodos en el cl√∫ster.  Los nodos que almacenar√°n la pista se seleccionan arrastrando las pistas a un punto en el anillo y movi√©ndose en el sentido de las agujas del reloj. <br><br><img src="https://habrastorage.org/webt/qr/ty/xf/qrtyxfbchjhlp5taqfs0fbicnk0.jpeg"><br><br>  Pero tal esquema tiene un inconveniente: en caso de falla del nodo N2, por ejemplo, toda su carga recaer√° en la pr√≥xima r√©plica en el anillo: N3.  Y si no tiene un doble margen en el rendimiento, y esto no est√° justificado econ√≥micamente, lo m√°s probable es que el segundo nodo tambi√©n lo pase mal.  Se desarrollar√° N3 con un alto grado de probabilidad, la carga ir√° a N4, y as√≠ sucesivamente: habr√° una falla en cascada a lo largo de todo el anillo. <br><br>  Este problema se puede resolver aumentando el n√∫mero de r√©plicas, pero luego disminuye la capacidad √∫til total del cl√∫ster en el anillo.  Por lo tanto, hacemos lo contrario.  Con el mismo n√∫mero de nodos, el anillo se divide en un n√∫mero significativamente mayor de rangos que se distribuyen aleatoriamente alrededor del anillo.  Las r√©plicas de la pista se seleccionan de acuerdo con el algoritmo anterior. <br><br><img src="https://habrastorage.org/webt/kc/uf/5-/kcuf5-1mmekp60d5emkp5ckkgps.png"><br><br>  En el ejemplo anterior, cada nodo es responsable de dos rangos.  Si uno de los nodos falla, su carga completa no se ubicar√° en el siguiente nodo del anillo, sino que se distribuir√° entre los otros dos nodos del cl√∫ster. <br><br>  El anillo se calcula en base a un peque√±o conjunto de par√°metros algor√≠tmicamente y se determina en cada nodo.  Es decir, no lo almacenamos en alg√∫n tipo de configuraci√≥n.  Tenemos m√°s de cien mil de estos rangos en producci√≥n, y en caso de falla de cualquiera de los nodos, la carga se distribuye de manera absolutamente uniforme entre todos los dem√°s nodos vivos. <br><br>  ¬øC√≥mo se ve la ruta de retorno para el usuario en un sistema con hashing consistente? <br><br>  El usuario a trav√©s del equilibrador L4 llega a un nodo aleatorio.  La selecci√≥n del nodo es aleatoria, porque el equilibrador no sabe nada sobre la topolog√≠a.  Pero entonces cada r√©plica en el cl√∫ster lo sabe.  El nodo que recibi√≥ la solicitud determina si es una r√©plica de la pista solicitada.  Si no, cambia al modo proxy con una de las r√©plicas, establece una conexi√≥n con √©l y busca datos en su almacenamiento local.  Si la pista no est√° all√≠, la r√©plica la extrae del almac√©n de pistas, la guarda en la tienda local y le da el proxy, que redirige los datos al usuario. <br><br><img src="https://habrastorage.org/webt/c5/pu/wl/c5puwlig-lfxy20leny4y4utqig.png"><br><br>  Si la unidad en la r√©plica falla, los datos del almacenamiento se transferir√°n directamente al usuario.  Y si la r√©plica falla, entonces el proxy conoce todas las dem√°s r√©plicas para esta pista, establecer√° una conexi√≥n con otra r√©plica en vivo y recibir√° datos de ella.  Por lo tanto, garantizamos que si un usuario solicita una pista y al menos una r√©plica est√° viva, recibir√° una respuesta. <br><br><h1>  ¬øC√≥mo funciona un nodo? </h1><br><img src="https://habrastorage.org/webt/2m/up/ob/2mupob-rqyqsbic50lc-qn2xwqe.png"><br><br>  Un nodo es una tuber√≠a de un conjunto de etapas a trav√©s de las cuales pasa la solicitud de un usuario.  Primero, la solicitud va a una API externa (enviamos todo a trav√©s de HTTPS).  Luego se valida la solicitud: se verifican las firmas.  Luego, las etiquetas IDv3 se construyen si es necesario, por ejemplo, al comprar una pista.  La solicitud pasa a la etapa de enrutamiento, donde, en funci√≥n de la topolog√≠a del cl√∫ster, se determina c√≥mo se devolver√°n los datos: o el nodo actual es una r√©plica de esta pista, o enviaremos un proxy desde otro nodo.  En el segundo caso, el nodo a trav√©s del cliente proxy establece una conexi√≥n con la r√©plica a trav√©s de la API HTTP interna sin verificaci√≥n de firmas.  La r√©plica busca datos en el almacenamiento local; si encuentra una pista, la proporciona desde su disco;  y si no lo hace, extrae pistas del almacenamiento, las almacena en cach√© y las dona. <br><br><h1>  Carga de nodo </h1><br>  Vamos a estimar qu√© carga debe contener un nodo en esta configuraci√≥n.  Tengamos tres centros de datos con cuatro nodos cada uno. <br><br><img src="https://habrastorage.org/webt/in/-z/nz/in-znz1gekgg217y9oxdlm5pv-g.png"><br><br>  El servicio completo deber√≠a servir a 120 Gbit / s, es decir, 40 Gbit / s por centro de datos.  Supongamos que los networkers realizan maniobras o se produce un accidente, y quedan dos centros de datos DC1 y DC3.  Ahora cada uno de ellos deber√≠a dar 60 Gbit / s.  Pero aqu√≠ les correspond√≠a a los desarrolladores implementar alguna actualizaci√≥n, en cada centro de datos quedaban 3 nodos activos y cada uno de ellos deber√≠a dar 20 Gbit / s. <br><br><img src="https://habrastorage.org/webt/6q/tc/sz/6qtcszoeoi4w1zjxvh_o1u35vni.png"><br><br>  Pero inicialmente en cada centro de datos hab√≠a 4 nodos.  Y si almacenamos dos r√©plicas en el centro de datos, con una probabilidad del 50%, el nodo que recibi√≥ la solicitud no ser√° una r√©plica de la pista solicitada y representar√° los datos.  Es decir, la mitad del tr√°fico dentro del centro de datos es proxy. <br><br><img src="https://habrastorage.org/webt/yi/aj/tc/yiajtck3angspynaidxuar_t5gm.png"><br><br>  Entonces, un nodo deber√≠a dar a los usuarios 20 Gb / s.  De estos, 10 Gb / s extrae de sus vecinos en el centro de datos.  Pero el esquema es sim√©trico: el nodo da los mismos 10 Gb / s a ‚Äã‚Äãlos vecinos en el centro de datos.  Resulta que 30 Gbit / s salen del nodo, de los cuales 20 Gbit / s deben ser atendidos por s√≠ mismos, ya que es una r√©plica de los datos solicitados.  Adem√°s, los datos ir√°n de discos o de RAM, que contiene alrededor de 50 mil pistas "calientes".  Seg√∫n nuestras estad√≠sticas de reproducci√≥n, esto le permite eliminar el 60-70% de la carga de los discos y permanecer√° a unos 8 Gb / s.  Este hilo es bastante capaz de entregar una docena de SSD. <br><br><h1>  Almacenamiento de datos en un nodo </h1><br>  Si coloca cada pista en un archivo separado, la sobrecarga de administrar estos archivos ser√° enorme.  Incluso reiniciar los nodos y escanear los datos en los discos tomar√° minutos, si no decenas de minutos. <br><br>  Hay limitaciones menos obvias para este esquema.  Por ejemplo, puede cargar pistas solo desde el principio.  Y si el usuario solicit√≥ la reproducci√≥n desde el medio y se perdi√≥ la memoria cach√©, entonces no podremos enviar un solo byte hasta que carguemos los datos en la ubicaci√≥n deseada desde el repositorio de pistas.  Adem√°s, podemos almacenar las pistas solo como un todo, incluso si es un audiolibro gigante que dejaron de escuchar en el tercer minuto.  Continuar√° depositando peso muerto en el disco, desperdiciar√° espacio costoso y reducir√° el impacto de cach√© de este nodo. <br><br>  Por lo tanto, lo hacemos de una manera completamente diferente: dividimos las pistas en bloques de 256 KB, porque esto se correlaciona con el tama√±o del bloque en el SSD, y ya estamos operando con estos bloques.  Un disco de 1 TB contiene 4 millones de bloques.  Cada disco en un nodo es un almacenamiento independiente, y todos los bloques de cada pista se distribuyen en todos los discos. <br><br>  No llegamos inmediatamente a tal esquema, al principio todos los bloques de una pista se encontraban en un disco.  Pero esto condujo a una fuerte distorsi√≥n de la carga entre los discos, ya que si una pista popular golpea uno de los discos, todas las solicitudes de sus datos ir√°n a un disco.  Para evitar esto, distribuimos los bloques de cada pista en todos los discos, equilibrando la carga. <br><br>  Adem√°s, no olvidamos que tenemos un mont√≥n de RAM, pero decidimos no hacer el cach√© sem√°ntico, ya que tenemos un maravilloso cach√© de p√°gina en Linux. <br><br>  ¬øC√≥mo almacenar bloques en discos? <br><br>  Primero decidimos obtener un archivo XFS gigante del tama√±o de un disco y poner todos los bloques en √©l.  Entonces surgi√≥ la idea de trabajar directamente con un dispositivo de bloque.  Implementamos ambas opciones, las comparamos y result√≥ que cuando se trabaja directamente con un dispositivo de bloque, la grabaci√≥n es 1.5 veces m√°s r√°pida, el tiempo de respuesta es 2-3 veces menor, la carga total del sistema es 2 veces menor. <br><br><h1>  Indice </h1><br>  Pero no es suficiente para poder almacenar bloques; debe mantener un √≠ndice de bloques de pistas de m√∫sica a bloques en el disco. <br><br><img src="https://habrastorage.org/webt/me/4y/0b/me4y0bk_xbwco9r_5y6smyhmxmc.png"><br><br>  Result√≥ ser bastante compacto, una entrada de √≠ndice solo toma 29 bytes.  Para un almacenamiento de 10 TB, el √≠ndice es un poco m√°s de 1 GB. <br><br>  Hay un punto interesante aqu√≠.  En cada uno de estos registros, debe almacenar el tama√±o total de toda la pista.  Este es un ejemplo cl√°sico de desnormalizaci√≥n.  La raz√≥n es que, de acuerdo con la especificaci√≥n en la respuesta de rango HTTP, debemos devolver el tama√±o total del recurso, as√≠ como formar un encabezado de longitud de contenido.  Si no fuera as√≠, entonces todo ser√≠a a√∫n m√°s compacto. <br><br>  Formulamos una serie de requisitos para el √≠ndice: trabajar r√°pidamente (preferiblemente, almacenado en la RAM), ser compacto y no ocupar espacio en la memoria cach√© de la p√°gina.  Otro √≠ndice debe ser persistente.  Si lo perdemos, perderemos informaci√≥n sobre en qu√© lugar del disco se almacena la pista, y esto equivale a limpiar los discos.  Y en general, me gustar√≠a que los viejos bloques, a los que no se haya accedido durante mucho tiempo, se suplanten de alguna manera, dejando espacio para pistas m√°s populares.  Hemos elegido la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pol√≠tica de exclusi√≥n de LRU</a> : los bloques se eliminan una vez por minuto, el 1% de los bloques se mantienen libres.  Por supuesto, la estructura del √≠ndice debe ser segura para subprocesos, porque tenemos 100 mil conexiones por nodo.  <code>SharedMemoryFixedMap</code> de nuestra biblioteca de c√≥digo abierto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">one-nio</a> cumple todas estas condiciones de manera ideal. <br><br>  Ponemos el √≠ndice en <code>tmpfs</code> , funciona r√°pidamente, pero hay un matiz.  Cuando la m√°quina se reinicia, todo lo que estaba en <code>tmpfs</code> , incluido el √≠ndice, se pierde.  Adem√°s, si debido al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code> sun.misc.Unsafe</code></a> nuestro proceso se bloque√≥, no est√° claro en qu√© estado se mantuvo el √≠ndice.  Por lo tanto, hacemos una impresi√≥n de esto una vez por hora.  Pero esto no es suficiente: dado que usamos extrusi√≥n de bloques, tenemos que admitir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WAL</a> , en el que escribimos informaci√≥n sobre bloques extruidos.  Las entradas sobre bloques en yesos y WAL deben clasificarse de alguna manera durante la recuperaci√≥n.  Para hacer esto, usamos el bloque de generaci√≥n.  Desempe√±a el papel de un contador de transacciones globales y se incrementa cada vez que cambia el √≠ndice.  Veamos un ejemplo de c√≥mo funciona esto. <br><br>  Tome un √≠ndice con tres entradas: dos bloques de la pista No. 1 y un bloque de la pista No. 2. <br><br><img src="https://habrastorage.org/webt/l6/ux/51/l6ux512_lbpedki0bb3g0ouggau.png"><br><br>  La corriente de creaci√≥n de moldes se despierta e itera mediante este √≠ndice: la primera y segunda tuplas caen en el elenco.  Luego, el flujo de aglomeraci√≥n se vuelve hacia el √≠ndice, se da cuenta de que no se ha accedido al s√©ptimo bloque durante mucho tiempo y decide usarlo para otra cosa.  El proceso fuerza el bloqueo y escribe un registro en el WAL.  Llega al bloque 9, ve que no ha sido contactado por mucho tiempo y tambi√©n lo se√±ala como desplazado.  Aqu√≠ el usuario accede al sistema y se produce una p√©rdida de cach√©: se solicita una pista que no tenemos.  Guardamos el bloque de esta pista en nuestro repositorio, sobrescribiendo el bloque 9.  En este caso, la generaci√≥n se incrementa y se vuelve igual a 22. Luego, se activa el proceso de creaci√≥n de un molde, que no ha completado su trabajo, alcanza el √∫ltimo registro y lo escribe en el molde.  Como resultado, tenemos dos registros en vivo en el √≠ndice, un elenco y WAL. <br><br><img src="https://habrastorage.org/webt/sy/vj/0_/syvj0_-kknmn4i5pulf_p8bclc4.png"><br><br>  Cuando el nodo actual cae, restaurar√° el estado inicial del √≠ndice de la siguiente manera.  Primero, escanee el WAL y construya un mapa de bloques sucio.  La tarjeta almacena el mapeo desde el n√∫mero de bloque hasta la generaci√≥n cuando este bloque fue suplantado. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/9p/g5/gn/9pg5gn-8atbixm4swmytkscxwpm.png" width="300"></div><br><br>  Despu√©s de eso, comenzamos a iterar sobre el molde usando el mapa como filtro.  Observamos el primer registro del elenco, se relaciona con el bloque n√∫mero 3.  No se lo menciona entre los sucios, lo que significa que est√° vivo y entra en el √≠ndice.  Llegamos al bloque n√∫mero 7 con la d√©cimo octava generaci√≥n, pero el mapa de bloques sucios nos dice que solo en la generaci√≥n 18 el bloque se desplaz√≥.  Por lo tanto, no cae en el √≠ndice.  Llegamos al √∫ltimo registro, que describe el contenido del bloque 9 con 22 generaciones.  Este bloque se menciona en el mapa de bloques sucios, pero fue suplantado anteriormente.  Por lo tanto, se reutiliza para nuevos datos y entra en el √≠ndice.  El objetivo se logra. <br><br><h1>  Optimizaciones </h1><br>  Pero eso no es todo, vamos m√°s abajo. <br><br>  Comencemos con el cach√© de la p√°gina.  Inicialmente contamos con √©l, pero cuando comenzamos a realizar pruebas de carga de la primera versi√≥n, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">result√≥</a> que la tasa de aciertos de la cach√© de la p√°gina no alcanz√≥ el 20%.  Sugirieron que el problema se lea con anticipaci√≥n: no almacenamos archivos, sino bloques, mientras servimos un mont√≥n de conexiones, y en esta configuraci√≥n, trabajar con el disco es aleatoriamente eficiente.  Casi nunca leemos nada secuencialmente.  Afortunadamente, en Linux hay una llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>posix_fadvise</code></a> que le permite decirle al kernel c√≥mo vamos a trabajar con el descriptor de archivo; en particular, podemos decir que no necesitamos leer con anticipaci√≥n pasando el indicador <code>POSIX_FADV_RANDOM</code> .  Esta llamada al sistema est√° disponible a trav√©s de <a href="">one-nio</a> .  En funcionamiento, nuestro acierto de cach√© es 70-80%.  El n√∫mero de lecturas f√≠sicas de los discos disminuy√≥ en m√°s de 2 veces, el retraso en la respuesta HTTP disminuy√≥ en un 20%. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos m√°s all√°. </font><font style="vertical-align: inherit;">El servicio tiene un tama√±o de almacenamiento din√°mico bastante grande. </font><font style="vertical-align: inherit;">Para facilitar la vida de los cach√©s TLB del procesador, decidimos incluir p√°ginas enormes para nuestro proceso Java. </font><font style="vertical-align: inherit;">Como resultado, obtuvimos una ganancia notable por el tiempo de recolecci√≥n de basura (GC Time / Safepoint Total Time es 20-30% menor), la carga del kernel se volvi√≥ m√°s uniforme, pero no not√≥ ning√∫n efecto en los gr√°ficos de latencia HTTP.</font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Incidente </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Poco despu√©s de que comenzara el servicio, ocurri√≥ el √∫nico incidente (hasta ahora). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Una tarde despu√©s del final de la jornada laboral, las quejas sobre la reproducci√≥n de m√∫sica generaron apoyo. Los usuarios escribieron que incluyeron su pista favorita, pero cada pocos segundos escucharon m√∫sica extra√±a de otros tiempos y personas, y el jugador les dijo que reproduc√≠a su pista favorita. Bastante r√°pidamente redujo el c√≠rculo de b√∫squeda a un auto, lo que dio algo extra√±o. Descubrimos por los registros que recientemente se reinici√≥. Para simplificar, ten√≠amos dos discos e √≠ndices que describ√≠an el contenido de los bloques. Un √≠ndice dice que el cuarto bloque de la pista Daft Punk se encuentra en el bloque n√∫mero 2 del disco sdc, y el bloque cero de la pista Stas Mikhailov se encuentra en el bloque cero del disco sdd.</font></font><br><br><img src="https://habrastorage.org/webt/9q/pu/9g/9qpu9gxbc-uph2jp7tsjkup4b5a.png"><br><br> ,            .    Linux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="></a> :      ,      . <br><br><img src="https://habrastorage.org/webt/3s/y-/vm/3sy-vmtyncu3miiwjhzyu0j9xi4.png"><br><br>   .        ID.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WWN</a>           ,   WAL.      ,      ,             . <br><br><h1>   </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El an√°lisis de problemas en tales sistemas distribuidos es dif√≠cil porque la solicitud de un usuario pasa por muchas etapas y cruza los l√≠mites de los nodos. En el caso de CDN, todo se vuelve a√∫n m√°s complicado, porque para CDN, el upstream es el centro de datos del hogar. Puede haber muchas de esas esperanzas. Adem√°s, el sistema sirve a cientos de miles de conexiones de usuarios. Es bastante dif√≠cil entender en qu√© etapa hay un problema al procesar una solicitud de un usuario espec√≠fico. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simplificamos nuestras vidas as√≠. Al iniciar sesi√≥n, marcamos todas las solicitudes con una etiqueta similar a </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open Tracing</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Zipkin</font></font></a> .      ,    .          ,    ,       HTTP-    .      ,   ,  ,   ,     ,   ,        . <br><br><h1>   </h1><br>         . ,  :  ,     ,    . <br><br><pre> <code class="java hljs">ByteBuffer buffer = ByteBuffer.allocate(size); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count = fileChannel.read(buffer, position); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// ... } buffer.flip(); socketChannel.write(buffer);</span></span></code> </pre> <br>        ,       : <br><br><ul><li>       <code>FileChannel.read()</code>    kernel space  user space; </li><li>            <code>SocketChannel.write()</code> ,    user space  kernel space. </li></ul><br>  ,  Linux   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><code>sendfile()</code></a> ,              ,    user space.  ,     <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">one-nio</a> .                ,      <code>sendfile()</code> ‚Äî    10 /   <code>sendfile()</code>    0. <br><br>     user-space SSL-     <code>sendfile()</code>      ,        .       .     <code>SocketChannel</code>  <code>FileChannel</code> ,   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Async Profiler</a>         ,         <code>sun.nio.ch.IOUtil</code> ,      <code>read()</code>  <code>write()</code>   .    . <br><br><pre> <code class="java hljs">ByteBuffer bb = Util.getTemporaryDirectBuffer(dst.remaining()); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = readIntoNativeBuffer(fd, bb, position, nd); bb.flip(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) dst.put(bb); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> n; } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { Util.offerFirstTemporaryDirectBuffer(bb); }</code> </pre> <br>    .       heap <code>ByteBuffer</code> ,         ,    ,     heap <code>ByteBuffer</code> ,       .        . <br><br>  .      <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">one-nio</a> .   <code>MallocMT</code> ‚Äî  ,   .    SSL       ,     Java heap,    <code>ByteBuffer</code> ,      <code>FileChannel</code>       .      . <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Allocator allocator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MallocMT(size, concurrency); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Socket socket)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (socket.getSslContext() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> address = allocator.malloc(size); ByteBuffer buf = DirectMemory.wrap(address, size); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> available = channel.read(buf, offset); socket.writeRaw(address, available, flags);</code> </pre><br><h1> 100 000    </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero el √©xito del sistema no est√° garantizado por una implementaci√≥n razonable en los niveles inferiores. Hay otro problema aqu√≠. El transportador en cada nodo sirve hasta 100 mil conexiones simult√°neas. ¬øC√≥mo organizar los c√°lculos en tal sistema? </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Lo primero que viene a la mente es crear un hilo de ejecuci√≥n para cada cliente o conexi√≥n, y en √©l realizamos las etapas de canalizaci√≥n una tras otra. Si es necesario, bloquee, luego contin√∫e. Pero con tal esquema, los costos de los cambios de contexto y las pilas de flujos ser√°n excesivos, ya que estamos hablando de un distribuidor y muchos flujos. Por lo tanto, fuimos por el otro lado.</font></font><br><br><img src="https://habrastorage.org/webt/mt/vg/eo/mtvgeoszcpcv6zpc-qi_rbqeyhy.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se crea una tuber√≠a l√≥gica para cada conexi√≥n, que consiste en etapas que interact√∫an entre s√≠ de forma asincr√≥nica. Cada etapa tiene un turno que almacena las solicitudes entrantes. Para la ejecuci√≥n de etapas, se utilizan peque√±os grupos de subprocesos comunes. Si necesita procesar un mensaje de la cola de solicitudes, tomamos una secuencia del grupo, procesamos el mensaje y devolvemos la secuencia al grupo. Con este esquema, los datos se env√≠an desde el almacenamiento al cliente.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pero tal esquema no est√° exento de defectos. Los backends son mucho m√°s r√°pidos que las conexiones de usuario. Cuando los datos pasan a trav√©s de la tuber√≠a, se acumulan en la etapa m√°s lenta, es decir. en la etapa de escribir bloques en el socket de conexi√≥n del cliente. Tarde o temprano, esto conducir√° al colapso del sistema. Si intenta limitar las colas en estas etapas, entonces todo se detendr√° instant√°neamente, porque las tuber√≠as en la cadena al z√≥calo del usuario se bloquear√°n. Y dado que usan grupos de hilos compartidos, bloquear√°n todos los hilos en ellos. Necesita contrapresi√≥n. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para hacer esto, usamos </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">corrientes en chorro</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. La esencia del enfoque es que el suscriptor controla la velocidad de los datos provenientes del editor utilizando la demanda. La demanda significa la cantidad de datos que el suscriptor est√° listo para procesar junto con la demanda anterior que ya ha se√±alado. El editor tiene derecho a enviar datos, pero sin exceder la demanda acumulada total en este momento, menos los datos ya enviados.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Por lo tanto, el sistema cambia din√°micamente entre los modos push y pull. </font><font style="vertical-align: inherit;">En modo push, el suscriptor es m√°s r√°pido que el editor, lo que significa que el editor siempre tiene una demanda insatisfecha del suscriptor, pero no tiene datos. </font><font style="vertical-align: inherit;">Tan pronto como aparecen los datos, los env√≠a inmediatamente al suscriptor. </font><font style="vertical-align: inherit;">El modo de extracci√≥n ocurre cuando el editor es m√°s r√°pido que el suscriptor. </font><font style="vertical-align: inherit;">Es decir, el editor estar√≠a encantado de enviar datos, solo la demanda es cero. </font><font style="vertical-align: inherit;">Tan pronto como el suscriptor dice que est√° listo para procesar un poco m√°s, el editor inmediatamente le env√≠a un dato como parte de la demanda. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuestro transportador se convierte en una corriente en chorro. </font><font style="vertical-align: inherit;">Cada etapa se convierte en editor de la etapa anterior y suscriptor de la siguiente. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La interfaz de las corrientes en chorro se ve extremadamente simple. </font></font><code>Publisher</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">vamos a firmar</font></font><code>Subscriber</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , y solo debe implementar cuatro controladores: </font></font><br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Publisher</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">subscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscriber&lt;? </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">super</span></span></span></span><span class="hljs-function"><span class="hljs-params"> T&gt; s)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscriber</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSubscribe</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Subscription s)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onNext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Throwable t)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onComplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Subscription</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br> <code>Subscription</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> le permite se√±alar la demanda y darse de baja. </font></font> En ninguna parte es m√°s f√°cil. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Como elemento de datos, no pasamos matrices de bytes, sino una abstracci√≥n como un fragmento. </font><font style="vertical-align: inherit;">Hacemos esto para no arrastrar los datos en el mont√≥n, si es posible. </font><font style="vertical-align: inherit;">Chunk es un enlace de datos con una interfaz muy limitada que le permite solo leer datos </font></font><code>ByteBuffer</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, escribir en un socket o en un archivo.</font></font><br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chunk</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ByteBuffer dst)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Socket socket)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">write</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(FileChannel channel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> offset)</span></span></span></span>; }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Hay muchas implementaciones de fragmentos: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El m√°s popular, que se utiliza en el caso de aciertos de cach√© y al enviar datos desde el disco, es la implementaci√≥n en la parte superior </font></font><code>RandomAccessFile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">El fragmento contiene solo un enlace al archivo, el desplazamiento en este archivo y el tama√±o de los datos. </font><font style="vertical-align: inherit;">Atraviesa toda la tuber√≠a, llega a la toma de conexi√≥n del usuario y all√≠ se convierte en una llamada </font></font><code>sendfile()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Es decir, la memoria no se consume en absoluto.</font></font></li><li>   cache miss   :             .     , ‚Äî  ,     , ‚Äî      . </li><li> ,    -      heap.        <code>ByteBuffer</code> . </li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A pesar de la simplicidad de esta API, debe ser segura para subprocesos por especificaci√≥n, y la mayor√≠a de los m√©todos deben ser sin bloqueo. </font><font style="vertical-align: inherit;">Elegimos el camino en el esp√≠ritu del Modelo de actor mecanografiado, inspirado en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejemplos</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> del </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">repositorio oficial de </font></font></a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">jet stream</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Para hacer que las llamadas a m√©todos no sean bloqueadas, cuando llamamos al m√©todo, tomamos todos los par√°metros, lo envolvemos en un mensaje, lo ponemos en la cola para su ejecuci√≥n y devolvemos el control. </font><font style="vertical-align: inherit;">Los mensajes de la cola se procesan estrictamente secuencialmente.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sin sincronizaci√≥n, el c√≥digo es simple y directo.</font></font></b> <div class="spoiler_text">     .   publisher  subscriber   ,    ,   executor,       . <code>AtomicBoolean</code>  happens before   . <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// Incoming messages final Queue&lt;M&gt; mailbox; // Message processing works here final Executor executor; // To ensure HB relationship between runs final AtomicBoolean on = new AtomicBoolean();</span></span></code> </pre> <br>    : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> n)</span></span></span><span class="hljs-function"> </span></span>{ enqueue(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Request(n)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enqueue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> M message)</span></span></span><span class="hljs-function"> </span></span>{ mailbox.offer(message); tryScheduleToExecute(); }</code> </pre> <br>  <code>tryScheduleToExecute()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on.compareAndSet(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { executor.execute(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { ... } }</code> </pre> <br>  <code>run()</code> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (on.get()) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { dequeueAndProcess(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { on.set(<span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!messages.isEmpty()) { tryScheduleToExecute(); } } }</code> </pre> <br>  <code>dequeueAndProcess()</code> : <br><br><pre> <code class="java hljs">M message; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((message = mailbox.poll()) != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-comment"><span class="hljs-comment">// Pattern match if (message instanceof Request) { doRequest(((Request) message).n); } else { ‚Ä¶ } }</span></span></code> </pre> </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenemos una implementaci√≥n completamente sin bloqueo. </font><font style="vertical-align: inherit;">c√≥digo simple y consistente, sin </font></font><code>volatile</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>Atomic*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, contenci√≥n, y otros. </font><font style="vertical-align: inherit;">En todo nuestro sistema, hay un total de 200 hilos para servir 100,000 conexiones.</font></font><br><br><h1>  Al final </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En producci√≥n, tenemos 12 m√°quinas, mientras que hay m√°s de un doble margen en el ancho de banda. Cada m√°quina en modo normal proporciona hasta 10 Gbit / s a ‚Äã‚Äãtrav√©s de cientos de miles de conexiones. Hemos proporcionado escalabilidad y resistencia. Todo est√° escrito en Java y </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">one-nio</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><img src="https://habrastorage.org/webt/oa/pz/cq/oapzcqjf6y9ccxrnk1wzrpaigdy.jpeg"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Este es un gr√°fico hasta el primer byte dado al usuario desde el lado del servidor. Percentil 99 menos de 20 ms. El gr√°fico azul es el retorno de los datos HTTPS al usuario. El gr√°fico rojo es el retorno de datos de la r√©plica al proxy a trav√©s de </font></font><code>sendfile()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HTTP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En realidad, el impacto de cach√© en producci√≥n es del 97%, por lo que los gr√°ficos describen la latencia de nuestro repositorio de pistas, del cual extraemos datos en caso de errores de cach√©, lo que tampoco es malo, considerando los petabytes de datos.</font></font><br><br><img src="https://habrastorage.org/webt/xp/fd/eq/xpfdequddx6cnglrzrgdxtbspuc.jpeg"><br><br>    75-    ,       1 .         ‚Äî   300 .  Es decir 0.7  ‚Äî   . <br><br>      ,      ,     ,   . ,    . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es434206/">https://habr.com/ru/post/es434206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es434194/index.html">Desarrollo de habilidades para Alice. Experiencia con interfaces de voz, consejos para principiantes.</a></li>
<li><a href="../es434196/index.html">3CX v16 Alpha 2 y planes para el nuevo a√±o</a></li>
<li><a href="../es434198/index.html">Elegir un modo operativo de servidor web basado en la experiencia personal</a></li>
<li><a href="../es434200/index.html">¬øEs el √≥xido tan terrible como est√° pintado?</a></li>
<li><a href="../es434202/index.html">4 secretos sobre c√≥mo no perder tu trabajo en ciencia de datos</a></li>
<li><a href="../es434208/index.html">C√≥mo se salv√≥ nuestro viernes negro</a></li>
<li><a href="../es434210/index.html">An√°lisis del concurso de cuestionarios de Android del stand de HeadHunter en Mobius 2018 Mosc√∫</a></li>
<li><a href="../es434212/index.html">Torre Tesla ¬øQu√© sucede dentro y cerca de un rascacielos cuando cae un rayo?</a></li>
<li><a href="../es434214/index.html">Proxy din√°mico de Java: ¬øqu√© es y c√≥mo usarlo?</a></li>
<li><a href="../es434216/index.html">Ataques de fuerza bruta con Kali Linux</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>