<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïï üå°Ô∏è üñçÔ∏è Escrevendo bilh√µes de m√∫sicas com C # e Deep Learning üë©üèº‚Äçüç≥ üì® üçø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Neste artigo, explicarei como criar um site ASP.NET Core , que usa a IA para gerar letras de m√∫sicas exclusivas com um clique de um bot√£o e permite qu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escrevendo bilh√µes de m√∫sicas com C # e Deep Learning</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453232/">  Neste artigo, explicarei como criar um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">site ASP.NET Core</a> , que usa a IA para gerar letras de m√∫sicas exclusivas com um clique de um bot√£o e permite que os usu√°rios votem nas melhores m√∫sicas. <br><a name="habracut"></a><br><h1>  A rede neural </h1><br>  Cerca de 2,5 meses atr√°s, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">OpenAI</a> publicou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">um post no blog</a> , onde eles demonstraram quase imposs√≠vel: um modelo de aprendizado profundo, que pode escrever artigos, indistingu√≠veis dos escritos por seres humanos.  O texto que ele gerou foi t√£o impressionante que eu tive que verificar o calend√°rio para garantir que n√£o era uma piada de tolo de abril (lembre-se de que era fevereiro e Seattle estava coberta de neve). <br><br><p><img src="https://habrastorage.org/webt/df/ok/nc/dfoknc5wbfxrkyvigyygtz9kctw.png" alt="Amostra de texto GPT-2"></p><br><p> Eles n√£o lan√ßaram a maior rede neural com mais de 1 bilh√£o de par√¢metros que constru√≠ram at√© hoje (uma decis√£o muito controversa), mas forneceram uma vers√£o menor de 117 milh√µes de par√¢metros <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">no GitHub</a> sob licen√ßa MIT.  O modelo tem um nome muito memor√°vel: <b>GPT-2</b> . </p><br><p>  Ent√£o, cerca de um m√™s atr√°s, quando eu estava tentando pensar em qual projeto legal eu poderia fazer com o TensorFlow, essa rede se tornou o ponto de partida.  Se ele j√° poderia gerar texto em ingl√™s, n√£o seria muito dif√≠cil <i>ajust√°-</i> lo para gerar letras de m√∫sicas, se houver um conjunto de dados suficientemente grande. </p><br><h2>  Como o GPT-2 funciona? </h2><br><p>  Existem v√°rias conquistas importantes na pesquisa de aprendizado profundo, que tornaram poss√≠vel o GPT-2: </p><br><h3>  Aprendizagem auto-supervisionada </h3><br><p>  Essa t√©cnica recebeu seu nome finalizado por Yan LeCunn apenas alguns dias depois que eu escrevi a primeira vers√£o deste artigo.  √â uma t√©cnica muito poderosa, que pode ser aplicada a basicamente qualquer tipo de dados do mundo real.  Para treinar o GPT-2, a OpenAI coletou <i>dezenas de gigabytes de artigos</i> de v√°rias fontes, que foram votados no Reddit. </p><br><p>  Convencionalmente, seria necess√°rio um ser humano para percorrer todos esses artigos e, por exemplo, marc√°-los como "positivos" ou "negativos".  Ent√£o eles ensinavam uma rede neural de maneira supervisionada a classificar esses artigos da mesma maneira que um humano. </p><br><p><img src="https://habrastorage.org/webt/cn/sl/_2/cnsl_21o1f-vio39rn5auufl_lw.jpeg" alt="RECAPTCHA: encontre sinais de stree"></p><br><p>  A nova id√©ia aqui √© que, para criar um modelo de aprendizado profundo, que tenha um alto n√≠vel de entendimento de seus dados, voc√™ simplesmente corrompe os dados e encarrega o modelo de restaurar o original.  Isso faz o modelo entender as conex√µes entre partes de dados e seus contextos circundantes. </p><br><p>  Vamos tomar o texto como um exemplo.  O GPT-2 pega uma amostra do texto original, seleciona 15% dos tokens para serem corrompidos e oculta 80% deles (por exemplo, substitui por um token de m√°scara especial, geralmente ___), substitui 10% por outro token aleat√≥rio do dicion√°rio, e mant√©m os 10% restantes intactos.  Pegue <i>eu joguei uma bola, e ela caiu na grama</i> .  Depois da corrup√ß√£o, pode ser assim: <i>eu joguei a bola do carro, e ela ___ na grama</i> .  Em termos leigos, para que a rede restaure o original, √© preciso aprender que algo jogado provavelmente cair√° e que a bola de carro √© algo muito incomum no contexto. </p><br><p>  Um modelo treinado assim √© bom em gerar / completar dados parciais, mas os recursos de alto n√≠vel que aprendeu (como sa√≠das das camadas internas) podem ser usados ‚Äã‚Äãpara outros fins, adicionando uma ou duas camadas sobre elas e ajustando-as <b>somente essa nova √∫ltima camada</b> em um conjunto de dados real, <b>menor</b> e marcado por humanos, de maneira convencional. </p><br><h3>  Pouca aten√ß√£o pessoal </h3><br><p>  O GPT-2 usa algo chamado pouca aten√ß√£o pessoal.  Em ess√™ncia, √© uma t√©cnica que permite que uma grande quantidade de entradas de processamento de redes neurais se concentre mais em algumas partes dela do que em outras.  E a rede aprende onde deve "procurar" durante o treinamento.  O mecanismo de aten√ß√£o √© melhor explicado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">nesta postagem do blog</a> . </p><br><p>  A parte <i>esparsa</i> no t√≠tulo desta se√ß√£o refere-se a uma restri√ß√£o sobre quais segmentos de entrada o mecanismo de aten√ß√£o pode escolher.  A aten√ß√£o inicial pode escolher entre toda a entrada.  Isso fez com que sua matriz de pesos fosse O (input_size ^ 2), que cresce muito rapidamente com o tamanho da entrada.  Pouca aten√ß√£o normalmente restringe isso de alguma maneira.  Para mais informa√ß√µes, d√™ uma olhada em outro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">post do OpenAI</a> . </p><br><p>  A aten√ß√£o no GPT-2 √© <i>m√∫ltipla</i> .  Imagine que voc√™ poderia ter um olho ou dois adicionais para verificar o que estava no √∫ltimo par√°grafo sem parar de ler o atual. </p><br><h3>  Muito mais </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Conex√µes residuais</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">codifica√ß√£o de pares de bytes</a> , previs√£o de pr√≥xima senten√ßa e muito mais. </p><br><h2>  Portando GPT-2 (e convertendo Python em geral) </h2><br><p>  O c√≥digo do modelo original est√° em Python, mas eu sou um cara de C #.  Felizmente, o c√≥digo fonte √© bastante leg√≠vel e o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">ponto crucial</a> est√° em apenas 5 arquivos, talvez 500 linhas no total.  Ent√£o, criei um novo projeto .NET Standard, instalei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Gradient</a> (uma liga√ß√£o do TensorFlow para .NET) e converti esses arquivos linha por linha em C #.  Isso me levou cerca de 2 horas.  A √∫nica coisa pit√¥nica que restava no c√≥digo era o uso do m√≥dulo regex Python do pip (o gerenciador de pacotes mais usado para o Python), pois eu n√£o queria perder tempo aprendendo os meandros das express√µes regulares do Python ( <i>como se isso n√£o bastasse). para lidar com os .NET j√°</i> ). </p><br><p>  Principalmente, a convers√£o consistia em definir classes semelhantes, adicionar tipos e reescrever as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">compreens√µes da lista</a> Python nas constru√ß√µes LINQ correspondentes.  Al√©m do LINQ da biblioteca padr√£o, usei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">MoreLinq</a> , que expande levemente o que o LINQ pode fazer. Por exemplo: </p><br><p></p><pre><code class="python hljs">bs = list(range(ord(<span class="hljs-string"><span class="hljs-string">"!"</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"~"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) + list(range(ord(<span class="hljs-string"><span class="hljs-string">"¬°"</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"¬¨"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>)) + list(range(ord(<span class="hljs-string"><span class="hljs-string">""</span></span>), ord(<span class="hljs-string"><span class="hljs-string">"√ø"</span></span>)+<span class="hljs-number"><span class="hljs-number">1</span></span>))</code> </pre> <br><p>  se transformou em: </p><br><p></p><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bs = Range(<span class="hljs-string"><span class="hljs-string">'!'</span></span>, <span class="hljs-string"><span class="hljs-string">'~'</span></span> - <span class="hljs-string"><span class="hljs-string">'!'</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) .Concat(Range(<span class="hljs-string"><span class="hljs-string">'¬°'</span></span>, <span class="hljs-string"><span class="hljs-string">'¬¨'</span></span> -<span class="hljs-string"><span class="hljs-string">'¬°'</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>)) .Concat(Range(<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-string"><span class="hljs-string">'√ø'</span></span> - <span class="hljs-string"><span class="hljs-string">''</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>)) .ToList();</code> </pre> <br><p>  Outra coisa com a qual tive que lutar foi com uma discrep√¢ncia entre a maneira como o Python lida com os intervalos e os novos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">intervalos e √≠ndices</a> no pr√≥ximo C # 8, que descobri ao depurar minhas execu√ß√µes iniciais: no C # 8, o final do intervalo √© <b>inclusivo</b> , enquanto no Python √© <b>exclusivo</b> (para incluir o √∫ltimo elemento no Python, voc√™ deve omitir o lado direito da <i>..</i> express√£o). </p><br><blockquote>  H√° duas coisas dif√≠ceis na ci√™ncia da computa√ß√£o: invalida√ß√£o de cache, nomea√ß√£o de coisas e erros pontuais. </blockquote><br><p>  Infelizmente, a queda da fonte original n√£o continha nenhum treinamento ou c√≥digo de ajuste fino, mas <b>Neil Shepperd</b> forneceu um ajuste fino simples em seu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">GitHub</a> , que eu tamb√©m precisei portar.  De qualquer forma, o resultado desse esfor√ßo √© um <b>c√≥digo C #</b> , que pode ser usado <b>para jogar com o GPT-2</b> , agora faz parte do reposit√≥rio Gradient <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Samples</a> . </p><br><p>  O objetivo do exerc√≠cio de portabilidade √© duplo: ap√≥s a portabilidade, √© poss√≠vel <b>brincar com o c√≥digo do modelo em seu C # IDE favorito</b> e mostrar que <b>agora √© poss√≠vel obter modelos avan√ßados de aprendizado profundo trabalhando de maneira personalizada. Projetos .NET</b> logo ap√≥s o lan√ßamento (entre a queda de c√≥digo do GPT-2 e o primeiro lan√ßamento do Billion Songs - pouco mais de um m√™s). </p><br><h2>  Ajuste fino das letras das m√∫sicas </h2><br><p>  Existem v√°rias maneiras de obter um grande conjunto de letras de m√∫sicas.  Voc√™ pode raspar um dos sites da Internet que o hospeda com um analisador HTML, retir√°-lo da sua cole√ß√£o de karaok√™ ou arquivos mp3.  Felizmente, algu√©m fez isso por n√≥s.  Encontrei alguns conjuntos de dados de letras preparadas no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Kaggle</a> .  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Toda m√∫sica que voc√™ ouviu</a> " parecia ser a maior.  Tentando ajustar o GPT-2, enfrentei dois problemas. </p><br><h3>  Leitura CSV </h3><br><p>  Sim, voc√™ leu corretamente, a <i>an√°lise de CSV foi um problema</i> .  Inicialmente, eu queria usar o ML.NET, a nova biblioteca da Microsoft para aprendizado de m√°quina, para ler o arquivo.  No entanto, depois de percorrer a documenta√ß√£o e configur√°-la, percebi que ela falhou ao processar quebras de linha nas m√∫sicas corretamente.  N√£o importa o que eu fiz, ele lutou ap√≥s algumas centenas de exemplos e come√ßou a misturar trechos de letras com t√≠tulos e artistas. </p><br><p>  Ent√£o, tive que recorrer a uma biblioteca de n√≠vel inferior, com a qual eu j√° tinha uma experi√™ncia melhor: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">CsvHelper</a> .  Ele fornece uma interface semelhante ao <i>DataReader</i> .  Voc√™ pode ver o c√≥digo usando-o <a href="" rel="nofollow">aqui</a> .  Essencialmente, voc√™ abre um arquivo, configura um <i>CsvReader</i> e intercala a chamada em <i>.Read ()</i> com as chamadas em <i>.GetField (fieldName)</i> . </p><br><h3>  M√∫sicas curtas </h3><br><p>  A maioria das m√∫sicas √© curta em compara√ß√£o com um artigo m√©dio no conjunto de dados original usado pelo OpenAI.  O treinamento do GPT-2 √© mais eficiente em grandes partes de texto, ent√£o tive que agrupar v√°rias m√∫sicas em partes de texto cont√≠nuas para aliment√°-las ao treinador.  O OpenAI tamb√©m parecia usar essa t√©cnica; portanto, eles tinham um token especial <i>&lt;| endoftext |&gt;</i> , que atua como um separador entre textos completos em um peda√ßo e funciona como o token inicial.  Agrupei m√∫sicas at√© que um certo n√∫mero de fichas fosse alcan√ßado e, em seguida, retornei toda a parte para incluir nos dados do treinamento.  O c√≥digo relevante est√° <a href="" rel="nofollow">aqui</a> . </p><br><h3>  Requisitos de hardware para ajuste </h3><br><p>  Mesmo a vers√£o menor do GPT-2 √© grande.  Com 12 <b>GB de RAM da GPU,</b> eu <b>s√≥</b> podia <b>definir o tamanho do lote para 2</b> (por exemplo, treinar em dois blocos ao mesmo tempo, tamanhos maiores de lote melhoram o desempenho da GPU e os resultados do treinamento).  3 perderia <i>mem√≥ria</i> no CUDA.  E demorou meio dia para ajust√°-lo ao desempenho desejado no meu V100.  O b√¥nus √© que voc√™ pode ver o progresso, pois de vez em quando o c√≥digo de treinamento gera alguns exemplos gerados, que come√ßam como texto simples e simples e se parecem cada vez mais com letras de m√∫sicas √† medida que o treinamento avan√ßa. </p><br><p>  Eu n√£o tentei, mas o <b>treinamento na CPU provavelmente ser√° muito lento</b> . </p><br><h3>  Modelo pr√©-sintonizado </h3><br><p>  Enquanto eu preparava este post, percebi que seria melhor n√£o for√ßar todo mundo a passar horas ajustando o <b>modelo</b> das <b>letras</b> , ent√£o eu <b>lancei</b> um <b>pr√©-ajustado</b> no <a href="" rel="nofollow">reposit√≥rio</a> do <a href="" rel="nofollow">Billion Songs</a> .  Se voc√™ est√° apenas tentando executar bilh√µes de m√∫sicas, nem precisa fazer o download manualmente.  O projeto far√° isso por voc√™ por padr√£o. </p><br><div class="spoiler">  <b class="spoiler_title">modelo semi-treinado jogando HAL9000 em mim</b> <div class="spoiler_text">  Eu juro que devo escrever para voc√™ <br>  E eu juro, juro <br>  Voc√™ estragou tudo agora, espero que voc√™ fa√ßa <br>  E eu espero que o seu sonho, eu espero que voc√™ sonhe, eu espero que voc√™ sonhe Eu espero que voc√™ sonhe Eu espero que voc√™ sonhe com <br>  Sobre <br>  o que eu vou  Eu vou  Eu vou  Eu vou, vou, vou, vou, vou, vou, vou, <br>  Eu vou, eu vou, eu vou ... </div></div><br><h1>  Fazendo um site </h1><br><p>  OK!  Parece uma m√∫sica (mais ou menos), agora vamos criar um site! </p><br><p>  Como n√£o pretendo fornecer APIs, escolho o modelo Razor Pages em oposi√ß√£o ao MVC.  Tamb√©m ativei a autoriza√ß√£o, pois permitiremos que os usu√°rios votem nas melhores letras e tenham um gr√°fico das 10 melhores. </p><br><p>  Apressando o MVP, fui em frente e criei uma p√°gina da Web Song.cshtml, cujo objetivo no momento ser√° simplesmente chamar o GPT-2 e obter uma m√∫sica aleat√≥ria.  O layout da p√°gina √© trivial e basicamente consiste na m√∫sica e seu t√≠tulo: </p><br><pre> <code class="xml hljs">@page "/song/{id}" @model BillionSongs.Pages.SongModel<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> @{ ViewData["Title"] = @Model.Song.Title ?? "Untitled"; } <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">article</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-align: center"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>@(Model.Song.Title ?? "Untitled")<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span>@Model.Song.Lyrics<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">article</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><p>  Agora, como gosto do meu c√≥digo reutiliz√°vel, criei uma interface que me permitir√° conectar diferentes geradores de letras posteriormente, que ser√£o injetados pelo ASP.NET no SongModel. </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">ILyricsGenerator</span></span> { <span class="hljs-function"><span class="hljs-function">Task&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateLyrics</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">uint</span></span></span></span><span class="hljs-function"><span class="hljs-params"> song, CancellationToken cancellation</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><p>  Omitindo o t√≠tulo da m√∫sica por enquanto, tudo o que precisamos fazer √© registrar o <i>Gpt2LyricsGenerator</i> na <i>Inicializa√ß√£o, configurar os Servi√ßos</i> e cham√°-lo no <i>SongModel</i> .  Ent√£o, vamos come√ßar o gerador.  E a primeira coisa que precisamos garantir √© que temos </p><br><h2>  Gera√ß√£o de letras repet√≠veis </h2><br><p>  Porque eu fiz uma declara√ß√£o ousada no t√≠tulo, que ser√° mais de 1 bilh√£o de m√∫sicas, nem pense em gerar e armazenar todas elas.  Primeiro, sem nenhum metadado, isso levaria sozinho mais de 1 TB de espa√ßo em disco.  Segundo, leva ~ 3 minutos no meu nettop para gerar uma nova m√∫sica, por isso levar√° uma eternidade para gerar todas elas.  E eu quero poder transformar esse bilh√£o em um quintilh√£o, mudando para <i>Int64,</i> se necess√°rio!  Imagine que poder√≠amos fazer 1 centavo por m√∫sica, em 1 quintilh√£o de m√∫sicas?  Isso seria mais do que o atual PIB anual do mundo! </p><br><p>  Em vez disso, o que precisamos fazer √© garantir que o GPT-2 gere a mesma m√∫sica repetidas vezes, devido ao seu <i>ID</i> , que eu especifico na rota.  Para esse prop√≥sito, o TensorFlow permite definir a semente de seu gerador de n√∫meros interno a qualquer momento, atrav√©s da fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">tf.set_random_seed</a> , da seguinte forma: <i>tf.set_random_seed (songNumber)</i> .  Ent√£o, eu queria apenas chamar <i>Gpt2Sampler.SampleSequence</i> , para obter o texto da m√∫sica codificada, decodific√°-lo e retornar o resultado, concluindo assim <i>Gpt2LyricsGenerator</i> . </p><br><p>  Infelizmente, na primeira tentativa, isso n√£o funcionou como esperado.  Toda vez que eu pressionava o bot√£o de atualiza√ß√£o, um novo texto exclusivo era retornado na p√°gina.  Ap√≥s bastante depura√ß√£o, finalmente descobri que o TensorFlow 1.X tem problemas significativos com a reprodutibilidade: muitas opera√ß√µes t√™m estados internos, que n√£o s√£o afetados pelo <i>set_random_seed</i> e s√£o dif√≠ceis de serem redefinidos. </p><br><p>  A reinicializa√ß√£o das vari√°veis ‚Äã‚Äãdo modelo ajudou a compensar esse problema, mas tamb√©m significou que a sess√£o deve ser recriada e os pesos do modelo precisam ser recarregados a cada chamada.  Recarregar uma sess√£o desse tamanho causou um vazamento de mem√≥ria gigante.  Para evitar procurar sua causa no c√≥digo-fonte TensorFlow C ++, em vez de gerar gera√ß√£o de texto em processo, decidi iniciar um novo processo com <i>Process.Start</i> , gerar texto l√° e ler a partir da sa√≠da padr√£o.  At√© que uma maneira de redefinir o estado do modelo no TensorFlow seja estabilizada, esse seria o caminho a seguir. </p><br><p>  Ent√£o, acabei com duas classes: <a href="" rel="nofollow">Gpt2LyricsGenerator</a> , que implementa <i>ILyricsGenerator</i> de cima, gerando uma nova inst√¢ncia do BillionSongs.exe com par√¢metros de linha de comando, que incluem a identifica√ß√£o da m√∫sica, e eventualmente instancia o <a href="" rel="nofollow">Gpt2TextGenerator</a> , que na verdade chama GPT-2 para gerar letras, e simplesmente imprime. </p><br><p>  Agora, atualizar a p√°gina sempre me dava o mesmo texto. </p><br><h2>  Lidando com tempo de 3 minutos para gerar uma m√∫sica </h2><br><p>  Que experi√™ncia horr√≠vel para o usu√°rio seria!  Voc√™ acessa um site, clica em "Criar nova m√∫sica" e <b>absolutamente nada acontece por 3 (!) Minutos</b> enquanto meu nettop leva tempo para gerar as letras das m√∫sicas solicitadas. </p><br><p>  Eu resolvi esse problema em v√°rios n√≠veis: </p><br><h3>  Pregenerando m√∫sicas </h3><br><p>  Como mencionado acima, voc√™ n√£o pode gerar todas as m√∫sicas e servi-las a partir de um banco de dados.  E voc√™ n√£o pode simplesmente gerar sob demanda, porque isso √© lento.  Ent√£o o que voc√™ pode fazer? </p><br><p>  Simples!  Como a maneira principal para os usu√°rios verem uma nova m√∫sica √© clicar no bot√£o "Tornar aleat√≥rio", vamos gerar muitas m√∫sicas com anteced√™ncia, coloc√°-las em um <i>ConcurrentQueue</i> e deixar que "Torne aleat√≥rias" pop.  Embora o n√∫mero de visitantes seja baixo, o servidor levar√° algum tempo entre eles para gerar algumas m√∫sicas, que ser√£o prontamente acess√≠veis. </p><br><p>  Outro truque que usei √© fazer um loop nessa fila v√°rias vezes, para que muitos usu√°rios possam ver a mesma m√∫sica pr√©-gerada.  Basta manter um equil√≠brio entre o uso da RAM e quantas vezes um usu√°rio precisa clicar em "Tornar aleat√≥rio" para ver algo que j√° viu antes.  Simplesmente escolhi 50.000 m√∫sicas como um n√∫mero razo√°vel, o que consumiria apenas 50 MB de RAM, al√©m de fornecer um n√∫mero bastante grande de cliques. </p><br><p>  Eu implementei essa funcionalidade na classe <a href="" rel="nofollow">PregeneratedSongProvider</a> : <i>IRandomSongProvider</i> (a interface √© injetada no c√≥digo, respons√°vel por manipular o bot√£o "Tornar aleat√≥rio"). </p><br><h3>  Armazenamento em cache </h3><br><p>  M√∫sicas pr√©-geradas s√£o armazenadas em cache na mem√≥ria, mas tamb√©m defino o cabe√ßalho do <i>cache</i> HTTP como <i>p√∫blico</i> para permitir o navegador, e a CDN (eu uso o CloudFlare) armazena em cache para evitar ser atingido por um influxo de usu√°rio. </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ResponseCache(VaryByHeader = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"User-Agent"</span></span></span><span class="hljs-meta">, Duration = 3*60*60)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SongModel</span></span>: <span class="hljs-title"><span class="hljs-title">PageModel</span></span> { ‚Ä¶ }</code> </pre><br><h3>  Retornando m√∫sicas populares </h3><br><p>  A maioria das m√∫sicas geradas pelo GPT-2 afinado dessa maneira √© bastante mon√≥tona, se n√£o rudimentar.  Para tornar os cliques em "Tornar aleat√≥rio" mais atraentes, adicionei uma probabilidade de 25% de que, em vez de uma m√∫sica completamente aleat√≥ria, voc√™ obter√° uma m√∫sica que foi previamente votada por outros usu√°rios.  Al√©m de aumentar o envolvimento, aumenta a chance de voc√™ solicitar uma m√∫sica, armazenada em cache na CDN ou na mem√≥ria. </p><br><p>  Todos os truques acima s√£o conectados usando a inje√ß√£o de depend√™ncia do ASP.NET na classe <a href="" rel="nofollow">Startup</a> . </p><br><h2>  Vota√ß√£o </h2><br><p>  N√£o h√° muito especial sobre a implementa√ß√£o da vota√ß√£o.  Existe o <a href="" rel="nofollow">SongVoteCache</a> , que mant√©m as contagens atualizadas.  E um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">iframe que hospeda o bot√£o de vota√ß√£o</a> s na p√°gina da m√∫sica, que permite que a parte essencial da p√°gina - o t√≠tulo e a letra sejam armazenados em cache, enquanto a contagem de votos e o status do login s√£o carregados posteriormente. </p><br><h1>  Os resultados finais </h1><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/aw/c7/wf/awc7wfzablt9gotcrrv8nsihrvu.png" alt="Amostra de m√∫sica gerada"></a> <br></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">Uma vers√£o demo</a> em execu√ß√£o no <s>meu nettop, liderada pelo CloudFlare (com folga, seu Core i3)</s> agora congelada e movida para o n√≠vel gratuito do Servi√ßo de Aplicativo do Azure. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">O reposit√≥rio GitHub</a> , contendo c√≥digo fonte e instru√ß√µes para executar o site e ajustar o modelo. </p><br><h1>  Planos para o futuro / exerc√≠cios </h1><br><h2>  Gere t√≠tulos </h2><br><p>  O GPT-2 √© muito f√°cil de ajustar.  Pode-se gerar t√≠tulos de m√∫sicas anexando ou sufixando todas as amostras de letras do conjunto de dados com um token artificial como <i>&lt;| startoftitle |&gt;</i> , seguido pelo t√≠tulo do mesmo conjunto de dados. </p><br><p>  Como alternativa, os usu√°rios podem sugerir e / ou votar em t√≠tulos. </p><br><h2>  Gere m√∫sica </h2><br><p>  No meio do desenvolvimento do Billion Songs, achei que seria legal baixar um monte de arquivos MIDI (que √© um formato de m√∫sica antigo, muito mais pr√≥ximo do texto do que mp3s) e treinar o GPT-2 para gerar mais .  Alguns desses arquivos ainda tinham texto incorporado, para que <b>voc√™ pudesse obter a gera√ß√£o de karaok√™</b> . </p><br><p>  Eu sei que a gera√ß√£o de m√∫sicas dessa maneira √© muito poss√≠vel, porque ontem a <b>OpenAI realmente publicou uma implementa√ß√£o dessa ideia</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">em seu blog</a> .  Mas, hooray, <b>eles n√£o fizeram o karaok√™!</b>  Eu descobri que √© poss√≠vel raspar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">http://www.midi-karaoke.info</a> para esse fim. </p><br><h2>  Gradiente, tamb√©m conhecido como TensorFlow for .NET </h2><br>  Por favor, consulte o nosso <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" rel="nofollow">blog</a> para obter atualiza√ß√µes. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt453232/">https://habr.com/ru/post/pt453232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt453216/index.html">Sistemas de monitoramento de tr√°fego em redes VoIP. Parte Dois - Princ√≠pios da Organiza√ß√£o</a></li>
<li><a href="../pt453218/index.html">A principal coisa com o YaC 2019: cem drones nas estradas, Yandex.Module, food, smart home</a></li>
<li><a href="../pt453220/index.html">13 erros de marketing por e-mail a serem evitados para melhor engajamento</a></li>
<li><a href="../pt453222/index.html">SuperJob do SphinxSearch-meetup</a></li>
<li><a href="../pt453228/index.html">Rel√≥gio Nixie nos indicadores IN-18</a></li>
<li><a href="../pt453234/index.html">Engenharia reversa do protocolo de troca em equipamentos EOS</a></li>
<li><a href="../pt453236/index.html">Prototipar um jogo para celular, por onde come√ßar e como faz√™-lo. Parte 2</a></li>
<li><a href="../pt453238/index.html">Luzes de marcha no rel√©</a></li>
<li><a href="../pt453242/index.html">Playground para eventos de ver√£o</a></li>
<li><a href="../pt453246/index.html">ERP - Sistema de Degrada√ß√£o Cont√≠nua</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>