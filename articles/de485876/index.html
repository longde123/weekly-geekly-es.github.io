<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÇ üòô ‚óÄÔ∏è Wir beschleunigen OpenVPN auf dem Openwrt-Router. Alternative Version ohne L√∂tkolben und harten Extremismus üåó ü•´ üíÜüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo allerseits, ich habe k√ºrzlich einen langj√§hrigen Artikel dar√ºber gelesen, wie man OpenVPN auf einem Router beschleunigt und die Verschl√ºsselung ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir beschleunigen OpenVPN auf dem Openwrt-Router. Alternative Version ohne L√∂tkolben und harten Extremismus</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/485876/"><img src="https://habrastorage.org/webt/ua/za/wl/uazawliq9mctkaeu0sra7g-_y8y.jpeg"><br><br>  Hallo allerseits, ich habe k√ºrzlich einen <a href="https://habr.com/ru/post/368735/">langj√§hrigen Artikel</a> dar√ºber gelesen, wie man OpenVPN auf einem Router beschleunigt und die Verschl√ºsselung auf eine separate Hardware √ºbertr√§gt, die im Router selbst verl√∂tet ist.  Ich habe einen √§hnlichen Fall mit dem Autor: TP-Link WDR3500 mit 128 Megabyte RAM und einem schlechten Prozessor, der die Tunnelverschl√ºsselung nicht bew√§ltigen kann.  Allerdings wollte ich unbedingt nicht mit einem L√∂tkolben in den Router klettern.  Meine Erfahrung mit der Verlagerung von OpenVPN auf eine separate Hardware mit Redundanz auf einem Router im Falle eines Unfalls. <br><a name="habracut"></a><br><h3>  Herausforderung </h3><br>  Es gibt einen TP-Link WDR3500 Router und Orange Pi Zero H2.  Wir m√∂chten, dass Orange Pi die Verschl√ºsselung von Tunneln im normalen Modus durchf√ºhrt. Wenn ihm etwas passiert, kehrt die VPN-Verarbeitung zum Router zur√ºck.  Alle Firewall-Einstellungen auf dem Router sollten wie zuvor funktionieren.  Im Allgemeinen sollte das Hinzuf√ºgen zus√§tzlicher Hardware f√ºr alle transparent und unsichtbar sein.  OpenVPN arbeitet √ºber TCP, den TAP-Adapter im Bridge-Modus (Server-Bridge). <br><br><h3>  L√∂sung </h3><br>  Anstatt √ºber USB anzuschlie√üen, habe ich mich entschlossen, einen Port des Routers auszugeben und alle Subnetze, auf denen sich eine VPN-Br√ºcke befindet, auf dem Orange Pi abzurufen.  Es stellt sich heraus, dass das Eisenst√ºck physisch in denselben Netzwerken h√§ngt wie der VPN-Server auf dem Router.  Danach erh√∂hen wir genau dieselben Server auf den Orange Pi und konfigurieren eine Art Proxy auf dem Router, sodass alle eingehenden Verbindungen an den externen Server gesendet werden. Wenn der Orange Pi tot oder nicht verf√ºgbar ist, dann an den internen Fallback-Server.  Ich habe HAProxy genommen. <br><br>  Es stellt sich so heraus: <br><br><ol><li>  Kunde kommt </li><li>  Wenn der externe Server nicht verf√ºgbar ist, wird die Verbindung wie zuvor zum internen Server hergestellt </li><li>  Sofern verf√ºgbar, akzeptiert der Kunde Orange Pi </li><li>  VPN auf Orange Pi entschl√ºsselt Pakete und gibt sie an den Router zur√ºck </li><li>  Der Router leitet sie irgendwo hin </li></ol><br><h3>  Implementierungsbeispiel </h3><br>  Lassen Sie uns also zwei Netzwerke auf dem Router haben - main (1) und guest (2). F√ºr jedes von ihnen gibt es einen OpenVPN-Server f√ºr die Verbindung von au√üen. <br><br><h4>  Netzwerkkonfiguration </h4><br>  Wir m√ºssen beide Netzwerke √ºber einen Port weiterleiten, daher erstellen wir 2 VLAN'a. <br><br>  Erstellen Sie auf dem Router im Bereich "Netzwerk / Switch" VLANs (z. B. 1 und 2) und aktivieren Sie diese im Tag-Modus auf dem gew√ºnschten Port. F√ºgen Sie die neu erstellten eth0.1 und eth0.2 zu den entsprechenden Netzwerken hinzu (z. B. Add to Brigde). <br><br>  Wir erstellen zwei VLAN-Schnittstellen auf dem Orange Pi (ich habe Archlinux ARM + netctl): <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / vlan-main</b> <div class="spoiler_text"><pre><code class="plaintext hljs">Description='Main VLAN on eth0' Interface=vlan-main Connection=vlan BindsToInterfaces=eth0 VLANID=1 IP=no</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / vlan-guest</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Description='Guest VLAN on eth0' Interface=vlan-guest Connection=vlan BindsToInterfaces=eth0 VLANID=2 IP=no</code> </pre></div></div><br>  Und sofort schaffen wir zwei Br√ºcken f√ºr sie: <br><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / br-main</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Description="Main Bridge connection" Interface=br-main Connection=bridge BindsToInterfaces=(vlan-main) IP=dhcp</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">/ etc / netctl / br-guest</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Description="Guest Bridge connection" Interface=br-guest Connection=bridge BindsToInterfaces=(vlan-guest) IP=dhcp</code> </pre></div></div><br>  Wir aktivieren den Autostart f√ºr alle 4 Profile (netctl enable).  Nach einem Neustart bleibt der Orange Pi nun in den beiden erforderlichen Netzwerken h√§ngen.  Die Schnittstellenadressen auf Orange Pi werden in Static Leases auf dem Router konfiguriert. <br><br><div class="spoiler">  <b class="spoiler_title">IP-Adresse anzeigen</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">4: vlan-main@eth0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-main state UP group default qlen 1000 link/ether 02:42:f0:f8:23:c8 brd ff:ff:ff:ff:ff:ff inet6 fe80::42:f0ff:fef8:23c8/64 scope link valid_lft forever preferred_lft forever 5: vlan-guest@eth0: &lt;BROADCAST,MULTICAST,PROMISC,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-guest state UP group default qlen 1000 link/ether 02:42:f0:f8:23:c8 brd ff:ff:ff:ff:ff:ff inet6 fe80::42:f0ff:fef8:23c8/64 scope link valid_lft forever preferred_lft forever 6: br-main: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether 52:c7:0f:89:71:6e brd ff:ff:ff:ff:ff:ff inet 192.168.1.3/24 brd 192.168.1.255 scope global dynamic noprefixroute br-main valid_lft 29379sec preferred_lft 21439sec inet6 fe80::50c7:fff:fe89:716e/64 scope link valid_lft forever preferred_lft forever 7: br-guest: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000 link/ether ee:ea:19:31:34:32 brd ff:ff:ff:ff:ff:ff inet 192.168.2.3/24 brd 192.168.2.255 scope global br-guest valid_lft forever preferred_lft forever inet6 fe80::ecea:19ff:fe31:3432/64 scope link valid_lft forever preferred_lft forever</code> </pre></div></div><br><h4>  VPN-Einrichtung </h4><br>  Kopieren Sie anschlie√üend die Einstellungen f√ºr OpenVPN und die Schl√ºssel vom Router.  Einstellungen finden Sie normalerweise in <i>/tmp/etc/openvpn*.conf</i> <br><br>  Standardm√§√üig wird openvpn im TAP-Modus ausgef√ºhrt und die Schnittstelle von server-bridge bleibt inaktiv.  Damit dies funktioniert, m√ºssen Sie ein Skript hinzuf√ºgen, das ausgef√ºhrt wird, wenn die Verbindung aktiviert wird. <br><br><div class="spoiler">  <b class="spoiler_title">/etc/openvpn/main.conf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">dev vpn-main dev-type tap client-to-client persist-key persist-tun ca /etc/openvpn/main/ca.crt cert /etc/openvpn/main/main.crt cipher AES-256-CBC comp-lzo yes dh /etc/openvpn/main/dh2048.pem ifconfig-pool-persist /etc/openvpn/ipp_main.txt keepalive 10 60 key /etc/openvpn/main/main.key port 443 proto tcp push "redirect-gateway" push "dhcp-option DNS 192.168.1.1" server-bridge 192.168.1.3 255.255.255.0 192.168.1.200 192.168.1.229 status /tmp/openvpn.main.status verb 3 setenv profile_name main script-security 2 up /etc/openvpn/vpn-up.sh</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">/etc/openvpn/vpn-up.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/sh ifconfig vpn-${profile_name} up brctl addif br-${profile_name} vpn-${profile_name}</span></span></code> </pre></div></div><br>  Sobald die Verbindung hergestellt ist, wird die VPN-Hauptschnittstelle zu br-main hinzugef√ºgt.  F√ºr das Gast-Grid gilt das Gleiche bis zum Schnittstellennamen und der Adresse in der Server-Bridge. <br><br><h4>  Routing au√üerhalb und Proxy anfordern </h4><br>  In diesem Schritt ist Orange Pi bereits in der Lage, Verbindungen anzunehmen und Clients in die erforderlichen Netzwerke zuzulassen.  Das Proxying eingehender Verbindungen auf dem Router muss noch konfiguriert werden. <br><br>  Wir √ºbertragen die Router-VPN-Server auf andere Ports, setzen sie auf den HAProxy-Router und konfigurieren: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/haproxy.cfg</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">global maxconn 256 uid 0 gid 0 daemon defaults retries 1 contimeout 1000 option splice-auto listen guest_vpn bind :444 mode tcp server 0-orange 192.168.2.3:444 check server 1-local 127.0.0.1:4444 check backup listen main_vpn bind :443 mode tcp server 0-orange 192.168.1.3:443 check server 1-local 127.0.0.1:4443 check backup</code> </pre></div></div><br><h4>  Genie√üen </h4><br>  Wenn alles nach Plan lief, fahren die Kunden zu Orange Pi, und der Prozessor des Routers heizt nicht mehr auf, und die VPN-Geschwindigkeit wird erheblich erh√∂ht.  In diesem Fall bleiben alle auf dem Router registrierten Netzwerkregeln relevant.  Im Falle eines Unfalls auf Orange Pi f√§llt es ab und HAProxy wickelt Clients auf lokalen Servern ab. <br><br>  Vielen Dank f√ºr Ihre Aufmerksamkeit, Vorschl√§ge und Korrekturen sind willkommen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de485876/">https://habr.com/ru/post/de485876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de485862/index.html">DDoS von der Kaffeemaschine</a></li>
<li><a href="../de485866/index.html">Integration der Zimbra Open-Source Edition mit dem Enterprise Portal</a></li>
<li><a href="../de485870/index.html">Gibt es ein GameDev in Sachalin? 2.V</a></li>
<li><a href="../de485872/index.html">Logistische Regression kauen</a></li>
<li><a href="../de485874/index.html">Das Buch ‚ÄûLearning Python: Spielprogrammierung, Datenvisualisierung, Webanwendungen. 3rd ed.</a></li>
<li><a href="../de485878/index.html">Eine Abfolge von Schritten zur Organisation des Management Accounting auf der JetCalc-Plattform</a></li>
<li><a href="../de485884/index.html">So richten Sie das chinesische Levitron ein</a></li>
<li><a href="../de485886/index.html">Wie (und warum) man die Schl√ºssel und Anzeigen der Mitbewerber von Yandex.Direct und Google Ads kostenlos parst</a></li>
<li><a href="../de485888/index.html">F√§lschung von Serveranforderungen, blinder SSRF-Betrieb</a></li>
<li><a href="../de485892/index.html">Das Ende der Trident-√Ñra</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>