<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèΩ üë®üèæ‚Äçüè≠ üç† Adaptador PPM a USB en STM32F3 Discovery, o conectamos la consola del modelo de avi√≥n a la computadora como un joystick HID con STM32Cube ‚òùüèø üë©‚Äç‚öñÔ∏è üë©üèæ‚Äçü§ù‚Äçüë©üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo te dir√© c√≥mo:
 

- Cree un proyecto en STM32CubeMX y configure temporizadores para capturar se√±ales externas. 
- Decodifica una se√±al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Adaptador PPM a USB en STM32F3 Discovery, o conectamos la consola del modelo de avi√≥n a la computadora como un joystick HID con STM32Cube</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/384813/"><img src="https://habrastorage.org/files/42a/e17/45b/42ae1745bcc442529f2839504fdf51f4.jpg"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En este art√≠culo te dir√© c√≥mo:</font></font><br>
<ul>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cree un proyecto en STM32CubeMX y configure temporizadores para capturar se√±ales externas. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decodifica una se√±al PPM de una consola modelo de avi√≥n. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cree un dispositivo de interfaz humana en STM32 y escriba su descriptor de informe HID. </font></font></li>
<li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vuela en un simulador en un quadrocopter de carreras. </font><font style="vertical-align: inherit;">:)</font></font></li>
</ul><a name="habracut"></a><br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prefacio</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Recientemente, las carreras de FPV en quadrocopters de la clase 250 (FPV - First Person View) est√°n ganando cada vez m√°s popularidad. </font><font style="vertical-align: inherit;">El n√∫mero 250 significa la distancia entre los ejes de los motores en diagonal, t√≠pica de peque√±os helic√≥pteros maniobrables. </font><font style="vertical-align: inherit;">Dichos dispositivos est√°n construidos sobre cuadros de carbono duraderos que resisten ca√≠das y colisiones. </font><font style="vertical-align: inherit;">Las h√©lices con un di√°metro de 5-6 pulgadas con un gran paso (√°ngulo de inclinaci√≥n de las palas) se colocan en motores potentes para el vuelo m√°s din√°mico. </font><font style="vertical-align: inherit;">La imagen de la videoc√°mara con rumbo anal√≥gico se transmite a una frecuencia de 5.8 GHz al monitor o las gafas de video del piloto. </font><font style="vertical-align: inherit;">Dado que la transmisi√≥n digital a trav√©s de WiFi crea un largo retraso (200-300 ms), el video siempre se transmite en un canal anal√≥gico. </font><font style="vertical-align: inherit;">Para grabar clips espectaculares, se colocan c√°maras de acci√≥n (GoPro, Mobius, SJcam, Xiaomi Yi, etc.).</font></font><br>
<br>
<div style="text-align:center;"><img width="40%" src="https://habrastorage.org/files/727/722/0e5/7277220e5a8c4b749415d16d28091648.jpg"></div><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay algunos videos interesantes sobre los helic√≥pteros FPV:</font></font></b><div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/NsxyV-kgfio%3Ffeature%3Doembed&amp;usg=ALkJrhjxlYVUn1xrr-dDoujd4sEKxXqk5g" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/1MBW8zoZUR4%3Ffeature%3Doembed&amp;usg=ALkJrhgt1soq3QCd31ki49jsmSihEK6r_Q" frameborder="0" allowfullscreen=""></iframe><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/70pusNNunMA%3Ffeature%3Doembed&amp;usg=ALkJrhitZt7wVZIvWCJINNusRARnvaTtzQ" frameborder="0" allowfullscreen=""></iframe></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de construir mi mini quadrocopter, quer√≠a volar en un simulador y ver si me interesar√≠an las carreras de FPV. Para el entrenamiento, el simulador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">FPV FreeRider</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es muy adecuado </font><font style="vertical-align: inherit;">. Es econ√≥mico, tiene una versi√≥n demo gratuita y, seg√∫n pilotos experimentados, imita con mucha precisi√≥n la mec√°nica real del vuelo.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Puede controlar la aeronave en el simulador desde el teclado o desde el joystick. El teclado no es adecuado para el pilotaje, ya que los botones solo pueden transmitir un valor discreto (el bot√≥n se presiona / no se presiona) y es imposible transmitir valores intermedios que var√≠an suavemente. Los joysticks de las consolas de juegos con dispositivos anal√≥gicos son mucho mejores, pero tienen un dispositivo muy peque√±o, que no le permite controlar el dispositivo con la suficiente precisi√≥n. Una opci√≥n ideal para un simulador es una consola modelo de avi√≥n conectada a una computadora a trav√©s de un adaptador especial, gracias al cual el sistema operativo lo ve como un joystick.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya ten√≠a un quadrocopter, ensamblado para vuelos pausados ‚Äã‚Äãy fotograf√≠a, pero demasiado grande y pesado para competir. En consecuencia, hab√≠a un control remoto: Turnigy 9X (en la primera ilustraci√≥n). En la parte posterior, tiene un conector para conectar un adaptador al que se emite una se√±al PPM. Esta se√±al es un pulso corto con intervalos de 1 a 2 milisegundos, cuya duraci√≥n corresponde a la posici√≥n de los controles (m√°s sobre esto en la secci√≥n sobre decodificaci√≥n).</font></font><br>
<br>
<div style="text-align:center;"><img width="33%" src="https://habrastorage.org/files/68b/cc1/4f0/68bcc14f02164d51a17401da82253df4.jpg"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Debo decir que los adaptadores para conectar el control remoto de PPM a USB se han lanzado durante mucho tiempo y se venden con poder y principal. </font><font style="vertical-align: inherit;">Se puede comprar un adaptador similar en el formato de unidad flash por $ 5 en China o un poco m√°s caro en las tiendas rusas. </font><font style="vertical-align: inherit;">Tambi√©n hay </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proyectos de</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> adaptadores de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">c√≥digo abierto</font></a><font style="vertical-align: inherit;"> en los controladores AVR. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Pero un agudo deseo de volar me lleg√≥ de inmediato al anochecer, cuando todas las tiendas de modelos de aviones de Mosc√∫ ya estaban cerradas. </font><font style="vertical-align: inherit;">No quer√≠a esperar en la ma√±ana, no hab√≠a tiempo para envenenar y soldar la placa con ATmega, as√≠ que decid√≠ hacer un adaptador PPM-USB en la placa de descubrimiento STM32F3, que hab√≠a estado inactiva durante mucho tiempo y estaba a mano.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Qu√© se necesita</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para hacer un adaptador, necesitar√°:</font></font><br>
<br>
<ul>
<li> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">STM32F3Discovery</a>.     STM32,     USB,   . </li>
<li>  c - 3,5     ( Turnigy)   BLS-,   ,   ( Discovery).</li>
<li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">STM32CubeMX</a>. </li>
<li>IDE    ARM.   <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Keil uVision 5</a>.          32 ,      .</li>
<li> Turnigy 9X     PPM-.       FlySky FS-i6.</li>
</ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las placas de depuraci√≥n de descubrimiento son bastante caras. </font><font style="vertical-align: inherit;">El F3 descrito cuesta alrededor de $ 20 y sus capacidades son redundantes para un proyecto tan simple. </font><font style="vertical-align: inherit;">Lo us√© porque al momento de escribir esta era la √∫nica placa con hardware USB que encontr√© en casa. </font><font style="vertical-align: inherit;">Para aquellos que a√∫n no lo han comprado, puedo aconsejarles que presten atenci√≥n a las placas en miniatura con el controlador </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F103C8T6 de AliExpress por $ 3</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y el programador ST-Link desde all√≠. </font><font style="vertical-align: inherit;">El proceso no difiere del descrito en el art√≠culo. </font><font style="vertical-align: inherit;">A menos que sea necesario elegir otro controlador al principio, indique la presencia de un resonador de cuarzo y use un pinout ligeramente diferente.</font></font><br>
<br>
<div style="text-align:center;"><img width="30%" src="https://habrastorage.org/files/cf1/88d/0a1/cf188d0a1da94acfb233350ff94830ae.jpg"></div><br>
<br>
<a name="cube"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crear un proyecto en STM32CubeMX</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
STM32Cube es un paquete desarrollado por STMicroelectronics para facilitar la vida de los desarrolladores de dispositivos STM32. Consiste en la utilidad de gr√°ficos CubeMX, controladores HAL y componentes de middleware. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CubeMX</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es una herramienta para crear proyectos e inicializar perif√©ricos. Para comenzar, simplemente seleccione el controlador, marque las casillas de los m√≥dulos requeridos, seleccione los modos requeridos en el men√∫ e ingrese los valores deseados en varios campos. CubeMX generar√° el proyecto y le conectar√° las bibliotecas necesarias. El desarrollador del dispositivo solo escribir√° la l√≥gica de la aplicaci√≥n. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conductores HAL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(Capa de abstracci√≥n de hardware) es una API para trabajar con m√≥dulos y perif√©ricos del microcontrolador. HAL le permite separar la capa superior de la aplicaci√≥n que crea el desarrollador de trabajar con registros y hacer que el c√≥digo del programa sea lo m√°s port√°til posible entre las familias de controladores STM32. </font></font><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , o componentes intermedios, incluyen el sistema operativo FreeRTOS, una biblioteca para trabajar con el sistema de archivos, bibliotecas USB, TCP / IP, etc.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Parece que ahora es posible "programar con el mouse" en lugar de escribir bits manualmente en los registros. </font><font style="vertical-align: inherit;">Pero la simplicidad y la conveniencia no cancelan el hecho de que necesita estudiar la documentaci√≥n, especialmente en los casos en que necesita exprimir la velocidad m√°xima, el consumo m√≠nimo de energ√≠a o usar perif√©ricos en modos no est√°ndar. </font><font style="vertical-align: inherit;">STM32Cube a√∫n no cubre el 100% de todas las capacidades del microcontrolador, pero se est√° acercando a esto. </font><font style="vertical-align: inherit;">STMicroelectronics actualiza Cube de vez en cuando, extiende funciones y corrige errores. </font><font style="vertical-align: inherit;">Por lo tanto, si ya tiene Cube instalado, verifique que sea la √∫ltima versi√≥n.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajustes iniciales</font></font></b></h5><br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/acf/6b2/4fc/acf6b24fc6c449f58c2be3b9ce9d1c1e.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El trabajo con el proyecto comienza con la elecci√≥n del controlador. Inicie STM32CubeMX, haga clic en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nuevo proyecto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En la pesta√±a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selector MCU</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">puede seleccionar el controlador deseado de los filtros. Dado que tenemos una placa de depuraci√≥n terminada, en la pesta√±a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selector de placa</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , encontramos </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STM32F3Discovery</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Despu√©s de elegir una placa, aparecer√° una imagen del controlador con pines resaltados y firmados. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay cuatro pesta√±as grandes en la parte superior de la ventana: </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : para configurar funciones de pin y preajustar m√≥dulos. Estamos en ello en este momento. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n del</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reloj: configuraci√≥n del reloj, PLL, divisores. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : </font><i><font style="vertical-align: inherit;">configuraci√≥n</font></i><font style="vertical-align: inherit;"> m√°s detallada de perif√©ricos y middleware.</font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calculadora de consumo de energ√≠a</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : c√°lculo de la energ√≠a consumida por el microcontrolador. </font></font><br>
<br>
<img src="https://habrastorage.org/files/d02/a54/3a7/d02a543a7fe148d99d67ae83ad6a8fc9.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el men√∫ de la izquierda en la pesta√±a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">puede usar los perif√©ricos deseados, y en el circuito del controlador, seleccione una funci√≥n para cualquiera de las salidas del microcontrolador. Algunos elementos a la izquierda son iconos de advertencia. Esto significa que los m√≥dulos (en este caso ADC, DAC, OPAMP2, RTC) ahora se pueden usar de forma incompleta, ya que algunas de sus salidas ya est√°n ocupadas por otras funciones.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los pines configurados se resaltan en verde en el circuito del controlador. </font><font style="vertical-align: inherit;">Dado que elegimos no un controlador simple sin flejes, sino una placa de depuraci√≥n F3-Discovery lista para usar, algunas de las salidas ya est√°n configuradas, por ejemplo, un bot√≥n azul est√° conectado a PA0 y LED a PE8 ... 15. </font><font style="vertical-align: inherit;">Los pines a los que se conectan algunos dispositivos externos en Discovery se resaltan en naranja, pero los m√≥dulos perif√©ricos para ellos a√∫n no se han configurado. </font><font style="vertical-align: inherit;">Como puede ver, estos son pines para USB, resonadores de cuarzo, SPI e I2C para giroscopio y br√∫jula, DP y DM para USB. </font><font style="vertical-align: inherit;">Actualmente no se utilizan conclusiones grises, cualquiera de ellas podemos aplicar para nuestros fines.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selecci√≥n de entrada</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vamos a capturar la duraci√≥n de los pulsos, por lo que la entrada debe estar conectada a uno de los canales de cualquier temporizador. </font><font style="vertical-align: inherit;">Adem√°s, el nivel de se√±al con Turnigy 9X no es 3.3V, como el voltaje de alimentaci√≥n del STM32, sino 5V. </font><font style="vertical-align: inherit;">Somos demasiado vagos para soldar el divisor de voltaje, por lo que debe elegir una entrada que pueda soportar 5V (estas entradas se llaman tolerantes a 5V). </font><font style="vertical-align: inherit;">Los pines adecuados se pueden encontrar en la </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hoja</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">datos</font></a><font style="vertical-align: inherit;"> en STM32F303VCT6 en la secci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Descripci√≥n de pines y pines</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Hay muchos temporizadores en el STM32F3, se encuentran dispersos en casi todos los pines. </font><font style="vertical-align: inherit;">Una opci√≥n conveniente es PC6. </font><font style="vertical-align: inherit;">Puede soportar 5 voltios y se encuentra en la esquina inferior izquierda de la placa, al lado de GND. </font><font style="vertical-align: inherit;">Asigne el primer canal del tercer temporizador TIM3_CH1 a este pin.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/eb7/4b2/67e/eb74b267e70140b9842408158de617e8.png"></div><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajuste del reloj</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para que el USB funcione, el microcontrolador debe sincronizarse a una frecuencia muy estable, por lo que casi todos los dispositivos USB tienen resonadores de cuarzo. La estabilidad de frecuencia del generador RC incorporado no es suficiente para USB. Pero en el tablero STM32F3 Discovery, los desarrolladores por alguna raz√≥n eran codiciosos y no pusieron cuarzo. Sin embargo, si estudia cuidadosamente el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">circuito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , puede ver que la </font><font style="vertical-align: inherit;">se√±al </font><i><font style="vertical-align: inherit;">MCO</font></i><font style="vertical-align: inherit;"> est√° conectada </font><font style="vertical-align: inherit;">a la entrada </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PF0-OSC_IN</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , donde debe conectarse el cuarzo </font><font style="vertical-align: inherit;">. Proviene del programador ST-Link en la misma placa en la que hay cuarzo. El </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Manual del usuario</font></a><font style="vertical-align: inherit;"> para F3 Discovery (UM1570) en la secci√≥n </font><i><font style="vertical-align: inherit;">Reloj OSC</font></i><font style="vertical-align: inherit;"> dice que se est√°n </font><font style="vertical-align: inherit;">enviando </font><font style="vertical-align: inherit;">8 MHz a esta l√≠nea.</font></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"></font></i><font style="vertical-align: inherit;"></font><br>
<br>
<img width="30%" src="https://habrastorage.org/files/b5c/234/80f/b5c23480ffca498d8e52e6fef4c0892f.png"><img width="65%" src="https://habrastorage.org/files/c00/160/fb8/c00160fb809b4c7190390d8a8ccd3ac6.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Por lo tanto, el microcontrolador se sincroniza desde una fuente externa. Este modo se llama Bypass. En el men√∫ de configuraci√≥n perif√©rica en la secci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">RCC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">para marcar el reloj de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">alta velocidad,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seleccione </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">BYPASS Clock Source</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/934/7e5/17e/9347e517e21540a88c922d35d881c009.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de proceder a una configuraci√≥n de reloj m√°s detallada, notamos en el men√∫ perif√©rico que el microcontrolador actuar√° como un dispositivo USB. </font></font><br>
<br>
<img src="https://habrastorage.org/files/597/c20/ddb/597c20ddbe2e4c2898c90db97110e454.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora puede ir a la siguiente pesta√±a grande: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n del reloj</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Aqu√≠ veremos un gran diagrama que muestra qu√© se√±ales de reloj est√°n presentes en el microcontrolador, de d√≥nde provienen, c√≥mo se ramifican, multiplican y dividen. En amarillo, destaqu√© los par√°metros que deben tenerse en cuenta. </font></font><br>
<br>
<img src="https://habrastorage.org/files/1a5/9a8/596/1a59a8596d434c1f8d09ee5e8335adee.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compruebe que la frecuencia de entrada</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La frecuencia de entrada</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es de 8 MHz. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Configuramos el interruptor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL Source Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HSE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (High Speed ‚Äã‚ÄãExternal) para que registre desde una fuente externa en lugar de una fuente interna. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLL</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : Phase Lock Loop, o </font><i><font style="vertical-align: inherit;">PLL</font></i><font style="vertical-align: inherit;"> : Phase Lock Loop, sirve para multiplicar la frecuencia externa varias veces. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Establezca el</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> multiplicador </font><i><font style="vertical-align: inherit;">PLLMul</font></i><font style="vertical-align: inherit;"> en 9. Luego alcanzaremos la frecuencia m√°xima posible para el STM32F303 - 72 MHz. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">System Clock Mux</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> debe estar en la posici√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PLLCLK para</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> que la frecuencia del reloj se multiplique con el PLL. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para el m√≥dulo USB, se necesitan 48 MHz, as√≠ que coloque un divisor de 1.5 frente al USB. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presta atenci√≥n a la frecuencia</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El temporizador APB1 registra</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> el lado izquierdo del circuito. </font><font style="vertical-align: inherit;">Va a los temporizadores y es √∫til para nosotros en el futuro. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si alguna frecuencia est√° configurada incorrectamente, excede el valor m√°ximo posible o los interruptores est√°n en una posici√≥n no v√°lida, entonces CubeMX resaltar√° este lugar en rojo.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ajuste del temporizador</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para medir la duraci√≥n del pulso, iniciaremos el temporizador TIM3 en modo Captura de entrada. En el </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Manual de referencia</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , en la secci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Temporizadores de uso general (TIM2 / TIM3 / TIM4),</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> hay un diagrama que ilustra el funcionamiento de los temporizadores. Con los colores, destaqu√© las se√±ales y los registros utilizados en el modo de captura de entrada. </font></font><br>
<br>
<img src="https://habrastorage.org/files/e76/54c/ea5/e7654cea52cb46c891e5a73e91068b71.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La se√±al de reloj resaltada en verde ingresa continuamente en el registro del contador CNT e incrementa su valor en 1 en cada ciclo de reloj. En el divisor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PSC Prescaler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , la </font><font style="vertical-align: inherit;">frecuencia </font><font style="vertical-align: inherit;">del </font><font style="vertical-align: inherit;">reloj puede disminuir para un conteo m√°s lento. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ingresa</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> una </font><font style="vertical-align: inherit;">se√±al externa </font><font style="vertical-align: inherit;">a </font><i><font style="vertical-align: inherit;">TIMx_CH1</font></i><font style="vertical-align: inherit;"> . </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Detector de borde</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reconoce los bordes de la se√±al de entrada: transiciones de 0 a 1 o de 1 a 0. Al registrar el borde, da dos comandos resaltados en amarillo: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- un comando para escribir el valor del contador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">registro de captura / comparaci√≥n 1 (CCR1)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llamada de</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interrupci√≥n </font><i><font style="vertical-align: inherit;">CC1I</font></i><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
- un comando para el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">controlador de modo Esclavo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mediante el cual el valor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CNT</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> se </font><font style="vertical-align: inherit;">restablece a 0 y la cuenta regresiva comienza nuevamente. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Aqu√≠ hay una ilustraci√≥n del proceso en una l√≠nea de tiempo:</font></font><br>
<br>
<img width="50%" src="https://habrastorage.org/files/3b5/80b/ab0/3b580bab0b894981b8d28eadd9f444b2.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando ocurre una interrupci√≥n, realizaremos acciones con el valor capturado. Si los pulsos de entrada llegan con demasiada frecuencia y las acciones que ocurren en el controlador de interrupciones son demasiado largas, entonces el valor de CCR1 puede sobrescribirse antes de leer el anterior. En este caso, debe verificar el indicador de sobrecaptura o aplicar DMA (Acceso directo a memoria) cuando los datos de CCR1 llenan autom√°ticamente la matriz preparada en la memoria. En nuestro caso, el pulso m√°s corto tiene una duraci√≥n de 1 milisegundo, y el controlador de interrupci√≥n ser√° simple y corto, as√≠ que no se preocupe por sobrescribir. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Regrese a la pesta√±a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pinout</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y configure el temporizador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TIM3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en el men√∫ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Peripherals</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br>
<img src="https://habrastorage.org/files/437/703/50b/43770350badf4efcb4d02a11ea2f9db0.png"><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Modo esclavo: modo de reinicio</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- significa que en alg√∫n evento el temporizador se restablecer√° a 0. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fuente de disparo: TI1FP1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - el evento utilizado para restablecer e iniciar el temporizador es el borde de la se√±al capturado desde la entrada TI1. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ClockSource: reloj interno</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : el temporizador se sincroniza desde el generador interno del microcontrolador. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Canal 1: Modo directo de captura de entrada:</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> captura los intervalos del primer canal en el registro CCR1. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la pr√≥xima pesta√±a de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> grande, </font><font style="vertical-align: inherit;">realizaremos configuraciones de temporizador adicionales.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/db8/b67/8d8/db8b678d8f7846c9af081a0bfdb0d7b1.png"></div><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/63b/6ac/c06/63b6acc06716451399d01566635d2f87.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Prescaler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es un divisor de temporizador. Si es 0, la frecuencia se toma directamente del reloj APB del bus de reloj - 72 MHz. Si el preescalador es 1, la frecuencia se divide por 2 y se convierte en 36 MHz. Establezca el divisor en 71 para que la frecuencia se divida entre 72. Luego, la frecuencia del temporizador ser√° de 1 MHz y los intervalos se medir√°n con una resoluci√≥n de 1 microsegundo. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Periodo de contador</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : establece el valor m√°ximo posible de 16 bits 0xFFFF. El per√≠odo es importante para generar intervalos de tiempo, por ejemplo, para PWM. Pero el per√≠odo no es importante para capturar se√±ales; haremos que se sepa que es grande para cualquier pulso de entrada. </font></font><br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Selecci√≥n de polaridad: borde descendente: los</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> valores del temporizador se capturar√°n en el borde descendente de la se√±al de entrada. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la pesta√±a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n de NVIC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">pon un daw</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interrupci√≥n global TIM3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , de modo que los eventos relacionados con el 3er temporizador generan una interrupci√≥n.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n del dispositivo USB</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ya hemos notado que el controlador ser√° un dispositivo USB. </font><font style="vertical-align: inherit;">Dado que el joystick pertenece a la clase de dispositivos HID, en el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">men√∫ Middlewares -&gt; USB_DEVICE,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> seleccione </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Class For FS IP: Human Interface Device Class (HID)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Luego, CubeMX conectar√° las bibliotecas para el dispositivo HID al proyecto. </font></font><br>
<br>
<img src="https://habrastorage.org/files/3fe/080/472/3fe0804729bd4b2f995c5f32a9173d47.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vayamos a la configuraci√≥n de </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USB_DEVICE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la pesta√±a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configuraci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la secci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Middlewares</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/574/ba7/dde/574ba7dde3794ce4911f955e628f7ce7.png"></div><br>
<br>
<i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La identificaci√≥n del proveedor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y la </font><i><font style="vertical-align: inherit;">identificaci√≥n del </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">producto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> son dos identificadores de 16 bits que son √∫nicos para cada modelo de dispositivo USB. VID corresponde al fabricante del dispositivo, y cada fabricante asigna PID, guiado por sus propias consideraciones. No pude encontrar la lista oficial de VID y PID, solo encontr√© </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">la base de identificadores</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> compatible con entusiastas. Para obtener su propia identificaci√≥n de proveedor, debe ir al Foro de implementadores USB en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usb.org</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y pagar unos pocos miles de d√≥lares. Las peque√±as empresas o los desarrolladores de c√≥digo abierto que no pueden pagar su VID pueden solicitar un fabricante de chips USB y recibir oficialmente un par VID / PID para su proyecto. Tal servicio es ofrecido, por ejemplo, por FTDI o Silicon Laboratories.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si conecta dos dispositivos con el mismo VID / PID, pero de un tipo diferente (por ejemplo, uno es un dispositivo HID y el otro es Almacenamiento masivo), el sistema operativo intentar√° instalar el mismo controlador para ellos, y al menos uno de ellos no trabajar√°. Es por eso que los pares VID / PID para diferentes modelos de dispositivos deben ser √∫nicos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como no estamos fabricando un dispositivo para nosotros, no lo vamos a vender y distribuir, dejaremos VID 0x0483, correspondiente a STMicroelectronics, y crearemos nuestro propio PID. Por defecto, CubeMX ofrece PID 0x5710 para el dispositivo HID. Reempl√°celo, por ejemplo, con 0x57FF. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Reemplace la </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cadena del producto</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> con el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">adaptador STM32 PPM-USB</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Este nombre aparecer√° en la lista de dispositivos en el Panel de control de Windows. Todav√≠a no cambiaremos el n√∫mero de serie (S \ N). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando Windows detecta que detecta un dispositivo con una combinaci√≥n de VID, PID y S \ N que no ha visto antes, el sistema instala el controlador apropiado para √©l. Si la combinaci√≥n de VID, PID y S \ N ya se ha utilizado, Windows sustituye autom√°ticamente el controlador utilizado anteriormente. Puede ver esto, por ejemplo, cuando conecta la unidad flash al USB. La primera vez que se conecta e instala toma algo de tiempo. En conexiones posteriores, la unidad comienza a funcionar casi instant√°neamente. Sin embargo, si conecta otra instancia de la unidad Flash del mismo modelo, pero con un n√∫mero de serie diferente, el sistema instalar√° un nuevo controlador, aunque tenga el mismo VID y PID.</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Explicar√© por qu√© esto es importante. </font><font style="vertical-align: inherit;">Si cre√≥ un mouse USB en su STM32 con su VID, PID y S \ N, lo conect√≥ a la computadora y luego hizo un joystick USB sin cambiar el VID, PID y S \ N, entonces Windows percibir√° el nuevo dispositivo como un mouse que ya utilizado en el sistema y no instalar√° el controlador de joystick. </font><font style="vertical-align: inherit;">En consecuencia, el joystick no funcionar√°. </font><font style="vertical-align: inherit;">Por lo tanto, si desea cambiar el tipo de su dispositivo, sin modificar el VID / PID, aseg√∫rese de cambiar su n√∫mero de serie.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generaci√≥n de proyectos para IDE</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La √∫ltima configuraci√≥n que debe realizar es la configuraci√≥n de generaci√≥n del proyecto. Esto se hace a trav√©s del </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proyecto -&gt; Configuraci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ... All√≠ estableceremos el nombre, la carpeta de destino y el IDE deseado, bajo el cual CubeMX crear√° el proyecto. Eleg√≠ </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MDK-ARM V5</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque uso Keil uVision 5. En la pesta√±a </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Generador de c√≥digo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , </font><font style="vertical-align: inherit;">puede marcar la </font><font style="vertical-align: inherit;">casilla </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Copiar solo los archivos de biblioteca necesarios</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para </font><font style="vertical-align: inherit;">no saturar el proyecto con archivos innecesarios. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Presione el bot√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proyecto -&gt; Generar c√≥digo</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . CubeMX crear√° un proyecto con c√≥digo que se puede abrir en Keil uVision y compilar y flashear sin configuraciones adicionales. En el archivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en la funci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main (void)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya se han insertado funciones para inicializar el reloj, los puertos, el temporizador y el USB. En ellos, los m√≥dulos del microcontrolador est√°n configurados de acuerdo con los modos que configuramos en CubeMX. </font></font><br>
<br>
<img src="https://habrastorage.org/files/fb6/a32/393/fb6a323933734c7cb3ac4e11550d7420.png"><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el c√≥digo, a menudo se encuentran construcciones de este tipo:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-comment">/* USER CODE BEGIN 0 */</span><font></font>
(...)<font></font>
<span class="hljs-comment">/* USER CODE END 0 */</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Se supone que el usuario incrustar√° su c√≥digo en estas secciones. Si la opci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conservar c√≥digo de usuario al volver a generar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> est√° habilitada en la configuraci√≥n del proyecto CubeMX </font><font style="vertical-align: inherit;">, el c√≥digo encerrado entre estas l√≠neas no se sobrescribir√° durante la generaci√≥n secundaria de un proyecto existente. Desafortunadamente, solo las secciones creadas por CubeMX se guardan. Secciones </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/ * C√ìDIGO DE USUARIO * /</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> creado por el usuario se perder√°n. Por lo tanto, si despu√©s de escribir el c√≥digo en el IDE desea volver a CubeMX y generar el proyecto nuevamente con la nueva configuraci√≥n, le recomiendo hacer una copia de seguridad del proyecto. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En la configuraci√≥n de firmware en uVision ( </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Configurar herramientas de Flash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ), le aconsejo que habilite la opci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Restablecer despu√©s de flash</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que el microcontrolador se inicie inmediatamente despu√©s de parpadear. </font><font style="vertical-align: inherit;">De forma predeterminada, est√° deshabilitado y, despu√©s de cada parpadeo, debe presionar el bot√≥n Restablecer en el tablero.</font></font><br>
<br>
<img src="https://habrastorage.org/files/1e1/a3d/20d/1e1a3d20dd994c1787f8a8758fcd200e.png"><br>
<br>
<a name="ppm"></a><h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Decodificaci√≥n PPM</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
PPM - Modulaci√≥n de posici√≥n de pulso: un m√©todo de codificaci√≥n de se√±ales transmitidas, muy extendido en la electr√≥nica de modelos de aviones. </font><font style="vertical-align: inherit;">Es una secuencia de pulsos, los intervalos de tiempo entre los cuales corresponden a los valores num√©ricos transmitidos.</font></font><br>
<br>
<div style="text-align:center;"><img width="80%" src="https://habrastorage.org/files/905/3ec/257/9053ec2573f8438b9a3053f2ef408739.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Seg√∫n este protocolo, la consola env√≠a informaci√≥n al m√≥dulo de transmisi√≥n de radio, que se inserta en la consola en la parte posterior. Muchos receptores que se colocan a bordo del helic√≥ptero pueden transmitir se√±ales de control para el controlador de vuelo a trav√©s de PPM. Adem√°s, casi cualquier consola tiene conectores para conectar una segunda consola en el modo entrenador-alumno y para conectar la consola a un simulador, que tambi√©n suele usar PPM. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Escribimos una se√±al desde la salida del simulador de Turnigy 9X con un analizador l√≥gico:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/53e/da5/319/53eda5319a6d45b59ee6e265de445992.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cada secuencia codifica el estado actual de los controles en el control remoto. Por lo general, los primeros cuatro valores (tambi√©n llamados canales) corresponden a la posici√≥n de los sticks anal√≥gicos, y los siguientes a la posici√≥n de los interruptores o potenci√≥metros. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La posici√≥n m√≠nima del control corresponde al intervalo 1000 Œºs, el m√°ximo - 2000 Œºs, la posici√≥n promedio - 1500 Œºs. Las r√°fagas de pulsos, o cuadros, est√°n separadas por intervalos sustancialmente m√°s largos y siguen con un per√≠odo de 20‚Äì25 ms. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Echemos un vistazo m√°s de cerca a la se√±al:</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/703/86d/84e/70386d84efe24577a958767f8c5b7ae9.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, tres palos est√°n en la posici√≥n neutral (1, 3, 4), y uno est√° en la posici√≥n extrema (2). </font><font style="vertical-align: inherit;">Tres interruptores de palanca est√°n apagados (5, 6, 7) y el √∫ltimo est√° encendido (8). </font><font style="vertical-align: inherit;">El microcontrolador, que act√∫a como un adaptador, debe capturar dicha secuencia, agregar los valores a una matriz y enviarla a trav√©s de USB como un comando desde el joystick. </font><font style="vertical-align: inherit;">Escribamos un decodificador de secuencia de pulsos.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Interrupci√≥n de captura</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de la inicializaci√≥n en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> antes del </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ciclo while</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> principal </font><i><font style="vertical-align: inherit;">,</font></i><font style="vertical-align: inherit;"> inicie el temporizador TIM3 en el modo de captura de captura de entrada desde el canal 1, con la generaci√≥n de interrupciones de captura. </font><font style="vertical-align: inherit;">Para hacer esto, use la funci√≥n correspondiente de HAL:</font></font><br>
<br>
<pre><code class="cpp hljs">HAL_TIM_IC_Start_IT(&amp;htim3, TIM_CHANNEL_1);
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La estructura </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">htim3</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> declarada en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es el controlador del temporizador TIM3, que contiene todas las estructuras y variables asociadas con el temporizador: par√°metros para la inicializaci√≥n, punteros a todos los registros del temporizador (valor de contador, divisor, todas las configuraciones, banderas de interrupci√≥n), puntero en un controlador DMA que funciona con este temporizador, etc. El desarrollador no necesita buscar qu√© bits en qu√© registro son responsables de qu√© y establecerlos y restablecerlos manualmente. Es suficiente pasar el controlador a la funci√≥n HAL. Las bibliotecas HAL har√°n el resto ellos mismos. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los principios de la estructura HAL se describen con m√°s detalle en el documento </font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;">Descripci√≥n de los controladores HAL STM32F3xx</font></a><font style="vertical-align: inherit;"> .</font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(UM1786). Cabe se√±alar que las propias bibliotecas HAL est√°n bien documentadas. Para comprender c√≥mo funciona el HAL para el temporizador y c√≥mo usarlo, puede leer los comentarios en los </font><i><font style="vertical-align: inherit;">archivos </font></i></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para cada interrupci√≥n que genera el temporizador TIM3, se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llama al</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> manejador </font><i><font style="vertical-align: inherit;">TIM3_IRQHandler</font></i><font style="vertical-align: inherit;"> . Se encuentra en el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_it.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> archivo </font><font style="vertical-align: inherit;">, en el que el </font><i><font style="vertical-align: inherit;">controlador de HAL_TIM_IRQHandler</font></i><font style="vertical-align: inherit;"> , est√°ndar para todos los contadores de tiempo, se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">llama</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en √©l, y un puntero a la estructura htim3 se pasa a ella.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">TIM3_IRQHandler</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span>
</span>{
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 0 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 0 */</span><font></font>
  HAL_TIM_IRQHandler(&amp;htim3);<font></font>
  <span class="hljs-comment">/* USER CODE BEGIN TIM3_IRQn 1 */</span><font></font>
<font></font>
  <span class="hljs-comment">/* USER CODE END TIM3_IRQn 1 */</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si nos fijamos en el interior </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HAL_TIM_IRQHandler</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> archivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">stm32f3xx_hal_tim.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , vemos un gran manipulador que los cheques de las banderas de interrupci√≥n de temporizador causas de devoluci√≥n de llamada de funci√≥n y borra la bandera despu√©s de la ejecuci√≥n. </font><font style="vertical-align: inherit;">Si se </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">produce</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> un evento de captura, llama a la funci√≥n </font><i><font style="vertical-align: inherit;">HAL_TIM_IC_CaptureCallback</font></i><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se parece a esto:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function">__weak <span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span>
</span>{
<span class="hljs-comment">/* NOTE : This function Should not be modified, when the callback is needed, the __HAL_TIM_IC_CaptureCallback could be implemented in the user file
*/</span><font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Esto significa que podemos anular esta funci√≥n en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Por lo tanto, inserte </font><font style="vertical-align: inherit;">esta devoluci√≥n de llamada </font><font style="vertical-align: inherit;">antes de la funci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">int main (void)</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span>
</span>{<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Me gustar√≠a ver c√≥mo se realiza la interrupci√≥n. </font><font style="vertical-align: inherit;">Agregue un encendido y apagado r√°pido de una de las conclusiones:</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span>
</span>{<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_SET);<font></font>
  __nop();__nop();__nop();__nop();__nop();__nop();<font></font>
  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_8, GPIO_PIN_RESET);<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El pin PE8 ya se ha inicializado como salida. </font><font style="vertical-align: inherit;">Entre el encendido y el apagado, se insertan las instrucciones </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">__nop ()</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , lo que forma un retraso de 1 ciclo de reloj. </font><font style="vertical-align: inherit;">Esto se hace para que mi analizador l√≥gico chino de $ 8 que funcione a 24 MHz no pierda un pulso demasiado corto de un microcontrolador de 72 MHz. </font><font style="vertical-align: inherit;">Ahora compile el proyecto </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Proyecto -&gt; Compilar destino</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y pregunte al controlador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Flash -&gt; Descargar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Conectaremos el PPM desde el control remoto a la PC6 y veremos qu√© sucede en la PC6 y la PE8 con el analizador.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/abf/64c/e2c/abf64ce2c6874057933df9edb58dff8f.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La devoluci√≥n de llamada se llama realmente en los momentos correctos, justo despu√©s de que la se√±al de entrada haya pasado de 1 a 0. Por lo tanto, todo se hizo correctamente.</font></font><br>
<br>
<h5><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Captura y procesa datos capturados</font></font></b></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Editaremos la devoluci√≥n de llamada para que agregue cada valor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">capturado al</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> b√∫fer </font><i><font style="vertical-align: inherit;">capturado_valor</font></i><font style="vertical-align: inherit;"> sin cambios. Si el temporizador captura un valor muy grande (m√°s de 5000 Œºs), esto significa que se registr√≥ una pausa, el paquete se recibi√≥ en su totalidad y puede procesarse. Los valores procesados ‚Äã‚Äãse agregan a la matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de 5 elementos. En los primeros cuatro, las posiciones de la palanca se reducen al rango [0; 1000], en el quinto, los bits individuales se establecen de acuerdo con los interruptores de palanca, que se interpretar√°n como presionar botones en el gamepad.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">uint16_t</span> captured_value[<span class="hljs-number">8</span>] = {<span class="hljs-number">0</span>};
<span class="hljs-keyword">uint16_t</span> rc_data[<span class="hljs-number">5</span>] = {<span class="hljs-number">0</span>};
<span class="hljs-keyword">uint8_t</span> pointer = <span class="hljs-number">0</span>;
<span class="hljs-keyword">uint8_t</span> data_ready = <span class="hljs-number">0</span>;<font></font>
<font></font>
...<font></font>
<font></font>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">HAL_TIM_IC_CaptureCallback</span><span class="hljs-params">(TIM_HandleTypeDef *htim)</span>
</span>{
    <span class="hljs-keyword">uint8_t</span> i;
    <span class="hljs-keyword">uint16_t</span> temp;
    <span class="hljs-comment">//     </span><font></font>
    temp = HAL_TIM_ReadCapturedValue(htim, TIM_CHANNEL_1);<font></font>
    <span class="hljs-comment">//    , ,  </span>
    <span class="hljs-keyword">if</span> ((temp &gt; <span class="hljs-number">5000</span>) &amp;&amp; (!data_ready))<font></font>
    {<font></font>
        pointer = <span class="hljs-number">0</span>;
        <span class="hljs-comment">//        [0;1000]</span>
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">4</span>; i++)<font></font>
        {<font></font>
            <span class="hljs-keyword">if</span> (captured_value[i] &lt; <span class="hljs-number">1000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">1000</span>;
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (captured_value[i] &gt; <span class="hljs-number">2000</span>)<font></font>
                captured_value[i] = <span class="hljs-number">2000</span>;<font></font>
            rc_data[i] = captured_value[i]<span class="hljs-number">-1000</span>;<font></font>
        };<font></font>
        <span class="hljs-comment">//     </span>
        rc_data[<span class="hljs-number">4</span>] = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">4</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">4</span>);
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">5</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">5</span>);
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">6</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">6</span>);
        <span class="hljs-keyword">if</span> (captured_value[<span class="hljs-number">7</span>] &gt; <span class="hljs-number">1500</span>)<font></font>
            rc_data[<span class="hljs-number">4</span>] |= (<span class="hljs-number">1</span>&lt;&lt;<span class="hljs-number">7</span>);<font></font>
        data_ready = <span class="hljs-number">1</span>;<font></font>
    }<font></font>
    <span class="hljs-keyword">else</span> <span class="hljs-comment">//      </span><font></font>
    {<font></font>
        captured_value[pointer] = temp;<font></font>
        pointer++;<font></font>
    };<font></font>
    <span class="hljs-keyword">if</span> (pointer == <span class="hljs-number">8</span>) <span class="hljs-comment">//   </span>
        pointer = <span class="hljs-number">0</span>;<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Perm√≠tanme explicar por qu√© coloqu√© los bits correspondientes a los botones no en los 4 bits inferiores, sino en los bits quinto a octavo. En el simulador, se supone que conecta un gamepad desde la Xbox, donde se usan los botones LB, RB, Start y Back, y tienen n√∫meros del 5 al 8. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el bucle principal, el indicador data_ready se rotar√° continuamente, por lo que los datos se enviar√°n a la computadora.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    <span class="hljs-comment">//      </span>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  }<font></font>
}<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Para comprobar c√≥mo funciona esto, conecte el control remoto, comp√≠lelo y vuelva a flashearlo, y luego comience a depurar </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Debug -&gt; Iniciar / Detener sesi√≥n de depuraci√≥n</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Abrir la ventana para las variables de seguimiento </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ver -&gt; reloj de Windows -&gt; Reloj 1</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y a√±adir </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">captured_value</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data all√≠</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Comenzamos la depuraci√≥n con el comando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Depurar -&gt; Ejecutar</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y en tiempo real, sin siquiera agregar puntos de interrupci√≥n, veremos c√≥mo cambian los n√∫meros despu√©s de los sticks.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/5cf/7da/c9c/5cf7dac9c152498e89ea3948a8549efb.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A continuaci√≥n, debe enviar datos a la computadora en forma de un comando de joystick.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Configure el dispositivo HID y cree el descriptor de informe HID</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USB HID (Dispositivo de interfaz humana) es una clase de dispositivos para la interacci√≥n humano-computadora. Estos incluyen teclados, ratones, joysticks, gamepads, paneles t√°ctiles. La principal ventaja de los dispositivos HID es que no requieren controladores especiales en ning√∫n sistema operativo: Windows, OS X, Android e incluso iOS (a trav√©s del adaptador USB-Lightning). Se puede encontrar una descripci√≥n detallada en el documento </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Device Class Definition for HID</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Lo principal que necesitamos saber para crear un adaptador PPM-USB es qu√© son el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Informe </font></font></i><font style="vertical-align: inherit;"></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y el </font><i><font style="vertical-align: inherit;">Descriptor de informe HID</font></i><font style="vertical-align: inherit;"> .</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El dispositivo HID env√≠a paquetes de bytes a la computadora en un formato predefinido. Cada paquete de este tipo es un informe HID. El dispositivo informa a la computadora sobre el formato de datos cuando se conecta, enviando un Descriptor de Informe HID, una descripci√≥n del paquete que indica cu√°ntos bytes contiene el paquete y el prop√≥sito de cada byte y bit en el paquete. Por ejemplo, el Informe HID de un mouse simple consta de cuatro bytes: el primer byte contiene informaci√≥n sobre los botones presionados, el segundo y el tercer bytes contienen el movimiento relativo del cursor a lo largo de X e Y, y el cuarto byte contiene la rotaci√≥n de la rueda de desplazamiento. El Descriptor de informes se almacena en la memoria del controlador del dispositivo como una matriz de bytes.</font></font><br>
<br>
<div style="text-align:center;"><img width="35%" src="https://habrastorage.org/files/22f/dd2/aa6/22fdd2aa67154365a6f89f6a2f7f2798.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Antes de crear un descriptor, me gustar√≠a detenerme por separado en la terminolog√≠a. Dos t√©rminos son comunes en el entorno del idioma ingl√©s: </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamepad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . La palabra </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">joystick</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> generalmente se llama manipulador que se sostiene con una mano y se inclina en diferentes direcciones, y el </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gamepad</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es un dispositivo con botones y palos que se sostiene con dos manos. Los usuarios de habla rusa generalmente llaman al joystick tanto eso como otro. En la descripci√≥n del dispositivo HID, hay una diferencia entre el joystick y el gamepad. La consola del modelo de avi√≥n es m√°s similar en su prop√≥sito funcional a un gamepad, por lo que en el futuro a veces usar√© el t√©rmino "gamepad".</font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Generamos un proyecto, que indica que el dispositivo actuar√° como un dispositivo de interfaz humana. </font><font style="vertical-align: inherit;">Esto significa que una biblioteca USB HID est√° conectada al proyecto y ya se ha generado un Descriptor de dispositivo. </font><font style="vertical-align: inherit;">Se encuentra en el archivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , describe el informe del mouse y tiene este aspecto:</font></font><br>
<div class="spoiler"><b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_Mouse_Report_Descriptor</font></font></b><div class="spoiler_text"><pre><code class="cpp hljs">__ALIGN_BEGIN <span class="hljs-keyword">static</span> <span class="hljs-keyword">uint8_t</span> HID_MOUSE_ReportDesc[HID_MOUSE_REPORT_DESC_SIZE]  __ALIGN_END =<font></font>
{<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0xA1</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x19</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x29</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x00</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x02</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x01</span>,<font></font>
<font></font>
  <span class="hljs-number">0x05</span>,   <span class="hljs-number">0x01</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x30</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x31</span>,
  <span class="hljs-number">0x09</span>,   <span class="hljs-number">0x38</span>,<font></font>
<font></font>
  <span class="hljs-number">0x15</span>,   <span class="hljs-number">0x81</span>,
  <span class="hljs-number">0x25</span>,   <span class="hljs-number">0x7F</span>,
  <span class="hljs-number">0x75</span>,   <span class="hljs-number">0x08</span>,
  <span class="hljs-number">0x95</span>,   <span class="hljs-number">0x03</span>,<font></font>
<font></font>
  <span class="hljs-number">0x81</span>,   <span class="hljs-number">0x06</span>,
  <span class="hljs-number">0xC0</span>,   <span class="hljs-number">0x09</span>,
  <span class="hljs-number">0x3c</span>,   <span class="hljs-number">0x05</span>,
  <span class="hljs-number">0xff</span>,   <span class="hljs-number">0x09</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x15</span>,
  <span class="hljs-number">0x00</span>,   <span class="hljs-number">0x25</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0x95</span>,<font></font>
<font></font>
  <span class="hljs-number">0x02</span>,   <span class="hljs-number">0xb1</span>,
  <span class="hljs-number">0x22</span>,   <span class="hljs-number">0x75</span>,
  <span class="hljs-number">0x06</span>,   <span class="hljs-number">0x95</span>,
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xb1</span>,<font></font>
<font></font>
  <span class="hljs-number">0x01</span>,   <span class="hljs-number">0xc0</span><font></font>
};<font></font>
</code></pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La creaci√≥n manual del Descriptor de informes HID lleva mucho tiempo. </font><font style="vertical-align: inherit;">Para facilitar la tarea, hay una herramienta llamada </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID Descriptor Tool</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (DT). </font><font style="vertical-align: inherit;">Este programa puede crear un descriptor para su dispositivo. </font><font style="vertical-align: inherit;">En el archivo que contiene puede encontrar varios ejemplos de descriptores para diferentes dispositivos.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/a3c/6fd/07c/a3c6fd07c997415ab94ba603edda628d.png"></div><br>
<br>
<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aqu√≠ hay un</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> muy buen art√≠culo sobre c√≥mo crear su propio descriptor HID para mouse y teclado (en ingl√©s). Te dir√© en ruso c√≥mo hacer un mango para un gamepad. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El informe HID enviado por la consola debe contener cuatro valores de 16 bits para dos ejes de sticks anal√≥gicos y 16 valores de un bit para botones. Total 10 bytes. Su asa creada en DT se ver√° as√≠:</font></font><br>
<br>
<pre><code class="cpp hljs">    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// USAGE_PAGE (Generic Desktop)</span>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x05</span>,                    <span class="hljs-comment">// USAGE (Game Pad)</span>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">// COLLECTION (Application)</span>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE (Pointer)</span>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x30</span>,                    <span class="hljs-comment">//     USAGE (X)</span>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x31</span>,                    <span class="hljs-comment">//     USAGE (Y)</span>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span>
    <span class="hljs-number">0xa1</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   COLLECTION (Physical)</span>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x33</span>,                    <span class="hljs-comment">//     USAGE (Rx)</span>
    <span class="hljs-number">0x09</span>, <span class="hljs-number">0x34</span>,                    <span class="hljs-comment">//     USAGE (Ry)</span>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//     LOGICAL_MINIMUM (0)</span>
    <span class="hljs-number">0x26</span>, <span class="hljs-number">0xe8</span>, <span class="hljs-number">0x03</span>,              <span class="hljs-comment">//     LOGICAL_MAXIMUM (1000)</span>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//     REPORT_SIZE (16)</span>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     REPORT_COUNT (2)</span>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//     INPUT (Data,Var,Abs)</span>
    <span class="hljs-number">0xc0</span>,                          <span class="hljs-comment">//   END_COLLECTION</span>
    <span class="hljs-number">0x05</span>, <span class="hljs-number">0x09</span>,                    <span class="hljs-comment">//   USAGE_PAGE (Button)</span>
    <span class="hljs-number">0x19</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   USAGE_MINIMUM (Button 1)</span>
    <span class="hljs-number">0x29</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   USAGE_MAXIMUM (Button 16)</span>
    <span class="hljs-number">0x15</span>, <span class="hljs-number">0x00</span>,                    <span class="hljs-comment">//   LOGICAL_MINIMUM (0)</span>
    <span class="hljs-number">0x25</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   LOGICAL_MAXIMUM (1)</span>
    <span class="hljs-number">0x75</span>, <span class="hljs-number">0x01</span>,                    <span class="hljs-comment">//   REPORT_SIZE (1)</span>
    <span class="hljs-number">0x95</span>, <span class="hljs-number">0x10</span>,                    <span class="hljs-comment">//   REPORT_COUNT (16)</span>
    <span class="hljs-number">0x81</span>, <span class="hljs-number">0x02</span>,                    <span class="hljs-comment">//   INPUT (Data,Var,Abs)</span>
    <span class="hljs-number">0xc0</span>                           <span class="hljs-comment">// END_COLLECTION</span>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
No parece menos intimidante que un descriptor de mouse. </font><font style="vertical-align: inherit;">Pero si comprende lo que significa cada l√≠nea, todo resulta bastante comprensible y l√≥gico. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE muestra c√≥mo el sistema debe interpretar los datos que van m√°s all√°. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Hay muchos tipos de uso, se clasifican en grupos: p√°ginas de uso. </font><font style="vertical-align: inherit;">Por lo tanto, para seleccionar un Uso espec√≠fico, primero debe consultar la USAGE_PAGE correspondiente. </font><font style="vertical-align: inherit;">Sobre qu√© uso se puede encontrar en el documento </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hid Tablas de uso</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Al comienzo del descriptor, indicamos que se describir√° el joystick:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (Escritorio gen√©rico) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Game Pad)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
COLLECTION combina varios conjuntos de datos relacionados. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La recopilaci√≥n f√≠sica se usa para datos relacionados con un punto geom√©trico espec√≠fico, por ejemplo, un stick anal√≥gico. </font><font style="vertical-align: inherit;">Application Collection se utiliza para combinar diferentes funciones en un solo dispositivo. </font><font style="vertical-align: inherit;">Por ejemplo, un teclado con un panel t√°ctil integrado puede tener dos colecciones de aplicaciones. </font><font style="vertical-align: inherit;">Describimos solo el joystick, lo que significa que la colecci√≥n ser√° una:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLLECTION (Aplicaci√≥n) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s de eso, debe especificar que se describir√°n los elementos que transmiten las coordenadas. </font><font style="vertical-align: inherit;">Usage Pointer se usa para describir ratones, joysticks, gamepads, digitalizadores:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USO (puntero)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Las siguientes son descripciones de palos anal√≥gicos combinados en una colecci√≥n:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLECCI√ìN (F√≠sica)</font></font><br>
 <blockquote>USAGE (X)<br>
 USAGE (Y)<br>
 LOGICAL_MINIMUM (0)<br>
 LOGICAL_MAXIMUM (1000)<br>
 REPORT_SIZE (16)<br>
 REPORT_COUNT (2)<br>
 INPUT (Data,Var,Abs)</blockquote>END_COLLECTION</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USO aqu√≠ indica que se </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
utilizan </font><font style="vertical-align: inherit;">los valores de desviaci√≥n a lo largo de los dos ejes, X e Y. </font><font style="vertical-align: inherit;">LOGICAL_MINIMUM y LOGICAL_MAXIMUM especifican la medida en que el valor transmitido puede variar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
REPORT_COUNT y REPORT_SIZE establecen, respectivamente, cu√°ntos n√∫meros y qu√© tama√±o vamos a transferir, es decir, dos n√∫meros de 16 bits. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
INPUT (Datos, Var, Abs) significa que los datos provienen del dispositivo a la computadora, y estos datos pueden cambiar. Los valores en nuestro caso son absolutos. Por ejemplo, los valores relativos provienen del mouse para mover el cursor. A veces los datos se describen como Const, no Var. Esto es necesario para transmitir bits no significativos. Por ejemplo, en un informe de mouse con tres botones, se transfieren 3 bits de Var para botones y 5 bits de Const para complementar el tama√±o de transferencia a un byte.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Como puede ver, las descripciones de los ejes X e Y se agrupan. </font><font style="vertical-align: inherit;">Tienen el mismo tama√±o, los mismos l√≠mites. </font><font style="vertical-align: inherit;">El mismo stick anal√≥gico podr√≠a describirse como sigue, describiendo cada eje individualmente. </font><font style="vertical-align: inherit;">Tal descriptor funcionar√° de manera similar al anterior:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLECCI√ìN (F√≠sica)</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USO (X) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Datos, Var, Abs)</font></font></blockquote><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USO (Y) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Datos, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Despu√©s del primer stick, se describe el segundo stick anal√≥gico. </font><font style="vertical-align: inherit;">Sus ejes tienen un uso diferente para que pueda distinguirlos del primer palo: Rx y Ry:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">COLECCI√ìN (F√≠sica)</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USO (Rx) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 USO (Ry) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MINIMUM (0) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 LOGICAL_MAXIMUM (1000) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_SIZE (16) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 REPORT_COUNT (2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
 INPUT (Datos, Var, Abs)</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">END_COLLECTION</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ahora necesitas describir algunos botones del gamepad. </font><font style="vertical-align: inherit;">Esto puede hacerse de la siguiente manera:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (Bot√≥n) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Bot√≥n 1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Bot√≥n 2) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Bot√≥n 3) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
... </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE (Bot√≥n 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
La engorrosa grabaci√≥n de botones del mismo tipo se puede reducir utilizando el rango de uso:</font></font><br>
<blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">USAGE_PAGE (Bot√≥n) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MINIMUM (Bot√≥n 1) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
USAGE_MAXIMUM (Bot√≥n 16)</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los datos transmitidos por los botones son 16 valores de un solo bit, que var√≠an de 0 a 1:</font></font><br>
<blockquote>LOGICAL_MINIMUM (0)<br>
LOGICAL_MAXIMUM (1)<br>
REPORT_SIZE (1)<br>
REPORT_COUNT (16)<br>
INPUT (Data,Var,Abs)</blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El orden de las l√≠neas en el descriptor no es estricto. Por ejemplo, Logical_Minimum y Logical_Maximum se pueden escribir antes de Usage (Button), o las l√≠neas Report_Size y Report_Count se pueden intercambiar. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es importante que el comando Entrada tenga todos los par√°metros necesarios para la transferencia de datos (Uso, M√≠nimo, M√°ximo, Tama√±o, Recuento). </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Cuando se forma el descriptor, se puede verificar con el comando </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Parse Descriptor</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para ver si hay errores. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Si todo est√° en orden, exp√≥rtelo con la extensi√≥n h. En el archivo </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.c,</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> reemplace el descriptor por uno nuevo y ajuste en </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h el</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> tama√±o del descriptor </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">HID_MOUSE_REPORT_DESC_SIZE</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> de 74 a 61. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los informes se env√≠an utilizando el indicador </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">data_ready</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Para que esto</font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">main.c</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> incluiremos el archivo de encabezado </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usbd_hid.h</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y en el bucle principal llamaremos a la funci√≥n de env√≠o de informes. </font><font style="vertical-align: inherit;">La matriz </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">rc_data</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> es del tipo uint16, por lo que el puntero debe convertirse a un tipo de 8 bits y pasar el tama√±o 10 en lugar de 5.</font></font><br>
<br>
<pre><code class="cpp hljs"><span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"usbd_hid.h"</span></span><font></font>
...<font></font>
<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<font></font>
{<font></font>
  <span class="hljs-keyword">if</span> (data_ready)<font></font>
  {<font></font>
    USBD_HID_SendReport(&amp;hUsbDeviceFS, (<span class="hljs-keyword">uint8_t</span>*)rc_data, <span class="hljs-number">10</span>);<font></font>
    data_ready = <span class="hljs-number">0</span>;<font></font>
  };<font></font>
};<font></font>
</code></pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Compilamos el proyecto y lo flasheamos nuevamente.</font></font><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Conexi√≥n y uso</font></font></b></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vuelva a conectar el cable USB del conector USB ST-LINK al conector USB del USUARIO. </font><font style="vertical-align: inherit;">Windows detectar√° el nuevo dispositivo e instalar√° autom√°ticamente el controlador. </font><font style="vertical-align: inherit;">Vayamos al </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Panel de control -&gt; Dispositivos e impresoras</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y veamos nuestro dispositivo adaptador USB-PPM STM32 con un √≠cono de gamepad.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/1ee/5ad/846/1ee5ad84654545dfbcec807073ef8207.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En los par√°metros del dispositivo, puede ver c√≥mo la cruz se mueve alrededor del campo y las columnas se mueven despu√©s de mover los palos, y los s√≠mbolos de los botones se iluminan desde el interruptor de palanca. </font><font style="vertical-align: inherit;">La calibraci√≥n no es necesaria porque los valores m√≠nimo y m√°ximo ya se han establecido en el descriptor.</font></font><br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/files/52c/4b0/9db/52c4b09db3074871b917aa74b3375de6.png"></div><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Al iniciar FPV FreeRider, veremos c√≥mo en la pantalla principal del gamepad virtual dibujado los palos se mueven de acuerdo con nuestro control remoto. </font><font style="vertical-align: inherit;">Si los ejes no est√°n asignados correctamente por alg√∫n motivo, puede reconfigurarlos en la secci√≥n </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calibrar controlador</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Los interruptores de palanca correspondientes a los botones del control remoto se utilizan para cambiar los modos de vuelo (acrob√°tico / estabilizado), cambiar la vista de la c√°mara (desde el tablero / desde el suelo), iniciar un vuelo desde el principio o encender la carrera por un tiempo.</font></font><br>
<br>
<div style="text-align:center;"><img width="70%" src="https://habrastorage.org/files/153/bc2/3a8/153bc23a87bd4fedad1dd9b04c2aae22.png"></div><br>
<br>
<h3><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vol√≥!</font></font></b></h3><br>
<iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=https://www.youtube.com/embed/ilMeTba4EOE%3Ffeature%3Doembed&amp;usg=ALkJrhgglgo900LgdoY7vej6V36EYMg38A" frameborder="0" allowfullscreen=""></iframe><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
En el video, el resultado de varios d√≠as de mi entrenamiento. Mientras vuelo con nivelaci√≥n autom√°tica, y no en modo acrob√°tico, como lo hacen todos los maestros de las carreras de FPV. En modo acro, si suelta los palos, el helic√≥ptero no vuelve autom√°ticamente a la posici√≥n horizontal, sino que contin√∫a volando en el mismo √°ngulo que vol√≥. Administrar en modo acro es mucho m√°s dif√≠cil, pero puede lograr una mayor velocidad, maniobrabilidad, agitar el aire e incluso volar al rev√©s. </font></font><br>
<br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
A los </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">maestros Charpu</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todav√≠a estoy muy lejos, pero sigo entrenando y puedo decir con certeza que la idea de un mini helic√≥ptero de carreras me interes√≥ a√∫n m√°s. </font><font style="vertical-align: inherit;">Y pronto, definitivamente estar√© involucrado en su construcci√≥n y vuelos, ya no en el simulador, sino en una dura realidad, con choques reales, h√©lices rotas, motores rotos y bater√≠as quemadas. </font><font style="vertical-align: inherit;">Pero este es un tema para otros art√≠culos :)</font></font><br>
<br>
<hr><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
El proyecto para Keil uVision 5 y STM32CubeMX est√° en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es384813/">https://habr.com/ru/post/es384813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es384801/index.html">√öltimo d√≠a de Pompeya: cient√≠ficos italianos escanearon los restos de v√≠ctimas del desastre</a></li>
<li><a href="../es384803/index.html">Paul Graham: Ideas para una startup org√°nica</a></li>
<li><a href="../es384805/index.html">–°–ø–µ—Ü–∏–∞–ª–∏—Å—Ç—ã iFixit —Ä–∞–∑–æ–±—Ä–∞–ª–∏ AppleTV, –∞ Apple —É–¥–∞–ª–∏–ª–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ iFixit –∏–∑ AppStore</a></li>
<li><a href="../es384809/index.html">¬øPapel o "n√∫mero"? Ambos: revisi√≥n del bol√≠grafo inteligente NeoLAB Convergence Neo smartpen N2</a></li>
<li><a href="../es384811/index.html">Opini√≥n de expertos: materiales semiconductores en electr√≥nica</a></li>
<li><a href="../es384815/index.html">Tel√©fonos para la seguridad de los ni√±os y la paz de sus padres: una revisi√≥n del nuevo bb-mobile</a></li>
<li><a href="../es384817/index.html">Miles de fotos de Apolo subidas a Flickr</a></li>
<li><a href="../es384819/index.html">En lugar de "no ser malo", "Google" ahora est√° "haciendo lo correcto"</a></li>
<li><a href="../es384821/index.html">El estudiante introdujo un guante que permitir√° a las personas con trastornos del habla comunicarse</a></li>
<li><a href="../es384823/index.html">Formas no est√°ndar de promocionar juegos m√≥viles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>