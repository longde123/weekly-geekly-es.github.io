<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë± ‚è¨ ü•î Operaci√≥n TA505, cuarta parte. Gemelos ‚öñÔ∏è üë∂üèª üíÄ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuamos hablando sobre las actividades del grupo de hackers TA505. La conocida frase "lo nuevo es lo viejo olvidado" es el ep√≠grafe m√°s adecuado p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Operaci√≥n TA505, cuarta parte. Gemelos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/475328/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/79/gv/mv/79gvmv2kznpjzybycyw7scp5zus.jpeg"></a> <br><br>  Continuamos hablando sobre las actividades del grupo de hackers TA505.  La conocida frase "lo nuevo es lo viejo olvidado" es el ep√≠grafe m√°s adecuado para el pr√≥ximo cap√≠tulo de la historia sobre el grupo TA505.  Es cierto que esta vez lo "viejo" no est√° tan "olvidado" como si fue modificado y mejorado. <br><br>  A principios de septiembre, descubrimos varios descargadores maliciosos empaquetados con el PE-packer especial del grupo sobre el que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">escribimos anteriormente</a> .  A primera vista, parec√≠an los conocidos montadores de la puerta trasera FlawedAmmyy.  Pero un an√°lisis m√°s profundo mostr√≥ que esto no es as√≠.  No las t√©cnicas m√°s avanzadas para escribir c√≥digo nos han llevado a cargas √∫tiles radicalmente opuestas en t√©rminos de calidad de ejecuci√≥n. <br><br>  En este art√≠culo, veremos m√°s de cerca las herramientas encontradas y trazaremos paralelos con lo que ya se conoce. <a name="habracut"></a><br><br><h2>  Twein del cargador de arranque </h2><br>  En primer lugar, lo siguiente es curioso: de todas las muestras del gestor de arranque que logramos recolectar, solo una tiene una firma digital: <br><br><img src="https://habrastorage.org/webt/im/iu/-a/imiu-af4otgk3nhalsj7mhe3hwy.jpeg"><br><br>  <i>Fig.</i>  <i>1. Firma digital del gestor de arranque</i> <br><br>  Certificado emitido a nombre de PEAR SOLUTIONS LTD.  Por cierto, esta no es la primera vez que un grupo firma sus herramientas, haci√©ndolas pasar por software leg√≠timo de organizaciones ficticias.  Aqu√≠ hay algunos otros nombres que usaron el TA505 para otras familias de malware: <br><br><ul><li>  ET HOMES LTD, </li><li>  FIT Y FLEX LIMITED, </li><li>  MISHA LONDRES LTD, </li><li>  SATOJI KAIDA MB, </li><li>  MUY TELE LIMITADO. </li></ul><br>  Dado que los cargadores de arranque detectados no difieren entre s√≠, seleccionamos el ya firmado firmado y nos detenemos en √©l con m√°s detalle. <br><br>  A lo largo del trabajo del malware, casi todas las acciones van acompa√±adas de la escritura en el archivo de registro y la salida de depuraci√≥n de todo lo que sucede: <br><br><img src="https://habrastorage.org/webt/dm/7f/1j/dm7f1jjwkhlfkj8k987uvp8ixjw.jpeg"><br><br>  <i>Fig.</i>  <i>2. Depuraci√≥n de salida y registro</i> <br><br>  Tal rastreo no solo simplifica el an√°lisis est√°tico del archivo, sino que tambi√©n ayuda a descubrir qu√© est√° mal en los sistemas de an√°lisis din√°mico: <br><br><img src="https://habrastorage.org/webt/d4/g1/kg/d4g1kgeiovdgo-ecz3ytg5ki26c.jpeg"><br><br>  <i>Fig.</i>  <i>3. Salida de depuraci√≥n en el analizador en l√≠nea ANY.RUN</i> <br><br>  Troyan comprueba la distribuci√≥n del idioma del teclado, y no funciona en Rusia y los pa√≠ses vecinos: <br><br><img src="https://habrastorage.org/webt/bz/hr/my/bzhrmynjo9dlc50xi_nucjdpuf4.jpeg"><br><br>  <i>Fig.</i>  <i>4. Verificaci√≥n de la disposici√≥n del idioma del teclado</i> <br>  Luego crea el mutex <code>Global\system32_mutant_service</code> y verifica la disponibilidad de Internet mediante una solicitud HTTP GET a google.com.  Despu√©s de eso, determina la forma de acceder a la red (direcci√≥n dedicada o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NAT</a> ) determinando la direcci√≥n IP externa por los servicios myexternalip.com, ipecho.net e ifconfig.me y comparando el valor obtenido con los especificados en los par√°metros de red del sistema: <br><br><img src="https://habrastorage.org/webt/ld/80/7w/ld807wry4cgdc1qzj3mwjogabf8.jpeg"><br><br>  <i>Fig.</i>  <i>5. Comparaci√≥n de direcciones IP internas y externas</i> <br><br>  A continuaci√≥n, el malware determina la versi√≥n de la biblioteca <code>%SystemRoot%\system32\crypt32.dll</code> y, si el n√∫mero de compilaci√≥n y el n√∫mero de revisi√≥n son inferiores a <code>7601</code> y <code>18741</code> respectivamente, descarga e instala la actualizaci√≥n <code>KB3033929</code> seg√∫n la versi√≥n del sistema operativo: <br><br><img src="https://habrastorage.org/webt/su/zu/ig/suzuighncp_psgtfbtnbvcdbb1y.jpeg"><br><br>  <i>Fig.</i>  <i>6. Descargue e instale actualizaciones del sistema</i> <br><br>  ¬øLos atacantes TA505 cuidan de la v√≠ctima y reparan el sistema seg√∫n sea necesario?  En absoluto  La instalaci√≥n de la actualizaci√≥n est√° asociada con la finalizaci√≥n del soporte para los certificados de seguridad de c√≥digo firmados con SHA-1 y su abandono a favor del algoritmo SHA-2.  Lo m√°s probable es que los piratas inform√°ticos ya hayan tenido dificultades para ejecutar cargas √∫tiles firmadas en sistemas no actualizados.  Curiosamente, despu√©s de instalar la actualizaci√≥n, el troyano env√≠a el registro de acci√≥n generado al servidor de administraci√≥n, detiene su trabajo y se borra solo, eliminando los rastros que quedan. <br><br><img src="https://habrastorage.org/webt/k6/jk/-y/k6jk-yijoanmpjtwath42fioh10.jpeg"><br><br>  <i>Fig.</i>  <i>7. Apagar despu√©s de instalar una actualizaci√≥n del sistema</i> <br><br>  Si no se requiere la instalaci√≥n de la actualizaci√≥n, el gestor de arranque recopila y env√≠a la siguiente informaci√≥n al servidor de administraci√≥n: <br><br><ul><li>  informaci√≥n del sistema </li><li>  informaci√≥n sobre el software instalado, </li><li>  informaci√≥n sobre el software firmado en los directorios% ProgramFiles% y% ProgramFiles (x86)% (si corresponde), </li><li>  Informaci√≥n sobre controladores firmados en el directorio% SystemRoot% \ drivers. </li></ul><br>  Tenga en cuenta que se utiliz√≥ un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">c√≥digo leg√≠timo</a> para obtener informaci√≥n sobre las firmas. <br><br><img src="https://habrastorage.org/webt/z4/1o/p_/z41op_q3q8pzlli3zlapjreaxd0.jpeg"><br><br>  <i>Fig.</i>  <i>8. Obteniendo informaci√≥n del certificado</i> <br><br>  Despu√©s de eso, el gestor de arranque crea el directorio <code>C:\Windows\Logs\diag</code> e inicia un hilo en el que rastrea los cambios en el directorio, enviando notificaciones al servidor de gesti√≥n: <br><br><img src="https://habrastorage.org/webt/ra/rh/-g/rarh-gd4x8yafwiipdft7r9duiq.jpeg"><br><br>  <i>Fig.</i>  <i>9. Monitoreo de cambios en el directorio</i> <br><br>  Luego, prepara la informaci√≥n existente y faltante sobre el sistema (nombre de usuario, versi√≥n del sistema, dominio, direcci√≥n IP, informaci√≥n sobre la tarjeta de video, conexi√≥n de red - NAT o no NAT) y genera un archivo JSON de este tipo: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"adm"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bid"</span></span>: <span class="hljs-string"><span class="hljs-string">"M3xwwhqLH/AUOhmU2+W55A=="</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bit"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"bnet"</span></span>: <span class="hljs-string"><span class="hljs-string">"ldr"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cam"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cis"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dmn"</span></span>: <span class="hljs-string"><span class="hljs-string">"WORKGROUP"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"hash_r"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lip"</span></span>: <span class="hljs-string"><span class="hljs-string">"192.168.100.153"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lvl"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"nat"</span></span>: <span class="hljs-string"><span class="hljs-string">"1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osb"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"osv"</span></span>: <span class="hljs-string"><span class="hljs-string">"Windows 7 Professional"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"pc"</span></span>: <span class="hljs-string"><span class="hljs-string">"USER-PC"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_c"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"proc_n"</span></span>: <span class="hljs-string"><span class="hljs-string">"cpu"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"rep"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmt"</span></span>: <span class="hljs-string"><span class="hljs-string">"0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ver"</span></span>: <span class="hljs-string"><span class="hljs-string">"163"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"video"</span></span>: <span class="hljs-string"><span class="hljs-string">"Standard VGA Graphics Adapter,"</span></span> }</code> </pre> <br>  M√°s tarde, estos datos se <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> con RC4 (la clave de cifrado <code>gJypA9RWUlYpnBbzujVqE6fDcEAk0zoz</code> se cifra en el cuerpo del troyano), se codifica con Base64 y se env√≠a mediante una solicitud HTTP POST al servidor de gesti√≥n: <br><br><img src="https://habrastorage.org/webt/wu/4p/x8/wu4px8dxpkvy5mshywjkrskevlm.jpeg"><br><br>  <i>Fig.</i>  <i>10. Solicitud HTTP POST al servidor de administraci√≥n</i> <br><br><img src="https://habrastorage.org/webt/uv/lw/bg/uvlwbgwcx0ejyfndmzdybhtqrsy.jpeg"><br><br>  <i>Fig.</i>  <i>11. La lista de servidores de control en el gestor de arranque</i> <br><br>  RC4 descifra la respuesta del servidor (la clave de cifrado es la misma que la utilizada para enviar los datos) y se verifica: los dos primeros bytes deben corresponder a la l√≠nea MZ, que es un signo del archivo PE.  Ya conocimos esta secuencia antes cuando analizamos otro cargador de grupo que entreg√≥ FlawedAmmyy RAT: <br><br><img src="https://habrastorage.org/webt/pb/oe/hi/pboehibfeoivvna7bl6xkumibuo.jpeg"><br><br>  <i>Fig.</i>  <i>12. Un c√≥digo similar para descifrar y verificar el archivo descargado para el gestor de arranque en cuesti√≥n (izquierda) y el gestor de arranque FlawedAmmyy RAT (derecha)</i> <br><br>  La carga √∫til se produce no solo en el hilo principal, sino tambi√©n en uno creado por separado.  En otras palabras, hay dos cargas √∫tiles.  En un caso, el mutex Global \ system32_host_service se verifica previamente y, en caso de ausencia, se carga un componente, al que se hace referencia en la informaci√≥n de depuraci√≥n como carga √∫til o bot.  Curiosamente, despu√©s de recibir una respuesta del servidor, el archivo PE no se inicia de ninguna manera.  En cambio, su cuerpo est√° escrito en el registro en la secci√≥n <code>HKEY_LOCAL_MACHINE\SYSTEM</code> en la clave <code>0x228028</code> .  Luego, el gestor de arranque deshabilita la redirecci√≥n del sistema de archivos WoW64 para aplicaciones de 32 bits usando <code>Wow64DisableWow64FsRedirection</code> e inicia el proceso <code>%SystemRoot%\System32\services.exe</code> con el par√°metro -ww.  El uso de este par√°metro no tiene sentido, pero completa la cadena de instalaci√≥n de la carga √∫til resultante. <br><br><img src="https://habrastorage.org/webt/bn/eb/w1/bnebw1pcir-t8io211poejmlzbe.jpeg"><br><br>  <i>Fig.</i>  <i>13. Configuraci√≥n de la carga √∫til</i> <br><br>  Hablaremos de la segunda carga √∫til m√°s tarde. <br><br><h2>  Complementos Twein </h2><br>  Al examinar el troyano mencionado anteriormente, notamos una funci√≥n que elimina dos archivos del <code>%SystemRoot%</code> : <code>twein_32.dll</code> y <code>twein_64.dll</code> : <br><br><img src="https://habrastorage.org/webt/hk/v2/ht/hkv2ht9lipkhgz-ydz622exxzds.jpeg"><br><br>  <i>Fig.</i>  <i>14. Eliminar archivos twein_32.dll y twein_64.dll</i> <br><br>  Estos archivos no se encuentran en ning√∫n otro lugar, no aparecen en la l√≥gica del gestor de arranque.  Sin embargo, los nombres de las bibliotecas nos recordaron a otro grupo de malware, que ahora consideraremos. <br>  Dos meses antes, encontramos un troyano del grupo TA505, de unos 9 MB de tama√±o.  El archivo est√° empaquetado por <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">UPX</a> .  El troyano se instala en el sistema como un servicio <code>WMDICToss</code> .  Los recursos contienen tres archivos: <code>systemdiron.bat</code> , <code>twein__32.dll</code> y <code>twein__64.dll</code> , que est√°n cifrados con XOR lineal. <br><br><img src="https://habrastorage.org/webt/tj/op/xh/tjopxhpvsrbmlstkvm2fidukk7w.jpeg"><br><br>  <i>Fig.</i>  <i>15. Descifrado de uno de los recursos del cuentagotas</i> <br><br>  Tenga en cuenta que los nombres de los dos archivos casi coinciden con los ya mencionados anteriormente: la diferencia es solo en el n√∫mero de guiones bajos. <br><br>  Se espera que uno de los recursos descifrados con el nombre <code>systemdiron.bat</code> sea ‚Äã‚Äãun script de comando que proporcione el lanzamiento de otros componentes dependiendo de la capacidad del sistema: <br><br><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> defined PROCESSOR_ARCHITEW6432 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==IA64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==AMD64 (goto LABEL_X64) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %PROCESSOR_ARCHITECTURE%==x86 (goto LABEL_X86) goto LABEL_NON :LABEL_X64 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x64 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__64.dll,Install copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_X86 <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: x86 copy c:\temp\tmp.log c:\i.txt rundll32.exe C:\Windows\twein__32.dll,Install del c:\temp\tmp.log del c:\i.txt shutdown.exe -r -t 00 goto LABEL_END :LABEL_NON <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> OS <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>: undefined goto LABEL_END :LABEL_END pause</code> </pre> <br>  Ambas bibliotecas de twein act√∫an de manera similar.  Empaquetado con el caracter√≠stico empacador del grupo TA505.  Nombres de biblioteca originales: <code>av_block.dll</code> .  El an√°lisis es significativamente complicado por el uso de un ofuscador, y la proporci√≥n de c√≥digo ofuscado es aproximadamente del 80%.  Como resultado de esto, la ejecuci√≥n del programa est√° saturada con numerosas transiciones, decodificaci√≥n de los siguientes pasos del c√≥digo, llamadas a funciones no lineales. <br><br>  Las bibliotecas contienen una impresionante lista de cadenas similares a Base64, que se descifran de la siguiente manera: <br><br>  1. La cadena de entrada se divide en bloques de 4 bytes; <br>  2. Cada bloque se decodifica usando el algoritmo de reemplazo y cambio: <br><br><pre> <code class="bash hljs">import binascii def block_decode(input_str, len_of_block): alphabet = <span class="hljs-string"><span class="hljs-string">'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x3E\x00\x00\x00\x3F\x34\x35\x36\x37\x38\x39\x3A\x3B\x3C\x3D\x00\x00\x00\x00\x00\x00\x00\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x00\x00\x00\x00\x00\x00\x1A\x1B\x1C\x1D\x1E\x1F\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2A\x2B\x2C\x2D\x2E\x2F\x30\x31\x32\x33\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00'</span></span> int_result = 0 <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> range(len_of_block): alph = ord(alphabet[ord(input_str[i])]) alph &lt;&lt;= 0x6 * i int_result += alph str_result = hex(int_result)[2:] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(str_result) % 2 != 0: str_result = <span class="hljs-string"><span class="hljs-string">'0'</span></span> + str_result <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> binascii.unhexlify(str_result).decode(<span class="hljs-string"><span class="hljs-string">'latin1'</span></span>)[::-1]</code> </pre> <br><br>  3) los bloques se recogen en una sola l√≠nea; <br>  4) el algoritmo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">eexec</a> descifra el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resultado</a> con una clave de doble byte, que se pasa como par√°metro: <br><br><img src="https://habrastorage.org/webt/qs/mj/ah/qsmjah4gzyqwizgrothw1hlbkdc.jpeg"><br><br>  <i>Fig.</i>  <i>16. Implementaci√≥n del algoritmo eexec</i> <br><br>  La mayor√≠a de las l√≠neas son los nombres y las rutas a los archivos de los productos antivirus, sin embargo, algunos de ellos no pertenecen a herramientas de seguridad en absoluto: MS Exchange Server, MySQL Server, SAP, Apache, PostgreSQL, Elasticsearch, etc. Incluso hubo rutas √∫nicas: <br><br><ul><li>  C: \ Users \ tislam \ Desktop \ salik app \ Aye_salik_data \ Aye_salik_data \ bin \ Debug \ Aye_salik_data.exe </li><li>  C: \ oem13c \ agent13c \ agent_13.2.0.0.0 \ perl \ bin \ perl.exe </li><li>  C: \ Users \ adadmin \ Ubiquiti UniFi \ bin \ mongod.exe </li><li>  C: \ Users \ sakella \ AppData \ Local \ Microsoft \ OneDrive \ OneDrive.exe </li><li>  D: \ Complementos \ IMI_CREDIT_POLICY Test v 02.01 \ IMI_CREDIT_POLICY.exe </li></ul><br>  Si se encuentra software en el sistema de la lista, se eliminan los archivos y directorios. <br><br>  Para protegerse en el sistema, las bibliotecas se configuran como la interfaz del proveedor de servicios de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Windows Sockets</a> (SPI), denominada Intel e IntelFiltr.  Adem√°s, cambian el orden de los manejadores en la cadena de protocolo para ser el primer SPI en manejar la solicitud del cliente. <br><br>  En 2015, nuestros colegas de FireEye presentaron el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">an√°lisis de</a> bot <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LatentBot</a> .  Es curioso que el algoritmo de cifrado de cadenas en LatentBot y las bibliotecas de twein revisadas sean completamente iguales.  Adem√°s, LatentBot utiliza un m√≥dulo de seguridad como uno de los complementos, que busca herramientas de seguridad en el sistema utilizando las rutas especificadas y los nombres de productos, aunque se limita a verificar la disponibilidad. <br><br><h2>  Rootkit twein </h2><br>  Volver al gestor de arranque, es decir, la segunda carga √∫til.  Desde las l√≠neas de depuraci√≥n de intentar abrir rootkit ... y Driver% S instalado, es f√°cil adivinar el formato de la pr√≥xima carga √∫til.  Despu√©s de una carga exitosa, el controlador se escribir√° en el <code>%SystemRoot%\System32\drivers</code> con un nombre formado de forma pseudoaleatoria a partir de los nombres de otros archivos leg√≠timos.  Luego se crear√° y lanzar√° el servicio: <br><br><img src="https://habrastorage.org/webt/hw/dp/vi/hwdpvipfgx2-rra5iqecj2o5t8w.jpeg"><br><br>  <i>Fig.</i>  <i>17. Instalaci√≥n e inicio del servicio.</i> <br><br>  En la etapa final de su trabajo, el gestor de arranque configurar√° el controlador para que se incluya en una lista negra en las claves de registro: los nombres de los procesos antivirus, las herramientas de an√°lisis y los proveedores de protecci√≥n en las firmas de archivos digitales se ingresar√°n en los valores num√©ricos especificados de las claves de la rama <code>HKEY_LOCAL_MACHINE\SYSTEM</code> : <br><br><img src="https://habrastorage.org/webt/u2/fw/zj/u2fwzjlb_hjgmabjwa4filz9fn4.jpeg"><br><br>  <i>Fig.</i>  <i>18. Configuraci√≥n del controlador en la lista negra</i> <br><br>  En el proceso de investigaci√≥n del gestor de arranque, no pudimos obtener una muestra del controlador del servidor de administraci√≥n.  Sin embargo, encontramos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">menci√≥n de un rootkit</a> que fue bombeado por otro gestor de arranque similar. <br><br>  El controlador est√° firmado digitalmente a nombre de <code>Lizas Limited</code> con <code>administrator@lizaslimited.site</code> como correo electr√≥nico: <br><br><img src="https://habrastorage.org/webt/o_/tm/yy/o_tmyyrx3dayywf-jnfkoijecvm.jpeg"><br><br>  <i>Fig.</i>  <i>19. controlador firmado digitalmente</i> <br><br>  Durante la investigaci√≥n, encontramos mucho en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">com√∫n</a> con el conocido rootkit de la botnet Necurs, que fue utilizado activamente por el grupo TA505 para enviar spam y propagar malware.  Consideremos con m√°s detalle las caracter√≠sticas m√°s interesantes de su trabajo. <br><br>  El controlador registra controladores de eventos para iniciar procesos y cargar im√°genes PE utilizando <code>PsSetCreateProcessNotifyRoutine</code> y <code>PsSetLoadImageNotifyRoutine</code> .  En otras palabras, esto permite que el controlador controle el lanzamiento de todos los procesos y servicios nuevos.  Usando las listas negras que mencionamos anteriormente, el rootkit termina los procesos no deseados con ZwTerminateProcess y evita que otros controladores potencialmente peligrosos se carguen, sobrescribiendo el valor del punto de entrada en las instrucciones: <br><br><pre> <code class="bash hljs">mov eax, 0C0000001 retn 8</code> </pre> <br>  Como resultado, el servicio se descargar√° con el error <code>STATUS_UNSUCCESSFULL</code> . <br><br><img src="https://habrastorage.org/webt/td/l7/ea/tdl7ea03jvxszqftk9rks9wqgqc.jpeg"><br><br>  <i>Fig.</i>  <i>20. Finalizaci√≥n del proceso</i> <br><br><img src="https://habrastorage.org/webt/va/6k/bb/va6kbbjuepdp1x99ktenowebmc0.jpeg"><br><br>  <i>Fig.</i>  <i>21. Sobrescribir puntos de entrada del conductor</i> <br><br>  Mediante CmRegisterCallback, el controlador intercepta los eventos de acceso al registro del sistema.  En particular, su trabajo adicional est√° parametrizado por los valores num√©ricos de las teclas a las que se accede en eventos interceptados. <br><br><img src="https://habrastorage.org/webt/af/ka/b6/afkab6erynqiphtoyzztal2wjq8.jpeg"><br><br>  <i>Fig.</i>  <i>22. Gesti√≥n de rootkits de accesos de clave de registro</i> <br><br>  Curiosamente, en algunas versiones del rootkit Necurs, se usaron los mismos valores num√©ricos que los c√≥digos de solicitud ioctl. <br><br><img src="https://habrastorage.org/webt/nn/vx/rh/nnvxrhxmoftlziclt9dgak73ydk.jpeg"><br><br>  <i>Fig.</i>  <i>23. Administrar un rootkit Necurs usando consultas ioctl</i> <br><br>  Este truco puede considerarse como un paso hacia un mayor secreto: el acceso al registro causa menos sospechas que las solicitudes ioctl a DeviceObject. <br><br>  El cuerpo del rootkit contiene una biblioteca DLL auxiliar cifrada con XOR de un solo byte.  Al crear un nuevo proceso, el controlador inyecta la biblioteca junto con otro archivo PE, que se extrae del registro y se descifra nuevamente con un XOR de un solo byte. <br><br><img src="https://habrastorage.org/webt/nu/ze/03/nuze03jkif4-7sl9mux_j8_roz8.jpeg"><br><br>  <i>Fig.</i>  <i>24. Descifrado e inyecci√≥n de la biblioteca auxiliar en el proceso creado.</i> <br><br>  El componente auxiliar es un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cargador reflexivo</a> personalizado que coloca correctamente el segundo archivo PE en la memoria, que act√∫a como una carga √∫til, y le transfiere el control.  Ahora queda claro c√≥mo exactamente la carga √∫til que el gestor de arranque escribi√≥ en el registro desde la primera parte del art√≠culo comienza a funcionar. <br><br><img src="https://habrastorage.org/webt/wa/zr/c3/wazrc3yxq9pul3vzf3jjbgsdeyg.jpeg"><br><br>  <i>Fig.</i>  <i>25. Llenar la tabla de importaci√≥n con una biblioteca auxiliar</i> <br><br><h2>  Conclusi√≥n </h2><br>  En el art√≠culo, nos familiarizamos con las caracter√≠sticas del trabajo de muchos troyanos gemelos.  ¬øPor qu√© gemelos?  El gestor de arranque malicioso con el que comenzamos nuestra investigaci√≥n es muy similar al conocido gestor de arranque de puerta trasera FlawedAmmyy en la calidad de la escritura de c√≥digo y los matices de implementaci√≥n.  Las bibliotecas de twein que est√° tratando de eliminar del sistema son las que probablemente veamos a continuaci√≥n.  Las bibliotecas son muy similares al complemento de seguridad LatentBot.  Una de las cargas √∫tiles del gestor de arranque es un controlador derivado del popular rootkit de Necurs. <br><br>  Algunas familias de malware tienen m√°s de 5 a√±os, sin embargo, los atacantes contin√∫an actualiz√°ndolas y mejor√°ndolas, teniendo en cuenta el desarrollo de sistemas operativos y herramientas de seguridad. <br><br>  <b>Autores</b> : Alexey Vishnyakov y Daniil Koloskov, Tecnolog√≠as positivas <br><br><div class="spoiler">  <b class="spoiler_title">COI</b> <div class="spoiler_text">  a28a54abc30805cc6ea2ce0732989287 - Twein bootloader <br>  f6b6526b8d494dce14568e3703368432 - cuentagotas plugin twein <br>  983dd279722154a12093410067fe070e - rootkit Twein <br></div></div><br><h2>  Art√≠culos anteriores de la serie: </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Operaci√≥n TA505: c√≥mo analizamos las nuevas herramientas de los creadores del troyano Dridex, el ransomware Locky y la botnet Neutrino.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 1</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Operaci√≥n TA505: Aprendizaje de la puerta trasera ServHelper con NetSupport RAT.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 2</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Operaci√≥n TA505: Infraestructura de red de agrupaci√≥n.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Parte 3</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/475328/">https://habr.com/ru/post/475328/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../475314/index.html">Eco-fantas√≠a para proteger el planeta.</a></li>
<li><a href="../475320/index.html">Recomendaciones de Microsoft para deshabilitar la caducidad de la contrase√±a: consecuencias y conclusiones</a></li>
<li><a href="../475322/index.html">Sonido √≥seo de siguiente nivel: revisi√≥n de Aftershokz Aeropex</a></li>
<li><a href="../475324/index.html">Programaci√≥n funcional desde el punto de vista de EcmaScript. Composici√≥n, Curry, Aplicaci√≥n Parcial</a></li>
<li><a href="../475326/index.html">C√≥mo los estafadores hacen esto. Herramientas de enga√±o</a></li>
<li><a href="../475330/index.html">Concurso de complementos de la plataforma Miro con un premio de $ 21,000</a></li>
<li><a href="../475336/index.html">C√≥mo dejar de fumar correctamente (instrucci√≥n)</a></li>
<li><a href="../475338/index.html">Si no tiene Python, pero hay un modelo Keras y Java</a></li>
<li><a href="../475342/index.html">Andrey Sebrant (Yandex): negocios en la era de la inteligencia artificial</a></li>
<li><a href="../475346/index.html">Mientras el ej√©rcito de los Estados Unidos trata de leer las mentes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>