<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ” ğŸ‘ğŸ¼ ğŸ å®‰å“ç³»ç»Ÿ åœ°è¡¨ ğŸ‘¶ğŸ» ğŸ•  ğŸ‘¨ğŸ½â€ğŸ¤â€ğŸ‘¨ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å…è´£å£°æ˜ 


 æœ¬æ–‡é¢å‘æ²¡æœ‰ç»éªŒçš„åˆå­¦è€…androidå¼€å‘äººå‘˜ï¼Œå°¤å…¶æ˜¯é‚£äº›å¼€å§‹åˆ†ægrafikaç¤ºä¾‹ä½†å‘ç°å®ƒä»¬å¾ˆå›°éš¾çš„åˆå­¦è€… ï¼Œè¿™é‡Œæˆ‘ä»¬å°†çœ‹ä¸€ä¸‹ç±»ä¼¼çš„ä»£ç ï¼Œå¹¶é€šè¿‡çŠ¶æ€å›¾ç®€åŒ–åŸºæœ¬æ­¥éª¤çš„æè¿°ã€‚ 


 ä¸ºä»€ä¹ˆåœ¨æ ‡é¢˜ä¸­å‘ˆç°Surfaceç±»ï¼Ÿ åœ¨androidä¸­ï¼Œè®¸å¤šç±»çš„åç§°ï¼ˆSurfaceï¼ŒSurfac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å®‰å“ç³»ç»Ÿ åœ°è¡¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480878/"><h2 id="diskleymer"> å…è´£å£°æ˜ </h2><br><p> æœ¬æ–‡é¢å‘æ²¡æœ‰ç»éªŒçš„åˆå­¦è€…androidå¼€å‘äººå‘˜ï¼Œå°¤å…¶æ˜¯é‚£äº›å¼€å§‹åˆ†æ<a href="https://github.com/google/grafika" rel="nofollow">grafika</a>ç¤ºä¾‹ä½†å‘ç°å®ƒä»¬å¾ˆå›°éš¾çš„<a href="https://github.com/google/grafika" rel="nofollow">åˆå­¦è€…</a> ï¼Œè¿™é‡Œæˆ‘ä»¬å°†çœ‹ä¸€ä¸‹ç±»ä¼¼çš„ä»£ç ï¼Œå¹¶é€šè¿‡çŠ¶æ€å›¾ç®€åŒ–åŸºæœ¬æ­¥éª¤çš„æè¿°ã€‚ </p><br><p> ä¸ºä»€ä¹ˆåœ¨æ ‡é¢˜ä¸­å‘ˆç°Surfaceç±»ï¼Ÿ åœ¨androidä¸­ï¼Œè®¸å¤šç±»çš„åç§°ï¼ˆSurfaceï¼ŒSurfaceHolderï¼ŒSurfaceTextureï¼ŒSurfaceViewï¼ŒGLSurfaceViewï¼‰éƒ½å¸¦æœ‰Surfaceä¸€è¯ï¼Œå®ƒä»¬æ²¡æœ‰é€šè¿‡é€šç”¨çš„å±‚æ¬¡ç»“æ„è¿›è¡Œè¿æ¥ï¼Œä½†æ˜¯å®ƒä»¬é€šè¿‡ä½çº§é€»è¾‘è¿›è¡Œç»„åˆä»¥å¤„ç†å›¾åƒè¾“å‡ºã€‚ åœ¨æˆ‘çœ‹æ¥ï¼Œåœ¨æ ‡é¢˜ä¸­ä½¿ç”¨å®ƒæ¥å¼ºè°ƒå°è¯•å…¬å¼€ä½¿ç”¨SDKçš„æ­¤ç‰¹å®šéƒ¨åˆ†çš„å·¥ä½œæ˜¯åˆç†çš„ã€‚ </p><a name="habracut"></a><br><h2 id="primer-ispolzovaniya-s-raznym-api"> ä¸åŒAPIçš„ç”¨æ³•ç¤ºä¾‹ </h2><br><p> è®©æˆ‘ä»¬å°è¯•ç¼–å†™ä»¥ä¸‹ç¤ºä¾‹ï¼š <strong>æˆ‘ä»¬å°†ä»æ‘„åƒæœºè¿›è¡Œé¢„è§ˆï¼Œåœ¨å…¶ä¸Šå åŠ ä¸€ä¸ªåŠ¨ç”»å¯ç»˜åˆ¶å¯¹è±¡ï¼Œå°†å…¶å…¨éƒ¨æ˜¾ç¤ºåœ¨å±å¹•ä¸Šï¼Œå¹¶åœ¨å¿…è¦æ—¶å†™å…¥æ–‡ä»¶ã€‚</strong> å®Œæ•´çš„ä»£ç å°†ä½äº<a href="https://github.com/tttzof351/AndroidSurfaceExample/" rel="nofollow">https://github.com/tttzof351/AndroidSurfaceExample/</a> </p><br><p> ä¸ºäº†è¾“å‡ºåˆ°å±å¹•ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨<a href="https://developer.android.com/reference/android/opengl/GLSurfaceView" rel="nofollow">GLSurfaceView</a>è¿›è¡Œ<a href="https://developer.android.com/reference/android/media/MediaCodec" rel="nofollow">MediaCodec</a>å’Œ<a href="https://developer.android.com/reference/android/opengl/EGLSurface" rel="nofollow">EGLSurface</a>ç±»çš„è®°å½•ï¼Œå¹¶é€šè¿‡<a href="https://developer.android.com/reference/android/hardware/camera2/package-summary" rel="nofollow">API V2</a>ä¸æ‘„åƒæœºè¿›è¡Œé€šä¿¡ã€‚ æ€»ä½“æ–¹æ¡ˆå¤§è‡´å¦‚ä¸‹ï¼š </p><br><p><img src="https://habrastorage.org/webt/9o/rc/o5/9orco54m0chpg_og4db_qppsrjm.png"></p><br><h2 id="nalozhenie-neskolkih-surface"> å¤šä¸ªè¡¨é¢è¦†ç›– </h2><br><p> è¡¨é¢å®é™…ä¸Šæ˜¯å†…å­˜ä¸­éœ€è¦å¡«å……å›¾åƒçš„åŒºåŸŸçš„å¥æŸ„ã€‚ æœ€æœ‰å¯èƒ½çš„æ˜¯ï¼Œæˆ‘ä»¬è¯•å›¾åœ¨å±å¹•ä¸Šæˆ–æ–‡ä»¶ä¸­æ˜¾ç¤ºæŸäº›å†…å®¹ï¼Œå› æ­¤å®ƒå°±åƒæŸäº›ç”Ÿæˆæ•°æ®çš„â€œè¿›ç¨‹â€çš„ç¼“å†²åŒºä¸€æ ·å·¥ä½œã€‚ </p><br><p> è¦ä»å¤šä¸ªSurfaceåˆ›å»ºè¦†ç›–ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨OpenGLã€‚ <br> ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸¤ä¸ªæ­£æ–¹å½¢çš„å¤–éƒ¨çº¹ç†å¹¶ä»ä¸­è·å–Surface </p><br><p> åœ¨ä»£ç ä¸­ï¼Œå®ƒå°†å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><p>  <a href="" rel="nofollow">OpenGLExtarnalTexture.kt</a> </p><br><pre><code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> textures = IntArray(<span class="hljs-number"><span class="hljs-number">1</span></span>) GLES20.glGenTextures(<span class="hljs-number"><span class="hljs-number">1</span></span>, textures, <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> textureId = textures[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-comment"><span class="hljs-comment">//    val textureWidth = ... val textureHeight = ... //  val surfaceTexture = SurfaceTexture(textureId) surfaceTexture.setDefaultBufferSize(textureWidth, textureHeight) //, surface  ""    val surface = Surface(surfaceTexture)</span></span></code> </pre> <br><p>  <strong>XYZåæ ‡</strong> </p><br><p> ç°åœ¨æˆ‘ä»¬éœ€è¦äº†è§£å¦‚ä½•åˆ›å»ºå’Œæ’åˆ—çº¹ç†ï¼Œä¸ºæ­¤ï¼Œæˆ‘ä»¬å¿…é¡»è®°ä½åœ¨OpenGLä¸­åæ ‡ç½‘æ ¼çš„ç»“æ„æ–¹å¼ï¼šå…¶ä¸­å¿ƒä¸åœºæ™¯çš„ä¸­å¿ƒï¼ˆçª—å£ï¼‰é‡åˆï¼Œå¹¶ä¸”è¾¹ç•Œè¢«è§„èŒƒåŒ–ï¼Œå³ä»-1åˆ°1ã€‚ </p><br><p> åœ¨æ­¤åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬è¦è®¾ç½®ä¸¤ä¸ªçŸ©å½¢ï¼ˆå·¥ä½œåœ¨å¹³é¢ä¸Šï¼Œå› æ­¤æ‰€æœ‰zåæ ‡åœ¨é€»è¾‘ä¸Šéƒ½è®¾ç½®ä¸º0fï¼‰-çº¢è‰²è¡¨ç¤ºè¦æ”¾ç½®ç›¸æœºé¢„è§ˆçš„çŸ©å½¢ï¼Œè“è‰²è¡¨ç¤ºåŠ¨ç”»å¯ç»˜åˆ¶å¯¹è±¡çš„è“è‰²ï¼š </p><br><p> æˆ‘ä»¬æ˜ç¡®å†™ä¸‹æˆ‘ä»¬çš„åæ ‡ï¼š </p><br><p><img src="https://habrastorage.org/webt/mu/fj/kr/mufjkrznafatofs4lsn-ywm_h7i.png"></p><br><pre> <code class="kotlin hljs">fullscreenTexture = floatArrayOf( <span class="hljs-comment"><span class="hljs-comment">// X, Y, Z -1.0f, -1.0f, 0.0f, 1.0f, -1.0f, 0.0f, -1.0f, 1.0f, 0.0f, 1.0f, 1.0f, 0.0f, ) smallTexture = floatArrayOf( // X, Y, Z 0.3f, 0.3f, 0.0f, 0.8f, 0.3f, 0.0f, 0.3f, 0.8f, 0.0f, 0.8f, 0.8f, 0.0f )</span></span></code> </pre> <br><p>  <strong>ç´«å¤–çº¿åæ ‡</strong> </p><br><p> è¿™æ ·å¤Ÿäº†å— åŸæ¥æ²¡æœ‰:( </p><br><p> çº¹ç†æ˜¯å›¾ç‰‡åˆ°åœºæ™¯åŒºåŸŸçš„æ˜ å°„ï¼Œä¸ºäº†ä½¿å…¶æ­£ç¡®æ˜¾ç¤ºï¼Œæ‚¨éœ€è¦å‡†ç¡®æŒ‡å®šå›¾ç‰‡ä¸­çš„ç‚¹å°†è½åœ¨è¯¥åŒºåŸŸå†…çš„ä½ç½®-ä¸ºæ­¤ï¼ŒOpenGLä½¿ç”¨<strong>UV</strong>åæ ‡-å®ƒä»¬æ¥è‡ªå·¦ä¸‹è§’ï¼Œå¹¶ä¸”æ¯ä¸ªè¾¹ç•Œçš„è¾¹ç•Œä¸º0åˆ°1è½´ã€‚ </p><br><p> å®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼šæˆ‘ä»¬å°†ä¸ºåŒºåŸŸçš„æ¯ä¸ªé¡¶ç‚¹è®¾ç½®<strong>UV</strong>åæ ‡ï¼Œå¹¶å‡è®¾å›¾åƒçš„å®½åº¦å’Œé«˜åº¦ç­‰äº1ï¼Œç„¶ååœ¨å›¾åƒä¸­å¯»æ‰¾ç›¸åº”çš„ç‚¹ã€‚ </p><br><p> è€ƒè™‘ä¸€ä¸ªä¾‹å­-æˆ‘ä»¬å‡è®¾ç›¸æœºä»¥åè½¬å’Œåå°„çŠ¶æ€å‘æˆ‘ä»¬æä¾›å›¾åƒï¼ŒåŒæ—¶æˆ‘ä»¬åªæƒ³æ˜¾ç¤ºå³ä¸Šéƒ¨åˆ†ï¼Œå³å›¾åƒçš„çº¬åº¦å’Œé«˜åº¦ä¸º0.8ã€‚ </p><br><p> å¾®å¦™çš„ä¸€ç‚¹-åœ¨æ­¤é˜¶æ®µï¼Œæˆ‘ä»¬ä¸çŸ¥é“å±å¹•ä¸ŠåŒºåŸŸçš„çºµæ¨ªæ¯”-æˆ‘ä»¬åœ¨ç›¸å¯¹åæ ‡ä¸­åªæœ‰ä¸€ä¸ªæ­£æ–¹å½¢ï¼Œå®ƒå°†å¡«æ»¡æ•´ä¸ªåœºæ™¯å¹¶ç›¸åº”åœ°æ‹‰ä¼¸ã€‚ å¦‚æœæˆ‘ä»¬è¦åˆ¶ä½œå…¨å±ç›¸æœºï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç›¸å¯¹å°ºå¯¸ï¼ˆæ¯ä¾§2ä¸ªï¼‰å°†æ‰©å±•åˆ°ä¼ ç»Ÿçš„1080x1920ã€‚ æˆ‘ä»¬å‡è®¾æˆ‘ä»¬è®¾ç½®åœºæ™¯çš„å°ºå¯¸ï¼Œä»¥ä½¿å®ƒä»¬çš„æ¯”ä¾‹ç­‰äºæ‘„åƒæœºçš„æ¯”ä¾‹ã€‚ <br> è®©æˆ‘ä»¬çœ‹çœ‹åæ ‡çš„ä½ç½®-æˆ‘ä»¬åŒºåŸŸï¼ˆ1ï¼Œ1ï¼Œ0ï¼‰çš„å³ä¸Šè§’åº”è¯¥æŒ‡å‘UVåæ ‡ï¼ˆ0ï¼Œ0ï¼‰ï¼Œå·¦ä¸‹è§’ä¸ºï¼ˆ0.8fï¼Œ0.8fï¼‰ï¼Œä¾æ­¤ç±»æ¨ã€‚ </p><br><p><img src="https://habrastorage.org/webt/fk/ur/ig/fkurigpfo4l_hnl1fonbgj1dao0.png"></p><br><p> å› æ­¤ï¼Œæˆ‘ä»¬è·å¾—äº†XYZå’ŒUVçš„å¯¹åº”å…³ç³»ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">// X, Y, Z, U, V -1.0f, -1.0f, 0.0f, 0.8f, 0.8f, 1.0f, -1.0f, 0.0f, 0.8f, 0.0f, -1.0f, 1.0f, 0.0f, 0.0f, 0.8f, 1.0f, 1.0f, 0.0f, 0.0f, 0.0f</span></span></code> </pre> <br><p> å¦‚æœæ‘„åƒæœºé¢„è§ˆä¸å±å¹•ä¸Šçš„åŒºåŸŸä¹‹é—´çš„å®½é«˜æ¯”æœ€åˆæ˜¯ä¸€è‡´çš„ï¼Œé‚£ä¹ˆæ˜¾ç„¶å®ƒå°†ç»§ç»­ä¿å­˜ï¼Œå› ä¸ºåœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ˜¯ä¹˜ä»¥0.8fã€‚ <br> æˆ‘ä»¬å°†åƒä»€ä¹ˆï¼Œæˆ‘ä»¬å°†å€¼è®¾ç½®ä¸ºå¤§äº1ï¼Ÿ æ ¹æ®ä¼ é€’ç»™OpenGLçš„è®¾ç½®ï¼Œæˆ‘ä»¬å°†è·å¾—å›¾åƒæŸäº›éƒ¨åˆ†çš„ç‚¹ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæœ€åä¸€è¡Œå°†æ²¿ç€ç›¸åº”çš„è½´é‡å¤ï¼Œæˆ‘ä»¬å°†çœ‹åˆ°â€œæ¡çº¹â€å½¢å¼çš„å·¥ä»¶ </p><br><p>  <strong>åº•çº¿ï¼šå¦‚æœæˆ‘ä»¬æƒ³åœ¨ä¿æŒå±å¹•ä¸ŠåŒºåŸŸä½ç½®çš„åŒæ—¶å‹ç¼©/å‰ªåˆ‡å›¾åƒï¼Œé‚£ä¹ˆUVåæ ‡å°±æ˜¯æˆ‘ä»¬çš„é€‰æ‹©ï¼</strong> </p><br><p>  <strong>è®¾ç½®çº¹ç†çš„åæ ‡ã€‚</strong> </p><br><p><img src="https://habrastorage.org/webt/au/wp/zx/auwpzx9wgczhb79_4bbfu9nyk_a.png"></p><br><pre> <code class="kotlin hljs">fullscreenTexture = floatArrayOf( <span class="hljs-comment"><span class="hljs-comment">// X, Y, Z, U, V -1.0f, -1.0f, 0.0f, 1f, 0f, 1.0f, -1.0f, 0.0f, 0f, 0f, -1.0f, 1.0f, 0.0f, 1f, 1f, 1.0f, 1.0f, 0.0f, 0f, 1f ) smallTexture = floatArrayOf( // X, Y, Z, U, V 0.3f, 0.3f, 0.0f, 0f, 0f, 0.8f, 0.3f, 0.0f, 1f, 0f, 0.3f, 0.8f, 0.0f, 0f, 1f, 0.8f, 0.8f, 0.0f, 1f, 1f )</span></span></code> </pre> <br><p>  <strong>ç€è‰²å™¨</strong> </p><br><p> å…·æœ‰é™æ€XYZå’ŒUVåæ ‡ä¸æ˜¯å¾ˆæ–¹ä¾¿-ä¾‹å¦‚ï¼Œæˆ‘ä»¬å¯èƒ½æƒ³ä½¿ç”¨æ‰‹åŠ¿æ¥ç§»åŠ¨å’Œç¼©æ”¾çº¹ç†ã€‚ è¦å¯¹å…¶è¿›è¡Œè½¬æ¢ï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªçº¹ç†åˆ›å»ºä¸¤ä¸ªçŸ©é˜µï¼šåˆ†åˆ«ç”¨äºXYZå’ŒUVåæ ‡çš„<strong>MVPMatrix</strong>å’Œ<strong>TexMatrix</strong> ã€‚ </p><br><p> æ¯ä¸ªOpenGL2å¿…é¡»åŒ…å«ç€è‰²å™¨ï¼Œä»¥ä¾¿åœ¨å±å¹•ä¸Šæ˜¾ç¤ºæŸäº›å†…å®¹ã€‚ å½“ç„¶ï¼Œè¿™ä¸æ˜¯ä¸€ä¸ªå¯ä»¥åœ¨ä¸€ä¸ªæ®µè½ä¸­å…¬å¼€çš„ä¸»é¢˜ï¼Œä½†æ˜¯ï¼Œåœ¨æˆ‘ä»¬çš„æ¡ˆä¾‹ä¸­ï¼Œå®ƒä»¬å°†æ˜¯å¾®ä¸è¶³é“çš„ï¼Œå› æ­¤ï¼Œæ‚¨æ— éœ€äº†è§£å¤ªå¤šææ–™å°±å¯ä»¥å¿«é€Ÿäº†è§£å®ƒä»¬æ­£åœ¨åšä»€ä¹ˆã€‚ </p><br><p> é¦–å…ˆï¼Œæœ‰ä¸¤ä¸ªç€è‰²å™¨-é¡¶ç‚¹å’Œç‰‡æ®µã€‚ </p><br><p> ç¬¬ä¸€ä¸ªï¼ˆé¡¶ç‚¹ï¼‰å°†å¤„ç†æˆ‘ä»¬çš„é¡¶ç‚¹ï¼Œå³ï¼Œå°†æˆ‘ä»¬çš„XYZ / UVåæ ‡ä¹˜ä»¥å®ƒä»¬ç›¸åº”çš„çŸ©é˜µï¼Œç„¶åå¡«å……OpenGLå˜é‡<strong>gl_Position</strong> ï¼Œè¯¥å˜é‡å®Œå…¨è´Ÿè´£çº¹ç†åœ¨å±å¹•ä¸Šçš„æœ€ç»ˆä½ç½®ã€‚ </p><br><p> ç¬¬äºŒä¸ªï¼ˆç‰‡æ®µï¼‰åº”<strong>ä½¿ç”¨</strong>å›¾åƒåƒç´ å¡«å……<strong>gl_FragColor</strong> ã€‚ </p><br><p> æˆ‘ä»¬å…±æœ‰ï¼šé¡¶ç‚¹ç€è‰²å™¨ä¸­çš„å˜é‡ï¼Œæˆ‘ä»¬å¿…é¡»ç”¨æ•°æ®å¡«å……å­—æ®µï¼Œå³ï¼š </p><br><ul><li>  MVPMatrix-&gt; <strong>uMVPMatrix</strong> </li><li>  <strong>TexMatrix-&gt; uTexMatrix</strong> </li><li> æˆ‘ä»¬çš„XYZé¡¶ç‚¹åæ ‡-&gt; <strong>aPosition</strong> </li><li>  UVåæ ‡-&gt; <strong>aTextureCoord</strong> </li></ul><br><p>  <strong>vTextureCoord-</strong>éœ€è¦å°†æ•°æ®ä»é¡¶ç‚¹ç€è‰²å™¨è½¬å‘åˆ°ç‰‡æ®µç€è‰²å™¨ <br> åœ¨ç‰‡æ®µç€è‰²å™¨ä¸­ï¼Œæˆ‘ä»¬è·å–è½¬æ¢åçš„UVåæ ‡ï¼Œå¹¶ä½¿ç”¨å®ƒä»¬åœ¨çº¹ç†åŒºåŸŸä¸­æ˜¾ç¤ºå›¾åƒåƒç´ ã€‚ </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> vertexShader = <span class="hljs-string"><span class="hljs-string">""" uniform mat4 uMVPMatrix; uniform mat4 uTexMatrix; attribute vec4 aPosition; attribute vec4 aTextureCoord; varying vec2 vTextureCoord; void main() { gl_Position = uMVPMatrix * aPosition; vTextureCoord = (uTexMatrix * aTextureCoord).xy; } """</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fragmentShader = <span class="hljs-string"><span class="hljs-string">""" #extension GL_OES_EGL_image_external : require precision mediump float; varying vec2 vTextureCoord; uniform samplerExternalOES sTexture; void main() { gl_FragColor = texture2D(sTexture, vTextureCoord); } """</span></span></code> </pre> <br><p> ä½œä¸ºå‚è€ƒï¼Œæˆ‘ä»¬æŒ‡å‡ºäº†ä¸¤ç§ç±»å‹ä¹‹é—´çš„åŒºåˆ«ï¼š </p><br><ul><li> ç»Ÿä¸€çš„-è¿™ç§ç±»å‹çš„å˜é‡å°†åœ¨é‡å¤è°ƒç”¨æœŸé—´ä¿ç•™å€¼ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªç€è‰²å™¨ï¼Œè¯¥ç€è‰²å™¨è¢«ä¾æ¬¡è°ƒç”¨ä¸¤ä¸ªçº¹ç†ï¼Œå› æ­¤æˆ‘ä»¬ä»å°†è¦†ç›–æ¯ä¸ªæ¸²æŸ“ </li><li> å±æ€§-ä»é¡¶ç‚¹ç¼“å†²åŒºè¯»å–æ­¤ç±»å‹çš„æ•°æ®ï¼Œéœ€è¦åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶å°†å…¶åŠ è½½ </li><li> å˜åŒ–-å°†æ•°æ®ä»é¡¶ç‚¹ç€è‰²å™¨ä¼ è¾“åˆ°ç‰‡æ®µæ‰€éœ€ </li></ul><br><p> å¦‚ä½•å°†å‚æ•°ä¼ é€’ç»™ç€è‰²å™¨ï¼Ÿ ä¸ºæ­¤ï¼Œæ‚¨é¦–å…ˆéœ€è¦è·å–å˜é‡çš„IDï¼ˆæŒ‡é’ˆï¼‰ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> aPositionHandle = GLES20.glGetAttribLocation(programId, <span class="hljs-string"><span class="hljs-string">"aPosition"</span></span>)</code> </pre> <br><p> ç°åœ¨ï¼Œå¯¹äºæ­¤IDï¼Œæ‚¨éœ€è¦åŠ è½½æ•°æ®ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-comment"><span class="hljs-comment">//      floatbuffer val verticesBuffer = ByteBuffer.allocateDirect( fullscreenTexture.size * FLOAT_SIZE_BYTES ).order( ByteOrder.nativeOrder() ).asFloatBuffer() verticesBuffer.put(fullscreenTexture).position(0) /*    -  XYZ   0 .       id      ,     ,               - 5  - XYZUV,  4 - -   float */ verticesBuffer.position(0) GLES20.glVertexAttribPointer( aPositionHandle, 3, GLES20.GL_FLOAT, false, 5 * 4, verticesBuffer )</span></span></code> </pre> <br><p>  <strong>ç›´æ¥ç»˜å›¾</strong> </p><br><p> åœ¨å°†æ‰€æœ‰æ•°æ®å¡«å……åˆ°ç€è‰²å™¨ä¹‹åï¼Œæˆ‘ä»¬åº”è¯¥è¦æ±‚çº¹ç†æ›´æ–°å›¾åƒï¼Œå¹¶è¦æ±‚OpenGLç»˜åˆ¶é¡¶ç‚¹ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span></span> { ... surfaceTexture.updateTexImage() GLES20.glDrawArrays(GLES20.GL_TRIANGLE_STRIP, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) }</code> </pre> <br><p> åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†æŠŠOpenGLåœºæ™¯çš„å·¥ä½œåˆ†ä¸ºä¸¤ç±»-ç›´æ¥æ˜¯åœºæ™¯å’Œçº¹ç†ï¼š </p><br><p>  <a href="https://github.com/tttzof351/AndroidSurfaceExample/blob/master/app/src/main/java/com/example/surfaces/helpers/OpenGLExternalTexture.kt/" rel="nofollow">OpenGLExternalTexture.kt</a> </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OpenGLExternalTexture</span></span></span></span>(verticesData: FloatArray, ...) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> surfaceTexture: SurfaceTexture <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> surface: Surface <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,    . } ... fun updateFrame(aPositionHandle: Int, ...) {...} // ,   fun release() {...} //   }</span></span></code> </pre> <br><p>  <a href="" rel="nofollow">OpenGLScene.kt</a> </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OpenGLScene</span></span></span></span>( sceneWidth: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>, sceneHeight: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span>, ... ) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fullscreenTexture = OpenGLExternalTexture(...) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> smallTexture = OpenGLExternalTexture(..) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> aPositionHandle: <span class="hljs-built_in"><span class="hljs-built_in">Int</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ,        . } fun updateFrame() { ... fullscreenTexture.updateFrame(aPositionHandle, ...) smallTexture.updateFrame(aPositionHandle, ...) } fun release() { fullscreenTexture.release() smallTexture.release() } }</span></span></code> </pre> <br><h2 id="statemachine--mashina-sostoyaniy--konechnyy-avtomat">  StateMachine /çŠ¶æ€æœº/çŠ¶æ€æœº </h2><br><p> æˆ‘ä»¬æ‰“ç®—åœ¨ç¤ºä¾‹ä¸­ä½¿ç”¨çš„æ‰€æœ‰APIåŸºæœ¬ä¸Šéƒ½æ˜¯å¼‚æ­¥çš„ï¼ˆå—¯ï¼Œä¹Ÿè®¸æ˜¯åŠ¨ç”»Drawableé™¤å¤–ï¼‰ã€‚ æˆ‘ä»¬å°†è¿™äº›è°ƒç”¨åŒ…è£…åœ¨å•ç‹¬çš„StateMachinesä¸­ï¼Œè¯¥æ–¹æ³•æ˜¯æ˜¾å¼å†™å‡ºç³»ç»ŸçŠ¶æ€ï¼Œå¹¶é€šè¿‡å‘é€äº‹ä»¶è¿›è¡ŒçŠ¶æ€ä¹‹é—´çš„è½¬æ¢ã€‚ </p><br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä»¥ä¸‹ä»£ç ï¼š </p><br><pre> <code class="kotlin hljs">imageView.setOnClickListener { loadImage { bitmap -&gt; imageView.setBitmap(bitmap) } }</code> </pre> <br><p> æ€»çš„æ¥è¯´ï¼Œä¸€åˆ‡éƒ½å¾ˆå¥½-æ¼‚äº®è€Œç´§å‡‘ï¼Œä½†æ˜¯æˆ‘ä»¬å°†å°è¯•é€šè¿‡ä»¥ä¸‹æ–¹å¼é‡å†™å®ƒï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> uiMachine = UIMachine() imageView.setOnClickListener { uiMachine.send(Click(imageView)) } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UIMachine</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state: State = WaitClick() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(action: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Action</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = transition(action) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(action: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Action</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> state = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> { state <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WaitingClick &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Click -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = WaitBitmap(imageView = action.imageView) loadImage { send(BitmapIsReady(bitmap = it)) } } state <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WaitingBitmap &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> BitmapIsReady -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = WaitClick state.imageView.setImageBitmap(action.bitmap) } } } } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> WaitingClick : State() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WaitingBitmap</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> imageView: ImageView): State() } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Action</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Click</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> imageView: ImageView): Action() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BitmapIsReady</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bitmap: Bitmap): Action() }</code> </pre> <br><p> ä¸€æ–¹é¢ï¼Œç»“æœå´æ˜¯<strong><em>å¾ˆå¤š</em></strong> ï¼Œå°½ç®¡å¦‚æ­¤ï¼Œè¿˜æ˜¯å‡ºç°äº†ä¸€äº›éšå¼ä½†æœ‰ç”¨çš„å±æ€§ï¼šç°åœ¨é‡å¤æŒ‰ä¸‹å¹¶ä¸ä¼šå¯¼è‡´ä¸å¿…è¦çš„<strong>loadImage</strong> starts <strong>ï¼Œ</strong>å°½ç®¡å¯¹äºå¦‚æ­¤å¤§çš„å·æ¥è¯´è¿™å¹¶ä¸æ˜æ˜¾ï¼Œä½†æ˜¯æˆ‘ä»¬æ‘†è„±äº†åµŒå¥—çš„å›è°ƒè°ƒç”¨ï¼Œç¨åæˆ‘ä»¬å°†ä½¿ç”¨å®ƒï¼Œä»¥åŠtransitionæ–¹æ³•çš„ä¹¦å†™é£æ ¼å…è®¸æ‚¨æ„å»ºä¸€ä¸ªè¿‡æ¸¡å›¾ï¼Œè¯¥å›¾ä¸€å¯¹ä¸€åœ°é‡å¤ä»£ç ï¼Œå³åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼š </p><br><p><img src="https://habrastorage.org/webt/-n/2p/mq/-n2pmqdwfsps932me0wfsrvyj_q.png"><br> ç°è‰²è¡¨ç¤ºæœªæ˜ç¡®å†™å‡ºçš„è¿‡æ¸¡ã€‚ é€šå¸¸ï¼Œå®ƒä»¬è¢«è®°å½•æˆ–å¼•å‘å¼‚å¸¸ï¼Œè®¤ä¸ºè¿™æ˜¯é”™è¯¯çš„è¿¹è±¡ã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å°†è®¾æ³•å¿½ç•¥å®ƒï¼Œå¹¶ä¸”åœ¨å°†æ¥ï¼Œæˆ‘ä»¬å°†ä¸å†æŒ‡å‘è¿™äº›å›¾ã€‚ </p><br><p> åˆ›å»ºStateMachineçš„åŸºæœ¬æ¥å£ï¼š </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Action</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">State</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StateMachine</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">S : State, A : Action</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state: S <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(action: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">A</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(action: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">A</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> }</code> </pre> <br><h2 id="glsurfaceview">  GLSurfaceView </h2><br><p> åœ¨Androidä¸­ä½¿ç”¨OpenGLæ˜¾ç¤ºå†…å®¹çš„æœ€ç®€å•æ–¹æ³•æ˜¯GLSurfaceViewç±»-å®ƒä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªæ–°çš„ç»˜å›¾æµï¼Œå¹¶ä½¿ç”¨GLSurfaceView :: onResume / onPauseæ–¹æ³•å¼€å§‹/æš‚åœã€‚ </p><br><p> ä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†è§†å›¾è®¾ç½®ä¸º16ï¼š9çš„æ¯”ä¾‹ã€‚ </p><br><p> å‘ˆç°è¿‡ç¨‹æœ¬èº«å·²ç§»è‡³å•ç‹¬çš„å›è°ƒ-GLSurfaceView.Rendererã€‚ <br> å°†å…¶åŒ…è£…åœ¨StateMachineä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°å¦‚ä¸‹å†…å®¹ï¼š </p><br><p>  <a href="" rel="nofollow">GLSurfaceMachine.kt</a> </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GLSurfaceMachine</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">StateMachine</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GLSurfaceState, GLSurfaceAction</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> state: GLSurfaceState = WaitCreate() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(action: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">GLSurfaceAction</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> = transition(action) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transition</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(action: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">GLSurfaceAction</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> state = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> { state <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WaitCreate &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Create -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = WaitSurfaceReady(...) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state.glSurfaceView?.setRenderer(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> :Renderer { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSurfaceChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gl: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">GL10</span></span></span></span><span class="hljs-function"><span class="hljs-params">?, width: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, height: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> send(SurfaceReady(width, height, gl)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSurfaceCreated</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gl: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">GL10</span></span></span></span><span class="hljs-function"><span class="hljs-params">?, config: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">EGLConfig</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDrawFrame</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(gl: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">GL10</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { send(Draw) } }) } state <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WaitSurfaceReady &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> SurfaceReady -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> openGLScene = OpenGLScene(width, height) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = DrawingAvailable(openGLScene, ...) } state <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> DrawingAvailable &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Draw -&gt; { state.openGLScene.updateFrame() } state !<span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WaitCreate &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Stop -&gt; { state.uiHolder.glSurfaceView?.onPause() state.uiHolder.openGLScene?.release() <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.state = WaitSurfaceReady() } state <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> WaitSurfaceReady &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Start -&gt; { state.uiHolder.glSurfaceView?.onResume() } } } } ... <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> glSurfaceMachine = GLSurfaceMachine() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> glSurfaceView = findViewById(R.id.gl_view) glSurfaceView.layoutParams.width = width glSurfaceView.layoutParams.height = ((<span class="hljs-number"><span class="hljs-number">16f</span></span>/<span class="hljs-number"><span class="hljs-number">9f</span></span>) * width).toInt() glSurfaceMachine.send(GLSurfaceAction.Create(glSurfaceView, ...))</code> </pre> <br><p> è®©æˆ‘ä»¬ç”»ä¸€ä¸ªè¿‡æ¸¡å›¾ï¼š </p><br><p><img src="https://habrastorage.org/webt/mx/5i/xb/mx5ixbssfaqci1ktsmumu94jbz0.png"></p><br><p> ç°åœ¨ï¼Œæˆ‘ä»¬çš„ä»£ç æ­£åœ¨å°è¯•åœ¨å±å¹•ä¸Šæ˜¾ç¤ºæŸäº›å†…å®¹ï¼Œå°½ç®¡ç›®å‰å®ƒçš„æ•ˆæœå¾ˆå·®-é™¤äº†é»‘å±ï¼Œæˆ‘ä»¬çœ‹ä¸åˆ°å…¶ä»–ä»»ä½•å†…å®¹ã€‚ ä¸éš¾çŒœæµ‹ï¼Œç”±äºæˆ‘ä»¬å°šæœªå®ç°å›¾åƒæºï¼Œå› æ­¤ç°åœ¨æ²¡æœ‰ä»»ä½•ä¸œè¥¿è¿›å…¥Surfaceã€‚ è§£å†³è¿™ä¸ªé—®é¢˜-é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªCanvasDrawableï¼š </p><br><p>  <a href="" rel="nofollow">CanvasDrawable.kt</a> </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CanvasDrawable</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Drawable</span></span></span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> backgroundPaint = Paint().apply { ... } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> circlePaint = Paint().apply { ... } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(canvas: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Canvas</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { canvas.drawRect(bounds, backgroundPaint) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> width = bounds.width() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> height = bounds.height() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> posX = ... <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> posY = ... canvas.drawCircle(posX, posY, <span class="hljs-number"><span class="hljs-number">0.1f</span></span> * width, circlePaint) } ... }</code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡åœ¨ç”»å¸ƒä¸Šæ¸²æŸ“canvasDrawableæ¥è¡¥å……GLSâ€‹â€‹urfaceMachineä¸­çš„éƒ¨åˆ†ï¼Œè¯¥ç”»å¸ƒæä¾›ç›¸åº”çº¹ç†çš„è¡¨é¢ï¼š </p><br><pre> <code class="kotlin hljs">state <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> DrawingAvailable &amp;&amp; action <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Draw -&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> canvasDrawable = state.canvasDrawable <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> smallTexture = state.openGLScene.smallTexture <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> bounds = canvasDrawable.bounds <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> canvas = smallSurface.lockCanvas(bounds) canvasDrawable.draw(canvas) smallSurface.unlockCanvasAndPost(canvas) state.openGLScene.updateFrame() }</code> </pre> <br><p> ä¹‹åï¼Œæˆ‘ä»¬å°†çœ‹åˆ°ç±»ä¼¼ä»¥ä¸‹å†…å®¹çš„å†…å®¹ï¼š </p><br><p><img src="https://habrastorage.org/webt/vo/4r/-d/vo4r-dgpynjvynvxdomy2fezp9y.png"></p><br><h2 id="camera-api-v2"> ç›¸æœºAPI V2 </h2><br><p> ç»¿è‰²çŸ©å½¢è‚¯å®šå¾ˆæœ‰è¶£ä¸”å¼•äººå…¥èƒœï¼Œä½†æ˜¯ç°åœ¨æ˜¯æ—¶å€™å°è¯•å°†é¢„è§ˆä»æ‘„åƒæœºç§»åˆ°å…¶ä½™è¡¨é¢äº†ã€‚ </p><br><p> è®©æˆ‘ä»¬å†™ä¸‹ä½¿ç”¨ç›¸æœºçš„æ­¥éª¤ï¼š </p><br><ul><li> æˆ‘ä»¬æ­£åœ¨ç­‰å¾…è®¸å¯ã€‚ æˆ‘ä»¬å°†å…·æœ‰æ­¤çŠ¶æ€<strong>WaitingStart</strong> </li><li> æˆ‘ä»¬è·å¾—äº†ç›¸æœºç®¡ç†å™¨å®ä¾‹ï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†æ‰€éœ€ç›¸æœºçš„é€»è¾‘IDï¼ˆé€šå¸¸æœ‰ä¸¤ä¸ª-åé¢å’Œå‰é¢ï¼Œé€»è¾‘ä¸Šæ˜¯å› ä¸ºç›¸æœºå¯ä»¥ç”±ç°ä»£è®¾å¤‡ä¸Šçš„è®¸å¤šä¼ æ„Ÿå™¨ç»„æˆï¼‰ï¼Œé€‰æ‹©åˆé€‚çš„å¤§å°ï¼Œæ‰“å¼€ç›¸æœºï¼Œæˆ‘ä»¬å¾—åˆ°äº†cameraDeviceã€‚ çŠ¶æ€<strong>ç­‰å¾…ä¸­</strong> </li></ul><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> manager = getSystemService(Context.CAMERA_SERVICE) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> CameraManager <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultCameraId: String? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> resultSize: Size? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (cameraId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> manager.cameraIdList) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> chars = manager.getCameraCharacteristics(cameraId) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> facing = chars.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>(CameraCharacteristics.LENS_FACING) ?: -<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (facing == LENS_FACING_BACK) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> confMap = chars.<span class="hljs-keyword"><span class="hljs-keyword">get</span></span>( CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP ) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sizes = confMap?.getOutputSizes(SurfaceTexture::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resultSize</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">findSize</span></span></span></span>(sizes) resultCameraId = cameraId <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> } } resultCameraId?.let { cameraId -&gt; manager.openCamera(cameraId, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : CameraDevice.StateCallback() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onOpened</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(camera: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CameraDevice</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//Success open camera ... } }) }</span></span></code> </pre> <br><ul><li> æ‰“å¼€ç›¸æœºåï¼Œæˆ‘ä»¬è½¬å‘ç”³è¯·Surfaceæ¥æ˜¾ç¤ºå›¾åƒã€‚  <strong>ç­‰å¾…è¡¨é¢</strong>çŠ¶æ€ </li><li> ç°åœ¨æˆ‘ä»¬æœ‰äº†cameraDeviceï¼ŒSurfaceï¼Œæˆ‘ä»¬éœ€è¦æ‰“å¼€ä¸€ä¸ªä¼šè¯ï¼Œä»¥ä¾¿æ‘„åƒæœºæœ€ç»ˆå¼€å§‹ä¼ è¾“æ•°æ®ã€‚  <strong>ç­‰å¾…ä¼šè¯</strong>çŠ¶æ€ </li></ul><br><pre> <code class="kotlin hljs">cameraDevice.createCaptureSession( arrayListOf(surface), <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : CameraCaptureSession.StateCallback() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onConfigured</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(session: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">CameraCaptureSession</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { send(CameraAction.SessionReady(session)) } }, handler )</code> </pre> <br><ul><li> ç°åœ¨æˆ‘ä»¬å¯ä»¥æ•è·é¢„è§ˆã€‚  <strong>å¼€å§‹é¢„è§ˆ</strong>çŠ¶æ€ </li></ul><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> request = cameraDevice.createCaptureRequest( CameraDevice.TEMPLATE_PREVIEW ).apply { addTarget(surface) } session.setRepeatingRequest( request.build(), <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : CameraCaptureSession.CaptureCallback() {...} handler )</code> </pre> <br><p> æˆ‘ä»¬è¯´æ˜ä¸€ä¸‹å½“å‰çš„æ–¹æ¡ˆï¼š </p><br><p>  <a href="" rel="nofollow">CameraMachine.kt</a> </p><br><p><img src="https://habrastorage.org/webt/i6/tj/q1/i6tjq12xls77hudocvpnt0m6qy0.png"></p><br><p><img src="https://habrastorage.org/webt/6w/ad/fp/6wadfpayduldvtqwcrjggkoce6y.png"></p><br><h2 id="mediacodec"> åª’ä½“ç¼–è§£ç å™¨ </h2><br><p>  MediaCodecæ˜¯ç”¨äºä¸ç³»ç»Ÿç¼–è§£ç å™¨è¿›è¡Œä½çº§å·¥ä½œçš„ç±»ï¼Œé€šå¸¸ï¼Œå…¶APIæ˜¯ä¸€ç»„è¾“å…¥/è¾“å‡ºç¼“å†²åŒºï¼ˆä¸å¹¸çš„æ˜¯ï¼Œå¬èµ·æ¥æ¯”ä½¿ç”¨å®ƒæ›´å®¹æ˜“ï¼‰ï¼Œæ•°æ®ï¼ˆåŸå§‹æˆ–ç¼–ç å–å†³äºç¼–ç å™¨/è§£ç å™¨çš„æ“ä½œæ¨¡å¼ï¼‰æ”¾å…¥å…¶ä¸­ï¼Œå¹¶ä¸”åœ¨è¾“å‡ºä¸­ï¼Œæˆ‘ä»¬å¾—åˆ°ç»“æœã€‚ </p><br><p> å°½ç®¡ByteBufferé€šå¸¸å……å½“ç¼“å†²åŒºï¼Œä½†æ˜¯æ‚¨å¯ä»¥ä½¿ç”¨Surfaceæ¥å¤„ç†è§†é¢‘ï¼Œè¿™å°†å‘æˆ‘ä»¬è¿”å›MediaCodec :: createInputSurfaceï¼Œåœ¨å…¶ä¸Šæˆ‘ä»¬åº”è¯¥ç»˜åˆ¶è¦è®°å½•çš„å¸§ï¼ˆé€šè¿‡è¿™ç§æ–¹æ³•ï¼Œæ–‡æ¡£æ‰¿è¯ºé€šè¿‡ä½¿ç”¨gpuå¯ä»¥æ›´å¿«åœ°è¿›è¡Œç¼–ç ï¼‰ </p><br><p> å¥½äº†ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦å­¦ä¹ å¦‚ä½•åœ¨MediaCodecçš„Surfaceä¸Šç»˜åˆ¶æˆ‘ä»¬åœ¨GLSurfaceMachineä¸­åˆ›å»ºçš„ç°æœ‰Surfaceã€‚ è¯·åŠ¡å¿…è®°ä½ï¼šSurfaceæ˜¯ä¸€ä¸ªåˆ›å»ºä½¿ç”¨è€…çš„å¯¹è±¡ï¼Œé€šå¸¸æ— æ³•ä»å…¶ä¸­è¯»å–æŸäº›å†…å®¹ï¼Œå³æ²¡æœ‰æ¡ä»¶æ–¹æ³•getBitmap / readImage / ... </p><br><p> æˆ‘ä»¬å°†æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ“ä½œï¼šåœ¨ç°æœ‰çš„GLä¸Šä¸‹æ–‡çš„åŸºç¡€ä¸Šï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªæ–°çš„å…·æœ‰é€šç”¨å†…å­˜çš„å†…å­˜ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥é‡ç”¨æˆ‘ä»¬å…ˆå‰åœ¨æ­¤å¤„åˆ›å»ºçš„çº¹ç†çš„id-shniksã€‚ ç„¶åï¼Œä½¿ç”¨MediaCodecä¸­çš„æ–°GLä¸Šä¸‹æ–‡å’ŒSurfaceï¼Œæˆ‘ä»¬å°†åˆ›å»ºEGLSurface-å±å¹•å¤–ç¼“å†²åŒºï¼Œæˆ‘ä»¬è¿˜å¯ä»¥åœ¨è¯¥ç¼“å†²åŒºä¸Šåˆ›å»ºæˆ‘ä»¬çš„OpenGLSceneç±»ã€‚ ç„¶åï¼Œåœ¨æ¯ä¸ªå¸§æ¸²æŸ“æ—¶ï¼Œæˆ‘ä»¬å°†å°è¯•å°†å¸§å¹¶è¡Œå†™å…¥æ–‡ä»¶ã€‚ </p><br><p>  EGLè¡¨ç¤ºOpenGL APIä¸å¹³å°çš„çª—å£å­ç³»ç»Ÿçš„äº¤äº’æ¥å£ï¼Œæˆ‘ä»¬å°†ä»grafikaé‚£é‡Œçªƒå–å®ƒçš„å·¥ä½œã€‚ æˆ‘ä¹Ÿä¸ä¼šç›´æ¥ç”¨MediaCodecæè¿°ä¼ é€å¸¦ï¼ˆEncoderHelperï¼‰ï¼Œä»…ç»™å‡ºç»„ä»¶ä¹‹é—´äº¤äº’çš„æœ€ç»ˆæ–¹æ¡ˆï¼š </p><br><p>  <a href="" rel="nofollow">EncoderMachine.kt</a> <br>  <a href="" rel="nofollow">EncoderHelper.kt</a> </p><br><p><img src="https://habrastorage.org/webt/d1/gc/kf/d1gckfqligsrwynmmkq_bb2yzoy.png"></p><br><h2 id="itog"> ç»“æœï¼š </h2><br><ul><li> å¤„ç†è§†é¢‘è‡³å°‘éœ€è¦å…·å¤‡OpenGLçš„åŸºæœ¬æŠ€èƒ½ </li><li>  Android Media APIçš„åº•å±‚çº§åˆ«å¾ˆä½ï¼Œå› æ­¤å…·æœ‰ä¸€å®šçš„çµæ´»æ€§ï¼Œä½†æœ‰æ—¶å®ƒä¼šè¿«ä½¿æ‚¨ç¼–å†™æ¯”è‡ªå·±æƒ³è¦çš„ä»£ç æ›´å¤šçš„ä»£ç  </li><li> å¼‚æ­¥APIå¯ä»¥åŒ…è£…åœ¨StateMachinesä¸­ </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN480878/">https://habr.com/ru/post/zh-CN480878/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN480866/index.html">Webå¼€å‘çš„æ–°æ—¶ä»£æˆ–â€œä¸€åˆ‡å·²å­˜åœ¨â€</a></li>
<li><a href="../zh-CN480870/index.html">åå¹´ç»“æœ</a></li>
<li><a href="../zh-CN480872/index.html">è‹±ç‰¹å°”å…³é—­äº†å…­ä¸ªæœˆå‰çš„å®‰å…¨æ¼æ´</a></li>
<li><a href="../zh-CN480874/index.html">ä¸­å¾®å­çš„ç ”ç©¶å¯¼è‡´æ•°å­¦ä¸Šçš„æ„å¤–å‘ç°</a></li>
<li><a href="../zh-CN480876/index.html">æˆ‘ä»¬æ¸…ç†Dockï¼Œä½¿åº”ç”¨ç¨‹åºæ²¡æœ‰xCode</a></li>
<li><a href="../zh-CN480884/index.html">5åˆ†é’Ÿå†…å®ŒæˆPython GUI</a></li>
<li><a href="../zh-CN480886/index.html">ç¥ç»ç½‘ç»œä¸é»„é‡‘åˆ†å‰²ï¼šç¬¬äºŒæ¬¡</a></li>
<li><a href="../zh-CN480888/index.html">DIYåç¨‹ã€‚ ç¬¬1éƒ¨åˆ†ã€‚æƒ°æ€§å‘ç”Ÿå™¨</a></li>
<li><a href="../zh-CN480890/index.html">ä½¿ç”¨Expressé¢æ¿çš„è°ƒæŸ¥ç»“æœ</a></li>
<li><a href="../zh-CN480892/index.html">æ°”çƒäº’è”ç½‘</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>