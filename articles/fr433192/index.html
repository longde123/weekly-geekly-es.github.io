<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÄ „ÄΩÔ∏è ‚ôèÔ∏è Kubernetes: une solution de projet personnel incroyablement abordable üèÇ üßòüèæ üë©üèæ‚Äç‚öñÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour coll√®gues! 

 En janvier, nous avons enfin le livre tant attendu sur Kubernetes. Discours sur la ¬´Mastering Kubernetes 2nd edition¬ª par Gigi S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Kubernetes: une solution de projet personnel incroyablement abordable</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/433192/">  Bonjour coll√®gues! <br><br>  En janvier, nous avons enfin le livre tant attendu sur Kubernetes.  Discours sur la ¬´Mastering Kubernetes 2nd edition¬ª par Gigi Saifan: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/mp/6r/pc/mp6rpcu9hby7scugehhegmzmtrs.jpeg"></div><br>  Nous n'avons pas os√© publier un livre sur Kubernetes il y a environ un an, car √† cette √©poque la technologie ressemblait d√©finitivement √† un dreadnought pour les super corporations.  Cependant, la situation est en train de changer, √† l'appui de laquelle nous sugg√©rons de lire un grand article de Caleb Doxsey, qui a d'ailleurs √©crit un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">livre</a> sur la langue du Go.  Les arguments de M. Doxy sont tr√®s int√©ressants et nous esp√©rons qu'apr√®s les avoir lus, vous voudrez vraiment essayer Kubernetes dans la pratique. <br><a name="habracut"></a><br>  J'ai pass√© quelques mois au d√©but de cette ann√©e sur une √©tude approfondie de Kubernetes: j'en avais besoin pour un projet de travail.  Kubernetes est une technologie compl√®te pour la gestion des infrastructures, elle "inclut tout, m√™me les batteries".  Kubernetes r√©sout un certain nombre de probl√®mes que vous √™tes condamn√© √† rencontrer lors du d√©veloppement pour les grandes entreprises.  Cependant, la croyance que Kubernetes est une technologie trop sophistiqu√©e qui n'est pertinente que pour la gestion d'un grand cluster de machines est r√©pliqu√©e.  Apparemment, la charge op√©rationnelle lors de l'utilisation de Kubernetes est si grande que son utilisation pour les petites infrastructures, o√π la machine ne va pas par dizaines, est un tir de canon sur des moineaux. <br>  Je me permets d'√™tre en d√©saccord avec cela.  Kubernetes est √©galement bon pour les petits projets, et aujourd'hui vous pouvez d√©j√† vous permettre votre propre cluster Kubernetes pour moins de <b>5 $</b> par mois. <br><br>  <b>Un mot pour d√©fendre Kubernetes</b> <br><br>  Ci-dessous, je vais vous montrer comment configurer votre propre cluster Kubernetes, mais essayez d'abord d'expliquer pourquoi Kubernetes devrait √™tre utilis√© dans de petits projets: <br><br>  <i>Kubernetes est minutieux</i> <br><br>  Oui, √† premi√®re vue, Kubernetes semble √™tre une solution quelque peu redondante.  Il semble plus facile d'obtenir et d'obtenir une machine virtuelle et de ne pas configurer votre propre application en tant que service, pourquoi pas?  En choisissant cette voie, vous devrez d√©cider de certaines solutions, notamment: <br><br><ol><li>  Comment d√©ployer l'application?  Il suffit de le resynchroniser sur le serveur? </li><li>  Et les d√©pendances?  Si vous travaillez avec Python ou Ruby, vous devrez les installer sur le serveur.  Allez-vous simplement ex√©cuter les commandes manuellement? </li><li>  Comment allez-vous lancer l'application?  Ex√©cutez simplement le binaire en arri√®re-plan, puis rien?  Ce n'est probablement pas trop bon, donc si vous organisez l'application en tant que service, vous devez apprendre systemd? </li><li>  Comment allez-vous g√©rer le fonctionnement de nombreuses applications lorsqu'elles ont toutes des noms de domaine ou des chemins http diff√©rents?  (vous devez probablement configurer haproxy ou nginx pour cela) </li><li>  Supposons que vous ayez mis √† jour votre application.  Comment allez-vous alors d√©ployer les changements?  Arr√™ter le service, d√©ployer le code, red√©marrer le service?  Comment √©viter les temps d'arr√™t? </li><li>  Et si vous bloquez le d√©ploiement?  Il y a des opportunit√©s de revenir en arri√®re?  (R√©pertoire Symlink ...? Ce script simple ne semble plus particuli√®rement simple) </li><li>  Votre application utilise-t-elle d'autres services, par exemple, redis?  Comment configurer tous ces services? </li></ol><br>  Kubernetes r√©sout tous ces probl√®mes.  Naturellement, ils sont tous r√©solus par d'autres moyens, parmi lesquels il existe de meilleures options pour Kubernetes;  cependant, il est pr√©f√©rable de ne pas penser √† tout cela et de se concentrer sur le d√©veloppement d'applications. <br><br>  <i>Kubernetes est fiable</i> <br><br>  Un seul serveur plantera toujours.  Oui, c'est rare, peut-√™tre une fois par an, mais apr√®s un tel √©v√©nement, un vrai mal de t√™te commence: comment remettre tout en condition de travail.  Cela est particuli√®rement vrai si vous avez manuellement configur√© vous-m√™me l'int√©gralit√© de la configuration.  Rappelez-vous toutes les √©quipes qui ont couru la derni√®re fois?  Vous souvenez-vous de ce qui a fonctionn√© sur le serveur?  Je me souviens d'une citation de bashorg: <br><blockquote>  erno: Hmm.  Perdu l'ordinateur ... s√©rieusement, _lost_.  Il r√©pond, fonctionne bien, je ne sais pas o√π il est all√© dans l'appartement. <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">bash.org/?5273</a> </blockquote>  Exactement la m√™me chose m'est arriv√©e r√©cemment sur mon propre blog.  J'avais juste besoin de mettre √† jour le lien, mais j'ai compl√®tement oubli√© comment d√©ployer le blog.  Soudain, un correctif de dix minutes s'est transform√© en un travail pendant tout un week-end. <br><br>  Kubernetes utilise un format <b>descriptif</b> , vous savez donc toujours quelles choses, quand et o√π il √©tait cens√© s'ex√©cuter;  De plus, tous les composants de votre syst√®me d√©ploy√© sont beaucoup plus visibles.  De plus, dans le plan de contr√¥le, la d√©faillance des n≈ìuds est g√©r√©e avec soin et les foyers sont automatiquement redistribu√©s.  Lorsque vous travaillez avec un service qui ne conserve pas l'√©tat, par exemple, avec une application Web, vous pouvez probablement oublier compl√®tement les √©checs. <br><br>  <i>Apprendre Kubernetes n'est pas plus difficile que des alternatives</i> <br><br>  Kubernetes ne suit pas le mod√®le Unix.  Il ne rentre pas dans l'√©cosyst√®me d'outils.  Il ne fait pas partie de ces d√©cisions qui "ne font qu'une chose et le font bien".  Kubernetes est une solution compl√®te √† de nombreux probl√®mes, capable de remplacer une vari√©t√© de trucs et d'outils auxquels les d√©veloppeurs sont d√©j√† habitu√©s. <br><br>  Kubernetes a sa propre terminologie, ses propres outils, son propre paradigme de gestion de serveur, qui diff√®re consid√©rablement de l'approche Unix traditionnelle.  Lorsque vous naviguez sur ces syst√®mes, de nombreuses fonctionnalit√©s de Kubernetes peuvent sembler al√©atoires et trop compliqu√©es, voire cruelles.  Je suppose qu'il y a de bonnes raisons pour lesquelles cette complexit√© est apparue, mais ici je ne dis pas que Kubernetes est simple et √©l√©mentaire √† comprendre;  Je dis que les connaissances de Kubernetes suffisent pour cr√©er et prendre en charge n'importe quelle infrastructure. <br><br>  Cela ne veut pas dire que tout administrateur syst√®me poss√®de une formation suffisante sous Unix.  Par exemple, apr√®s avoir obtenu mon dipl√¥me universitaire, j'ai travaill√© pendant 5 ans dans l'√©cosyst√®me Windows.  Je peux dire que mon premier emploi dans une startup o√π j'avais besoin de traiter avec Linux, a n√©cessit√© une transformation difficile.  Je ne connaissais pas les commandes de m√©moire, je n'ai pas l'habitude d'utiliser la ligne de commande pour presque toutes les occasions.  Il m'a fallu un certain temps pour apprendre √† travailler avec la nouvelle plate-forme (m√™me si j'avais d√©j√† une certaine exp√©rience en programmation √† ce moment-l√†), mais je me souviens clairement combien j'ai souffert. <br><br>  Avec Kubernetes, vous pouvez commencer tout le travail √† partir de z√©ro.  Dans Kubernetes, vous pouvez facilement provisionner des services m√™me sans connexion SSH au serveur.  Vous n'avez pas besoin d'apprendre systemd;  il n'est pas n√©cessaire de comprendre les niveaux d'ex√©cution ni de savoir quelle commande a √©t√© utilis√©e: <code>groupadd</code> ou <code>addgroup</code> ;  Vous n'avez pas √† apprendre √† g√©rer <code>ps</code> ou, Dieu nous en pr√©serve, vim.  Tout ce mat√©riel est utile et important, rien n'en dispara√Æt nulle part.  J'ai un grand respect pour les administrateurs syst√®me capables de se frayer un chemin √† travers n'importe quel environnement Unix.  Mais serait-ce cool que les d√©veloppeurs puissent acqu√©rir de mani√®re productive toutes ces ressources sans se plonger dans de telles subtilit√©s d'administration? <br><br>  Est-ce vraiment √ßa: <br><br><pre> <code class="plaintext hljs">[Unit] Description=The NGINX HTTP and reverse proxy server After=syslog.target network.target remote-fs.target nss-lookup.target [Service] Type=forking PIDFile=/run/nginx.pid ExecStartPre=/usr/sbin/nginx -t ExecStart=/usr/sbin/nginx ExecReload=/usr/sbin/nginx -s reload ExecStop=/bin/kill -s QUIT $MAINPID PrivateTmp=true [Install] WantedBy=multi-user.target</code> </pre> <br>  Beaucoup plus difficile que √ßa? <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: my-nginx spec: selector: matchLabels: run: my-nginx replicas: 1 template: metadata: labels: run: my-nginx spec: containers: - name: my-nginx image: nginx ports: - containerPort: 80</code> </pre> <br>  Et c'est toujours un cas relativement bon.  Si vous g√©rez l'infrastructure √† 100% √† distance, vous ne pourrez pas fournir de prise en charge manuelle du serveur.  Pour ce faire, vous aurez besoin d'une sorte d'outil: ansible, sel, chef, marionnette, etc.  Naturellement, pour ma√Ætriser Kubernetes et travailler efficacement avec lui, vous devez apprendre beaucoup, mais ce n'est pas plus difficile que de g√©rer des alternatives. <br><br>  <b>Kubernetes open source</b> <br><br>  √Ä l'√®re de l'√©norme popularit√© des technologies sans serveur, Kubernetes se distingue par son ind√©pendance vis-√†-vis de fournisseurs sp√©cifiques.  Il existe au moins 3 fournisseurs populaires et faciles √† g√©rer de Kubernetes (Google, Amazon, Microsoft) qui ne dispara√Ætront pas dans un avenir pr√©visible.  Il existe √©galement de nombreuses entreprises qui g√®rent avec succ√®s leurs propres clusters Kubernetes, et chaque jour le nombre de ces entreprises se multiplie.  Aujourd'hui, travailler avec Kubernetes d√®s le premier jour est une solution √©vidente pour la plupart des startups. <br>  Kubernetes, √©tant un projet open source, est bien document√©, stable et populaire, et tous les probl√®mes peuvent √™tre trait√©s avec autant de d√©tails que possible sur stackoverflow.  Bien s√ªr, Kubernetes a ses propres bugs et d√©fis techniques, mais je vous assure: il y a des gars dans le monde qui perfectionnent Kubernetes avec une comp√©tence incroyable.  Leur travail est vos dividendes;  au cours des prochaines ann√©es, cette technologie ne fera que s'am√©liorer. <br><br>  <b>√âcailles Kubernetes</b> <br><br>  L'un des d√©fis associ√©s √† la prise en charge de l'infrastructure est le suivant: les techniques qui sont utiles lors du d√©ploiement de petits syst√®mes r√©ussissent rarement √† se reproduire dans des syst√®mes plus grands.  Il est certainement pratique de lier SCP un fichier binaire au serveur, de tuer le processus et de le red√©marrer si vous n'avez qu'un seul serveur.  Mais, lorsque vous devez prendre en charge plusieurs serveurs et les surveiller simultan√©ment, une telle t√¢che peut s'av√©rer extr√™mement difficile.  C'est pourquoi vous ne pouvez pas vous passer d'outils comme le chef ou la marionnette lors de la gestion d'une telle infrastructure. <br><br>  Cependant, si vous choisissez le mauvais outil, au fil du temps, il peut vous conduire dans un coin.  Soudain, il s'av√®re que le chef-serveur leader n'est pas en mesure de faire face √† la charge de 1000 serveurs, le d√©ploiement bleu-vert ne correspond pas √† votre mod√®le et il faut des heures pour terminer les t√¢ches capistrano.  Lorsque l'infrastructure atteint une certaine taille, vous serez oblig√© de d√©molir tout ce qui a d√©j√† √©t√© fait et de recommencer.  Ce serait formidable si vous pouviez sortir de cette roue d'√©cureuil √©ternelle avec une infrastructure et passer √† une technologie qui √©voluera en fonction de vos besoins? <br><br>  Kubernetes ressemble beaucoup √† une base de donn√©es SQL.  SQL est le produit de nombreuses ann√©es de le√ßons difficiles sur le stockage de donn√©es et l'interrogation efficace.  Vous n'aurez probablement jamais besoin d'un dixi√®me de ces fonctionnalit√©s fournies dans une base de donn√©es SQL valide.  Vous pourriez m√™me √™tre en mesure de concevoir un syst√®me plus efficace, en vous appuyant sur votre propre base de donn√©es.  Mais dans la grande majorit√© des situations, la base de donn√©es SQL ne satisfera pas seulement tous vos besoins, mais augmentera consid√©rablement votre capacit√© √† √©mettre rapidement des solutions toutes faites.  Les sch√©mas SQL et l'indexation sont beaucoup plus faciles √† utiliser que les structures de donn√©es natives bas√©es sur des fichiers, car les structures de donn√©es natives deviendront presque certainement obsol√®tes √† mesure que votre produit grandit et se d√©veloppe avec le temps.  Mais la base de donn√©es SQL est susceptible de survivre √† toute refactorisation in√©vitable. <br><br>  Kubernetes survivra aussi.  Peut-√™tre que votre projet parall√®le ne se d√©veloppera jamais √† une telle √©chelle o√π ses probl√®mes ne peuvent √™tre r√©solus qu'avec Kubernetes, mais Kubernetes poss√®de absolument tous les outils pour tous les probl√®mes, et les comp√©tences que vous acquerrez en traitant de cette bo√Æte √† outils peuvent s'av√©rer √™tre inestimable dans les projets futurs. <br><br>  <b>Cr√©ez votre propre cluster Kubernetes</b> <br><br>  Je pense donc qu'il est conseill√© d'utiliser Kubernetes dans de petits projets, mais seulement si la mise en place d'un cluster se r√©v√®le simple et peu co√ªteuse.  Il s'av√®re que les deux sont r√©alisables.  Il existe des fournisseurs g√©r√©s par Kubernetes qui g√®rent tout le d√©sordre par eux-m√™mes, prenant en charge le plan de contr√¥le de l'h√¥te Kubernetes.  Et les r√©centes guerres de dumping dans l'environnement d'infrastructure cloud ont conduit √† une r√©duction √©tonnante du co√ªt de ces services. <br>  Nous analyserons le cas suivant en utilisant le moteur Kubernetes de Google (GKE) √† titre d'exemple, cependant, vous pouvez √©galement consulter les offres d'Amazon (EKS) ou de Microsoft (AKS) si Google ne vous convient pas.  Pour cr√©er votre propre cluster Kubernetes, nous avons besoin de: <br><br><ul><li>  Nom de domaine (~ 10 $ / an, selon le domaine) </li><li>  H√©bergement DNS Cloudflare (gratuit) </li><li>  Cluster √† trois n≈ìuds GKE Kubernetes (~ 5 $ / mois) </li><li>  Application Web t√©l√©charg√©e en tant que conteneur Docker dans le Google Container Registry (GCR) (gratuit) </li><li>  Un certain nombre de fichiers yaml pour la configuration de Kubernetes </li></ul><br>  Pour des √©conomies suppl√©mentaires, nous allons essayer de nous passer d'un contr√¥leur d'entr√©e Google.  √Ä la place, nous utiliserons Nginx sur chaque n≈ìud comme d√©mon et cr√©erons notre propre op√©rateur qui synchronisera les adresses IP externes du n≈ìud de travail avec Cloudflare. <br><br>  <b>Configuration de Google</b> <br><br>  Tout d'abord, acc√©dez √† console.cloud.google.com et cr√©ez un projet, si vous ne l'avez pas d√©j√† fait.  Vous devrez √©galement cr√©er un compte de facturation.  Ensuite, via le menu hamburger, acc√©dez √† la page Kubernetes et cr√©ez un nouveau cluster.  Voici ce que vous devez faire ensuite: <br><br><ul><li>  S√©lectionnez Zonal pour le type d'emplacement. </li><li>  J'ai indiqu√© mon emplacement comme us-central1-a </li><li>  Choisissez votre version de kubernetes </li><li>  Cr√©ez un pool de 3 n≈ìuds en utilisant le type d'instance le moins cher (f1-micro). </li><li>  Pour ce pool de n≈ìuds, sur l'√©cran ¬´avanc√©¬ª, d√©finissez la taille du disque de d√©marrage sur 10 Go, activez les n≈ìuds extrud√©s (ils sont moins chers), activez la mise √† jour automatique et le traitement automatique. </li><li>  Sous le pool de n≈ìuds, vous trouverez un certain nombre d'options suppl√©mentaires.  Nous voulons d√©sactiver l'√©quilibrage de charge HTTP (l'√©quilibrage de charge dans GCP co√ªte cher), et d√©sactiver √©galement l'ensemble de l'√©conomie associ√©e √† StackDriver (il peut √©galement √™tre co√ªteux et, selon mon exp√©rience, pas tr√®s fiable).  √âteignez √©galement le panneau indicateur kubernetes. </li></ul><br>  Apr√®s avoir mis toutes ces options, vous pouvez passer √† l'√©tape suivante: cr√©er un cluster.  Voici comment √©conomiser dessus: <br><br><ul><li>  Plan de contr√¥le Kubernetes: gratuit, car Google ne facture pas les n≈ìuds h√¥tes </li><li>  Noeuds de travail Kubernetes: 5,04 $ / mois, en r√®gle g√©n√©rale, 3 micro-noeuds vous co√ªteront 11,65 $ / mois, et apr√®s les avoir √©vinc√©s, nous r√©duirons ce taux √† 7,67 $ / mois, et toujours gratuit - √† 5,04 $. </li><li>  Frais de stockage: gratuit.  Nous obtenons gratuitement 30 Go d'espace disque permanent, nous avons donc choisi ci-dessus la taille de 10 Go. </li><li>  Co√ªts de l'√©quilibrage de charge: gratuitement, nous avons d√©sactiv√© l'√©quilibrage de charge HTTP, car cela nous co√ªterait seulement 18 $ / mois.  Au lieu de cela, ex√©cutez nos propres proxys HTTP sur chaque n≈ìud et dirigez le DNS vers l'IP publique. </li><li>  Frais de r√©seau: gratuit, la fonction de sortie reste gratuite jusqu'√† ce que vous s√©lectionniez 1 Go par mois.  (Ensuite, chaque gigaoctet suivant co√ªte 8 cents) </li></ul><br>  Nous avons donc mis en place un cluster Kubernetes de 3 n≈ìuds, cela nous a co√ªt√© le m√™me prix que la seule machine Digital Ocean. <br><br>  En plus de configurer GKE, vous devez √©galement configurer quelques r√®gles de pare-feu afin que vous puissiez atteindre les ports HTTP de nos h√¥tes depuis le monde ext√©rieur.  Recherchez l'entr√©e VPC Network dans le menu hamburger, puis acc√©dez aux r√®gles de pare-feu et ajoutez les r√®gles pour les ports TCP 80 et 443, avec la plage d'adresses IP 0.0.0.0/0. <br><br><img src="https://habrastorage.org/webt/if/ag/gz/ifaggzw5xpzfosqf_lxon8bqsdo.jpeg"><br><br>  R√®gles de pare-feu <br><br>  <b>R√©glage local</b> <br><br>  Nous avons donc cr√©√© et d√©marr√© le cluster, et maintenant configurons-le.  Installez l'outil <code>gcloud</code> suivant les instructions sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">cloud.google.com/sdk/docs</a> .  Apr√®s l'avoir install√©, vous pouvez proc√©der √† la configuration en proc√©dant comme suit: <br><br><pre> <code class="plaintext hljs">gcloud auth login</code> </pre> <br>  Bien s√ªr, vous devez toujours installer docker, puis le lier au GCR, afin de pouvoir envoyer des conteneurs: <br><br><pre> <code class="plaintext hljs">gcloud auth configure-docker</code> </pre> <br>  Vous pouvez √©galement installer et configurer <code>kubectl</code> en suivant les instructions d√©crites ici. <br><br>  Simplifi√©: <br><br><pre> <code class="plaintext hljs">gcloud components install kubectl gcloud config set project PROJECT_ID gcloud config set compute/zone COMPUTE_ZONE gcloud container clusters get-credentials CLUSTER_NAME</code> </pre> <br>  Soit dit en passant, c'est juste un conte de f√©es que toute cette bo√Æte √† outils fonctionne sur Windows, OSX ou Linux.  En tant que personne qui a parfois fait de telles choses sous Windows, j'avoue que c'est une agr√©able surprise. <br><br>  <b>Cr√©ation d'applications Web</b> <br><br>  Une application Web peut √™tre √©crite dans n'importe quel langage de programmation.  Le conteneur vous permet d'abstraire le particulier.  Il faut cr√©er une application HTTP √† l'√©coute sur le port.  Je pr√©f√®re Go √† de telles fins, mais pour changer, nous essaierons le cristal.  Cr√©ez le fichier <code>main.cr</code> : <br><br><pre> <code class="plaintext hljs"># crystal-www-example/main.cr require "http/server" Signal::INT.trap do exit end server = HTTP::Server.new do |context| context.response.content_type = "text/plain" context.response.print "Hello world from crystal-www-example! The time is #{Time.now}" end server.bind_tcp("0.0.0.0", 8080) puts "Listening on http://0.0.0.0:8080" server.listen</code> </pre> <br>  Nous avons √©galement besoin d'un Dockerfile: <br><br><pre> <code class="plaintext hljs"># crystal-www-example/Dockerfile FROM crystallang/crystal:0.26.1 as builder COPY main.cr main.cr RUN crystal build -o /bin/crystal-www-example main.cr --release ENTRYPOINT [ "/bin/crystal-www-example" ]</code> </pre> <br>  Pour cr√©er et tester notre application, ex√©cutez: <br><br><pre> <code class="plaintext hljs">docker build -t gcr.io/PROJECT_ID/crystal-www-example:latest . docker run -p 8080:8080 gcr.io/PROJECT_ID/crystal-www-example:latest</code> </pre> <br>  Et puis allez dans le navigateur localhost: 8080.  Apr√®s avoir √©tabli ce m√©canisme, nous pouvons envoyer notre application √† GCR en ex√©cutant: <br><br><pre> <code class="plaintext hljs">docker push gcr.io/PROJECT_ID/crystal-www-example:latest</code> </pre> <br>  <b>Configurer Kubernetes</b> <br><br>  Ma configuration Kubernetes est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Pour cet exemple, nous devrons cr√©er plusieurs fichiers yaml o√π nos diff√©rents services seront pr√©sent√©s, puis ex√©cuter kubectl apply pour les configurer dans le cluster.  La configuration de Kubernetes est descriptive, et tous ces fichiers yaml indiquent √† Kubernetes quel √©tat nous voulons obtenir.  Au sens large, c'est ce que nous allons faire: <br><br><ul><li>  Cr√©er un d√©ploiement et un service pour notre application Web Crystal-www-example </li><li>  Cr√©er un ensemble de d√©mons (ensemble de services) et une carte de configuration (carte de configuration) pour nginx </li><li>  Nous lan√ßons notre propre application pour synchroniser les n≈ìuds IP avec Cloudflare for DNS </li></ul><br>  <b>Configuration d'application Web</b> <br><br>  Tout d'abord, configurons notre application Web: (assurez-vous de remplacer <code>PROJECT_ID</code> par l'ID de votre projet) <br><br><pre> <code class="plaintext hljs"># kubernetes-config/crystal-www-example.yaml apiVersion: apps/v1 kind: Deployment metadata: name: crystal-www-example labels: app: crystal-www-example spec: replicas: 1 selector: matchLabels: app: crystal-www-example template: metadata: labels: app: crystal-www-example spec: containers: - name: crystal-www-example image: gcr.io/PROJECT_ID/crystal-www-example:latest ports: - containerPort: 8080 --- kind: Service apiVersion: v1 metadata: name: crystal-www-example spec: selector: app: crystal-www-example ports: - protocol: TCP port: 8080 targetPort: 8080</code> </pre> <br>  Cela cr√©e un d√©ploiement (configuration √©tendue), selon lequel Kubernetes doit cr√©er un seul conteneur (notre conteneur Docker y fonctionnera) et un service que nous utiliserons pour trouver des services dans notre cluster.  Pour appliquer cette configuration, ex√©cutez (√† partir du <code>kubernetes-config</code> ): <br><br><pre> <code class="plaintext hljs">kubectl apply -f</code> </pre> <br>  Vous pouvez le tester comme ceci: <br><br><pre> <code class="plaintext hljs">kubectl get pod #     : # crystal-www-example-698bbb44c5-l9hj9 1/1 Running 0 5m</code> </pre> <br><br>  Nous pouvons √©galement cr√©er une API proxy pour l'acc√®s: <br><br><pre> <code class="plaintext hljs">kubectl proxy</code> </pre> <br>  Et puis allez: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">localhost</a> : 8001 / api / v1 / namespaces / default / services / crystal-www-example / proxy / <br><br>  <b>Configuration NGINX</b> <br><br>  En r√®gle g√©n√©rale, lors de l'utilisation de services HTTP, Kubernetes utilise un contr√¥leur d'entr√©e.  Malheureusement, l'√©quilibreur de charge HTTP de Google est trop cher, nous ne l'utiliserons donc pas, mais utilisez notre propre proxy HTTP et configurez-le manuellement (cela semble effrayant, mais en r√©alit√©, c'est tr√®s simple). <br><br>  Pour ce faire, utilisez Daemon Set et Config Map.  Daemon Set est une application qui s'ex√©cute sur chaque n≈ìud.  Config Map est, en principe, un petit fichier que nous pouvons monter dans un conteneur;  ce fichier stockera la configuration nginx. <br>  Le fichier yaml ressemble √† ceci: <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: DaemonSet metadata: name: nginx labels: app: nginx spec: selector: matchLabels: app: nginx template: metadata: labels: app: nginx spec: hostNetwork: true dnsPolicy: ClusterFirstWithHostNet containers: - image: nginx:1.15.3-alpine name: nginx ports: - name: http containerPort: 80 hostPort: 80 volumeMounts: - name: "config" mountPath: "/etc/nginx" volumes: - name: config configMap: name: nginx-conf --- apiVersion: v1 kind: ConfigMap metadata: name: nginx-conf data: nginx.conf: | worker_processes 1; error_log /dev/stdout info; events { worker_connections 10; } http { access_log /dev/stdout; server { listen 80; location / { proxy_pass http://crystal-www-example.default.svc.cluster.local:8080; } } }</code> </pre> <br>  C'est ainsi que nous montons le fichier nginx.conf de la carte de configuration dans le conteneur nginx.  Nous d√©finissons √©galement des valeurs pour deux autres champs: <code>hostNetwork: true</code> , afin que vous puissiez lier le port h√¥te et atteindre nginx de l'ext√©rieur et <code>dnsPolicy: ClusterFirstWithHostNet</code> afin que vous puissiez acc√©der aux services au sein du cluster.  Si cela n'est pas fait, nous obtiendrons une configuration compl√®tement standard. <br><br>  Appliquez ces expressions et vous pouvez acc√©der √† nginx via l'IP publique de vos n≈ìuds. <br><br>  Voici comment vous pouvez le v√©rifier: <br><br><pre> <code class="plaintext hljs">kubectl get node -o yaml # look for: # - address: ... # type: ExternalIP</code> </pre><br>  Alors maintenant, notre application Web est accessible depuis Internet.  Reste √† trouver un beau nom pour l'application. <br><br>  <b>Connexion DNS</b> <br><br>  Il est n√©cessaire de d√©finir 3 enregistrements DNS A pour les n≈ìuds de notre cluster: <br><br><img src="https://habrastorage.org/webt/1l/0t/xx/1l0txxf6dye-lyuxpbndghsw_ta.png"><br><br>  Entr√©es dans l'interface utilisateur Cloudflare <br><br>  Ajoutez ensuite un enregistrement CNAME pour pointer vers ces enregistrements A.  (par exemple, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">www.example.com</a> CNAME pour kubernetes.example.com).  Cela peut √™tre fait manuellement, mais mieux - automatiquement, de sorte que si nous avons besoin de mettre √† l'√©chelle ou de remplacer des n≈ìuds dans des enregistrements DNS, ces informations sont √©galement mises √† jour automatiquement. <br><br>  Je pense que cet exemple illustre bien comment vous pouvez d√©l√©guer une partie de votre travail √† Kubernetes, et ne pas essayer de le surmonter.  Kubernetes comprend les scripts et poss√®de une API puissante, et vous pouvez remplir les espaces existants avec vos propres composants, qui ne sont pas si difficiles √† √©crire.  Pour ce faire, j'ai r√©alis√© une petite application sur Go, disponible √† cette adresse: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">kubernetes-cloudflare-sync</a> . <br><br>  Pour commencer, j'ai cr√©√© un informateur: <br><br><pre> <code class="go hljs">factory := informers.NewSharedInformerFactory(client, time.Minute) lister := factory.Core().V1().Nodes().Lister() informer := factory.Core().V1().Nodes().Informer() informer.AddEventHandler(cache.ResourceEventHandlerFuncs{ AddFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, UpdateFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(oldObj, newObj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, DeleteFunc: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">interface</span></span></span></span><span class="hljs-function"><span class="hljs-params">{})</span></span></span></span> { resync() }, }) informer.Run(stop)</code> </pre> <br>  Il appellera ma fonction de resynchronisation chaque fois qu'un n≈ìud change.  Ensuite, je synchronise l'API √† l'aide de la biblioth√®que d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">API Cloudflare</a> , quelque chose comme ceci: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ips []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, node := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> nodes { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, addr := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> node.Status.Addresses { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> addr.Type == core_v1.NodeExternalIP { ips = <span class="hljs-built_in"><span class="hljs-built_in">append</span></span>(ips, addr.Address) } } } sort.Strings(ips) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, ip := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> ips { api.CreateDNSRecord(zoneID, cloudflare.DNSRecord{ Type: <span class="hljs-string"><span class="hljs-string">"A"</span></span>, Name: options.DNSName, Content: ip, TTL: <span class="hljs-number"><span class="hljs-number">120</span></span>, Proxied: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, }) }</code> </pre> <br>  Ensuite, comme avec notre application Web, nous lan√ßons cette application dans Kubernetes en tant que d√©ploiement: <br><br><pre> <code class="plaintext hljs">apiVersion: apps/v1 kind: Deployment metadata: name: kubernetes-cloudflare-sync labels: app: kubernetes-cloudflare-sync spec: replicas: 1 selector: matchLabels: app: kubernetes-cloudflare-sync template: metadata: labels: app: kubernetes-cloudflare-sync spec: serviceAccountName: kubernetes-cloudflare-sync containers: - name: kubernetes-cloudflare-sync image: gcr.io/PROJECT_ID/kubernetes-cloudflare-sync args: - --dns-name=kubernetes.example.com env: - name: CF_API_KEY valueFrom: secretKeyRef: name: cloudflare key: api-key - name: CF_API_EMAIL valueFrom: secretKeyRef: name: cloudflare key: email</code> </pre> <br>  Nous devrons cr√©er un secret Kubernetes en sp√©cifiant la <code>cloudflare api</code> et l'adresse postale: <br><br><pre> <code class="plaintext hljs">kubectl create secret generic cloudflare --from-literal=email='EMAIL' --from-literal=api-key='API_KEY'</code> </pre> <br>  Nous devrons √©galement cr√©er un compte de service (donnant √† notre d√©ploiement un acc√®s √† l'API Kubernetes pour r√©cup√©rer les n≈ìuds).  Premi√®re course (en particulier pour GKE): <br><br><pre> <code class="plaintext hljs">kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user YOUR_EMAIL_ADDRESS_HERE</code> </pre> <br><br>  Et puis appliquez: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ServiceAccount metadata: name: kubernetes-cloudflare-sync --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRole metadata: name: kubernetes-cloudflare-sync rules: - apiGroups: [""] resources: ["nodes"] verbs: ["list", "watch"] --- apiVersion: rbac.authorization.k8s.io/v1 kind: ClusterRoleBinding metadata: name: kubernetes-cloudflare-sync-viewer roleRef: apiGroup: rbac.authorization.k8s.io kind: ClusterRole name: kubernetes-cloudflare-sync subjects: - kind: ServiceAccount name: kubernetes-cloudflare-sync namespace: default</code> </pre> <br>  Travailler avec RBAC est un peu fastidieux, mais j'esp√®re que tout est clair ici.  Lorsque la configuration est pr√™te et que notre application fonctionne avec Cloudflare, cette application peut √™tre mise √† jour avec tout changement dans l'un des n≈ìuds. <br><br>  <b>Conclusion</b> <br><br>  Kubernetes est destin√© √† devenir la technologie phare pour la gestion de grands syst√®mes. ,   Kubernetes     ,    Kubernetes    ,    Kubernetes   ,      Kubernetes   . <br><br>    ,  Kubernetes       :      ,  .       ‚Äì   ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr433192/">https://habr.com/ru/post/fr433192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr433180/index.html">R√©solution des probl√®mes de type de donn√©es dans Ruby ou Fiabilisation des donn√©es</a></li>
<li><a href="../fr433182/index.html">Est-il possible de former un agent pour la n√©gociation en bourse avec des renforts? Impl√©mentation du langage R</a></li>
<li><a href="../fr433184/index.html">ASP.NET Core 2.2 est sorti. Quoi de neuf (2 sur 3)</a></li>
<li><a href="../fr433186/index.html">Il ne suffit pas de compter les polygones pour optimiser les mod√®les 3D</a></li>
<li><a href="../fr433188/index.html">Un projet de loi sur le travail autonome de Runet a √©t√© soumis √† la Douma d'√âtat</a></li>
<li><a href="../fr433194/index.html">Veilleuse programm√©e</a></li>
<li><a href="../fr433196/index.html">Guide cadeaux du Nouvel An</a></li>
<li><a href="../fr433198/index.html">10 dollars pour l'h√©bergement: il y a 20 ans et aujourd'hui</a></li>
<li><a href="../fr433202/index.html">Choisir l'architecture d'une solution pour une place de march√© des services de fret</a></li>
<li><a href="../fr433204/index.html">Comment apprendre le d√©veloppement Java? L'exp√©rience de l'√©tudiante GeekUniversity Nikita Chernetsov</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>