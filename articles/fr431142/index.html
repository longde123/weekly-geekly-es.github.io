<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☝🏼 🕝 👍🏾 Comment exécuter SQL Profiler Trace la nuit, à une heure précise? 🙏🏽 👋🏾 👩🏽‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment exécuter la trace du profileur SQL lorsqu'un problème doit être détecté de 3h00 à 3h30 du matin? Cela peut être fait à l'aide d'une trace côté...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment exécuter SQL Profiler Trace la nuit, à une heure précise?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/431142/"> Comment exécuter la trace du profileur SQL lorsqu'un problème doit être détecté de 3h00 à 3h30 du matin?  Cela peut être fait à l'aide d'une trace côté serveur, mais cela est extrêmement gênant.  Ce n'est pas difficile, mais inconfortable et toujours paresseux.  Enfin, j'ai décidé d'automatiser cela une fois pour toutes.  Comme ça: <br><br><img src="https://habrastorage.org/webt/_r/ty/7m/_rty7m9htl1loovg_kulcfxev2k.png"><br><a name="habracut"></a><br>  Au fait, Jenkins ici est complètement optionnel et ne sert que d'interface pour appeler un script avec les paramètres nécessaires: <br><br><img src="https://habrastorage.org/webt/tg/wi/kd/tgwikde13ffvjgenfni2wmgeb2g.png"><br><br>  Je vais montrer la solution à grands traits, de toute façon il y a beaucoup de spécificités liées spécifiquement à notre infrastructure.  Autrement dit, je ferai ce qui est montré à gauche: <br><br><img src="https://habrastorage.org/webt/ff/i0/fq/ffi0fqqs7gbi3aczbucvusrw2qi.jpeg"><br><br>  Ainsi, le fichier bat fait quelque chose et transfère déjà l'action au script PowerShell auquel il transmet tous les paramètres et deux autres variables - '% BUILD_USER_ID%', '% BUILD_USER_EMAIL%' - reçues de Jenkins.  Ils nous seront utiles ultérieurement: <br><br><img src="https://habrastorage.org/webt/ao/u4/qw/aou4qwgabqzva2mxxrgmpurc0lm.png"><br><br>  Curieusement, il se passe peu de choses vraiment très utiles dans la ps1 elle-même: une certaine procédure y est appelée, qui crée et renvoie le nom du répertoire sur un partage spécial par le nom du serveur où ce fichier sera placé.  Le serveur sur lequel ce répertoire sera créé dépend du centre de données où se trouve le serveur sur lequel la trace sera lancée.  De plus, l'utilisateur a le droit de lire la trace et il existe un processus qui nettoie ces répertoires en quelques jours.  Comme vous pouvez le voir, vous n'en aurez peut-être pas besoin et vous pouvez ignorer tout cela en toute sécurité. <br><br>  Maintenant, l'action est déjà transférée sur le serveur où la trace sera lancée, dans le fichier SQL.  loc est juste un paramètre contenant le chemin où la trace finie sera copiée.  Vous pouvez le remplacer par une constante. <br><br><img src="https://habrastorage.org/webt/zk/6n/wm/zk6nwmrrxc05dasxdocadwafeti.png"><br><br>  Nous devons d'abord trouver un endroit où nous allons écrire le fichier de trace localement.  Par exemple, comme ceci: <br><br><img src="https://habrastorage.org/webt/ir/yi/r1/iryir1hj9hvwgrm3cpzpkwmedkw.png"><br><br>  Ensuite, un peu de nettoyage.  Soudain, un tel fichier existe déjà, ou quelqu'un a-t-il exécuté la trace plus tôt?  Vous devrez quitter sys.traces et arrêter / supprimer l'écriture de trace dans% jenkinsTraceSch%, s'il en existe déjà.  Ensuite, créez une trace (limitez sa taille!) Et un peu d'ennui avec les appels sp_trace_setevent.  Vous pouvez vous faciliter la vie en faisant CROSS JOIN entre les événements et les colonnes: <br><br><img src="https://habrastorage.org/webt/jv/pg/jy/jvpgjysiy2bcfgoa6clr_7fqnis.png"><br><br>  Maintenant, ajoutez des filtres au goût.  Ici, vous venez de terminer votre hibou.  C'est le premier endroit où nous utilisons des paramètres de script - type de filtre et nom de la base de données: <br><br><img src="https://habrastorage.org/webt/k8/9t/lx/k89tlxrj6xz_mr5niefx8dnllny.png"><br><br>  Maintenant, le thrash est allé: <br><br><img src="https://habrastorage.org/webt/vq/uf/xv/vqufxvy5xwqohpy0hihhbx1cpc8.png"><br><br>  Dans @j, vous formez une commande pour Job, qui sera: <br><br><ul><li>  Attendez le bon moment avec WAITFOR </li><li>  Courez la piste </li><li>  Attendez l'heure commandée </li><li>  Arrêtez la course </li><li>  Attendez une seconde au cas où - opérations asynchrones </li><li>  Former une équipe pour copier la trace au bon endroit </li><li>  Réalisez-la </li><li>  Formulaire Objet et lettres de corps </li><li>  Envoyer une lettre au client via sp_send_dbmail avec un lien vers la trace </li></ul><br>  Nous devons maintenant créer Job avec l'étape 1 décrite dans @j.  Cependant, j'ajoute encore le suicide à ce Job pour que Joba disparaisse sans laisser de trace à la fin du travail: <br><br><img src="https://habrastorage.org/webt/vk/mi/kw/vkmikw0o4-ziozt1vk_gh0q9h2g.png"><br><br>  Ici, j'entends des cris à propos de xp_cmdshell ... Je ne veux pas faire de commentaire à ce sujet.  En fin de compte, personne ne devrait témoigner contre lui-même devant le tribunal.  Mais vous pouvez faire autrement.  Il est peu probable que vous puissiez envoyer la trace par courrier - c'est gros.  Bien que vous puissiez l'emballer.  Eh bien, laissez-le sur le serveur lui-même et laissez l'utilisateur le récupérer lui-même ou tirez-le via UNC à un endroit accessible à l'utilisateur <br><br>  Vous avez donc: <br><br><ul><li>  Jenkins appelle la chauve-souris </li><li>  chauve-souris appelle PowerShell </li><li>  PowerShell appelle le script SQL via sqlcmd </li><li>  Le script crée Job </li><li>  Job crée une trace et envoie du courrier avant le suicide: </li></ul><br>  Je n'aurais jamais pensé qu'une aussi longue chaîne fonctionnerait.  Mais ça marche ... <br><br><img src="https://habrastorage.org/webt/er/vs/gi/ervsgidlkkydbzvoyea8u38w6sc.png"><br><br>  PS: Et oui, même si xp_cmdshell est interdit et que vous ne pouvez pas l'activer, vous avez au moins 2 façons d'écrire my_xp_cmdshell.  Cette "protection" ne protège donc contre rien. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr431142/">https://habr.com/ru/post/fr431142/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr431132/index.html">Reuters: la Russie augmentera les amendes des sociétés Internet à 1% du chiffre d'affaires annuel</a></li>
<li><a href="../fr431134/index.html">Téléphone SIP sur STM32F7-Discovery</a></li>
<li><a href="../fr431136/index.html">Des téraoctets en apesanteur dans votre poche - est l'avenir ici? Exploration des fonctionnalités d'HyperX SAVAGE EXO</a></li>
<li><a href="../fr431138/index.html">Biométrie avec la clé Rostelecom: comment le FSB a lancé pour la première fois la cryptographie russe dans les magasins d'applications</a></li>
<li><a href="../fr431140/index.html">Reportage de la métapa Go in Production: vidéo, photos, présentations</a></li>
<li><a href="../fr431144/index.html">Far Fields mic (Mic array) - héros discret dans une colonne intelligente</a></li>
<li><a href="../fr431146/index.html">1. Check Point Log Analysis: l'application officielle Check Point pour Splunk</a></li>
<li><a href="../fr431148/index.html">La nouvelle entreprise mobile iOS. Partie # 1: Génération de code pour les ressources</a></li>
<li><a href="../fr431152/index.html">Metro 4 est un voyage de 6 ans. Une brève histoire de Metro UI CSS</a></li>
<li><a href="../fr431154/index.html">Les lacunes dans les quêtes de Fallout 76 ont permis aux joueurs de faire de l'enfer nucléaire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>