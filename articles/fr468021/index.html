<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>😈 🐗 🔁 PHP, combien d'abstraction pour les gens? 👠 🧗🏿 🖕</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Joy: Que se passe-t-il? 
 Tristesse: nous abstenons! Il y a quatre étapes. Ceci est le premier. Fragmentation non objective! 
 Bing Bong: D'accord, pa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>PHP, combien d'abstraction pour les gens?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/funcorp/blog/468021/"><img src="https://habrastorage.org/webt/wx/in/ae/wxinae8d5pdleez3sa9w1odeaw0.jpeg"><br>  <i>Joy: Que se passe-t-il?</i> <i><br></i>  <i>Tristesse: nous abstenons!</i>  <i>Il y a quatre étapes.</i>  <i>Ceci est le premier.</i>  <i>Fragmentation non objective!</i> <i><br></i>  <i>Bing Bong: D'accord, pas de panique.</i>  <i>Ce qui est important, c'est que nous restions tous ensemble.</i>  <i>[tout à coup son bras abstrait tombe]</i> <i><br></i>  <i>Joy: Oh!</i>  <i>[La tristesse et la joie commencent aussi à s'effondrer]</i> <i><br></i>  <i>Tristesse: nous en sommes à la deuxième étape.</i>  <i>Nous déconstruisons!</i>  <i>[Alors que Bing Bong tombe en morceaux]</i> <i><br></i>  <i>Bing Bong: Je ne sens pas mes jambes!</i>  <i>[prend une jambe en l'air] Oh, ils sont là.</i> <i><br></i>  <i><b>© Cartoon Inside Out</b></i> <br><br>  Tout le monde aime écrire du beau code.  Aux abstractions, lambdas, SOLIDES, SECS, DI, etc.  etc.  Dans cet article, je veux explorer combien cela coûte en termes de performances et pourquoi. <br><br>  Pour ce faire, nous prenons une tâche simple, séparée de la réalité, et nous y apporterons progressivement de la beauté, en mesurant la performance et en regardant sous le capot. <br><a name="habracut"></a><br>  <b>Avertissement:</b> Cet article ne doit en aucun cas être interprété comme un appel à écrire du mauvais code.  Il est préférable de régler à l'avance pour dire après avoir lu «Cool!  Maintenant je sais comment c'est à l'intérieur.  Mais, bien sûr, je ne l'utiliserai pas. »  :) <br><br>  Défi: <br><br><ol><li>  Fichier texte Dan. </li><li>  Nous le divisons en lignes. </li><li>  Coupez les espaces à gauche et à droite </li><li>  Jetez toutes les lignes vides. </li><li>  Nous remplaçons tous les espaces non simples par des espaces simples («ABC» -&gt; «ABC»). </li><li>  Les lignes de plus de 10 mots, selon les mots, sont inversées ("An Bn Cn" -&gt; "Cn Bn An"). </li><li>  Nous comptons le nombre de fois où chaque ligne se produit. </li><li>  Imprimez toutes les lignes qui se produisent plus de N fois. </li></ol><br>  En tant que fichier d'entrée, par tradition, nous prenons php-src / Zend / zend_vm_execute.h pour environ 70 000 lignes. <br><br>  En tant que runtime, prenez PHP 7.3.6. <br>  Regardons les opcodes compilés ici <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://3v4l.org</a> . <br><br>  Les mesures seront effectuées comme suit: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//     $start = microtime(true); ob_start(); for ($i = 0; $i &lt; 10; $i++) { //    } ob_clean(); echo "Time: " . (microtime(true) - $start) / 10;</span></span></code> </pre> <br><h3>  Première approche, naïve </h3><br>  Écrivons un simple code impératif: <br><br><pre> <code class="php hljs">$array = explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, file_get_contents(<span class="hljs-string"><span class="hljs-string">'/Users/rjhdby/CLionProjects/php-src/Zend/zend_vm_execute.h'</span></span>)); $cache = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($array <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($row)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; $words = preg_split(<span class="hljs-string"><span class="hljs-string">"/\s+/"</span></span>, trim($row)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($words) &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { $words = array_reverse($words); } $row = implode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, $words); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cache[$row])) { $cache[$row]++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $cache[$row] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($cache <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($value &gt; <span class="hljs-number"><span class="hljs-number">1000</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$key : $value"</span></span> . PHP_EOL; } }</code> </pre> <br>  Autonomie ~ 0,148 s. <br><br>  Tout est simple et il n'y a rien à dire. <br><br><h3>  La deuxième approche, procédurale </h3><br>  Nous refactorisons notre code et supprimons les actions élémentaires de la fonction. <br>  Nous essaierons d'adhérer au principe de la responsabilité exclusive. <br><br><div class="spoiler">  <b class="spoiler_title">Chausson sous le spoiler.</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContentFromFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $fileName)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, file_get_contents($fileName)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reverseWordsIfNeeded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array &amp;$input)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($input) &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { $input = array_reverse($input); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $input)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $words = preg_split(<span class="hljs-string"><span class="hljs-string">"/\s+/"</span></span>, trim($input)); reverseWordsIfNeeded($words); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, $words); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printIfSuitable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $input, int $threshold)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($input <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($value &gt; $threshold) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$key : $value"</span></span> . PHP_EOL; } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addToCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array &amp;$cache, string $line)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($cache[$line])) { $cache[$line]++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $cache[$line] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array $input)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">array</span></span></span><span class="hljs-function"> </span></span>{ $cache = []; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ($input <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($row)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; addToCache($cache, prepareString($row)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $cache; } printIfSuitable( processContent( getContentFromFile(<span class="hljs-string"><span class="hljs-string">'/Users/rjhdby/CLionProjects/php-src/Zend/zend_vm_execute.h'</span></span>) ), <span class="hljs-number"><span class="hljs-number">1000</span></span> );</code> </pre> <br></div></div><br>  Durée d'exécution ~ 0,275 s ... WTF!?  La différence est presque 2 fois! <br><br>  Voyons ce qu'est une fonction PHP du point de vue d'une machine virtuelle. <br><br>  Code: <br><br><pre> <code class="php hljs">$a = <span class="hljs-number"><span class="hljs-number">1</span></span>; $b = <span class="hljs-number"><span class="hljs-number">2</span></span>; $c = $a + $b;</code> </pre> <br>  Compile pour: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ------------------------------------------------------------------------------------- 2 0 E &gt; ASSIGN !0, 1 3 1 ASSIGN !1, 2 4 2 ADD ~5 !0, !1 3 ASSIGN !2, ~5</span></span></code> </pre><br>  Mettons l'ajout dans une fonction: <br><br><pre> <code class="php hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $a + $b; } $a = <span class="hljs-number"><span class="hljs-number">1</span></span>; $b = <span class="hljs-number"><span class="hljs-number">1</span></span>; $c = sum($a, $b);</code> </pre> <br>  Ce code est compilé en deux ensembles d'opcodes: un pour l'espace de noms racine et le second pour la fonction. <br><br>  Racine: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ------------------------------------------------------------------------------------- 2 0 E &gt; ASSIGN !0, 1 3 1 ASSIGN !1, 1 5 2 NOP 9 3 INIT_FCALL 'sum' 4 SEND_VAR !0 5 SEND_VAR !1 6 DO_FCALL 0 $5 7 ASSIGN !2, $5</span></span></code> </pre> <br>  Fonction: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands ------------------------------------------------------------------------------------- 5 0 E &gt; RECV !0 1 RECV !1 6 2 ADD ~2 !0, !1 3 &gt; RETURN ~2</span></span></code> </pre> <br>  C'est-à-dire  même si vous comptez simplement par opcodes, alors chaque appel de fonction ajoute 3 + 2N opcodes, où N est le nombre d'arguments passés. <br><br>  Et si vous creusez un peu plus profondément, alors ici nous changeons également le contexte d'exécution. <br><br>  Une estimation approximative de notre code refactorisé donne de tels nombres (rappelez-vous environ 70 000 itérations). <br>  Le nombre d'opcodes exécutés "supplémentaires": ~ 17 000 000. <br>  Nombre de changements de contexte: ~ 280 000. <br><br><h3>  La troisième approche, classique </h3><br>  Surtout sans philosopher, nous enveloppons toutes ces fonctions avec une classe. <br><br><div class="spoiler">  <b class="spoiler_title">Drap de lit sous le spoiler</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProcessFile</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $content; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $cache = []; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $fileName)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;content = explode(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>, file_get_contents($fileName)); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reverseWordsIfNeeded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(array &amp;$input)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($input) &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { $input = array_reverse($input); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $input)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">string</span></span></span><span class="hljs-function"> </span></span>{ $words = preg_split(<span class="hljs-string"><span class="hljs-string">"/\s+/"</span></span>, trim($input)); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;reverseWordsIfNeeded($words); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> implode(<span class="hljs-string"><span class="hljs-string">" "</span></span>, $words); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">printIfSuitable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(int $threshold)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $value) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($value &gt; $threshold) { <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"$key : $value"</span></span> . PHP_EOL; } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addToCache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(string $line)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache[$line])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache[$line]++; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache[$line] = <span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processContent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;content <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $row) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($row)) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;addToCache( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;prepareString($row)); } } } $processFile = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProcessFile(<span class="hljs-string"><span class="hljs-string">'/Users/rjhdby/CLionProjects/php-src/Zend/zend_vm_execute.h'</span></span>); $processFile-&gt;processContent(); $processFile-&gt;printIfSuitable(<span class="hljs-number"><span class="hljs-number">1000</span></span>);</code> </pre><br></div></div><br>  Délai: 0,297.  Ça a empiré.  Pas beaucoup, mais perceptible.  La création d'un objet (10 fois dans notre cas) est-elle si chère?  Nuuu ... Pas seulement ça. <br><br>  Voyons comment une machine virtuelle fonctionne avec une classe. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Adder</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a, $b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a = $a; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;b = $b; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a + <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;b; } } $a = <span class="hljs-number"><span class="hljs-number">1</span></span>; $b = <span class="hljs-number"><span class="hljs-number">1</span></span>; $adder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Adder($a, $b); $c = $adder-&gt;sum();</code> </pre> <br>  Il y aura trois ensembles d'opcodes, ce qui est logique: la racine et deux méthodes. <br><br>  Racine: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands --------------------------------------------------------------------------- 2 0 E &gt; NOP 16 1 ASSIGN !0, 1 17 2 ASSIGN !1, 1 18 3 NEW $7 :15 4 SEND_VAR_EX !0 5 SEND_VAR_EX !1 6 DO_FCALL 0 7 ASSIGN !2, $7 19 8 INIT_METHOD_CALL !2, 'sum' 9 DO_FCALL 0 $10 10 ASSIGN !3, $10</span></span></code> </pre> <br>  Constructeur: <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands --------------------------------------------------------------------------- 6 0 E &gt; RECV !0 1 RECV !1 7 2 ASSIGN_OBJ 'a' 3 OP_DATA !0 8 4 ASSIGN_OBJ 'b' 5 OP_DATA !1 9 6 &gt; RETURN null</span></span></code> </pre> <br>  Méthode de <b>somme</b> : <br><br><pre> <code class="php hljs">line <span class="hljs-comment"><span class="hljs-comment">#* EIO op fetch ext return operands --------------------------------------------------------------------------- 11 0 E &gt; FETCH_OBJ_R ~0 'a' 1 FETCH_OBJ_R ~1 'b' 2 ADD ~2 ~0, ~1 3 &gt; RETURN ~2</span></span></code> </pre> <br>  Le <b>nouveau</b> mot-clé est en fait converti en appel de fonction (lignes 3-6). <br>  Il crée une instance de la classe et appelle le constructeur avec les paramètres passés dessus. <br><br>  Dans le code des méthodes, nous serons intéressés à travailler avec les champs de classe.  Veuillez noter que si vous affectez un opcode <b>ASSIGN</b> simple avec des variables ordinaires pour l'affectation, alors pour les champs de classe, tout est quelque peu différent. <br><br>  Affectation - 2 opcodes <br><br><pre> <code class="php hljs"> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> ASSIGN_OBJ <span class="hljs-string"><span class="hljs-string">'a'</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> OP_DATA !<span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Lecture - 1 opcode <br><br><pre> <code class="php hljs"> <span class="hljs-number"><span class="hljs-number">1</span></span> FETCH_OBJ_R ~<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-string"><span class="hljs-string">'b'</span></span></code> </pre> <br>  Ici, vous devez savoir que <b>ASSIGN_OBJ</b> et <b>FETCH_OBJ_R sont</b> beaucoup plus compliqués et, par conséquent, plus <b>gourmands en</b> ressources qu'un simple <b>ASSIGN</b> , qui, en gros, copie simplement <b>zval</b> d'un morceau de mémoire à un autre. <br><br><div class="scrollable-table"><table><tbody><tr><th>  Opcode </th><th>  Le nombre de lignes du gestionnaire (code C) </th></tr><tr><td>  ASSIGN_OBJ </td><td>  149 </td></tr><tr><td>  OP_DATA </td><td>  30 </td></tr><tr><td>  FETCH_OBJ_R </td><td>  112 </td></tr><tr><td>  ASSIGNER </td><td>  26 </td></tr></tbody></table></div><br>  Il est clair qu'une telle comparaison est très loin d'être correcte, mais donne quand même une idée.  Un peu plus loin je ferai des mesures. <br><br>  Voyons maintenant combien il est coûteux d'instancier un objet.  Mesurons sur un million d'itérations: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueObject</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $a; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;a = $a; } } $start = microtime(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>($i = <span class="hljs-number"><span class="hljs-number">0</span></span>; $i &lt; <span class="hljs-number"><span class="hljs-number">1000000</span></span>; $i++){ <span class="hljs-comment"><span class="hljs-comment">// $a = $i; // $a = new ValueObject($i); } echo "Time: " . (microtime(true) - $start);</span></span></code> </pre> <br>  Affectation variable: 0,092. <br>  Objet d'instance: 0,889. <br><br>  Quelque chose comme ça.  Pas complètement gratuit, surtout si plusieurs fois. <br><br>  Eh bien, pour ne pas se lever deux fois, mesurons la différence entre travailler avec des propriétés et des variables locales.  Pour ce faire, modifiez notre code de cette façon: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueObject</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $b; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">try</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    // $this-&gt;b = $a; // $c = $this-&gt;b; //    // $b = $a; // $c = $b; return $c; } } $a = new ValueObject(); $start = microtime(true); for($i = 0; $i &lt; 1000000; $i++){ $b = $a-&gt;try($i); } echo "Simple. Time: " . (microtime(true) - $start);</span></span></code> </pre> <br><br>  Échange par affectation: 0,830. <br>  Échange par la propriété: 0,862. <br><br>  Juste un peu, mais plus longtemps.  Juste le même ordre de différence que vous avez obtenu après avoir encapsulé des fonctions dans une classe. <br><br><h3>  Conclusions banales </h3><br><ol><li>  La prochaine fois que vous souhaitez instancier un million d'objets, pensez à en avoir vraiment besoin.  Peut-être juste un tableau, hein? </li><li>  Écrire un code de spaghetti pour économiser une milliseconde - enfin, ça.  L'échappement est bon marché et les collègues peuvent les battre plus tard. </li><li>  Mais pour économiser 500 millisecondes, cela peut parfois avoir du sens.  L'essentiel est de ne pas aller trop loin et de se rappeler que ces 500 millisecondes sont très susceptibles d'être enregistrées uniquement par une petite section de code très chaud, et de ne pas transformer l'ensemble du projet en un vide de chagrin. </li></ol><br>  PS À propos de lambdas la prochaine fois.  C'est intéressant là-bas.  :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr468021/">https://habr.com/ru/post/fr468021/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr468011/index.html">L'histoire d'un robot hypothétique</a></li>
<li><a href="../fr468013/index.html">Un moyen simple et sûr d'automatiser les déploiements canaris avec Helm</a></li>
<li><a href="../fr468015/index.html">Ce que l'on sait actuellement sur ITIL 4 et qui utilise déjà la nouvelle bibliothèque</a></li>
<li><a href="../fr468017/index.html">La monade peut-être via async / attendre en C # (sans tâche ov!)</a></li>
<li><a href="../fr468019/index.html">Développement de sites Web sur WebAssembly avec NetCore 3 et Blazor</a></li>
<li><a href="../fr468023/index.html">L'intelligence artificielle dans le jeu de combat Shadow Fight 3</a></li>
<li><a href="../fr468025/index.html">Comment configurer SNI dans Zimbra OSE?</a></li>
<li><a href="../fr468027/index.html">Méthodes d'optimisation de code pour Redd. Partie 2: mémoire non cache et fonctionnement sur bus parallèle</a></li>
<li><a href="../fr468031/index.html">Nous portons un jeu multijoueur de C ++ sur le Web avec Cheerp, WebRTC et Firebase</a></li>
<li><a href="../fr468039/index.html">Meetup Moscou Kubernetes # 6 à Acronis (Fiztehpark) 10/03/2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>