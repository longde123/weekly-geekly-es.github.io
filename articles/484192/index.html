<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü•† ‚ú≥Ô∏è üóÑÔ∏è Aplicaciones f√°ciles y f√°ciles de implementar en el cartucho de Tarantool (parte 2) üë©üèø‚Äçüíº üî¢ üßòüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="M√°s recientemente, hablamos sobre c√≥mo implementar aplicaciones escritas en el cartucho de Tarantool . Pero la operaci√≥n no termina en la implementaci...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Aplicaciones f√°ciles y f√°ciles de implementar en el cartucho de Tarantool (parte 2)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/484192/"><p><img src="https://habrastorage.org/webt/yc/gm/xx/ycgmxxaqlvyslsrzoo6jnv1vmx0.jpeg"></p><br><p>  M√°s recientemente, <a href="https://habr.com/ru/company/mailru/blog/478710/">hablamos</a> sobre c√≥mo implementar aplicaciones escritas en el <a href="https://habr.com/ru/company/mailru/blog/465503/">cartucho de Tarantool</a> .  Pero la operaci√≥n no termina en la implementaci√≥n, por lo que hoy actualizaremos nuestra aplicaci√≥n y entenderemos c√≥mo administrar la topolog√≠a, la divisi√≥n y la autorizaci√≥n, as√≠ como cambiar la configuraci√≥n de roles. </p><br><p>  Inquisitivo por favor corte! </p><a name="habracut"></a><br><h2 id="na-chem-my-ostanovilis">  Donde paramos </h2><br><p>  La √∫ltima vez configuramos la siguiente topolog√≠a: </p><br><p><img src="https://habrastorage.org/webt/sw/0z/gm/sw0zgm53me7ft63db8lxrswcxvw.png"></p><br><p> <a href="https://github.com/dokshina/deploy-tarantool-cartridge-app">El repositorio de</a> ejemplo logr√≥ cambiar un poco, aparecieron nuevos archivos all√≠, <code>getting-started-app-2.0.0-0.rpm</code> y <code>hosts.updated.2.yml</code> .  No tiene que extraer la nueva versi√≥n, solo puede descargar el paquete desde el <a href="">enlace</a> , y <code>hosts.updated.2.yml</code> solo <code>hosts.updated.2.yml</code> necesario para que pueda mirar all√≠ en caso de dificultades con el cambio del inventario actual. </p><br><p>  Si ha completado todos los pasos de la parte anterior de este tutorial, ahora en su <code>hosts.yml</code> hosts.yml hay una configuraci√≥n de cl√∫ster con dos r√©plicas de <code>storage</code> (en el repositorio esto es <code>hosts.updated.yml</code> ). </p><br><p>  Eleva nuestras m√°quinas virtuales: </p><br><pre> <code class="bash hljs">$ vagrant up</code> </pre> <br><p>  Instale la nueva versi√≥n del cartucho de Tarantool de rol Ansible (se las arregl√≥ para cambiar, por supuesto, para mejor): </p><br><pre> <code class="bash hljs">$ ansible-galaxy install tarantool.cartridge,1.0.2</code> </pre> <br><p>  Entonces, la configuraci√≥n actual del cl√∫ster: </p><br><pre> <code class="plaintext hljs">--- all: vars: # common cluster variables cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-1.0.0-0.rpm # path to package cartridge_cluster_cookie: app-default-cookie # cluster cookie # common ssh options ansible_ssh_private_key_file: ~/.vagrant.d/insecure_private_key ansible_ssh_common_args: '-o IdentitiesOnly=yes -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no' # INSTANCES hosts: storage-1: config: advertise_uri: '172.19.0.2:3301' http_port: 8181 app-1: config: advertise_uri: '172.19.0.3:3301' http_port: 8182 storage-1-replica: config: advertise_uri: '172.19.0.3:3302' http_port: 8183 storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 children: # GROUP INSTANCES BY MACHINES host1: vars: # first machine connection options ansible_host: 172.19.0.2 ansible_user: vagrant hosts: # instances to be started on the first machine storage-1: storage-2-replica: host2: vars: # second machine connection options ansible_host: 172.19.0.3 ansible_user: vagrant hosts: # instances to be started on the second machine app-1: storage-1-replica: storage-2: # GROUP INSTANCES BY REPLICA SETS replicaset_app_1: vars: # replica set configuration replicaset_alias: app-1 failover_priority: - app-1 # leader roles: - 'api' hosts: # replica set instances app-1: replicaset_storage_1: vars: # replica set configuration replicaset_alias: storage-1 weight: 3 failover_priority: - storage-1 # leader - storage-1-replica roles: - 'storage' hosts: # replica set instances storage-1: storage-1-replica: replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 2 failover_priority: - storage-2 - storage-2-replica roles: - 'storage' hosts: # replicaset instances storage-2: storage-2-replica:</code> </pre> <br><p>  Vaya a <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> y aseg√∫rese de que su cl√∫ster est√© en el estado correcto. </p><br><p>  Todo es igual que la √∫ltima vez: cambiaremos gradualmente este archivo y observaremos c√≥mo cambia el cl√∫ster.  Siempre puede ver la versi√≥n final en <code>hosts.updated.2.yml</code> </p><br><p>  ¬°As√≠ que aqu√≠ vamos! </p><br><h2 id="obnovlyaem-prilozhenie">  Actualizando la aplicaci√≥n </h2><br><p>  Para comenzar, vamos a actualizar nuestra aplicaci√≥n.  Aseg√∫rese de tener el archivo <code>getting-started-app-2.0.0-0.rpm</code> en el directorio actual (si no, <a href="">desc√°rguelo</a> del repositorio). </p><br><p>  Especifique la ruta a la nueva versi√≥n del paquete: </p><br><pre> <code class="plaintext hljs">--- all: vars: cartridge_app_name: getting-started-app cartridge_package_path: ./getting-started-app-2.0.0-0.rpm # &lt;== cartridge_enable_tarantool_repo: false # &lt;==</code> </pre> <br><p>  Especificamos <code>cartridge_enable_tarantool_repo: false</code> para que el rol no conecte el repositorio con el paquete Tarantool, que ya instalamos la √∫ltima vez.  Esto acelerar√° ligeramente el proceso de implementaci√≥n, pero no es absolutamente necesario. </p><br><p>  Inicie el libro de jugadas con la etiqueta de <code>cartridge-instances</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-instances</code> </pre> <br><p>  Y comprobamos que el paquete ha sido actualizado: </p><br><pre> <code class="bash hljs">$ vagrant ssh vm1 [vagrant@svm1 ~]$ sudo yum list installed | grep getting-started-app</code> </pre> <br><p>  Verifique que la versi√≥n se haya convertido en <code>2.0.0</code> : </p><br><pre> <code class="bash hljs">getting-started-app.x86_64 2.0.0-0 installed</code> </pre> <br><p>  Ahora puede experimentar con seguridad con la nueva versi√≥n de la aplicaci√≥n. </p><br><h2 id="vklyuchaem-shardirovanie">  Activar fragmentaci√≥n </h2><br><p>  Activemos el fragmentaci√≥n para que podamos tomar el control de <code>storage</code> r√©plicas de <code>storage</code> m√°s adelante.  Esto se hace de manera muy simple.  Agregue la variable <code>cartridge_bootstrap_vshard</code> secci√≥n <code>all.vars</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Lanzamos: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Tenga en cuenta que especificamos la etiqueta de <code>cartridge-config</code> para ejecutar solo las tareas que est√°n involucradas en la configuraci√≥n del cl√∫ster. </p><br><p>  Abra la interfaz de usuario web <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> y vea que nuestros dep√≥sitos se distribuyen a trav√©s de conjuntos de r√©plica de almacenamiento en una proporci√≥n de <code>2:3</code> (especificamos dichos pesos para nuestros conjuntos de r√©plica, ¬ørecuerda?): </p><br><p><img src="https://habrastorage.org/webt/g_/vd/78/g_vd787hpifhrlhk-jfs5sw8iu4.png"></p><br><h2 id="vklyuchaem-avtomaticheskiy-failover">  Active la conmutaci√≥n por error autom√°tica </h2><br><p>  Y ahora activaremos el modo de conmutaci√≥n por error autom√°tica para que podamos descubrir qu√© es y c√≥mo funciona un poco m√°s tarde. </p><br><p>  Agregue el indicador de <code>cartridge_failover</code> a la configuraci√≥n: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... cartridge_cluster_cookie: app-default-cookie # cluster cookie cartridge_bootstrap_vshard: true cartridge_failover: true # &lt;== ... hosts: ... children: ...</code> </pre> <br><p>  Nuevamente comenzamos las tareas de administraci√≥n del cl√∫ster: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Despu√©s de completar con √©xito el libro de jugadas, puede ir a la interfaz de usuario web y asegurarse de que el interruptor de <code>Failover</code> en la esquina superior derecha est√© activado.  Para desactivar el modo de conmutaci√≥n por error autom√°tica, simplemente cambie el valor de <code>cartridge_failover</code> a <code>false</code> y vuelva a ejecutar el libro de jugadas. </p><br><p>  Es hora de averiguar qu√© tipo de r√©gimen es este y por qu√© lo activamos. </p><br><h2 id="razbiraemsya-s-failover-om">  Nos ocupamos de la conmutaci√≥n por error </h2><br><p>  Probablemente haya notado la variable <code>failover_priority</code> que especificamos para cada conjunto de r√©plicas.  Veamos de qu√© se trata. </p><br><p>  El cartucho de Tarantool proporciona un modo de conmutaci√≥n por error autom√°tico.  Cada conjunto de r√©plicas tiene un l√≠der, la instancia en la que se est√° grabando.  Si algo le sucede al l√≠der, uno de los comentarios tomar√° su papel.  Cual?  Echemos un vistazo m√°s de cerca al conjunto de r√©plicas <code>storage-2</code> : </p><br><pre> <code class="plaintext hljs">--- all: ... children: ... replicaset_storage_2: vars: ... failover_priority: - storage-2 - storage-2-replica</code> </pre> <br><p>  La instancia de <code>storage-2</code> que especificamos primero en <code>failover_priority</code> .  En la interfaz de usuario web, aparece primero en la lista de instancias de conjunto de r√©plicas y est√° marcado con una corona verde.  Este es el l√≠der: la primera instancia especificada en <code>failover_priority</code> : </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Ahora veamos qu√© sucede si algo le sucede al l√≠der del conjunto de r√©plicas.  Entramos en la m√°quina virtual y detenemos la instancia de <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl stop getting-started-app@storage-2</code> </pre> <br><p>  Volver a la interfaz de usuario web: </p><br><p><img src="https://habrastorage.org/webt/iy/b2/ff/iyb2ff_a6dryhg0nik8p48rhqhm.png"></p><br><p>  La corona en la instancia de <code>storage-2</code> volvi√≥ roja; esto significa que el l√≠der designado no es saludable.  Pero la <code>storage-2-replica</code> tiene una corona verde: esta instancia asumi√≥ las responsabilidades de liderazgo hasta que el <code>storage-2</code> regrese al servicio.  Esta es una conmutaci√≥n por error autom√°tica en acci√≥n. </p><br><p>  Revivamos el <code>storage-2</code> : </p><br><pre> <code class="bash hljs">$ vagrant ssh vm2 [vagrant@vm2 ~]$ sudo systemctl start getting-started-app@storage-2</code> </pre> <br><p>  Todo volvi√≥ al punto de partida: </p><br><p><img src="https://habrastorage.org/webt/ge/om/bg/geombgvhy6plfnrwpz0o8jqgnaw.png"></p><br><p>  Cambiemos el orden de las instancias en la prioridad de la conmutaci√≥n por error.  Haremos que la instancia de <code>storage-2-replica</code> l√≠der, y eliminaremos el <code>storage-2</code> de la lista en general: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2-replica # &lt;== ...</code> </pre> <br><p>  Ejecute <code>cartridge-replicasets</code> para instancias desde el grupo <code>replicaset_storage_2</code> : </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Vamos a <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> y vemos que el l√≠der ha cambiado: </p><br><p><img src="https://habrastorage.org/webt/r_/hq/bm/r_hqbmgxwbkvcycacj7pnotjhjc.png"></p><br><p>  Pero eliminamos la instancia de <code>storage-2</code> de la configuraci√≥n, ¬øpor qu√© todav√≠a est√° aqu√≠?  El hecho es que Cartridge, al recibir un nuevo valor de <code>failover_priority</code> organiza las instancias de la siguiente manera: la primera instancia de la lista se convierte en l√≠der, el resto de las instancias indicadas siguen.  Las instancias no mencionadas en <code>failover_priority</code> se ordenar√°n por UUID y se agregar√°n al final. </p><br><h2 id="izgnanie-instansa">  Instancia de exilio </h2><br><p>  Pero, ¬øqu√© sucede si queremos excluir la instancia de la topolog√≠a?  Todo es muy simple: debes pasarle la bandera <code>expelled</code> .  Excluyamos la instancia de <code>storage-2-replica</code> .  √âl es el l√≠der ahora, por lo que Cartridge no nos permitir√° hacer esto.  Pero no tenemos miedo a las dificultades, y a√∫n intentamos: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: storage-2-replica: config: advertise_uri: '172.19.0.2:3302' http_port: 8185 expelled: true # &lt;== ...</code> </pre> <br><p>  Especificamos la <code>cartridge-replicasets</code> , ya que expulsar una instancia es un cambio de topolog√≠a: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Ejecute el libro de jugadas y vea el error: </p><br><p><img src="https://habrastorage.org/webt/hf/wf/tc/hfwftcua4yyueyi0qgngr2mveia.png"></p><br><p>  Como acabamos de ver, Cartridge no justifica arrojar al l√≠der actual del conjunto de r√©plicas fuera de la topolog√≠a.  Esto es bastante l√≥gico, ya que la replicaci√≥n es as√≠ncrona, la exclusi√≥n de un l√≠der puede conducir a la p√©rdida de datos.  Necesitamos especificar otro l√≠der y solo despu√©s de eso excluir la instancia.  El rol primero aplicar√° la nueva configuraci√≥n del conjunto de r√©plicas y luego se ocupar√° de la excepci√≥n.  Por lo tanto, cambiamos <code>failover_priority</code> y ejecutamos nuevamente el libro de jugadas: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration ... failover_priority: - storage-2 # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  ¬°Voila, la instancia de <code>storage-2-replica</code> ha desaparecido de la topolog√≠a! </p><br><p><img src="https://habrastorage.org/webt/tl/ao/ue/tlaoue_hclprc1i6tdjuil5efyk.png"></p><br><p>  Tenga en cuenta que el exilio de la instancia es verdaderamente final e irrevocable.  Despu√©s de eliminar la instancia de la topolog√≠a, nuestra funci√≥n ansible detendr√° el servicio systemd y eliminar√° todos los archivos de esta instancia. </p><br><p><img src="https://habrastorage.org/webt/_7/bp/nx/_7bpnxxuydmfmddneontw1nxexi.png"></p><br><p>  Si de repente cambia de opini√≥n y decide que el conjunto <code>storage-2</code> r√©plicas <code>storage-2</code> todav√≠a necesita una segunda instancia, no podr√° restaurarlo.  Cartridge recuerda el UUID de todas las instancias que han abandonado la topolog√≠a y no permitir√° que el exilio regrese.  Puede generar una nueva instancia con el mismo nombre y configuraci√≥n, pero obviamente tendr√° un UUID diferente, por lo que Cartridge le permitir√° unirse. </p><br><h2 id="udalenie-replikaseta">  Eliminando Replicaset </h2><br><p>  Ya hemos descubierto que no se nos permitir√° expulsar al l√≠der del conjunto de r√©plicas.  Pero, ¬øqu√© pasa si queremos eliminar el replicaet de <code>storage-2</code> forma permanente?  Hay, por supuesto, una salida. </p><br><p>  Para no perder datos, primero debemos transferir todos los <code>storage-1</code> al <code>storage-1</code> , para esto establecemos el peso del r√©plica de <code>storage-2</code> a <code>0</code> : </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... children: ... replicaset_storage_2: vars: # replicaset configuration replicaset_alias: storage-2 weight: 0 # &lt;== ... ...</code> </pre> <br><p>  Lanzamiento de gesti√≥n de topolog√≠a: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --<span class="hljs-built_in"><span class="hljs-built_in">limit</span></span> replicaset_storage_2 \ --tags cartridge-replicasets</code> </pre> <br><p>  Abra la interfaz de usuario web <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> y observe c√≥mo fluyen todos los <code>storage-1</code> en el <code>storage-1</code> : </p><br><p><img src="https://habrastorage.org/webt/nk/mo/fq/nkmofqnvvoccqfqkyz1myryu4-s.png"></p><br><p>  Configuramos el l√≠der de <code>storage-2</code> a la bandera expulsada y nos despedimos de este conjunto de r√©plicas: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... hosts: ... storage-2: config: advertise_uri: '172.19.0.3:3303' http_port: 8184 expelled: true # &lt;== ...</code> </pre> <br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-replicasets</code> </pre> <br><p>  Tenga en cuenta que esta vez no especificamos la opci√≥n de <code>limit</code> , ya que al menos una instancia de todas para las cuales lanzamos el libro de jugadas no debe marcarse como <code>expelled</code> . </p><br><p>  Entonces volvimos a la topolog√≠a original: </p><br><p><img src="https://habrastorage.org/webt/70/zo/vq/70zovqqaeiph6v1bjoenzl_hn1w.png"></p><br><h2 id="avtorizaciya">  Iniciar sesi√≥n </h2><br><p>  Propongo distraerme de la gesti√≥n de conjuntos de r√©plicas y pensar en la seguridad.  Ahora, cualquier usuario no autorizado puede administrar el cl√∫ster a trav√©s de la interfaz de usuario web.  De acuerdo, parece m√°s o menos. </p><br><p>  Cartridge brinda la capacidad de conectar su propio m√≥dulo de autorizaci√≥n, como LDAP (o lo que sea que tenga all√≠), y usarlo para administrar usuarios y su acceso a la aplicaci√≥n.  Pero usaremos el m√≥dulo de autorizaci√≥n incorporado, que Cartridge usa de manera predeterminada.  Este m√≥dulo le permite realizar operaciones b√°sicas con los usuarios (eliminar, agregar, editar) e implementa la funci√≥n de verificaci√≥n de contrase√±a. <br>  Tenga en cuenta que nuestra funci√≥n ansible requiere la autorizaci√≥n del backend para implementar todas estas funciones. </p><br><p>  Entonces, pasamos de la teor√≠a a la pr√°ctica.  Primero, haga que la autorizaci√≥n sea obligatoria, configure los par√°metros de la sesi√≥n y agregue un nuevo usuario: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # authorization cartridge_auth: # &lt;== enabled: true # enable authorization cookie_max_age: 1000 cookie_renew_age: 100 users: # cartridge users to set up - username: dokshina password: cartridge-rullez fullname: Elizaveta Dokshina email: dokshina@example.com # deleted: true # uncomment to delete user ...</code> </pre> <br><p>  La gesti√≥n de autorizaci√≥n se realiza como parte de las tareas de <code>cartridge-config</code> , indicamos esta etiqueta: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  En <a href="http://localhost:8181/admin/cluster/dashboard">http: // localhost: 8181 / admin / cluster / dashboard</a> nos espera <a href="http://localhost:8181/admin/cluster/dashboard">una</a> sorpresa: </p><br><p><img src="https://habrastorage.org/webt/a2/t8/pq/a2t8pqil4sxnosey38i-baf3q1k.png"></p><br><p>  Puede iniciar sesi√≥n con el <code>username</code> y la <code>password</code> nuestro nuevo usuario o iniciar sesi√≥n como <code>admin</code> , el usuario predeterminado.  Su contrase√±a es cookie de cl√∫ster, especificamos este valor en la variable <code>cartridge_cluster_cookie</code> (esta es <code>app-default-cookie</code> , no puede mirar). </p><br><p>  Despu√©s de un inicio de sesi√≥n exitoso, abra la pesta√±a <code>Users</code> para asegurarse de que todo sali√≥ bien: </p><br><p><img src="https://habrastorage.org/webt/af/h_/9o/afh_9ofcv7htwplfgomnxejosxo.png"></p><br><p>  Experimente agregando nuevos usuarios y cambiando su configuraci√≥n.  Para eliminar un usuario, especifique el indicador <code>deleted: true</code> para √©l.  Cartridge no utiliza los valores de <code>email</code> y nombre <code>fullname</code> ninguna manera, pero puede especificarlos por conveniencia. </p><br><h2 id="konfiguraciya-prilozheniya">  Configuraci√≥n de la aplicaci√≥n </h2><br><p>  Recordemos c√≥mo comenz√≥ todo. </p><br><p>  Hemos implementado una peque√±a aplicaci√≥n que almacena datos sobre clientes y sus cuentas bancarias.  Como recordar√°, esta aplicaci√≥n tiene 2 roles: <code>api</code> y <code>storage</code> .  El rol de <code>storage</code> maneja el almacenamiento de datos e implementa el fragmentado utilizando el rol <code>vshard-storage</code> .  El segundo rol, <code>api</code> , implementa un servidor HTTP con una API para la gesti√≥n de datos, adem√°s, dentro est√° conectado otro rol est√°ndar, <code>vshard-router</code> , que controla el fragmentaci√≥n. </p><br><p>  Entonces, hacemos la primera solicitud a la API de la aplicaci√≥n.  Agregar un nuevo cliente: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">'{"customer_id":1, "name":"Elizaveta", "accounts":[{"account_id": 1}]}'</span></span> \ http://localhost:8182/storage/customers/create</code> </pre> <br><p>  En respuesta, obtenemos algo como esto: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Successfully created"</span></span>}</code> </pre> <br><p>  Tenga en cuenta que en la URL especificamos el puerto de instancia <code>app-1</code> , <code>8082</code> , porque implementa esta API. </p><br><p>  Ahora vamos a actualizar el saldo de nuestro nuevo usuario: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  En la respuesta vemos el saldo actualizado: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"balance"</span></span>:<span class="hljs-string"><span class="hljs-string">"1000.00"</span></span>}</code> </pre> <br><p>  ¬°Genial, todo funciona!  La API est√° implementada, Cartridge se dedica a compartir datos, ya hemos configurado la prioridad de conmutaci√≥n por error para casos de emergencia e incluso hemos habilitado la autorizaci√≥n.  Es hora de hacer la configuraci√≥n de la aplicaci√≥n. </p><br><p>  La configuraci√≥n actual del cl√∫ster se almacena en un archivo de configuraci√≥n distribuido.  Cada instancia mantiene una copia de este archivo, y Cartridge asegura su sincronizaci√≥n entre todos los nodos del cl√∫ster.  Podemos especificar la configuraci√≥n de los roles de nuestra aplicaci√≥n en este archivo, y Cartridge se encargar√° de distribuir la nueva configuraci√≥n en todas las instancias. </p><br><p>  Veamos el contenido actual de este archivo.  Vaya a la <code>Cofiguration files</code> y haga clic en el bot√≥n <code>Download</code> : </p><br><p><img src="https://habrastorage.org/webt/wx/xw/vc/wxxwvcdusefetrgyaxpnnrvxwya.png"></p><br><p>  En el <code>config.yml</code> config.yml descargado <code>config.yml</code> encontramos una tabla vac√≠a.  No es de extra√±ar, porque todav√≠a no hemos especificado ning√∫n par√°metro: </p><br><pre> <code class="plaintext hljs">--- [] ...</code> </pre> <br><p>  De hecho, el archivo de configuraci√≥n de nuestro cl√∫ster no est√° vac√≠o, almacena la topolog√≠a actual, la configuraci√≥n de autorizaci√≥n y la configuraci√≥n de fragmentaci√≥n.  Pero Cartridge no ser√° tan f√°cil compartir esta informaci√≥n, est√° destinada para uso interno y, por lo tanto, est√° almacenada en secciones ocultas del sistema, que no podemos editar. </p><br><p>  Cada rol de aplicaci√≥n puede usar una o m√°s secciones de configuraci√≥n.  La descarga de una nueva configuraci√≥n ocurre en dos etapas: primero, todos los roles verifican que est√°n listos para aceptar nuevos par√°metros.  Si no hay objeci√≥n, se aplican los cambios, si alguien est√° en contra, se produce una reversi√≥n. </p><br><p>  Volvamos a nuestra aplicaci√≥n.  La funci√≥n de <code>api</code> utiliza la secci√≥n de <code>max-balance</code> , donde el saldo m√°ximo permitido se almacena en una cuenta de cliente.  Configuremos esta secci√≥n, pero, por supuesto, no de forma manual, sino con nuestro rol Ansible. </p><br><p>  Entonces, ahora la configuraci√≥n de la aplicaci√≥n (o m√°s bien, parte de ella disponible para nosotros) es una tabla vac√≠a.  Agregue una secci√≥n de <code>max-balance</code> con un valor de <code>100000</code> .  Escribimos la variable <code>cartridge_app_config</code> en nuestro archivo de inventario: </p><br><pre> <code class="plaintext hljs">--- all: vars: ... # cluster-wide config cartridge_app_config: # &lt;== max-balance: # section name body: 1000000 # section body # deleted: true # uncomment to delete section max-balance ...</code> </pre> <br><p>  Especificamos el nombre de la secci√≥n, <code>max-balance</code> , y su contenido, <code>body</code> .  El contenido de una secci√≥n puede ser no solo un n√∫mero, tambi√©n puede ser una tabla o una fila, dependiendo de c√≥mo se escriba el rol y qu√© tipo de valor desee usar. </p><br><p>  Lanzamos: </p><br><pre> <code class="bash hljs">$ ansible-playbook -i hosts.yml playbook.yml \ --tags cartridge-config</code> </pre> <br><p>  Y comprobamos que el saldo m√°ximo permitido realmente ha cambiado: </p><br><pre> <code class="bash hljs">$ curl -X POST -H <span class="hljs-string"><span class="hljs-string">"Content-Type: application/json"</span></span> \ -d <span class="hljs-string"><span class="hljs-string">"{\"account_id\": 1, \"amount\": \"1000001\"}"</span></span> \ http://localhost:8182/storage/customers/1/update_balance</code> </pre> <br><p>  En respuesta, recibimos un error, como quer√≠amos: </p><br><pre> <code class="bash hljs">{<span class="hljs-string"><span class="hljs-string">"info"</span></span>:<span class="hljs-string"><span class="hljs-string">"Error"</span></span>,<span class="hljs-string"><span class="hljs-string">"error"</span></span>:<span class="hljs-string"><span class="hljs-string">"Maximum is 1000000"</span></span>}</code> </pre> <br><p>  Puede volver a descargar el archivo de configuraci√≥n en la pesta√±a <code>Configuraion files</code> para asegurarse de que aparezca una nueva secci√≥n all√≠: </p><br><pre> <code class="plaintext hljs">--- max-balance: 1000000 ...</code> </pre> <br><p>  Intente agregar nuevas secciones a la configuraci√≥n de la aplicaci√≥n, cambie su contenido o elim√≠nelas por completo (para esto debe establecer el indicador <code>deleted: true</code> en la secci√≥n). </p><br><p>  Puede encontrar c√≥mo usar una configuraci√≥n distribuida en roles en la <a href="https://www.tarantool.io/ru/rocks/cartridge/1.0/modules/cartridge.clusterwide-config/">documentaci√≥n del</a> cartucho de Tarantool. </p><br><p>  Recuerde llamar al <code>vagrant halt</code> para detener las <code>vagrant halt</code> cuando termine de trabajar con ellas. </p><br><h2 id="v-zaklyuchenie">  En conclusi√≥n </h2><br><p>  La √∫ltima vez, aprendimos c√≥mo implementar aplicaciones distribuidas de cartuchos de Tarantool usando un rol especial de Ansible.  Hoy actualizamos la aplicaci√≥n y tambi√©n dominamos la administraci√≥n de la topolog√≠a, el fragmentaci√≥n, la autorizaci√≥n y la configuraci√≥n de la aplicaci√≥n. </p><br><p>  No se detenga all√≠, aprenda <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_best_practices.html">diferentes enfoques</a> para escribir libros de jugadas Ansible y use sus aplicaciones con la m√°xima comodidad. </p><br><p>  Si algo no funciona para usted o si tiene ideas sobre c√≥mo mejorar nuestro papel responsable, no dude en comenzar un <a href="https://github.com/tarantool/ansible-cartridge/issues/new">boleto</a> .  ¬°Siempre le ayudaremos a resolver su problema y estaremos encantados de recibir ofertas interesantes! </p></div></div><p>Source: <a href="https://habr.com/ru/post/484192/">https://habr.com/ru/post/484192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../484178/index.html">Conmutador Ethernet inteligente para el planeta Tierra</a></li>
<li><a href="../484180/index.html">PBX virtual Rostelecom: qu√© y c√≥mo se puede hacer a trav√©s de la API</a></li>
<li><a href="../484182/index.html">Xenobots: nanorobots vivos de c√©lulas de rana</a></li>
<li><a href="../484186/index.html">LDAP - "autenticaci√≥n" es un antipatr√≥n</a></li>
<li><a href="../484188/index.html">Est√°ndares de dise√±o de bases de datos</a></li>
<li><a href="../484194/index.html">Kubernetes traducido a ni√±os</a></li>
<li><a href="../484196/index.html">Grabar sonido JS desde un micr√≥fono o comentarios de voz</a></li>
<li><a href="../484198/index.html">Reverso de la moneda: qui√©n gan√≥ y perdi√≥ con el crecimiento de las acciones de Tesla</a></li>
<li><a href="../484200/index.html">C√≥mo establecer objetivos para alcanzarlos</a></li>
<li><a href="../484202/index.html">Aprendizaje autom√°tico en an√°lisis est√°tico del c√≥digo fuente del programa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>