<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õ∫Ô∏è üïµüèª üç° Secrets de tol√©rance aux fautes de notre front office üíÜüèª üë©üèª‚Äç‚öïÔ∏è üëÜüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Comment est organis√©e une banque moderne? Il y a un back office o√π diverses op√©rations sont effectu√©es, des comptes et des rapports sont tenus. Il exi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Secrets de tol√©rance aux fautes de notre front office</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/419815/">  Comment est organis√©e une banque moderne?  Il y a un back office o√π diverses op√©rations sont effectu√©es, des comptes et des rapports sont tenus.  Il existe un middle office o√π les d√©cisions sont prises et les risques sont √©valu√©s, o√π les risques de cr√©dit sont √©valu√©s et les fraudeurs sont neutralis√©s.  Et il y a un front office o√π ils servent les clients et sont responsables de leur interaction avec la banque √† travers diff√©rents canaux. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aad/a71/55c/aada7155cf378d6d91c3b52a528b4384.png"><br><br>  Sberbank poss√®de des centaines de syst√®mes de disponibilit√© et de fiabilit√© variables.  Il a son propre d√©veloppement et des solutions en bo√Æte avec diff√©rents degr√©s de personnalisation, diff√©rents SLA.  Tous les syst√®mes sont int√©gr√©s les uns aux autres de nombreuses fa√ßons.  Dans cet article, nous vous expliquerons comment toute cette colline de fourmis frontale est construite de mani√®re √† fournir un service client continu. <br><a name="habracut"></a><br>  Commen√ßons par la th√©orie.  Les principes cl√©s par lesquels un syst√®me √† s√©curit√© int√©gr√©e est construit peuvent √™tre emprunt√©s √† un sous-marin: <br><br><ol><li>  Le sous-marin est divis√© en compartiments ind√©pendants.  Si un compartiment est inond√©, les autres survivent encore. <br></li><li>  Tous les composants critiques sont r√©serv√©s.  Moteurs, r√©servoirs d'oxyg√®ne.  Et les Beatles ont √©galement r√©serv√© des p√©riscopes avec des hublots. <br></li><li>  Le sous-marin est prot√©g√© des conditions critiques √† la surface - si n√©cessaire, il peut aller plus loin et y travailler comme si de rien n'√©tait. <br></li></ol><br>  Nous illustrons le premier principe avec un exemple de notre pratique.  Nous avions un syst√®me de cache distribu√©.  Et une fois sous charge, l'un des n≈ìuds de donn√©es de cache est tomb√© en panne.  Ce n'est pas grave: pour maintenir une r√©plication correcte, le contr√¥leur a redistribu√© les donn√©es aux n≈ìuds restants.  Mais √† la suite de la redistribution, le trafic r√©seau a bondi et les paquets ont commenc√© √† √™tre perdus, y compris la surcharge du cache.  √Ä un moment donn√©, le contr√¥leur a d√©cid√© qu'un autre n≈ìud de donn√©es √©tait en panne, a redistribu√© les donn√©es √† nouveau, le trafic a augment√© ... En cons√©quence, en moins d'une minute, le syst√®me est tomb√© compl√®tement en panne.  Heureusement, c'√©tait un circuit de charge et personne n'a √©t√© bless√©.  Mais nous avons pass√© beaucoup de temps √† chercher la cause. <br><br>  On peut affirmer que cela ne se produit pas avec les bases de donn√©es en cluster et les serveurs haut de gamme - la redondance est int√©gr√©e au niveau mat√©riel.  Pour citer Werner Vogels, CTO Amazon: ¬´Tout √©choue tout le temps.¬ª  Nous sommes tomb√©s et clusters de bases de donn√©es, et serveur haut de gamme.  Tomb√© √† cause d'erreurs de configuration, √† cause de probl√®mes dans le logiciel de gestion.  Avec la solution de chaque probl√®me, notre confiance dans ces solutions a diminu√©.  En cons√©quence, nous sommes arriv√©s √† la conclusion: seuls les syst√®mes qui sont divis√©s en parties ind√©pendantes les unes des autres - principalement ind√©pendantes dans la gestion - ne refusent pas. <br><br><h2>  Architecture multi-blocs </h2><br>  La solution √† nos probl√®mes √©tait une architecture multi-blocs.  Dans ce document, tous les composants mat√©riels, y compris les bases de donn√©es, sont divis√©s en blocs √† couplage l√¢che, presque ind√©pendants.  Chaque bloc sert une partie des clients, comme lors du partage dans des bases de donn√©es.  Les n≈ìuds de chaque bloc sont r√©serv√©s √† tous les niveaux, y compris la g√©o-redondance.  Tout probl√®me dans un bloc n'affecte pas les autres.  Avec une augmentation du nombre de clients, nous pouvons facilement ajouter de nouveaux blocs et continuer √† travailler normalement. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/066/cb5/6c5/066cb56c5cf947823870e31d00c89403.png"><br>  <i>Architecture g√©n√©rale des blocs.</i>  <i>Tous les blocs sont r√©serv√©s selon le sch√©ma 2N.</i>  <i>Chaque centre de donn√©es dispose d'un puissant √©quilibreur de charge mat√©riel.</i>  <i>Les centres de donn√©es sont connect√©s par 2-3 canaux de communication ind√©pendants.</i> <br><br>  Les serveurs sont r√©partis en blocs de cinq types: <br><br><ul><li>  Routeur - une unit√© de contr√¥le qui distribue les clients aux autres unit√©s <br></li><li>  Bloc client - le bloc principal desservant jusqu'√† 10 millions de clients <br></li><li>  Bloc pilote - ici, nous testons de nouvelles versions d'applications sur des clients fid√®les (environ 300 000 personnes, principalement des employ√©s de Sberbank) <br></li><li>  Unit√© invit√© - les utilisateurs non authentifi√©s sont servis par son interm√©diaire;  ceux, par exemple, qui passent par le site <br></li><li>  Bloc de r√©serve - un bloc de s√©curit√© suffisamment puissant pour remplacer deux blocs clients √† la fois <br></li></ul><br>  √Ä l'int√©rieur de chaque bloc, le serveur d'applications et le serveur Web sont s√©par√©s par des canaux de service, mais les bases de donn√©es sont communes.  Nous pouvons donc isoler les sc√©narios de d√©faillance les plus courants afin qu'ils ne d√©passent pas les limites de notre canal. <br><br><h2>  Comment √ßa marche? </h2><br>  Tout d'abord, l'utilisateur entre dans l'unit√© de routeur.  Ce bloc v√©rifie √† quel bloc client la personne appartient et l'envoie l√† (ou au bloc invit√©).  De plus, une personne travaille calmement √† l'int√©rieur de son bloc.  Si une d√©faillance se produit dans l'unit√© native, la personne retourne au routeur et re√ßoit automatiquement une direction vers l'unit√© de sauvegarde pour un travail ult√©rieur. <br><br>  Qu'arrive-t-il aux donn√©es pendant le fonctionnement?  Les informations sur l'interaction du client avec la banque sont r√©pliqu√©es en continu des blocs clients vers la base de donn√©es d'archives.  Apr√®s avoir rencontr√© l'utilisateur, l'unit√© de sauvegarde extrait les informations n√©cessaires √† son sujet de la base de donn√©es d'archives et, si n√©cessaire, fournit des donn√©es - afin que l'utilisateur ne se fige pas lorsque des probl√®mes surviennent de notre part. <br><br>  Les op√©rations effectu√©es dans l'unit√© de sauvegarde y sont stock√©es.  Lorsque le bloc client natif de l'utilisateur est restaur√©, il revient.  Les op√©rations accumul√©es dans le bloc de sauvegarde sont transf√©r√©es de mani√®re asynchrone aux blocs clients n√©cessaires.  Bien que les donn√©es soient r√©duites √† la coh√©rence, le client voit un message indiquant que toutes les op√©rations ont √©t√© accept√©es et enregistr√©es, mais en raison de travaux techniques, les derni√®res op√©rations peuvent ne pas √™tre affich√©es. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/da5/362/a98da53620d3a2d57119975d2872e156.png"><br>  <i>Sch√©ma g√©n√©ral du syst√®me</i> <br><br>  Dans certains cas, le basculement vers le bloc de sauvegarde est planifi√© √† l'avance, par exemple lors de la mise √† jour dans le bloc client.  Ensuite, l'unit√© de sauvegarde ne r√©cup√®re pas les sessions client, mais √† un certain moment, elle d√©marre simplement toutes les nouvelles op√©rations √† la place.  Si vous devez passer d'urgence √† l'unit√© de sauvegarde, l'administrateur peut d√©sactiver toutes les sessions.  Dans ce cas, la session utilisateur sera interrompue et il en d√©marrera une nouvelle sur l'unit√© de sauvegarde.  √Ä propos, l'unit√© de routeur poss√®de sa propre unit√© de sauvegarde d√©di√©e.  Donc, personne ne se retrouve sans roue de secours. <br><br><h2>  Mise √† jour des syst√®mes </h2><br>  Les nouvelles versions logicielles sont d√©ploy√©es en premier sur le bloc pilote et sont pr√©sent√©es √† un public limit√©.  Puis progressivement sur les blocs clients, et d√©j√† √† la fin - sur les blocs de r√©serve.  Donc, s'il y a des probl√®mes dans le bloc client avec la nouvelle version du logiciel, nous pouvons transf√©rer les clients vers le bloc de sauvegarde de l'ancienne. <br><br>  Lorsqu'une nouvelle fonctionnalit√© roule sur un bloc, elle ne s'active pas automatiquement.  Les administrateurs le font √† l'aide de cases √† cocher - bascule de fonction.  Vous pouvez basculer les clients vers la nouvelle version par groupes - c'est ainsi que nous v√©rifions la r√©action des mises √† jour √† la croissance de l'audience. <br><br><h2>  Autonomie </h2><br>  Notre syst√®me en lui-m√™me est fiable, mais d√©pend toujours du backend utilis√© pour les op√©rations.  Comment se prot√©ger des probl√®mes?  Nous utilisons trois outils. <br><br><ol><li>  <i>Demandes en attente</i> .  Le client demande que l'op√©ration soit termin√©e.  Nous l'enregistrons dans notre base de donn√©es et essayons de l'ex√©cuter dans le backend.  Si le backend ne r√©pond pas, nous montrons au client un message indiquant que l'op√©ration a √©t√© accept√©e et est en cours de traitement.  Lorsque le backend monte, un ¬´docker¬ª distinct lit les op√©rations incompl√®tes de la base de donn√©es et les ¬´pousse¬ª en lots dans le syst√®me backend.  Afin de ne pas surcharger la table principale avec des op√©rations avec un grand nombre de requ√™tes √† faible efficacit√©, nous utilisons en outre la table dite des jetons - une liste d'identifiants d'op√©rations incompl√®tes.  Afin de ne pas abandonner le backend qui vient d'augmenter de centaines de milliers d'op√©rations, nous utilisons le traitement par lots - nous supprimons deux cents op√©rations et attendons, par exemple, quelques secondes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd3/af8/261/cd3af826195c4c177e55a7bdbbd2d786.png"><br><br>  Mais que se passe-t-il si des changements importants se produisent entre la demande de l'utilisateur et la r√©cup√©ration du backend?  Par exemple, les taux de change ont-ils chang√©?  Dans ce cas, une double v√©rification est d√©clench√©e.  Ces op√©rations sont enregistr√©es √† l'entr√©e, puis v√©rifi√©es √† l'ex√©cution.  Si quelque chose ne converge pas, l'op√©ration sera ajust√©e ou rejet√©e. <br></li><li>  <i>Mise en cache des donn√©es</i> .  Lorsqu'un utilisateur entre, par exemple, Sberbank Online, toutes les informations n√©cessaires le concernant sont d√©j√† visibles - factures, cartes, pr√™ts, etc.  Ces donn√©es sont demand√©es via un bus de service √† partir d'une dizaine de syst√®mes.  Si la r√©ponse a √©t√© collect√©e rapidement, en quelques secondes, nous montrons les donn√©es au client et les sauvegardons dans le cache syst√®me de notre base de donn√©es.  Sinon, nous recherchons dans la base de donn√©es les donn√©es pr√©c√©demment mises en cache et les montrons au client.  Bien s√ªr, pour cela, le cache ne doit pas √™tre plus ancien qu'un certain √¢ge.  Lorsque le bus de service collecte n√©anmoins les donn√©es n√©cessaires √† la demande, elles sont mises √† jour dans le cache de la base de donn√©es et envoy√©es au client au lieu des anciennes. <br><br>  Lors de l'utilisation de l'application, cela signifie qu'une personne verra l'√©tat de son compte quelques secondes apr√®s son entr√©e.  Bien que les donn√©es puissent √™tre quelque peu d√©pass√©es.  Si cela se produit, apr√®s quelques secondes, les donn√©es sont g√©n√©ralement remplac√©es par les donn√©es r√©elles - ce qui signifie que le bus de service a collect√© tout ce dont vous avez besoin. <br><br>  De plus, nous avons une pr√©-mise en cache utilisant la r√©plication.  Surtout pour diff√©rentes donn√©es de r√©f√©rence.  Nous pr√©chargeons ces donn√©es dans le backend, le client fait calmement une demande pour l'op√©ration, et nous l'envoyons.  M√™me si les syst√®mes charg√©s de la maintenance des donn√©es ne fonctionnent pas, l'utilisateur n'a pas √† attendre √† nouveau. <br></li><li>  <i>Pauses techniques</i> .  Si le syst√®me principal est tomb√© en panne ou est en cours de maintenance, nous le signalons.  Et puis les op√©rations qui le traversent se heurtent imm√©diatement au refus.  Nous √©vitons donc que le serveur d'applications ne d√©borde de requ√™tes en attente d'une r√©ponse par timeout.  Dans ce mode, la mise en cache des op√©rations et des donn√©es que nous avons d√©crites pr√©c√©demment peut √™tre utilis√©e.  Des ruptures techniques sont d√©finies pour chaque sc√©nario d'int√©gration, manuellement par l'administrateur ou automatiquement, en fonction du nombre de demandes. <br></li></ol><br><br><img src="https://habrastorage.org/getpro/habr/post_images/ce4/643/7d5/ce46437d574e8a2353f82f3856c2648f.png"><br><br>  Dans tous les cas, nous cherchons √† minimiser les attentes de l'utilisateur - s'il y a des probl√®mes, il re√ßoit imm√©diatement un message sur l'impossibilit√© de l'op√©ration.  Nous essayons de minimiser le nombre de ces messages, donc nous augmentons la dur√©e de vie de certaines donn√©es en cache - cela nous permet d'√©tendre l'interaction normale avec les services de la banque. <br><br>  Dans certains sc√©narios, la mise en cache ne doit pas √™tre supprim√©e, par exemple lors de l'√©mission d'esp√®ces.  Il s'agit d'une fraude possible de la part du client.  Ces op√©rations dans les distributeurs automatiques de billets et les succursales ne sont pas mises en cache.  Dans la banque Internet, c'est plus facile - nous acceptons la demande, puis la traitons ou la rejetons. <br><br>  Par cons√©quent, en respectant les principes d√©crits dans l'article, vous pouvez obtenir des syst√®mes avec une disponibilit√© de 99,99% et plus. <br><br><h2>  Nos plans </h2><br>  D√©sormais, les plans visent √† minimiser le d√©lai de mise sur le march√© de notre syst√®me unique, √† garantir l'omnicanalit√©, en tenant compte des caract√©ristiques techniques et commerciales des canaux.  Et √©galement migrer les syst√®mes h√©rit√©s tout en conservant leur op√©rabilit√© pendant le d√©m√©nagement. <br><br>  <i>Nous remercions Roman Shekhovtsov pour son aide active dans la pr√©paration de ce message</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr419815/">https://habr.com/ru/post/fr419815/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr419803/index.html">Test du WANHAO DUPLICATOR 8 Mini</a></li>
<li><a href="../fr419805/index.html">The Super Tiny Compiler - maintenant en russe</a></li>
<li><a href="../fr419807/index.html">Glaucome - comment ne pas devenir aveugle: parlons de traitement ...</a></li>
<li><a href="../fr419811/index.html">L'√©volution des √©crans flexibles</a></li>
<li><a href="../fr419813/index.html">Webinaires Skillbox: s√©lection du vendredi</a></li>
<li><a href="../fr419817/index.html">Lancement du cluster RabbitMQ dans Kubernetes</a></li>
<li><a href="../fr419819/index.html">Biomarqueurs du vieillissement. Panel de fragilit√©. 2e partie</a></li>
<li><a href="../fr419823/index.html">Duo insolite - phrases de passe et images mn√©moniques</a></li>
<li><a href="../fr419825/index.html">Test des performances de plusieurs types de disques dans un environnement virtuel</a></li>
<li><a href="../fr419829/index.html">Le chiffrement de cl√© par d√©faut d'OpenSSH est pire que rien</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>