<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘ƒğŸ» ğŸ‘‚ğŸ¿ ğŸ§˜ğŸ½ äº‹ä»¶ç”Ÿæˆï¼ŒCQRSå’ŒLaravel ğŸ¤¢ ğŸ”± ğŸ§</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æœ¬æ–‡çš„ç¿»è¯‘æ˜¯ä¸ºä¸“ä¸šè¯¾ç¨‹â€œ Framework Laravelâ€çš„å­¦ç”Ÿå‡†å¤‡çš„ 
 



 å¼•è¨€ 
 æœ¬æ–‡è‡´åŠ›äºä»¥PHPè¯­è¨€å’ŒLaravelæ¡†æ¶åˆ›å»ºäº‹ä»¶CQRSç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†ã€‚ å‡å®šæ‚¨ç†Ÿæ‚‰ä½¿ç”¨å‘½ä»¤æ€»çº¿çš„å¼€å‘æ–¹æ¡ˆå¹¶ä¸”å¯¹äº‹ä»¶æœ‰æ‰€äº†è§£ï¼ˆå°¤å…¶æ˜¯é’ˆå¯¹ä¸€ç³»åˆ—ä¾¦å¬å™¨çš„äº‹ä»¶å‘å¸ƒï¼‰ã€‚ è¦åˆ·æ–°æ­¤çŸ¥è¯†ï¼Œå¯ä»¥ä½¿ç”¨Laraca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>äº‹ä»¶ç”Ÿæˆï¼ŒCQRSå’ŒLaravel</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/461899/">  <i>æœ¬æ–‡çš„ç¿»è¯‘æ˜¯ä¸ºä¸“ä¸šè¯¾ç¨‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">â€œ Framework Laravelâ€çš„</a>å­¦ç”Ÿå‡†å¤‡çš„</i> <i><br></i> <br><img src="https://habrastorage.org/webt/h8/4u/y5/h84uy5i5spnt3rdmpaiw2aynd0s.png"><br><br><hr><br><h2> å¼•è¨€ </h2><br> æœ¬æ–‡è‡´åŠ›äºä»¥PHPè¯­è¨€å’ŒLaravelæ¡†æ¶åˆ›å»ºäº‹ä»¶CQRSç³»ç»Ÿçš„åŸºç¡€çŸ¥è¯†ã€‚ å‡å®šæ‚¨ç†Ÿæ‚‰ä½¿ç”¨å‘½ä»¤æ€»çº¿çš„å¼€å‘æ–¹æ¡ˆå¹¶ä¸”å¯¹äº‹ä»¶æœ‰æ‰€äº†è§£ï¼ˆå°¤å…¶æ˜¯é’ˆå¯¹ä¸€ç³»åˆ—ä¾¦å¬å™¨çš„äº‹ä»¶å‘å¸ƒï¼‰ã€‚ è¦åˆ·æ–°æ­¤çŸ¥è¯†ï¼Œå¯ä»¥ä½¿ç”¨LaracastsæœåŠ¡ã€‚ å¦å¤–ï¼Œå‡è®¾æ‚¨å¯¹CQRSåŸç†æœ‰ä¸€å®šçš„äº†è§£ã€‚ å¦‚æœæ²¡æœ‰ï¼Œæˆ‘å¼ºçƒˆå»ºè®®æ‚¨å¬ä¸¤ä¸ªè®²åº§ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Mathias Verraeså…³äºäº‹ä»¶ç”Ÿæˆçš„ç ”è®¨ä¼š</a>å’Œ<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Greg Youngçš„CQRSå’ŒEvent Generation</a> ã€‚ <br><a name="habracut"></a><br> ä¸è¦åœ¨æ‚¨çš„é¡¹ç›®ä¸­ä½¿ç”¨æ­¤å¤„ç»™å‡ºçš„ä»£ç ï¼ è¿™æ˜¯ä¸€ä¸ªäº†è§£CQRSèƒŒåæ€æƒ³çš„å­¦ä¹ å¹³å°ã€‚ æ­¤ä»£ç ä¸èƒ½è¢«ç§°ä¸ºå¯é çš„ï¼Œæœªç»æµ‹è¯•ï¼Œè€Œä¸”æˆ‘å¾ˆå°‘ç¼–ç¨‹æ¥å£ï¼Œå› æ­¤æ›´æ”¹ä»£ç çš„å„ä¸ªéƒ¨åˆ†å°†å˜å¾—æ›´åŠ å›°éš¾ã€‚ å¯ä»¥ä½¿ç”¨çš„CQRSè½¯ä»¶åŒ…æ›´å¥½çš„ä¾‹å­æ˜¯<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Qandidate Labå¼€å‘çš„Broadway</a> ã€‚ è¿™æ˜¯å¹²å‡€çš„ï¼Œæ¾æ•£è€¦åˆçš„ä»£ç ï¼Œä½†æ˜¯ï¼Œå¦‚æœæ‚¨ä»æœªé‡åˆ°è¿‡äº‹ä»¶ç³»ç»Ÿï¼Œåˆ™æœ‰äº›æŠ½è±¡æ— æ³•å®Œå…¨å¼„æ¸…ã€‚ <br><br> æœ€åä¸€ä¸ª-æˆ‘çš„ä»£ç ä¸äº‹ä»¶å’ŒLaravelå‘½ä»¤æ€»çº¿æœ‰å…³ã€‚ æˆ‘æƒ³çœ‹çœ‹ä»£ç åœ¨Laravelä¸­çš„å¤–è§‚ï¼ˆæˆ‘é€šå¸¸å°†è¿™ä¸ªæ¡†æ¶ç”¨äºå°å‹æœºæ„çš„é¡¹ç›®ï¼‰ï¼Œä½†æ˜¯å›æƒ³ä¸€ä¸‹ï¼Œæˆ‘è®¤ä¸ºæˆ‘åº”è¯¥åˆ›å»ºè‡ªå·±çš„å®ç°ã€‚ æˆ‘å¸Œæœ›å³ä½¿å¯¹äºé‚£äº›ä¸ä½¿ç”¨æ¡†æ¶çš„äººï¼Œæˆ‘çš„ä»£ç ä¹Ÿå°†æ˜¯æ¸…æ™°çš„ã€‚ <br><br> åœ¨githubä¸Šï¼Œä»£ç ä½äº<a href="">https://github.com/scazz/cqrs-tutorial.git</a> ï¼Œåœ¨æˆ‘ä»¬çš„æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†è€ƒè™‘å…¶ç»„ä»¶ä»¥å¢åŠ é€»è¾‘ã€‚ <br><br> æˆ‘ä»¬å°†ä¸ºå†²æµªå­¦æ ¡åˆ›å»ºä¸€ä¸ªåˆå§‹æ³¨å†Œç³»ç»Ÿã€‚ åœ¨å®ƒçš„å¸®åŠ©ä¸‹ï¼Œå­¦æ ¡å®¢æˆ·å¯ä»¥æ³¨å†Œè¯¾ç¨‹ã€‚ å¯¹äºè®°å½•è¿‡ç¨‹ï¼Œæˆ‘ä»¬åˆ¶å®šä»¥ä¸‹è§„åˆ™ï¼š <br><br><ul><li> æ¯èŠ‚è¯¾å¿…é¡»è‡³å°‘æœ‰ä¸€ä¸ªå®¢æˆ·... </li><li>  ...ä½†ä¸è¶…è¿‡ä¸‰ä¸ªã€‚ </li></ul><br> åŸºäºäº‹ä»¶çš„CQRSç³»ç»Ÿæœ€ä»¤äººå°è±¡æ·±åˆ»çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯é’ˆå¯¹ç³»ç»Ÿæ‰€éœ€çš„æ¯ä¸ªæŒ‡æ ‡åˆ›å»ºè¯»å–æ¨¡å‹ã€‚ æ‚¨å°†åœ¨ElasticSearchä¸­æ‰¾åˆ°é˜…è¯»æ¨¡å‹çš„æŠ•å½±ç¤ºä¾‹ï¼Œè€ŒGreg Youngåœ¨å…¶äº‹ä»¶å­˜å‚¨ä¸­å®ç°äº†ä¸€ç§é¢å‘ä¸»é¢˜çš„è¯­è¨€ï¼Œç”¨äºå¤„ç†å¤æ‚äº‹ä»¶ã€‚ ä½†æ˜¯ï¼Œä¸ºç®€å•èµ·è§ï¼Œæˆ‘ä»¬çš„è¯»å–æŠ•å½±å°†æ˜¯ä¸Eloquentä¸€èµ·ä½¿ç”¨çš„æ ‡å‡†SQLæ•°æ®åº“ã€‚ ç»“æœï¼Œæˆ‘ä»¬å°†æœ‰ä¸€ä¸ªè¡¨ç”¨äºç±»ï¼Œä¸€ä¸ªè¡¨ç”¨äºå®¢æˆ·ã€‚ <br><br> äº‹ä»¶ç”Ÿæˆçš„æ¦‚å¿µè¿˜å…è®¸æ‚¨è„±æœºå¤„ç†äº‹ä»¶ã€‚ ä½†æ˜¯åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æœ€å¤§ç¨‹åº¦åœ°åšæŒâ€œä¼ ç»Ÿâ€å¼€å‘æ¨¡å‹ï¼ˆå†æ¬¡ç®€åŒ–ï¼‰ï¼Œå¹¶ä¸”å°†äº‹ä»¶å­˜å‚¨åœ¨å­˜å‚¨åº“ä¸­åï¼Œæˆ‘ä»¬çš„é˜…è¯»é¢„æµ‹å°†å®æ—¶æ›´æ–°ã€‚ <br><br><h2> é¡¹ç›®è®¾ç½®å’Œé¦–æ¬¡æµ‹è¯• </h2><br><pre><code class="plaintext hljs">git clone https://github.com/scazz/cqrs-tutorial</code> </pre> <br> åˆ›å»ºä¸€ä¸ªæ–°çš„Laravel 5é¡¹ç›® <br><br><pre> <code class="plaintext hljs">$&gt; laravel new cqrs-tutorial</code> </pre> <br> å¯¹äºåˆå­¦è€…ï¼Œæˆ‘ä»¬éœ€è¦æµ‹è¯•ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨é›†æˆæµ‹è¯•ï¼Œè¿™å°†ç¡®ä¿å®¢æˆ·çš„è¯¾ç¨‹æ³¨å†Œä¼šå¯¼è‡´åœ¨Eloquentæ¨¡å‹ä¸­åˆ›å»ºè¯¾ç¨‹ã€‚ <br><br> åˆ—å‡ºæµ‹è¯•/ CQRSTest.phpï¼š <br><br><pre> <code class="plaintext hljs">use Illuminate\Foundation\Bus\DispatchesCommands; class CQRSTest extends TestCase { use DispatchesCommands;</code> </pre><br><pre> <code class="bash hljs">/** *  ,   BookLesson       * @<span class="hljs-built_in"><span class="hljs-built_in">return</span></span> void */ public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span> = <span class="hljs-string"><span class="hljs-string">'123e4567-e89b-12d3-a456-426655440000'</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertNotNull(Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( Lesson::find(<span class="hljs-variable"><span class="hljs-variable">$testLessonId</span></span>)-&gt;clientName, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ); } }</code> </pre> <br> æˆ‘ä»¬å°†æ–°æ´»åŠ¨é¢„å…ˆåˆ†é…ç»™ä¸€ä¸ªIDï¼Œåˆ›å»ºä¸€ä¸ªå›¢é˜Ÿæ¥æ³¨å†Œæ–°æ´»åŠ¨ï¼Œç„¶åå‘Šè¯‰Laravelå‘é€å®ƒã€‚ åœ¨è¯¾ç¨‹è¡¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€æ¡æ–°è®°å½•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨Eloquentæ¨¡å‹è¯»å–è¯¥è®°å½•ã€‚ æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ•°æ®åº“ï¼Œå› æ­¤è¯·æ­£ç¡®å¡«å†™æ‚¨çš„.envæ–‡ä»¶ã€‚ <br><br> åœ¨äº‹ä»¶å­˜å‚¨ä¸­è®°å½•çš„æ¯ä¸ªäº‹ä»¶éƒ½é™„åŠ åˆ°èšåˆçš„æ ¹ï¼Œæˆ‘ä»¬å°†å…¶ç®€ç§°ä¸ºå®ä½“ï¼ˆEntityï¼‰-ç”¨äºæ•™è‚²ç›®çš„çš„æŠ½è±¡åªä¼šå¢åŠ æ··ä¹±ã€‚  IDæ˜¯é€šç”¨å”¯ä¸€æ ‡è¯†ç¬¦ï¼ˆUUIDï¼‰ã€‚ æ´»åŠ¨å­˜å‚¨åŒºå¹¶ä¸å…³å¿ƒæ´»åŠ¨æ˜¯å¦é€‚ç”¨äºè¯¾ç¨‹æˆ–å®¢æˆ·ã€‚ ä»–åªçŸ¥é“å®ƒä¸IDç›¸å…³è”ã€‚ <br><br> æ ¹æ®æµ‹è¯•æœŸé—´å‘ç°çš„é”™è¯¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ›å»ºç¼ºå°‘çš„ç±»ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å°†åˆ›å»ºLessonIdç±»ï¼Œç„¶ååˆ›å»ºBookLessonå‘½ä»¤ï¼ˆç°åœ¨ä¸ç”¨æ‹…å¿ƒå¤„ç†ç¨‹åºæ–¹æ³•ï¼Œåªéœ€ç»§ç»­è¿è¡Œæµ‹è¯•å³å¯ï¼‰ã€‚  Lessonç±»æ˜¯Lessonåç§°ç©ºé—´ä¹‹å¤–çš„é˜…è¯»æ¨¡å‹ã€‚ ç‹¬å®¶é˜…è¯»æ¨¡å‹-ä¸»é¢˜åŒºåŸŸçš„é€»è¾‘æ°¸è¿œä¸ä¼šå­˜å‚¨åœ¨è¿™é‡Œã€‚ æ€»ä¹‹ï¼Œæˆ‘ä»¬å°†éœ€è¦ä¸ºè¯¾ç¨‹è¡¨åˆ›å»ºè¿ç§»ã€‚ <br><br> ä¸ºäº†ä¿æŒä»£ç çš„æ¸…æ™°åº¦ï¼Œæˆ‘å°†ä½¿ç”¨æ–­è¨€éªŒè¯åº“ã€‚ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ·»åŠ å®ƒï¼š <br><br><pre> <code class="plaintext hljs">$&gt; composer require beberlei/assert</code> </pre> <br> è€ƒè™‘åº”è¯¥ç”±è¯¥å‘½ä»¤å¯åŠ¨çš„è¿‡ç¨‹ï¼š <br><br><ol><li> éªŒè¯ï¼šå‘½ä»¤æ€§å‘½ä»¤å¯èƒ½ä¼šå¤±è´¥ï¼Œå¹¶ä¸”äº‹ä»¶å·²ç»å‘ç”Ÿï¼Œå› æ­¤ä¸åº”å¤±è´¥ã€‚ </li><li> åˆ›å»ºä¸€ä¸ªæ–°çš„LessonWasBookedäº‹ä»¶ï¼ˆæ³¨å†Œä¸€ä¸ªè¯¾ç¨‹ï¼‰ã€‚ </li><li> æ›´æ–°æ´»åŠ¨çŠ¶æ€ã€‚  ï¼ˆè®°å½•æ¨¡å‹å¿…é¡»çŸ¥é“æ¨¡å‹çš„çŠ¶æ€ï¼Œä»¥ä¾¿å®ƒå¯ä»¥æ‰§è¡ŒéªŒè¯ã€‚ï¼‰ </li><li> å°†æ­¤äº‹ä»¶æ·»åŠ åˆ°æ´»åŠ¨è®°å½•æ¨¡å‹ä¸­å­˜å‚¨çš„æœªæäº¤äº‹ä»¶æµä¸­ã€‚ </li><li> å°†æœªæäº¤çš„äº‹ä»¶æµä¿å­˜åˆ°å­˜å‚¨åº“ã€‚ </li><li> åœ¨å…¨å±€èŒƒå›´å†…å¼•å‘LessonWasBookedäº‹ä»¶ï¼Œä»¥é€šçŸ¥æ‰€æœ‰æ­£åœ¨é˜…è¯»çš„æŠ•å½±ä»ªæ›´æ–°è¯¾ç¨‹è¡¨ã€‚ </li></ol><br> é¦–å…ˆï¼Œæ‚¨éœ€è¦ä¸ºè¯¥è¯¾ç¨‹åˆ›å»ºä¸€ä¸ªå½•éŸ³æ¨¡å‹ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•<code>Lesson::bookClientOntoNewLesson()</code> ã€‚ å®ƒä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„<code>LessonWasOpened</code>äº‹ä»¶ï¼ˆè¯¾ç¨‹å·²æ‰“å¼€ï¼‰ï¼Œå°†å…¶åº”ç”¨äºè‡ªèº«ï¼ˆä»…è®¾ç½®å…¶IDï¼‰ï¼Œç„¶åå°†æ–°äº‹ä»¶ä»¥<code>DomainEventMessage</code>çš„å½¢å¼æ·»åŠ åˆ°æœªæäº¤çš„äº‹ä»¶åˆ—è¡¨ä¸­ï¼ˆäº‹ä»¶ä»¥åŠä¸€äº›ä¿å­˜åˆ°äº‹ä»¶å­˜å‚¨æ—¶ä½¿ç”¨çš„å…ƒæ•°æ®ï¼‰ã€‚ <br><br> é‡å¤è¯¥è¿‡ç¨‹ä»¥å°†å®¢æˆ·ç«¯æ·»åŠ åˆ°äº‹ä»¶ä¸­ã€‚ å½“åº”ç”¨<code>ClientWasBookedOntoLesson</code>äº‹ä»¶ï¼ˆå®¢æˆ·ç«¯å·²æ³¨å†Œè¯¾ç¨‹ï¼‰æ—¶ï¼Œè®°å½•æ¨¡å‹ä¸ä¼šè·Ÿè¸ªå®¢æˆ·ç«¯åç§°ï¼Œè€Œåªä¼šè·Ÿè¸ªå·²æ³¨å†Œå®¢æˆ·ç«¯çš„æ•°é‡ã€‚ è®°å½•æ¨¡å‹ä¸éœ€è¦çŸ¥é“å®¢æˆ·åç§°å³å¯ç¡®ä¿ä¸€è‡´æ€§ã€‚ <br><br> ç°åœ¨ï¼Œ <code>applyLessonWasOpened</code>å’Œ<code>applyClientWasBookedOntoLesson</code>æ–¹æ³•å¯èƒ½çœ‹èµ·æ¥æœ‰äº›å¥‡æ€ªã€‚ å½“æˆ‘ä»¬éœ€è¦é‡ç°æ—§äº‹ä»¶ä»¥å½¢æˆè®°å½•æ¨¡å‹çš„çŠ¶æ€æ—¶ï¼Œå°†åœ¨ä»¥åä½¿ç”¨å®ƒä»¬ã€‚ è§£é‡Šèµ·æ¥å¹¶ä¸å®¹æ˜“ï¼Œå› æ­¤ï¼Œæˆ‘å°†æä¾›ä¸€ä¸ªä»£ç ï¼Œä»¥å¸®åŠ©æ‚¨äº†è§£æ­¤è¿‡ç¨‹ã€‚ ç¨åï¼Œæˆ‘ä»¬å°†æå–å¤„ç†uncommittedEventså¹¶ç”ŸæˆåŸŸäº‹ä»¶æ¶ˆæ¯çš„ä»£ç ã€‚ <br><br><pre> <code class="bash hljs">app/School/Lesson/Lesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> openLesson( LessonId <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ) { /*      ,      ,       */ <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new LessonWasOpened( <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); } protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients = 0; } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> bookClient( <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients &gt;= 3) { throw new TooManyClientsAddedToLesson(); } <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;apply( new ClientBookedOntoLesson( <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>) ); } /** *       â€” *  ,       *      ,       , *      . */ protected <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyClientBookedOntoLesson( ClientBookedOntoLesson <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;numberOfClients++; }</code> </pre> <br> æˆ‘ä»¬å¯ä»¥ä»è®°å½•æ¨¡å‹ä¸­æå–CQRSç»„ä»¶-æ¶‰åŠå¤„ç†æœªæäº¤äº‹ä»¶çš„ç±»çš„ç‰‡æ®µã€‚ æˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ªå®‰å…¨çš„<code>apply()</code>å‡½æ•°æ¥æ¸…é™¤äº‹ä»¶ç”Ÿæˆçš„å®ä½“çš„APIï¼Œè¯¥å‡½æ•°æ¥å—äº‹ä»¶ï¼Œè°ƒç”¨ç›¸åº”çš„<code>applyEventName()</code>æ–¹æ³•ï¼Œå¹¶å°†æ–°çš„<code>DomainEventMessage</code>äº‹ä»¶æ·»åŠ åˆ°æœªæäº¤çš„äº‹ä»¶åˆ—è¡¨ä¸­ã€‚ æå–çš„ç±»æ˜¯CQRSå®ç°çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¹¶ä¸”ä¸åŒ…å«åŸŸé€»è¾‘ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å‘½åç©ºé—´ï¼šApp \ CQRSï¼š <br><br>  <i>æ³¨æ„ä»£ç <code>app/CQRS/EventSourcedEntity.php</code></i> <i><br></i>  <i>ä¸ºäº†ä½¿ä»£ç æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ <code>DomainEventMessage</code>ç±»ï¼Œè¿™æ˜¯ä¸€ä¸ªç®€å•çš„<code>DomainEventMessage</code>å¯ä»¥åœ¨<code>app/CQRS/DomainEventMessage.php</code></i> <br><br> å› æ­¤ï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸€ä¸ªç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿä¸ºæ¯æ¬¡å†™å°è¯•ç”Ÿæˆäº‹ä»¶ï¼Œå¹¶ä½¿ç”¨äº‹ä»¶è®°å½•å¿…è¦çš„æ›´æ”¹ä»¥é˜²æ­¢ä¸å˜ã€‚ ä¸‹ä¸€æ­¥æ˜¯å°†è¿™äº›äº‹ä»¶ä¿å­˜åœ¨å•†åº—ï¼ˆEventStoreï¼‰ä¸­ã€‚ é¦–å…ˆï¼Œéœ€è¦åˆ›å»ºæ­¤äº‹ä»¶å­˜å‚¨åº“ã€‚ ä¸ºç®€åŒ–èµ·è§ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨Eloquentæ¨¡å‹ï¼Œå®ƒæ˜¯ä¸€ä¸ªå¸¦æœ‰ä»¥ä¸‹å­—æ®µçš„ç®€å•SQLè¡¨ï¼š* <code>UUID</code> ï¼ˆç”¨äºäº†è§£å°†äº‹ä»¶åº”ç”¨åˆ°å“ªä¸ªå®ä½“ï¼‰* <code>event_payload</code> ï¼ˆåŒ…å«é‡æ–°åˆ›å»ºäº‹ä»¶æ‰€éœ€çš„æ‰€æœ‰å†…å®¹çš„åºåˆ—åŒ–æ¶ˆæ¯ï¼‰* <code>event_payload</code>ç”¨äºäº†è§£äº‹ä»¶å‘ç”Ÿæ—¶é—´çš„æ—¶é—´æˆ³å‘ç”Ÿäº† å¦‚æœä»”ç»†æŸ¥çœ‹ä»£ç ï¼Œæ‚¨å°†çœ‹åˆ°æˆ‘åˆ›å»ºäº†ä¸¤ä¸ªå‘½ä»¤-åˆ›å»ºå’Œé”€æ¯äº‹ä»¶å­˜å‚¨è¡¨ï¼š <br><br><ul><li>  php artisan eloquenteventstoreï¼šåˆ›å»ºï¼ˆåº”ç”¨ç¨‹åº\ CQRS \ EloquentEventStore \ CreateEloquentEventStoreï¼‰ </li><li>  php artisan eloquenteventstoreï¼šåˆ é™¤ï¼ˆApp \ CQRS \ EloquentEventStore \ DropEloquentEventStoreï¼‰ï¼ˆåˆ«å¿˜äº†å°†å®ƒä»¬æ·»åŠ åˆ°App \ Console \ Kernel.phpä»¥ä¾¿å®ƒä»¬åŠ è½½ï¼‰ã€‚ </li></ul><br> ä¸ä½¿ç”¨SQLä½œä¸ºäº‹ä»¶å­˜å‚¨æœ‰ä¸¤ä¸ªå¾ˆå¥½çš„ç†ç”±ï¼šå®ƒæ²¡æœ‰å®ç°ä»…è¿½åŠ æ¨¡å‹ï¼ˆä»…æ·»åŠ æ•°æ®ï¼Œäº‹ä»¶å¿…é¡»æ˜¯ä¸å¯å˜çš„ï¼‰ï¼Œä¹Ÿå› ä¸ºSQLå¹¶ä¸æ˜¯æ—¶æ€æ•°æ®åº“çš„ç†æƒ³æŸ¥è¯¢è¯­è¨€ã€‚ æˆ‘ä»¬å¯¹æ¥å£è¿›è¡Œç¼–ç¨‹ï¼Œä»¥æ–¹ä¾¿åœ¨åç»­å‡ºç‰ˆç‰©ä¸­æ›¿æ¢äº‹ä»¶å­˜å‚¨ã€‚ <br><br> è¦ä¿å­˜äº‹ä»¶ï¼Œè¯·ä½¿ç”¨å­˜å‚¨åº“ã€‚ æ¯å½“ä¸ºè®°å½•æ¨¡å‹è°ƒç”¨<code>save()</code> ï¼Œæˆ‘ä»¬éƒ½ä¼šå°†uncommittedEventsåˆ—è¡¨ä¿å­˜åœ¨äº‹ä»¶å­˜å‚¨ä¸­ã€‚ ä¸ºäº†å­˜å‚¨äº‹ä»¶ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ç§å¯¹å…¶è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æœºåˆ¶ã€‚ ä¸ºæ­¤åˆ›å»ºä¸€ä¸ªåºåˆ—åŒ–å™¨ã€‚ æˆ‘ä»¬å°†éœ€è¦å…ƒæ•°æ®ï¼Œä¾‹å¦‚äº‹ä»¶ç±»ï¼ˆä¾‹å¦‚<code>App\School\Lesson\Events\LessonWasOpened</code> ï¼‰å’Œäº‹ä»¶æœ‰æ•ˆè´Ÿè½½ï¼ˆé‡å»ºäº‹ä»¶æ‰€éœ€çš„æ•°æ®ï¼‰ã€‚ <br><br> æ‰€æœ‰è¿™äº›å°†ä»¥JSONæ ¼å¼ç¼–ç ï¼Œç„¶åä¸å®ä½“UUIDå’Œæ—¶é—´æˆ³ä¸€èµ·å†™å…¥æˆ‘ä»¬çš„æ•°æ®åº“ã€‚ æˆ‘ä»¬æƒ³åœ¨æ•è·äº‹ä»¶åæ›´æ–°é˜…è¯»æ¨¡å‹ï¼Œå› æ­¤å­˜å‚¨åº“å°†åœ¨ä¿å­˜åè§¦å‘æ¯ä¸ªäº‹ä»¶ã€‚ åºåˆ—åŒ–ç¨‹åºå°†è´Ÿè´£ç¼–å†™äº‹ä»¶ç±»ï¼Œè€Œäº‹ä»¶å°†è´Ÿè´£åºåˆ—åŒ–å…¶æœ‰æ•ˆè´Ÿè½½ã€‚ å®Œå…¨åºåˆ—åŒ–çš„äº‹ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="plaintext hljs"> { class: "App\\School\\Lesson\\Events\\", event: $event-&gt;serialize() }</code> </pre> <br> ç”±äºæ‰€æœ‰äº‹ä»¶éƒ½éœ€è¦åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ³•ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ª<code>SerializableEvent</code>æ¥å£å¹¶æ·»åŠ æœŸæœ›å€¼ç±»å‹çš„æŒ‡ç¤ºã€‚ æ›´æ–°æˆ‘ä»¬çš„<code>LessonWasOpened</code>äº‹ä»¶ï¼š <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php class LessonWasOpened implements SerializableEvent { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serialize</span></span></span></span>() { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'lessonId'</span></span>=&gt; (string) <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;getLessonId() ); } }</code> </pre> <br> åˆ›å»ºä¸€ä¸ª<code>LessonRepository</code>å­˜å‚¨åº“ã€‚ æˆ‘ä»¬ç¨åå¯ä»¥é‡æ„å’Œæå–æ ¸å¿ƒCQRSç»„ä»¶ã€‚ <br><br> <code>app/School/Lesson/LessonRepository.php</code> <br> <pre> <code class="plaintext hljs">eventStoreRepository = new EloquentEventStoreRepository( new EventSerializer() ); } public function save(Lesson $lesson) { /** @var DomainEventMessage $domainEventMessage */ foreach( $lesson-&gt;getUncommittedDomainEvents() as $domainEventMessage ) { $this-&gt;eventStoreRepository-&gt;append( $domainEventMessage-&gt;getId(), $domainEventMessage-&gt;getEvent(), $domainEventMessage-&gt;getRecordedAt() ); Event::fire($domainEventMessage-&gt;getEvent()); } } }</code> </pre> <br> å¦‚æœå†æ¬¡è¿è¡Œé›†æˆæµ‹è¯•ï¼Œç„¶åæ£€æŸ¥<code>domain_events</code> SQLè¡¨ï¼Œåˆ™åº”è¯¥åœ¨æ•°æ®åº“ä¸­çœ‹åˆ°ä¸¤ä¸ªäº‹ä»¶ã€‚ <br><br> æˆåŠŸé€šè¿‡æµ‹è¯•çš„æœ€åä¸€æ­¥æ˜¯æ”¶å¬å¹¿æ’­äº‹ä»¶å¹¶æ›´æ–°Lessoné˜…è¯»æ¨¡å‹çš„é¢„æµ‹ã€‚  Lessonå¹¿æ’­äº‹ä»¶å°†ç”±<code>LessonProjector</code>æ‹¦æˆªï¼Œè¯¥äº‹ä»¶å°†å¯¹<code>LessonProjection</code> ï¼ˆè¯¾ç¨‹è¡¨çš„<code>LessonProjection</code>æ¨¡å‹ï¼‰è¿›è¡Œå¿…è¦çš„æ›´æ”¹ï¼š <br><br><pre> <code class="bash hljs"> app/School/Lesson/Projections/LessonProjector.php class LessonProjector { public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> applyLessonWasOpened( LessonWasOpened <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span> = new LessonProjection(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;id = <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;getLessonId(); <span class="hljs-variable"><span class="hljs-variable">$lessonProjection</span></span>-&gt;save(); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> subscribe(Dispatcher <span class="hljs-variable"><span class="hljs-variable">$events</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span> = self::class; <span class="hljs-variable"><span class="hljs-variable">$events</span></span>-&gt;listen( LessonWasOpened::class, <span class="hljs-variable"><span class="hljs-variable">$fullClassName</span></span>.<span class="hljs-string"><span class="hljs-string">'@applyLessonWasOpened'</span></span>); } }  app/School/Lesson/Projections/LessonProjection.php class LessonProjection extends Model { public <span class="hljs-variable"><span class="hljs-variable">$timestamps</span></span> = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; protected <span class="hljs-variable"><span class="hljs-variable">$table</span></span> = <span class="hljs-string"><span class="hljs-string">"lessons"</span></span>; }</code> </pre> <br> å¦‚æœè¿è¡Œæµ‹è¯•ï¼Œæ‚¨å°†çœ‹åˆ°å‘ç”Ÿäº†SQLé”™è¯¯ï¼š <br><br><pre> <code class="plaintext hljs">Unknown column 'clientName' in 'field list'</code> </pre> <br> ä¸€æ—¦åˆ›å»ºè¿ç§»ä»¥å°†<code>clientName</code>æ·»åŠ åˆ°è¯¾ç¨‹è¡¨ä¸­ï¼Œæˆ‘ä»¬å°±å°†æˆåŠŸé€šè¿‡æµ‹è¯•ã€‚ æˆ‘ä»¬å·²ç»å®ç°äº†CQRSçš„åŸºæœ¬åŠŸèƒ½ï¼šå›¢é˜Ÿåˆ›å»ºç”¨äºç”Ÿæˆé˜…è¯»æ¨¡å‹çš„äº‹ä»¶ã€‚ <br><br><h2> é€šè¿‡é“¾æ¥æ”¹å–„é˜…è¯»æ¨¡å¼ </h2><br> æˆ‘ä»¬å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘ï¼Œä½†è¿™è¿˜ä¸æ˜¯å…¨éƒ¨ï¼ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œé˜…è¯»æ¨¡å‹ä»…æ”¯æŒä¸€ä¸ªå®¢æˆ·ç«¯ï¼ˆæˆ‘ä»¬åœ¨åŸŸè§„åˆ™ä¸­æŒ‡å®šäº†ä¸‰ä¸ªï¼‰ã€‚ æˆ‘ä»¬å¯¹é˜…è¯»æ¨¡å‹çš„æ›´æ”¹éå¸¸ç®€å•ï¼šæˆ‘ä»¬åªåˆ›å»ºä¸€ä¸ªClientæŠ•å½±æ¨¡å‹å’Œä¸€ä¸ª<code>ClientProjector</code>æ¥æ•è·<code>ClientBookedOntoLesson</code>äº‹ä»¶ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬æ›´æ–°æµ‹è¯•ä»¥åæ˜ æˆ‘ä»¬å¸Œæœ›åœ¨é˜…è¯»æ¨¡å‹ä¸­çœ‹åˆ°çš„å˜åŒ–ï¼š <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testFiringEventUpdatesReadModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals( <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;id, (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$client</span></span> = <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients()-&gt;first(); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertEquals(<span class="hljs-variable"><span class="hljs-variable">$client</span></span>-&gt;name, <span class="hljs-variable"><span class="hljs-variable">$clientName</span></span>); }</code> </pre><br> è¿™æ¸…æ¥šåœ°è¯´æ˜äº†æ›´æ”¹é˜…è¯»æ¨¡å‹æœ‰å¤šä¹ˆå®¹æ˜“ã€‚ ç›´åˆ°äº‹ä»¶å­˜å‚¨åº“çš„æ‰€æœ‰å†…å®¹éƒ½ä¿æŒä¸å˜ã€‚ å¦å¤–ï¼Œä½¿ç”¨äº‹ä»¶ç³»ç»Ÿæ—¶ï¼Œæˆ‘ä»¬ä¼šè·å¾—ç”¨äºåŸºæœ¬æµ‹è¯•çš„æ•°æ®-æ›´æ”¹é˜…è¯»æ¨¡å‹çš„æŠ•å½±ä»ªæ—¶ï¼Œæˆ‘ä»¬ä¼šè†å¬ç³»ç»Ÿä¸­å‘ç”Ÿè¿‡çš„æ‰€æœ‰äº‹ä»¶ã€‚ <br><br> æˆ‘ä»¬ä½¿ç”¨æ–°çš„æŠ•å½±ä»ªå†ç°è¿™äº›äº‹ä»¶ï¼Œæ£€æŸ¥å¼‚å¸¸æƒ…å†µï¼Œå¹¶å°†ç»“æœä¸â€‹â€‹ä»¥å‰çš„æŠ•å½±è¿›è¡Œæ¯”è¾ƒã€‚ ç³»ç»Ÿè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œæˆ‘ä»¬å°†æœ‰ç›¸å½“å…·ä»£è¡¨æ€§çš„äº‹ä»¶é€‰æ‹©æ¥æµ‹è¯•æˆ‘ä»¬çš„æŠ•å½±æœºã€‚ <br><br> æˆ‘ä»¬çš„è®°å½•æ¨¡å‹å½“å‰ä¸å…·å¤‡åŠ è½½å½“å‰çŠ¶æ€çš„èƒ½åŠ›ã€‚ å¦‚æœè¦åœ¨è¯¾ç¨‹ä¸­æ·»åŠ ç¬¬äºŒä¸ªå®¢æˆ·ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°åˆ›å»ºç¬¬äºŒä¸ªClientWaâš“ToLessonäº‹ä»¶ï¼Œä½†æ˜¯æˆ‘ä»¬ä¸èƒ½æä¾›é’ˆå¯¹ä¸å˜æ€§çš„ä¿æŠ¤ã€‚ ä¸ºäº†æ›´åŠ æ¸…æ™°ï¼Œæˆ‘å»ºè®®ç¼–å†™ç¬¬äºŒä¸ªæµ‹è¯•æ¥æ¨¡æ‹Ÿæ¯èŠ‚è¯¾ä¸­ä¸¤ä¸ªå®¢æˆ·ç«¯çš„å½•åˆ¶ã€‚ <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testLoadingWriteModel</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span> = <span class="hljs-string"><span class="hljs-string">"George"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span> = <span class="hljs-string"><span class="hljs-string">"Fred"</span></span>; <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$command</span></span> = new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch(<span class="hljs-variable"><span class="hljs-variable">$command</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_1</span></span>); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertClientCollectionContains(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;clients, <span class="hljs-variable"><span class="hljs-variable">$clientName_2</span></span>); }</code> </pre> <br> å¯¹äºæˆ‘ä»¬çš„è®°å½•æ¨¡å‹ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ç§â€œåŠ è½½â€å·²åœ¨äº‹ä»¶å­˜å‚¨ä¸­å¯¹å…¶åº”ç”¨äº†äº‹ä»¶çš„å®ä½“çš„æ–¹æ³•ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡å›æ”¾å¼•ç”¨å®ä½“UUIDçš„æ¯ä¸ªäº‹ä»¶æ¥å®ç°æ­¤ç›®çš„ã€‚ ä¸€èˆ¬è€Œè¨€ï¼Œè¯¥è¿‡ç¨‹å¦‚ä¸‹ï¼š <br><br><ol><li> æˆ‘ä»¬ä»äº‹ä»¶å­˜å‚¨æ¥æ”¶æ‰€æœ‰ç›¸å…³çš„äº‹ä»¶æ¶ˆæ¯ã€‚ </li><li> å¯¹äºæ¯æ¡æ¶ˆæ¯ï¼Œæˆ‘ä»¬éƒ½ä¼šé‡æ–°åˆ›å»ºç›¸åº”çš„äº‹ä»¶ã€‚ </li><li> æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„å®ä½“è®°å½•æ¨¡å‹å¹¶æ’­æ”¾æ¯ä¸ªäº‹ä»¶ã€‚ </li></ol><br> ç›®å‰ï¼Œæˆ‘ä»¬çš„æµ‹è¯•ä¼šå¼•å‘å¼‚å¸¸ï¼Œå› æ­¤æˆ‘ä»¬å°†ä»ä½¿ç”¨<code>BookLesson</code>å‘½ä»¤ä½œä¸ºæ¨¡æ¿åˆ›å»ºå¿…è¦çš„<code>BookClientOntoLesson</code> ï¼ˆä¸ºè¯¾ç¨‹æ³¨å†Œå®¢æˆ·ç«¯ï¼‰å¼€å§‹ã€‚ è¯¥å¤„ç†ç¨‹åºæ–¹æ³•å°†å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="bash hljs"> app/School/Lesson/Commands/BookClientOntoLesson.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> handle(LessonRepository <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>) { /** @var Lesson <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> */ <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;lessonId); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;bookClient(<span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;clientName); <span class="hljs-variable"><span class="hljs-variable">$repository</span></span>-&gt;save(<span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>); }      : app/School/Lesson/LessonRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(LessonId <span class="hljs-variable"><span class="hljs-variable">$id</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventStoreRepository-&gt;load(<span class="hljs-variable"><span class="hljs-variable">$id</span></span>); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span> = new Lesson(); <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>-&gt;initializeState(<span class="hljs-variable"><span class="hljs-variable">$events</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$lesson</span></span>; }</code> </pre> <br> å­˜å‚¨åº“åŠ è½½åŠŸèƒ½è¿”å›ä¸€ä¸ªé‡æ–°åˆ›å»ºçš„äº‹ä»¶æ•°ç»„ã€‚ ä¸ºæ­¤ï¼Œå¥¹é¦–å…ˆåœ¨å­˜å‚¨åº“ä¸­æ‰¾åˆ°æœ‰å…³äº‹ä»¶çš„æ¶ˆæ¯ï¼Œç„¶åå°†å®ƒä»¬ä¼ é€’ç»™<code>Serializer</code>ä»¥å°†æ¯ä¸ªæ¶ˆæ¯è½¬æ¢ä¸ºäº‹ä»¶ã€‚  <code>Serializer</code>ä»äº‹ä»¶åˆ›å»ºæ¶ˆæ¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦æ·»åŠ <code>deserialize()</code>æ–¹æ³•ä»¥æ‰§è¡Œé€†å˜æ¢ã€‚ å›æƒ³ä¸€ä¸‹ï¼Œå°†<code>Serializer</code>å™¨ä¼ é€’ç»™æ¯ä¸ªäº‹ä»¶ä»¥åºåˆ—åŒ–äº‹ä»¶æ•°æ®ï¼ˆä¾‹å¦‚ï¼Œå®¢æˆ·ç«¯åç§°ï¼‰ã€‚ æˆ‘ä»¬å°†æ‰§è¡Œç›¸åŒçš„æ“ä½œä»¥æ‰§è¡Œé€†å˜æ¢ï¼Œè€Œæˆ‘ä»¬çš„<code>SerializableEvent</code>æ¥å£å¿…é¡»ä½¿ç”¨<code>deserialize()</code>æ–¹æ³•è¿›è¡Œæ›´æ–°ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ä»£ç ï¼Œä»¥ä¾¿ä¸€åˆ‡éƒ½å‡†å¤‡å°±ç»ªã€‚ é¦–å…ˆæ˜¯<code>EventStoreRepository</code>åŠ è½½<code>EventStoreRepository</code> ï¼š <br><br><pre> <code class="bash hljs">app/CQRS/EloquentEventStore/EloquentEventStoreRepository.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> load(<span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> = EloquentEventStoreModel::<span class="hljs-built_in"><span class="hljs-built_in">where</span></span>(<span class="hljs-string"><span class="hljs-string">'uuid'</span></span>, <span class="hljs-variable"><span class="hljs-variable">$uuid</span></span>)-&gt;get(); <span class="hljs-variable"><span class="hljs-variable">$events</span></span> = []; foreach(<span class="hljs-variable"><span class="hljs-variable">$eventMessages</span></span> as <span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>) { /*       event_payload,        . */ <span class="hljs-variable"><span class="hljs-variable">$events</span></span>[] = <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;eventSerializer-&gt;deserialize( json_decode(<span class="hljs-variable"><span class="hljs-variable">$eventMessage</span></span>-&gt;event_payload)); } <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$events</span></span>; }</code> </pre><br> åœ¨<code>eventSerializer</code>ä½¿ç”¨é€‚å½“çš„ååºåˆ—åŒ–åŠŸèƒ½ï¼š <br><br><pre> <code class="bash hljs">app/CQRS/Serializer/EventSerializer.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> serialize( SerializableEvent <span class="hljs-variable"><span class="hljs-variable">$event</span></span> ) { <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> array( <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; get_class(<span class="hljs-variable"><span class="hljs-variable">$event</span></span>), <span class="hljs-string"><span class="hljs-string">'payload'</span></span> =&gt; <span class="hljs-variable"><span class="hljs-variable">$event</span></span>-&gt;serialize() ); } public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize( <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span> ) { <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;class; <span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span> = <span class="hljs-variable"><span class="hljs-variable">$serializedEvent</span></span>-&gt;payload; <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> <span class="hljs-variable"><span class="hljs-variable">$eventClass</span></span>::deserialize(<span class="hljs-variable"><span class="hljs-variable">$eventPayload</span></span>); }</code> </pre> <br> æ€»ä¹‹ï¼Œæˆ‘ä»¬å°†åœ¨<code>LessonWasOpened</code>ä½¿ç”¨é™æ€å·¥å‚æ–¹æ³•<code>LessonWasOpened</code> ï¼ˆ <code>deserialize()</code> ï¼ˆæˆ‘ä»¬éœ€è¦å°†æ­¤æ–¹æ³•æ·»åŠ åˆ°æ¯ä¸ªäº‹ä»¶ä¸­ï¼‰ <br><br><pre> <code class="bash hljs">app/School/Lesson/Events/LessonWasOpened.php public static <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> deserialize(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>) { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId(<span class="hljs-variable"><span class="hljs-variable">$data</span></span>-&gt;lessonId); <span class="hljs-built_in"><span class="hljs-built_in">return</span></span> new self(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>); }</code> </pre> <br> ç°åœ¨ï¼Œç›¸å¯¹äºæˆ‘ä»¬çš„å®ä½“è®°å½•æ¨¡å‹ï¼Œæˆ‘ä»¬æœ‰äº†ä¸€ä¸ªåˆšåˆšå†ç°çš„æ‰€æœ‰äº‹ä»¶çš„æ•°ç»„ï¼Œç”¨äºåˆå§‹åŒ–<code>app/CQRS/EventSouredEntity.php</code>ä¸­çš„<code>initializeState</code>æ–¹æ³•ä¸­çš„çŠ¶æ€ <br><br> ç°åœ¨è¿è¡Œæˆ‘ä»¬çš„æµ‹è¯•ã€‚ å®¾æœï¼ <br> å®é™…ä¸Šï¼Œç›®å‰æˆ‘ä»¬è¿˜æ²¡æœ‰æµ‹è¯•æ¥éªŒè¯æ˜¯å¦ç¬¦åˆæˆ‘ä»¬çš„åŸŸè§„åˆ™ï¼Œå› æ­¤æˆ‘ä»¬æ¥ç¼–å†™å®ƒï¼š <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testMoreThan3ClientsCannotBeAddedToALesson</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"george"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"fred"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;setExpectedException( TooManyClientsAddedToLesson::class ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookClientOntoLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"emma"</span></span>) ); }</code> </pre> <br> è¯·æ³¨æ„ï¼Œæˆ‘ä»¬åªéœ€è¦<code>lessonId</code>æ­¤æµ‹è¯•å°†åœ¨æ¯ä¸ªå‘½ä»¤æœŸé—´é‡æ–°åˆå§‹åŒ–è¯¾ç¨‹çš„çŠ¶æ€ã€‚ <br><br> ç›®å‰ï¼Œæˆ‘ä»¬ä»…ä¼ è¾“æ‰‹åŠ¨åˆ›å»ºçš„<code>UUID</code> ï¼Œè€Œå®é™…ä¸Šæˆ‘ä»¬å¸Œæœ›è‡ªåŠ¨ç”Ÿæˆå®ƒä»¬ã€‚ æˆ‘å°†ä½¿ç”¨<code>Ramsy\UUID</code>è½¯ä»¶åŒ…ï¼Œå› æ­¤è®©æˆ‘ä»¬ä¸<code>composer</code>ä¸€èµ·å®‰è£…å®ƒï¼š <br><br><pre> <code class="plaintext hljs">$&gt; composer require ramsey/uuid</code> </pre> <br> ç°åœ¨æ›´æ–°æµ‹è¯•ä»¥ä½¿ç”¨æ–°è½¯ä»¶åŒ…ï¼š <br><br><pre> <code class="bash hljs">tests/CQRSTest.php public <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> <span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testEntityCreationWithUUIDGenerator</span></span></span></span>() { <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span> = new LessonId( (string) \Rhumsaa\Uuid\Uuid::uuid1() ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;dispatch( new BookLesson(<span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>, <span class="hljs-string"><span class="hljs-string">"bob"</span></span>) ); <span class="hljs-variable"><span class="hljs-variable">$this</span></span>-&gt;assertInstanceOf( Lesson::class, Lesson::find( (string) <span class="hljs-variable"><span class="hljs-variable">$lessonId</span></span>) ); }</code> </pre><br> ç°åœ¨ï¼Œæ–°é¡¹ç›®å¼€å‘äººå‘˜å¯ä»¥æŸ¥çœ‹ä»£ç ï¼Œè¯·å‚é˜…<code>App\School\ReadModels</code> ï¼Œå…¶ä¸­åŒ…å«ä¸€ç»„<code>App\School\ReadModels</code>æ¨¡å‹ï¼Œå¹¶ä½¿ç”¨è¿™äº›æ¨¡å‹å°†æ›´æ”¹å†™å…¥è¯¾ç¨‹è¡¨ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡åˆ›å»ºä¸€ä¸ª<code>ImmutableModel</code>ç±»æ¥é˜²æ­¢è¿™ç§æƒ…å†µï¼Œè¯¥ç±»å¯ä»¥æ‰©å±•Eloquent Modelç±»å¹¶è¦†ç›–<code>app/CQRS/ReadModelImmutableModel.php</code>çš„saveæ–¹æ³•ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN461899/">https://habr.com/ru/post/zh-CN461899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN461885/index.html">EDSæ˜¯å¦ä¸€ç§æ¬ºè¯ˆ</a></li>
<li><a href="../zh-CN461887/index.html">è¿›å…¥èˆªç©ºç½‘ç¬¬2é›†ï¼šæ— äººæœº</a></li>
<li><a href="../zh-CN461891/index.html">æˆ‘ä»¬å¦‚ä½•ä½¿ç”¨ManageIQåœ¨é“¶è¡ŒåŸºç¡€è®¾æ–½ä¸­ç»“è¯†æœ‹å‹</a></li>
<li><a href="../zh-CN461895/index.html">è¾¹èµ°è¾¹å­¦-åœ¨ç¬¬ä¸€å±Šæ¬§æ´²å•†ä¸šåˆ†ææ—¥æˆ‘ä»¬å¦‚ä½•å¼€è½¦</a></li>
<li><a href="../zh-CN461897/index.html">æˆ‘ä»¬å¦‚ä½•ä¿æŒLamodaåº”ç”¨ç¨‹åºçš„ç¨³å®šæ€§</a></li>
<li><a href="../zh-CN461901/index.html">ä¸‰å¹´çš„è‡ªåŠ¨æµ‹è¯•ï¼šå¦‚ä½•æé«˜é€Ÿåº¦ï¼Œè€Œä¸ä»…ä»…æ˜¯</a></li>
<li><a href="../zh-CN461903/index.html">ç¥ç§˜å¯¹æ‰‹ï¼šæ¨¡ç³Šå€Ÿç”¨</a></li>
<li><a href="../zh-CN461905/index.html">äº•å­—æ¸¸æˆï¼Œç¬¬7éƒ¨åˆ†ï¼špytestå’ŒTravis CI</a></li>
<li><a href="../zh-CN461907/index.html">å…¨å‘¨æœŸå·¥ä½œå®¤ä¸­çš„äº§å“åˆ†æ</a></li>
<li><a href="../zh-CN461913/index.html">ç”µå­å•†åŠ¡ä¸­çš„ç§»åŠ¨å¯ç”¨æ€§ï¼šä¿„ç½—æ–¯TOP-20åœ¨çº¿å•†åº—çš„åˆ†æ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>