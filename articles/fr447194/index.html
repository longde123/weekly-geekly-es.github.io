<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüè´ ü§∞üèº üõåüèª Fonctionnalit√©s de rendu dans Metro: Exodus c raytracing üå®Ô∏è üëø üçë</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pr√©face 
 Apr√®s la sortie du dernier jeu de la s√©rie Metro, j'ai pass√© plusieurs heures √† √©tudier son travail interne et j'ai d√©cid√© de partager quelq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fonctionnalit√©s de rendu dans Metro: Exodus c raytracing</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447194/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b6c/122/9f2/b6c1229f21aaaefc416b180a41759690.jpg" alt="image"></div><br><h3>  Pr√©face </h3><br>  Apr√®s la sortie du dernier jeu de la s√©rie Metro, j'ai pass√© plusieurs heures √† √©tudier son travail interne et j'ai d√©cid√© de partager quelque chose qui pourrait sembler int√©ressant d'un point de vue technologique.  Je ne proc√©derai pas √† une analyse d√©taill√©e ni √† l'√©tude du code d√©mont√© des shaders, mais je montrerai les d√©cisions de haut niveau prises par les d√©veloppeurs en cours de cr√©ation du jeu. <br><br>  Pour le moment, les d√©veloppeurs n'ont pas encore parl√© des techniques de rendu utilis√©es dans le jeu.  La seule source officielle d'informations est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noreferrer noopener">rapport GDC</a> , que l'on ne trouve nulle part ailleurs sur Internet.  Et c'est ennuyeux, car le jeu fonctionne sur un moteur propri√©taire tr√®s int√©ressant qui a √©volu√© par rapport aux jeux pr√©c√©dents de la s√©rie Metro.  C'est l'un des premiers jeux √† utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DXR</a> . <br><br>  Remarque: cet article n'est pas une description compl√®te et j'y reviendrai si je trouve quelque chose qui m√©rite d'√™tre ajout√©.  Peut-√™tre que j'ai rat√© quelque chose, car certains aspects n'apparaissent que dans les prochaines √©tapes du jeu, ou je viens de regarder les d√©tails. <br><br><h3>  Premiers pas </h3><br>  Il m'a fallu plusieurs jours pour trouver un environnement capable de travailler avec ce jeu.  Apr√®s avoir test√© plusieurs versions de RenderDoc et PIX, j'ai d√©cid√© d'√©tudier les r√©sultats du lancer de rayons √† l'aide de Nvidia NSight.  Je voulais apprendre le rendu sans lancer de rayons, mais NSight m'a √©galement permis d'explorer les d√©tails de cette fonctionnalit√©, j'ai donc d√©cid√© de la laisser activ√©e.  Pour le reste du rendu, PIX est un bon ajustement.  Des captures d'√©cran ont √©t√© prises √† l'aide des deux applications. <br><a name="habracut"></a><br>  NSight a un inconv√©nient - il ne prend pas en charge l'enregistrement de la capture dans un fichier, donc je ne pouvais pas revenir aux images que j'√©tudiais. <br><br>  Au tout d√©but de mon travail, j'ai √©galement rencontr√© un autre probl√®me qui n'avait rien √† voir avec les applications de d√©bogage d'images: les fonctions de lancer de rayons n√©cessitaient l'installation de la derni√®re mise √† jour de Windows, mais le jeu leur permettait d'√™tre incluses dans les options sans installer la mise √† jour.  Dans ce cas, l'inclusion de fonctions a provoqu√© un plantage du jeu au d√©marrage.  L'exp√©rience GeForce n'a √©galement rien dit sur la n√©cessit√© de la bonne version de Windows pour activer ces fonctionnalit√©s.  Ce probl√®me doit √™tre r√©solu des deux c√¥t√©s. <br><br>  Par souci d'exhaustivit√©, j'ai fait des captures √† partir d'un jeu fonctionnant avec le maximum de param√®tres possibles, mais sans DLSS. <br><br><h3>  Analyse de trame </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/541/f12/e34/541f12e34559d73faa7eb743915e5cdd.png"></div><br>  <i>Cadre fini</i> <br><br>  Une br√®ve analyse du rendu montre un ensemble de fonctions assez standard, √† l'exception de l'illumination globale effectu√©e par lancer de rayons (GI raytrac√©). <br><br>  Avant de rendre l'image, l'√©chelle de l'image pr√©c√©dente est r√©duite dans la file d'attente de calcul et la luminosit√© moyenne est calcul√©e. <br><br>  La file d'attente graphique commence par le rendu des particules de distorsion (gouttelettes sur la cam√©ra), qui sont appliqu√©es au stade du post-traitement.  Ensuite, un rapide passage pr√©liminaire des profondeurs cr√©e une partie des profondeurs avant le Gbuffer;  on dirait que √ßa ne fait que soulager. <br><br>  La passe GBuffer remplit 4 cibles de rendu selon le diagramme ci-dessous et termine √©galement le remplissage du tampon de profondeur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a67/9ef/332/a679ef3320584af81cc4d3c6970fecd1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/97b/c7d/d77/97bc7dd7753e655aec4a8279851e78be.png"></div><br>  <i>1. Cible au format RGBA8 avec alb√©do et, √©ventuellement, occlusion ambiante dans le canal alpha;</i>  <i>Sur certaines surfaces, il semble tr√®s sombre.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ff/a5f/972/8ffa5f972989ecb5104c92cf1e56ddc0.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/580/93a/6e158093ac061f9c993fc5d954d3a383.png"></div><br>  <i>2. Cible au format RGB10A2 avec des normales et, √©ventuellement, un masque de diffusion souterrain dans le canal alpha.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aed/cab/600/aedcab600ed86cab9d6fff32d005365b.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9e/7e8/64e/d9e7e864ecc5794d64a9f0923153f673.png"></div><br>  <i>3. Cible au format RGBA8 avec d'autres param√®tres de mat√©riau, probablement la m√©tallit√© et la rugosit√© du canal alpha.</i>  <i>Curieusement, les canaux RVB dans ce cas contiennent exactement les m√™mes donn√©es.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ae/aaf/aa7/2aeaafaa75ea48daa6c9671ef02024e4.png"></div><br>  <i>4. Cible au format RG16F avec des vecteurs de mouvement 2D.</i> <br><br>  Une fois les profondeurs compl√®tement remplies, un tampon de profondeur lin√©aire est construit et son √©chelle diminue.  Tout cela se fait dans la file d'attente de calcul.  Dans la m√™me file d'attente, le tampon est rempli de quelque chose de similaire √† l'√©clairage directionnel sans utiliser d'ombres. <br><br>  Dans la file d'attente graphique, le GPU trace les rayons de l'illumination globale, mais j'en parlerai plus en d√©tail ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/205/368/6b1/2053686b1cb719229dc0ccce1540e5c1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/879/607/0ab/8796070abae27e9695fb82d6f5789375.png"></div><br>  La file d'attente de calcul calcule l'occlusion ambiante, les r√©flexions et quelque chose de similaire √† la reconnaissance des contours. <br><br>  Dans la file d'attente graphique, une carte d'ombre √† quatre √©tapes est rendue dans une carte de profondeur 32 bits de taille 6k * 6k.  Plus d'informations ci-dessous.  Apr√®s avoir termin√© la carte des ombres dirig√©es, la r√©solution de la troisi√®me cascade pour des raisons inconnues diminue √† 768 * 768. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a85/203/3e2/a852033e230487f7be913e94ee87a7fa.png"></div><br>  Au milieu du processus de rendu des ombres, il y a un moment curieux: l'atlas des imposteurs est compl√©t√© par certains objets avant de restituer les ombres locales √† partir de l'√©clairage (√† propos des imposteurs qui peuvent √™tre trouv√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ).  Les tampons d'imposteur et les tampons d'ombre d'√©clairage locaux sont √©galement des textures 6k * 6k. <br><br>  Une fois toutes les ombres termin√©es, le calcul de l'√©clairage commence.  Cette partie du rendu est plut√¥t incompr√©hensible, car il existe de nombreux rendus qui effectuent des actions myst√©rieuses et n√©cessitent donc une √©tude suppl√©mentaire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e07/838/016/e078380165142b63cce7e340155e4aef.png"></div><br>  Le rendu de la sc√®ne se termine avec des objets √©clair√©s de face (yeux, particules).  Les effets visuels sont rendus dans un tampon √† demi-r√©solution, apr√®s quoi ils sont compos√©s avec des objets opaques √† l'aide du zoom. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d95/88c/66e/d9588c66ecb2dbd09b0386fc481771c1.png"></div><br>  L'image finale est obtenue par la correction tonale et le calcul de la floraison (diminuez puis augmentez la r√©solution de l'image avec la correction tonale).  Enfin, l'interface utilisateur est rendue dans un tampon s√©par√© et, avec le compositing de floraison, est superpos√©e au-dessus de la sc√®ne. <br><br>  Je n'ai pas trouv√© la partie dans laquelle le lissage est effectu√©, je vais donc le laisser pour plus tard. <br><br><h3>  Tra√ßage global des rayons lumineux </h3><br>  Quelques informations sur l'√©clairage global r√©alis√© par GI raytraced.  Cette structure acc√©l√©ratrice couvre une grande partie du monde du jeu, probablement plusieurs centaines de m√®tres, tout en maintenant des d√©tails tr√®s √©lev√©s partout.  Il semble √™tre diffus√© en quelque sorte.  La sc√®ne de la structure acc√©l√©r√©e ne co√Øncide pas avec la sc√®ne tram√©e, par exemple, les b√¢timents de l'image ci-dessous ne sont pas visibles sous la forme tram√©e. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e98/f99/6d9/e98f996d9c2ad589d81fb6c5abac1208.png"></div><br>  <i>Vue de dessus</i> <br><br>  Ici, nous pouvons voir quatre tuiles entourant la position du joueur.  Le manque de g√©om√©trie test√© sur le canal alpha est √©galement apparent.  Les arbres ont des troncs, mais pas de feuillage, pas d'herbe, pas de buissons. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/500/53a/089/50053a0898f262725ade46d2b5dadb88.png"></div><br>  <i>Fermer la vue</i> <br><br>  En vue rapproch√©e, les d√©tails et la densit√© des objets sont mieux visibles.  Chaque objet d'une couleur diff√©rente a sa propre structure acc√©l√©ratrice du niveau inf√©rieur.  Seulement sur cette photo, il y en a plusieurs centaines. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83e/5e8/dff/83e5e8dfff1709a0d38b1f4c5d012282.png"></div><br>  <i>Objets du joueur sous le pied</i> <br><br>  Fait int√©ressant, les objets du joueur font √©galement partie de la structure d'acc√©l√©ration, mais pour une raison quelconque, ils sont situ√©s sous ses pieds. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/969/c2b/203/969c2b203e8abecbd7718e061db99984.png"></div><br>  <i>Peau cass√©e?</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/366/620/78d/36662078d0930dfb66fb3bf1d928f022.png"></div><br>  <i>Peau cass√©e √† nouveau?</i> <br><br>  Certains des objets avec √©corch√© semblent cass√©s dans la structure acc√©l√©r√©e.  L‚Äôun des probl√®mes observ√©s est l‚Äô√©tirement de la maille (sur les jambes de l‚Äôenfant).  Un autre probl√®me conduit au fait que diff√©rentes parties du personnage avec skinning sont dans des positions diff√©rentes.  Il n'y a pas d'√©tirement, mais les pi√®ces sont s√©par√©es les unes des autres.  Il semble que rien de tout cela ne soit visible dans l'√©clairage global de lancer de rayons, ou du moins je n'ai pas pu le remarquer dans le jeu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/647/c7c/c2b/647c7cc2beab467af7223ed97f80fa08.png"></div><br>  <i>Un grand nombre d'objets</i> <br><br>  Sur un plan plus g√©n√©ral, vous pouvez voir le nombre d'objets diff√©rents dans la structure acc√©l√©ratrice.  La plupart d'entre eux ne contribueront pas r√©ellement aux r√©sultats des calculs de l'illumination globale.  On voit √©galement ici qu'il n'y a pas de sch√©ma LOD.  Tous les objets sont ajout√©s avec tous les d√©tails.  Il serait int√©ressant de savoir si cela a un effet sur le lancer de rayons (je suppose que oui). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/11b/0ec/64f11b0ec3d0882a84503875c5a1cb20.png"></div><br>  <i>LOD ultra-√©lev√©, chaque √©chelle et commutateur enti√®rement mod√©lis√©s</i> <br><br>  Une autre capture d'√©cran montre un √©norme d√©tail d'objets, m√™me loin du lecteur.  Chaque interrupteur et chaque √©chelle de cette image sont clairement lisibles m√™me sans textures.  L'endroit o√π j'ai d√©plac√© l'appareil photo pour prendre cette capture d'√©cran est situ√© √† des dizaines de m√®tres du lecteur et l'√©limination de ces d√©tails n'aurait pas d√©t√©rior√© la qualit√© de l'image.  La mise √† jour de la structure d'acc√©l√©ration √† l'aide de LOD serait peut-√™tre trop co√ªteuse, mais il existe une forte probabilit√© que cette mise √† jour puisse √™tre effectu√©e de mani√®re asynchrone.  Ce point m√©rite certainement d'√™tre explor√© plus en d√©tail. <br><br><h3>  Rendu des ombres directionnelles </h3><br>  La partie principale du rendu des ombres est simple et ne n√©cessite pas de mention sp√©ciale, mais il y a des points int√©ressants ici. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/016/0ea/d160160ea9d4dc571c97440f77d103a0.png"></div><br>  <i>Mailles pour lesquelles la projection d'ombres est peu probable</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/369/857/cb1/369857cb17bf6baeaae52295930b4ac5.png"></div><br>  <i>D'√©normes d√©tails dans les cartes fant√¥mes</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e0/708/9ba/0e07089ba7b63f9c055a95a8ed783f09.png"></div><br>  <i>Maillages qui semblent utiliser le mauvais tampon d'index</i> <br><br>  Il semble que, comme l'acc√©l√©ration des structures, le rendu des ombres comprend absolument tout.  Il y a des objets qui ne contribuent presque pas √† la texture de l'ombre, mais ils sont toujours rendus.  Je me demande si cela se produit √† cause d'une autorisation, ou n'y a-t-il aucun moyen facile dans le moteur de les exclure? <br><br>  Il y a des objets qui sont difficiles √† remarquer m√™me avec des ombres dans l'espace d'√©cran.  Leur rendu ne prend pas beaucoup de temps, mais il serait int√©ressant de voir s‚Äôils peuvent √™tre supprim√©s pour gagner un peu de temps. <br><br>  Lors de l'examen du maillage, il semble que certains des maillages rendus dans la carte d'ombre ont des tampons d'index cass√©s, mais apr√®s le vertex shader, ils semblent corrects (les r√©sultats sont les m√™mes dans PIX et NSight).  C'est le meilleur exemple que j'ai r√©ussi √† trouver, mais il est loin d'√™tre le seul.  Peut-√™tre que c'est une sorte de position d'emballage sp√©ciale? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/079/80b/5d907980beab8411086ae95a3cd1069e.png"></div><br>  <i>Les mailles semblent avoir une peau √©corch√©e</i> <br><br>  Le d√©pouillement semble poser des probl√®mes non seulement dans l'acc√©l√©ration des structures.  Fait int√©ressant, cela ne conduit pas √† des artefacts visibles √† l'√©cran. <br><br><h2>  2e partie </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png" alt="image"></div><br><h3>  Amendement mineur </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/177/37b/efe17737bab902e3b3d1e4ae2a29edbf.png"></div><br>  Dans la partie pr√©c√©dente, j'ai √©crit que la troisi√®me cible de rendu du tampon GBuffer contient probablement de la m√©tallit√©, mais il semble qu'elle contient en fait une couleur sp√©culaire.  Au d√©but, je n'ai vu aucune couleur et je n'ai pas compris pourquoi les trois canaux RVB contiennent les m√™mes donn√©es, mais c'√©tait probablement parce qu'il n'y avait pas de reflets de couleur dans la sc√®ne.  Pour cette arme, le tampon contient beaucoup plus de couleurs diff√©rentes. <br><br>  J'ai √©galement oubli√© d'ajouter ma texture pr√©f√©r√©e, que j'ai trouv√©e en recherchant le rendu du jeu.  Cela vaut vraiment la peine d'√™tre mentionn√© car il d√©montre la nature chaotique du d√©veloppement de jeux quand il n'est pas toujours possible de le nettoyer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bb/5b4/288/7bb5b428878a0be20dbe80d599256d80.png"></div><br>  <i>"Am√©liorez-moi!"</i> <br><br><h3>  Composite de transparence et lissage </h3><br>  En essayant de comprendre comment la r√©solution du tampon de transparence demi-taille augmente et comment le jeu effectue l'anticr√©nelage, j'ai remarqu√© quelque chose d'int√©ressant.  J'avais besoin d'une sc√®ne o√π il y avait beaucoup plus de contraste pour que ce qui se passait soit clairement visible.  Heureusement, j'ai r√©ussi √† capturer une image dans laquelle l'arme du joueur se d√©place l√©g√®rement entre les images. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0c/974/612/a0c9746122e45a19786bdf51521015a9.png"></div><br>  <i>Avant de rendre la transparence</i> <br><br>  Il semble qu'avant de composer le tampon de transparence, le tampon contient d√©j√† une image enti√®rement rendue, et puisqu'il n'y a pas de bords nets dans ce cadre, il est logique de supposer que ce sont les donn√©es du cadre pr√©c√©dent. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c56/bd5/b89/c56bd5b8938a315f97def63dc7b8b214.png"></div><br>  <i>Apr√®s composition de la transparence de l'image actuelle</i> <br><br>  Lors de l'ajout de transparence √† l'image actuelle, nous pouvons remarquer des bords cass√©s individuels.  Cela s'est produit parce que l'arme s'est l√©g√®rement d√©plac√©e vers la droite.  Certains nuages ‚Äã‚Äãsont rendus transparents, mais ils sont coup√©s √† l'horizon (qui est opaque), donc la composition ne change pas le fond, mais rend d√©j√† le maillage de l'arme de l'image pr√©c√©dente en utilisant le tampon de profondeur de l'image actuelle. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/7a1/e93/64f7a1e9340dfe180e4807cf7c4da5be.png"></div><br>  <i>Apr√®s avoir ajout√© l'opacit√© √† l'image actuelle</i> <br><br>  Apr√®s plusieurs appels de dessin, la composition et les maillages opaques sont effectu√©s.  Il ne semble pas y avoir de raison particuli√®re de proc√©der ainsi dans cet ordre.  Il est logique de composer le tampon de transparence dans les donn√©es des objets opaques de la trame courante, mais cela ne se produit pas, et il serait int√©ressant de savoir pourquoi. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/963/bce/f23/963bcef23544573444acf29bf7a83a87.png"></div><br>  <i>Apr√®s TAA</i> <br><br>  Apr√®s avoir termin√© le cadre complet, le passage TAA (lissage temporel) lisse les bords.  J'√©tais d√©j√† int√©ress√© par cela auparavant, car je ne voyais pas o√π se d√©roulait le lissage.  Mais j'ai saut√© cela parce qu'imm√©diatement apr√®s cet appel de tirage, le sous-√©chantillonnage pour la passe de floraison commence et je manque cet appel de tirage. <br><br><h3>  √âblouissement de l'objectif </h3><br>  Habituellement, je ne veux pas analyser les effets individuels, mais il existe de nombreuses fa√ßons d'impl√©menter la lumi√®re parasite, donc j'√©tais curieux de savoir quels d√©veloppeurs avaient choisi. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png"></div><br>  <i>√âblouissement des lentilles en compositing pr√™t √† l'emploi</i> <br><br>  Dans la plupart des cas, la lumi√®re parasite est √† peine perceptible, mais c'est un bel effet.  Il est difficile de montrer dans la capture d'√©cran, donc je n'y mettrai pas beaucoup d'efforts. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a32/554/efc/a32554efc67afb79416b6ce2fe337148.png"></div><br>  <i>√âblouissement de la lentille dans le tampon de floraison</i> <br><br>  Apr√®s la recherche, j'ai trouv√© un appel de tirage qui ajoute cet effet, et il s'est av√©r√© que c'√©tait un appel apr√®s la derni√®re √©tape de l'augmentation de la r√©solution de floraison.  Dans ce tampon, l'effet est beaucoup plus visible. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a3/f38/078/8a3f38078dc5d6c6451030ee3eb5c53b.png"></div><br>  <i>Flare g√©om√©trique</i> <br><br>  Si vous regardez la g√©om√©trie, la lumi√®re parasite est assez simple.  Au moins 6 quadrangles sont impliqu√©s dans la cr√©ation du r√©sultat final √† l'√©cran, mais aucune s√©rie de quadrangles plus petits ne se rapproche de la position du soleil.  Nous pouvons conclure qu'il s'agit d'une solution assez standard, bien que certains d√©veloppeurs rendent la lumi√®re parasite directement dans la sc√®ne cible de rendu, tandis que d'autres calculent l'effet en tant que post-traitement. <br><br><h3>  Rendu du terrain </h3><br>  Dans tous les jeux en monde ouvert, l'une des difficult√©s les plus int√©ressantes est le rendu du terrain.  J'ai d√©cid√© qu'il pourrait sembler int√©ressant d'√©tudier cet aspect, mais, franchement, un peu d√©√ßu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/125/7a6/89b/1257a689b93f0f7a0239b5514ce911af.png"></div><br>  √Ä premi√®re vue, un fragment du relief donne l'impression qu'une sorte de pavage est en cours.  La fa√ßon dont le relief est d√©form√© pendant le mouvement rend logique de supposer qu'il y a un d√©placement suppl√©mentaire.  De plus, sur PC, le jeu utilise activement la tessellation, il serait donc logique de l'utiliser en relief. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99d/214/a4d/99d214a4dc8c15862b7e385edda0c25e.png"></div><br>  Peut-√™tre que les mauvais param√®tres ont √©t√© d√©finis, mais le jeu rend tous les fragments du relief sans pavage.  Pour chaque fragment du relief, elle utilise cette grille uniforme 32 * 32.  Il n'y a pas non plus de LOD. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/744/aa8/4bc/744aa84bce83c87e8c2a49338f7c8c13.png"></div><br>  En regardant un fragment du relief apr√®s le vertex shader, vous pouvez voir que la plupart des paires de sommets ont fusionn√© pour former une grille 16 * 16 presque parfaite, √† l'exception de certains endroits qui n√©cessitent plus de pr√©cision (probablement en raison de la courbure du relief).  La d√©formation mentionn√©e ci-dessus r√©sulte probablement de la lecture des textures de mip de la carte d'√©l√©vation du relief lorsque le relief est loin de la cam√©ra. <br><br><h3>  Ray Tracking Tricks </h3><br>  Et maintenant ce que tout le monde attendait. <br><br><h4>  Streaming de donn√©es </h4><br>  L'un des aspects les plus int√©ressants de toute impl√©mentation DXR pour le moment est la fa√ßon dont vous travaillez avec les donn√©es.  La chose la plus importante est de savoir comment les donn√©es sont charg√©es dans les structures acc√©l√©ratrices et comment elles sont mises √† jour.  Pour tester cela, j'ai pris deux captures et compar√© les structures acc√©l√©ratrices dans NSight. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3fc/7b7/0d2/3fc7b70d22199c5be429417fd6ed92a9.png"></div><br>  <i>Le joueur est √† l'int√©rieur du navire</i> <br><br>  Lors de la premi√®re capture, je me tenais √† l'int√©rieur d'un vaisseau cass√©, visible au milieu de cette image.  Seuls les objets les plus proches sont charg√©s, √† l'exception des gros rochers au bord de la carte. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc4/e41/2fa/dc4e412fa02b74f7ca4384a53e1b8100.png"></div><br>  <i>Le joueur s'est d√©plac√© dans le coin sup√©rieur gauche de cette image.</i> <br><br>  Dans la deuxi√®me capture, je me suis √©loign√© du bord de la carte et je me suis rapproch√© du bord sup√©rieur gauche de l'image.  Le navire et tout ce qui l'entoure est toujours charg√©, mais de nouveaux objets ont √©galement √©t√© charg√©s.  Fait int√©ressant, je ne peux d√©finir aucune structure de tuile.  Les objets peuvent √™tre charg√©s / retir√©s de la structure acc√©l√©ratrice en fonction de la distance et de la visibilit√© (peut-√™tre en limitant le parall√©logramme?).  De plus, le bord sup√©rieur droit semble plus d√©taill√©, bien qu'il s'en soit √©loign√©.  Il serait int√©ressant d'en savoir plus √† ce sujet. <br><br><h4>  Le soulagement et ce qu'il y a sous </h4><br>  Plusieurs aspects de l'impl√©mentation DXR dans Metro: Exodus concernant le terrain peuvent √™tre mentionn√©s. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e97/386/8bf/e973868bf7b0bd40cfc58c0d94678acf.png"></div><br>  Tout d'abord, il est int√©ressant de noter que les structures acc√©l√©ratrices ne contiennent pas de maillage en relief (√† l'exception de cas particuliers).  Ces monstres courent r√©ellement dans le jeu sur le terrain, mais √† en juger par les donn√©es de NSight, vous pourriez penser qu'ils volent.  Cela nous pose une question int√©ressante: la mise en ≈ìuvre de l'√©clairage global peut-elle en quelque sorte prendre en compte le relief (√©ventuellement √† l'aide d'une carte des hauteurs et de mat√©riaux en relief) ou non. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7a/03e/860/a7a03e8601a37c6459eff55cc7dda39f.png"></div><br>  Le moment suivant, je n'aurais jamais remarqu√© si le soulagement √©tait en place.  En regardant le d√©but du niveau √† la structure acc√©l√©ratrice dans NSight, j'ai remarqu√© quelques mailles sous le relief. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/458/b77/ec3/458b77ec37a3db2b1d8ca0b3f1694dd8.png"></div><br>  Les artistes placent assez souvent, pour diverses raisons, des maillages de d√©bogage sous le niveau, mais ils sont g√©n√©ralement supprim√©s avant la sortie du jeu.  Dans ce cas, ces mailles ont non seulement surv√©cu jusqu'√† la lib√©ration, mais sont √©galement devenues une partie de la structure acc√©l√©ratrice. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/27d/64a/15d/27d64a15df609c55b8742d77637fca22.png"></div><br>  En plus de celles mentionn√©es ci-dessus, j'ai trouv√© d'autres mailles √©parpill√©es sous le relief.  Fondamentalement, ils ne valent pas beaucoup de mention, mais celui-ci √©tait tr√®s int√©ressant - c'est un personnage se tenant juste en dessous du point de d√©part du niveau.  Il a m√™me sa propre piscine. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/53f/5dd/66c/53f5dd66c2b959793151e3a59d1309a5.png"></div><br>  Enfin, le dernier √©l√©ment curieux de la structure acc√©l√©ratrice est les mailles unilat√©rales regardant vers l'ext√©rieur du niveau.  √Ä moins qu'ils ne soient consid√©r√©s comme bilat√©raux, il y a tr√®s peu de chances qu'ils contribuent √† l'image du jeu.  M√™me si les maillages sont bilat√©raux, ils sont si loin de la zone jouable qu'ils √©tirent probablement la structure acc√©l√©ratrice.  Il est int√©ressant de voir qu'ils ne sont pas filtr√©s.  Cette image montre √©galement l'un des cas particuliers de la "maille en relief" dans le coin inf√©rieur droit, entre le train et le b√¢timent. <br><br><h4>  Sans t√™te avec d√©pouillement </h4><br>  J'ai d√©j√† parl√© des probl√®mes de skinning des mailles, mais √† ce niveau j'ai remarqu√© autre chose. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d1/0dd/a8c/1d10dda8c75112713b51c32771bb8ecb.png"></div><br>  Tout d'abord, ce monstre montre les deux erreurs dans une image, que j'ai remarqu√©es ci-dessus.  Je me demande toujours ce qui les a caus√©s. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/523/265/dd7/523265dd72a9613800831592706bd510.png"></div><br>  J'ai √©galement remarqu√© que ces petites cr√©atures, comme les chauves-souris, n'ont pas de t√™te dans la structure acc√©l√©ratrice. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fd/1a9/801/6fd1a9801d440a719602ab30eb33a88e.png"></div><br>  Un autre exemple.  Remarquez le trou o√π la t√™te devrait √™tre.  Je n'ai pas vu un seul cas o√π la t√™te √©tait visible. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e7f/51e/741/e7f51e74194bf8cccf8e430e6ec8513d.png"></div><br>  Le m√™me genre de cr√©atures en mode rasterisation.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Notez que la t√™te est clairement visible. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebd/d67/2ea/ebdd672ea50f7717c4b66afeb20b4cf8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et voici le filaire de la t√™te. </font></font><br><br><h3>  En conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est tout pour aujourd'hui. </font><font style="vertical-align: inherit;">J'esp√®re que vous avez appr√©ci√© ce regard sur l'int√©rieur de Metro: Exodus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je continuerai d'explorer le rendu du jeu, mais je ne publierai pas de nouvelles parties de l'article √† moins de trouver des parties sp√©ciales qui seraient int√©ressantes pour les gens ou de trouver quelque chose qui m√©rite d'√™tre partag√©.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447194/">https://habr.com/ru/post/fr447194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447182/index.html">Syst√®mes d'exploitation: trois pi√®ces faciles. Partie 3: API de processus (traduction)</a></li>
<li><a href="../fr447184/index.html">Qu'est-ce que l'offre d'√©change initiale (IEO) et en quoi est-elle diff√©rente de l'ICO?</a></li>
<li><a href="../fr447186/index.html">Comment lancer un prototype ML en une journ√©e. Signaler Yandex.Taxi</a></li>
<li><a href="../fr447190/index.html">Pr√©dictions de math√©maticiens. Nous analysons les principales m√©thodes de d√©tection des anomalies</a></li>
<li><a href="../fr447192/index.html">Quel r√¥le la technologie peut-elle jouer dans l'art ancien du m√©lange d'√©pices?</a></li>
<li><a href="../fr447196/index.html">7. Check Point Getting Started R80.20. Contr√¥le d'acc√®s</a></li>
<li><a href="../fr447198/index.html">Mission lunaire "Bereshit": atterrissage-accident-chute sur la lune</a></li>
<li><a href="../fr447204/index.html">17 avril: Conf√©rence ouverte "Le chemin du d√©veloppeur du jeu: de l'id√©e au lancement" et une ludoth√®que √† la Higher School of Law</a></li>
<li><a href="../fr447208/index.html">SQA Days EU Review</a></li>
<li><a href="../fr447210/index.html">@Pythonetc compilation mars 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>