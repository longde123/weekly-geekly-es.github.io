<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👩🏾‍🏫 🤰🏼 🛌🏻 Fonctionnalités de rendu dans Metro: Exodus c raytracing 🌨️ 👿 🍑</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Préface 
 Après la sortie du dernier jeu de la série Metro, j'ai passé plusieurs heures à étudier son travail interne et j'ai décidé de partager quelq...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Fonctionnalités de rendu dans Metro: Exodus c raytracing</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/447194/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b6c/122/9f2/b6c1229f21aaaefc416b180a41759690.jpg" alt="image"></div><br><h3>  Préface </h3><br>  Après la sortie du dernier jeu de la série Metro, j'ai passé plusieurs heures à étudier son travail interne et j'ai décidé de partager quelque chose qui pourrait sembler intéressant d'un point de vue technologique.  Je ne procéderai pas à une analyse détaillée ni à l'étude du code démonté des shaders, mais je montrerai les décisions de haut niveau prises par les développeurs en cours de création du jeu. <br><br>  Pour le moment, les développeurs n'ont pas encore parlé des techniques de rendu utilisées dans le jeu.  La seule source officielle d'informations est le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="noreferrer noopener">rapport GDC</a> , que l'on ne trouve nulle part ailleurs sur Internet.  Et c'est ennuyeux, car le jeu fonctionne sur un moteur propriétaire très intéressant qui a évolué par rapport aux jeux précédents de la série Metro.  C'est l'un des premiers jeux à utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">DXR</a> . <br><br>  Remarque: cet article n'est pas une description complète et j'y reviendrai si je trouve quelque chose qui mérite d'être ajouté.  Peut-être que j'ai raté quelque chose, car certains aspects n'apparaissent que dans les prochaines étapes du jeu, ou je viens de regarder les détails. <br><br><h3>  Premiers pas </h3><br>  Il m'a fallu plusieurs jours pour trouver un environnement capable de travailler avec ce jeu.  Après avoir testé plusieurs versions de RenderDoc et PIX, j'ai décidé d'étudier les résultats du lancer de rayons à l'aide de Nvidia NSight.  Je voulais apprendre le rendu sans lancer de rayons, mais NSight m'a également permis d'explorer les détails de cette fonctionnalité, j'ai donc décidé de la laisser activée.  Pour le reste du rendu, PIX est un bon ajustement.  Des captures d'écran ont été prises à l'aide des deux applications. <br><a name="habracut"></a><br>  NSight a un inconvénient - il ne prend pas en charge l'enregistrement de la capture dans un fichier, donc je ne pouvais pas revenir aux images que j'étudiais. <br><br>  Au tout début de mon travail, j'ai également rencontré un autre problème qui n'avait rien à voir avec les applications de débogage d'images: les fonctions de lancer de rayons nécessitaient l'installation de la dernière mise à jour de Windows, mais le jeu leur permettait d'être incluses dans les options sans installer la mise à jour.  Dans ce cas, l'inclusion de fonctions a provoqué un plantage du jeu au démarrage.  L'expérience GeForce n'a également rien dit sur la nécessité de la bonne version de Windows pour activer ces fonctionnalités.  Ce problème doit être résolu des deux côtés. <br><br>  Par souci d'exhaustivité, j'ai fait des captures à partir d'un jeu fonctionnant avec le maximum de paramètres possibles, mais sans DLSS. <br><br><h3>  Analyse de trame </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/541/f12/e34/541f12e34559d73faa7eb743915e5cdd.png"></div><br>  <i>Cadre fini</i> <br><br>  Une brève analyse du rendu montre un ensemble de fonctions assez standard, à l'exception de l'illumination globale effectuée par lancer de rayons (GI raytracé). <br><br>  Avant de rendre l'image, l'échelle de l'image précédente est réduite dans la file d'attente de calcul et la luminosité moyenne est calculée. <br><br>  La file d'attente graphique commence par le rendu des particules de distorsion (gouttelettes sur la caméra), qui sont appliquées au stade du post-traitement.  Ensuite, un rapide passage préliminaire des profondeurs crée une partie des profondeurs avant le Gbuffer;  on dirait que ça ne fait que soulager. <br><br>  La passe GBuffer remplit 4 cibles de rendu selon le diagramme ci-dessous et termine également le remplissage du tampon de profondeur. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a67/9ef/332/a679ef3320584af81cc4d3c6970fecd1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/97b/c7d/d77/97bc7dd7753e655aec4a8279851e78be.png"></div><br>  <i>1. Cible au format RGBA8 avec albédo et, éventuellement, occlusion ambiante dans le canal alpha;</i>  <i>Sur certaines surfaces, il semble très sombre.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8ff/a5f/972/8ffa5f972989ecb5104c92cf1e56ddc0.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6e1/580/93a/6e158093ac061f9c993fc5d954d3a383.png"></div><br>  <i>2. Cible au format RGB10A2 avec des normales et, éventuellement, un masque de diffusion souterrain dans le canal alpha.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/aed/cab/600/aedcab600ed86cab9d6fff32d005365b.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9e/7e8/64e/d9e7e864ecc5794d64a9f0923153f673.png"></div><br>  <i>3. Cible au format RGBA8 avec d'autres paramètres de matériau, probablement la métallité et la rugosité du canal alpha.</i>  <i>Curieusement, les canaux RVB dans ce cas contiennent exactement les mêmes données.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ae/aaf/aa7/2aeaafaa75ea48daa6c9671ef02024e4.png"></div><br>  <i>4. Cible au format RG16F avec des vecteurs de mouvement 2D.</i> <br><br>  Une fois les profondeurs complètement remplies, un tampon de profondeur linéaire est construit et son échelle diminue.  Tout cela se fait dans la file d'attente de calcul.  Dans la même file d'attente, le tampon est rempli de quelque chose de similaire à l'éclairage directionnel sans utiliser d'ombres. <br><br>  Dans la file d'attente graphique, le GPU trace les rayons de l'illumination globale, mais j'en parlerai plus en détail ci-dessous. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/205/368/6b1/2053686b1cb719229dc0ccce1540e5c1.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/879/607/0ab/8796070abae27e9695fb82d6f5789375.png"></div><br>  La file d'attente de calcul calcule l'occlusion ambiante, les réflexions et quelque chose de similaire à la reconnaissance des contours. <br><br>  Dans la file d'attente graphique, une carte d'ombre à quatre étapes est rendue dans une carte de profondeur 32 bits de taille 6k * 6k.  Plus d'informations ci-dessous.  Après avoir terminé la carte des ombres dirigées, la résolution de la troisième cascade pour des raisons inconnues diminue à 768 * 768. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a85/203/3e2/a852033e230487f7be913e94ee87a7fa.png"></div><br>  Au milieu du processus de rendu des ombres, il y a un moment curieux: l'atlas des imposteurs est complété par certains objets avant de restituer les ombres locales à partir de l'éclairage (à propos des imposteurs qui peuvent être trouvés <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> ).  Les tampons d'imposteur et les tampons d'ombre d'éclairage locaux sont également des textures 6k * 6k. <br><br>  Une fois toutes les ombres terminées, le calcul de l'éclairage commence.  Cette partie du rendu est plutôt incompréhensible, car il existe de nombreux rendus qui effectuent des actions mystérieuses et nécessitent donc une étude supplémentaire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e07/838/016/e078380165142b63cce7e340155e4aef.png"></div><br>  Le rendu de la scène se termine avec des objets éclairés de face (yeux, particules).  Les effets visuels sont rendus dans un tampon à demi-résolution, après quoi ils sont composés avec des objets opaques à l'aide du zoom. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d95/88c/66e/d9588c66ecb2dbd09b0386fc481771c1.png"></div><br>  L'image finale est obtenue par la correction tonale et le calcul de la floraison (diminuez puis augmentez la résolution de l'image avec la correction tonale).  Enfin, l'interface utilisateur est rendue dans un tampon séparé et, avec le compositing de floraison, est superposée au-dessus de la scène. <br><br>  Je n'ai pas trouvé la partie dans laquelle le lissage est effectué, je vais donc le laisser pour plus tard. <br><br><h3>  Traçage global des rayons lumineux </h3><br>  Quelques informations sur l'éclairage global réalisé par GI raytraced.  Cette structure accélératrice couvre une grande partie du monde du jeu, probablement plusieurs centaines de mètres, tout en maintenant des détails très élevés partout.  Il semble être diffusé en quelque sorte.  La scène de la structure accélérée ne coïncide pas avec la scène tramée, par exemple, les bâtiments de l'image ci-dessous ne sont pas visibles sous la forme tramée. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e98/f99/6d9/e98f996d9c2ad589d81fb6c5abac1208.png"></div><br>  <i>Vue de dessus</i> <br><br>  Ici, nous pouvons voir quatre tuiles entourant la position du joueur.  Le manque de géométrie testé sur le canal alpha est également apparent.  Les arbres ont des troncs, mais pas de feuillage, pas d'herbe, pas de buissons. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/500/53a/089/50053a0898f262725ade46d2b5dadb88.png"></div><br>  <i>Fermer la vue</i> <br><br>  En vue rapprochée, les détails et la densité des objets sont mieux visibles.  Chaque objet d'une couleur différente a sa propre structure accélératrice du niveau inférieur.  Seulement sur cette photo, il y en a plusieurs centaines. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/83e/5e8/dff/83e5e8dfff1709a0d38b1f4c5d012282.png"></div><br>  <i>Objets du joueur sous le pied</i> <br><br>  Fait intéressant, les objets du joueur font également partie de la structure d'accélération, mais pour une raison quelconque, ils sont situés sous ses pieds. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/969/c2b/203/969c2b203e8abecbd7718e061db99984.png"></div><br>  <i>Peau cassée?</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/366/620/78d/36662078d0930dfb66fb3bf1d928f022.png"></div><br>  <i>Peau cassée à nouveau?</i> <br><br>  Certains des objets avec écorché semblent cassés dans la structure accélérée.  L’un des problèmes observés est l’étirement de la maille (sur les jambes de l’enfant).  Un autre problème conduit au fait que différentes parties du personnage avec skinning sont dans des positions différentes.  Il n'y a pas d'étirement, mais les pièces sont séparées les unes des autres.  Il semble que rien de tout cela ne soit visible dans l'éclairage global de lancer de rayons, ou du moins je n'ai pas pu le remarquer dans le jeu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/647/c7c/c2b/647c7cc2beab467af7223ed97f80fa08.png"></div><br>  <i>Un grand nombre d'objets</i> <br><br>  Sur un plan plus général, vous pouvez voir le nombre d'objets différents dans la structure accélératrice.  La plupart d'entre eux ne contribueront pas réellement aux résultats des calculs de l'illumination globale.  On voit également ici qu'il n'y a pas de schéma LOD.  Tous les objets sont ajoutés avec tous les détails.  Il serait intéressant de savoir si cela a un effet sur le lancer de rayons (je suppose que oui). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/11b/0ec/64f11b0ec3d0882a84503875c5a1cb20.png"></div><br>  <i>LOD ultra-élevé, chaque échelle et commutateur entièrement modélisés</i> <br><br>  Une autre capture d'écran montre un énorme détail d'objets, même loin du lecteur.  Chaque interrupteur et chaque échelle de cette image sont clairement lisibles même sans textures.  L'endroit où j'ai déplacé l'appareil photo pour prendre cette capture d'écran est situé à des dizaines de mètres du lecteur et l'élimination de ces détails n'aurait pas détérioré la qualité de l'image.  La mise à jour de la structure d'accélération à l'aide de LOD serait peut-être trop coûteuse, mais il existe une forte probabilité que cette mise à jour puisse être effectuée de manière asynchrone.  Ce point mérite certainement d'être exploré plus en détail. <br><br><h3>  Rendu des ombres directionnelles </h3><br>  La partie principale du rendu des ombres est simple et ne nécessite pas de mention spéciale, mais il y a des points intéressants ici. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d16/016/0ea/d160160ea9d4dc571c97440f77d103a0.png"></div><br>  <i>Mailles pour lesquelles la projection d'ombres est peu probable</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/369/857/cb1/369857cb17bf6baeaae52295930b4ac5.png"></div><br>  <i>D'énormes détails dans les cartes fantômes</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0e0/708/9ba/0e07089ba7b63f9c055a95a8ed783f09.png"></div><br>  <i>Maillages qui semblent utiliser le mauvais tampon d'index</i> <br><br>  Il semble que, comme l'accélération des structures, le rendu des ombres comprend absolument tout.  Il y a des objets qui ne contribuent presque pas à la texture de l'ombre, mais ils sont toujours rendus.  Je me demande si cela se produit à cause d'une autorisation, ou n'y a-t-il aucun moyen facile dans le moteur de les exclure? <br><br>  Il y a des objets qui sont difficiles à remarquer même avec des ombres dans l'espace d'écran.  Leur rendu ne prend pas beaucoup de temps, mais il serait intéressant de voir s’ils peuvent être supprimés pour gagner un peu de temps. <br><br>  Lors de l'examen du maillage, il semble que certains des maillages rendus dans la carte d'ombre ont des tampons d'index cassés, mais après le vertex shader, ils semblent corrects (les résultats sont les mêmes dans PIX et NSight).  C'est le meilleur exemple que j'ai réussi à trouver, mais il est loin d'être le seul.  Peut-être que c'est une sorte de position d'emballage spéciale? <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5d9/079/80b/5d907980beab8411086ae95a3cd1069e.png"></div><br>  <i>Les mailles semblent avoir une peau écorchée</i> <br><br>  Le dépouillement semble poser des problèmes non seulement dans l'accélération des structures.  Fait intéressant, cela ne conduit pas à des artefacts visibles à l'écran. <br><br><h2>  2e partie </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png" alt="image"></div><br><h3>  Amendement mineur </h3><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/efe/177/37b/efe17737bab902e3b3d1e4ae2a29edbf.png"></div><br>  Dans la partie précédente, j'ai écrit que la troisième cible de rendu du tampon GBuffer contient probablement de la métallité, mais il semble qu'elle contient en fait une couleur spéculaire.  Au début, je n'ai vu aucune couleur et je n'ai pas compris pourquoi les trois canaux RVB contiennent les mêmes données, mais c'était probablement parce qu'il n'y avait pas de reflets de couleur dans la scène.  Pour cette arme, le tampon contient beaucoup plus de couleurs différentes. <br><br>  J'ai également oublié d'ajouter ma texture préférée, que j'ai trouvée en recherchant le rendu du jeu.  Cela vaut vraiment la peine d'être mentionné car il démontre la nature chaotique du développement de jeux quand il n'est pas toujours possible de le nettoyer. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7bb/5b4/288/7bb5b428878a0be20dbe80d599256d80.png"></div><br>  <i>"Améliorez-moi!"</i> <br><br><h3>  Composite de transparence et lissage </h3><br>  En essayant de comprendre comment la résolution du tampon de transparence demi-taille augmente et comment le jeu effectue l'anticrénelage, j'ai remarqué quelque chose d'intéressant.  J'avais besoin d'une scène où il y avait beaucoup plus de contraste pour que ce qui se passait soit clairement visible.  Heureusement, j'ai réussi à capturer une image dans laquelle l'arme du joueur se déplace légèrement entre les images. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a0c/974/612/a0c9746122e45a19786bdf51521015a9.png"></div><br>  <i>Avant de rendre la transparence</i> <br><br>  Il semble qu'avant de composer le tampon de transparence, le tampon contient déjà une image entièrement rendue, et puisqu'il n'y a pas de bords nets dans ce cadre, il est logique de supposer que ce sont les données du cadre précédent. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c56/bd5/b89/c56bd5b8938a315f97def63dc7b8b214.png"></div><br>  <i>Après composition de la transparence de l'image actuelle</i> <br><br>  Lors de l'ajout de transparence à l'image actuelle, nous pouvons remarquer des bords cassés individuels.  Cela s'est produit parce que l'arme s'est légèrement déplacée vers la droite.  Certains nuages ​​sont rendus transparents, mais ils sont coupés à l'horizon (qui est opaque), donc la composition ne change pas le fond, mais rend déjà le maillage de l'arme de l'image précédente en utilisant le tampon de profondeur de l'image actuelle. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/64f/7a1/e93/64f7a1e9340dfe180e4807cf7c4da5be.png"></div><br>  <i>Après avoir ajouté l'opacité à l'image actuelle</i> <br><br>  Après plusieurs appels de dessin, la composition et les maillages opaques sont effectués.  Il ne semble pas y avoir de raison particulière de procéder ainsi dans cet ordre.  Il est logique de composer le tampon de transparence dans les données des objets opaques de la trame courante, mais cela ne se produit pas, et il serait intéressant de savoir pourquoi. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/963/bce/f23/963bcef23544573444acf29bf7a83a87.png"></div><br>  <i>Après TAA</i> <br><br>  Après avoir terminé le cadre complet, le passage TAA (lissage temporel) lisse les bords.  J'étais déjà intéressé par cela auparavant, car je ne voyais pas où se déroulait le lissage.  Mais j'ai sauté cela parce qu'immédiatement après cet appel de tirage, le sous-échantillonnage pour la passe de floraison commence et je manque cet appel de tirage. <br><br><h3>  Éblouissement de l'objectif </h3><br>  Habituellement, je ne veux pas analyser les effets individuels, mais il existe de nombreuses façons d'implémenter la lumière parasite, donc j'étais curieux de savoir quels développeurs avaient choisi. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/787/d1c/c6d/787d1cc6d642436ce05542678e27b807.png"></div><br>  <i>Éblouissement des lentilles en compositing prêt à l'emploi</i> <br><br>  Dans la plupart des cas, la lumière parasite est à peine perceptible, mais c'est un bel effet.  Il est difficile de montrer dans la capture d'écran, donc je n'y mettrai pas beaucoup d'efforts. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a32/554/efc/a32554efc67afb79416b6ce2fe337148.png"></div><br>  <i>Éblouissement de la lentille dans le tampon de floraison</i> <br><br>  Après la recherche, j'ai trouvé un appel de tirage qui ajoute cet effet, et il s'est avéré que c'était un appel après la dernière étape de l'augmentation de la résolution de floraison.  Dans ce tampon, l'effet est beaucoup plus visible. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8a3/f38/078/8a3f38078dc5d6c6451030ee3eb5c53b.png"></div><br>  <i>Flare géométrique</i> <br><br>  Si vous regardez la géométrie, la lumière parasite est assez simple.  Au moins 6 quadrangles sont impliqués dans la création du résultat final à l'écran, mais aucune série de quadrangles plus petits ne se rapproche de la position du soleil.  Nous pouvons conclure qu'il s'agit d'une solution assez standard, bien que certains développeurs rendent la lumière parasite directement dans la scène cible de rendu, tandis que d'autres calculent l'effet en tant que post-traitement. <br><br><h3>  Rendu du terrain </h3><br>  Dans tous les jeux en monde ouvert, l'une des difficultés les plus intéressantes est le rendu du terrain.  J'ai décidé qu'il pourrait sembler intéressant d'étudier cet aspect, mais, franchement, un peu déçu. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/125/7a6/89b/1257a689b93f0f7a0239b5514ce911af.png"></div><br>  À première vue, un fragment du relief donne l'impression qu'une sorte de pavage est en cours.  La façon dont le relief est déformé pendant le mouvement rend logique de supposer qu'il y a un déplacement supplémentaire.  De plus, sur PC, le jeu utilise activement la tessellation, il serait donc logique de l'utiliser en relief. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/99d/214/a4d/99d214a4dc8c15862b7e385edda0c25e.png"></div><br>  Peut-être que les mauvais paramètres ont été définis, mais le jeu rend tous les fragments du relief sans pavage.  Pour chaque fragment du relief, elle utilise cette grille uniforme 32 * 32.  Il n'y a pas non plus de LOD. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/744/aa8/4bc/744aa84bce83c87e8c2a49338f7c8c13.png"></div><br>  En regardant un fragment du relief après le vertex shader, vous pouvez voir que la plupart des paires de sommets ont fusionné pour former une grille 16 * 16 presque parfaite, à l'exception de certains endroits qui nécessitent plus de précision (probablement en raison de la courbure du relief).  La déformation mentionnée ci-dessus résulte probablement de la lecture des textures de mip de la carte d'élévation du relief lorsque le relief est loin de la caméra. <br><br><h3>  Ray Tracking Tricks </h3><br>  Et maintenant ce que tout le monde attendait. <br><br><h4>  Streaming de données </h4><br>  L'un des aspects les plus intéressants de toute implémentation DXR pour le moment est la façon dont vous travaillez avec les données.  La chose la plus importante est de savoir comment les données sont chargées dans les structures accélératrices et comment elles sont mises à jour.  Pour tester cela, j'ai pris deux captures et comparé les structures accélératrices dans NSight. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3fc/7b7/0d2/3fc7b70d22199c5be429417fd6ed92a9.png"></div><br>  <i>Le joueur est à l'intérieur du navire</i> <br><br>  Lors de la première capture, je me tenais à l'intérieur d'un vaisseau cassé, visible au milieu de cette image.  Seuls les objets les plus proches sont chargés, à l'exception des gros rochers au bord de la carte. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dc4/e41/2fa/dc4e412fa02b74f7ca4384a53e1b8100.png"></div><br>  <i>Le joueur s'est déplacé dans le coin supérieur gauche de cette image.</i> <br><br>  Dans la deuxième capture, je me suis éloigné du bord de la carte et je me suis rapproché du bord supérieur gauche de l'image.  Le navire et tout ce qui l'entoure est toujours chargé, mais de nouveaux objets ont également été chargés.  Fait intéressant, je ne peux définir aucune structure de tuile.  Les objets peuvent être chargés / retirés de la structure accélératrice en fonction de la distance et de la visibilité (peut-être en limitant le parallélogramme?).  De plus, le bord supérieur droit semble plus détaillé, bien qu'il s'en soit éloigné.  Il serait intéressant d'en savoir plus à ce sujet. <br><br><h4>  Le soulagement et ce qu'il y a sous </h4><br>  Plusieurs aspects de l'implémentation DXR dans Metro: Exodus concernant le terrain peuvent être mentionnés. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e97/386/8bf/e973868bf7b0bd40cfc58c0d94678acf.png"></div><br>  Tout d'abord, il est intéressant de noter que les structures accélératrices ne contiennent pas de maillage en relief (à l'exception de cas particuliers).  Ces monstres courent réellement dans le jeu sur le terrain, mais à en juger par les données de NSight, vous pourriez penser qu'ils volent.  Cela nous pose une question intéressante: la mise en œuvre de l'éclairage global peut-elle en quelque sorte prendre en compte le relief (éventuellement à l'aide d'une carte des hauteurs et de matériaux en relief) ou non. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7a/03e/860/a7a03e8601a37c6459eff55cc7dda39f.png"></div><br>  Le moment suivant, je n'aurais jamais remarqué si le soulagement était en place.  En regardant le début du niveau à la structure accélératrice dans NSight, j'ai remarqué quelques mailles sous le relief. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/458/b77/ec3/458b77ec37a3db2b1d8ca0b3f1694dd8.png"></div><br>  Les artistes placent assez souvent, pour diverses raisons, des maillages de débogage sous le niveau, mais ils sont généralement supprimés avant la sortie du jeu.  Dans ce cas, ces mailles ont non seulement survécu jusqu'à la libération, mais sont également devenues une partie de la structure accélératrice. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/27d/64a/15d/27d64a15df609c55b8742d77637fca22.png"></div><br>  En plus de celles mentionnées ci-dessus, j'ai trouvé d'autres mailles éparpillées sous le relief.  Fondamentalement, ils ne valent pas beaucoup de mention, mais celui-ci était très intéressant - c'est un personnage se tenant juste en dessous du point de départ du niveau.  Il a même sa propre piscine. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/53f/5dd/66c/53f5dd66c2b959793151e3a59d1309a5.png"></div><br>  Enfin, le dernier élément curieux de la structure accélératrice est les mailles unilatérales regardant vers l'extérieur du niveau.  À moins qu'ils ne soient considérés comme bilatéraux, il y a très peu de chances qu'ils contribuent à l'image du jeu.  Même si les maillages sont bilatéraux, ils sont si loin de la zone jouable qu'ils étirent probablement la structure accélératrice.  Il est intéressant de voir qu'ils ne sont pas filtrés.  Cette image montre également l'un des cas particuliers de la "maille en relief" dans le coin inférieur droit, entre le train et le bâtiment. <br><br><h4>  Sans tête avec dépouillement </h4><br>  J'ai déjà parlé des problèmes de skinning des mailles, mais à ce niveau j'ai remarqué autre chose. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1d1/0dd/a8c/1d10dda8c75112713b51c32771bb8ecb.png"></div><br>  Tout d'abord, ce monstre montre les deux erreurs dans une image, que j'ai remarquées ci-dessus.  Je me demande toujours ce qui les a causés. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/523/265/dd7/523265dd72a9613800831592706bd510.png"></div><br>  J'ai également remarqué que ces petites créatures, comme les chauves-souris, n'ont pas de tête dans la structure accélératrice. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/6fd/1a9/801/6fd1a9801d440a719602ab30eb33a88e.png"></div><br>  Un autre exemple.  Remarquez le trou où la tête devrait être.  Je n'ai pas vu un seul cas où la tête était visible. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e7f/51e/741/e7f51e74194bf8cccf8e430e6ec8513d.png"></div><br>  Le même genre de créatures en mode rasterisation.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Notez que la tête est clairement visible. </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ebd/d67/2ea/ebdd672ea50f7717c4b66afeb20b4cf8.png"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Et voici le filaire de la tête. </font></font><br><br><h3>  En conclusion </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">C'est tout pour aujourd'hui. </font><font style="vertical-align: inherit;">J'espère que vous avez apprécié ce regard sur l'intérieur de Metro: Exodus. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je continuerai d'explorer le rendu du jeu, mais je ne publierai pas de nouvelles parties de l'article à moins de trouver des parties spéciales qui seraient intéressantes pour les gens ou de trouver quelque chose qui mérite d'être partagé.</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr447194/">https://habr.com/ru/post/fr447194/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr447182/index.html">Systèmes d'exploitation: trois pièces faciles. Partie 3: API de processus (traduction)</a></li>
<li><a href="../fr447184/index.html">Qu'est-ce que l'offre d'échange initiale (IEO) et en quoi est-elle différente de l'ICO?</a></li>
<li><a href="../fr447186/index.html">Comment lancer un prototype ML en une journée. Signaler Yandex.Taxi</a></li>
<li><a href="../fr447190/index.html">Prédictions de mathématiciens. Nous analysons les principales méthodes de détection des anomalies</a></li>
<li><a href="../fr447192/index.html">Quel rôle la technologie peut-elle jouer dans l'art ancien du mélange d'épices?</a></li>
<li><a href="../fr447196/index.html">7. Check Point Getting Started R80.20. Contrôle d'accès</a></li>
<li><a href="../fr447198/index.html">Mission lunaire "Bereshit": atterrissage-accident-chute sur la lune</a></li>
<li><a href="../fr447204/index.html">17 avril: Conférence ouverte "Le chemin du développeur du jeu: de l'idée au lancement" et une ludothèque à la Higher School of Law</a></li>
<li><a href="../fr447208/index.html">SQA Days EU Review</a></li>
<li><a href="../fr447210/index.html">@Pythonetc compilation mars 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>