<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§æüèø üë©üèΩ‚Äçüíª üìê Escapando del matorral de pruebas: construyendo un atajo de un accesorio a una aserci√≥n üïØÔ∏è ‚ùáÔ∏è üë©üèø‚Äç‚öïÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En este art√≠culo, me gustar√≠a proponer una alternativa al estilo de dise√±o de prueba tradicional utilizando conceptos de programaci√≥n funcional en Sca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escapando del matorral de pruebas: construyendo un atajo de un accesorio a una aserci√≥n</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/2gis/blog/465211/"><p><img src="https://habrastorage.org/webt/mu/ll/ar/mullaroquhqtdb05ygvb82nmghu.jpeg"></p><br><p>  En este art√≠culo, me gustar√≠a proponer una alternativa al estilo de dise√±o de prueba tradicional utilizando conceptos de programaci√≥n funcional en Scala.  Este enfoque se inspir√≥ en muchos meses de dolor por mantener docenas de ex√°menes fallidos y un deseo ardiente de hacerlos m√°s directos y m√°s comprensibles. </p><br><p>  Aunque el c√≥digo est√° en Scala, las ideas propuestas son apropiadas para desarrolladores e ingenieros de control de calidad que usan lenguajes que admiten programaci√≥n funcional.  Puede encontrar un enlace de Github con la soluci√≥n completa y un ejemplo al final del art√≠culo. </p><a name="habracut"></a><br><h2 id="the-problem">  El problema </h2><br><p>  Si alguna vez tuvo que lidiar con pruebas (no importa cu√°les: pruebas unitarias, integrales o funcionales), probablemente se escribieron como un conjunto de instrucciones secuenciales.  Por ejemplo: </p><br><pre><code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// The following tests describe a simple internet store. // Depending on their role, bonus amount and the order's // subtotal, users may receive a discount of some size. "If user's role is 'customer'" - { import TestHelper._ "And if subtotal &lt; 250 after bonuses - no discount" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 30) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 20) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 90 } "And if subtotal &gt;= 250 after bonuses - 10% off" in { val db: Database = Database.forURL(TestConfig.generateNewUrl()) migrateDb(db) insertUser(db, id = 1, name = "test", role = "customer") insertPackage(db, id = 1, name = "test", userId = 1, status = "new") insertPackageItems(db, id = 1, packageId = 1, name = "test", price = 100) insertPackageItems(db, id = 2, packageId = 1, name = "test", price = 120) insertPackageItems(db, id = 3, packageId = 1, name = "test", price = 130) insertBonus(db, id = 1, packageId = 1, bonusAmount = 40) val svc = new SomeProductionLogic(db) val result = svc.calculatePrice(packageId = 1) result shouldBe 279 } } "If user's role is 'vip'" - {/*...*/}</span></span></code> </pre> <br><p>  En mi experiencia, esta forma de escribir pruebas es preferida por la mayor√≠a de los desarrolladores.  Nuestro proyecto tiene alrededor de mil pruebas en diferentes niveles de aislamiento, y todas fueron escritas con este estilo hasta hace poco.  A medida que el proyecto creci√≥, comenzamos a notar problemas graves y retrasos en el mantenimiento de tales pruebas: solucionarlos tomar√≠a al menos la misma cantidad de tiempo que escribir el c√≥digo de producci√≥n. </p><br><p>  Al escribir nuevas pruebas, siempre ten√≠amos que encontrar formas de preparar los datos desde cero, generalmente copiando y pegando los pasos de las pruebas vecinas.  Como resultado, cuando el modelo de datos de la aplicaci√≥n cambiara, el castillo de naipes se derrumbar√≠a y tendr√≠amos que reparar cada prueba fallida: en el peor de los casos, profundizando en cada prueba y reescribi√©ndola. </p><br><p>  Cuando una prueba fallaba "honestamente", es decir, debido a un error real en la l√≥gica empresarial, era imposible comprender qu√© sali√≥ mal sin depurar.  Debido a que las pruebas eran tan dif√≠ciles de entender, nadie ten√≠a el conocimiento completo sobre c√≥mo se supone que debe comportarse el sistema. </p><br><p>  Todo este dolor, en mi opini√≥n, es un s√≠ntoma de los dos problemas m√°s profundos de este dise√±o de prueba: </p><br><ol><li>  No existe una estructura clara y pr√°ctica para las pruebas.  Cada prueba es un copo de nieve √∫nico.  La falta de estructura conduce a la verbosidad, que consume mucho tiempo y desmotiva.  Detalles insignificantes distraen de lo que es m√°s importante: el requisito que afirma la prueba.  Copiar y pegar se convierte en el enfoque principal para escribir nuevos casos de prueba. </li><li>  Las pruebas no ayudan a los desarrolladores a localizar defectos;  solo indican que hay un problema de alg√∫n tipo.  Para comprender el estado en el que se ejecuta la prueba, debe trazarla en su cabeza o usar un depurador. </li></ol><br><h2 id="modeling">  Modelado </h2><br><p>  ¬øPodemos hacerlo mejor?  (Alerta de spoiler: podemos). Consideremos qu√© tipo de estructura puede tener esta prueba. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> db: <span class="hljs-type"><span class="hljs-type">Database</span></span> = <span class="hljs-type"><span class="hljs-type">Database</span></span>.forURL(<span class="hljs-type"><span class="hljs-type">TestConfig</span></span>.generateNewUrl()) migrateDb(db) insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> <br><p>  Como regla general, el c√≥digo bajo prueba espera algunos par√°metros expl√≠citos (identificadores, tama√±os, cantidades, filtros, por nombrar algunos), as√≠ como algunos datos externos (de una base de datos, cola o alg√∫n otro servicio del mundo real).  Para que nuestra prueba se ejecute de manera confiable, necesita un <em>elemento fijo</em> : un estado para colocar el sistema, los proveedores de datos o ambos. </p><br><p>  Con este accesorio, preparamos una <em>dependencia</em> para inicializar el c√≥digo bajo prueba: llenar una base de datos, crear una cola de un tipo particular, etc. </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> svc = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">SomeProductionLogic</span></span>(db) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = svc.calculatePrice(packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br><p>  Despu√©s de ejecutar el c√≥digo bajo prueba en algunos par√°metros de entrada, recibimos una <em>salida</em> , tanto expl√≠cita (devuelta por el c√≥digo bajo prueba) como impl√≠cita (los cambios en el estado). </p><br><pre> <code class="scala hljs">result shouldBe <span class="hljs-number"><span class="hljs-number">90</span></span></code> </pre> <br><p>  Finalmente, verificamos que el resultado es el esperado, terminando la prueba con una o m√°s <em>aserciones</em> . </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  Se puede concluir que las pruebas generalmente consisten en las mismas etapas: preparaci√≥n de entrada, ejecuci√≥n de c√≥digo y afirmaci√≥n de resultados.  Podemos utilizar este hecho para deshacernos del <strong>primer problema de nuestras pruebas</strong> , es decir, una forma demasiado liberal, dividiendo expl√≠citamente el cuerpo de una prueba en etapas.  Tal idea no es nueva, como se puede ver en las pruebas de estilo BDD ( <em>desarrollo basado en el comportamiento</em> ). </p><br><p>  ¬øQu√© pasa con la extensibilidad?  Cualquier paso del proceso de prueba puede, a su vez, contener cualquier cantidad de intermedios.  Por ejemplo, podr√≠amos dar un paso grande y complicado, como construir un accesorio y dividirlo en varios, encadenados uno tras otro.  De esta manera, el proceso de prueba puede ser infinitamente extensible, pero en √∫ltima instancia siempre consta de los mismos pocos pasos generales. </p><br><p><img src="https://habrastorage.org/webt/55/qf/zl/55qfzlhkl99txyyhizbvzg48yhs.jpeg"></p><br><h2 id="running-tests">  Ejecutando pruebas </h2><br><p>  Intentemos implementar la idea de dividir la prueba en etapas, pero primero, debemos determinar qu√© tipo de resultado nos gustar√≠a ver. </p><br><p>  En general, nos gustar√≠a escribir y mantener pruebas para que sea menos laborioso y m√°s agradable.  Cuantas menos instrucciones expl√≠citas y no √∫nicas tenga una prueba, menos cambios tendr√≠an que realizarse despu√©s de cambiar los contratos o la refactorizaci√≥n, y menos tiempo tomar√≠a leer la prueba.  El dise√±o de la prueba debe promover la reutilizaci√≥n de fragmentos de c√≥digo comunes y desalentar la copia y el pegado sin sentido.  Tambi√©n ser√≠a bueno que las pruebas tuvieran una forma unificada.  La previsibilidad mejora la legibilidad y ahorra tiempo.  Por ejemplo, imagine cu√°nto tiempo m√°s le tomar√≠a a los aspirantes a cient√≠ficos aprender todas las f√≥rmulas si los libros de texto los escribieran libremente en un lenguaje com√∫n en lugar de las matem√°ticas. </p><br><p>  Por lo tanto, nuestro objetivo es ocultar cualquier cosa que distraiga e innecesaria, dejando solo lo que es de importancia cr√≠tica para la comprensi√≥n: lo que se est√° probando, cu√°les son las entradas y salidas esperadas. </p><br><p>  Volvamos a nuestro modelo de la estructura de la prueba. </p><br><p><img src="https://habrastorage.org/webt/em/aa/rb/emaarb5ltmnme4-wpda0ebakueq.jpeg"></p><br><p>  T√©cnicamente, cada paso puede representarse mediante un tipo de datos y cada transici√≥n, mediante una funci√≥n.  Es posible pasar del tipo de datos inicial al √∫ltimo aplicando cada funci√≥n al resultado del anterior.  En otras palabras, mediante el uso de la composici√≥n de funciones de preparaci√≥n de datos (llam√©mosla <code>prepare</code> ), ejecuci√≥n de c√≥digo ( <code>execute</code> ) y verificaci√≥n del resultado esperado ( <code>check</code> ).  La entrada para esta composici√≥n ser√≠a el primer paso: el accesorio.  Llamemos a la funci√≥n de orden superior resultante la funci√≥n de <strong>ciclo de vida de prueba</strong> . </p><br><div class="spoiler">  <b class="spoiler_title">Prueba de la funci√≥n del ciclo de vida</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">runTestCycle</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">DEP</span></span>, <span class="hljs-type"><span class="hljs-type">OUT</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( fixture: <span class="hljs-type"><span class="hljs-type">FX</span></span>, prepare: <span class="hljs-type"><span class="hljs-type">FX</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">DEP</span></span>, execute: <span class="hljs-type"><span class="hljs-type">DEP</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">OUT</span></span>, check: <span class="hljs-type"><span class="hljs-type">OUT</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] ): <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">Assertion</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// In Scala instead of writing check(execute(prepare(fixture))) // one can use a more readable version using the andThen function: (prepare andThen execute andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Surge una pregunta, ¬øde d√≥nde vienen estas ciertas funciones?  Bueno, en cuanto a la preparaci√≥n de datos, solo hay una cantidad limitada de formas de hacerlo: llenar una base de datos, burlarse, etc.  Por lo tanto, es √∫til escribir variantes especializadas de la funci√≥n de <code>prepare</code> compartida en todas las pruebas.  Como resultado, ser√≠a m√°s f√°cil realizar funciones de ciclo de vida de prueba especializadas para cada caso, lo que ocultar√≠a implementaciones concretas de preparaci√≥n de datos.  Dado que la ejecuci√≥n de c√≥digo y las aserciones son m√°s o menos √∫nicas para cada prueba (o grupo de pruebas), la <code>execute</code> y la <code>check</code> deben escribirse expl√≠citamente cada vez. </p><br><div class="spoiler">  <b class="spoiler_title">Funci√≥n de ciclo de vida de prueba adaptada para pruebas de integraci√≥n en una base de datos</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Sets up the fixture ‚Äî implemented separately def prepareDatabase[DB](db: Database): DbFixture =&gt; DB def testInDb[DB, OUT]( fixture: DbFixture, execute: DB =&gt; OUT, check: OUT =&gt; Future[Assertion], db: Database = getDatabaseHandleFromSomewhere(), ): Future[Assertion] = runTestCycle(fixture, prepareDatabase(db), execute, check)</span></span></code> </pre> </div></div><br><p>  Al delegar todos los matices administrativos a la funci√≥n del ciclo de vida de la prueba, tenemos la capacidad de extender el proceso de prueba sin tocar ninguna prueba dada.  Al utilizar la composici√≥n de funciones, podemos interferir en cualquier paso del proceso y extraer o agregar datos. </p><br><p>  Para ilustrar mejor las capacidades de este enfoque, resuelvamos <strong>el segundo problema de nuestra prueba inicial</strong> : la falta de informaci√≥n complementaria para detectar problemas.  Agreguemos el registro de cualquier ejecuci√≥n de c√≥digo que haya devuelto.  Nuestro registro no cambiar√° el tipo de datos;  solo produce <em>un efecto secundario</em> : enviar un mensaje a la consola.  Despu√©s del efecto secundario, lo devolvemos tal como est√°. </p><br><div class="spoiler">  <b class="spoiler_title">Pruebe la funci√≥n del ciclo de vida con el registro</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">logged</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> loggedT: <span class="hljs-type"><span class="hljs-type">Logged</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">T</span></span> = (that: <span class="hljs-type"><span class="hljs-type">T</span></span>) =&gt; { <span class="hljs-comment"><span class="hljs-comment">// By passing an instance of the Logged typeclass for T as an argument, // we get an ability to ‚Äúadd‚Äù behavior log() to the abstract ‚Äúthat‚Äù member. // More on typeclasses later on. loggedT.log(that) // We could even do: that.log() that // The object gets returned unaltered } def runTestCycle[FX, DEP, OUT, F[_]]( fixture: FX, prepare: FX =&gt; DEP, execute: DEP =&gt; OUT, check: OUT =&gt; F[Assertion] )(implicit loggedOut: Logged[OUT]): F[Assertion] = // Insert logged right after receiving the result - after execute() (prepare andThen execute andThen logged andThen check) (fixture)</span></span></code> </pre> </div></div><br><p>  Con este simple cambio, hemos agregado el registro de la salida del c√≥digo ejecutado <strong>en cada prueba</strong> .  La ventaja de funciones tan peque√±as es que son f√°ciles de entender, componer y eliminar cuando sea necesario. </p><br><p><img src="https://habrastorage.org/webt/ti/2t/l9/ti2tl9pk8wkd4hp8pqevf74hdn4.jpeg"></p><br><p>  Como resultado, nuestra prueba ahora se ve as√≠: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> fixture: <span class="hljs-type"><span class="hljs-type">SomeMagicalFixture</span></span> = ??? <span class="hljs-comment"><span class="hljs-comment">// Comes from somewhere else def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected // The creation and filling of Database is hidden in testInDb "If user's role is 'customer'" in testInDb( state = fixture, execute = runProductionCode(id = 1), check = checkResult(90) )</span></span></code> </pre> <br><p>  El cuerpo de la prueba se volvi√≥ conciso, el dispositivo y los controles se pueden reutilizar en otras pruebas, y ya no preparamos la base de datos manualmente en ninguna parte.  Solo queda un peque√±o problema ... </p><br><h2 id="fixture-preparation">  Preparaci√≥n de accesorios </h2><br><p>  En el c√≥digo anterior est√°bamos trabajando bajo la suposici√≥n de que el dispositivo nos ser√≠a dado desde alg√∫n lugar.  Dado que los datos son el ingrediente cr√≠tico de las pruebas sencillas y f√°ciles de mantener, tenemos que tocar c√≥mo hacerlos f√°cilmente. </p><br><p>  Supongamos que nuestra tienda bajo prueba tiene una base de datos relacional t√≠pica de tama√±o mediano (por simplicidad, en este ejemplo tiene solo 4 tablas, pero en realidad, puede tener cientos).  Algunas tablas tienen datos referenciales, algunos datos comerciales, y todo eso puede agruparse l√≥gicamente en una o m√°s entidades complejas.  Las relaciones se vinculan con <em>claves externas</em> , para crear un <code>Bonus</code> , se requiere un <code>Package</code> , que a su vez necesita un <code>User</code> , y as√≠ sucesivamente. </p><br><p><img src="https://habrastorage.org/webt/3z/of/sy/3zofsyjoygierusjtmlu_okrmh0.png"></p><br><p>  Las soluciones y los hacks solo conducen a la inconsistencia de los datos y, como resultado, a horas y horas de depuraci√≥n.  Por esta raz√≥n, no estamos haciendo cambios en el esquema de ninguna manera. </p><br><p>  Podr√≠amos usar algunos m√©todos de producci√≥n para llenarlo, pero incluso bajo un escrutinio superficial, esto plantea muchas preguntas dif√≠ciles.  ¬øQu√© preparar√° los datos en las pruebas para ese c√≥digo de producci√≥n?  ¬øTendr√≠amos que reescribir las pruebas si cambia el contrato de ese c√≥digo?  ¬øQu√© sucede si los datos provienen de otro lugar y no hay m√©todos para usar?  ¬øCu√°ntas solicitudes se necesitar√≠an para crear una entidad que depende de muchas otras? </p><br><div class="spoiler">  <b class="spoiler_title">Base de datos completando la prueba inicial</b> <div class="spoiler_text"><pre> <code class="scala hljs">insertUser(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, role = <span class="hljs-string"><span class="hljs-string">"customer"</span></span>) insertPackage(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, userId = <span class="hljs-number"><span class="hljs-number">1</span></span>, status = <span class="hljs-string"><span class="hljs-string">"new"</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">1</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">30</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">2</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">20</span></span>) insertPackageItems(db, id = <span class="hljs-number"><span class="hljs-number">3</span></span>, packageId = <span class="hljs-number"><span class="hljs-number">1</span></span>, name = <span class="hljs-string"><span class="hljs-string">"test"</span></span>, price = <span class="hljs-number"><span class="hljs-number">40</span></span>)</code> </pre> </div></div><br><p>  Los m√©todos de ayuda dispersos, como los de nuestro primer ejemplo, son el mismo problema bajo un disfraz diferente.  Asumen la responsabilidad de gestionar las dependencias sobre nosotros mismos, lo que estamos tratando de evitar. </p><br><p>  Idealmente, nos gustar√≠a tener una estructura de datos que presente todo el estado del sistema de un vistazo.  Un candidato adecuado ser√≠a una tabla (o un <em>conjunto de datos</em> , como en PHP o Python) que no tendr√≠a nada m√°s que campos cr√≠ticos para la l√≥gica empresarial.  Si cambia, mantener las pruebas ser√≠a f√°cil: simplemente cambiamos los campos en el conjunto de datos.  Ejemplo: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) )</code> </pre> <br><p><img src="https://habrastorage.org/webt/5j/dt/2p/5jdt2pdn7hdzhepaut_bhukkcgm.jpeg"></p><br><p>  Desde nuestra tabla, creamos <em>claves</em> - enlaces de entidad por ID.  Si una entidad depende de otra, tambi√©n se crea una clave para esa otra entidad.  Puede suceder que dos entidades diferentes creen una dependencia con la misma ID, lo que puede conducir a <em>una violaci√≥n de la clave principal</em> .  Sin embargo, en esta etapa es incre√≠blemente barato deduplicar claves, ya que todo lo que contienen son ID, podemos ponerlas en una colecci√≥n que nos deduplica, por ejemplo, un <code>Set</code> .  Si eso resulta insuficiente, siempre podemos implementar una deduplicaci√≥n m√°s inteligente como una funci√≥n separada y componerla en la funci√≥n de prueba del ciclo de vida. </p><br><div class="spoiler">  <b class="spoiler_title">Claves (ejemplo)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusKey</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Key</span></span></span></span></code> </pre> </div></div><br><p>  La generaci√≥n de datos falsos para campos (por ejemplo, nombres) se delega a una clase separada.  Luego, al usar esa clase y las reglas de conversi√≥n para las claves, obtenemos los objetos Row destinados a la inserci√≥n en la base de datos. </p><br><div class="spoiler">  <b class="spoiler_title">Filas (ejemplo)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SampleData</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">name</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"test name"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">role</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"customer"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">price</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bonusAmount</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">status</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">String</span></span> = <span class="hljs-string"><span class="hljs-string">"new"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, userId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, status: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PackageItemRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, price: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, role: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BonusRow</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">id: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, packageId: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, bonusAmount: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Row</span></span></span></span></code> </pre> </div></div><br><p>  Los datos falsos generalmente no son suficientes, por lo que necesitamos una forma de anular campos espec√≠ficos.  Afortunadamente, las <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">lentes</a> son justo lo que necesitamos: podemos usarlas para iterar sobre todas las filas creadas y cambiar solo los campos que necesitamos.  Dado que las lentes son funciones disfrazadas, podemos componerlas como de costumbre, que es su punto m√°s fuerte. </p><br><div class="spoiler">  <b class="spoiler_title">Lense (ejemplo)</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeUserRole</span></span></span></span>(userId: <span class="hljs-type"><span class="hljs-type">Int</span></span>, newRole: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>] = (rows: <span class="hljs-type"><span class="hljs-type">Set</span></span>[<span class="hljs-type"><span class="hljs-type">Row</span></span>]) =&gt; rows.modifyAll(_.each.when[<span class="hljs-type"><span class="hljs-type">UserRow</span></span>]) .using(r =&gt; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (r.id == userId) r.modify(_.role).setTo(newRole) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> r)</code> </pre> </div></div><br><p>  Gracias a la composici√≥n, podemos aplicar diferentes optimizaciones y mejoras dentro del proceso: por ejemplo, podr√≠amos agrupar filas por tabla para insertarlas con un solo <code>INSERT</code> para reducir el tiempo de ejecuci√≥n de la prueba o registrar todo el estado de la base de datos. </p><br><div class="spoiler">  <b class="spoiler_title">Funci√≥n de preparaci√≥n de accesorios</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeFixture</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">STATE</span></span>, <span class="hljs-type"><span class="hljs-type">FX</span></span>, <span class="hljs-type"><span class="hljs-type">ROW</span></span>, <span class="hljs-type"><span class="hljs-type">F</span></span>[_]]( state: <span class="hljs-type"><span class="hljs-type">STATE</span></span>, applyOverrides: <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] =&gt; <span class="hljs-type"><span class="hljs-type">F</span></span>[<span class="hljs-type"><span class="hljs-type">ROW</span></span>] = x =&gt; x ): <span class="hljs-type"><span class="hljs-type">FX</span></span> = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state)</code> </pre> </div></div><br><p>  Finalmente, todo nos proporciona un accesorio.  En la prueba en s√≠, no se muestra nada adicional, excepto el conjunto de datos inicial: todos los detalles est√°n ocultos por la composici√≥n de la funci√≥n. </p><br><p><img src="https://habrastorage.org/webt/b3/wz/cq/b3wzcqmqj3gomn-s-zycrakuegy.jpeg"></p><br><p>  Nuestro conjunto de pruebas ahora se ve as√≠: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dataTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">DataRow</span></span>] = <span class="hljs-type"><span class="hljs-type">Table</span></span>( (<span class="hljs-string"><span class="hljs-string">"Package ID"</span></span>, <span class="hljs-string"><span class="hljs-string">"Customer's role"</span></span>, <span class="hljs-string"><span class="hljs-string">"Item prices"</span></span>, <span class="hljs-string"><span class="hljs-string">"Bonus value"</span></span>, <span class="hljs-string"><span class="hljs-string">"Expected final price"</span></span>) , (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">90.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">250</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>.empty , <span class="hljs-number"><span class="hljs-number">225.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>) , <span class="hljs-number"><span class="hljs-number">210.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-string"><span class="hljs-string">"customer"</span></span>, <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>) , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>) , <span class="hljs-number"><span class="hljs-number">279.0</span></span>) , (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-string"><span class="hljs-string">"vip"</span></span> , <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">120</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>), <span class="hljs-type"><span class="hljs-type">Vector</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>), <span class="hljs-number"><span class="hljs-number">252.0</span></span>) ) <span class="hljs-string"><span class="hljs-string">"If the buyer's role is"</span></span> - { <span class="hljs-string"><span class="hljs-string">"a customer"</span></span> - { <span class="hljs-string"><span class="hljs-string">"And the total price of items"</span></span> - { <span class="hljs-string"><span class="hljs-string">"&lt; 250 after applying bonuses - no discount"</span></span> - { <span class="hljs-string"><span class="hljs-string">"(case: no bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-string"><span class="hljs-string">"(case: has bonuses)"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">3</span></span>) } <span class="hljs-string"><span class="hljs-string">"&gt;= 250 after applying bonuses"</span></span> - { <span class="hljs-string"><span class="hljs-string">"If there are no bonuses - 10% off on the subtotal"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-string"><span class="hljs-string">"If there are bonuses - 10% off on the subtotal after applying bonuses"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">4</span></span>) } } } <span class="hljs-string"><span class="hljs-string">"a vip - then they get a 20% off before applying bonuses and then all the other rules apply"</span></span> in calculatePriceFor(dataTable, <span class="hljs-number"><span class="hljs-number">5</span></span>) }</code> </pre> <br><p>  Y el c√≥digo de ayuda: </p><br><div class="spoiler">  <b class="spoiler_title">C√≥digo de ayuda</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Reusable test's body def calculatePriceFor(table: Seq[DataRow], idx: Int) = testInDb( state = makeState(table.row(idx)), execute = runProductionCode(table.row(idx)._1), check = checkResult(table.row(idx)._5) ) def makeState(row: DataRow): Logger =&gt; DbFixture = { val items: Map[Int, Int] = ((1 to row._3.length) zip row._3).toMap val bonuses: Map[Int, Int] = ((1 to row._4.length) zip row._4).toMap MyFixtures.makeFixture( state = PackageRelationships .minimal(id = row._1, userId = 1) .withItems(items.keys) .withBonuses(bonuses.keys), overrides = changeRole(userId = 1, newRole = row._2) andThen items.map { case (id, newPrice) =&gt; changePrice(id, newPrice) }.foldPls andThen bonuses.map { case (id, newBonus) =&gt; changeBonus(id, newBonus) }.foldPls ) } def runProductionCode(id: Int): Database =&gt; Double = (db: Database) =&gt; new SomeProductionLogic(db).calculatePrice(id) def checkResult(expected: Double): Double =&gt; Future[Assertion] = (result: Double) =&gt; result shouldBe expected</span></span></code> </pre></div></div><br><p>  Agregar nuevos casos de prueba a la tabla es una tarea trivial que nos permite concentrarnos en <strong>cubrir m√°s casos marginales</strong> y no en escribir c√≥digo repetitivo. </p><br><h2 id="reusing-fixture-preparation-on-different-projects">  Reutilizando la preparaci√≥n de accesorios en diferentes proyectos </h2><br><p>  Bien, escribimos una gran cantidad de c√≥digo para preparar accesorios en un proyecto espec√≠fico, pasando bastante tiempo en el proceso.  ¬øQu√© pasa si tenemos varios proyectos?  ¬øEstamos condenados a reinventar todo desde cero todo el tiempo? </p><br><p>  Podemos abstraer la preparaci√≥n del aparato sobre un modelo de dominio concreto.  En el mundo de la programaci√≥n funcional, existe un concepto de <em>clases</em> de <em>tipos</em> .  Sin profundizar en los detalles, no son como clases en OOP, sino m√°s bien como interfaces en el sentido de que definen un cierto comportamiento de alg√∫n grupo de tipos.  La diferencia fundamental es que no se heredan sino que se instancian como variables.  Sin embargo, de manera similar a la herencia, la resoluci√≥n de instancias de tipo de clase ocurre <em>en tiempo de compilaci√≥n</em> .  En este sentido, las clases de tipos se pueden entender como <em>m√©todos de extensi√≥n</em> de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Kotlin</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">C #</a> . </p><br><p>  Para registrar un objeto, no necesitamos saber qu√© hay dentro, qu√© campos y m√©todos tiene.  Lo √∫nico que nos importa es tener un <code>log()</code> comportamiento <code>log()</code> con una firma particular.  Extender cada clase individual con una interfaz <code>Logged</code> ser√≠a extremadamente tedioso e incluso, en muchos casos, no ser√≠a posible, por ejemplo, para bibliotecas o clases est√°ndar.  Con las clases de tipos, esto es mucho m√°s f√°cil.  Podemos crear una instancia de una clase de tipo llamada <code>Logged</code> , por ejemplo, para que un dispositivo lo registre en un formato legible para humanos.  Para todo lo dem√°s que no tiene una instancia de <code>Logged</code> , podemos proporcionar una alternativa: una instancia para el tipo <code>Any</code> que utiliza un m√©todo est√°ndar <code>toString()</code> para registrar de forma gratuita todos los objetos en su representaci√≥n interna. </p><br><div class="spoiler">  <b class="spoiler_title">Un ejemplo de la clase de tipo Logged y sus instancias</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Logged</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">A</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">log</span></span></span></span>(a: <span class="hljs-type"><span class="hljs-type">A</span></span>)(<span class="hljs-keyword"><span class="hljs-keyword">implicit</span></span> logger: <span class="hljs-type"><span class="hljs-type">Logger</span></span>): <span class="hljs-type"><span class="hljs-type">A</span></span> } <span class="hljs-comment"><span class="hljs-comment">// For all Futures implicit def futureLogged[T]: Logged[Future[T]] = new Logged[Future[T]] { override def log(futureT: Future[T])(implicit logger: Logger): Future[T] = { futureT.map { t =&gt; // map on a Future lets us modify its result after it finishes logger.info(t.toString()) t } } } // Fallback in case there are no suitable implicits in scope implicit def anyNoLogged[T]: Logged[T] = new Logged[T] { override def log(t: T)(implicit logger: Logger): T = { logger.info(t.toString()) t } }</span></span></code> </pre> </div></div><br><p>  Adem√°s del registro, podemos usar este enfoque durante todo el proceso de hacer accesorios.  Nuestra soluci√≥n propone una forma abstracta de hacer accesorios de base de datos y un conjunto de clases de tipos para acompa√±arlo.  Es el proyecto que usa la responsabilidad de la soluci√≥n implementar las instancias de estas clases de tipos para que todo funcione. </p><br><pre> <code class="scala hljs"><span class="hljs-comment"><span class="hljs-comment">// Fixture preparation function def makeFixture[STATE, FX, ROW, F[_]]( state: STATE, applyOverrides: F[ROW] =&gt; F[ROW] = x =&gt; x ): FX = (extractKeys andThen deduplicateKeys andThen enrichWithSampleData andThen applyOverrides andThen logged andThen buildFixture) (state) override def extractKeys(implicit toKeys: ToKeys[DbState]): DbState =&gt; Set[Key] = (db: DbState) =&gt; db.toKeys() override def enrichWithSampleData(implicit enrich: Enrich[Key]): Key =&gt; Set[Row] = (key: Key) =&gt; key.enrich() override def buildFixture(implicit insert: Insertable[Set[Row]]): Set[Row] =&gt; DbFixture = (rows: Set[Row]) =&gt; rows.insert() // Behavior of splitting something (eg a dataset) into keys trait ToKeys[A] { def toKeys(a: A): Set[Key] // Something =&gt; Set[Key] } // ...converting keys into rows trait Enrich[A] { def enrich(a: A): Set[Row] // Set[Key] =&gt; Set[Row] } // ...and inserting rows into the database trait Insertable[A] { def insert(a: A): DbFixture // Set[Row] =&gt; DbFixture } // To be implemented in our project (see the example at the end of the article) implicit val toKeys: ToKeys[DbState] = ??? implicit val enrich: Enrich[Key] = ??? implicit val insert: Insertable[Set[Row]] = ???</span></span></code> </pre> <br><p>  Al dise√±ar esta herramienta de preparaci√≥n de accesorios, utilic√© los <em>principios S√ìLIDOS</em> como una br√∫jula para asegurarme de que se pueda mantener y ampliar: </p><br><ul><li>  <em>El Principio de Responsabilidad √önica</em> : cada clase de tipo describe uno y solo un comportamiento de un tipo. </li><li>  <em>El principio abierto / cerrado</em> : no modificamos ninguna de las clases de producci√≥n;  en su lugar, los extendemos con instancias de typeclasses. </li><li>  <em>El Principio de sustituci√≥n de Liskov</em> no se aplica aqu√≠ ya que no usamos la herencia. </li><li>  <em>El principio de segregaci√≥n de interfaz</em> : utilizamos muchas clases de tipos especializadas en lugar de una global. </li><li>  <em>El principio de inversi√≥n de dependencia</em> : la funci√≥n de preparaci√≥n de accesorios no depende de tipos concretos, sino de clases de tipos abstractos. </li></ul><br><p>  Despu√©s de asegurarnos de que se cumplan todos los principios, podemos asumir con seguridad que nuestra soluci√≥n es mantenible y lo suficientemente extensible como para ser utilizada en diferentes proyectos. </p><br><p>  Despu√©s de escribir la funci√≥n del ciclo de vida de la prueba y la soluci√≥n para la preparaci√≥n del accesorio, que tambi√©n es independiente de un modelo de dominio concreto en cualquier aplicaci√≥n, estamos listos para mejorar todas las pruebas restantes. </p><br><h2 id="bottom-line">  L√≠nea inferior </h2><br><p>  Hemos cambiado del estilo de dise√±o de prueba tradicional (paso a paso) a funcional.  El estilo paso a paso es √∫til desde el principio y en proyectos de menor tama√±o, ya que no restringe a los desarrolladores y no requiere ning√∫n conocimiento especializado.  Sin embargo, cuando la cantidad de pruebas se vuelve demasiado grande, ese estilo tiende a caerse.  Escribir pruebas en el estilo funcional probablemente no resolver√° todos sus problemas de prueba, pero podr√≠a mejorar significativamente la escala y el mantenimiento de las pruebas en proyectos, donde hay cientos o miles de ellas.  Las pruebas escritas en el estilo funcional resultan ser m√°s concisas y centradas en las cosas esenciales (como los datos, el c√≥digo bajo prueba y el resultado esperado), no en los pasos intermedios. </p><br><p>  Adem√°s, hemos explorado cu√°n poderosas pueden ser la composici√≥n de funciones y las clases de tipos en la programaci√≥n funcional.  Con su ayuda, es bastante sencillo dise√±ar soluciones teniendo en cuenta la capacidad de ampliaci√≥n y la reutilizaci√≥n. </p><br><p>  Desde que adoptamos el estilo hace varios meses, nuestro equipo tuvo que dedicar un poco de esfuerzo para adaptarse, pero al final, disfrutamos del resultado.  Las nuevas pruebas se escriben m√°s r√°pido, los registros hacen la vida mucho m√°s c√≥moda y los conjuntos de datos son √∫tiles para verificar cada vez que haya preguntas sobre las complejidades de algunas l√≥gicas.  Nuestro equipo tiene como objetivo cambiar gradualmente todas las pruebas a este nuevo estilo. </p><br><hr><br><p>  Enlace a la soluci√≥n y un ejemplo completo se puede encontrar aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Github</a> .  ¬°Divi√©rtete con tus pruebas! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/465211/">https://habr.com/ru/post/465211/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../465189/index.html">Equipo de desarrollo de Workflow One Sprint</a></li>
<li><a href="../465191/index.html">Entrenamiento Cisco 200-125 CCNA v3.0. D√≠a 25. Estudio en profundidad de IPv6</a></li>
<li><a href="../465193/index.html">Crear un proyecto de Android en un contenedor acoplable</a></li>
<li><a href="../465203/index.html">Elefante corporativo</a></li>
<li><a href="../465209/index.html">Aprendemos los datos del pasaporte de una persona por su nombre (si hay una garant√≠a)</a></li>
<li><a href="../465215/index.html">Qu√© leer L√≠der de equipo y estaci√≥n de servicio: una selecci√≥n de 50 libros con calificaciones y m√°s</a></li>
<li><a href="../465217/index.html">Acronis True Image 2020: nuevos esquemas de replicaci√≥n y protecci√≥n mejorada</a></li>
<li><a href="../465221/index.html">Lo que los registros en 1C podr√≠an verse en presencia de OOP</a></li>
<li><a href="../465223/index.html">C√≥mo hacer un uso pr√°ctico de la seguridad del papel, o por qu√© necesitamos cumplir con 152-–§–ó y PCI DSS en una nube</a></li>
<li><a href="../465227/index.html">Realidad aumentada en el comercio minorista en l√≠nea</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>