<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÄ üó°Ô∏è üëáüèΩ De um laptop - um servidor dom√©stico com energia redundante ao roteador Mikrotik ‚ùî üë∞üèø üñêüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Brevemente 
 Um artigo para os f√£s soldarem esquemas simples e descobrirem por que eles s√£o feitos dessa maneira. 

 E tamb√©m para aqueles que realmen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>De um laptop - um servidor dom√©stico com energia redundante ao roteador Mikrotik</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479488/"><img src="https://habrastorage.org/webt/pl/gi/hh/plgihhkmxbo7cvnzhnbtwwdi85w.jpeg"><br><br><h1>  Brevemente </h1><br>  Um artigo para os f√£s soldarem esquemas simples e descobrirem por que eles s√£o feitos dessa maneira. <br><br>  E tamb√©m para aqueles que realmente precisam desse servidor. <br><br>  N√£o h√° super conquista aqui, mas existe uma solu√ß√£o barata, compacta e econ√¥mica, que em alguns casos substitui um grande volume de equipamentos: <br><br><ul><li>  criou um servidor dom√©stico a partir de um laptop antigo e um dispositivo de energia do roteador, </li><li>  explicou o esquema de energia do roteador a partir do carregamento e da bateria do laptop, </li><li>  O esquema para ligar o laptop quando a energia √© ligada √© explicado. </li></ul><a name="habracut"></a><br><h1>  Id√©ia </h1><br>  Eu precisava de um servidor de arquivos pequeno, que tamb√©m tivesse que suportar quedas de energia de at√© 15 minutos. <br><br>  Eu decidi fazer isso a partir de um laptop antigo. <br><br>  Um laptop (Asus A8J) foi comprado especialmente para o experimento com uma matriz quebrada, mas com bateria e ventilador ativos. <br><br>  <i>(Nota: se voc√™ j√° possui um laptop, ent√£o, como na tarefa conhecida sobre a chaleira, n√£o √© necess√°rio quebrar a matriz. No entanto, se o seu roteador, como o meu, trabalha com um modem 4G, √© melhor desabilitar a matriz, ent√£o explicarei o motivo.</i> <i><br><br></i>  <i>Trabalhar sem matriz n√£o cria nenhum desconforto, primeiro usa um monitor externo e depois o SSH.)</i> <br><br>  No processo, chamei a aten√ß√£o para o fato de que o roteador Mikrotik (eu tenho RB-951G) pode ser alimentado de 9 a 30 V, e surgiu a id√©ia de aliment√°-lo em um laptop. <br><br>  Acabou sendo uma combina√ß√£o muito bem-sucedida: na presen√ßa de tens√£o da rede, o roteador √© alimentado pelo carregador do laptop (19-20 V) e, no caso de uma falha na rede, pela bateria do mesmo laptop (de 12 a 9 V quando √© descarregada), ou seja,  tudo est√° dentro dos limites normais. <br><br>  <i>Mais precisamente, a voltagem no roteador ser√° 0,2-0,4 V mais baixa devido a uma queda nos diodos, mas ainda dentro da faixa aceit√°vel (exceto pelo limite inferior de descarga da bateria, que n√£o sabemos ao certo, mas no meu caso √© improv√°vel que seja atingido) .</i> <i><br><br></i>  <i>E se isso acontecer, nada terr√≠vel acontecer√° ao roteador).</i> <br><br><h1>  Esquema de energia do roteador </h1><br><img src="https://habrastorage.org/webt/x8/ym/3x/x8ym3xsabcnw62ea6dmynhylwic.jpeg"><br><br>  Como uma tens√£o mais alta (20V) tem preced√™ncia aqui, o circuito de comuta√ß√£o √© muito simples, de dois diodos. <br><br>  Tamb√©m √© conveniente que nenhuma prote√ß√£o de tens√£o seja necess√°ria. <br><br>  No caso de uma longa aus√™ncia da rede, a bateria ser√° descarregada at√© o limite em que seu controlador interno desconectar√° a carga e, portanto, a descarga excessiva n√£o ocorrer√°. <br><br>  Ent√£o, quando a energia da rede el√©trica for aplicada, a bateria come√ßar√° a carregar e o roteador ser√° alimentado pelo carregador. <br><br>  <i>Teoricamente, em um caso malsucedido, podemos exceder a corrente permitida do carregador e / ou bateria (j√° que levamos 0,4-0,8A extra para o roteador a 20V), mas, na pr√°tica, a corrente excedente n√£o vai acontecer, e eis o porqu√™: eu removi a unidade de DVD do laptop, o controlador WIFI, bem como a matriz.</i>  <i>Nesse sentido, o consumo atual diminuiu.</i> <br><br>  Para reduzir as perdas de tens√£o, selecionamos diodos Schottky e, especificamente, montei dois diodos (n√£o me lembro do tipo), que est√£o nas fontes de alimenta√ß√£o de computadores e parecem um transistor poderoso. <br><br>  <i>O consumo atual do roteador, juntamente com o modem 4G inclu√≠do, pode chegar a 1,7A no pior dos casos - quando alimentado a partir de 9V.</i> <i><br><br></i>  <i>(A fonte de alimenta√ß√£o de comuta√ß√£o dentro do roteador consome energia constante; portanto, quanto menor a tens√£o de entrada, maior o consumo de corrente).</i> <br><br>  Os diodos de montagem suportam uma corrente cont√≠nua de 20A, e isso tamb√©m √© conveniente. <br><br>  Voc√™ n√£o precisa fazer prote√ß√£o contra curtos-circuitos de sa√≠da.  Esse papel, se houver, ser√° desempenhado por circuitos internos de prote√ß√£o de carga e bateria. <br><br>  Se algu√©m quiser usar diodos Schottky separados, √© necess√°rio lev√°-los a uma corrente de pelo menos 5A e pelo menos um pouco fria, por exemplo, atrav√©s das faixas no quadro. <br><br><h1>  Circuito de notebook </h1><br><img src="https://habrastorage.org/webt/tz/lz/aw/tzlzawj3w4knkung90wa0vakney.jpeg"><br><br>  Mas havia outro problema: o laptop em si n√£o liga quando a tens√£o da rede el√©trica aparece.  <i>N√£o existe essa op√ß√£o no BIOS.</i>  <i>(Por algum motivo, muitos laptops n√£o possuem diversas fun√ß√µes √∫teis, por exemplo, ainda n√£o possuem inicializa√ß√£o a partir do cart√£o de mem√≥ria).</i> <br><br>  Embora essas interrup√ß√µes, a fim de descarregar completamente a bateria, praticamente n√£o ocorram, mas eu j√° queria terminar esta pergunta. <br><br>  No meu laptop, o bot√£o liga / desliga fecha a entrada do circuito para menos energia (a sua, provavelmente tamb√©m). <br><br>  Na mesma entrada, soldei o fio do conector do meu dispositivo. <br><br>  No dispositivo, essa entrada √© fechada por um transistor negativo, o laptop √© ligado. <br><br>  Para proteger o transistor em caso de conex√£o incorreta, um resistor R8 foi adicionado ao circuito coletor. <br><br>  Verifica-se que o laptop √© ligado de forma est√°vel, mesmo com um aumento de tr√™s vezes nesse resistor.  (Tamb√©m √© melhor verificar o seu laptop, pois os par√¢metros de entrada do bot√£o podem variar). <br><br>  Para controlar o transistor, um gerador de pulso RC foi feito em um chip CD4093 com gatilhos Schmitt e elementos R4, R5, C3.  A dura√ß√£o do pulso e pausa por cerca de 1 s, a precis√£o n√£o √© importante. <br><br>  √â importante que a opera√ß√£o do gerador comece com uma pausa. <br><br>  <i>E √© por isso que eu criei um gerador de pulsos: meu laptop √†s vezes n√£o ligava quando pressionava o bot√£o pela primeira vez, mas ligava quando pressionava o segundo, n√£o sei por qu√™.</i>  <i>De qualquer forma, resultou em uma solu√ß√£o universal e confi√°vel.</i> <br><br>  Quando o laptop est√° ligado, voc√™ n√£o precisa mais "pressionar" o bot√£o e paramos o gerador. <br><br>  O circuito aprende a ligar o laptop usando outro fio soldado a + 5V de qualquer conector USB. <br><br>  <i>Meu laptop apenas fornece + 5V a USB quando est√° ligado.</i> <i><br><br></i>  <i>(Se a sua voltagem USB estiver sempre presente quando alimentada pela rede, voc√™ dever√° desativar a op√ß√£o correspondente no BIOS ou procurar outro ponto de conex√£o para este sinal).</i> <br>  O microcircuito √© alimentado a partir da entrada de + 20V atrav√©s do estabilizador mais simples de R1 e VD3 e C2, apenas para proteger contra pulsos de energia. <br><br>  A energia deste circuito de + 5V USB tamb√©m foi produzida para que, quando a energia da rede el√©trica falhar, a energia do gerador n√£o diminua e forne√ßa pulsos falsos que possam desligar o laptop. <br><br>  Ambas as fontes de alimenta√ß√£o s√£o fornecidas ao microcircuito atrav√©s do circuito mais simples em dois diodos VD1, VD2, o mesmo que no roteador, apenas com uma pot√™ncia muito baixa. <br><br><h1>  Constru√ß√£o civil </h1><br><img src="https://habrastorage.org/webt/bg/i3/eb/bgi3ebghkos-hpssa5w7wrsrsie.jpeg"><br><br>  O conector √© de 10 pinos: PLD-10 + PBD-10, 2 fios em paralelo s√£o usados ‚Äã‚Äãnos fios de energia. <br><br>  Dos 4 restantes, dois s√£o ocupados pela entrada do bot√£o e + 5V USB, mais 2 n√£o s√£o usados. <br><br>  <i>A localiza√ß√£o dos contatos √© escolhida de forma que, se voc√™ ligar o conector na posi√ß√£o invertida, nada queimar√°, o roteador ser√° ligado e a fun√ß√£o de ligar o laptop n√£o funcionar√°.</i> <br><br>  O dispositivo √© montado em uma t√°bua de p√£o e colocado em um tubo termo-retr√°til. <br><br>  Nenhum resfriamento adicional √© necess√°rio. <br>  Voc√™ pode coloc√°-lo no compartimento onde estava a unidade de DVD. <br>  As pe√ßas podem ser substitu√≠das por an√°logos em uma faixa muito ampla. <br>  Eu n√£o dou uma foto geral, porque  laptops quebrados e todos viram. <br><br><h1>  O que aconteceu </h1><br><img src="https://habrastorage.org/webt/q0/ym/hx/q0ymhxprycrw8yq0wg_h-szf8ue.jpeg"><br><br>  Trabalha h√° um m√™s. <br><br>  O consumo de pelo menos 13 watts (medido por um medidor el√©trico), com o trabalho ativo aumenta para 25 watts. <br><br>  2 falhas de hardware foram detectadas: <br><br>  Falha n¬∫ 1: se voc√™ desligar o conector de carregamento do laptop, √†s vezes o laptop ser√° desligado instantaneamente. <br><br>  <i>Provavelmente, isso se deve ao fato de eu ter ligado o fio da carga no dispositivo diretamente na placa, e mesmo com + 5V USB e o fio do bot√£o.</i> <i><br><br></i>  <i>Quando voc√™ desconecta o conector de carregamento do fio, uma s√©rie de pulsos bastante √≠ngremes cai de +19 para + 12V e vice-versa, e mesmo com um ‚Äúressalto‚Äù, e isso atrav√©s da capacit√¢ncia dos fios pode interferir em outros circuitos de laptop.</i> <i><br><br></i>  <i>Por√©m, se voc√™ n√£o desconectar esse conector e desconectar o carregamento da rede, nada de ruim acontecer√°.</i>  <i>Aparentemente, a tens√£o no fio fica lenta devido aos capacitores no carregamento e a interfer√™ncia n√£o ocorre.</i> <br><br>  N√£o consertei a instala√ß√£o, mas, em geral, √© claro, n√£o vale a pena colocar os fios na placa de circuito como fiz.  De alguma forma, eles devem ser protegidos ou transportados para fora do laptop ou pelo menos afastados da placa.  (√â um pouco que o fato de todos os meus fios estarem com tens√£o constante). <br>  Adicionado capacitor C1 entre o sinal de menos e o sinal de mais, parece que a falha n√∫mero 1 desapareceu. <br><br>  Falha n¬∫ 2: o laptop n√£o p√¥de ser desligado com um bot√£o. <br><br>  Para desligar o laptop corretamente, primeiro desligue a fonte de alimenta√ß√£o (por precau√ß√£o, desconecte o carregamento da rede e n√£o do laptop, como j√° sabemos pela experi√™ncia anterior). <br>  E ent√£o pressionamos o bot√£o liga / desliga.  O sistema operacional desliga e desliga o laptop. <br><br>  MAS.  Neste momento, ainda h√° tens√£o nos capacitores de energia USB (na aus√™ncia de dispositivos consum√≠veis) no laptop, ele se senta lentamente e, em algum momento, o circuito d√° um impulso falso ao bot√£o e o laptop liga novamente! <br><br>  <i>Para evitar que isso aconte√ßa, foi adicionado um resistor R2, que consegue descarregar os capacitores em um segundo e tudo se tornou normal.</i>  <i>Se voc√™ tiver esse problema, a resist√™ncia dever√° ser reduzida por um fator de 2. N√£o vale a pena fazer o resistor muito baixo, porque</i>  <i>ele vai se aquecer.</i> <i><br><br></i>  <i>Isso praticamente n√£o adiciona consumo de energia.</i> <br><br><h1>  SO e programas </h1><br>  Eu instalei o servidor Ubuntu 14.04 e configurei o samba, tudo funciona e isso √© suficiente por enquanto. <br><br>  Havia as seguintes desvantagens: <br><br>  1) O ventilador do laptop era muito barulhento, independentemente da carga do processador. <br><br>  Eu tentei o programa fancontrol, mas ela n√£o conseguiu encontrar acesso ao controle do ventilador. <br>  No processo de escava√ß√£o na Internet, outro programa foi encontrado: asusfan, que pessoas gentis j√° fizeram especialmente para o meu modelo de laptop.  Funcionou imediatamente ap√≥s a compila√ß√£o e instala√ß√£o, e agora o ventilador √© regulado automaticamente e faz pouco barulho, e o recurso √© salvo. <br><br>  2) √â imposs√≠vel parar o disco r√≠gido durante a noite com o comando hdparm -S 241 / dev / sda. <br><br>  O programa de registro jbd2 o puxa a cada 5 a 10 minutos, mesmo quando nenhuma a√ß√£o √© tomada por uma hora. <br><br>  Os f√≥runs escrevem que este √© um problema irrecuper√°vel com o sistema de arquivos ext4 ou sua implementa√ß√£o no Ubuntu. <br><br>  Depois, tentarei mudar para xfs (ou talvez para SSD), mas por enquanto - "E assim vai!" (C). <br><br><h1>  Mais ideias (que permanecer√£o nesta fase) </h1><br><ul><li>  Fa√ßa um circuito independente em algum dispositivo como "GSM-relay" para reiniciar o sistema. </li><li>  Fa√ßa no mesmo dispositivo GSM um circuito para conectar remotamente uma unidade flash USB a um sistema de "backup" para que voc√™ possa inicializar a partir dele e corrigir alguma coisa na configura√ß√£o, se o sistema principal n√£o inicializar. </li></ul><br>  Por que via GSM, n√£o Ethernet? <br><br>  Em primeiro lugar, por causa das poss√≠veis vulnerabilidades dos controladores Ethernet, das quais ouvi falar em algum lugar. <br>  Em segundo lugar, pode ser necess√°rio reiniciar o roteador, ou seja,  precisa de um esquema independente. <br><br>  Mas os roteadores Mikrotik a esse respeito s√£o bastante confi√°veis ‚Äã‚Äãe, portanto, isso n√£o √© realmente necess√°rio, e o servidor tamb√©m parece estar funcionando sem perguntas. <br><br><h1>  Agradecimentos </h1><br>  O roteador me ajudou (em 99%) a configurar o camarada @rifei, pelo qual muito obrigado a ele. <br><br>  E tamb√©m para todos aqueles que escreveram instru√ß√µes na Internet, como ‚Äúcomo executar o programa no ubuntu 14.04‚Äù, etc., j√° que eu mesmo sou um bule de ch√° completo nisso, mas lendo 100500 essas instru√ß√µes, consegui configurar tudo. <br><br>  E separadamente - para aqueles que criaram e publicaram todos os tipos de programas √∫teis, mencionados e n√£o mencionados aqui. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt479488/">https://habr.com/ru/post/pt479488/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt479474/index.html">Por que a auto-organiza√ß√£o de equipes √© t√£o importante no Scrum e por que n√£o pode haver gerentes nele</a></li>
<li><a href="../pt479478/index.html">Plug-in Java sem problemas</a></li>
<li><a href="../pt479480/index.html">SARIF SDK e seus erros</a></li>
<li><a href="../pt479482/index.html">SARIF SDK e seus erros</a></li>
<li><a href="../pt479486/index.html">Programa√ß√£o heterog√™nea e oneAPI Toolkit. Palestra improvisada de especialistas da Intel responde √†s suas perguntas</a></li>
<li><a href="../pt479492/index.html">Computa√ß√£o sem servidor baseada no OpenWhisk, parte 3</a></li>
<li><a href="../pt479496/index.html">Analisando tarefas WTF em JavaScript</a></li>
<li><a href="../pt479498/index.html">Como o tempo linear se transforma no Windows em O (n¬≤)</a></li>
<li><a href="../pt479502/index.html">Como sobreviver √† era glacial mais severa da hist√≥ria da Terra?</a></li>
<li><a href="../pt479504/index.html">Criar um Thin Client RDP baseado em Raspberry Pi</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>