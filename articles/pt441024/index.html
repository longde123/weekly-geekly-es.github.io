<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë∏üèª ‚úçüèæ üçñ Escrevemos um rastreador para um ou dois 1.0 ü•É üëí üòì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Um rastreador da Web (ou web spider) √© uma parte importante dos mecanismos de pesquisa para rastrear p√°ginas da Web, a fim de inserir informa√ß√µes sobr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Escrevemos um rastreador para um ou dois 1.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/semrush/blog/441024/">  Um <b>rastreador da</b> Web (ou web spider) √© uma parte importante dos mecanismos de pesquisa para rastrear p√°ginas da Web, a fim de inserir informa√ß√µes sobre eles nos bancos de dados, principalmente para indexa√ß√£o posterior.  Os mecanismos de pesquisa (Google, Yandex, Bing), bem como os produtos de SEO (SEMrush, MOZ, ahrefs), e n√£o apenas t√™m isso.  E isso √© bastante interessante: tanto em termos de casos potenciais quanto de uso, e para implementa√ß√£o t√©cnica. <br><br><img src="https://habrastorage.org/webt/vw/pi/-9/vwpi-9jp8-dypdtmlh58qqa1nm0.jpeg"><br><br>  Com este artigo, come√ßaremos a criar <b>iterativamente</b> nossa <s>bicicleta de</s> esteira, analisando muitos recursos e atendendo √†s armadilhas.  De uma simples fun√ß√£o recursiva a um servi√ßo escal√°vel e extens√≠vel.  Deve ser interessante! <br><a name="habracut"></a><br><h3>  Introdu√ß√£o </h3><br>  Iterativamente - significa que ao final de cada vers√£o √© esperada uma vers√£o pronta para uso do "produto", com as limita√ß√µes, recursos e interface acordados. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Node.js</a> e <b>JavaScript foram</b> escolhidos como plataforma e idioma, por serem simples e ass√≠ncronos.  Obviamente, para o desenvolvimento industrial, a escolha da base tecnol√≥gica deve se basear nos requisitos, expectativas e recursos do neg√≥cio.  Como demonstra√ß√£o e prot√≥tipo, esta plataforma √© completamente nada (IMHO). <br><br><blockquote>  Este √© o meu rastreador.  Existem muitos rastreadores, mas este √© meu. <br>  Meu rastreador √© meu melhor amigo. <br></blockquote><br>  A implementa√ß√£o do rastreador √© uma tarefa bastante popular e pode ser encontrada mesmo em entrevistas t√©cnicas.  H√° realmente muitas solu√ß√µes prontas ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Apache Nutch</a> ) e auto-escritas para diferentes condi√ß√µes e em v√°rios idiomas.  Portanto, quaisquer coment√°rios da experi√™ncia pessoal em desenvolvimento ou uso s√£o bem-vindos e ser√£o interessantes. <br><br><h3>  Declara√ß√£o do problema </h3><br>  A tarefa para a primeira implementa√ß√£o (inicial) do nosso rastreador <s>tyap-blooper</s> ser√° a seguinte: <br><br><blockquote>  <b>Um-dois rastreador 1.0</b> <br>  Escreva um script de rastreador que ignore os links internos <i>&lt;a href /&gt;</i> de um site pequeno (at√© 100 p√°ginas).  Como resultado, forne√ßa uma lista de URLs de p√°ginas com os c√≥digos recebidos e um mapa de seus links.  As regras <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">robots.txt</a> e o atributo do link <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">rel = nofollow</a> s√£o ignorados. </blockquote><br>  <b>Aten√ß√£o!</b>  Ignorar as regras do <i>robots.txt</i> √© uma m√° ideia por raz√µes √≥bvias.  Iremos compensar essa omiss√£o no futuro.  Enquanto isso, adicione o par√¢metro limit que limita o n√∫mero de p√°ginas a serem rastreadas para que n√£o pare o DoS e tente o site experimental (√© melhor usar o seu pr√≥prio "site de hamster" pessoal para experi√™ncias). <br><br><h3>  Implementa√ß√£o </h3><br>  Para os impacientes, <a href="">aqui est√£o as fontes</a> desta solu√ß√£o. <br><br><ol><li>  Cliente HTTP (S) </li><li>  Op√ß√µes de resposta </li><li>  Extra√ß√£o de link </li><li>  Prepara√ß√£o e filtragem de links </li><li>  Normaliza√ß√£o de URL </li><li>  Algoritmo da fun√ß√£o principal </li><li>  Resultado de retorno </li></ol><br><h4>  1. Cliente HTTP (S) </h4><br>  A primeira coisa que precisamos fazer √©, de fato, enviar solicita√ß√µes e receber respostas via HTTP e HTTPS.  No node.js, existem dois clientes correspondentes para isso.  Obviamente, voc√™ pode atender a uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">solicita√ß√£o de cliente pronta</a> , mas para nossa tarefa √© extremamente redundante: basta enviar uma solicita√ß√£o GET e obter uma resposta com o corpo e os cabe√ßalhos. <br><br>  A API dos dois clientes que precisamos √© id√™ntica, vamos obter um mapa: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> clients = { <span class="hljs-string"><span class="hljs-string">'http:'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>), <span class="hljs-string"><span class="hljs-string">'https:'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'https'</span></span>) };</code> </pre> <br>  Declaramos uma <i>busca de</i> fun√ß√£o simples, cujo √∫nico par√¢metro ser√° o URL <b>absoluto</b> da cadeia de recursos da web desejada.  Usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">o m√≥dulo url,</a> analisaremos a sequ√™ncia resultante em um objeto de URL.  Este objeto possui um campo com o protocolo (com dois pontos), pelo qual escolheremos o cliente apropriado: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dst</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dstURL = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(dst); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> client = clients[dstURL.protocol]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'Could not select a client for '</span></span> + dstURL.protocol); } <span class="hljs-comment"><span class="hljs-comment">// ... }</span></span></code> </pre><br>  Em seguida, use o cliente selecionado e agrupe o resultado da fun√ß√£o de <i>busca</i> em uma promessa: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dst</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve, reject</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// ... let req = client.get(dstURL.href, res =&gt; { // do something with the response }); req.on('error', err =&gt; reject('Failed on the request: ' + err.message)); req.end(); }); }</span></span></code> </pre><br><br>  Agora podemos receber resposta de forma ass√≠ncrona, mas por enquanto n√£o estamos fazendo nada com ela. <br><br><h4>  2. Op√ß√µes de resposta </h4><br>  Para rastrear o site, basta processar tr√™s op√ß√µes de resposta: <br><br><ol><li>  <b>OK</b> - Um c√≥digo de status 2xx foi recebido.  √â necess√°rio salvar o corpo da resposta como resultado para processamento adicional - extra√ß√£o de novos links. </li><li>  <b>REDIRECIONAR</b> - Um c√≥digo de status 3xx foi recebido.  Este √© um redirecionamento para outra p√°gina.  Nesse caso, precisaremos do cabe√ßalho de resposta da <i>localiza√ß√£o</i> , de onde pegaremos um √∫nico link "de sa√≠da". </li><li>  <b>NO_DATA</b> - Todos os outros casos: 4xx / 5xx e 3xx sem o cabe√ßalho <i>Location</i> .  N√£o h√° para onde ir al√©m do nosso rastreador. </li></ol><br>  A fun√ß√£o de <i>busca</i> resolver√° a resposta processada, indicando seu tipo: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ft = { <span class="hljs-string"><span class="hljs-string">'OK'</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">// code (2xx), content 'REDIRECT': 2, // code (3xx), location 'NO_DATA': 3 // code };</span></span></code> </pre><br>  Implementa√ß√£o da estrat√©gia de gerar o resultado nas melhores tradi√ß√µes do <i>if-else</i> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> code = res.statusCode; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> codeGroup = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(code / <span class="hljs-number"><span class="hljs-number">100</span></span>); <span class="hljs-comment"><span class="hljs-comment">// OK if (codeGroup === 2) { let body = []; res.setEncoding('utf8'); res.on('data', chunk =&gt; body.push(chunk)); res.on('end', () =&gt; resolve({ code, content: body.join(''), type: ft.OK })); } // REDIRECT else if (codeGroup === 3 &amp;&amp; res.headers.location) { resolve({ code, location: res.headers.location, type: ft.REDIRECT }); } // NO_DATA (others) else { resolve({ code, type: ft.NO_DATA }); }</span></span></code> </pre><br>  A fun√ß√£o de <i>busca</i> est√° pronta para uso: <a href="">todo o c√≥digo da fun√ß√£o</a> . <br><br><h4>  3. Extra√ß√£o de links </h4><br>  Agora, dependendo da variante da resposta recebida, voc√™ precisa extrair links dos dados do resultado da <i>busca</i> para rastreamento adicional.  Para fazer isso, definimos a fun√ß√£o <i>extrair</i> , que pega um objeto de resultado como entrada e retorna uma matriz de novos links. <br><br>  Se o tipo de resultado for REDIRECIONAR, a fun√ß√£o retornar√° uma matriz com uma √∫nica refer√™ncia do campo de <i>localiza√ß√£o</i> .  Se NO_DATA, uma matriz vazia.  Se estiver bem, precisamos conectar o analisador do <i>conte√∫do de</i> texto apresentado para pesquisa. <br><br>  Para a tarefa de pesquisa <i>&lt;a href /&gt;,</i> voc√™ tamb√©m pode escrever uma express√£o regular.  Mas essa solu√ß√£o n√£o √© escal√°vel, j√° que no futuro prestaremos aten√ß√£o, no m√≠nimo, a outros atributos ( <i>rel</i> ) do link, no m√°ximo, pensaremos em <i>img</i> , <i>link</i> , <i>script</i> , <i>√°udio / v√≠deo</i> ( <i>fonte</i> ) e outros recursos.  √â muito mais promissor e mais conveniente analisar o texto do documento e criar uma √°rvore de seus n√≥s para ignorar os seletores comuns. <br><br>  Usaremos a popular biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">JSDOM</a> para trabalhar com o DOM no node.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { JSDOM } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'jsdom'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> <span class="hljs-built_in"><span class="hljs-built_in">document</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSDOM(fetched.content).window.document; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> elements = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByTagName(<span class="hljs-string"><span class="hljs-string">'A'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.from(elements) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">el</span></span></span><span class="hljs-function"> =&gt;</span></span> el.getAttribute(<span class="hljs-string"><span class="hljs-string">'href'</span></span>)) .filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">href</span></span></span><span class="hljs-function"> =&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> href === <span class="hljs-string"><span class="hljs-string">'string'</span></span>) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">href</span></span></span><span class="hljs-function"> =&gt;</span></span> href.trim()) .filter(<span class="hljs-built_in"><span class="hljs-built_in">Boolean</span></span>);</code> </pre><br>  Obtemos todos os elementos <i>A</i> do documento e, em seguida, todos os valores filtrados do atributo <i>href</i> , se n√£o linhas vazias. <br><br><h4>  4. Prepara√ß√£o e filtragem de links </h4><br>  Como resultado do extrator, temos um conjunto de links (URL) e dois problemas: 1) o URL pode ser relativo e 2) o URL pode levar a um recurso externo (precisamos apenas de recursos internos agora). <br><br>  O primeiro problema ser√° ajudado pela fun√ß√£o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">url.resolve</a> , que resolve o URL da p√°gina de destino em rela√ß√£o ao URL da p√°gina de origem. <br><br>  Para resolver o segundo problema, escrevemos uma fun√ß√£o de utilit√°rio simples <i>inScope</i> que verifica o host da p√°gina de destino com o host do URL base do rastreamento atual: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLowerHost</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dst</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(dst)).hostname.toLowerCase(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">inScope</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dst, base</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dstHost = getLowerHost(dst); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> baseHost = getLowerHost(base); <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> i = dstHost.indexOf(baseHost); <span class="hljs-comment"><span class="hljs-comment">// the same domain or has subdomains return i === 0 || dstHost[i - 1] === '.'; }</span></span></code> </pre><br>  A fun√ß√£o procura uma substring ( <i>baseHost</i> ) com uma verifica√ß√£o do caractere anterior, se a substring for encontrada: como <i>wwwexample.com</i> e <i>example.com</i> s√£o dom√≠nios diferentes.  Como resultado, n√£o deixamos o dom√≠nio especificado, mas ignoramos seus subdom√≠nios. <br><br>  Refinamos a fun√ß√£o <i>extrair</i> adicionando "absolutiza√ß√£o" e filtrando os links resultantes: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">extract</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">fetched, src, base</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> extractRaw(fetched) .map(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">href</span></span></span><span class="hljs-function"> =&gt;</span></span> url.resolve(src, href)) .filter(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dst</span></span></span><span class="hljs-function"> =&gt;</span></span> /^https?\:\/\<span class="hljs-comment"><span class="hljs-comment">//i.test(dst)) .filter(dst =&gt; inScope(dst, base)); }</span></span></code> </pre><br>  Aqui <i>buscado</i> √© o resultado da fun√ß√£o de <i>busca</i> , <i>src</i> √© o URL da p√°gina de origem, <i>base</i> √© o URL de base do rastreamento.  Na sa√≠da, obtemos uma lista de links internos (URLs) j√° absolutos para processamento adicional.  Todo o c√≥digo da fun√ß√£o pode ser <a href="">visto aqui</a> . <br><br><h4>  5. Normaliza√ß√£o de URL </h4><br>  Depois de encontrar qualquer URL novamente, n√£o h√° necessidade de enviar outra solicita√ß√£o para o recurso, pois os dados j√° foram recebidos (ou outra conex√£o ainda est√° aberta e aguardando uma resposta).  Mas nem sempre √© suficiente comparar as sequ√™ncias de dois URLs para entender isso.  A normaliza√ß√£o √© o procedimento necess√°rio para determinar a equival√™ncia de URLs sintaticamente diferentes. <br><br>  O processo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">normaliza√ß√£o</a> √© um conjunto inteiro de transforma√ß√µes aplicadas ao URL de origem e seus componentes.  Aqui est√£o apenas alguns deles: <br><br><ul><li>  O esquema e o host n√£o diferenciam mai√∫sculas de min√∫sculas; portanto, eles devem ser convertidos para mais baixos. </li><li>  Todas as porcentagens (como "% 3A") devem estar em mai√∫sculas. </li><li>  A porta padr√£o (80 para HTTP) pode ser removida. </li><li>  O fragmento ( <i>#</i> ) nunca √© vis√≠vel para o servidor e tamb√©m pode ser exclu√≠do. </li></ul><br>  Voc√™ sempre pode pegar algo pronto (por exemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">normalizar-url</a> ) ou escrever sua pr√≥pria fun√ß√£o simples, cobrindo os casos mais importantes e comuns: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">normalize</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">dst</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> dstUrl = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(dst); <span class="hljs-comment"><span class="hljs-comment">// ignore userinfo (auth property) let origin = dstUrl.protocol + '//' + dstUrl.hostname; // ignore http(s) standart ports if (dstUrl.port &amp;&amp; (!/^https?\:/i.test(dstUrl.protocol) || ![80, 8080, 443].includes(+dstUrl.port))) { origin += ':' + dstUrl.port; } // ignore fragment (hash property) let path = dstUrl.pathname + dstUrl.search; // convert origin to lower case return origin.toLowerCase() // and capitalize letters in escape sequences + path.replace(/%([0-9a-f]{2})/ig, (_, es) =&gt; '%' + es.toUpperCase()); }</span></span></code> </pre><br><div class="spoiler">  <b class="spoiler_title">Apenas no caso, o formato do objeto URL</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/zs/te/jr/zstejr_mjpparhgrr4aar6ma7nq.png"><br></div></div><br>  Sim, n√£o h√° classifica√ß√£o dos par√¢metros de consulta, ignorando as tags utm, processando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">_escaped_fragment_</a> e outras coisas, das quais (absolutamente) n√£o precisamos. <br><br>  Em seguida, criaremos um cache local de URLs normalizados solicitados pela estrutura de rastreamento.  Antes de enviar a pr√≥xima solicita√ß√£o, normalizamos a URL recebida e, se ela n√£o estiver no cache, adicione-a e s√≥ ent√£o envie uma nova solicita√ß√£o. <br><br><h4>  6. O algoritmo da fun√ß√£o principal </h4><br>  Os principais componentes (primitivos) da solu√ß√£o est√£o prontos, √© hora de come√ßar a coletar tudo juntos.  Para come√ßar, vamos determinar a assinatura da fun√ß√£o de <i>rastreamento</i> : na entrada, o URL inicial e o limite de p√°ginas.  A fun√ß√£o retorna uma promessa cuja resolu√ß√£o fornece um resultado acumulado;  escreva-o no arquivo de <i>sa√≠da</i> : <br><br><pre> <code class="javascript hljs">crawl(start, limit).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function"> =&gt;</span></span> { fs.writeFile(output, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(result), <span class="hljs-string"><span class="hljs-string">'utf8'</span></span>, err =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> err; }); });</code> </pre><br>  O fluxo de trabalho recursivo mais simples da fun√ß√£o de rastreamento pode ser descrito nas etapas: <br><br><blockquote>  1. Inicializa√ß√£o do cache e do objeto de resultado <br>  2. Se o URL da p√°gina de destino (via <b>normalizar</b> ) n√£o estiver no cache, ENT√ÉO <br>  2.1.  Se o <i>limite for</i> atingido, END (aguarde pelo resultado) <br>  2.2.  Adicionar URL ao cache <br>  2.3.  Salvar link entre a origem e a p√°gina de destino no resultado <br>  2.4.  Enviar solicita√ß√£o ass√≠ncrona por p√°gina ( <b>busca</b> ) <br>  - 2.5  Se a solicita√ß√£o for bem-sucedida, ENT√ÉO <br>  - 2.5.1.  Extrair novos links do resultado ( <b>extrair</b> ) <br>  - - 2.5.2.  Para cada novo link, execute o algoritmo 2-3 <br>  - 2.6  ELSE marcar a p√°gina como um erro <br>  - 2.7  Salvar dados da p√°gina no resultado <br>  - 2.8  Se essa foi a √∫ltima p√°gina, traga o resultado <br>  3. ELSE salve o link entre a fonte e a p√°gina de destino no resultado <br></blockquote><br>  <b>Sim, este algoritmo passar√° por grandes mudan√ßas no futuro.</b>  Agora, uma solu√ß√£o recursiva √© usada deliberadamente na testa, para que mais tarde seja melhor ‚Äúsentir‚Äù a diferen√ßa nas implementa√ß√µes.  A pe√ßa de trabalho para a implementa√ß√£o da fun√ß√£o √© assim: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crawl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">start, limit = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">100</span></span></span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// initialize cache &amp; result return new Promise((resolve, reject) =&gt; { function curl(src, dst) { // check dst in the cache &amp; pages limit // save the link (src -&gt; dst) to the result fetch(dst).then(fetched =&gt; { extract(fetched, dst, start).forEach(ln =&gt; curl(dst, ln)); }).finally(() =&gt; { // save the page's data to the result // check completion and resolve the result }); } curl(null, start); }); }</span></span></code> </pre><br>  A conquista do limite de p√°ginas √© verificada por um simples contador de solicita√ß√µes.  O segundo contador - o n√∫mero de solicita√ß√µes ativas de cada vez - servir√° como um teste de prontid√£o para fornecer o resultado (quando o valor voltar a zero).  Se a fun√ß√£o de <i>busca</i> n√£o puder acessar a pr√≥xima p√°gina, defina o C√≥digo de Status para ele como nulo. <br><br>  Voc√™ pode (opcionalmente) <a href="">se familiarizar</a> com o c√≥digo de implementa√ß√£o <a href="">aqui</a> , mas antes disso, considere o formato do resultado retornado. <br><br><h4>  7. resultado retornado </h4><br>  Introduziremos um <i>identificador de</i> identifica√ß√£o exclusivo com um incremento simples para as p√°ginas pesquisadas: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> id = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> cache = {}; <span class="hljs-comment"><span class="hljs-comment">// ... let dstNorm = normalize(dst); if (dstNorm in cache === false) { cache[dstNorm] = ++id; // ... }</span></span></code> </pre><br>  Para o resultado, vamos criar uma matriz de <i>p√°ginas</i> , na qual adicionaremos objetos com dados na p√°gina: <i>id</i> {number}, <i>url</i> {string} e <i>c√≥digo</i> {number | null} (agora √© suficiente).  Tamb√©m criamos uma matriz de <i>links</i> para links entre p√°ginas na forma de um objeto: <i>de</i> ( <i>ID da</i> p√°gina de origem) <i>a</i> ( <i>ID da</i> p√°gina de destino). <br><br>  Para fins informativos, antes de resolver o resultado, classificamos a lista de p√°ginas em ordem crescente de <i>id</i> (afinal, as respostas vir√£o em qualquer ordem), complementamos o resultado com o n√∫mero de p√°ginas de <i>contagem</i> digitalizadas e um sinalizador para atingir o limite de <i>aletas</i> especificado: <br><br><pre> <code class="javascript hljs">resolve({ <span class="hljs-attr"><span class="hljs-attr">pages</span></span>: pages.sort(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">p1, p2</span></span></span><span class="hljs-function">) =&gt;</span></span> p1.id - p2.id), <span class="hljs-attr"><span class="hljs-attr">links</span></span>: links.sort(<span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">l1, l2</span></span></span><span class="hljs-function">) =&gt;</span></span> l1.from - l2.from || l1.to - l2.to), count, <span class="hljs-attr"><span class="hljs-attr">fin</span></span>: count &lt; limit });</code> </pre><br><h3>  Exemplo de uso </h3><br>  O script do rastreador finalizado possui a seguinte sinopse: <br><br><pre> <code class="plaintext hljs">node crawl-cli.js --start="&lt;URL&gt;" [--output="&lt;filename&gt;"] [--limit=&lt;int&gt;]</code> </pre><br>  Complementando o registro dos pontos principais do processo, veremos uma imagem na inicializa√ß√£o: <br><br><pre> <code class="plaintext hljs">$ node crawl-cli.js --start="https://google.com" --limit=20 [2019-02-26T19:32:10.087Z] Start crawl "https://google.com" with limit 20 [2019-02-26T19:32:10.089Z] Request (#1) "https://google.com/" [2019-02-26T19:32:10.721Z] Fetched (#1) "https://google.com/" with code 301 [2019-02-26T19:32:10.727Z] Request (#2) "https://www.google.com/" [2019-02-26T19:32:11.583Z] Fetched (#2) "https://www.google.com/" with code 200 [2019-02-26T19:32:11.720Z] Request (#3) "https://play.google.com/?hl=ru&amp;tab=w8" [2019-02-26T19:32:11.721Z] Request (#4) "https://mail.google.com/mail/?tab=wm" [2019-02-26T19:32:11.721Z] Request (#5) "https://drive.google.com/?tab=wo" ... [2019-02-26T19:32:12.929Z] Fetched (#11) "https://www.google.com/advanced_search?hl=ru&amp;authuser=0" with code 200 [2019-02-26T19:32:13.382Z] Fetched (#19) "https://translate.google.com/" with code 200 [2019-02-26T19:32:13.782Z] Fetched (#14) "https://plus.google.com/108954345031389568444" with code 200 [2019-02-26T19:32:14.087Z] Finish crawl "https://google.com" on count 20 [2019-02-26T19:32:14.087Z] Save the result in "result.json"</code> </pre><br>  E aqui est√° o resultado no formato JSON: <br><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"pages"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://google.com/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">301</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://www.google.com/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://play.google.com/?hl=ru&amp;tab=w8"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">302</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://mail.google.com/mail/?tab=wm"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">302</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://drive.google.com/?tab=wo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">302</span></span> }, // ... { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://translate.google.com/"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-attr"><span class="hljs-attr">"url"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://calendar.google.com/calendar?tab=wc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"code"</span></span>: <span class="hljs-number"><span class="hljs-number">302</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"links"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> }, // ... { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span> }, { <span class="hljs-attr"><span class="hljs-attr">"from"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-attr"><span class="hljs-attr">"to"</span></span>: <span class="hljs-number"><span class="hljs-number">8</span></span> } ], <span class="hljs-attr"><span class="hljs-attr">"count"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-attr"><span class="hljs-attr">"fin"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }</code> </pre><br><br>  O que pode ser feito com isso j√°?  No m√≠nimo, a lista de p√°ginas voc√™ pode encontrar todas as p√°ginas quebradas do site.  E, com informa√ß√µes sobre links internos, √© poss√≠vel detectar longas cadeias (e loops fechados) de redirecionamentos ou encontrar as p√°ginas mais importantes por massa de refer√™ncia. <br><br><h3>  An√∫ncio 2.0 </h3><br>  Obtivemos uma variante do rastreador de console mais simples, que ignora as p√°ginas de um site.  O c√≥digo fonte <a href="">est√° aqui</a> .  H√° tamb√©m um exemplo e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">testes de unidade</a> para algumas fun√ß√µes. <br><br>  Agora, este √© um remetente sem cerim√¥nia de pedidos e o pr√≥ximo passo razo√°vel seria ensinar-lhe boas maneiras.  Ser√° sobre o cabe√ßalho do <i>agente</i> do <i>usu√°rio</i> , regras <i>robots.txt</i> , diretiva de <i>atraso de rastreamento</i> e muito mais.  Do ponto de vista da implementa√ß√£o, isso √© antes de tudo enfileirar mensagens e, em seguida, atender a uma carga maior.  <i>Se, √© claro, este material ser√° interessante!</i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt441024/">https://habr.com/ru/post/pt441024/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt441012/index.html">Fatos interessantes sobre a hist√≥ria do programa lunar chin√™s e a miss√£o espacial Chang'e-4</a></li>
<li><a href="../pt441014/index.html">Renderiza√ß√£o est√©reo de baixo or√ßamento em poucas linhas de c√≥digo (estereograma, anaglyph, estereosc√≥pio)</a></li>
<li><a href="../pt441018/index.html">Ferramentas de desenvolvimento e especifica√ß√£o do programa NanoCAD Mechanics</a></li>
<li><a href="../pt441020/index.html">Como o VTB chegou a um √∫nico conhecimento</a></li>
<li><a href="../pt441022/index.html">Erros comuns de passageiros de ferrovias e companhias a√©reas</a></li>
<li><a href="../pt441026/index.html">VMware NSX para o menor. Parte 2. Configurando Firewall e NAT</a></li>
<li><a href="../pt441028/index.html">Como os pesquisadores descobrem os bancos de dados abertos do MongoDB e Elasticsearch</a></li>
<li><a href="../pt441030/index.html">Detectando ataques da Web com um autoencodificador Seq2Seq</a></li>
<li><a href="../pt441032/index.html">KeeBee Criando seu pr√≥prio teclado USB a partir do zero</a></li>
<li><a href="../pt441034/index.html">6 pontos de crescimento de convers√µes ou como aumentar a confian√ßa usando um telefone no site</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>