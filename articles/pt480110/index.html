<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëãüèΩ üëåüèº üèÇ uMCPIno: Escrevendo um protocolo simples com entrega garantida para o Arduino üë©üèº‚Äçüåæ üë© üí™üèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sauda√ß√µes, queridos! 
 Em algum momento de sua vida, cada caixa teimosa e teimosa deixa de sentir falta do Kantian Arduino como "coisas em si mesmas" ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>uMCPIno: Escrevendo um protocolo simples com entrega garantida para o Arduino</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/480110/"><h3>  Sauda√ß√µes, queridos! </h3><br>  Em algum momento de sua vida, cada caixa teimosa e teimosa deixa de sentir falta do Kantian Arduino como "coisas em si mesmas" <s>que simplesmente n√£o podem!</s>  : Piscando o LED, pegando dados dos sensores e transferindo-os pelo fio para o PC √© certamente divertido, mas o Santo Graal est√° em mobilidade, em liberta√ß√£o das ‚Äúliga√ß√µes de cobre‚Äù, em verdadeira liberdade entre as ondas do √©ter universal. <br>  √â aqui que a dura realidade dos canais de comunica√ß√£o inst√°veis, erros de transmiss√£o e mensagens n√£o entregues se abre para n√≥s. <br>  Deus pro√≠be reivindicar originalidade nesta √°rea: a humanidade h√° muito tempo usa muitos protocolos para todas as ocasi√µes. <br>  Mas nosso objetivo √© aprender e, como sou um fervoroso defensor do reconhecimento em combate, estudaremos inventando nosso pr√≥prio protocolo ‚Äúbicicleta‚Äù. <br>  Hoje, proponho desenvolver um protocolo que garanta entrega garantida, integridade e sequ√™ncia de mensagens entre dois assinantes (ponto a ponto, ponto a ponto), saiba como e aplique o algoritmo <a href="https://en.wikipedia.org/wiki/Nagle%2527s_algorithm" rel="nofollow">Nagle</a> e o <a href="https://en.wikipedia.org/wiki/Protocol_pipelining" rel="nofollow">pipelining de protocolo</a> , seja l√° o que isso signifique.  Ao mesmo tempo, ele deve ter uma <a href="https://en.wikipedia.org/wiki/Overhead_(computing)" rel="nofollow">sobrecarga</a> m√≠nima e apertar at√© o apertado UNO do Arduino. <br><br><img src="https://habrastorage.org/webt/jt/7a/_b/jt7a_bc6uynr5uu08ab3plyuucq.png"><br><br>  Pe√ßo a todos os interessados ‚Äã‚Äãa bordo, fechamos as escotilhas, abrimos as pedras do rei, enchemos os tanques de lastro.  Temos uma excurs√£o ao passado, destino: ano 1974! <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Para os impacientes (eu mesmo sou assim!)</b> <div class="spoiler_text">  Aqui est√° o reposit√≥rio do github onde est√£o as implementa√ß√µes: <br><ul><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/Arduino" rel="nofollow">Para arduino</a> </li><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/STM32" rel="nofollow">Para STM32</a> </li><li>  <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/CSharp" rel="nofollow">Para PC (C #)</a> </li></ul><br></div></div><br>  De acordo com a boa e velha tradi√ß√£o, pelo menos dois especialistas reconhecidos neste campo est√£o envolvidos na descri√ß√£o de algoritmos e protocolos criptogr√°ficos, se algu√©m n√£o os conhece, familiarize-se: <br><div class="spoiler">  <b class="spoiler_title">Alice</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/fb4/6f4/f08/fb46f4f081e1affbfba68c39dcbc7768.jpg" alt="imagem"><br></div></div><br>  E <br><div class="spoiler">  <b class="spoiler_title">Bob</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/048/a75/668/048a75668215c8147df3f5720f283899.jpg" alt="imagem"><br></div></div><br><br><h3>  Primeiro, descrevemos uma tarefa simples </h3><br>  Alice e Bob est√£o sentados em trincheiras adjacentes e n√£o podem levantar a cabe√ßa para se ver.  Eles podem falar apenas em voz alta, ao lado deles as balas apitam e os proj√©teis explodem, afogando seus gritos e, al√©m disso, quando um deles fala, voc√™ precisa gritar para n√£o ouvir nada. <br>  A situa√ß√£o √© complicada pelo fato de eles estarem sendo ouvidos pelos inimigos - e voc√™ precisa usar uma linguagem de c√≥digo, por algum motivo que consiste em longas sequ√™ncias de n√∫meros. <br>  Como Alice e Bob s√£o pessoas, eles periodicamente precisam sair para comer ou ir ao banheiro, e s√£o t√£o impacientes que podem ficar impacientes no momento mais inoportuno! <br><br><h3>  Como e por que estabelecer uma conex√£o? </h3><br>  Como podemos organizar uma transfer√™ncia de dados confi√°vel em uma situa√ß√£o t√£o deprimente, quando parece que tudo est√° simplesmente fadado ao fracasso? <br><br>  A primeira solu√ß√£o que pode surgir √© usar frases de c√≥digo com <s>palavras de parada</s> para iniciar e terminar a transfer√™ncia. <br><br>  Bem, digamos que, se Alice quiser enviar uma mensagem, ela precisa gritar "Comece a transmiss√£o!" E espere at√© Bob responder "Comece a recep√ß√£o!". <br>  Se Alice n√£o esperar pela resposta de Bob, ela simplesmente repetir√° sua solicita√ß√£o para iniciar a transfer√™ncia.  Naturalmente, voc√™ n√£o deve fazer isso com muita frequ√™ncia; caso contr√°rio, como sabemos, voc√™ simplesmente n√£o ouve a resposta de Bob. <br><br>  √ìtimo.  Mas o que acontece se Alice em resposta ouvir da pr√≥xima trincheira, "Come√ßar a transmiss√£o!"? <br>  Acontece que Bob tamb√©m decidiu transferir algumas informa√ß√µes importantes agora.  Alice tem um car√°ter moderado, e ela pode ter pensado: "Ok, vou esperar, minha mensagem √©, em princ√≠pio, n√£o urgente, deixe Bob passar primeiro."  Pensando nisso, ela responde: "Comece a recep√ß√£o!". <br><br>  Como <s>em tempo de guerra o valor do seno pode chegar a quatro, a</s> velocidade do som √© finita e leva algum tempo para compreender o que Alice e Bob ouviram, e at√© Bob, como cavalheiro, pode decidir ceder √† dama, ele d√° de ombros e grita: "Estou come√ßando a receber!" <br><br>  Para ilustrar a indigna√ß√£o, usaremos gr√°ficos de tempo.  O tempo passa para eles. <br><br>  O caso em que Alice e Bob n√£o chegaram a acordo sobre o prazo: <br><img src="https://habrastorage.org/webt/cz/ye/hn/czyehnoehw9e3wnxveaiwvef5ok.png"><br><br>  O caso em que a mensagem foi perdida: <br><img src="https://habrastorage.org/webt/5u/yk/md/5uykmdq7sxiagt-5twd3uhpnxas.png"><br><br>  Isso √© um fiasco.  Tudo fica confuso demais e √© agravado pelo fato de o destinat√°rio poder ouvir ou n√£o ouvir alguma das frases e, em cada caso, o interlocutor n√£o sabe se sua mensagem foi ouvida pelo destinat√°rio. <br><br>  Agora, Alice e Bob est√£o esperando um bem-vindo.  Seria l√≥gico perceber que ocorreu um conflito e algu√©m precisa retomar a transmiss√£o.  Mas e se tudo acontecer novamente de uma nova maneira?  E aqui estamos novamente onde come√ßamos. <br><br>  Se voc√™ acha que a situa√ß√£o √© extremamente rara, lembre-se da √∫ltima vez em que voc√™ conversou com algu√©m por voz, quando seu assinante ou voc√™ (ou ambos) tiver uma conex√£o lenta √† Internet.  "Ol√°, ol√°, ol√°, voc√™ desaparece."  "Voc√™ n√£o pode ouvir ol√°, ol√°." <br><br>  Enquanto isso, nas trincheiras, a situa√ß√£o est√° esquentando, os comandantes exigem a transmiss√£o de relat√≥rios. <br>  √â hora <s>de recorrer √†s fontes principais: para estudar Marx, Engels</s> retornar√° mais de 40 anos atr√°s e ver√° como esses problemas foram resolvidos pelos engenheiros da <a href="https://en.wikipedia.org/wiki/Digital_Equipment_Corporation" rel="nofollow">DEC</a> ao projetar o protocolo <a href="https://en.wikipedia.org/wiki/Digital_Data_Communications_Message_Protocol" rel="nofollow">DDCMP</a> . <br><br>  Segundo os desenvolvedores do DDCMP, Alice e Bob precisam rejeitar emo√ß√µes e se tornarem <a href="https://en.wikipedia.org/wiki/Finite-state_machine" rel="nofollow">m√°quinas de estado finito</a> . <br>  Isso significa que, a partir de agora, nossa Alice e Bob ter√£o apenas alguns estados fixos, as transi√ß√µes entre esses estados poder√£o ocorrer estritamente de acordo com certas regras quando certos eventos ocorrerem. <br><br>  Primeiro, simplesmente listamos os estados: <br><br><ul><li>  Interrompido </li><li>  IN√çCIO INICIAL </li><li>  IN√çCIO RECONHECIDO </li><li>  EXECUTANDO </li></ul><br><br>  Como voc√™ pode ver, existem apenas quatro deles.  E agora, n√£o importa o que aconte√ßa, cada um dos assinantes sabe ao menos com certeza que o seu vis-√†-vis est√° em apenas um desses estados.  De fato, olhando um pouco √† frente, direi que quase sempre um assinante saber√° em que estado est√° o segundo assinante, <s>mas isso n√£o √© exato</s> . <br><br><h3>  Vamos considerar os estados separadamente, em detalhes </h3><br>  <b>HALTED</b> √© o estado mais simples, ningu√©m vai a lugar algum, todos permanecem em seus lugares, nada √© transmitido e n√£o recebido, nenhum est√≠mulo externo √© ignorado.  Todos, exceto um - a vontade das autoridades superiores.  No protocolo DDCMP original, a transi√ß√£o do estado <b>HALTED</b> s√≥ pode estar no estado <b>INICIAL IN√çCIO</b> a pedido do usu√°rio - Alice ou Bob recebem um pedido para estabelecer uma conex√£o. <br><br>  O que acontece quando Alice ou Bob recebem esse pedido? <br>  Eles notam imediatamente a si mesmos que o estado mudou de <b>IN√çCIO INICIAL</b> , e essa transi√ß√£o, como qualquer outra, envolve uma sequ√™ncia de a√ß√µes estritamente definida.  Nesse caso, voc√™ precisa gritar ‚ÄúDO IT!‚Äù E ajustar o rel√≥gio.  S√≥ isso. <br><br>  Ent√£o, Alice gritou o que era necess√°rio e apertou um bot√£o no cron√¥metro.  Agora, para entender o que esperar de Bob, descobriremos o que pode acontecer com Alice quando ela estiver no estado <b>INICIAL IN√çCIO</b> . <br><br>  - A partir do momento em que Alice notou que o tempo passou, digamos 10 segundos e ela n√£o ouviu nenhuma rea√ß√£o de Bob (observe, eu n√£o estou dizendo que Bob n√£o gritou nada para ela - isso n√£o √© conhecido, mas apenas que Alice n√£o sabe nada) ouvida durante esse per√≠odo, Alice √© uma mulher s√°bia e racional e depende apenas de fatos).  Chamamos esse evento de tempo limite - o intervalo de espera foi excedido.  Nesse caso, o protocolo nos diz para repetir: grite ‚ÄúFA√áA UMA VEZ!‚Äù E repita a hora.  Ainda n√£o grosso. <br><br>  - Se Alice ouviu que Bob gritou a mesma coisa - "FA√áA UMA VEZ!", Ent√£o Alice entra de forma <b>n√£o seletiva</b> no estado <b>IN√çCIO RECONHECIDO</b> , sobre o qual ela deve gritar imediatamente "FA√áA DOIS!" E acerte o rel√≥gio novamente. <br><br>  - Mais uma vez, se Alice ouviu Bob fazer "DOIS!", Ent√£o ela imediatamente entra no estado <b>EXECUTANDO</b> (!), Grita "ACEITOU NOOOOOL!".  Se o cron√¥metro foi iniciado, ela o desliga da linha da frente da cautela. <br><br>  √â muito importante n√£o fazer movimentos desnecess√°rios que n√£o sejam previstos pelo estado atual.  O que quer que Bob chore, n√£o importa o quanto xingue ou implore, Alice s√≥ reage conforme combinado. <br><br>  √â conveniente apresentar essas coisas na forma de uma tabela.  Ent√£o, vamos come√ßar com os <b>estados HALTED</b> e <b>INITIAL START</b> j√° descritos e, em seguida, reabasteceremos mais a tabela. <br><br><div class="scrollable-table"><table><tbody><tr><th>  ESTADO ATUAL </th><th>  EVENTO <br></th><th>  NOVA CONDI√á√ÉO </th><th>  A√á√ÉO <br></th></tr><tr><td>  QUALQUER UM </td><td>  A ordem "interromper a conex√£o" </td><td>  Interrompido <br></td><td></td></tr><tr><td>  Interrompido <br></td><td>  Encomende "Connect" <br></td><td>  ESTADO INICIAL </td><td>  1) Grite "FA√áA UMA VEZ!" <br>  2) Inicie o temporizador <br></td></tr><tr><td rowspan="3">  IN√çCIO INICIAL <br></td><td>  Eu ouvi "FA√áA UMA VEZ!" <br></td><td>  IN√çCIO RECONHECIDO <br></td><td>  1) Grite "DOIS!" <br>  2) Inicie o temporizador <br></td></tr><tr><td>  Eu ouvi "DOIS!" </td><td>  EXECUTANDO <br></td><td>  1) Grite "NOOOL ACEITO!" <br>  2) Pare o cron√¥metro <br></td></tr><tr><td>  O tempo acabou - tempo limite </td><td>  IN√çCIO INICIAL <br></td><td>  1) Grite "FA√áA UMA VEZ!" <br>  2) Inicie o temporizador <br></td></tr></tbody></table></div><br><br>  Omiti conscientemente alguns pontos da descri√ß√£o original do DDCMP - n√£o precisamos deles, queremos n√£o apenas repetir o DDCMP, mas construir com base <s>no mesmo, apenas outro</s> novo protocolo. <br><br>  Mas voltando √† descri√ß√£o de estados e transi√ß√µes.  O pr√≥ximo estado √© <b>IN√çCIO RECONHECIDO</b> . <br>  Sendo neste estado, tudo o que pode preocupar Alice ou Bob √©: <br><br>  - como antes, a expira√ß√£o do tempo de espera, nesse caso, voc√™ precisa permanecer no mesmo estado, gritar "DOIS!" E iniciar o temporizador novamente <br><br>  - o ‚ÄúDOIS!‚Äù ouvido se traduz no estado <b>RUNNING</b> , enquanto grita ‚ÄúNOOOOL LOGO ACEITADO!‚Äù E pare o temporizador; <br><br>  - o ouvido ‚ÄúDO IT!‚Äù Sai no mesmo estado, voc√™ precisa gritar ‚ÄúDOIS!‚Äù E iniciar o temporizador; <br><br>  - ouviu ‚ÄúNOOOL ACCEPTED!‚Äù - transi√ß√£o para o estado <b>RUNNING</b> , pare o temporizador. <br><br>  Colocamos tudo isso em uma tabela. <br><div class="scrollable-table"><table><tbody><tr><th>  ESTADO ATUAL </th><th>  EVENTO <br></th><th>  NOVA CONDI√á√ÉO </th><th>  A√á√ÉO <br></th></tr><tr><td rowspan="4">  IN√çCIO RECONHECIDO <br></td><td>  Eu ouvi "FA√áA UMA VEZ!" <br></td><td>  IN√çCIO RECONHECIDO <br></td><td>  1) Grite "DOIS!" <br>  2) Inicie o temporizador <br></td></tr><tr><td>  Eu ouvi "DOIS!" </td><td>  EXECUTANDO <br></td><td>  1) Grite "NOOOL ACEITO!" <br>  2) Pare o cron√¥metro <br></td></tr><tr><td>  Ouvi "NOOOL ACEITO!" </td><td>  EXECUTANDO <br></td><td>  1) Pare o cron√¥metro <br></td></tr><tr><td>  O tempo acabou - tempo limite </td><td>  IN√çCIO RECONHECIDO </td><td>  1) Grite "DOIS!" <br>  2) Inicie o temporizador <br></td></tr></tbody></table></div><br><br>  Com um aperto de m√£o, quase tudo est√° pronto - resta considerar apenas um estado <b>RUNNING</b> , porque um dos assinantes j√° pode entrar nele e o segundo - corre urgentemente para o banheiro, e quando ele volta, esquece tudo e tenta estabelecer uma nova conex√£o. <br><br>  Do ponto de vista do procedimento de handshake (ainda n√£o lidamos com a transfer√™ncia de dados, para a qual tudo foi iniciado - esta √© uma hist√≥ria separada) no estado <b>RUNNING</b> , estamos interessados ‚Äã‚Äãem dois eventos: <br><br>  - se eles gritarem para n√≥s "FA√áA UMA VEZ!" - tudo est√° muito ruim, √© uma dessincroniza√ß√£o completa, tudo precisa ser reiniciado.  O protocolo original <b>instrui</b> voc√™ a simplesmente entrar no estado <b>HALTED</b> .  Mas isso n√£o nos ajudar√° de forma alguma - se, por algum motivo, isso aconteceu em um Arduino aut√¥nomo, que transmite alguns dados de alguns sensores, ent√£o, para n√≥s, √© uma falha completa.  Como sabemos, de <b>HALTED</b> voc√™ pode ir para <b>INICIAL START</b> apenas por ordem das autoridades. <br>  Portanto, estamos modificando o protocolo aqui: a recep√ß√£o no estado <b>HALTED</b> do <b>comando</b> "DO ONCE!" Deve funcionar como uma ordem das autoridades - ou seja,  <b>mude para o</b> estado <b>INICIAL IN√çCIO</b> , grite ‚ÄúFA√áA UMA VEZ!‚Äù, inicie o cron√¥metro.  Al√©m disso, em alguns casos, √© conveniente dar uma ordem para estabelecer comunica√ß√£o imediatamente ap√≥s o fornecimento de energia a si mesmo. <br>  Assim, agora, no caso mais inconveniente, simplesmente redefiniremos a conex√£o. <br><br>  - o segundo evento ao qual √© necess√°rio reagir no estado <b>RUNNING</b> - se ouvirmos "DOIS!" De uma trincheira vizinha.  Isso j√° √© mais interessante.  Nesse caso, voc√™ precisa gritar ‚ÄúER ACEITO!‚Äù. Onde ER significa o n√∫mero de mensagens recebidas com sucesso na atual sess√£o de comunica√ß√£o.  Este √© um novo conceito.  Abaixo, consideraremos tudo com mais detalhes, mas, por enquanto, traremos tudo o que aprendemos para o momento atual em uma tabela: <br><br><div class="scrollable-table"><table><tbody><tr><th>  ESTADO ATUAL </th><th>  EVENTO <br></th><th>  NOVA CONDI√á√ÉO </th><th>  A√á√ÉO <br></th></tr><tr><td rowspan="4">  IN√çCIO RECONHECIDO <br></td><td>  Eu ouvi "FA√áA UMA VEZ!" <br></td><td>  IN√çCIO RECONHECIDO <br></td><td>  1) Grite "DOIS!" <br>  2) Inicie o temporizador <br></td></tr><tr><td>  Eu ouvi "DOIS!" </td><td>  EXECUTANDO <br></td><td>  1) Grite "NOOOL ACEITO!" <br>  2) Pare o cron√¥metro <br></td></tr><tr><td>  Ouvi "NOOOL ACEITO!" </td><td>  EXECUTANDO <br></td><td>  1) Pare o cron√¥metro <br></td></tr><tr><td>  O tempo acabou - tempo limite </td><td>  IN√çCIO RECONHECIDO </td><td>  1) Grite "DOIS!" <br>  2) Inicie o temporizador <br></td></tr></tbody></table></div><br><br>  Agora, se Alice e Bob seguem estritamente o protocolo, eles simplesmente n√£o t√™m op√ß√µes <s>para entrar em</s> algo <s>incompreens√≠vel</s> , exceto como estabelecer uma conex√£o, alternando em conjunto para o estado <b>RUNNING</b> ou, em um caso ruim, tentando estabelec√™-lo antes da vit√≥ria ser <s>clicada</s> . <br><br>  Um leitor agressivo pode tentar examinar todas as op√ß√µes e chegar √† conclus√£o de que a s√©rie de estados e transi√ß√µes acaba sendo fechada e estritamente determinada.  N√≥s (com a ajuda das mentes dos engenheiros do DEC) agora amarramos Alice e Bob com um conjunto de regras que simplesmente seguem as quais eles estabelecer√£o uma conex√£o, se nas condi√ß√µes atuais isso for geralmente poss√≠vel em princ√≠pio. <br><br><h3>  Como transferir dados agora? </h3><br>  Ok, isso foi um bom treino.  Per√≠odo de doces-buqu√™ no relacionamento de dois n√≥s da rede.  Lembre-se de que iniciamos um neg√≥cio: precisamos transferir dados com entrega garantida e prioridade!  Com recupera√ß√£o de desastres.  Na medida em que os recursos de hardware permitem isso (afinal, Alice e Bob podem se mostrar controladores fracos de 8 bits com 2 kilobytes de RAM!). <br><br>  Os engenheiros do DEC nos ensinam que as mensagens que precisamos numerar, precisamos contar quanto enviamos, quantas recebemos e quantas das mensagens que enviamos chegaram ao destinat√°rio. <br><br><div class="spoiler">  <b class="spoiler_title">√â hora de uma digress√£o!</b> <div class="spoiler_text">  Admita.  quando vi os nomes das vari√°veis ‚Äã‚Äãna descri√ß√£o do protocolo DDCMP, decidi que n√£o foi por acaso: os americanos gostam muito de atrair belas abrevia√ß√µes por seus ouvidos. <br><br>  Para nossa conveni√™ncia, existem at√© v√°rios recursos em que os interessados ‚Äã‚Äãpodem tocar o belo. <br>  O meu favorito √© este - <a href="https://www.cfa.harvard.edu/~gpetitpas/Links/Astroacro.html" rel="nofollow">Site de acr√¥nimos astron√¥micos mudos ou excessivamente for√ßados (ou DOOFAAS)</a> <br><br>  Quanto valem essas fabrica√ß√µes! <br>  Aqui est√° um exemplo: <br><br>  <b>WASP</b> - Espectr√¥metro anal√≥gico de banda larga (mas n√£o exatamente o que voc√™ pensava!) <br>  <b>SAURON</b> - Unidade Espectrosc√≥pica de <b>√Årea</b> para Pesquisa em Nebulosas √ìpticas <br>  <b>CISCO</b> - Espectr√≥grafo infravermelho e c√¢mera refrigerados para OHS (√© isso que significa!) <br><br>  E aqui, apenas atire: <br>  <b>SQUIRT</b> (ah, sim, artigo 18+!) - Satettile QUICK Research Testbed <br>  <b>MERDA</b> (nem mais nem menos!) - Telesc√≥pio Interferom√©trico Super Enorme, com a inscri√ß√£o ‚Äúprocure voc√™ mesmo‚Äù, ao qual o link para o resumo est√° anexado ao artigo com o mesmo nome. <br><br>  Portanto, as vari√°veis ‚Äã‚Äãque indicam o n√∫mero de pacotes recebidos, enviados e entregues no n√≥ na descri√ß√£o original do protocolo s√£o denominadas <b>RNA</b> . <br><br>  Ah, por que eles n√£o nomearam o protocolo dessa maneira - RNA!  Uma esp√©cie de rede de RNA.  Os protocolos DECnet tinham todas as chances de se tornar protocolos da Internet se a hist√≥ria tivesse sido diferente. <br></div></div><br><br><h3>  Mas voltando √†s nossas trincheiras </h3><br>  O padr√£o de protocolo original define que todos os contadores s√£o de 8 bits e aumentam o m√≥dulo 256. Isso significa que pode haver um m√°ximo de 256 mensagens enviadas para as quais a confirma√ß√£o ainda n√£o foi recebida. <br>  E, se a confirma√ß√£o n√£o for recebida, eles poder√£o precisar ser retransmitidos e, se necess√°rio, dever√£o ser armazenados at√© a confirma√ß√£o.  Afinal, temos entrega garantida! <br><br>  Os par√¢metros f√≠sicos de nossa Alice e Bob nos ditam condi√ß√µes diferentes.  No Arduino de 8 bits, essa quantidade de dados simplesmente n√£o existe para armazenar e temos que comprometer.  E n√£o estou falando do fato de que, no padr√£o, o tamanho dos pacotes (mensagens) em bytes √© limitado a um n√∫mero de 16 bits, ou seja,  64 kilobytes √© um luxo inadmiss√≠vel! <br><br><h3>  Portanto, a conex√£o √© estabelecida.  O que vem a seguir? </h3><br>  No momento em que Alice ou Bob <b>entram no</b> estado <b>RUNNING</b> , os contadores s√£o redefinidos. <br>  Como j√° mencionei, o protocolo original envolve a numera√ß√£o de mensagens no m√≥dulo 256, mas temos que reduzir esse n√∫mero para se adequar √† pequena quantidade de mem√≥ria em coisas do tipo Arduino. <br>  Para poder limitar imediatamente todos os incrementos de contadores, apresentaremos uma certa constante UMCP_PACKETS_NUMBER, e agora todos os incrementos ocorrer√£o neste m√≥dulo. <br><br>  Se voc√™ usar UMCP_PACKETS_NUMBER = 8, e o tamanho m√°ximo do pacote for UMCP_PACKET_DATA_SIZE - as partes dos dados transmitidos por vez s√£o limitadas a 64 bytes, tudo se encaixar√° no Arduino UNO e permanecer√° um pouco para as necessidades do usu√°rio. <br>  √â importante lembrar que esses dois par√¢metros devem ser os mesmos para ambas as partes. <br><br>  Obviamente, agora, se Alice e Bob estabeleceram uma conex√£o com sucesso, e um deles precisa transferir dados, primeiro os dados devem ser divididos em partes que n√£o excedam os 64 bytes de tamanho e, em segundo lugar, cada pacote tamb√©m deve conter um estado dois contadores de remetentes: o n√∫mero de mensagens recebidas e enviadas (R e N). <br><br>  Veja como √© f√°cil agora organizar os chamados  pipelining e como √© f√°cil lidar com situa√ß√µes de erro! <br><br>  Se Alice enviar 3 pacotes seguidos logo ap√≥s o estabelecimento da conex√£o, todos eles ter√£o o contador R definido como 0 (ela ainda n√£o recebeu nenhum pacote) e o contador N aumentar√° em um a cada novo pacote. <br><br>  Se Bob aceitar todos eles com √™xito, para confirmar o recebimento dos tr√™s pacotes, ser√° suficiente enviar uma confirma√ß√£o apenas para o √∫ltimo, de fato, se ele simplesmente enviar de volta o status de seus contadores R = 3 e N = 0, Alice entender√° imediatamente que todos os pacotes enviados suas mensagens chegaram ao destinat√°rio. <br><br>  Era um caso ideal quando n√£o ocorria for√ßa maior.  Vamos agora ver o que poderia dar errado e como lidar com isso. <br><br>  Se, por algum motivo, Bob pular o primeiro pacote e aceitar um dos pr√≥ximos, ele imediatamente chamar√° a aten√ß√£o para o fato de que o contador N (o n√∫mero de pacotes transmitidos por Alice) excede claramente o contador R do lado de Bob e Bob percebe facilmente que perdeu o primeiro pacote .  Nesse caso, ele s√≥ precisa jogar o Capit√£o Evidence mais plano e informar a Alice o status de seu contador de pacotes recebidos (R = 0).  Ao mesmo tempo, Alice entende que ela √© N = 3 e Bob tem R = 0, ou seja, ela precisa transferir pacotes de uma nova maneira, come√ßando pelo primeiro. <br><br>  Se voc√™ observar esse esquema com aten√ß√£o, poder√° ver que qualquer transmiss√£o do status de seus contadores por qualquer assinante informa imediatamente o resultado da transmiss√£o de pacotes de dados, e a diferen√ßa entre o contador transmitido de um lado e recebido do outro indica quantos pacotes foram perdidos e de que n√∫mero ele come√ßou. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ou seja, no pior dos casos, h√° uma retransmiss√£o completa da transmiss√£o; no caso m√©dio, o contador A no lado do transmissor aumenta para o valor do contador R no lado receptor e ‚Äúenviando‚Äù os pacotes perdidos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">√â f√°cil entender que, dessa maneira, a continuidade do incremento dos contadores √© mantida, o que significa que a transmiss√£o de mensagens (pacotes) √© garantida. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Al√©m das vari√°veis ‚Äã‚Äãde RNA, cada assinante possui dois sinalizadores SACK e SPEP. Se o primeiro estiver instalado, ser√° necess√°rio enviar uma confirma√ß√£o (Enviar confirma√ß√£o), se o segundo - voc√™ precisar√° enviar uma solicita√ß√£o de confirma√ß√£o (Enviar REPly para uma mensagem).</font></font><br><br> ,   DDCMP     ‚Äî SNAK (Send Negative AcKnowledgement).         - .               ,      , ,         ‚Äî       . <br>       ,      . <br><br>          - . -      .  E √© verdade.    . <br>                  . <br><br>       ,        ‚Äî   ,   .      ,   ,    L,   (,      ‚Äî  R). <br><div class="scrollable-table"><table><tbody><tr><th>  </th><th>  </th></tr><tr><td>    NR=RL+1 </td><td> 1)   <br> 2)    <br> 3) RL=RL+1 <br> 4)  RR=NL  AL&lt;=RR&lt;=NL   <br>      AL  RR  <br>  <br> 5) AL=RR <br></td></tr><tr><td>     ‚Äî REP </td><td> 1) SACK = true <br> 2) SREP = false <br></td></tr><tr><td>   ‚Äî ACK </td><td> 1)   <br> 2) SREP = false <br> 3)  RR=NL  AL&lt;=RR&lt;=NL   <br>      AL  RR  <br>  <br> 4) AL=RR <br></td></tr><tr><td>    </td><td> 1) SREP = true </td></tr><tr><td>      SREP </td><td> 1)     REP(RL, NL) <br> 2)   <br></td></tr><tr><td>    AL&lt;NL </td><td> 1)     AL+1 <br> 2)   <br></td></tr><tr><td>  ,   SACK </td><td> 1)   ACK(RL,NL) </td></tr><tr><td>  , AL=NL,  SACK  SREP <br>  ,     <br></td><td> 1) NL=NL+1 <br> 2)     <br></td></tr></tbody></table></div><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora d√™ uma olhada mais de perto, percorra todo o circuito na cabe√ßa. Percebemos o que est√° faltando aqui. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Na descri√ß√£o original do DDCMP, da qual partimos bastante, isso √© chamado de sinalizador SELECT - um n√≥ (Alice ou Bob) pode ou n√£o ser "escolhido". </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O que nos confundiu foi o fato de nenhum mecanismo estar autorizado a permitir ou proibir a transfer√™ncia. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, aqui est√°: esta √© a bandeira SELECT. √â aplicado de maneira muito simples: se o sinalizador estiver definido, √© poss√≠vel transmitir, caso contr√°rio, √© imposs√≠vel.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todas as mensagens de controle como ACK e REP devem conter esse sinalizador. </font><font style="vertical-align: inherit;">O √∫ltimo pacote na fila tamb√©m deve conter esse sinalizador. </font><font style="vertical-align: inherit;">Se um n√≥ "costura" um sinalizador em um pacote, ele "o distribui" e, portanto, n√£o √© mais instalado. </font><font style="vertical-align: inherit;">O n√≥ que detecta esse sinalizador no pacote, pelo contr√°rio, deve instal√°-lo por conta pr√≥pria. </font><font style="vertical-align: inherit;">√â como passar um bast√£o ou jogar um picadinho (lembra-se disso?). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O mais importante ao trabalhar com esse sinalizador √© que um dos n√≥s deve ter esse sinalizador por padr√£o e o outro n√£o. </font><font style="vertical-align: inherit;">Esse √© outro cron√¥metro muito importante - o sinalizador SELECT retorna o cron√¥metro. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agora, temos um conjunto completo de regras para estabelecer uma conex√£o e transmitir dados por ela. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">N√£o tocamos apenas na implementa√ß√£o concreta desse conjunto de regras. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Bem, conserte!</font></font><br><br><h3><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Forma√ß√£o e Formato de Pacotes </font></font></h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Isso se chama Enquadramento de Mensagens - as regras para analisar e gerar mensagens e o formato. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vamos calcular quanto precisamos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">1. No m√≠nimo, precisamos de cada mensagem para conter o estado dos contadores R e N do remetente. </font><font style="vertical-align: inherit;">Para o Arduino, concordamos que podemos ter no m√°ximo 8 mensagens enviadas, mas n√£o confirmadas. </font><font style="vertical-align: inherit;">Mas, como transferimos bytes, colocamos ambos os contadores em um byte, deixando-os em 4 bits. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esse byte ser√° formado assim:</font></font><br><pre><code class="cpp hljs"> = (RL &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>) | (NL &lt;&lt; <span class="hljs-number"><span class="hljs-number">4</span></span>);</code> </pre> <br>  E leremos o status dos contadores assim: <br><pre> <code class="cpp hljs">NR = (c &gt;&gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>; RR = c &amp; <span class="hljs-number"><span class="hljs-number">0x0F</span></span>;</code> </pre> <br>  c - byte correspondente da mensagem <br><br>  2. Lembramos tamb√©m que cada mensagem deve conter o estado do sinalizador SELECT.  E os diferentes tipos de mensagens ser√£o: <br><div class="scrollable-table"><table><tbody><tr><th>  Nome engra√ßado <br></th><th>  Nome s√©rio <br></th><th>  Descri√ß√£o do produto <br></th><th>  Valor do sinalizador SELECT <br></th><th>  Valor PTYPE </th></tr><tr><td>  "FA√áA UMA VEZ!" <br></td><td>  STR <br></td><td>  STaRt <br></td><td>  verdade </td><td>  40. <br></td></tr><tr><td>  "DOIS!" <br></td><td>  STA <br></td><td>  In√≠cio reconhecido </td><td>  verdade </td><td>  36. </td></tr><tr><td>  ‚ÄúNOOL ACEITO!‚Äù <br></td><td>  ACK (NL = 0, RL = 0) <br></td><td>  Reconhecimento <br></td><td>  verdade </td><td>  33 <br></td></tr><tr><td>  "ACEITO POR ER, ENVIADO POR EN" </td><td>  ACK (NL, RL) </td><td>  Reconhecimento </td><td>  verdade </td><td>  33 </td></tr><tr><td>  "CONFIRMAR COMO EU ENTENDO?" <br></td><td>  REP (NL, RL) <br></td><td>  REPly a uma mensagem </td><td>  verdade </td><td>  34 </td></tr><tr><td>  "PACOTE DE DADOS" <br></td><td>  DTA (NL, RL) <br></td><td>  Pacote de dados </td><td>  falsa </td><td>  17 </td></tr><tr><td>  PACOTE DE DADOS EXTREMOS <br></td><td>  DTE (NL, RL) </td><td>  Pacote DaTa - Fim </td><td>  verdade </td><td>  49. </td></tr></tbody></table></div><br><br>  Ou seja, apenas 6 tipos diferentes de mensagens.  Todas as mensagens, exceto o DTA, "liberam" o sinalizador SELECT - elas precisam de uma resposta imediata do assinante remoto e, sem o sinalizador, ele n√£o poder√° transmiti-lo.  A mensagem DTA n√£o retorna um sinalizador para possibilitar o pipelining. <br><br>  Em geral, temos 3 bits suficientes para o tipo de mensagem, mas, para n√£o mexer com os bits, atribu√≠mos um byte inteiro ao tipo - em caso de revis√£o, teremos alguma liberdade de a√ß√£o. <br><br>  Se a mensagem contiver dados, precisamos transferir sua quantidade e soma de verifica√ß√£o.  Como o tamanho m√°ximo do pacote √© de 64 bytes, tamb√©m ser√° necess√°rio um byte para a soma de verifica√ß√£o e o comprimento - de repente voc√™ ter√° que aumentar o tamanho do pacote. <br><br>  3. Tamb√©m precisamos de alguma assinatura do in√≠cio da mensagem e uma soma de verifica√ß√£o separada para o cabe√ßalho. <br><br>  Com tudo isso em mente, o cabe√ßalho (tamb√©m conhecido como mensagens de controle) fica assim: <br><div class="scrollable-table"><table><tbody><tr><th>  Deslocamento, byte <br></th><th>  Descri√ß√£o do produto </th><th>  Tamanho, bit </th></tr><tr><td>  0 0 </td><td>  SIGN = 0xAD <br></td><td>  8 </td></tr><tr><td>  1 </td><td>  PTYPE </td><td>  8 </td></tr><tr><td>  2 </td><td>  TCNT </td><td>  4 <br></td></tr><tr><td>  2 </td><td>  RCNT </td><td>  4 </td></tr><tr><td>  3 </td><td>  Hchk </td><td>  8 </td></tr></tbody></table></div><br><br>  E o bloco de dados √© assim: <br><div class="scrollable-table"><table><tbody><tr><th>  Deslocamento, byte <br></th><th>  Descri√ß√£o do produto </th><th>  Tamanho, bit </th></tr><tr><td>  4 </td><td>  DCNT <br></td><td>  8 </td></tr><tr><td>  5..5 + DCNT-1 <br></td><td>  DADOS <br></td><td>  8 * DCNT </td></tr><tr><td>  5 + DCNT </td><td>  Dchk </td><td>  8 </td></tr></tbody></table></div><br><br>  S√≥ isso.  Esta √© uma descri√ß√£o completa do protocolo que recebemos do DDCMP. <br>  Agora voc√™ pode passar pela implementa√ß√£o. <br><br><h3>  Como √© organizado e como us√°-lo? </h3><br>  Primeiro, um pouco sobre a estrutura do reposit√≥rio. <br>  Como mencionei no in√≠cio, o c√≥digo do projeto est√° no github: <a href="https://github.com/AlekUnderwater/uMCPIno" rel="nofollow">uMCPIno</a> <br><br>  Para ver como tudo funciona, voc√™ pode executar um <a href="" rel="nofollow">aplicativo de teste</a> em um PC. <br><br>  No arquivo morto, execute uMCPIno_Test.exe, selecione a porta COM desejada e tente como ela funciona. <br>  Voc√™ pode verificar um par de portas COM virtuais (eu geralmente fa√ßo isso). <br>  Por que voc√™ pode executar duas c√≥pias do aplicativo.  Apenas n√£o esque√ßa de ativar ‚ÄúSELECTED BY DEFAULT‚Äù em uma c√≥pia - esta ser√° Master e na outra - desligue-a.  By the way, se estiver interessado, voc√™ pode ver o que acontece se voc√™ n√£o seguir esta regra =) <br><br>  A op√ß√£o EXTRAS permite ver todos os movimentos dos pensamentos dentro do c√©rebro do protocolo.  Todas as altera√ß√µes no estado dos sinalizadores SELECT, eventos dos temporizadores, altera√ß√µes no estado do n√≥, bem como os valores das vari√°veis ‚Äã‚ÄãR e N nas mensagens transmitidas e recebidas ser√£o exibidos. <br><br>  Eu conecto meu Arduino UNO ao meu laptop atrav√©s de um conversor USB UART &lt;-&gt;.  Os conectores de pinos permitem simular uma quebra de linha a qualquer momento: <br><img src="https://habrastorage.org/webt/nn/vg/kp/nnvgkplqtoqbazpubopcb8bff-g.jpeg"><br><br>  Se voc√™ agora executar o aplicativo no laptop, depois de pressionar o bot√£o "CONNECT", o arduina estabelecer√° uma conex√£o: <br><img src="https://habrastorage.org/webt/cy/jm/lx/cyjmlxn_ga-_zvrzel5yjmfwdz4.png"><br><br>  E √© assim que o sistema reage a uma tentativa de enviar atrav√©s de uma linha "rasgada": <br><img src="https://habrastorage.org/webt/lu/kb/dw/lukbdwxot1xuopxjdqxgpq1xqsq.png"><br><br>  Para incorporar o uMCPIno no seu aplicativo para PC: <br><ol><li>  O reposit√≥rio possui uma biblioteca uMCPIno.  Conecte-o √†s refer√™ncias do seu projeto </li><li>  Ele cont√©m a classe uMCPInoPort.  Declaramos sua inst√¢ncia: <br><pre> <code class="cs hljs">uMCPInoPort port; port = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> uMCPInoPort(<span class="hljs-string"><span class="hljs-string">"COM1"</span></span>, UCNLDrivers.BaudRate.baudRate9600, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-number"><span class="hljs-number">8100</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>, <span class="hljs-number"><span class="hljs-number">64</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>);</code> </pre><br>  Par√¢metros em ordem: nome da porta, velocidade da porta, estado SELECT padr√£o, intervalo para SELECT, intervalo de tempo limite, tamanho do pacote e o n√∫mero m√°ximo de mensagens n√£o reconhecidas. <br></li><li>  Inscrever-se para eventos: <br>  quando o sinalizador SELECT - port.Select for alterado: <br><pre> <code class="cs hljs">OnSelectChangedEventHandler</code> </pre> <br>  quando o estado muda - port.State: <br><pre> <code class="cs hljs">OnStateChangedEventHandler</code> </pre> <br>  O host remoto confirma o recebimento do c√≥digo: <br><pre> <code class="cs hljs">OnDataBlockAcknowledgedEventHandler</code> </pre> <br>  quando chega o pacote de dados: <br><pre> <code class="cs hljs">OnDataBlockReceivedEventHandler</code> </pre> <br></li><li>  Antes do trabalho, abra a porta <br><pre> <code class="cs hljs">port.Open();</code> </pre> <br></li><li>  Para enviar dados, chamamos o m√©todo: <pre> <code class="cs hljs">port.Send(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] data);</code> </pre> <br></li><li>  Ap√≥s a conclus√£o, feche a porta: <pre> <code class="cs hljs">port.Close();</code> </pre> <br></li></ol><br><br>  Basta enviar dois bytes! <br><br>  Agora vamos √† implementa√ß√£o do Arduino.  Dois exemplos est√£o na pasta <a href="https://github.com/AlekUnderwater/uMCPIno/tree/master/Arduino" rel="nofollow">github.com/AlekUnderwater/uMCPIno/tree/master/Arduino</a> <br><br>  <a href="" rel="nofollow">O primeiro</a> √© apenas um conversor de e para o uMCP.  O primeiro Serial serve para se comunicar com o Host e o Serial1 (se estiver na sua placa) ou o SoftwareSerial nos pinos 2 e 3 - para se comunicar com outro n√≥ do uMCPIno.  Voc√™ pode conectar o Bluetooth ou um m√≥dulo de r√°dio aqui. <br><br>  <a href="" rel="nofollow">O segundo</a> √© um modelo de projeto com suporte para o protocolo uMCPIno <br><br>  Ambos os projetos t√™m configura√ß√µes onde voc√™ pode e deve subir.  Aqui est√£o elas: <br><br>  O estado padr√£o do sinalizador SELECT.  Se definido como (true), mesmo que o n√≥ remoto n√£o retorne o sinalizador, ele ser√° definido como true pelo timer. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_SELECT_DEFAULT_STATE (false)</span></span></code> </pre> <br><br>  Para definir o per√≠odo desse timer, existe a seguinte configura√ß√£o: intervalo para retornar o sinalizador SELECT em milissegundos <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_SELECT_DEFAULT_INTERVAL_MS (4000)</span></span></code> </pre> <br><br>  O intervalo para aguardar uma resposta em milissegundos, √© melhor deix√°-lo um pouco menos que o intervalo para retornar o sinalizador SELECT. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_TIMEOUT_INTERVAL_MS (3000)</span></span></code> </pre> <br><br>  A taxa de transmiss√£o real da linha.  Este par√¢metro √© necess√°rio para determinar quando a transfer√™ncia ser√° finalizada. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_LINE_BAUDRATE_BPS (9600)</span></span></code> </pre> <br><br>  Intervalo de acumula√ß√£o de dados para o algoritmo Nagle.  Insolentemente, considere igual a 100 milissegundos.  Durante esse tempo, estamos aguardando um conjunto de pacotes, se n√£o for digitado, enviamos como est√°.  A tarefa do algoritmo Nagle √© livrar a rede de uma pilha de pacotes pequenos de um a v√°rios bytes de tamanho. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_NAGLE_DELAY_MS (100)</span></span></code> </pre> <br><br>  Essas configura√ß√µes definem as velocidades da porta para comunica√ß√£o com o sistema de controle (Host) e a linha.  N√£o confunda a velocidade da porta com uma linha com uma taxa de transfer√™ncia f√≠sica. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_HOST_CONNECTION_BAUDRATE_BPS (9600) </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// Host connection port speed #define CFG_LINE_CONNECTION_BAUDRATE_BPS (9600) // Line connection port speed</span></span></span></span></code> </pre> <br><br>  Se essa configura√ß√£o estiver ativada, quando a energia for fornecida ao controlador, o pr√≥prio protocolo se comandar√° para iniciar o estabelecimento de uma conex√£o. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_IS_AUTOSTART_ON_POWERON (true)</span></span></code> </pre> <br><br>  Este √© o tamanho em bytes do buffer para pacotes de dados recebidos. <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> CFG_IL_RING_SIZE (255)</span></span></code> </pre> <br><br>  A seguir, vamos ver como √© o loop de esbo√ßo principal: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">loop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ uMCP_ITimers_Process(); DC_Input_Process(); DC_Output_Process(); <span class="hljs-comment"><span class="hljs-comment">//  ip_ready  ,      if (ip_ready) { uMCP_OnIncomingPacket(); } //        ,     -  if ((state == uMCP_STATE_HALTED) &amp;&amp; ((ih_Cnt &gt; 0) || (isStartup &amp;&amp; CFG_IS_AUTOSTART_ON_POWERON))) { if (isStartup) { isStartup = false; } uMCP_STATE_Set(uMCP_STATE_ISTART); uMCP_CtrlSend(uMCP_PTYPE_STR, 0, 0, true); } else if (state == uMCP_STATE_RUNNING) { uMCP_Protocol_Perform(); //      -   if (il_ready) { il_ready = false; USER_uMCPIno_DataPacketReceived(); } } }</span></span></code> </pre><br><br>  Agora vamos ver como o protocolo funciona.  A l√≥gica principal est√° contida na fun√ß√£o uMCP_Protocol_Perform ();  Aqui est√° o c√≥digo dela: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCP_Protocol_Perform</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (state == uMCP_STATE_RUNNING) { <span class="hljs-comment"><span class="hljs-comment">//              SELECT  if ((!iTimer_State[uMCP_Timer_TX]) &amp;&amp; (!iTimer_State[uMCP_Timer_TMO]) &amp;&amp; (select)) { //     if (ih_Cnt == 0) { //    REP -  if (srep) { uMCP_CtrlSend(uMCP_PTYPE_REP, N, R, true); srep = false; } //     -   else if (sentBlocksCnt &gt; 0) { uMCP_DataBlockResend((A + 1) % UMCP_PACKETS_NUMBER, true, true); } //    SACK  -        //  -       ACK else if ((!selectDefaultState) || (sack)) { uMCP_CtrlSend(uMCP_PTYPE_ACK, N, R, false); sack = false; } } //     -  else if (ih_Cnt &gt; 0) { //              -  if ((ih_Cnt &gt;= UMCP_PACKET_DATA_SIZE) || (millis() &gt;= ih_TS + CFG_NAGLE_DELAY_MS)) { //   N N = (N + 1) % UMCP_PACKETS_NUMBER; uMCP_NextDataBlockSend(); } } } } }</span></span></code> </pre><br><br>  Um analisador de pacotes que vive em uma fun√ß√£o <pre> <code class="cpp hljs">On_NewByte_From_Line</code> </pre>  tamb√©m organizado pelo princ√≠pio de uma m√°quina de estados finitos e funciona "byte a byte".  Isso √© feito para economizar mem√≥ria. <br><br>  O restante da implementa√ß√£o n√£o √© de particular interesse.  Analisaremos melhor como o usu√°rio interage com o protocolo.  Neste exemplo, existem quatro "pontos de contato". <br><br>  A primeira √© a fun√ß√£o de enviar dados na linha uMCPIno: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCPIno_SendData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte* dataToSend, byte dataSize)</span></span></span></span>;</code> </pre> <br>  Tudo √© simples aqui - voc√™ tem um buffer de bytes dataToSend, seu tamanho √© dataSize.  A fun√ß√£o retorna true se o envio for poss√≠vel (h√° espa√ßo para adicionar dados) e false caso contr√°rio. <br>  Para n√£o dirigir em v√£o, voc√™ pode verificar imediatamente a disponibilidade de espa√ßo suficiente usando a fun√ß√£o: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uMCP_IsCanSend</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(byte dataSize)</span></span></span></span>;</code> </pre> <br><br>  Para analisar os pacotes de dados recebidos, voc√™ precisa adicionar seu c√≥digo ao corpo da fun√ß√£o <pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USER_uMCPIno_DataPacketReceived</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br><br>  Os dados recebidos s√£o gravados no buffer de anel il_ring.  A leitura a partir dele pode ser organizada em bytes como este: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (il_Cnt &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { c = il_ring[il_rPos]; il_rPos = (il_rPos + <span class="hljs-number"><span class="hljs-number">1</span></span>) % CFG_IL_RING_SIZE; il_Cnt--; <span class="hljs-comment"><span class="hljs-comment">//   "c" -      }</span></span></code> </pre><br><br>  Para prazeres sofisticados existe uma fun√ß√£o <br><pre> <code class="cpp hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">USER_uMCP_OnTxBufferEmptry</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>;</code> </pre> <br>  Que √© chamado quando todos os dados s√£o enviados com sucesso.  Tamb√©m √© poss√≠vel e necess√°rio colocar algum tipo de c√≥digo nele. <br><br><h3>  Por que isso √© tudo e onde? </h3><br>  Eu lidei principalmente com apenas por divers√£o.  Al√©m disso, eu precisava de um protocolo simples e, o mais importante, "leve" para enviar dados atrav√©s de nossos modems de sonar <a href="https://habr.com/ru/post/428367/">uWAVE</a> .  Como eles transmitem dados atrav√©s da √°gua a uma velocidade de apenas 80 bps e com seu alcance m√°ximo de comunica√ß√£o de 1000 metros e a velocidade do som na √°gua de cerca de 1500 m / s, a transmiss√£o est√° associada a atrasos vis√≠veis e existe apenas um canal de sonar (se n√£o o mais !) das mais barulhentas, mais lentas e mais inst√°veis. <br>  Em grande parte devido a isso, tive que abandonar o mecanismo de reconhecimento negativo (NAK) - se √© poss√≠vel n√£o transmitir - na √°gua √© melhor n√£o transmitir 100%. <br>  Na realidade, o protocolo foi √∫til ao transmitir dados por um canal de r√°dio usando m√≥dulos <a href="http://www.dorji.com/products.php%3FCateId%3D9" rel="nofollow">DORJI</a> e o <a href="https%253A%252F%252Fwww.elecrow.com%252Fdownload%252FHC-12.pdf%26usg%3DAOvVaw2rNtYm7nLdpqPN6HR-LAS8" rel="nofollow">NS-012</a> conhecido por arduinos. <br><br><h3>  O que vem a seguir? </h3><br>  Se houver tempo, pretendo adicionar a possibilidade de endere√ßamento (que, a prop√≥sito, estava no DDCMP).  Como a principal tarefa deste protocolo agora √© fornecer comodidade para todos os tipos de testes de nossos modens de sonar e outras redes de sensores, ent√£o existem (literalmente!) Armadilhas l√°.  S√≥ posso dizer que o problema n√£o pode ser resolvido simplesmente adicionando os campos "Remetente" e "Alvo". <br>  Talvez seja o <a href="https://en.wikipedia.org/wiki/Geographic_routing" rel="nofollow">Roteamento Geogr√°fico</a> e todo esse jazz. <br><br><h3>  PS </h3><br>  Tradicionalmente, serei muito grato por cr√≠ticas, desejos e sugest√µes construtivas.  √â sempre importante entender se voc√™ est√° fazendo algo √∫til para as pessoas ou perdendo tempo. <br>  Talvez, ao tentar evitar a transi√ß√£o desse longread para o romance "Guerra e Paz", tenha perdido alguns detalhes - n√£o hesite em perguntar. <br><br><h3>  PPS </h3><br>  Muito obrigado pela vergonha do meu analfabetismo, apontando erros (gramaticais e l√≥gicos): <br><ul><li>  <a href="https://habr.com/ru/users/berez/" class="user_link">Berez</a> </li><li>  <a href="https://habr.com/ru/users/edo1h/" class="user_link">edo1h</a> </li></ul><br>  O projeto era originalmente de c√≥digo aberto, mas agora o artigo tamb√©m √© de c√≥digo aberto. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480110/">https://habr.com/ru/post/pt480110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480100/index.html">Iniciantes Sobre SEO</a></li>
<li><a href="../pt480102/index.html">Resumo do gerenciamento de produtos em novembro</a></li>
<li><a href="../pt480104/index.html">9 truques √∫teis em HTML</a></li>
<li><a href="../pt480106/index.html">Como montar uma imagem do banco de dados Oracle para cont√™ineres de teste</a></li>
<li><a href="../pt480108/index.html">F√≠sica em um projeto de unidade usando a luta m√≥vel como exemplo</a></li>
<li><a href="../pt480112/index.html">Diferen√ßas entre C ++ / Visual Basic e Java no n√≠vel geral (para iniciantes e estudantes)</a></li>
<li><a href="../pt480114/index.html">Tudo sobre impostos para freelancers de TI. IE e trabalhadores por conta pr√≥pria. Parte 1</a></li>
<li><a href="../pt480116/index.html">Posi√ß√£o do grupo Mail.ru no desenvolvimento de c√≥digo-fonte aberto na R√∫ssia</a></li>
<li><a href="../pt480118/index.html">Estamos escrevendo um simulador de digita√ß√£o por toque usando JavaScript puro. Parte 1</a></li>
<li><a href="../pt480120/index.html">Uma nova conquista em criptografia - fatora√ß√£o de um RSA de 795 bits</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>