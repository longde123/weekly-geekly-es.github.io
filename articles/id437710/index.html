<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÅ üêØ üçì Membatasi hak pengguna lokal di Linux seminimal mungkin üêß üèòÔ∏è ‚ú≥Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suatu hari, tugas berikut muncul: untuk membuat pengguna lokal di Linux, dengan akses terbatas ke folder dan file, termasuk tidak hanya mengedit, teta...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Membatasi hak pengguna lokal di Linux seminimal mungkin</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/437710/"><img src="https://habrastorage.org/webt/74/bk/1j/74bk1jiajt8gxpjnpfpm2_veawk.png" width="200" height="200" alt="Kucing" align="right">  Suatu hari, tugas berikut muncul: untuk membuat pengguna lokal di Linux, dengan akses terbatas ke folder dan file, termasuk tidak hanya mengedit, tetapi juga melihat, serta kemampuan untuk menggunakan hanya utilitas yang diizinkan.  Hanya akses lokal yang disediakan, tidak ada akses jaringan. <br><br>  Agar tidak menemukan kembali roda, hal pertama yang saya lakukan adalah mulai menggali Internet, sebagai akibatnya ditemukan opsi-opsi berikut: <br><br><ul><li>  pembatasan akses melalui layanan jaringan ssh, sftp (tidak cocok) </li><li>  diferensiasi hak akses oleh sistem operasi linux itu sendiri (tidak cocok, saya ingin solusi universal) </li><li>  menggunakan chroot (tidak cocok) </li><li>  penggunaan utilitas pihak ketiga, misalnya SELinux (tidak cocok, mempersulit sistem). </li></ul><br>  Sebagai hasil dari pencarian, mekanisme bawaan untuk membatasi kemampuan pengguna dalam bash shell ditemukan, itu disebut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Restricted Shell atau rbash</a> . <br><a name="habracut"></a><br>  Ini menerapkan pembatasan berikut: <br><br><ul><li>  tidak ada opsi untuk mengubah direktori dengan perintah cd </li><li> Anda tidak dapat mengatur ulang atau mengubah nilai variabel SHELL, PATH, ENV, BASH_ENV </li><li>  dilarang untuk menentukan perintah yang mengandung / (slash) </li><li>  dilarang mengimpor fungsi dari shell utama </li><li>  dilarang untuk mengarahkan ulang output menggunakan operator&gt;, &lt;, |, &lt;&gt;,&gt; &amp;, &amp;&gt;, &gt;&gt; </li><li>  dilarang menggunakan perintah exec untuk mengganti perintah, dll. </li></ul><br>  Ada minus, ini adalah keamanan, jadi sangat penting untuk menambahkan alias ke perintah dalam file perilaku shell .bashrc (informasi akan lebih lanjut). <br><br>  Tentu saja, rbash di luar kotak, itu tidak menyelesaikan semua masalah, oleh karena itu, sebagai contoh, kami mempertimbangkan untuk membuat pengguna dan mengatur lingkungannya untuk solusi lengkap untuk masalah kami. <br><br>  Selanjutnya, semua operasi dilakukan dari superuser (root). <br><br>  1. Buat shell terbatas <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'/bin/bash -r'</span></span> &gt; /bin/zbash chmod +x /bin/zbash</code> </pre> <br>  2. Buat pengguna <br><br><pre> <code class="bash hljs">adduser --home /home/zuser --shell /bin/zbash zuser</code> </pre> <br>  3. Ubah izin direktori <br><br><pre> <code class="bash hljs">chown root.zuser /home/zuser chmod 750 /home/zuser</code> </pre> <br>  4. Pergi ke direktori dan bersihkan <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~zuser ls -a rm .bash* rm .profile ls -a</code> </pre> <br>  5. Kustomisasi shell dan hak <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"PATH=:/home/zuser/bin"</span></span> &gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias help='echo access is limited'"</span></span> &gt;&gt; .bashrc <span class="hljs-comment"><span class="hljs-comment"># alias   help echo "bind 'set disable-completion on'" &gt;&gt; .bashrc #    tab mkdir -p bin chmod 750 bin chown -R root.zuser /home/zuser chmod 640 .bash*</span></span></code> </pre> <br>  File .bashrc mendefinisikan perilaku shell; alias untuk perintah atau <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">opsi</a> tambahan dapat ditambahkan ke file ini. <br><br>  Untuk memastikan keamanan, jalankan perintah berikut: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias echo=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias cat=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias bash=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias sh=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias ln=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias set=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias uset=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias export=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias typeset=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias declare=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias alias=':'"</span></span> &gt;&gt; .bashrc <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"alias unalias=':'"</span></span> &gt;&gt; .bashrc</code> </pre> <br>  Daftarnya berlanjut ... <br><br>  6. Periksa pekerjaan <br><br><pre> <code class="bash hljs">root@host: su zuser zuser@host: <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> access is limited zuser@host: <span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> /home/zuser zuser@host: ls /tmp/ bash: ls:    zuser@host: /bin/ls bash: /bin/ls:         {/} zuser@host: <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> :/home/zuser/bin zuser@host: PATH=/bin/ bash: PATH:     zuser@host: <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre><br>  7. Tambahkan perintah yang valid <br><br><pre> <code class="bash hljs">ln -s /bin/ping /home/zuser/bin/ping</code> </pre> <br>  Yang penting, path dalam perintah ln harus ditentukan sepenuhnya. <br><br>  8. Anda dapat menggunakan pembungkus untuk membatasi opsi perintah. <br><br><pre> <code class="bash hljs">mkdir /var/scripts <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"/usr/sbin/useradd -D"</span></span> &gt; /var/scripts/user-info chmod +x /var/scripts/user-info ln -s /var/scripts/user-info /home/zuser/bin/user-info</code> </pre> <br>  9. Anda juga dapat membuat pembungkus untuk bekerja dengan file dan folder. <br>  dengan <b>daftar hitam</b> (kecuali semuanya): <br>  - buat file <br><br><pre> <code class="bash hljs">nano /var/scripts/ls</code> </pre> <br>  - isi file <br><br><pre> <code class="bash hljs">blacklist=<span class="hljs-string"><span class="hljs-string">"\? ../ /etc /bin /boot /var"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> var <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">$blacklist</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ $* == *<span class="hljs-variable"><span class="hljs-variable">$var</span></span>* ]]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'Access is denied:'</span></span> $* <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> /bin/ls $*</code> </pre> <br>  blacklist - variabel yang berisi daftar hitam direktori atau file (dipisahkan oleh spasi) <br>  - tambahkan perintah untuk pengguna zuser <br><br><pre> <code class="bash hljs">chmod +x /var/scripts/ls ln -s /var/scripts/ls /home/zuser/bin/ls</code> </pre> <br>  Script ini memungkinkan Anda untuk mengeksekusi perintah ls dengan tombol apa saja untuk direktori dan file yang tidak cocok dengan daftar hitam <br><br>  dengan <b>daftar putih</b> (melarang semuanya kecuali): <br>  - buat file <br><br><pre> <code class="bash hljs">nano /var/scripts/cat</code> </pre> <br>  - isi file <br><br><pre> <code class="bash hljs">whitelist=<span class="hljs-string"><span class="hljs-string">"./ /tmp/"</span></span> <span class="hljs-comment"><span class="hljs-comment">#   for var in $whitelist do if [[ $* == *$var* ]]; then /bin/cat $* #   cat    exit fi done echo 'Access is denied:' $*</span></span></code> </pre> <br>  daftar putih - variabel yang berisi daftar putih direktori atau file (dipisahkan spasi) <br>  - tambahkan perintah untuk pengguna zuser <br><br><pre> <code class="bash hljs">chmod +x /var/scripts/cat ln -s /var/scripts/cat /home/zuser/bin/cat</code> </pre> <br>  Script ini memungkinkan Anda untuk mengeksekusi perintah cat dengan file yang ditentukan dalam daftar putih. <br><br>  <b>Selesai</b> , kami akhirnya mendapatkan hasil sebagai berikut: <br><br><ul><li>  kami membuat pengguna zuser dengan rbash shell </li><li>  menonaktifkan kemampuan untuk menggunakan pelengkapan otomatis di konsol </li><li>  zuser hanya dapat menjalankan utilitas dari direktori / home / zuser / bin </li><li>  menambahkan perintah ping ke zuser </li><li>  menambahkan perintah info-pengguna ke pengguna zuser </li><li>  zuser dibatasi melalui pembungkus untuk menjalankan perintah ls dan cat </li></ul><br><br>  Sayangnya metode ini tidak menjamin keamanan 100%, dan dengan pengetahuan dan kualifikasi tertentu, pengguna dapat meninggalkan shell ini.  Terima kasih kepada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">Jouretz</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">arheops</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">YaDr</a> di komentar mereka <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" class="user_link">memberikan</a> contoh menghindari pembatasan shell. <br><br>  Kerentanan berikut ada dalam solusi ini (Shell Escape), yang harus diperhitungkan: <br><table><tbody><tr><td>  PATH </td><td>  Kemampuan untuk mengubah variabel PATH </td></tr><tr><td>  Salin file dengan scp </td><td>  Kemampuan untuk mengunggah skrip Anda </td></tr><tr><td>  Saat menghubungkan melalui ssh, Anda dapat mengganti shell </td><td><pre> <code class="bash hljs">ssh zuser@xxxx -t <span class="hljs-string"><span class="hljs-string">"/bin/bash"</span></span></code> </pre> </td></tr><tr><td>  Saat menghubungkan melalui ssh, Anda dapat mengubah file konfigurasi shell </td><td><pre> <code class="bash hljs">ssh zuser@xxxx -t <span class="hljs-string"><span class="hljs-string">"bash --noprofile"</span></span></code> </pre> </td></tr><tr><td>  Saat menghubungkan melalui ssh, Anda dapat menggunakan ShellShock </td><td><pre> <code class="bash hljs">ssh zuser@xxxx -t <span class="hljs-string"><span class="hljs-string">"() { :; }; /bin/bash"</span></span></code> </pre> </td></tr><tr><td>  Melalui utilitas vi, vim </td><td><pre> <code class="bash hljs">:!bash</code> </pre> </td></tr><tr><td>  Melalui utilitas vi, vim </td><td><pre> <code class="bash hljs">:<span class="hljs-built_in"><span class="hljs-built_in">set</span></span> shell=/bin/bash :shell</code> </pre> </td></tr><tr><td>  Melalui manusia utilitas, lebih banyak, lebih sedikit </td><td><pre> <code class="bash hljs">!bash</code> </pre> </td></tr><tr><td>  Melalui utilitas find </td><td><pre> <code class="bash hljs">find . -maxdepth 0 -execdir /bin/bash \;</code> </pre> </td></tr><tr><td>  Melalui utilitas awk </td><td><pre> <code class="bash hljs">awk <span class="hljs-string"><span class="hljs-string">'BEGIN {system("/bin/bash")}'</span></span></code> </pre> </td></tr><tr><td>  Melalui utilitas nmap </td><td><pre> <code class="bash hljs">nmap --interactive</code> </pre> </td></tr><tr><td>  Melalui utilitas nmap </td><td><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"os.execute('/bin/sh')"</span></span> &gt; exploit.nse nmap --script=exploit.nse</code> </pre> </td></tr><tr><td>  Melalui perl </td><td><pre> <code class="bash hljs">perl -e <span class="hljs-string"><span class="hljs-string">'exec "/bin/bash";'</span></span></code> </pre> </td></tr><tr><td>  Melalui python </td><td><pre> <code class="bash hljs">python -c <span class="hljs-string"><span class="hljs-string">'import pty; pty.spawn("/bin/bash")'</span></span></code> </pre> </td></tr><tr><td>  Melalui ruby </td><td><pre> <code class="bash hljs">ruby: <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> <span class="hljs-string"><span class="hljs-string">"/bin/bash"</span></span></code> </pre> </td></tr><tr><td>  Melalui LD_PRELOAD </td><td>  Buat file evil.c: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdio.h&gt; #include &lt;unistd.h&gt; #include &lt;sys/types.h&gt; #include &lt;stdlib.h&gt; void _init() { unsetenv("LD_PRELOAD"); setgid(0); setuid(0); system("echo work"); system("/bin/bash --noprofile"); }</span></span></span></span></code> </pre> <br>  Kami mengkompilasi: <br><pre> <code class="bash hljs">gcc -fPIC -shared -o evil.so evil.c -nostartfiles</code> </pre> <br>  Kami mentransfer file evil.so yang dihasilkan ke mesin dengan konsol tertutup dan berjalan: <br><pre> <code class="bash hljs">LD_PRELOAD=<span class="hljs-variable"><span class="hljs-variable">$PWD</span></span>/evil.so ls</code> </pre> <br>  Sebagai argumen, perintah apa pun yang tersedia </td></tr></tbody></table><br>  Karena adanya sejumlah besar kerentanan, metode ini hanya dapat digunakan untuk pengguna lokal pada sistem yang tidak kritis, untuk akses melalui jaringan melalui ssh, lebih baik menggunakan chroot atau utilitas lain untuk membatasi kemampuan pengguna. <br><br>  Semoga informasi ini bermanfaat. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id437710/">https://habr.com/ru/post/id437710/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id437696/index.html">Intisari materi menarik untuk pengembang seluler # 283 (pada 21 - 27 Januari)</a></li>
<li><a href="../id437698/index.html">Layanan terjemahan paten WIPO Translate - pengalaman saya</a></li>
<li><a href="../id437702/index.html">Parsing Wawancara Kerja Google: Pertanyaan Sinonim</a></li>
<li><a href="../id437704/index.html">Pengetahuan yang sangat baik tentang kurikulum sekolah sebagai indikator bukan kecerdasan tertinggi</a></li>
<li><a href="../id437706/index.html">Tahun dengan Tesla</a></li>
<li><a href="../id437712/index.html">Stasiun Luar Angkasa Roskomnadzor</a></li>
<li><a href="../id437714/index.html">Kami menggambar ledakan kartun untuk 180 garis telanjang C ++</a></li>
<li><a href="../id437716/index.html">Tiga cara yang relatif jujur ‚Äã‚Äãuntuk membuat proyek Flutter</a></li>
<li><a href="../id437720/index.html">Perjuangan untuk solusi berkualitas di Erlang / Elixir</a></li>
<li><a href="../id437722/index.html">Konsekuensi Kosmik Shatdown Amerika</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>