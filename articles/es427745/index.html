<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>游땵 游 游붂 Consejos y trucos de Kubernetes: acceso a sitios de desarrollo 游낆 游땰 游돖游</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Continuamos una serie de art칤culos pr치cticos sobre c칩mo hacer la vida m치s f치cil para los desarrolladores y desarrolladores en su trabajo diario con Ku...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Consejos y trucos de Kubernetes: acceso a sitios de desarrollo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/427745/">  Continuamos una serie de art칤culos pr치cticos sobre c칩mo hacer la vida m치s f치cil para los desarrolladores y desarrolladores en su trabajo diario con Kubernetes.  Todos ellos se recopilan de nuestra experiencia en la soluci칩n de problemas de los clientes y se mejoran con el tiempo, pero a칰n as칤 no dicen ser ideales: consid칠relos m치s como ideas y espacios en blanco, sugiera sus soluciones y mejoras en los comentarios. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jx/ht/jr/jxhtjry3qmixqrb-_968gbd_qs4.jpeg"></div><br>  Esta vez, se considerar치n dos temas, relacionados condicionalmente con un tema: el acceso del usuario al entorno de desarrollo. <a name="habracut"></a><br><br><h2>  1. 쮺칩mo cerramos los circuitos de desarrollo de usuarios innecesarios? </h2><br>  A menudo nos enfrentamos a la tarea de cerrar todo el circuito de desarrollo (decenas / cientos de aplicaciones) detr치s de la autenticaci칩n b치sica o la lista blanca, para que los robots de b칰squeda o solo personas de terceros no puedan llegar all칤. <br><br>  Por lo general, para limitar el acceso, cada Ingress y aplicaci칩n deben crear <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">secretos de autenticaci칩n b치sicos por separado</a> .  Administrarlos es muy problem치tico al escribir con una docena de aplicaciones.  Por lo tanto, organizamos el control de acceso centralizado. <br><br>  Para hacer esto, nginx se cre칩 con una configuraci칩n de este tipo: <br><br><pre><code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">satisfy</span></span> any; <span class="hljs-attribute"><span class="hljs-attribute">auth_basic</span></span> <span class="hljs-string"><span class="hljs-string">"Authentication or whitelist!"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">auth_basic_user_file</span></span> /etc/nginx/htpasswd/htpasswd; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">10.0.0.0</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">allow</span></span> <span class="hljs-number"><span class="hljs-number">175.28.12.2</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">deny</span></span> all; <span class="hljs-attribute"><span class="hljs-attribute">try_files</span></span> FAKE_NON_EXISTENT <span class="hljs-variable"><span class="hljs-variable">@return200</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-variable"><span class="hljs-variable">@return200</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> Ok; }</code> </pre> <br>  Adem치s en los Ingresss de la aplicaci칩n, simplemente agregamos la anotaci칩n: <br><br> <code>ingress.kubernetes.io/auth-url: "http://dev-auth.dev-auth-infra.svc.cluster.local"</code> <br> <br>  Por lo tanto, al acceder a la aplicaci칩n, la solicitud va al <code>dev-auth</code> , que verifica si se ingres칩 la autenticaci칩n b치sica correcta o si el cliente ingresa a la lista blanca.  Si se cumple una de las condiciones, la solicitud se confirma y pasa a la aplicaci칩n. <br><br><img src="https://habrastorage.org/webt/zl/oi/-r/zloi-rlzrfp935uovi5762b3qk4.png"><br><br>  En el caso de utilizar dicho servicio, un repositorio es suficiente, en el que se almacena una lista de todos los accesos y a trav칠s del cual podemos configurar convenientemente nuestro "centro de autorizaci칩n 칰nico".  Su distribuci칩n a nuevas aplicaciones se lleva a cabo mediante la adici칩n elemental de anotaciones. <br><br><h2>  2. 쮺칩mo proporcionamos acceso a las aplicaciones dentro de Kubernetes en un entorno de desarrollo? </h2><br>  <i>... ya sea Redis, RabbitMQ, PostgreSQL o el desarrollador PHP favorito de Xdebug.</i> <br><br>  Muy a menudo, al traducir aplicaciones a Kubernetes, para garantizar una mejor seguridad, tenemos que bloquear el acceso desde el exterior y por completo.  Y luego los desarrolladores que est치n acostumbrados a "ir a su IDE" a la base de datos o a Xdebug experimentan serias dificultades. <br><br>  Para resolver este problema, utilizamos una VPN directamente en el cl칰ster de Kubernetes.  El esquema general se ve de modo que cuando se conecta a un servidor VPN que se ejecuta en K8, en el archivo de configuraci칩n de OpenVPN empujamos la direcci칩n del servidor DNS, que tambi칠n vive en K8.  OpenVPN configura la VPN de tal manera que cuando solicita un recurso dentro de Kubernetes, primero va al servidor DNS de Kubernetes, por ejemplo, detr치s de la direcci칩n del servicio <code>redis.production.svc.cluster.local</code> .  DNS en Kubernetes lo resuelve a 10.244.1.15 y las solicitudes de esta direcci칩n IP pasan por OpenVPN directamente al cl칰ster de Kubernetes. <br><br>  Durante el funcionamiento de esta soluci칩n, logramos expandirla repetidamente.  En particular: <br><br><ol><li>  Como no encontramos un <b>panel de administraci칩n</b> simple y adecuado (para nuestro caso) <b>para contabilizar el acceso a la VPN</b> , tuvimos que crear nuestra propia interfaz simple: el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">gr치fico oficial</a> proporciona solo la opci칩n de ejecutar comandos de consola para emitir certificados. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">El panel de administraci칩n resultante</a> (ver tambi칠n en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Docker Hub</a> ) se ve muy asc칠tico: <br><img src="https://habrastorage.org/webt/jh/3t/yx/jh3tyxlld0gkfuj3xqsx6zqurto.png"><br><br>  Puede crear nuevos usuarios o revocar certificados antiguos: <br><img src="https://habrastorage.org/webt/j6/ck/8l/j6ck8labsqw82jyacqzr9pylivk.png"><br><br>  Tambi칠n puede ver la configuraci칩n de este cliente: <br><img src="https://habrastorage.org/webt/xy/ka/yo/xykayonukrklnh8tdp_p3-hyd40.png"><br></li><li>  Agregamos <b>autorizaci칩n en VPN basada en usuarios en GitLab</b> , donde se verifica la contrase침a y si el usuario est치 activo en GitLab.  Esto es para los casos en que el cliente desea administrar usuarios que pueden conectarse a la VPN de desarrollo solo sobre la base de GitLab, y sin el uso de administradores adicionales; en cierto sentido, resulta "SSO para los pobres".  Como base, tomaron el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cuadro</a> ya mencionado. <br><br>  Para hacer esto, escribimos un script de Python que, al conectar un usuario a OpenVPN, usando el nombre de usuario y la contrase침a, compara el hash en la base de datos de GitLab y verifica su estado (si est치 activo). <br><br><img src="https://habrastorage.org/webt/eb/s6/gg/ebs6ggujgreuw3szeqaebnadpgm.png"><br><br>  Aqu칤 est치 el script en s칤: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python3 # pip3 install psycopg2-binary bcrypt import bcrypt import sys import os import psycopg2 import yaml with open("/etc/openvpn/setup/config.yaml", 'r') as ymlfile: cfg = yaml.load(ymlfile) def get_user_info(username=''): try: connect_str = "dbname=%s user=%s host=%s password=%s" % (cfg['db'], cfg['user'], cfg['host'], cfg['pass']) # use our connection values to establish a connection conn = psycopg2.connect(connect_str) # create a psycopg2 cursor that can execute queries cursor = conn.cursor() # create a new table with a single column called "name" cursor.execute("""SELECT encrypted_password,state FROM users WHERE username='%s';""" % username) # run a SELECT statement - no data in there, but we can try it rows = cursor.fetchall() print(rows) return(rows[0]) except Exception as e: print("Uh oh, can't connect. Invalid dbname, user or password?") print(e) def check_user_auth(): username = os.environ['username'] password = bytes(os.environ['password'], 'utf-8') # hashed = bcrypt.hashpw(password, bcrypt.gensalt()) user_info = get_user_info(username=username) user_encrypted_password = bytes(user_info[0], 'utf-8') user_state = True if user_info[1] == 'active' else False if bcrypt.checkpw(password, user_encrypted_password) and user_state: print("It matches!") sys.exit(0) else: print("It does not match :(") sys.exit(1) def main(): check_user_auth() if __name__ == '__main__': main()</span></span></code> </pre> <br>  Y en la configuraci칩n de OpenVPN solo especifique lo siguiente: <br><br> <code>auth-user-pass-verify /etc/openvpn/auth-user.py via-env <br> script-security 3 <br> client-cert-not-required</code> <br> <br>  Por lo tanto, si un empleado dejaba al cliente, simplemente lo desactivaban en GitLab, despu칠s de lo cual no podr칤a conectarse a la VPN. </li></ol><br><h2>  En lugar de una conclusi칩n </h2><br>  Continuando con una serie de art칤culos con recetas pr치cticas de Flant para la operaci칩n de Kubernetes, cubrir칠 temas como resaltar nodos individuales para tareas espec칤ficas (쯣or qu칠 y c칩mo?) Y configurar servicios como php-fpm / gunicorn que se ejecutan en contenedores para cargas pesadas.  춰Suscr칤bete a nuestro blog para no perderte las actualizaciones! <br><br><h2>  PS </h2><br>  Otros del ciclo de consejos y trucos de K8s: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">P치ginas de error personalizadas en NGINX Ingress</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Transferencia de recursos que trabajan en un cl칰ster a la gesti칩n de Helm 2</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sobre la asignaci칩n de nodos y la carga en la aplicaci칩n web</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Acelerar el arranque de grandes bases de datos</a> " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">.</a> </li></ul><br>  Lea tambi칠n en nuestro blog: <br><br><ul><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">11 maneras de (no) convertirse en una v칤ctima del pirateo de Kubernetes</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Crear e instalar aplicaciones en Kubernetes utilizando dapp y GitLab CI</a> "; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Monitoreo y Kubernetes</a> " <i>(informe de revisi칩n y video)</i> ; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nuestra experiencia con Kubernetes en peque침os proyectos</a> " <i>(informe en video, que incluye una introducci칩n al dispositivo t칠cnico Kubernetes)</i> . </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427745/">https://habr.com/ru/post/es427745/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427735/index.html">An치lisis del juego de Classmates en Joker 2018</a></li>
<li><a href="../es427737/index.html">Viaje a la tierra de los gigantes: Rese침a de ONYX BOOX Gulliver</a></li>
<li><a href="../es427739/index.html">DDD, Hexagonal, Onion, Clean, CQRS ... c칩mo lo arm칠 todo</a></li>
<li><a href="../es427741/index.html">Generador de c칩digo para Laravel - para entrada OAS, para salida JSON-API</a></li>
<li><a href="../es427743/index.html">Divertido y extra침o: hemos reunido consultas de b칰squeda que nos gustan</a></li>
<li><a href="../es427747/index.html">A qui칠n aplastar un auto no tripulado: resultados del experimento Moral Machine</a></li>
<li><a href="../es427749/index.html">Apple y Samsung multados por primera vez por ralentizar tel칠fonos viejos</a></li>
<li><a href="../es427751/index.html">Ideas sublimes de CudaText</a></li>
<li><a href="../es427755/index.html">Nueva versi칩n de GitLab 11.4 con revisi칩n por pares de solicitudes de fusi칩n y marcas de funciones</a></li>
<li><a href="../es427757/index.html">Puertas traseras de microc칩digo ensambladas con procesador X86</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>