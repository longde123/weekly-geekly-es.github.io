<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💅🏻 🙍🏼 🙋🏾 Schrieb API - brach XML (zwei) 💗 👆 👂🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Die erste MyStore-API wurde vor 10 Jahren veröffentlicht. Während dieser ganzen Zeit arbeiten wir an vorhandenen Versionen der API und entwickeln neue...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Schrieb API - brach XML (zwei)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/moysklad/blog/453136/">  Die erste MyStore-API wurde vor 10 Jahren veröffentlicht.  Während dieser ganzen Zeit arbeiten wir an vorhandenen Versionen der API und entwickeln neue.  Und mehrere Versionen der API wurden bereits begraben. <br><br>  Dieser Artikel enthält viele Informationen: Wie wird die API erstellt, warum wird der Cloud-Dienst benötigt, was gibt den Benutzern, auf welchen Rake wir getreten sind und was wir als Nächstes tun möchten. <br><a name="habracut"></a><br>  Mein Name ist Oleg Alekseev <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">oalexeev</a> , ich bin der technische Direktor und Mitbegründer von MySklad. <br><br><h2>  Warum eine API für einen Dienst erstellen? </h2><br>  Unsere Kunden, die Zehntausende von Unternehmern sind, nutzen aktiv Cloud-Lösungen: Banking, Online-Shops, Produktbuchhaltung, CRM.  Verbunden mit einem - und es ist schon schwierig aufzuhören.  Und jetzt erleichtert der fünfte, achte und zehnte Dienst die Arbeit des Unternehmers, aber Benutzer übertragen Daten manuell zwischen diesen Cloud-Diensten.  Arbeit wird zum Albtraum. <br><br>  Die naheliegende Lösung besteht darin, Benutzern die Möglichkeit zu geben, Daten zwischen Cloud-Diensten zu übertragen.  Importieren und exportieren Sie beispielsweise Daten als Dateien, die dann auf den gewünschten Dienst heruntergeladen werden können.  Dateien werden normalerweise in das Format jedes Dienstes geändert.  Dies ist mehr oder weniger einfache manuelle Arbeit, aber mit zunehmender Anzahl dieser Dienste wird es schwieriger, sie auszuführen. <br><br>  Daher ist der nächste Schritt die API.  Damit profitiert ein Cloud-Dienst von der Verbindung mehrerer Dienste an einem Punkt.  Die Entstehung eines solchen Ökosystems zieht aufgrund zusätzlicher Möglichkeiten neue Kunden an.  Ein Produkt mit neuen Funktionen wird rentabler und nützlicher. <br><br>  Wenn Sie Ihre eigenen Programmschnittstellen erstellen, zieht dies Drittanbieter in Form von Programmierern an, die dank der API über Ihr Produkt Bescheid wissen.  Sie beginnen, Lösungen basierend auf der vorgeschlagenen API zu entwickeln und verdienen Geld, indem sie die Aufgaben ihrer Kunden automatisieren. <br><br>  Das Buchhaltungssystem von MyStore basiert auf einfachen Prozessen.  Die Hauptsache ist die Arbeit mit Primärdokumenten, die Fähigkeit, Waren anzunehmen und zu versenden und Geschäftsberichte auf der Grundlage der Primärdokumente zu erhalten.  Es gibt auch Datenübertragungen, zum Beispiel in die Cloud-Buchhaltung, und deren Empfang von Bankensystemen oder Einzelhandelsgeschäften.  Wir arbeiten auch mit Online-Shops zusammen: Wir erhalten Informationen über Waren und senden Daten über Salden. <br><br><img src="https://habrastorage.org/webt/bu/cm/xx/bucmxx8qzy9efcgtznvyncdprje.png" alt="Der Datenzyklus um Online-Shops in MyStore"><br><br><h2>  Erste MyStore-API </h2><br>  In über 10 Jahren Arbeit von MyStore mit der API haben wir alle Arten von Integrationen erworben, mit denen Sie Daten austauschen, mit Banken zusammenarbeiten, Zahlungen tätigen und externe Telefonie nutzen können. <br><br>  Im ersten Jahr haben wir es möglich gemacht, Daten im XML-Format hochzuladen.  Dann war es für Benutzer viel verständlicher und vertrauter, die Daten offline und nicht in einer Art Cloud zu halten, und wir gaben ihnen dies.  Das Entladen wurde durch manuellen Export von der Schnittstelle gestartet.  Das heißt, die API konnte noch nicht aufgerufen werden. <br><br>  Dann begannen wir mit Rusagro zusammenzuarbeiten - sie nutzten bereits das ERP für Erwachsene, um Produktion und Verkauf zu planen, aber das Laden von Autos in den Werken wurde in MySklad automatisiert.  So erhielten wir die ersten Grundlagen dieser API: Der Austausch zwischen unserem Service und ERP erfolgte durch Senden einer großen Datei mit Daten für alle Arten von Dokumenten. <br><br>  Dies ist eine gute Option für den Batch-Datenaustausch, aber zusammen mit den Dokumenten mussten sie ihre Abhängigkeiten übertragen: Informationen über Waren, Auftragnehmer und Lager.  Eine solche Deponie ist beim Export nicht so schwer zu erzeugen, beim Import jedoch nur schwer zu zerlegen, da alle Informationen in einem Paket enthalten sind: sowohl über neue als auch über bestehende Dokumente. <br><br>  Die erste XML-API hielt nicht lange an - zwei Jahre später begannen wir, sie neu zu erstellen.  Schon zu Beginn seiner Arbeit haben wir beim Erstellen der Software-Schnittstelle einige Fehler gemacht. <br><br><img src="https://habrastorage.org/storage2/51d/0be/dca/51d0bedca4dcedbabf6cf125e2acc93a.jpg" alt="Wie die XML-API erstellt wurde: eine Illustration von einem unserer Architekten. Warten Sie übrigens auf seine Artikel."><br>  <i>Wie die XML-API erstellt wurde: eine Illustration von einem unserer Architekten.</i>  <i>Warten Sie übrigens auf seine Artikel.</i> <br><br>  Hier sind unsere Hauptfehler: <br><br><ol><li>  JAXB-Markup wurde direkt für Entity-Beans durchgeführt.  Wir verwenden den Ruhezustand, um mit der Datenbank zu kommunizieren, und das JAXB-Markup wurde für dieselben Beans erstellt.  Dieser Fehler trat fast sofort auf: Jede Aktualisierung der Datenstruktur führte dazu, dass jeder, der die API verwendet, dringend benachrichtigt oder Krücken erstellt werden mussten, um die Kompatibilität mit der vorherigen Datenstruktur sicherzustellen. </li><li>  Die API wuchs als eine Art Ergänzung, und anfangs haben wir nicht festgestellt, welchen Teil des Produkts sie ausmacht.  Wir haben nicht einmal darüber nachgedacht, ob die API etwas Wichtiges ist, ob es notwendig ist, die Abwärtskompatibilität für die ersten Kunden aufrechtzuerhalten.  Irgendwann betrug die Anzahl der API-Benutzer etwa 5% der gesamten kleinen Anzahl, und ihnen wurde keine Aufmerksamkeit geschenkt.  Die zu gegebener Zeit vorgenommene universelle Filterung hat dazu geführt, dass wir als Backend verwendet werden.  Diese Filterung war überhaupt nicht GraphQL, aber so ähnlich - sie funktionierte durch viele Abfragezeichenfolgenparameter.  Mit einem so leistungsstarken Tool war es für Benutzer schwierig, Widerstand zu leisten, und Anfragen wurden an uns weitergeleitet, sodass sie direkt von der Benutzeroberfläche ihrer Online-Shops gesendet wurden.  Die Situation war eine unangenehme Überraschung, da die Bereitstellung eines solchen Dienstes unterschiedliche Gebühren und ein anderes Verständnis der API selbst als Produkt erfordern sollte. </li><li>  Aufgrund der Tatsache, dass sich die API nicht als Hauptprodukt entwickelt hat, wurde die API-Dokumentation nach dem Restprinzip erstellt und veröffentlicht - durch Reverse Engineering.  Dieser Weg scheint recht einfach und bequem zu sein, widerspricht jedoch der Vertragsarbeit.  Dies ist der Fall, wenn eine bestimmte Komponente mit einem vordefinierten Arbeitsschema vorhanden ist.  Der Entwickler implementiert es gemäß diesem Schema und dieser Aufgabe, die Komponente wird getestet, der Kunde erhält ein Produkt, das der Idee des Analysten entspricht.  Reverse Engineering hingegen wirft ein Produkt auf, das einfach existiert: mit Krücken, seltsamen Lösungen und Fahrrädern anstelle der erforderlichen Funktionalität. </li><li>  Der gesamte Anforderungsstrom, der über die API einging, konnte nur mit einem Nginx-Protokoll oder einem Anwendungsserver analysiert werden.  Dies erlaubte uns nicht, Themenbereiche zu isolieren, außer sie vielleicht nach Benutzern und Abonnenten aufzuteilen.  Wenn es nicht möglich ist, die Registrierung der Anwendung oder der Kunden zu regeln, ist es unmöglich, die Situation zu analysieren.  Dieses Problem hat sich am wenigsten auf die Entwicklung der API ausgewirkt. Es geht vielmehr darum, ihre Relevanz und Funktionalität zu verstehen. </li></ol><br><h2>  Versuch Nummer zwei: REST-API </h2><br>  Im Jahr 2010 haben wir versucht, ein Austauschsystem mit Online-Buchhaltung aufzubauen - BukhSoft.  Nicht abgehoben.  Während des Integrationsprozesses erschien jedoch eine vollwertige API: ein REST-Austauschdienst, bei dem es keine Freiheiten wie Aufrufe von Operationen in Form von RPC-Aufrufen gab.  Die gesamte Kommunikation mit der API wurde zum Ausruhen in einen Standardmodus gebracht: Die Abfragezeichenfolge enthält den Namen der Entität, und die damit ausgeführte Operation wird mithilfe der http-Methode festgelegt.  Wir haben die Filterung zum Zeitpunkt der Aktualisierung von Entitäten hinzugefügt, und Benutzer haben jetzt die Möglichkeit, die Replikation mit ihren Systemen zu erstellen. <br><br>  Im selben Jahr erschien eine API zum Entladen von Lager- und Warenbilanzen.  Die wertvollsten Teile des Systems wurden den Benutzern über die API zur Verfügung gestellt - der Austausch von Primärdokumenten und geschätzten Daten zu Salden und Kosten von Waren. <br><br>  Im Dezember 2015 veröffentlichte RetailCRM die erste Drittanbieter-Bibliothek, die auf unsere API zugreift.  Sie begannen, es ziemlich aktiv zu nutzen, während die Popularität des gesamten Dienstes zunahm, die Last auf der API schneller wuchs als die Last auf der Weboberfläche.  Einmal verwandelte sich das Wachstum in einen Lastsprung. <br><br><img src="https://habrastorage.org/webt/8h/1p/no/8h1pnokzk8grz6kcs3ok0b1txua.png" alt="Hier der Fall des Black Hawk. Oder der Rechen, den wir durchgemacht haben."><br><br><img src="https://habrastorage.org/webt/2n/ry/4h/2nry4hnfml6miv4axqp_cxrgthy.png" alt="Die Lösung ist einfach: Geben Sie allen die gleichen Ressourcen."><br><br>  Und dieser Sprung, der durch den Pfeil links angezeigt wird, führte zu dem völligen Erstaunen des Servers, der unsere API bedient.  Eine Woche lang haben wir verstanden, was genau diese Last erzeugt.  Es stellte sich heraus, dass dies genau die Anfragen sind, die von den Fronten der Kunden an unsere API gesendet werden.  Ungefähr 50 Kunden haben alles gegessen.  Damals erkannten wir einen unserer Fehler - das völlige Fehlen von Grenzen. <br><br>  Infolgedessen haben wir die Anzahl der gleichzeitigen Anforderungen begrenzt.  Von einem Konto aus konnten nicht mehr als zwei Anfragen gleichzeitig geöffnet werden.  Dies reicht aus, um im Replikationsmodus für den Datenaustausch im Stapelmodus zu arbeiten.  Und diejenigen, die uns von diesem Moment an als Backend nutzen wollten, waren gezwungen, die Tarife stärker einzuhalten, da sie die Arbeit an mehreren Konten in ihre Software einführten. <br><br><h2>  Aufräumen </h2><br>  Seit 2014 ist die Nachfrage nach der vorhandenen API zu einem wichtigen Teil des Geschäfts geworden, und die API selbst hat beim Datenaustausch mit Kunden die größte Datenmenge generiert.  2015 haben wir ein Projekt zur Bereinigung der API gestartet.  Wir haben JSON anstelle von XML als Format gewählt und begonnen, es auf der Grundlage der Funktionen zu erstellen, die bei der Implementierung der vorherigen Version enthüllt wurden: <br><br><ol><li>  Möglichkeit zum Verwalten von Versionen.  Mit der Versionierung können Sie eine neue Version entwickeln, ohne eine vorhandene Anwendung zu beeinträchtigen und ohne Benutzer zu stören. </li><li>  Die Fähigkeit des Benutzers, Metadaten in der Antwort zu sehen, die er erhält. </li><li>  Die Möglichkeit, große Dokumente auszutauschen.  Wenn wir ein Dokument mit einer Anzahl von mehr als 4-5 Tausend Positionen verarbeiten, wird dies zu einem Problem für den Server: eine lange Transaktion, eine lange http-Anfrage.  Wir haben einen speziellen Mechanismus entwickelt, mit dem Sie das Dokument in Teilen aktualisieren und einzelne Positionen dieses Dokuments verwalten können, indem Sie sie an den Server senden. </li><li>  Tools für die Replikation - waren in der vorherigen Version. </li><li>  Die Belastungsgrenzen entsprechen dem Erbe des Schwaders, auf den in der vorherigen Version getreten wurde.  Es wurden Beschränkungen für die Anzahl der Anforderungen in einem bestimmten Zeitraum, die Anzahl der gleichzeitigen Anforderungen und Anforderungen von einer IP-Adresse eingeführt. </li></ol><br>  Von diesem Moment an haben wir zwei kleinere Versionen der API veröffentlicht und mehrere spezialisierte APIs gestartet, aber im Allgemeinen blieb der Ansatz unverändert.  Ein aktualisiertes Austauschformat und eine neue Architektur haben es ermöglicht, Mängel in der API viel schneller zu beheben. <br><br><h2>  MyStore API heute </h2><br>  Heute löst die MyStore-API viele Probleme: <br><br><ul><li>  Datenaustausch mit Online-Shops, Buchhaltungssystemen, Banken; </li><li>  Empfangen von Abrechnungsdaten, Berichten; </li><li>  Verwendung als Backend für Clientanwendungen - unsere mobilen Anwendungen und Desktop-Kassen arbeiten über die API </li><li>  Senden von Benachrichtigungen über Datenänderungen in MyStore - Webhooks; </li><li>  Telefonie; </li><li>  Loyalitätssysteme. </li></ul><br>  Basierend auf der API hat unser CEO Askar Rakhimberdiev <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Nashorn</a> in vier Stunden einen Telegrammbot geschrieben, der den Rest durch die API zieht: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">github.com/arahimberdiev/com-lognex-telegram-moysklad-stock</a> <br><br>  Jetzt trockene Zahlen. <br><br>  Hier sind unsere Statistiken für die alte REST-API: <br><br><ul><li>  400 Unternehmen; </li><li>  600 Benutzer; </li><li>  2 Millionen Anfragen pro Tag; </li><li>  200 GB / Tag ausgehenden Verkehrs. </li></ul><br>  Und hier ist, worauf wir mit der gesamten MyStore-API gekommen sind: <br><br><ul><li>  mehr als 70 Integrationen (einige davon finden Sie hier <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">www.moysklad.ru/integratsii</a> ); </li><li>  8500 Unternehmen; </li><li>  12.000 Benutzer; </li><li>  46 Millionen Anfragen pro Tag; </li><li>  2 TB / Tag ausgehenden Verkehrs. </li></ul><br><h2>  Was weiter </h2><br>  API-Entwicklungspläne werden derzeit aktiv diskutiert.  Wir versuchen, die Betriebserfahrung zu berücksichtigen, die uns die Benutzer bieten.  Nicht immer und nicht alles wird sofort erledigt, aber nicht weit entfernt ist die neue Version der API mit bequemeren Metadaten und einer weniger gewichtigen Struktur, OAuth für die Authentifizierung, eine API für in die Schnittstelle integrierte Anwendungen. <br><br>  Sie können die Nachrichten auf einer speziellen Website für Integrationsentwickler mit MySklad verfolgen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">dev.moysklad.ru</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de453136/">https://habr.com/ru/post/de453136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de453120/index.html">So schützen Sie 5G vor Hacking: Erkundung der Sicherheitsarchitektur</a></li>
<li><a href="../de453122/index.html">Kotlin Heroes Programmierwettbewerb</a></li>
<li><a href="../de453126/index.html">UIAppearance war nicht so einfach</a></li>
<li><a href="../de453128/index.html">Telecom Digest: 15 Expertenmaterialien zu IPv6, IS, Standards und Gesetzen in der IT</a></li>
<li><a href="../de453130/index.html">Systematische Korrekturcodes. Linearer Gruppencode</a></li>
<li><a href="../de453138/index.html">Kunst und Wissenschaft: VITAE-Projekt - viele Palmendrucke auf einer Mondblume</a></li>
<li><a href="../de453140/index.html">Wer stiehlt die virtuelle CPU-Zeit?</a></li>
<li><a href="../de453146/index.html">So holen Sie das Beste aus einer Konferenz heraus</a></li>
<li><a href="../de453148/index.html">AirBnb vernachlässigt seine Konten</a></li>
<li><a href="../de453154/index.html">Internet-Verlauf: Verbesserung der Interaktivität</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>