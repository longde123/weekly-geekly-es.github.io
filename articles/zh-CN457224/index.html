<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ™†ğŸ» ğŸ™…ğŸ¿ ğŸ‘ Androidä¸­ç«äº‰çš„ç°ä»£æ–¹æ³•ï¼šKotlinçš„Corotins ğŸ§— ğŸ‘¨ğŸ¾â€âš–ï¸ ğŸ”</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å“ˆHaï¼ 

 æˆ‘ä»¬æé†’æ‚¨ï¼Œæˆ‘ä»¬å·²ç»ä»è‘—åçš„ã€Šå¤§ä¹¦å‘†å­ç‰§åœºæŒ‡å—ã€‹ç³»åˆ—ä¸­é¢„è®¢äº†äººä»¬æœŸå¾…å·²ä¹…çš„æœ‰å…³Kotlinè¯­è¨€çš„ä¹¦ ã€‚ ä»Šå¤©ï¼Œæˆ‘ä»¬å†³å®šæè¯·æ‚¨æ³¨æ„ä¸€ç¯‡æ–‡ç« çš„ç¿»è¯‘ï¼Œè¯¥æ–‡ç« è®²è¿°äº†Kotlinåç¨‹ä»¥åŠAndroidä¸­æµçš„æ­£ç¡®å·¥ä½œã€‚ å¯¹è¯¥ä¸»é¢˜çš„è®¨è®ºéå¸¸æ´»è·ƒï¼Œå› æ­¤ï¼Œä¸ºå®Œæ•´èµ·è§ï¼Œæˆ‘ä»¬è¿˜å»ºè®®æ‚¨é˜…è¯»Habrçš„æœ¬æ–‡å’ŒA...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Androidä¸­ç«äº‰çš„ç°ä»£æ–¹æ³•ï¼šKotlinçš„Corotins</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/457224/">å“ˆHaï¼ <br><br> æˆ‘ä»¬æé†’æ‚¨ï¼Œæˆ‘ä»¬å·²ç»ä»è‘—åçš„ã€Šå¤§ä¹¦å‘†å­ç‰§åœºæŒ‡å—ã€‹ç³»åˆ—ä¸­<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">é¢„è®¢</a>äº†äººä»¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœŸå¾…å·²ä¹…çš„</a>æœ‰å…³Kotlinè¯­è¨€çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¹¦</a> ã€‚ ä»Šå¤©ï¼Œæˆ‘ä»¬å†³å®šæè¯·æ‚¨æ³¨æ„ä¸€ç¯‡æ–‡ç« çš„ç¿»è¯‘ï¼Œè¯¥æ–‡ç« è®²è¿°äº†Kotlinåç¨‹ä»¥åŠAndroidä¸­æµçš„æ­£ç¡®å·¥ä½œã€‚ å¯¹è¯¥ä¸»é¢˜çš„è®¨è®ºéå¸¸æ´»è·ƒï¼Œå› æ­¤ï¼Œä¸ºå®Œæ•´èµ·è§ï¼Œæˆ‘ä»¬è¿˜å»ºè®®æ‚¨é˜…è¯»Habrçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¬æ–‡</a>å’ŒAxmor Softwareåšå®¢çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¯¦ç»†æ–‡ç« </a> ã€‚ <br><a name="habracut"></a><br>  Java / Androidä¸­çš„ç°ä»£ç«äº‰æ¡†æ¶åœ¨å›è°ƒä¸Šâ€‹â€‹é€ æˆåœ°ç‹±ï¼Œå¹¶å¯¼è‡´é˜»å¡çŠ¶æ€ï¼Œå› ä¸ºAndroidå¹¶æ²¡æœ‰ç›¸å½“ç®€å•çš„æ–¹æ³•æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚ <br><br>  Kotlinåç¨‹æ˜¯éå¸¸æœ‰æ•ˆå’Œå®Œæ•´çš„å·¥å…·åŒ…ï¼Œå¯ä»¥ä½¿ç«äº‰ç®¡ç†å˜å¾—æ›´åŠ è½»æ¾å’Œé«˜æ•ˆã€‚ <br><br>  <b>æš‚åœå’Œé˜»æ­¢ï¼šæœ‰ä»€ä¹ˆåŒºåˆ«</b> <br><br> åç¨‹ä¸æ›¿ä»£çº¿ç¨‹ï¼Œè€Œæ˜¯æä¾›ç”¨äºç®¡ç†çº¿ç¨‹çš„æ¡†æ¶ã€‚  corutinçš„ç†å¿µæ˜¯å®šä¹‰ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼Œä½¿æ‚¨å¯ä»¥<b>ç­‰å¾…</b>åå°æ“ä½œå®Œæˆè€Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚ <br><br> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒCorutinçš„ç›®æ ‡æ˜¯æ”¾å¼ƒå›è°ƒå¹¶ç®€åŒ–ç«äº‰ã€‚ <br><br>  <b>æœ€ç®€å•çš„ä¾‹å­</b> <br><br> é¦–å…ˆï¼Œè®©æˆ‘ä»¬ä»¥æœ€ç®€å•çš„ç¤ºä¾‹ä¸ºä¾‹ï¼šåœ¨<code>Main</code> ï¼ˆä¸»çº¿ç¨‹ï¼‰çš„ä¸Šä¸‹æ–‡ä¸­è¿è¡Œcoroutineã€‚ åœ¨å…¶ä¸­ï¼Œæˆ‘ä»¬å°†ä»<code>IO</code>æµä¸­æå–å›¾åƒï¼Œå¹¶å°†è¯¥å›¾åƒå‘é€å›<code>Main</code>è¿›è¡Œå¤„ç†ã€‚ <br><br><pre> <code class="kotlin hljs">launch(Dispatchers.Main) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> image = withContext(Dispatchers.IO) { getImage() } <span class="hljs-comment"><span class="hljs-comment">//    IO imageView.setImageBitmap(image) //     }</span></span></code> </pre> <br> è¯¥ä»£ç ä½œä¸ºå•çº¿ç¨‹å‡½æ•°å¾ˆç®€å•ã€‚ è€Œä¸”ï¼Œå°½ç®¡åœ¨åˆ†é…çš„<code>IO</code>çº¿ç¨‹æ± ä¸­æ‰§è¡Œ<code>getImage</code> ï¼Œä½†ä¸»çº¿ç¨‹æ˜¯ç©ºé—²çš„ï¼Œå¯ä»¥æ‰§è¡Œä»»ä½•å…¶ä»–ä»»åŠ¡ï¼  withContextå‡½æ•°åœ¨å…¶åŠ¨ä½œè¿è¡Œæ—¶æš‚åœå½“å‰åç¨‹ï¼ˆ <code>getImage()</code> ï¼‰ã€‚ ä¸€æ—¦<code>getImage()</code>è¿”å›å¹¶ä¸”ä¸»çº¿ç¨‹ä¸­çš„å¾ªç¯ç¨‹åºå˜å¾—å¯ç”¨ï¼Œåç¨‹å°†åœ¨ä¸»çº¿ç¨‹ä¸­æ¢å¤å·¥ä½œå¹¶è°ƒç”¨<code>imageView.setImageBitmap(image)</code> ã€‚ <br><br> ç¬¬äºŒä¸ªç¤ºä¾‹ï¼šç°åœ¨æˆ‘ä»¬éœ€è¦å®Œæˆ2ä¸ªåå°ä»»åŠ¡ï¼Œä»¥ä¾¿å¯ä»¥ä½¿ç”¨å®ƒä»¬ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨async / awaitäºŒé‡å”±ï¼Œä»¥ä¾¿å¹¶è¡Œæ‰§è¡Œè¿™ä¸¤ä¸ªä»»åŠ¡ï¼Œå¹¶åœ¨ä¸¤ä¸ªä»»åŠ¡å‡†å¤‡å°±ç»ªåç«‹å³åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨å®ƒä»¬çš„ç»“æœï¼š <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> job = launch(Dispatchers.Main) { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deferred1 = async(Dispatchers.Default) { getFirstValue() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deferred2 = async(Dispatchers.IO) { getSecondValue() } useValues(deferred1.await(), deferred2.await()) } job.join() <span class="hljs-comment"><span class="hljs-comment">//    ,     </span></span></code> </pre> <br>  <code>async</code>ä¸<code>launch</code>ç±»ä¼¼ï¼Œä½†è¿”å›çš„æ˜¯<code>deferred</code> ï¼ˆç›¸å½“äº<code>Future</code>çš„Kotlinå®ä½“ï¼‰ï¼Œå› æ­¤å¯ä»¥ä½¿ç”¨<code>await()</code>è·å¾—å…¶ç»“æœã€‚ ä¸å¸¦å‚æ•°è°ƒç”¨æ—¶ï¼Œå®ƒå°†åœ¨å½“å‰ä½œç”¨åŸŸçš„é»˜è®¤ä¸Šä¸‹æ–‡ä¸­å·¥ä½œã€‚ <br><br> åŒæ ·ï¼Œåœ¨ç­‰å¾…2ä¸ªå€¼æ—¶ï¼Œä¸»çº¿ç¨‹ä¿æŒç©ºé—²çŠ¶æ€ã€‚ <br> å¦‚æ‚¨æ‰€è§ï¼Œ <code>launch</code>å‡½æ•°è¿”å›<code>Job</code> ï¼Œå®ƒå¯ä»¥ç”¨æ¥ç­‰å¾…æ“ä½œå®Œæˆ-è¿™æ˜¯é€šè¿‡<code>join()</code>å‡½æ•°å®Œæˆçš„ã€‚ å®ƒçš„å·¥ä½œæ–¹å¼ä¸å…¶ä»–ä»»ä½•è¯­è¨€ä¸€æ ·ï¼Œä½†è¦æ³¨æ„çš„æ˜¯ï¼Œå®ƒåªæ˜¯<b>æš‚åœåç¨‹ï¼Œè€Œä¸é˜»å¡æµç¨‹</b> ã€‚ <br><br>  <b>æ´¾é£</b> <br><br> ä½¿ç”¨ååŒç¨‹åºæ—¶ï¼Œè°ƒåº¦æ˜¯ä¸€ä¸ªå…³é”®æ¦‚å¿µã€‚ æ­¤æ“ä½œä½¿æ‚¨å¯ä»¥ä»ä¸€ä¸ªçº¿ç¨‹â€œè·³è½¬â€åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚ <br><br> è€ƒè™‘ä¸€ä¸‹Javaä¸­<code>Main</code>åˆ†æ´¾çš„ç­‰æ•ˆæƒ…å†µï¼Œå³ <br><br><pre> <code class="kotlin hljs">runOnUiThread: <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> void runOnUiThread(Runnable action) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Thread.currentThread() != mUiThread) { mHandler.post(action); <span class="hljs-comment"><span class="hljs-comment">//  } else { action.run(); //   } }</span></span></code> </pre> <br>  Androidçš„<code>Main</code>ä¸Šä¸‹æ–‡å®ç°æ˜¯åŸºäºå¤„ç†ç¨‹åºçš„è°ƒåº¦ç¨‹åºã€‚ å› æ­¤ï¼Œè¿™ç¡®å®æ˜¯ä¸€ä¸ªéå¸¸åˆé€‚çš„å®ç°ï¼š <br><br><pre> <code class="kotlin hljs">launch(Dispatchers.Main) { ... } vs launch(Dispatchers.Main, CoroutineStart.UNDISPATCHED) { ... } <span class="hljs-comment"><span class="hljs-comment">//   kotlinx 0.26: launch(Dispatchers.Main.immediate) { ... }</span></span></code> </pre> <br>  <code>launch(Dispatchers.Main)</code>å°†<code>Runnable</code>å‘é€ç»™<code>Handler</code> ï¼Œå› æ­¤å…¶ä»£ç ä¸ä¼šç«‹å³æ‰§è¡Œã€‚ <br><br>  <code>launch(Dispatchers.Main, CoroutineStart.UNDISPATCHED)</code>å°†ç«‹å³åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œå…¶lambdaè¡¨è¾¾å¼ã€‚ <br><br>  <code>Dispatchers.Main</code> <b>ç¡®ä¿åç¨‹æ¢å¤å·¥ä½œæ—¶å°†å…¶å®šå‘åˆ°ä¸»çº¿ç¨‹</b> ï¼› å¦å¤–ï¼Œè¿™é‡Œå°†Handlerç”¨ä½œåŸç”ŸAndroidå®ç°ï¼Œä»¥å‘é€åˆ°åº”ç”¨ç¨‹åºäº‹ä»¶å¾ªç¯ã€‚ <br><br> ç¡®åˆ‡çš„å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> Main: HandlerDispatcher = HandlerContext(mainHandler, <span class="hljs-string"><span class="hljs-string">"Main"</span></span>)</code> </pre> <br> è¿™æ˜¯ä¸€ç¯‡å¾ˆå¥½çš„æ–‡ç« ï¼Œå¯ä»¥å¸®åŠ©æ‚¨äº†è§£Androidä¸­è°ƒåº¦çš„å¤æ‚æ€§ï¼š <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">äº†è§£Android Coreï¼šLooperï¼ŒHandlerå’ŒHandlerThread</a> ã€‚ <br><br>  <b>åç¨‹ä¸Šä¸‹æ–‡</b> <br><br> åç¨‹ä¸Šä¸‹æ–‡ï¼ˆä¹Ÿç§°ä¸ºåç¨‹ç®¡ç†å™¨ï¼‰ç¡®å®šå°†åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå…¶ä»£ç ï¼Œå¦‚æœå¼•å‘å¼‚å¸¸ï¼Œè¯¥æ€ä¹ˆåŠï¼Œå¹¶å¼•ç”¨çˆ¶ä¸Šä¸‹æ–‡æ¥ä¼ æ’­å–æ¶ˆã€‚ <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> job = Job() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> exceptionHandler = CoroutineExceptionHandler { coroutineContext, throwable -&gt; whatever(throwable) } launch(Disaptchers.Default+exceptionHandler+job) { ... }</code> </pre> <br>  <code>job.cancel()</code>å°†å–æ¶ˆæ‰€æœ‰çˆ¶å¯¹è±¡ä¸º<code>job</code>åç¨‹ã€‚  exceptionHandlerå°†æ¥æ”¶åœ¨è¿™äº›åç¨‹ä¸­å¼•å‘çš„æ‰€æœ‰å¼‚å¸¸ã€‚ <br><br>  <b>é€‚ç”¨èŒƒå›´</b> <br><br>  <code>coroutineScope</code>æ¥å£ç®€åŒ–äº†é”™è¯¯å¤„ç†ï¼š <br> å¦‚æœå…¶å­åç¨‹ä¸­çš„ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œåˆ™æ•´ä¸ªèŒƒå›´å’Œæ‰€æœ‰å­åç¨‹ä¹Ÿå°†è¢«å–æ¶ˆã€‚ <br><br> åœ¨<code>async</code>ç¤ºä¾‹ä¸­ï¼Œå¦‚æœæ— æ³•æå–è¯¥å€¼ï¼Œè€Œå¦ä¸€é¡¹ä»»åŠ¡ç»§ç»­å·¥ä½œï¼Œåˆ™æˆ‘ä»¬å¤„äºæŸåçŠ¶æ€ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æ­¤è¿›è¡Œä¸€äº›å¤„ç†ã€‚ <br><br> ä½¿ç”¨<code>coroutineScope</code> ï¼Œä»…å½“ä¸¤ä¸ªå€¼çš„æå–æˆåŠŸæ—¶ï¼Œæ‰ä¼šè°ƒç”¨<code>useValues</code>å‡½æ•°ã€‚ å¦å¤–ï¼Œå¦‚æœ<code>deferred2</code>å¤±è´¥ï¼Œåˆ™<code>deferred1</code>å°†è¢«å–æ¶ˆã€‚ <br><br><pre> <code class="kotlin hljs">coroutineScope { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deferred1 = async(Dispatchers.Default) { getFirstValue() } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> deferred2 = async(Dispatchers.IO) { getSecondValue() } useValues(deferred1.await(), deferred2.await()) }</code> </pre> <br> æ‚¨è¿˜å¯ä»¥â€œæ”¾å…¥ä½œç”¨åŸŸâ€æ•´ä¸ªç±»æ¥ä¸ºå…¶è®¾ç½®é»˜è®¤çš„<code>CoroutineContext</code>å¹¶ä½¿ç”¨å®ƒã€‚ <br><br> å®ç°<code>CoroutineScope</code>æ¥å£çš„ç¤ºä¾‹ç±»ï¼š <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ScopedViewModel</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ViewModel</span></span></span></span>(), CoroutineScope { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> job = Job() <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> coroutineContext = Dispatchers.Main+job <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCleared</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCleared() job.cancel() } }</code> </pre> <br> åœ¨<code>CoroutineScope</code>è¿è¡Œ<code>CoroutineScope</code> ï¼š <br><br> ç°åœ¨ï¼Œé»˜è®¤çš„<code>launch</code>æˆ–<code>async</code>ç®¡ç†å™¨å°†æˆä¸ºå½“å‰çš„ä½œç”¨åŸŸç®¡ç†å™¨ã€‚ <br><br><pre> <code class="kotlin hljs">launch { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> foo = withContext(Dispatchers.IO) { â€¦ } <span class="hljs-comment"><span class="hljs-comment">// -    CoroutineContext   â€¦ } launch(Dispatchers.Default) { // -        â€¦ }</span></span></code> </pre> <br> åç¨‹çš„è‡ªåŠ¨å¯åŠ¨ï¼ˆåœ¨ä»»ä½•CoroutineScopeä¹‹å¤–ï¼‰ï¼š <br><br><pre> <code class="kotlin hljs">GlobalScope.launch(Dispatchers.Main) { <span class="hljs-comment"><span class="hljs-comment">// -    . â€¦ }</span></span></code> </pre> <br> æ‚¨ç”šè‡³å¯ä»¥é€šè¿‡è®¾ç½®é»˜è®¤çš„<code>Main</code>è°ƒåº¦ç¨‹åºæ¥å®šä¹‰åº”ç”¨ç¨‹åºçš„èŒƒå›´ï¼š <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">object</span></span> AppScope : CoroutineScope <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> GlobalScope { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> coroutineContext = Dispatchers.Main.immediate }</code> </pre><br>  <b>å¤‡æ³¨</b> <br><br><ul><li> åç¨‹é™åˆ¶äº†ä¸Javaçš„äº’æ“ä½œæ€§ </li><li> é™åˆ¶å¯å˜æ€§ä»¥é¿å…é”å®š </li><li> åç¨‹æ—¨åœ¨ç­‰å¾…è€Œä¸æ˜¯ç»„ç»‡çº¿ç¨‹ </li><li> é¿å…åœ¨<code>Dispatchers.Default</code> ï¼ˆå’Œ<code>Main</code> ...ï¼‰ä¸­ä½¿ç”¨I / O-è¿™å°±æ˜¯Dispatchers.IOçš„ç”¨é€” </li><li> æµæ¶ˆè€—èµ„æºï¼Œå› æ­¤ä½¿ç”¨å•çº¿ç¨‹ä¸Šä¸‹æ–‡ </li><li>  <code>Dispatchers.Default</code>åŸºäºAndroid 5+ä¸­å¼•å…¥çš„<code>ForkJoinPool</code> </li><li> åç¨‹å¯ä»¥é€šè¿‡æ¸ é“ä½¿ç”¨ </li></ul><br>  <b>ä½¿ç”¨é€šé“æ‘†è„±é”å’Œå›è°ƒ</b> <br><br>  JetBrainsæ–‡æ¡£ä¸­çš„æ¸ é“å®šä¹‰ï¼š <br><br><blockquote>  Channel <code>Channel</code>æ¦‚å¿µä¸Šä¸<code>BlockingQueue</code>éå¸¸ç›¸ä¼¼ã€‚ å…³é”®åŒºåˆ«åœ¨äºï¼Œå®ƒä¸ä¼šé˜»æ­¢æ”¾ç½®æ“ä½œï¼Œè€Œæ˜¯æä¾›äº†æŒ‚èµ·<code>send</code> ï¼ˆæˆ–éé˜»æ­¢<code>offer</code> ï¼‰ï¼Œå¹¶ä¸”æä¾›äº†æš‚åœ<code>receive</code> ï¼Œè€Œä¸æ˜¯é˜»æ­¢äº†è·å–æ“ä½œã€‚ </blockquote><br><br>  <b>æ¼”å‘˜ä»¬</b> <br><br> è€ƒè™‘ä¸€ä¸ªä½¿ç”¨æ¸ é“çš„ç®€å•å·¥å…·ï¼š <code>Actor</code> ã€‚ <br><br> åŒæ ·ï¼Œ <code>Actor</code>ä¸<code>Handler</code>éå¸¸ç›¸ä¼¼ï¼šæˆ‘ä»¬å®šä¹‰åç¨‹çš„ä¸Šä¸‹æ–‡ï¼ˆå³ï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­æ‰§è¡Œæ“ä½œçš„çº¿ç¨‹ï¼‰å¹¶æŒ‰é¡ºåºä½¿ç”¨å®ƒã€‚ <br><br> å½“ç„¶ï¼ŒåŒºåˆ«åœ¨äºè¿™é‡Œä½¿ç”¨äº†Corutinsã€‚  <b>æ‚¨å¯ä»¥æŒ‡å®šç”µæºä»¥åŠæ‰§è¡Œçš„ä»£ç -pause</b> ã€‚ <br><br> åŸåˆ™ä¸Šï¼Œ <code>actor</code>ä¼šå°†ä»»ä½•å‘½ä»¤é‡å®šå‘åˆ°åç¨‹é€šé“ã€‚ å®ƒ<b>ä¿è¯å‘½ä»¤çš„æ‰§è¡Œï¼Œå¹¶é™åˆ¶å…¶ä¸Šä¸‹æ–‡ä¸­çš„æ“ä½œ</b> ã€‚ è¿™ç§æ–¹æ³•éå¸¸æœ‰åŠ©äºæ‘†è„±<code>synchronize</code>è°ƒç”¨å¹¶ä¿æŒæ‰€æœ‰çº¿ç¨‹ç©ºé—²ï¼ <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> updateActor <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> lazy { actor&lt;Update&gt;(capacity = Channel.UNLIMITED) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (update <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> channel) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> (update) { Refresh -&gt; updateList() <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Filter -&gt; filter.filter(update.query) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> MediaUpdate -&gt; updateItems(update.mediaList <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> List&lt;T&gt;) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> MediaAddition -&gt; addMedia(update.media <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> T) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> MediaListAddition -&gt; addMedia(update.mediaList <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> List&lt;T&gt;) <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> MediaRemoval -&gt; removeMedia(update.media <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> T) } } } <span class="hljs-comment"><span class="hljs-comment">//  fun filter(query: String?) = updateActor.offer(Filter(query)) //  suspend fun filter(query: String?) = updateActor.send(Filter(query))</span></span></code> </pre> <br> åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å¯†å°çš„Kotlinç±»ï¼Œé€‰æ‹©è¦æ‰§è¡Œçš„åŠ¨ä½œã€‚ <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Update</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Refresh</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Update</span></span></span></span>() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Filter</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> query: String?) : Update() <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MediaAddition</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> media: Media) : Update()</code> </pre> <br> è€Œä¸”ï¼Œæ‰€æœ‰è¿™äº›åŠ¨ä½œéƒ½å°†æ’é˜Ÿï¼Œå®ƒä»¬å°†æ°¸è¿œä¸ä¼šå¹¶è¡Œæ‰§è¡Œã€‚ è¿™æ˜¯è¾¾åˆ°<b>å¯å˜æ€§é™åˆ¶</b>çš„ä¾¿æ·æ–¹æ³•ã€‚ <br><br>  <b>Androidç”Ÿå‘½å‘¨æœŸ+åç¨‹</b> <br><br>  Actorå¯¹äºæ§åˆ¶Androidç”¨æˆ·ç•Œé¢ï¼Œç®€åŒ–ä»»åŠ¡å–æ¶ˆå¹¶é˜²æ­¢ä¸»çº¿ç¨‹è¿‡è½½ä¹Ÿéå¸¸æœ‰ç”¨ã€‚ <br> è®©æˆ‘ä»¬å®ç°å®ƒï¼Œå¹¶åœ¨æ´»åŠ¨è¢«ç ´åæ—¶è°ƒç”¨<code>job.cancel()</code> ã€‚ <br><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyActivity</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">AppCompatActivity</span></span></span></span>(), CoroutineScope { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> job = SupervisorJob() <span class="hljs-comment"><span class="hljs-comment">//  Job    override val coroutineContext = Dispatchers.Main.immediate+job override fun onDestroy() { super.onDestroy() job.cancel() //      } }</span></span></code> </pre> <br>  <code>SupervisorJob</code>ç±»ä¸å¸¸è§„<code>Job</code>ç±»ä¼¼ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯å–æ¶ˆä»…åœ¨ä¸‹æ¸¸æ–¹å‘ä¸Šè¿›è¡Œã€‚ <br><br> å› æ­¤ï¼Œå½“å…¶ä¸­ä¸€ä¸ªåç¨‹å¤±è´¥æ—¶ï¼Œæˆ‘ä»¬ä¸ä¼šå–æ¶ˆæ‰€æœ‰åç¨‹ã€‚ <br><br> ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ‰©å±•åŠŸèƒ½</a> ï¼Œæ‚¨å¯ä»¥ä»<code>CoroutineContext</code>çš„ä»»ä½•<code>View</code>è®¿é—®æ­¤<code>CoroutineContext</code> ï¼Œä»è€Œä½¿äº‹æƒ…å˜å¾—æ›´å¥½ã€‚ <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> View.coroutineContext: CoroutineContext? <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() = (context <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>? CoroutineScope)?.coroutineContext</code> </pre> <br> ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»“åˆæ‰€æœ‰è¿™äº›ï¼Œ <code>setOnClick</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªç»„åˆçš„actoræ¥æ§åˆ¶å…¶<code>onClick</code>åŠ¨ä½œã€‚ åœ¨å¤šæ¬¡è½»å‡»çš„æƒ…å†µä¸‹ï¼Œä¸­é—´åŠ¨ä½œå°†è¢«å¿½ç•¥ï¼Œä»è€Œæ¶ˆé™¤äº†ANRé”™è¯¯ï¼ˆåº”ç”¨ç¨‹åºä¸å“åº”ï¼‰ï¼Œå¹¶ä¸”è¿™äº›åŠ¨ä½œå°†åœ¨<code>Activity</code>çš„èŒƒå›´å†…æ‰§è¡Œã€‚ å› æ­¤ï¼Œå½“æ´»åŠ¨è¢«é”€æ¯æ—¶ï¼Œæ‰€æœ‰è¿™äº›éƒ½å°†è¢«å–æ¶ˆã€‚ <br><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> View.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setOnClick</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(action: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">suspend</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ()</span></span></span></span> -&gt; <span class="hljs-built_in"><span class="hljs-built_in">Unit</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//         val scope = (context as? CoroutineScope)?: AppScope val eventActor = scope.actor&lt;Unit&gt;(capacity = Channel.CONFLATED) { for (event in channel) action() } //       setOnClickListener { eventActor.offer(Unit) } }</span></span></code> </pre> <br> åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†<code>Channel</code>è®¾ç½®ä¸º<code>Conflated</code>ä»¥ä¾¿åœ¨äº‹ä»¶è¿‡å¤šæ—¶å¿½ç•¥æŸäº›äº‹ä»¶ã€‚ å¦‚æœæ‚¨å¸Œæœ›å°†äº‹ä»¶æ’é˜Ÿè€Œä¸ä¸¢å¤±ä»»ä½•äº‹ä»¶ï¼Œä½†ä»å¸Œæœ›ä¿æŠ¤åº”ç”¨ç¨‹åºå…å—ANRé”™è¯¯çš„å½±å“ï¼Œåˆ™å¯ä»¥å°†å…¶æ›¿æ¢ä¸º<code>Channel.UNLIMITED</code> ã€‚ <br><br> æ‚¨è¿˜å¯ä»¥ç»“åˆåç¨‹å’Œç”Ÿå‘½å‘¨æœŸæ¡†æ¶æ¥è‡ªåŠ¨å–æ¶ˆä¸ç”¨æˆ·ç•Œé¢ç›¸å…³çš„ä»»åŠ¡ï¼š <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> LifecycleOwner.untilDestroy: Job <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> job = Job() lifecycle.addObserver(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>: LifecycleObserver { <span class="hljs-meta"><span class="hljs-meta">@OnLifecycleEvent(Lifecycle.Event.ON_DESTROY)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onDestroy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { job.cancel() } }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> job } <span class="hljs-comment"><span class="hljs-comment">//  GlobalScope.launch(Dispatchers.Main, parent = untilDestroy) { /*    ! */ }</span></span></code> </pre> <br>  <b>é€šè¿‡å›è°ƒç®€åŒ–æƒ…å†µï¼ˆç¬¬1éƒ¨åˆ†ï¼‰</b> <br><br> è¿™æ˜¯é€šè¿‡<code>Channel</code>è½¬æ¢åŸºäºå›è°ƒçš„APIçš„ç”¨æ³•çš„æ–¹æ³•ã€‚ <br><br>  APIçš„å·¥ä½œæ–¹å¼å¦‚ä¸‹ï¼š <br><br><ol><li>  <code>requestBrowsing(url, listener)</code>è§£æä½äº<code>url</code>çš„æ–‡ä»¶å¤¹ã€‚ </li><li>  <code>listener</code>æ”¶åˆ°æ­¤æ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°çš„ä»»ä½•åª’ä½“æ–‡ä»¶çš„<code>onMediaAdded(media: Media)</code> ã€‚ </li><li> è§£ææ–‡ä»¶å¤¹æ—¶è°ƒç”¨<code>listener.onBrowseEnd()</code> </li></ol><br> è¿™æ˜¯VLCæµè§ˆå™¨çš„å†…å®¹æä¾›ç¨‹åºä¸­çš„æ—§<code>refresh</code>åŠŸèƒ½ï¼š <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refreshList = mutableListOf&lt;Media&gt;() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> = requestBrowsing(url, refreshListener) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refreshListener = <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : EventListener{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMediaAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(media: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Media</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { refreshList.add(media)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBrowseEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> list = refreshList.toMutableList() refreshList.clear() launch { dataset.value = list parseSubDirectories() } } }</code> </pre> <br>  <b>å¦‚ä½•æ”¹å–„å‘¢ï¼Ÿ</b> <br><br> åˆ›å»ºä¸€ä¸ªå°†<code>refresh</code>è¿è¡Œçš„é€šé“ã€‚ ç°åœ¨ï¼Œæµè§ˆå™¨å›è°ƒä»…å°†åª’ä½“å®šå‘åˆ°è¯¥é€šé“ï¼Œç„¶åå°†å…¶å…³é—­ã€‚ <br><br> ç°åœ¨ï¼Œ <code>refresh</code>åŠŸèƒ½å˜å¾—æ›´åŠ æ¸…æ™°ã€‚ å¥¹åˆ›å»ºäº†ä¸€ä¸ªé¢‘é“ï¼Œè°ƒç”¨äº†VLCæµè§ˆå™¨ï¼Œç„¶åå½¢æˆäº†ä¸€ä¸ªåª’ä½“æ–‡ä»¶åˆ—è¡¨å¹¶å¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ <br><br> æ‚¨å¯ä»¥ä½¿ç”¨<code>for</code>æ¥ç­‰å¾…åª’ä½“ï¼Œè€Œä¸æ˜¯<code>select</code>æˆ–<code>consumeEach</code>å¹¶ä¸”è¯¥å¾ªç¯å°†åœ¨<code>browserChannel</code>å…³é—­åç«‹å³ä¸­æ–­ã€‚ <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">lateinit</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> browserChannel : Channel&lt;Media&gt; <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMediaAdded</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(media: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Media</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { browserChannel.offer(media) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onBrowseEnd</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { browserChannel.close() } <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">refresh</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { browserChannel = Channel(Channel.UNLIMITED) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> refreshList = mutableListOf&lt;Media&gt;() requestBrowsing(url) <span class="hljs-comment"><span class="hljs-comment">//        for (media in browserChannel) refreshList.add(media) //   dataset.value = refreshList parseSubDirectories() }</span></span></code> </pre> <br>  <b>é€šè¿‡å›è°ƒç®€åŒ–æƒ…å†µï¼ˆç¬¬2éƒ¨åˆ†ï¼‰ï¼šæ”¹è¿›</b> <br><br> ç¬¬äºŒç§æ–¹æ³•ï¼šæˆ‘ä»¬æ ¹æœ¬ä¸ä½¿ç”¨kotlinxåç¨‹ï¼Œè€Œæ˜¯ä½¿ç”¨åç¨‹æ ¸å¿ƒæ¡†æ¶ã€‚ <br><br> çœ‹çœ‹åç¨‹å®é™…ä¸Šæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼ <br><br>  <code>retrofitSuspendCall</code>å‡½æ•°åŒ…è£…<code>Retrofit Call</code>è¯·æ±‚ä»¥ä½¿å…¶æˆä¸º<code>suspend</code>å‡½æ•°ã€‚ <br><br> ä½¿ç”¨<code>suspendCoroutine</code>æˆ‘ä»¬è°ƒç”¨<code>Call.enqueue</code>æ–¹æ³•å¹¶æš‚åœåç¨‹ã€‚ ä»¥è¿™ç§æ–¹å¼æä¾›çš„å›è°ƒå°†åœ¨è°ƒç”¨åç«‹å³è°ƒç”¨<code>continuation.resume(response)</code>ä»¥ä½¿ç”¨æœåŠ¡å™¨çš„å“åº”æ¥æ¢å¤åç¨‹ã€‚ <br><br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬åªéœ€è¦å°†Retrofitå‡½æ•°ç»„åˆåˆ°<code>retrofitSuspendCall</code>å³å¯ä½¿ç”¨å®ƒä»¬è¿”å›æŸ¥è¯¢ç»“æœã€‚ <br><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-type"><span class="hljs-keyword">reified</span></span></span></span><span class="hljs-function"><span class="hljs-type"> T&gt;</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">retrofitSuspendCall</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: ()</span></span></span></span> -&gt; Call &lt;T&gt; ) : Response &lt;T&gt; = suspendCoroutine { continuation -&gt; request.invoke().enqueue(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : Callback&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onResponse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(call: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Call</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;, response: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Response</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { continuation.resume(response) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onFailure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(call: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Call</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;, t: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">Throwable</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { continuation.resumeWithException(t) } }) } <span class="hljs-keyword"><span class="hljs-keyword">suspend</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(path: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> = retrofitSuspendCall { ApiClient.browse(path) } <span class="hljs-comment"><span class="hljs-comment">//  (   Main) livedata.value = Repo.browse(path)</span></span></code> </pre> <br> å› æ­¤ï¼Œé˜»æ­¢ç½‘ç»œçš„å‘¼å«æ˜¯åœ¨ä¸“ç”¨çš„Retrofitçº¿ç¨‹ä¸­è¿›è¡Œçš„ï¼Œåç¨‹åœ¨è¿™é‡Œï¼Œç­‰å¾…æœåŠ¡å™¨çš„å“åº”ï¼Œå¹¶ä¸”åœ¨åº”ç”¨ç¨‹åºä¸­æ— å¤„å¯ä½¿ç”¨ï¼ <br><br> æ­¤å®ç°å—åˆ°<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">gildor / kotlin-coroutines-retrofitåº“çš„</a>å¯å‘ã€‚ <br><br> è¿˜æœ‰ä¸€ä¸ª<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JakeWharton / retrofit2-kotlin-coroutines-adapter</a> ï¼Œå¦å¤–ä¸€ä¸ªå®ç°ä¹Ÿç»™å‡ºäº†ç±»ä¼¼çš„ç»“æœã€‚ <br><br>  <b>ç»“è¯­</b> <br><br>  <code>Channel</code>å¯ä»¥ä»¥è®¸å¤šå…¶ä»–æ–¹å¼ä½¿ç”¨ï¼› è¯·æŸ¥çœ‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">BroadcastChannelï¼Œä»¥</a>è·å¾—å¯èƒ½æœ‰ç”¨çš„æ›´å¼ºå¤§çš„å®ç°ã€‚ <br><br> æ‚¨è¿˜å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç”Ÿäº§</a>åŠŸèƒ½åˆ›å»ºé¢‘é“ã€‚ <br><br> æœ€åï¼Œä½¿ç”¨é€šé“å¯ä»¥æ–¹ä¾¿åœ°ç»„ç»‡UIç»„ä»¶ä¹‹é—´çš„é€šä¿¡ï¼šé€‚é…å™¨å¯ä»¥é€šè¿‡<code>Channel</code>æˆ–ä¾‹å¦‚<code>Actor</code>ç‚¹å‡»äº‹ä»¶ä¼ è¾“åˆ°å…¶ç‰‡æ®µ/æ´»åŠ¨ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN457224/">https://habr.com/ru/post/zh-CN457224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN457204/index.html">Windows PowerShellå’Œé•¿è·¯å¾„</a></li>
<li><a href="../zh-CN457206/index.html">SQLç´¢å¼•ç®¡ç†å™¨-å…³äºSQL Serverï¼Œæ·±å…¥æŒ–æ˜å’Œç´¢å¼•ç»´æŠ¤çš„æ‚ ä¹…å†å²</a></li>
<li><a href="../zh-CN457208/index.html">æ ¹æ®ç¯å¢ƒä¸ºASP.NET Coreç½‘ç«™åŠ¨æ€ç”Ÿæˆrobots.txt</a></li>
<li><a href="../zh-CN457210/index.html">åœ¨ä¸»æœºä¸Šå­˜å‚¨é™æ€èµ„æº</a></li>
<li><a href="../zh-CN457212/index.html">ä¸ºä»€ä¹ˆå¼€å§‹å­¦ä¹ Javaï¼ˆæˆ–å…¶ä»–Javaè¯­è¨€ï¼‰æ°¸è¿œä¸ä¼šå¤ªæ™š</a></li>
<li><a href="../zh-CN457232/index.html">æœºå™¨äººâ€œå¤§é»„èœ‚â€-å›½é™…ç©ºé—´ç«™å†…çš„é¦–æ¬¡è¯•é£</a></li>
<li><a href="../zh-CN457234/index.html">äº§å“è®¤çŸ¥åå·®</a></li>
<li><a href="../zh-CN457236/index.html">ITå…¬å¸å¦‚ä½•åŠªåŠ›é”€å”®éŸ³ä¹</a></li>
<li><a href="../zh-CN457240/index.html">æœ¬å‘¨æ–°é—»ï¼šç¥ç»ç½‘ç»œå’Œæ‹ç…§å›¾åƒï¼ŒYandexè‚¡ä»½çš„å¢é•¿ï¼Œåä¸ºéœ€è¦10äº¿ç¾å…ƒçš„ä¸“åˆ©</a></li>
<li><a href="../zh-CN457246/index.html">å¦‚ä½•ä½¿ç”¨C ++ 17ï¼Œå…ƒç»„å’Œä¸€äº›å¹»æƒ³ä½¿CortexMä¸Šçš„4ä¸ªLEDé—ªçƒ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>