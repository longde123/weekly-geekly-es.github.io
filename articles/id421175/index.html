<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¤™ğŸ½ ğŸ´ó §ó ¢ó ·ó ¬ó ³ó ¿ â–ªï¸ Memantau Cluster Kubernetes dengan Prometheus ğŸ”ƒ ğŸ˜ï¸ ğŸ¥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Halo kolega. 

 Kami baru saja menerjemahkan buku yang menarik dari Brendan Burns, yang berbicara tentang pola desain untuk sistem terdistribusi 

 Se...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Memantau Cluster Kubernetes dengan Prometheus</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/piter/blog/421175/">  Halo kolega. <br><br>  Kami baru saja menerjemahkan buku yang menarik dari Brendan Burns, yang berbicara tentang pola desain untuk sistem terdistribusi <br><br><img src="https://habrastorage.org/webt/v5/ws/9g/v5ws9g2gozqoyrmjuqxe5rif6to.jpeg" align="left">  Selain itu, terjemahan buku " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Mastering Kubernetes</a> " (edisi ke-2) sudah berjalan lancar dan buku penulis tentang Docker akan diterbitkan pada bulan September, dan akan ada posting terpisah tentang hal itu. <br><br>  Kami percaya bahwa perhentian berikutnya di jalan ini adalah sebuah buku tentang Prometheus, jadi hari ini kami membawa kepada Anda terjemahan dari sebuah artikel pendek oleh BjÃ¶rn Wenzel tentang interaksi erat antara Prometheus dan Kubernetes.  Harap ingat untuk berpartisipasi dalam survei ini. <br><a name="habracut"></a><br>  Memantau cluster Kubernetes adalah bisnis yang sangat penting.  Cluster berisi banyak informasi yang memungkinkan Anda untuk menjawab pertanyaan dari kategori: berapa banyak memori dan ruang disk yang tersedia sekarang, seberapa aktif cpu digunakan?  Wadah mana yang menghabiskan berapa banyak sumber daya?  Ini juga mencakup pertanyaan tentang status aplikasi yang berjalan di cluster. <br><br>  Salah satu alat yang dimiliki untuk pekerjaan semacam itu disebut Prometheus.  Didukung oleh Cloud Native Computing Foundation, awalnya Prometheus dikembangkan oleh SoundCloud.  Secara konseptual, Prometheus sangat sederhana: <br><br><h4>  Arsitektur </h4><br>  Server Prometheus dapat berfungsi, misalnya, di kluster Kubernetes dan menerima konfigurasi melalui file khusus.  Konfigurasi ini, khususnya, berisi informasi tentang di mana terminal berada untuk mengumpulkan data setelah interval yang ditentukan.  Kemudian, server Prometheus meminta metrik dari terminal-terminal ini dalam format khusus (biasanya tersedia di <code>/metrics</code> ) dan menyimpannya dalam basis data deret waktu.  Berikut ini adalah contoh singkat: file konfigurasi kecil yang meminta metrik dari modul <code>node_exporter</code> digunakan sebagai agen di setiap node: <br><br><pre> <code class="python hljs">scrape_configs: - job_name: <span class="hljs-string"><span class="hljs-string">"node_exporter"</span></span> scrape_interval: <span class="hljs-string"><span class="hljs-string">"15s"</span></span> target_groups: - targets: [<span class="hljs-string"><span class="hljs-string">'&lt;ip&gt;:9100'</span></span>]</code> </pre> <br>  Pertama kita mendefinisikan nama pekerjaan <code>job_name</code> , kemudian nama ini dapat digunakan untuk meminta metrik di Prometheus, kemudian <code>scrape_interval</code> data <code>scrape_interval</code> dan sekelompok server yang menjalankan <code>node_exporter</code> .  Sekarang Prometheus akan setiap 15 detik meminta server untuk <code>path /metrics</code> ke metrik saat ini.  Itu terlihat seperti ini: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># HELP go_gc_duration_seconds A summary of the GC invocation durations. # TYPE go_gc_duration_seconds summary go_gc_duration_seconds{quantile="0"} 1.4852e-05 go_gc_duration_seconds{quantile="0.25"} 2.0702e-05 go_gc_duration_seconds{quantile="0.5"} 2.2059e-05 ...</span></span></code> </pre> <br>  Pertama, nama metrik diberikan, lalu tanda tangan (informasi dalam kurung kurawal) dan, akhirnya, nilai metrik.  Yang paling menarik adalah fungsi pencarian untuk metrik ini.  Prometheus memiliki <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bahasa permintaan</a> yang sangat kuat untuk tujuan ini. <br><br>  Gagasan utama Prometheus, yang sudah dijelaskan di atas, adalah ini: Prometheus pada jeda waktu yang ditentukan memeriksa port untuk metrik dan menyimpannya dalam basis data deret waktu.  Jika Prometheus tidak dapat menghapus metrik itu sendiri, maka ada fungsi lain yang disebut pushgateway.  Gerbang pushg menerima metrik yang dikirim oleh pekerjaan eksternal, dan Prometheus mengumpulkan informasi dari gateway ini pada interval tertentu. <br><br>  Komponen opsional lain dari arsitektur Prometheus adalah <code>alertmanager</code> .  Komponen <code>alertmanager</code> memungkinkan <code>alertmanager</code> untuk menetapkan batas, dan jika melebihi batasnya, mengirim pemberitahuan melalui email, kendur, atau opsgenie. <br><br>  Selain itu, server Prometheus berisi banyak <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">fitur terintegrasi</a> , misalnya, ia dapat meminta instance EC2 di API Amazon atau meminta pod, node, dan layanan dari Kubernetes.  Ini juga memiliki banyak <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">eksportir</a> , misalnya, <code>node_exporter</code> tersebut.  Eksportir tersebut dapat bekerja, misalnya, pada simpul di mana aplikasi seperti MySQL diinstal dan pada interval tertentu untuk polling aplikasi untuk metrik dan menyediakannya di terminal / metrik, dan server Prometheus dapat mengumpulkan metrik ini dari sana. <br><br>  Selain itu, tidak sulit untuk menulis eksportir Anda sendiri - misalnya, untuk aplikasi yang menyediakan metrik seperti informasi jvm.  Misalnya, ada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">perpustakaan yang</a> dikembangkan oleh Prometheus untuk mengekspor metrik tersebut.  Pustaka ini dapat digunakan bersama dengan Spring, dan juga memungkinkan Anda untuk mendefinisikan metrik Anda sendiri.  Ini adalah contoh dari halaman <code>client_java</code> : <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Controller</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@RequestMapping</span></span>(<span class="hljs-string"><span class="hljs-string">"/"</span></span>) <span class="hljs-meta"><span class="hljs-meta">@PrometheusTimeMethod</span></span>(name = <span class="hljs-string"><span class="hljs-string">"my_controller_path_duration_seconds"</span></span>, help = <span class="hljs-string"><span class="hljs-string">"Some helpful info here"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  - } }</span></span></code> </pre> <br>  Ini adalah metrik yang menjelaskan durasi metode, dan metrik lainnya sekarang dapat diberikan melalui terminal atau didorong melalui pushgateway. <br><br><h4>  Penggunaan di Cluster Kubernetes </h4><br>  Seperti yang saya sebutkan, untuk menggunakan Prometheus di cluster Kubernetes ada kemampuan terintegrasi untuk menghapus informasi dari perapian, simpul dan layanan.  Yang paling menarik, Kubernetes dirancang khusus untuk bekerja dengan Prometheus.  Misalnya, <code>kubelet</code> dan <code>kube-apiserver</code> memberikan metrik yang <code>kube-apiserver</code> di Prometheus, jadi pemantauannya sangat sederhana. <br><br>  Dalam contoh ini, sebagai permulaan, saya menggunakan grafik helm resmi. <br><br>  Bagi saya sendiri, saya sedikit mengubah konfigurasi grafik helm default.  Pertama, saya perlu mengaktifkan <code>rbac</code> di instalasi Prometheus, jika tidak Prometheus tidak dapat mengumpulkan informasi dari <code>kube-apiserver</code> .  Oleh karena itu, saya menulis file values.yaml saya sendiri, yang menjelaskan bagaimana grafik helm harus ditampilkan. <br><br>  Saya membuat perubahan paling sederhana: <br><br><ol><li>  <code>alertmanager.enabled: false</code> , yaitu, membatalkan penyebaran alertmanager di cluster (saya tidak akan menggunakan alertmanager, saya pikir lebih mudah untuk mengkonfigurasi peringatan dengan Grafana) </li><li>  <code>kubeStateMetrics.enabled: false</code> Saya pikir metrik ini mengembalikan hanya beberapa informasi tentang jumlah maksimum perapian.  Ketika Anda pertama kali memulai sistem, informasi ini tidak penting bagi saya </li><li>  <code>server.persistentVolume.enabled: false</code> sampai saya memiliki volume persisten yang dikonfigurasi secara default </li><li>  Saya mengubah konfigurasi pengumpulan informasi di Prometheus, seperti yang dilakukan pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">permintaan tarik di github</a> .  Faktanya adalah bahwa dalam Kubernetes v1.7, metrik cAdvisor bekerja pada port yang berbeda. </li></ol><br>  Setelah itu, Anda dapat memulai Prometheus menggunakan helm: <br><br> <code>helm install stable/prometheus --name prometheus-monitoring -f prometheus-values.yaml</code> <br> <br>  Jadi kami menginstal server Prometheus, dan pada setiap node - instal di bawah node_exporter.  Sekarang Anda dapat pergi ke GUI web Prometheus dan melihat beberapa informasi: <br><br> <code>kubectl port-forward &lt;prometheus-server-pod&gt; 9090</code> <br> <br>  Tangkapan layar berikut menunjukkan untuk tujuan apa Prometheus mengumpulkan informasi (Status / target), dan ketika informasi diambil beberapa kali di yang terakhir: <br><br><img src="https://habrastorage.org/webt/ie/yw/57/ieyw57lw3ilbrb9ywwhexfouwo4.png"><br><br>  Di sini Anda dapat melihat bagaimana Prometheus meminta metrik dari apiserver, node, cadvisor yang berjalan pada node dan titik akhir layanan kubernet.  Anda dapat melihat metrik secara detail dengan membuka Grafik dan menulis kueri untuk melihat informasi yang kami minati: <br><br><img src="https://habrastorage.org/webt/b8/vj/yh/b8vjyhkpmiimp7j43kvrvtflg5u.png"><br><br>  Di sini, misalnya, kita melihat penyimpanan gratis di titik mount â€œ/â€.  Di bagian bawah diagram, tanda tangan ditambahkan yang ditambahkan oleh Prometheus atau sudah tersedia di node_exporter.  Kami menggunakan tanda tangan ini untuk meminta hanya titik mount â€œ/â€. <br><br><h4>  Metrik khusus dengan anotasi </h4><br>  Seperti yang telah diperlihatkan dalam tangkapan layar pertama, di mana tujuan yang diminta metrik dari Demetheus diperoleh, ada juga metrik untuk perapian yang bekerja di kluster.  Salah satu fitur bagus Prometheus adalah kemampuan untuk mengambil informasi dari seluruh perapian.  Jika wadah di perapian menyediakan metrik Prometheus, maka kami dapat mengumpulkan metrik ini menggunakan Prometheus secara otomatis.  Satu-satunya hal yang perlu kita perhatikan adalah menyediakan instalasi dengan dua anotasi;  dalam kasus saya <code>nginx-ingress-controller</code> melakukan ini di luar kotak: <br><br><pre> <code class="plaintext hljs">apiVersion: extensions/v1beta1 kind: Deployment metadata: name: nginx-ingress-controller namespace: ingress-nginx spec: replicas: 1 selector: matchLabels: app: ingress-nginx template: metadata: labels: app: ingress-nginx annotations: prometheus.io/port: '10254' prometheus.io/scrape: 'true' ...</code> </pre> <br>  Di sini kita melihat bahwa templat penyebaran dilengkapi dengan dua anotasi Prometheus.  Yang pertama menjelaskan port yang melaluinya Prometheus harus meminta metrik, dan yang kedua mengaktifkan fungsi pengumpulan data.  Sekarang, Prometheus meminta <code>Kubernetes Api-Server</code> pod yang dianotasi untuk mengumpulkan informasi dan mencoba mengumpulkan informasi dari terminal / metrik. <br><br><h4>  Pekerjaan federasi </h4><br>  Kami memiliki proyek di mana Prometheus digunakan dalam mode gabungan.  Idenya adalah ini: kami hanya mengumpulkan informasi yang hanya dapat diakses dari dalam cluster (atau lebih mudah untuk mengumpulkan informasi ini dari dalam cluster), mengaktifkan mode gabungan dan mendapatkan informasi ini menggunakan Prometheus kedua yang dipasang di luar cluster.  Dengan demikian, dimungkinkan untuk mengumpulkan informasi dari beberapa cluster Kubernetes sekaligus, juga menangkap komponen lain yang tidak dapat diakses dari dalam cluster ini atau tidak terkait dengan cluster ini.  Selain itu, maka tidak perlu untuk menyimpan data yang dikumpulkan dalam cluster untuk waktu yang lama, dan jika ada yang salah dengan cluster, kami dapat mengumpulkan beberapa informasi, misalnya, node_exporter, dari luar cluster. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id421175/">https://habr.com/ru/post/id421175/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id421163/index.html">Apakah ada alternatif Excel untuk penganggaran dan intelijen bisnis</a></li>
<li><a href="../id421165/index.html">Cara mendapatkan umpan balik tanpa mendaftar dan SMS. Tentang ulasan dari kolega dan klien</a></li>
<li><a href="../id421167/index.html">Tutup kerentanan pada pengontrol Wi-Fi dari D-Link</a></li>
<li><a href="../id421171/index.html">Deerploy DevOps MeetUp</a></li>
<li><a href="../id421173/index.html">Tampilan Pencarian Google Kustom</a></li>
<li><a href="../id421177/index.html">Cara menarik spesialis analisis data ketika perusahaan Anda bahkan tidak memiliki situs web</a></li>
<li><a href="../id421179/index.html">HashMap Internal di Jawa</a></li>
<li><a href="../id421183/index.html">Paten IBM drone yang membedakan emosi dan membawa orang kopi. Dan apa lagi yang harus ditulis pada hari Jumat?</a></li>
<li><a href="../id421187/index.html">Belajar mendalam untuk mengidentifikasi lukisan</a></li>
<li><a href="../id421189/index.html">Memigrasi basis data ke versi yang lebih lama dari MS SQL Server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>