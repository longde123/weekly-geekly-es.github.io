<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥« ğŸ‘¨ğŸ¿â€âš–ï¸ ğŸ‘©â€âš•ï¸ å¦‚ä½•è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿæœºï¼Ÿ è¯¦ç»†è¯´ ğŸ‘©ğŸ¾â€ğŸ¤â€ğŸ‘©ğŸ½ ğŸ”’ ğŸ™†ğŸ¿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªè€—æ—¶çš„ä¾‹ç¨‹ã€‚ åŸºç¡€è®¾æ–½å’Œç»„ç»‡è¶Šå¤šï¼Œä¸æ­¤è¿‡ç¨‹ç›¸å…³çš„ç¨‹åºå°±è¶Šå¤šã€‚ æˆ‘ä»¬ä½¿ç”¨PowerShellä½¿è¯¥è¿‡ç¨‹è‡ªåŠ¨åŒ–ã€‚ 

 å¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œæ¬¢è¿æ¥åˆ°å‡¯ç‰¹ã€‚ 




 ç¨‹åºå‘˜ä¸å–œæ¬¢åšåŒé‡å·¥ä½œï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¹Ÿä¸å–œæ¬¢ã€‚ 

 ä»¥ä¸‹æ˜¯æˆ‘ä»¬å…¶ä¸­ä¸€ä½å®¢æˆ·çš„è‡ªåŠ¨åŒ–ç¤ºä¾‹ã€‚ 

 æˆ‘ä»¬å¸Œæœ›ç¡®ä¿ä»»ä½•å·¥ç¨‹å¸ˆæˆ–é¡¹ç›®...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>å¦‚ä½•è‡ªåŠ¨åˆ›å»ºè™šæ‹Ÿæœºï¼Ÿ è¯¦ç»†è¯´</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/icl_services/blog/425129/">åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºæ˜¯ä¸€ä¸ªè€—æ—¶çš„ä¾‹ç¨‹ã€‚ åŸºç¡€è®¾æ–½å’Œç»„ç»‡è¶Šå¤šï¼Œä¸æ­¤è¿‡ç¨‹ç›¸å…³çš„ç¨‹åºå°±è¶Šå¤šã€‚ æˆ‘ä»¬ä½¿ç”¨PowerShellä½¿è¯¥è¿‡ç¨‹è‡ªåŠ¨åŒ–ã€‚ <br><br> å¦‚æœæ‚¨æœ‰å…´è¶£ï¼Œæ¬¢è¿æ¥åˆ°å‡¯ç‰¹ã€‚ <br><br><img src="https://habrastorage.org/webt/fv/fr/cc/fvfrccl_crsi5nfvcnstarorits.jpeg"><br><br><a name="habracut"></a><br> ç¨‹åºå‘˜ä¸å–œæ¬¢åšåŒé‡å·¥ä½œï¼Œç³»ç»Ÿç®¡ç†å‘˜ä¹Ÿä¸å–œæ¬¢ã€‚ <br><br> ä»¥ä¸‹æ˜¯æˆ‘ä»¬å…¶ä¸­ä¸€ä½å®¢æˆ·çš„è‡ªåŠ¨åŒ–ç¤ºä¾‹ã€‚ <br><br> æˆ‘ä»¬å¸Œæœ›ç¡®ä¿ä»»ä½•å·¥ç¨‹å¸ˆæˆ–é¡¹ç›®ç»ç†éƒ½èƒ½ä»¥æœ€å°‘çš„ç²¾åŠ›å’Œæœ€çŸ­çš„æ—¶é—´åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºã€‚ æˆ‘ä»¬çš„å®¢æˆ·æœ‰ä¸€ä¸ªITSMç³»ç»Ÿï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸ºServiceNowï¼Œæˆ‘ä»¬åœ¨æœåŠ¡ç›®å½•ä¸­åˆ›å»ºäº†ç›¸åº”çš„Webè¡¨å•ã€‚ è¦â€œè®¢è´­â€ä¸€å°æ–°æœºå™¨ï¼Œç»ç†éœ€è¦å¡«å†™å­—æ®µå¹¶ç¡®è®¤â€œè®¢è´­â€ï¼Œç„¶åå¯åŠ¨æµç¨‹é“¾ï¼Œç„¶ååœ¨è¾“å‡ºç«¯å‡†å¤‡å¥½æœºå™¨æŠ•å…¥ä½¿ç”¨ã€‚ <br><br> å› æ­¤ï¼Œè®©æˆ‘ä»¬çœ‹ä¸€ä¸‹ç®¡ç†è€…éœ€è¦å®šä¹‰ä»€ä¹ˆæ‰èƒ½åˆ›å»ºæ–°çš„è™šæ‹Ÿæœºï¼š <br><br><img src="https://habrastorage.org/webt/3l/8d/yo/3l8dyowobrfvbgpznotayqjywvu.png"><br><br>  <b>VMæè¿°ï¼šè™šæ‹Ÿæœºæè¿°</b> <b><br></b> è¿™é‡Œéœ€è¦ä¸€äº›æ¾„æ¸…ã€‚ åœ¨æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆä¸­ï¼ŒPowerShell 5.1è¢«ç§¯æä½¿ç”¨ï¼Œå› æ­¤å°½ç®¡ä»…Windowsï¼Œä½†å°†æ¥æˆ‘ä»¬å°†å°è¯•æ·»åŠ å¯¹Unixè®¡ç®—æœºçš„æ”¯æŒå¹¶åˆ‡æ¢åˆ°PowerShell Coreã€‚ <br><br>  <b>æ“ä½œç³»ç»Ÿ</b> ã€‚ ä½¿ç”¨Windows 2008ï¼ˆR2ï¼‰æ²¡æœ‰ç‰¹åˆ«çš„éšœç¢ï¼Œä½†æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ˜¯2012R2æˆ–2016ã€‚ <br><br>  <b>VM Size</b> ï¼Œè™šæ‹Ÿæœºå¤§å°ã€‚ æ¯ç§æƒ…å†µéƒ½å¯ä»¥ä»¥è‡ªå·±çš„æ–¹å¼ç¡®å®šï¼Œåœ¨æ­¤ç¤ºä¾‹ä¸­ä¸ºå°å‹1CPU-4Gb Ramï¼Œä¸­å‹2CPU-8Gbï¼Œå¤§å‹4-16ã€‚ <br><br>  <b>VMå­˜å‚¨</b> ï¼Œç£ç›˜0ï¼ˆCï¼š\ï¼‰å…·æœ‰æ— æ³•æ›´æ”¹çš„å›ºå®šå¤§å°ï¼Œåªæœ‰å¿«é€Ÿ/æ…¢é€Ÿå­˜å‚¨é€‰æ‹©å™¨å¯ç”¨ã€‚  â€œå¿«é€Ÿâ€å¯ä»¥æ˜¯å¸¦æœ‰SSDçš„å­˜å‚¨å±‚ï¼Œâ€œæ…¢é€Ÿâ€å¯ä»¥å­˜å‚¨åœ¨â€œå¸¸è§„â€ HDDï¼ˆå½“ç„¶æ˜¯SANï¼‰ä¸Šã€‚  Disk1ï¼ˆä»Disk2å¼€å§‹ï¼‰è¿˜å…·æœ‰ä¸€ä¸ªç”¨äºé€‰æ‹©â€œå­˜å‚¨â€çš„é€‰æ‹©å™¨ï¼Œä»¥åŠç”¨äºè¾“å…¥æ‰€éœ€å¤§å°ï¼ˆä»¥GBä¸ºå•ä½ï¼‰ï¼Œç”¨äºåˆ†åŒºå’Œç¾¤é›†å¤§å°çš„å­—æ¯ï¼ˆå¯¹äºSQL Serverå¾ˆé‡è¦ï¼‰çš„å­—æ®µã€‚ <br><br>  <b>ä¿¡ä»»</b> ï¼Œæˆ‘ä»¬ç¡®å®šè®¡ç®—æœºæ˜¯å¦å¿…é¡»åŠ å…¥åŸŸï¼Œä»¥åŠæ˜¯å¦å¯ä»¥ä»å…¬å…±ç½‘ç»œè®¿é—®ã€‚ <br><br>  <b>ç±»å‹</b> ï¼Œæœºå™¨ç±»å‹ã€‚ åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œå‡ ä¹æ¯å°æœºå™¨éƒ½å¯ä»¥å®šä¹‰ä¸ºå‰ç«¯æˆ–åç«¯åº”ç”¨ç¨‹åºæˆ–å…¶ä»–åº”ç”¨ç¨‹åºã€‚ æ ¹æ®æ‰€é€‰çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥ç¡®å®šæœ€é€‚åˆè¯¥è®¡ç®—æœºçš„å­ç½‘ã€‚ <br><br>  <b>ç¯å¢ƒ</b> ï¼Œåœ¨å®¢æˆ·çš„åŸºç¡€æ¶æ„ä¸­ï¼Œæœ‰ä¸¤ä¸ªæ•°æ®ä¸­å¿ƒï¼šä¸»è¦ï¼ˆç”Ÿäº§ï¼‰å’Œæ¬¡è¦ï¼ˆå¼€å‘/æµ‹è¯•ï¼‰ï¼ŒDCé€šè¿‡å¿«é€Ÿé€šä¿¡é€šé“è¿æ¥å¹¶æä¾›å®¹é”™èƒ½åŠ›ã€‚ æ ¹æ®åè®®ï¼Œä¸»DCä¸­çš„æ‰€æœ‰è™šæ‹Ÿæœºéƒ½æœ‰ä¸€ä¸ªIPåœ°å€ï¼Œä»10.230å¼€å§‹ï¼Œè€Œä»DCä¸­çš„æ‰€æœ‰è™šæ‹Ÿæœºéƒ½ä»10.231å¼€å§‹ã€‚ <br><br>  <b>ï¼ˆSLAï¼‰æœåŠ¡æ°´å¹³åè®®</b> ï¼Œæ­¤å‚æ•°å½±å“æ­¤æœºå™¨çš„æœåŠ¡è´¨é‡ã€‚ <br><br>  <b>åº”ç”¨é¢†åŸŸ</b> æˆ‘ä»¬å¢åŠ äº†å®‰è£…å’Œé…ç½®SQL Serverçš„åŠŸèƒ½ã€‚ æ‚¨å¿…é¡»é€‰æ‹©ç‰ˆæœ¬ï¼Œå®ä¾‹åç§°å’Œæ’åºè§„åˆ™ã€‚ ä¹Ÿå¯ä»¥åŒæ—¶é…ç½®WebæœåŠ¡å™¨è§’è‰²å’Œæ›´å¤šå…¶ä»–è§’è‰²ã€‚ <br><br> ç°åœ¨æˆ‘ä»¬éœ€è¦ç¡®å®šå¦‚ä½•å­˜å‚¨æ‰€é€‰å€¼ã€‚ æˆ‘ä»¬è®¤ä¸ºæœ€æ–¹ä¾¿çš„æ ¼å¼æ˜¯JSONæ–‡ä»¶ã€‚ å¦‚å‰æ‰€è¿°ï¼Œå®¢æˆ·ç¯å¢ƒä½¿ç”¨ITSM ServiceNowã€‚ é€‰æ‹©æ‰€æœ‰å¿…éœ€çš„å€¼åï¼Œç®¡ç†å™¨å•å‡»â€œè®¢è´­â€æŒ‰é’®ï¼Œç„¶åServiceNowå°†æ‰€æœ‰å‚æ•°ä¼ é€’åˆ°æˆ‘ä»¬çš„PowerShellè„šæœ¬ï¼ˆåˆ°åç«¯ServiceNowï¼‰ï¼Œè¯¥è„šæœ¬å°†åˆ›å»ºJSONæ–‡ä»¶ã€‚ çœ‹èµ·æ¥åƒè¿™æ ·ï¼š <br><br><pre><code class="plaintext hljs">.\CreateConfiguration.ps1 -SecurityZone trusted -VMDescription "VM for CRM System" -Requestor "evgeniy.vpro" -OSVersion 2k16 -OSEdition Standard -BuildNewVM -VMEnvironment Prod -VMServiceLevel GOLD -VMSize Medium -Disk0Tier Fast -Disk1Size 50 -Disk1Tier Eco -Disk1Letter D -MSSQLServer -MSSQLInstanceName "Instance1" -SQLCollation Latin1_General_CI_AS -SQLEdition Standard -Disk2Size 35 -Disk3Size 65</code> </pre> <br><br> åœ¨CreateConfiguration .ps1è„šæœ¬çš„ä¸»ä½“ä¸­ï¼š <br><br><pre> <code class="plaintext hljs"># PowerShell- $config = [ordered]@{} #    . $config.SecurityZone=$SecurityZone</code> </pre><br><br> æœ€åï¼Œå°†æˆ‘ä»¬çš„å¯¹è±¡å¯¼å‡ºåˆ°JSONæ–‡ä»¶ï¼š <br><br><pre> <code class="plaintext hljs">$ServerConfig = New-Object â€“TypeName PSObject $config ConvertTo-Json -InputObject $ServerConfig -Depth 100 | Out-File "C:\Configs\TargetNodes\Build\$($Hostname.ToLower()).json" -Force</code> </pre><br><br> æ ·æœ¬é…ç½®ï¼š <br><br><pre> <code class="plaintext hljs">{ "Hostname": "dsctest552", "SecurityZone": "trusted", "Domain": "testdomain", "Requestor": "evgeniy.vpro", "VM": { "Size": "Medium", "Environment": "Prod", "SLA": "GOLD", "DbEngine": "MSSQL", "RAM": 8, "Storage": [ { "Id": 0, "Tier": "Fast", "Size": "100", "Allocation": 4, "Letter": "C" }, { "Id": 1, "Tier": "Eco", "Size": 50, "Label": "Data", "Allocation": 64, "Letter": "D" }, { "Id": 2, "Tier": "Fast", "Size": 35, "Label": "Data", "Allocation": 64, "Letter": "E" }, { "Id": 3, "Tier": "Fast", "Size": 65, "Label": "Data", "Allocation": 64, "Letter": "F" } ] }, "Network": { "MAC": "", "IP": "10.230.168.50", "Gateway": "10.230.168.1", "VLAN": â€œVLAN168â€ }, "OS": { "Version": "2k16", "Edition": "Standard", "Administrators": [ "LocaAdmin", "testdomain\\ Security-LocalAdmins" ] }, "OU": "OU=Servers,OU=Staging,DC=testdomain", "Applications": [ { "Application": "Microsoft SQL Server 2016", "InstanceName": "vd", "Collation": "Latin1_General_CI_AS", "Edition": "Standard", "Features": "SQLENGINE", "Folders": { "DataRoot": "E:\\MSSQL", "UserDB": "E:\\MSSQL\\MSSQL11.vd\\MSSQL\\Data", "UserLog": "E:\\MSSQL\\MSSQL11.vd\\MSSQL\\Log", "TempDB": "D:\\MSSQL\\MSSQL11.vd\\MSSQL\\TempDB", "TempDBLog": "D:\\MSSQL\\MSSQL11.vd\\MSSQL\\TempDB", "Backup": "E:\\MSSQL\\MSSQL11.vd\\MSSQL\\Backup" }, "MaxMemory": 2147483647 } ], "Description": "VM for CRM", "Certificate": { "File": null, "Thumbprint": null }, "Version": 0 }</code> </pre><br><br> æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼ŒWebè¡¨å•æ²¡æœ‰è™šæ‹Ÿæœºåç§°å’ŒIPåœ°å€ã€‚ æˆ‘ä»¬è‡ªåŠ¨è·å¾—è¿™äº›å€¼ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <br><br>  <b>è®¡ç®—æœºçš„åç§°</b> ITSM ServiceNowæœ‰ä¸€ä¸ªç‰¹æ®Šçš„éƒ¨åˆ†ï¼šCMDBï¼ˆé…ç½®ç®¡ç†æ•°æ®åº“ï¼‰ï¼Œæ­¤æ•°æ®åº“å­˜å‚¨æœ‰å…³ç°æœ‰è™šæ‹Ÿæœºï¼Œå®ƒä»¬çš„çŠ¶æ€ï¼Œæ”¯æŒå›¢é˜Ÿç­‰çš„æ‰€æœ‰è®°å½•ã€‚ æˆ‘ä»¬å·²ç»åˆ›å»ºäº†çº¦200ä¸ªå…·æœ‰å·²åˆ†é…çŠ¶æ€çš„å¤‡ä»½è®°å½•ã€‚ ä¸ºäº†è·å¾—è™šæ‹Ÿæœºçš„åç§°ï¼Œæˆ‘ä»¬å‘CMDBå‘å‡ºRESTè¯·æ±‚ï¼Œå¹¶è·å–ç¬¬ä¸€ä¸ªâ€œå…è´¹â€è®°å½•ï¼Œå¹¶å°†å…¶çŠ¶æ€ä»â€œå·²åˆ†é…â€å®‰è£…æ›´æ”¹ä¸ºâ€œå¾…å¤„ç†â€å®‰è£…ã€‚ <br><br>  <b>IPåœ°å€å’ŒVLAN</b> ï¼Œæˆ‘ä»¬åœ¨ç½‘ç»œä¸Šéƒ¨ç½²äº†IPAM-è¿™æ˜¯Windows Server 2016ä¸­çš„å†…ç½®åŠŸèƒ½ï¼Œå¯è®©æ‚¨ç®¡ç†ç½‘ç»œä¸Šçš„IPåœ°å€ã€‚ å®Œå…¨æ²¡æœ‰å¿…è¦ä½¿ç”¨IPAMçš„æ‰€æœ‰åŠŸèƒ½ï¼ˆDHCPï¼ŒDNSï¼ŒADï¼‰ï¼Œè€Œä»…å°†å…¶ç”¨ä½œå…·æœ‰æ½œåœ¨åŠŸèƒ½æ‰©å±•çš„IPåœ°å€æ•°æ®åº“ã€‚ åˆ›å»ºJSONæ–‡ä»¶çš„è„šæœ¬å‘IPAMè¯·æ±‚å­ç½‘ä¸­çš„ç¬¬ä¸€ä¸ªç©ºé—²IPåœ°å€ã€‚ ç„¶åæ ¹æ®æ‰€é€‰çš„SLAï¼Œç¯å¢ƒï¼Œä¿¡ä»»å’Œç±»å‹å€¼ç¡®å®šVLANå­ç½‘ï¼ˆx / 24å­ç½‘ï¼‰ã€‚ <br> é…ç½®æ–‡ä»¶å·²å‡†å¤‡å°±ç»ªï¼Œæ‰€æœ‰å­—æ®µå‡å·²å°±ç»ªï¼Œæ‚¨å¯ä»¥åˆ›å»ºæœºå™¨ã€‚ é—®é¢˜æ˜¯â€œå¦‚ä½•å­˜å‚¨æˆ‘ä»¬æ‰€æœ‰è„šæœ¬çš„å‡­æ®ï¼Ÿâ€ã€‚ æˆ‘ä»¬ä½¿ç”¨<a href="">CredentialManager</a>åŒ…ã€‚ è¯¥è½¯ä»¶åŒ…ä¸å†…ç½®çš„Windows Credential Manager APIä¸€èµ·ç”¨äºå­˜å‚¨å¯†ç ã€‚ åˆ›å»ºå¯†ç çš„ç¤ºä¾‹ï¼š <br><br><pre> <code class="plaintext hljs">New-StoredCredential -Target "ESXi" -UserName "testdomain.eu\vmwareadm" -Password "veryultraP@ssw00rd." -Type Generic -Persist LocalMachine</code> </pre><br><br> å¯†ç å¯åœ¨æœ¬æœºå’Œå¸æˆ·ä¸­è¯»å–ã€‚ <br><br><pre> <code class="plaintext hljs">$ESXiAdmin = Get-StoredCredential -Type Generic -Target ESXi</code> </pre> <br><br> æˆ‘ä»¬æœ‰ä¸€å°å­˜å‚¨GITæ‰€æœ‰é…ç½®çš„æœåŠ¡å™¨ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥å¯é åœ°è·Ÿè¸ªé…ç½®çš„æ‰€æœ‰æ›´æ”¹ï¼šè°ï¼Œä»€ä¹ˆï¼Œä½•æ—¶ä½•åœ°ã€‚ <br><br> åœ¨æ­¤æœåŠ¡å™¨ä¸Šé…ç½®äº†è®¡åˆ’çš„ä»»åŠ¡ï¼šæ£€æŸ¥åŒ…å«é…ç½®çš„æ–‡ä»¶å¤¹ï¼Œç„¶åå°†æ‰€æœ‰æ›´æ”¹å†™å…¥Windowsäº‹ä»¶æ—¥å¿—ã€‚ <br><br>  15åˆ†é’Ÿåï¼Œè®¡åˆ’çš„ä»»åŠ¡å°†å‘Windows EventLogå†™å…¥å·²æ£€æµ‹åˆ°æ–°çš„é…ç½®æ–‡ä»¶ã€‚ <br><br> ç°åœ¨è¯¥æ£€æŸ¥æ­¤é…ç½®äº†ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼š <br><br><pre> <code class="plaintext hljs">$Configuration=(Get-Content -Raw $File | Out-String | ConvertFrom-Json)</code> </pre> <br><br> å¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼Œæ˜¯æ—¶å€™å¼€å§‹åˆ›å»ºæœºå™¨å¹¶è¿è¡ŒBuildVM.ps1è„šæœ¬äº†ã€‚ <br><br> åœ¨BuildVM.ps1ä¸­ï¼Œæˆ‘ä»¬éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å…·æœ‰è™šæ‹Ÿæœºæ‰€æœ‰ç‰¹å¾çš„æè¿°ï¼šå¤§å°ï¼Œç¯å¢ƒï¼Œslaï¼Œç±»å‹ï¼Œå­˜å‚¨ï¼Œå†…å­˜ï¼Œç½‘ç»œã€‚ <br><br> ç¡®ä¿æ£€æŸ¥åŸºç¡€ç»“æ„ï¼ˆCheckVM.ps1ï¼‰ä¸­æ˜¯å¦å­˜åœ¨å…·æœ‰ç›¸åŒåç§°çš„è®¡ç®—æœºã€‚ <br> æˆ‘ä»¬é€šè¿‡<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">VMWare PowerShell CLI</a>è¿æ¥åˆ°æˆ‘ä»¬çš„vSphereï¼š <br><br><pre> <code class="plaintext hljs">$VmWareAdmin = Get-StoredCredential -Type Generic -Target ESXi Connect-VIServer -Server "vSphereSrv" -Credential $VmWareAdmin | Out-Null</code> </pre><br><br> æ£€æŸ¥åŸºç¡€æ¶æ„ä¸­æ˜¯å¦æœ‰åŒåæœºå™¨ <br><br><pre> <code class="plaintext hljs">$VM=Get-VM $server -ErrorAction SilentlyContinue</code> </pre> <br><br> å¹¶å…³é—­ï¼š <br><br><pre> <code class="plaintext hljs">Disconnect-VIServer * -Force -Confirm:$false</code> </pre> <br><br> ç¡®ä¿è®¡ç®—æœºåœ¨WinRMä¸Šä¹Ÿä¸å¯ç”¨ <br><br><pre> <code class="plaintext hljs">$ping=Test-NetConnection -ComputerName $Configuration.Hostname -CommonTCPPort WINRM -InformationLevel Quiet -ErrorAction SilentlyContinue</code> </pre> <br><br> å¦‚æœ$ VMå’Œ$ pingä¸ºç©ºï¼Œåˆ™å¯ä»¥åˆ›å»ºæ–°è®¡ç®—æœºã€‚  ï¼ˆå½“æœºå™¨å·²åœ¨ESXiä¸­æ‰‹åŠ¨åˆ›å»ºæˆ–è¯¥æœºå™¨åœ¨å¦ä¸€ä¸ªæ•°æ®ä¸­å¿ƒä¸­æ—¶ï¼Œæˆ‘ä»¬ä¼šå¤„ç†è¿™ç§æƒ…å†µã€‚ï¼‰ <br><br><blockquote> å…³äºæ±½è½¦çš„å‡ å¥è¯ã€‚ è¿™æ˜¯ä¸€ä¸ªå‡†å¤‡å¥½çš„è™šæ‹Ÿæœºæ˜ åƒï¼Œç”±sysprepå®Œæˆï¼Œå¹¶åœ¨æˆ‘ä»¬çš„vSphereä¸­è½¬æ¢ä¸ºæ¨¡æ¿ã€‚ ä½¿ç”¨æˆ‘ä»¬çŸ¥é“çš„å¯†ç çš„æœ¬åœ°ç®¡ç†å‘˜å·²ä¿å­˜åœ¨æ˜ åƒä¸­ï¼Œsysprepåè¯¥å¸æˆ·ä¸ä¼šå´©æºƒï¼Œè¿™å°†ä½¿æˆ‘ä»¬èƒ½å¤Ÿä»æ­¤æ¨¡æ¿è®¿é—®æ¯å°è®¡ç®—æœºï¼Œå¹¶ä¸”å‡ºäºå®‰å…¨ç›®çš„ï¼Œä»¥åå¯ä»¥æ›¿æ¢æ­¤å¯†ç ã€‚ </blockquote><br><br><h3> åˆ›å»ºè™šæ‹Ÿæœº <br></h3><br> æŸ¥æ‰¾ç›¸åº”çš„SLRç¾¤é›†ï¼š <br><br><pre> <code class="plaintext hljs">$Cluster=Get-Cluster -Name $Configuration.VM.SLA</code> </pre> <br><br> æ£€æŸ¥æ•°æ®å­˜å‚¨ä¸Šæ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼š <br><br><pre> <code class="plaintext hljs">$DatastoreCluster = Get-DatastoreCluster |Where-Object {$_.Name -like $Datastore1Name} $Datastore1 = Get-Datastore -Location $DatastoreCluster |sort -Property "FreeSpaceGB" |select -Last 1 IF ($Datastore1.FreeSpaceGB -le "200"){ Write-Host -foreground red "STOP: Not enough datastore capacity for DISK" $vdisk.Id Break }</code> </pre><br><br> å’Œè¶³å¤Ÿçš„å†…å­˜ï¼š <br><br><pre> <code class="plaintext hljs">$VMHost = Get-VMHost -Location $Cluster |sort -Property "MemoryUsageGB" |select -First 1 IF ($VMHost.MemoryUsageGB -le "20"){ Write-Host -foreground red "STOP: No enough ESXi host capacity" Break }</code> </pre><br><br> æˆ‘ä»¬æ‹¿æˆ‘ä»¬çš„æ¨¡æ¿ <br><br><pre> <code class="plaintext hljs">$VMTemplate = Get-Template -Name 'Win2016_Std_x64_Template'</code> </pre> <br><br> å¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„è™šæ‹Ÿæœº <br><br><pre> <code class="plaintext hljs">New-VM -Name $Configuration.Hostname.ToUpper() -VMHost $VMHost -ResourcePool $ResourcePool -Datastore $Datastore -Template $VMTemplate -Location "AutoDeployed VMs"</code> </pre> <br><br> å°†ç½‘ç»œæ¥å£è¿æ¥åˆ°å¯ç”¨äº†DHCPçš„å­ç½‘å¾ˆé‡è¦ã€‚ <br><br> æˆ‘ä»¬å¯åŠ¨è™šæ‹Ÿæœº <br><br><pre> <code class="plaintext hljs">Start-VM $VM</code> </pre> <br><br> å¹¶ä¿å­˜æœºå™¨çš„æè¿°ï¼Œä»¥ä¾¿ä»¥åå¯ä»¥åœ¨VMWareçº§åˆ«ç¡®å®šæœºå™¨ã€‚ <br><br><pre> <code class="plaintext hljs">Set-Annotation -Entity $VM -CustomAttribute "Change request" -Value $Configuration.Request -Confirm:$false Set-VM $VM -Notes $Configuration.Description -Confirm:$false</code> </pre><br><br> æœºå™¨å¯åŠ¨ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰¾åˆ°æ¥æ”¶åˆ°çš„MACåœ°å€ï¼š <br><br><pre> <code class="plaintext hljs">$vMAC = (($VM | Get-NetworkAdapter | Select-Object -Property "MacAddress").MacAddress).Replace(':','')</code> </pre> <br><br> å°†æ­¤å€¼ä¿å­˜åˆ°æˆ‘ä»¬çš„JSONæ–‡ä»¶ä¸­ã€‚ <br><br><pre> <code class="plaintext hljs">$Configuration.Network.MAC=$VMAC ConvertTo-Json -InputObject $Configuration -Depth 100 | Out-File "C:\Configs\TargetNodes\Build\$Hostname.json" -Force</code> </pre><br><br> ç°åœ¨æ˜¯æ—¶å€™æ‰¿è¯ºæˆ‘ä»¬çš„Gitæœºå™¨å·²ç»åˆ›å»ºå¹¶æ‹¥æœ‰è‡ªå·±çš„å”¯ä¸€MACã€‚ <br><br> æœºå™¨å¼€å§‹åˆå§‹åŒ–ï¼ˆåœ¨sysprepä¹‹åï¼‰ï¼Œè®¾ç½®è®¾å¤‡å’Œåˆå§‹é…ç½®ã€‚ <br><br> è®©æˆ‘ä»¬ç­‰åˆ°WinRMè®¡ç®—æœºå¯ä»¥ä½¿ç”¨IncludeConnection.ps1è„šæœ¬ã€‚ <br><br> é¦–å…ˆæˆ‘ä»¬æ‰¾å‡ºæœºå™¨ä»DHCPæ¥æ”¶åˆ°çš„IPï¼š <br><br><pre> <code class="plaintext hljs"># $MAC = $vMAC while($isOnline -ne $true){ if((Get-DhcpServerv4Lease -ClientId $MAC -ScopeId $StagingDHCPScope -ComputerName $DHCPServer -ErrorAction Ignore).IPAddress.IPAddressToString){ $tempIP=(Get-DhcpServerv4Lease -ClientId $MAC -ScopeId $StagingDHCPScope -ComputerName $DHCPServer).IPAddress.IPAddressToString break } else{ if($isOnline -ne $true){ Write-Host "`r$i`t" -NoNewline $i++ } } }</code> </pre><br><br> ç°åœ¨ï¼Œå½“è®¡ç®—æœºåœ¨WinRMä¸Šå¯ç”¨æ—¶ï¼Œæˆ‘ä»¬å°†ç­‰å¾…ï¼š <br><br><pre> <code class="plaintext hljs">$LocalAdmin = Get-StoredCredential -Type Generic -Target LocalAdmin $i=0 $isOnline=$false while($isOnline -ne $true){ if(Invoke-Command -ComputerName $tempIP -ScriptBlock{ Get-ItemProperty -Path "Registry::\HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Component Based Servicing" } -Credential $LocalAdmin -ErrorAction SilentlyContinue){ $isOnline=$true break } else{ if($isOnline -ne $true){ Write-Host "`r$i" -NoNewline $i++ Start-Sleep -Seconds 1 } } }</code> </pre><br><br> æœºå™¨å·²å‡†å¤‡å¥½é©±åŠ¨ã€‚ <br><br><h3> æ‰€éœ€çŠ¶æ€é…ç½® <br></h3><br> è¦é…ç½®æ‰€éœ€çš„é…ç½®ï¼Œæˆ‘ä»¬ä½¿ç”¨PowerShelléƒ¨ä»¶-DSCï¼ˆæ‰€éœ€çŠ¶æ€é…ç½®ï¼‰ã€‚ ç½‘ç»œä¸Šæœ‰ä¸€ä¸ªå·²é…ç½®çš„DSC PullæœåŠ¡å™¨ï¼šdscpull.testdomain.euã€‚ <br> ä»¥ä¸‹æ˜¯æˆ‘ä»¬çš„DSC PullæœåŠ¡å™¨çš„é…ç½®ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å…³äºé…ç½®DSCæ‹‰å–çš„å¥½æ–‡ç« ã€‚</a> <br><br><pre> <code class="plaintext hljs">Node $NodeName { WindowsFeature DSCServiceFeature { Ensure = "Present" Name = "DSC-Service" } xDscWebService PSDSCPullServer { Ensure = "Present" EndpointName = "PSDSCPullServer" Port = 8080 PhysicalPath = "$env:SystemDrive\inetpub\PSDSCPullServer" CertificateThumbPrint = $certificateThumbPrint ModulePath = "$env:PROGRAMFILES\WindowsPowerShell\DscService\Modules" ConfigurationPath = "$env:PROGRAMFILES\WindowsPowerShell\DscService\Configuration" State = "Started" DependsOn = "[WindowsFeature]DSCServiceFeature" RegistrationKeyPath = "$env:PROGRAMFILES\WindowsPowerShell\DscService" AcceptSelfSignedCertificates = $true UseSecurityBestPractices = $true } File RegistrationKeyFile { Ensure = 'Present' Type = 'File' DestinationPath = "$env:ProgramFiles\WindowsPowerShell\DscService\RegistrationKeys.txt" Contents = $RegistrationKey } }</code> </pre><br><br> å¯ä»ä»¥ä¸‹<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç½‘å€</a>è·å¾—ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">https</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">//dscpull.testdomain.eu</a> : <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">8080</a> <br><br> å®ƒçš„ç«¯ç‚¹ï¼š <a href="">https</a> ://dscpull.testdomain.eu:8080/ <a href="">PSDSCPullserver.svc</a> <br><br> æ‰€æœ‰æ‹‰å¼æœåŠ¡å™¨å®¢æˆ·ç«¯éƒ½å¿…é¡»å®‰è£…PowerShell 5.1 <br> å¦‚æœæœªå®‰è£…PowerShell 5.1ï¼š <br><br><pre> <code class="plaintext hljs">$PSVersionTable.PSVersion.Major â€“lt 5</code> </pre> <br><br> å®‰è£…PowerShell 5.1ï¼š <br><br><pre> <code class="plaintext hljs">Write-Host "Download PowerShell 5.1" Invoke-Command -ComputerName $Node -ScriptBlock { [System.Net.ServicePointManager]::SecurityProtocol=[System.Net.SecurityProtocolType]::Tls12;Invoke-WebRequest -Uri "https://dscpull.testdomain.eu:8080/Files/Updates/WMF.msu" -OutFile C:\TEMP\WMF.MSU } Write-Host "Extract PowerShell 5.1" Invoke-Command -ComputerName $Node -ScriptBlock {Start-Process -FilePath 'wusa.exe' -ArgumentList "C:\temp\WMF.msu /extract:C:\temp\" -Wait -PassThru } Write-Host "Apply PowerShell 5.1" Invoke-Command -ComputerName $Node -ScriptBlock {Start-Process -FilePath 'dism.exe' -ArgumentList "/online /add-package /PackagePath:C:\temp\WindowsBlue-KB3191564-x64.cab /Quiet" -Wait -PassThru } Write-Host "PowerShell 5.1 has been installed"</code> </pre><br><br>  PKIæœåŠ¡å™¨ä¹Ÿå·²éƒ¨ç½²åœ¨æˆ‘ä»¬çš„ç½‘ç»œä¸Šã€‚ è¿™æ˜¯å¯¹å­˜å‚¨åœ¨DSC mofæ–‡ä»¶ä¸­çš„å‡­æ®è¿›è¡Œå®‰å…¨åŠ å¯†çš„æ¡ä»¶ï¼ˆMofæ–‡ä»¶æ˜¯Pull ServeråŠå…¶å®¢æˆ·ç«¯è¿›è¡Œé€šä¿¡çš„â€œè¯­è¨€â€ï¼‰ã€‚ å½“å®¢æˆ·ç«¯å°è¯•åœ¨Pull Serverä¸Šæ³¨å†Œæ—¶ï¼Œæœ‰å¿…è¦æŒ‡å®šä¸€ä¸ªThumbprintè¯ä¹¦ï¼Œä»¥ååœ¨Pull Serverä¸Šå°†ä½¿ç”¨æ­¤è¯ä¹¦æ¥åŠ å¯†å¯†ç ã€‚ ä¸‹é¢æˆ‘ä»¬å°†çœ‹åˆ°å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ <br><br> å°†æ ¹CAå¯¼å…¥æˆ‘ä»¬çš„æ–°è®¡ç®—æœºï¼š <br><br><pre> <code class="plaintext hljs"> Invoke-Command -ComputerName $server -ScriptBlock{ $PKI="-----BEGIN CERTIFICATE----- MIIF2TCCA8GgAwIBAgIQSPIjcff9rotNdxbg3+ygqDANBgkqhkiG9w0BAQUFADAe **************************************************************** znafMvVx0B4tGEz2PFss/FviGdC3RohBHG0rF5jO50J4nS/3cGGm+HGdn1w/tZd0 a0FWpn9VCOSmXM2It+tSW1f4nZVt6T2kr1ZlTxkDhT7HMSGsrX/XJswzCkDGe3dE qrVVjNUkhVTaeeBWdujB5J6mcx7YkNsAUhODiS9Cf7FnYnxLFA72M0pijI48P5F0 ShM9HWAAUIrLkv13ug== -----END CERTIFICATE-----" $PKI | Out-File RootCA.cer Import-Certificate RootCA.cer -CertStoreLocation Cert:\LocalMachine\Root | select Thumbprint | Out-Null } -Credential $LocalAdmin | Out-Null</code> </pre><br><br> ä¸ºäº†è¿›ä¸€æ­¥çš„å·¥ä½œï¼Œæˆ‘ä»¬éœ€è¦ä¸€å¯¹RSAå¯†é’¥ã€‚  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æˆ‘ä»¬å°†ç”Ÿæˆä¸€ä¸ªè‡ªç­¾åè¯ä¹¦</a>å¹¶æš‚æ—¶ä½¿ç”¨å®ƒã€‚ <br><br> ç°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨æ‹‰å–æœåŠ¡å™¨ä¸Šæ³¨å†Œï¼š <br><br><pre> <code class="plaintext hljs">$DscHostFQDN = [System.Net.Dns]::GetHostEntry([string]$env:computername).HostName $DscPullServerURL = "https://$($DscHostFQDN):8080/PSDSCPullserver.svc" $DscWebConfigChildPath = '\inetpub\psdscpullserver\web.config' $DscWebConfigPath = Join-Path -Path $env:SystemDrive -ChildPath $DscWebConfigChildPath $DscWebConfigXML = [xml](Get-Content $DscWebConfigPath) $DscRegKeyName = 'RegistrationKeys.txt' $DscRegKeyXMLNode = "//appSettings/add[@key = 'RegistrationKeyPath']" $DscRegKeyParentPath = ($DscWebConfigXML.SelectNodes($DscRegKeyXMLNode)).value $DscRegKeyPath = Join-Path -Path $DscRegKeyParentPath -ChildPath $DscRegKeyName $DscRegKey = Get-Content $DscRegKeyPath [DSCLocalConfigurationManager()] configuration RegisterOnPull { Node $Node { Settings { ConfigurationModeFrequencyMins = 1440 CertificateID = $Thumbprint RefreshMode ='Pull' RefreshFrequencyMins = 1440 RebootNodeIfNeeded = $true ConfigurationMode ='ApplyAndAutoCorrect' AllowModuleOverwrite = $true DebugMode = 'None' StatusRetentionTimeInDays = 1 } ConfigurationRepositoryWeb $([string]$env:computername) { ServerURL = $DscPullServerURL RegistrationKey = $DscRegKey CertificateID = $Thumbprint ConfigurationNames = @("$hostx") } } } RegisterOnPull -OutputPath $MetaConfigsStorage Set-DscLocalConfigurationManager -ComputerName $Node -Path $MetaConfigsStorage -Verbose -Force -Credential $LocalAdmin</code> </pre><br><br> å°†ç¬¬ä¸€ä¸ªé…ç½®å‘é€åˆ°æˆ‘ä»¬çš„æœºå™¨ <br><br><pre> <code class="plaintext hljs">Configuration Rename { param ( [Parameter()] [System.String[]] $Node, $hostname ) Import-DscResource -ModuleName xComputerManagement Import-DscResource â€“ModuleName PSDesiredStateConfiguration Node $Node { xComputer JoinDomain { Name = $hostname } } } Rename -Node $Node -OutputPath $DscConfigPath -hostname $hostname New-DscChecksum $DscConfigPath -Force Invoke-Command -ComputerName $Node -ScriptBlock{Update-DscConfiguration -Verbose -Wait } -Credential $LocalAdmin -Verbose</code> </pre><br><br> æœåŠ¡å™¨å°†è‡ªåŠ¨é‡å‘½åå¹¶é‡æ–°å¯åŠ¨ã€‚ ç°åœ¨æˆ‘ä»¬å¯ä»¥æ‰§è¡ŒJoin Domainã€‚ <br><br><pre> <code class="plaintext hljs">Configuration JoinAD { param ( [Parameter()] [System.String[]] $Node, [Parameter(Mandatory = $true)] [ValidateNotNullorEmpty()] [System.Management.Automation.PSCredential] $DomainAdmin, $hostname, $domain ) Import-DscResource -ModuleName xComputerManagement Import-DscResource â€“ModuleName PSDesiredStateConfiguration Node $Node { xComputer JoinDomain { Name = $hostname DomainName = $domain Credential = $DomainAdmin JoinOU = "OU=Servers,OU=Staging,DC=testdomain,DC=eu" } GroupSet LocalAdmins { GroupName = @( 'Administrators') Ensure = 'Present' MembersToInclude = @( 'testdomain-eu\dscstaging' ) } } } $cd = @{ AllNodes = @( @{ NodeName = $Node PSDscAllowPlainTextPassword = $false PSDscAllowDomainUser=$true Certificatefile = $CertFile Thumbprint = $Certificate.ToString() } ) } JoinAD -Node $Node -OutputPath $DscConfigPath -DomainAdmin $DomainAdmin -hostname $hostname -ConfigurationData $cd -domain $domain New-DscChecksum $DscConfigPath -Force Invoke-Command -ComputerName $Node -ScriptBlock{Update-DscConfiguration -Verbose -Wait } -Credential $LocalAdmin -Verbose</code> </pre><br><br> è¿™æ˜¯æˆ‘ä»¬çš„mofæ–‡ä»¶çš„æ ·å­ï¼š <br><br><pre> <code class="plaintext hljs">instance of MSFT_Credential as $MSFT_Credential1ref { Password = "-----BEGIN CMS-----\nMIIBsgYJKoZIhvcNAQcDoIIBozCCAZ8CAQAxggFKMIIBRgIBADAuMBoxGDAWBgNVBAMMD1dJTi1H\nNFFKTFFQME4xNQIQOQN77pxew75HU6l7GPn99TANBgkqhkiG9w0BAQcwAASCAQAlhFf7Zs2gJbJEnc1DEK2yWbKcO+BEyD2cr6vKHdn\nQ9TrjvbysEOvYjT15o6MccwkMEwGCSqGSIb3DQEHATAdBglghkgBZQMEASoEEEdKJT+GX4IkPezR\nwYncyQiAIAFKxwJocH4ufRsq9L2Ipkp+VQCx2ljlwif6ac4X/PqG\n-----END CMS-----"; UserName = "testdomain.eu\\service_DomainJoin_001"; }; instance of MSFT_xComputer as $MSFT_xComputer1ref { ResourceID = "[xComputer]JoinDomain"; Credential = $MSFT_Credential1ref; DomainName = "testdomain.eu"; SourceInfo = "C:\\Program Files\\WindowsPowerShell\\Scripts\\JoinAD.ps1::34::9::xComputer"; Name = "dsctest51"; JoinOU = "OU=Servers,OU=Staging,DC=testdomain,DC=eu"; ModuleName = "xComputerManagement"; ModuleVersion = "4.1.0.0"; ConfigurationName = "JoinAD"; };</code> nMIIBsgYJKoZIhvcNAQcDoIIBozCCAZ8CAQAxggFKMIIBRgIBADAuMBoxGDAWBgNVBAMMD1dJTi1H \ nNFFKTFFQME4xNQIQOQN77pxew75HU6l7GPn99TANBgkqhkiG9w0BAQcwAASCAQAlhFf7Zs2gJbJEnc1DEK2yWbKcO + BEyD2cr6vKHdn \ nQ9TrjvbysEOvYjT15o6MccwkMEwGCSqGSIb3DQEHATAdBglghkgBZQMEASoEEEdKJT + GX4IkPezR \ nwYncyQiAIAFKxwJocH4ufRsq9L2Ipkp + VQCx2ljlwif6ac4X / PQG \ n ----- END CMS -----â€; <code class="plaintext hljs">instance of MSFT_Credential as $MSFT_Credential1ref { Password = "-----BEGIN CMS-----\nMIIBsgYJKoZIhvcNAQcDoIIBozCCAZ8CAQAxggFKMIIBRgIBADAuMBoxGDAWBgNVBAMMD1dJTi1H\nNFFKTFFQME4xNQIQOQN77pxew75HU6l7GPn99TANBgkqhkiG9w0BAQcwAASCAQAlhFf7Zs2gJbJEnc1DEK2yWbKcO+BEyD2cr6vKHdn\nQ9TrjvbysEOvYjT15o6MccwkMEwGCSqGSIb3DQEHATAdBglghkgBZQMEASoEEEdKJT+GX4IkPezR\nwYncyQiAIAFKxwJocH4ufRsq9L2Ipkp+VQCx2ljlwif6ac4X/PqG\n-----END CMS-----"; UserName = "testdomain.eu\\service_DomainJoin_001"; }; instance of MSFT_xComputer as $MSFT_xComputer1ref { ResourceID = "[xComputer]JoinDomain"; Credential = $MSFT_Credential1ref; DomainName = "testdomain.eu"; SourceInfo = "C:\\Program Files\\WindowsPowerShell\\Scripts\\JoinAD.ps1::34::9::xComputer"; Name = "dsctest51"; JoinOU = "OU=Servers,OU=Staging,DC=testdomain,DC=eu"; ModuleName = "xComputerManagement"; ModuleVersion = "4.1.0.0"; ConfigurationName = "JoinAD"; };</code> </pre><br><br>  DSCä½¿ç”¨å…·æœ‰è‡ªç­¾åè¯ä¹¦çš„å…·æœ‰Domain Adminæƒé™çš„æœåŠ¡å¸æˆ·å¯¹å‡­æ®è¿›è¡ŒåŠ å¯†ï¼Œå³ï¼štestdomain.eu \\ service_DomainJoin_001ã€‚  DSCå®¢æˆ·ç«¯åŠå…¶ç§é’¥å°†è§£å¯†å‡­æ®ï¼Œå¹¶ä½¿ç”¨æŒ‡å®šçš„åŸŸå‡­æ®æ¥åº”ç”¨æ‰€æœ‰é…ç½®æ¨¡å—ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå°†åœ¨æŒ‡å®šçš„ç»„ç»‡å•ä½ä¸­æ‰§è¡ŒåŸŸåŠ å…¥ã€‚ <br><br><pre> <code class="plaintext hljs">GroupSet LocalAdmins { GroupName = @( 'Administrators') Ensure = 'Present' MembersToInclude = @( testdomain-eu\dscstaging' ) }</code> </pre><br><br> æ­¤æ¨¡å—å°†dscstagingæ·»åŠ åˆ°æœ¬åœ°ç®¡ç†å‘˜ä»¥è¿›è¡Œè¿›ä¸€æ­¥é…ç½®ã€‚ <br><br> é‡æ–°å¯åŠ¨åï¼Œæˆ‘ä»¬å°†èƒ½å¤Ÿä½¿ç”¨åŸŸå‡­æ®è¾“å…¥è®¡ç®—æœºã€‚ <br><br> æˆ‘ä»¬æ­£åœ¨ç­‰å¾…æœåŠ¡å™¨ä»PKIæ¥æ”¶è¯ä¹¦ï¼ˆå·²é…ç½®è‡ªåŠ¨æ³¨å†Œï¼‰ï¼Œå°†æ¥æˆ‘ä»¬å°†ä½¿ç”¨PKIé¢å‘çš„è¯ä¹¦ã€‚ <br><br><pre> <code class="plaintext hljs">$vmcert=Invoke-Command -ComputerName $server -ScriptBlock{ return Get-ChildItem -Path cert:\LocalMachine\My | where {$_.EnhancedKeyUsageList.FriendlyName -eq "Document Encryption"-and $_.Issuer -eq "CN=TestDomain Issuing CA, DC=testdomain, DC=eu"} } -ErrorAction Ignore</code> </pre> <br><br> ç°åœ¨ï¼Œä½¿ç”¨æ›´æ–°çš„æŒ‡çº¹å†æ¬¡æ³¨å†ŒPull Serverã€‚ <br><br> å°±æ˜¯è¿™æ ·ï¼ŒåŠ å…¥åŸŸçš„æœºå™¨ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‰ç…§é€‚åˆè‡ªå·±çš„æ–¹å¼ä½¿ç”¨å®ƒã€‚ <br><br><h3> å®‰è£…SQL Server <br></h3><br>  JSONæ–‡ä»¶æè¿°äº†MS SQL Serverçš„è¦æ±‚ï¼Œæˆ‘ä»¬è¿˜ä½¿ç”¨DSCæ¥å®‰è£…å’Œé…ç½®SQL Serverã€‚ é…ç½®å¦‚ä¸‹æ‰€ç¤ºï¼š <br><br><pre> <code class="plaintext hljs">Configuration $Node{ WindowsFeature "NetFramework35"{ Name = "NET-Framework-Core" Ensure = "Present" Source = "\\$DscHostFQDN\Files\Updates" } WindowsFeature "NetFramework45"{ Name = "NET-Framework-45-Core" Ensure= "Present" } SqlSetup "MSSQL2012NamedInstance"{ InstanceName = $MSSQL.InstanceName Features = $MSSQL.Features ProductKey = $ProductKey SQLCollation = $MSSQL.Collation SQLSysAdminAccounts = @('testdomain-EU\SQLAdmins',' testdomain-EU\Backup') InstallSharedDir = "C:\Program Files\Microsoft SQL Server" InstallSharedWOWDir = "C:\Program Files (x86)\Microsoft SQL Server" InstallSQLDataDir = $MSSQL.DataRoot SQLUserDBDir = $MSSQL.UserDBDir SQLUserDBLogDir = $MSSQL.UserLogDir SQLTempDBDir = $MSSQL.TempDBDir SQLTempDBLogDir = $MSSQL.TempDBLogDir SQLBackupDir = $MSSQL.BackupDir SourcePath = $SQLSource SAPwd = $SA SecurityMode = 'SQL' UpdateSource = ".\Updates" Action = "Install" ForceReboot = $True SQLSvcAccount = $SqlServiceCredential AgtSvcAccount = $SqlServiceCredential ISSvcAccount = $SqlServiceCredential BrowserSvcStartupType = "Automatic" DependsOn = '[WindowsFeature]NetFramework35', '[WindowsFeature]NetFramework45' }</code> </pre><br> å…¶ä¸­å®šä¹‰äº†$ MSSQLï¼š <br><pre> <code class="plaintext hljs">$MSSQL=$Configuration.Applications | where {$_.Application -eq "Microsoft SQL Server 2012"}</code> </pre> <br><br>  $ MSSQL.InstanceName-æ‰€æœ‰è¿™äº›éƒ½åœ¨æˆ‘ä»¬çš„Jsonæ–‡ä»¶ä¸­æŒ‡ç¤ºã€‚ åº”ç”¨æ­¤é…ç½®å°†å®‰è£…MS SQL Serverï¼Œå¹¶å°†æ‰€æœ‰æ›´æ–°å­˜å‚¨åœ¨Updatesæ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶åœ¨å¿…è¦æ—¶é‡æ–°å¯åŠ¨æœåŠ¡å™¨ã€‚ <br><br> æ±½è½¦å‡†å¤‡å¥½äº†ã€‚ <br><br><h2> ç°åœ¨æœåŠ¡ </h2><br>  Service-Nowä¸­<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ‰å‡ ä¸ªå¯ç”¨çš„API</a> ã€‚ æˆ‘ä»¬ä½¿ç”¨Rest APIã€‚ <br> è¦è·å–å…·æœ‰å·²åˆ†é…çŠ¶æ€çš„è®¡ç®—æœºçš„åˆ—è¡¨ï¼Œè¯·ä½¿ç”¨ä»¥ä¸‹å½¢å¼çš„æŸ¥è¯¢ï¼š <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">instance.service-now.com/cmdb_ci_server_list.do?sysparm_query=install_status=16</a> ^ u_subtype = ^ ORDERBYåç§° <br> åœ¨PowerShellä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š <br><pre> <code class="plaintext hljs">$url="https://instance.service-now.com/api/now/table/cmdb_ci_server?sysparm_query=install_status=16^u_subtype=^ORDERBYname" $uri= new-object System.Uri("https://instance.service-now.com/") #       $credentials = (Get-StoredCredential -Type Generic -Target DSC).GetNetworkCredential() $credentials = new-object System.Net.NetworkCredential $credentials.UserName, $credentials.SecurePassword Add-Type -AssemblyName System.Net.Http $handler = New-Object System.Net.Http.HttpClientHandler $handler.CookieContainer = New-Object System.Net.CookieContainer $handler.UseCookies=$true $handler.Credentials=$credentials $HttpClient = New-Object System.Net.Http.HttpClient($handler) $HttpClient.BaseAddress= $uri $Header = New-Object System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/json") $HttpClient.DefaultRequestHeaders.Accept.Clear() $HttpClient.DefaultRequestHeaders.Accept.Add($Header); $response=$HttpClient.GetAsync($url) $respStream=$response.Result.Content.ReadAsStringAsync() $Servers = $respStream.Result | ConvertFrom-Json #   Configuration Items  $ServersCI=$Servers.result</code> </pre> <br> ç¬¬ä¸€ä¸ªæ•°ç»„å¯¹è±¡æ˜¯æˆ‘ä»¬éœ€è¦çš„ä¸»æœºåã€‚ <br> å¦‚æœè®¡ç®—æœºå·²å‡†å¤‡å°±ç»ªï¼Œåˆ™å¯ä»¥åœ¨Service-Nowä¸­æ›´æ”¹è®¡ç®—æœºçš„çŠ¶æ€ï¼Œä¸ºæ­¤ï¼Œä½¿ç”¨UpdateCI.ps1è„šæœ¬ï¼š <br><pre> <code class="plaintext hljs">param( $CI, [ValidateSet("Allocated","In use","Pending install")] $NewStatus='In use' ) $url="https://instance.service-now.com/api/now/table/cmdb_ci_server?sysparm_query=name=$CI" $uri= new-object System.Uri("https://instance.service-now.com/") $credentials = (Get-StoredCredential -Type Generic -Target DSC).GetNetworkCredential() $credentials = new-object System.Net.NetworkCredential $credentials.UserName, $credentials.SecurePassword Add-Type -AssemblyName System.Net.Http $handler = New-Object System.Net.Http.HttpClientHandler $handler.CookieContainer = New-Object System.Net.CookieContainer $handler.UseCookies=$true $handler.Credentials=$credentials $HttpClient = New-Object System.Net.Http.HttpClient($handler) $HttpClient.BaseAddress= $uri $Header = New-Object System.Net.Http.Headers.MediaTypeWithQualityHeaderValue("application/json") $HttpClient.DefaultRequestHeaders.Accept.Clear() $HttpClient.DefaultRequestHeaders.Accept.Add($Header); $response=$HttpClient.GetAsync($url) $respStream=$response.Result.Content.ReadAsStringAsync() $Servers = $respStream.Result | ConvertFrom-Json $ServerCI=$Servers.result[0] $update=@{} if($NewStatus -eq "In use"){ $update.install_status=1 } if($NewStatus -eq "Pending install"){ $update.install_status=4 } $stringcontent = New-Object System.Net.Http.StringContent((ConvertTo-Json -InputObject $update -Depth 100),[System.Text.Encoding]::UTF8, "application/json"); $result=$HttpClient.PutAsync("https://instance.service-now.com/api/now/table/cmdb_ci_server/$($ServerCI.sys_id)", $stringcontent)</code> </pre> <br> è¦è·å–è¡¨å’Œè®°å½•ï¼Œå°†ä½¿ç”¨REST API GETè¯·æ±‚æ¥æ›´æ”¹è®°å½•PUT / POSTè¯·æ±‚ï¼Œæ‚¨éœ€è¦åœ¨å…¶ä¸­æ›´æ”¹å­—æ®µçš„ä¸»ä½“ã€‚ <br><br>  <i>æˆ‘ä»¬ä½¿ç”¨å›¾å½¢å·¥å…·ï¼ˆå¦‚Azure Portalï¼‰åˆ›å»ºäº†ä¸€ä¸ªæ–¹ä¾¿çš„å·¥å…·ï¼Œè¯¥å·¥å…·ä½¿æˆ‘ä»¬èƒ½å¤Ÿä¸ºæˆ‘ä»¬å’Œæˆ‘ä»¬çš„å®¢æˆ·å°½å¯èƒ½æ–¹ä¾¿åœ°ç®¡ç†æœ¬åœ°åŸºç¡€ç»“æ„ã€‚</i> <br>  PS 12.24.2018ã€‚ ä¸€åˆ‡ä¼¼ä¹éƒ½è¿‡æ—¶äº†å—ï¼Ÿ ç°åœ¨è¯¥ä½¿ç”¨Azure DevOpsäº†ã€‚ åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†å‘æ‚¨å±•ç¤ºå¦‚ä½•ä½¿ç”¨Azure DevOpsç®¡é“å®Œæˆæ‰€æœ‰è¿™äº›æ“ä½œã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN425129/">https://habr.com/ru/post/zh-CN425129/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN425113/index.html">â€œæ•°å­—å°åˆ·æœ¯â€æˆ–æˆ‘åœ¨ä¹¦ç±ç§»åŠ¨æ•°å­—åŒ–æ–¹é¢çš„ç»éªŒ</a></li>
<li><a href="../zh-CN425115/index.html">æˆç†Ÿçš„DevOpsï¼šä¸‰å¹•å¸Œè…Šæ‚²å‰§</a></li>
<li><a href="../zh-CN425117/index.html">æ¯ä¸ªæ™¶ä½“ç®¡ä¸¤ä½ï¼šIntel 8087æµ®ç‚¹èŠ¯ç‰‡ä¸­çš„é«˜å¯†åº¦ROM</a></li>
<li><a href="../zh-CN425123/index.html">ç½—å…°TR-808é¼“æœºçš„ç¥ç§˜å¿ƒè„</a></li>
<li><a href="../zh-CN425125/index.html">@Pythonetc 2018å¹´9æœˆ</a></li>
<li><a href="../zh-CN425131/index.html">å…³äºåŒºå—é“¾æŠ€æœ¯çš„è¯»ç‰©ï¼šæŒ‡å—ï¼Œä¹¦ç±å’Œæ–‡ç« </a></li>
<li><a href="../zh-CN425133/index.html">è·¨å¢ƒæ”¯ä»˜é—®é¢˜-ä¸ºä»€ä¹ˆåœ¨è¿™é‡Œä»¥åŠå¦‚ä½•ä½¿ç”¨åŒºå—é“¾</a></li>
<li><a href="../zh-CN425135/index.html">ä¸ºä»€ä¹ˆVoIPåœ¨ç¾å›½è¢«å…¬è®¤ä¸ºä¿¡æ¯æœåŠ¡ï¼Œè¿™å¯¹ç”µä¿¡è¡Œä¸šå’Œç”¨æˆ·æ„å‘³ç€ä»€ä¹ˆ</a></li>
<li><a href="../zh-CN425137/index.html">æˆ‘ä»¬åœ¨æ§åˆ¶å°ä¸­å¿«é€Ÿé«˜æ•ˆåœ°å·¥ä½œ</a></li>
<li><a href="../zh-CN425139/index.html">äººå·¥æ™ºèƒ½é•œå¤´ä¸‹çš„æµè¡Œæ­Œæ˜Ÿ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>