<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèæ‚Äçüîß üíÉüèª ü§≥üèª Criando um pipeline de teste automatizado no Azure DevOps ü§∂üèª üóÇÔ∏è üåò</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recentemente, deparei-me com uma fera n√£o t√£o popular no mundo do DevOps, os pipelines do Azure DevOps. Imediatamente senti a aus√™ncia de instru√ß√µes o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Criando um pipeline de teste automatizado no Azure DevOps</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460431/">  Recentemente, deparei-me com uma fera n√£o t√£o popular no mundo do DevOps, os pipelines do Azure DevOps.  Imediatamente senti a aus√™ncia de instru√ß√µes ou artigos claros sobre o t√≥pico, n√£o sei com o que ele est√° conectado, mas a Microsoft claramente tem algo com o que trabalhar em termos de promo√ß√£o da ferramenta.  Hoje, criaremos um pipeline para testes automatizados dentro da nuvem do Azure. <a name="habracut"></a><br><br>  Ent√£o, a tarefa: <br>  Existem softwares criados com o mesmo Azure DevOps, montados a partir de um projeto no WIX.  Se houver interesse, escreverei sobre esta ferramenta.  Na verdade, essa √© uma maneira mais automatizada de criar instaladores do Windows, que substitui o InstallShield padr√£o.  Portanto, nosso software cria e gera com sucesso um artefato, um determinado setup.exe, que coloca o aplicativo em um sistema Windows.  √â necess√°rio colocar esse aplicativo em uma m√°quina virtual semelhante a um produto, copiar os testes automatizados preparados pela equipe de testes, execut√°-los e coletar os resultados para considerar o ramo bom ou ruim antes da mesclagem.  Tudo √© como no GitLab, <s>apenas atrav√©s de ....</s> <br><br>  Como um ambiente de virtualiza√ß√£o onde executaremos nossos testes, obviamente usamos o Azure DevTest Labs, uma entidade nas assinaturas do Azure, criada para distorcer todo tipo de absurdo de teste por um pre√ßo razo√°vel. <br><br><h1>  1. Integra√ß√£o do lado da nuvem </h1><br>  Primeiro, precisamos integrar nosso DevTest Labs ao Azure DevOps, para o qual precisamos de algum Service Principal, essencialmente uma conta de servi√ßo que permita acessar os pipelines na nuvem e criar / excluir recursos para n√≥s mesmos. <br><br>  V√° para a assinatura e encontre o servi√ßo do Azure Active Directory <br><br><img src="https://habrastorage.org/webt/cf/fn/bq/cffnbqsgvtmscikoypqdftkarpg.jpeg"><br><br>  Encontramos Registros de Aplicativos e clique em Novo Registro, isso criar√° nosso principal de servi√ßo.  N√£o analisarei quais configura√ß√µes escolherei ao criar. Isso pode ser diferente para assinaturas diferentes. <br><br><img src="https://habrastorage.org/webt/ns/4a/jq/ns4ajqbtui4oz51gruhl84gejac.jpeg"><br><br>  Agora precisamos dar direitos ao nosso diretor de servi√ßo.  Para fazer isso, v√° para o √≠cone de assinatura com uma chave.  Escolha nossa assinatura. <br><br><img src="https://habrastorage.org/webt/-p/tj/te/-ptjtehk7ftpdtlf4op0dwlqj9g.jpeg"><br><br>  Em seguida, em Controle de acesso, clique em Atribui√ß√£o de fun√ß√£o e procure essa conta na pesquisa pelo nome que voc√™ acabou de criar.  Damos o papel de Colaborador, isso √© suficiente. <br><br><img src="https://habrastorage.org/webt/pr/nq/s_/prnqs_0culpmj9xrudzptpv4mc0.jpeg"><br><br>  Em seguida, volte ao nosso Principal de servi√ßo no Azure AD e abra suas propriedades.  Mais tarde, precisaremos de todos os IDs existentes, salv√°-los. <br><br>  √â aqui que nossas configura√ß√µes do portal terminam e vamos para o Azure DevOps. <br><br><h1>  2. Integra√ß√£o no lado do Azure DevOps </h1><br>  Primeiro, vamos √†s configura√ß√µes do projeto e selecionamos Conex√µes de Servi√ßo.  Crie um novo elemento do tipo Azure Resource Manager. <br><br><img src="https://habrastorage.org/webt/ct/hc/7c/cthc7c3qagkfuyxa3_6fyod5k90.jpeg"><br><br>  Agora precisamos de todos os IDs que gravamos.  Clique em usar a vers√£o completa da caixa de di√°logo de conex√£o de servi√ßo.  E insira todos os dados que recebemos do respons√°vel pelo servi√ßo.  Clique em verificar e, se estiver tudo bem, mantenha a conex√£o.  Agora, nossos pipelines podem us√°-lo para conectar-se √† nuvem. <br><br><img src="https://habrastorage.org/webt/it/7s/as/it7sas1cjqbrwt58uncazzfp4ee.jpeg"><br><br><h1>  3. Criando um pipeline </h1><br>  Agora vamos para o mais interessante, a constru√ß√£o do pr√≥prio gasoduto.  Abra o menu Pipelines-Builds <br><br><img src="https://habrastorage.org/webt/et/wd/h5/etwdh5romudzssphyz-hmliq2bw.jpeg"><br><br>  Somos recebidos por um menu para criar uma nova compila√ß√£o, que por padr√£o tentar√° criar um arquivo YAML para n√≥s com uma configura√ß√£o adequada.  Recusamos educadamente isso e escolhemos a vers√£o cl√°ssica.  O desejo da Microsoft de fazer tudo como pessoas e dar a oportunidade de personalizar pipelines atrav√©s do YAML, tanto quanto poss√≠vel, mas a documenta√ß√£o escassa e a inoperabilidade pr√°tica de muitos m√≥dulos nos dizem que √© muito cedo para usar essa funcionalidade. <br><br><img src="https://habrastorage.org/webt/it/at/gu/itatgu_alr1efjbtvlr6rin5e9i.jpeg"><br><br>  A partir da variedade de modelos, precisamos de um simples pipeline vazio.  Ap√≥s a sua cria√ß√£o, somos recebidos por uma janela de edi√ß√£o vazia, na qual passaremos muito tempo. <br><br><img src="https://habrastorage.org/webt/0t/g0/0h/0tg00hw3ojp3plkvochf9-skdac.jpeg"><br><br>  Ent√£o, clique em + e entre em um determinado reposit√≥rio de m√≥dulos, de onde precisaremos dos seguintes componentes da lista. <br><br><img src="https://habrastorage.org/webt/9q/2l/ud/9q2ludjenipcm_m8oteqerfseoe.jpeg"><br><br>  Antes de prosseguirmos com a configura√ß√£o da tarefa de pipeline, precisamos criar e colocar v√°rios arquivos no projeto.  Esses ser√£o o Modelo ARM da nossa m√°quina virtual, que geraremos no Azure DevTest Labs, o script para obter a m√°quina IP ap√≥s a cria√ß√£o e, se desejado, os scripts de nossos testes ou o que queremos executar no host. <br><br><h1>  4. Gera√ß√£o de modelo ARM </h1><br>  Para criar uma m√°quina virtual, primeiro precisamos gerar um modelo para ela, um arquivo json, que inserimos no c√≥digo do projeto para que possa ser lido a partir da√≠ pelo pipeline. <br><br>  Vamos ao nosso laborat√≥rio e encontramos o menu F√≥rmulas (bases reutiliz√°veis), clique para criar um novo. <br><br><img src="https://habrastorage.org/webt/8w/rc/-l/8wrc-lfvdcettljp5-j7iclsz1u.jpeg"><br><br>  Seremos recebidos por uma longa lista de imagens como base, a escolha do tamanho da m√°quina, da mesma forma que na cria√ß√£o de uma m√°quina virtual.  Nesta fase, n√£o vamos parar, iremos imediatamente para o √∫ltimo item das propriedades da m√°quina, ou seja, artefatos.  Voc√™ pode usar as configura√ß√µes necess√°rias para o seu ambiente.  Por exemplo, adiciono uma m√°quina ao dom√≠nio e adiciono uma conta de servi√ßo como administrador, para que o pipeline possa acessar essa m√°quina nessa conta.  Tudo isso pode variar, mas para um teste bem-sucedido do c√≥digo, precisamos de um artefato, no qual iremos nos aprofundar mais detalhadamente.  Para colocar a vers√£o mais recente do software que testamos em nossa m√°quina, usaremos o artefato Download Download Pipelines Azure Artfact e Run Script.  Lembra no come√ßo que eu disse que em algum lugar uma compila√ß√£o est√° acontecendo com o instalador do aplicativo?  Agora precisamos dizer √† m√°quina virtual, ou melhor, ao modelo, para que ele v√° e pegue esse artefato.  E n√£o apenas o peguei, mas tamb√©m o defini, para o qual preenchemos campos especiais indicando o projeto, o nome da constru√ß√£o e a chave secreta.  A chave secreta, como em todos os sistemas desse tipo, √© gerada na conta, nesse caso no Azure DevOps e armazenada em Segredos no seu laborat√≥rio.  H√° uma pequena ressalva: em Secrets, vamos salv√°-lo, mas n√£o √© frio nem calor; ele ser√° lan√ßado a partir de outro usu√°rio como parte do pipeline; portanto, precisaremos inserir manualmente a chave secreta novamente no modelo. <br><br>  Outro artefato que deve ser inclu√≠do √© o ‚ÄúConfigure WinRM‚Äù, precisamos dele para acesso subseq√ºente √† m√°quina.  Existe apenas um par√¢metro, nome do host.  Como n√£o sabemos com anteced√™ncia, usaremos a vari√°vel% COMPUTERNAME%. <br><br><img src="https://habrastorage.org/webt/ve/46/ps/ve46psila9wlzhoh9hiiwatcvxe.jpeg"><br><br>  Ent√£o, n√≥s adicionamos todos os artefatos necess√°rios. Vamos seguir por que viemos aqui.  Obtemos o modelo ARM gerado na guia Avan√ßado da mesma janela de cria√ß√£o de f√≥rmula. <br><br><img src="https://habrastorage.org/webt/bj/ly/ae/bjlyaelkb2okdk8cvk3xvtjhrm0.jpeg"><br><br>  Copie o conte√∫do da p√°gina para o arquivo VMtemplate.json e coloque-o na raiz do projeto.  N√£o precisamos mais da nuvem, estamos retornando ao pipeline. <br><br><h1>  5. Configura√ß√£o de Pipeline </h1><br>  Vamos come√ßar com o mais importante e interessante, criando uma m√°quina virtual. Para isso, fizemos todas essas integra√ß√µes e modelos.  Na assinatura do Azure RM, selecionamos nossa conex√£o de servi√ßo, configurada no par√°grafo 2. Em seguida, o ambiente de laborat√≥rio dispon√≠vel ser√° exibido.  Depois, selecionamos json que geramos e definimos algumas vari√°veis ‚Äã‚Äãobrigat√≥rias.  O nome de usu√°rio e a senha do carro podem ser definidos diretamente ou com vari√°veis, mas n√£o tenho certeza de que funcione, o que quer que eu escreva l√°, n√£o consegui entrar no carro com esses cr√©ditos, o principal √© definir o nome do carro para que seja sempre poss√≠vel √∫nico.  Para isso, eu uso a vari√°vel de ambiente build. <br><br><img src="https://habrastorage.org/webt/cx/nw/gv/cxnwgvb73r6yougop6htozc6g3c.jpeg"><br><br>  Em seguida, estabelecemos outro ponto importante.  Depois que o carro decola, tamb√©m precisamos conhecer seus par√¢metros de alguma forma, e √© melhor n√£o para n√≥s, mas para a linha de pagamento.  Para fazer isso, criamos um script, por exemplo, GetLabVMParams.ps1 e o colocamos l√°, no projeto.  Peguei o texto do script no site da Microsoft, mas o corrigi levemente para o meu ambiente, porque  ele levou m√°quinas PublicIP e FQDN.  Eu n√£o tenho nenhum, mas h√° o PrivateIP que n√£o √© t√£o f√°cil de obter, ent√£o adicionei um artigo. <br><br><pre><code class="plaintext hljs">Param( [string] $labVmId) $labVmComputeId = (Get-AzureRmResource -Id $labVmId).Properties.ComputeId # Get lab VM resource group name $labVmRgName = (Get-AzureRmResource -Id $labVmComputeId).ResourceGroupName # Get the lab VM Name $labVmName = (Get-AzureRmResource -Id $labVmId).Name # Get lab VM public IP address # $labVMIpAddress = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName -Name $labVmName).IpAddress # Get lab VM FQDN # $labVMFqdn = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName -Name $labVmName).DnsSettings.Fqdn # Get lab VM private IP address $VmNetworkdetails= (((Get-AzureRmVM -ResourceGroupName $labVmRgName -Name $labVmName).NetworkProfile).NetworkInterfaces).Id $nicname = $VmNetworkdetails.substring($VmNetworkdetails.LastIndexOf("/")+1) $labVMnetwork = (Get-AzureRmNetworkInterface -Name $nicname -ResourceGroupName $labVmRgName)|Select-Object -ExpandProperty IPConfigurations $labVMIpAddress = $labVMnetwork.PrivateIpAddress # Set a variable labVmRgName to store the lab VM resource group name Write-Host "##vso[task.setvariable variable=labVmRgName;]$labVmRgName" # Set a variable labVMIpAddress to store the lab VM Ip address Write-Host "##vso[task.setvariable variable=labVMIpAddress;]$labVMIpAddress" # Set a variable labVMFqdn to store the lab VM FQDN name Write-Host "##vso[task.setvariable variable=labVMFqdn;]$labVMFqdn" Write-Output $labVMIpAddress Set-Item wsman:\localhost\client\trustedhosts * -Force</code> </pre> <br>  De tudo o que o script l√™, precisamos apenas da vari√°vel labVMIpAddress.  Bem, isso √© para mim, talvez voc√™ precise de algo mais, por isso eu n√£o apaguei nada e apenas comentei o excesso. <br><br>  Tamb√©m explicarei a √∫ltima linha do script, que permite √† nossa m√°quina de compila√ß√£o acessar qualquer host via WinRM. <br><br>  O pr√≥ximo passo, executamos nosso maravilhoso script.  Ele precisar√° da mesma conex√£o com a nuvem, a vari√°vel de entrada com o ID da m√°quina, que naquele momento j√° seria conhecido na etapa anterior.  Como  Aqui √© necess√°rio mencionar algo t√£o maravilhoso como vari√°veis ‚Äã‚Äãde sa√≠da.  Cada etapa pode ter uma lista de vari√°veis ‚Äã‚Äãque s√£o passadas para as pr√≥ximas etapas do pipeline.  Assim, para o nosso super script, essa vari√°vel ser√° labVMIpAddress, n√£o se esque√ßa de indicar isso. <br><br><img src="https://habrastorage.org/webt/yu/va/m7/yuvam7x2ikxspc7ucohyp5oivq4.jpeg"><br><br>  Al√©m disso, fa√ßo coisas bastante simples, que, al√©m disso, podem variar de caso para caso.  Eu executo um script remoto com a cria√ß√£o de bolas, no qual carregarei meus scripts. <br><br><pre> <code class="plaintext hljs">New-Item ‚ÄúC:\test" ‚Äìtype directory New-SMBShare ‚ÄìName ‚Äútest‚Äù ‚ÄìPath ‚ÄúC:\test‚Äù ‚ÄìFullAccess everyone</code> </pre> <br>  Pelo nome dos repolhos, fica claro que, em seguida, copiamos algum script de amostra para a m√°quina e o executamos em outra etapa.  Como o endere√ßo da m√°quina remota, nossa vari√°vel $ (labVMIpAddress) √© √∫til para n√≥s.  Em seguida, usamos a tarefa ‚Äúpegar o artefato das bolas‚Äù e copiamos os resultados do script para o nosso ambiente de constru√ß√£o; em seguida, salvamos esses arquivos no artefato de constru√ß√£o com a mesma tarefa padr√£o.  Depois que n√£o precisamos mais do carro, o matamos com o √∫ltimo passo.  A principal dificuldade, como pode ser visto no volume do artigo, √© integrar-se √† nuvem e estabelecer contato com a m√°quina virtual que voc√™ criou, para que voc√™ j√° possa se divertir o quanto precisar. <br><br>  Este √© o meu primeiro artigo, portanto, n√£o julgue estritamente, coment√°rios s√£o bem-vindos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460431/">https://habr.com/ru/post/pt460431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460415/index.html">Apple Watch 4 (44 mm, 2019) vs Pebble Steel Classic (2014)</a></li>
<li><a href="../pt460419/index.html">Recupera√ß√£o de calor de gases de combust√£o: ambientalmente amig√°vel</a></li>
<li><a href="../pt460421/index.html">Switch √≥ptico TP-Link T2600G-28SQ para provedores de servi√ßos: uma revis√£o detalhada</a></li>
<li><a href="../pt460423/index.html">WAL no PostgreSQL: 3. Ponto de Verifica√ß√£o</a></li>
<li><a href="../pt460425/index.html">Frio infernal, levita√ß√£o e plasma: passado, presente e futuro da supercondutividade</a></li>
<li><a href="../pt460433/index.html">Riscos e amea√ßas na Internet das coisas</a></li>
<li><a href="../pt460435/index.html">Petty little joy # 8: prazeres mesquinhos por trabalhar com o banco de dados</a></li>
<li><a href="../pt460437/index.html">Como colocamos uma bicicleta de suporte t√©cnico</a></li>
<li><a href="../pt460439/index.html">Linguagem de programa√ß√£o P4</a></li>
<li><a href="../pt460441/index.html">Gleb Nitzman: ‚ÄúEncontrei o final de uma era em que as pessoas ainda n√£o haviam perseguido o ouro contido nos elementos radioel√©tricos‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>