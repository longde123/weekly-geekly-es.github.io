<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧟 👻 🚽 Cómo probar contratos inteligentes 👩 🛂 💼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Los términos del contrato inteligente no se pueden cambiar. Por lo tanto, cada vez que cree un contrato inteligente, debe asegurarse de que funcione c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cómo probar contratos inteligentes</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mobileup/blog/432012/"><img src="https://habrastorage.org/webt/p5/xq/sj/p5xqsjbx3ydredj41fcohyg6jga.png" alt="imagen"><br><br>  Los términos del contrato inteligente no se pueden cambiar.  Por lo tanto, cada vez que cree un contrato inteligente, debe asegurarse de que funcione correctamente.  La prueba es una forma segura de probar un contrato en diferentes situaciones.  En este tutorial, aprenderá qué pasos tomar. <br><a name="habracut"></a><br>  Te diré: <br><br><ol><li>  Cómo preparar un entorno de prueba. </li><li>  Cómo escribir pruebas de <b>JavaScript</b> y ejecutarlas en <b>Truffle</b> . </li></ol><br>  El tutorial está dirigido a principiantes que acaban de comenzar a profundizar en el desarrollo y las pruebas de contratos inteligentes en Ethereum.  Para comprender este tutorial, debe tener al menos un conocimiento básico de <b>JavaScript</b> y <b>Solidity</b> . <br><br><h2>  1. Cómo preparar un entorno de prueba </h2><br>  Hay muchas formas de probar contratos inteligentes, pero <b><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Truffle</a></b> es la herramienta de escritura de prueba más popular que usa <b>JavaScript</b> .  En <b>Truffle,</b> puede escribir pruebas unitarias o realizar pruebas de integración completas con parámetros reales del entorno de producción. <br><br>  Primero debe instalar la última versión de Node.js desde el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sitio oficial</a> . <br>  Luego abra una terminal e instale <b>Truffle</b> usando el siguiente comando: <br><br><pre><code class="plaintext hljs">npm install -g truffle</code> </pre> <br>  Después de instalar <b>Truffle</b> , sin cerrar la terminal, cree el directorio de <b>Financiación</b> : <br><br><pre> <code class="plaintext hljs">mkdir Funding</code> </pre> <br>  A continuación, vaya al directorio con el comando: <br><br><pre> <code class="plaintext hljs">cd Funding</code> </pre> <br>  Para inicializar el directorio, ejecute el comando: <br><br><pre> <code class="plaintext hljs">truffle init</code> </pre> <br>  Después de ejecutar el comando, se crearán las siguientes carpetas y archivos en el directorio de <b>Financiación</b> : <br><br><img src="https://habrastorage.org/webt/lb/io/8k/lbio8kevpzbkkk45st2cj1xzmvw.png" alt="imagen"><br><br>  Además trabajaremos con cada directorio.  Mientras tanto, continuamos preparando el entorno de prueba. <br><br>  Para ejecutar las pruebas, necesita bibliotecas Javascript. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Mocha</a> es una biblioteca que contiene funciones comunes para la prueba, incluida la <b>descripción</b> y. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Chai</a> es una biblioteca que admite una variedad de funciones para cheques.  Existen diferentes "estilos" para verificar los resultados, y Chai nos brinda esta oportunidad.  En el tutorial usaremos <b>debería</b> . <br><br>  Por defecto, Mocha es parte de Truffle, podemos usar fácilmente las funciones de la biblioteca.  Chai debe instalarse manualmente.  Para hacer esto, use la terminal y en el directorio raíz del proyecto, ejecute el comando: <br><br><pre> <code class="plaintext hljs">npm install chai</code> </pre> <br>  También instalé la <b>biblioteca chai-bignumber</b> para comparar números con precisión arbitraria: <br><br><pre> <code class="plaintext hljs">npm install --save-dev chai-bignumber</code> </pre> <br>  El entorno de prueba está listo para esto.  Ahora puede comenzar a desarrollar un contrato inteligente y probarlo. <br><br><h2>  2. Cómo escribir pruebas de JavaScript y ejecutarlas en Truffle </h2><br>  Para desarrollar pruebas, necesita un contrato inteligente.  Desarrollaremos un contrato que le permita recolectar donaciones, establecer una cantidad específica para lograr la recolección y retirar fondos.  Si alguien dona más, se le devolverá la diferencia entre la cantidad que se ha acumulado y la cantidad que se debe cobrar. <br><br>  Vaya al directorio <b>Financiación -&gt; contratos</b> .  En <b>Financiación / contratos,</b> cree el archivo <b>Funding.sol</b> con la extensión <b>.sol</b> ; este será el contrato inteligente para las pruebas. <br><br>  En <b>Funding.sol,</b> agregue el siguiente código: <br><br><pre> <code class="javascript hljs">pragma solidity <span class="hljs-number"><span class="hljs-number">0.4</span></span><span class="hljs-number"><span class="hljs-number">.24</span></span>; contract Funding { uint public raised; uint public goal; address public owner; event Donated(uint donation); event Withdrew(uint amount); modifier onlyOwner() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(owner == msg.sender); _; } modifier isFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(isFunded()); _; } modifier notFinished() { <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(!isFunded()); _; } <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span> (uint _goal) public { owner = msg.sender; goal = _goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFunded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">view</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">bool</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> raised &gt;= goal; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">donate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">payable</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notFinished</span></span></span><span class="hljs-function"> </span></span>{ uint refund; raised += msg.value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (raised &gt; goal) { refund = raised - goal; raised -= refund; msg.sender.transfer(refund); } emit Donated(msg.value); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">withdraw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onlyOwner</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isFinished</span></span></span><span class="hljs-function"> </span></span>{ uint amount = address(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).balance; owner.transfer(amount); emit Withdrew(amount); } }</code> </pre><br>  El contrato esta listo.  Implementaremos un contrato inteligente a través de la migración. <br><br>  Las migraciones son archivos <b>JavaScript</b> que lo ayudan a implementar contratos en la red Ethereum.  Esta es la principal forma de implementar contratos. <br><br>  Vaya al directorio <b>Financiación -&gt; migraciones</b> y cree el archivo <b>2_funding.js</b> , agregando el siguiente código: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"./Funding.sol"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GOAL = <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS; <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">deployer</span></span></span><span class="hljs-function">) </span></span>{ deployer.deploy(Funding, GOAL); };</code> </pre> <br>  Para ejecutar las pruebas, debe usar el comando de <b>prueba de trufa</b> .  En la terminal, vaya a la raíz del directorio de <b>Financiación</b> , que se creó durante la preparación del entorno de prueba e ingrese: <br><br><pre> <code class="plaintext hljs">truffle test</code> </pre> <br>  Si la siguiente salida aparece en la terminal, entonces todo se hace correctamente: <br><br><img src="https://habrastorage.org/webt/yi/gn/wp/yignwpfhoay4uojgfxixff6twew.png" alt="imagen"><br><br>  Ahora comencemos a escribir pruebas. <br><br><h3>  Verificación del propietario </h3><br><br>  Vaya al directorio <b>Financiación -&gt; prueba</b> y cree un archivo <b>test_funding.js</b> con la extensión <b>.js</b> .  Este es el archivo en el que se escribirán las pruebas. <br><br>  Agregue el siguiente código al archivo <b>test_funding.js</b> : <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Funding = artifacts.require(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai"</span></span>).use(<span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"chai-bignumber"</span></span>)(web3.BigNumber)).should(); contract(<span class="hljs-string"><span class="hljs-string">"Funding"</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[account, firstDonator, secondDonator]</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; it(<span class="hljs-string"><span class="hljs-string">"should check the owner is valid"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { fundingContract = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Funding.deployed(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> owner = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.owner.call() owner.should.be.bignumber.equal(account); });</code> </pre><br>  En la prueba, verificamos que el contrato de <b>Financiación</b> almacena la dirección del propietario que implementó el contrato.  En nuestro caso, la <b>cuenta</b> es el primer elemento de la matriz.  <b>Truffle le</b> permite usar hasta diez direcciones, en las pruebas solo necesitamos tres direcciones. <br><br><h3>  Aceptación de donaciones y verificación del fin de la recaudación de fondos. </h3><br>  En esta sección revisaremos: <br><br><ol><li>  Aceptación y cantidad de donaciones. </li><li>  ¿Se ha alcanzado una cierta cantidad de donación? </li><li>  ¿Qué sucede si dona más de lo que necesita recolectar? </li><li>  El monto total de la donación. </li><li>  ¿Puedo continuar recaudando fondos si se ha recaudado la cantidad requerida? </li></ol><br>  Escribiremos y analizaremos las pruebas: <br><br><pre> <code class="javascript hljs">. . . . . . . . . . . . . . . . . . . . . . const ETHERS = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">18</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> GAS_PRICE = <span class="hljs-number"><span class="hljs-number">10</span></span>**<span class="hljs-number"><span class="hljs-number">6</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> fundingContract = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> txEvent; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">logs, eventName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> result = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">let</span></span> log <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> logs) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (log.event === eventName) { result = log; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }; it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #1"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bFirstDonator= web3.eth.getBalance(firstDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bFirstDonator.sub(web3.eth.getBalance(firstDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">5</span></span> * ETHERS); });</code> </pre><br>  Antes de analizar la prueba, quiero señalar 2 puntos: <br><br><ol><li>  Para buscar eventos (eventos) y verificar sus argumentos, se escribió una pequeña función <b>findEvent</b> . </li><li>  Para la conveniencia de las pruebas y los cálculos, se estableció el valor intrínseco para el gas (constante GAS_PRICE). </li></ol><br>  Ahora analicemos la prueba.  En la prueba, verificamos: <br><br><ul><li>  que podemos aceptar donaciones llamando al método <b>donate ()</b> ; </li><li>  que la cantidad donada a nosotros está indicada correctamente; </li><li>  que quien donó fondos, el saldo disminuyó en la cantidad donada. </li></ul><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if donation is not completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> isFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); isFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">false</span></span>); });</code> </pre><br>  En esta prueba, verificamos que la recaudación de fondos aún no se ha completado. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should not allow to withdraw the fund until the required amount has been collected"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre> <br>  En la prueba, verificamos que no podemos retirar fondos hasta que se obtenga la cantidad que necesitamos. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should accept donations from the donator #2"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bSecondDonator= web3.eth.getBalance(secondDonator); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> donate = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: secondDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS, <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(donate.logs, <span class="hljs-string"><span class="hljs-string">"Donated"</span></span>); txEvent.args.donation.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = bSecondDonator.sub(web3.eth.getBalance(secondDonator)).sub(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> web3.BigNumber(donate.receipt.gasUsed * GAS_PRICE)); difference.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">15</span></span> * ETHERS); });</code> </pre><br>  En la prueba, verificamos que si dona una gran cantidad, el método <b>donate ()</b> calcula y devuelve los fondos a la persona que donó más de lo necesario.  Este monto es la diferencia entre el monto acumulado y el monto que desea cobrar. <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">"should check if the donation is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> notFunded = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.isFunded(); notFunded.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); }); it(<span class="hljs-string"><span class="hljs-string">"should check if donated amount of money is correct"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> raised = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call(); raised.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); }); it(<span class="hljs-string"><span class="hljs-string">"should not accept donations if the fundraising is completed"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> isCaught = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.donate({ <span class="hljs-attr"><span class="hljs-attr">from</span></span>: firstDonator, <span class="hljs-attr"><span class="hljs-attr">value</span></span>: <span class="hljs-number"><span class="hljs-number">10</span></span> * ETHERS }); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (err) { isCaught = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } isCaught.should.be.equal(<span class="hljs-literal"><span class="hljs-literal">true</span></span>); });</code> </pre><br>  En estas tres pruebas, verificamos: <br><br><ul><li>  que la recaudación de fondos se ha completado; </li><li>  que el monto de la donación es correcto; </li><li>  que nadie más puede donar, ya que la recaudación de fondos se ha completado. </li></ul><br><h3>  Retirar fondos </h3><br>  En la sección anterior del tutorial, recopilamos la cantidad que necesitamos, ahora se puede mostrar: <br><br><pre> <code class="javascript hljs"> . . . . . . . . . . . . . . . . . . . . . . it(<span class="hljs-string"><span class="hljs-string">"should allow the owner to withdraw the fund"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> bAccount = web3.eth.getBalance(account); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> withdraw = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.withdraw({ <span class="hljs-attr"><span class="hljs-attr">gasPrice</span></span>: GAS_PRICE }); txEvent = findEvent(withdraw.logs, <span class="hljs-string"><span class="hljs-string">"Withdrew"</span></span>); txEvent.args.amount.should.be.bignumber.equal(<span class="hljs-number"><span class="hljs-number">20</span></span> * ETHERS); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> difference = web3.eth.getBalance(account).sub(bAccount); difference.should.be.bignumber.equal(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> fundingContract.raised.call() - withdraw.receipt.gasUsed * GAS_PRICE); });</code> </pre><br>  Al llamar a la función <b>retirada ()</b> , retiramos los fondos del propietario del contrato inteligente, en nuestra <b>cuenta de</b> caso.  Luego verificamos que realmente habíamos retirado la cantidad que necesitábamos.  Para hacer esto, <b>escriba la</b> diferencia en el saldo antes y después del retiro de fondos en la constante de <b>diferencia</b> .  El resultado se compara con la cantidad de donaciones menos la tarifa de transacción.  Como se mencionó anteriormente, para la conveniencia de las pruebas y los cálculos, establecí mi propio precio para el <b>gas</b> . <br><br>  Ejecute las pruebas escritas con el comando de <b>prueba de trufa</b> .  Si todo se hizo correctamente, el resultado debería ser el siguiente: <br><br><img src="https://habrastorage.org/webt/3n/jp/jr/3njpjroqs-jqwzfuejzkqu4neuk.png" alt="imagen"><br><br><h3>  Resultado </h3><br>  Traté de describir los pasos para probar contratos inteligentes en un lenguaje simple y comprensible: desde preparar un entorno de prueba hasta escribir las mismas pruebas. <br><br>  Ahora puede probar cualquier contrato inteligente y asegurarse de que funciona correctamente. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es432012/">https://habr.com/ru/post/es432012/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es431998/index.html">Conoce a Yandex.Phone - ahora oficialmente</a></li>
<li><a href="../es432002/index.html">Microsoft está desarrollando un navegador basado en Chromium, que se enviará de forma predeterminada en lugar de Edge</a></li>
<li><a href="../es432004/index.html">Introducción a la programación reactiva.</a></li>
<li><a href="../es432006/index.html">La historia de cómo me metí en el tema de la salud de la mujer.</a></li>
<li><a href="../es432008/index.html">Persiguiendo estándares web</a></li>
<li><a href="../es432014/index.html">Kali Linux para principiantes</a></li>
<li><a href="../es432016/index.html">Cómo la música y el dibujo me enseñaron a programar</a></li>
<li><a href="../es432020/index.html">Replicación en cadena: construir un repositorio KV eficiente (parte 2/2)</a></li>
<li><a href="../es432022/index.html">Forkney it: 8 proyectos Go que son interesantes para cavar en el código fuente</a></li>
<li><a href="../es432024/index.html">Gradle 5.0: novedades</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>