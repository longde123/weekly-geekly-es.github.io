<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üé∏ üö´ üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø N√ºtzliche Repositories mit Eloquent? üçü üë®üèø‚Äçüîß üôÇ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Letzte Woche habe ich einen Artikel √ºber die Nutzlosigkeit der Repository-Vorlage f√ºr eloquente Entit√§ten geschrieben , aber ich habe versprochen, zu ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>N√ºtzliche Repositories mit Eloquent?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/445452/"><p>  Letzte Woche habe ich <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen Artikel √ºber die Nutzlosigkeit der Repository-Vorlage f√ºr eloquente Entit√§ten geschrieben</a> , aber ich habe versprochen, zu erkl√§ren, wie man sie teilweise mit Nutzen verwendet.  Dazu werde ich versuchen zu analysieren, wie diese Vorlage normalerweise in Projekten verwendet wird.  Der minimal erforderliche Satz von Methoden f√ºr das Repository: </p><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Post $post)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span></span>; }</code> </pre> <br><p>  In realen Projekten werden jedoch h√§ufig Methoden zur Auswahl von Datens√§tzen hinzugef√ºgt, wenn entschieden wurde, Repositorys zu verwenden: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostRepository</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Post $post)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span></span>; }</code> </pre> <a name="habracut"></a><br><p>  Diese Methoden k√∂nnten √ºber eloquente Bereiche implementiert werden, aber das √úberladen von Entit√§tsklassen mit Verantwortlichkeiten f√ºr das Abrufen selbst ist keine gute Idee, und es erscheint logisch, diese Verantwortung in Repository-Klassen zu √ºbertragen.  Ist es so?  Ich habe diese Schnittstelle speziell visuell in zwei Teile unterteilt.  Der erste Teil der Methoden wird f√ºr Schreibvorg√§nge verwendet. </p><br><p>  Standardschreibvorg√§nge sind: </p><br><ul><li>  <strong>Erstellen</strong> eines neuen <strong>Objekts</strong> und Aufrufen von <strong>PostRepository :: save</strong> </li><li>  <strong>PostRepository :: getById</strong> , Entit√§tsmanipulation und Aufruf von <strong>PostRepository :: save</strong> </li><li>  Rufen Sie <strong>PostRepository :: delete auf</strong> </li></ul><br><p>  Bei Schreibvorg√§ngen gibt es keine Abtastmethoden.  Bei Lesevorg√§ngen werden nur get * -Methoden verwendet.  Wenn Sie √ºber das <strong>Prinzip</strong> der <strong>Schnittstellentrennung</strong> (Buchstabe <strong>I</strong> in <strong>SOLID</strong> ) <strong>lesen</strong> , wird deutlich, dass unsere Schnittstelle zu gro√ü ist und mindestens zwei verschiedene Aufgaben erf√ºllt.  Es ist Zeit, es in zwei Teile zu teilen.  Die Methode <strong>getById ist</strong> in beiden <strong>F√§llen</strong> erforderlich. Wenn die Anwendung jedoch komplizierter wird, unterscheidet sich ihre Implementierung.  Dies werden wir etwas sp√§ter sehen.  Ich habe in einem fr√ºheren Artikel √ºber die Nutzlosigkeit des Schreibteils geschrieben, also vergesse ich es einfach. </p><br><p>  Lesen Sie den Teil scheint mir nicht so nutzlos, denn selbst f√ºr Eloquent kann es mehrere Implementierungen geben.  Wie benenne ich eine Klasse?  Sie k√∂nnen <strong>ReadPostRepository verwenden</strong> , es hat jedoch bereits eine geringe Beziehung zur <strong>Repository-</strong> Vorlage.  Sie k√∂nnen einfach <strong>PostQueries</strong> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span></span>; }</code> </pre> <br><p>  Die Implementierung mit Eloquent ist recht einfach: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EloquentPostQueries</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::findOrFail($id); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::orderBy(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>) -&gt;limit(<span class="hljs-comment"><span class="hljs-comment">/*some limit*/</span></span>) -&gt;get(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::orderBy(<span class="hljs-string"><span class="hljs-string">'rating'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>) -&gt;limit(<span class="hljs-comment"><span class="hljs-comment">/*some limit*/</span></span>) -&gt;get(); } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> int $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::whereUserId($userId) -&gt;orderBy(<span class="hljs-string"><span class="hljs-string">'created_at'</span></span>, <span class="hljs-string"><span class="hljs-string">'desc'</span></span>) -&gt;get(); } }</code> </pre> <br><p>  Die Schnittstelle muss der Implementierung zugeordnet sein, z. B. im <strong>AppServiceProvider</strong> : </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppServiceProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;bind(PostQueries::class, EloquentPostQueries::class); } }</code> </pre> <br><p>  Diese Klasse ist bereits n√ºtzlich.  Er erkennt seine Verantwortung, indem er entweder Controller oder eine Entit√§tsklasse entl√§dt.  In der Steuerung kann es folgenderma√üen verwendet werden: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostsController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Controller</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">lastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(PostQueries $postQueries)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> view(<span class="hljs-string"><span class="hljs-string">'posts.last'</span></span>, [ <span class="hljs-string"><span class="hljs-string">'posts'</span></span> =&gt; $postQueries-&gt;getLastPosts(), ]); } }</code> </pre> <br><p>  Die <strong>PostsController :: lastPosts-Methode</strong> fragt sich einfach nach einer Implementierung von <strong>PostsQueries</strong> und arbeitet damit.  Im Provider haben wir <strong>PostQueries</strong> der <strong>EloquentPostQueries-</strong> Klasse zugeordnet, und diese Klasse wird in den Controller eingesetzt. </p><br><p>  Stellen wir uns vor, unsere Anwendung ist sehr beliebt geworden.  Tausende Benutzer pro Minute √∂ffnen die Seite mit den neuesten Ver√∂ffentlichungen.  Die beliebtesten Ver√∂ffentlichungen werden auch sehr oft gelesen.  Datenbanken kommen mit solchen Belastungen nicht sehr gut zurecht, daher verwenden sie den Standardl√∂sungs-Cache.  Zus√§tzlich zur Datenbank wird ein bestimmtes Daten-Nugget in einem Repository gespeichert, das f√ºr bestimmte Vorg√§nge optimiert ist - <strong>Memcached</strong> oder <strong>Redis</strong> . </p><br><p>  Die Caching-Logik ist normalerweise nicht so kompliziert, aber die Implementierung in EloquentPostQueries ist nicht sehr korrekt (zumindest aufgrund des <strong>Single-Responsibility-Prinzips</strong> ).  Es ist viel nat√ºrlicher, die <strong>Decorator-</strong> Vorlage zu verwenden und das Caching als Dekoration f√ºr die Hauptaktion zu implementieren: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Illuminate</span></span>\<span class="hljs-title"><span class="hljs-title">Contracts</span></span>\<span class="hljs-title"><span class="hljs-title">Cache</span></span>\<span class="hljs-title"><span class="hljs-title">Repository</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CachedPostQueries</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> LASTS_DURATION = <span class="hljs-number"><span class="hljs-number">10</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> PostQueries */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $base; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> Repository */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $cache; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( PostQueries $base, Repository $cache)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;base = $base; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache = $cache; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> Post[] | Collection */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;cache-&gt;remember(<span class="hljs-string"><span class="hljs-string">'last_posts'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::LASTS_DURATION, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;base-&gt;getLastPosts(); }); } <span class="hljs-comment"><span class="hljs-comment">//      }</span></span></code> </pre> <br><p>  Ignorieren Sie die <strong>Repository-</strong> Schnittstelle im Konstruktor.  Aus irgendeinem Grund haben sie beschlossen, die Schnittstelle f√ºr das Caching in Laravel aufzurufen. </p><br><p>  Die <strong>CachedPostQueries-</strong> Klasse implementiert nur das Caching.  <strong>$ this-&gt; cache-&gt; merke dir</strong> , ob der angegebene Eintrag im Cache ist. Wenn nicht, ruft er den R√ºckruf auf und schreibt den zur√ºckgegebenen Wert in den Cache.  Es bleibt nur diese Klasse in der Anwendung zu implementieren.  Wir ben√∂tigen alle Klassen, die in der Anwendung die Implementierung der <strong>PostQueries-</strong> Schnittstelle <strong>anfordern</strong> , um eine Instanz der <strong>CachedPostQueries-</strong> Klasse zu erhalten.  <strong>CachedPostQueries</strong> selbst sollte jedoch die <strong>EloquentPostQueries-</strong> Klasse als Parameter im Konstruktor erhalten, da dies ohne eine "echte" Implementierung nicht funktionieren kann.  <strong>AppServiceProvider</strong> √§ndern: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppServiceProvider</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ServiceProvider</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">register</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;bind(PostQueries::class, CachedPostQueries::class); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;app-&gt;when(CachedPostQueries::class) -&gt;needs(PostQueries::class) -&gt;give(EloquentPostQueries::class); } }</code> </pre> <br><p>  Alle meine W√ºnsche sind ganz nat√ºrlich im Anbieter beschrieben.  Daher haben wir das Caching f√ºr unsere Anforderungen nur implementiert, indem wir eine Klasse geschrieben und die Containerkonfiguration ge√§ndert haben.  Der Code f√ºr den Rest der Anwendung wurde nicht ge√§ndert. </p><br><p>  Nat√ºrlich ist es f√ºr die vollst√§ndige Implementierung des Caching weiterhin erforderlich, die Ung√ºltigmachung zu implementieren, damit der gel√∂schte Artikel nicht l√§nger auf der Site h√§ngt, sondern sofort abl√§uft (k√ºrzlich wurde <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ein Artikel √ºber das Caching geschrieben</a> , der im Detail hilfreich sein kann). </p><br><p>  Fazit: Wir haben nicht ein, sondern zwei ganze Muster verwendet.  Die <strong>CQRS-</strong> Vorlage <strong>(Command Query Responsibility Segregation)</strong> bietet eine vollst√§ndige Trennung von Lese- und Schreibvorg√§ngen auf Schnittstellenebene.  Ich bin durch das <strong>Prinzip</strong> der <strong>Schnittstellentrennung</strong> zu ihm gekommen, was bedeutet, dass ich Vorlagen und Prinzipien geschickt manipuliere und als Theorem voneinander ableitet :) Nat√ºrlich ben√∂tigt nicht jedes Projekt eine solche Abstraktion auf Entit√§tsbeispielen, aber ich werde den Fokus mit Ihnen teilen. <strong>In der</strong> Anfangsphase der Anwendungsentwicklung k√∂nnen Sie einfach eine <strong>PostQueries-</strong> Klasse mit einer regelm√§√üigen Implementierung √ºber Eloquent erstellen: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Post::findOrFail($id); } <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre> <br><p>  Wenn Caching erforderlich ist, k√∂nnen Sie anstelle dieser <strong>PostQueries-</strong> Klasse problemlos eine Schnittstelle (oder eine abstrakte Klasse) <strong>erstellen</strong> , deren Implementierung in die <strong>EloquentPostQueries-</strong> Klasse kopieren und zu dem zuvor beschriebenen Schema <strong>wechseln</strong> .  Der Rest des Anwendungscodes muss nicht ge√§ndert werden. </p><br><p>  Es bleibt jedoch ein Problem bei der Verwendung derselben Post-Entit√§ten, die Daten √§ndern k√∂nnen.  Dies ist nicht genau CQRS. </p><br><p><img src="https://habrastorage.org/webt/c3/rl/wx/c3rlwxjo18l4kxe9zfjmxr-axfi.png"></p><br><p>  Niemand st√∂rt sich daran, die <strong>Post-</strong> Entit√§t von <strong>PostQueries abzurufen</strong> , zu √§ndern und die √Ñnderungen mit einem einfachen <strong>-&gt; save () zu speichern</strong> .  Und es wird funktionieren. <br>  Nach einer Weile wechselt das Team zur Master-Slave-Replikation in der Datenbank und <strong>PostQueries</strong> arbeitet mit <strong>Lesereplikaten</strong> .  Schreibvorg√§nge f√ºr Lesereplikate werden normalerweise blockiert.  Der Fehler wird ge√∂ffnet, aber Sie m√ºssen hart arbeiten, um alle diese Pfosten zu beheben. </p><br><p>  Die naheliegende L√∂sung besteht darin, die <strong>Lese-</strong> und <strong>Schreibteile</strong> vollst√§ndig zu trennen.  Sie k√∂nnen Eloquent weiterhin verwenden, indem Sie jedoch eine Klasse f√ºr schreibgesch√ºtzte Modelle erstellen.  Beispiel: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://github.com/adelf/freelance-example/blob/master/app/ReadModels/ReadModel.php</a> Alle Daten√§nderungsvorg√§nge sind blockiert.  Erstellen Sie ein neues Modell, z. B. <strong>ReadPost</strong> (Sie k√∂nnen <strong>Post</strong> verlassen, aber in einen anderen Namespace verschieben): </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReadPost</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReadModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $table = <span class="hljs-string"><span class="hljs-string">'posts'</span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadPost</span></span></span></span>; }</code> </pre> <br><p>  Solche Modelle k√∂nnen schreibgesch√ºtzt und sicher zwischengespeichert werden. </p><br><p><img src="https://habrastorage.org/webt/ib/eu/wq/ibeuwqyh2aobxpdnlxjy9ypuwqg.png"></p><br><p>  Eine weitere Option: Eloquent aufgeben.  Daf√ºr kann es mehrere Gr√ºnde geben: </p><br><ul><li>  Alle Tabellenfelder werden fast nie ben√∂tigt.  F√ºr die <strong>LastPosts-</strong> Anforderung sind normalerweise nur die Felder <strong>id</strong> , <strong>title</strong> und beispielsweise <strong>shared_at</strong> erforderlich.  Das Anfordern einiger schwerer Texte von Ver√∂ffentlichungen f√ºhrt nur zu einer unn√∂tigen Belastung der Datenbank oder des Caches.  Eloquent kann nur die erforderlichen Felder ausw√§hlen, aber all dies ist sehr implizit.  <strong>PostQueries-</strong> Kunden <strong>wissen</strong> nicht genau, welche Felder ausgew√§hlt werden, ohne in die Implementierung <strong>einzusteigen</strong> . </li><li>  Beim Caching wird standardm√§√üig die Serialisierung verwendet.  Eloquente Klassen nehmen in serialisierter Form zu viel Platz ein.  Wenn dies bei einfachen Entit√§ten nicht besonders auff√§llt, wird dies bei komplexen Entit√§ten mit Beziehungen zu einem Problem (wie ziehen Sie sogar Objekte mit einer Megabyte-Gr√∂√üe aus dem Cache?).  Bei einem Projekt ben√∂tigte eine normale Klasse mit √∂ffentlichen Feldern im Cache zehnmal weniger Speicherplatz als die Option Eloquent (es gab viele kleine Subentit√§ten).  Sie k√∂nnen Attribute nur beim Zwischenspeichern zwischenspeichern, dies erschwert den Vorgang jedoch erheblich. </li></ul><br><p>  Ein einfaches Beispiel daf√ºr, wie dies aussehen k√∂nnte: </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostHeader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> int $id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string $title; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime $publishedAt; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Post</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> int $id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string $title; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> string $text; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime $publishedAt; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PostQueries</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function">: </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Post</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> PostHeader[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> PostHeader[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getTopPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> int $userId * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> PostHeader[] */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserPosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($userId)</span></span></span></span>; }</code> </pre> <br><p>  Nat√ºrlich scheint dies alles eine wilde √úberkomplikation der Logik zu sein.  "Nehmen Sie die eloquenten Zielfernrohre und alles wird gut. Warum sich das alles einfallen lassen?"  F√ºr einfachere Projekte ist dies richtig.  Es ist absolut nicht notwendig, die Bereiche neu zu erfinden.  Aber wenn das Projekt gro√ü ist und mehrere Entwickler an der Entwicklung beteiligt sind, die sich oft √§ndern (sie beenden und neue kommen), werden die Spielregeln etwas anders.  Der Code muss gesch√ºtzt geschrieben werden, damit der neue Entwickler nach einigen Jahren nichts falsch machen kann.  Nat√ºrlich ist es unm√∂glich, eine solche Wahrscheinlichkeit vollst√§ndig auszuschlie√üen, aber es ist notwendig, ihre Wahrscheinlichkeit zu verringern.  Dar√ºber hinaus ist dies eine √ºbliche Systemzerlegung.  Sie k√∂nnen alle Caching-Dekoratoren und -Klassen f√ºr die Ung√ºltigmachung des Caches in einem bestimmten "Caching-Modul" sammeln und so den Rest der Anwendung von Informationen zum Caching speichern.  Ich musste gro√üe Anfragen durchsuchen, die von Cache-Aufrufen umgeben waren.  Es steht im Weg.  Insbesondere wenn die Caching-Logik nicht so einfach ist wie oben beschrieben. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de445452/">https://habr.com/ru/post/de445452/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de445440/index.html">Code√ºberpr√ºfung: schlechte Tipps f√ºr Mitwirkende und Pr√ºfer</a></li>
<li><a href="../de445444/index.html">Hochleistungs-Solarmodul-Update von REC und Trina (Solar)</a></li>
<li><a href="../de445446/index.html">Wie wir die verz√∂gerte Replikation f√ºr die Notfallwiederherstellung mit PostgreSQL verwendet haben</a></li>
<li><a href="../de445448/index.html">Konfigurieren des automatischen Empfangs von Letsencrypt-Zertifikaten mit Docker unter Linux</a></li>
<li><a href="../de445450/index.html">Browser-Erweiterung f√ºr toster.ru</a></li>
<li><a href="../de445454/index.html">Himbeer Pi Zero Inside Handy Tech Active Star 40 Braillezeile</a></li>
<li><a href="../de445456/index.html">Suche mit 1 TB / s</a></li>
<li><a href="../de445458/index.html">Electronic Arts wird 350 Mitarbeiter besch√§ftigen und seine Pr√§senz in Russland reduzieren</a></li>
<li><a href="../de445460/index.html">Gadget-freie Interaktivit√§t</a></li>
<li><a href="../de445464/index.html">Verringerung der Stichprobengr√∂√üe experimenteller Daten ohne Informationsverlust</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>