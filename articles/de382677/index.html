<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊🏻 🛍️ 🧜🏻 Mein Internet der Dinge: Guest Castle (Teil 2) 🚉 👰🏽 🈲</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hallo GT! Alles mit dem Kommen und der Vergangenheit! 
 Ich setze die Geschichte fort, wie ich das Türschloss mit dem Internet verbunden habe. Beginne...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mein Internet der Dinge: Guest Castle (Teil 2)</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/382677/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Hallo GT! Alles mit dem Kommen und der Vergangenheit! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich setze die Geschichte fort, wie ich das Türschloss mit dem Internet verbunden habe. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Beginnen Sie hier</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Vielen Dank an alle für die Kommentare. Es gibt wirklich vorgefertigte Lösungen, aber es gibt auch eine Reihe von Nuancen, die es mir nicht erlaubt haben, sie zu verwenden. Eine Wohnung ist immer noch kein Hotel, daher entlassen wir spezialisierte Hotelburgen sofort. Schlüsselschlösser, Antennen für NFC, um die Nachbarn nicht zu erschrecken, berücksichtigen wir auch nicht. Es können auch keine Karten, Token oder andere physische Medien verwendet werden. Es versteht sich, dass es keine Möglichkeit gibt, diese an einen Gast zu übertragen, bevor er die Tür öffnet.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Kevo, August oder Lockitron konnten nicht verwendet werden, weil Sie basieren auf dem amerikanischen Schloss (Riegel), das an einer 65-70 mm dicken Stahltür nicht sehr gut installiert ist. Unsere Wahl ist das elektromechanische CISA für Panzertüren zum Preis von rund 500 Euro (noch nicht gekauft, weil teuer). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Und vor allem möchte ich etwas mit meinen eigenen Händen tun, nicht egoistisch sein, um Hobbyströmungen willen.</font></font><br>
<img src="https://habrastorage.org/files/12f/2b5/6a3/12f2b56a3cae496d9f3717839e37cea1.JPG"><br>
<a name="habracut"></a><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich möchte Sie daran erinnern, dass sich der Lock Controller tief hinter NAT im lokalen Heimnetzwerk befindet. Daher ist es nicht sinnvoll, den Webserver auf Arduin zu erhöhen. Es ist unmöglich, ihn über das Internet zu erreichen. Der Server wird in Python unter Verwendung des Twisted-Frameworks geschrieben, läuft unter Linux an einem anderen Ort, an dem eine echte IP-Adresse vorhanden ist, und der Controller stellt eine Verbindung dazu her und wartet auf Befehle. </font></font><br>
<img src="https://habrastorage.org/files/c3a/803/92b/c3a80392b83f4a0382e764ad8afa142e.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt möchte ich über die Logik der Arbeit und der Kryptographie sprechen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich habe nichts gefunden, das den Verkehr für Arduina verschlüsselt, da die Kommunikation zwischen Schloss und Server über offene Kanäle mit unverschlüsseltem Verkehr erfolgt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im ersten Prototyp habe ich MD5 verwendet, jetzt habe ich es in SHA-1 geändert, hier in dieser </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Cryptosuite-</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Bibliothek </font><font style="vertical-align: inherit;">. Es verbraucht weniger Speicher und es gibt bereits eine vorgefertigte HMAC-Funktion.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Schlüssel ist ein Passwort mit bis zu 30 ASCII-Zeichen, das im EEPROM-Speicher des Controllers gespeichert ist. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im ersten Prototyp wurde dasselbe Passwort explizit auf dem Server gespeichert, was natürlich keine Sicherheit darstellt. Der zweite Prototyp erforderte zwei Passwörter. Die erste besteht darin, die Sperre beim Herstellen einer Verbindung zum Server zu authentifizieren. Sie können die Sperre nicht mit diesem Kennwort öffnen. Sie wird benötigt, damit nur die richtigen Sperren eine Verbindung zum Server herstellen können. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Schloss stellt eine Verbindung zum Server her und teilt ihm zunächst seine Kennung mit. Der Server prüft in der Datenbank, ob eine solche Sperre vorliegt, und sendet als Antwort eine zufällig generierte ASCII-Sequenz. Das Schloss "signiert" es mit einem Passwort und sendet den Hash zurück. Der Server vergleicht den empfangenen Hash mit dem, was er selbst berechnet hat, und wenn er übereinstimmt, autorisiert er den verbundenen Controller als "Sperre".</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Andernfalls wird die Verbindung zurückgesetzt. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das zweite Passwort ist bereits ein digitaler Schlüssel und wird nicht auf dem Server gespeichert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es funktioniert wie folgt: Die Benutzeranwendung ruft über die SOAP-Funktion auf dem Server auf, gibt die ID der Sperre und den Befehl an, den sie ihm senden möchte. Infolgedessen gibt die Funktion die Anforderungs-ID zurück. Der Server leitet diesen Befehl an die Steuerung weiter, die Steuerung sendet als Antwort eine zufällig generierte ASCII-Sequenz und wartet einige Sekunden auf die „richtige“ Antwort. Als nächstes muss die Benutzeranwendung es vom Server über dieselbe SOAP per Anforderungs-ID abrufen, mit einem digitalen Schlüssel signieren und zurücksenden. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Controller vergleicht den empfangenen Hash mit dem berechneten selbst und führt bei Übereinstimmung den zuvor empfangenen Befehl aus, der dem Server gemeldet wird.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Die Zeit zur Bestätigung des Befehls ist auf 2 Sekunden begrenzt. Wenn während dieser Zeit keine Antwort empfangen wird, ignoriert die Steuerung den zuvor empfangenen Befehl. Wenn die Hashes nicht übereinstimmen, wird der Befehl ebenfalls ignoriert. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher versuche ich, mich vor dem Angriff „Mann in der Mitte“ zu schützen, der sehr einfach auf den Drähten meines Providers zu arrangieren ist. Die Verbindung ist dort einfach, keine Passwörter und Zertifikate, es reicht aus, das Twisted Pair im Shield zu schneiden, es auf beiden Seiten zusammenzudrücken, es von der Apartment-Seite mit der IP-Adresse des Befehlsservers in das Netzwerk einzustecken, die Sperre am anderen Ende zu emulieren (ich habe auch ein Skript zur Emulation auf dem Python zum Debuggen geschrieben ), nachdem eine solche "Firewall" mit Abhören angeordnet wurde. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
In dieser Hinsicht erwies sich die Burg meiner Meinung nach als ziemlich geschützt.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Selbst das Hacken des Befehlsservers und das Stehlen seiner Datenbank mit Passwörtern zur Autorisierung durch die Sperre wird keine großen Probleme verursachen, da sie die Sperre nicht öffnen können. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Es bleibt nur mit den Gästen zu tun. Dies sind die Anforderungen Nr. 6-8 aus dem ersten Artikel. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Tastaturen, Proxys, RFID und NFC sind keine Option. Aber fast jeder hat ein Smartphone und alle Smartphones haben Bluetooth, die Wahl liegt auf der Hand! </font></font><br>
<img src="https://habrastorage.org/files/d2a/1bd/1b0/d2a1bd1b0a2a4f81a906fba3e2640b5e.jpg"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Im ersten Prototyp wurde einem Gast ein einziger Zugangscode zugeordnet. In der Serverdatenbank für diesen Code wurden die ID der Sperre, das Datum und die Uhrzeit des Beginns und des Endes des Gastzugriffs sowie ein Textfeld für den vom Menschen lesbaren Namen des Gastes gespeichert.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Der Gast kommt zum Schloss, startet die mobile Anwendung auf seinem Smartphone, sendet einen Zugangscode über Bluetooth an den Controller, eine Nachricht vom Controller an den Server, die besagt, dass sich ein Gast mit einem solchen Zugangscode an ihn gewandt hat. Der Server vergleicht dies mit der Datenbank. Wenn der richtige Gast zur richtigen Zeit am richtigen Ort eingetroffen ist, sendet er den Befehl zum Öffnen der Sperre. Anstelle des eindeutigen Zugangscodes sendet der Gast einen HMAC-Hash, der mit einem „temporären Stempel“ signiert ist (eine Zeichenfolgendarstellung der Unix-Zeit geteilt durch 30, wobei der Bruchteil verworfen wird). Der Server zur Überprüfung sendet eine Anforderung an die Datenbank mit einer Auswahl aller derzeit gültigen Zugriffscodes für eine bestimmte Sperre, durchläuft diese dann und berechnet eine ähnliche HMAC für sie. Wenn er eine Übereinstimmung findet, sendet er einen Befehl zum Öffnen.Wenn die Suche nach Zugangscodes endet, bevor eine Übereinstimmung gefunden werden kann, wird beim Versuch, sie zu öffnen, eine negative Antwort an das Schloss gesendet.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das Problem ist, dass der digitale Schlüssel für eine solche Autorisierung auf dem Server gespeichert werden musste. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Ich musste die "Gast" -Autorisierung für den zweiten Prototyp komplizieren. Der Gastzugangscode besteht jetzt aus zwei Schlüsseln. Nennen wir sie "Server" und "privat". Der Server wird benötigt, um ein Gastkonto auf dem Server einzurichten, und privat, um die Sperre selbst zu öffnen. Der Server wird explizit auf dem Server gespeichert, und vom privaten gibt es nur einen Hash, aber keinen einfachen, sondern einen HMAC mit einem digitalen Schlüssel für das Schloss. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Jetzt sieht die Gastautorisierungssitzung folgendermaßen aus: </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
1. Die Gastanwendung sendet den "Server" -Schlüssel an den Controller (wie im ersten Prototyp seinen Hash) und </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
2. Der Server überprüft ihn auf die gleiche Weise, aber anstelle des Befehls "Öffnen" wird der Hash des privaten Schlüssels gesendet</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
3. Der Controller vergleicht den Hash des vom Server empfangenen privaten Schlüssels mit dem unabhängig berechneten Hash. Wenn er übereinstimmt, wird die Sperre geöffnet. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Daher speichert der Server nichts, was die Sperre öffnen könnte. Es funktioniert nicht, den gewünschten Hash zu generieren, ohne den digitalen Schlüssel zu kennen. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Das gleiche Bluetooth wird auch für den Master-Zugriff ohne Internet verwendet. Der Controller empfängt Befehle über ihn und antwortet mit einem Einmalcode, der 2 Sekunden lang mit dem richtigen digitalen Schlüssel signiert werden muss.</font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Dadurch möchte ich die Grundeinstellungen des Controllers vornehmen. </font><font style="vertical-align: inherit;">Der Eigentümer drückt eine spezielle Taste auf dem Controller. Danach akzeptiert er einen erweiterten Befehlssatz, z. B. das Festlegen der Sperr-ID, der geheimen Schlüssel, der Server-Port-Adresse, der Netzwerkeinstellungen usw. </font><font style="vertical-align: inherit;">Aber in Adruin ging die Erinnerung aus und die Skizze passt nicht. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">
Am Ende eine kurze Demonstration der Arbeit.</font></font><br>
<iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=aue&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=https://www.youtube.com/embed/dfSnXt631KQ%3Ffeature%3Doembed&amp;usg=ALkJrhiin5OUl48OqXhG7hvIDZXuUDNW1Q" frameborder="0" allowfullscreen=""></iframe></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de382677/">https://habr.com/ru/post/de382677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de382665/index.html">Стратегии и тактики email-маркетинга. Часть 1</a></li>
<li><a href="../de382667/index.html">Intel kündigt ersten Xeon Notebook-Prozessor an</a></li>
<li><a href="../de382669/index.html">Ein Reiniger. Unreine Software bekämpfen</a></li>
<li><a href="../de382673/index.html">Aibo Robot Dog Mortalität</a></li>
<li><a href="../de382675/index.html">Riesige Faultiere der Vergangenheit konnten U-Bahnlinien legen</a></li>
<li><a href="../de382679/index.html">Astronomen konnten Bilder des Lavasees auf der Oberfläche von Io, dem Satelliten des Jupiter, aufnehmen</a></li>
<li><a href="../de382681/index.html">5 Stunden Sojus 'Annäherung an die ISS - in einem halbstündigen Video auf YouTube</a></li>
<li><a href="../de382685/index.html">Schau über den Horizont hinaus</a></li>
<li><a href="../de382687/index.html">CERN-Wissenschaftler bereiten ein "Kraftfeld" vor, um Astronauten vor Strahlung zu schützen</a></li>
<li><a href="../de382689/index.html">Управляем освещением в квартире (NooLite, Raspberry Pi и WebIOPi)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>