<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëê ü§±üèº üëêüèº Teste de configura√ß√£o para desenvolvedores Java: experi√™ncia pr√°tica üöµüèº üë∑üèº ‚õ±Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Com os testes para o c√≥digo, tudo fica claro (bem, pelo menos o fato de que eles precisam ser escritos). Com os testes de configura√ß√£o, tudo fica muit...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teste de configura√ß√£o para desenvolvedores Java: experi√™ncia pr√°tica</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jugru/blog/427487/"><img src="https://habrastorage.org/webt/9o/r3/24/9or324raqccmfaeghrlyaagxmja.jpeg"><br><br>  Com os testes para o c√≥digo, tudo fica claro (bem, pelo menos o fato de que eles precisam ser escritos).  Com os testes de configura√ß√£o, tudo fica muito menos √≥bvio, come√ßando com a pr√≥pria exist√™ncia.  Algu√©m os escreve?  Isso √© importante?  Isso √© dif√≠cil?  Que tipo de resultados podem ser alcan√ßados com a ajuda deles? <br><br>  Acontece que isso tamb√©m √© muito √∫til, come√ßar a faz√™-lo √© muito simples e, ao mesmo tempo, existem muitas nuances no teste da configura√ß√£o.  Quais - pintados sob o corte com base na experi√™ncia pr√°tica. <br><a name="habracut"></a><br>  <i>O material √© baseado na transcri√ß√£o de um relat√≥rio de <b>Ruslan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=" class="user_link">cheremin</a> Cheremin</b> (desenvolvedor Java do Deutsche Bank).</i>  <i>A seguir, fala em primeira pessoa.</i> <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/Tk_nmV-mWOA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  Meu nome √© Ruslan, trabalho no Deutsche Bank.  Come√ßamos com isso: <br><br><img src="https://habrastorage.org/webt/vg/xr/rq/vgxrrqh1taa98cujjske1r5usa4.jpeg"><br><br>  H√° muito texto, de longe parece russo.  Mas isso n√£o √© verdade.  Esta √© uma linguagem muito antiga e perigosa.  Fiz uma tradu√ß√£o para o russo simples: <br><br><ul><li>  Todos os personagens s√£o compostos </li><li>  Use com cuidado </li><li>  Funeral √†s suas pr√≥prias custas </li></ul><br><br>  Vou descrever brevemente o que vou falar hoje.  Suponha que tenhamos um c√≥digo: <br><br><img src="https://habrastorage.org/webt/qv/ip/gd/qvipgdp4a8n1bjo79z29aicqmik.jpeg"><br><br>  Ou seja, inicialmente tivemos algum tipo de tarefa, escrevemos um c√≥digo para resolv√™-lo e, supostamente, ganha dinheiro.  Se, por algum motivo, esse c√≥digo n√£o funcionar corretamente, ele resolve a tarefa errada e ganha o dinheiro errado.  Os neg√≥cios n√£o gostam desse tipo de dinheiro - eles parecem ruins nas demonstra√ß√µes financeiras. <br><br>  Portanto, para o nosso c√≥digo importante, temos testes: <br><br><img src="https://habrastorage.org/webt/0e/9g/-k/0e9g-klbunmtoyvlhf9q0-vl-4o.jpeg"><br><br>  Geralmente l√°.  Agora, provavelmente, quase todo mundo tem.  Os testes verificam se o c√≥digo resolve o problema certo e gera o dinheiro certo.  Mas o servi√ßo n√£o se limita ao c√≥digo e, ao lado do c√≥digo, h√° tamb√©m uma configura√ß√£o: <br><br><img src="https://habrastorage.org/webt/z7/75/sq/z775sqxlsy1nha5hrclznn6biq0.jpeg"><br><br>  Pelo menos em quase todos os projetos em que participei, essa configura√ß√£o era, de uma forma ou de outra.  (Lembro-me apenas de alguns casos dos meus primeiros anos de interface do usu√°rio, onde n√£o havia arquivos de configura√ß√£o, mas tudo foi configurado por meio da interface do usu√°rio). Nesta configura√ß√£o, existem portas, endere√ßos e par√¢metros de algoritmo. <br><br><h2>  Por que a configura√ß√£o √© importante para testar? </h2><br>  Aqui est√° o truque: erros na configura√ß√£o prejudicam a execu√ß√£o do programa, n√£o menos que erros no c√≥digo.  Eles tamb√©m podem fazer com que o c√≥digo execute a tarefa errada - e veja acima. <br><br>  E encontrar erros na configura√ß√£o √© ainda mais dif√≠cil do que no c√≥digo, pois a configura√ß√£o geralmente n√£o √© compilada.  Citei os arquivos de propriedades como exemplo, em geral existem op√ß√µes diferentes (JSON, XML, algu√©m armazena no YAML), mas √© importante que nada disso seja compilado e, portanto, n√£o seja verificado.  Se voc√™ acidentalmente selou um arquivo Java - provavelmente, ele simplesmente n√£o passar√° na compila√ß√£o.  Um erro de digita√ß√£o aleat√≥rio na propriedade n√£o excitar√° ningu√©m, ele funcionar√°. <br><br>  E o IDE tamb√©m n√£o destaca o erro na configura√ß√£o, porque sabe apenas o mais primitivo sobre o formato (por exemplo) dos arquivos de propriedades: que deve haver uma chave e um valor e "igual", dois pontos ou espa√ßo entre eles.  Mas o fato de que o valor deve ser um n√∫mero, uma porta de rede ou um endere√ßo - o IDE n√£o sabe de nada. <br><br>  E mesmo se voc√™ testar o aplicativo em um UAT ou em um ambiente tempor√°rio, isso tamb√©m n√£o garante nada.  Como a configura√ß√£o, em regra, em cada ambiente √© diferente, e no UAT voc√™ testou apenas a configura√ß√£o do UAT. <br><br>  Outra sutileza √© que, mesmo na produ√ß√£o, os erros de configura√ß√£o √†s vezes n√£o aparecem imediatamente.  Um servi√ßo pode n√£o iniciar - e este √© um bom cen√°rio.  Mas ele pode come√ßar e trabalhar por muito tempo - at√© o momento X, quando ser√° necess√°rio exatamente o par√¢metro em que o erro.  E aqui voc√™ descobre que um servi√ßo que nem mudou muito recentemente parou de funcionar repentinamente. <br><br>  Depois de tudo o que eu disse - parece que as configura√ß√µes de teste devem ser um t√≥pico importante.  Mas, na pr√°tica, parece algo como isto: <br><br><img src="https://habrastorage.org/webt/9o/r3/24/9or324raqccmfaeghrlyaagxmja.jpeg"><br><br>  Pelo menos foi esse o caso conosco - at√© um certo ponto.  E uma das tarefas do meu relat√≥rio √© parar de parecer assim tamb√©m para voc√™.  Espero poder empurrar voc√™ para isso. <br><br>  Tr√™s anos atr√°s, no nosso Deutsche Bank, na minha equipe, Andrei Satarin trabalhou como l√≠der de controle de qualidade.  Foi ele quem trouxe a ideia de testar configura√ß√µes - ou seja, ele simplesmente fez e realizou o primeiro teste desse tipo.  Seis meses atr√°s, no Heisenbug anterior, ele <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">falou</a> sobre o teste da configura√ß√£o como a v√™.  Eu recomendo que voc√™ olhe, porque l√° ele deu uma vis√£o ampla do problema: tanto do lado de artigos cient√≠ficos quanto da experi√™ncia de grandes empresas que encontraram erros de configura√ß√£o e suas conseq√º√™ncias. <br><br>  Meu relat√≥rio ser√° mais restrito - sobre a experi√™ncia pr√°tica.  Vou falar sobre quais problemas, como desenvolvedor, encontrei quando escrevi testes de configura√ß√£o e como resolvi esses problemas.  Minhas decis√µes podem n√£o ser as melhores, n√£o s√£o as melhores pr√°ticas - esta √© minha experi√™ncia pessoal, tentei n√£o fazer generaliza√ß√µes amplas. <br><br>  Descri√ß√£o geral do relat√≥rio: <br><br><ul><li>  ‚ÄúO que voc√™ pode fazer antes da segunda-feira √† tarde‚Äù: exemplos simples e √∫teis. </li><li>  "Segunda-feira, dois anos depois": onde e como fazer melhor. </li><li>  Suporte para refatora√ß√£o da configura√ß√£o: como obter uma cobertura densa;  modelo de configura√ß√£o de software. </li></ul><br><br>  A primeira parte √© motivacional: descreverei os testes mais simples com os quais tudo come√ßou conosco.  Haver√° uma grande variedade de exemplos.  Espero que pelo menos um deles ressoe com voc√™, ou seja, voc√™ ver√° algum tipo de problema semelhante e sua solu√ß√£o. <br><br>  Os testes em si na primeira parte s√£o simples, at√© primitivos - do ponto de vista da engenharia, n√£o h√° ci√™ncia de foguetes.  Mas apenas o fato de que eles podem ser feitos rapidamente √© especialmente valioso.  Essa √© uma "entrada f√°cil" nos testes de configura√ß√£o e √© importante porque existe uma barreira psicol√≥gica para a escrita desses testes.  E quero mostrar que "voc√™ pode fazer isso": agora fizemos, funcionou bem para n√≥s e, embora ningu√©m tenha morrido, vivemos h√° tr√™s anos. <br><br>  A segunda parte √© sobre o que fazer depois.  Quando voc√™ escreveu muitos testes simples, surge a quest√£o do suporte.  Alguns deles come√ßam a cair, voc√™ entende os erros que eles supostamente destacaram.  Acontece que isso nem sempre √© conveniente.  E surge a quest√£o de escrever testes mais complexos - afinal, voc√™ j√° cobriu casos simples, quero algo mais interessante.  E aqui novamente n√£o h√° pr√°ticas recomendadas, apenas descreverei algumas das solu√ß√µes que funcionaram para n√≥s. <br><br>  A terceira parte √© sobre como o teste pode suportar a refatora√ß√£o de uma configura√ß√£o bastante complexa e confusa.  Novamente estudo de caso - como fizemos.  Do meu ponto de vista, este √© um exemplo de como o teste de configura√ß√£o pode ser escalado para resolver tarefas maiores, e n√£o apenas para corrigir pequenos orif√≠cios. <br><br><h2>  Parte 1. "Voc√™ pode fazer assim" </h2><br>  Agora √© dif√≠cil entender qual foi o primeiro teste de configura√ß√£o conosco.  Andrei est√° sentado no corredor, ele pode dizer que eu menti.  Mas parece-me que tudo come√ßou com isso: <br><br><img src="https://habrastorage.org/webt/6t/dr/d8/6tdrd8-mwyj8otcngbcjsjqi3ge.jpeg"><br><br>  A situa√ß√£o √© a seguinte: temos n servi√ßos no mesmo host, cada um deles eleva seu pr√≥prio servidor JMX em sua porta, exporta alguns JMXs de monitoramento.  Portas para todos os servi√ßos s√£o configuradas no arquivo.  Mas o arquivo ocupa v√°rias p√°ginas e existem muitas outras propriedades - geralmente acontece que as portas de diferentes servi√ßos entram em conflito.  √â f√°cil cometer um erro.  Ent√£o, tudo √© trivial: alguns servi√ßos n√£o aumentam, depois n√£o aumentam para os dependentes - os testadores ficam furiosos. <br><br>  Este problema √© resolvido em v√°rias linhas.  Esse teste, que (me parece) foi o primeiro, ficou assim: <br><br><img src="https://habrastorage.org/webt/ka/ln/51/kaln51onx8-1yzdr2vq0ltcmegq.jpeg"><br><br>  N√£o √© nada complicado: examinamos a pasta onde os arquivos de configura√ß√£o est√£o localizados, carregamos, analisamos como propriedades, filtramos os valores cujo nome cont√©m ‚Äújmx.port‚Äù e verificamos se todos os valores s√£o √∫nicos.  N√£o √© necess√°rio nem mesmo converter valores em n√∫mero inteiro.  Presumivelmente, existem apenas portas. <br><br>  Minha primeira rea√ß√£o quando vi isso foi confusa: <br><br><img src="https://habrastorage.org/webt/ka/ln/51/kaln51onx8-1yzdr2vq0ltcmegq.jpeg"><br><br>  Primeira impress√£o: o que h√° nos meus belos testes de unidade?  Por que entramos no sistema de arquivos? <br><br>  E ent√£o a surpresa veio: "O que poderia ser isso?" <br><br>  Estou falando disso porque parece haver algum tipo de barreira psicol√≥gica que dificulta a realiza√ß√£o de tais testes.  Tr√™s anos se passaram desde ent√£o, o projeto est√° cheio desses testes, mas muitas vezes vejo que meus colegas, encontrando um erro cometido na configura√ß√£o, n√£o escrevem testes nele.  Para o c√≥digo, todo mundo j√° est√° acostumado a escrever testes de regress√£o - para que o erro encontrado n√£o seja mais reproduzido.  Mas eles n√£o fazem isso para configura√ß√£o, algo est√° interferindo.  H√° algum tipo de barreira psicol√≥gica que precisa ser resolvida - √© por isso que menciono uma rea√ß√£o para que voc√™ a reconhe√ßa de si mesma se ela aparecer. <br><br><img src="https://habrastorage.org/webt/ka/ln/51/kaln51onx8-1yzdr2vq0ltcmegq.jpeg"><br><br>  O exemplo a seguir √© quase o mesmo, mas ligeiramente modificado - removi todo o "jmx".  Desta vez, verificamos todas as propriedades chamadas algo-l√°-porta.  Eles devem ser valores inteiros e ser uma porta de rede v√°lida.  O Matcher validNetworkPort () oculta nosso Matcher hamcrest personalizado, que verifica se o valor est√° acima do intervalo de portas do sistema, abaixo do intervalo de portas ef√™meras, bem, sabemos que algumas portas de nossos servidores est√£o pr√©-ocupadas - aqui est√° toda a lista delas tamb√©m est√° oculta isso √© igual. <br><br>  Este teste ainda √© muito primitivo.  Observe que n√£o h√° nenhuma indica√ß√£o sobre qual propriedade espec√≠fica estamos verificando - ela √© massiva.  Um √∫nico teste pode verificar 500 propriedades com o nome "... porta" e verificar se todas elas s√£o n√∫meros inteiros no intervalo desejado, com todas as condi√ß√µes necess√°rias.  Uma vez que eles escreveram, uma d√∫zia de linhas - e √© isso.  Esse √© um recurso muito conveniente, parece que a configura√ß√£o possui um formato simples: duas colunas, uma chave e um valor.  Portanto, pode ser processado em massa. <br><br>  Outro exemplo de teste.  O que estamos verificando aqui? <br><br><img src="https://habrastorage.org/webt/7j/wt/wr/7jwtwr0zn93gy0fhfaqykbeyeyy.jpeg"><br><br>  Ele verifica se as senhas reais n√£o vazam para a produ√ß√£o.  Todas as senhas devem ter algo parecido com isto: <br><br><img src="https://habrastorage.org/webt/yg/4_/ft/yg4_ftjvkm_bhqqzmdxppafoaii.jpeg"><br><br>  Voc√™ pode escrever muitos testes para arquivos de propriedades.  N√£o vou dar mais exemplos - n√£o quero me repetir, a ideia √© muito simples, ent√£o tudo deve ficar claro. <br><br>  ... e depois de escrever o suficiente desses testes, surge uma pergunta interessante: o que queremos dizer com configura√ß√£o, onde est√° sua borda?  Consideramos o arquivo de propriedades como uma configura√ß√£o, cobrimos - e o que mais pode ser coberto no mesmo estilo? <br><br><h2>  O que considerar uma configura√ß√£o </h2><br>  Acontece que existem muitos arquivos de texto no projeto que n√£o s√£o compilados - pelo menos no processo normal de compila√ß√£o.  Eles n√£o s√£o verificados de maneira alguma at√© serem executados no servidor, ou seja, os erros aparecem atrasados.  Todos esses arquivos - com certa extens√£o - podem ser chamados de configura√ß√£o.  Pelo menos, eles ser√£o testados aproximadamente da mesma forma. <br><br>  Por exemplo, temos um sistema de patches SQL que s√£o rolados no banco de dados durante o processo de implanta√ß√£o. <br><br><img src="https://habrastorage.org/webt/jz/bk/c7/jzbkc7m5zo0k6phy-9kuzvkqkam.jpeg"><br><br>  Eles s√£o escritos para o SQL * Plus.  O SQL * Plus √© uma ferramenta dos anos 60 e requer todo tipo de coisas estranhas: por exemplo, para garantir que o final do arquivo esteja em uma nova linha.  Claro, as pessoas regularmente esquecem de colocar o fim da linha l√°, porque n√£o nasceram nos anos 60. <br><br><img src="https://habrastorage.org/webt/nr/oj/3w/nroj3wxkhriqqeqa-iwxwus0a0a.jpeg"><br><br>  E, novamente, √© resolvido pelas mesmas dezenas de linhas: selecionamos todos os arquivos SQL, verificamos se h√° uma barra final no final.  Simples, conveniente, r√°pido. <br><br>  Outro exemplo de "como um arquivo de texto" √© o crontabs.  Nossos servi√ßos crontab come√ßam e param.  Eles costumam causar dois erros: <br><br><img src="https://habrastorage.org/webt/02/i0/ch/02i0chpobgao-lexobckwr5ffd4.jpeg"><br><br>  Primeiro, o formato da express√£o de agendamento.  N√£o √© t√£o complicado, mas ningu√©m o verifica antes do lan√ßamento, por isso √© f√°cil colocar um espa√ßo extra, v√≠rgula e coisas do g√™nero. <br><br>  Em segundo lugar, como no exemplo anterior, o final do arquivo tamb√©m deve estar em uma nova linha. <br><br>  E tudo isso √© muito f√°cil de verificar.  O final do arquivo √© compreens√≠vel, mas para verificar a programa√ß√£o, voc√™ pode encontrar bibliotecas prontas que analisam a express√£o cron.  Antes do relat√≥rio, pesquisei no Google: havia pelo menos seis deles.  Encontrei seis, mas em geral pode haver mais.  Quando escrevemos, pegamos o mais simples dos encontrados, porque n√£o precis√°vamos verificar o conte√∫do da express√£o, mas apenas sua corre√ß√£o sint√°tica, para que o cron a carregasse com √™xito. <br><br>  Em princ√≠pio, voc√™ pode encerrar mais verifica√ß√µes - verifique se inicia no dia certo da semana, se n√£o interrompe os servi√ßos no meio do dia de trabalho.  Mas isso acabou n√£o sendo t√£o √∫til para n√≥s, e n√£o nos incomodamos. <br><br>  Outra id√©ia que funciona muito bem √© o shell scripts.  Obviamente, escrever em Java um analisador completo de scripts bash √© um prazer para os corajosos.  Mas o ponto principal √© que um grande n√∫mero desses scripts n√£o √© uma festa completa.  Sim, existem scripts bash nos quais o c√≥digo √© direto, inferno e inferno, onde eles aparecem uma vez por ano e, jurando, fogem.  Mas muitos scripts bash t√™m as mesmas configura√ß√µes.  H√° v√°rias vari√°veis ‚Äã‚Äãde sistema e vari√°veis ‚Äã‚Äãde ambiente definidas para o valor desejado, configurando outros scripts que usam essas vari√°veis.  E √© f√°cil obter essas vari√°veis ‚Äã‚Äãa partir deste arquivo bash e verificar algo sobre elas. <br><br><img src="https://habrastorage.org/webt/5s/4d/z_/5s4dz_wtejguewyqrat5ipxa7by.jpeg"><br><br>  Por exemplo, verifique se JAVA_HOME est√° instalado em cada ambiente ou se alguma biblioteca jni que usamos est√° localizada em LD_LIBRARY_PATH.  De alguma forma, passamos de uma vers√£o do Java para outra e expandimos o teste: verificamos que JAVA_HOME cont√©m "1,8" naquele mesmo subconjunto de ambiente, que gradualmente transferimos para a nova vers√£o. <br><br>  Aqui est√£o alguns exemplos.  Deixe-me resumir a primeira parte das conclus√µes: <br><br><ul><li>  Testes de configura√ß√£o s√£o confusos no in√≠cio, h√° uma barreira psicol√≥gica.  Mas, ap√≥s super√°-lo, h√° muitos lugares no aplicativo que n√£o s√£o cobertos por cheques e podem ser cobertos. </li><li>  Em seguida, eles s√£o escritos com <b>facilidade e alegria</b> : existem muitas "frutas baixas" que rapidamente oferecem grandes benef√≠cios). </li><li>  Reduza o <b>custo de</b> detec√ß√£o e corre√ß√£o de erros de configura√ß√£o.  Como esses s√£o, de fato, testes de unidade, voc√™ pode execut√°-los no seu computador, mesmo antes de confirmar - isso reduz muito o Feedback Loop.  Muitos deles, √© claro, teriam sido testados no est√°gio de implanta√ß√£o do teste, por exemplo.  E muitos n√£o seriam testados - se esta for uma configura√ß√£o de produ√ß√£o.  E assim eles s√£o verificados diretamente no computador local. </li><li>  Eles d√£o uma segunda juventude.  No sentido de que h√° uma sensa√ß√£o de que voc√™ ainda pode testar muitas coisas interessantes.  De fato, no c√≥digo n√£o √© mais t√£o f√°cil encontrar o que voc√™ pode testar. </li></ul><br><br><h2>  Parte 2. Casos mais complexos </h2><br>  Vamos passar para testes mais complexos.  Depois de cobrir a maioria das verifica√ß√µes triviais, como as mostradas aqui, surge a pergunta: √© poss√≠vel verificar algo mais complicado? <br><br>  O que significa "mais dif√≠cil"?  Os testes que acabei de descrever t√™m aproximadamente a seguinte estrutura: <br><br><img src="https://habrastorage.org/webt/er/an/sx/eransxujnuprewkr1lcrk1nweui.jpeg"><br><br>  Eles verificam algo em rela√ß√£o a um arquivo espec√≠fico.  Ou seja, examinamos os arquivos, aplicamos uma determinada verifica√ß√£o de condi√ß√£o a cada um.  Assim, muito pode ser verificado, mas h√° cen√°rios mais √∫teis: <br><br><ul><li>  O aplicativo de interface do usu√°rio se conecta ao servidor de <b>seu</b> ambiente. </li><li>  Todos os servi√ßos do mesmo ambiente se conectam ao <b>mesmo</b> servidor de gerenciamento. </li><li>  Todos os servi√ßos no mesmo ambiente usam <b>o mesmo</b> banco de dados. </li></ul><br><br>  Por exemplo, um aplicativo de interface do usu√°rio se conecta ao seu servidor de ambiente.  Provavelmente, a interface do usu√°rio e o servidor s√£o m√≥dulos diferentes, se n√£o s√£o projetos, e t√™m configura√ß√µes diferentes; √© improv√°vel que eles usem os mesmos arquivos de configura√ß√£o.  Portanto, voc√™ precisar√° vincul√°-los para que todos os servi√ßos de um ambiente sejam conectados a um servidor de gerenciamento de chaves atrav√©s do qual os comandos s√£o distribu√≠dos.  Novamente, provavelmente, esses s√£o m√≥dulos diferentes, servi√ßos diferentes e equipes geralmente diferentes os desenvolvem. <br><br>  Ou todos os servi√ßos usam o mesmo banco de dados, a mesma coisa - servi√ßos em m√≥dulos diferentes. <br><br>  De fato, existe uma imagem: muitos servi√ßos, cada um deles com sua pr√≥pria estrutura de configura√ß√£o, √© necess√°rio reduzir alguns deles e verificar algo no cruzamento: <br><br><img src="https://habrastorage.org/webt/tw/et/op/twetop-jheecrf02felhlhchnvi.jpeg"><br><br>  Obviamente, voc√™ pode fazer exatamente isso: carregar um, o segundo, retirar algo em algum lugar, colar no c√≥digo de teste.  Mas voc√™ pode imaginar o tamanho do c√≥digo e a legibilidade dele.  Come√ßamos com isso, mas depois percebemos o qu√£o dif√≠cil √©.  Como fazer melhor? <br><br>  Se voc√™ sonha, seria mais conveniente, ent√£o eu sonhei que o teste seria como se eu o explicasse em linguagem humana: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Theory</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">eachEnvironmentIsXXX</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( Environment environment )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( Server server : environment.servers() ) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>( Service service : server.services() ) { Properties config = buildConfigFor( environment, server, service ); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ check {something} about config } } }</span></span></code> </pre> <br>  Para cada ambiente, uma condi√ß√£o √© atendida.  Para verificar isso, voc√™ precisa do ambiente para encontrar uma lista de servidores, uma lista de servi√ßos.  Em seguida, carregue as configura√ß√µes e verifique algo no cruzamento.  Consequentemente, eu preciso disso, chamei de Layout de Implanta√ß√£o. <br><br><img src="https://habrastorage.org/webt/cs/um/3u/csum3u7sucokbnlydgulc18cdhs.jpeg"><br><br>  Precisamos de uma oportunidade do c√≥digo para obter acesso a como o aplicativo √© implantado: em quais servidores, quais servi√ßos s√£o colocados, em qual ambiente - para obter essa estrutura de dados.  E, partindo disso, come√ßo a carregar a configura√ß√£o e a process√°-la. <br><br>  O Layout de implanta√ß√£o √© espec√≠fico para cada equipe e cada projeto.  Eu desenhei - este √© um caso geral: geralmente h√° um conjunto de servidores, servi√ßos, um servi√ßo √†s vezes tem um conjunto de arquivos de configura√ß√£o, e n√£o apenas um.  √Äs vezes, s√£o necess√°rios par√¢metros adicionais √∫teis para testes, que precisam ser adicionados.  Por exemplo, o rack no qual o servidor est√° localizado pode ser importante.  Andrey, em seu relat√≥rio, deu um exemplo de quando era importante para os servi√ßos deles que os servi√ßos de Backup / Prim√°rio devessem estar em racks diferentes - no seu caso, ele precisaria manter uma indica√ß√£o do rack no layout de implanta√ß√£o: <br><br><img src="https://habrastorage.org/webt/gj/oh/ip/gjohipszob-edpgkekfr1zvdfp0.jpeg"><br><br>  Para nossos prop√≥sitos, a regi√£o do servidor √© importante, o data center espec√≠fico, tamb√©m em princ√≠pio, para que o Backup / Primary esteja em diferentes data centers.  Essas s√£o propriedades adicionais do servidor, s√£o espec√≠ficas do projeto, mas no slide √© um denominador comum. <br><br>  Onde obter o layout de implanta√ß√£o?  Parece que em qualquer grande empresa existe um sistema de gerenciamento de infraestrutura, tudo √© descrito l√°, √© confi√°vel, confi√°vel e tudo o mais ... na verdade n√£o. <br><br>  Pelo menos, minha pr√°tica em dois projetos mostrou que √© mais f√°cil codificar primeiro e depois de tr√™s anos ... deixar a pele dura. <br><br>  Vivemos com esse projeto h√° tr√™s anos.  No segundo, ao que parece, ainda nos integramos ao Gerenciamento de infraestrutura em um ano, mas todos esses anos vivemos assim.  Por experi√™ncia, faz sentido adiar a tarefa de integra√ß√£o com o IM, a fim de obter testes prontos o mais r√°pido poss√≠vel, o que mostrar√° que eles funcionam e s√£o √∫teis.  E ent√£o, pode ser que essa integra√ß√£o n√£o seja t√£o necess√°ria, porque a distribui√ß√£o de servi√ßos entre servidores n√£o √© alterada com tanta frequ√™ncia. <br><br>  O hardcode pode literalmente ser assim: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Environment { PROD( PROD_UK_PRIMARY, PROD_UK_BACKUP, PROD_US_PRIMARY, PROD_US_BACKUP, PROD_SG_PRIMARY, PROD_SG_BACKUP ) ‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Server[] servers() {‚Ä¶} } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> Server { PROD_UK_PRIMARY(‚Äúrflx-ldn-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">"), PROD_UK_BACKUP("</span></span>rflx-ldn-<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-string"><span class="hljs-string">"), PROD_US_PRIMARY(‚Äúrflx-nyc-1"</span></span>), PROD_US_BACKUP(<span class="hljs-string"><span class="hljs-string">"rflx-nyc-2"</span></span>), PROD_SG_PRIMARY(‚Äúrflx-sng-<span class="hljs-number"><span class="hljs-number">1</span></span><span class="hljs-string"><span class="hljs-string">"), PROD_SG_BACKUP("</span></span>rflx-sng-<span class="hljs-number"><span class="hljs-number">2</span></span><span class="hljs-string"><span class="hljs-string">"), public Service[] services() {‚Ä¶} }</span></span></code> </pre><br>  A maneira mais f√°cil que usamos em nosso primeiro projeto √© enumerar o Environment com uma lista de servidores em cada um deles.  Existe uma lista de servidores e, ao que parece, deve haver uma lista de servi√ßos, mas enganamos: temos scripts de in√≠cio (que tamb√©m fazem parte da configura√ß√£o). <br><br><img src="https://habrastorage.org/webt/m0/ww/jw/m0wwjwoo1xhqahbdppfbf8q5rno.jpeg"><br><br>  Eles executam servi√ßos para cada ambiente.  E o m√©todo services () simplesmente grep'a todos os servi√ßos do arquivo de seu servidor.  Isso √© feito porque n√£o existem tantos Ambientes e os servidores tamb√©m raramente s√£o adicionados ou exclu√≠dos - mas existem muitos servi√ßos e eles s√£o embaralhados com bastante frequ√™ncia.  Fazia sentido carregar o layout real dos servi√ßos a partir de scripts para n√£o alterar o layout codificado com muita frequ√™ncia. <br><br>  Depois de criar esse modelo de configura√ß√£o de software, b√¥nus agrad√°veis ‚Äã‚Äãaparecem.  Por exemplo, voc√™ pode escrever um teste como este: <br><br><img src="https://habrastorage.org/webt/ht/-o/lk/ht-olkpuql9rl2jhdkpm23yfnlm.jpeg"><br><br>  O teste √© que, em todos os ambientes, todos os principais servi√ßos est√£o presentes.  Suponha que haja quatro servi√ßos principais, e o resto pode ou n√£o ser, mas sem esses quatro n√£o faz sentido.  Voc√™ pode verificar se n√£o os esqueceu em nenhum lugar, se todos eles t√™m backups no mesmo ambiente.  Na maioria das vezes, esses erros ocorrem ao configurar o UAT dessas inst√¢ncias, mas tamb√©m podem vazar para o PROD.  No final, erros no UAT tamb√©m perdem tempo e nervosismo dos testadores. <br><br>  Surge a quest√£o de manter a relev√¢ncia do modelo de configura√ß√£o.  Voc√™ tamb√©m pode escrever um teste para isso. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HardCodedLayoutConsistencyTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Theory</span></span> eachHardCodedEnvironmentHasConfigFiles(Environment env){ ‚Ä¶ } <span class="hljs-meta"><span class="hljs-meta">@Theory</span></span> eachConfigFileHasHardCodedEnvironment(File configFile){ ‚Ä¶ } }</code> </pre><br>  Existem arquivos de configura√ß√£o e um layout de implanta√ß√£o no c√≥digo.  E voc√™ pode verificar isso para cada ambiente / servidor / etc.  existe um arquivo de configura√ß√£o correspondente e para cada arquivo do formato necess√°rio - o ambiente correspondente.  Assim que voc√™ esquecer de adicionar algo a um lugar, o teste ser√° reprovado. <br><br>  A linha inferior √© o layout de implanta√ß√£o: <br><br><ul><li>  Simplifica a grava√ß√£o de testes complexos que re√∫nem configura√ß√µes de diferentes partes do aplicativo. </li><li>  Torna-os mais claros e mais leg√≠veis.  Eles t√™m a apar√™ncia que voc√™ pensa deles em alto n√≠vel, e n√£o a maneira como eles passam pelas configura√ß√µes. </li><li>  Durante a sua cria√ß√£o, quando as pessoas fazem perguntas, h√° muitas coisas interessantes sobre a implanta√ß√£o.  Limita√ß√µes, conhecimento sagrado impl√≠cito, surgem, por exemplo, sobre a possibilidade de hospedar dois ambientes em um servidor.  Acontece que os desenvolvedores pensam de maneira diferente e escrevem seus servi√ßos de acordo.  E esses momentos s√£o √∫teis para se estabelecer entre os desenvolvedores. </li><li>  Bem complementa a documenta√ß√£o (especialmente se n√£o for).  Mesmo se houver, √© mais agrad√°vel para mim, como desenvolvedor, ver isso no c√≥digo.  Al√©m disso, voc√™ pode escrever coment√°rios importantes para mim, e n√£o para outra pessoa.  E voc√™ tamb√©m pode codificar.  Ou seja, se voc√™ decidir que n√£o pode haver dois ambientes no mesmo servidor, poder√° inserir uma verifica√ß√£o e agora n√£o.  Pelo menos voc√™ descobrir√° se algu√©m tentar.  Ou seja, esta √© a documenta√ß√£o com a capacidade de aplic√°-la.  Isso √© muito √∫til. </li></ul><br>  Vamos seguir em frente.  Depois que os testes foram escritos, eles "se estabeleceram" por um ano, alguns come√ßam a cair.  Alguns come√ßam a cair mais cedo, mas n√£o √© t√£o assustador.  √â assustador quando um teste escrito um ano atr√°s cai, voc√™ olha para a mensagem de erro e n√£o entende. <br><img src="https://habrastorage.org/webt/gm/e1/kb/gme1kb6jzdvbvfpfxlxydbxbktw.jpeg"><br><br>  Suponha que eu compreenda e concorde que essa √© uma porta de rede inv√°lida - mas onde ela est√°?  Antes da palestra, observei o fato de termos 1.200 arquivos de propriedades no projeto, espalhados por 90 m√≥dulos, com um total de 24.000 linhas.  (Embora eu tenha ficado surpreso, mas se voc√™ contar, ent√£o este n√£o √© um n√∫mero t√£o grande - para um servi√ßo para 4 arquivos.) Onde fica essa porta? <br><br>  √â claro que assertThat () tem um argumento de mensagem; voc√™ pode inserir algo que ajudar√° a identificar o local.  Mas quando voc√™ escreve um teste, n√£o pensa nisso.  E mesmo que voc√™ pense, ainda precisa adivinhar qual descri√ß√£o ser√° detalhada o suficiente para ser entendida em um ano.  Gostaria de automatizar esse momento, para que haja uma maneira de escrever testes com gera√ß√£o autom√°tica de uma descri√ß√£o mais ou menos clara, pela qual voc√™ pode encontrar um erro. <br><br>  Mais uma vez, eu sonhei e sonhei com algo assim: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> environment, <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>, component, configLocation, propertyName, propertyValue <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> configuration(environment, <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>, component) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> propertyName <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> ‚Äú%.port%‚Äù <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> propertyValue <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> validNetworkPort()</code> </pre><br>  Isso √© t√£o pseudo-SQL - bem, eu apenas conhe√ßo SQL, e o c√©rebro jogou a solu√ß√£o fora do que √© familiar.  A id√©ia √© que a maioria dos testes de configura√ß√£o consiste em v√°rias partes do mesmo tipo.  Primeiro, um subconjunto de par√¢metros √© selecionado pela condi√ß√£o: <br><br><img src="https://habrastorage.org/webt/ig/om/g_/igomg_lacmbr2w7xdnuqtxgrnoc.jpeg"><br><br>  Ent√£o, em rela√ß√£o a esse subconjunto, verificamos algo em rela√ß√£o ao valor: <br><br><img src="https://habrastorage.org/webt/xm/zr/1p/xmzr1p3brb_ixbgiafqteeiltgg.jpeg"><br><br>  E ent√£o, se havia propriedades cujos valores n√£o satisfazem o desejo, esta √© a "planilha" que queremos receber na mensagem de erro: <br><br><img src="https://habrastorage.org/webt/6d/ci/jr/6dcijrp9yesvndnn6hq2udo5fw8.jpeg"><br><br>  Ao mesmo tempo, pensei at√© em escrever um analisador como o SQL, pois agora n√£o √© dif√≠cil.  Mas ent√£o percebi que o IDE n√£o o apoiaria e sugeriria, para que as pessoas tivessem que escrever √†s cegas nesse "SQL" criado por si pr√≥prio, sem avisos do IDE, sem compila√ß√£o, sem verifica√ß√£o - isso n√£o √© muito conveniente.  Portanto, tive que procurar solu√ß√µes suportadas pela nossa linguagem de programa√ß√£o.  Se tiv√©ssemos .NET, o LINQ ajudaria, √© quase como o SQL. <br><br>  N√£o h√° LINQ em Java, o mais pr√≥ximo poss√≠vel dos fluxos.  √â assim que esse teste deve parecer nos fluxos: <br><br><pre> <code class="java hljs">ValueWithContext[] incorrectPorts = flattenedProperties( environment ) .filter( propertyNameContains( <span class="hljs-string"><span class="hljs-string">".port"</span></span> ) ) .filter( !isInteger( propertyValue ) || !isValidNetworkPort( propertyValue ) ) .toArray(); assertThat( incorrectPorts, emptyArray() );</code> </pre><br>  flattenedProperties () pega todas as configura√ß√µes desse ambiente, todos os arquivos para todos os servidores, servi√ßos e os expande para uma tabela grande.  Esta √© essencialmente uma tabela semelhante a SQL, mas na forma de um conjunto de objetos Java.  E flattenedProperties () retorna esse conjunto de strings como um fluxo. <br><br><img src="https://habrastorage.org/webt/8b/ep/jb/8bepjbpkln50gcn1hlgdizwxkxe.jpeg"><br><br>  Em seguida, voc√™ adiciona algumas condi√ß√µes neste conjunto de objetos Java.  Neste exemplo: selecionamos aqueles que cont√™m "port" em propertyName e filtramos aqueles em que os valores n√£o s√£o convertidos em Inteiro ou n√£o no intervalo v√°lido.  Esses s√£o valores errados e, em teoria, deveriam ser um conjunto vazio. <br><br><img src="https://habrastorage.org/webt/4z/8i/db/4z8idb1t_vtoprcjg3f23ct0aeq.jpeg"><br><br>  Se eles n√£o forem um conjunto vazio, lan√ßamos um erro que ser√° parecido com este: <br><br><img src="https://habrastorage.org/webt/ia/wq/wy/iawqwytklkjtldsc-afzmw7-cui.jpeg"><br><br><h2>  Parte 3. Teste como suporte para refatora√ß√£o </h2><br>  Normalmente, o teste de c√≥digo √© um dos mais poderosos recursos de refatora√ß√£o.  A refatora√ß√£o √© um processo perigoso, com muitas refazer e quero garantir que, depois disso, o aplicativo ainda seja vi√°vel.  Uma maneira de garantir isso √© primeiro sobrepor tudo com testes de todos os lados e depois refator√°-lo. <br><br>  E agora, diante de mim, estava a tarefa de refatorar a configura√ß√£o.  H√° um aplicativo que foi escrito h√° sete anos por uma pessoa inteligente.  A configura√ß√£o deste aplicativo √© mais ou menos assim: <br><br><img src="https://habrastorage.org/webt/d4/vc/wz/d4vcwzxtgvecd-be0n51ysi9mho.jpeg"><br><br>  Este √© um exemplo, h√° muitos mais.  Permuta√ß√µes de aninhamento triplo, e isso √© usado em toda a configura√ß√£o: <br><br><img src="https://habrastorage.org/webt/ua/gt/t7/uagtt7xt289h6xfpc0swrmfztca.jpeg"><br><br>  Existem poucos arquivos na pr√≥pria configura√ß√£o, mas eles s√£o inclu√≠dos um no outro.  Ele usa uma pequena extens√£o do iu Properties - Apache Commons Configuration, que suporta apenas inclus√µes e permiss√µes entre chaves. <br><br>  E o autor fez um trabalho fant√°stico usando apenas essas duas coisas.  Acho que ele construiu uma m√°quina de Turing sobre eles.  Em alguns lugares, realmente parece que ele est√° tentando fazer c√°lculos usando inclus√µes e substitui√ß√µes.  N√£o sei se esse sistema de Turing est√° completo, mas ele, na minha opini√£o, tentou provar que √© assim. <br><br>  E o homem foi embora.  Escreveu, o aplicativo funciona e ele saiu do banco.  Tudo funciona, apenas ningu√©m entende completamente a configura√ß√£o. <br><br>  Se tomarmos um servi√ßo separado, ocorrer√£o 10 inclus√µes, para uma profundidade tripla e, no total, se tudo for expandido, 450 par√¢metros.  De fato, esse servi√ßo em particular usa de 10 a 15% deles, o restante dos par√¢metros s√£o para outros servi√ßos, porque os arquivos s√£o compartilhados, eles s√£o usados ‚Äã‚Äãpor v√°rios servi√ßos.  Mas o que exatamente 10-15% usa esse servi√ßo espec√≠fico n√£o √© t√£o f√°cil de entender.  O autor aparentemente entendeu.  Pessoa muito inteligente, muito. <br><br>  A tarefa, respectivamente, era simplificar a configura√ß√£o, sua refatora√ß√£o.  Ao mesmo tempo, eu queria manter o aplicativo funcionando, pois nessa situa√ß√£o as chances s√£o baixas.  Eu quero: <br><br><ul><li>  Simplifique a configura√ß√£o. </li><li>  Para que ap√≥s a refatora√ß√£o, cada servi√ßo ainda tenha todos os par√¢metros necess√°rios. </li><li>  Para que ele n√£o tenha par√¢metros extras.  85% dos que n√£o est√£o relacionados a ele n√£o devem confundir a p√°gina. </li><li>  Esses servi√ßos ainda se conectaram com √™xito em clusters e executaram colabora√ß√£o. </li></ul><br>  O problema √© que n√£o se sabe qu√£o bem eles se conectam agora, porque o sistema √© altamente redundante.  Por exemplo, olhando para o futuro: durante a refatora√ß√£o, descobriu-se que em uma das configura√ß√µes de produ√ß√£o deveria haver quatro servidores no clipe de backup, mas na verdade havia dois.  Devido ao alto n√≠vel de redund√¢ncia, ningu√©m percebeu isso - o erro veio √† tona acidentalmente, mas, na verdade, o n√≠vel de redund√¢ncia ficou por muito tempo abaixo do esperado.  O ponto √© que n√£o podemos confiar no fato de que a configura√ß√£o atual est√° correta em todos os lugares. <br><br>  Eu levo ao fato de que voc√™ n√£o pode simplesmente comparar a nova configura√ß√£o com a antiga.  Pode ser equivalente, mas permanece ao mesmo tempo em algum lugar errado.  √â necess√°rio verificar o conte√∫do l√≥gico. <br><br>  Programa m√≠nimo: isole cada par√¢metro separado de cada servi√ßo necess√°rio e verifique se a porta √© uma porta, o endere√ßo √© um endere√ßo, o TTL √© um n√∫mero positivo etc.  E verifique os principais relacionamentos aos quais os servi√ßos se conectam basicamente nos principais pontos finais.  Eu queria conseguir isso, pelo menos.  Ou seja, diferente dos exemplos anteriores, a tarefa aqui n√£o √© verificar par√¢metros individuais, mas cobrir toda a configura√ß√£o com uma rede completa de verifica√ß√µes. <br><br>  Como test√°-lo? <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleComponent</span></span></span><span class="hljs-class"> </span></span>{ ‚Ä¶ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Configuration conf )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port = conf.getInt( <span class="hljs-string"><span class="hljs-string">"Port"</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( port &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationException(); String ip = conf.getString( <span class="hljs-string"><span class="hljs-string">"Address"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( ip == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ConfigurationException(); ‚Ä¶ } ‚Ä¶ }</code> </pre><br>  Como eu resolvi esse problema?  H√° algum componente simples, no exemplo, √© simplificado ao m√°ximo.  (Para aqueles que n√£o se depararam com o Apache Commons Configuration: o objeto Configuration √© como Properties, apenas ele ainda possui os m√©todos digitados getInt (), getLong (), etc .; podemos assumir que esses s√£o juProperties em pequenos ester√≥ides.) Suponha que um componente precise de dois par√¢metros: por exemplo, um endere√ßo TCP e uma porta TCP.  N√≥s os retiramos e verificamos.  Quais s√£o as quatro partes comuns aqui? <br><br><img src="https://habrastorage.org/webt/ou/s0/0k/ous00k4owrh8kqvf20fqqpzrfg0.jpeg"><br><br>  Este √© o nome do par√¢metro, tipo, valores padr√£o (aqui s√£o triviais: nulo e -1, √†s vezes h√° valores s√£os) e algumas valida√ß√µes.  A porta aqui √© validada de maneira muito simples e incompleta - voc√™ pode especificar a porta que passar√° por ela, mas n√£o ser√° uma porta de rede v√°lida.  Portanto, eu gostaria de melhorar esse momento tamb√©m.  Mas antes de tudo, quero transformar essas quatro coisas em uma coisa.  Por exemplo, isto: <br><br><pre> <code class="java hljs">IProperty&lt;Integer&gt; PORT_PROPERTY = intProperty( <span class="hljs-string"><span class="hljs-string">"Port"</span></span> ) .withDefaultValue( -<span class="hljs-number"><span class="hljs-number">1</span></span> ) .matchedWith( validNetworkPort() ); IProperty&lt;String&gt; ADDRESS_PROPERTY = stringProperty( <span class="hljs-string"><span class="hljs-string">"Address"</span></span> ) .withDefaultValue( <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ) .matchedWith( validIPAddress() );</code> </pre><br>  Esse objeto composto √© uma descri√ß√£o de uma propriedade que sabe seu nome, valor padr√£o, pode validar (aqui eu uso o correspondente de hamcrest novamente).  E este objeto tem algo como esta interface: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IProperty</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/* (name, defaultValue, matcher‚Ä¶) */</span></span> <span class="hljs-comment"><span class="hljs-comment">/** lookup (or use default), * convert type, * validate value against matcher */</span></span> <span class="hljs-function"><span class="hljs-function">FetchedValue&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fetch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Configuration config )</span></span></span><span class="hljs-function"> } class FetchedValue&lt;T&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String propertyName; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> T propertyValue; ‚Ä¶ }</code> </pre><br>  Ou seja, depois de criar um objeto espec√≠fico para uma implementa√ß√£o espec√≠fica, voc√™ pode solicitar que ele extraia o par√¢metro que ele representa da configura√ß√£o.  E ele retirar√° esse par√¢metro, verificar√° o processo; se n√£o houver par√¢metro, ele fornecer√° um valor padr√£o, direcionar√° para o tipo desejado e retornar√° imediatamente com o nome. <br><br>  Ou seja, aqui est√° o nome do par√¢metro e um valor real que o servi√ßo ver√° se solicita dessa configura√ß√£o.  Isso permite que voc√™ agrupe v√°rias linhas de c√≥digo em uma entidade; esta √© a primeira simplifica√ß√£o que precisarei. <br><br>  A segunda simplifica√ß√£o necess√°ria para solucionar o problema foi a introdu√ß√£o de um componente que precisa de v√°rias propriedades para sua configura√ß√£o.  Modelo de configura√ß√£o de componentes: <br><br><img src="https://habrastorage.org/webt/gf/rr/ku/gfrrkugkjdimk8kcunvu4vijrsu.jpeg"><br><br>  Tivemos um componente usando essas duas propriedades, existe um modelo para sua configura√ß√£o - a interface IConfigurationModel, que essa classe implementa.  IConfigurationModel faz tudo o que o componente faz, mas apenas a parte relacionada √† configura√ß√£o.  Se o componente precisar de par√¢metros em uma determinada ordem com certos valores padr√£o - IConfigurationModel combina essas informa√ß√µes em si, o encapsula.  Todas as outras a√ß√µes do componente n√£o s√£o importantes para ele.  Este √© um modelo de componente em termos de acesso √† configura√ß√£o. <br><br><img src="https://habrastorage.org/webt/1v/-b/0d/1v-b0dpycb6qscw_n5sul8tbzec.jpeg"><br><br>  O truque dessa vis√£o √© que os modelos s√£o combin√°veis.  Se houver um componente que use outros componentes e eles forem combinados, da mesma maneira, o modelo desse componente complexo poder√° mesclar os resultados das chamadas de dois subcomponentes. <br><br>  Ou seja, √© poss√≠vel construir uma hierarquia de modelos de configura√ß√£o paralela √† hierarquia dos pr√≥prios componentes.  No modelo superior, chame fetch (), que retornar√° a planilha dos par√¢metros que ele extraiu da configura√ß√£o com seus nomes - exatamente aqueles que o componente correspondente precisar√° em tempo real.  Se escrevemos todos os modelos corretamente, √© claro. <br><br>  Ou seja, a tarefa √© escrever esses modelos para cada componente no aplicativo que tem acesso √† configura√ß√£o.  No meu aplicativo, havia alguns desses componentes: o aplicativo em si √© bastante frondoso, mas reutiliza ativamente o c√≥digo, para que apenas 70 classes principais sejam configuradas.  Para eles, eu tive que escrever 70 modelos. <br><br>  Quanto custa: <br><br><ul><li>  12 servi√ßos </li><li>  70 classes configur√°veis </li><li>  =&gt; 70 modelos de configura√ß√£o (~ 60 s√£o triviais); </li><li>  Semanas de 1-2 pessoas. </li></ul><br>  Simplesmente abri a tela com o c√≥digo do componente que se configura e, na tela seguinte, escrevi o c√≥digo para o ConfigurationModel correspondente.  A maioria deles √© trivial, como o exemplo mostrado.  Em alguns casos, existem ramifica√ß√µes e transi√ß√µes condicionais - a√≠ o c√≥digo se torna mais ramificado, mas tudo tamb√©m √© resolvido.  Em uma hora e meia a duas semanas, resolvi esse problema; para todos os 70 componentes, descrevi os modelos. <br><br>  Como resultado, quando reunimos tudo, obtemos o seguinte c√≥digo: <br><br><img src="https://habrastorage.org/webt/dq/ab/vf/dqabvfz99qwfnortpempmtvaalm.jpeg"><br><br>  Para cada servi√ßo / ambiente / etc.  pegamos o modelo de configura√ß√£o, ou seja, o n√≥ superior desta √°rvore e pedimos para obter tudo da configura√ß√£o.  Nesse ponto, todas as valida√ß√µes passam para dentro, cada uma das propriedades, quando sai da configura√ß√£o, verifica seu valor quanto √† exatid√£o.  Se pelo menos um n√£o for aprovado, uma exce√ß√£o ser√° exibida.  Todo o c√≥digo √© obtido verificando se todos os valores s√£o v√°lidos isoladamente. <br><br><h2>  Interdepend√™ncias de Servi√ßo </h2><br>  Ainda t√≠nhamos uma pergunta sobre como verificar a interdepend√™ncia dos servi√ßos.  Isso √© um pouco mais complicado, voc√™ precisa observar que tipo de interdepend√™ncia existe.  Descobri que as interdepend√™ncias se resumem ao fato de que os servi√ßos devem "atender" nos pontos de extremidade da rede.  O servi√ßo A deve ouvir exatamente o endere√ßo para o qual o servi√ßo B envia pacotes e vice-versa.  No meu exemplo, todas as depend√™ncias entre as configura√ß√µes de diferentes servi√ßos se resumiram a isso.  Foi poss√≠vel resolver esse problema de maneira simples: obtenha portas e endere√ßos de diferentes servi√ßos e verifique-os.  Haveria muitos testes, eles seriam volumosos.  Sou uma pessoa pregui√ßosa e n√£o queria isso.  Portanto, eu fiz o contr√°rio. <br><br>  Em primeiro lugar, eu queria abstrair de alguma forma esse ponto de extremidade da rede.  Por exemplo, para uma conex√£o TCP, voc√™ precisa de apenas dois par√¢metros: endere√ßo e porta.  Para uma conex√£o multicast, quatro par√¢metros.  Eu gostaria de colaps√°-lo em algum tipo de objeto.  Fiz isso no objeto Endpoint, que oculta tudo o que voc√™ precisa.  O slide √© um exemplo de OutcomingTCPEndpoint, uma conex√£o de rede TCP de sa√≠da. <br><br><pre> <code class="java hljs">IProperty&lt;IEndpoint&gt; TCP_REQUEST = outcomingTCP( <span class="hljs-comment"><span class="hljs-comment">// (+matchers, +default values) ‚ÄúTCP.Request.Address‚Äù, ‚ÄúTCP.Request.Port¬ª ); class OutcomingTCPEndpoint implements IEndpoint { //(localInterface, localAddress, multicastGroup, port) @Override boolean matches( IEndpoint other); }</span></span></code> </pre><br>    Endpoint    matches(),      Endpoint,  ,           . <br><br>  ¬´ ¬ª?     ,    : , ,  -   ,          ‚Äî        .   ,     ,  /  . ,  ,          . <br><br> ,    , ---,     ,  Endpoint.    ConfigurationModels    ‚Äî  , .    ?        : <br><br><pre> <code class="java hljs">ValueWithContext[] allEndpoints = flattenedConfigurationValues(environment) .filter( valueIsEndpoint() ) .toArray(); ValueWithContext[] unpairedEndpoints = Arrays.stream( allEndpoints ) .filter( e -&gt; !hasMatchedEndpoint(e, allEndpoints) ) .toArray(); assertThat( unpairedEndpoints, emptyArray() );</code> </pre><br>      environment'  endpoint',    ,   ,      ,     .          .     ¬´  ¬ª  O(n^2),     ,   endpoint'  ,    . <br><br>      Endpoint      ,   ,    .     ,        ,  -     . <br><br> ,  ,     ,   ¬´¬ª ‚Äî     ,   .      .  ,          ,       .  ,       . <br><br>      .   , ,   .        , ,      ,   c,  ,        . <br><br>    ConfigurationModel : <br><br><ul><li>     </li><li>     (‚Äú udp-,     ‚Äù) </li><li>        . </li></ul><br>          ,       .         ,     ,   ,    ‚Äî   .    :          ,      .        ,      ,      ,     ,  . <br><br>   .    ,   ConfigurationModels,      .      ,   UDP-      ,    ,   . <br><br>  ,      endpoints      ,   .dot.      .     ‚Äî      . <br><br>    .  Conclus√µes: <br><br><ul><li>   ,   ,   ‚Äî    . </li><li>     ,     .    ,     . </li><li>    ,    ,     ,       . </li></ul><br><blockquote>     Heisenbug 2018 Piter ,  : <b>6-7   </b>   <b>Heisenbug</b> .  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="> </a>      .   1     ‚Äî        . </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt427487/">https://habr.com/ru/post/pt427487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt427477/index.html">Estamos preparando clustering hier√°rquico ou como identifiquei especializa√ß√µes no curr√≠culo</a></li>
<li><a href="../pt427479/index.html">O uso de dados do usu√°rio e a venda de big data propostos para legitimar</a></li>
<li><a href="../pt427481/index.html">Caracter√≠sticas da constru√ß√£o de uma rede Wi-Fi na produ√ß√£o inovadora de alimentos</a></li>
<li><a href="../pt427483/index.html">Escola de Intelig√™ncia Artificial no Distrito Bin√°rio</a></li>
<li><a href="../pt427485/index.html">O problema com o Windows n√£o √© a taxa de atualiza√ß√£o, mas o processo de desenvolvimento</a></li>
<li><a href="../pt427489/index.html">HomeData: como a an√°lise de dados √© usada em arquitetura e urbanismo</a></li>
<li><a href="../pt427491/index.html">vDud em ingl√™s: 7 entrevistadores ocidentais, dos quais todos d√£o um exemplo</a></li>
<li><a href="../pt427493/index.html">Amplificadores de classes de baixa frequ√™ncia: A, B, AB, D, G, H</a></li>
<li><a href="../pt427495/index.html">Quanto custa as instru√ß√µes da Habr + como descobrir quanto outras empresas ganham</a></li>
<li><a href="../pt427499/index.html">Sobre o que eles escrevem no suporte t√©cnico da serpentina de v√≠deo?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>