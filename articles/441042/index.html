<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèø üöî üò™ Generando √≠conos multiplataforma de m√∫ltiples marcas con Sketch y un script Node.js - Parte # 2 üë®üèΩ‚Äç‚öñÔ∏è ‚òéÔ∏è üóëÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Esta es la segunda parte de una publicaci√≥n sobre la creaci√≥n de una tuber√≠a que puede tomar un archivo de boceto y exportar todos los √≠conos incluido...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Generando √≠conos multiplataforma de m√∫ltiples marcas con Sketch y un script Node.js - Parte # 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/badoo/blog/441042/"><img src="https://habrastorage.org/webt/na/kj/v5/nakjv5srowi99bsjteoqabwtoz8.png"><br><br>  Esta es la segunda parte de una publicaci√≥n sobre la creaci√≥n de una tuber√≠a que puede tomar un archivo de boceto y exportar todos los √≠conos incluidos en el archivo, en diferentes formatos, para diferentes plataformas, con la posibilidad de que AB pruebe cada √≠cono. <br><br>  Puedes leer la primera parte de la publicaci√≥n <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><img src="https://habrastorage.org/webt/s6/lt/2d/s6lt2dttycpvlqbolmyeyacaeas.png"><br><br>  Los archivos de Sketch, con todos los √≠conos recopilados, con estilo y con el nombre apropiado, estaban listos.  Ahora era el momento de comenzar a escribir el c√≥digo. <br><br>  Basta decir que el proceso fue en gran medida una prueba y error: despu√©s del importante n√∫cleo de c√≥digo inicial, desarrollado por el l√≠der de mi equipo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nikhil Verma</a> (quien estableci√≥ los fundamentos del gui√≥n), pas√© por un proceso incremental que requiri√≥ al menos tres fases de refactorizaci√≥n y bastantes revisiones.  Por esta raz√≥n, no entrar√© en demasiados detalles sobre c√≥mo se desarroll√≥ el script, sino que me centrar√© en c√≥mo funciona el script hoy, en su forma final. <br><a name="habracut"></a><br><h2>  El script de compilaci√≥n </h2><br>  El script de compilaci√≥n, escrito en Node.js, es relativamente sencillo en su flujo: una vez importadas las dependencias, declar√≥ la lista de archivos de Sketch para procesar (como una lista de marcas y para cada marca una lista de archivos para esa marca) y comprob√≥ que Sketch est√° instalado en el cliente, el script se repite en el conjunto de marcas y para cada una de ellas ejecuta estos pasos en secuencia: <br><br><ol><li>  Obtenga los tokens de dise√±o para la marca (necesitamos los valores de color) </li><li>  Clone los archivos Sketch asociados con la marca, descompr√≠malos para exponer los archivos JSON internos y manipule algunos de los valores internos de estos archivos JSON (m√°s sobre esto m√°s adelante) </li><li>  Lea los metadatos relevantes de los archivos de Sketch JSON ( <i>document.json</i> , <i>meta.json</i> y <i>pages / pageUniqueID.json</i> );  en particular, necesitamos la lista de estilos compartidos y la lista de activos / iconos contenidos en los archivos </li><li>  Despu√©s de algunas manipulaciones adicionales de los archivos Sketch JSON, vuelva a comprimirlos y, utilizando los archivos Sketch (clonados y actualizados), exporte y genere los archivos de salida finales para las tres plataformas (iOS, Android, Mobile Web) </li></ol><br>  Puede ver las partes relevantes del script de compilaci√≥n principal aqu√≠: <br><br><pre><code class="plaintext hljs">// ... modules imports here const SKETCH_FILES = { badoo: ['icons_common'], blendr: ['icons_common', 'icons_blendr'], fiesta: ['icons_common', 'icons_fiesta'], hotornot: ['icons_common', 'icons_hotornot'], }; const SKETCH_FOLDER_PATH = path.resolve(__dirname, '../src/'); const SKETCH_TEMP_PATH = path.resolve(SKETCH_FOLDER_PATH, 'tmp'); const DESTINATION_PATH = path.resolve(__dirname, '../dist'); console.log('Build started...'); if (sketchtool.check()) { console.log(`Processing Sketch file via ${sketchtool.version()}`); build(); } else { console.info('You need Sketch installed to run this script'); process.exit(1); } // ---------------------------------------- function build() { // be sure to start with a blank slate del.sync([SKETCH_TEMP_PATH, DESTINATION_PATH]); // process all the brands declared in the list of Sketch files Object.keys(SKETCH_FILES).forEach(async (brand) =&gt; { // get the design tokens for the brand const brandTokens = getDesignTokens(brand); // prepare the Sketch files (unzipped) and get a list of them const sketchUnzipFolders = await prepareSketchFiles({ brand, sketchFileNames: SKETCH_FILES[brand], sketchFolder: SKETCH_FOLDER_PATH, sketchTempFolder: SKETCH_TEMP_PATH }); // get the Sketch metadata const sketchMetadata = getSketchMetadata(sketchUnzipFolders); const sketchDataSharedStyles = sketchMetadata.sharedStyles; const sketchDataAssets = sketchMetadata.assetsMetadata; generateAssetsPDF({ platform: 'ios', brand, brandTokens, sketchDataSharedStyles, sketchDataAssets }); generateAssetsSVGDynamicMobileWeb({ platform: 'mw', brand, brandTokens, sketchDataSharedStyles, sketchDataAssets }); generateAssetsVectorDrawableDynamicAndroid({ platform: 'android', brand, brandTokens, sketchDataSharedStyles, sketchDataAssets }); }); }</code> </pre> <br>  En realidad, todo el c√≥digo de canalizaci√≥n es mucho m√°s complejo que esto, y la complejidad radica en las <b>funciones prepareSketchFiles</b> , <b>getSketchMetadata</b> y <b>generateAssets [formato] [plataforma]</b> .  Tratar√© de explicarlos con m√°s detalle a continuaci√≥n. <br><br><h2>  Preparando los archivos de croquis </h2><br>  El primer paso en el proceso de compilaci√≥n es la preparaci√≥n de los archivos de Sketch, de modo que puedan usarse m√°s tarde para la exportaci√≥n de los activos para las diferentes plataformas. <br><br>  Los archivos asociados con la marca, por ejemplo, para <i>Blendr</i> , los archivos <i>icons_common.sketch</i> y <i>icons_blendr.sketch</i> , se clonan inicialmente en una carpeta temporal (m√°s precisamente, en una subcarpeta con el nombre de la marca que se est√° procesando) y se descomprimen. <br><br>  Luego, se procesan los archivos JSON internos, a un prefijo agregado a los activos que se someter√°n a pruebas AB, de modo que cuando se exporten, se guardar√°n en una subcarpeta con un nombre predefinido (el nombre √∫nico del experimento).  Para comprender qu√© activos se deben probar, simplemente verificamos si el nombre de la p√°gina en la que est√°n almacenados en Sketch tiene el prefijo <i>"XP_"</i> . <br><br><img src="https://habrastorage.org/webt/k7/qo/df/k7qodfiyytkacnk1uknx_6gxhzw.png"><br>  <i>Una comparaci√≥n de los nombres de las capas, dentro de los archivos de Sketch, antes y despu√©s de la actualizaci√≥n.</i> <br><br>  En el ejemplo anterior, cuando se exportan los activos se guardar√°n en la subcarpeta <i>"this__is_an_experiment"</i> , con un nombre de archivo <i>"icon-name [variant-name] .ext"</i> . <br><br><h2>  Leer los metadatos del boceto </h2><br>  El segundo paso importante en el proceso es sacar todos los metadatos relevantes de los archivos de Sketch, en particular de sus archivos JSON internos.  Como se explic√≥ anteriormente, estos archivos son los dos archivos principales ( <i>document.json</i> y <i>meta.json</i> ) y los archivos de <i>p√°ginas</i> ( <i>pages / pageUniqueId.json</i> ). <br><br>  El <i>archivo document.json</i> se usa para obtener la lista de los estilos compartidos, que aparecen debajo de la propiedad de objeto <i>layerStyles</i> : <br><br><pre> <code class="plaintext hljs">{ "_class": "document", "do_objectID": "45D2DA82-B3F4-49D1-A886-9530678D71DC", "colorSpace": 1, ... "layerStyles": { "_class": "sharedStyleContainer", "objects": [ { "_class": "sharedStyle", "do_objectID": "9BC39AAD-CDE6-4698-8EA5-689C3C942DB4", "name": "features/feature-like", "value": { "_class": "style", "fills": [ { "_class": "fill", "isEnabled": true, "color": { "_class": "color", "alpha": 1, "blue": 0.10588235408067703, "green": 0.4000000059604645, "red": 1 }, "fillType": 0, "noiseIndex": 0, "noiseIntensity": 0, "patternFillType": 1, "patternTileScale": 1 } ], "blur": {...}, "startMarkerType": 0, "endMarkerType": 0, "miterLimit": 10, "windingRule": 1 } }, ...</code> </pre> <br>  Para cada estilo, almacenamos informaci√≥n b√°sica en un objeto clave-valor.  Esto se usar√° m√°s adelante cuando necesitemos recuperar el nombre de un estilo basado en su ID √∫nica (en Sketch, la propiedad <i>do_objectID</i> ): <br><br><pre> <code class="plaintext hljs">const parsedSharedStyles = {}; parsedDocument.layerStyles.objects.forEach((object) =&gt; { parsedSharedStyles[object.do_objectID] = { name: object.name, isFill: _.get(object, 'value.fills[0].color') !== undefined, isBorder: _.get(object, 'value.borders[0].color') !== undefined, }; });</code> </pre> <br><br>  En este punto, nos movemos en el archivo <i>meta.json</i> para obtener la lista de p√°ginas, en particular necesitamos su <i>id</i> y <i>nombre</i> <i>√∫nicos</i> : <br><br><pre> <code class="plaintext hljs">{ "commit": "623a23f2c4848acdbb1a38c2689e571eb73eb823", "pagesAndArtboards": { "EE6BE8D9-9FAD-4976-B0D8-AB33D2B5DBB7": { "name": "Icons", "artboards": { "3275987C-CE1B-4369-B789-06366EDA4C98": { "name": "badge-feature-like" }, "C6992142-8439-45E7-A346-FC35FA01440F": { "name": "badge-feature-crush" }, ... "7F58A1C4-D624-40E3-A8C6-6AF15FD0C32D": { "name": "tabbar-livestream" } ... } }, "ACF82F4E-4B92-4BE1-A31C-DDEB2E54D761": { "name": "XP_this__is_an_experiment", "artboards": { "31A812E8-D960-499F-A10F-C2006DDAEB65": { "name": "this__is_an_experiment/tabbar-livestream[variant1]" }, "20F03053-ED77-486B-9770-32E6BA73A0B8": { "name": "this__is_an_experiment/tabbar-livestream[variant2]" }, "801E65A4-3CC6-411B-B097-B1DBD33EC6CC": { "name": "this__is_an_experiment/tabbar-livestream[control]" } } },</code> </pre> <br>  Luego, para cada p√°gina leemos el archivo JSON correspondiente debajo de la carpeta de <i>p√°ginas</i> (como ya se dijo, el nombre de archivo es <i>[pageUniqueId] .json</i> ), y revisamos los activos contenidos en esa p√°gina (aparecen como capas).  De esta manera, para cada icono obtenemos su nombre, su ancho / alto, los metadatos de Sketch para ese icono de capa, y si est√° en una p√°gina de experimento, el nombre de la prueba AB en cuesti√≥n y el nombre de la variante para ese √≠cono. <br><br>  <i>Aviso</i> : el objeto "page.json" es muy complejo, por lo que no voy a entrar aqu√≠.  Si tiene curiosidad y quiere ver c√≥mo se ve, le sugiero que cree un nuevo archivo Sketch en blanco, agregue alg√∫n contenido y gu√°rdelo;  luego cambie el nombre de su extensi√≥n en zip, descompr√≠malo y busque uno de los archivos que aparecen en la carpeta "p√°ginas". <br><br>  Mientras procesamos las mesas de trabajo, tambi√©n creamos una lista de experimentos (con sus activos correspondientes) que se utilizar√°n m√°s adelante para determinar qu√© opciones de icono se usan y para qu√© experimento, asociando el nombre de las opciones de icono al objeto "base de icono". <br><br>  Para cada archivo de boceto que se procesa asociado con la marca, producimos un objeto de <i>metadatos de activos</i> que se ve as√≠: <br><br><pre> <code class="plaintext hljs">{ "navigation-bar-edit": { "do_objectID": "86321895-37CE-4B3B-9AA6-6838BEDB0977", ...sketch_artboard_properties, "name": "navigation-bar-edit", "assetname": "navigation-bar-edit", "source": "icons_common", "width": 48, "height": 48 "layers": [ { "do_objectID": "A15FA03C-DEA6-4732-9F85-CA0412A57DF4", "name": "Path", ...sketch_layer_properties, "sharedStyleID": "6A3C0FEE-C8A3-4629-AC48-4FC6005796F5", "style": { ... "fills": [ { "_class": "fill", "isEnabled": true, "color": { "_class": "color", "alpha": 1, "blue": 0.8784313725490196, "green": 0.8784313725490196, "red": 0.8784313725490196 }, } ], "miterLimit": 10, "startMarkerType": 0, "windingRule": 1 }, }, ], ... }, "experiment-name/navigation-bar-edit[variant]": { "do_objectID": "00C0A829-D8ED-4E62-8346-E7EFBC04A7C7", ...sketch_artboard_properties, "name": "experiment-name/navigation-bar-edit[variant]", "assetname": "navigation-bar-edit", "source": "icons_common", "width": 48, "height": 48 ...</code> </pre> <br>  Como puede ver, el mismo "icono" (en este caso <i>, barra de navegaci√≥n-edici√≥n</i> ) puede tener m√∫ltiples "activos" asociados, en t√©rminos de experimentos.  Pero el mismo √≠cono puede aparecer con el mismo nombre en un segundo archivo de boceto asociado con la marca, y esto es muy √∫til: es el truco que hemos usado para compilar un conjunto com√∫n de √≠conos y luego definir diferentes variantes de √≠conos espec√≠ficos dependiendo de marca <br><br>  Es por eso que declaramos los archivos de Sketch asociados con cada marca en particular como una matriz: <br><br><pre> <code class="plaintext hljs">const SKETCH_FILES = { badoo: ['icons_common'], blendr: ['icons_common', 'icons_blendr'], fiesta: ['icons_common', 'icons_fiesta'], hotornot: ['icons_common', 'icons_hotornot'], };</code> </pre> <br>  Porque en este caso el orden importa.  Y, de hecho, en la funci√≥n <i>getSketchMetadata</i> , llamada por el script de compilaci√≥n, no devolvemos los objetos <i>assetsMetadata</i> (uno por archivo) como una lista, sino que hacemos una fusi√≥n profunda de cada objeto, uno en el otro, y luego devuelve un √∫nico objeto <i>activoMetadata</i> combinado. <br><br>  Esto no es m√°s que la fusi√≥n "l√≥gica" de los archivos de Sketch, y sus activos, en un solo archivo.  Pero la l√≥gica no es tan simple como parece.  Aqu√≠ est√° el esquema que tuvimos que crear para descubrir qu√© sucede cuando hay √≠conos con el mismo nombre (posiblemente bajo pruebas AB) en diferentes archivos asociados con la misma marca: <br><br><img src="https://habrastorage.org/webt/yg/ug/-6/ygug-6xnds3cvysntithaenmbfw.png"><br>  <i>El esquema l√≥gico de c√≥mo funciona la "anulaci√≥n" del mismo √≠cono, entre un conjunto com√∫n / compartido de √≠conos e √≠conos dise√±ados espec√≠ficamente para etiquetas blancas (tambi√©n considerando el caso de las pruebas AB)</i> <br><br><h2>  Generando los archivos finales en diferentes formatos para diferentes plataformas </h2><br>  El √∫ltimo paso del proceso es la generaci√≥n real de los archivos de iconos con diferentes formatos para las diferentes plataformas (PDF para iOS, SVG / JSX para Web y VectorDrawable para Android). <br><br>  Como puede ver en la cantidad de par√°metros pasados ‚Äã‚Äãa las funciones <i>generateAssets [formato] [plataforma]</i> esta es la parte m√°s compleja de la tuber√≠a.  Aqu√≠ es donde <b>el proceso comienza a dividirse y divergir</b> para las diferentes plataformas.  Vea a continuaci√≥n el flujo l√≥gico completo del script y c√≥mo la parte relacionada con la generaci√≥n de los activos se <b>divide en tres flujos similares pero no id√©nticos:</b> <br><br> <a href=""><img src="https://habrastorage.org/webt/jv/83/xy/jv83xyzcpvzmn4snh0xakkrfu8k.png"></a> <br><br>  Para generar los activos finales con los colores correctos asociados con la marca que se est√° procesando, necesitamos hacer otro conjunto de manipulaciones en los archivos Sketch JSON: iteramos iterativamente sobre cada capa que tiene un estilo compartido aplicado, y reemplazamos el valores de color con los colores de las fichas de dise√±o de la marca. <br><br>  Para la generaci√≥n de Android, se requiere una manipulaci√≥n adicional (m√°s sobre esto m√°s adelante): cambiamos la propiedad de regla de relleno de cada capa de <i>par</i> a <i>impar</i> a <i>distinto de cero</i> (esto est√° controlado por la propiedad "windingRule" en el objeto JSON, donde " 1 "significa" par-impar "y" 0 "significa" distinto de cero "). <br><br>  Una vez completadas estas manipulaciones, comprimimos los archivos de Sketch JSON nuevamente en un archivo de Sketch est√°ndar, de modo que pueda procesarse para exportar los activos con las propiedades actualizadas (los archivos clonados y actualizados son archivos de Sketch absolutamente normales: se pueden abrir en Sketch , visto, editado, guardado, etc.). <br><br>  En este punto, podemos usar sketchtool ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en un contenedor de nodo</a> ) para exportar autom√°ticamente todos los activos en formatos espec√≠ficos para plataformas espec√≠ficas.  Para cada archivo asociado con una marca (m√°s correctamente, su versi√≥n clonada y actualizada) ejecutamos este comando: <br><br><pre> <code class="plaintext hljs">sketchtool.run(`export slices ${cloneSketchFile} --formats=svg &lt;i&gt;--scales=1 &lt;/i&gt;--output=${destinationFolder} --overwriting`);</code> </pre> <br>  Como puede suponer, este comando exporta los activos en un formato espec√≠fico, aplicando una escala opcional (por ahora siempre mantenemos la escala original), en una carpeta de destino.  La opci√≥n de <i>sobrescritura</i> es clave aqu√≠: de la misma manera que hacemos una "fusi√≥n profunda" de los objetos de metadatos de activos (que equivale a una "fusi√≥n l√≥gica" de los archivos de Sketch), cuando exportamos lo hacemos desde m√∫ltiples archivos a la misma carpeta (√∫nica por marca / plataforma).  Esto significa que si un activo, identificado por su nombre de capa, ya exist√≠a en un archivo Sketch anterior, se sobrescribir√° en la siguiente exportaci√≥n.  Lo cual, de nuevo, no es m√°s que una operaci√≥n de "fusi√≥n". <br><br>  Sin embargo, en este caso, podemos tener algunos activos que son "fantasmas".  Esto sucede cuando un icono se prueba con AB en un archivo, pero se sobrescribe en un archivo posterior.  En tales casos, los archivos de variantes se exportan a la carpeta de destino, a los que se hace referencia en el objeto <i>assetsMetadata</i> como activo (con su clave y propiedades), pero no se asocian a ning√∫n activo "base" (debido a la fusi√≥n profunda de los objetos <i>activosMetadata</i> ).  Estos archivos se eliminar√°n en un paso posterior, antes de completar el proceso. <br><br><hr><br>  Como se mencion√≥ anteriormente, necesitamos diferentes formatos finales para diferentes plataformas.  Para iOS queremos archivos PDF, y podemos exportarlos directamente con el comando <i>sketchtool</i> .  Mientras, para Mobile Web queremos archivos JSX, y para Android queremos archivos VectorDrawable;  Por esta raz√≥n, exportamos los activos en formato SVG a una carpeta intermedia y luego los sometemos a un procesamiento adicional. <br><br><h2>  Archivos PDF para iOS </h2><br>  Curiosamente, PDF es el formato (¬øsolo?) Compatible con Xcode y OS / iOS para importar y representar activos vectoriales ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠ hay una breve explicaci√≥n</a> de las razones t√©cnicas detr√°s de esta elecci√≥n de Apple). <br><br>  Como podemos exportar directamente en PDF a trav√©s de Sketchtool, no hay necesidad de pasos adicionales para esta plataforma: simplemente guardamos los archivos directamente en la carpeta de destino, y eso es todo. <br><br><h2>  Reaccionar / archivos JSX para web </h2><br>  En el caso de la Web, utilizamos una biblioteca de nodos llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">svgr</a> que convierte archivos SVG simples en componentes React.  Pero queremos hacer algo a√∫n m√°s poderoso: queremos "pintar din√°micamente" el √≠cono en tiempo de ejecuci√≥n, con los colores provenientes de los tokens de dise√±o.  Por esta raz√≥n, justo antes de la conversi√≥n, reemplazamos en el SVG los valores de <i>relleno</i> de las rutas que originalmente ten√≠an un estilo compartido aplicado, con el valor de token correspondiente asociado con ese estilo. <br><br>  Entonces, si este es el archivo <i>badge-feature-like.svg</i> exportado desde Sketch: <br><br><pre> <code class="plaintext hljs">&lt;?xml version="1.0" encoding="UTF-8"?&gt; &lt;svg width="128px" height="128px" viewBox="0 0 128 128" version="1.1" xmlns="&lt;a href="http://www.w3.org/2000/svg"&gt;http://www.w3.org/2000/svg&lt;/a&gt;" xmlns:xlink="&lt;a href="http://www.w3.org/1999/xlink"&gt;http://www.w3.org/1999/xlink&lt;/a&gt;"&gt; &lt;!-- Generator: sketchtool 52.2 (67145) - &lt;a href="http://www.bohemiancoding.com/sketch"&gt;http://www.bohemiancoding.com/sketch&lt;/a&gt; --&gt; &lt;title&gt;badge-feature-like&lt;/title&gt; &lt;desc&gt;Created with sketchtool.&lt;/desc&gt; &lt;g id="Icons" fill="none" fill-rule="evenodd"&gt; &lt;g id="badge-feature-like"&gt; &lt;circle id="circle" fill="#E71032" cx="64" cy="64" r="64"&gt; &lt;path id="Shape" fill="#FFFFFF" d="M80.4061668,..."&gt;&lt;/path&gt; &lt;/g&gt; &lt;/g&gt; &lt;/svg&gt;</code> </pre> <br>  el activo / icono final de <i>badge-feature-like.js</i> se ver√° as√≠: <br><br><pre> <code class="plaintext hljs">/* This file is generated automatically - DO NOT EDIT */ /* eslint-disable max-lines,max-len,camelcase */ const React = require('react'); module.exports = function badge_feature_like({ tokens }) { return ( &lt;svg data-origin="pipeline" viewBox="0 0 128 128"&gt; &lt;g fill="none" fillRule="evenodd"&gt; &lt;circle fill={tokens.TOKEN_COLOR_FEATURE_LIKED_YOU} cx={64} cy={64} r={64} /&gt; &lt;path fill="#FFF" d="M80.4061668,..." /&gt; &lt;/g&gt; &lt;/svg&gt; ); };</code> </pre> <br>  Como puede ver, hemos reemplazado el valor est√°tico para el color de <i>relleno</i> del c√≠rculo, por uno din√°mico, que toma su valor de los tokens de dise√±o (estos estar√°n disponibles para el componente Reaccionar <i>&lt;Icono /&gt; a</i> trav√©s de la API de contexto, Pero esa es otra historia). <br><br>  Este reemplazo es posible a trav√©s de los metadatos de Sketch para el activo almacenado en el objeto <i>Metadata de</i> los <i>activos</i> : recorriendo recursivamente las capas del activo, es posible crear un selector DOM (en el caso anterior, ser√≠a <i>#Icons # badge-feature- como #circle</i> ) y <i>√∫selo</i> para encontrar el nodo en el √°rbol SVG y reemplace el valor de su atributo de <i>relleno</i> (para esta operaci√≥n usamos la biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cheerio</a> ). <br><br><h2>  Archivos VectorDrawable para Android </h2><br>  Android admite gr√°ficos vectoriales utilizando su formato vectorial personalizado, llamado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">VectorDrawable</a> .  Por lo general, los desarrolladores realizan la conversi√≥n de SVG a VectorDrawable <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">directamente en Android Studio</a> .  Pero aqu√≠ quer√≠amos automatizar todo el proceso, por lo que necesit√°bamos encontrar una forma de convertirlos mediante c√≥digo. <br><br>  Despu√©s de mirar diferentes bibliotecas y herramientas, decidimos usar una biblioteca llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">svg2vectordrawable</a> .  No solo se mantiene activamente (al menos, mejor que los otros que encontramos) sino que tambi√©n es m√°s completo. <br><br>  El hecho es que VectorDrawable no est√° en paridad de caracter√≠sticas con SVG: algunas de las caracter√≠sticas avanzadas de SVG (p. Ej., Gradientes radiales, m√°scaras complejas, etc.) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">no</a> son <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">compatibles</a> , y algunas de ellas han obtenido soporte recientemente (con Android API 24 y m√°s alto).  Una desventaja de esto es que en Android pre-24 <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">la regla de relleno "par-impar" no es compatible</a> .  Pero en Badoo necesitamos ser compatibles con Android 5 y superior.  Es por eso que, como se explic√≥ anteriormente, para Android necesitamos convertir cada ruta en los archivos de Sketch a relleno "distinto de cero". <br><br>  Potencialmente, los dise√±adores podr√≠an hacer esto manualmente: <br><br><img src="https://habrastorage.org/webt/oj/ec/bp/ojecbp2no3lxsas5uwxcqmobcji.png"><br><br>  pero esto puede pasarse por alto f√°cilmente y, por lo tanto, ser propenso a errores humanos. <br><br>  Por esta raz√≥n, hemos agregado un paso adicional en nuestro proceso para Android, donde convertimos autom√°ticamente todas las rutas a <i>no cero</i> en el Sketch JSON.  Esto es para que cuando exportamos los √≠conos a SVG, ya est√©n en este formato, y cada VectorDrawable generado tambi√©n sea compatible con dispositivos Android 5. <br><br>  El archivo final <i>badge-feature-like.xml</i> en este caso tiene este aspecto: <br><br><pre> <code class="plaintext hljs">&lt;!-- This file is generated automatically - DO NOT EDIT --&gt; &lt;vector xmlns:android="&lt;a href="http://schemas.android.com/apk/res/android"&gt;http://schemas.android.com/apk/res/android&lt;/a&gt;" android:width="128dp" android:height="128dp" android:viewportWidth="128" android:viewportHeight="128"&gt; &lt;path android:fillColor="?color_feature_liked_you" android:pathData="M64 1a63 63 0 1 0 0 126A63 63 0 1 0 64 1z" /&gt; &lt;path android:fillColor="#FFFFFF" android:pathData="M80.406 ..." /&gt; &lt;/vector&gt;</code> </pre> <br>  Como puede ver, tambi√©n en los archivos de VectorDrawable inyectamos nombres de variables para los colores de <i>relleno</i> , que est√°n asociados a los tokens de dise√±o a trav√©s de estilos personalizados en las aplicaciones de Android. <br><br>  As√≠ es como se ve VectorDrawable una vez importado en Android Studio: <br><br> <a href=""><img src="https://habrastorage.org/webt/zu/n4/8q/zun48q0knfv8k9xy4amb6eqrxxa.png"></a> <br>  <i>Un ejemplo de un icono de VectorDrawable importado a Android Studio</i> <br><br>  Una cosa a tener en cuenta en este caso: Android Studio tiene una forma muy estricta y prescriptiva de organizar los activos: ¬°no hay carpetas anidadas y todos los nombres en min√∫sculas!  Esto significaba que ten√≠amos que encontrar un formato ligeramente diferente para los nombres de sus √≠conos: en el caso de un activo en experimentaci√≥n, su nombre ser√° algo as√≠ como <i>ic_icon-name__experiment-name__variant-name</i> . <br><br><h2>  Diccionario JSON como biblioteca de activos </h2><br>  Una vez que los archivos de activos se guardan en su formato final, lo √∫ltimo que queda por hacer es guardar toda la metainformaci√≥n recopilada durante el proceso de compilaci√≥n y almacenarla en un "diccionario" para que pueda estar disponible m√°s adelante. cuando los activos son importados y consumidos por la base de c√≥digo de las diferentes plataformas. <br><br>  Una vez extra√≠da la lista plana de iconos del objeto <i>assetsMetadata</i> , la <i>recorrimos</i> y para cada elemento verificamos: <br><br><ul><li>  si es un activo normal (por ejemplo, <i>tabbar-livestream</i> ), y si lo es, simplemente lo conservamos; </li><li>  si se trata de una variante en una prueba AB (p. ej. <i>experimento / tabbar-livestream [variante]</i> ) asociamos su nombre, ruta, prueba AB y nombres de variantes a las propiedades <i>abtest</i> del activo "base" (en este caso, <i>tabbar- livestream</i> ), y luego eliminamos la entrada variante de la lista / objeto (solo cuenta la "base"); </li><li>  si es una variante "fantasma", eliminamos el archivo y luego eliminamos la entrada de la lista / objeto. </li></ul><br>  Una vez que se completa el ciclo, el diccionario contendr√° la lista de todos y solo los √≠conos "base" (y sus pruebas AB, si est√°n bajo experimento).  Para cada uno de estos, contendr√° su nombre, tama√±o, ruta y, en caso de que un icono est√© bajo prueba AB, la informaci√≥n sobre las diferentes opciones del activo. <br><br>  Este diccionario se guarda en formato JSON en la carpeta de destino de la <i>marca</i> y la <i>plataforma</i> .  Aqu√≠, por ejemplo, est√° el archivo <i>assets.json</i> generado para la aplicaci√≥n "Blendr" en "web m√≥vil": <br><br><pre> <code class="plaintext hljs">{ "platform": "mw", "brand": "blendr", "assets": { "badge-feature-like": { "assetname": "badge-feature-like", "path": "assets/badge-feature-like.jsx", "width": 64, "height": 64, "source": "icons_common" }, "navigation-bar-edit": { "assetname": "navigation-bar-edit", "path": "assets/navigation-bar-edit.jsx", "width": 48, "height": 48, "source": "icons_common" }, "tabbar-livestream": { "assetname": "tabbar-livestream", "path": "assets/tabbar-livestream.jsx", "width": 128, "height": 128, "source": "icons_blendr", "abtest": { "this__is_an_experiment": { "control": "assets/this__is_an_experiment/tabbar-livestream__control.jsx", "variant1": "assets/this__is_an_experiment/tabbar-livestream__variant1.jsx", "variant2": "assets/this__is_an_experiment/tabbar-livestream__variant2.jsx" }, "a_second-experiment": { "control": "assets/a_second-experiment/tabbar-livestream__control.jsx", "variantA": "assets/a_second-experiment/tabbar-livestream__variantA.jsx" } } }, ... } }</code> </pre> <br>  El √∫ltimo paso es comprimir todas las carpetas de <i>activos</i> .  archivos <i>zip</i> , para que puedan descargarse m√°s f√°cilmente. <br><br><h2>  El resultado final </h2><br>  El proceso descrito anteriormente, desde la clonaci√≥n inicial y la manipulaci√≥n de los archivos de Sketch, hasta la exportaci√≥n (y conversi√≥n) de los activos en el formato deseado para cada plataforma compatible, hasta el almacenamiento de la metainformaci√≥n recopilada en una biblioteca de activos. repetido para cada marca declarada en el script de compilaci√≥n. <br><br>  A continuaci√≥n se muestra una captura de pantalla de la estructura de las carpetas <i>src</i> y <i>dist</i> , una vez que se completa el proceso de compilaci√≥n: <br><br><img src="https://habrastorage.org/webt/yg/nc/d9/ygncd9uupdngcnav-rmkrsq1dsg.png"><br>  <i>Estructura de las carpetas "src" y "dist" despu√©s de completar el proceso de compilaci√≥n.</i> <br><br>  En este punto, con un simple comando es posible cargar todos los recursos (archivos JSON, archivos ZIP y archivos de activos) en un repositorio remoto, y ponerlos a disposici√≥n de todas las plataformas, para descargar y consumir en sus bases de c√≥digo. <br><br>  (La forma en que las plataformas reales recuperan y procesan los activos, a trav√©s de scripts personalizados que se crearon ad-hoc para este prop√≥sito, est√° m√°s all√° del alcance de este art√≠culo. Pero esto probablemente se cubrir√° muy pronto en otras publicaciones de blog dedicadas, por uno de los otros desarrolladores que trabajaron conmigo en este proyecto). <br><br><h2>  Conclusiones (y lecciones aprendidas en el camino) </h2><br>  Siempre me ha encantado <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Sketch</a> .  Durante a√±os ha sido la herramienta de elecci√≥n "de facto" para el dise√±o (y desarrollo) de aplicaciones y web.  As√≠ que estaba muy interesado y curioso por explorar posibles integraciones como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">html-sketchapp</a> o herramientas similares, que podr√≠amos usar en nuestros flujos de trabajo y tuber√≠as. <br><br>  Este flujo (ideal) siempre ha sido el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">santo grial para m√≠</a> ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">y para muchos otros</a> ): <br><br><img src="https://habrastorage.org/webt/kq/7l/n4/kq7ln4kr6txurb-mvh6brqbhnqe.png"><br><br>  Sketch como herramienta de dise√±o se puede imaginar como un posible "objetivo" de la base de c√≥digo. <br><br>  Pero debo admitir que recientemente comenc√© a preguntarme si Sketch todav√≠a era la herramienta adecuada, especialmente en el contexto de un Sistema de dise√±o.  Entonces, comenc√© a explorar nuevas herramientas como <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Figma</a> , con sus API abiertas, y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Framer X</a> , con su incre√≠ble integraci√≥n con React, porque no ve√≠a esfuerzos equivalentes de Sketch para avanzar hacia la integraci√≥n con el c√≥digo (cualquiera que sea el c√≥digo). <br><br>  Bueno, este proyecto cambi√≥ de opini√≥n.  No completamente, pero definitivamente mucho. <br><br>  Quiz√°s Sketch no est√° exponiendo oficialmente sus API, pero ciertamente la forma en que han construido la estructura interna de sus archivos es una especie de API "no oficial".  Podr√≠an haber usado nombres cr√≠pticos u ofuscar las claves en los objetos JSON;  en su lugar, han optado por una convenci√≥n de nomenclatura sem√°ntica clara, f√°cil de leer y legible para humanos.  No puedo pensar que esto sea simplemente accidental. <br><br>  El hecho de que los archivos de Sketch se puedan manipular me ha abierto la mente a una amplia gama de posibles desarrollos y mejoras futuros.  Desde complementos para validar el nombre, el estilo y la estructura de las capas para los iconos, hasta posibles integraciones con nuestra wiki y nuestra documentaci√≥n del sistema de dise√±o (en ambas direcciones), a trav√©s de la creaci√≥n de aplicaciones Node alojadas en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Electron</a> o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Carlo</a> para facilitar muchas de las tareas repetitivas que los dise√±adores deben emprender. <br><br>  Una ventaja inesperada de este proyecto (al menos para m√≠) es que ahora los archivos de Sketch con los "iconos Cosmos" se han convertido en una "fuente de verdad", de manera similar a lo que sucedi√≥ con el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sistema de dise√±o Cosmos</a> .  Si un icono no est√° all√≠, no existe en la base de c√≥digo (o mejor, no deber√≠a existir: pero al menos sabemos que es una excepci√≥n).  S√© que parece obvio ahora, pero no antes, al menos para m√≠. <br><br>  Lo que comenz√≥ como un proyecto MVP, pronto se convirti√≥ en una inmersi√≥n profunda (literalmente) en lo interno de los archivos de Sketch, con la conciencia de que estos pueden ser manipulados.  Todav√≠a no sabemos a d√≥nde llevar√° todo esto, pero hasta ahora ha sido un √©xito.  Los dise√±adores, desarrolladores, PM y partes interesadas, todos est√°n de acuerdo en que esto ahorrar√° mucho trabajo manual para todos y evitar√° muchos errores potenciales.  Pero tambi√©n abrir√° las puertas a los usos de los iconos que han sido imposibles hasta ahora. <br><br>  Una √∫ltima cosa: lo que describ√≠ en esta larga publicaci√≥n es una tuber√≠a que hemos construido aqu√≠ para resolver <i>nuestros</i> problemas particulares, por lo que necesariamente est√° s√∫per personalizada para <i>nuestro</i> contexto.  Tenga en cuenta que puede que no se adapte a las necesidades de <i>su</i> negocio o que sea apropiado para <i>su</i> contexto. <br><br>  Pero lo que es importante para m√≠, y lo que quer√≠a compartir, es que se puede hacer.  Tal vez de diferentes maneras, con diferentes enfoques y diferentes formatos de salida, que tal vez impliquen menos complejidad (es decir, es posible que no necesite la marca m√∫ltiple y la prueba AB).  Pero ahora puede automatizar el flujo de trabajo involucrado en la entrega de sus iconos con un script Node.js personalizado y Sketch. <br><br>  Encuentra tu propia forma de hacerlo.  Es divertido (y relativamente f√°cil). <br><br><h2>  Cr√©ditos </h2><br>  Este gran proyecto fue desarrollado en colaboraci√≥n con <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Nikhil Verma</a> (Mobile Web), quien cre√≥ la primera versi√≥n del script de compilaci√≥n, y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Artem Rudoi</a> (Android) e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Igor Savelev</a> (iOS), quienes desarrollaron los scripts que importan y consumen los activos en su respectivas plataformas nativas.  Gracias, amigos, fue una maravilla trabajar con ustedes en este proyecto y verlo cobrar vida. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441042/">https://habr.com/ru/post/441042/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441030/index.html">Detecci√≥n de ataques web con un codificador autom√°tico Seq2Seq</a></li>
<li><a href="../441032/index.html">KeeBee Hacer su propio teclado USB desde cero</a></li>
<li><a href="../441034/index.html">6 puntos de crecimiento de conversi√≥n o c√≥mo aumentar la confianza usando un tel√©fono en el sitio</a></li>
<li><a href="../441036/index.html">C√≥mo dar y recibir retroalimentaci√≥n si eres un gorri√≥n-sociophobus</a></li>
<li><a href="../441040/index.html">Generando √≠conos multiplataforma multiplataforma con Sketch y un script Node.js - Parte # 1</a></li>
<li><a href="../441044/index.html">La historia de c√≥mo cambiamos el √≠cono de PVS-Studio</a></li>
<li><a href="../441046/index.html">La historia de c√≥mo cambiamos el √≠cono de PVS-Studio</a></li>
<li><a href="../441048/index.html">Oficina pro agresiva</a></li>
<li><a href="../441050/index.html">Hacer una c√°mara t√©rmica de bricolaje basada en una Raspberry Pi</a></li>
<li><a href="../441052/index.html">16 de marzo Badoo PHP Meetup: Pruebas y calidad de c√≥digo. El registro est√° abierto.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>