<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>✊ 👨‍👧‍👦 ☑️ Acenda a luz pelo poder do pensamento, bem, quase 💵 😖 👩🏼‍🔧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Escrever algoritmos é provavelmente a parte mais interessante para mim em automação residencial. Mas mesmo toda a massa de sensores e scripts não cons...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Acenda a luz pelo poder do pensamento, bem, quase</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/477770/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/v6/5s/kh/v65skhw1ssde-bikgplmz-ntc8e.jpeg" alt="KDPV"></div><br>  Escrever algoritmos é provavelmente a parte mais interessante para mim em automação residencial.  Mas mesmo toda a massa de sensores e scripts não consegue lidar com a exuberante fantasia da vida e você precisa adicionar uma maneira de controlar diretamente.  Como controles manuais, você pode colocar uma campainha comum, mas e se você quiser mais?  Conhecemos o herói deste artigo - um sensor de gestos baseado no SI1143 da Silicon Labs. <br><a name="habracut"></a><br>  SI1143 em si: <br><br><img src="https://habrastorage.org/webt/3l/a5/hz/3la5hzxcweqdhstg7x_67dpbx5y.jpeg" alt="SI1143"><br><br>  Parece realmente futurista. <br><br>  E quantas vantagens: <br><br><ul><li>  fotodíodo altamente sensível, ADC de baixo ruído </li><li>  Drivers de LED com correntes de 6 a 360 miliamperes </li><li>  alimentado de 1,71 a 3,6 volts </li><li>  e I2C inteligente - até 3,4 megabits por segundo </li></ul><br>  Esse é o tamanho de apenas 5 por 3 milímetros.  Esta não é a primeira vez que você o vê.  Bem, aqui você precisa de um pouco mais de cintas. <br><br><img src="https://habrastorage.org/webt/qd/gt/h2/qdgth25drlqtfixzko3e-cijooy.png" alt="Dispositivo"><br><br>  Isso pode ser removido?  Meu sentimento de beleza perguntou.  Tentarei satisfazer o pedido desse hóspede raro em nossa área e ocultar o quadro no edifício, mas, enquanto isso, você poderá aplicar energia e ver o que aconteceu. <br><blockquote>  Comente para o atencioso.  Existem realmente mais alguns detalhes do que o esperado.  O nó do projeto Enviriot foi tomado como base.  Além do microcontrolador STM32F051, a placa também possui um transceptor de 868 megahertz CC1101 da Texas Instruments e, após preencher o firmware, é suficiente para fornecer energia e o dispositivo se conectará ao servidor MQTT-SN. <br></blockquote><hr><br>  O princípio de operação é baseado na medição do nível do sinal refletido de cada um dos 3 LEDs.  Vou tentar ativá-lo e analisar a resposta. <br><br><img src="https://habrastorage.org/webt/8n/ga/gr/8ngagr4kxddscblrnp01j7l-lbk.png" alt="sinal"><br><br>  Devido ao arranjo assimétrico dos LEDs, o sinal do LED 1 é visivelmente maior e os resultados da medição deverão ser normalizados primeiro. <br><br><img src="https://habrastorage.org/webt/ac/qq/yf/acqqyfb0cuibrsjuq0xu_hripqo.png" alt="signal_norm"><br><br>  E assim a dependência já é bastante compreensível.  Vou tentar codificar o seguinte algoritmo: <br><div class="scrollable-table"><table><tbody><tr><th></th><th>  Um </th><th>  B </th><th>  C </th><th>  D </th></tr><tr><td>  ===&gt; <br></td><td>  L1 + <br>  L3 + <br>  L1&gt; L3 </td><td>  L1- <br>  L3 + <br>  L1&gt; L3 </td><td>  L1- <br>  L3 + <br>  L1&gt; L3 </td><td>  L1- <br>  L3- <br>  L1 &lt;L3 </td></tr><tr><td>  &lt;=== <br></td><td>  L1- <br>  L3- <br>  L1 &lt;L3 </td><td>  L1 + <br>  L3- <br>  L1 &lt;L3 </td><td>  L1 + <br>  L3- <br>  L1 &lt;L3 </td><td>  L1 + <br>  L3 + <br>  L1&gt; L3 </td></tr></tbody></table></div><br>  Onde L1 + - o sinal do LED 1 aumenta, L1&gt; L3 - o sinal do LED 1 é maior que o sinal do LED 3. <br><br>  Era bom no papel, mas na dinâmica os problemas começaram.  Para uma folha de papel branco fixada na mesma altura, os resultados esperados foram obtidos em dois casos em três.  Quando tento acenar com as mãos, o sinal começa a pular e meu maravilhoso algoritmo começou a ficar confuso nas leituras.  Ele olhou para a mão, mas há muitas diferenças em relação a uma folha plana de papel branco.  Mas de alguma forma deveria funcionar.  Ok.  Persuadido!  Vou tentar ler a documentação. <br><br><hr><br>  Para os aflitos, a Silicon Labs lançou o AppNote AN580 - “SENSOR DE GESTO INFRAVERMELHO”.  Dois métodos básicos para determinar gestos e suas possíveis combinações são descritos.  O primeiro método é determinar a posição em cada momento no tempo e determinar os gestos com base nas coordenadas.  O segundo método determina a mudança de fase entre os sinais.  Uma das variantes do primeiro método já foi testada e não foi impressionante.  Vou tentar implementar o segundo. <br><br>  Vamos lá  É necessário implementar até dois pontos.  Determine o momento da entrada e transfira esses dados para a máquina de estado.  O limiar de entrada foi determinado experimentalmente em 1/8 do sinal total.  Para proteger contra ruídos, adicionarei o gatilho de Schmidt, ligando 15% e desligando 10%. <br><br>  Bem, a própria máquina de estado.  Estados 1 a 3 - movimento ascendente, estados -1 a -3 - movimento descendente e estado 4 para o evento improvável de que os dois LEDs funcionem simultaneamente. <br><br><img src="https://habrastorage.org/webt/nu/td/gs/nutdgsnfzqqmob6zd_tpc6ylnzu.png" alt="ka"><br><br>  Agora vamos tentar decolar com tudo isso. <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> LSt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Int8Array</span></span>([<span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-number"><span class="hljs-number">-3</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>]); <span class="hljs-comment"><span class="hljs-comment">/* ...... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r1 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r3 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.button = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Int8(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* ...... */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n1 &gt; <span class="hljs-number"><span class="hljs-number">15</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r1 = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n1 &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r1 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n3 &gt; <span class="hljs-number"><span class="hljs-number">15</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r3 = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(n3 &lt; <span class="hljs-number"><span class="hljs-number">10</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r3 = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> st = (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r1?<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>) | (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r3?<span class="hljs-number"><span class="hljs-number">2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(st == <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-comment"><span class="hljs-comment">// .      this.button = 0; } else { this.button = LSt[st*8 + this.button - 5]; }</span></span></code> </pre> <br>  As variáveis ​​n1 e n3 contêm valores normalizados para os LEDs correspondentes.  O resultado está no campo do botão. <br><br>  Para uso posterior, os estados 2 - para cima e -2 - para baixo são úteis. <br><br>  O programa é escrito em um subconjunto de JavaScript, depois compilado no código de bytes e carregado no dispositivo.  O JavaScript é analisado e o AST é gerado pela biblioteca NiL.JS do camarada <a href="https://habr.com/ru/users/iaiojek/" class="user_link">IaIojek</a> , pelo qual muitos <a href="https://habr.com/ru/users/iaiojek/" class="user_link">agradecimentos</a> a ele. <br><br><img src="https://habrastorage.org/webt/bo/q1/-h/boq1-hroa90suwbentkltmxa9xu.png" alt="Logramm"><br><br>  Se o estado 2 dura menos de 0,3 segundos, os blocos A14 e A15 são responsáveis ​​por isso, o brilho é definido no máximo.  Os blocos A01 e A13 ajustam o brilho para 0 para um breve movimento descendente. <br><br>  Ao subir e segurar, os blocos A10, A09 e A04 fornecem um aumento suave do brilho.  Ao descer e segurar, os blocos A12, A11 e A08 funcionam e permitem reduzir o nível. <br><br><div class="spoiler">  <b class="spoiler_title">Demonstração de trabalho.</b>  <b class="spoiler_title">GIF de 20 megabytes.</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/38a/35d/cad/38a35dcad7ba7d1ab74b0dbc1271be96.gif" alt="demonstração"><br></div></div><br>  Bem, talvez seja só isso.  O cliente está feliz e estou começando a pensar na próxima versão.  Das alterações necessárias: coloque os LEDs à mesma distância do receptor, exiba a indicação de operação e faça uma pesquisa em um controlador separado, o que reduzirá o intervalo de pesquisa. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt477770/">https://habr.com/ru/post/pt477770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt477756/index.html">Como nos casamos com dois sistemas bancários de CRM</a></li>
<li><a href="../pt477758/index.html">“Doutor, retire isso da conta”: como procuramos serviços ilegais na VHI</a></li>
<li><a href="../pt477760/index.html">SberX RamblerFront & Meet Up: como foi</a></li>
<li><a href="../pt477766/index.html">Aplicação do modo de criptografia das placas SL3 MIfare no exemplo de uma empresa</a></li>
<li><a href="../pt477768/index.html">História do Vim e um guia para seu uso efetivo</a></li>
<li><a href="../pt477774/index.html">Reunião de design no escritório de Wrike em São Petersburgo, 5 de dezembro</a></li>
<li><a href="../pt477778/index.html">História do processador de vídeo, parte 2: 3Dfx Voodoo</a></li>
<li><a href="../pt477780/index.html">Escrevendo sua própria CLI para React</a></li>
<li><a href="../pt477782/index.html">DJI Mavic Mini e a lei</a></li>
<li><a href="../pt477786/index.html">Smartphone em vez de terminal de coleta de dados</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>