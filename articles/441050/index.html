<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÑ ü§∂üèº üòñ Hacer una c√°mara t√©rmica de bricolaje basada en una Raspberry Pi üõ¨ „ÄΩÔ∏è üë©üèø‚Äçüî¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hola a todos! 

 El invierno ha llegado, as√≠ que tuve que verificar el aislamiento t√©rmico de mi casa de campo fuera de la ciudad . Y result√≥ que un f...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hacer una c√°mara t√©rmica de bricolaje basada en una Raspberry Pi</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/441050/"><img src="https://habrastorage.org/webt/ei/lx/7g/eilx7ge_qfo9qu0xnwi1wvhjajs.jpeg" alt="imagen"><br><br>  Hola a todos! <br><br>  El invierno ha llegado, as√≠ que tuve que verificar el aislamiento t√©rmico de mi <s>casa de campo fuera de la ciudad</s> .  Y result√≥ que un famoso mercado chino comenz√≥ a vender m√≥dulos de c√°mara t√©rmica baratos.  As√≠ que decid√≠ armarlo y construir algo bastante ex√≥tico y √∫til: una visera t√©rmica para el hogar.  Por que no  Especialmente porque ten√≠a una Raspberry Pi por ah√≠ de todos modos ... El resultado est√° abajo. <br><a name="habracut"></a><br><h2>  MLX90640.  Que es </h2><br>  Esta es una matriz de c√°mara t√©rmica con un microcontrolador integrado, fabricado por una compa√±√≠a desconocida (para m√≠) llamada Melexis.  La matriz tiene 32x24 p√≠xeles, lo cual no es mucho, pero despu√©s de la interpolaci√≥n es suficiente para notar las tendencias generales. <br><br><img src="https://habrastorage.org/webt/vg/dz/aj/vgdzajxguwnre-4onijasyukl8o.jpeg" alt="imagen"><br><br>  El sensor viene en dos versiones, la √∫nica diferencia es el caso y el FoV de la c√°mara.  El modelo A m√°s conectado a tierra observa el mundo con 110 grados en horizontal y 75 en vertical.  El modelo B tiene 55 y 37.5 grados respectivamente.  El estuche tiene cuatro salidas: dos para alimentaci√≥n y dos para hablar con un dispositivo controlador a trav√©s de I2C.  La hoja de datos se puede encontrar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br><h2>  ¬øQu√© es GY-MCU90640, entonces? </h2><br>  Nuestros colegas chinos tambi√©n env√≠an el chip MLX90640 con otro microcontrolador a bordo (STM32F103), probablemente para un control de matriz m√°s f√°cil.  Toda la unidad se llama GY-MCU90640, y me cost√≥ alrededor de 5,000 RUB (aproximadamente $ 80) en diciembre de 2018. Se ve as√≠: <br><br><img src="https://habrastorage.org/webt/jd/h9/w4/jdh9w4phuzdtcccd8gsgcd5_gjk.jpeg" alt="imagen"><br><br>  Como podemos ver, tambi√©n hay dos versiones de este modelo, con diferentes sensores. <br><br>  ¬øCu√°l funcionar√° mejor?  Desafortunadamente, solo me hice esta pregunta despu√©s de que el m√≥dulo ha sido ordenado, enviado y recibido.  No lo he pensado al elegir. <br><br>  La versi√≥n de √°ngulo m√°s amplio es m√°s adecuada para robots aut√≥nomos o sistemas de CCTV (ya que su campo de visi√≥n es mejor).  La hoja de datos dice que tambi√©n es menos ruidosa y m√°s precisa. <br><br><img src="https://habrastorage.org/webt/_r/f1/vw/_rf1vwk_urgqftzfjdsy9lucsxo.jpeg" alt="imagen"><br><br>  Pero para la visualizaci√≥n, recomendar√≠a el modelo B m√°s ‚Äúcon ojos de √°guila‚Äù, por una raz√≥n muy importante.  Se puede colocar en su lugar (manualmente o mediante una unidad) para hacer que las im√°genes combinadas sean mucho m√°s detalladas que su resoluci√≥n de 32x24.  Pero no tengo uno, as√≠ que m√°s adelante hablar√© sobre el modelo A de √°ngulo m√°s amplio. <br><br><h2>  Conectando a la Raspberry Pi </h2><br>  Podemos controlar la c√°mara t√©rmica de dos maneras: <br><br><ul><li>  Cortar los pines "SET" en la placa y utilizar el protocolo I2C para controlar el microcontrolador MLX90640 directamente </li><li>  Deje los pines y use el controlador STM32F103 a trav√©s de RS-232 o una interfaz similar. </li></ul><br>  Si codifica en C ++, probablemente sea mejor ignorar el controlador adicional, acortar los pines y usar la API del fabricante, que se encuentra <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> . <br><br>  Los pitonistas humildes tambi√©n podr√≠an usar la primera opci√≥n.  Parece que hay un par de bibliotecas de Python ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aqu√≠</a> ), pero ninguna funcion√≥ para m√≠. <br><br>  Pythonists avanzados te√≥ricamente podr√≠an escribir su propio controlador de controlador.  La hoja de datos explica c√≥mo extraer un marco de ella.  Pero tendr√° que describir todos los procedimientos de calibraci√≥n manualmente, lo cual me parece excesivamente dif√≠cil.  Entonces utilic√© la opci√≥n 2. Result√≥ ser un poco complicado, pero a√∫n manejable. <br><br>  Gracias al ingenio chino (o suerte), la configuraci√≥n de salida en el tablero result√≥ ser muy conveniente: <br><br><img src="https://habrastorage.org/webt/wr/t1/iu/wrt1iuw0xxqw0cze8sb0wg4bl54.jpeg" alt="imagen"><br><br>  Todo lo que necesitaba hacer era insertar la placa en el puerto de Raspberry.  La placa tiene incorporado un convertidor de 5V-3V, por lo que las delicadas salidas Rx y Tx del Pi no est√°n en peligro. <br><br>  Tambi√©n agregar√≠a que podr√≠a conectarlo de manera similar mientras usa la opci√≥n 1, pero tendr√° que ser extremadamente cuidadoso y competente en la soldadura.  La placa debe montarse en el otro lado del Pi (el ejemplo est√° en la foto del encabezado). <br><br><h2>  Software </h2><br>  El famoso mercado chino ofrece este majestuoso software para acceder al GY-MCU90640: <br><br><img src="https://habrastorage.org/webt/ri/fo/pq/rifopqyhbfzldcrxujqgobydntm.jpeg" alt="imagen"><br><br>  Aparentemente, tambi√©n debe haber alguna descripci√≥n del protocolo de comunicaci√≥n utilizado para acceder al microcontrolador, y despu√©s de una breve conversaci√≥n con el vendedor (un gran respeto hacia √©l), ten√≠a dicho protocolo en mis manos.  En PDF y en chino puro destilado. <br><br>  Gracias al Traductor de Google y una buena dosis de copiado, unos 90 minutos despu√©s, el protocolo ha sido decodificado.  Lo cargu√© en <img src="https://github.com/vvkuryshev/GY-MCU90640-RPI-Python" alt="imagen">  Github  Result√≥ que la placa comprende 6 comandos b√°sicos, incluido uno para solicitar la trama actual a trav√©s de un puerto COM. <br><br>  Cada p√≠xel de la matriz es esencialmente una lectura de la temperatura del objeto.  El valor de la temperatura est√° en grados Celsius multiplicado por 100 (un n√∫mero de 2 bytes).  Incluso hay un modo especial cuando la placa env√≠a fotogramas a la Pi autom√°ticamente 4 veces por segundo. <br><br><div class="spoiler">  <b class="spoiler_title">El gui√≥n completo para recibir im√°genes t√©rmicas:</b> <div class="spoiler_text"><pre><code class="python hljs"><span class="hljs-string"><span class="hljs-string">"""MIT License Copyright (c) 2019 Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions: The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software. THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE."""</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> serial, time <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> datetime <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> dt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> numpy <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> np <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> cv2 <span class="hljs-comment"><span class="hljs-comment"># function to get Emissivity from MCU def get_emissivity(): ser.write(serial.to_bytes([0xA5,0x55,0x01,0xFB])) read = ser.read(4) return read[2]/100 # function to get temperatures from MCU (Celsius degrees x 100) def get_temp_array(d): # getting ambient temperature T_a = (int(d[1540]) + int(d[1541])*256)/100 # getting raw array of pixels temperature raw_data = d[4:1540] T_array = np.frombuffer(raw_data, dtype=np.int16) return T_a, T_array # function to convert temperatures to pixels on image def td_to_image(f): norm = np.uint8((f/100 - Tmin)*255/(Tmax-Tmin)) norm.shape = (24,32) return norm ########################### Main cycle ################################# # Color map range Tmax = 40 Tmin = 20 print ('Configuring Serial port') ser = serial.Serial ('/dev/serial0') ser.baudrate = 115200 # set frequency of module to 4 Hz ser.write(serial.to_bytes([0xA5,0x25,0x01,0xCB])) time.sleep(0.1) # Starting automatic data colection ser.write(serial.to_bytes([0xA5,0x35,0x02,0xDC])) t0 = time.time() try: while True: # waiting for data frame data = ser.read(1544) # The data is ready, let's handle it! Ta, temp_array = get_temp_array(data) ta_img = td_to_image(temp_array) # Image processing img = cv2.applyColorMap(ta_img, cv2.COLORMAP_JET) img = cv2.resize(img, (320,240), interpolation = cv2.INTER_CUBIC) img = cv2.flip(img, 1) text = 'Tmin = {:+.1f} Tmax = {:+.1f} FPS = {:.2f}'.format(temp_array.min()/100, temp_array.max()/100, 1/(time.time() - t0)) cv2.putText(img, text, (5, 15), cv2.FONT_HERSHEY_SIMPLEX, 0.45, (0, 0, 0), 1) cv2.imshow('Output', img) # if 's' is pressed - saving of picture key = cv2.waitKey(1) &amp; 0xFF if key == ord("s"): fname = 'pic_' + dt.datetime.now().strftime('%Y-%m-%d_%H-%M-%S') + '.jpg' cv2.imwrite(fname, img) print('Saving image ', fname) t0 = time.time() except KeyboardInterrupt: # to terminate the cycle ser.write(serial.to_bytes([0xA5,0x35,0x01,0xDB])) ser.close() cv2.destroyAllWindows() print(' Stopped') # just in case ser.close() cv2.destroyAllWindows()</span></span></code> </pre> <br></div></div><br><h2>  Resultados </h2><br>  El script sondea la matriz t√©rmica y env√≠a cuadros a la consola del monitor conectado, 4 veces por segundo, lo cual es suficiente para no experimentar demasiadas molestias.  Para la visualizaci√≥n utiliza el paquete OpenCV.  Cuando presiona S, los "mapas de calor" de la c√°mara se cargan como JPG en la carpeta del script. <br><br><img src="https://habrastorage.org/webt/6n/9o/gw/6n9ogwhkr1klkw_qvcaej45vqnw.jpeg" alt="imagen"><br><br>  Para una mejor visibilidad, tambi√©n hice que la aplicaci√≥n muestre la temperatura m√≠nima y m√°xima dentro del marco.  Entonces, al observar el mapa de calor podemos estimar la temperatura de los objetos m√°s fr√≠os y calientes (dentro de un grado, generalmente en el lado m√°s alto), dentro del rango de 20-40 grados.  Ctrl + C sale del gui√≥n. <br><br><img src="https://habrastorage.org/webt/ik/e9/cy/ike9cyyu4h3wbdde2tfubq6yhwu.jpeg" alt="imagen"><br><br>  El script funciona igual en Raspberry Pi Zero W y Pi 3 B +.  Instal√© un servidor VNC en mi tel√©fono inteligente, por lo tanto, al llevar un Pi conectado a un banco de energ√≠a con un tel√©fono inteligente habilitado para VNC, podemos obtener una c√°mara t√©rmica de bolsillo que guarda im√°genes.  Puede que no sea demasiado conveniente, pero hace el trabajo. <br><br>  Despu√©s del primer arranque, podr√≠a mostrar la temperatura m√°xima incorrectamente, en cuyo caso solo reiniciar el script deber√≠a hacer el trabajo. <br><br>  Eso es todo por hoy.  El experimento podr√≠a considerarse un √©xito.  Definitivamente puedes hacer un escaneo t√©rmico de una casa usando este dispositivo.  Si alguien puede encontrar otros usos para esto, por favor escriba en los comentarios. <br><br>  ¬°Feliz semana de trabajo y hasta pronto! <br><br>  UPD: Me pidieron en los comentarios que tomara una foto de la casa desde afuera.  Aqui esta  Las im√°genes terminaron siendo poco informativas debido al menor contraste de temperaturas.  Las dos fotos superiores son la casa entera desde dos √°ngulos.  Las dos fotos inferiores son ventanas diferentes. <br><br><img src="https://habrastorage.org/webt/-y/ww/kd/-ywwkdovoeqvolceev0zu--0bi4.jpeg" alt="imagen"><br><br>  El √∫nico cambio que hice al c√≥digo fue el rango de temperatura: de +20 ... + 40 a -10 ... + 5. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/441050/">https://habr.com/ru/post/441050/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../441040/index.html">Generando √≠conos multiplataforma multiplataforma con Sketch y un script Node.js - Parte # 1</a></li>
<li><a href="../441042/index.html">Generando √≠conos multiplataforma de m√∫ltiples marcas con Sketch y un script Node.js - Parte # 2</a></li>
<li><a href="../441044/index.html">La historia de c√≥mo cambiamos el √≠cono de PVS-Studio</a></li>
<li><a href="../441046/index.html">La historia de c√≥mo cambiamos el √≠cono de PVS-Studio</a></li>
<li><a href="../441048/index.html">Oficina pro agresiva</a></li>
<li><a href="../441052/index.html">16 de marzo Badoo PHP Meetup: Pruebas y calidad de c√≥digo. El registro est√° abierto.</a></li>
<li><a href="../441058/index.html">Concurso en l√≠nea para resolver un problema desde la teor√≠a de juegos</a></li>
<li><a href="../441060/index.html">Descripci√≥n general del esc√°ner 3D Metronor</a></li>
<li><a href="../441062/index.html">Mundo integrado 2019 en el Centro de Exposiciones de Nuremberg</a></li>
<li><a href="../441064/index.html">Computadora m√°s peque√±a</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>