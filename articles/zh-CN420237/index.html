<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‰ ğŸ¤¾ğŸ¾ ğŸ’… C ++ä¸­å›´ç»•gRPCæ¡†æ¶çš„QtåŒ…è£…å™¨ ğŸ“¡ ğŸ™ğŸ¼ ğŸ‘©â€ğŸ”¬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½ ä»Šå¤©ï¼Œæˆ‘ä»¬å°†ç ”ç©¶å¦‚ä½•åœ¨C ++å’ŒQtåº“ä¸­é“¾æ¥gRPCæ¡†æ¶ã€‚ æœ¬æ–‡æä¾›äº†æ€»ç»“gRPCä¸­æ‰€æœ‰å››ç§äº¤äº’æ¨¡å¼çš„ç”¨æ³•çš„ä»£ç ã€‚ å¦å¤–ï¼Œæä¾›äº†å…è®¸é€šè¿‡Qtä¿¡å·å’Œæ’æ§½ä½¿ç”¨gRPCçš„ä»£ç ã€‚ æœ¬æ–‡å¯èƒ½ä¸»è¦æ˜¯å¯¹ä½¿ç”¨gRPCæ„Ÿå…´è¶£çš„Qtå¼€å‘äººå‘˜æ„Ÿå…´è¶£çš„ã€‚ å°½ç®¡å¦‚æ­¤ï¼Œåœ¨ä¸ä½¿ç”¨Qtçš„æƒ…å†µä¸‹ï¼Œç”¨C ++ç¼–å†™äº†gRPCå››ç§...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C ++ä¸­å›´ç»•gRPCæ¡†æ¶çš„QtåŒ…è£…å™¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/420237/"><p> å¤§å®¶å¥½ ä»Šå¤©ï¼Œæˆ‘ä»¬å°†ç ”ç©¶å¦‚ä½•åœ¨C ++å’ŒQtåº“ä¸­é“¾æ¥gRPCæ¡†æ¶ã€‚ æœ¬æ–‡æä¾›äº†æ€»ç»“gRPCä¸­æ‰€æœ‰å››ç§äº¤äº’æ¨¡å¼çš„ç”¨æ³•çš„ä»£ç ã€‚ å¦å¤–ï¼Œæä¾›äº†å…è®¸é€šè¿‡Qtä¿¡å·å’Œæ’æ§½ä½¿ç”¨gRPCçš„ä»£ç ã€‚ æœ¬æ–‡å¯èƒ½ä¸»è¦æ˜¯å¯¹ä½¿ç”¨gRPCæ„Ÿå…´è¶£çš„Qtå¼€å‘äººå‘˜æ„Ÿå…´è¶£çš„ã€‚ å°½ç®¡å¦‚æ­¤ï¼Œåœ¨ä¸ä½¿ç”¨Qtçš„æƒ…å†µä¸‹ï¼Œç”¨C ++ç¼–å†™äº†gRPCå››ç§æ“ä½œæ¨¡å¼çš„æ¦‚æ‹¬ï¼Œè¿™å°†ä½¿ä¸Qtæ— å…³çš„å¼€å‘äººå‘˜å¯ä»¥ä¿®æ”¹ä»£ç ã€‚ æˆ‘é—®æ¯ä¸ªæœ‰å…´è¶£çš„çŒ«ã€‚ </p><a name="habracut"></a><br><h2> èƒŒæ™¯çŸ¥è¯† </h2><br><p> å¤§çº¦å…­ä¸ªæœˆå‰ï¼Œä½¿ç”¨gRPCçš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ¨åˆ†æŒ‚èµ·äº†ä¸¤ä¸ªé¡¹ç›®ã€‚ è¿™ä¸¤ä¸ªé¡¹ç›®éƒ½å‡äº§ã€‚ è¿™äº›é¡¹ç›®æ˜¯ç”±å·²ç»é€€å‡ºçš„å¼€å‘äººå‘˜ç¼–å†™çš„ã€‚ å”¯ä¸€çš„å¥½æ¶ˆæ¯æ˜¯ï¼Œæˆ‘ç§¯æå‚ä¸äº†ç¼–å†™gRPCæœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä»£ç çš„å·¥ä½œã€‚ ä½†æ˜¯é‚£æ˜¯å¤§çº¦ä¸€å¹´å‰çš„äº‹ã€‚ å› æ­¤ï¼Œåƒå¾€å¸¸ä¸€æ ·ï¼Œæˆ‘å¿…é¡»ä»å¤´å¼€å§‹å¤„ç†æ‰€æœ‰é—®é¢˜ã€‚ </p><br><p> ç¼–å†™gRPCæœåŠ¡å™¨ä»£ç æ—¶ï¼ŒæœŸæœ›å®ƒå°†ç”±.protoæ–‡ä»¶è¿›ä¸€æ­¥ç”Ÿæˆã€‚ ä»£ç å†™å¾—å¾ˆå¥½ã€‚ ä½†æ˜¯ï¼ŒæœåŠ¡å™¨æœ‰ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºç‚¹ï¼šåªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥è¿æ¥åˆ°å®ƒã€‚ </p><br><p>  gRPCå®¢æˆ·ç«¯çš„ç¼–å†™éå¸¸ç³Ÿç³•ã€‚ </p><br><p> å‡ å¤©åï¼Œæˆ‘å¼„æ¸…æ¥šäº†å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç gRPCã€‚ è€Œä¸”æˆ‘æ„è¯†åˆ°ï¼Œå¦‚æœæˆ‘èŠ±äº†å‡ ä¸ªæ˜ŸæœŸçš„æ—¶é—´æ¥åšé¡¹ç›®ï¼Œæˆ‘å°†ä¸å¾—ä¸å†æ¬¡å¤„ç†æœåŠ¡å™¨å’ŒgRPCå®¢æˆ·ç«¯ã€‚ </p><br><p> é‚£æ—¶æˆ‘å†³å®šæ˜¯æ—¶å€™ç¼–å†™å’Œè°ƒè¯•gRPCå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨äº†ï¼Œä»¥ä¾¿ï¼š </p><br><ul><li><p> æ‚¨å¯ä»¥åœ¨æ™šä¸Šå®‰ç„¶å…¥ç¡ï¼› </p></li><li><p> æ— éœ€è®°ä½æ¯æ¬¡æ‚¨éœ€è¦ç¼–å†™å®¢æˆ·ç«¯æˆ–gRPCæœåŠ¡å™¨æ—¶å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ </p></li><li><p> æ‚¨å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®ä¸­ä½¿ç”¨ä¹¦é¢çš„gRPCå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ã€‚ </p></li></ul><br><p> åœ¨ç¼–å†™ä»£ç æ—¶ï¼Œæˆ‘éµå¾ªä»¥ä¸‹è¦æ±‚ï¼š </p><br><ul><li><p>  gRPCå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½å¯ä»¥è‡ªç„¶åœ°ä½¿ç”¨Qtåº“ä¿¡å·å’Œæ’æ§½è¿›è¡Œæ“ä½œï¼› </p></li><li><p> æ›´æ”¹.protoæ–‡ä»¶æ—¶ï¼Œæ— éœ€ä¿®å¤gRPCå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä»£ç ï¼› </p></li><li><p>  gRPCå®¢æˆ·ç«¯åº”è¯¥èƒ½å¤Ÿå‘Šè¯‰å®¢æˆ·ç«¯ä»£ç ä¸æœåŠ¡å™¨çš„è¿æ¥çŠ¶æ€ã€‚ </p></li></ul><br><p> æœ¬æ–‡çš„ç»“æ„å¦‚ä¸‹ã€‚ é¦–å…ˆï¼Œå°†ç®€è¦æ¦‚è¿°ä½¿ç”¨å®¢æˆ·ç«¯ä»£ç çš„ç»“æœä»¥åŠä¸€äº›è§£é‡Šã€‚ å®¡æŸ¥ç»“æŸæ—¶ï¼ŒæŒ‡å‘å­˜å‚¨åº“çš„é“¾æ¥ã€‚ æ­¤å¤–ï¼Œåœ¨æ¶æ„ä¸Šè¿˜ä¼šæœ‰ä¸€äº›ä¸€èˆ¬æ€§çš„äº‹æƒ…ã€‚ ç„¶åæ˜¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä»£ç çš„è¯´æ˜ï¼ˆå¹•åèŠ±çµ®ï¼‰å’Œç»“è®ºã€‚ </p><br><h2> ç®€çŸ­è¯„è®º </h2><br><p> æœ€ç®€å•çš„pingproto.protoæ–‡ä»¶ç”¨ä½œ.protoæ–‡ä»¶ï¼Œå…¶ä¸­å®šä¹‰äº†æ‰€æœ‰äº¤äº’ç±»å‹çš„RPCï¼š </p><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">syntax</span></span> = <span class="hljs-string"><span class="hljs-string">"proto3"</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">package</span></span> pingpong; <span class="hljs-attribute"><span class="hljs-attribute">service</span></span> ping { <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> SayHello (PingRequest) returns (PingReply) {} <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> GladToSeeMe(PingRequest) returns (stream PingReply){} <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> GladToSeeYou(stream PingRequest) returns (PingReply){} <span class="hljs-attribute"><span class="hljs-attribute">rpc</span></span> BothGladToSee(stream PingRequest) returns (stream PingReply){} } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> PingRequest { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> name = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> message = <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">message</span></span> PingReply { <span class="hljs-attribute"><span class="hljs-attribute">string</span></span> message = <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>  pingpong.protoæ–‡ä»¶å°†æœ‰å…³<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">C ++ä¸­å¼‚æ­¥gRPCæ¨¡å¼</a>çš„æ–‡ç« ä¸­çš„helloworld.protoæ–‡ä»¶é‡å¤åˆ°ç¡®åˆ‡åç§°ã€‚ </p><br><p> ç»“æœï¼Œå¯ä»¥åƒä¸‹é¢è¿™æ ·ä½¿ç”¨ä¹¦é¢æœåŠ¡å™¨ï¼š </p><br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> QObject { Q_OBJECT; QpingServerService pingservice; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: A() { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> is_ok; is_ok = connect(&amp;pingservice, SIGNAL(SayHelloRequest(SayHelloCallData*)), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(onSayHello(SayHelloCallData*))); assert(is_ok); is_ok = connect(&amp;pingservice, SIGNAL(GladToSeeMeRequest(GladToSeeMeCallData*)), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(onGladToSeeMe(GladToSeeMeCallData*))); assert(is_ok); is_ok = connect(&amp;pingservice, SIGNAL(GladToSeeYouRequest(GladToSeeYouCallData*)), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(onGladToSeeYou(GladToSeeYouCallData*))); assert(is_ok); is_ok = connect(&amp;pingservice, SIGNAL(BothGladToSeeRequest(BothGladToSeeCallData*)), <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, SLOT(onBothGladToSee(BothGladToSeeCallData*))); assert(is_ok); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> slots: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSayHello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SayHelloCallData* cd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"["</span></span> &lt;&lt; cd-&gt;peer() &lt;&lt; <span class="hljs-string"><span class="hljs-string">"][11]: request: "</span></span> &lt;&lt; cd-&gt;request.name() &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; cd-&gt;reply.set_message(<span class="hljs-string"><span class="hljs-string">"hello "</span></span> + cd-&gt;request.name()); cd-&gt;Finish(); } <span class="hljs-comment"><span class="hljs-comment">//etc. };</span></span></code> </pre><br><p> å®¢æˆ·ç«¯è°ƒç”¨RPCæ—¶ï¼ŒgRPCæœåŠ¡å™¨ä¼šä½¿ç”¨é€‚å½“çš„ä¿¡å·é€šçŸ¥å®¢æˆ·ç«¯ä»£ç ï¼ˆåœ¨æœ¬ä¾‹ä¸­ä¸ºAç±»ï¼‰ã€‚ </p><br><p>  gRPCå®¢æˆ·ç«¯å¯ä»¥è¿™æ ·ä½¿ç”¨ï¼š </p><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> B : <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> QObject { Q_OBJECT QpingClientService pingPongSrv; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span>: B() { <span class="hljs-type"><span class="hljs-type">bool</span></span> c = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; c = <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(&amp;pingPongSrv, SIGNAL(SayHelloResponse(SayHelloCallData*)), this, SLOT(onSayHelloResponse(SayHelloCallData*))); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(c); c = <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(&amp;pingPongSrv, SIGNAL(GladToSeeMeResponse(GladToSeeMeCallData*)), this, SLOT(onGladToSeeMeResponse(GladToSeeMeCallData*))); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(c); c = <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(&amp;pingPongSrv, SIGNAL(GladToSeeYouResponse(GladToSeeYouCallData*)), this, SLOT(onGladToSeeYouResponse(GladToSeeYouCallData*))); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(c); c = <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(&amp;pingPongSrv, SIGNAL(BothGladToSeeResponse(BothGladToSeeCallData*)), this, SLOT(onBothGladToSeeResponse(BothGladToSeeCallData*))); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(c); c = <span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(&amp;pingPongSrv, SIGNAL(channelStateChanged(<span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span>)), this, SLOT(onPingPongStateChanged(<span class="hljs-type"><span class="hljs-type">int</span></span>, <span class="hljs-type"><span class="hljs-type">int</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span>(c); } <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">usage</span></span>() { //Unary PingRequest request; request.set_name("user"); request.set_message("user"); pingPongSrv.SayHello(request); //<span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> streaming PingRequest request2; request2.set_name("user"); pingPongSrv.GladToSeeMe(request2); //etc. } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> slots: <span class="hljs-type"><span class="hljs-type">void</span></span> SayHelloResponse(SayHelloCallData* response) { std::cout &lt;&lt; "[11]: reply: " &lt;&lt; response-&gt;reply.message() &lt;&lt; std::endl; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response-&gt;CouldBeDeleted()) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> response; } //etc. };</code> </pre><br><p> ä½¿ç”¨gRPCå®¢æˆ·ç«¯ï¼Œæ‚¨å¯ä»¥ç›´æ¥è°ƒç”¨RPCï¼Œå¹¶ä½¿ç”¨é€‚å½“çš„ä¿¡å·è®¢é˜…æœåŠ¡å™¨çš„å“åº”ã€‚ </p><br><p>  gRPCå®¢æˆ·ç«¯ä¹Ÿæœ‰ä¸€ä¸ªä¿¡å·ï¼š <br><br></p><pre> <code class="hljs objectivec">channelStateChanged(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>);</code> </pre><br> æŠ¥å‘Šè¿‡å»å’Œå½“å‰æœåŠ¡å™¨è¿æ¥çŠ¶æ€ã€‚ æ‰€æœ‰<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç¤ºä¾‹</a>ä»£ç éƒ½åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">qgrpcå­˜å‚¨åº“ä¸­</a> ã€‚ <br><br><h2> å¦‚ä½•è¿ä½œ </h2><br><p> å›¾ä¸­æ˜¾ç¤ºäº†å°†å®¢æˆ·ç«¯å’ŒgRPCæœåŠ¡å™¨åŒ…æ‹¬åœ¨é¡¹ç›®ä¸­çš„åŸç†ã€‚ </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/i3/h9/ad/i3h9ad3c3joddotb7akq1iagpnc.jpeg"></div><br><p> åœ¨.proé¡¹ç›®æ–‡ä»¶ä¸­ï¼ŒæŒ‡å®šäº†.protoæ–‡ä»¶ï¼ŒgRPCå°†åŸºäºè¯¥æ–‡ä»¶å·¥ä½œã€‚  grpc.priæ–‡ä»¶åŒ…å«ç”¨äºç”ŸæˆgRPCå’ŒQgRPCæ–‡ä»¶çš„å‘½ä»¤ã€‚ åè®®ç¼–è¯‘å™¨ç”ŸæˆgRPCæ–‡ä»¶[protofile] .grpc.pb.hå’Œ[protofile] .grpc.pb.ccã€‚  [protofile]æ˜¯ä¼ é€’ç»™ç¼–è¯‘å™¨è¾“å…¥çš„.protoæ–‡ä»¶çš„åç§°ã€‚ </p><br><p>  QgRPCæ–‡ä»¶[protofile] .qgrpcã€‚[Config] .hçš„ç”Ÿæˆç”±è„šæœ¬genQGrpc.pyå¤„ç†ã€‚  [config]æ˜¯â€œæœåŠ¡å™¨â€æˆ–â€œå®¢æˆ·ç«¯â€ã€‚ <br><br> ç”Ÿæˆçš„QgRPCæ–‡ä»¶åŒ…å«å›´ç»•gRPCç±»çš„QtåŒ…è£…å™¨ä»¥åŠå¸¦æœ‰ç›¸åº”ä¿¡å·çš„è°ƒç”¨ã€‚ åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œåˆ†åˆ«åœ¨ç”Ÿæˆçš„æ–‡ä»¶pingpong.qgrpc.server.hå’Œpingpong.qgrpc.client.hä¸­å£°æ˜äº†QpingServerServiceå’ŒQpingClientServiceç±»ã€‚ ç”Ÿæˆçš„QgRPCæ–‡ä»¶å°†æ·»åŠ åˆ°mocå¤„ç†ä¸­ã€‚ </p><br><p> åœ¨ç”Ÿæˆçš„QgRPCæ–‡ä»¶ä¸­ï¼ŒåŒ…æ‹¬QGrpc [config] .hæ–‡ä»¶ï¼Œæ‰€æœ‰ä¸»è¦å·¥ä½œéƒ½åœ¨å…¶ä¸­è¿›è¡Œã€‚ åœ¨ä¸‹é¢é˜…è¯»æœ‰å…³æ­¤å†…å®¹çš„æ›´å¤šä¿¡æ¯ã€‚ </p><br><p> è¦å°†æ‰€æœ‰æ­¤æ„é€ è¿æ¥åˆ°é¡¹ç›®ï¼Œæ‚¨éœ€è¦åœ¨é¡¹ç›®.proæ–‡ä»¶ä¸­åŒ…æ‹¬grpc.priæ–‡ä»¶ï¼Œå¹¶æŒ‡å®šä¸‰ä¸ªå˜é‡ã€‚  GRPCå˜é‡å®šä¹‰äº†.protoæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶å°†è¢«ä¼ è¾“åˆ°protocç¼–è¯‘å™¨å’ŒgenQGrpc.pyè„šæœ¬çš„è¾“å…¥ä¸­ã€‚  QGRPC_CONFIGå˜é‡å®šä¹‰ç”Ÿæˆçš„QgRPCæ–‡ä»¶çš„é…ç½®å€¼ï¼Œå¹¶ä¸”å¯ä»¥åŒ…å«å€¼â€œ serverâ€æˆ–â€œ clientâ€ã€‚ æ‚¨è¿˜å¯ä»¥å®šä¹‰å¯é€‰çš„GRPC_VERSIONå˜é‡ä»¥æŒ‡ç¤ºgRPCçš„ç‰ˆæœ¬ã€‚ </p><br><p> æœ‰å…³æ‰€æœ‰å†…å®¹çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·é˜…è¯»grpc.priæ–‡ä»¶å’Œ.proç¤ºä¾‹æ–‡ä»¶ã€‚ </p><br><h2> æœåŠ¡å™¨æ¶æ„ </h2><br><p> æœåŠ¡å™¨ç±»å›¾å¦‚å›¾æ‰€ç¤ºã€‚ </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nd/ec/ae/ndecaezqpvmh1kn9iviw6yuic9i.jpeg"></div><br><p> ç²—ç®­å¤´æ˜¾ç¤ºç±»ç»§æ‰¿çš„å±‚æ¬¡ç»“æ„ï¼Œç»†ç®­å¤´æ˜¾ç¤ºç±»ä¸­æˆå‘˜å’Œæ–¹æ³•çš„æˆå‘˜èµ„æ ¼ã€‚ é€šå¸¸ï¼Œä¼šä¸ºæœåŠ¡ç”ŸæˆQ [servicename] ServerServiceç±»ï¼Œå…¶ä¸­servicenameæ˜¯.protoæ–‡ä»¶ä¸­å£°æ˜çš„æœåŠ¡çš„åç§°ã€‚  RPCCallDataæ˜¯ä¸ºæœåŠ¡ä¸­çš„æ¯ä¸ªRPCç”Ÿæˆçš„æ§åˆ¶ç»“æ„ã€‚ åœ¨QpingServerServiceç±»çš„æ„é€ å‡½æ•°ä¸­ï¼ŒåŸºç±»QGrpcServerServiceä½¿ç”¨gRPC pingpong :: ping :: AsyncServiceå¼‚æ­¥æœåŠ¡åˆå§‹åŒ–ã€‚ è¦å¯åŠ¨è¯¥æœåŠ¡ï¼Œæ‚¨éœ€è¦ä½¿ç”¨è¯¥æœåŠ¡å°†åœ¨å…¶ä¸Šè¿è¡Œçš„åœ°å€å’Œç«¯å£æ¥è°ƒç”¨Startï¼ˆï¼‰æ–¹æ³•ã€‚  Startï¼ˆï¼‰å‡½æ•°å®ç°äº†å¯åŠ¨æœåŠ¡çš„æ ‡å‡†è¿‡ç¨‹ã€‚ </p><br><p> åœ¨Startï¼ˆï¼‰å‡½æ•°çš„æœ«å°¾ï¼Œå°†è°ƒç”¨çº¯è™šå‡½æ•°makeRequestsï¼ˆï¼‰ï¼Œè¯¥å‡½æ•°åœ¨ç”Ÿæˆçš„QpingServerServiceç±»ä¸­å®ç°ï¼š </p><br><pre> <code class="hljs xml">void makeRequests() { needAnotherCallData<span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SayHello_RPCtypes</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SayHelloCallData</span></span></span><span class="hljs-tag"> &gt;</span></span>(); needAnotherCallData<span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">GladToSeeMe_RPCtypes</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">GladToSeeMeCallData</span></span></span><span class="hljs-tag"> &gt;</span></span>(); needAnotherCallData<span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">GladToSeeYou_RPCtypes</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">GladToSeeYouCallData</span></span></span><span class="hljs-tag"> &gt;</span></span>(); needAnotherCallData<span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BothGladToSee_RPCtypes</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">BothGladToSeeCallData</span></span></span><span class="hljs-tag"> &gt;</span></span>(); }</code> </pre><br><p>  needAnotherCallDataå‡½æ•°çš„ç¬¬äºŒä¸ªæ¨¡æ¿å‚æ•°æ˜¯ç”Ÿæˆçš„RPCCallDataç»“æ„ã€‚ ç›¸åŒçš„ç»“æ„æ˜¯æ‰€ç”Ÿæˆçš„æœåŠ¡çš„Qtç±»ä¸­çš„ä¿¡å·å‚æ•°ã€‚ </p><br><p> ç”Ÿæˆçš„RPCCallDataç»“æ„ç»§æ‰¿è‡ªServerCallDataç±»ã€‚ åè¿‡æ¥ï¼ŒServerCallDataç±»æ˜¯ä»ServerResponderå“åº”å™¨ç»§æ‰¿çš„ã€‚ å› æ­¤ï¼Œåˆ›å»ºç›¸å¹²ç»“æ„çš„å¯¹è±¡ä¼šå¯¼è‡´åˆ›å»ºå“åº”è€…å¯¹è±¡ã€‚ </p><br><p>  ServerCallDataç±»çš„æ„é€ å‡½æ•°é‡‡ç”¨ä¸¤ä¸ªå‚æ•°ï¼šsignal_funcå’Œrequest_funcã€‚  signal_funcæ˜¯ç”Ÿæˆçš„ä¿¡å·ï¼Œåœ¨ä»é˜Ÿåˆ—ä¸­æ¥æ”¶åˆ°æ ‡ç­¾åå°†è°ƒç”¨è¯¥ä¿¡å·ã€‚  request_funcæ˜¯åˆ›å»ºæ–°å“åº”è€…æ—¶åº”è°ƒç”¨çš„å‡½æ•°ã€‚ ä¾‹å¦‚ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒå¯èƒ½æ˜¯RequestSayHelloï¼ˆï¼‰å‡½æ•°ã€‚  request_funcè°ƒç”¨å‘ç”Ÿåœ¨needAnotherCallDataï¼ˆï¼‰å‡½æ•°ä¸­ã€‚ è¿™æ ·åšæ˜¯ä¸ºäº†åœ¨æœåŠ¡ä¸­è¿›è¡Œå“åº”è€…çš„ç®¡ç†ï¼ˆåˆ›å»ºå’Œåˆ é™¤ï¼‰ã€‚ </p><br><p>  needAnotherCallDataï¼ˆï¼‰å‡½æ•°çš„ä»£ç åŒ…æ‹¬åˆ›å»ºå“åº”è€…å¯¹è±¡å’Œè°ƒç”¨å°†å“åº”è€…è¿æ¥åˆ°RPCè°ƒç”¨çš„å‡½æ•°ï¼š </p><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RPCCallData</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RPCTypes</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">void</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">needAnotherCallData</span></span></span><span class="hljs-class">() {</span></span> RPCCallData* cd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RPCCallData(); <span class="hljs-comment"><span class="hljs-comment">//... RequestRPC&lt;RPCTypes::kind, ...&gt; (service_, cd-&gt;request_func_, cd-&gt;responder, ..., (void*)cd); }</span></span></code> </pre><br><p>  RequestRPCï¼ˆï¼‰å‡½æ•°æ˜¯ç”¨äºå››ç§ç±»å‹çš„äº¤äº’çš„æ¨¡æ¿å‡½æ•°ã€‚ ç»“æœï¼Œè°ƒç”¨RequestRPCï¼ˆï¼‰å½’ç»“ä¸ºä¸€ä¸ªè°ƒç”¨ï¼š </p><br><pre> <code class="hljs lisp">service_-&gt;(<span class="hljs-name"><span class="hljs-name">cd-&gt;request_func_</span></span>)(...,cd-&gt;responder, (<span class="hljs-name"><span class="hljs-name">void*</span></span>)cd)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><p> å…¶ä¸­service_æ˜¯gRPCæœåŠ¡ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒæ˜¯pingpong :: ping :: AsyncServiceã€‚ </p><br><p> è‹¥è¦åŒæ­¥æˆ–å¼‚æ­¥æ£€æŸ¥äº‹ä»¶é˜Ÿåˆ—ï¼Œå¿…é¡»åˆ†åˆ«è°ƒç”¨CheckCQï¼ˆï¼‰æˆ–AsyncCheckCQï¼ˆï¼‰å‡½æ•°ã€‚  CheckCQï¼ˆï¼‰å‡½æ•°çš„ä»£ç å¯å½’ç»“ä¸ºä»é˜Ÿåˆ—ä¸­è°ƒç”¨åŒæ­¥æ ‡ç­¾ä»¥åŠå¯¹è¯¥æ ‡ç­¾çš„å¤„ç†ï¼š </p><br><pre> <code class="hljs pgsql">virtual <span class="hljs-type"><span class="hljs-type">void</span></span> CheckCQ() override { <span class="hljs-type"><span class="hljs-type">void</span></span>* tag; <span class="hljs-type"><span class="hljs-type">bool</span></span> ok; server_cq_-&gt;Next(&amp;tag, &amp;ok); //tagActions_ <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!tag) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; AbstractCallData* cd = (AbstractCallData*)tag; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!started_.<span class="hljs-keyword"><span class="hljs-keyword">load</span></span>()) { destroyCallData(cd); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } cd-&gt;cqReaction(this, ok); }</code> </pre><br><p> ä»é˜Ÿåˆ—æ¥æ”¶æ ‡ç­¾åï¼Œå°†æ£€æŸ¥æ ‡ç­¾çš„æœ‰æ•ˆæ€§å’ŒæœåŠ¡å™¨å¯åŠ¨ã€‚ å¦‚æœæœåŠ¡å™¨å·²å…³é—­ï¼Œåˆ™ä¸å†éœ€è¦è¯¥æ ‡ç­¾-å¯ä»¥å°†å…¶åˆ é™¤ã€‚ ä¹‹åï¼Œå°†è°ƒç”¨ServerCallDataç±»ä¸­å®šä¹‰çš„cqReactionï¼ˆï¼‰å‡½æ•°ï¼š </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cqReaction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> QGrpcServerService* service_, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ok)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!first_time_reaction_) { first_time_reaction_ = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; service_-&gt;needAnotherCallData&lt;RPC, RPCCallData&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> genRpcCallData = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;RPCCallData*&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* tag = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*&gt;(genRpcCallData); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;CouldBeDeleted()) { service_-&gt;destroyCallData(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;processEvent(tag, ok)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-comment"><span class="hljs-comment">//call generated service signal with generated call data argument service_-&gt;(*signal_func_)(genRpcCallData); }</span></span></code> </pre><br><p>  first_time_reaction_æ ‡å¿—æŒ‡ç¤ºæ‚¨éœ€è¦ä¸ºè¢«è°ƒç”¨çš„RPCåˆ›å»ºä¸€ä¸ªæ–°çš„å“åº”å™¨ã€‚ å‡½æ•°CouldBeDeletedï¼ˆï¼‰å’ŒProcessEventï¼ˆï¼‰ç»§æ‰¿è‡ªç›¸åº”çš„ServerResponderå“åº”å™¨ç±»ã€‚  CouldBeDeletedï¼ˆï¼‰å‡½æ•°è¿”å›ä¸€ä¸ªæ ‡å¿—ï¼Œè¡¨æ˜å¯ä»¥åˆ é™¤å“åº”ç¨‹åºå¯¹è±¡ã€‚  processEventï¼ˆï¼‰å‡½æ•°å¤„ç†æ ‡è®°å’Œokæ ‡å¿—ã€‚ å› æ­¤ï¼Œä¾‹å¦‚ï¼Œå¯¹äºå®¢æˆ·ç«¯æµç±»å‹çš„å“åº”è€…ï¼Œè¯¥å‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* tag, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ok</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;tag_ = tag; read_mode_ = ok; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br><p> æ— è®ºå“åº”å™¨çš„ç±»å‹å¦‚ä½•ï¼ŒProcessEventï¼ˆï¼‰å‡½æ•°å§‹ç»ˆè¿”å›trueã€‚ è¯¥å‡½æ•°çš„è¿”å›å€¼ä¿ç•™ä¸ºå¯èƒ½çš„åŠŸèƒ½æ‰©å±•ï¼Œå¹¶ä¸”ä»ç†è®ºä¸Šè®²ï¼Œæ˜¯ä¸ºäº†æ¶ˆé™¤é”™è¯¯ã€‚ </p><br><p> å¤„ç†äº‹ä»¶åï¼Œè°ƒç”¨å¦‚ä¸‹ï¼š <br><br></p><pre> <code class="hljs lisp">service_-&gt;(<span class="hljs-name"><span class="hljs-name">*signal_func_</span></span>)(<span class="hljs-name"><span class="hljs-name">genRpcCallData</span></span>)<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre><br><p> å˜é‡service_æ˜¯æ‰€ç”ŸæˆæœåŠ¡çš„å®ä¾‹ï¼Œåœ¨æœ¬ä¾‹ä¸­ä¸ºQpingServerServiceã€‚ å˜é‡signal_func_æ˜¯å¯¹åº”äºç‰¹å®šRPCçš„æœåŠ¡ä¿¡å·ã€‚ ä¾‹å¦‚ï¼ŒSayHelloRequestï¼ˆï¼‰ã€‚ å˜é‡genRpcCallDataæ˜¯ç›¸åº”ç±»å‹çš„å“åº”è€…å¯¹è±¡ã€‚ ä»è°ƒç”¨ä»£ç çš„è§’åº¦æ¥çœ‹ï¼Œå˜é‡genRpcCallDataæ˜¯æ‰€ç”Ÿæˆçš„RPCCallDataç»“æ„ä¹‹ä¸€çš„å¯¹è±¡ã€‚ <br></p><br><h2> å®¢æˆ·æ¶æ„ </h2><br><p> å®¢æˆ·ç«¯çš„ç±»å’ŒåŠŸèƒ½çš„åç§°å°½å¯èƒ½åŒ¹é…æœåŠ¡å™¨çš„ç±»å’ŒåŠŸèƒ½çš„åç§°ã€‚ å®¢æˆ·ç«¯ç±»å›¾å¦‚å›¾æ‰€ç¤ºã€‚ </p><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4u/ak/xe/4uakxee1iettn1zm_7fooerdosc.jpeg"></div><br><p> ç²—ç®­å¤´æ˜¾ç¤ºç±»ç»§æ‰¿çš„å±‚æ¬¡ç»“æ„ï¼Œç»†ç®­å¤´æ˜¾ç¤ºç±»ä¸­æˆå‘˜å’Œæ–¹æ³•çš„æˆå‘˜èµ„æ ¼ã€‚ é€šå¸¸ï¼Œå¯¹äºæœåŠ¡ï¼Œå°†ç”ŸæˆQ [servicename]ç±»ClientServiceï¼Œå…¶ä¸­servicenameæ˜¯.protoæ–‡ä»¶ä¸­å£°æ˜çš„æœåŠ¡çš„åç§°ã€‚  RPCCallDataæ˜¯ä¸ºæœåŠ¡ä¸­çš„æ¯ä¸ªRPCç”Ÿæˆçš„æ§åˆ¶ç»“æ„ã€‚ è¦è°ƒç”¨RPCï¼Œç”Ÿæˆçš„ç±»æä¾›åç§°ä¸.protoæ–‡ä»¶ä¸­å£°æ˜çš„RPCå®Œå…¨åŒ¹é…çš„å‡½æ•°ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œåœ¨.proto RPCæ–‡ä»¶ä¸­ï¼ŒSayHelloï¼ˆï¼‰å£°æ˜ä¸ºï¼š <br><br></p><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-function">rpc </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SayHello</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PingRequest</span></span></span><span class="hljs-function">) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">returns</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">PingReply</span></span></span><span class="hljs-function">)</span></span> {}</code> </pre><br><p> åœ¨ç”Ÿæˆçš„QpingClientServiceç±»ä¸­ï¼Œç›¸åº”çš„RPCå‡½æ•°å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="hljs vbscript">void SayHello(PingRequest <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!connected()) return; SayHelloCallData* <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SayHelloCallData; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">request</span></span> = <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>-&gt;responder = stub_-&gt;AsyncSayHello(&amp;<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>-&gt;context, <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>, &amp;cq_); <span class="hljs-keyword"><span class="hljs-keyword">call</span></span>-&gt;responder-&gt;Finish(&amp;<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>-&gt;reply, &amp;<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>-&gt;status, (void*)<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>); }</code> </pre><br><p> ä¸æœåŠ¡å™¨ä¸€æ ·ï¼Œç”Ÿæˆçš„RPCCallDataç»“æ„æœ€ç»ˆä»ClientResponderç±»ç»§æ‰¿ã€‚ å› æ­¤ï¼Œæ‰€ç”Ÿæˆç»“æ„çš„å¯¹è±¡çš„åˆ›å»ºå¯¼è‡´å“åº”è€…çš„åˆ›å»ºã€‚ åˆ›å»ºå“åº”è€…åï¼Œå°†è°ƒç”¨RPCï¼Œå¹¶å°†å“åº”è€…ä¸ä»æœåŠ¡å™¨æ¥æ”¶å“åº”çš„äº‹ä»¶ç›¸å…³è”ã€‚ åœ¨å®¢æˆ·ç«¯ä»£ç æ–¹é¢ï¼ŒRPCè°ƒç”¨å¦‚ä¸‹æ‰€ç¤ºï¼š </p><br><pre> <code class="hljs vbscript">void ToSayHello() { PingRequest <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.set_name(<span class="hljs-string"><span class="hljs-string">"user"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">request</span></span>.set_message(<span class="hljs-string"><span class="hljs-string">"user"</span></span>); pingPongSrv.SayHello(<span class="hljs-built_in"><span class="hljs-built_in">request</span></span>); }</code> </pre><br><p> ä¸ç”Ÿæˆçš„QpingServerServiceæœåŠ¡å™¨ç±»ä¸åŒï¼ŒQpingClientServiceç±»ä»ä¸¤ä¸ªæ¨¡æ¿ç±»ç»§æ‰¿ï¼šConnectivityFeatureså’ŒMonitorFeaturesã€‚ </p><br><p>  ConnectivityFeaturesç±»è´Ÿè´£å®¢æˆ·ç«¯-æœåŠ¡å™¨è¿æ¥çš„çŠ¶æ€ï¼Œå¹¶æä¾›ä¸‰ä¸ªä½¿ç”¨åŠŸèƒ½ï¼šgrpc_connectï¼ˆï¼‰ï¼Œgrpc_disconnectï¼ˆï¼‰ï¼Œgrpc_reconnectï¼ˆï¼‰ã€‚  grpc_disconnectï¼ˆï¼‰å‡½æ•°ä»…åˆ é™¤è´Ÿè´£ä¸æœåŠ¡å™¨äº¤äº’çš„æ‰€æœ‰æ•°æ®ç»“æ„ã€‚ å¯¹grpc_connectçš„è°ƒç”¨è¢«ç®€åŒ–ä¸ºå¯¹grpc_connect_ï¼ˆï¼‰å‡½æ•°çš„è°ƒç”¨ï¼Œè¯¥å‡½æ•°åˆ›å»ºæ§åˆ¶æ•°æ®ç»“æ„ï¼š </p><br><pre> <code class="hljs php">void grpc_connect_() { channel_ = grpc::CreateChannel(target_, creds_); stub_ = GRPCService::NewStub(channel_); channelFeatures_ = std::make_unique&lt;ChannelFeatures&gt;(channel_); channelFeatures_-&gt;checkChannelState(); }</code> </pre><br><p>  ChannelFeaturesç±»ç›‘è§†ä¸æœåŠ¡å™¨çš„<em>channel_</em>é€šé“é€šä¿¡çš„çŠ¶æ€ã€‚  ConnectivityFeaturesç±»å°è£…ChannelFeaturesç±»çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå¹¶ä½¿ç”¨æ­¤å¯¹è±¡å®ç°æŠ½è±¡åŠŸèƒ½channelStateï¼ˆï¼‰ï¼ŒcheckChannelStateï¼ˆï¼‰å’Œconnectedï¼ˆï¼‰ã€‚  channelStateï¼ˆï¼‰å‡½æ•°è¿”å›ä¸æœåŠ¡å™¨é€šä¿¡é€šé“çš„æœ€åè§‚å¯Ÿåˆ°çš„çŠ¶æ€ã€‚ å®é™…ä¸Šï¼ŒcheckChannelStateï¼ˆï¼‰å‡½æ•°è¿”å›é€šé“çš„å½“å‰çŠ¶æ€ã€‚  connectedï¼ˆï¼‰å‡½æ•°è¿”å›å®¢æˆ·ç«¯è¿æ¥åˆ°æœåŠ¡å™¨çš„æ ‡å¿—ã€‚ <br></p><br><p>  MonitorFeaturesç±»è´Ÿè´£ä»æœåŠ¡å™¨æ¥æ”¶å’Œå¤„ç†äº‹ä»¶ï¼Œå¹¶æä¾›CheckCQï¼ˆï¼‰å‡½æ•°ä»¥ä¾›ä½¿ç”¨ï¼š </p><br><pre> <code class="hljs ruby">bool CheckCQ() { auto service<span class="hljs-number"><span class="hljs-number">_</span></span> = dynamic_cast&lt; SERVICE* &gt;(this); <span class="hljs-regexp"><span class="hljs-regexp">//connection</span></span> state auto old_state = conn<span class="hljs-number"><span class="hljs-number">_</span></span>-&gt;channelState(); auto new_state = conn<span class="hljs-number"><span class="hljs-number">_</span></span>-&gt;checkChannelState(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (old_state != new_state) service-&gt;*channelStateChangedSignal<span class="hljs-number"><span class="hljs-number">_</span></span>(old_state, new_state); <span class="hljs-regexp"><span class="hljs-regexp">//end</span></span> of connection state void* tag; bool ok = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; grpc::CompletionQueue::NextStatus st; st = cq<span class="hljs-number"><span class="hljs-number">_</span></span>.AsyncNext(&amp;tag, &amp;ok, deadlineFromMSec(<span class="hljs-number"><span class="hljs-number">100</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((st == grpc::CompletionQueue::SHUTDOWN) <span class="hljs-params"><span class="hljs-params">||</span></span> (st == grpc::CompletionQueue::TIMEOUT)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; (AbstractCallData&lt; SERVICE &gt;*)(tag)-&gt;cqActions(service<span class="hljs-number"><span class="hljs-number">_</span></span>, ok); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; }</code> </pre><br><p> ä»£ç ç»“æ„ä¸æœåŠ¡å™¨çš„æƒ…å†µç›¸åŒã€‚ ä¸æœåŠ¡å™¨ä¸åŒï¼Œå°†è´Ÿè´£å¤„ç†å½“å‰çŠ¶æ€çš„ä»£ç å—æ·»åŠ åˆ°å®¢æˆ·ç«¯ã€‚ å¦‚æœé€šä¿¡é€šé“çš„çŠ¶æ€å·²æ›´æ”¹ï¼Œåˆ™ä¼šè°ƒç”¨ä¿¡å·channelStateChangedSignal_ï¼ˆï¼‰ã€‚ åœ¨æ‰€æœ‰ç”Ÿæˆçš„æœåŠ¡ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ªä¿¡å·ï¼š <br><br></p><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">channelStateChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span></span><span class="hljs-function">)</span></span>;</code> </pre><br> å¦å¤–ï¼Œä¸æœåŠ¡å™¨ä¸åŒï¼Œæ­¤å¤„ä½¿ç”¨AsyncNextï¼ˆï¼‰å‡½æ•°ä»£æ›¿Nextï¼ˆï¼‰ã€‚ è¿™æ ·åšæœ‰å‡ ä¸ªåŸå› ã€‚ é¦–å…ˆï¼Œå½“ä½¿ç”¨AsyncNextï¼ˆï¼‰æ—¶ï¼Œå®¢æˆ·ç«¯ä»£ç å…·æœ‰äº†è§£é€šä¿¡é€šé“çŠ¶æ€å˜åŒ–çš„èƒ½åŠ›ã€‚ å…¶æ¬¡ï¼Œå½“ä½¿ç”¨AsyncNextï¼ˆï¼‰æ—¶ï¼Œå¯ä»¥åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­å¤šæ¬¡è°ƒç”¨å„ç§RPCã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½¿ç”¨Nextï¼ˆï¼‰å‡½æ•°å°†é˜»å¡çº¿ç¨‹ï¼Œç›´åˆ°ä»é˜Ÿåˆ—æ¥æ”¶åˆ°äº‹ä»¶ä¸ºæ­¢ï¼Œç»“æœå°†ä¸¢å¤±æ‰€æè¿°çš„ä¸¤ä¸ªåŠŸèƒ½ã€‚ <br><br><p> ä¸æœåŠ¡å™¨ä¸€æ ·ï¼Œä»é˜Ÿåˆ—æ¥æ”¶äº‹ä»¶åï¼Œå°†è°ƒç”¨ClientCallDataç±»ä¸­å®šä¹‰çš„cqReactionï¼ˆï¼‰å‡½æ•°ï¼š </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cqActions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RPC::Service* service, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ok)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">auto</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;RPCCallData*&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* tag = <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*&gt;(response); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;processEvent(tag, ok)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; service-&gt;*func_( response ); }</code> </pre><br><p> ä¸æœåŠ¡å™¨ä¸€æ ·ï¼ŒprocessEventï¼ˆï¼‰å‡½æ•°å¤„ç†æ ‡è®°å’Œokæ ‡å¿—ï¼Œå¹¶å§‹ç»ˆè¿”å›trueã€‚ ä¸æœåŠ¡å™¨çš„æƒ…å†µä¸€æ ·ï¼Œåœ¨å¤„ç†äº‹ä»¶ä¹‹åï¼Œåº”è°ƒç”¨ç”Ÿæˆçš„æœåŠ¡çš„ä¿¡å·ã€‚ ä½†æ˜¯ï¼ŒåŒåæœåŠ¡å™¨åŠŸèƒ½æœ‰ä¸¤ä¸ªé‡è¦åŒºåˆ«ã€‚ ç¬¬ä¸€ä¸ªåŒºåˆ«æ˜¯æ²¡æœ‰åœ¨æ­¤åŠŸèƒ½ä¸­åˆ›å»ºå“åº”è€…ã€‚ å¦‚ä¸Šæ‰€ç¤ºï¼Œå“åº”è€…çš„åˆ›å»ºåœ¨è°ƒç”¨RPCæ—¶å‘ç”Ÿã€‚ ç¬¬äºŒä¸ªåŒºåˆ«æ˜¯æ­¤åŠŸèƒ½æœªåˆ é™¤å“åº”è€…ã€‚ ç”±äºä¸¤ä¸ªåŸå› ï¼Œæ²¡æœ‰åˆ é™¤å“åº”è€…ã€‚ é¦–å…ˆï¼Œå®¢æˆ·ç«¯ä»£ç å¯ä»¥å‡ºäºè‡ªèº«ç›®çš„ä½¿ç”¨æŒ‡å‘ç”Ÿæˆçš„RPCCallDataç»“æ„çš„æŒ‡é’ˆã€‚ ç”¨æ­¤æŒ‡é’ˆåˆ é™¤éšè—åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­çš„å†…å®¹å¯èƒ½å¯¼è‡´ä¸æ„‰å¿«çš„åæœã€‚ å…¶æ¬¡ï¼Œç§»é™¤å“åº”è€…å°†å¯¼è‡´ä»¥ä¸‹äº‹å®ï¼šå°†ä¸ä¼šç”Ÿæˆå¸¦æœ‰æ•°æ®çš„ä¿¡å·ã€‚ å› æ­¤ï¼Œå®¢æˆ·ç«¯ä»£ç å°†ä¸ä¼šæ”¶åˆ°æœ€åçš„æœåŠ¡å™¨æ¶ˆæ¯ã€‚ åœ¨è§£å†³æŒ‡ç¤ºé—®é¢˜çš„å‡ ç§é€‰æ‹©ä¸­ï¼Œå†³å®šå°†å“åº”è€…ï¼ˆç”Ÿæˆçš„ç»“æ„ï¼‰çš„ç§»é™¤è½¬ç§»åˆ°å®¢æˆ·ç«¯ä»£ç ã€‚ å› æ­¤ï¼Œä¿¡å·å¤„ç†ç¨‹åºåŠŸèƒ½ï¼ˆæ’æ§½ï¼‰å¿…é¡»åŒ…å«ä»¥ä¸‹ä»£ç ï¼š </p><br><pre> <code class="hljs cpp"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ResponseHandler</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(RPCCallData* response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response-&gt;CouldBeDeleted()) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> response; <span class="hljs-comment"><span class="hljs-comment">//process response }</span></span></code> </pre><br><p> å¦‚æœæ²¡æœ‰åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­åˆ é™¤å“åº”è€…ï¼Œåˆ™ä¸ä»…ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼Œè¿˜ä¼šå¯¼è‡´é€šä¿¡é€šé“å‡ºç°é—®é¢˜ã€‚ ç¤ºä¾‹ä»£ç ä¸­å®ç°äº†å„ç§RPCäº¤äº’çš„ä¿¡å·å¤„ç†ç¨‹åºã€‚ </p><br><h2> ç»“è®º </h2><br><p> æ€»ä¹‹ï¼Œæˆ‘ä»¬æè¯·æ³¨æ„ä¸¤ç‚¹ã€‚ ç¬¬ä¸€ç‚¹ä¸è°ƒç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨çš„CheckCQï¼ˆï¼‰å‡½æ•°æœ‰å…³ã€‚ å¦‚ä¸Šæ‰€ç¤ºï¼Œå®ƒä»¬æŒ‰ç…§ä¸€ç§åŸç†å·¥ä½œï¼šå¦‚æœé˜Ÿåˆ—ä¸­æœ‰äº‹ä»¶ï¼Œåˆ™ä¼šå‘å‡ºå…·æœ‰ç›¸åº”ç”Ÿæˆçš„RPCCallDataç»“æ„çš„ä¿¡å·ã€‚ æ‚¨å¯ä»¥æ‰‹åŠ¨è°ƒç”¨æ­¤å‡½æ•°å¹¶æ£€æŸ¥ï¼ˆå¯¹äºå®¢æˆ·ç«¯ï¼‰äº‹ä»¶ã€‚ ä½†æ˜¯æœ€åˆæœ‰ä¸€ä¸ªæƒ³æ³•å°†ä¸gRPCç›¸å…³çš„æ•´ä¸ªç½‘ç»œéƒ¨åˆ†è½¬ç§»åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ã€‚ ä¸ºæ­¤ï¼Œç¼–å†™äº†ç”¨äºgRPCæœåŠ¡å™¨çš„è¾…åŠ©ç±»QGrpcSrvMonitorå’Œç”¨äºgRPCå®¢æˆ·ç«¯çš„QGrpcCliServerã€‚ è¿™ä¸¤ä¸ªç±»çš„å·¥ä½œåŸç†ç›¸åŒï¼šå®ƒä»¬åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æµï¼Œå°†ç”Ÿæˆçš„æœåŠ¡æ”¾å…¥æ­¤æµä¸­ï¼Œå¹¶å®šæœŸè°ƒç”¨æ­¤æœåŠ¡çš„CheckCQï¼ˆï¼‰å‡½æ•°ã€‚ å› æ­¤ï¼Œå½“ä½¿ç”¨ä¸¤ä¸ªè¾…åŠ©ç±»æ—¶ï¼Œæ— éœ€åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­è°ƒç”¨CheckCQï¼ˆï¼‰å‡½æ•°ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”Ÿæˆçš„æœåŠ¡çš„ä¿¡å·â€œæ¥è‡ªâ€å¦ä¸€ä¸ªæµã€‚ ä½¿ç”¨è¿™äº›å¸®åŠ©ç¨‹åºç±»æ¥å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç¤ºä¾‹ã€‚ </p><br><p> ç¬¬äºŒç‚¹æ¶‰åŠå¤§å¤šæ•°åœ¨å·¥ä½œä¸­ä¸ä½¿ç”¨Qtåº“çš„å¼€å‘äººå‘˜ã€‚  QgRPCä¸­çš„Qtç±»å’Œå®ä»…åœ¨ä¸¤ä¸ªåœ°æ–¹ä½¿ç”¨ï¼šåœ¨ç”Ÿæˆçš„æœåŠ¡æ–‡ä»¶ä¸­ä»¥åŠåœ¨åŒ…å«è¾…åŠ©ç±»çš„æ–‡ä»¶ä¸­ï¼šQGrpcServerMonitor.hå’ŒQGrpcClientMonitor.hã€‚ ä¸Qtåº“çš„å…¶ä½™æ–‡ä»¶æ²¡æœ‰ä»»ä½•å…³è”ã€‚ è®¡åˆ’ä½¿ç”¨cmakeæ·»åŠ ç¨‹åºé›†ï¼Œå¹¶æ·»åŠ ä¸€äº›QtæŒ‡ä»¤ã€‚ ç‰¹åˆ«æ˜¯QObjectç±»å’ŒQ_OBJECTå®ã€‚ ä½†æ˜¯ï¼Œäººä»¬å¯¹æ­¤ä¸€æ— æ‰€çŸ¥ã€‚ å› æ­¤ï¼Œæ¬¢è¿æå‡ºä»»ä½•å»ºè®®ã€‚ </p><br><p> ä»…æ­¤è€Œå·²ã€‚ è°¢è°¢å¤§å®¶ï¼ </p><br><h2> å‚è€ƒæ–‡çŒ® </h2><br><ul><li><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">å¸¦æœ‰QgRPCä»£ç çš„å­˜å‚¨åº“</a> </p></li><li><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">C ++ä¸­çš„å¼‚æ­¥gRPC</a> </p></li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN420237/">https://habr.com/ru/post/zh-CN420237/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN420225/index.html">åŸºäºç´ æ•°çš„æ— é™ç®—æ³•æ—‹å¾‹</a></li>
<li><a href="../zh-CN420227/index.html">åœŸè€³å…¶æ€»ç»Ÿå®£å¸ƒç¦æ­¢ç¾å›½è¿›å£ç”µå­äº§å“</a></li>
<li><a href="../zh-CN420229/index.html">å¦‚æœé™„è¿‘çš„å­©å­ä»¬åªæ•™é“è·¯å·¥äººï¼Œä»–ä»¬å¯ä»¥æˆä¸ºç¨‹åºå‘˜å—ï¼Ÿ ä¸â€œåœˆå­â€çš„å¯¹è¯</a></li>
<li><a href="../zh-CN420233/index.html">UE4 | å¤šäººæ¸¸æˆè£…å¤‡ï¼ƒ5 | æœåŠ¡å™¨ä¸å®¢æˆ·ç«¯ä¹‹é—´çš„ä¿¡æ¯ä¼ è¾“</a></li>
<li><a href="../zh-CN420235/index.html">Zenjectï¼šIoCå®¹å™¨å¦‚ä½•æ€æ­»é¡¹ç›®çš„ä¾èµ–æ³¨å…¥</a></li>
<li><a href="../zh-CN420239/index.html">ç§»åŠ¨å¼€å‘ã€‚ Swiftï¼šåè®®ä¹‹è°œ</a></li>
<li><a href="../zh-CN420243/index.html">çªç ´æ€§æ…ˆå–„äº‹ä¸šï¼šäººé“ä¸»ä¹‰çªç ´æ€§é¡¹ç›®</a></li>
<li><a href="../zh-CN420245/index.html">ä½¿ç”¨Javaé›†åˆæ—¶å¦‚ä½•é˜²æ­¢å†…å­˜æº¢å‡º</a></li>
<li><a href="../zh-CN420251/index.html">è‹¹æœç§°è¯¥å…¬å¸æ€»éƒ¨å¤§æ¥¼ä»…éœ€200ç¾å…ƒ</a></li>
<li><a href="../zh-CN420253/index.html">å¼€æ”¾é“¶è¡ŒAPIå¦‚ä½•æ”¹å˜é‡‘èä¸–ç•Œ</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>