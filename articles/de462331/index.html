<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¥üèª üëµüèª üó®Ô∏è GAZ-66 Spielzeug auf dem Bedienfeld. Teil 2 ü•û üíÖüèª ‚ôªÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In diesem Teil werden wir √ºber die Softwarekomponente sprechen, wie die Maschine zum Leben erweckt wurde. Welches Betriebssystem wurde verwendet, welc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>GAZ-66 Spielzeug auf dem Bedienfeld. Teil 2</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/462331/"><p><img src="https://habrastorage.org/webt/ix/tf/mx/ixtfmxmnpt-9rkvbc2kqpdtol2c.jpeg" alt="Bild"></p><br><p>  In diesem Teil werden wir √ºber die Softwarekomponente sprechen, wie die Maschine zum Leben erweckt wurde.  Welches Betriebssystem wurde verwendet, welche Sprache wurde gew√§hlt, mit welchen Problemen war es konfrontiert? </p><a name="habracut"></a><br><h3 id="1-kak-rabotaet-v-2-h-slovah">  1. Wie es in 2 Worten funktioniert </h3><br><p>  Das System besteht aus einem Server, der auf einer Schreibmaschine installiert ist, und einem Client, der auf der Konsole installiert ist.  Der Server erh√∂ht den <strong>WLAN-</strong> Zugangspunkt und wartet, bis der Client eine Verbindung herstellt.  Der Server f√ºhrt Clientbefehle aus und √ºbertr√§gt auch Videos von der Kamera an die Kamera. </p><br><h3 id="2-os">  2. Betriebssystem </h3><br><p>  Lassen Sie uns nun √ºber die verwendeten Betriebssysteme sprechen. </p><br><p>  Da das gesamte System auf <strong>Raspberry pi 3</strong> basiert, wurde das offizielle Betriebssystem daf√ºr verwendet.  Zum Zeitpunkt der Erstellung war die neueste Version <strong>Stretch</strong> . Sie wurde und wurde f√ºr die Verwendung auf einer Schreibmaschine und einem Bedienfeld ausgew√§hlt.  Es stellte sich jedoch heraus, dass es einen Fehler gibt (der eine Woche lang gequ√§lt wurde), aufgrund dessen es unm√∂glich ist, den WLAN-Zugangspunkt zu erh√∂hen.  Um den Zugangspunkt zu erh√∂hen, wurde daher eine fr√ºhere Version von <strong>Jessie verwendet</strong> , die keine derartigen Probleme aufwies. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Artikel, wie man einen Zugangspunkt erh√∂ht.</a>  Sehr detailliert, habe alles drauf gemacht. </p><br><p>  Die Fernbedienung stellt automatisch eine Verbindung zum Ger√§t her, wenn der Zugangspunkt angehoben wird. <br>  Automatische Verbindung zu unserem Punkt, in der Datei <strong>/ etc / network / interfaces</strong> hinzuf√ºgen: </p><br><pre><code class="plaintext hljs">auto wlan0 iface wlan0 inet dhcp wpa-ssid {ssid} wpa-psk {password}</code> </pre> <br><h3 id="2-yazyk">  2. Sprache </h3><br><p>  Ich habe <strong>Python gew√§hlt,</strong> weil es einfach und unkompliziert ist. </p><br><h3 id="3-server">  3. Server </h3><br><p>  Mit Server in diesem Abschnitt meine ich Software, die von mir geschrieben wurde, um die Maschine zu steuern und mit Video zu arbeiten. </p><br><p>  Der Server besteht aus 2 Teilen.  Videoserver und Verwaltungsserver. </p><br><h3 id="31-video-server">  3.1 Videoserver </h3><br><p>  Es gab zwei M√∂glichkeiten, mit einer Videokamera zu arbeiten.  1. Verwenden Sie das <strong>Picamera-</strong> Modul und 2. Verwenden Sie die <strong>mjpg-Streamer-Software</strong> .  Ohne nachzudenken, entschied ich mich, beide zu verwenden und welche in den Konfigurationseinstellungen zu verwenden. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> conf.conf.VideoServerType == <span class="hljs-string"><span class="hljs-string">'m'</span></span> : cmd = <span class="hljs-string"><span class="hljs-string">"cd /home/pi/projects/mjpg-streamer-experimental &amp;&amp; "</span></span> cmd += <span class="hljs-string"><span class="hljs-string">'./mjpg_streamer -o "./output_http.so -p {0} -w ./www" -i "./input_raspicam.so -x {1} -y {2} -fps 25 -ex auto -awb auto -vs -ISO 10"'</span></span>.format(conf.conf.videoServerPort, conf.conf.VideoWidth, conf.conf.VideoHeight) print(cmd) os.system(cmd) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> picamera.PiCamera(resolution = str(conf.conf.VideoWidth) + <span class="hljs-string"><span class="hljs-string">'x'</span></span> + str(conf.conf.VideoHeight) , framerate = conf.conf.VideoRate) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> Camera: output = camera.StreamingOutput() camera.output = output Camera.start_recording(output, format = <span class="hljs-string"><span class="hljs-string">'mjpeg'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: address = (conf.conf.ServerIP, conf.conf.videoServerPort) server = camera.StreamingServer(address, camera.StreamingHandler) server.serve_forever() <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span>: Camera.stop_recording()</code> </pre> <br><p>  Da sie dieselben Einstellungen vornehmen, arbeiten sie an derselben Adresse.  Es gibt keine Probleme bei der Kommunikation mit der Fernbedienung, wenn Sie von einer zur anderen wechseln.  Das einzige, was ich denke, <strong>mjpg-Streamer</strong> funktioniert schneller. </p><br><h3 id="32-server-upravleniya">  3.2 Management Server </h3><br><h4 id="321-vzaimodeystvie-mezhdu-klientom-i-serverom">  3.2.1 Interaktion zwischen Client und Server </h4><br><p>  Die Server- und Client-Austauschbefehle in Form von JSON-Zeichenfolgen: </p><br><pre> <code class="python hljs">{<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Start'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.0</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'Y'</span></span>, <span class="hljs-string"><span class="hljs-string">'status'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, <span class="hljs-string"><span class="hljs-string">'val'</span></span>: <span class="hljs-number"><span class="hljs-number">0.5</span></span>} {<span class="hljs-string"><span class="hljs-string">'type'</span></span>: <span class="hljs-string"><span class="hljs-string">'remote'</span></span>, <span class="hljs-string"><span class="hljs-string">'cmd'</span></span>: <span class="hljs-string"><span class="hljs-string">'turn'</span></span>, <span class="hljs-string"><span class="hljs-string">'x'</span></span>: <span class="hljs-number"><span class="hljs-number">55</span></span>, <span class="hljs-string"><span class="hljs-string">'y'</span></span>: <span class="hljs-number"><span class="hljs-number">32</span></span>}</code> </pre> <br><ul><li>  Typ - 'Remote' oder 'Auto', je nachdem, wer den Befehl sendet (Client oder Server) </li><li>  cmd - eine Zeichenfolge mit dem Namen der Schaltfl√§che, der dem Namen der Schaltfl√§che auf dem <strong>Game HAT entspricht</strong> , zum Beispiel: <br><ul><li>  Start - Schaltfl√§che Start </li><li>  Ausw√§hlen - Schaltfl√§che Ausw√§hlen </li><li>  Y - Y Taste </li><li>  usw. </li><li>  drehen - Der Befehl zum √Ñndern des Status des Joysticks ist f√ºr das Drehen der R√§der verantwortlich </li></ul></li><li>  status - Richtig oder falsch, je nachdem, ob die Taste gedr√ºckt wird oder nicht.  Ein Schaltfl√§chenstatusereignis wird jedes Mal ausgel√∂st, wenn sich sein Status √§ndert. </li><li>  Wert - Drehzahl und Bewegungsrichtung des Motors von -1 ... 1, Wert vom Typ <strong>Schwimmer</strong> .  Wichtiger Parameter nur f√ºr Bewegungstasten. </li><li>  x - Abweichung des Joysticks entlang der x-Achse von -100 ... 100, Wert vom Typ <strong>int</strong> </li><li>  y - Abweichung des Joysticks entlang der y-Achse von -100 ... 100, Wert vom Typ <strong>int</strong> </li></ul><br><p>  Als n√§chstes kommt meine Schande, zu wiederholen, welche H√§nde nicht erreichen.  Der Computer l√∂st den Server-Socket aus und wartet, bis der Client eine Verbindung hergestellt hat.  Dar√ºber hinaus wird f√ºr jede neue Verbindung ein separater Stream erstellt, und jeder neue Client, der eine Verbindung zum Computer herstellt, kann ihn steuern.  Dies kann nicht so weit sein, weil niemand sonst eine solche Fernbedienung hat und ich mein geschlossenes WLAN-Netzwerk erh√∂he. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> TCP_IP = conf.conf.ServerIP TCP_PORT = conf.conf.controlServerPort BUFFER_SIZE = conf.conf.ServerBufferSize self.tcpServer = socket.socket(socket.AF_INET, socket.SOCK_STREAM) self.tcpServer.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="hljs-number"><span class="hljs-number">1</span></span>) self.tcpServer.bind((TCP_IP, TCP_PORT)) threads = [] <span class="hljs-comment"><span class="hljs-comment">#     . self.tcpServer.listen(1) while True: print("Car server up : Waiting for connections from TCP clients...") (conn, (ip, port)) = self.tcpServer.accept() newthread = ClientThread(conn, ip, port) newthread.start() self.threads.append(newthread)</span></span></code> </pre> <br><h4 id="322-upravlenie-zhelezom">  3.2.2 Eisenmanagement </h4><br><p>  Bei der Arbeit mit Raspberry wurde das Pin-Nummerierungssystem <strong>GPIO.BCM</strong> verwendet. </p><br><p>  <strong>Das Licht wird</strong> √ºber GPIO 17 gesteuert und an den 2. Pin von <strong>L293 angeschlossen</strong> .  Als n√§chstes enth√§lt der Befehl jedes Mal Folgendes: </p><br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.HIGH)</code> </pre> <br><pre> <code class="python hljs">GPIO.output(self.gpioLight, GPIO.LOW)</code> </pre> <br><p>  entsprechende Befehle werden aufgerufen. </p><br><p>  <strong>Der Servoantrieb</strong> wird √ºber die <strong>PCA9685-Karte</strong> √ºber den I2C-Bus <strong>gesteuert</strong> , daher ben√∂tigen wir die entsprechende Bibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adafruit_PCA9685</a> .  PCA9685 ist √ºber 7-polig mit dem Servo verbunden.  Die erforderliche PWM-Frequenz f√ºr die Arbeit mit Servo betr√§gt 50 Hz oder eine Periode von 20 ms. </p><br><p>  Das Funktionsprinzip des Servos: </p><br><p><img src="https://habrastorage.org/webt/h2/z-/ns/h2z-nsefbtnvntcwbmmt9qoikjc.jpeg" alt="Bild"></p><br><p>  Wenn ein 1,5-ms-Signal angelegt wird, werden die R√§der zentriert.  Bei 1 ms.  Das Servo dreht sich 2 ms lang bis nach rechts.  so weit wie m√∂glich nach links.  Die Achsschenkel in Br√ºcken f√ºr solche Kurven sind nicht ausgelegt, daher musste der Drehwinkel experimentell ausgew√§hlt werden. </p><br><p>  Werte, die an die Adafruit_PCA9685-API √ºbergeben werden k√∂nnen, reichen von 0..4095, 0 kein Signal, 4095 voll.  Dementsprechend mussten aus diesem Bereich die f√ºr meine R√§der geeigneten Werte ausgew√§hlt werden.  Der einfachste Weg, die Werte f√ºr genau eingestellte R√§der zu bestimmen, besteht darin, 1,5 ms auf einen Wert aus dem Bereich von ~ 307 zu √ºbertragen. </p><br><p>  Der Maximalwert f√ºr rechts betr√§gt 245, f√ºr links 369. </p><br><p>  Die vom Joystick kommenden Werte haben Werte von -100 ... 100, daher mussten sie im Bereich von 245 bis 369 √ºbersetzt werden. Auch hier ist die Mitte am einfachsten, wenn 0 307 ist. Links und rechts gem√§√ü der Formel: </p><br><pre> <code class="python hljs">val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero))</code> </pre> <br><ul><li>  HardwareSetting._turnCenter - 307 </li><li>  Turn - Wert vom Joystick von -100 ... 100 </li><li>  HardwareSetting._turnDelta - 62, die Differenz zwischen der Mitte und der maximalen Abweichung zur Seite (307 - 245 = 62) </li><li>  HardwareSetting.yZero - 100, der vom Joystick empfangene Maximalwert </li></ul><br><p>  R√§der gerade: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnCenter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Biegen Sie links ab: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnLeft</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  Biegen Sie rechts ab: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">turnRight</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, turn)</span></span></span><span class="hljs-function">:</span></span> val = int(HardwareSetting._turnCenter + (<span class="hljs-number"><span class="hljs-number">-1</span></span> * turn * HardwareSetting._turnDelta / HardwareSetting.yZero)) self.pwm_servo.set(val) CarStatus.statusCar[<span class="hljs-string"><span class="hljs-string">'car'</span></span>][<span class="hljs-string"><span class="hljs-string">'turn'</span></span>] = val</code> </pre> <br><p>  <strong>Die Motorsteuerung</strong> erfolgt auch √ºber die <strong>PCA9685-Karte</strong> √ºber den I2C-Bus, daher verwenden wir <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adafruit_PCA9685</a> .  Die Pins 10 bis 15 des PCA9685 sind mit dem L298N verbunden (ich verwende 2 Kan√§le, um Strom zu absorbieren).  10 und 11 an ENA und ENB (ich f√ºlle sie mit PWM, um die Geschwindigkeit zu steuern).  12, 13, 14, 15 bis IN1, IN2, IN3, IN4 - sind f√ºr die Drehrichtung des Motors verantwortlich.  Die PWM-Frequenz ist hier nicht sehr wichtig, aber ich verwende auch 50 Hertz (mein Standardwert). </p><br><p>  Die Maschine steht still: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><p>  Weiter geht's: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">back</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH)</code> </pre> <br><p>  R√ºckw√§rtsbewegung: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">forward</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, speed)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">"""  . Args: speed:     0  1. """</span></span> self.pwm.set_pwm(self.ena, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.enb, <span class="hljs-number"><span class="hljs-number">0</span></span>, int(speed * self.HIGH)) self.pwm.set_pwm(self.in1, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in4, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.HIGH) self.pwm.set_pwm(self.in2, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW) self.pwm.set_pwm(self.in3, <span class="hljs-number"><span class="hljs-number">0</span></span>, self.LOW)</code> </pre> <br><h3 id="4-klient">  4. Kunde </h3><br><h3 id="41-klaviatura">  4.1 Tastatur </h3><br><p>  Es gab bestimmte Probleme mit ihr, zuerst wollte ich sie ereignisreich machen (es dauerte ~ 2 Wochen der Qual).  Aber die mechanischen Tasten trugen dazu bei, das Klappern der Kontakte f√ºhrte zu st√§ndigen und unvorhersehbaren Fehlern (die von mir erfundenen Steueralgorithmen funktionierten einwandfrei).  Dann erz√§hlte mir mein Kollege, wie die Tastaturen hergestellt werden.  Und ich habe beschlossen, dasselbe zu tun. Jetzt frage ich alle 0,005 Sekunden den Status ab (warum und wer wei√ü).  Und wenn es sich ge√§ndert hat, senden Sie den Wert an den Server. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pin <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.pins : p = self.pins[pin] status = p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> GPIO.input(pin) == GPIO.HIGH : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> p[<span class="hljs-string"><span class="hljs-string">'status'</span></span>] != status : p[<span class="hljs-string"><span class="hljs-string">'callback'</span></span>](pin) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> KeyboardInterrupt: GPIO.cleanup()</code> </pre><br><h3 id="42-dzhoystik">  4.2 Joystick </h3><br><p>  <strong>Das Lesen der Messwerte</strong> erfolgt √ºber die <strong>ADS1115-Karte</strong> √ºber den I2C-Bus. Daher ist die entsprechende Bibliothek <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Adafruit_PCA9685</a> .  Der Joystick neigt auch dazu, Kontakte zu klappern, daher nehme ich ihn analog zur Tastatur ab. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: X = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">0</span></span>, gain=self.GAIN) / HardwareSetting.valueStep Y = self.adc.read_adc(<span class="hljs-number"><span class="hljs-number">1</span></span>, gain=self.GAIN) / HardwareSetting.valueStep <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> X &gt; HardwareSetting.xZero : X = X - HardwareSetting.xZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : X = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.xZero - X) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Y &gt; HardwareSetting.yZero : Y = Y - HardwareSetting.yZero <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> : Y = <span class="hljs-number"><span class="hljs-number">-1</span></span> * (HardwareSetting.yZero - Y) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(X) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : X = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(Y) &lt; <span class="hljs-number"><span class="hljs-number">5</span></span>) : Y = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (abs(self.x - X) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> abs(self.y - Y) &gt;= <span class="hljs-number"><span class="hljs-number">1.0</span></span>) : self.sendCmd(round(X), round(Y)) self.x = X self.y = Y time.sleep(<span class="hljs-number"><span class="hljs-number">0.005</span></span>)</code> </pre> <br><p>  Bei einer Stromversorgung von 3,3 Volt reicht der Wertebereich, den der ADS1115 mit einem Joystick ausgibt, von 0 bis 26500 aus.  Ich bringe dies in den Bereich von -100 ... 100.  In meinem Bereich um 0 schwankt es immer. Wenn die Werte also 5 nicht √ºberschreiten, denke ich, dass es 0 ist (sonst wird es √ºberfluten).  Sobald sich die Werte √§ndern, senden Sie sie an die Schreibmaschine. </p><br><h3 id="43-podklyuchenie-k-serveru-upravleniya">  4.3 Verbindung zum Verwaltungsserver herstellen </h3><br><p>  Das Herstellen einer Verbindung zum Server ist eine einfache Sache: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> : tcpClient = socket.socket(socket.AF_INET, socket.SOCK_STREAM) tcpClient.settimeout(<span class="hljs-number"><span class="hljs-number">2.0</span></span>) tcpClient.connect((conf.conf.ServerIP, conf.conf.controlServerPort)) self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"+"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> self.tcpClient = tcpClient <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> socket.error <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: self.signalDisplayPrint.emit(<span class="hljs-string"><span class="hljs-string">"-"</span></span>) carStatus.statusRemote[<span class="hljs-string"><span class="hljs-string">'network'</span></span>][<span class="hljs-string"><span class="hljs-string">'control'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> time.sleep(conf.conf.timeRecconect) self.tcpClient = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.tcpClient : self.tcpClient.settimeout(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>)</code> </pre> <br><p>  Aber ich m√∂chte auf eine Sache achten.  Wenn Sie in der Verbindung kein Timeout verwenden, kann es einfrieren und Sie m√ºssen einige Minuten warten (dies geschieht, wenn der Client vor dem Server gestartet wurde).  Ich habe dies folgenderma√üen gel√∂st und das Zeitlimit f√ºr die Verbindung festgelegt.  Sobald die Verbindung hergestellt ist, entferne ich das Timeout. </p><br><p>  Ich speichere auch den Status der Verbindung, damit ich wei√ü, ob die Kontrolle verloren geht, und zeige sie auf dem Bildschirm an. </p><br><h3 id="44-proverka-podklyucheniya-k-wifi">  4.4 WLAN-Verbindung √ºberpr√ºfen </h3><br><p>  Ich √ºberpr√ºfe den Status von WLAN f√ºr die Verbindung zum Server.  Und wenn, dann melde ich mich auch √ºber Probleme. </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: time.sleep(<span class="hljs-number"><span class="hljs-number">1.0</span></span>) self.ps = subprocess.Popen([<span class="hljs-string"><span class="hljs-string">'iwgetid'</span></span>], stdout=subprocess.PIPE, stderr=subprocess.STDOUT) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: output = subprocess.check_output((<span class="hljs-string"><span class="hljs-string">'grep'</span></span>, <span class="hljs-string"><span class="hljs-string">'ESSID'</span></span>), stdin=self.ps.stdout) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> re.search(<span class="hljs-string"><span class="hljs-string">r'djvu-car-pi3'</span></span>, str(output)) : self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi+'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> subprocess.CalledProcessError: <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span> self.sendStatus(<span class="hljs-string"><span class="hljs-string">'wifi-'</span></span>) self.ps.kill()</code> </pre> <br><h3 id="45-podklyuchenie-k-video-serveru">  4.5 Verbindung zu einem Videoserver herstellen </h3><br><p>  Daf√ºr wurde die ganze Leistung von <strong>Qt5 ben√∂tigt</strong> , √ºbrigens auf der <strong>Stretch-</strong> Distribution ist es neuer und zeigt meiner Meinung nach besser.  auf <strong>jessie habe</strong> ich es auch versucht. </p><br><p>  F√ºr die Anzeige habe ich verwendet: </p><br><pre> <code class="python hljs">self.videoWidget = QVideoWidget()</code> </pre> <br><p>  Und er folgerte: </p><br><pre> <code class="python hljs">self.mediaPlayer = QMediaPlayer(<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>, QMediaPlayer.LowLatency) self.mediaPlayer.setVideoOutput(self.videoWidget)</code> </pre> <br><p>  Verbindung zum Streaming von Videos: </p><br><pre> <code class="python hljs">self.mediaPlayer.setMedia(QMediaContent(QUrl(<span class="hljs-string"><span class="hljs-string">"http://{}:{}/?action=stream"</span></span>.format(conf.conf.ServerIP, conf.conf.videoServerPort)))) self.mediaPlayer.play()</code> </pre> <br><p>  Ich entschuldige mich noch einmal f√ºr die Tautologie.  Ich √ºberwache den Status der Videoverbindung auf Verbindung zum Videoserver.  Und wenn, dann melde ich mich auch √ºber Probleme. </p><br><p>  So sieht es aus, wenn nicht alles funktioniert: </p><br><p><img src="https://habrastorage.org/webt/ea/6a/ug/ea6augn3vrdv3ejjom8v6qrnpvu.jpeg" alt="Bild"></p><br><ul><li>  <strong>W</strong> - bedeutet, dass keine Verbindung mit WLAN besteht </li><li>  <strong>B</strong> - bedeutet kein Video </li><li>  <strong>Y</strong> - bedeutet, dass es keine Kontrolle gibt </li></ul><br><p>  Ansonsten gibt es keine roten Buchstaben, es gibt ein Video von der Kamera.  Ich werde in Zukunft ein Foto und ein Video mit der Arbeit ver√∂ffentlichen. Ich hoffe, dass die Halterung f√ºr die Kamera in naher Zukunft kommt und ich sie endlich normal anbringen werde. </p><br><h3 id="5-nastroyka-raspberry-os">  5 Konfigurieren des Raspberry-Betriebssystems </h3><br><p>  √úbrigens muss die Arbeit mit der Kamera und anderen notwendigen Dingen eingeschaltet sein (sowohl auf dem Client als auch auf dem Server).  Nach dem Laden des Betriebssystems: </p><br><p><img src="https://habrastorage.org/webt/ex/ye/gz/exyegz24x9ec0ee0cdp7qpm5kog.jpeg" alt="Bild"></p><br><p>  Und schalten Sie fast alles ein: Kamera, SSH, i2c, GPIO </p><br><p><img src="https://habrastorage.org/webt/ye/fu/z4/yefuz4_ioqh5g1j_f1n1mgwf_cg.png" alt="Bild"></p><br><h3 id="demonstraciya">  Demonstration </h3><br><p>  Es gibt nur einen Videokanal (die Kamera bleibt in Betrieb).  Ich entschuldige mich f√ºr seine Abwesenheit, ich werde es am Montag anh√§ngen. </p><br><img alt="Spielhut" width="400" src="https://habrastorage.org/webt/5q/yt/ox/5qytoxmp0ojxi7bheduksv8qipg.jpeg"><br><p>  Videoarbeit: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/D6ZT90L6q00" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3 id="ishodnye-kody">  Quellcode </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Server- und Client-Quellcode</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Startpaket f√ºr den Daemon-Server</a> </p><br><h3 id="ssylki">  Referenzen </h3><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 1</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 3</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de462331/">https://habr.com/ru/post/de462331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de462321/index.html">Internationales SEO | Internationale SEO-Ranking-Faktoren</a></li>
<li><a href="../de462323/index.html">Fettleibigkeit - Entspannen und einbeziehen</a></li>
<li><a href="../de462325/index.html">Web Worker einfacher als Sie dachten</a></li>
<li><a href="../de462327/index.html">Quietschen eines Krebstumors: Wissenschaftler von NUST ‚ÄûMISiS‚Äú haben einen Laser-Ultraschall zur Diagnose von Krebs entwickelt</a></li>
<li><a href="../de462329/index.html">Bewegen Sie das Netzteil zur Vorderseite des Geh√§uses</a></li>
<li><a href="../de462333/index.html">Erstellen eines einfachen Chatbots f√ºr Konversationen in Python</a></li>
<li><a href="../de462335/index.html">Nicht lesen, erneut lesen</a></li>
<li><a href="../de462337/index.html">Site-Statistiken und Ihr kleines Repository</a></li>
<li><a href="../de462339/index.html">Wie h√§ngen Handheld-Schulungen mit den internen Standards von Amazon zusammen und wie hat sich dies auf das Weltbild des Unternehmens ausgewirkt?</a></li>
<li><a href="../de462347/index.html">Die ersten zehn Tage auf dem Weg von einer Eule zu einem Fr√ºhaufsteher: Schlaf, Di√§t, Di√§t und Bewegung</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>