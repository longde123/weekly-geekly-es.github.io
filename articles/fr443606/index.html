<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëçüèæ ‚ÅâÔ∏è üì∫ Jenkins pour Android build utilisant docker üßíüèæ ü•ì ü§∑üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour √† tous! 

 Je travaille en tant que d√©veloppeur Android, et il n'y a pas si longtemps, nous avons rencontr√© des t√¢ches de routine sur notre pr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Jenkins pour Android build utilisant docker</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/443606/">  Bonjour √† tous! <br><br>  Je travaille en tant que d√©veloppeur Android, et il n'y a pas si longtemps, nous avons rencontr√© des t√¢ches de routine sur notre projet que nous aimerions automatiser.  Par exemple, nous avons 5 saveurs diff√©rentes, pour chacune desquelles nous devons t√©l√©charger notre build sur fabric, parfois pour diff√©rents chariots plusieurs fois par jour.  Oui, cette t√¢che peut √™tre effectu√©e avec une t√¢che gradle, mais je voudrais ne pas ex√©cuter ce processus sur la machine du d√©veloppeur, mais le faire de mani√®re centrale.  Ou, par exemple, t√©l√©chargez automatiquement la version dans Google Play en version b√™ta.  Eh bien, je voulais juste choisir le syst√®me CI.  Qu'est-ce qui est arriv√© et comment nous l'avons mis en place, pourquoi Docker, plus loin dans l'article. <br><br><img src="https://habrastorage.org/webt/at/pi/_v/atpi_veqcyb-lryxth_ia4m0uag.png"><br><a name="habracut"></a><br>  √Ä ma connaissance, l'ensemble de la t√¢che a √©t√© divis√©e en deux √©tapes environ: <br><br><ol><li>  Installez et configurez Jenkins lui-m√™me avec le SDK Android </li><li>  Configurer des t√¢ches d√©j√† dans Jenkins </li></ol><br>  Dans cet article, je veux aborder le premier point, et si cela int√©resse quelqu'un, je d√©crirai dans le prochain article le processus de configuration des t√¢ches d'assemblage dans Jenkins lui-m√™me. <br><br><h2>  Donc, le premier point est l'installation et la configuration du syst√®me Jenkins </h2><br>  <i>Habr√© a d√©j√† un merveilleux <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> sur ce sujet, mais elle a d√©j√† quelques ann√©es, et certaines choses sont l√©g√®rement d√©pass√©es (par exemple sdkmanager), m√™me si elle m'a beaucoup aid√© √† comprendre quoi et comment faire aux √©tapes initiales.</i> <br><br>  Si vous consultez la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation</a> officielle pour l'installation de Jenkins, nous verrons trois fa√ßons diff√©rentes de le faire: lancer une image docker pr√™te √† l'emploi, t√©l√©charger et ex√©cuter un fichier war, et aussi simplement installer jenkins dans le syst√®me √† l'ancienne (par exemple, <code>apt-get install jenkins</code> utilisant ubuntu comme exemple).  La premi√®re option est la plus correcte, car elle ne transporte pas de param√®tres et de d√©pendances inutiles sur notre syst√®me h√¥te, et √† tout moment, m√™me en cas de probl√®me, il est facile et simple de tout supprimer et de recommencer.  Mais l'image docker standard pour jenkins contient certaines des donn√©es dont nous n'avons pas besoin (par exemple, le plugin blueocean) et ne contiennent pas ce dont nous aurons certainement besoin (par exemple, android sdk).  Il a √©t√© d√©cid√© de cr√©er notre propre image docker qui, √† l'int√©rieur, t√©l√©chargera et ex√©cutera le fichier war, t√©l√©chargera et installera le sdk android, ainsi que configurera tous les autres param√®tres dont nous avons besoin.  Pour le d√©marrer plus tard, nous avons besoin d'un syst√®me h√¥te avec docker install√©.  Je sugg√®re ici de ne pas r√©inventer la roue et d'utiliser DigitalOcean. <br><br><h4>  Cr√©er et configurer une machine virtuelle </h4><br>  Pour commencer, si quelqu'un d'autre n'y est pas inscrit, je sugg√®re de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">m'inscrire</a> (ici au moment de la r√©daction de l'article il y avait un lien de parrainage, mais apr√®s avoir lu les r√®gles je l'ai jet√©).  Apr√®s l'enregistrement, vous pouvez google un ou un autre code promotionnel sur Internet, et obtenir environ 10 dollars pour commencer. <br><br>  Apr√®s, nous devons obtenir une nouvelle gouttelette.  S√©lectionnez l'√©l√©ment Droplets, puis <b>Cr√©er une droplet</b> . <br><br><img src="https://habrastorage.org/webt/gx/5m/th/gx5mthmcjzw-okm6ktxpfekimn8.png" alt="image"><br><br>  Le syst√®me h√¥te est Ubuntu 18.04.  Vous pouvez choisir une image avec Docker d√©j√† install√© et configur√©, mais nous ferons tout par nous-m√™mes.  √âtant donn√© que l'assemblage des builds Android est toujours gourmand en ressources, nous devons choisir une configuration pour au moins 20 dollars afin que les builds soient collect√©s normalement et relativement rapidement. <br><br><img src="https://habrastorage.org/webt/1e/y_/z1/1ey_z1uyjffbqocqz6i4ef8ium8.png" alt="image"><br><br>  Nous choisirons un emplacement plus proche (par exemple, en Allemagne).  Ensuite, il existe deux options pour la fa√ßon dont nous nous connecterons √† notre serveur virtuel.  On peut ajouter une cl√© ssh ou s'en passer.  Si, √† cet endroit, nous n'indiquons pas quelle cl√© utiliser, le mot de passe de l'utilisateur root sera envoy√© √† notre courrier. <br><br><img src="https://habrastorage.org/webt/eg/qd/hu/egqdhuamgiddwijvsfidcxu7ieq.png" alt="image"><br><br>  Ici, nous pouvons changer le nom du serveur et terminer la cr√©ation en cliquant sur le bouton <b>Cr√©er</b> . <br><br><img src="https://habrastorage.org/webt/ad/mw/6w/admw6wwv2zyontaxpzx-fgp-rfg.png" alt="image"><br><br>  Maintenant, nous allons dans le droplet cr√©√© et copions l'adresse IP pour nous-m√™mes, pour une connexion et une configuration suppl√©mentaires. <br><br><img src="https://habrastorage.org/webt/q7/th/yv/q7thyvgm-hppvgrured6dogeqva.png" alt="image"><br><br>  Nous avons besoin d'un client ssh.  Si vous travaillez sous un pavot, vous pouvez utiliser le terminal standard, si sous Windows, nous pouvons utiliser du mastic pour <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">travailler</a> ou utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">le sous-syst√®me Linux</a> (pour Windows 10 uniquement).  J'utilise personnellement cette derni√®re option, et elle me convient parfaitement. <br><br>  Connectez-vous √† notre serveur √† l'aide de la commande suivante <br><br><pre> <code class="bash hljs">ssh root@YOUR_IP_ADDRESS</code> </pre> <br>  La console vous proposera de sauvegarder la cl√©, nous en convenons.  Apr√®s la connexion, nous allons cr√©er un nouvel utilisateur pour nous-m√™mes, l'ajouter aux superutilisateurs (et lui donner la possibilit√© d'utiliser sudo sans mot de passe), lui copier la cl√© d'acc√®s via ssh et dire qu'il est le propri√©taire de ces fichiers (sinon cela ne fonctionnera pas).  Le <b>nom d'utilisateur est</b> chang√© en n'importe quel endroit qui vous convient. <br><br><pre> <code class="bash hljs">useradd -m -s /bin/bash username \ &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'username ALL=(ALL) NOPASSWD:ALL'</span></span> &gt;&gt; /etc/sudoers \ &amp;&amp; mkdir /home/username/.ssh \ &amp;&amp; cp /root/.ssh/authorized_keys /home/username/.ssh/authorized_keys \ &amp;&amp; chown username:username -R /home/username/.ssh</code> </pre><br>  Se d√©connecter de root avec la commande <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">exit</span></span></code> </pre> <br>  Et nous nous reconnecterons d√©j√† avec l'aide du nouvel utilisateur cr√©√© <br><br><pre> <code class="bash hljs">ssh username@YOUR_IP_ADDRESS</code> </pre> <br>  Apr√®s avoir mis √† jour le syst√®me et red√©marr√© notre serveur (si pendant le processus de mise √† jour le syst√®me vous demandera quelque chose, il suffit de toujours choisir les valeurs par d√©faut dans ce cas). <br><br><pre> <code class="bash hljs">sudo apt update &amp;&amp; sudo apt full-upgrade -y &amp;&amp; sudo apt autoremove -y &amp;&amp; sudo reboot</code> </pre> <br>  La configuration de base est termin√©e.  Du point de vue du syst√®me de combat, il n'est pas tr√®s s√©curis√©, mais dans le cadre de cet article il est tout √† fait adapt√©. <br><br><h4>  Installez Docker. </h4><br>  Pour installer Docker dans notre syst√®me, nous utiliserons la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> .  Puisque nous avons un syst√®me nouvellement install√©, nous ignorerons ce point, et si vous avez un syst√®me sur lequel quelque chose fonctionne depuis longtemps, sur la recommandation des gars de Docker, supprimez les anciennes versions possibles <br><br><pre> <code class="bash hljs">sudo apt-get remove docker docker-engine docker.io containerd runc</code> </pre> <br>  N'oubliez pas de vous reconnecter d'abord via ssh √† notre serveur.  L'installation de Docker lui-m√™me est d√©crite en d√©tail dans la documentation, je vous donnerai des commandes g√©n√©rales pour vous faciliter la t√¢che.  Ce qu'ils font peut y √™tre lu.  Ajoutez d'abord le r√©f√©rentiel. <br><br><pre> <code class="bash hljs">sudo apt update \ &amp;&amp; sudo apt install -y apt-transport-https ca-certificates \ curl gnupg-agent software-properties-common \ &amp;&amp; curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - \ &amp;&amp; sudo apt-key fingerprint 0EBFCD88 \ &amp;&amp; sudo add-apt-repository <span class="hljs-string"><span class="hljs-string">"deb [arch=amd64] https://download.docker.com/linux/ubuntu </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(lsb_release -cs)</span></span></span><span class="hljs-string"> stable"</span></span></code> </pre> <br>  Et puis installez Docker lui-m√™me: <br><br><pre> <code class="bash hljs">sudo apt update &amp;&amp; sudo apt install -y docker-ce docker-ce-cli containerd.io</code> </pre> <br>  Pour qu'√† l'avenir nous puissions appeler des commandes docker sans le pr√©fixe sudo, ex√©cutez la commande suivante (qui est √©galement soigneusement d√©crite dans les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">instructions</a> ). <br><br><pre> <code class="bash hljs">sudo usermod -aG docker username</code> </pre> <br>  Apr√®s cela, vous devez vous reconnecter (en utilisant la commande exit et en vous reconnectant au serveur) pour que cela fonctionne. <br><br>  Docker lui-m√™me est install√©, ce que nous pouvons v√©rifier avec la commande <br><br><pre> <code class="bash hljs">docker run hello-world</code> </pre> <br>  Elle t√©l√©charge l'image de test, l'ex√©cute dans le conteneur.  Le conteneur, apr√®s avoir d√©marr√©, imprime un message d'information et se ferme. <br><br>  F√©licitations, nous avons termin√© l'√©tape de pr√©paration du serveur pour le travail! <br><br><h4>  Cr√©ation de votre image Docker </h4><br>  Nous allons cr√©er l'image Docker en √©crivant notre propre Dockerfile.  Des exemples de comment le faire correctement sur Internet un wagon et un petit chariot, je vais montrer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ma</a> version finale, et je vais essayer de commenter autant que possible.  Il existe √©galement un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">manuel d'instructions</a> de docker lui-m√™me avec des exemples sur l'orthographe correcte et canonique de dockerfile. <br><br>  Cr√©ez et ouvrez votre Dockerfile pour le modifier <br><br><pre> <code class="bash hljs">touch Dockerfile &amp;&amp; nano Dockerfile</code> </pre> <br>  Par exemple, nous y mettrons le contenu de mon Dockerfile <br><br><div class="spoiler">  <b class="spoiler_title">Mon dockerfile entier avec commentaires</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    . FROM ubuntu:18.04 #      LABEL author="osipovaleks" LABEL maintainer="osipov.aleks.kr@gmail.com" LABEL version="1.0" LABEL description="Docker image for Jenkins with Android SDK" #  ,  Jenkins    ENV TZ=Europe/Kiev RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime &amp;&amp; echo $TZ &gt; /etc/timezone # i386    ia32-libs RUN dpkg --add-architecture i386 #      RUN apt-get update &amp;&amp; apt-get install -y git \ wget \ unzip \ sudo \ tzdata \ locales\ openjdk-8-jdk \ libncurses5:i386 \ libstdc++6:i386 \ zlib1g:i386 #  ,       RUN apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists /var/cache/apt #  RUN locale-gen en_US.UTF-8 ENV LANG en_US.UTF-8 ENV LANGUAGE en_US:en ENV LC_ALL en_US.UTF-8 #   Android Sdk     ARG android_home_dir=/var/lib/android-sdk/ ARG sdk_tools_zip_file=sdk-tools-linux-4333796.zip RUN mkdir $android_home_dir RUN wget https://dl.google.com/android/repository/$sdk_tools_zip_file -P $android_home_dir -nv RUN unzip $android_home_dir$sdk_tools_zip_file -d $android_home_dir RUN rm $android_home_dir$sdk_tools_zip_file &amp;&amp; chmod 777 -R $android_home_dir # environment    ENV ANDROID_HOME=$android_home_dir ENV PATH="${PATH}:$android_home_dir/tools/bin:$android_home_dir/platform-tools" ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64/ #   Android SDK RUN yes | sdkmanager --licenses #    Jenkins ENV JENKINS_HOME=/var/lib/jenkins RUN mkdir $JENKINS_HOME &amp;&amp; chmod 777 $JENKINS_HOME #     jenkins,   ,         RUN useradd -m jenkins &amp;&amp; echo 'jenkins ALL=(ALL) NOPASSWD:ALL' &gt;&gt; /etc/sudoers USER jenkins WORKDIR /home/jenkins #   war     Jenkins RUN wget http://mirrors.jenkins.io/war-stable/latest/jenkins.war -nv CMD java -jar jenkins.war #      EXPOSE 8080/tcp</span></span></code> </pre><br></div></div><br>  Quelques pr√©cisions: <br><br><ul><li>  Au d√©but, il y avait un d√©sir d'utiliser un alpin plus l√©ger au lieu d'ubuntu, mais il ne prend pas en charge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ia32-libs</a> , qui est requis pour la construction de projets √† l'aide du SDK Android. </li><li>  Nous installons openjdk-8-jdk, pas le plus l√©ger openjdk-8-jdk-headless, car certaines fonctions Jenkins ont besoin d'un syst√®me complet (par exemple, afficher les r√©sultats des tests unitaires). </li><li>  Il est n√©cessaire d'installer des locales, car sur certains projets, sans eux, l'assembly gradle se bloque sans erreurs claires et sans journaux, et j'ai pass√© plusieurs jours pour aller au fond de cette raison (sur ubuntu normal qui n'est pas dans docker, toutes les locales sont remplies par d√©faut) . </li><li>  Nous devons accepter imm√©diatement toutes les licences pour le SDK Android, afin que pendant le processus de construction Jenkins puisse installer ind√©pendamment les composants dont il a besoin (par exemple, les SDK dont il a besoin pour diff√©rentes versions d'api).  Si n√©cessaire, plus tard √† l'int√©rieur du conteneur Docker, il sera possible de g√©rer le SDK √† l'aide de sdkmanager, par exemple <code>sdkmanager --list</code> permet de visualiser tous les composants disponibles et install√©s, et <code>sdkmanager --install "platforms;android-26"</code> installera le SDK pour la version 26 de l'api. </li><li>  En g√©n√©ral, il √©tait possible de ne pas d√©marrer l'utilisateur jenkins et de rester avec l'utilisateur root, mais en quelque sorte ce n'est pas tout √† fait correct, vous ne pouviez pas non plus lui donner des droits de superutilisateur, mais cela a √©t√© fait en termes de commodit√©, si quelque chose doit √™tre install√© √† l'√©tape de configuration et de d√©bogage. </li><li>  La taille de base de l'image s'est av√©r√©e plut√¥t grande (pr√®s de 800 Mo), mais dans l'ensemble, je suis arriv√© √† la conclusion que pour moi, ce n'est pas tr√®s critique, et il est plus facile pour moi de la t√©l√©charger sous cette forme que de passer du temps √† rechercher et supprimer des packages dont je n'ai pas besoin. </li></ul><br>  Apr√®s avoir √©crit Dockerfile, nous devons le transformer en une image pr√™te √† l'emploi pour Docker, sur la base des conteneurs qui seront cr√©√©s.  Cela se fait simplement par une √©quipe <br><br><pre> <code class="bash hljs">docker build -t jenkins-image</code> </pre> <br>  o√π le <code>-t jenkins-image</code> est responsable du nom de votre image et le point √† la fin de la commande indique que vous devez rechercher le Dockerfile pour l'assembly dans ce r√©pertoire.  Le processus d'assemblage lui-m√™me prend un certain temps, et apr√®s l'assemblage, il devrait y avoir quelque chose comme √ßa dans la console. <br><blockquote>  9fd8f5545c27 construit avec succ√®s <br>  Tag jenkins-image avec succ√®s: le dernier </blockquote>  Ce qui nous dit que notre image a √©t√© assembl√©e avec succ√®s, et nous pouvons passer √† l'√©tape suivante, √† savoir le lancement de notre conteneur <br><br><h4>  Docker Hub et images pr√™tes √† l'emploi </h4><br>  Oui, bien s√ªr, nous pouvons utiliser notre image pr√™te √† l'emploi pour lancer le conteneur, mais si nous devons le faire sur plus de plusieurs appareils, cr√©er un Dockerfile √† chaque fois et en construire une image finie ne sera pas tr√®s pratique.  Et si nous mettons √©galement √† jour le contenu de notre Dockerfile, le d√©ploiement des modifications sur tous les n≈ìuds ne sera pas du tout pratique.  √Ä ces fins, il existe un r√©f√©rentiel public d'images <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Docker Hub</a> .  Il vous permet de ne pas collecter une image √† chaque fois, sur chaque n≈ìud, mais simplement de la t√©l√©charger √† vous-m√™me √† partir du r√©f√©rentiel public et de l'utiliser √©galement sur toutes les machines.  Par exemple, l'image qui a servi d'exemple pour cet article est disponible dans le r√©f√©rentiel nomm√© <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">osipovaleks / docker-jenkins-android</a> , et plus tard dans l'article, nous travaillerons avec. <br><br>  Cet article n'implique pas une √©tude d√©taill√©e du Docker Hub, nous ne comprendrons pas comment y t√©l√©charger nos images (bien que ce ne soit pas tr√®s difficile) et ce qui peut √™tre fait avec elles l√†-bas, nous ne comprendrons pas qu'il puisse toujours y avoir vos propres r√©f√©rentiels publics ou priv√©s personnels, En cela, tout peut √™tre tri√© ind√©pendamment si n√©cessaire. <br><br><h4>  Lancement de conteneurs </h4><br>  Il existe deux fa√ßons de d√©marrer un conteneur. <br><br><ol><li>  La premi√®re fa√ßon, en utilisant simplement la <code>docker run</code> , vous permet de le faire facilement et rapidement de la mani√®re suivante <br><br><pre> <code class="bash hljs">docker run --name jenkins -d -it -v jenkins-data:/var/lib/jenkins -v jenkins-home:/home/jenkins -p 8080:8080 --restart unless-stopped osipovaleks/docker-jenkins-android</code> </pre> <br>  o√π la commande <code>run</code> a les param√®tres suivants <br><br><ul><li>  <code>--name jenkins</code> - nom du futur conteneur </li><li>  <code>-d</code> - d√©marre le conteneur en arri√®re-plan </li><li>  <code>-it</code> - drapeaux pour travailler avec STDIN et tty </li><li>  <code>-v jenkins-data:/var/lib/jenkins</code> et <code>-v jenkins-home:/home/jenkins</code> - cr√©e (s'il n'est pas cr√©√©) et mappe des fichiers de volume sp√©ciaux aux sections internes du conteneur qui nous permettront de sauvegarder nos Jenkins personnalis√©s m√™me apr√®s la reconstruction conteneur </li><li>  <code>-p 8080:8080</code> - mappez le port h√¥te sur le port conteneur afin que nous ayons acc√®s √† l'interface web (oui c'est le port que nous avons sp√©cifi√© dans le Dockerfile) </li><li>  <code>--restart unless-stopped</code> - l'option d√©termine la strat√©gie d'ex√©cution automatique du conteneur apr√®s le red√©marrage de l'h√¥te (dans ce cas, d√©marrage automatique si le conteneur n'a pas √©t√© d√©sactiv√© manuellement) </li><li>  <code>osipovaleks/docker-jenkins-android</code> - image pour le d√©ploiement. </li></ul><br>  √Ä la sortie de la console Docker, nous devrions obtenir l'id du conteneur cr√©√© et √©galement afficher des informations sur la fa√ßon dont l'image est charg√©e dans le syst√®me (bien s√ªr, si elle n'est pas d√©j√† charg√©e), quelque chose comme √ßa <br><blockquote>  Impossible de trouver l'image 'osipovaleks / docker-jenkins-android: latest' localement <br>  dernier: tirant de osipovaleks / docker-jenkins-android <br>  6cf436f81810: Pull complet <br>  987088a85b96: Pull complet <br>  b4624b3efe06: Pull complet <br>  d42beb8ded59: Pull complet <br>  b3896048bb8c: Pull complet <br>  8eeace4c3d64: tirer complet <br>  d9b74624442c: Pull complet <br>  36bb3b7da419: traction compl√®te <br>  31361bd508cb: Pull complet <br>  cee49ae4c825: tirer complet <br>  868ddf54d4c1: Pull complet <br>  361bd7573dd0: Pull complet <br>  bb7b15e36ae8: Pull complet <br>  97f19daace79: Pull complet <br>  1f5eb3850f3e: tirer compl√®tement <br>  651e7bbedad2: Pull complet <br>  a52705a2ded7: Pull complet <br>  R√©sum√©: sha256: 321453e2f2142e433817cc9559443387e9f680bb091d6369bbcbc1e0201be1c5 <br>  Statut: Image plus r√©cente t√©l√©charg√©e pour osipovaleks / docker-jenkins-android: derni√®re <br>  ef9e5512581da66d66103d9f6ea6ccd74e5bdb3776747441ce6a88a98a12b5a4 </blockquote></li><li>  La deuxi√®me fa√ßon de commencer consiste √† √©crire un fichier de composition sp√©cial, o√π la commande d'ex√©cution est simplement d√©crite en utilisant le langage <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">YAML</a> et est lanc√©e √† l'aide de Docker Compose. <br><br>  Pour ce faire, nous devons l'installer: <br><br><pre> <code class="bash hljs">sudo apt update &amp;&amp; sudo apt install -y docker-compose</code> </pre> <br>  Ensuite, cr√©ez un r√©pertoire pour le projet (c'est important si vous vous souciez du nom des volumes cr√©√©s automatiquement pour le conteneur) et allez-y <br><br><pre> <code class="bash hljs">mkdir jenkinsProject &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> jenkinsProject</code> </pre> <br>  et √† l'int√©rieur, nous cr√©ons le fichier de composition lui-m√™me et passons en mode √©dition <br><br><pre> <code class="bash hljs">touch docker-compose.yml &amp;&amp; nano docker-compose.yml</code> </pre> <br>  et y mettre le contenu suivant <br><br><pre> <code class="markdown hljs">version: '3' services: jenkins: container_name: jenkins image: osipovaleks/docker-jenkins-android ports: - "8080:8080" restart: unless-stopped volumes: - "jenkins-data:/var/lib/jenkins" - "jenkins-home:/home/jenkins" volumes: jenkins-data: jenkins-home:</code> </pre> <br>  Dans ce document, peut-√™tre, seule la premi√®re ligne soul√®ve des questions ( <code>version: '3'</code> ) qui indique la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">version des</a> capacit√©s du fichier de composition, ainsi qu'une section avec le bloc de <code>volumes</code> qui r√©pertorie celles utilis√©es dans ce conteneur <br><br>  Ex√©cutez votre conteneur avec la commande: <br><br><pre> <code class="bash hljs">docker-compose up -d</code> </pre> <br>  o√π l'indicateur <code>-d</code> indique √©galement que le conteneur sera cr√©√© et lanc√© en arri√®re-plan.  Par cons√©quent, Docker devrait afficher quelque chose comme ceci: <br><blockquote>  Cr√©ation du volume "jenkinsproject_jenkins-data" avec le pilote par d√©faut <br>  Cr√©ation du volume "jenkinsproject_jenkins-home" avec le pilote par d√©faut <br>  Pulling jenkins (osipovaleks / docker-jenkins-android: dernier) ... <br>  dernier: tirant de osipovaleks / docker-jenkins-android <br>  6cf436f81810: Pull complet <br>  987088a85b96: Pull complet <br>  b4624b3efe06: Pull complet <br>  d42beb8ded59: Pull complet <br>  b3896048bb8c: Pull complet <br>  8eeace4c3d64: tirer complet <br>  d9b74624442c: Pull complet <br>  36bb3b7da419: traction compl√®te <br>  31361bd508cb: Pull complet <br>  cee49ae4c825: tirer complet <br>  868ddf54d4c1: Pull complet <br>  361bd7573dd0: Pull complet <br>  bb7b15e36ae8: Pull complet <br>  97f19daace79: Pull complet <br>  1f5eb3850f3e: tirer compl√®tement <br>  651e7bbedad2: Pull complet <br>  a52705a2ded7: Pull complet <br>  R√©sum√©: sha256: 321453e2f2142e433817cc9559443387e9f680bb091d6369bbcbc1e0201be1c5 <br>  Statut: Image plus r√©cente t√©l√©charg√©e pour osipovaleks / docker-jenkins-android: derni√®re <br>  Cr√©ation de jenkins ... <br>  Cr√©ation de jenkins ... termin√© </blockquote>  Rappelez-vous, j'ai dit que le nom des volumes cr√©√©s d√©pendra du nom du projet?  Ex√©cutez la commande: <br><br><pre> <code class="bash hljs">docker volume ls</code> </pre> <br>  et nous obtenons une telle sortie <br><blockquote>  NOM DU VOLUME DU CONDUCTEUR <br>  jenkinsproject_jenkins-data local <br>  local jenkinsproject_jenkins-home </blockquote>  o√π nous verrons qu'en d√©pit du fait que le nom du volume a √©t√© choisi par <code>jenkins-home</code> , en r√©alit√©, un pr√©fixe du nom du projet y est rest√© et que le nom du volume s'est av√©r√© √™tre <code><b>jenkinsproject</b> _jenkins-home</code> </li></ol><br><br>  Quelle option de d√©marrage utiliser?  Ici, vous pouvez choisir par vous-m√™me, on pense que Docker Compose est plut√¥t un outil pour lancer plusieurs conteneurs √† la fois, qui sont li√©s les uns aux autres, et si vous n'avez besoin d'ex√©cuter qu'un seul conteneur, vous pouvez utiliser la <code>docker run</code> . <br><br>  Maintenant, apr√®s ces sous-√©tapes pour d√©marrer et configurer le serveur, ainsi que pour d√©marrer le conteneur avec Jenkins, nous pouvons proc√©der √† sa configuration initiale <br><br><h4>  Configuration initiale de Jenkins </h4><br>  Prenez l'adresse IP de notre serveur, ajoutez-y le port 8080 que nous vous avons indiqu√© et suivez ce lien dans le navigateur. <br><br> <code>http://YOUR_IP_ADDRESS:8080/</code> <br> <br>  Si avant cela, tout √©tait configur√© et d√©marr√© correctement, alors ici nous verrons l'image suivante <br><br><img src="https://habrastorage.org/webt/za/a5/bi/zaa5bi-5vkvscc-ww7gd2ouxjte.png"><br><br>  Pour la premi√®re configuration, nous devons saisir le mot de passe g√©n√©r√© par le syst√®me lors de l'installation.  Pour ce faire, il suffit de regarder le contenu du fichier <code>/var/lib/jenkins/secrets/initialAdminPassword</code> .  Mais ce fichier est √† l'int√©rieur de notre conteneur en cours d'ex√©cution, et pour le lire, nous devons nous connecter au conteneur √† l'aide de la commande suivante: <br><br><pre> <code class="bash hljs">docker <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> -it jenkins /bin/bash</code> </pre> <br>  o√π l'option <code>-it</code> est similaire √† l'ex√©cution de <code>docker run</code> , <code>jenkins</code> est le nom de notre conteneur et <code>/bin/bash</code> ex√©cutera <code>/bin/bash</code> pour nous dans le conteneur et lui donnera acc√®s.  Apr√®s cela, nous pouvons voir le mot de passe initial de Jenkins: <br><br><pre> <code class="bash hljs">cat /var/lib/jenkins/secrets/initialAdminPassword</code> </pre> <br>  ce qui suit appara√Æt dans la console <br><blockquote>  91092b18d6ca4492a2759b1903241d2a </blockquote>  Ceci est le mot de passe. <br><br>  <i>L'utilisateur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">ALexhha a</a> sugg√©r√© une option plus simple pour lire ce mot de passe, sans se connecter au conteneur lui-m√™me.</i>  <i>Le fait est qu'au moment du lancement de Jenkins lui-m√™me, ce mot de passe est affich√© dans les journaux.</i>  <i>Il s'av√®re que tout ce dont nous avons besoin est de lire les journaux des conteneurs.</i>  <i>Dans notre cas, cela se fait avec la commande suivante:</i> <br><br><pre> <code class="bash hljs">docker logs jenkins</code> </pre> <br><br>  <i>o√π</i> <code>jenkins</code> <i>nom de notre conteneur, et dans les journaux, vous pouvez voir ce qui suit:</i> <br><br><blockquote>  ***************************************************** *********** <br>  ***************************************************** *********** <br>  ****************************************** .... *********** <br><br>  La configuration initiale de Jenkins est requise.  Un utilisateur administrateur a √©t√© cr√©√© et un mot de passe g√©n√©r√©. <br>  Veuillez utiliser le mot de passe suivant pour proc√©der √† l'installation: <br><br>  91092b18d6ca4492a2759b1903241d2a <br><br>  Vous pouvez √©galement le trouver sur: / var / lib / jenkins / secrets / initialAdminPassword <br><br>  ****************************************** .... *********** <br>  ******************************************** .... *********** </blockquote><br>  ******************************************** .... *********** <br><br>  <i>Cette option est un peu plus simple et plus rapide.</i> <br><br>  Copiez-le, collez-le dans le champ <b>Mot de passe administrateur</b> de l'interface Web et cliquez sur <b>Continuer</b> .  Sur l'√©cran suivant, s√©lectionnez <b>Installer les plugins sugg√©r√©s</b> et installez un ensemble de plugins par d√©faut. <br><br><img src="https://habrastorage.org/webt/bs/9d/xs/bs9dxsxd6-cddmut2bww9utxjw4.png"><br><br><img src="https://habrastorage.org/webt/r5/-m/u-/r5-mu-bgyaqswxcqnyrpds0qhic.png"><br><br>  Apr√®s avoir install√© les plugins, cr√©ez un utilisateur pour nous-m√™mes et cliquez sur <b>Enregistrer et terminer</b> <br><br><img src="https://habrastorage.org/webt/iy/ap/jd/iyapjd__vdbys6jsjiinvzcp58q.png"><br><br>  Nous sommes d'accord avec la section de configuration d'instance, o√π il nous est demand√© de remplir l'URL sur laquelle Jenkins fonctionnera (dans notre cas, laissez tout tel quel) <br><br><img src="https://habrastorage.org/webt/4v/w1/ie/4vw1ieq0o_tm5bkrgn4sb-m__kk.png"><br><br>  Et sur l'√©cran suivant, cliquez sur le ch√©ri <b>Commencer √† utiliser Jenkins</b> <br><br><img src="https://habrastorage.org/webt/4a/iw/yq/4aiwyqwkzbxjdkjwyzowxyvsktc.png"><br><br>  Nous avons donc install√© et lanc√© Jenkins! <br><br><img src="https://habrastorage.org/webt/9a/4z/tu/9a4ztunwk1gxuc8rsho2ql9-tou.png"><br><br>  Il est d√©j√† tout √† fait possible de travailler avec, mais pour collecter nos builds Android, vous devrez configurer quelques points suppl√©mentaires.  La localisation de Jenkins est li√©e √† la langue s√©lectionn√©e de votre navigateur, et bien s√ªr la traduction en russe n'est pas termin√©e avant la fin, et nous obtenons un m√©lange infernal de russe et d'anglais.  Si vous avez r√©ussi exactement de la m√™me mani√®re et que cela vous exasp√®re, vous pouvez utiliser le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plug-in</a> sp√©cial et d√©finir la langue d'interface par d√©faut.  Eh bien, ou passez votre navigateur √† l'interface anglaise. <br><br>  Acc√©dez aux param√®tres Jenkins et s√©lectionnez <b>Configuration syst√®me.</b> <br><br><img src="https://habrastorage.org/webt/pk/xo/1d/pkxo1diloanswc7tciicxhaiidq.png"><br><br>  V√©rifiez <b>les variables d'environnement</b> , entrez le nom <b>ANDROID_HOME</b> dans le champ et sp√©cifiez <b>/ var / lib / android-sdk /</b> dans le champ (nous avons sp√©cifi√© ces donn√©es dans le Dockerfile comme r√©pertoire de base pour le SDK Android). <br><br><img src="https://habrastorage.org/webt/on/af/4j/onaf4jfhel5_ys078k5ohrxwxuu.png"><br><br>  Cliquez sur le bouton <b>Enregistrer</b> , quittez cette section des param√®tres et acc√©dez √† la section intitul√©e <b>Configuration des outils globaux</b> . <br><br><img src="https://habrastorage.org/webt/b9/3i/zx/b93izxlndc-utyrnewgv5kluug0.png"><br><br>  Configurez la partition <b>JDK</b> (o√π la variable JAVA_HOME a √©galement √©t√© remplie par nous dans le Dockerfile, et nous pouvons utiliser sa valeur <b>/ usr / lib / jvm / java-8-openjdk-amd64 / ici</b> ). <br><br><img src="https://habrastorage.org/webt/0l/wn/2p/0lwn2prv62virmofscvskc5e6_8.png"><br><br>  Ici aussi, nous devons encore remplir la section <b>Gradle</b> .  Nous s√©lectionnons et installons la version de Gradle qui est utilis√©e dans les projets que vous construirez en utilisant ce syst√®me CI.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Vous pouvez avoir plusieurs versions. Vous ne pouvez pas non plus d√©marrer la variable Gradle du tout si vous avez gradlew dans le r√©f√©rentiel, par exemple, et vous pouvez la construire avec. </font></font><br><br><img src="https://habrastorage.org/webt/0q/fe/wj/0qfewj73fbwr3vzudpk8woyrsmy.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Avec cela, nous pouvons terminer notre premi√®re √©tape. Le syst√®me Jenkins est enti√®rement op√©rationnel et nous pouvons passer √† la personnalisation des t√¢ches de construction elles-m√™mes. Veuillez noter que le syst√®me a √©t√© personnalis√© en fonction de nos besoins et peut ne pas fournir ce dont vous avez besoin - par exemple, il n'y a pas d'√©mulateurs Android pour les tests et NDK.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Si cet article int√©resse quelqu'un, alors je continuerai dans la deuxi√®me partie avec un exemple d'un ou deux tracas, je d√©crirai l'int√©gration de Jenkins et Bitbucket (c'est lui, pas Github, car c'est plus facile avec des r√©f√©rentiels priv√©s gratuits et des articles sur Internet √† propos de il est plus petit, mais peut-√™tre plus amusant), je vais vous dire comment vous faire des amis avec la cl√© ssh de notre conteneur avec le r√©f√©rentiel, sur les notifications par e-mail, ainsi que plusieurs autres puces. </font><font style="vertical-align: inherit;">En g√©n√©ral, sur tout ce que nous avons configur√©. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je vous demande de ne pas trop taper, c'est mon premier article sur Habr. </font><font style="vertical-align: inherit;">Bon √† tous!</font></font></i> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr443606/">https://habr.com/ru/post/fr443606/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr443594/index.html">Le carrefour des tests et de l'architecture: une entrevue avec Neil Ford</a></li>
<li><a href="../fr443598/index.html">Il y a une r√©vocation massive de certificats TLS d'une vari√©t√© d'autorit√©s de certification, g√©n√©r√©es par erreur sur un RNG 63 bits au lieu d'un 64 bits</a></li>
<li><a href="../fr443600/index.html">Les meilleures et les pires tendances du MWC 2019</a></li>
<li><a href="../fr443602/index.html">Qu'est-ce que le pseudonyme strict et pourquoi devrions-nous nous en pr√©occuper? 2e partie</a></li>
<li><a href="../fr443604/index.html">MOBILE FIRST: Hackathon √† OZON</a></li>
<li><a href="../fr443608/index.html">Smart Home / Mises √† jour chez Lazurite</a></li>
<li><a href="../fr443612/index.html">Nous utilisons de vieux mauvais disques durs</a></li>
<li><a href="../fr443614/index.html">YouTrack 2019.1: s√©lectionnez des cartes Agile, des champs de cartes personnalisables sur les cartes Agile, etc.</a></li>
<li><a href="../fr443616/index.html">35% de retour de stock sur les donn√©es alternatives</a></li>
<li><a href="../fr443618/index.html">√âmulateur d'ordinateur des ann√©es 80 dans le navigateur</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>