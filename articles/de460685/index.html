<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçü§ù‚Äçüë®üèº ü•† üïµüèº Wir verteilen Dateien von Google Drive mit nginx üíØ üç∏ üêá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hintergrund 


 Es ist einfach so passiert, dass ich irgendwo mehr als 1,5 TB Daten speichern und sogar die M√∂glichkeit bieten musste, sie von normale...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Wir verteilen Dateien von Google Drive mit nginx</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460685/"><h3>  Hintergrund </h3><br><p>  Es ist einfach so passiert, dass ich irgendwo mehr als 1,5 TB Daten speichern und sogar die M√∂glichkeit bieten musste, sie von normalen Benutzern √ºber einen direkten Link herunterzuladen.  Da solche Speichermengen traditionell bereits an VDS gehen, dessen Mietkosten nicht zu sehr in das Projektbudget aus der Kategorie "Nichts zu tun" investiert werden, und aus den Quelldaten hatte ich eine VPS 400 GB SSD, auf der ich ohne verlustfreie Komprimierung keine 1,5 TB Bilder speichern konnte wird gelingen. </p><a name="habracut"></a><br><p>  Und dann erinnerte ich mich daran, dass wenn Sie Junk von der Google-Festplatte l√∂schen, wie Programme, die nur unter Windows XP ausgef√ºhrt werden, und andere Dinge, die von meinen Medien zu Medien wandern, da das Internet nicht so schnell und vollst√§ndig war nicht unbegrenzt (zum Beispiel hatten diese 10-20 Versionen der virtuellen Box wahrscheinlich keinen anderen Wert als nostalgisch), dann sollte alles sehr gut passen.  Kaum gesagt als getan.  Auf dem Weg durch die Begrenzung der Anzahl der Anfragen an die API (√ºbrigens hat der technische Support ohne Probleme die Anzahl der Anfragen pro Benutzer in 100 Sekunden auf 10.000 erh√∂ht) flossen die Daten schnell an den Ort ihrer weiteren Bereitstellung. </p><br><p>  Alles scheint gut zu sein, aber jetzt muss es dem Endbenutzer √ºbermittelt werden.  Dar√ºber hinaus ohne Weiterleitungen zu anderen Ressourcen, und so dass eine Person einfach auf die Schaltfl√§che "Herunterladen" klickt und der gl√ºckliche Besitzer der gesch√§tzten Datei wird. </p><br><p>  Dann machte ich mich auf den Weg.  Anfangs war es ein Skript auf AmPHP, aber ich war nicht zufrieden mit der Last, die es erzeugt hat (ein scharfer Sprung zu Beginn bis zu 100% des Kernelverbrauchs).  Dann ging der Curl-Wrapper f√ºr ReactPHP in Aktion, der vollst√§ndig zu meinen W√ºnschen nach der verbrauchten Anzahl von CPU-Taktzyklen passte, aber nicht die gew√ºnschte Geschwindigkeit ergab (es stellte sich heraus, dass Sie das Aufrufintervall curl_multi_select einfach reduzieren k√∂nnen, aber dann haben wir die gleiche V√∂llerei f√ºr die erste Option )  Ich habe sogar versucht, einen kleinen Dienst in Rust zu schreiben, und er funktionierte recht z√ºgig (sogar √ºberraschend, er funktionierte mit meinem Wissen), aber ich wollte mehr, und es war irgendwie nicht einfach, ihn anzupassen.  Au√üerdem haben all diese L√∂sungen die Antwort seltsamerweise gepuffert, und ich wollte den Moment verfolgen, in dem der Dateidownload mit gr√∂√üter Genauigkeit endete. </p><br><p>  Im Allgemeinen war es eine Weile schief, aber es funktionierte.  Bis ich eines Tages auf die Idee einer wunderbaren Wahnidee kam: Nginx kann theoretisch tun, was ich will, es funktioniert z√ºgig und erlaubt sogar alle Arten von Perversionen mit Konfiguration.  Wir m√ºssen versuchen - was ist, wenn es klappt?  Und nach einem halben Tag st√§ndiger Suche funktionierte eine L√∂sung mehrere Monate lang stabil und erf√ºllte alle meine Anforderungen. </p><br><h3>  Passen Sie NGINX an </h3><br><pre><code class="nginx hljs"><span class="hljs-comment"><span class="hljs-comment">#         . location ~* ^/google_drive/(.+)$ { #       (,     ). internal; #       (  ). limit_rate 1m; #   nginx    google drive    . resolver 8.8.8.8; # C     (    ). set $download_url https://www.googleapis.com/drive/v3/files/$upstream_http_file_id?alt=media; #    Content-Disposition ,        . set $content_disposition 'attachment; filename="$upstream_http_filename"'; #     . proxy_max_temp_file_size 0; # ,  ,     (  ,     $http_upstream    .   ,     -  ,      ). proxy_set_header Authorization 'Bearer $1'; #  ,         . proxy_pass $download_url; #              . add_header Content-Disposition $content_disposition; #        . proxy_hide_header Content-Disposition; proxy_hide_header Alt-Svc; proxy_hide_header Expires; proxy_hide_header Cache-Control; proxy_hide_header Vary; proxy_hide_header X-Goog-Hash; proxy_hide_header X-GUploader-UploadID; }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Eine kurze Version ohne Kommentare ist unter dem Spoiler zu sehen</b> <div class="spoiler_text"><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~* ^/google_drive/(.+)$</span></span> { internal; <span class="hljs-attribute"><span class="hljs-attribute">limit_rate</span></span> <span class="hljs-number"><span class="hljs-number">1m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">resolver</span></span> <span class="hljs-number"><span class="hljs-number">8.8.8.8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$download_url</span></span> https://www.googleapis.com/drive/v3/files/<span class="hljs-variable"><span class="hljs-variable">$upstream_http_file_id</span></span>?alt=media; <span class="hljs-attribute"><span class="hljs-attribute">set</span></span> <span class="hljs-variable"><span class="hljs-variable">$content_disposition</span></span> <span class="hljs-string"><span class="hljs-string">'attachment; filename="</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$upstream_http_filename</span></span></span><span class="hljs-string">"'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_max_temp_file_size</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Authorization <span class="hljs-string"><span class="hljs-string">'Bearer </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$1</span></span></span><span class="hljs-string">'</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> <span class="hljs-variable"><span class="hljs-variable">$download_url</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Content-Disposition <span class="hljs-variable"><span class="hljs-variable">$content_disposition</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Content-Disposition; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Alt-Svc; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Expires; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Cache-Control; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> Vary; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> X-Goog-Hash; <span class="hljs-attribute"><span class="hljs-attribute">proxy_hide_header</span></span> X-GUploader-UploadID; }</code> </pre> <br></div></div><br><br><h3>  Schreiben Sie ein Skript, um all dieses Gl√ºck zu verwalten </h3><br><p>  Das Beispiel wird in PHP sein und absichtlich mit einem Minimum Body Kit geschrieben.  Ich denke, jeder, der Erfahrung mit einer anderen Sprache hat, kann diesen Artikel anhand meines Beispiels integrieren. </p><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">#   Google Drive Api. define('TOKEN', '*****'); # ID     $fileId = 'abcdefghijklmnopqrstuvwxyz1234567890'; # ,         -    ? http_response_code(204); #   c ID  (  nginx      $upstream_http_file_id). header('File-Id: ' . $fileId); #      ( $upstream_http_filename). header('Filename: ' . 'test.zip'); #  .       ,  ,     $1  nginx. header('X-Accel-Redirect: ' . rawurlencode('/google_drive/' . TOKEN));</span></span></code> </pre> <br><h3>  Zusammenfassung </h3><br><p>  Im Allgemeinen ist es mit dieser Methode ziemlich einfach, die Verteilung von Dateien an Benutzer aus einem beliebigen Cloud-Speicher zu organisieren.  Ja, auch per Telegramm oder VK (vorausgesetzt, die Dateigr√∂√üe √ºberschreitet nicht die zul√§ssige Gr√∂√üe f√ºr dieses Repository).  Ich hatte eine √§hnliche Idee wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">diese</a> , aber leider sto√üe ich auf Dateien mit bis zu 2 GB, und ich habe noch keinen Weg oder kein Modul gefunden, um die Antworten aus dem Upstream zu kleben. Das Schreiben einiger Wrapper f√ºr dieses Projekt ist unangemessen m√ºhsam. </p><br><p>  Vielen Dank f√ºr Ihre Aufmerksamkeit.  Ich hoffe, meine Geschichte war zumindest ein wenig interessant oder n√ºtzlich f√ºr Sie. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de460685/">https://habr.com/ru/post/de460685/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de460669/index.html">So gew√§hrleisten Sie die Sicherheit der Entwicklung, sparen Zeit und Nerven</a></li>
<li><a href="../de460671/index.html">Eigentum und Ausleihe in D.</a></li>
<li><a href="../de460673/index.html">Enth√ºlle die Magie von DiffUtil</a></li>
<li><a href="../de460675/index.html">Datenextraktion beim maschinellen Lernen</a></li>
<li><a href="../de460683/index.html">Laravel Event Projector und Event Generation Concept</a></li>
<li><a href="../de460687/index.html">Wie Dosen von innen aussehen</a></li>
<li><a href="../de460695/index.html">Was ist DAA und wie hilft dieses System Drohnen?</a></li>
<li><a href="../de460697/index.html">Kleinstm√∂gliche Schriftart</a></li>
<li><a href="../de460699/index.html">Habr Weekly # 10 / Super Services und E-Pass, Smartphones und Russen, "Spionageger√§te", Leben ohne Satelliten</a></li>
<li><a href="../de460701/index.html">Kurs "Start in Data Science": der erste Schritt in der Arbeit mit Daten</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>