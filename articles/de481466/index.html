<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëÜüèΩ üôã üë©‚Äçüîß So erstellen Sie Projekte in Jenkins, wenn Sie viele verschiedene Umgebungen ben√∂tigen ‚úãüèΩ üë∞ ü§™</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es gibt viele Artikel √ºber Habr√© √ºber Jenkins, aber es werden nur wenige Beispiele f√ºr die Arbeit von Jenkins und Hafenagenten beschrieben. Alle g√§ngi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>So erstellen Sie Projekte in Jenkins, wenn Sie viele verschiedene Umgebungen ben√∂tigen</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/481466/"><p><img src="https://habrastorage.org/webt/be/ex/-k/beex-kn_7aua2kim4jnlzqg-ch0.jpeg" alt="Bild"></p><br><p>  Es gibt viele Artikel √ºber Habr√© √ºber Jenkins, aber es werden nur wenige Beispiele f√ºr die Arbeit von Jenkins und Hafenagenten beschrieben.  Alle g√§ngigen Tools zum <a href="https://drone.io/" rel="nofollow">Erstellen von</a> Projekten wie <a href="https://drone.io/" rel="nofollow">Drone.io</a> , <a href="https://bitbucket.org/product/ru/features/pipelines" rel="nofollow">Bitbucket Pipeline</a> , <a href="https://about.gitlab.com/" rel="nofollow">GitLab</a> , <a href="https://github.com/features/actions" rel="nofollow">GitHub</a> und andere k√∂nnen alles in Containern sammeln.  Aber was ist mit Jenkins? </p><br><p>  Heute gibt es eine L√∂sung f√ºr das Problem: Jenkins 2 kann hervorragend mit <a href="https://jenkins.io/doc/book/pipeline/docker/" rel="nofollow">Docker-Agenten zusammenarbeiten</a> .  In dem Artikel m√∂chte ich Erfahrungen teilen und zeigen, wie Sie es selbst tun k√∂nnen. </p><a name="habracut"></a><br><h2 id="pochemu-ya-zanyalsya-resheniem-etoy-problemy">  Warum habe ich dieses Problem gel√∂st? </h2><br><p>  Da wir bei <a href="https://citronium.com/" rel="nofollow">Citronium</a> viele verschiedene Technologien verwenden, m√ºssen wir verschiedene Versionen von Node.JS, Gradle, Ruby, JDK und anderen auf der Montagemaschine behalten.  Oft lassen sich Versionskonflikte jedoch nicht vermeiden.  Ja, Sie werden Recht haben, wenn Sie sagen, dass es verschiedene Versionsmanager wie nvm, rvm gibt, aber nicht alles mit ihnen so reibungslos l√§uft und diese L√∂sungen Probleme haben: </p><br><ul><li>  eine gro√üe Menge von Laufzeiten, die Entwickler vergessen zu reinigen; </li><li>  Es gibt Konflikte zwischen verschiedenen Versionen der gleichen Laufzeiten. </li><li>  Jeder Entwickler ben√∂tigt einen anderen Komponentensatz. </li></ul><br><p>  Es gibt noch andere Probleme, aber ich m√∂chte Ihnen die L√∂sung n√§her erl√§utern. </p><br><h2 id="jenkins-v-docker">  Jenkins in Docker </h2><br><p>  Da Docker mittlerweile gut in der Entwicklungsbranche verwurzelt ist, kann mit Docker fast alles gestartet werden.  Meine L√∂sung ist, dass Jenkins in Docker ist und andere Docker-Container ausf√ºhren kann.  Diese Frage wurde bereits 2013 im Artikel " <a href="https://www.docker.com/blog/docker-can-now-run-within-docker/" rel="nofollow">Docker kann jetzt in Docker ausgef√ºhrt werden</a> " gestellt. </p><br><p> In K√ºrze ist es lediglich erforderlich, Docker im <code>/var/run/docker.sock</code> zu installieren und die Datei <code>/var/run/docker.sock</code> . </p><br><p>  Hier ist ein Dockerfile-Beispiel, das f√ºr Jenkins herauskam. </p><br><pre> <code class="plaintext hljs">FROM jenkins/jenkins:lts ARG DOCKER_COMPOSE_VERSION=1.25.0 USER root RUN apt-get update &amp;&amp; \ apt-get upgrade -y &amp;&amp; \ apt-get -y install apt-transport-https \ ca-certificates \ curl \ gnupg2 \ git \ software-properties-common &amp;&amp; \ curl -fsSL https://download.docker.com/linux/$(. /etc/os-release; echo "$ID")/gpg &gt; /tmp/dkey; apt-key add /tmp/dkey &amp;&amp; \ add-apt-repository \ "deb [arch=amd64] https://download.docker.com/linux/$(. /etc/os-release; echo "$ID") \ $(lsb_release -cs) \ stable" &amp;&amp; \ apt-get update &amp;&amp; \ apt-get -y install docker-ce &amp;&amp; \ apt-get clean autoclean &amp;&amp; apt-get autoremove &amp;&amp; rm -rf /var/lib/{apt,dpkg,cache,log}/ RUN curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` -o /usr/local/bin/docker-compose &amp;&amp; chmod +x /usr/local/bin/docker-compose RUN usermod -aG docker jenkins &amp;&amp; gpasswd -a jenkins docker USER jenkins</code> </pre> <br><p>  So haben wir einen Docker-Container, der Docker-Befehle auf dem Host-Rechner ausf√ºhren kann. </p><br><h2 id="nastroyka-sborki">  Setup erstellen </h2><br><p>  Vor nicht allzu langer Zeit hatte Jenkins die M√∂glichkeit, seine Regeln mithilfe der <a href="https://jenkins.io/doc/book/pipeline/" rel="nofollow">Pipeline-</a> Syntax zu beschreiben, mit der Sie das Build-Skript einfach √§ndern und im Repository speichern k√∂nnen. </p><br><p>  Legen wir also ein spezielles Dockerfile im Repository selbst ab, das alle Bibliotheken enth√§lt, die zum Erstellen der Bibliothek erforderlich sind.  Auf diese Weise kann der Entwickler selbst eine wiederholbare Umgebung vorbereiten, und OPS muss nicht aufgefordert werden, eine bestimmte Version von Node.JS auf dem Host zu speichern. </p><br><pre> <code class="plaintext hljs">FROM node:12.10.0-alpine RUN npm install yarn -g</code> </pre> <br><p>  Dieses Build-Image ist f√ºr die meisten Node.JS-Anwendungen geeignet.  Und wenn Sie beispielsweise ein Image f√ºr ein JVM-Projekt mit einem im Sonar enthaltenen Scanner ben√∂tigen?  Sie k√∂nnen selbst die Komponenten ausw√§hlen, die Sie erstellen m√ºssen. </p><br><pre> <code class="plaintext hljs">FROM adoptopenjdk/openjdk12:latest RUN apt update \ &amp;&amp; apt install -y \ bash unzip wget RUN mkdir -p /usr/local/sonarscanner \ &amp;&amp; cd /usr/local/sonarscanner \ &amp;&amp; wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-3.3.0.1492-linux.zip \ &amp;&amp; unzip sonar-scanner-cli-3.3.0.1492-linux.zip \ &amp;&amp; mv sonar-scanner-3.3.0.1492-linux/* ./ \ &amp;&amp; rm sonar-scanner-cli-3.3.0.1492-linux.zip \ &amp;&amp; rm -rf sonar-scanner-3.3.0.1492-linux \ &amp;&amp; ln -s /usr/local/sonarscanner/bin/sonar-scanner /usr/local/bin/sonar-scanner ENV PATH $PATH:/usr/local/sonarscanner/bin/ ENV SONAR_RUNNER_HOME /usr/local/sonarscanner/bin/</code> </pre><br><p>  Wir haben die Build-Umgebung beschrieben, aber was hat Jenkins damit zu tun?  Und Jenkins-Agenten k√∂nnen mit solchen Docker-Images arbeiten und diese im Inneren erstellen. </p><br><pre> <code class="plaintext hljs">stage("Build project") { agent { docker { image "project-build:${DOCKER_IMAGE_BRANCH}" args "-v ${PWD}:/usr/src/app -w /usr/src/app" reuseNode true label "build-image" } } steps { sh "yarn" sh "yarn build" } }</code> </pre> <br><p>  Die <code>agent</code> Direktive verwendet die <code>docker</code> Eigenschaft, in der Sie Folgendes angeben k√∂nnen: </p><br><ul><li>  Name des Assembly-Containers gem√§√ü Ihrer Namensrichtlinie; </li><li>  Argumente, die zum Starten des Assembly-Containers erforderlich sind. In unserem Fall wird das aktuelle Verzeichnis als Verzeichnis im Container bereitgestellt. </li></ul><br><p><img src="https://habrastorage.org/webt/sz/pq/xk/szpqxkz-jfks8kfss_1is40mxx8.png" alt="Jenkins"></p><br><p>  Und bereits in den Assemblyschritten geben wir an, welche Befehle im Assembly Docker-Agenten ausgef√ºhrt werden sollen.  Es kann alles, also starte ich auch App Deploy mit Ansible. </p><br><p>  Im Folgenden m√∂chte ich eine generische Jenkins-Datei zeigen, mit der eine einfache Node.JS-Anwendung erstellt werden kann. </p><br><pre> <code class="plaintext hljs">def DOCKER_IMAGE_BRANCH = "" def GIT_COMMIT_HASH = "" pipeline { options { buildDiscarder( logRotator( artifactDaysToKeepStr: "", artifactNumToKeepStr: "", daysToKeepStr: "", numToKeepStr: "10" ) ) disableConcurrentBuilds() } agent any stages { stage("Prepare build image") { steps { sh "docker build -f Dockerfile.build . -t project-build:${DOCKER_IMAGE_BRANCH}" } } stage("Build project") { agent { docker { image "project-build:${DOCKER_IMAGE_BRANCH}" args "-v ${PWD}:/usr/src/app -w /usr/src/app" reuseNode true label "build-image" } } steps { sh "yarn" sh "yarn build" } } post { always { step([$class: "WsCleanup"]) cleanWs() } } }</code> </pre> <br><h2 id="chto-zhe-vyshlo">  Was ist passiert? </h2><br><p>  Dank dieser Methode haben wir die folgenden Probleme gel√∂st: </p><br><ul><li>  Die Konfigurationszeit der Umgebungsassembly wird auf 10 bis 15 Minuten pro Projekt reduziert. </li><li>  vollst√§ndig wiederholbare Umgebung der Anwendungsassembly, da diese auch auf dem lokalen Computer zusammengestellt werden kann; </li><li>  Keine Konflikte mit verschiedenen Versionen von Montagewerkzeugen. </li><li>  Immer ein sauberer Arbeitsplatz, der nicht verstopft. </li></ul><br><p>  Die L√∂sung selbst ist einfach und offensichtlich und bietet einige Vorteile.  Ja, die Eintrittsschwelle ist im Vergleich zu einfachen Build-Befehlen etwas angestiegen, aber jetzt besteht die Garantie, dass sie immer erfasst wird und der Entwickler selbst alles ausw√§hlen kann, was f√ºr seinen Build-Prozess erforderlich ist. </p><br><p>  Sie k√∂nnen auch das Bild verwenden, das ich <a href="https://hub.docker.com/repository/docker/rmuhamedgaliev/jenkins/general" rel="nofollow">Jenkins + Docker</a> gesammelt habe.  Alle Quellen sind offen und liegen auf <a href="https://github.com/rmuhamedgaliev/jenkins_docker" rel="nofollow">rmuhamedgaliev / jenkins_docker</a> . </p><br><p>  W√§hrend des Schreibens des Artikels gab es eine Diskussion √ºber die Verwendung von Agenten auf Remote-Servern, um den Masterknoten nicht mit dem <a href="https://plugins.jenkins.io/docker-plugin" rel="nofollow">Docker-Plugin</a> zu laden.  Aber ich werde in Zukunft dar√ºber sprechen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de481466/">https://habr.com/ru/post/de481466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de481450/index.html">Wie automatisieren wir die Lieferung von Lebensmitteln auf Aiko?</a></li>
<li><a href="../de481452/index.html">Russische Investoren k√∂nnen an den B√∂rsen in London und Hongkong Aktien kaufen</a></li>
<li><a href="../de481458/index.html">Fanatischer Programmierer. Abstrakter Teil 2 + abstrakter Tisch. Fische, Riesen und Mentoren</a></li>
<li><a href="../de481460/index.html">Messaging -> PubSub in OTP</a></li>
<li><a href="../de481462/index.html">Die Geschichte der Lernsoftware: die Entwicklung von PCs und virtuellen Lehrern</a></li>
<li><a href="../de481470/index.html">Smarte Girlande f√ºr das ganze Jahr</a></li>
<li><a href="../de481472/index.html">DNS-Verlauf: Wenn Domainnamen bezahlt werden</a></li>
<li><a href="../de481474/index.html">Wir sind von einem anderen Test - wir testen die Datenbank auf MSTest</a></li>
<li><a href="../de481476/index.html">Wie ich anfing auf Konferenzen zu sprechen und nicht aufh√∂ren kann</a></li>
<li><a href="../de481478/index.html">STM32 + CMSIS + STM32CubeIDE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>