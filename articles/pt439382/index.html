<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üòÄ üôÜ üêß Usando Ansible, Terraform, Docker, Consul, Nomad nas nuvens (Alexey Vakhov, Uchi.ru) üôå üë®üèΩ‚Äçüé§ üßúüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este artigo √© uma transcri√ß√£o do relat√≥rio em v√≠deo de Alexei Vakhov de Uchi.ru ‚ÄúNuvens nas nuvens‚Äù 


 Uchi.ru √© uma plataforma on-line para educa√ß√£o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Usando Ansible, Terraform, Docker, Consul, Nomad nas nuvens (Alexey Vakhov, Uchi.ru)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439382/"><p>  Este artigo √© uma transcri√ß√£o do relat√≥rio em v√≠deo de Alexei Vakhov de Uchi.ru ‚ÄúNuvens nas nuvens‚Äù </p><br><p>  Uchi.ru √© uma plataforma on-line para educa√ß√£o escolar, mais de 2 milh√µes de estudantes, aulas interativas regularmente decidem conosco.  Todos os nossos projetos s√£o hospedados inteiramente em nuvens p√∫blicas, 100% dos aplicativos funcionam em cont√™ineres, come√ßando pelo menor, para uso interno, e terminando com grandes produ√ß√µes com 1k + solicita√ß√µes por segundo.  Aconteceu que temos 15 clusters de docker isolados (n√£o Kubernetes, sic!) Em cinco provedores de nuvem.  Mil e quinhentos aplicativos de usu√°rio, cujo n√∫mero est√° em constante crescimento. </p><br><p>  Vou falar sobre coisas muito espec√≠ficas: como mudamos para cont√™ineres, como gerenciamos a infraestrutura, os problemas que encontramos, o que funcionou e o que n√£o funcionou. </p><br><p>  Durante o relat√≥rio, discutiremos: </p><br><ul><li>  Motiva√ß√£o para sele√ß√£o de tecnologia e recursos de neg√≥cios </li><li>  Ferramentas: Ansible, Terraform, Docker, Github Flow, Consul, Nomad, Prometheus, Shaman - uma interface da Web para o Nomad. </li><li>  Usando a Federa√ß√£o de Cluster para Gerenciar Infra-Estrutura Distribu√≠da </li><li>  Lan√ßamentos de NoOps, ambientes de teste, circuitos de aplicativos (os desenvolvedores fazem suas pr√≥prias altera√ß√µes praticamente por conta pr√≥pria) </li><li>  Hist√≥rias divertidas da pr√°tica </li></ul><br><iframe width="560" height="315" src="https://www.youtube.com/embed/C7utdhh6UCk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Quem se importa, por favor, debaixo do gato. </p><a name="habracut"></a><br><p>  Meu nome √© Alexey Vakhov.  Eu trabalho como diretor t√©cnico em Uchi.ru.  Hospedamos em nuvens p√∫blicas.  N√≥s ativamente usamos Terraform, Ansible.  Desde ent√£o, mudamos completamente para o Docker.  Muito satisfeito.  Qu√£o felizes, qu√£o felizes estamos - eu direi. </p><br><p><img src="https://habrastorage.org/webt/l3/zh/6x/l3zh6xrikma1bku1ks6vo7hixva.png"></p><br><p>  A empresa Uchi.ru est√° envolvida na produ√ß√£o de produtos para educa√ß√£o escolar.  Temos uma plataforma principal na qual as crian√ßas resolvem problemas interativos em v√°rios assuntos na R√∫ssia, Brasil e EUA.  Realizamos olimp√≠adas online, concursos, clubes, acampamentos.  Todos os anos essa atividade est√° crescendo. </p><br><p><img src="https://habrastorage.org/webt/ms/m8/8h/msm88h-eoc67vkjnokat3ssq_wo.png"></p><br><p>  Do ponto de vista da engenharia, a pilha da Web cl√°ssica (Ruby, Python, NodeJS, Nginx, Redis, ELK, PostgreSQL).  A principal caracter√≠stica √© que muitas aplica√ß√µes.  Os aplicativos est√£o hospedados em todo o mundo.  Todos os dias h√° lan√ßamentos em produ√ß√£o. </p><br><p>  A segunda caracter√≠stica √© que nossos esquemas mudam com muita frequ√™ncia.  Eles pedem para criar um novo aplicativo, interromper o antigo, adicionar cron para trabalhos em segundo plano.  A cada 2 semanas, h√° uma nova Olimp√≠ada - esta √© uma nova aplica√ß√£o.  √â tudo necess√°rio para acompanhar, monitorar, fazer backup.  Portanto, o ambiente √© superdin√¢mico.  Dinamismo √© a nossa principal dificuldade. </p><br><p><img src="https://habrastorage.org/webt/gm/dn/vu/gmdnvuag9g19b-bkzqbamcrwdw8.png"></p><br><p>  Nossa unidade de trabalho √© o site.  Em termos de provedores de nuvem, este √© o Projeto.  Nosso site √© uma entidade completamente isolada, com uma API e uma sub-rede privada.  Quando entramos no pa√≠s, procuramos provedores de nuvem locais.  Em todo lugar n√£o h√° Google e Amazon.  √Äs vezes acontece que n√£o h√° API para o provedor de nuvem.  Externamente, publicamos VPN e HTTP, HTTPS para balanceadores.  Todos os outros servi√ßos se comunicam dentro da nuvem. </p><br><p><img src="https://habrastorage.org/webt/vz/b6/w2/vzb6w2yehx_arktffwsjxildnhe.png"></p><br><p>  Para cada site, criamos nosso pr√≥prio reposit√≥rio Ansible.  O reposit√≥rio possui hosts.yml, playbook, pap√©is e 3 pastas secretas, sobre as quais falarei mais adiante.  Isto √© terraform, provis√£o, roteamento.  Somos f√£s da padroniza√ß√£o.  Nosso reposit√≥rio sempre deve ser chamado de "nome ansible do site".  N√≥s padronizamos cada nome de arquivo, estrutura interna.  Isso √© muito importante para maior automa√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/v3/a0/kk/v3a0kke8aauqojk4hj5blhgwmt4.png"></p><br><p>  Montamos o Terraform h√° um ano e meio, ent√£o o usamos.  Terraform sem m√≥dulos, sem estrutura de arquivos (estrutura plana √© usada).  Estrutura do arquivo Terraform: 1 servidor - 1 arquivo, configura√ß√µes de rede e outras configura√ß√µes.  Usando terraform, descrevemos servidores, unidades, dom√≠nios, s3-buckets, redes e assim por diante.  Terraform no local est√° preparando totalmente o ferro. </p><br><p><img src="https://habrastorage.org/webt/wq/qz/ly/wqqzly1s4_6brivoh4hkeyvexmu.png"></p><br><p>  Terraform cria o servidor, ent√£o o conjunto rola esses servidores.  Devido ao fato de usarmos a mesma vers√£o do sistema operacional em todos os lugares, escrevemos todas as fun√ß√µes do zero.  As fun√ß√µes poss√≠veis geralmente s√£o publicadas na Internet para todos os sistemas operacionais que n√£o funcionam em nenhum lugar.  Todos n√≥s assumimos pap√©is Ansible e deixamos apenas o que precis√°vamos.  Pap√©is Ansible Padronizados.  Temos 6 cartilhas b√°sicas.  Quando lan√ßado, o Ansible instala uma lista padr√£o de software: OpenVPN, PostgreSQL, Nginx, Docker.  Kubernetes que n√£o usamos. </p><br><p><img src="https://habrastorage.org/webt/fh/x4/i4/fhx4i4ztn5fvmjj6uivdbkdrub8.png"></p><br><p>  Usamos Consul + Nomad.  Estes s√£o programas muito simples.  Execute 2 programas escritos em Golang em cada servidor.  O Consul √© respons√°vel pela descoberta de servi√ßos, verifica√ß√£o de integridade e valor-chave para armazenar a configura√ß√£o.  Nomad √© respons√°vel pelo agendamento, pela implanta√ß√£o.  O Nomad lan√ßa cont√™ineres, fornece lan√ßamentos, incluindo atualiza√ß√µes cont√≠nuas na verifica√ß√£o de integridade, permite executar cont√™ineres laterais.  O cluster √© f√°cil de expandir ou vice-versa para reduzir.  Nomad suporta cron distribu√≠do. </p><br><p><img src="https://habrastorage.org/webt/dc/ic/sm/dcicsmnhzdduqbnxsdpe6ewkvws.png"></p><br><p>  Depois de entrar no site, o Ansible executa o manual localizado no diret√≥rio de provis√£o.  O manual deste diret√≥rio √© respons√°vel pela instala√ß√£o do software no cluster de docker usado pelos administradores.  Instale o software prometheus, grafana e secret shaman. </p><br><p>  Shaman √© um painel da web para n√¥mades.  O Nomad √© de n√≠vel baixo e eu realmente n√£o quero deixar desenvolvedores.  No shaman, vemos uma lista de aplicativos, fornecemos aos desenvolvedores um bot√£o de implanta√ß√£o de aplicativos.  Os desenvolvedores podem alterar as configura√ß√µes: adicionar cont√™ineres, vari√°veis ‚Äã‚Äãde ambiente, iniciar servi√ßos. </p><br><p><img src="https://habrastorage.org/webt/cm/jw/ry/cmjwryicd-9dvhlpg--bhfrfe9w.png"></p><br><p>  E, finalmente, o componente final do site √© roteamento.  O roteamento √© armazenado no armazenamento K / V do c√¥nsul, ou seja, existe um link entre upstream, servi√ßo, URL, etc.  Em cada balanceador, h√° um modelo Consul que gera uma configura√ß√£o nginx e a recarrega.  Uma coisa muito confi√°vel, nunca tivemos problemas com isso.  A caracter√≠stica desse esquema √© que o tr√°fego aceita o nginx padr√£o e voc√™ sempre pode ver qual configura√ß√£o foi gerada e trabalhar como no nginx padr√£o. </p><br><p><img src="https://habrastorage.org/webt/rn/ew/7g/rnew7gm_fe4gcc57clp3f41ob68.png"></p><br><p>  Assim, cada site consiste em 5 camadas.  Com terraform, personalizamos o hardware.  Ansible realizamos a configura√ß√£o b√°sica dos servidores, coloque o docker-cluster.  A provis√£o acumula o software do sistema.  O roteamento direciona o tr√°fego no site.  Aplicativos cont√©m aplicativos de usu√°rio e aplicativos de administrador. </p><br><p>  Depuramos essas camadas por um longo tempo para que fossem t√£o id√™nticas quanto poss√≠vel.  Provis√£o, roteamento corresponde a 100% entre sites.  Portanto, para desenvolvedores, cada site √© absolutamente o mesmo. </p><br><p>  Se os profissionais de TI mudarem de um projeto para outro, eles cair√£o em um ambiente completamente t√≠pico.  Em geral, n√£o foi poss√≠vel tornar as configura√ß√µes de firewall e VPN id√™nticas para diferentes provedores de nuvem.  Com uma rede, todos os provedores de nuvem funcionam de maneira diferente.  O Terraform est√° em toda parte, porque cont√©m designs espec√≠ficos para cada provedor de nuvem. </p><br><p><img src="https://habrastorage.org/webt/36/kg/ti/36kgtipfv8rl9lhjevdjhhiwp5m.png"></p><br><p>  Temos 14 locais de produ√ß√£o.  Surge a pergunta: como gerenci√°-los?  Criamos o 15¬∫ site mestre, no qual permitimos apenas administradores.  Ela trabalha em um esquema de federa√ß√£o. </p><br><p>  A id√©ia foi tirada de Prometeu.  H√° um modo no prometheus quando instalamos o prometheus em cada site.  Publicamos o Prometheus por meio da autoriza√ß√£o de autentica√ß√£o b√°sica HTTPS.  O mestre do Prometheus coleta apenas as m√©tricas necess√°rias do prometheus remoto.  Isso possibilita comparar m√©tricas de aplicativos em diferentes nuvens, encontrar os aplicativos mais baixados ou descarregados.  A notifica√ß√£o centralizada (alerta) passa pelo mestre do prometheus para administradores.  Os desenvolvedores recebem alertas do prometheus local. </p><br><p><img src="https://habrastorage.org/webt/cw/c9/yd/cwc9yd3hpmbhbxvlz0ygacktloa.png"></p><br><p>  O xam√£ √© configurado da mesma maneira.  Por meio do site principal, os administradores podem implantar, configurar em qualquer site por meio de uma √∫nica interface.  Resolvemos uma classe de problemas suficientemente grande sem sair deste site mestre. </p><br><p><img src="https://habrastorage.org/webt/kz/ul/hi/kzulhi1jrz8c3bssubwqzremd6g.png"></p><br><p>  Vou te contar como mudamos para o docker.  Este processo √© muito lento.  Passamos cerca de 10 meses.  No ver√£o de 2017, t√≠nhamos 0 cont√™ineres de produ√ß√£o.  Em abril de 2018, fizemos a dockeriza√ß√£o e lan√ßamos nosso aplicativo mais recente em produ√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/h5/9t/ib/h59tibngi0uru-f4vehjhnq3e1c.png"></p><br><p>  N√≥s somos do mundo do rubi nos trilhos.  Costumava haver 99% das aplica√ß√µes Ruby on Rails.  O Rails passa por Capistrano.  Tecnicamente, o Capistrano funciona da seguinte maneira: o desenvolvedor inicia o deploy do cap, o capistrano acessa todos os servidores de aplicativos via ssh, pega a vers√£o mais recente do c√≥digo, coleta ativos, migra√ß√µes de bancos de dados.  Capistrano faz um link simb√≥lico para a nova vers√£o do c√≥digo e envia um sinal USR2 para o aplicativo da web.  Nesse sinal, o servidor da web pega um novo c√≥digo. </p><br><p><img src="https://habrastorage.org/webt/il/us/4e/ilus4ejwfkd6cvjnmjrcln2ugyy.png"></p><br><p>  O √∫ltimo passo na janela de encaixe n√£o √© feito assim.  Na janela de encaixe, √© necess√°rio parar o cont√™iner antigo e elevar o novo cont√™iner.  Isso levanta a quest√£o: como mudar o tr√°fego?  No mundo da nuvem, a descoberta de servi√ßos √© respons√°vel por isso. </p><br><p><img src="https://habrastorage.org/webt/k3/il/ig/k3iligqv5uphvlp1l3cvkmbggem.png"></p><br><p>  Portanto, adicionamos o consul em cada site.  O Consul foi adicionado porque eles usaram o Terraform.  Envolvemos todas as configura√ß√µes do nginx em um modelo de consul.  Formalmente, a mesma coisa, mas j√° est√°vamos prontos para gerenciar dinamicamente o tr√°fego dentro dos sites. </p><br><p><img src="https://habrastorage.org/webt/u9/qg/ag/u9qgagdnxiwo4lowkqi7micapqu.png"></p><br><p>  Em seguida, escrevemos um script ruby ‚Äã‚Äãque coletava uma imagem em um dos servidores, a enviava para o registro, passava o ssh para cada servidor, pegava novos e interrompia os cont√™ineres antigos, registrando-os no consul.  Os desenvolvedores tamb√©m continuaram executando a implementa√ß√£o de limite, mas os servi√ßos j√° estavam em execu√ß√£o no docker. </p><br><p>  Lembro-me de que havia duas vers√µes do script, a segunda era bastante avan√ßada, houve uma atualiza√ß√£o cont√≠nua, quando um pequeno n√∫mero de cont√™ineres parou, novos surgiram, o c√¥nsul Helfcheki esperou e seguiu em frente. </p><br><p><img src="https://habrastorage.org/webt/07/fx/gk/07fxgkf2fcvnhs8gpfjfrygalxs.png"></p><br><p>  Ent√£o eles perceberam que este √© um m√©todo sem sa√≠da.  O script aumentou para 600 linhas.  O pr√≥ximo passo na programa√ß√£o manual substitu√≠mos o Nomad.  Escondendo os detalhes do trabalho do desenvolvedor.  Ou seja, eles ainda chamavam cap deploy, mas por dentro j√° havia uma tecnologia completamente diferente. </p><br><p><img src="https://habrastorage.org/webt/4j/o-/ms/4jo-ms4v5mx1q4cn6sqt6n0jr4a.png"></p><br><p>  E, no final, movemos a implanta√ß√£o para a interface do usu√°rio e tiramos o acesso ao servidor, deixando o bot√£o verde de implanta√ß√£o e a interface de controle. </p><br><p>  Em princ√≠pio, essa transi√ß√£o acabou sendo obviamente longa, mas evitamos o problema que encontrei algumas vezes. </p><br><p>  Existe algum tipo de pilha, sistema ou algo parecido.  Khachennaya j√° apenas em retalhos.  O desenvolvimento de uma nova vers√£o come√ßa.  Ap√≥s alguns meses ou alguns anos, dependendo do tamanho da empresa, na nova vers√£o menos da metade da funcionalidade necess√°ria √© implementada, e a vers√£o antiga ainda escapou.  E esse novo tamb√©m se tornou muito legado.  E √© hora de come√ßar uma nova terceira vers√£o do zero.  Em geral, este √© um processo sem fim. </p><br><p>  Portanto, sempre movemos a pilha inteira como um todo.  Em pequenos passos, tortos, com muletas, mas inteiramente.  N√£o podemos atualizar, por exemplo, o mecanismo do docker em um site.  √â necess√°rio atualizar em qualquer lugar, se houver um desejo. </p><br><p><img src="https://habrastorage.org/webt/qy/31/jr/qy31jrpbehnyyrcozqaxnj41jk8.png"></p><br><p>  Implementa√ß√µes.  Todas as instru√ß√µes da janela de encaixe lan√ßam 10 cont√™ineres nginx ou 10 cont√™ineres redis na doca.  Este √© um mau exemplo, porque as imagens j√° est√£o montadas, as imagens s√£o claras.  Empacotamos nossos aplicativos de trilhos na janela de encaixe.  O tamanho das imagens da janela de encaixe era de 2 a 3 gigabytes.  Eles aparecer√£o n√£o t√£o r√°pido. </p><br><p><img src="https://habrastorage.org/webt/2q/lx/bf/2qlxbfo5lnhpjfxcjtlljrntgxy.png"></p><br><p>  O segundo problema veio da web hipster.  Uma web moderna √© sempre o Github Flow.  Em 2011, houve um post de √©poca que o Github Flow dirige, de modo que toda a web rola.  Como √© isso?  O ramo mestre √© sempre produ√ß√£o.  Ao adicionar novas funcionalidades, fazemos uma ramifica√ß√£o.  Quando fazemos fus√£o, revisamos o c√≥digo, executamos testes, aumentamos o ambiente de teste.  Neg√≥cios que procuram um ambiente de prepara√ß√£o.  No momento X, se tudo der certo, mesclaremos o ramo no master e iniciaremos a produ√ß√£o. </p><br><p>  No capistrano, isso funcionou bem, porque foi criado para isso.  O Docker sempre nos vende um pipeline.  Montou o recipiente.  O cont√™iner pode ser transferido para o desenvolvedor, testador, transferido para produ√ß√£o.  Mas no momento da mesclagem no mestre, o c√≥digo j√° √© diferente.  Todas as imagens da janela de encaixe que foram coletadas da ramifica√ß√£o do recurso, elas n√£o foram coletadas do mestre. </p><br><p><img src="https://habrastorage.org/webt/vl/th/8g/vlth8gjbcyby-rpamtltaijqxcy.png"></p><br><p>  Como fizemos isso?  Coletamos a imagem e a colocamos no registro da janela de encaixe local.  Depois disso, fazemos o restante das opera√ß√µes: migra√ß√£o, implanta√ß√£o na produ√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/1i/kb/yu/1ikbyuh88pytsfprkkwdi6_6ppq.png"></p><br><p>  Para montar rapidamente esta imagem, usamos o Docker-in-Docker.  Na Internet, todo mundo escreve que isso √© um antipadr√£o, ele trava.  N√£o t√≠nhamos nada disso.  Quantos j√° trabalham com ele nunca tiveram problemas.  Encaminhamos o diret√≥rio / var / lib / docker para o servidor principal usando o volume Persistent.  Todas as imagens intermedi√°rias est√£o no servidor principal.  A montagem de uma nova imagem cabe em alguns minutos. </p><br><p><img src="https://habrastorage.org/webt/6q/_g/67/6q_g67tuzx_n078pff6-aisdvdc.png"></p><br><p>  Para cada aplicativo, criamos um registro da janela de encaixe interna local e nosso volume de compila√ß√£o.  Porque o docker salva todas as camadas no disco e √© dif√≠cil de limpar.  Agora sabemos a utiliza√ß√£o do disco de cada registro da janela de encaixe local.  Sabemos a quantidade de disco necess√°ria.  Voc√™ pode receber alertas atrav√©s do Grafana centralizado e limpo.  Enquanto limpamos as m√£os deles.  Mas vamos automatizar isso. </p><br><p><img src="https://habrastorage.org/webt/mf/py/wj/mfpywjgwpsj0tbqb6vvvyzz8_1u.png"></p><br><p>  Outro ponto.  Imagem do Docker coletada.  Agora, essa imagem precisa ser decomposta em servidores.  Ao copiar uma imagem grande do Docker, a rede n√£o suporta.  Na nuvem, temos 1 Gbit / s.  H√° um desligamento global na nuvem.  Agora, estamos implantando uma imagem do docker em 4 servidores de produ√ß√£o pesada.  No gr√°fico, voc√™ pode ver o disco trabalhado em 1 pacote de servidores.  Em seguida, o segundo pacote de servidores √© implantado.  Abaixo voc√™ pode ver a utiliza√ß√£o do canal.  Cerca de 1 Gbit / s, quase puxamos.  N√£o h√° mais acelera√ß√£o l√°. </p><br><p><img src="https://habrastorage.org/webt/lk/eo/hl/lkeohl4fjm-y97kmp3hyogr3p1a.png"></p><br><p>  Minha produ√ß√£o favorita √© a √Åfrica do Sul.  H√° ferro muito caro e lento.  Quatro vezes mais caro que na R√∫ssia.  Existe uma internet muito ruim.  Internet no n√≠vel do modem, mas n√£o com bugs.  L√°, lan√ßamos aplicativos em 40 minutos, levando em considera√ß√£o o ajuste de caches, par√¢metros de tempo limite. </p><br><p><img src="https://habrastorage.org/webt/zl/8x/ig/zl8xig0k9liveeiuzoykh-ctgwm.png"></p><br><p>  O √∫ltimo problema que me preocupou antes do docker entrar em contato foi a carga.  De fato, a carga √© a mesma que sem uma docker com ferro id√™ntico.  A √∫nica nuance que encontramos em apenas um ponto.  Se voc√™ coletar logs do mecanismo do Docker por meio do driver fluentd interno, a uma carga de cerca de 1000 rps, o buffer interno do fluentd come√ßa a ficar desarrumado e as solicita√ß√µes come√ßam a ficar mais lentas.  Tiramos o registro em cont√™ineres laterais.  No n√≥mada, isso √© chamado de log-shipper.  Um cont√™iner pequeno fica ao lado de um cont√™iner de aplicativo grande.  A √∫nica tarefa √© busc√°-lo e envi√°-lo para um reposit√≥rio centralizado. </p><br><p><img src="https://habrastorage.org/webt/8r/fv/7x/8rfv7xzfamwjrwemisa1laingzy.png"></p><br><p>  Quais foram os problemas / solu√ß√µes / desafios.  Eu tentei analisar qual era a tarefa.  As caracter√≠sticas de nossos problemas s√£o: </p><br><ul><li>  muitas aplica√ß√µes independentes </li><li>  mudan√ßas cont√≠nuas na infraestrutura </li><li>  Fluxo do Github e imagens grandes de janela de encaixe </li></ul><br><p><img src="https://habrastorage.org/webt/da/xm/jm/daxmjmflat8cz4a5b-2nmx4pip4.png"></p><br><p>  Nossas solu√ß√µes </p><br><ul><li>  Federa√ß√£o de clusters de docker.  Do ponto de vista do manuseio, √© dif√≠cil.  Mas o docker √© bom em implementar a funcionalidade comercial na produ√ß√£o.  Trabalhamos com dados pessoais e temos certifica√ß√£o em todos os pa√≠ses.  Em um site isolado, essa certifica√ß√£o √© f√°cil de passar.  Durante a certifica√ß√£o, surgem todas as perguntas: onde voc√™ est√° hospedando, como possui um provedor de nuvem, onde armazena dados pessoais, onde faz backup e quem tem acesso aos dados.  Quando tudo est√° isolado, √© muito mais f√°cil descrever o c√≠rculo de suspeitos e monitorar tudo isso √© muito mais f√°cil. </li><li>  Orquestra√ß√£o.  √â claro que os kubernetes.  Ele est√° em todo lugar.  Mas quero dizer que o Consul + Nomad √© uma solu√ß√£o completamente de produ√ß√£o. </li><li>  Montagem de imagens.  Voc√™ pode criar rapidamente imagens no Docker-in-Docker. </li><li>  Ao usar o Docker, tamb√©m √© poss√≠vel manter uma carga de 1000 rps. </li></ul><br><p>  Vetor de dire√ß√£o de desenvolvimento </p><br><p>  Agora, um dos grandes problemas √© a dessincroniza√ß√£o de vers√µes de software nos sites.  Anteriormente, configuramos o servidor manualmente.  Ent√£o nos tornamos engenheiros de devops.  Agora configure o servidor usando ansible.  Agora temos unifica√ß√£o total, padroniza√ß√£o.  Introduzimos o pensamento comum na cabe√ßa.  N√£o podemos consertar o PostgreSQL com as m√£os no servidor.  Se voc√™ precisar de algum tipo de ajuste fino em apenas 1 servidor, pensamos em como espalhar essa configura√ß√£o em todos os lugares.  Se voc√™ n√£o padronizar, haver√° um zool√≥gico de configura√ß√µes. </p><br><p>  Estou encantado e muito feliz por termos sa√≠do da caixa gratuitamente de uma infraestrutura de trabalho realmente muito boa. </p><br><p><img src="https://habrastorage.org/webt/w6/nz/pw/w6nzpwpzt1tsxifw0gksrvoplpg.png"></p><br><p>  Voc√™ pode me adicionar no facebook.  Se fizermos algo de bom, vou escrever sobre isso. </p><br><p>  Perguntas: </p><br><p>  Qual √© a vantagem do modelo Consul em rela√ß√£o ao modelo Ansible, por exemplo, para configurar regras de firewall e muito mais? </p><br><p>  Resposta: Agora temos tr√°fego de balanceadores externos indo diretamente para cont√™ineres.  N√£o h√° ningu√©m no meio.  Uma configura√ß√£o √© formada l√° que encaminha os endere√ßos IP e as portas do cluster.  Al√©m disso, temos todas as configura√ß√µes de saldo em K / V no Consul.  Temos a ideia de fornecer configura√ß√µes de roteamento aos desenvolvedores por meio de uma interface segura, para que eles n√£o quebrem nada. </p><br><p>  Pergunta: Em rela√ß√£o √† homogeneidade de todos os sites.  Realmente, n√£o h√° solicita√ß√µes de empresas ou de desenvolvedores que voc√™ precise implementar algo fora do padr√£o neste site?  Por exemplo, tarantool com cassandra. </p><br><p>  Resposta: Isso acontece, mas √© muito raro.  Assim, elaboramos um artefato separado interno.  Existe um problema, mas √© raro. </p><br><p>  Pergunta: A solu√ß√£o para o problema de entrega √© usar um registro do docker privado em cada site e, a partir da√≠, j√° √© r√°pido obter imagens do docker. </p><br><p>  Resposta: De qualquer forma, a implanta√ß√£o ser√° executada na rede, pois estamos implantando a imagem do docker em 15 servidores simultaneamente.  Descansamos contra a rede.  Dentro da rede, 1 Gbit / s. </p><br><p>  Pergunta: Muitos cont√™ineres de docker s√£o baseados na mesma pilha de tecnologia? </p><br><p>  Resposta: Ruby, Python, NodeJS. </p><br><p>  Pergunta: Com que frequ√™ncia voc√™ testa ou verifica as imagens do docker em busca de atualiza√ß√µes?  Como voc√™ resolve problemas de atualiza√ß√£o, por exemplo, quando o glibc, openssl precisa ser corrigido em todas as janelas de encaixe? </p><br><p>  Resposta: Se voc√™ encontrar esse erro, vulnerabilidade, nos sentaremos por uma semana e o repararemos.  Se voc√™ precisar implantar, podemos implantar a nuvem inteira (todos os aplicativos) do zero at√© a federa√ß√£o.  Podemos clicar em todos os bot√µes verdes para a implanta√ß√£o de aplicativos e sair para beber ch√°. </p><br><p>  Pergunta: Voc√™ vai lan√ßar seu xam√£ no c√≥digo-fonte aberto? </p><br><p>  Resposta: Aqui, Andrei (aponta para a pessoa da plat√©ia) promete que deixemos o xam√£ no outono.  Mas a√≠ voc√™ precisa adicionar suporte ao kubernetes.  O opensource sempre deve ser melhor. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt439382/">https://habr.com/ru/post/pt439382/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt439372/index.html">Quer jogar um detetive? Encontre o bug em uma fun√ß√£o do Midnight Commander</a></li>
<li><a href="../pt439374/index.html">Para aqueles que querem jogar detetive: encontre o erro na fun√ß√£o do Midnight Commander</a></li>
<li><a href="../pt439376/index.html">Clube de Interesse</a></li>
<li><a href="../pt439378/index.html">Livro (de ser?). Reflex√µes sobre a natureza da mente. Parte I</a></li>
<li><a href="../pt439380/index.html">Como criei uma extens√£o para o c√≥digo Atom e VS: experi√™ncia e fontes pessoais</a></li>
<li><a href="../pt439384/index.html">Modelagem Metr√≥pole</a></li>
<li><a href="../pt439388/index.html">Rob√¥s no jornalismo ou como usar a intelig√™ncia artificial para criar conte√∫do</a></li>
<li><a href="../pt439390/index.html">As melhores inova√ß√µes das redes sociais em 2018</a></li>
<li><a href="../pt439392/index.html">A temporada de campeonato 2019 est√° aberta! SNA Hackathon Ala ML Boot Camp 8 come√ßa</a></li>
<li><a href="../pt439394/index.html">Como programador, os kernels do datacenter escreveram</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>