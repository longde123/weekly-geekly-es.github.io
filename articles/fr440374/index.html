<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👨🏽‍🎤 📯 👊🏼 Les fonctions Yandex envoient du courrier 🏮 🚾 💆🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, nous allons créer le soi-disant La fonction Yandex (le nom officiel de Yandex Cloud Functions ), qui conspire avec le service de messager...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Les fonctions Yandex envoient du courrier</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/440374/"><img src="https://habrastorage.org/webt/-m/wh/t7/-mwht7iegxhuf9jusdci3-n7bpw.jpeg" alt="Caractéristiques de Yandex"><br><br>  Aujourd'hui, nous allons créer le soi-disant  <i><b>La fonction Yandex</b></i> (le nom officiel de <i><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow">Yandex Cloud Functions</a></i> ), qui conspire avec le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>service de</i></a> messagerie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>SendGrid,</i></a> enverra du "savon" aux utilisateurs qui dorment paisiblement ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>je plaisante</i></a> - je sais que nous sommes tous contre le spam). <br><br>  Je suis aussi un adversaire (mais sans fanatisme) des serveurs traditionnels, et un partisan du soi-disant  solutions sans <i>serveur</i> (sans serveur), parce que je n'aime pas (et ne sais vraiment pas comment) administrer le serveur, et encore plus - payer pour le temps où ils ne sont pas chargés.  Les fonctions sont une autre affaire.  Quelqu'un les sert sans moi et je ne paie que pour les appels.  Début octobre 2019, Yandex a présenté ses <i>fonctions cloud Yandex</i> - il semble être le premier <i>sans serveur</i> de la Fédération de Russie.  Et ce qui est particulièrement agréable - pour les compétences d'Alice, ils sont généralement libres, ils sont donc depuis dans le domaine de ma vision périphérique.  Mais commençons. <br><a name="habracut"></a><br>  Imaginez un tel scénario.  Votre application (par exemple, la compétence Alice’s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i><b>Remember and Forget</b></i></a> qui, soit dit en passant, fonctionne également sur les <i>fonctions Yandex</i> ), propose à l’utilisateur d’acheter des produits numériques, par exemple, des options supplémentaires, et l’utilisateur effectue un paiement.  Un certain système de paiement (similaire au degré de confusion avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>Yandex.Money</i></a> ) traite le paiement et l'envoie à l'adresse que vous avez fournie (et nous aurons un lien pour appeler la <i>fonction Yandex</i> ) Demande <i>HTTP</i> contenant les détails du paiement, tels que le montant, le nom, le téléphone et email du payeur.  Mais nous voulons traiter ces données d'une certaine manière, par exemple: vérifier le montant, effectuer les entrées appropriées dans la base de données, envoyer des <i>SMS</i> et des <i>e</i> - <i>mails</i> aux utilisateurs avec confirmation de la réception du paiement et d'autres instructions.  Un tel <i><b>microservice</b></i> . <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><b><i>Alice se souvient de tout</i></b></a> sur la façon d'enregistrer à partir des <i>fonctions Yandex</i> dans la base de données <i>Cloud Firestore</i> dans le tutoriel (et à l'avenir, je pense, nous considérerons un exemple pour une autre base de données - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>Yandex Database</i></a> ).  Nous analyserons comment envoyer des <i>SMS aux</i> utilisateurs et intégrerons notre application avec <i>Yandex.Money</i> dans un avenir proche.  Maintenant, nous ne traiterons que de l'envoi de lettres. <br><br><h2>  1. Créez un compte dans SendGrid </h2><br><div class="spoiler">  <b class="spoiler_title">Remarque</b> <div class="spoiler_text">  SendGrid est juste mon choix, que j'ai fait pour une raison quelconque, et le principal est leur disponibilité d'un SDK prêt à l'emploi pour Node.js.  Vous pouvez choisir n'importe quel autre service de liste de diffusion. <br></div></div><br>  Nous allons <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>sur la page d'enregistrement du compte</i></a> et remplissons le formulaire d'inscription ici.  Ensuite, nous allons au <i>tableau de bord</i> , dans le panneau de navigation, sélectionnez <i>Email API -&gt; Guide d'intégration</i> , et sur le panneau principal - <i>Web API</i> et cliquez sur le bouton <i>Choisir</i> .  Tout est comme sur la photo: <br><br><img src="https://habrastorage.org/webt/pg/fb/h7/pgfbh7l3afq7zc2euvbnklqdoim.png" alt="Console dans SendGrid"><br><br>  À l'étape suivante, sélectionnez <i>Node.js</i> : <br><br><img src="https://habrastorage.org/webt/ae/ip/0y/aeip0y-m-yl_vvewbhcmasuhcga.png" alt="Choisir Node.js dans SendGrid"><br><br>  Ensuite, nous trouvons un nom pour notre clé <i>API</i> (il ne s'affichera que dans la console dans la liste des clés, et n'a rien à voir avec notre futur code; je viens de trouver une <i>clé de démonstration api</i> impérissable) et cliquez sur le bouton <i>Créer une clé</i> : <br><br><img src="https://habrastorage.org/webt/y6/ah/c0/y6ahc0j8lewypmyknq6qjuq0nik.png" alt="Création d'une API clé dans SendGrid"><br><br>  La clé est générée, nous la copions et la gardons dans le plus grand secret.  Et nous aurons un écran avec le bouton <i>Vérifier l'intégration</i> , comme dans l'image ci-dessous, mais pour l'instant nous n'appuierons pas dessus, mais nous allons écrire le code: <br><br><img src="https://habrastorage.org/webt/iq/1n/0s/iq1n0sazcac2tron51v9qxpb_ue.png" alt="Demande de confirmation d'intégration avec SendGrid"><br><br><h2>  2. Rédaction de code </h2><br>  Et le code lui-même, comme vous le voyez, est ridiculement petit - 22 lignes! <br><br><img src="https://habrastorage.org/webt/as/am/ce/asamcev3zizxt3dzp_xqrcxjp4c.png" alt="Code"><br><br>  À la ligne <i>8,</i> mon courrier est enregistré avec un code dur (et est donc timidement couvert) - vous indiquez le vôtre.  Dans la vraie vie, nous recevrons toutes les données de l'objet <i>événement</i> .  Par exemple, si la méthode <i>POST</i> ( <code>"Content-Type": "application/json"</code> ) transmet le champ de <i>messagerie</i> (propriété): <br><pre> <code class="plaintext hljs">{ ... "email": "user@example.com", ... }</code> </pre><br>  La valeur de ce champ peut être obtenue comme suit: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> body = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(event.body); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> email = body.email;</code> </pre><br>  Et si le champ <i>e</i> - <i>mail</i> est une propriété d'un autre champ - l'objet <i>utilisateur</i> (collection): <br><pre> <code class="plaintext hljs">{ ... "user": { ... "email": "user@example.com", ... }, ... }</code> </pre><br>  La valeur de ce champ peut être obtenue encore plus facilement: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { user } = event; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> email = user.email;</code> </pre><br>  Si l'adresse e-mail est transmise à la fonction dans l'URL (la soi-disant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>chaîne de requête URL</i></a> ), par exemple: <code>https://functions.yandexcloud.net/123abc? <b>email=user@example.com</b></code> <code>https://functions.yandexcloud.net/123abc? <b>email=user@example.com</b></code> <br>  La valeur du paramètre <i>e-mail</i> sera: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> email = event.queryStringParameters.email;</code> </pre> <br>  Pour jeter un œil à ce qui est exactement contenu dans l'objet <i>événement</i> , vous pouvez créer une simple <i>fonction Yandex</i> et la tordre avec des requêtes: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.handler = <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">event</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-string"><span class="hljs-string">'statusCode'</span></span>: <span class="hljs-number"><span class="hljs-number">200</span></span>, <span class="hljs-string"><span class="hljs-string">'headers'</span></span>: { <span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>: <span class="hljs-string"><span class="hljs-string">'application/json; charset=utf-8'</span></span> }, <span class="hljs-string"><span class="hljs-string">'body'</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(event), <span class="hljs-string"><span class="hljs-string">'isBase64Encoded'</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }; };</code> </pre> <br>  Plus (mais moins intelligible), cela est indiqué dans la documentation officielle <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>ici</i></a> . <br><br>  Donc, créez le répertoire du projet (par exemple, <i>mailer</i> ), allez-y, initialisez le projet, installez les dépendances: <br><br><pre> <code class="plaintext hljs">mkdir mailer cd mailer npm init -y npm i @sendgrid/mail email-validator dotenv</code> </pre><br>  Ici, seul le <i>package @ sendgrid / mail</i> est <i>requis</i> .  Le <i>package de validation de courrier électronique</i> vérifie la validité de l'adresse e-mail (comme je ne l'ai pas immédiatement deviné?), Mais si nous en sommes sûrs (il a longtemps été vérifié sans nous), nous ne pouvons pas l'installer (et, bien sûr, ne pas vérifier le code).  Le package <i>dotenv est</i> conçu pour lire les entrées du fichier <i>.env</i> en tant que variables d' <i>exécution</i> .  Mais les <i>fonctions Yandex</i> ont la capacité de placer ces variables directement dans l'environnement d'exécution.  Comment?  - Je vais le montrer ci-dessous.  Par conséquent, le package <i>dotenv ne peut</i> pas non plus être installé et le fichier <i>.env</i> ne <i>doit</i> pas être créé et le code du fichier <i>index.js</i> ne <i>doit</i> pas être modifié.  Mais ici, nous avons installé ce package, nous créons <i>donc des fichiers</i> <i>index.js</i> et <i>.env</i> : <br><br><pre> <code class="plaintext hljs">touch index.js touch .env</code> </pre><br>  Dans le fichier <i>index.js</i> , <i>nous</i> écrivons 22 lignes de code affichées dans la capture d'écran ci-dessus (modifier le courrier uniquement à la ligne <i># 8</i> ), et dans le fichier <i>.env</i> (sans guillemets ni signes de ponctuation), spécifiez une paire - le nom / la valeur de la clé <i>API</i> , qui nous avons récemment obtenu dans la console <i>SendGrid</i> : <br>  <i>SENDGRID_API_KEY = votre-clé-très-secrète-sendgrid-api</i> <br><br>  Et si vous voulez moins de travail, clonez le référentiel, installez les packages: <br><br><pre> <code class="plaintext hljs">git clone https://github.com/stmike/ycf-sendgrid-mailer-tutorial.git cd ycf-sendgrid-mailer-tutorial npm i</code> </pre><br>  Dans le fichier <i>index.js</i> , à la ligne <i>8,</i> modifiez le courrier;  créez le fichier <i>.env</i> dans le répertoire racine et spécifiez le nom / la valeur de la clé <i>API</i> , comme indiqué un peu ci-dessus. <br><br><h2>  3. Déployer </h2><br>  Plus ou moins distinctement et en détail sur <i>Yandex.Cloud</i> et comment y placer <i>des fonctions Yandex est</i> décrit dans mon article <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><i><b>Alice dans le pays de Bitrix</b></i></a> - je l'envoie aux ignorants de ce pays, et pour tout le reste (et ceux qui sont revenus) - ci-après une petite bande dessinée (c.-à-d. e. une série d'images et de texte). <br><br>  Nous créons une archive <i>zip</i> (appelons-la, par exemple, <i>mailer.zip</i> ), dans laquelle nous incluons le répertoire <i>node_modules</i> et les <i>fichiers .env, index.js</i> - le tout depuis le répertoire de notre projet: <br><br><img src="https://habrastorage.org/webt/mm/t4/wo/mmt4wo_3lrmvfsmu_jb1zvqosdi.png" alt="Archive du projet"><br><br>  Nous créons une fonction avec le nom ... correctement - <i>mailer</i> , sélectionnez l' <i>éditeur</i> dans le menu de navigation de gauche, remplissez les champs nécessaires et passez à l'onglet d' <i>archive ZIP et</i> chargez notre archive <i>mailer.zip</i> : <br><br><img src="https://habrastorage.org/webt/3_/lm/kp/3_lmkpmibz5zreymkt0ablnofnc.png" alt="Télécharger l'archive"><br><br>  Et voici l'opportunité mentionnée précédemment de télécharger la <i>clé API</i> directement ici, et de ne pas créer le fichier <i>.env</i> dans le projet, et de ne pas installer le package <i>dotenv</i> .  Mais nous avons déjà fait tout cela, donc je le montre juste pour information.  C'est-à-dire qu'il n'est pas nécessaire de dupliquer! <br><br><img src="https://habrastorage.org/webt/_k/qt/rz/_kqtrzgehcja5njtxhxgq1b2sqi.png" alt="Variables d'environnement"><br><br>  Maintenant, dans le coin supérieur droit, cliquez sur le bouton <i>Créer une version</i> et attendez quelques secondes.  Lorsque tout sera prêt, nous irons automatiquement à la section <i>Présentation</i> .  Là, nous allons activer l'option <i>Fonction publique</i> afin que vous puissiez interagir avec elle depuis le monde extérieur. <br><br><img src="https://habrastorage.org/webt/bx/7a/cf/bx7acfdqk78xywz_nlpq3osecxo.png" alt="Présentation des fonctionnalités"><br><br>  Voir le lien bleu à côté <i>du lien d'appel</i> ?  Cliquez sur elle.  Une fenêtre de navigateur vide va s'ouvrir ... Mais attendez - j'ai reçu une lettre: <br><br><img src="https://habrastorage.org/webt/ty/im/pe/tyimpe1b_kbkkd5_ztjmmssvcqk.png" alt="Courriel"><br><br>  Vous pouvez maintenant revenir à la console <i>SendGrid</i> et cliquer sur le bouton <i>Vérifier l'intégration</i> .  Le système vérifiera tout sur ses canaux, et par conséquent devrait retourner un tel écran: <br><br><img src="https://habrastorage.org/webt/f-/pz/gn/f-pzgnxkutupsgqlyutkhh5pwci.png" alt="Confirmation d'intégration"><br><br>  Donc, les gars (et les filles, bien sûr) - tout est vraiment très simple et élégant!  Il y aura plus d'articles.  À qui il est intéressant de lire, abonnez-vous pour ne pas manquer.  Vous pouvez vous abonner ici ou en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><i>télégramme</i></a> . <br><br><h2>  4. Donuts </h2><br> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" rel="nofollow"><img src="https://habrastorage.org/webt/rk/dv/cw/rkdvcwukhwm_dzin-9t_kgszgj0.jpeg" alt="Donat"></a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr440374/">https://habr.com/ru/post/fr440374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr440362/index.html">Le scooter électrique Xiaomi M365 est sensible au piratage avec la possibilité de contrôler à distance</a></li>
<li><a href="../fr440364/index.html">Vous savez kilo, méga et concert. Et ronne et cuecca?</a></li>
<li><a href="../fr440366/index.html">Cycle de vie d'un article sur Habré: on écrit un habraparser</a></li>
<li><a href="../fr440370/index.html">Conditions d'utilisation: 99% des utilisateurs ne les comprennent tout simplement pas</a></li>
<li><a href="../fr440372/index.html">Mon compilateur Pascal et l'art contemporain polonais</a></li>
<li><a href="../fr440378/index.html">Retour aux microservices avec Istio. 2e partie</a></li>
<li><a href="../fr440382/index.html">200 est-il bon ou mauvais?</a></li>
<li><a href="../fr440386/index.html">Libérer la gestion des erreurs en éliminant les erreurs</a></li>
<li><a href="../fr440388/index.html">Intervalles: la prochaine évolution C ++</a></li>
<li><a href="../fr440390/index.html">Le monde diversifié des systèmes embarqués et la place d'Embox dans celui-ci</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>