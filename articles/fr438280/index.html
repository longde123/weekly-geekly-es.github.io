<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏥 🔻 💨 "Supprimer" des objets dans Django 🙊 🧑‍🤝‍🧑 🍄</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tôt ou tard, les développeurs sont confrontés à la tâche de supprimer les données inutiles. Et plus le service est compliqué, plus vous devez prendre ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>"Supprimer" des objets dans Django</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/438280/"><img src="https://habrastorage.org/webt/6h/-4/-w/6h-4-wzp5wlydal3wkp2df8aq5a.jpeg"><br><br>  Tôt ou tard, les développeurs sont confrontés à la tâche de supprimer les données inutiles.  Et plus le service est compliqué, plus vous devez prendre en compte les nuances.  Dans cet article, je vais décrire comment nous avons implémenté la «suppression» dans une base de données avec des centaines de liens. <br><a name="habracut"></a><br><h2>  Contexte </h2><br>  Pour surveiller l'opérabilité de la plupart des projets, <b>Mail.ru Group</b> et <b>VKontakte</b> utilisent un service de leur propre développement - <b>Monitoring</b> .  Commençant son histoire à partir de la fin de 2012, le projet est devenu en 6 ans un énorme système, qui a gagné en fonctionnalités.  La surveillance vérifie régulièrement la disponibilité des serveurs et l'exactitude des réponses aux demandes, collecte des statistiques sur la mémoire utilisée, l'utilisation du processeur, etc.  Lorsque les paramètres du serveur surveillé dépassent les valeurs autorisées, les responsables du serveur reçoivent des notifications dans le système et par SMS. <br><br>  Toutes les vérifications et les incidents sont enregistrés pour suivre la dynamique des performances du serveur, de sorte que la base de données a atteint l'ordre de centaines de millions d'enregistrements.  De nouveaux serveurs apparaissent périodiquement et les anciens cessent d'être utilisés.  Les informations sur les serveurs inutilisés doivent être supprimées du système de surveillance afin de: <i>a) ne pas surcharger l'interface avec des informations inutiles,</i> et <i>b) libérer des identifiants uniques</i> . <br><br><h2>  Effacer </h2><br>  J'ai sciemment dans le titre de l'article le mot «supprimer» écrit entre guillemets.  Il existe plusieurs façons de supprimer un objet du système: <br><br><ul><li>  complètement supprimé de la base de données; </li><li>  marquer les objets comme supprimés et se cacher de l'interface.  En tant que marqueur, vous pouvez utiliser Boolean ou DateTime pour une journalisation plus précise. </li></ul><br><h4>  Itération # 1 </h4><br>  Initialement, la première approche a été utilisée, lorsque nous avons simplement exécuté <code>object.delete()</code> et que l'objet a été supprimé avec toutes les dépendances.  Mais au fil du temps, nous avons dû abandonner cette approche, car un objet pouvait avoir des dépendances avec des millions d'autres objets, et la suppression en cascade des tables bloquées de manière rigide.  Et comme le service effectue des milliers de contrôles chaque seconde et les enregistre, le blocage des tables a entraîné un sérieux ralentissement du service, ce qui était inacceptable pour nous. <br><br><h4>  Itération # 2 </h4><br>  Pour éviter de longs verrous, nous avons décidé de supprimer les données par lots.  Cela permettrait d'enregistrer des données de surveillance réelles dans les intervalles entre les suppressions d'objets.  Une liste de tous les objets qui seront supprimés en cascade peut être obtenue par la méthode utilisée dans le panneau d'administration lors de la suppression d'un objet (lors de la confirmation de la suppression): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.contrib.admin.util <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> NestedObjects <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DEFAULT_DB_ALIAS collector = NestedObjects(using=DEFAULT_DB_ALIAS) collector.collect([obj]) objects_to_delete = collector.nested() <span class="hljs-comment"><span class="hljs-comment"># Recursive delete objects</span></span></code> </pre> <br>  La situation s'est améliorée: la charge a été répartie dans le temps, de nouvelles données ont commencé à être enregistrées plus rapidement.  Mais nous avons immédiatement rencontré le prochain écueil.  Le fait est que la liste des objets à supprimer est formée au tout début de la suppression, et si de nouveaux objets dépendants sont ajoutés pendant la suppression "portionnée", l'élément parent ne peut pas être supprimé. <br><br>  Nous avons immédiatement abandonné l'idée d'une erreur de suppression récursive pour collecter à nouveau des données sur les nouvelles dépendances ou interdire l'ajout d'enregistrements dépendants lors de la suppression, car <i>a) vous pouvez entrer dans une boucle infinie</i> ou <i>b) vous devez trouver tous les objets dépendants dans le code entier</i> . <br><br><h4>  Itération # 3 </h4><br>  Nous avons pensé au deuxième type de suppression, lorsque les données sont marquées et cachées de l'interface.  Initialement, cette approche a été rejetée, car il semblait être une tâche pendant au moins une semaine pour trouver toutes les requêtes et ajouter un filtre pour l'absence d'un parent supprimé.  En outre, il y avait une forte probabilité de manquer le code nécessaire, ce qui entraînerait des conséquences imprévisibles. <br><br>  Ensuite, nous avons décidé d'utiliser des décorateurs pour remplacer le gestionnaire de requêtes.  De plus, il vaut mieux voir le code que d'écrire cent mots. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exclude_objects_for_deleted_hosts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*fields)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Decorator that adds .exclude({field__}is_deleted=True) for model_class.objects.get_queryset :param fields: fields for exclude condition """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wrapper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model_class)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply_filters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(qs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filter_fields: qs = qs.exclude(**{ <span class="hljs-string"><span class="hljs-string">'{}is_deleted'</span></span>.format(<span class="hljs-string"><span class="hljs-string">'{}__'</span></span>.format(field) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-string"><span class="hljs-string">''</span></span>): <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> qs model_class.all_objects = copy.deepcopy(model_class.objects) filter_fields = set(fields) get_queryset = model_class.objects.get_queryset model_class.objects.get_queryset = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: apply_filters(get_queryset()) <span class="hljs-comment"><span class="hljs-comment"># save info about model decorator setattr(model_class, DECORATOR_DEL_HOST_ATTRIBUTE, filter_fields) return model_class return wrapper</span></span></code> </pre><br>  Le <code>exclude_objects_for_deleted_hosts(fields)</code> pour les champs spécifiés du modèle de champs ajoute automatiquement un filtre d' <code>exclude</code> pour chaque demande, qui supprime simplement les entrées qui ne doivent pas être affichées dans l'interface. <br><br>  Maintenant, il suffit que tous les modèles qui seront affectés d'une manière ou d'une autre par la suppression ajoutent un décorateur: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@exclude_objects_for_deleted_hosts('host') class Alias(models.Model): host = models.ForeignKey(to=Host, verbose_name='Host', related_name='alias')</span></span></code> </pre><br>  Maintenant, afin de supprimer l'objet <code>Host</code> , modifiez simplement l'attribut <code>is_deleted</code> : <br><br><pre> <code class="python hljs">host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> <span class="hljs-comment"><span class="hljs-comment"># after this save the host and all related objects will be inaccessible host.save()</span></span></code> </pre> <br>  Toutes les requêtes excluront automatiquement les enregistrements qui référencent des objets distants: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># model decorator @exclude_objects_for_deleted_hosts('checker__monhost', 'alias__host') CheckerToAlias.objects.filter( alias__hostname__in=['cloud.spb.s', 'cloud.msk.s'] ).values('id')</span></span></code> </pre><br>  Il s'avère que la requête SQL suivante: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> monitoring_checkertoalias.id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> monitoring_checkertoalias <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> monitoring_checker <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`checker_id`</span></span> = monitoring_checker.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checker`</span></span>.<span class="hljs-string"><span class="hljs-string">`monhost_id`</span></span> = Hosts.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dcmap_alias <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`monitoring_checkertoalias`</span></span>.<span class="hljs-string"><span class="hljs-string">`alias_id`</span></span> = dcmap_alias.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Hosts</span></span> T5 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (<span class="hljs-string"><span class="hljs-string">`dcmap_alias`</span></span>.<span class="hljs-string"><span class="hljs-string">`host_id`</span></span> = T5.<span class="hljs-string"><span class="hljs-string">`id`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> (<span class="hljs-string"><span class="hljs-string">`Hosts`</span></span>.<span class="hljs-string"><span class="hljs-string">`is_deleted`</span></span> = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span>) <span class="hljs-comment"><span class="hljs-comment">-- ,   monitoring_checker AND NOT (T5.`is_deleted` = TRUE) -- ,   dcmap_alias AND dcmap_alias.name IN ('dir1.server.p', 'dir2.server.p') );</span></span></code> </pre> <br>  Comme vous pouvez le voir, des jointures supplémentaires pour les champs spécifiés dans le décorateur et vérifie <code>`is_deleted` = TRUE</code> ajoutées à la demande. <br><br><h2>  Un peu de chiffres </h2><br>  Il est logique que des jointures et des conditions supplémentaires augmentent le temps d'exécution des requêtes.  L'étude de cette question a montré que le degré de «complication» dépend de la structure de la base de données, du nombre d'enregistrements et de la présence d'indices. <br><br>  Plus précisément, dans notre cas, pour chaque niveau de dépendance, la demande est condamnée à une amende d'environ 30%.  Il s'agit de la pénalité maximale que nous obtenons sur la plus grande table avec des millions d'enregistrements; sur les petites tables, la pénalité est réduite à quelques pour cent.  Heureusement, nous avons configuré les index nécessaires, et pour la majorité des requêtes critiques, les jointures nécessaires étaient déjà là, nous n'avons donc pas ressenti une grande différence de performances. <br><br><h2>  Identifiants uniques </h2><br>  Avant de supprimer des données, il peut être nécessaire de libérer les identifiants dont l'utilisation est prévue à l'avenir, car cela peut entraîner une erreur non unique lors de la création d'un nouvel objet.  Malgré le fait qu'aucun objet ne sera visible dans l'application Django, ils seront toujours dans la base de données.  Par conséquent, pour les objets supprimés, nous ajoutons uuid à l'identifiant. <br><br><pre> <code class="python hljs">host.hostname = <span class="hljs-string"><span class="hljs-string">'{}_{}'</span></span>.format(host.hostname, uuid.uuid4()) host.is_deleted = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> host.save()</code> </pre><br><h2>  Fonctionnement </h2><br>  Pour chaque nouveau modèle ou dépendance, le décorateur doit être mis à jour si nécessaire.  Pour simplifier la recherche de modèles dépendants, nous avons écrit un test «intelligent»: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_deleted_host_decorator_for_models</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recursive_host_finder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model, cache, path, filters)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># cache for skipping looked models cache.add(model) # process all related models for field in (f for f in model._meta.fields if isinstance(f, ForeignKey)): if field.related_model == Host: filters.add(path + field.name) elif field.related_model not in cache: recursive_host_finder(field.related_model, cache.copy(), path + field.name + '__', filters) # check all models for current_model in apps.get_models(): model_filters = getattr(current_model, DECORATOR_DEL_HOST_ATTRIBUTE, set()) found_filters = set() if current_model == Host: found_filters.add('') else: recursive_host_finder(current_model, set(), '', found_filters) if found_filters or model_filters: try: self.assertSetEqual(model_filters, found_filters) except AssertionError as err: err.args = ( '{}\n !!! Fix decorator "exclude_objects_for_deleted_hosts" ' 'for model {}'.format(err.args[0], current_model), ) raise err</span></span></code> </pre><br>  Le test vérifie récursivement tous les modèles pour la présence d'une dépendance sur le modèle à supprimer, puis il cherche à voir si le décorateur pour les champs requis a été défini pour ce modèle.  Si quelque chose manque, le test vous indiquera délicatement où ajouter le décorateur. <br><br><h2>  Épilogue </h2><br>  Ainsi, avec l'aide d'un décorateur, il a été possible d'implémenter une «petite suppression» de données comportant un grand nombre de dépendances.  Toutes les demandes reçoivent automatiquement le filtre d' <code>exclude</code> requis.  L'imposition de conditions supplémentaires ralentit le processus d'obtention des données, le degré de «complication» dépend de la structure de la base de données, du nombre d'enregistrements et de la disponibilité des indices.  Le test proposé vous indiquera pour quels modèles vous devez ajouter des décorateurs, et à l'avenir contrôlera leur cohérence. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr438280/">https://habr.com/ru/post/fr438280/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr438266/index.html">Pourquoi le pentesting est important pour votre entreprise?</a></li>
<li><a href="../fr438270/index.html">Love Kubernetes chez Mail.ru Group: 14 février</a></li>
<li><a href="../fr438272/index.html">Comment nous avons envoyé des SMS depuis la grotte</a></li>
<li><a href="../fr438274/index.html">Définition de la «personnalité toxique» en informatique</a></li>
<li><a href="../fr438278/index.html">Apprendre aux enfants à programmer</a></li>
<li><a href="../fr438286/index.html">Utilisation des fuseaux horaires en JavaScript</a></li>
<li><a href="../fr438288/index.html">Protection sans peur. Sécurité de la mémoire dans Rust</a></li>
<li><a href="../fr438290/index.html">Post-mortem avec GGJ-2019: comment obtenir des bosses, mais toujours faire le jeu</a></li>
<li><a href="../fr438292/index.html">Automatisation d'appartement avec HomePod, Raspberry Pi et Node.js</a></li>
<li><a href="../fr438294/index.html">Recherche de streamers Twitch dans une correspondance PUBG</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>