<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üöÑ üõ§Ô∏è üë∞üèΩ Comment d√©marrer Istio en utilisant Kubernetes en production. Partie 1 üòæ ü•Ä üëá</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Qu'est-ce que Istio ? C'est ce que l'on appelle le maillage de service, une technologie qui ajoute une couche d'abstraction sur le r√©seau. Nous interc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment d√©marrer Istio en utilisant Kubernetes en production. Partie 1</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/avito/blog/419319/">  Qu'est-ce que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Istio</a> ?  C'est ce que l'on appelle le maillage de service, une technologie qui ajoute une couche d'abstraction sur le r√©seau.  Nous interceptons tout ou partie du trafic dans le cluster et effectuons avec lui un ensemble sp√©cifique d'op√©rations.  Lequel?  Par exemple, nous faisons un routage intelligent, ou nous impl√©mentons l'approche du disjoncteur, nous pouvons organiser un ¬´d√©ploiement canari¬ª, basculer partiellement le trafic vers une nouvelle version du service, et nous pouvons limiter les interactions externes et contr√¥ler tous les d√©placements du cluster vers le r√©seau externe.  Il est possible de d√©finir des r√®gles de strat√©gie pour contr√¥ler les campagnes entre diff√©rents microservices.  Enfin, nous pouvons obtenir l'int√©gralit√© de la carte d'interaction sur le r√©seau et rendre la collection unifi√©e de m√©triques compl√®tement transparente pour les applications. <br><br>  √Ä propos du m√©canisme de travail peut √™tre trouv√© dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">documentation officielle</a> .  Istio est un outil vraiment puissant qui peut r√©soudre de nombreux probl√®mes et probl√®mes.  Dans cet article, je voudrais r√©pondre aux questions de base qui se posent g√©n√©ralement au d√©but du travail avec Istio.  Cela vous aidera √† y faire face plus rapidement. <br><br><img src="https://habrastorage.org/webt/cg/g_/dm/cgg_dmyxbtcrlna9cjib_vzazdm.png"><br><a name="habracut"></a><br><h3>  Principe de fonctionnement </h3><br>  Istio se compose de deux zones principales - plan de contr√¥le et plan de donn√©es.  Le plan de contr√¥le contient les principaux composants qui assurent le bon fonctionnement du reste.  Dans la version actuelle (1.0), le plan de contr√¥le a trois composants principaux: Pilot, Mixer, Citadel.  Nous ne consid√©rerons pas Citadel, il est n√©cessaire de g√©n√©rer des certificats pour assurer un TLS mutuel entre les services.  Examinons de plus pr√®s l'appareil et le but du pilote et du m√©langeur. <br><br><img src="https://habrastorage.org/webt/bz/eb/pz/bzebpzcfxr7himr5du7j1cm18zg.png"><br><br>  Pilot est le principal composant de contr√¥le qui diffuse toutes les informations sur ce que nous avons dans le cluster - les services, leurs points de terminaison et les r√®gles de routage (par exemple, les r√®gles de d√©ploiement Canary ou les r√®gles de disjoncteur). <br><br>  Mixer - un composant facultatif du plan de contr√¥le, qui offre la possibilit√© de collecter des m√©triques, des journaux et toutes les informations sur les interactions r√©seau.  Il surveille √©galement le respect des r√®gles de la politique et le respect des limites de taux. <br><br>  Le plan de donn√©es est impl√©ment√© √† l'aide de conteneurs proxy sidecar.  Par d√©faut, le puissant <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">serveur proxy d'envoy√© est utilis√©</a> .  Il peut √™tre remplac√© par une autre impl√©mentation, par exemple nginx (nginmesh). <br><br>  Afin qu'Istio fonctionne de mani√®re totalement transparente pour les applications, il existe un syst√®me d'injection automatique.  La derni√®re impl√©mentation est adapt√©e aux versions de Kubernetes 1.9+ (webhook d'admission mutationnelle).  Pour les versions 1.7, 1.8 de Kubernetes, il est possible d'utiliser l'initialiseur. <br><br>  Les conteneurs Sidecar sont connect√©s au Pilot via le protocole GRPC, ce qui permet d'optimiser le mod√®le de push des changements intervenant dans le cluster.  GRPC a commenc√© √† √™tre utilis√© dans Envoy depuis la version 1.6, √† Istio, il est utilis√© depuis la version 0.8 et est un pilote-agent - un wrapper sur golang sur l'envoy√© qui configure les param√®tres de lancement. <br><br>  Pilot et Mixer sont des composants compl√®tement sans √©tat, tous les √©tats sont conserv√©s en m√©moire.  La configuration pour eux est sp√©cifi√©e en tant que ressources personnalis√©es Kubernetes, qui sont enregistr√©es dans etcd. <br>  Istio-agent re√ßoit l'adresse pilote et lui ouvre un flux GRPC. <br><br>  Comme je l'ai dit, Istio impl√©mente toutes les fonctionnalit√©s de mani√®re totalement transparente pour les applications.  Voyons comment.  L'algorithme est le suivant: <br><br><ol><li>  D√©ployez une nouvelle version du service. </li><li>  Selon l'approche d'injection du conteneur side-car, un conteneur istio-init et un conteneur istio-agent (envoy√©) sont ajout√©s au stade de l'application de la configuration, ou ils peuvent d√©j√† √™tre ins√©r√©s manuellement dans la description Pod de l'entit√© Kubernetes. </li><li> Le conteneur istio-init est un script qui applique les r√®gles iptables pour le foyer.  Il existe deux options pour configurer l'habillage du trafic dans le conteneur istio-agent: utilisez les r√®gles de redirection iptables ou <a href="">TPROXY</a> .  Au moment de la r√©daction, l'approche par d√©faut avec les r√®gles de redirection est utilis√©e.  Dans istio-init, il est possible de configurer quel trafic doit √™tre intercept√© et achemin√© vers istio-agent.  Par exemple, pour intercepter tout le trafic entrant et sortant, vous devez d√©finir les param√®tres <code>-i</code> et <code>-b</code> sur <code>*</code> .  Vous pouvez sp√©cifier des ports sp√©cifiques √† intercepter.  Afin de ne pas intercepter un sous-r√©seau sp√©cifique, vous pouvez le sp√©cifier en utilisant l'indicateur <code>-x</code> . </li><li>  Apr√®s l'ex√©cution des conteneurs init, les principaux sont lanc√©s, y compris pilote-agent (envoy√©).  Il se connecte au pilote d√©j√† d√©ploy√© via GRPC et re√ßoit des informations sur tous les services et politiques de routage existants dans le cluster.  Selon les donn√©es re√ßues, il configure les clusters et leur attribue directement les noeuds finaux de nos applications dans le cluster Kubernetes.  Il convient √©galement de noter un point important: l'envoy√© configure dynamiquement des √©couteurs (IP, paires de ports) qu'il commence √† √©couter.  Par cons√©quent, lorsque les demandes entrent dans le pod, elles sont redirig√©es √† l'aide des r√®gles de redirection iptables dans le sidecar, l'envoy√© peut d√©j√† traiter ces connexions avec succ√®s et comprendre o√π acheminer le trafic proxy.  Toujours √† ce stade, des informations sont envoy√©es au m√©langeur, dont nous discuterons plus tard, et en envoyant des plages de suivi. </li></ol><br>  En cons√©quence, nous obtenons tout un r√©seau de serveurs proxy envoy√©s, que nous pouvons configurer √† partir d'un point (pilote).  Toutes les demandes entrantes et sortantes passent par l'envoy√©.  De plus, seul le trafic TCP est intercept√©.  Cela signifie que l'IP du service Kubernetes se r√©sout √† l'aide de kube-dns sur UDP sans modification.  Ensuite, apr√®s r√©solution, la demande sortante est intercept√©e et trait√©e par l'envoy√©, qui d√©cide d√©j√† √† quel point final envoyer la demande (ou non, en cas de politiques d'acc√®s ou de d√©clenchement d'algorithmes de disjoncteur). <br><br>  Avec Pilot tri√©, vous devez maintenant comprendre comment fonctionne le Mixer et pourquoi il est n√©cessaire.  Vous pouvez lire la documentation officielle √† ce sujet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Le m√©langeur dans sa forme actuelle se compose de deux composants: istio-t√©l√©m√©trie, istio-policy (avant la version 0.8, il √©tait un composant d'istio-mixer).  Les deux sont mixeurs, chacun √©tant responsable de sa t√¢che.  La t√©l√©m√©trie Istio re√ßoit via GRPC du sidecar Report conteneurs des informations sur qui va o√π et avec quels param√®tres.  Istio-policy accepte les demandes de v√©rification pour v√©rifier si les r√®gles de politique sont satisfaites.  Les contr√¥les de politique sont effectu√©s, bien s√ªr, pas pour chaque demande, mais sont mis en cache sur le client (en side-car) pendant un certain temps.  Les ch√®ques de rapport sont envoy√©s par des demandes group√©es.  Nous verrons un peu plus tard comment configurer et quels param√®tres vous devez envoyer. <br><br>  Le m√©langeur est cens√© √™tre un composant hautement disponible qui fournit un travail ininterrompu sur la collecte et le traitement des donn√©es de t√©l√©m√©trie.  Le syst√®me se r√©v√®le √™tre un tampon √† plusieurs niveaux.  Initialement, les donn√©es sont mises en m√©moire tampon du c√¥t√© du sidecar des conteneurs, puis du c√¥t√© du m√©langeur, puis envoy√©es aux serveurs dits du m√©langeur.  Par cons√©quent, si l'un des composants du syst√®me tombe en panne, le tampon augmente et se bloque apr√®s la r√©cup√©ration du syst√®me.  Les backends du m√©langeur sont les points de terminaison pour l'envoi de donn√©es de t√©l√©m√©trie: statsd, newrelic, etc.  Vous pouvez √©crire votre backend, c'est assez simple, et nous verrons comment le faire. <br><br><img src="https://habrastorage.org/webt/pz/qy/a_/pzqya_uanc5lmnd1kdv8ddu-frc.png"><br><br>  Pour r√©sumer, le sch√©ma de travail avec l'istio-t√©l√©m√©trie est le suivant. <br><br><ol><li>  Le service 1 envoie une demande au service 2. </li><li>  Lorsque vous quittez le service 1, la demande est envelopp√©e dans son propre side-car. </li><li>  L'envoy√© Sidecar surveille le d√©roulement de la demande de service 2 et pr√©pare les informations n√©cessaires. </li><li>  L'envoie ensuite √† istio-t√©l√©m√©trie √† l'aide de la demande de rapport. </li><li>  Istio-telemetry d√©termine s'il faut envoyer ce rapport aux backends, √† quelles donn√©es et quelles donn√©es envoyer. </li><li>  Istio-telemetry envoie les donn√©es du rapport au backend si n√©cessaire. </li></ol><br>  Voyons maintenant comment se d√©ployer dans le syst√®me Istio, compos√© uniquement des principaux composants (pilote et envoy√© side-car). <br><br>  Tout d'abord, regardons la configuration principale (maillage) que Pilot lit: <br><br><pre> <code class="plaintext hljs">apiVersion: v1 kind: ConfigMap metadata: name: istio namespace: istio-system labels: app: istio service: istio data: mesh: |- #      tracing  (pilot  envoy'  ,     ) enableTracing: false #     mixer endpoint',  sidecar      #mixerCheckServer: istio-policy.istio-system:15004 #mixerReportServer: istio-telemetry.istio-system:15004 #   ,    envoy  Pilot (    envoy proxy) rdsRefreshDelay: 5s # default   envoy sidecar defaultConfig: #   rdsRefreshDelay discoveryRefreshDelay: 5s #    (     envoy) configPath: "/etc/istio/proxy" binaryPath: "/usr/local/bin/envoy" #    sidecar  (, ,      tracing span') serviceCluster: istio-proxy # ,    envoy  ,        drainDuration: 45s parentShutdownDuration: 1m0s #    REDIRECT  iptables.    TPROXY. #interceptionMode: REDIRECT # ,     admin   sidecar  (envoy) proxyAdminPort: 15000 # ,     trace'  zipkin  (     ,       ) zipkinAddress: tracing-collector.tracing:9411 # statsd     envoy  () # statsdUdpAddress: aggregator:8126 #    Mutual TLS controlPlaneAuthPolicy: NONE # ,     istio-pilot  ,     service discovery  sidecar  discoveryAddress: istio-pilot.istio-system:15007</code> </pre><br>  Tous les principaux composants du plan de contr√¥le sont situ√©s dans l'istio-syst√®me d'espace de noms de Kubernetes. <br><br>  Au minimum, nous devons d√©ployer uniquement Pilot.  Pour ce faire, nous utiliserons <a href="">cette configuration.</a> <br><br>  Et configurez manuellement le sidecar d'injection du conteneur. <br><br>  Conteneur init: <br><br><pre> <code class="plaintext hljs">initContainers: - name: istio-init args: - -p - "15001" - -u - "1337" - -m - REDIRECT - -i - '*' - -b - '*' - -d - "" image: istio/proxy_init:1.0.0 imagePullPolicy: IfNotPresent resources: limits: memory: 128Mi securityContext: capabilities: add: - NET_ADMIN</code> </pre><br>  Et side-car: <br><br><pre> <code class="plaintext hljs"> name: istio-proxy args: - "bash" - "-c" - | exec /usr/local/bin/pilot-agent proxy sidecar \ --configPath \ /etc/istio/proxy \ --binaryPath \ /usr/local/bin/envoy \ --serviceCluster \ service-name \ --drainDuration \ 45s \ --parentShutdownDuration \ 1m0s \ --discoveryAddress \ istio-pilot.istio-system:15007 \ --discoveryRefreshDelay \ 1s \ --connectTimeout \ 10s \ --proxyAdminPort \ "15000" \ --controlPlaneAuthPolicy \ NONE env: - name: POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: POD_NAMESPACE valueFrom: fieldRef: fieldPath: metadata.namespace - name: INSTANCE_IP valueFrom: fieldRef: fieldPath: status.podIP - name: ISTIO_META_POD_NAME valueFrom: fieldRef: fieldPath: metadata.name - name: ISTIO_META_INTERCEPTION_MODE value: REDIRECT image: istio/proxyv2:1.0.0 imagePullPolicy: IfNotPresent resources: requests: cpu: 100m memory: 128Mi limits: memory: 2048Mi securityContext: privileged: false readOnlyRootFilesystem: true runAsUser: 1337 volumeMounts: - mountPath: /etc/istio/proxy name: istio-envoy</code> </pre><br>  Pour que tout d√©marre correctement, vous devez obtenir ServiceAccount, ClusterRole, ClusterRoleBinding, CRD for Pilot, dont la description se trouve <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  En cons√©quence, le service dans lequel nous injectons le side-car avec l'envoy√© doit d√©marrer avec succ√®s, obtenir toutes les d√©couvertes du pilote et traiter les demandes. <br><br>  Il est important de comprendre que tous les composants du plan de contr√¥le sont des applications sans √©tat et peuvent √™tre mis √† l'√©chelle horizontalement sans aucun probl√®me.  Toutes les donn√©es sont dans etcd en tant que descriptions personnalis√©es des ressources Kubernetes. <br><br>  Istio a √©galement (jusqu'√† pr√©sent exp√©rimentalement) la capacit√© de s'ex√©cuter en dehors du cluster et la capacit√© de surveiller et de t√¢tonner pour la d√©couverte de services entre plusieurs clusters Kubernetes.  Vous pouvez en savoir plus √† ce sujet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Pour une installation multi-cluster, les restrictions suivantes doivent √™tre prises en compte: <br><br><ol><li>  Le pod CIDR et le service CIDR doivent √™tre uniques sur tous les clusters et ne doivent pas se chevaucher. </li><li>  Tous les pod CIDR doivent √™tre disponibles √† partir de n'importe quel pod CIDR entre les clusters. </li><li>  Tous les serveurs API Kubernetes doivent √™tre accessibles les uns aux autres. </li></ol><br>  Ce sont les informations initiales pour vous aider √† d√©marrer avec Istio.  Cependant, il existe encore de nombreux pi√®ges.  Par exemple, les fonctionnalit√©s de routage du trafic externe (vers l'ext√©rieur du cluster), les approches de d√©bogage des side-cars, le profilage, la configuration d'un m√©langeur et l'√©criture d'un backend de m√©langeur personnalis√©, la configuration du m√©canisme de tra√ßage et son fonctionnement √† l'aide d'envoy√©. <br>  Nous consid√©rerons tout cela dans les publications suivantes.  Posez vos questions, je vais essayer de les couvrir. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr419319/">https://habr.com/ru/post/fr419319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr419307/index.html">Roskomnadzor s'int√©resse aux relations d'affaires Facebook</a></li>
<li><a href="../fr419309/index.html">JavaScript Medium Color</a></li>
<li><a href="../fr419311/index.html">Luminaires industriels d'un fabricant domestique Effest avec un bon indice de rendu des couleurs</a></li>
<li><a href="../fr419313/index.html">Le testament de Buffett ou ce que les consultants financiers ne disent pas</a></li>
<li><a href="../fr419315/index.html">Dur√©e de vie du moteur apr√®s la mort d'une fus√©e</a></li>
<li><a href="../fr419321/index.html">SamsPcbGuide Partie 7: Tra√ßage des lignes de signal Paires diff√©rentielles</a></li>
<li><a href="../fr419323/index.html">Installer Kubernetes sur Hetzner Cloud</a></li>
<li><a href="../fr419325/index.html">Relocaliser un √©tudiant en France</a></li>
<li><a href="../fr419327/index.html">Guide de la liste des interfaces sur MikroTik</a></li>
<li><a href="../fr419329/index.html">√âv√©nements num√©riques √† Moscou du 6 au 12 ao√ªt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>