<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💿 🐊 🤜🏻 Comment vous avez besoin et n'avez pas besoin d'écrire un chat pour les bots en utilisant l'exemple de mon bot pour jouer à Secret Santa 🏙️ 👨🏾‍🎤 🏯</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Contexte 
 Il y a un an, j'ai décidé de créer un bot de télégramme afin de jouer au jeu très populaire du Nouvel An «Secret Santa». J'ai été inspiré p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment vous avez besoin et n'avez pas besoin d'écrire un chat pour les bots en utilisant l'exemple de mon bot pour jouer à Secret Santa</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/476144/"><img src="https://habrastorage.org/webt/bn/q0/rt/bnq0rth_z9f4mrq3z_64x9x2bkg.png" alt="image"><br><br><h2>  Contexte </h2><br>  Il y a un an, j'ai décidé de créer un bot de télégramme afin de jouer au jeu très populaire du Nouvel An «Secret Santa».  J'ai été inspiré par le fait qu'il y a quelques années, nous, au travail, en tant qu'entreprise, avons décidé de jouer à ce jeu (cela semblait très cool), et en plus, je suis depuis longtemps le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">club ADM</a> sur Habré.  En octobre-novembre de l'année dernière, j'ai réalisé que je devais jouer entre ma propre entreprise cette année encore, mais cette fois sans retirer les noms écrits sur un morceau de papier du chapeau du Père Noël, mais plus technologiquement, ou quelque chose.  Comme tout le monde était dans un télégramme et qu'il était très intéressant pour moi d'écrire un bot là-bas, j'ai décidé de le faire sur cette plateforme <br><a name="habracut"></a><br>  Au fait, il y a un an, j'avais déjà <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">écrit</a> un article sur ce projet sur Habré, mais je n'ai rien dit sur la mise en œuvre.  Je n'ai pas parlé pour une bonne raison, car c'était une honte ou quelque chose :) Le projet a été préparé uniquement pour l'entreprise au travail (15-20 personnes à vitesse maximale), mais il s'est avéré que le projet a "tourné" dans d'autres cercles après quelques articles sur les ressources.  De plus, des ressources plus populaires elles-mêmes ont commencé à me faire de la publicité (je ne le savais même pas avant qu'un afflux important de personnes ne sorte de nulle part). <br><br>  Pendant un mois, sans un seul investissement publicitaire, j'ai rassemblé plus de 5000 joueurs satisfaits et suis vraiment tombé amoureux de ce projet.  Mais en plus de tous ses avantages, il y avait un énorme inconvénient en lui, et c'est la mise en œuvre. <br><br><h3>  Comment c'était il y a un an </h3><br>  C'était drôle que j'avais un bouton dans le bot "rejoindre la salle".  Oui, c'est précisément celui qui rejoint.  Ils m'ont écrit pour corriger ce bug de grammaire, mais je ne l'ai pas risqué, et c'est pourquoi :) Ensuite, j'ai mis un morceau de code de la version de l'an dernier du bot. <br><br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">elseif</span></span> ($user[<span class="hljs-string"><span class="hljs-string">'state'</span></span>] == <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mb_stripos($textMessage, <span class="hljs-string"><span class="hljs-string">''</span></span>) !== <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">empty</span></span>($user[<span class="hljs-string"><span class="hljs-string">'santa_for_user_id'</span></span>])) { $text = <span class="hljs-string"><span class="hljs-string">'   ,      '</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $text = <span class="hljs-string"><span class="hljs-string">"!       -     ,      "</span></span>; $db-&gt;updateState($userId, <span class="hljs-number"><span class="hljs-number">8</span></span>); } }</code> </pre> <br>  Le bot entier - c'était un énorme fichier index.php qui vivait de la fonction mb_stripos, en fait.  De plus, il y avait beaucoup de "ifics" identiques.  C'est-à-dire  mb_stripos ($ textMessage, 'join')! == false peut se produire plusieurs fois.  Si vous changez le mot «rejoindre» dans le bouton pour «rejoindre», et oubliez de changer une sorte d'ifchik (qui, encore une fois, beaucoup), tout peut saupoudrer.  À quoi il peut ne pas être immédiatement perceptible (juste un bot dans certains scénarios ne répondra pas comme il se doit).  Une fois que j'ai changé le texte, les utilisateurs ont commencé à écrire que dans un certain scénario, le bot ne répond pas comme il se doit.  Je ne voulais pas prendre de risques supplémentaires et je pensais que l'erreur n'était pas si critique :) En principe, vous comprenez.  S'il y avait un bouton, par exemple, "Trouver un Père Noël aléatoire", je me suis accroché au mot "aléatoire" via mb_stripos.  C'était amusant quand un bouton similaire est apparu, avec un texte similaire, et quand ce n'était pas nécessaire, tout est devenu inutile si (si par exemple à la fois là et il y a le mot "aléatoire") :) <br><br>  Au fait, avez-vous remarqué $ user ['state']?  À cette époque, j'ai introduit des «états» afin de comprendre dans quel état se trouve actuellement l'utilisateur.  Voulait-il rejoindre la salle, par exemple, ou créer, ou peut-être voulait-il jouer à un seul jeu?  Et pour chaque état, son propre ensemble d'ifchi est venu, ce qui était également important de ne pas se casser. <br><br>  Soit dit en passant, le fichier Cron se trouvait à côté de index.php, il pouvait être exécuté directement sous le navigateur (apparemment, cela ne m'a pas vraiment dérangé).  De plus, quand j'ai soudainement voulu ajouter une sorte d '"état" (j'aurais aimé ne pas le vouloir), j'ai dû plonger dans cette ville ... et bien sûr, rien n'est sorti de la première tentative.  Tout cela reposait également sur l'hébergement le moins cher pour 1 $ par mois, ce qui pourrait m'envoyer en enfer lorsque beaucoup de gens ont commencé à écrire aux heures de pointe. <br><br>  C'était certainement un enfer pour un programmeur :) <br><br><h4>  Ce que j'ai décidé de faire cette année </h4><br>  Cette année, bien sûr, j'ai décidé de réécrire le bot (car il y avait une demande considérable l'année dernière), je voulais entrer dans l'ancien code et comprendre comment c'était cette année afin de transférer la logique métier.  Malheureusement, je n'ai même pas pu comprendre à 70% l'ancien code, même si j'ai ensuite essayé de me laisser des commentaires dans le code pour m'aider dans un an :) <br><br>  J'ai décidé de simplement rappeler les principaux scénarios, et d'y ajouter quelque chose de nouveau en cours de route.  Il a commencé par la question: "que faut-il utiliser pour écrire l’architecture pour ne pas pleurer plus tard?"  Après de nombreuses recherches, le choix s'est <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">porté</a> sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Botman</a> .  Nous avons de petits articles sur Habré à ce sujet.  En bref, Botman est une chose très cool.  Il peut être installé à la fois sur un "propre", et vous pouvez immédiatement installer son assemblage avec Laravel (oui, il y a un botman installé immédiatement au-dessus de Laravel).  J'ai décidé de rester sur cette version, car Laravel est clairement meilleur qu'il y a un an :) Il a la capacité de mettre en cache à partir de la "boîte", un routage pratique, artisan, middleware, commodité, la possibilité de travailler avec la base de données et d'autres avantages.  <i>Si tout à coup vous n'aimez pas Laravel, vous pouvez utiliser n'importe quel autre framework et installer Botman dessus, ou vous ne pouvez pas utiliser le framework du tout</i> .  Soit dit en passant, Botman est construit sur ReactPHP, ce qui est cool :) <br><br>  Ensuite, je décrirai les avantages de Botman: <br><br>  Il existe un seul fichier botman.php dans lequel vous pouvez décrire toutes les commandes.  Un exemple: <br><br><pre> <code class="php hljs">$botman-&gt;hears(<span class="hljs-string"><span class="hljs-string">'/start'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(BotMan $bot)</span></span></span><span class="hljs-function"> </span></span>{ $bot-&gt;startConversation(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StartConversation()); })-&gt;stopsConversation();</code> </pre> <br>  Lors de l'écriture de la commande / start, StartConversation démarrera (qui devrait hériter de la classe de conversation abstraite) et implémentera la méthode run (). <br><br>  Les questions sont posées très facilement, par exemple: <br><br><pre> <code class="php hljs">$question = Question::create(<span class="hljs-string"><span class="hljs-string">"   ,    ?"</span></span>)-&gt;addButtons([Button::create(<span class="hljs-string"><span class="hljs-string">''</span></span>)-&gt;value(<span class="hljs-string"><span class="hljs-string">'create'</span></span>), Button::create(<span class="hljs-string"><span class="hljs-string">''</span></span>)-&gt;value(<span class="hljs-string"><span class="hljs-string">'join'</span></span>)]); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;ask($question, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Answer $answer)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($answer-&gt;isInteractiveMessageReply()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($answer-&gt;getValue() == <span class="hljs-string"><span class="hljs-string">'join'</span></span>) {</code> </pre><br>  Remarquez que chez Button, nous pouvons définir une valeur, et nous y accrocher plus tard?  Autrement dit, sous vos yeux, le bug avec le "join" est corrigé, car je m'accroche à value () :) <br>  Soit dit en passant, vous pouvez toujours utiliser la méthode isInteractiveMessageRhness, qui répondra à la question si vous avez écrit du texte ou cliqué sur le bouton interactif lors de la réponse à la question posée à l'utilisateur. <br><br>  Botman a aidé à se débarrasser des états, je peux faire une autre méthode de demande dans la méthode de demande, par exemple, si une personne a cliqué sur «rejoindre», je fais juste une autre demande à l'intérieur de ce si. <br><br>  Voici quelques autres méthodes (d'un très grand nombre) fournies par le botman, qui peuvent être facilement comprises à partir du nom: <br><blockquote>  $ this-&gt; repeat ($ question); </blockquote><br><blockquote>  $ this-&gt; bot-&gt; typesAndWaits ($ secondsToWait); </blockquote><br><blockquote>  $ this-&gt; bot-&gt; reply ($ reply); </blockquote>  Le tueur des fonctionnalités du botman est qu'un code peut s'exécuter sur de nombreuses plates-formes.  Autrement dit, vous pouvez écrire votre code, ne l'exécuter initialement que pour Telegram.  Ensuite, décidez que vous souhaitez toujours accéder à Facebook Manager, et que vous n'avez pas du tout besoin de commencer à gérer le SDK Facebook, les développeurs Botman l'ont déjà fait pour vous.  Il vous suffit d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">installer le pilote</a> et de définir l'API Token de votre bot Facebook Messenger en .env.  Toutes les fonctionnalités fonctionneront automatiquement dans Facebook Messenger. <br>  Botman ne prend pas seulement en charge Facebook Messenger et Telegram, cette liste comprend également Slack, Skype, WeChat (une liste complète peut être trouvée sur leur site Web). <br><br>  En outre, le "héros de l'occasion" est célèbre pour le fait qu'il a déjà les tests de papa / Botman (vous pouvez écrire des tests unitaires, votre casquette), ainsi qu'une bonne documentation.  Il est difficile de nommer tous les avantages, car je n'ai évidemment pas travaillé avec tout le monde, je ne me souviens pas de tout, mais je pense que ce que j'ai décrit devrait déjà être suffisant pour être intéressé par eux au moins :) <br><br><h3>  Eh bien, ok, mais allons-nous héberger à nouveau sur l'hébergement pour 1 $? </h3><br>  Non, cette année, tout est sérieux.  Hébergement pour 10 $ par mois et un domaine gratuit avec ref.  Je plaisante :) <br><br>  J'ai décidé d'approfondir mes connaissances de docker, acheté VPS sur DigitalOcean et lancé le projet dans docker.  Cela s'est plutôt bien passé, malgré le fait que je l'ai fait presque la première fois.  <s>Étonnamment, le docker n'est jamais tombé</s> . <br><br>  Avec VPS, bien sûr, plus cool :) <br><br>  Lorsqu'il était docker, il était beaucoup plus pratique de mener à bien le développement (le versioning sur la vierge et sur la prod a été conservé). <br><br>  Le plus drôle, c'est que lorsque j'ai introduit des fonctionnalités payantes dans le bot, j'avais besoin d'obtenir une mise à niveau du système de paiement.  Le système de paiement me renvoyait constamment ma demande de mise à niveau et disait "le site est en panne".  A travaillé pour moi, a travaillé pour des amis (nous sommes d'Ukraine), mais n'a pas travaillé pour des gars de la Fédération de Russie.  Sans hésitation, j'ai vu que Roskomnadzor interdisait toujours l'adresse IP de ma droplet il y a un an (beaucoup de serveurs DigitalOcean ont été endommagés par l'ILV à cette époque).  Ensuite, ils ont également décidé de cela. <br><br><h3>  Sur quoi est écrit votre bot? </h3><br><ul><li>  PHP 7.3 </li><li>  Laravel </li><li>  Botman </li></ul><br>  Et je conseille à tout le monde d'utiliser cette pile particulière lors de l'écriture de leurs bots en PHP (afin de ne pas se tirer une balle dans la jambe plus tard, comme je l'ai fait). <br><br><h3>  Quoi de neuf dans le bot? </h3><br><h4>  Le Père Noël a appris à appeler </h4><br>  Vous pouvez commander un appel du Père Noël!  Il va même vous comprendre et vous écouter :) <br><br>  Le Père Noël appelle le numéro indiqué (à partir des numéros américains), pose des questions, par exemple, "Comment vous êtes-vous comporté dans l'année?", "Que voulez-vous pour la nouvelle année?", "Connaissez-vous le poème?", Etc.  Si l'utilisateur dit qu'il ne connaît pas la rime, alors le Père Noël suivra un scénario différent de questions, s'il dit qu'il sait, alors le Père Noël vous demandera de bien vouloir dire la rime :) PLUS: quand une personne dit sa liste de souhaits pour le Nouvel An au Père Noël, le Père Noël écoute, puis envoie cette liste de souhaits à l'utilisateur qui a ordonné l'appel (tout d'un coup, l'enfant a été fermé à ses parents dans la chambre, mais ils ont en quelque sorte besoin de savoir ce qu'il a demandé au Père Noël?).  Le Père Noël envoie également l'enregistrement audio de l'appel avec le Père Noël en souvenir :) <br><br><h4>  Vous pouvez maintenant découvrir qui est votre père Noël. </h4><br>  Zrada?  C'est contraire au nom du jeu "Secret Santa", n'est-ce pas?  En principe, oui.  MAIS l'année dernière, à cause du nombre de personnes qui voulaient connaître leur père Noël, mes drogues étaient déchirées.  "Le patron va-t-il me donner un cadeau?", "Quelqu'un ne nous a pas donné de cadeau pour quelqu'un, pouvez-vous dire qui aurait dû lui donner?" Et ainsi de suite.  Maintenant, il y a une telle opportunité, mais quelle qu'elle soit - un tel plaisir sortira à 5,99 $ :) <br><br><h3>  Conclusions </h3><br>  Vous ne devez pas espérer que votre projet sera toujours petit.  Il n'est pas nécessaire de créer un index.php avec un tas d'if, même si le projet commence avec seulement quelques trois ifs (je connais assez de ces projets)).  Il vaut mieux le faire tout de suite.  Même si vous y consacrez plus de temps, cela vous apportera des avantages en ce sens que lorsque vous aurez un besoin urgent de changer / ajouter de la logique au projet, vous n'avez pas eu à réfléchir à la façon de changer ifas pour que le bot ne tombe pas, comme cela s'est avéré pour moi :).  De plus, cette approche (avec ifas) vous apprend à prendre toutes les autres décisions béquillées (pas la meilleure compétence, d'accord).  Eh bien, bien sûr, pensez à vous, vous devrez entrer dans ce code plus tard, et vous devrez vous en occuper, puis ce ne sera pas très doux :( <br><br>  Tout le bon code, écrire vos robots de chat, et aussi écrire vos projets.  C'est génial! <br><br>  En fin de compte, je tiens à rappeler que j'ai lu quelque part que: <br>  Si vous saviez que vos projets préférés que vous utilisez (Facebook, VK, etc.) sont construits de telle sorte que sur le point de tomber, vous seriez surpris.  Oui, en effet, cette année-là, tout le monde a joué avec plaisir, sans même imaginer ce qui se passait à l'intérieur de ce bot (j'ai moi-même été choqué de voir comment il a survécu en décembre :)). <br><br>  Si vous voulez jouer - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Bienvenue</a> :) </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr476144/">https://habr.com/ru/post/fr476144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr476128/index.html">Ivan Osipov et Yuri Artamonov à propos de Kotlin et des plugins pour IntelliJ IDEA lors de la réunion jug.msk.ru</a></li>
<li><a href="../fr476134/index.html">MONQ - surveillance et AIOps originaires de Russie</a></li>
<li><a href="../fr476138/index.html">Les astronomes pensent que les satellites de communication SpaceX, OneWeb et d'autres sociétés menacent l'avenir de l'astronomie</a></li>
<li><a href="../fr476140/index.html">Comment améliorer l'écoute si vous connaissez 7 000 mots mais ne le comprenez pas à l'oreille?</a></li>
<li><a href="../fr476142/index.html">Pourquoi éviter d'utiliser des exceptions pour contrôler votre flux en Java</a></li>
<li><a href="../fr476146/index.html">Comment faire évoluer les centres de données. Rapport Yandex</a></li>
<li><a href="../fr476148/index.html">postfix + dovecot + mysql sur FreeBSD</a></li>
<li><a href="../fr476156/index.html">Synchronous Request-Response à l'aide d'Apache Kafka</a></li>
<li><a href="../fr476160/index.html">La naissance du logiciel éducatif et son histoire: des machines mécaniques aux premiers ordinateurs</a></li>
<li><a href="../fr476162/index.html">Nous créons une application web moderne. Connaissance du projet et préparation au travail. Partie 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>