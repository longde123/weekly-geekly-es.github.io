<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïπÔ∏è üò∏ üßóüèæ Testando o c√≥digo do SQL Server com tSQLt ü§¥ ü§üüèæ ‚õπüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FYI: Este artigo √© uma vers√£o expandida do meu relat√≥rio nos SQA Days # 25. 

 Com base na minha experi√™ncia de comunica√ß√£o com colegas, posso dizer q...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Testando o c√≥digo do SQL Server com tSQLt</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/arcadia/blog/461133/">  <i>FYI: Este artigo √© uma vers√£o expandida do meu <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">relat√≥rio</a> nos SQA Days # 25.</i> <br><br>  Com base na minha experi√™ncia de comunica√ß√£o com colegas, posso dizer que testar c√≥digo em um banco de dados n√£o √© uma pr√°tica comum.  Isso pode ser um risco potencial.  A l√≥gica no banco de dados √© escrita pelas mesmas pessoas que escrevem o c√≥digo "regular".  Consequentemente, os erros tamb√©m podem estar presentes l√° e tamb√©m podem ter consequ√™ncias negativas para o produto, neg√≥cios e consumidores.  N√£o importa se √© sobre procedimentos armazenados que ajudam o back-end ou sobre ETLs que convertem dados em armazenamento - existe um risco e os testes podem reduzi-los significativamente.  Quero lhe dizer o que √© o tSQLt e como ele nos ajuda a testar o c√≥digo no SQL Server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/2e/-h/nx/2e-hnxb3bddbq3ck_8vi4jwah8i.jpeg"></div><br><a name="habracut"></a><br><h1>  Contexto </h1><br>  H√° um grande armaz√©m no SQL Server contendo v√°rios dados de pesquisa cl√≠nica.  Ele √© preenchido de v√°rias fontes (principalmente bancos de dados orientados a documentos).  Dentro do pr√≥prio servidor, os dados s√£o convertidos repetidamente usando ETL.  No futuro, esses dados poder√£o ser carregados em bancos de dados menores para uso em aplicativos da web que resolvem alguns pequenos problemas espec√≠ficos.  Alguns dos clientes do cliente tamb√©m solicitam uma API para suas necessidades internas.  Na implementa√ß√£o dessas APIs, procedimentos e consultas armazenados s√£o frequentemente usados. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/iw/vu/rz/iwvurz8sbflhuz3mkj39ipf9rag.png"></div><br>  Em geral, o c√≥digo est√° no lado do DBMS em ordem. <br><br><h1>  Por que tudo isso √© necess√°rio </h1><br>  Como j√° entendido na introdu√ß√£o, o c√≥digo no banco de dados √© o mesmo c√≥digo <br>  aplicativos, como o restante, e tamb√©m pode haver erros. <br><br>  Eu acho que muitas pessoas est√£o cientes da depend√™ncia do pre√ßo do bug no momento de sua descoberta, cuja descoberta √© geralmente atribu√≠da a Barry Bohem.  Um erro cometido em um est√°gio inicial e detectado em um est√°gio posterior pode ser mais caro devido √† necessidade de passar por v√°rios est√°gios (codifica√ß√£o, unidade, integra√ß√£o, teste do sistema etc.) repetidamente, tanto para localizar o erro quanto para trazer de volta o c√≥digo corrigido. o est√°gio em que o problema foi identificado.  Esse efeito tamb√©m √© relevante para o caso do armaz√©m.  Se um erro for arrastado para algum ETL e os dados sofrerem v√°rias transforma√ß√µes, se um erro for detectado nos dados, voc√™ dever√°: <br><br><ol><li>  Siga todas as etapas da convers√£o de volta para a localiza√ß√£o do problema. </li><li>  Corrija o problema. </li><li>  Recupere os dados corrigidos (as corre√ß√µes manuais n√£o s√£o exclu√≠das). </li><li>  Verifique se os dados incorretos causados ‚Äã‚Äãpelo erro n√£o apareceram em outro lugar. </li></ol><br>  N√£o esque√ßa que n√£o vendemos brinquedos macios.  Um erro em um campo como a pesquisa cl√≠nica pode causar danos n√£o apenas aos neg√≥cios, mas tamb√©m √† sa√∫de das pessoas. <br><br><h1>  Como testar? </h1><br>  Como estamos falando de teste de c√≥digo, queremos dizer teste de unidade e integra√ß√£o.  Essas coisas s√£o muito ensaiadas e envolvem regress√£o constante.  A rigor, ningu√©m realiza esses testes manualmente (bem, talvez com exce√ß√£o de alguns casos completamente degenerados). <br><br>  Um bom b√¥nus: os testes podem ser um material auxiliar ao documentar o c√≥digo.  A prop√≥sito, os requisitos do cliente podem ser assim (clic√°veis): <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/fh/af/xb/fhafxb5yph-tgvy2zhka9jfcvmk.png"></a> </div><br>  Excel, duas colunas com requisitos + informa√ß√µes de suporte dispersas em outras colunas + marca√ß√£o arrastada, o que √© mais confuso do que √∫til.  Se necess√°rio, restaurar os desejos originais pode ser dif√≠cil.  Os testes podem ajudar a capturar com mais precis√£o as nuances da implementa√ß√£o (√© claro, voc√™ n√£o deve consider√°-las como o equivalente da documenta√ß√£o). <br><br>  Infelizmente, com a complexidade do c√≥digo, a complexidade dos testes aumenta e esse efeito pode ser nivelado. <br><br>  Os testes podem servir como uma camada adicional de seguran√ßa contra morsas espont√¢neas.  Os autotestes no IC devido ao formalismo ajudam a lidar com esse problema. <br><br>  Se nossa escolha caiu no caminho da automa√ß√£o, precisamos decidir sobre as ferramentas para sua implementa√ß√£o. <br><br><h1>  Como testar? </h1><br>  No caso de testar o c√≥digo no banco de dados, distingo duas abordagens: alimentado por SQL, ou seja, funcionando diretamente no DBMS e alimentado por n√£o-SQL.  Pude destacar as seguintes nuances: <br><div class="scrollable-table"><table><tbody><tr><th>  Alimentado por SQL <br></th><th>  N√£o alimentado por sql <br></th></tr><tr><td>  Requer instala√ß√£o de objetos no banco de dados <br></td><td>  √â necess√°ria a instala√ß√£o de ferramentas externas adicionais no banco de dados <br></td></tr><tr><td>  Os testes s√£o sempre independentes das tecnologias usadas no aplicativo fora do banco de dados <br></td><td>  Os testes podem depender de tecnologias usadas fora do banco de dados. <br></td></tr><tr><td>  A estrutura est√° sempre vinculada a um DBMS espec√≠fico </td><td>  A estrutura geralmente oferece suporte a v√°rios DBMSs. </td></tr><tr><td>  Para escrever testes, apenas o conhecimento do DBMS √© necess√°rio;  para desenvolvimento, voc√™ pode usar testadores manuais ou DBA </td><td>  Escrever testes geralmente requer conhecimento adicional de qualquer linguagem de programa√ß√£o e / ou tecnologia;  muitas vezes precisam de ajuda de programadores <br></td></tr><tr><td>  A execu√ß√£o no n√≠vel do DBMS permite o uso de falsifica√ß√µes e asser√ß√µes mais avan√ßadas <br></td><td>  A execu√ß√£o externa pode limitar os recursos da ferramenta <br></td></tr></tbody></table></div>  No SQL Server, temos algumas op√ß√µes: <br><div class="scrollable-table"><table><tbody><tr><th colspan="6" align="center">  Informa√ß√£o geral </th></tr><tr><th>  T√≠tulo </th><th>  A abordagem </th><th>  Arquitetura </th><th>  Escrito em </th><th>  Testes para </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-SQL + CLR </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  Alimentado por SQL </td><td>  xUnit </td><td>  T-sql </td><td>  T-sql </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  N√£o alimentado por sql </td><td>  Fitnessess </td><td>  C # / java </td><td>  Marca√ß√£o Wiki </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  N√£o alimentado por sql </td><td>  RSpec (orientado a BDD) </td><td>  Ruby </td><td>  Ruby </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  N√£o alimentado por sql </td><td>  xUnit </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="4" align="center">  Datas </th></tr><tr><th>  T√≠tulo </th><th>  Primeira apari√ß√£o </th><th>  √öltima confirma√ß√£o </th><th>  Vers√£o mais recente </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  27/07/2007 </td><td>  07/07/2019 </td><td>  31/01/2016 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  16-12-2006 (0,9) <br>  21/07/2007 (0,91 rc1) </td><td>  26/04/2018 (GitHub) </td><td>  04/09/2011 (SourceForge) </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  12/03/2003 </td><td>  12/03/2003 </td><td>  12/03/2003 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  02-03-2009 (v1.0) </td><td>  N / a </td><td>  30-03-2012 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  12-01-2009 </td><td>  10-09-2018 </td><td>  15/08/2015 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  23/06/2011 </td><td>  12-12-2018 </td><td>  12-12-2018 </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  N / a </td><td>  N / a </td><td>  N / a </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="7" align="center">  As possibilidades </th></tr><tr><th>  T√≠tulo </th><th>  CLR n√£o obrigat√≥rio </th><th>  Sa√≠da XML </th><th>  Testes agrupados em uma transa√ß√£o </th><th>  Falso </th><th>  Manipuladores de erro </th><th>  Asser√ß√µes </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  - </td><td>  + </td><td>  + </td><td>  + </td><td>  + </td><td>  √ìtimo </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  + </td><td>  - </td><td>  + </td><td>  - </td><td>  - </td><td>  Muito ruim </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  + </td><td>  - </td><td>  - </td><td>  - </td><td>  - </td><td>  Ruim </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  + </td><td>  + </td><td>  + (op√ß√£o) </td><td>  - </td><td>  + </td><td>  √ìtimo </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  + </td><td>  - </td><td>  + (op√ß√£o) </td><td>  - </td><td>  + </td><td>  Bom;  existem nuances </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  + </td><td>  - </td><td>  + (op√ß√£o) </td><td>  - </td><td>  - </td><td>  Bom;  existem nuances </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  + </td><td>  + </td><td>  N / a </td><td>  N / a </td><td>  N / a </td><td>  √ìtimo  existem nuances </td></tr></tbody></table></div><div class="scrollable-table"><table><tbody><tr><th colspan="3" align="center">  Outros </th></tr><tr><th>  T√≠tulo </th><th>  A documenta√ß√£o </th><th>  Comunidade </th></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tSQLt</a> </td><td>  √ìtimo  existem nuances </td><td>  √ìtimo </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">TSQLUnit</a> </td><td>  Ruim </td><td>  Ruim </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">utTSQL</a> </td><td>  √ìtimo </td><td>  Ruim </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Tst</a> </td><td>  √ìtimo </td><td>  Ruim </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Dbfit</a> </td><td>  √ìtimo </td><td>  Ok </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Slacker</a> </td><td>  √ìtimo </td><td>  Ok </td></tr><tr><td>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">NUnit</a> , etc. </td><td>  √ìtimo </td><td>  √ìtimo </td></tr></tbody></table></div>  Avalia√ß√µes de "bom-mau" s√£o subjetivas, desculpe, sem isso, em lugar nenhum. <br><br>  Explica√ß√£o: ‚ÄúPrimeira Apari√ß√£o‚Äù √© a data mais antiga no caminho da vida da estrutura que eu consegui encontrar, ou seja, a libera√ß√£o ou consolida√ß√£o mais antiga. <br><br>  Voc√™ pode notar que as alternativas baseadas em SQL foram abandonadas por algum tempo e o tSQLt √© a √∫nica op√ß√£o suportada.  Funcionalmente, o tSQLt tamb√©m vence.  A √∫nica coisa √© que, em termos de asser√ß√µes, o TST possui uma op√ß√£o um pouco mais rica que o tSQLt, que, no entanto, dificilmente superar√° seus contras. <br><br>  Existem nuances na documenta√ß√£o do tSQLt, mas falarei sobre isso mais tarde. <br><br>  No mundo que n√£o usa SQL, as coisas n√£o s√£o t√£o diretas.  Alternativas, embora n√£o super ativas, est√£o sendo desenvolvidas.  DbFit √© uma ferramenta interessante baseada na estrutura FitNesse.  Ele oferece testes de escrita na marca√ß√£o wiki.  O Slacker tamb√©m √© uma coisa curiosa - a abordagem do BDD ao escrever testes para o banco de dados. <br><br>  Vou discutir as asser√ß√µes em n√£o-SQL-powered.  Externamente, h√° menos deles, e pode-se dizer que eles s√£o piores por causa disso.  Mas aqui vale a pena considerar que eles s√£o fundamentalmente diferentes do tSQLt.  Nem tudo √© t√£o simples. <br><br>  A √∫ltima linha √© "NUnit, etc."  - √© um lembrete.  Muitas das estruturas de teste de unidade conhecidas no trabalho cotidiano podem ser usadas em bancos de dados auxiliares usando bibliotecas auxiliares.  A tabela possui muito N / A, porque essa linha, de fato, inclui muitas ferramentas.  As ‚Äúnuances‚Äù na coluna de asser√ß√µes v√™m do mesmo ponto - em diferentes ferramentas, seu conjunto pode variar e a quest√£o da aplicabilidade ao banco de dados √© aberta. <br><br>  Como outra m√©trica interessante, podemos considerar as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tend√™ncias do Google</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ud/2u/km/ud2ukmcoyjvstvhcu2taegpib34.png"></div><br>  Nuances: <br><br><ol><li>  N√£o inclu√≠ o Slacker, porque esse nome pode significar muitas coisas (e solicita√ß√µes como "estrutura do Slacker" n√£o s√£o particularmente vis√≠veis nos gr√°ficos). </li><li>  Por uma quest√£o de curiosidade, acrescentou a tend√™ncia do TST, mas tamb√©m n√£o reflete muito o estado das coisas, pois √© uma abrevia√ß√£o que significa muitas coisas diferentes. </li><li>  N√£o inclu√≠ o NUnit e seus an√°logos, pois eles eram originalmente estruturas para testar o c√≥digo dos aplicativos, e suas tend√™ncias n√£o s√£o indicativas do nosso contexto. </li></ol><br>  Em geral, podemos dizer que o tSQLt parece favor√°vel no contexto de an√°logos. <br><br><h1>  O que √© tSQLt? </h1><br>  O tSQLt, como voc√™ pode imaginar, √© uma estrutura de teste de unidade baseada em SQL. <br><br>  ‚Üí <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Site oficial</a> <br><br>  O suporte ao SQL Server foi anunciado desde 2005 SP2.  Eu nunca fui capaz de olhar t√£o longe no passado, mas temos 2012 no servidor de desenvolvimento, localmente em 2017 - n√£o houve problemas. <br><br>  C√≥digo aberto, uma licen√ßa do Apache 2.0, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">est√° dispon√≠vel no GitHub</a> .  Voc√™ pode bifurcar, contrabandear, usar gratuitamente em projetos comerciais e, o mais importante, n√£o ter medo de indicadores no CLR. <br><br><h1>  Mec√¢nica do trabalho </h1><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/1v/kx/wi/1vkxwixwjyna756vsce7uhwqzw0.png"></div><br>  Casos de teste s√£o procedimentos armazenados.  Eles s√£o combinados em classes de teste (su√≠te de testes em termos de xUnit). <br><br>  As classes de teste nada mais s√£o do que esquemas regulares de banco de dados.  Eles diferem de outros esquemas pelo registro nas tabelas de estrutura.  Voc√™ pode fazer esse registro chamando um procedimento - tSQLt.NewTestClass. <br><br>  Dentro da classe de teste, tamb√©m √© poss√≠vel definir um procedimento SetUp que ser√° executado antes de cada caso de teste individual ser executado. <br><br>  N√£o √© necess√°rio um procedimento de desmontagem para restaurar o sistema ap√≥s a conclus√£o do caso de teste.  Cada caso de teste, juntamente com o procedimento SetUp, √© executado em uma transa√ß√£o separada, que √© revertida ap√≥s a coleta dos resultados.  Isso √© muito conveniente, mas tem alguns efeitos negativos, que discutimos abaixo. <br><br>  A estrutura permite executar casos de teste individuais, classes de teste inteiras ou todas as classes de teste registradas ao mesmo tempo. <br><br><h1>  Recursos por exemplo </h1><br>  N√£o tendo o desejo de recontar um guia oficial j√° simples, falarei sobre as possibilidades da estrutura usando exemplos. <br><br>  <i>Isen√ß√£o de responsabilidade:</i> <br><br><ul><li>  <i>exemplos s√£o simplificados;</i> </li><li>  <i>no original, nem todos os c√≥digos de teste foram escritos por mim, s√£o os frutos da criatividade coletiva;</i> </li><li>  <i>O Exemplo 2 foi inventado para demonstrar mais completamente os recursos do tSQLt.</i> </li></ul><br><h3>  Exemplo 1: CsvSql </h3><br>  A pedido de um dos clientes do cliente, o seguinte foi implementado.  O banco de dados nos campos Nvarchar (MAX) armazena consultas SQL.  Para visualizar essas consultas, um frontend m√≠nimo √© parafusado.  Os conjuntos de resultados retornados por essas solicita√ß√µes s√£o usados ‚Äã‚Äãpelo back-end para gerar o arquivo CSV para retornar por meio da chamada da API. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/5q/mu/oy/5qmuoyyjjvlphk79jt-xtawwjn8.png"></div><br>  Os conjuntos de resultados s√£o bastante pesados ‚Äã‚Äãe cont√™m muitas colunas.  Um exemplo condicional de um conjunto de resultados: <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/dg/50/bb/dg50bbx25qaw6ycwpfqcsfj5kyk.png"></div><br>  Este conjunto de resultados √© alguns dados de ensaios cl√≠nicos.  Vamos dar uma olhada em como o ClinicsNum √© considerado - o n√∫mero de cl√≠nicas envolvidas no estudo.  Temos duas tabelas: [Trial] e [Clinic]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/qo/mu/n-/qomun-gdbdl05teniypbtzi8jio.png"></div><br>  Existe FK: [Clinic]. [TrialID] -&gt; [Trial]. [TrialID].  Obviamente, para calcular o n√∫mero de cl√≠nicas, precisamos apenas da COUNT usual (*). <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*), ...  <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.Trial  <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> dbo.Clinic    <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> Trial.ID = Clinic.TrialID  <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> Trial.Name = @trialName  <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> ...</code> </pre> <br>  Como testamos essa solicita√ß√£o?  Para come√ßar, podemos usar o conveniente esbo√ßo - FakeTable, que simplificar√° muito o trabalho adicional. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Trial'; EXEC tSQLt.FakeTable 'dbo.Clinic';</code> </pre> <br>  O FakeTable faz uma coisa simples - renomeia tabelas antigas e cria novas em seu lugar.  Os mesmos nomes, as mesmas colunas, mas sem constrangimento'ov e disparo'ov. <br><br>  Por que precisamos disso: <br><br><ol><li>  Pode haver alguns dados no banco de dados de teste que podem interferir nos testes.  Gra√ßas ao FakeTable, n√£o somos dependentes deles. </li><li>  Para o teste, como regra, voc√™ precisa preencher apenas algumas colunas.  Pode haver muitos deles na tabela, e alguns deles ter√£o restri√ß√µes.  Dessa maneira, simplificamos a instala√ß√£o adicional dos dados de teste - inseriremos apenas aqueles realmente necess√°rios para o caso de teste. </li><li>  Definitivamente, n√£o afetamos nenhum gatilho ao inserir dados de teste e n√£o precisamos nos preocupar com p√≥s-efeitos indesejados. </li></ol><br>  Em seguida, insira os dados de teste que precisamos: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Trial ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-string"><span class="hljs-string">'Valerian'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.Clinic ([<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>], [TrialID], [<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic1'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>,   <span class="hljs-number"><span class="hljs-number">1</span></span>,        <span class="hljs-string"><span class="hljs-string">'Clinic2'</span></span>);</code> </pre> <br>  N√≥s obtemos nossa consulta do banco de dados, criamos a tabela Actual e a preenchemos com o conjunto de resultados da nossa consulta: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @sqlStatement <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>) = (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span>‚Ä¶ <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> actual ([TrialID], ...); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> actual EXEC sp_executesql @sqlStatement, ...</code> </pre> <br>  Preenchimento esperado - valores esperados: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> expected (   ClinicsNum <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> expected <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br>  Quero chamar sua aten√ß√£o para o fato de que, na tabela Esperado, temos apenas uma coluna, enquanto que em Real, temos um conjunto completo. <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/qd/gx/ga/qdgxgaqr4cjp2eayoz0eycjs8cg.png"></div><br>  Isso se deve ao recurso do procedimento AssertEqualsTable, que usaremos para verificar os valores. <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEqualsTable   'expected',   'actual',   'incorrect number of clinics';</code> </pre> <br>  Ele compara apenas as colunas que est√£o presentes nas duas tabelas sendo comparadas.  Isso √© muito conveniente no nosso caso, pois a consulta de teste retorna muitas colunas, cada uma com sua pr√≥pria l√≥gica, √†s vezes muito confusa.  N√£o queremos aumentar os casos de teste, portanto esse recurso √© muito √∫til para n√≥s.  Claro, esta √© uma faca de dois gumes.  Se em Real um conjunto de colunas for preenchido automaticamente atrav√©s de SELECT TOP 0 e, em algum momento, uma coluna extra aparecer de repente, esse caso de teste n√£o ser√° capturado neste momento.  Para lidar com essas situa√ß√µes, voc√™ precisa fazer verifica√ß√µes adicionais. <br><br><h3>  Procedimentos da irm√£ AssertEqualsTable </h3><br>  Vale ressaltar que o tSQLt cont√©m dois procedimentos semelhantes ao AssertEqualsTable.  Estes s√£o AssertEqualsTableSchema e AssertResultSetsHaveSameMetaData.  O primeiro faz o mesmo que AssertEqualsTable, mas nos metadados da tabela.  O segundo faz uma compara√ß√£o semelhante, mas nos metadados dos conjuntos de resultados. <br><br><h3>  Exemplo 2: Restri√ß√µes </h3><br>  No exemplo anterior, vimos como voc√™ pode remover as restri√ß√µes.  Mas e se precisarmos verificar?  Tecnicamente, isso tamb√©m faz parte da l√≥gica e tamb√©m pode ser considerado um candidato √† cobertura do teste. <br><br>  Considere a situa√ß√£o do exemplo anterior.  Duas tabelas - [Trial] e [Clinic];  [TrialID] FK: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-8/zu/v3/-8zuv3clqoo3ygm9wko5hpibc90.png"></div><br>  Vamos tentar escrever um caso de teste para testar essa restri√ß√£o.  A princ√≠pio, como da √∫ltima vez, falsificamos mesas. <br><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable '[dbo].[Trial]' EXEC tSQLt.FakeTable '[dbo].[Clinic]'</code> </pre> <br>  O objetivo √© o mesmo - livrar-se de restri√ß√µes desnecess√°rias.  Queremos verifica√ß√µes isoladas, sem gestos desnecess√°rios. <br><br>  Em seguida, retornamos a restri√ß√£o necess√°ria para o local usando o procedimento ApplyConstraint: <br><br><pre> <code class="sql hljs">EXEC tSQLt.ApplyConstraint   '[dbo].[Clinic]',   'Trial_FK';</code> </pre> <br>  Aqui reunimos uma configura√ß√£o conveniente para verifica√ß√£o direta.  A verifica√ß√£o propriamente dita consistir√° no fato de que uma tentativa de inserir dados levar√° inevitavelmente a uma exce√ß√£o.  Para que o caso de teste funcione corretamente, precisamos capturar essa mesma exce√ß√£o.  O manipulador de exce√ß√£o ExpectException nos ajudar√° com isso. <br><br><pre> <code class="sql hljs">EXEC tSQLt.ExpectException   @ExpectedMessage = 'The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted...<span class="hljs-string"><span class="hljs-string">',   @ExpectedSeverity = 16,   @ExpectedState = 0;</span></span></code> </pre> <br>  Ap√≥s instalar o manipulador, voc√™ pode tentar inserir o n√£o inser√≠vel. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> [dbo].[Clinic] ([TrialID])   <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Exce√ß√£o capturada.  Teste aprovado. <br><br><h3>  Procedimentos para irm√£s ApplyConstraint </h3><br>  Os desenvolvedores do TSQLt nos oferecem uma abordagem semelhante para testar gatilhos.  Voc√™ pode usar o procedimento ApplyTrigger para retornar um gatilho para a tabela falsa.  Al√©m disso, tudo √© como no exemplo acima - acionamos o gatilho, verificamos o resultado. <br><br><h3>  ExpectNoException - o ant√¥nimo de ExpectException </h3><br>  Nos casos em que definitivamente n√£o deve ocorrer uma exce√ß√£o, existe um procedimento ExpectNoException.  Funciona da mesma maneira que uma ExpectException, exceto que o teste √© considerado falhado se ocorrer uma exce√ß√£o. <br><br><h3>  Exemplo 3: sem√°foro </h3><br>  A situa√ß√£o √© a seguinte.  H√° v√°rios procedimentos armazenados e servi√ßos do Windows.  O in√≠cio de sua execu√ß√£o pode ser causado por v√°rios eventos externos.  Al√©m disso, a ordem permitida de sua execu√ß√£o √© fixa.  Um sem√°foro √© usado para diferenciar o acesso √†s tabelas do banco de dados.  √â um grupo de procedimentos armazenados. <br><br>  Por exemplo, considere um desses procedimentos.  Temos duas tabelas: <br><br><div style="text-align:center;"><img width="80%" height="80%" src="https://habrastorage.org/webt/-m/hz/8-/-mhz8-fm_n1w7njpryiv8z3epiw.png"></div><br>  A tabela [Process] cont√©m uma lista de processos permitidos para execu√ß√£o, [ProcStatus] - uma lista de status desses processos. <br><br>  O que nosso procedimento faz?  Quando chamado, uma s√©rie de verifica√ß√µes ocorre primeiro: <br><br><ol><li>  O nome do processo a ser iniciado, transmitido no par√¢metro do procedimento, √© pesquisado no campo [Nome] da tabela [Processo]. </li><li>  Se o nome do processo foi encontrado, √© verificado se atualmente √© poss√≠vel inici√°-lo - o sinalizador [IsRunable] da tabela [Process]. </li><li>  Se o processo for aceit√°vel para execu√ß√£o, resta garantir que ele ainda n√£o esteja em execu√ß√£o.  Na tabela [ProcStatus], a aus√™ncia de registros sobre esse processo com o status = 'InProg' √© verificada. </li></ol><br>  Se tudo estiver correto, um novo registro sobre esse processo com o status 'InProg' ser√° adicionado ao ProcStatus (isso √© considerado um lan√ßamento), o ID desse registro ser√° retornado com o par√¢metro ProcStatusId.  Se alguma verifica√ß√£o falhar, esperamos o seguinte: <br><br><ol><li>  Uma carta √© enviada ao administrador do sistema. </li><li>  Retorna ProcStatusId = -1. </li><li>  Uma nova entrada em [ProcStatus] n√£o √© adicionada. </li></ol><br>  Vamos escrever um caso de teste para testar o caso quando o processo n√£o estiver na lista dos aceit√°veis. <br><br>  Por conveni√™ncia, aplique imediatamente o FakeTable.  Aqui n√£o √© t√£o fundamentalmente importante, mas pode ser √∫til: <br><br><ol><li>  Temos a garantia de nos livrar de quaisquer dados que possam interferir na execu√ß√£o correta do caso de teste. </li><li>  Simplificaremos a verifica√ß√£o adicional de entradas ausentes no ProcStatus. </li></ol><br><pre> <code class="sql hljs">EXEC tSQLt.FakeTable 'dbo.Process'; EXEC tSQLt.FakeTable 'dbo.ProcStatus';</code> </pre> <br>  Para enviar uma mensagem, √© usado o procedimento [SendEmail] escrito por nossos programadores.  Para verificar o envio de uma carta aos administradores, precisamos atender a liga√ß√£o dela.  Nesse caso, o tSQLt nos oferece o uso do SpyProcedure. <br><br><pre> <code class="sql hljs">EXEC tSQLt.SpyProcedure 'dbo.SendEmail'</code> </pre> <br>  O SpyProcedure faz o seguinte: <br><br><ol><li>  Cria uma tabela no formato [dbo]. [SendEmail_SpyProcedureLog]. </li><li>  Como o FakeTable, ele substitui o procedimento original pelo seu pr√≥prio, com o mesmo nome, mas contendo a l√≥gica de log.  Se desejar, voc√™ pode adicionar qualquer uma de sua pr√≥pria l√≥gica. </li></ol><br>  Como voc√™ pode imaginar, o registro ocorre na tabela [dbo]. [SendEmail_SpyProcedureLog].  Esta tabela cont√©m a coluna [_ID_] - o n√∫mero de sequ√™ncia da chamada de procedimento.  As colunas subseq√ºentes exibem os nomes dos par√¢metros passados ‚Äã‚Äãpara o procedimento e os valores passados ‚Äã‚Äãnas chamadas s√£o coletados neles.  Se necess√°rio, eles tamb√©m podem ser verificados. <br><br><div style="text-align:center;"><img width="75%" height="75%" src="https://habrastorage.org/webt/ko/gh/4h/kogh4hgcdsxagldk2bmdcfrptzi.png"></div><br>  A √∫ltima coisa que precisamos fazer antes de chamar o sem√°foro e a verifica√ß√£o √© criar uma vari√°vel na qual colocaremos o ID do registro da tabela [ProcStatus] (mais precisamente -1, porque o registro n√£o ser√° adicionado). <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ProcStatusId <span class="hljs-built_in"><span class="hljs-built_in">BIGINT</span></span>;</code> </pre> <br>  Ligue para o sem√°foro: <br><br><pre> <code class="sql hljs">EXEC dbo.[Semaphore_JobStarter]   'SomeProcess',   @ProcStatusId OUTPUT; <span class="hljs-comment"><span class="hljs-comment">--    -1</span></span></code> </pre> <br>  √â isso, agora temos todos os dados necess√°rios para verifica√ß√£o.  Vamos come√ßar verificando a remessa. <br>  letras: <br><br><pre> <code class="sql hljs">IF NOT EXISTS (   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dbo.SendEmail_SpyProcedureLog) EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'SendEmail has not been run.'</span></span>;</code> </pre> <br>  Nesse caso, decidimos n√£o verificar os par√¢metros transmitidos durante o envio, mas simplesmente verificar o fato em si.  Chamo sua aten√ß√£o para o procedimento tSQLt.Fail.  Ele permite que voc√™ "oficialmente" falhe no caso de teste.  Se voc√™ precisar criar alguma constru√ß√£o espec√≠fica, o tSQLt.Fail permitir√° que voc√™ fa√ßa isso. <br><br>  Em seguida, verifique a aus√™ncia de entradas no [dbo]. [ProcStatus]: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEmptyTable 'dbo.ProcStatus';</code> </pre> <br>  √â aqui que a FakeTable que aplicamos desde o in√≠cio nos ajudou.  Gra√ßas a ele, podemos esperar um vazio.  Sem ele, para uma verifica√ß√£o precisa, devemos, em boa medida, comparar o n√∫mero de registros antes e depois do sem√°foro. <br><br>  Igualdade ProcStatusId = -1, podemos verificar facilmente com AssertEquals: <br><br><pre> <code class="sql hljs">EXEC tSQLt.AssertEquals   -1,       @ProcStatusId,       'Wrong ProcStatusId.';</code> </pre> <br>  AssertEquals √© minimalista - simplesmente compara dois valores, nada sobrenatural. <br><br><h3>  Procedimentos de Irm√£os AssertEquals </h3><br>  Para comparar os valores, somos fornecidos com v√°rios procedimentos: <br><br><ul><li>  AssertEquals </li><li>  AssertNotEquals </li><li>  AssertEqualsString </li><li>  Assertike </li></ul><br>  Eu acho que os nomes deles falam por si.  A √∫nica coisa que vale a pena notar √© a exist√™ncia de um procedimento AssertEqualsString separado.  O problema √© que AssertEquals / AssertNotEquals / AssertLike trabalha com SQL_VARIANT e o NVARCHAR (MAX) n√£o se aplica a ele, e, portanto, os desenvolvedores do tSQLt tiveram que alocar um procedimento separado para testar o NVARCHAR (MAX). <br><br><h3>  Fun√ß√£o falsa </h3><br>  O FakeFunction com algum alongamento pode ser chamado de procedimento semelhante ao SpyProcedure.  Esse falso permite que voc√™ substitua qualquer fun√ß√£o pela mais simples necess√°ria.  Como as fun√ß√µes no SQL Server funcionam com o princ√≠pio de um tubo com pasta de dente - elas fornecem o resultado atrav√©s do "√∫nico furo tecnol√≥gico", ent√£o, infelizmente, nenhuma funcionalidade de log √© fornecida.  Apenas um substituto para a l√≥gica. <br><br><h1>  Armadilhas </h1><br>  Vale a pena notar algumas armadilhas que voc√™ pode encontrar ao trabalhar com o tSQLt.  Nesse caso, por armadilhas, quero dizer alguns problemas problem√°ticos que nasceram devido √†s limita√ß√µes do SQL Server e / ou que n√£o podem ser resolvidos pelos desenvolvedores da estrutura. <br><br><h3>  Cancelamento / corrup√ß√£o de transa√ß√µes </h3><br>  O primeiro e mais importante problema que nossa equipe enfrentou foi o cancelamento de transa√ß√µes.  O SQL Server n√£o sabe como reverter transa√ß√µes aninhadas separadamente - apenas tudo como um todo, at√© as mais externas.  Dado o fato de o tSQLt agrupar cada caso de teste em uma transa√ß√£o separada, isso se torna um problema.  Afinal, uma revers√£o de transa√ß√£o dentro do procedimento de teste pode interromper a execu√ß√£o do teste, causando um erro de execu√ß√£o n√£o descritivo. <br><br>  Para contornar esse problema, usamos pontos de salvamento.  A ideia √© simples.  Antes de iniciar uma transa√ß√£o no procedimento de teste, verificamos se j√° estamos dentro da transa√ß√£o.  Se acontecer que sim, estamos assumindo que essa √© uma transa√ß√£o tSQLt, coloque o savepoint em vez de iniciar.  Ent√£o, se necess√°rio, reverteremos para esse ponto de salvamento, e n√£o para o in√≠cio da transa√ß√£o.  Aninhamento como tal n√£o √©. <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/zk/0u/jc/zk0ujc2gmggccs7bg7icraan3da.png"></div><br>  O problema √© complicado pela corrup√ß√£o da transa√ß√£o.  Se de repente algo deu errado e a exce√ß√£o funcionou, a transa√ß√£o pode se tornar uma condena√ß√£o.  Essa transa√ß√£o pode n√£o apenas ser confirmada, mas tamb√©m revertida para o savepoint, revertida apenas a coisa toda. <br><br>  Dado todo o exposto, voc√™ deve aplicar o seguinte design: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY BEGIN CATCH   DECLARE @isCommitable BIT =       CASE WHEN XACT_STATE() = 1           THEN 'true'           ELSE 'false'   END;   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       ROLLBACK TRANSACTION SavepointName;   ELSE       ROLLBACK;   THROW; END CATCH;</span></span></code> </pre> <br>  Considere o c√≥digo em partes.  Primeiro, precisamos determinar se estamos dentro de uma transa√ß√£o: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isNestedTransaction <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =   <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> @@trancount &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  Ap√≥s receber o sinalizador @isNestedTransaction, execute o bloco TRY e defina o savepoint ou o in√≠cio da transa√ß√£o, dependendo da situa√ß√£o. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY   <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @isNestedTransaction = <span class="hljs-string"><span class="hljs-string">'false'</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span>       <span class="hljs-keyword"><span class="hljs-keyword">SAVE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;       <span class="hljs-comment"><span class="hljs-comment">-- something useful</span></span></code> </pre> <br>  Depois de termos feito algo √∫til, confirme se este √© um in√≠cio "real" do procedimento. <br><br><pre> <code class="sql hljs">       <span class="hljs-comment"><span class="hljs-comment">-- something useful   IF @isNestedTransaction = 'false'   COMMIT TRANSACTION; END TRY</span></span></code> </pre> <br>  Obviamente, se este √© um lan√ßamento de um caso de teste, n√£o precisamos confirmar nada.  No final da execu√ß√£o, o tSQLt simplesmente reverter√° todas as altera√ß√µes.  Se de repente algo deu errado e entramos no bloco CATCH, a primeira coisa a fazer √© descobrir se nossa transa√ß√£o pode at√© ser confirmada. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH   <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @isCommitable <span class="hljs-built_in"><span class="hljs-built_in">BIT</span></span> =       <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> XACT_STATE() = <span class="hljs-number"><span class="hljs-number">1</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-string"><span class="hljs-string">'true'</span></span>           <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-string"><span class="hljs-string">'false'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre> <br>  S√≥ podemos reverter para o savepoint se <br><br><ol><li>  transa√ß√£o compromet√≠vel </li><li>  ocorre uma execu√ß√£o de teste, ou seja,  existe um ponto de salvamento. </li></ol><br>  Em outros casos, precisamos reverter toda a transa√ß√£o. <br><br><pre> <code class="sql hljs">   IF @isCommitable = 'true' AND @isNestedTransaction = 'true'       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> SavepointName;   ELSE       <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;   THROW; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH;</code> </pre> <br>  Sim, infelizmente, se durante uma execu√ß√£o de teste obtivemos uma transa√ß√£o inconfund√≠vel, ainda recebemos um erro na execu√ß√£o do caso de teste. <br><br><h3>  FakeTable e problema com chave estrangeira </h3><br>  Considere as tabelas familiares [Trial] e [Clinic]: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/fy/k7/nm/fyk7nmhfha_fnezignyxclpflay.png"></div><br>  Lembramos do [TrialID] FK.  Que problemas isso pode causar?  Nos exemplos dados anteriormente, aplicamos o FakeTable nas duas tabelas ao mesmo tempo.  Se aplicarmos apenas em [Trial], obteremos a seguinte situa√ß√£o: <br><br><div style="text-align:center;"><img width="85%" height="85%" src="https://habrastorage.org/webt/og/to/3-/ogto3-drjheieblpi1_gsyup4hs.png"></div><br>  Uma tentativa de inserir uma entrada em [Clinic], dessa maneira, pode resultar em falha (mesmo que tenhamos preparado todos os dados necess√°rios na vers√£o falsa da tabela [Trial]). <br><br><pre> <code class="sql hljs">[dbo].[Test_FK_Problem] failed: (Error) The <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> conflicted <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> <span class="hljs-string"><span class="hljs-string">"Trial_Fk"</span></span>. The conflict occurred <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">"HabrDemo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-string"><span class="hljs-string">"dbo.tSQLt_tempobject_ba8f36353f7a44f6a9176a7d1db02493"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">column</span></span> <span class="hljs-string"><span class="hljs-string">'TrialID'</span></span>.[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>]{Test_FK_Problem,<span class="hljs-number"><span class="hljs-number">14</span></span>}</code> </pre> <br>  Conclus√£o: voc√™ precisa fingir tudo ou n√£o fingir nada.  No segundo caso, √© √≥bvio que a base deve ser preparada com anteced√™ncia para teste. <br><br><h3>  SpyProcedure nos procedimentos do sistema </h3><br>  Infelizmente, a espionagem de chamadas para procedimentos do sistema falhar√°. <br><br><pre> <code class="sql hljs">[HabrDemo].[test_test] failed: (Error) Cannot <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> SpyProcedure <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> sys.sp_help because the <span class="hljs-keyword"><span class="hljs-keyword">procedure</span></span> does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> exist[<span class="hljs-number"><span class="hljs-number">16</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>] {tSQLt.Private_ValidateProcedureCanBeUsedWithSpyProcedure,<span class="hljs-number"><span class="hljs-number">7</span></span>}</code> </pre> <br>  No exemplo do sem√°foro, rastreamos as chamadas para o procedimento [SendEmail] escrito por nossos desenvolvedores.  Nesse caso, a grava√ß√£o de um procedimento separado deve-se √† necessidade de coletar e processar algumas informa√ß√µes adicionais antes de enviar as mensagens diretamente.  Em geral, √© preciso estar mentalmente preparado para o fato de que talvez seja necess√°rio escrever procedimentos entre camadas para alguns procedimentos do sistema apenas para fins de teste. <br><br><h1>  Vantagens </h1><br><h3>  Instala√ß√£o r√°pida </h3><br>  A instala√ß√£o ocorre em 2 etapas e leva cerca de 2 minutos.  Voc√™ s√≥ precisa ativar o CLR no servidor, se ainda n√£o estiver pronto, e executar um √∫nico script.  Tudo, voc√™ pode adicionar a primeira classe de teste e escrever casos de teste. <br><br><h3>  Desenvolvimento r√°pido </h3><br>  O tSQLt √© uma ferramenta f√°cil de aprender.  Levei um pequeno dia para domin√°-lo.  Perguntei aos meus colegas que trabalhavam com a estrutura, e acabou que todos gastariam cerca de um dia. <br><br><h3>  Implementa√ß√£o r√°pida no IC </h3><br>  Demorou cerca de 2 horas para configurar a integra√ß√£o no CI em nosso projeto.  O tempo, √© claro, pode variar, mas em geral isso n√£o √© um problema, e a integra√ß√£o pode ser realizada muito rapidamente. <br><br><h3>  Ampla gama de ferramentas </h3><br>  Essa √© uma avalia√ß√£o subjetiva, mas, na minha opini√£o, a funcionalidade fornecida pelo tSQLt √© bastante rica e cobre a maior parte das necessidades na pr√°tica.  Para casos raros, quando n√£o h√° falsifica√ß√µes e asser√ß√µes internas suficientes, existe, √© claro, tSQLt.Fail. <br><br><h3>  Documenta√ß√£o conveniente </h3><br>  A documenta√ß√£o oficial √© conveniente e consistente.  Com sua ajuda, voc√™ pode entender facilmente a ess√™ncia do uso do tSQLt em um curto espa√ßo de tempo, mesmo que essa seja sua primeira ferramenta de teste de unidade. <br><br><h3>  Sa√≠da conveniente </h3><br>  Os dados podem ser obtidos em uma forma de texto muito claro: <br><br><pre> <code class="plaintext hljs">[tSQLtDemo].[test_error_messages] failed: (Failure) Expected an error to be raised. [tSQLtDemo].[test_tables_comparison] failed: (Failure) useful and descriptive error message Unexpected/missing resultset rows! |_m_|Column1|Column2| +---+-------+-------+ |&lt; |2 |Value2 | |= |1 |Value1 | |= |3 |Value3 | |&gt; |2 |Value3 | +----------------------+ |Test Execution Summary| +----------------------+ |No|Test Case Name |Dur(ms)|Result | +--+------------------------------------+-------+-------+ |1 |[tSQLtDemo].[test_constraint] | 83|Success| |2 |[tSQLtDemo].[test_trial_view] | 83|Success| |3 |[tSQLtDemo].[test_error_messages] | 127|Failure| |4 |[tSQLtDemo].[test_tables_comparison]| 147|Failure| ----------------------------------------------------------------------------- Msg 50000, Level 16, State 10, Line 1 Test Case Summary: 4 test case(s) executed, 2 succeeded, 2 failed, 0 errored. -----------------------------------------------------------------------------</code> </pre><br>  Voc√™ tamb√©m pode extrair do banco de dados (clic√°vel) ... <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/webt/-f/83/la/-f83lajcz1mfcnkhtttz45b0x3g.png"></a> </div><br>  ... ou entre no formato XML. <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">tests</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">errors</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">failures</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">timestamp</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2019-06-22T16:46:06"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.433"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hostname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"BLAHBLAHBLAH\SQL2017"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">package</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_constraint"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.097"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_error_messages"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.153"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">failure</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Expected an error to be raised."</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLt.Fail"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testcase</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">classname</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"tSQLtDemo"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test_trial_view"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">time</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0.156"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-out</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system-err</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuite</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">testsuites</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  A √∫ltima op√ß√£o permite integrar facilmente os testes ao IC.  Em particular, tudo funciona para n√≥s no Atlassian Bamboo. <br><br><h3>  Suporte Redgate </h3><br>  As vantagens incluem suporte para um grande fornecedor de ferramentas DBA como o RedGate.  O Teste SQL - seu plug-in para o SQL Server Management Studio - funciona com o tSQLt imediatamente.  Al√©m disso, o RedGate fornece assist√™ncia ao desenvolvedor principal do tSQLt com o ambiente de desenvolvimento, como afirma o pr√≥prio desenvolvedor dos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grupos do Google</a> . <br><br><h1>  Desvantagens </h1><br><h3>  Sem falsifica√ß√µes tempor√°rias na mesa </h3><br>  O tSQLt n√£o permite tabelas tempor√°rias falsas.  Se necess√°rio, voc√™ pode usar o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">complemento n√£o oficial</a> .  Infelizmente, este complemento √© suportado apenas pelo SQL Server 2016+. <br><br><h3>  Sem acesso a bancos de dados externos </h3><br>  N√£o funcionar√° para manter uma base separada apenas para armazenar a estrutura.  O tSQLt foi projetado para testar o que est√° no mesmo banco de dados.  Falso, infelizmente, n√£o vai funcionar. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>]   EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'[AdventureWorks2017].[Person].[Password]'</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">10</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> [AdventureWorks2017].[Person].[<span class="hljs-keyword"><span class="hljs-keyword">Password</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ga/au/ny/gaaunygdr124sssxhonbb2s0b_0.png"></div><br>  As afirma√ß√µes parecem funcionar, mas ningu√©m garante seu desempenho, √© claro. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [tSQLtDemo].[test_outer_db_assertions] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>   <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TOP <span class="hljs-number"><span class="hljs-number">1</span></span> *   <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> <span class="hljs-comment"><span class="hljs-comment">#Actual   FROM [AdventureWorks2017].[Person].[Password]   SELECT *   INTO #Expected   FROM (          SELECT 'bE3XiWw=' AS [PasswordSalt]   ) expectedresult;   EXEC tSQLt.AssertEqualsTable '#Expected', '#Actual', 'The salt is not salty'; END</span></span></code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cg/dk/ow/cgdkowych69imevqmbirkkgsniq.png"></div><br><h3>  Erros de documenta√ß√£o </h3><br>  Apesar de ter escrito acima sobre a consist√™ncia e acessibilidade da documenta√ß√£o, ela tamb√©m cont√©m problemas.  Existem alguns momentos desatualizados. <br><br>  Exemplo 1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">‚ÄúGuia de in√≠cio r√°pido‚Äù</a> sugere o download da estrutura do SourceForge.  Eles se despediram do SourceForge <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">em 2015</a> . <br><br>  Exemplo 2. O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">guia ApplyConstraint</a> no exemplo usa um procedimento Fail para capturar uma exce√ß√£o, que seria mais f√°cil e mais visual para substituir por ExpectException. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> ConstraintTests.[<span class="hljs-keyword"><span class="hljs-keyword">test</span></span> ReferencingTable_ReferencedTable_FK prevents <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> orphaned <span class="hljs-keyword"><span class="hljs-keyword">rows</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.FakeTable <span class="hljs-string"><span class="hljs-string">'dbo.ReferencedTable'</span></span>; EXEC tSQLt.FakeTable 'dbo.ReferencingTable'; EXEC tSQLt.ApplyConstraint 'dbo.ReferencingTable','ReferencingTable_ReferencedTable_FK'; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* []     ExceptException ? */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> dbo.ReferencingTable ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, ReferencedTableId ) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span> ) ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> TRY <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @ErrorMessage = ERROR_MESSAGE(); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> CATCH <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> @ErrorMessage <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%ReferencingTable_ReferencedTable_FK%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> EXEC tSQLt.Fail <span class="hljs-string"><span class="hljs-string">'Expected error message containing ''ReferencingTable_ReferencedTable_FK'' but got: '''</span></span>,@ErrorMessage,<span class="hljs-string"><span class="hljs-string">'''!'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  E isso √© natural, porque acontece ... <br><br><h3>  Abandono parcial </h3><br>  H√° uma longa pausa no desenvolvimento do tSQLt do in√≠cio de 2016 a junho de 2019. Sim, infelizmente, essa ferramenta est√° parcialmente abandonada.  Em 2019, pouco a pouco, a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">julgar pelo GitHub</a> , o desenvolvimento ainda avan√ßou.  Embora os Grupos oficiais do Google <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">tenham um t√≥pico</a> em que Sebastian, o principal desenvolvedor do tSQLt, foi perguntado diretamente sobre o destino do desenvolvimento.  A √∫ltima pergunta foi feita em 2 de mar√ßo de 2019, a resposta ainda n√£o foi recebida. <br><br><h3>  Problema com o SQL Server 2017 </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Se voc√™ estiver usando o SQL Server 2017, para voc√™, possivelmente a instala√ß√£o do tSQLt exigir√° alguma manipula√ß√£o adicional. </font><font style="vertical-align: inherit;">O fato √© que, pela primeira vez desde 2012, o SQL Server fez altera√ß√µes na seguran√ßa. </font><font style="vertical-align: inherit;">No n√≠vel do servidor, o sinalizador ‚ÄúCLR strict security‚Äù foi adicionado, o que pro√≠be a cria√ß√£o de assemblies n√£o assinados (mesmo o SAFE). </font><font style="vertical-align: inherit;">Uma descri√ß√£o detalhada do problema merece um artigo separado (e, felizmente, tudo j√° est√° bem </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">descrito</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> e os artigos subsequentes da s√©rie). </font><font style="vertical-align: inherit;">Apenas esteja mentalmente preparado para isso. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviamente, pode-se atribuir essa desvantagem a "armadilhas", cuja solu√ß√£o n√£o depende dos desenvolvedores do tSQLt, mas √© poss√≠vel resolver esse problema no n√≠vel da estrutura, embora demore um pouco. </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">O GitHub j√° tem um problema</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> √â verdade que, com a permiss√£o dele, eles se arrastam desde outubro de 2017 (veja o par√°grafo anterior). </font></font><br><br><h1><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Alternativas (¬±) para outros DBMSs </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tamb√©m vale a pena mencionar alternativas para outros DBMSs. </font><font style="vertical-align: inherit;">O tSQLt n√£o √© a √∫nica ferramenta desse tipo. </font><font style="vertical-align: inherit;">Embora, devido aos recursos de implementa√ß√£o (CLR e T-SQL sejam significativamente diferentes de outros dialetos SQL), voc√™ n√£o possa us√°-lo em outros DBMSs, ainda poder√° encontrar ferramentas semelhantes. </font><font style="vertical-align: inherit;">Observo que essas alternativas diferem significativamente do tSQLt, por isso estamos falando principalmente sobre a abordagem baseada em SQL como um todo. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Portanto, no PostgreSQL, existe um </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ptTAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bastante desenvolvido e ativamente desenvolvido </font><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Envolve a grava√ß√£o de testes no PL / pgSQL nativo e a sa√≠da dos resultados no formato TAP. </font><font style="vertical-align: inherit;">No MySQL, existe uma ferramenta semelhante, embora um pouco menos funcional - </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">MyTAP</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Se voc√™ tiver sorte de trabalhar com o Oracle, ter√° a oportunidade de usar o </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">utPLSQL</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Uma ferramenta muito poderosa e ativamente (eu diria, mais do que) uma ferramenta de desenvolvimento.</font></font><br><br><h1>  Conclus√£o </h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Talvez, com todas as informa√ß√µes acima, eu quis transmitir duas id√©ias principais. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A primeira √© a utilidade de testar o c√≥digo em um banco de dados. </font><font style="vertical-align: inherit;">Esteja voc√™ sentado no SQL Server, Oracle ou MySQL, isso n√£o importa. </font><font style="vertical-align: inherit;">Se voc√™ possui uma certa quantidade de l√≥gica n√£o testada armazenada no banco de dados, assume riscos adicionais. </font><font style="vertical-align: inherit;">Os erros no c√≥digo do banco de dados s√£o capazes, como no restante do c√≥digo, de causar danos ao produto e, como resultado, √† empresa que o fornece. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A segunda id√©ia √© escolher uma ferramenta. </font><font style="vertical-align: inherit;">Se voc√™, como eu, trabalha com o SQL Server, o tSQLt √©, se n√£o 100% um vencedor, definitivamente vale a pena sua aten√ß√£o. </font><font style="vertical-align: inherit;">Mesmo apesar do lento desenvolvimento recente, ainda √© uma ferramenta relevante que facilita muito os testes.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Fontes que me ajudaram (lista incompleta)</font></font></b> <div class="spoiler_text"> DbFit ‚Äî Automated Open Source Database Testing: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://www.methodsandtools.com/tools/dbfit.php</a> <br><br> DbFit Documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://dbfit.github.io/dbfit/docs/</a> <br><br> Slacker wiki: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/vassilvk/slacker/wiki</a> <br><br> TST documentation: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://archive.codeplex.com/projects/TST/4e04e281-9f35-4891-809a-15f09d304f4e</a> <br><br> NUnit Assertions: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/nunit/docs/wiki/Assertions</a> <br><br> utTSQL code: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://sourceforge.net/p/uttsql/code/HEAD/tree/</a> <br><br> Junit Class Assert: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://junit.org/junit4/javadoc/latest/org/junit/Assert.html</a> <br><br> pgTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://pgtap.org/</a> <br><br> utPLSQL: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">http://utplsql.org/</a> <br><br> MyTap: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/hepabolu/mytap</a> <br><br> tSQLt Google groups: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://groups.google.com/forum/#!forum/tsqlt</a> <br><br> tSQLt official website: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://tsqlt.org/</a> <br><br> tSQLt GitHub: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://github.com/tSQLt-org/tSQLt</a> <br><br> Google trends: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://bit.ly/2x7BQL6</a> <br><br> How to ROLLBACK a transaction when testing using tSQLt: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://stackoverflow.com/questions/8973138/how-to-rollback-a-transaction-when-testing-using-tsqlt</a> <br><br> What are the Pros and Cons of Manual Unit Testing against the Automated Unit Testing?: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://stackoverflow.com/questions/2948337/what-are-the-pros-and-cons-of-manual-unit-testing-against-the-automated-unit-tes#2948354</a> <br><br> The Good, the Bad, and the UgleÃÖeÃÖ: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://sqlquantumleap.com/2017/08/07/sqlclr-vs-sql-server-2017-part-1-clr-strict-security/</a> <br><br> Rex Black, Erik Van Veenendal, Dorothy Graham, Foundations of Software Testing, Third edition, 2012 Cengage Learning EMEA <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461133/">https://habr.com/ru/post/pt461133/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461121/index.html">Pequenas experi√™ncias multitarefa em um microcontrolador</a></li>
<li><a href="../pt461125/index.html">A tarefa de criar c√≥digos num√©ricos seq√ºenciais para numerar mensagens no c√≥digo-fonte no Visual Studio (ex. C #)</a></li>
<li><a href="../pt461127/index.html">An√°lise de desempenho da VM no VMware vSphere. Parte 3: Armazenamento</a></li>
<li><a href="../pt461129/index.html">Sobre kote, esposa, dois filhos, a id√©ia ... e n√£o apenas. Hist√≥ria com continua√ß√£o</a></li>
<li><a href="../pt461131/index.html">Caminh√£o de carrinho ROS - Parte 2. Software</a></li>
<li><a href="../pt461137/index.html">Como desenvolvemos um dispositivo para monitorar a aten√ß√£o dos motoristas. Experimente o Yandex.Taxi</a></li>
<li><a href="../pt461141/index.html">Meu primeiro dia com o Haiku: ela √© inesperadamente boa</a></li>
<li><a href="../pt461143/index.html">Sobre quest√µes atuais de design de jogos e formas de resolv√™-las. Vista de baixo</a></li>
<li><a href="../pt461145/index.html">O que uma equipe deve liderar: pap√©is, responsabilidades e habilidades</a></li>
<li><a href="../pt461147/index.html">Como economizar 64 horas combinando chaves no PowerPoint</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>