<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî≠ üìç üë±üèø Migra√ß√£o de dados ElasticSearch sem perdas üë®üèΩ‚Äçü§ù‚Äçüë®üèº ü•à üì¶</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O design acad√™mico do data warehouse recomenda manter tudo em uma forma normalizada, com conex√µes entre eles. Em seguida, a revers√£o de altera√ß√µes na ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Migra√ß√£o de dados ElasticSearch sem perdas</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416069/"><p><img src="https://habrastorage.org/webt/1e/oc/om/1eocom45kcqgz65q-wneyoqopdg.jpeg"></p><br><p>  O design acad√™mico do data warehouse recomenda manter tudo em uma forma normalizada, com conex√µes entre eles.  Em seguida, a revers√£o de altera√ß√µes na matem√°tica relacional fornecer√° um reposit√≥rio confi√°vel com suporte a transa√ß√µes.  Atomicidade, consist√™ncia, isolamento, durabilidade - isso √© tudo.  Em outras palavras, o reposit√≥rio √© especialmente desenvolvido para atualizar dados com seguran√ßa.  Mas n√£o √© ideal para pesquisa, especialmente com um amplo gesto entre tabelas e campos.  Precisa de √≠ndices, muitos √≠ndices.  Os volumes crescem, a grava√ß√£o diminui.  O SQL LIKE n√£o est√° indexado e JOIN GROUP BY envia-o para o planejador de consultas para meditar. </p><a name="habracut"></a><br><p>  A carga crescente em uma m√°quina for√ßa a expans√£o, verticalmente no teto ou horizontalmente, comprando mais alguns n√≥s.  Os requisitos de failover distribuem os dados por v√°rios n√≥s.  E o requisito de recupera√ß√£o imediata ap√≥s uma falha, sem nega√ß√£o de servi√ßo, obriga a configurar o cluster de m√°quinas para que, a qualquer momento, qualquer uma delas possa executar grava√ß√£o e leitura.  Ou seja, j√° ser um mestre ou se tornar ele automaticamente e imediatamente. </p><br><p>  O problema da pesquisa r√°pida foi resolvido com a instala√ß√£o de um segundo reposit√≥rio otimizado para indexa√ß√£o nas proximidades.  Pesquisa de texto completo, facetada, com stemming <del>  e blackjack </del>  .  O segundo armazenamento aceita entradas das tabelas do primeiro como entrada, analisa e cria o √≠ndice.  Assim, o cluster de armazenamento de dados foi complementado por outro cluster para sua pesquisa.  Com uma configura√ß√£o principal semelhante para corresponder ao <em>SLA</em> geral.  Est√° tudo bem, os neg√≥cios est√£o satisfeitos, os administradores dormem √† noite ... at√© que haja mais de tr√™s m√°quinas no cluster mestre-mestre. </p><br><h2 id="elastic">  El√°stico </h2><br><p>  O movimento <em>NoSQL</em> expandiu bastante o horizonte de escala para dados pequenos e grandes.  Os n√≥s NoSQL do cluster podem distribuir dados entre si para que a falha de um ou mais deles n√£o leve a uma nega√ß√£o de servi√ßo para todo o cluster.  O pagamento pela alta disponibilidade dos dados distribu√≠dos foi a incapacidade de garantir sua consist√™ncia completa para grava√ß√£o a qualquer momento.  Em vez disso, o NoSQL fala de <em>consist√™ncia eventual</em> .  Ou seja, acredita-se que um dia todos os dados sejam dispersos para os n√≥s do cluster e eles se tornar√£o consistentes a longo prazo. </p><br><p>  Portanto, o modelo relacional foi complementado pelo modelo n√£o relacional e gerou muitos mecanismos de banco de dados que resolvem os problemas do tri√¢ngulo da <em>CAP</em> com algum sucesso.  Os desenvolvedores chegaram a suas m√£os ferramentas modernas para criar sua pr√≥pria camada de <em>persist√™ncia</em> ideal - para todos os gostos, or√ßamentos e perfis de carga. </p><br><p>  O ElasticSearch √© um representante do NoSQL agrupado com uma API JSON RESTful no mecanismo Lucene, de c√≥digo aberto em Java, capaz n√£o apenas de criar um √≠ndice de pesquisa, mas tamb√©m de armazenar o documento original.  Essa simula√ß√£o ajuda a repensar o papel de um DBMS separado para armazenar originais ou at√© mesmo abandon√°-lo.  O fim da introdu√ß√£o. </p><br><h2 id="mapping">  Mapeamento </h2><br><p>  O mapeamento no ElasticSearch √© algo como um esquema (estrutura da tabela, em termos de SQL) que informa exatamente como indexar documentos recebidos (registros, em termos de SQL).  O mapeamento pode ser est√°tico, din√¢mico ou ausente.  O mapeamento est√°tico n√£o permite ser alterado.  Din√¢mico permite adicionar novos campos.  Se o mapeamento n√£o for especificado, o ElasticSearch far√° isso sozinho, tendo recebido o primeiro documento para grava√ß√£o.  Ele analisar√° a estrutura dos campos, far√° algumas suposi√ß√µes sobre os tipos de dados neles, pular√° as configura√ß√µes padr√£o e as anotar√°.  Esse comportamento sem circuito, √† primeira vista, parece muito conveniente.  Mas, de fato, √© mais adequado para experimenta√ß√£o do que para surpresas na produ√ß√£o. </p><br><p>  Portanto, os dados s√£o indexados e esse √© um processo unidirecional.  Uma vez criado, o mapeamento n√£o pode ser alterado dinamicamente como ALTER TABLE no SQL.  Como a tabela SQL armazena o documento original no qual voc√™ pode fixar o √≠ndice de pesquisa.  Mas no ElasticSearch o oposto.  Ele pr√≥prio √© o √≠ndice de pesquisa no qual voc√™ pode fixar o documento original.  √â por isso que o esquema do √≠ndice √© est√°tico.  Teoricamente, pode-se criar um campo no mapeamento ou exclu√≠-lo.  Na pr√°tica, o ElasticSearch permite apenas adicionar campos.  Uma tentativa de excluir um campo n√£o leva a nada. </p><br><h2 id="alias">  Alias </h2><br><p>  Alias ‚Äã‚Äã- este √© um nome adicional para o √≠ndice ElasticSearch.  Pode haver v√°rios aliases para um √≠ndice.  Ou um alias para v√°rios √≠ndices.  Ent√£o os √≠ndices s√£o combinados logicamente como se fossem de fora e pare√ßam um.  O alias √© muito conveniente para servi√ßos que se comunicam com o √≠ndice ao longo de sua vida.  Por exemplo, os produtos alternativos podem ocultar <em>products_v2</em> e <em>products_v25</em> , sem precisar alterar os nomes no servi√ßo.  O alias √© indispens√°vel para a migra√ß√£o de dados, quando eles j√° s√£o transferidos do esquema antigo para o novo, e voc√™ precisa mudar o aplicativo para trabalhar com o novo √≠ndice.  Alternar um alias de √≠ndice para √≠ndice √© uma opera√ß√£o at√¥mica.  Ou seja, √© realizado em uma etapa sem perda. </p><br><h2 id="reindex-api">  Reindexar API </h2><br><p>  O layout dos dados, mapeamento, tende a mudar de tempos em tempos.  Novos campos s√£o adicionados, desnecess√°rios s√£o exclu√≠dos.  Se o ElasticSearch desempenhar o papel de √∫nico reposit√≥rio, voc√™ precisar√° de algum tipo de ferramenta para alterar o mapeamento em tempo real.  Para fazer isso, existe um comando especial para transferir dados de um √≠ndice para outro, a chamada <em>API _reindex</em> .  Ele trabalha com o mapeamento pronto ou vazio do √≠ndice de destinat√°rios, no lado do servidor, indexando rapidamente em lotes de 1000 documentos por vez. </p><br><p>  A reindexa√ß√£o pode fazer uma simples convers√£o de tipo de campo.  Por exemplo, <em>texto</em> <em>longo</em> e retorno <em>longo</em> , ou <em>booleano</em> em <em>texto</em> e retorno <em>booleano</em> .  Mas <em>-9,99</em> em <em>booleano</em> n√£o sabe mais como, <del>  n√£o √© PHP para voc√™ </del>  .  Por outro lado, a convers√£o de tipo n√£o √© segura.  Um servi√ßo escrito em um idioma com digita√ß√£o din√¢mica pode ser perdoado por esse pecado.  Mas se o reindex n√£o puder converter o tipo, o documento simplesmente n√£o ser√° escrito.  Em geral, a migra√ß√£o de dados deve ocorrer em tr√™s etapas: adicione um novo campo, libere um servi√ßo com ele, limpe o antigo. </p><br><p>  Um campo √© adicionado assim.  O esquema do √≠ndice de origem √© adotado, uma nova propriedade √© inserida, um √≠ndice vazio √© criado.  Ent√£o a reindexa√ß√£o come√ßa: </p><br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"dest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test_clone"</span></span> } }</code> </pre> <br><p>  O campo √© exclu√≠do de maneira semelhante.  O esquema do √≠ndice de origem √© utilizado, o campo √© removido, um √≠ndice vazio √© criado.  Em seguida, a reindexa√ß√£o √© iniciada com uma lista dos campos a serem copiados: </p><br><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"source"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"_source"</span></span>: [<span class="hljs-string"><span class="hljs-string">"field1"</span></span>, <span class="hljs-string"><span class="hljs-string">"field3"</span></span>] }, <span class="hljs-attr"><span class="hljs-attr">"dest"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"index"</span></span>: <span class="hljs-string"><span class="hljs-string">"test_clone"</span></span> } }</code> </pre> <br><p>  Por conveni√™ncia, os dois casos s√£o combinados em uma fun√ß√£o de clonagem no Kaizen, um cliente de desktop do ElasticSearch.  A clonagem pode se adaptar ao mapeamento do √≠ndice de destino.  O exemplo abaixo demonstra como fazer um clone parcial de um √≠ndice com tr√™s cole√ß√µes (tipos, em termos de ElasticSearch) <em>agir</em> , <em>linha</em> , <em>cena</em> .  Somente a <em>linha</em> com dois campos permanece nela, o mapeamento est√°tico √© ativado e o campo <em>speech_number</em> do <em>texto</em> se torna <em>longo</em> . </p><br><p><img src="https://habrastorage.org/webt/rt/ju/dq/rtjudqsh1s-tevki7azjyxctsuy.gif"></p><br><h2 id="migraciya">  A migra√ß√£o </h2><br><p>  A API reindex tem um recurso desagrad√°vel - n√£o sabe como monitorar altera√ß√µes no √≠ndice de origem.  Se algo mudar l√° ap√≥s o in√≠cio da reindexa√ß√£o, as altera√ß√µes n√£o ser√£o refletidas no √≠ndice de destinat√°rios.  Para resolver esse problema, o ElasticSearch FollowUp Plugin foi desenvolvido, o que adiciona comandos de log.  O plug-in pode monitorar o √≠ndice, retornando no formato JSON as a√ß√µes executadas nos documentos em ordem cronol√≥gica.  O √≠ndice, tipo, identificador de documento e opera√ß√£o nele - INDEX ou DELETE s√£o lembrados.  O Plug-in do FollowUp √© publicado no GitHub e compilado para quase todas as vers√µes do ElasticSearch. </p><br><p>  Portanto, para a migra√ß√£o sem perda de dados, voc√™ precisar√° do FollowUp instalado no n√≥ em que a reindexa√ß√£o ser√° iniciada.  Sup√µe-se que o √≠ndice j√° tenha um alias e todos os aplicativos funcionem com ele.  Antes de reindexar, o plug-in est√° ativado.  Quando a reindexa√ß√£o √© conclu√≠da, o plug-in √© encerrado e o alias √© invertido para o novo √≠ndice.  Em seguida, as a√ß√µes gravadas s√£o reproduzidas no √≠ndice de destinat√°rios, alcan√ßando seu estado.  Apesar da alta velocidade de reindexa√ß√£o, dois tipos de colis√µes podem ocorrer durante a reprodu√ß√£o: </p><br><ul><li>  n√£o h√° mais um documento com esse <em>_id</em> no novo √≠ndice.  Eles conseguiram excluir o documento depois de mudar o alias para o novo √≠ndice. </li><li>  no novo √≠ndice, existe um documento com esse <em>_id</em> , mas com um n√∫mero de vers√£o maior que o √≠ndice de origem.  Eles conseguiram atualizar o documento depois de mudar o alias para o novo √≠ndice. </li></ul><br><p>  Nesses casos, a a√ß√£o n√£o deve ser reproduzida no √≠ndice de destino.  Outras altera√ß√µes s√£o reproduzidas. </p><br><p>  Feliz codifica√ß√£o! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt416069/">https://habr.com/ru/post/pt416069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt416055/index.html">Atribui√ß√£o e suporte ao FQDN do servidor 3QX</a></li>
<li><a href="../pt416059/index.html">Mobio conversa com Daniil Shuleiko (Yandex.Taxi) sobre fus√£o com Uber, mercado de t√°xi e concorr√™ncia</a></li>
<li><a href="../pt416061/index.html">Ent√£o, eu vejo tudo</a></li>
<li><a href="../pt416063/index.html">As negocia√ß√µes dos russos n√£o t√™m onde registrar</a></li>
<li><a href="../pt416067/index.html">Vis√£o geral da vulnerabilidade do Mikrotik Winbox. Ou um arquivo grande</a></li>
<li><a href="../pt416071/index.html">Redes neurais, princ√≠pios fundamentais de opera√ß√£o, diversidade e topologia</a></li>
<li><a href="../pt416073/index.html">Um bot simples de negocia√ß√£o de criptomoedas</a></li>
<li><a href="../pt416075/index.html">O FSB quer introduzir a responsabilidade pelo uso oculto de gravadores de voz e c√¢meras em smartphones [e n√£o apenas]</a></li>
<li><a href="../pt416077/index.html">PlantUML - Tudo o que os analistas de neg√≥cios precisam para criar gr√°ficos em documenta√ß√£o de software</a></li>
<li><a href="../pt416079/index.html">Corona Native para Android - usando c√≥digo Java personalizado em um jogo escrito em Corona</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>