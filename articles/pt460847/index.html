<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚úèÔ∏è ‚ôüÔ∏è üíç 12,3 milh√µes de WebSockets simult√¢neos üë©üèº‚Äç‚öïÔ∏è üßúüèª üë©üèø‚Äçüåæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma coisa sobre o WebSockets √© que voc√™ precisa de muitos recursos no lado do cliente para gerar carga alta o suficiente para o servidor realmente con...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>12,3 milh√µes de WebSockets simult√¢neos</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460847/"><p>  Uma coisa sobre o WebSockets √© que voc√™ precisa de muitos recursos no lado do cliente para gerar carga alta o suficiente para o servidor realmente consumir todos os recursos da CPU. </p><br><p>  H√° v√°rios desafios que voc√™ precisa superar, porque o protocolo WebSockets exige mais CPU no lado do cliente do que no lado do servidor.  Ao mesmo tempo, voc√™ precisa de muita RAM para armazenar informa√ß√µes sobre conex√µes abertas, se voc√™ tiver milh√µes delas. </p><br><p>  Tive a sorte de obter alguns servidores novos por um per√≠odo limitado de tempo para os testes de "esgotamento" de hardware.  Ent√£o, decidi usar o Lua Application Server - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LAppS</a> para realizar as duas tarefas: testar o hardware e realizar os testes de alta carga do LAppS. </p><br><p><a name="habracut"></a>  Vamos ver os detalhes </p><br><h1 id="challenges">  Desafios </h1><br><p>  Antes de tudo, os WebSockets do lado do cliente exigem um RNG bastante r√°pido para mascarar o tr√°fego, a menos que voc√™ queira fingir.  Queria que os testes fossem realistas, ent√£o descartei a id√©ia de falsificar o RNG, substituindo-o por uma constante.  Isso deixa a √∫nica op√ß√£o - muita energia da CPU.  Como eu disse, tenho dois servidores: um com dois processadores Intel Gold 6148 (40 n√∫cleos no total) 256 GB de RAM (DDR4-2666) e outro com quatro processadores Intel Platinum 8180 (112 n√∫cleos no total) 384 GB de RAM (DDR4-2666) .  Vou me referir a eles como Servidor A e Servidor B a seguir. </p><br><p>  O segundo desafio - n√£o h√° bibliotecas ou conjuntos de testes para WebSockets que sejam r√°pidos o suficiente.  Por isso, fui for√ßado a desenvolver um m√≥dulo cliente WebSockets para LAppS ( <strong>cws</strong> ). </p><br><h1 id="the-tests-setup">  A configura√ß√£o dos testes </h1><br><p>  Ambos os servidores possuem placas de 10GbE de porta dupla.  A porta 1 de cada placa √© agregada a uma interface de liga√ß√£o e essas portas nas duas placas s√£o conectadas uma √† outra no modo RR.  A porta 2 de cada placa √© agregada a uma interface de liga√ß√£o no modo de backup ativo, conectado por um comutador Ethernet.  Cada servidor de hardware estava executando o RHEL 7.6.  Eu tive que instalar o gcc-8.3 a partir das fontes para ter um compilador moderno em vez do padr√£o gcc-4.8.5.  N√£o √© a melhor configura√ß√£o para os testes de desempenho, mas os mendigos n√£o podem escolher. </p><br><p>  As CPUs no servidor A (2xGold 6148) t√™m maior frequ√™ncia do que no servidor B (4xPlatinum 8180).  Ao mesmo tempo, o servidor B tem mais n√∫cleos, por isso decidi executar um servidor de eco no servidor A e os clientes de eco no servidor B. </p><br><p>  Eu queria ver como o LAppS se comporta sob alta carga com milh√µes de conex√µes e qual a quantidade m√°xima de solicita√ß√µes de eco por segundo que ele pode atender.  Na verdade, s√£o dois conjuntos diferentes de testes porque, com o crescimento das conex√µes, o servidor e os clientes est√£o realizando um trabalho cada vez mais complexo. </p><br><p>  Antes disso, fiz todos os testes no meu PC dom√©stico que utilizo para o desenvolvimento.  Os resultados desses testes ser√£o usados ‚Äã‚Äãpara compara√ß√£o.  Meu PC dom√©stico possui uma CPU Intel Core i7-7700 de 3,6 GHz (4,0 GHz Turbo) com 4 n√∫cleos e 32 GB de RAM DDR4-2400.  Este PC roda o Gentoo com o kernel 4.14.72. </p><br><div class="spoiler">  <b class="spoiler_title">N√≠veis de patch Spectre e Meltdown</b> <div class="spoiler_text"><ul><li>  Pc em casa <br><pre><code class="plaintext hljs">/sys/devices/system/cpu/vulnerabilities/l1tf:Mitigation: PTE Inversion; VMX: conditional cache flushes, SMT vulnerable /sys/devices/system/cpu/vulnerabilities/meltdown:Mitigation: PTI /sys/devices/system/cpu/vulnerabilities/spec_store_bypass:Mitigation: Speculative Store Bypass disabled via prctl and seccomp /sys/devices/system/cpu/vulnerabilities/spectre_v1:Mitigation: __user pointer sanitization /sys/devices/system/cpu/vulnerabilities/spectre_v2:Vulnerable: Minimal generic ASM retpoline, IBPB, IBRS_FW</code> </pre> </li><li>  Servidores A e B <br><pre> <code class="plaintext hljs">/sys/kernel/debug/x86/ibpb_enabled : 1 /sys/kernel/debug/x86/pti_enabled : 1 /sys/kernel/debug/x86/ssbd_enabled : 1 /sys/kernel/debug/x86/ibrs_enabled : 1 /sys/kernel/debug/x86/retp_enabled : 3</code> </pre> </li></ul><br><p>  Farei uma anota√ß√£o extra com os resultados dos testes dos Servidores A e B, independentemente de esses patches estarem ativados ou n√£o. </p><br><p>  No meu PC em casa, o n√≠vel do patch nunca √© alterado. </p></div></div><br><h2 id="installing-lapps-081">  Instalando o LAppS 0.8.1 </h2><br><div class="spoiler">  <b class="spoiler_title">Instalando pr√©-requisitos e o LAppS</b> <div class="spoiler_text"><p>  O LAppS depende das bibliotecas luajit-2.0.5 ou superior, libcrypto ++ 8.2 e wolfSSL-3.15.7 e elas devem ser instaladas a partir de fontes no RHEL 7.6 e provavelmente em qualquer outra distribui√ß√£o linux. </p><br><p>  O prefixo para instala√ß√£o √© / usr / local.  Aqui est√° a parte do Dockerfile praticamente auto-explicativa para a instala√ß√£o do wolfSSL </p><br><pre> <code class="plaintext hljs">ADD https://github.com/wolfSSL/wolfssl/archive/v3.15.7-stable.tar.gz ${WORKSPACE} RUN tar xzvf v3.15.7-stable.tar.gz WORKDIR ${WORKSPACE}/wolfssl-3.15.7-stable RUN ./autogen.sh RUN ./configure CFLAGS="-pipe -O2 -march=native -mtune=native -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -DTFM_TIMING_RESISTANT -DECC_TIMING_RESISTANT -DWC_RSA_BLINDING" --prefix=/usr/local --enable-tls13 --enable-openssh --enable-aesni --enable-intelasm --enable-keygen --enable-certgen --enable-certreq --enable-curve25519 --enable-ed25519 --enable-intelasm --enable-harden RUN make -j40 all RUN make install</code> </pre><br><p>  E aqui est√° a parte para a instala√ß√£o da libcrypto ++ </p><br><pre> <code class="plaintext hljs">ADD https://github.com/weidai11/cryptopp/archive/CRYPTOPP_8_2_0.tar.gz ${WORKSPACE} RUN rm -rf ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN tar xzvf ${WORKSPACE}/CRYPTOPP_8_2_0.tar.gz WORKDIR ${WORKSPACE}/cryptopp-CRYPTOPP_8_2_0 RUN make CFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" CXXFLAGS="-pipe -O2 -march=native -mtune=native -fPIC -fomit-frame-pointer -fstack-check -fstack-protector-strong -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops" -j40 libcryptopp.a libcryptopp.so RUN make install</code> </pre><br><p>  E o luajit </p><br><pre> <code class="plaintext hljs">ADD http://luajit.org/download/LuaJIT-2.0.5.tar.gz ${WORKSPACE} WORKDIR ${WORKSPACE} RUN tar xzvf LuaJIT-2.0.5.tar.gz WORKDIR ${WORKSPACE}/LuaJIT-2.0.5 RUN env CFLAGS="-pipe -Wall -pthread -O2 -fPIC -march=native -mtune=native -mfpmath=sse -msse2avx -mavx2 -ftree-vectorize -funroll-loops -fstack-check -fstack-protector-strong -fno-omit-frame-pointer" make -j40 all RUN make install</code> </pre> <br><p>  Uma depend√™ncia opcional do LAppS, que pode ser ignorada, √© a nova biblioteca do Microsoft <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">mimalloc</a> .  Essa biblioteca melhora significativamente o desempenho (cerca de 1%), mas requer o cmake-3.4 ou superior.  Dada a quantidade limitada de tempo para os testes, decidi sacrificar a melhoria de desempenho mencionada. </p><br><p>  No meu PC dom√©stico, n√£o desabilitarei o <em>mimalloc</em> durante os testes. </p><br><p>  Permite fazer checkout do LAppS no reposit√≥rio: </p><br><pre> <code class="plaintext hljs">WORKDIR ${WORKSPACE} RUN rm -rf ITCLib ITCFramework lar utils LAppS RUN git clone https://github.com/ITpC/ITCLib.git RUN git clone https://github.com/ITpC/utils.git RUN git clone https://github.com/ITpC/ITCFramework.git RUN git clone https://github.com/ITpC/LAppS.git RUN git clone https://github.com/ITpC/lar.git WORKDIR ${WORKSPACE}/LAppS</code> </pre> <br><p>  Agora precisamos remover "-lmimalloc" de todos os Makefiles no subdiret√≥rio <strong>nbproject</strong> , para que possamos construir o LAppS (assumindo que o diret√≥rio atual seja $ {WORKSPACE} / LAppS) </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># find ./nbproject -type f -name "*.mk" -exec sed -i.bak -e 's/-lmimalloc//g' {} \; # find ./nbproject -type f -name "*.bak" -exec rm {} \;</span></span></code> </pre> <br><p>  E agora podemos construir o LAppS.  O LAppS fornece v√°rias configura√ß√µes de compila√ß√£o, que podem ou n√£o excluir alguns recursos no lado do servidor: </p><br><ul><li>  com suporte SSL e com suporte a coleta de estat√≠sticas </li><li>  com SSL e sem coleta de estat√≠sticas (embora a coleta m√≠nima de estat√≠sticas continue enquanto √© usada para o ajuste din√¢mico do LAppS em tempo de execu√ß√£o) </li><li>  sem SSL e sem coleta de estat√≠sticas. </li></ul><br><p>  Antes da pr√≥xima etapa, verifique se voc√™ √© o propriet√°rio do diret√≥rio / opt / lapps (ou execute make installs com sudo) </p><br><p>  Vamos fazer dois tipos de bin√°rios com suporte a SSL e coleta de estat√≠sticas e sem (supondo que estejamos dentro do diret√≥rio $ {WORKSPACE} / LAppS): </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># make clean # make CONF=Release.AVX2 install # make CONF=Release.AVX2.NO_STATS.NO_TLS install</span></span></code> </pre> <br><p>  Os bin√°rios resultantes s√£o: </p><br><ul><li>  dist / Release.AVX2 / GNU-Linux / lapps.avx2 </li><li>  dist / Release.AVX2.NO_STATS.NO_TLS / GNU-Linux / lapps.avx2.nostats.notls </li></ul><br><p>  Eles ser√£o instalados em / opt / lapps / bin. </p><br><p>  Observe que o m√≥dulo do cliente WebSockets para Lua √© sempre constru√≠do com suporte a SSL.  Se est√° habilitado ou n√£o, depende do URI que voc√™ est√° usando para conex√£o (ws: // ou wss: //) em tempo de execu√ß√£o. </p></div></div><br><h2 id="test-1-top-performance-on-home-pc-configuration-for-baseline">  Teste 1. Desempenho superior no PC dom√©stico.  Configura√ß√£o para linha de base. </h2><br><p>  J√° estabeleci que obtenho o melhor desempenho ao configurar quatro inst√¢ncias de servi√ßo de benchmark com 100 conex√µes cada.  Ao mesmo tempo, preciso de apenas tr√™s IOWorkers e quatro inst√¢ncias de servi√ßo de eco para obter o melhor desempenho.  Lembra?  Eu tenho apenas 4 n√∫cleos aqui. </p><br><p>  O objetivo deste teste √© apenas estabelecer uma linha de base para compara√ß√£o adicional.  Nada emocionante aqui realmente. </p><br><p>  Abaixo est√£o as etapas necess√°rias para configurar o LAppS para os testes. </p><br><h3 id="self-signed-certificates">  Certificados autoassinados </h3><br><div class="spoiler">  <b class="spoiler_title">script certgen.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash openssl genrsa -out example.org.key 2048 openssl req -new -key example.org.key -out example.org.csr openssl genrsa -out ca.key 2048 openssl req -new -x509 -key ca.key -out ca.crt openssl x509 -req -in example.org.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out example.org.crt cat example.org.crt ca.crt &gt; example.org.bundle.crt</span></span></code> </pre> </div></div><br><p>  A execu√ß√£o desse script no diret√≥rio / opt / lapps / conf / ssl criar√° todos os arquivos necess√°rios.  Aqui est√° a sa√≠da do script e o que eu digitei: </p><br><div class="spoiler">  <b class="spoiler_title">sa√≠da certgen.sh</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># certgen.sh Generating RSA private key, 2048 bit long modulus .................................................................................................................................................................+++++ .....................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []: Email Address []: Please enter the following 'extra' attributes to be sent with your certificate request A challenge password []: An optional company name []: Generating RSA private key, 2048 bit long modulus ...+++++ ............................................................................+++++ e is 65537 (0x010001) You are about to be asked to enter information that will be incorporated into your certificate request. What you are about to enter is what is called a Distinguished Name or a DN. There are quite a few fields but you can leave some blank For some fields there will be a default value, If you enter '.', the field will be left blank. ----- Country Name (2 letter code) [AU]:KZ State or Province Name (full name) [Some-State]:none Locality Name (eg, city) []:Almaty Organization Name (eg, company) [Internet Widgits Pty Ltd]:none Organizational Unit Name (eg, section) []: Common Name (eg server FQDN or YOUR name) []:*.example.org Email Address []: Signature ok subject=C = KZ, ST = none, L = Almaty, O = NOORG.DO.NOT.FORGET.TO.REMOVE.FROM.BROWSER Getting CA Private Key</code> </pre> </div></div><br><h3 id="lapps-configuration">  Configura√ß√£o LAppS </h3><br><p>  Aqui est√° o arquivo de configura√ß√£o do WebSockets definido para o TLS 1.3, inclui os certificados gerados acima e configurado com 3 IOWorkers (consulte a descri√ß√£o detalhada das vari√°veis ‚Äã‚Äãno wiki do LAppS). </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">40000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  Configurando servi√ßos: o servidor de eco e o cliente de eco (benchmark), cada um com quatro inst√¢ncias. </p><br><div class="spoiler">  <b class="spoiler_title">/opt/lapps/etc/conf/lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } }, <span class="hljs-attr"><span class="hljs-attr">"benchmark"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">"depends"</span></span> : [ <span class="hljs-string"><span class="hljs-string">"echo"</span></span> ] } } }</code> </pre> </div></div><br><p>  O servi√ßo de eco √© bastante trivial: </p><br><div class="spoiler">  <b class="spoiler_title">c√≥digo fonte do servi√ßo de eco</b> <div class="spoiler_text"><pre> <code class="lua hljs">echo = {} echo.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span> = echo; echo.onStart=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onStart"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onDisconnect=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onShutdown=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::onShutdown()"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> echo.onMessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,opcode, message)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errmsg=ws:send(handler,opcode,message); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"echo::OnMessage(): "</span></span>..errmsg); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> echo</code> </pre> </div></div><br><p>  O servi√ßo de benchmark cria at√© <strong>benchmark.max_connections</strong> em <strong>benchmark.target</strong> e depois √© executado at√© voc√™ parar o LAppS.  N√£o h√° pausa no estabelecimento das conex√µes ou solicita√ß√µes de eco de bombardeio.  A API do m√≥dulo <strong>cws se</strong> assemelha √† API da Web para WebSockets.  Depois que todas as <strong>benchmark.max_connections</strong> forem estabelecidas, a benchmark imprime a quantidade de soquetes conectados.  Depois que a conex√£o √© estabelecida, o benchmark envia um <strong>benchmark.message</strong> ao servidor.  Ap√≥s o servidor responder, o m√©todo <strong>onmessage</strong> an√¥nimo do objeto <strong>cws</strong> √© chamado, o que apenas envia a mesma mensagem de volta ao servidor. </p><br><div class="spoiler">  <b class="spoiler_title">c√≥digo fonte do servi√ßo de refer√™ncia</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">100</span></span>; benchmark.target=<span class="hljs-string"><span class="hljs-string">"wss://127.0.0.1:5083/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-comment"><span class="hljs-comment">-- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><h3 id="services-installation">  Instala√ß√£o de servi√ßos </h3><br><p>  Agora precisamos colocar os scripts de servi√ßo em /opt/lapps/apps//.lua: <br></p><ul><li>  /opt/lapps/apps/benchmark/benchmark.lua </li><li>  /opt/lapps/apps/echo/echo.lua </li></ul><br><p>  Estamos prontos para executar nossa refer√™ncia agora.  Basta executar: <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2 &gt; log</code> no diret√≥rio LAppS, aguarde 5 minutos e pressione Ctrl-C uma vez para interromper o LAppS (ele n√£o para imediatamente, interrompe as conex√µes primeiro) ou duas vezes (isso interromper√° a sequ√™ncia de desligamento). </p><br><p>  Ok, temos um arquivo de texto com algo assim dentro: </p><br><div class="spoiler">  <b class="spoiler_title">sa√≠da de refer√™ncia</b> <div class="spoiler_text"><p>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  echo :: onStart <br>  correndo <br>  1 mensagens recebidas por 3196ms <br>  1 mensagens recebidas por 3299ms <br>  1 mensagens recebidas por 3299ms <br>  1 mensagens recebidas por 3305ms <br>  Soquetes conectados: 100 <br>  Soquetes conectados: 100 <br>  Soquetes conectados: 100 <br>  Soquetes conectados: 100 <br>  134597 mensagens recebidas por 1000ms <br>  139774 mensagens recebidas por 1000 ms <br>  138521 mensagens recebidas por 1000 ms <br>  139404 mensagens recebidas por 1000ms <br>  140162 mensagens recebidas por 1000ms <br>  139337 mensagens recebidas por 1000 ms <br>  140088 mensagens recebidas por 1000ms <br>  139946 mensagens recebidas por 1000ms <br>  141204 mensagens recebidas por 1000ms <br>  137988 mensagens recebidas por 1000ms <br>  141805 mensagens recebidas por 1000ms <br>  134733 mensagens recebidas por 1000ms <br>  ... </p></div></div><br><p>  Vamos limpar esse arquivo de log assim: </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G4/Sockets\n4\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span></code> </pre> <br><p>  '^ V ^ M' √© uma representa√ß√£o vis√≠vel das seguintes ocorr√™ncias de teclas: Ctrl-V Ctrl-V Ctrl-V Ctrl-M, portanto, ser√° bastante in√∫til copiar e colar esta linha do bash.  Breve explica√ß√£o: </p><br><ul><li>  temos que substituir os s√≠mbolos 'ms' pelo final da linha, porque n√£o precisamos deles, eles ir√£o atrapalhar os c√°lculos mais tarde e 4 benchmarks trabalhando em paralelo podem imprimir seus resultados em uma linha. </li><li>  precisamos remover todas as linhas vazias depois </li><li>  removemos a √∫ltima linha tamb√©m, porque paramos o servidor </li><li>  no arquivo de <strong>log</strong> , haver√° apenas linhas anteriores que consistem em <em>soquetes conectados: 100</em> (√© porque executamos apenas quatro servi√ßos de benchmark).  Ent√£o, pulamos 4 linhas al√©m da √∫ltima delas e depois removemos tudo para a parte superior do arquivo. </li><li>  salvando o arquivo. </li></ul><br><p>  O arquivo √© salvo e voc√™ est√° de volta ao shell agora, e o arquivo de log est√° pronto para a pr√≥xima etapa: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># awk -v avg=0 '{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*4}' log</span></span></code> </pre> <br><p>  Esse liner √∫nico do awk calcula a quantidade de respostas de eco por ms e acumula o resultado na vari√°vel <em>avg</em> .  Depois que todas as linhas do arquivo de log s√£o processadas, multiplica-se a <em>m√©dia</em> de 1000 para obter a quantidade total de respostas de eco por segundo, dividindo-se pelo n√∫mero de linhas e multiplicando-a pela quantidade de servi√ßos de refer√™ncia.  Isso nos d√° o n√∫mero m√©dio de respostas de eco por segundo para esta execu√ß√£o de teste. </p><br><p>  No meu PC, esse n√∫mero (ERps) √©: <strong>563854</strong> </p><br><p>  Vamos fazer o mesmo sem suporte a SSL e ver a diferen√ßa: </p><br><ul><li>  altere o valor da vari√°vel <strong>tls</strong> em ws.json para false </li><li>  altere <strong>benchmark.target</strong> em benchmark.lua de wss: // para ws: // </li><li>  execute <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code>  <code>rm -f lapps.log; /opt/lapps/bin/lapps.avx2.nostats.notls &gt; log</code> no diret√≥rio LAppS e repita as etapas acima. </li></ul><br><p>  Eu tenho: <strong>721236</strong> respostas por segundo </p><br><p>  A diferen√ßa de desempenho com SSL e sem SSL √© de cerca de 22%.  Vamos manter esses n√∫meros em mente para refer√™ncia futura. </p><br><p>  Com a mesma configura√ß√£o no servidor A, tenho: <strong>421905</strong> ERpS com SSL e <strong>443145</strong> ERpS sem SSL.  Os patches para Spectre e Meltdown foram desativados. <br>  No servidor B, tenho <strong>270996</strong> ERpS com SSL e <strong>318522</strong> ERpS sem SSL com os patches ativados.  <strong>385726</strong> e <strong>372126</strong> sem e com SSL.  Os patches para Spectre e Meltdown tamb√©m foram desativados. </p><br><p>  Os resultados s√£o piores com a mesma configura√ß√£o, porque as CPUs nesses servidores t√™m menor frequ√™ncia. </p><br><p>  Por favor, tenha cuidado que os clientes s√£o muito dependentes da disponibilidade de dados em / dev / urandom.  Pode demorar um pouco at√© os clientes come√ßarem a executar, se voc√™ j√° o executou uma vez.  Ent√£o, basta esperar que eles comecem a trabalhar, para que sejam bem r√°pidos no que fazem.  Apenas monitore com o <em>topo</em> se as inst√¢ncias do LAppS realmente est√£o fazendo algum trabalho.  Se / dev / urandom estiver esgotado, o LAppS n√£o consumir√° suas CPUs at√© que haja alguns dados dispon√≠veis. </p><br><h1 id="preparing-for-big-tests">  Preparando-se para grandes testes </h1><br><p>  Antes de tudo, precisamos fazer algumas altera√ß√µes nos par√¢metros do kernel e n√£o esquecer o ulimit para o n√∫mero de arquivos abertos.  Eu usei quase a mesma configura√ß√£o, como neste <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">artigo</a> . </p><br><p>  Crie um arquivo com o seguinte conte√∫do </p><br><pre> <code class="bash hljs">: sysctl -w fs.file-max=14000000 sysctl -w fs.nr_open=14000000 <span class="hljs-built_in"><span class="hljs-built_in">ulimit</span></span> -n 14000000 sysctl -w net.ipv4.tcp_mem=<span class="hljs-string"><span class="hljs-string">"100000000 100000000 100000000"</span></span> sysctl -w net.core.somaxconn=20000 sysctl -w net.ipv4.tcp_max_syn_backlog=20000 sysctl -w net.ipv4.ip_local_port_range=<span class="hljs-string"><span class="hljs-string">"1025 65535"</span></span></code> </pre> <br><p>  Em seguida, use <em>source ./filename</em> nos dois servidores para alterar os par√¢metros do kernel e o ulimit. </p><br><p>  Desta vez, meu objetivo √© criar v√°rios milh√µes de clientes em um servidor e conect√°-los ao segundo. </p><br><p>  O servidor A servir√° como o lado do servidor do servi√ßo de eco WebSockets. <br>  O servidor B servir√° como o lado do cliente do servi√ßo de eco WebSockets. </p><br><p>  H√° uma limita√ß√£o no LAppS imposta pelo LuaJIT.  Voc√™ pode usar apenas 2 GB de RAM por VM LuaJIT.  Esse √© o limite de RAM que voc√™ pode usar em uma √∫nica inst√¢ncia do LAppS para todos os servi√ßos, pois os servi√ßos s√£o os encadeamentos vinculados a uma inst√¢ncia do libluajit.  Se algum de seus servi√ßos que estiver executando sob a inst√¢ncia √∫nica do LAppS exceder esse limite, todos os servi√ßos ficar√£o sem mem√≥ria. </p><br><p>  Descobri que, por uma √∫nica inst√¢ncia do LAppS, n√£o √© poss√≠vel estabelecer mais de 2 464 000 WebSockets clientes com o tamanho da mensagem de 64 bytes.  O tamanho da mensagem pode alterar levemente esse limite, porque o LAppS passa a mensagem para o servi√ßo <em>cws</em> , alocando o espa√ßo para essa mensagem no LuaJIT. </p><br><p>  Isso implica que eu tenho que iniciar v√°rias inst√¢ncias do LAppS com a mesma configura√ß√£o no servidor B para estabelecer mais de 2,4 milh√µes de WebSockets.  O servidor A (servidor de eco) n√£o usa tanta mem√≥ria no lado LuaJIT; portanto, uma inst√¢ncia do LAppS cuidar√° de 12,3 milh√µes de WebSockets sem nenhum problema. </p><br><p>  Vamos preparar duas configura√ß√µes diferentes para os servidores A e B. </p><br><div class="spoiler">  <b class="spoiler_title">Servidor A ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">224</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5084</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">2000000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">256</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Servidor A lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"echo"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span>: <span class="hljs-number"><span class="hljs-number">40</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbound_message_size"</span></span>: <span class="hljs-number"><span class="hljs-number">16777216</span></span>, <span class="hljs-attr"><span class="hljs-attr">"protocol"</span></span>: <span class="hljs-string"><span class="hljs-string">"raw"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"request_target"</span></span>: <span class="hljs-string"><span class="hljs-string">"/echo"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"allow"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] } } } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Servidor B ws.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"listeners"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"connection_weight"</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"ip"</span></span> : <span class="hljs-string"><span class="hljs-string">"0.0.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">5083</span></span>, <span class="hljs-attr"><span class="hljs-attr">"lapps_config_auto_save"</span></span> : <span class="hljs-literal"><span class="hljs-literal">true</span></span> , <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"workers"</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_connections"</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">"auto_fragment"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_events"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_poll_wait_ms"</span></span> : <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-attr"><span class="hljs-attr">"max_inbounds_skip"</span></span> : <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-attr"><span class="hljs-attr">"input_buffer_size"</span></span> : <span class="hljs-number"><span class="hljs-number">2048</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"acl"</span></span> : { <span class="hljs-attr"><span class="hljs-attr">"policy"</span></span> : <span class="hljs-string"><span class="hljs-string">"deny"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"exclude"</span></span> : [] }, <span class="hljs-attr"><span class="hljs-attr">"tls"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_server_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_client_version"</span></span> : <span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tls_certificates"</span></span>:{ <span class="hljs-attr"><span class="hljs-attr">"ca"</span></span>:<span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/ca.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"cert"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.bundle.crt"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"key"</span></span>: <span class="hljs-string"><span class="hljs-string">"/opt/lapps/conf/ssl/example.org.key"</span></span> } }</code> </pre> </div></div><br><p>  O servidor A possui duas interfaces: </p><br><ul><li>  bond0 - xx203.37 </li><li>  bond1 - xx23.10 </li></ul><br><p>  Um √© mais r√°pido, o outro √© mais lento, mas isso realmente n√£o importa.  O servidor estar√° sob carga pesada de qualquer maneira. </p><br><p>  Vamos preparar um modelo em nosso /opt/lapps/benchmark/benchmark.lua </p><br><div class="spoiler">  <b class="spoiler_title">benchmark.lua</b> <div class="spoiler_text"><pre> <code class="lua hljs">benchmark={} benchmark.<span class="hljs-built_in"><span class="hljs-built_in">__index</span></span>=benchmark benchmark.init=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); benchmark.max_connections=<span class="hljs-number"><span class="hljs-number">10000</span></span>; benchmark.target_port=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.target_prefix=<span class="hljs-string"><span class="hljs-string">"wss://IPADDR:"</span></span>; benchmark.target_postfix=<span class="hljs-string"><span class="hljs-string">"/echo"</span></span>; benchmark.message=<span class="hljs-string"><span class="hljs-string">"XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"</span></span>; benchmark.meter=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> benchmark.messages_counter=benchmark.messages_counter+<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> slice=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now() - benchmark.start_time; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( slice &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(benchmark.messages_counter..<span class="hljs-string"><span class="hljs-string">" messages received per "</span></span>..slice..<span class="hljs-string"><span class="hljs-string">"ms"</span></span>) benchmark.messages_counter=<span class="hljs-number"><span class="hljs-number">0</span></span>; benchmark.start_time=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> benchmark.run=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n=nap:new(); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> counter=<span class="hljs-number"><span class="hljs-number">1</span></span>; n:sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> array={}; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> start=<span class="hljs-built_in"><span class="hljs-built_in">time</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(#array &lt; benchmark.max_connections) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> must_stop()) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> benchmark.target_port=<span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">random</span></span>(<span class="hljs-number"><span class="hljs-number">5084</span></span>,<span class="hljs-number"><span class="hljs-number">5307</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> sock, err_msg=cws:new(benchmark.target_prefix..benchmark.target_port..benchmark.target_postfix, { onopen=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> result, errstr=cws:send(handler,benchmark.message,<span class="hljs-number"><span class="hljs-number">2</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">not</span></span> result) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Error on websocket send at handler "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">": "</span></span>..errstr); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onmessage=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler,message,opcode)</span></span></span></span> benchmark.meter(); cws:send(handler,message,opcode); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onerror=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler, message)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Client WebSocket connection is failed for socketfd "</span></span>..handler..<span class="hljs-string"><span class="hljs-string">". Error: "</span></span>..message); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, onclose=<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(handler)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Connection is closed for socketfd "</span></span>..handler); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sock ~= <span class="hljs-literal"><span class="hljs-literal">nil</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-built_in"><span class="hljs-built_in">table</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">insert</span></span>(array,sock); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(err_msg); err_msg=<span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">collectgarbage</span></span>(<span class="hljs-string"><span class="hljs-string">"collect"</span></span>); <span class="hljs-comment"><span class="hljs-comment">-- force garbage collection on connection failure. end -- poll events once per 10 outgoing connections -- this will improve the connection establishment speed if counter == 10 then cws:eventLoop(); counter=1 else counter = counter + 1; end end print("Sockets connected: "..#array); benchmark.start_time=time.now(); while not must_stop() do cws:eventLoop(); end for i=1,#array do array[i]:close(); cws:eventLoop(); end end return benchmark;</span></span></code> </pre> </div></div><br><p>  Vamos armazenar os endere√ßos IP do servidor A nos arquivos IP1 e IP2, respectivamente, e depois: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 1 2 <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> mkdir -p /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span> sed -e <span class="hljs-string"><span class="hljs-string">"s/IPADDR/</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$(cat IP1)</span></span></span><span class="hljs-string">/g"</span></span> /opt/lapps/apps/benchmark/benchmark.lua &gt; /opt/lapps/apps/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>/benchmark<span class="hljs-variable"><span class="hljs-variable">${i}</span></span>.lua <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Agora modificamos o /opt/lapps/etc/conf/lapps.json no servidor B para usar estes dois servi√ßos de benchmark: </p><br><div class="spoiler">  <b class="spoiler_title">Servidor B lapps.json</b> <div class="spoiler_text"><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"app_conf_dir"</span></span>: <span class="hljs-string"><span class="hljs-string">"etc"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"applications"</span></span>: <span class="hljs-string"><span class="hljs-string">"apps"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"deploy"</span></span>: <span class="hljs-string"><span class="hljs-string">"deploy"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"tmp"</span></span>: <span class="hljs-string"><span class="hljs-string">"tmp"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"workdir"</span></span>: <span class="hljs-string"><span class="hljs-string">"workdir"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"services"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"benchmark1"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] }, <span class="hljs-attr"><span class="hljs-attr">"benchmark2"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"auto_start"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"instances"</span></span> : <span class="hljs-number"><span class="hljs-number">112</span></span>, <span class="hljs-attr"><span class="hljs-attr">"internal"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">"preload"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"nap"</span></span>, <span class="hljs-string"><span class="hljs-string">"cws"</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span> ] } } }</code> </pre> </div></div><br><p>  Estamos prontos?  N√£o, n√£o somos.  Como pretendemos gerar 2 240 000 soquetes de sa√≠da em apenas dois endere√ßos e precisamos de mais portas no lado do servidor.  √â imposs√≠vel criar mais de 64k conex√µes com o mesmo par ip: port (na verdade, um pouco menos que 64k). </p><br><p>  No servidor A, no arquivo LAppS / include / wsServer.h, existe uma fun√ß√£o void startListeners ().  Nesta fun√ß√£o, substituiremos a linha 126 </p><br><pre> <code class="plaintext hljs">LAppSConfig::getInstance()-&gt;getWSConfig()["port"],</code> </pre> <br><p>  com isso: </p><br><pre> <code class="plaintext hljs">static_cast&lt;int&gt;(LAppSConfig::getInstance()-&gt;getWSConfig()["port"])+i,</code> </pre> <br><p>  Reconstruir LAppS: </p><br><pre> <code class="bash hljs">make CONF=Release.AVX2 install</code> </pre> <br><h1 id="running-the-tests-for-2-240-000-client-websockets">  Executando os testes para 2 240 000 WebSockets do cliente. </h1><br><p>  Inicie o LAppS no servidor B, inicie o LAppS no servidor B e redirecione a sa√≠da para um arquivo como este: </p><br><pre> <code class="bash hljs">/opt/lapps/bin/lapps.avx2 &gt; <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  Editar, NB: </p><br><pre> <code class="plaintext hljs">if you want to run several LAppS instances, then create separate directory for each instnace (like run1,run2, etc) and run each instance from within these directories. This is required for lapps.log file and of course for resulting standard output, for not to be overlapped/overwritten by concurrent LAppS instances.</code> </pre> <br><p>  Isso pode demorar um pouco at√© que todas as conex√µes sejam estabelecidas.  Vamos monitorar o progresso. </p><br><p>  N√£o use o netstat para assistir a conex√µes estabelecidas; √© in√∫til enquanto √© executado indefinidamente ap√≥s conex√µes de 150k, que s√£o estabelecidas em alguns segundos.  Veja o lapps.log no servidor A, no diret√≥rio em que voc√™ estava quando iniciou o LAppS.  Voc√™ pode usar a seguinte linha √∫nica para ver como as conex√µes s√£o estabelecidas e como elas s√£o distribu√≠das entre os IOWorkers: </p><br><pre> <code class="bash hljs">date;awk <span class="hljs-string"><span class="hljs-string">'/ will be added to connection pool of worker/{a[$22]++}END{for(i in a){ print i, a[i]; sum+=a[i]} print sum}'</span></span> lapps.log | sort -n;date</code> </pre> <br><p>  Aqui est√° uma id√©ia sobre a rapidez com que essas conex√µes s√£o estabelecidas: </p><br><pre> <code class="plaintext hljs">375874 Sun Jul 21 20:33:07 +06 2019 650874 Sun Jul 21 20:34:42 +06 2019 2894 connections per second 1001874 Sun Jul 21 20:36:45 +06 2019 2974 connections per second 1182874 Sun Jul 21 20:37:50 +06 2019 2784 connections per second 1843874 Sun Jul 21 20:41:44 +06 2019 2824 connections per second 2207874 Sun Jul 21 20:45:43 +06 2019 3058 connections per second</code> </pre><br><p>  No servidor B, podemos verificar a quantidade de benchmarks conclu√≠dos, estabelecendo suas conex√µes: </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># grep Sockets log | wc -l 224</span></span></code> </pre> <br><p>  Depois de ver que o n√∫mero √© 224, deixe os servidores trabalharem por um tempo, monitore o uso da CPU e da mem√≥ria com o m√°ximo.  Voc√™ pode ver algo assim (Servidor B √† esquerda e Servidor A √† direita): </p><br><p><img src="https://habrastorage.org/webt/e0/vy/sv/e0vysvislttrfhwpn_vexnwseli.png" alt="imagem"></p><br><p>  Ou assim (Servidor B √† esquerda e Servidor A √† direita): </p><br><p><img src="https://habrastorage.org/webt/p1/cj/qk/p1cjqk6fxmthbnnexc2ikco9d6a.png"></p><br><p>  √â claramente o servidor B, onde os servi√ßos do cliente de refer√™ncia est√£o em execu√ß√£o, est√° sob carga pesada.  O servidor A tamb√©m est√° sob carga pesada, mas nem sempre.  Algumas vezes, esfria enquanto o servidor B luta com a quantidade de tarefas para trabalhar.  A codifica√ß√£o de tr√°fego no TLS consome muita CPU. </p><br><p>  Vamos parar os servidores (pressione Ctrl-C v√°rias vezes) e modifique o log como antes, mas com rela√ß√£o √† quantidade alterada de servi√ßos de benchmark (224): </p><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> -e <span class="hljs-string"><span class="hljs-string">':%s/ms/^V^M/g\n:%g/^$/d\nGdd1G224/Sockets\n224\ndggZZ'</span></span> | vi <span class="hljs-variable"><span class="hljs-variable">$i</span></span> awk -v avg=0 <span class="hljs-string"><span class="hljs-string">'{rps=($1/$5);avg+=rps;}END{print ((avg*1000)/NR)*224}'</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span></code> </pre> <br><p>  Voc√™ tamb√©m pode excluir v√°rias √∫ltimas linhas, para dar conta das impress√µes de interromper os servi√ßos de benchmark.  Voc√™ j√° tem uma id√©ia de como fazer isso.  Ent√£o, publicarei os resultados para diferentes cen√°rios de teste e continuarei com os problemas que enfrentei. </p><br><h1 id="results-for-all-the-other-tests-49-million-and-beyond">  Resultados para todos os outros testes (4,9 milh√µes e al√©m) </h1><br><p><img src="https://habrastorage.org/webt/az/4a/at/az4aatexickfttbrom2gg3yrymu.png"></p><br><div class="spoiler">  <b class="spoiler_title">carga de teste # 4</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ra/ka/_f/raka_fia7i2vnqhwh2p-5lnulc8.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">carga de teste # 5</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ln/z5/ml/lnz5mlaoz7aclxuyvjwjpwj25jm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">Teste 5 equilibrado para compartilhamento igual de CPU</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/vi/cy/fe/vicyfenhzk7uvcjsiohq950c9fa.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">teste # 6</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/7h/bg/ez/7hbgezb4zxuv3ijuemjmkilf110.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">teste # 8</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/gq/5_/uj/gq5_uje-nnkfhlqmilb7xnbu5tc.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">teste # 12</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/xa/tr/m9/xatrm9dbbaha13w9wjxzmecvxjm.png"></p></div></div><br><div class="spoiler">  <b class="spoiler_title">teste # 13</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/-w/9t/i8/-w9ti8atzczna-9dvepihihlyqu.png"></p></div></div><br><h1 id="problems">  Problemas. </h1><br><p>  Marcado na tabela acima com vermelho. </p><br><p>  A execu√ß√£o de mais de 224 inst√¢ncias de benchmark no servidor B provou ser uma p√©ssima id√©ia, pois o servidor do lado do cliente era incapaz de distribuir uniformemente o tempo da CPU entre processos / threads.  As primeiras 224 inst√¢ncias de benchmark que estabeleceram todas as suas conex√µes consumiram a maioria dos recursos da CPU e as demais inst√¢ncias de benchmark est√£o atrasadas.  Mesmo o uso de renice -20 n√£o ajuda muito (448 inst√¢ncias de benchmark, 2 inst√¢ncias LAppS): </p><br><div class="spoiler">  <b class="spoiler_title">448 inst√¢ncias de benchmark</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/a2/ms/bg/a2msbgjgzuwvzzdl332linmmq98.png"><br>  O servidor B (lado esquerdo) est√° sob carga muito pesada e o servidor A ainda possui recursos livres de CPU. </p></div></div><br><p>  Ent√£o, eu dobrei o <strong>benchmark.max_connections em</strong> vez de iniciar mais inst√¢ncias separadas do LAppS. </p><br><p>  Ainda para a execu√ß√£o de 12,3 milh√µes de WebSockets, iniciei a 5¬™ inst√¢ncia do LAppS (testes 5 e 6) sem interromper quatro que j√° est√£o em execu√ß√£o.  E desempenhou o papel de CFQ suspendendo e reiniciando manualmente os processos priorizados com <em>kill -STOP / -CONT</em> ou / e <em>renize</em> suas prioridades.  Voc√™ pode usar o seguinte script de modelo para isso: </p><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> [ 1 ]; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -STOP &lt;4 fast-processes pids&gt; sleep 10 <span class="hljs-built_in"><span class="hljs-built_in">kill</span></span> -CONT &lt;4 fast-processes pids&gt; sleep 5 <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre> <br><p>  Bem-vindo ao RHEL 7.6!  Honestamente, usei o comando renice pela primeira vez desde 2009. O pior: usei quase sem sucesso dessa vez. </p><br><p>  Eu tive um problema com o mecanismo de dispers√£o e coleta das NICs.  Por isso, desativei-o para alguns testes, sem marcar esse evento na tabela. </p><br><p>  Eu tive interrup√ß√µes parciais no link sob carga pesada e o bug do driver da NIC, ent√£o tive que descartar os resultados dos testes relacionados. </p><br><h1 id="end-of-story">  Fim da hist√≥ria </h1><br><p>  Honestamente, os testes foram muito mais suaves do que eu esperava. </p><br><p>  Estou convencido de que n√£o consegui carregar o LAppS no servidor A em todo o seu potencial (sem SSL), porque eu n√£o tinha recursos de CPU suficientes para o lado do cliente.  Embora com o TLS 1.3 ativado, o LAppS no servidor A estava utilizando quase todos os recursos de CPU dispon√≠veis. </p><br><p>  Ainda estou convencido de que o LAppS √© o servidor de c√≥digo aberto WebSockets mais escal√°vel e mais r√°pido dispon√≠vel no mercado e o m√≥dulo cliente WebSockets da <strong>cws</strong> √© o √∫nico do g√™nero, fornecendo a estrutura para testes de alta carga. </p><br><p>  Verifique os resultados em seu pr√≥prio hardware. </p><br><p>  Nota do conselho: nunca use nginx ou apache como balanceador de carga ou como um proxy-pass para WebSockets, ou voc√™ acabar√° reduzindo o desempenho em ordem de magnitude.  Eles n√£o s√£o criados para WebSockets. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt460847/">https://habr.com/ru/post/pt460847/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt460837/index.html">Manual do Podcast para Iniciantes</a></li>
<li><a href="../pt460839/index.html">Launch Predator - Reposit√≥rios de dados pr√©-compilados</a></li>
<li><a href="../pt460841/index.html">Os 23 melhores aplicativos de aprendizado de idiomas</a></li>
<li><a href="../pt460843/index.html">Apresentando o novo 3CX Call Flow Designer e o 3CX CRM Template Generator</a></li>
<li><a href="../pt460845/index.html">Fernando Corbato, pai do seu computador (e senha), morreu aos 93 anos</a></li>
<li><a href="../pt460849/index.html">Parte 4. Um modelo de gr√°fico para calcular fun√ß√µes l√≥gicas para processos paralelos ass√≠ncronos</a></li>
<li><a href="../pt460851/index.html">SamsPcbGuide, Parte 10: Tecnologia - Componentes sem solda de chumbo</a></li>
<li><a href="../pt460855/index.html">Como usar o PHP para implementar microsservi√ßos?</a></li>
<li><a href="../pt460857/index.html">Como a pesquisa da Namecoin Blockchain previu ataques cibern√©ticos RTM</a></li>
<li><a href="../pt460859/index.html">Confer√™ncia IThink # 3 em Kharkov - com base na WWDC 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>