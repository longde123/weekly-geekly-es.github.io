<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∂üèº ü•ú üïü Erstellen einer Abh√∂ranwendung zum Anzeigen des mobilen MMORPG-Verkehrs üôÑ üï¥üèæ üñ≤Ô∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dies ist der zweite Teil einer Reihe von Artikeln zur Analyse des Netzwerkverkehrs von mobilen MMORPGs. Beispielschleifenthemen: 



1. Analysieren Si...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Erstellen einer Abh√∂ranwendung zum Anzeigen des mobilen MMORPG-Verkehrs</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/457480/">  Dies ist der zweite Teil einer Reihe von Artikeln zur Analyse des Netzwerkverkehrs von mobilen MMORPGs.  Beispielschleifenthemen: <br><br><ol><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Analysieren Sie das Nachrichtenformat zwischen Server und Client.</a> </li><li>  Schreiben einer H√∂ranwendung, um den Spielverkehr auf bequeme Weise anzuzeigen. </li><li>  Abfangen des Datenverkehrs und dessen √Ñnderung mithilfe eines Nicht-HTTP-Proxyservers. </li><li>  Die ersten Schritte zu Ihrem eigenen ("Raubkopien") Server. </li></ol><br>  In diesem Teil werde ich die Erstellung einer Listening-Anwendung (Sniffer) beschreiben, mit der wir Ereignisse nach Typ und Quelle filtern, Informationen zur Nachricht anzeigen und selektiv zur Analyse speichern sowie ein wenig in die ausf√ºhrbare Datei des Spiels ("bin√§r") gelangen k√∂nnen unterst√ºtzende Informationen und Unterst√ºtzung f√ºr <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Protokollpuffer</a> zur App hinzuf√ºgen.  Interessiert frage ich nach Katze. <br><a name="habracut"></a><br><h3>  Erforderliche Werkzeuge </h3><br>  Um die unten beschriebenen Schritte wiederholen zu k√∂nnen, ben√∂tigen Sie: <br><br><ul><li>  Wireshark f√ºr die Paketanalyse; </li><li>  .NET </li><li>  <a href="">PcapDotNet-</a> Bibliothek f√ºr die Arbeit mit WinPcap; </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">protobuf-net</a> Bibliothek f√ºr die Arbeit mit Protokollpuffern. </li></ul><br><h3>  Schreiben einer H√∂ranwendung </h3><br>  Wie wir uns aus dem <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">vorherigen Artikel</a> erinnern, kommuniziert das Spiel √ºber das TCP-Protokoll und im Rahmen der Sitzung mit nur einem Server und an einem Port.  Um den Spielverkehr analysieren zu k√∂nnen, m√ºssen wir die folgenden Aufgaben ausf√ºhren: <br><br><ul><li>  Pakete eines mobilen Ger√§ts abfangen; </li><li>  Filterspielpakete; </li><li>  F√ºgen Sie die Daten des n√§chsten Pakets zur weiteren Verarbeitung zum Puffer hinzu. </li><li>  Holen Sie sich Spielereignisse aus Puffern, sobald diese gef√ºllt sind. </li></ul><br>  Diese Aktionen werden in der <code>Sniffer</code> Klasse implementiert, die die PcapDotNet-Bibliothek zum Abfangen von Paketen verwendet.  Bei der <code>Sniff</code> Methode √ºbergeben wir die IP-Adresse des Adapters (tats√§chlich ist dies die Adresse des PCs, von dem Wi-Fi f√ºr das mobile Ger√§t innerhalb desselben Netzwerks verteilt wird), die IP-Adresse des mobilen Ger√§ts und die IP-Adresse des Servers.  Aufgrund der Inkonsistenz der letzten beiden (nach monatelanger √úberwachung verschiedener Plattformen und Server stellte sich heraus, dass der Server aus einem Pool von ~ 50 Servern ausgew√§hlt wurde, von denen jeder noch 5-7 m√∂gliche Ports hat), √ºbertrage ich nur die ersten drei Oktette.  Die Verwendung dieser Filterung ist in der <code>IsTargetPacket</code> Methode sichtbar. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Sniffer</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[<span class="hljs-number"><span class="hljs-number">4096</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Active { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _adapterIP; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _target; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _server; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; _serverBuffer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt; _clientBuffer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LivePacketDevice _device = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PacketCommunicator _communicator = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Action&lt;Event&gt; _eventCallback = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sniff</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ip, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> target, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> server</span></span></span><span class="hljs-function">)</span></span> { _adapterIP = ip; _target = target; _server = server; _serverBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(); _clientBuffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(); IList&lt;LivePacketDevice&gt; allDevices = LivePacketDevice.AllLocalMachine; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i != allDevices.Count; ++i) { LivePacketDevice device = allDevices[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> address = device.Addresses[<span class="hljs-number"><span class="hljs-number">1</span></span>].Address + <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (address == <span class="hljs-string"><span class="hljs-string">"Internet "</span></span> + _adapterIP) { _device = device; } } _communicator = _device.Open(<span class="hljs-number"><span class="hljs-number">65536</span></span>, PacketDeviceOpenAttributes.Promiscuous, <span class="hljs-number"><span class="hljs-number">1000</span></span>); _communicator.SetFilter(_communicator.CreateFilter(<span class="hljs-string"><span class="hljs-string">"ip and tcp"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(() =&gt; { Thread.CurrentThread.IsBackground = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; BeginReceive(); }).Start(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BeginReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _communicator.ReceivePackets(<span class="hljs-number"><span class="hljs-number">0</span></span>, OnReceive); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { PacketCommunicatorReceiveResult result = _communicator.ReceivePacket(<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> Packet packet); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (result) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PacketCommunicatorReceiveResult.Timeout: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> PacketCommunicatorReceiveResult.Ok: OnReceive(packet); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Active); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddEventCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Action&lt;Event&gt; callback</span></span></span><span class="hljs-function">)</span></span> { _eventCallback = callback; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnReceive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Packet packet</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Active) { IpV4Datagram ip = packet.Ethernet.IpV4; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsTargetPacket(ip)) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ParseData(ip); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ObjectDisposedException) { } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (EndOfStreamException e) { Console.WriteLine(e); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span>; } } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsTargetPacket</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sourceIp = ip.Source.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> destIp = ip.Destination.ToString(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (sourceIp != _adapterIP &amp;&amp; destIp != _adapterIP) &amp;&amp; ( (sourceIp.StartsWith(_target) &amp;&amp; destIp.StartsWith(_server)) || (sourceIp.StartsWith(_server) &amp;&amp; destIp.StartsWith(_target)) ); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip</span></span></span><span class="hljs-function">)</span></span> { TcpDatagram tcp = ip.Tcp; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tcp.Payload != <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; tcp.PayloadLength &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payload = ExtractPayload(tcp); AddToBuffer(ip, payload); ProcessBuffers(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExtractPayload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TcpDatagram tcp</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> payloadLength = tcp.PayloadLength; MemoryStream ms = tcp.Payload.ToMemoryStream(); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] payload = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[payloadLength]; ms.Read(payload, <span class="hljs-number"><span class="hljs-number">0</span></span>, payloadLength); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> payload; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddToBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IpV4Datagram ip, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] payload</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ip.Destination.ToString().StartsWith(_target)) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> payload) _serverBuffer.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> payload) _clientBuffer.Add(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ProcessBuffer(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _serverBuffer); ProcessBuffer(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> _clientBuffer); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> List&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">// TODO } public void Suspend() { Active = false; } public void Resume() { Active = true; } }</span></span></code> </pre><br>  Gro√üartig, jetzt haben wir zwei Puffer mit Paketdaten vom Client und Server.  Erinnern Sie sich an das Format der Ereignisse zwischen dem Spiel und dem Server: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Event</span></span></span><span class="hljs-class"> {</span></span> uint payload_length &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFFFF00</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Payload Length"</span></span>&gt;; ushort event_code &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFF9988</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Event Code"</span></span>&gt;; byte payload[payload_length] &lt;name=<span class="hljs-string"><span class="hljs-string">"Event Payload"</span></span>&gt;; };</code> </pre><br>  Auf dieser Grundlage k√∂nnen Sie eine <code>Event</code> erstellen: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EventSource { Client, Server } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> EventTypes : <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> { Movement = <span class="hljs-number"><span class="hljs-number">11</span></span>, Ping = <span class="hljs-number"><span class="hljs-number">30</span></span>, Pong = <span class="hljs-number"><span class="hljs-number">31</span></span>, Teleport = <span class="hljs-number"><span class="hljs-number">63</span></span>, EnterDungeon = <span class="hljs-number"><span class="hljs-number">217</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> ID; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Length { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> DataLength { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> EventType { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> EventSource Direction { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _data; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> BinaryReader _br = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Event</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data, EventSource direction</span></span></span><span class="hljs-function">)</span></span> { _data = data; _br = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MemoryStream(_data)); Length = _br.ReadUInt32(); Type = _br.ReadUInt16(); DataLength = <span class="hljs-number"><span class="hljs-number">0</span></span>; EventType = <span class="hljs-string"><span class="hljs-string">$"Unknown (</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Type}</span></span></span><span class="hljs-string">)"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (IsKnown()) { EventType = ((EventTypes)Type).ToString(); } Direction = direction; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsKnown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Enum.IsDefined(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventTypes), Type); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">byte</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPayload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> hasDatLength = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> payloadLength = _data.Length - (hasDatLength ? <span class="hljs-number"><span class="hljs-number">10</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>&gt;(_data).GetRange(hasDatLength ? <span class="hljs-number"><span class="hljs-number">10</span></span> : <span class="hljs-number"><span class="hljs-number">6</span></span>, payloadLength).ToArray(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = Path.Combine(AppDomain.CurrentDomain.BaseDirectory, <span class="hljs-string"><span class="hljs-string">"Packets"</span></span>, EventType); Directory.CreateDirectory(path); File.WriteAllBytes(path + <span class="hljs-string"><span class="hljs-string">$"/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{ID}</span></span></span><span class="hljs-string">.dump"</span></span>, _data); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"Type </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Type}</span></span></span><span class="hljs-string">. Data length: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Length}</span></span></span><span class="hljs-string">."</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ulong</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadVLQ</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> readFlag = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">true</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (readFlag) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flag = _br.ReadByte(); } <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> vlq = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; ; i += <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = _br.ReadByte(); vlq |= (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)(x &amp; <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) &lt;&lt; i; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((x &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) != <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vlq; } }</code> </pre><br>  Die <code>Event</code> wird als Basisklasse f√ºr alle Ereignisse im Spiel verwendet.  Hier ist eine Beispielklasse f√ºr das <code>Ping</code> Ereignis: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Ping</span></span> : <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> _pingTime; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Ping</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] data</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data, EventSource.Client</span></span></span><span class="hljs-function">)</span></span> { EventType = <span class="hljs-string"><span class="hljs-string">"Ping"</span></span>; DataLength = <span class="hljs-number"><span class="hljs-number">4</span></span>; _pingTime = _br.ReadUInt32(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"Pinging server at </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{_pingTime}</span></span></span><span class="hljs-string">ms."</span></span>; } }</code> </pre><br>  Nachdem wir die Ereignisklasse haben, k√∂nnen wir <code>Sniffer</code> Methoden hinzuf√ºgen: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> List&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; buffer</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Active) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer.Count &gt; <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  4        ... { var eventLength = BitConverter.ToInt32(buffer.Take(4).ToArray(), 0) + 6; // ...    -   .. +  4  + 2    if (eventLength &gt;= 6 &amp;&amp; buffer.Count &gt;= eventLength) { var eventData = buffer.Take(eventLength).ToArray(); var ev = CreateEvent(eventData, direction); buffer.RemoveRange(0, eventLength); continue; } } break; } } } private Event CreateEvent(byte[] data, EventSource direction) { var ev = new Event(data, direction); var eventType = Enum.GetName(typeof(EventTypes), ev.Type); if (eventType != null) { try { //     (, &lt;code&gt;Ping&lt;/code&gt;). var className = "Events." + eventType; Type t = Type.GetType(className); ev = (Event)Activator.CreateInstance(t, data); } catch (Exception) { //     -   . ev = new Event(data, direction); } finally { } } _eventCallback?.Invoke(ev); return ev; }</span></span></code> </pre><br>  Erstellen Sie eine Formularklasse, die das Abh√∂ren ausl√∂st: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainForm</span></span> : <span class="hljs-title"><span class="hljs-title">Form</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Sniffer _sniffer = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Event&gt; _events = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Event&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt; _eventTypesFilter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">ushort</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showClientEvents = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showServerEvents = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _showUnknownEvents = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> _clearLogsOnRestart = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> _eventId = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitializeSniffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _sniffer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sniffer(); _sniffer.AddEventCallback(NewEventThreaded); _sniffer.Sniff(<span class="hljs-string"><span class="hljs-string">"192.168.137.1"</span></span>, <span class="hljs-string"><span class="hljs-string">"192.168.137."</span></span>, <span class="hljs-string"><span class="hljs-string">"123.45.67."</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEventThreaded</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { events_table.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NewEventCallback(NewEvent), ev); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">delegate</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEventCallback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NewEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { ev.ID = _eventId++; _events.Add(ev); LogEvent(ev); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LogEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FilterEvent(ev)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = ev.GetType(); events_table.Rows.Add(<span class="hljs-number"><span class="hljs-number">1</span></span>); events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">0</span></span>].Value = ev.ID; events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">1</span></span>].Value = ev.EventType; events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">2</span></span>].Value = Enum.GetName(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(EventSource), ev.Direction); events_table.Rows[events_table.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>].Cells[<span class="hljs-number"><span class="hljs-number">3</span></span>].Value = ev.ToString(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReloadEvents</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { events_table.Rows.Clear(); events_table.Refresh(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ev <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _events) { LogEvent(ev); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterEvent</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Event ev</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ( (ev.Direction == EventSource.Client &amp;&amp; _showClientEvents) || (ev.Direction == EventSource.Server &amp;&amp; _showServerEvents) ) &amp;&amp; (_eventTypesFilter.Contains(ev.Type) || (!ev.IsKnown() &amp;&amp; _showUnknownEvents)); } }</code> </pre><br>  Fertig!  Jetzt k√∂nnen Sie einige Tabellen hinzuf√ºgen, um die Liste der Ereignisse zu verwalten ( <code>_eventTypesFilter</code> gef√ºllt) und in Echtzeit <code>events_table</code> (die Haupttabelle <code>events_table</code> ).  Zum Beispiel habe ich nach folgenden Kriterien gefiltert ( <code>FilterEvent</code> Methode): <br><br><ul><li>  Ereignisse vom Kunden anzeigen; </li><li>  Ereignisse vom Server anzeigen; </li><li>  Anzeige unbekannter Ereignisse; </li><li>  Ausgew√§hlte bekannte Ereignisse anzeigen. </li></ul><br><h3>  Das ausf√ºhrbare Spiel lernen </h3><br>  Obwohl es jetzt m√∂glich ist, die Ereignisse des Spiels ohne Probleme zu analysieren, ist eine Menge manueller Arbeit erforderlich, um nicht nur die Bedeutung aller Ereigniscodes, sondern auch die Struktur der Nutzlast zu bestimmen, was sehr schwierig sein wird, insbesondere wenn sie sich in Abh√§ngigkeit von einigen Feldern √§ndert.  Ich beschloss, nach Informationen in der ausf√ºhrbaren Datei des Spiels zu suchen.  Da das Spiel plattform√ºbergreifend ist (verf√ºgbar unter Windows, iOS und Android), stehen die folgenden Optionen zur Analyse zur Verf√ºgung: <br><br><ul><li>  .exe-Datei (Ich habe mich im Pfad C befunden: / Programme / WindowsApps /% appname% /; </li><li>  eine bin√§re iOS-Datei, die von Apple verschl√ºsselt wird, aber mit JailBreak k√∂nnen Sie die entschl√ºsselte Version mit Crackulous oder √§hnlichem erhalten; </li><li>  Gemeinsame Android-Bibliothek  Es befindet sich im Pfad / data / data /% app-vendor-name% / lib /. </li></ul><br>  Da ich keine Ahnung hatte, welche Architektur ich f√ºr Android und iOS w√§hlen sollte, begann ich mit einer EXE-Datei.  Wir laden die Bin√§rdatei in die IDA, wir sehen die Auswahl der Architekturen. <br><br><img src="https://habrastorage.org/webt/jb/q6/vh/jbq6vhlp9nqovpae87uka5jrof0.png"><br><br>  Der Zweck unserer Suche sind einige sehr n√ºtzliche Zeilen, was bedeutet, dass die Dekompilierung des Assemblers nicht in den Pl√§nen enthalten ist. W√§hlen Sie jedoch f√ºr den Fall "ausf√ºhrbare Datei 80386" aus, da die Optionen "Bin√§rdatei" und "ausf√ºhrbare MS-DOS-Datei" eindeutig nicht geeignet sind.  Klicken Sie auf "OK", warten Sie, bis die Datei in die Datenbank geladen wurde, und warten Sie, bis die Analyse der Datei abgeschlossen ist.  Das Ende der Analyse l√§sst sich daran erkennen, dass in der Statusleiste unten links der folgende Status angezeigt wird: <br><br><img src="https://habrastorage.org/webt/yk/__/fb/yk__fbdgrskjle8c5zf6ro0q_f8.png"><br><br>  Wechseln Sie zur Registerkarte Strings (View / Open subviews / Strings oder <code>Shift + F12</code> ).  Der Zeilengenerierungsprozess kann einige Zeit dauern.  In meinem Fall wurden ~ 47.000 Zeilen gefunden.  Adressen f√ºr die Position von Zeichenfolgen haben das Pr√§fix der Form <code>.data</code> , <code>.rdata</code> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">anderer</a> .  In meinem Fall befanden sich alle ‚Äûinteressanten‚Äú Zeilen im Abschnitt <code>.rdata</code> , dessen Gr√∂√üe ~ 44,5.000 Datens√§tze betrug.  Wenn Sie durch die Tabelle schauen, k√∂nnen Sie sehen: <br><br><ul><li>  Fehlermeldungen und Abfragesegmente w√§hrend der Anmeldephase; </li><li>  Fehlerzeichenfolgen und Initialisierungsinformationen f√ºr das Spiel, die Spiel-Engine und die Schnittstellen; </li><li>  viel M√ºll; </li><li>  eine Liste der Spieltische auf der Client-Seite; </li><li>  verwendete Werte der Spiel-Engine im Spiel; </li><li>  Liste der Effekte; </li><li>  riesige Liste von Schnittstellenlokalisierungsschl√ºsseln; </li><li>  usw. </li></ul><br>  Endlich kommt das Ende der Tabelle, wonach wir gesucht haben. <br><br><img src="https://habrastorage.org/webt/ua/jr/sw/uajrsw8i71x33xuhyhmzonprqku.png"><br><br>  Dies ist eine Liste von Ereigniscodes zwischen Client und Server.  Dies kann unser Leben bei der Analyse des Netzwerkprotokolls des Spiels vereinfachen.  Aber wir werden hier nicht aufh√∂ren!  Es muss gepr√ºft werden, ob es m√∂glich ist, den numerischen Wert des Ereigniscodes irgendwie zu erhalten.  Wir sehen die "vertrauten" aus den vorherigen <code>CMSG_PING</code> und <code>SMSG_PONG</code> mit den Codes 30 ( <code>1E <sub>16</sub></code> ) bzw. 31 ( <code>1F <sub>16</sub></code> ).  Doppelklicken Sie auf die Zeile, um zu dieser Stelle im Code zu gelangen. <br><br><img src="https://habrastorage.org/webt/la/ro/wj/larowjnopxrmyc53htrzo_-_2zi.png"><br><br>  In der Tat ist unmittelbar nach den Zeichenfolgenwerten der Codes eine Folge von <code>0x10 0x1E</code> und <code>0x10 0x1F</code> .  Das bedeutet, dass Sie die gesamte Tabelle analysieren und eine Liste der Ereignisse und ihres numerischen Werts erhalten k√∂nnen, was die Analyse des Protokolls weiter vereinfacht. <br><br>  Leider bleibt die Windows-Version des Spiels um viele Versionen hinter den mobilen Versionen zur√ºck, und daher sind die Informationen aus .exe nicht relevant, und obwohl dies hilfreich sein kann, sollten Sie sich nicht vollst√§ndig darauf verlassen.  Als n√§chstes habe ich beschlossen, die dynamische Bibliothek mit Android zu studieren, da ich in einem Forum gesehen habe, dass dort im Gegensatz zu iOS-Bin√§rdateien viele Metainformationen zu Klassen enthalten sind.  <code>CMSG_PING</code> ergab eine Suche in der <code>CMSG_PING</code> keine Ergebnisse. <br><br>  Ohne Hoffnung mache ich die gleiche Suche in der iOS-Bin√§rdatei - unglaublich, aber die gleichen Daten sind dort wie in .exe!  Laden Sie die Datei auf die IDA hoch. <br><br><img src="https://habrastorage.org/webt/la/ro/wj/larowjnopxrmyc53htrzo_-_2zi.png"><br><br>  Ich w√§hle die erste vorgeschlagene Option, da ich nicht sicher bin, welche ben√∂tigt wird.  Wieder warten wir auf das Ende der Dateianalyse (die Bin√§rdatei ist fast viermal gr√∂√üer als .exe, die Analysezeit hat sich nat√ºrlich auch erh√∂ht).  Wir √∂ffnen ein Fenster mit Linien, die sich diesmal als 51k herausstellten.  √úber <code>Ctrl + F</code> suchen wir nach <code>CMSG_PING</code> und ... wir finden es nicht.  Wenn Sie den Code zeichenweise eingeben, k√∂nnen Sie folgendes Ergebnis feststellen: <br><br><img src="https://habrastorage.org/webt/jk/rz/be/jkrzbe0uvyj2vi2fxphnldc_vki.png"><br><br>  Aus irgendeinem Grund hat die IDA das gesamte <code>Opcode.proto</code> Objekt in eine Zeile <code>Opcode.proto</code> .  Doppelklicken Sie auf diese Stelle im Code und sehen Sie, dass die Struktur auf dieselbe Weise wie in der EXE-Datei beschrieben wird, sodass Sie sie ausschneiden und in <code>Enum</code> konvertieren k√∂nnen. <br><br>  Abschlie√üend sei daran erinnert, wie <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">aml</a> in den Kommentaren zum vorherigen Artikel vorgeschlagen hat, dass die Nachrichtenstruktur des Spiels eine Implementierung von <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Protokollpuffern ist</a> .  Wenn Sie sich den Code in einer Bin√§rdatei genau ansehen, sehen Sie, dass die <code>Opcode</code> Beschreibung auch in diesem Format vorliegt. <br><br><img src="https://habrastorage.org/webt/a6/pl/bk/a6plbk-pb8ldifrvha6qfqmh0oi.png"><br><br>  Wir werden eine Parser-Vorlage f√ºr 010Editor schreiben, um alle Codewerte abzurufen. <br><br><div class="spoiler">  <b class="spoiler_title">Packed * Type Code f√ºr 010Editor aktualisiert</b> <div class="spoiler_text">  Kleinere Typ√§nderungen enthalten die Validierung der Feldbezeichnung, um fehlende zu √ºberspringen. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">uint </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PeekTag</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (FTell() == FileSize()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } Varint tag; FSkip(-tag.size); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tag._ &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-function"><span class="hljs-function">struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Packed</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint fieldNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PeekTag() != fieldNumber) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } Varint key &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0xFFBB00</span></span>&gt;; local uint wiredType = key._ &amp; <span class="hljs-number"><span class="hljs-number">0x7</span></span>; local uint field = key._ &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>; local uint size = key.size; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (wiredType) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> value; size += <span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> value; size += <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: Varint value; size += value.size; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }; <span class="hljs-function"><span class="hljs-function">struct </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PackedString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint fieldNumber)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (PeekTag() != fieldNumber) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">length</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(fieldNumber)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> str[length.value._]; };</code> </pre><br></div></div><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Code</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">PackedString </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; <span class="hljs-function"><span class="hljs-function">Packed </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">code_value</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">2</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> &lt;bgcolor</span></span>=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; Printf(<span class="hljs-string"><span class="hljs-string">"%s = %d,\n"</span></span>, code_name.str, code_value.value._); <span class="hljs-comment"><span class="hljs-comment">//        Enum }; struct Property { Packed size(5) &lt;bgcolor=0x00FF00&gt;; PackedString prop_name(1) &lt;bgcolor=0x00FF00&gt;; while (FTell() - 0x176526B - prop_name.length.value._ &lt; size.value._) { Code codes &lt;name="Codes"&gt;; } }; struct { FSkip(0x176526B); PackedString object(1) &lt;bgcolor=0x00FF00&gt;; PackedString format(2) &lt;bgcolor=0x00FFFF&gt;; Property prop; } file;</span></span></code> </pre><br>  Das Ergebnis ist ungef√§hr so: <br><br><img src="https://habrastorage.org/webt/n5/ge/1d/n5ge1dnylry0n2tdskxrvqg9zmy.png"><br><br>  Interessanter!  Pb in der Objektbeschreibung bemerkt?  Es w√§re notwendig, nach anderen Linien zu suchen, pl√∂tzlich gibt es viele solcher Objekte? <br><br><img src="https://habrastorage.org/webt/wf/cp/fx/wfcpfxmh1c6vhwycv9jnp4k9wle.png"><br><br>  Die Ergebnisse sind √§u√üerst unerwartet.  Anscheinend beschreibt die ausf√ºhrbare Datei des Spiels viele Arten von Daten, einschlie√ülich Aufz√§hlungen und Nachrichtenformaten zwischen dem Server und dem Client.  Hier ist ein Beispiel f√ºr eine Beschreibung eines Typs, der die Position eines Objekts in der Welt beschreibt: <br><br><img src="https://habrastorage.org/webt/jl/br/ix/jlbrixdyltdfgfmzkdoxvl038eg.png"><br><br>  Eine schnelle Suche ergab zwei gro√üe Orte mit Typbeschreibungen, obwohl eine genauere Untersuchung wahrscheinlich andere kleine Orte aufdecken w√ºrde.  Nachdem ich sie geschnitten hatte, schrieb ich ein kleines Skript in C #, um die Beschreibungen nach Dateien zu trennen (in der Struktur √§hnelt dies der Beschreibung der Liste der Ereigniscodes) - es ist einfacher, sie in 010Editor zu analysieren. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> br = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BinaryReader(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileStream(<span class="hljs-string"><span class="hljs-string">"./BinaryFile.partX"</span></span>, FileMode.Open)); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (br.BaseStream.Position &lt; br.BaseStream.Length) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> startOffset = br.BaseStream.Position; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length = ReadVLQ(br, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tag = br.ReadByte(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> eventName = br.ReadString(); br.BaseStream.Position = startOffset; File.WriteAllBytes(<span class="hljs-string"><span class="hljs-string">$"./parsed/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{eventName}</span></span></span><span class="hljs-string">"</span></span>, br.ReadBytes((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)length + size + <span class="hljs-number"><span class="hljs-number">1</span></span>)); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">ulong</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReadVLQ</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">BinaryReader br, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> size</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> flag = br.ReadByte(); <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> vlq = <span class="hljs-number"><span class="hljs-number">0</span></span>; size = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; ; i += <span class="hljs-number"><span class="hljs-number">7</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = br.ReadByte(); vlq |= (<span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span>)(x &amp; <span class="hljs-number"><span class="hljs-number">0x7F</span></span>) &lt;&lt; i; size++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((x &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) != <span class="hljs-number"><span class="hljs-number">0x80</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vlq; } }</code> </pre><br>  Ich werde das Format zur detaillierten Beschreibung von Strukturen nicht analysieren, weil  Entweder ist es spezifisch f√ºr das betreffende Spiel oder es ist ein Format, das in <code>Protocol Buffers</code> allgemein akzeptiert wird (wenn jemand sicher wei√ü, geben Sie dies bitte in den Kommentaren an).  Nach allem, was ich feststellen konnte: <br><br><ul><li>  Beschreibung kommt auch im <code>Protocol Buffers</code> ; </li><li>  Die Beschreibung jedes Felds enth√§lt seinen Namen, seine Nummer und seinen Datentyp, f√ºr den eine eigene Typentabelle verwendet wurde: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TypeToStr</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(uint type)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Float"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"UInt64"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"UInt32"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Boolean"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"String"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Struct"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">14</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"Enum"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: local <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> s; SPrintf(s, <span class="hljs-string"><span class="hljs-string">"%Lu"</span></span>, type); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> s; } };</code> </pre></li><li>  Wenn der Datentyp eine Aufz√§hlung oder Struktur ist, gab es eine Verkn√ºpfung zum gew√ºnschten Objekt. </li></ul><br>  Nun, das Letzte, was uns bleibt, ist die Verwendung der in unserer <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>protobuf-net</code></a> empfangenen Informationen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>protobuf-net</code></a> Nachrichten mithilfe der <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u="><code>protobuf-net</code></a> Bibliothek.  Verbinden Sie die Bibliothek √ºber NuGet und f√ºgen Sie sie <code>using ProtoBuf;</code>  und Sie k√∂nnen Klassen erstellen, um Nachrichten zu beschreiben.  Nehmen Sie ein Beispiel aus einem fr√ºheren Artikel: Charakterbewegung.  Die formatierte Beschreibung des Formats beim Hervorheben von Segmenten sieht ungef√§hr so ‚Äã‚Äãaus: <br><br><img src="https://habrastorage.org/webt/ce/qg/py/ceqgpyfbuxygvoqx4jnlp8slumy.png"><br><br>  Mit der Debug-Ausgabe k√∂nnen Sie eine kurze Beschreibung daraus erstellen: <br><br><pre> <code class="plaintext hljs">Field 1 (Type 13): time Field 2 (Struct .pb.CxGS_Vec3): position Field 3 (UInt64): guid Field 4 (Struct .pb.CxGS_Vec3): direction Field 5 (Struct .pb.CxGS_Vec3): speed Field 6 (UInt32): state Field 10 (UInt32): flag Field 11 (Float): y_speed Field 12 (Boolean): is_flying Field 7 (UInt32): emote_id Field 9 (UInt32): emote_duration Field 8 (Boolean): emote_loop</code> </pre><br>  Jetzt k√∂nnen Sie die entsprechende Klasse mit der <code>protobuf-net</code> Bibliothek erstellen. <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ProtoContract</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MoveInfo</span></span> : <span class="hljs-title"><span class="hljs-title">ProtoBufEvent</span></span>&lt;<span class="hljs-title"><span class="hljs-title">MoveInfo</span></span>&gt; { [ProtoMember(<span class="hljs-number"><span class="hljs-number">3</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> GUID; [ProtoMember(<span class="hljs-number"><span class="hljs-number">1</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> Time; [ProtoMember(<span class="hljs-number"><span class="hljs-number">2</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Position; [ProtoMember(<span class="hljs-number"><span class="hljs-number">4</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Direction; [ProtoMember(<span class="hljs-number"><span class="hljs-number">5</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Vec3 Speed; [ProtoMember(<span class="hljs-number"><span class="hljs-number">6</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ulong</span></span> State; [ProtoMember(<span class="hljs-number"><span class="hljs-number">7</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> EmoteID; [ProtoMember(<span class="hljs-number"><span class="hljs-number">8</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EmoteLoop; [ProtoMember(<span class="hljs-number"><span class="hljs-number">9</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> EmoteDuration; [ProtoMember(<span class="hljs-number"><span class="hljs-number">10</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uint</span></span> Flag; [ProtoMember(<span class="hljs-number"><span class="hljs-number">11</span></span>, IsRequired = <span class="hljs-literal"><span class="hljs-literal">false</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> SpeedY; [ProtoMember(<span class="hljs-number"><span class="hljs-number">12</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IsFlying; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{GUID}</span></span></span><span class="hljs-string">: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{Position}</span></span></span><span class="hljs-string">"</span></span>; } }</code> </pre><br>  Zum Vergleich hier eine Vorlage f√ºr dasselbe Ereignis aus einem vorherigen Artikel: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MoveEvent</span></span></span><span class="hljs-class"> {</span></span> uint data_length &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>, name=<span class="hljs-string"><span class="hljs-string">"Data Length"</span></span>&gt;; Packed move_time &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FFFF</span></span>&gt;; PackedVector3 position &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; PackedVector3 direction &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; PackedVector3 speed &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; Packed state &lt;bgcolor=<span class="hljs-number"><span class="hljs-number">0x00FF00</span></span>&gt;; };</code> </pre><br>  Beim Erben der <code>Event</code> Klasse k√∂nnen wir die <code>ParseData</code> Methode <code>ParseData</code> , indem wir die <code>ParseData</code> deserialisieren: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CMSG_MOVE_INFO</span></span> : <span class="hljs-title"><span class="hljs-title">Event</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> MoveInfo _message; [...] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParseData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _message = MoveInfo.Deserialize(GetPayload()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ToString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _message.ToString(); } }</code> </pre><br>  Das ist alles.  Der n√§chste Schritt besteht darin, den Spielverkehr auf unseren Proxyserver umzuleiten, um Pakete zu injizieren, zu f√§lschen und zu schneiden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de457480/">https://habr.com/ru/post/de457480/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de457464/index.html">Deduplizierung von Anzeigen auf Yandex.Real Estate</a></li>
<li><a href="../de457466/index.html">Wie wir die IT bei Leroy Merlin entwickelt haben: Umbau eines Motors f√ºr unterwegs</a></li>
<li><a href="../de457468/index.html">Universeller Speicher: SRAM, DRAM und Flash-Speicher in einer Flasche</a></li>
<li><a href="../de457470/index.html">Blattmathematik: Wie ein ungew√∂hnlicher Busch die Gleichung eines Pflanzenwachstumsmodells ver√§nderte</a></li>
<li><a href="../de457476/index.html">Reduzieren der Gr√∂√üe eines Docker-Images mit einer Spring-Boot-Anwendung</a></li>
<li><a href="../de457490/index.html">Aisioshechka aus Zuckerberg - kurz und im Fall Waage</a></li>
<li><a href="../de457494/index.html">"Und wenn ich Mathe nicht kenne, bin ich dann hoffnungslos?" - Spezialisten beantworten h√§ufig gestellte Fragen zu Berufen in Data Science</a></li>
<li><a href="../de457496/index.html">"Finde die f√ºnf Unterschiede." Skalierbarer und Generierungsunterschied - Neue Testreihe</a></li>
<li><a href="../de457504/index.html">Warum sollten Sie Ihr React Data Grid im Jahr 2019 schreiben?</a></li>
<li><a href="../de457508/index.html">Elternschaft gegen maschinelles Lernen: Vergleicht eine junge Mutter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>