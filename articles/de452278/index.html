<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë¨ üëèüèª ‚ò∏Ô∏è Bluetooth LE ist nicht so be√§ngstigend oder wie man die Benutzererfahrung ohne gro√üen Aufwand verbessert üñêüèº üë©üèø‚Äçüè´ üèÇüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vor kurzem hat unser Team die Funktion des Geldtransfers auf dem Luftweg mithilfe der Bluetooth LE-Technologie entwickelt und implementiert. Ich m√∂cht...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bluetooth LE ist nicht so be√§ngstigend oder wie man die Benutzererfahrung ohne gro√üen Aufwand verbessert</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/raiffeisenbank/blog/452278/">  Vor kurzem hat unser Team die Funktion des Geldtransfers auf dem Luftweg mithilfe der Bluetooth LE-Technologie entwickelt und implementiert.  Ich m√∂chte Ihnen sagen, wie wir es gemacht haben und was Apple uns von den Tools zur Verf√ºgung stellt.  Viele Entwickler halten Bluetooth f√ºr schwierig, da es sich um ein Protokoll auf niedriger Ebene handelt und es nicht viele Experten gibt.  Aber alles ist nicht so be√§ngstigend, und tats√§chlich ist die Verwendung dieser Funktion sehr einfach!  Und die Funktionen, die mit Bluetooth LE implementiert werden k√∂nnen, sind sicherlich interessant und werden anschlie√üend Ihre Anwendung unter den Mitbewerbern hervorheben. <br><br><img src="https://habrastorage.org/webt/97/vu/bb/97vubbbho3z3z4dx_fwnztumh9u.png"><br><a name="habracut"></a><br>  Lassen Sie uns zun√§chst verstehen, um welche Art von Technologie es sich handelt und was den Unterschied zum klassischen Bluetooth ausmacht. <br><br><h3>  Was ist Bluetooth LE? </h3><br>  Warum haben die Bluetooth-Entwickler diese Technologie Low Energy genannt?  Immerhin war der Stromverbrauch mit jeder neuen Bluetooth-Version bereits um ein Vielfaches niedriger.  Die Antwort liegt in dieser Batterie. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/ce/qb/65/ceqb65oxhimqzgzovufqysqvsqk.png"></div><br>  Sein Durchmesser betr√§gt nur 2 cm und die Kapazit√§t betr√§gt ca. 220 mA * h.  Als Ingenieure Bluetooth LE entwickelten, wollten sie, dass das Ger√§t mit einem solchen Akku mehrere Jahre lang funktioniert.  Und sie haben es geschafft!  Bluetooth LE-Ger√§te mit einem solchen Akku k√∂nnen ein Jahr lang funktionieren.  Wie viele von Ihnen schalten das Bluetooth Ihres Telefons immer noch auf die altmodische Weise aus, um Energie zu sparen, wie Sie es im Jahr 2000 getan haben?  Vergebens tun Sie dies - die Einsparungen betragen weniger als 10 Sekunden des Telefons pro Tag.  Und Sie deaktivieren sehr gro√üe Funktionen wie Handoff, AirDrop und andere. <br><br>  Was haben die Ingenieure durch die Entwicklung von Bluetooth LE erreicht?  Haben sie das klassische Protokoll verfeinert?  Energieeffizienter gemacht?  Nur alle Prozesse optimiert?  Nein.  Sie haben die Architektur des Bluetooth-Stacks komplett neu gestaltet und die Tatsache erreicht, dass Sie jetzt, um f√ºr alle anderen Ger√§te sichtbar zu sein, weniger Zeit ben√∂tigen, um in der Luft zu sein und den Kanal zu belegen.  Dies erm√∂glichte wiederum eine gute Einsparung beim Energieverbrauch.  Und mit der neuen Architektur kann jetzt jedes neue Ger√§t standardisiert werden, dank dessen Entwickler aus der ganzen Welt mit dem Ger√§t kommunizieren und daher problemlos neue Anwendungen schreiben k√∂nnen, um es zu verwalten.  Dar√ºber hinaus ist das Prinzip der Selbsterkennung in die Architektur eingebettet: Wenn Sie eine Verbindung zu einem Ger√§t herstellen, m√ºssen Sie keine PIN-Codes eingeben. Wenn Ihre Anwendung mit diesem Ger√§t kommunizieren kann, dauert die Verbindung einige Millisekunden. <br><br><ul><li>  Weniger Zeit in der Luft. </li><li>  Weniger Stromverbrauch. </li><li>  Neue Architektur. </li><li>  Reduzierte Verbindungszeit. </li></ul><br>  <b>Wie haben die Ingenieure einen so gro√üen Sprung in der Energieeffizienz geschafft?</b> <br><br>  Die Frequenz blieb gleich: 2,4 GHz, nicht zertifiziert und in vielen L√§ndern kostenlos.  Die Verbindungsverz√∂gerung ist jedoch geringer geworden: 15-30 ms statt 100 ms mit klassischem Bluetooth.  Der Arbeitsabstand blieb gleich - 100 m. Das √úbertragungsintervall war nicht stark, sondern √§nderte sich - statt 0,625 ms wurden es 3 ms. <br><br>  Aus diesem Grund konnte der Energieverbrauch nicht verzehnfacht werden.  Nat√ºrlich musste etwas leiden.  Und das ist die Geschwindigkeit: Statt 24 Mbit / s wurden es 0,27 Mbit / s.  Sie werden wahrscheinlich sagen, dass dies f√ºr 2018 eine l√§cherliche Geschwindigkeit ist. <br><br><h3>  Wo wird Bluetooth LE verwendet? </h3><br><img src="https://habrastorage.org/webt/bz/0r/ca/bz0rcanj9nvdu_gijz0f6ip3h18.png"><br><br>  Diese Technologie ist nicht jung, sie erschien zuerst im iPhone 4s.  Und schon geschafft, viele Gebiete zu erobern.  Bluetooth LE wird in allen Smart-Home-Ger√§ten und tragbaren Elektronikger√§ten verwendet.  Jetzt gibt es sogar Pommes in der Gr√∂√üe von Kaffeebohnen. <br><br><img src="https://habrastorage.org/webt/ex/0c/go/ex0cgowkyn9nhzx_c5vnwvn7v3g.png"><br><br>  <b>Und wie wird diese Technologie in Software angewendet?</b> <br><br>  Da Apple als erstes Unternehmen Bluetooth in sein Ger√§t integriert und in Betrieb genommen hat, haben sie inzwischen gute Fortschritte erzielt und Technologie in ihr √ñkosystem integriert.  Und jetzt k√∂nnen Sie diese Technologie in Diensten wie AirDrop, Schnellstart von Ger√§ten, Teilen von Passw√∂rtern und √úbergabe erf√ºllen.  Und selbst die Benachrichtigungen in der Uhr erfolgen √ºber Bluetooth LE.  Dar√ºber hinaus hat Apple eine √∂ffentlich zug√§ngliche Dokumentation ver√∂ffentlicht, wie Sie sicherstellen k√∂nnen, dass Benachrichtigungen von allen Anwendungen auf Ihre eigenen Ger√§te gelangen.  Welche Rolle spielen Ger√§te in Bluetooth LE? <br><br><img src="https://habrastorage.org/webt/vd/gk/85/vdgk85ww_wcqq_jykxexwqidgcw.png"><br><br>  <b>Brodcaster.</b>  Sendet Nachrichten an alle Personen in der N√§he. Sie k√∂nnen keine Verbindung zu diesem Ger√§t herstellen.  Nach diesem Prinzip funktionieren iBeacons und Indoor-Navigation. <br><br>  <b>Beobachter.</b>  H√∂rt zu, was gerade passiert, und empf√§ngt Daten nur von √∂ffentlichen Nachrichten.  Erstellt keine Verbindungen. <br><br>  Aber mit <b>Central</b> und <b>Peripheral</b> interessanter.  Warum wurden sie nicht einfach Server-Client genannt?  Logischerweise nach dem Namen zu urteilen.  Aber nein. <br><br>  Weil Peripheral tats√§chlich als Server fungiert.  Dies ist ein Peripherieger√§t, das weniger Strom verbraucht und eine Verbindung zum leistungsst√§rkeren Central herstellt.  Peripheral kann Sie dar√ºber informieren, dass es in der N√§he ist und welche Dienste es hat.  Es kann nur ein Ger√§t eine Verbindung herstellen, und Peripheral verf√ºgt √ºber einige Daten.  Und Central kann die Luft nach Ger√§ten durchsuchen, Verbindungsanfragen senden, eine Verbindung zu einer beliebigen Anzahl von Ger√§ten herstellen, Daten von Peripheral lesen, schreiben und abonnieren. <br><br>  Worauf haben wir als Entwickler im Apple-√ñkosystem Zugriff? <br><br><h3>  Was steht uns zur Verf√ºgung? </h3><br>  <b>iOS / Mac OS:</b> <br><br><ul><li>  Peripherie und zentral. </li><li>  Hintergrundmodus. </li><li>  Wiederherstellung des Staates. </li><li>  Verbindungsintervall 15 ms. </li></ul><br>  <b>watchOS / tvOS:</b> <br><br><ul><li>  watchOS 4+ / tvOS 9+. </li><li>  Nur zentral. </li><li>  Maximal zwei Verbindungen. </li><li>  Apple Watch Serie 2+ / AppleTv 4+. </li><li>  Herunterfahren beim Aufrufen des Hintergrunds. </li><li>  Verbindungsintervall 30 ms. </li></ul><br>  Der wichtigste Unterschied ist das Verbindungsintervall.  Was betrifft es?  Um diese Frage zu beantworten, m√ºssen Sie zun√§chst verstehen, wie das Bluetooth LE-Protokoll funktioniert und warum ein so kleiner Unterschied in den absoluten Werten sehr wichtig ist. <br><br><h3>  Wie das Protokoll funktioniert </h3><br>  Wie ist der Such- und Verbindungsprozess? <br><br>  Peripheral meldet seine Anwesenheit bei der H√§ufigkeit des Werbeintervalls, sein Paket ist sehr klein und enth√§lt nur wenige vom Ger√§t bereitgestellte Dienstkennungen sowie den Ger√§tenamen.  Das Intervall kann sehr gro√ü sein und h√§ngt vom aktuellen Status des Ger√§ts, dem Energiesparmodus und anderen Einstellungen ab.  Apple empfiehlt Entwicklern externer Ger√§te, die L√§nge des Intervalls an den Beschleunigungsmesser zu binden: Erh√∂hen Sie das Intervall, wenn das Ger√§t nicht verwendet wird, und verringern Sie es, wenn es aktiv ist, um das Ger√§t schnell zu finden.  Das Ank√ºndigungsintervall korreliert nicht mit dem Verbindungsintervall und wird vom Ger√§t selbst abh√§ngig vom Stromverbrauch und seinen Einstellungen festgelegt.  Es ist im Apple-√ñkosystem nicht zug√§nglich und uns unbekannt, es wird vollst√§ndig vom System gesteuert. <br><br><img src="https://habrastorage.org/webt/na/_v/66/na_v662ojn9_xtvkdfma2wxyfaa.png"><br><br>  Nachdem wir das Ger√§t gefunden haben, senden wir eine Verbindungsanforderung, und hier tritt das Verbindungsintervall in die Szene ein - die Zeit, nach der das zweite Ger√§t auf die Anforderung antworten kann.  Aber dies ist beim Verbinden, aber was passiert beim Lesen / Schreiben? <br><br><img src="https://habrastorage.org/webt/iq/mv/hg/iqmvhgecmnlikziagjsbda4vxe0.png"><br><br>  Das Verbindungsintervall wird auch beim Lesen von Daten angezeigt. Durch zweimaliges Reduzieren wird die Daten√ºbertragungsrate erh√∂ht.  Sie m√ºssen jedoch verstehen, dass, wenn beide Ger√§te nicht dasselbe Intervall unterst√ºtzen, das Maximum ausgew√§hlt wird. <br><br>  Schauen wir uns an, woraus ein Informationspaket besteht, das Peripheral √ºbergibt. <br><br>  Die MTU (maximale √úbertragungseinheit) eines solchen Pakets wird w√§hrend des Verbindungsprozesses bestimmt und variiert von Ger√§t zu Ger√§t und abh√§ngig vom Betriebssystem.  In der Protokollversion 4.0 betrug die MTU etwa 30, und die Gr√∂√üe der Nutzlast √ºberschritt 20 Byte nicht.  In Version 4.2 hat sich alles ge√§ndert, jetzt k√∂nnen Sie ca. 520 Bytes √ºbertragen.  Leider unterst√ºtzen nur Ger√§te, die j√ºnger als das iPhone 5s sind, diese Version des Protokolls.  Die Gr√∂√üe des Overheads betr√§gt unabh√§ngig von der Gr√∂√üe der MTU 7 Byte: Dies schlie√üt ATT- und L2CAP-Header ein.  Mit der Aufzeichnung im Allgemeinen eine √§hnliche Situation. <br><br><img src="https://habrastorage.org/webt/gp/zi/ho/gpzihocxxa6po-lfmmlqyl5e7wu.png"><br><br>  Es gibt nur zwei Modi: mit und ohne Antwort.  Der unbeantwortete Modus beschleunigt die Daten√ºbertragung erheblich, da vor der n√§chsten Aufzeichnung kein Wartezeitintervall besteht.  Dieser Modus ist jedoch nicht immer verf√ºgbar, nicht auf allen Ger√§ten und nicht auf allen Systemen.  Der Zugriff auf diesen Aufzeichnungsmodus kann vom System selbst eingeschr√§nkt werden, da er als weniger energieeffizient angesehen wird.  In iOS gibt es eine Methode, mit der Sie vor der Aufzeichnung √ºberpr√ºfen k√∂nnen, ob dieser Modus verf√ºgbar ist. <br><br>  Schauen wir uns nun an, woraus das Protokoll besteht. <br><br><img src="https://habrastorage.org/webt/um/mh/um/ummhumgo7y_x3aeeu03wcv9shiy.png"><br><br>  Das Protokoll besteht aus 5 Ebenen.  <b>Die Anwendungsschicht</b> ist Ihre Logik, die √ºber CoreBluetooth beschrieben wird.  <b>GATT (Generic Attributes Layer)</b> wird verwendet, um Dienste und Eigenschaften auszutauschen, die sich auf den Ger√§ten befinden.  <b>ATT (Attributes Layer) wird</b> verwendet, um Ihre Eigenschaften zu verwalten und Ihre Daten zu √ºbertragen.  <b>L2CAP</b> ist ein Datenaustauschprotokoll auf niedriger Ebene.  <b>Controller</b> ist der BT-Chip selbst. <br><br>  <b>Sie fragen sich wahrscheinlich, was GATT ist und wie wir damit arbeiten k√∂nnen?</b> <br><br>  Das GATT besteht aus Funktionen und Diensten.  Ein Merkmal ist ein Objekt, in dem Ihre Daten wie eine Variable gespeichert sind.  Und ein Dienst ist eine Gruppe, in der sich Ihre Merkmale befinden, wie ein Namespace.  Der Dienst hat einen Namen - UUID, Sie w√§hlen ihn selbst aus.  Ein Dienst kann einen Nebendienst enthalten. <br><br><img src="https://habrastorage.org/webt/qs/cr/8k/qscr8kzsigratdfk7boemuqz_ri.png"><br><br>  Das Merkmal hat auch eine eigene <b>UUID</b> - tats√§chlich einen Namen.  <b>Der Wert des</b> Merkmals ist NSData. Hier k√∂nnen Sie Daten aufzeichnen und speichern.  <b>Deskriptoren</b> sind eine Beschreibung Ihres Merkmals. Sie k√∂nnen beschreiben, welche Daten Sie in diesem Merkmal erwarten oder was sie bedeuten.  Es gibt viele Deskriptoren im Bluetooth-Protokoll, aber bisher sind auf Apple-Systemen nur zwei verf√ºgbar: die menschliche Beschreibung und das Datenformat.  Es gibt auch Berechtigungen f√ºr Ihre Funktion: <br><br><img src="https://habrastorage.org/webt/xz/zh/kz/xzzhkzptblzhshwvso6kiiygtwe.png"><br><br><h3>  Lass es uns selbst versuchen </h3><br>  Wir hatten die Idee, Geld auf dem Luftweg zu √ºberweisen, ohne dass der Empf√§nger etwas ben√∂tigt.  Stellen Sie sich vor, Sie r√§tseln √ºber eine sehr interessante Aufgabe, schreiben den perfekten Code, und hier schl√§gt ein Kollege vor, Kaffee zu trinken.  Und Sie sind so begeistert von der Aufgabe, dass Sie nicht weggehen k√∂nnen und ihn bitten, Ihnen eine Tasse k√∂stlichen Cappuccino zu kaufen.  Er bringt dir Kaffee und du musst ihm das Geld zur√ºckgeben.  Sie k√∂nnen nach Telefonnummer √ºbersetzen, es funktioniert gut.  Aber hier ist eine unangenehme Situation - Sie kennen seine Nummer nicht.  Nun, so arbeitest du seit drei Jahren, aber sie haben keine Nummern ausgetauscht :) <br><br>  Aus diesem Grund haben wir uns entschlossen, Geld an Personen in der N√§he zu √ºberweisen, ohne Benutzerdaten eingeben zu m√ºssen.  Wie in AirDrop.  W√§hlen Sie einfach einen Benutzer aus und senden Sie den ben√∂tigten Betrag.  Mal sehen, was wir daf√ºr brauchen. <br><br><img src="https://habrastorage.org/webt/kp/tc/vs/kptcvsdcwhwapavwoxyq7h20nq4.png"><br><br><h3>  PUSH-Zuordnung </h3><br>  Wir brauchen den Absender: <br><br><ol><li>  Ich konnte alle Ger√§te in der N√§he finden und unseren Service unterst√ºtzen. </li><li>  Ich konnte die Details lesen. </li><li>  Und er konnte dem Empf√§nger eine Nachricht senden, dass er ihm das Geld erfolgreich geschickt hatte. </li></ol><br>  Der Empf√§nger muss seinerseits in der Lage sein, die umliegenden Absender dar√ºber zu informieren, dass er √ºber einen Dienst mit den erforderlichen Daten verf√ºgt, und Nachrichten vom Absender empfangen k√∂nnen.  Ich denke, es lohnt sich nicht zu beschreiben, wie der Prozess der Geld√ºberweisung durch Details bei unserer Bank abl√§uft.  Versuchen wir nun, dies umzusetzen. <br><br>  Zuerst m√ºssen Sie die Namen unserer Dienstleistungen und Merkmale finden.  Wie gesagt, das ist die UUID.  Wir generieren sie einfach und speichern sie auf Peripheral und Central, sodass sie auf beiden Ger√§ten gleich sind. <br><br><img src="https://habrastorage.org/webt/xp/bd/xi/xpbdxioazo7xd4wbnnluhmncbk4.png"><br><br>  Es steht Ihnen frei, UUIDs zu verwenden, mit Ausnahme derjenigen, die wie <b>folgt</b> enden: <b>XXXXXXXX- 0000-1000-8000-00805F9B34FB</b> - sie sind f√ºr verschiedene Unternehmen reserviert.  Sie selbst k√∂nnen eine solche Nummer kaufen und niemand wird sie verwenden.  Es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">kostet</a> 2500 Dollar. <br><br>  Als n√§chstes m√ºssen wir Manager erstellen: einen zum √úberweisen von Geldern, den anderen zum Empfangen.  Sie m√ºssen nur Delegaten angeben.  Wir werden Zentral senden, Peripherie empfangen.  Wir erstellen beide, weil sowohl der Absender als auch der Empf√§nger zu unterschiedlichen Zeiten eine Person sein k√∂nnen. <br><br><img src="https://habrastorage.org/webt/m3/vl/ta/m3vltagqi_tzwe8r6ayu70j3wyg.png"><br><br>  Jetzt m√ºssen wir es erm√∂glichen, den Empf√§nger zu erkennen und die Details des Empf√§ngers in unser Merkmal einzutragen. <br><br><img src="https://habrastorage.org/webt/ui/nf/hb/uinfhboh_hqspuyugii1xkukh1a.png"><br><br>  Erstellen Sie zun√§chst einen Dienst.  Wir werden die UUID registrieren und angeben, dass sie prim√§r ist - das hei√üt, der Dienst ist der Hauptdienst f√ºr dieses Ger√§t.  Ein gutes Beispiel: ein Herzfrequenzmesser, bei dem die aktuelle Herzfrequenz der Hauptdienst ist und der Batteriestatus eine sekund√§re Information ist. <br><br>  Als N√§chstes erstellen wir zwei Merkmale: eines zum Lesen der Details des Empf√§ngers und das zweite zum Schreiben, damit der Empf√§nger mehr √ºber das Senden von Geld erfahren kann.  Wir registrieren sie in unserem Dienst, f√ºgen sie dann dem Manager hinzu, starten die Ermittlung und geben die UUID des Dienstes an, damit alle Ger√§te in der N√§he Informationen zu unserem Dienst erhalten k√∂nnen, bevor sie eine Verbindung herstellen.  Diese Daten werden in das Paket gestellt, das Central w√§hrend der √úbertragung sendet. <br><br>  Der Empf√§nger ist bereit, fahren Sie mit dem Absender fort.  F√ºhren Sie die Suche aus und stellen Sie eine Verbindung her. <br><br><img src="https://habrastorage.org/webt/zq/d6/6j/zqd66jsw2k8gyb-chlj778dx_u8.png"><br><br>  Wenn Sie den Manager einschalten, starten wir mit unserem Service die Suche nach Ger√§ten.  Wenn wir sie finden, erhalten wir sie in der Delegate-Methode und stellen sofort eine Verbindung her.  Wichtig: Sie m√ºssen eine starke Verbindung zu allen Peripherieger√§ten aufrechterhalten, mit denen Sie arbeiten, da sie sonst auslaufen. <br><br><img src="https://habrastorage.org/webt/ll/ce/nf/llcenfrfgkrgdgxxy0wh2usf9-q.png"><br><br>  Nach erfolgreicher Verbindung konfigurieren wir den Delegaten, der mit diesem Ger√§t arbeiten wird, und wir erhalten den Dienst, den wir vom Ger√§t ben√∂tigen. <br><br><img src="https://habrastorage.org/webt/j3/f0/lh/j3f0lh82sza1lncds8ujfd4yoac.png"><br><br>  Wir haben uns erfolgreich mit dem Empf√§nger verbunden, jetzt m√ºssen Sie dessen Details lesen. <br><br>  Nach dem Verbinden haben wir bereits alle Dienste vom Ger√§t angefordert.  Nach dem Empfang wird die Delegate-Methode aufgerufen, in der alle auf diesem Ger√§t verf√ºgbaren Dienste aufgelistet sind.  Wir finden die richtige und fordern ihre Eigenschaften an.  Das Ergebnis kann von der UUID in der Delegate-Methode gefunden werden, die die Daten f√ºr die √úbersetzung speichert.  Wir versuchen sie zu lesen und bekommen in der Delegate-Methode wieder das Gew√ºnschte.  Alle Dienste, Merkmale und ihre Werte werden vom System zwischengespeichert, sodass es nicht erforderlich ist, sie jedes Mal sp√§ter anzufordern. <br><br><img src="https://habrastorage.org/webt/cn/e8/qh/cne8qh7dtbbir7q76abbpil4ywk.png"><br><br>  Das ist alles, wir haben Geld f√ºr Kaffee geschickt, es ist Zeit, dem Empf√§nger eine sch√∂ne Nachricht zu zeigen, damit er auf Rubel auf seinem Konto wartet.  Dazu m√ºssen Sie den Prozess des Sendens einer Nachricht implementieren. <br><br>  Wir erhalten das ben√∂tigte Merkmal vom Absender, in diesem Fall haben wir es dem gespeicherten Wert entnommen.  Aber vorher m√ºssen Sie es vom Ger√§t holen, wie wir es zuvor getan haben.  Und dann schreiben Sie einfach die Daten in das gew√ºnschte Merkmal. <br><br>  Danach erhalten wir auf dem anderen Ger√§t eine Schreibanforderung in der Delegate-Methode.  Hier k√∂nnen Sie die an Sie gesendeten Daten lesen, auf Fehler reagieren, z. B. keinen Zugriff haben oder diese Eigenschaft nicht vorhanden ist.  Alles wird funktionieren, aber nur, wenn beide Ger√§te eingeschaltet und Anwendungen aktiv sind.  Und wir m√ºssen im Hintergrund arbeiten! <br><br><img src="https://habrastorage.org/webt/3n/3x/4n/3n3x4no4wu9c95ej5nlmxrfc5g8.png"><br><br>  Mit Apple k√∂nnen Sie Bluetooth im Hintergrund verwenden.  Dazu m√ºssen Sie in info.plist den Schl√ºssel angeben, in welchem ‚Äã‚ÄãModus wir verwenden m√∂chten, in Peripheral oder Central. <br><br><img src="https://habrastorage.org/webt/e8/sk/ns/e8skns2rwruttrhvy1wagrcoppq.png"><br><br>  Als N√§chstes m√ºssen Sie im Manager den Wiederherstellungsschl√ºssel angeben und eine Delegatmethode erstellen.  Jetzt steht uns der Hintergrundmodus zur Verf√ºgung.  Wenn die Anwendung einschl√§ft oder aus dem Speicher entladen wird, wird sie beim Auffinden des gew√ºnschten Peripherieger√§ts oder beim Anschlie√üen von Central aktiviert und der Manager mit Ihrem Schl√ºssel wiederhergestellt. <br><br><img src="https://habrastorage.org/webt/7y/lz/xd/7ylzxdqlziqkiiqyby2ppkbcfws.png"><br><br>  Alles ist in Ordnung, bereit, ver√∂ffentlicht zu werden.  Aber hier kommen Designer zu uns gerannt und sagen: ‚ÄûWir m√∂chten Fotos von Benutzern einf√ºgen, damit sie sich leichter finden k√∂nnen.‚Äú  Was tun?  In unserer Eigenschaft k√∂nnen Sie nur etwa 500 Bytes schreiben, aber auf einigen Ger√§ten im Allgemeinen 20 :( <br><br><img src="https://habrastorage.org/webt/cu/dd/_l/cudd_lekcmzrpsmf-mz-9w7is0m.png"><br><br><h3>  Geh tiefer </h3><br>  Um dieses Problem zu l√∂sen, mussten wir tiefer gehen. <br><br><img src="https://habrastorage.org/webt/rt/bf/8h/rtbf8hlexfy42goqfvxs8mojyig.png"><br><br>  Jetzt haben wir mit Ger√§ten auf GATT / ATT-Ebene gesprochen.  In iOS 11 haben wir jedoch Zugriff auf das L2CAP-Protokoll.  In diesem Fall m√ºssen Sie sich jedoch selbst um die Daten√ºbertragung k√ºmmern.  Pakete werden mit 2 Kb MTU gesendet, es muss nichts neu codiert werden, es wird regul√§rer NSStream angewendet.  Datenraten bis zu 394 Kbit / s laut Apple. <br><br>  Angenommen, Sie √ºbertragen alle Daten Ihres Dienstes in Form normaler Merkmale von Peripheral nach Central.  Und ich brauchte, um den Kanal zu √∂ffnen.  Sie √∂ffnen es auf Peripheral, erhalten daf√ºr PSM - dies ist die Nummer des Kanals, mit dem Sie eine Verbindung herstellen k√∂nnen, und Sie m√ºssen es mit denselben Eigenschaften an Central √ºbertragen.  Die Nummer ist dynamisch, das System selbst w√§hlt aus, welches PSM gerade ge√∂ffnet werden soll.  Nach der √úbertragung k√∂nnen Sie bereits eine Verbindung zu Peripheral auf der Zentrale herstellen und Daten in einem f√ºr Sie geeigneten Format austauschen.  Schauen wir uns an, wie das geht. <br><br>  √ñffnen Sie zun√§chst den verschl√ºsselten Port von Peripheral.  Sie k√∂nnen dies ohne Verschl√ºsselung tun, dies beschleunigt die √úbertragung ein wenig. <br><br><img src="https://habrastorage.org/webt/ov/yd/ku/ovydkugm5hgyddaroucpcdjmaq0.png"><br><br>  Als n√§chstes erhalten wir in der Delegate-Methode das PSM und senden es an ein anderes Ger√§t. <br><br><img src="https://habrastorage.org/webt/tm/5g/bv/tm5gbvpsr1dbn8_x3jhg1btpth4.png"><br><br>  Nach dem Anschlie√üen eines anderen Ger√§ts werden wir als Methode bezeichnet, mit der wir den NSStream abrufen k√∂nnen, den wir f√ºr die √úbertragung vom Kanal ben√∂tigen. <br><br><img src="https://habrastorage.org/webt/nf/ec/kw/nfeckwjotne6tgzochcost5dr5g.png"><br><br>  Central ist noch einfacher, wir verbinden uns einfach mit der gew√ºnschten Nummer mit dem Kanal ... <br><br><img src="https://habrastorage.org/webt/oi/tm/hg/oitmhgdbpty9nmathmdnbhsisok.png"><br><br>  ... und danach bekommen wir die Streams, die wir brauchen.  In ihnen k√∂nnen Sie absolut alle Daten jeder Gr√∂√üe √ºbertragen und Ihr Protokoll auf L2CAP aufbauen.  Also haben wir die √úbertragung von Empf√§ngerfotos realisiert. <br><br><img src="https://habrastorage.org/webt/fq/hq/ha/fqhqha7vfucpkksx4whppmay_du.png"><br><br>  Aber es gibt Fallstricke, auf die man verzichten kann. <br><br><h3>  Fallstricke </h3><br>  Schauen wir uns die Fallstricke bei der Arbeit im Hintergrund an.  Da Ihnen die Rollen Peripheral und Central zur Verf√ºgung stehen, k√∂nnten Sie denken.  dass Sie im Hintergrund bestimmen k√∂nnen, welche Ger√§te sich im Hintergrund in der N√§he befinden und welche aktiv sind.  Theoretisch h√§tte es so sein sollen, aber Apple hat eine Einschr√§nkung eingef√ºhrt: Telefone im Hintergrund, ob zentral oder peripher, sind f√ºr andere Telefone, die sich ebenfalls im Hintergrund befinden, nicht verf√ºgbar.  Telefone im Hintergrund sind auf Nicht-iOS-Ger√§ten nicht sichtbar.  Schauen wir uns an, warum dies passiert. <br><br>  Wenn Ihr Ger√§t aktiv ist, sendet es ein regul√§res Broadcast-Paket, das den Ger√§tenamen und eine Liste der Dienste enthalten kann.  dass dieses Ger√§t bietet.  Und √úberlaufdaten sind alles, was nicht passte. <br><br><img src="https://habrastorage.org/webt/si/ca/ri/sicarigcdlr017kg1zpesa15psc.png"><br><br>  Wenn das Ger√§t in den Hintergrund tritt, √ºbertr√§gt es den Namen nicht und √ºbertr√§gt die Liste der unterst√ºtzten Dienste an √úberlaufdaten.  Wenn die Anwendung aktiv ist, liest sie diese Daten beim Scannen von einem iOS-Ger√§t und ignoriert sie beim Umschalten in den Hintergrund.  Wenn Sie zum Hintergrund wechseln, k√∂nnen Sie daher keine Anwendungen sehen, die sich ebenfalls im Hintergrund befinden.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Andere Apple-Betriebssysteme ignorieren √úberlaufdaten immer. Wenn Sie also nach Ger√§ten suchen, die Ihren Dienst unterst√ºtzen, erhalten Sie ein leeres Array. </font><font style="vertical-align: inherit;">Wenn Sie eine Verbindung zu jedem Ger√§t in der N√§he herstellen und unterst√ºtzte Dienste anfordern, enth√§lt die Liste m√∂glicherweise Ihren Dienst, und Sie k√∂nnen damit arbeiten. </font></font><br><br><img src="https://habrastorage.org/webt/nj/qc/s5/njqcs5ytnn4czeiumbsvwiqb3cu.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Dann machten wir uns bereit, sie zum Testen einzureichen, korrigierten kleinere Fehler und besch√§ftigten uns mit der Optimierung. </font><font style="vertical-align: inherit;">Und pl√∂tzlich, irgendwann, wurde dieser Fehler in der Konsole angezeigt:</font></font><br><br><pre><code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">124</span></span></code> </pre> <br>  Das Schlimmste war, dass keine Delegatenmethode aufgerufen wurde, wir konnten diesen Fehler f√ºr den Benutzer nicht einmal beseitigen.  Nur eine Nachricht im Protokoll - und Stille, alles erstarrte.  Da keine wesentlichen √Ñnderungen vorgenommen wurden, haben wir begonnen, die Commits zur√ºckzusetzen.  Und sie stellten fest, dass sie den Code einmal optimiert und die Art und Weise, Daten zu schreiben, √ºberarbeitet hatten.  Das Problem war, dass nicht alle Clients aktualisiert wurden, sodass dieser Fehler auftrat. <br><br><pre> <code class="javascript hljs">.write != .writeWithoutResponse</code> </pre> <br>  Wir waren froh, dass wir alles repariert haben, liefen lieber, um es zu testen, und sie kehrten fast sofort zu uns zur√ºck: ‚ÄûIhre Modefotos funktionieren nicht.  Sie sind alle unterladen. ‚Äú  Wir haben angefangen, es zu versuchen, und es ist wahr, dass manchmal auf verschiedenen Ger√§ten kaputte Fotos zu unterschiedlichen Zeiten auftreten.  Sie begannen nach einem Grund zu suchen. <br><br>  Und dann sahen sie wieder den vorherigen Fehler.  Dachte sofort, dass es in verschiedenen Versionen war.  Nach dem vollst√§ndigen Entfernen der alten Version von allen Testger√§ten wurde der Fehler jedoch weiterhin reproduziert.  Wir waren traurig ... <br><br><pre> <code class="javascript hljs">CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">722</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">249</span></span> CoreBluetooth[WARNING] Unknown error: <span class="hljs-number"><span class="hljs-number">312</span></span></code> </pre> <br>  Wir haben nach einem Debugging-Tool gesucht.  Das erste, was uns begegnete, war der Apple Bluetooth Explorer.  Als leistungsstarkes Programm kann es viele Dinge tun, aber zum Debuggen des Bluetooth LE-Protokolls gibt es eine kleine Registerkarte mit der Suche nach Ger√§ten und dem Abrufen von Merkmalen.  Und wir mussten L2CAP analysieren. <br><br>  Dann fanden sie LightBlue Explorer.  Es stellte sich heraus, dass es ein ziemlich anst√§ndiges Programm war, obwohl es ein Design von iOS 7 hatte. Es kann dasselbe wie Bluetooth Explorer und wei√ü auch, wie man Spezifikationen abonniert.  Und es funktioniert stabiler.  Alles ist in Ordnung, aber wieder ohne L2CAP. <br><br>  Und dann erinnerten wir uns an den bekannten WireShark-Schn√ºffler. <br><br>  Es stellte sich heraus, dass er mit Bluetooth LE vertraut war: Er kann L2CAP lesen, aber nur unter Windows.  Obwohl es nicht be√§ngstigend ist, dass wir Windows oder etwas anderes nicht finden.  Das gr√∂√üte Minus - das Programm funktioniert nur mit einem bestimmten Ger√§t.  Das hei√üt, Sie mussten das Ger√§t irgendwo im offiziellen Laden finden.  Und Sie selbst verstehen, dass ein gro√ües Unternehmen den Kauf eines unverst√§ndlichen Ger√§ts auf einem Flohmarkt wahrscheinlich nicht genehmigen wird.  Wir haben sogar angefangen, in Online-Shops in √úbersee zu st√∂bern. <br><br>  Aber hier fanden sie das PacketLogger-Programm in Additional Xcode Tools.  Sie k√∂nnen den Datenverkehr auf dem OS X-Ger√§t √ºberwachen.  Warum nicht unseren MoneyDrop unter OS X umschreiben?  Wir hatten bereits eine separate Bibliothek.  Wir haben gerade UIImage durch NSImage ersetzt, alles begann nach 10 Minuten. <br><br><img src="https://habrastorage.org/webt/vm/tn/z3/vmtnz3yw28-g7zsb8-cf6nldt6o.png"><br><br>  Schlie√ülich konnten wir die zwischen Ger√§ten ausgetauschten Pakete lesen.  Es wurde sofort klar, dass zum Zeitpunkt der Daten√ºbertragung √ºber L2CAP eines der Merkmale aufgezeichnet wurde.  Und aufgrund der Tatsache, dass der Kanal vollst√§ndig mit der √úbertragung von Fotos besch√§ftigt war, ignorierte iOS die Aufzeichnung und der Absender nach dem Ignorieren brach den Kanal.  Nach Behebung der Probleme mit der √úbertragung von Fotos wurde nicht. <br><br><img src="https://habrastorage.org/webt/ig/gw/sn/iggwsno_4bqfunmdzy0pigsn77i.png"><br><br>  Das ist alles, danke f√ºrs Lesen :) <br><br><h3>  <b>N√ºtzliche Links</b> </h3><br>  <b>WWDC / CoreBluetooth:</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://developer.apple.com/videos/play/wwdc2017/712/</a> </li><li>  WWDC 2012 Session 703 Core Bluetooth 101 </li><li>  WWDC 2012 Session 705 Advanced Core Bluetooth </li></ul><br>  <b>Bluetooth</b> <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">https://www.bluetooth.com/specifications/gatt</a> </li><li>  Erste Schritte mit Bluetooth Low Energy O'Reilly </li></ul><br>  <b>YouTube</b> <br><br><ul><li>  Pfeilelektronik ‚Üí Bluetooth Low Energy-Serie </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de452278/">https://habr.com/ru/post/de452278/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de452266/index.html">Serverlose Racks</a></li>
<li><a href="../de452268/index.html">C # WPF analog Window.ShowDialog () oder mit DispatcherFrame umgehen</a></li>
<li><a href="../de452270/index.html">Die Xamarin-API-Dokumentation ist jetzt √∂ffentlich verf√ºgbar</a></li>
<li><a href="../de452272/index.html">M√§dchen unter dem Wasserfall</a></li>
<li><a href="../de452276/index.html">Dropbox Client Reverse Engineering</a></li>
<li><a href="../de452280/index.html">PostgreSQL 11: Die Entwicklung der Partitionierung von Postgres 9.6 zu Postgres 11</a></li>
<li><a href="../de452282/index.html">Elementary, Watson: Sie integrieren sich in Voximplant</a></li>
<li><a href="../de452284/index.html">Klassifizierung der Landbedeckung mittels Eo-Learn. Teil 1</a></li>
<li><a href="../de452288/index.html">Situation: US-Mobilfunkbetreiber, denen illegaler Handel mit Geodaten von Abonnenten vorgeworfen wird</a></li>
<li><a href="../de452290/index.html">Was Hacker vermissen, wenn sie an PHDays eine Bank brechen</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>