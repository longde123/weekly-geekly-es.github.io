<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëêüèΩ üêò üëåüèæ Mengkonfigurasi pengiriman berkelanjutan di gitlab.com üñåÔ∏è ‚è≠Ô∏è üë©üèº‚Äçüç≥</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suatu kali saya berpikir untuk mengotomatiskan penyebaran proyek saya. gitlab.com dengan ramah menyediakan semua alat untuk ini, dan tentu saja saya m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Mengkonfigurasi pengiriman berkelanjutan di gitlab.com</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/449952/">  Suatu kali saya berpikir untuk mengotomatiskan penyebaran proyek saya.  gitlab.com dengan ramah menyediakan semua alat untuk ini, dan tentu saja saya memutuskan untuk menggunakannya setelah memilah dan menulis skrip penerapan kecil.  Dalam artikel ini, saya berbagi pengalaman saya dengan komunitas. <br><a name="habracut"></a><br><h3>  TL; DR </h3><br><ol><li>  Konfigurasi VPS: nonaktifkan root, login kata sandi, pasang dockerd, konfigurasikan ufw </li><li>  Hasilkan sertifikat untuk server dan klien <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://docs.docker.com/engine/security/" rel="nofollow">docs.docker.com/engine/security/https/#create-a-ca-server-and-client-keys-with-openssl</a> Aktifkan kontrol <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://docs.docker.com/engine/security/" rel="nofollow">dockerd</a> melalui soket tcp: hapus opsi -H fd: / / dari konfigurasi buruh pelabuhan. </li><li>  Daftarkan jalur sertifikat di docker.json </li><li>  Daftarkan dalam variabel gitlab dalam pengaturan CI / CD dengan konten sertifikat.  Tulis skrip .gitlab-ci.yml untuk penerapan. </li></ol><br>  Saya akan menunjukkan semua contoh pada kit distribusi Debian. <br><br><h3>  Pengaturan VPS awal </h3><br>  Jadi Anda membeli contoh misalnya pada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">DO</a> , hal pertama yang harus dilakukan adalah melindungi server Anda dari dunia luar yang agresif.  Saya tidak akan membuktikan dan mengklaim apa pun, cukup tampilkan log / var / log / pesan dari server virtual saya: <br><br><div class="spoiler">  <b class="spoiler_title">Tangkapan layar</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/1dc/3c5/054/1dc3c5054e545134f91441819476b8f4.png" alt="gambar"><br></div></div><br>  Pertama, instal ufw firewall: <br><br><pre><code class="plaintext hljs">apt-get update &amp;&amp; apt-get install ufw</code> </pre> <br>  Aktifkan kebijakan default: blokir semua koneksi masuk, izinkan semua koneksi keluar: <br><br><pre> <code class="plaintext hljs">ufw default deny incoming ufw default allow outgoing</code> </pre> <br>  Penting: jangan lupa untuk mengizinkan koneksi ssh: <br><br><pre> <code class="plaintext hljs">ufw allow OpenSSH</code> </pre> <br>  Sintaks umumnya adalah: Izinkan koneksi port: ufw allow 12345, di mana 12345 adalah nomor port atau nama layanan.  Tolak: ufw deny 12345 <br><br>  Nyalakan firewall: <br><br><pre> <code class="plaintext hljs">ufw enable</code> </pre> <br>  Kami meninggalkan sesi dan masuk lagi melalui ssh. <br><br>  Tambahkan pengguna, berikan dia kata sandi dan tambahkan dia ke grup sudo. <br><br><pre> <code class="plaintext hljs">apt-get install sudo adduser scoty usermod -aG sudo scoty</code> </pre> <br>  Selanjutnya, sesuai rencana, Anda harus menonaktifkan entri kata sandi.  Untuk melakukan ini, salin kunci ssh Anda ke server: <br><br><pre> <code class="plaintext hljs">ssh-copy-id root@10.101.10.28</code> </pre> <br>  IP server Anda harus ditentukan.  Coba sekarang untuk login di bawah pengguna yang dibuat sebelumnya, Anda tidak perlu lagi memasukkan kata sandi.  Selanjutnya, dalam pengaturan konfigurasi, ubah yang berikut: <br><br><pre> <code class="plaintext hljs">sudo nano /etc/ssh/sshd_config</code> </pre> <br>  nonaktifkan entri kata sandi: <br><br><pre> <code class="plaintext hljs">PasswordAuthentication no</code> </pre> <br>  Mulai kembali daemon sshd: <br><br><pre> <code class="plaintext hljs">sudo systemctl reload sshd</code> </pre> <br>  Sekarang, jika Anda atau orang lain mencoba masuk sebagai root, itu tidak akan berhasil. <br><br>  Selanjutnya, atur dockerd, saya tidak akan menjelaskan prosesnya di sini, karena semuanya sudah dapat diubah, ikuti tautan ke situs web resmi dan lakukan langkah-langkah untuk menginstal buruh pelabuhan di mesin virtual Anda: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">https://docs.docker.com/install/linux/docker- ce / debian /</a> <br><br><h3>  Pembuatan Sertifikat </h3><br>  Untuk mengelola daemon buruh pelabuhan dari jarak jauh, diperlukan koneksi TLS terenkripsi.  Untuk melakukan ini, Anda harus memiliki sertifikat dan kunci, yang harus dibuat dan ditransfer ke mesin jarak jauh Anda.  Ikuti langkah-langkah yang diberikan dalam instruksi di situs buruh pelabuhan resmi: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=https://docs.docker.com/engine/security/" rel="nofollow">https://docs.docker.com/engine/security/https/#create-a-ca-server-and-client-keys-with-openssl</a> Semua dihasilkan * .pem file untuk server, yaitu ca.pem, server.pem, key.pem harus ditempatkan di direktori / etc / docker di server. <br><br><h3>  Pengaturan Dockerd </h3><br>  Dalam skrip untuk meluncurkan daemon buruh pelabuhan, hapus opsi -H df: //, opsi ini menjawab host mana yang dapat mengendalikan daemon buruh pelabuhan. <br><br><pre> <code class="plaintext hljs"># At /lib/systemd/system/docker.service [Service] Type=notify ExecStart=/usr/bin/dockerd</code> </pre> <br>  Selanjutnya, buat file pengaturan, jika belum ada dan tentukan opsi: <br><br><div class="spoiler">  <b class="spoiler_title">/etc/docker/daemon.json</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">{ "hosts": [ "unix:///var/run/docker.sock", "tcp://0.0.0.0:2376" ], "labels": [ "is-our-remote-engine=true" ], "tls": true, "tlscacert": "/etc/docker/ca.pem", "tlscert": "/etc/docker/server.pem", "tlskey": "/etc/docker/key.pem", "tlsverify": true }</code> </pre> <br></div></div><br>  Mari kita aktifkan koneksi di port 2376: <br><br><pre> <code class="plaintext hljs">sudo ufw allow 2376</code> </pre> <br>  Mulai ulang dockerd dengan pengaturan baru: <br><br><pre> <code class="plaintext hljs">sudo systemctl daemon-reload &amp;&amp; sudo systemctl restart docker</code> </pre> <br>  Periksa: <br><br><pre> <code class="plaintext hljs">sudo systemctl status docker</code> </pre> <br>  Jika semuanya berwarna hijau, maka kami percaya bahwa kami telah berhasil mengkonfigurasi buruh pelabuhan di server. <br><br><h3>  Mengkonfigurasi pengiriman berkelanjutan pada gitlab </h3><br>  Agar pekerja gitalab dapat menjalankan perintah pada host jarak jauh buruh pelabuhan, perlu untuk menentukan bagaimana dan di mana menyimpan sertifikat dan kunci untuk koneksi terenkripsi dengan dockerd.  Saya memecahkan masalah ini dengan hanya menuliskannya ke dalam variabel di pengaturan gitlbab: <br><br><div class="spoiler">  <b class="spoiler_title">Judul spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/221/806/3d9/2218063d98a375d36e38fcb214a36bb7.png" alt="gambar"><br></div></div><br>  Cukup tampilkan konten sertifikat dan kunci melalui cat: <code>cat ca.pem</code> .  Salin dan tempel ke nilai variabel. <br><br>  Mari kita menulis skrip untuk penyebaran melalui gitlab.  Gambar docker-in-docker (dind) akan digunakan. <br><br><div class="spoiler">  <b class="spoiler_title">.gitlab-ci.yml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">image: name: docker/compose:1.23.2 #  entrypoint ,    dind entrypoint: ["/bin/sh", "-c"] variables: DOCKER_HOST: tcp://docker:2375/ DOCKER_DRIVER: overlay2 services: - docker:dind stages: - deploy deploy: stage: deploy script: - bin/deploy.sh #   </code> </pre><br></div></div><br>  Konten skrip penerapan dengan komentar: <br><br><div class="spoiler">  <b class="spoiler_title">bin / deploy.sh</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">#!/usr/bin/env sh #  ,   -  set -e # ,  ,   set -v # DOCKER_COMPOSE_FILE=docker-compose.yml #   DEPLOY_HOST=185.241.52.28 #    ,      - gitlab- DOCKER_CERT_PATH=/root/.docker # ,      docker info docker-compose version #   (    -  gitlab') mkdir $DOCKER_CERT_PATH #   ,         . echo "$CA_PEM" | tr -d '\r' &gt; $DOCKER_CERT_PATH/ca.pem echo "$CERT_PEM" | tr -d '\r' &gt; $DOCKER_CERT_PATH/cert.pem echo "$KEY_PEM" | tr -d '\r' &gt; $DOCKER_CERT_PATH/key.pem #       chmod 400 $DOCKER_CERT_PATH/ca.pem chmod 400 $DOCKER_CERT_PATH/cert.pem chmod 400 $DOCKER_CERT_PATH/key.pem #       docker-. ,   export DOCKER_TLS_VERIFY=1 export DOCKER_HOST=tcp://$DEPLOY_HOST:2376 # ,     docker-compose \ -f $DOCKER_COMPOSE_FILE \ ps #   docker-,     ""  docker login -u $DOCKER_USER -p $DOCKER_PASSWORD docker-compose \ -f $DOCKER_COMPOSE_FILE \ pull app #   docker-compose \ -f $DOCKER_COMPOSE_FILE \ up -d app</code> </pre><br></div></div><br>  Masalah utama adalah ‚Äúmengekstraksi‚Äù isi sertifikat dalam bentuk normal dari variabel gitlab CI / CD.  Saya tidak mengerti mengapa koneksi ke host jarak jauh tidak berfungsi.  Di tuan rumah, saya melihat jurnal buruh pelabuhan sudo journalctl -u, ada kesalahan jabat tangan.  Saya memutuskan untuk melihat apa yang umumnya disimpan dalam variabel, untuk ini Anda dapat melihat cat -A $ DOCKER_CERT_PATH / key.pem.  Kesalahan ini diatasi dengan menambahkan penghapusan simbol carriage tr -d '\ r'. <br><br>  Selanjutnya dalam skrip, Anda dapat menambahkan tugas pasca-rilis sesuai kebijakan Anda.  Anda dapat melihat versi yang berfungsi di repositori saya <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=" rel="nofollow">https://gitlab.com/isqad/gitlab-ci-cd</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id449952/">https://habr.com/ru/post/id449952/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id449940/index.html">Cara memeras 16 GB memori ke motherboard yang tidak mendukung jumlah ini</a></li>
<li><a href="../id449942/index.html">Bagaimana kami menguji fitur dari TK hingga pasca produksi dan menjaga hubungan persahabatan di dalam tim</a></li>
<li><a href="../id449944/index.html">Docker: Tip Buruk</a></li>
<li><a href="../id449946/index.html">Tales Pengembang 1C: admin</a></li>
<li><a href="../id449948/index.html">JavaScript: 7 hal kecil yang bermanfaat</a></li>
<li><a href="../id449954/index.html">Instal Zimbra Open-Source Edition pada CentOS 7</a></li>
<li><a href="../id449956/index.html">AI @ MIPT: Data besar untuk model matematika genom manusia</a></li>
<li><a href="../id449960/index.html">Sumber inspirasi saat berkembang untuk UDB</a></li>
<li><a href="../id449966/index.html">Tabel dalam Figma. Desain Kisi Data oleh Satu Komponen</a></li>
<li><a href="../id449968/index.html">Redmadrobot membahas AppsConf 2019: video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>