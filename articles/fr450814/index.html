<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêò üï£ üßëüèΩ‚Äçü§ù‚ÄçüßëüèΩ Comment BGP fonctionne üëØ ‚úåüèº ‚ôàÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Aujourd'hui, nous examinons le protocole BGP. Nous ne parlerons pas longtemps pourquoi il est et pourquoi il est utilis√© comme seul protocole. Beaucou...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment BGP fonctionne</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450814/">  Aujourd'hui, nous examinons le protocole BGP.  Nous ne parlerons pas longtemps pourquoi il est et pourquoi il est utilis√© comme seul protocole.  Beaucoup d'informations sont √† ce sujet, par exemple <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Alors, quel est BGP?  BGP est un protocole de routage dynamique qui est le seul protocole EGP (External Gateway Protocol).  Ce protocole est utilis√© pour cr√©er un routage sur Internet.  Consid√©rez comment le voisinage entre deux routeurs BGP est construit. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/3fa/da6/dd3/3fada6dd3c41923367af475da9b0ae10.jpg" alt="Mon image"></a> <br>  Consid√©rez le voisinage entre Router1 et Router3.  Nous les configurerons √† l'aide des commandes suivantes: <a name="habracut"></a><br><pre><code class="plaintext hljs">router bgp 10 network 192.168.12.0 network 192.168.13.0 neighbor 192.168.13.3 remote-as 10 router bgp 10 network 192.168.13.0 network 192.168.24.0 neighbor 192.168.13.1 remote-as 10</code> </pre> <br>  Le voisinage au sein d'un syst√®me autonome est AS 10. Apr√®s avoir entr√© des donn√©es sur un routeur, par exemple sur Router1, ce routeur essaie d'√©tablir une relation de voisinage avec Router3.  L'√©tat initial lorsque rien ne se produit est appel√© <b>Idle</b> .  D√®s que bgp est configur√© sur Router1, il commencera √† √©couter le port TCP 179 - il passera √† l'√©tat <b>Connect</b> et lorsqu'il essaiera d'ouvrir une session avec Router3, il passera √† l'√©tat <b>Active</b> . <br><br>  Une fois la session √©tablie entre Router1 et Router3, un √©change de messages ouvert a lieu.  Lorsque ce message est envoy√© par Router1, cet √©tat sera appel√© <b>Open Sent</b> .  Et lorsqu'il re√ßoit un message d'ouverture de Router3, il passe √† l'√©tat <b>Open Confirm</b> .  Consid√©rez le poste ouvert plus en d√©tail: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d9d/231/607/d9d2316070de22049a24da6d86cecb2b.jpg" alt="Mon image"></a> <br>  Ce message transmet des informations sur le protocole BGP que le routeur utilise.  En √©changeant des messages ouverts, Router1 et Router3 se communiquent mutuellement des informations sur leurs param√®tres.  Les param√®tres suivants sont transmis: <br><blockquote><ul><li>  <b>Version</b> : cela inclut la version BGP que le routeur utilise.  La version actuelle de BGP est la version 4 qui est d√©crite dans la RFC 4271. Deux routeurs BGP essaieront de n√©gocier une version compatible, quand il y a un d√©calage alors il n'y aura pas de session BGP. </li><li>  <b>Mon AS</b> : cela inclut le num√©ro AS du routeur BGP, les routeurs devront se mettre d'accord sur le (s) num√©ro (s) AS et il d√©finit √©galement s'ils ex√©cuteront iBGP ou eBGP. </li><li>  <b>Temps</b> de maintien: si BGP ne re√ßoit aucun message de pers√©v√©rance ou de mise √† jour de l'autre c√¥t√© pendant la dur√©e du temps de maintien, il d√©clarera l'autre c√¥t√© ¬´mort¬ª et d√©truira la session BGP.  Par d√©faut, le temps d'attente est d√©fini sur 180 secondes sur les routeurs Cisco IOS, le message keepalive est envoy√© toutes les 60 secondes.  Les deux routeurs doivent se mettre d'accord sur le temps d'attente ou il n'y aura pas de session BGP. </li><li>  <b>Identifiant BGP</b> : il s'agit de l'ID de routeur BGP local qui est √©lu comme OSPF: <br><ul><li>  Utilisez l'ID de routeur configur√© manuellement avec la commande bgp router-id. </li><li>  Utilisez l'adresse IP la plus √©lev√©e sur une interface de bouclage. </li><li>  Utilisez l'adresse IP la plus √©lev√©e sur une interface physique. </li></ul></li><li>  <b>Param√®tres optionnels</b> : vous trouverez ici quelques fonctionnalit√©s optionnelles du routeur BGP.  Ce champ a √©t√© ajout√© afin que de nouvelles fonctionnalit√©s puissent √™tre ajout√©es √† BGP sans avoir √† cr√©er une nouvelle version. Les choses que vous pourriez trouver ici sont: <br><br><ul><li>  prise en charge de MP-BGP (BGP multiprotocole). </li><li>  prise en charge de Route Refresh. </li><li>  prise en charge des num√©ros AS √† 4 octets. </li></ul></li></ul></blockquote>  Pour √©tablir un quartier, les conditions suivantes doivent √™tre remplies: <br><br><ul><li>  Num√©ro de version.  Version actuelle 4. </li><li>  Le num√©ro AS doit correspondre √† celui que vous avez configur√© le <b>voisin 192.168.13.3 √† distance en tant que 10</b> . </li><li>  L'ID du routeur doit √™tre diff√©rent du voisin. </li></ul><br>  Si l'un des param√®tres ne remplit pas ces conditions, le routeur enverra un message de <b>notification</b> o√π il indique une erreur.  Apr√®s l'envoi et la r√©ception de messages ouverts, la relation de voisinage entre dans l'√©tat <b>ESTABLISHED</b> .  Apr√®s cela, les routeurs peuvent √©changer des informations sur les itin√©raires et le faire en utilisant des messages de <b>mise</b> √† <b>jour</b> .  Voici un message de mise √† jour qui envoie Router1 √† Router3: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Mon image"></a> <br><br>  Indiquez ici les r√©seaux signal√©s par les attributs Router1 et Path, qui sont analogues aux m√©triques.  Nous parlerons plus en d√©tail des attributs Path.  De plus, les messages keepalive sont transmis dans la session TCP.  Ils sont transmis, par d√©faut, toutes les 60 secondes.  Ceci est une minuterie Keepalive.  Si le message Keepalive n'est pas re√ßu pendant la temporisation de mise en attente, cela signifie une perte de communication avec le voisin.  Par d√©faut, il est √©gal √† - 180 secondes. <br><br>  Assiette utile: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/853/f42/1f0/853f421f0a69f407c5ae4eae3423240c.jpg" alt="Mon image"></a> <br><br>  Il semble avoir compris comment les routeurs se transmettent des informations, essayons maintenant de comprendre la logique du protocole BGP. <br><br>  Pour publier un itin√©raire vers la table BGP, comme dans les protocoles IGP, la commande r√©seau est utilis√©e, mais la logique de fonctionnement est diff√©rente.  Si dans IGP, apr√®s avoir sp√©cifi√© une route dans la commande r√©seau, IGP regarde quelles interfaces appartiennent √† ce sous-r√©seau et les inclut dans sa table, puis la commande r√©seau dans BGP regarde dans la table de routage et recherche une correspondance <b>exacte</b> avec la route dans la commande r√©seau.  S'ils sont trouv√©s, ces itin√©raires tomberont dans la table BGP. <br><blockquote>  Recherchez une route dans la table de routage IP actuelle du routeur qui correspond exactement aux param√®tres de la commande r√©seau;  si la route IP existe, mettez l'√©quivalent NLRI dans la table BGP locale. </blockquote>  Nous allons maintenant augmenter le BGP √† tous les autres et voir comment l'itin√©raire est s√©lectionn√© dans un AS.  Une fois que le routeur BGP a re√ßu les routes du voisin, la s√©lection de la route optimale commence.  Ici, vous devez comprendre quel type de voisins peuvent √™tre - internes et externes.  Le routeur de configuration comprend-il si le voisin configur√© est interne ou externe?  En √©quipe: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.13.3 remote-as 10</code> </pre> <br>  en tant que param√®tre remote-as, l'AS est sp√©cifi√©, qui est configur√© sur le routeur lui-m√™me dans la commande router bgp 10. Les routes qui proviennent de l'AS interne sont consid√©r√©es comme internes et les routes de l'AS externe sont consid√©r√©es comme externes.  Et pour chacun, une logique diff√©rente de r√©ception et d'envoi d'≈ìuvres.  Consid√©rez la topologie suivante: <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/cea/5f8/2b0/cea5f82b050662b2632cab01f3de8e24.jpg" alt="Mon image"></a> <br><br>  Chaque routeur a une interface de bouclage configur√©e avec ip: xxxx 255.255.255.0 - o√π x est le num√©ro du routeur.  Sur Router9, nous avons une interface de bouclage avec l'adresse - 9.9.9.9 255.255.255.0.  Nous l'annoncerons sur BGP et verrons comment il est distribu√©.  Cette route sera transmise au routeur 8 et au routeur 12.  Avec Router8, cette route ira vers Router6, mais sur Router5, elle ne sera pas dans la table de routage.  En outre, sur Router12, cette route entrera dans la table, mais sur Router11, ce ne sera pas non plus.  Essayons de le comprendre.  Consid√©rez quelles donn√©es et quels param√®tres sont transmis par Router9 √† ses voisins, en signalant cette route.  Le paquet ci-dessous sera envoy√© du routeur 9 au routeur 8. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/5e7/80b/ca0/5e780bca084e8f42dab14d03f62723b6.jpg" alt="Mon image"></a> <br>  Les informations d'itin√©raire se composent d'attributs Path. <br><br>  Les attributs de chemin sont divis√©s en 4 cat√©gories: <br><br><ol><li>  <b>Bien connu obligatoire</b> - Tous les routeurs BGP doivent reconna√Ætre ces attributs.  Doit √™tre pr√©sent dans toutes les mises √† jour. </li><li>  <b>Discr√©tionnaire bien connu</b> - Tous les routeurs BGP doivent reconna√Ætre ces attributs.  Ils peuvent √™tre pr√©sents dans les mises √† jour, mais leur pr√©sence n'est pas n√©cessaire. </li><li>  <b>Transitif facultatif</b> - peut ne pas √™tre reconnu par toutes les impl√©mentations BGP.  Si le routeur ne reconna√Æt pas l'attribut, il marque la mise √† jour comme partielle et l'envoie plus loin aux voisins, en pr√©servant l'attribut non reconnu. </li><li>  <b>Facultatif non transitif</b> - peut ne pas √™tre reconnu par toutes les impl√©mentations BGP.  Si le routeur ne reconna√Æt pas l'attribut, l'attribut est ignor√© et est rejet√© lors de la transmission aux voisins. </li></ol><br>  Exemples d'attributs BGP: <br><br><ul><li>  <b>Obligatoire bien connu</b> : <br><ul><li>  Chemin du syst√®me autonome </li><li>  Saut suivant </li><li>  Origine </li></ul><br></li><li>  <b>Discr√©tionnaire bien connu</b> : <br><ul><li>  Pr√©f√©rence locale </li><li>  Agr√©gat atomique </li></ul></li><li>  <b>Transitif facultatif</b> : <br><ul><li>  Agr√©gateur </li><li>  Communaut√©s </li></ul></li><li>  <b>Option non transitive</b> : <br><ul><li>  Discriminateur √† sorties multiples (MED) </li><li>  Identifiant de l'initiateur </li><li>  Liste des clusters </li></ul></li></ul><br>  Dans ce cas, nous serons int√©ress√©s par Origin, Next-hop, AS Path.  √âtant donn√© que l'itin√©raire passe entre Router8 et Router9, c'est-√†-dire √† l'int√©rieur du m√™me AS, il est consid√©r√© comme interne et nous ferons attention √† Origin. <br><br>  Attribut d'origine - indique comment l'itin√©raire a √©t√© re√ßu dans la mise √† jour.  Valeurs d'attribut possibles: <br><br><ul><li>  0 - IGP: NLRI obtenu √† l'int√©rieur du syst√®me autonome d'origine; </li><li>  1 - EGP: NLRI appris par l'Ext√©rieur Gateway Protocol (EGP).  Pr√©d√©cesseur BGP, non utilis√© </li><li>  2 - Incomplet: NLRI a √©t√© appris d'une autre mani√®re </li></ul><br>  Dans notre cas, comme le montre le paquet, c'est 0. Lorsque cette route est transmise au routeur 12, alors ce code aura le code - 1. <br><br>  Ensuite, Next-hop.  Attribut de saut suivant <br><br><ul><li>  Il s'agit de l'adresse IP du routeur eBGP par laquelle passe le chemin vers le r√©seau de destination. </li><li>  L'attribut change lorsque le pr√©fixe est transmis √† un autre AS. </li></ul><br>  Dans le cas d'iBGP, c'est-√†-dire √† l'int√©rieur d'un AS, Next-hop sera indiqu√© celui qui a appris ou parl√© de cette route.  Dans notre cas, ce sera 192.168.89.9.  Mais quand il transf√©rera cette route de Router8 √† Router6, Router8 la changera et la remplacera par la sienne.  Le prochain saut sera - 192.168.68.8.  Cela nous am√®ne √† deux r√®gles: <br><br><ol><li>  Si le routeur transmet la route √† son voisin interne, il ne modifie pas le param√®tre Next-hop. </li><li>  Si le routeur envoie la route √† son voisin externe, il change le Next-hop en ip de l'interface √† partir de laquelle ce routeur envoie. </li></ol><br>  Cela nous am√®ne √† comprendre le premier probl√®me - Pourquoi il n'y aura pas de route dans la table de routage sur Router5 et Router11.  Examinons plus en d√©tail.  Ainsi, Router6 a re√ßu les informations d'itin√©raire 9.9.9.0/24 et les a ajout√©es en toute s√©curit√© √† la table de routage: <br><br><pre> <code class="plaintext hljs">Router6#show ip route bgp Codes: L - local, C - connected, S - static, R - RIP, M - mobile, B - BGP D - EIGRP, EX - EIGRP external, O - OSPF, IA - OSPF inter area N1 - OSPF NSSA external type 1, N2 - OSPF NSSA external type 2 E1 - OSPF external type 1, E2 - OSPF external type 2 i - IS-IS, su - IS-IS summary, L1 - IS-IS level-1, L2 - IS-IS level-2 ia - IS-IS inter area, * - candidate default, U - per-user static route o - ODR, P - periodic downloaded static route, H - NHRP, l - LISP a - application route + - replicated route, % - next hop override, p - overrides from PfR Gateway of last resort is not set 9.0.0.0/24 is subnetted, 1 subnets B 9.9.9.0 [20/0] via 192.168.68.8, 00:38:25</code> </pre> <br>  Maintenant, Router6 a d√©pass√© la route Router5 et n'a pas modifi√© la premi√®re r√®gle de saut suivant.  Autrement dit, Router5 devrait ajouter <b>9.9.9.0 [20/0] via 192.168.68.8</b> , mais il n'a pas de route vers 192.168.68.8 et donc cette route ne sera pas ajout√©e, bien que les informations sur cette route soient stock√©es dans la table BGP: <br><br><pre> <code class="plaintext hljs">&lt;b&gt;Router5#show ip bgp BGP table version is 1, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * i 9.9.9.0/24 192.168.68.8 0 100 0 45 i&lt;/b&gt;</code> </pre> <br>  La m√™me situation se produira entre Router11-Router12.  Afin d'√©viter une telle situation, il est n√©cessaire de configurer de sorte que Router6 ou Router12, en passant la route √† leurs voisins internes, substitue leur adresse IP en Next-hop.  Cela se fait √† l'aide de la commande: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.56.5 next-hop-self</code> </pre> <br>  Apr√®s cette commande, Router6 enverra un message de mise √† jour, o√π pour les routes comme Next-hop l'adresse IP de l'interface Gi0 / 0 de Router6 sera indiqu√©e - 192.168.56.6, apr√®s quoi cette route sera d√©j√† dans la table de routage. <br><br>  Allons de l'avant et voyons si cette route appara√Æt sur Router7 et Router10.  Il n'appara√Ætra pas dans la table de routage et nous pourrions penser que le probl√®me est comme dans le premier avec le param√®tre Next-hop, mais si nous regardons la sortie de la commande show ip bgp, nous verrons que la route n'y a pas √©t√© re√ßue m√™me avec le mauvais Next-hop, qui signifie que l'itin√©raire n'a m√™me pas √©t√© transmis.  Et cela nous conduira √† l'existence d'une autre r√®gle: <br><blockquote>  Les itin√©raires re√ßus de voisins internes ne sont pas transf√©r√©s √† d'autres voisins internes. </blockquote>  √âtant donn√© que le routeur 5 a re√ßu l'itin√©raire du routeur 6, il ne sera pas transmis √† son autre voisin interne.  Pour que le transfert se produise, vous devez configurer la fonction <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Route Reflector</a> ou configurer des relations de voisinage enti√®rement connect√©es (Full Mesh), c'est-√†-dire que Router5-7 sera chacun un voisin.  Nous utiliserons le Route Reflector dans ce cas.  Sur Router5, vous devez utiliser cette commande: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.57.7 route-reflector-client</code> </pre> <br>  Route-Reflector change le comportement de BGP lors de la transmission d'une route √† un voisin interne.  Si le voisin interne est sp√©cifi√© en tant que <b>client-r√©flecteur</b> de <b>route</b> , les routes internes seront annonc√©es √† ces clients. <br><br>  La route n'appara√Æt-elle pas sur Router7?  N'oubliez pas le Next-hop √©galement.  Apr√®s ces manipulations, la route devrait √©galement sur Router7, mais cela ne se produit pas.  Cela nous am√®ne √† une autre r√®gle: <br><blockquote>  La r√®gle de saut suivant ne fonctionne que pour les routes externes.  Pour les routes internes, l'attribut de saut suivant n'est pas remplac√©. </blockquote><br>  Et nous obtenons une situation dans laquelle vous devez cr√©er un environnement utilisant le routage statique ou IGP pour informer les routeurs de toutes les routes √† l'int√©rieur de l'AS.  Nous enregistrerons les routes statiques sur Router6 et Router7 et apr√®s cela, nous obtiendrons la route souhait√©e dans le tableau du routeur.  Dans AS 678, nous agirons un peu diff√©remment - nous √©crirons les routes statiques pour 192.168.112.0/24 sur Router10 et 192.168.110.0/24 sur Router12.  Ensuite, nous √©tablissons la relation de voisinage entre Router10 et Router12.  Nous configurons √©galement Router12 pour envoyer son prochain bond pour Router10: <br><br><pre> <code class="plaintext hljs">neighbor 192.168.110.10 next-hop-self</code> </pre> <br>  Le r√©sultat sera que Router10 recevra la route 9.9.9.0/24, elle sera re√ßue √† la fois de Router7 et Router12.  Voyons quel choix Router10 fait: <br><br><pre> <code class="plaintext hljs">Router10#show ip bgp BGP table version is 3, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.112.12 0 100 0 45 i 192.168.107.7 0 123 45 i</code> </pre> <br>  Comme nous pouvons le voir, deux itin√©raires et une fl√®che (&gt;) signifient que l'itin√©raire via 192.168.112.12 est s√©lectionn√©. <br>  Voyons comment se d√©roule le processus de s√©lection d'itin√©raire: <br><br><ol><li>  Tout d'abord, √† r√©ception de l'itin√©raire, la disponibilit√© de son Next-hop est v√©rifi√©e.  C'est pourquoi, lorsque nous avons re√ßu une route sur Router5 sans d√©finir Next-hop-self, cette route n'a plus √©t√© soumise pour traitement. </li><li>  Vient ensuite le param√®tre Weight.  Ce param√®tre n'est pas un attribut de chemin (PA) et n'est pas transmis dans les messages BGP.  Il est configur√© localement sur chaque routeur et n'est utilis√© que pour manipuler la s√©lection d'itin√©raire sur le routeur lui-m√™me.  Prenons un exemple.  Il est montr√© ci-dessus que Router10 a choisi la route pour 9.9.9.0/24 via Router12 (192.168.112.12).  Pour modifier le param√®tre Wieght, vous pouvez utiliser route-map pour d√©finir des itin√©raires sp√©cifiques ou attribuer un poids √† son voisin √† l'aide de la commande: <br><br><pre> <code class="plaintext hljs"> neighbor 192.168.107.7 weight 200</code> </pre> <br>  Maintenant, toutes les routes de ce voisin auront un tel poids.  Voyons comment le choix de l'itin√©raire change apr√®s cette manipulation: <br><br><pre> <code class="plaintext hljs">Router10#show bgp *Mar 2 11:58:13.956: %SYS-5-CONFIG_I: Configured from console by console BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 192.168.107.7 200 123 45 i * i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Comme vous pouvez le voir, l'itin√©raire via Router7 est maintenant s√©lectionn√©, mais cela n'aura aucun effet sur les autres routeurs. </li><li>  En troisi√®me place, nous avons - Pr√©f√©rence locale.  Ce param√®tre est un attribut discr√©tionnaire bien connu, ce qui signifie que sa pr√©sence est facultative.  Ce param√®tre n'est valide que dans un seul AS et affecte le choix du chemin uniquement pour les voisins internes.  C'est pourquoi, il n'est transmis que dans les messages de mise √† jour destin√©s au voisin interne.  Dans les messages de mise √† jour pour les voisins externes, il est absent.  Par cons√©quent, il a √©t√© affect√© au discr√©tionnaire bien connu.  Essayons de l'appliquer sur Router5.  Sur Router5, nous devrions avoir deux routes pour 9.9.9.0/24 - une via Router6 et la seconde via Router7. <br><br>  Nous regardons: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 2, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i</code> </pre> <br>  Mais comme vous pouvez voir un itin√©raire via Router6.  Et o√π est l'itin√©raire via Router7?  Peut-√™tre qu'il n'existe m√™me pas sur Router7?  Nous regardons: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 10, local router ID is 7.7.7.7 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.56.6 0 100 0 45 i 192.168.107.10 0 678 45 i</code> </pre> <br>  √âtrange, tout semble √™tre en ordre.  Pourquoi n'est-il pas transmis √† Router5?  Le fait est que BGP a une r√®gle: <br><blockquote>  Le routeur ne transmet que les routes qu'il utilise lui-m√™me. </blockquote><br>  Le routeur 7 utilise l'itin√©raire via le routeur 5, de sorte que l'itin√©raire via le routeur 10 ne sera pas transmis.  Retour √† la pr√©f√©rence locale.  D√©finissons la pr√©f√©rence locale sur Router7 et voyons comment Router5 r√©pond √† cela: <br><br><pre> <code class="plaintext hljs">route-map BGP permit 10 match ip address 10 set local-preference 250 access-list 10 permit any router bgp 123 neighbor 192.168.107.10 route-map BGP in&lt;/b&gt;</code> </pre> <br>  Nous avons donc cr√©√© une route-map dans laquelle toutes les routes entrent et avons dit √† Router7 de changer le param√®tre Local Preference √† 250 √† la r√©ception, par d√©faut, il est de 100. Nous regardons ce qui s'est pass√© sur Router5: <br><br><pre> <code class="plaintext hljs">Router5#show bgp BGP table version is 8, local router ID is 5.5.5.5 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt;i 9.9.9.0/24 192.168.57.7 0 250 0 678 45 i</code> </pre> <br>  Comme nous le voyons maintenant, Router5 pr√©f√®re la route via Router7.  La m√™me image sera sur Router6, bien qu'il soit plus rentable pour lui de choisir un itin√©raire via Router8.  Nous ajoutons √©galement qu'une modification de ce param√®tre n√©cessite un red√©marrage du voisinage pour que la modification prenne effet.  Lisez <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> .  Avec la pr√©f√©rence locale tri√©e.  Passez au param√®tre suivant. </li><li>  Pr√©f√©rence de route avec le param√®tre Next-hop 0.0.0.0, c'est-√†-dire les routes locales ou agr√©g√©es.  Apr√®s avoir entr√© la commande r√©seau, ces routes se voient automatiquement attribuer le param√®tre Weight √©gal au maximum - 32678: <br><br><pre> <code class="plaintext hljs">Router#show bgp BGP table version is 2, local router ID is 9.9.9.9 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path *&gt; 9.9.9.0/24 0.0.0.0 0 32768 i</code> </pre> </li><li>  Le chemin le plus court √† travers AS.  Le param√®tre le plus court AS_Path est s√©lectionn√©.  Moins l'itin√©raire passe, mieux c'est.  Consid√©rez la route vers 9.9.9.0/24 sur Router10: <br><br><pre> <code class="plaintext hljs">Router10#show bgp BGP table version is 2, local router ID is 6.6.6.6 Status codes: s suppressed, d damped, h history, * valid, &gt; best, i - internal, r RIB-failure, S Stale, m multipath, b backup-path, f RT-Filter, x best-external, a additional-path, c RIB-compressed, Origin codes: i - IGP, e - EGP, ? - incomplete RPKI validation codes: V valid, I invalid, N Not found Network Next Hop Metric LocPrf Weight Path * 9.9.9.0/24 192.168.107.7 0 123 45 i *&gt;i 192.168.112.12 0 100 0 45 i</code> </pre> <br>  Comme vous pouvez le voir, Router10 a choisi la route via 192.168.112.12 car le param√®tre AS_Path ne contient que 45 pour cette route, et 123 et 45 dans l'autre cas. </li><li>  Le param√®tre suivant est Origin.  IGP (route obtenue en utilisant BGP) est-il meilleur que EGP (route obtenu en utilisant le pr√©d√©cesseur BGP, maintenant non utilis√©), et EGP est meilleur que Incomplete?  (re√ßus d'une autre mani√®re, par exemple par redistribution). </li><li>  Le param√®tre suivant est MED.  Nous avions Wieght, qui ne fonctionnait que localement sur le routeur.  Il y avait une pr√©f√©rence locale qui ne fonctionnait qu'au sein d'un syst√®me autonome.  Comme vous pouvez le deviner, MED est un param√®tre qui sera transmis entre les syst√®mes autonomes.  Tr√®s bon <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> sur cette option. </li></ol><br>  Plus d'attributs ne seront pas utilis√©s, mais si les deux routes ont les m√™mes attributs, les r√®gles suivantes sont utilis√©es: <br><br><ol><li>  Choisissez un chemin √† travers le voisin IGP le plus proche. </li><li>  S√©lectionnez l'itin√©raire le plus ancien pour le chemin eBGP. </li><li>  Choisissez un chemin √† travers le voisin avec l'ID de routeur BGP le plus bas. </li><li>  Choisissez un chemin √† travers le voisin avec l'adresse IP la plus basse. </li></ol><br>  <b>Examinons maintenant la question de la convergence BGP.</b> <br><br>  Voyons ce qui se passe si, par exemple, Router6 perd la route 9.9.9.0/24 via Router9.  Nous d√©sactivons l'interface Gi0 / 1 Router6, qui comprend imm√©diatement que la session BGP avec Router8 est d√©connect√©e et que le voisin a disparu, ce qui signifie que la route re√ßue d'elle n'est pas valide.  Router6 envoie imm√©diatement des messages de mise √† jour o√π il indique le r√©seau 9.9.9.0/24 dans le champ Routes retir√©es.  D√®s que Router5 re√ßoit un message similaire, envoyez-le √† Router7.  Mais puisque Router7 a une route via Router10, il enverra imm√©diatement Update avec une nouvelle route en r√©ponse.  Si la chute du voisin ne peut pas √™tre d√©tect√©e par l'√©tat de l'interface, vous devez attendre le d√©clenchement de la minuterie de maintien. <br><br>  <b>Conf√©d√©ration.</b> <br><br>  Si vous vous en souvenez, nous avons parl√© du fait que vous devez souvent utiliser une topologie enti√®rement connect√©e.  Avec un grand nombre de routeurs dans un seul AS, cela peut provoquer de gros probl√®mes, pour √©viter cela, il est n√©cessaire d'utiliser des conf√©d√©rations.  Un AS est divis√© en plusieurs sous-AS, ce qui lui permet de fonctionner sans l'exigence d'une topologie enti√®rement connect√©e. <br><br> <a href=""><img src="https://habrastorage.org/getpro/habr/post_images/d55/6a8/741/d556a874120b70319381332cdddf739b.jpg" alt="Mon image"></a> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Voici un lien vers ce </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laboratoire</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , et </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">voici la</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> configuration de GNS3. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Par exemple, avec cette topologie, nous devrions connecter tous les routeurs de l'AS 2345, mais en utilisant la Conf√©d√©ration, nous pouvons √©tablir des relations de voisinage uniquement entre des routeurs directement connect√©s les uns aux autres. Parlons de cela en d√©tail. Si nous n'avions que l'AS 2345, alors </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">laForge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> obtiendrait une marche de </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Picard pour</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> informer ses </font><b><font style="vertical-align: inherit;">routeurs </font></b></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> et </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , mais ils n'en parleraient pas √† </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crusher</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . En </font><font style="vertical-align: inherit;">outre, les routes que le routeur lui - </font><font style="vertical-align: inherit;">m√™me rasprastranyaet </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Laforge</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ne seraient pas transf√©r√©s </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Crusher</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ou</font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Worf</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , ni </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Data</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Je devrais mettre en place une relation Route-Reflector ou un quartier enti√®rement connect√©. </font><font style="vertical-align: inherit;">En divisant un AS 2345 en 4 sous-AS (2,3,4,5) pour chaque routeur, nous nous retrouvons avec une logique de fonctionnement diff√©rente. </font><font style="vertical-align: inherit;">Tout est parfaitement d√©crit </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ici</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sources:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CCIE Routing and Switching v5.0 Official Cert Guide, Volume 2, Fifth Edition, Narbik Kocharians, Terry Vinson. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Site Web </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">xgu.ru</font></font></a> </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Site </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">GNS3Vault</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr450814/">https://habr.com/ru/post/fr450814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr450802/index.html">Panne h√©rit√©e</a></li>
<li><a href="../fr450804/index.html">L'impression 3D de m√©taux dans l'industrie automobile: commencez petit</a></li>
<li><a href="../fr450806/index.html">Lorsqu'une variable d'environnement acc√©l√®re le processus de 40 fois</a></li>
<li><a href="../fr450810/index.html">7 meilleures fa√ßons de v√©rifier rapidement les comp√©tences des informaticiens avant l'entretien</a></li>
<li><a href="../fr450812/index.html">PSR-14 - l'√©v√©nement principal en PHP</a></li>
<li><a href="../fr450816/index.html">En-t√™tes HTTP pour le d√©veloppeur responsable</a></li>
<li><a href="../fr450818/index.html">De la latence Ceph √©lev√©e au patch du noyau avec eBPF / BCC</a></li>
<li><a href="../fr450820/index.html">Comit√© du programme FrontendConf: cadres, horizons, exp√©rience mondiale et mission de la conf√©rence</a></li>
<li><a href="../fr450822/index.html">Cadres en voie de disparition</a></li>
<li><a href="../fr450824/index.html">L'√©tat du CSS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>