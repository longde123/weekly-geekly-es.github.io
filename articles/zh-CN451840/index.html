<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐗 💙 🖐🏻 Flutter应用程序性能测试 🚵🏽 🧚🏼 🐬</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Flutter框架默认情况下运行良好且快速，但这是否意味着您根本不需要考虑性能？ 不行 编写会很慢的Flutter应用程序是绝对真实的。 另一方面，您也可以最大程度地使用该框架，从而使您的应用程序不仅快速而且高效，消耗更少的处理器和电池时间。 





 这就是我们希望看到的结果：通过一些重要指标...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Flutter应用程序性能测试</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451840/"><p>  Flutter框架默认情况下运行良好且快速，但这是否意味着您根本不需要考虑性能？ 不行 编写会很慢的Flutter应用程序是绝对真实的。 另一方面，您也可以最大程度地使用该框架，从而使您的应用程序不仅快速而且高效，消耗更少的处理器和电池时间。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/bb9/950/aa7/bb9950aa7d75e64e402d3ffdd8958c97.png"></p><br><p> <em>这就是我们希望看到的结果：通过一些重要指标比较应用程序的两个版本的统计结果。</em>  <em>继续阅读以了解操作方法。</em> </p><a name="habracut"></a><br><p> 有一些通用准则可优化Flutter中的性能： </p><br><ul><li> 更新状态时尽可能少地参与小部件。 </li><li> 仅在必要时更新状态。 </li><li>从<code>build</code>方法中取出计算密集型任务，理想情况下从主隔离中取出。 </li></ul><br><p> 可悲的事实是，对于许多有关优化性能的问题，答案将是“多么幸运”。 这种特定的优化是否值得该特定小部件的工作量和维护成本？ 在这种特定情况下，这种特定方法是否有意义？ </p><br><p> 这些问题的唯一有用的答案是测试和测量。 量化每个选择如何影响性能并根据此数据做出决策。 </p><br><p> 好消息是Flutter提供了出色的性能分析工具，例如<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Dart DevTools</a> （当前在预览版本中），其中包括Flutter Inspector，或者您可以直接从Android Studio中使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Flutter Inspector</a> （安装了Flutter插件）。 您有<code>Flutter Driver</code>来测试您的应用程序和<code>Profile mode</code>以保存性能信息。 </p><br><p> 坏消息是现代智能手机太聪明了。 </p><br><h1 id="problema-s-regulyatorami"> 监管机构的问题 </h1><br><p> 对于iOS和Android控制器，量化Flutter应用程序的性能尤其困难。 这些系统级<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">守护程序</a>根据负载来控制中央处理器和图形处理器的速度。 当然，基本上这是个好办法，因为它可以减少电池消耗，提供平稳的运行。 </p><br><p> 缺点是您可以通过增加应用程序执行的工作量来加快应用程序的速度。 </p><br><p> 在下面，您可以看到对应用程序添加无意义的打印调用周期如何使调节器将CPU切换到更高的频率，从而使应用程序更快，性能更可预测。 <br><img src="https://habrastorage.org/getpro/habr/post_images/0bd/5e4/b29/0bd5e4b299bc338e4a65aba9f0a91bda.png"></p><br><p>  <em>监管机构的问题：默认情况下，您无法信任您的电话号码。</em>  <em>在此跨度图中，我们在x轴上有单独的运行（以它们开始的确切时间标记），在Y轴上有构建时间，如您所见，当我们引入一些完全不必要的打印语句时，这导致构建时间减少但没有。</em> </p><br><p> 在此实验中，最差的代码导致更快的构建时间（请参见上文），更快的光栅化时间和更高的帧速率。 当客观上较差的代码导致改进的性能指标时，您不能依靠这些指标作为指导（推荐）。 </p><br><p> 这只是移动应用程序性能测试如何直观而复杂的一个示例。 </p><br><p> 下面，我分享了在使用Flutter的Google I / O <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">开发人员任务</a>应用程序时收集的一些技巧。 </p><br><h1 id="obschie-sovety"> 一般提示 </h1><br><ul><li> 不要在调试模式（ <code>DEBUG mode</code> ）下测量性能。 仅在配置文件<code>Profile mode</code>测量性能。 </li><li> 在真实设备上而非在iOS Simulator或Android Emulator上进行测量。 软件仿真器非常适合开发，但是其性能特征与真实仿真器不同。  Flutter不允许您在模拟设备上以配置文件模式工作，因为这没有任何意义。 您以这种方式收集的数据不适用于实际性能。 </li><li> 理想情况下，使用完全相同的物理设备。 使其成为专用的性能测试设备，切勿将其用于其他任何用途。 </li><li> 探索Flutter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">性能分析工具</a> 。 </li></ul><br><h1 id="cpugpu-regulyatory">  CPU / GPU调节器 </h1><br><p> 如上所述，现代操作系统会根据负载和其他启发式方法更改每个处理器和GPU的频率。  （例如，触摸屏幕通常会提高Android手机的速度。） </p><br><p> 在Android上，您可以禁用这些控件。 我们称此过程为“缩放锁定”。 </p><br><ul><li> 创建一个脚本来禁用设备上的控件以测试性能。 您可以使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Skia示例</a>获取灵感。 您也可以签出<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Unix CPU API</a> 。 </li><li> 如果您不做像Skia一样多的测试工作，那么您可能会想要一些功能更轻巧的东西。 在Developer Quest中查看Shell脚本，以了解去向。 例如，脚本的下一部分将为用户空间控制器（唯一不更改处理器频率本身的控制器）设置CPU。 <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env bash GOV="userspace" echo "Setting CPU governor to: ${GOV}" adb shell "echo ${GOV} &gt; /sys/devices/system/cpu/cpu${CPU_NO}/cpufreq/scaling_governor" ACTUAL_GOV=`adb shell "cat /sys/devices/system/cpu/cpu${CPU_NO}/cpufreq/scaling_governor"` echo "- result: ${ACTUAL_GOV}"</span></span></code> </pre> </li><li> 您的目标不是模拟真实性能（用户不关闭设备上的稳压器），而是在两次运行之间具有可比较的性能指标。 </li><li> 最后，您需要进行实验并使Shell脚本适应将要使用的设备。 这行得通，但是除非您执行此操作，否则性能数据会欺骗您。 </li></ul><br><p><img src="https://habrastorage.org/webt/x4/fw/o5/x4fwo5lyzfo7osrcbjgpfjd7whi.gif"></p><br><p>  <em>Developer Quest的早期版本，已在我的台式机上经过Flutter驱动程序测试。</em> </p><br><h1 id="flutter-driver"> 颤振驱动程序 </h1><br><p>  Flutter Driver允许您自动测试您的应用程序。 阅读flutter.dev上的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">“性能分析”</a>部分，以了解在对应用程序进行<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">性能分析</a>时如何使用它。 </p><br><ul><li> 要测试性能，请不要手动测试您的应用程序。 始终使用Flutter驱动程序获取真正的指示性数据。 </li><li> 编写Flutter驱动程序代码，以便它检查您真正要测量的内容。 如果需要整体应用程序性能，请尝试遍历应用程序的所有部分，然后执行用户会做的事情。 </li><li> 如果您的应用程序具有随机性（ <code>Random</code> ，网络事件等），则为此类情况创建“模拟”。 试运行应尽可能接近。 </li><li> 如果需要，可以使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Timeline</a>类的<code>startSync()</code>和<code>finishSync()</code>方法将自定义事件添加到时间<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">线</a> 。 如果您对特定功能的性能感兴趣，这将很有用。 将<code>startSync()</code>放在其开始处，并将<code>finishSync()</code>放在其末尾。 </li><li> 保存摘要（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">writeSummaryToFile</a> ），更重要的是保存原始时间轴（ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">writeTimelineToFile</a> ）。 </li><li> 多次测试应用程序的每个版本。 对于Developer Quest，我花了100个开始。  （当您测量可能比较吵杂的事情（例如使用p99度量标准时，可能需要进行更多次运行）。）对于基于POSIX的系统，这仅意味着要执行以下操作： <code>for i in {1..100}; do flutter drive --target=test_driver/perf.dart --profile; done</code> <code>for i in {1..100}; do flutter drive --target=test_driver/perf.dart --profile; done</code>  <code>for i in {1..100}; do flutter drive --target=test_driver/perf.dart --profile; done</code> 。 <br><img src="https://habrastorage.org/getpro/habr/post_images/add/92b/950/add92b950ec34ce95edb9095a57186a3.png"></li></ul><br><p>  <em>Chrome的时间轴工具，用于在Flutter中检查分析结果。</em> </p><br><h1 id="timeline"> 时间表 </h1><br><p> 时间线是概要分析结果的原始输出。  Flutter将此信息写入JSON文件，该文件可以通过<code>chrome://tracing</code>下载。 </p><br><ul><li> 了解如何在Chrome中打开完整的时间表。 您只需打开<code>chrome://tracing</code>在Chrome浏览器中进行<code>chrome://tracing</code> ，单击“加载”并选择JSON文件。 您可以在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">此简短指南中</a>阅读更多内容。  （目前还有<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">一个Flutter时间轴工具</a>正在技术预览中。我没有使用它，因为在Flutter工具准备好之前启动了Developer Quest项目。） </li><li> 使用WSAD键在<code>chrome://tracing</code>浏览时间轴<code>chrome://tracing</code>和1234更改操作模式。 </li><li> 首次设置性能测试时，请考虑使用Systrace Android工具运行Flutter Driver。 这样可以使您更好地了解设备中实际发生的情况，包括有关缩放处理器频率的信息。 不要使用Systrace测量整个应用程序，因为这会使一切变慢并且难以预测。 </li><li> 如何使用Flutter Driver运行Android Systrace？ 首先，使用<code>/path/to/your/android/sdk/platform-tools/systrace/systrace.py --atrace-categories=gfx,input,view,webview,wm,am,sm,audio,video,camera,hal,app,res,dalvik,rs,bionic,power,pm,ss,database,network,adb,pdx,sched,irq,freq,idle,disk,load,workq,memreclaim,regulators,binder_driver,binder_lock</code>启动Android Systrace <code>/path/to/your/android/sdk/platform-tools/systrace/systrace.py --atrace-categories=gfx,input,view,webview,wm,am,sm,audio,video,camera,hal,app,res,dalvik,rs,bionic,power,pm,ss,database,network,adb,pdx,sched,irq,freq,idle,disk,load,workq,memreclaim,regulators,binder_driver,binder_lock</code> 。 然后<code>flutter run test_driver/perf.dart --profile --trace-systrace</code>应用程序<code>flutter run test_driver/perf.dart --profile --trace-systrace</code> 。 最后，运行Flutter Driver <code>flutter drive --driver=test_driver/perf_test.dart --use-existing-app=http://127.0.0.1:NNNNN/</code> （其中NNNNN是使您在上面运行flutter应用程序的端口）。 </li></ul><br><h1 id="metriki"> 指标 </h1><br><p> 最好查看尽可能多的指标，但我认为某些指标比其他指标更有用。 </p><br><ul><li><p> 构建时间和栅格化时间（度量标准是使用<code>TimelineSummary</code>默认提供的）仅对真正艰难的性能测试有用，该性能测试除了创建用户界面外不包含其他内容。 </p><br></li><li><p> 不要将<code>TimelineSummary.frameCount</code>视为计算每秒帧数（FPS）的方法。  Flutter分析工具不提供真实的帧速率信息。  <code>TimelineSummary</code>提供了<code>countFrames()</code>方法，但是它仅计算完成的框架装配的数量。 一个经过优化的应用程序可以限制不必要的重建（更新），其FPS会比未经优化的应用程序频繁地重建。 </p><br></li><li><p> 就个人而言，我通过测量执行Dart代码所花费的总处理器时间来获得最有用的数据。 这将计算在<code>build</code>方法中以及在<code>build</code>方法之外执行的代码。 假设您在规模锁定的设备上运行性能分析测试，则可以将总CPU时间视为您的应用程序将消耗多少电池的良好估计。 <br><img src="https://habrastorage.org/getpro/habr/post_images/bca/5e4/cf8/bca5e4cf8e41dc0fbb7a314de92ef507.png"></p><br></li><li><p> 找出执行Dart代码所花费的处理器总时间的最简单方法是估计时间轴上的<code>MessageLoop:FlushTasks</code>事件的数量。 对于Developer Quest，我编写<a href="">了Dart工具</a>来提取它们。 </p><br></li><li><p> 要查找垃圾（垃圾）（即掉落的帧），请寻找极端。 例如，对于特定情况的Developer Quest和我们测试过的设备，查看第95个百分点的构建时间很有用。  （即使将代码的性能水平完全比较，第90个百分位数的构建时间也非常相似，而第99个百分位数的数量通常很吵。您的性能可能会有所不同。） <br><img src="https://habrastorage.org/getpro/habr/post_images/496/e74/50c/496e7450c256ea47b319c66b7faea88d.png"></p><br></li><li><p> 如上所述，测试您的应用程序的每个版本几次（也许100次）。 然后，将平均或百分位数数据与错误字段一起使用。 更好的是，使用跨度图。 </p><br></li></ul><br><h1 id="rezultaty"> 结果 </h1><br><p> 调整后，您可以放心地比较提交并进行实验。 在下面，您可以看到一个常见难题的答案：“这种维护成本的优化值得吗？” <br><img src="https://habrastorage.org/getpro/habr/post_images/6e7/2c7/0e0/6e72c70e0077c95ce8d68abe26d886f5.png"></p><br><p> 我认为在<em>这种特殊</em>情况下，答案是肯定的。 只需几行代码，我们的应用程序的每个自动通道平均就可以减少12％的CPU时间。 </p><br><p> 但是-这是本文的主要内容-另一个优化的结果可能显示出完全不同的情况。 试图过于广泛地推断性能度量是很诱人的，但却是错误的。 </p><br><p> 换句话说：“多么幸运”。 我们必须忍受它。 </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN451840/">https://habr.com/ru/post/zh-CN451840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN451826/index.html">推销市场荒谬：事实证明</a></li>
<li><a href="../zh-CN451828/index.html">Google I / O 2019的主要秘密，无法在Internet上找到</a></li>
<li><a href="../zh-CN451830/index.html">简要介绍AES 128 ECB的实施</a></li>
<li><a href="../zh-CN451832/index.html">如何理解代理何时说谎：使用主动地理位置算法验证网络代理的物理位置</a></li>
<li><a href="../zh-CN451834/index.html">数据中心的重大事故：原因和结果</a></li>
<li><a href="../zh-CN451842/index.html">关于发现自己</a></li>
<li><a href="../zh-CN451848/index.html">使用DNS-01挑战和AWS自动化让我们加密SSL证书管理</a></li>
<li><a href="../zh-CN451852/index.html">RDP中的远程任意代码执行</a></li>
<li><a href="../zh-CN451854/index.html">面试-关于Swift的10个问题。 第一部分</a></li>
<li><a href="../zh-CN451856/index.html">安装openmeetings 5​​.0.0-M1。 没有Flash的WEB会议</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>