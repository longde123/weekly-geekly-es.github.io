<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üêÅ ü•ä üåû Syst√®me d'exploitation en temps r√©el AQUA RTOS pour MK AVR dans l'environnement BASCOM AVR ‚úçüèΩ üö≥ üë¶üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lorsqu'il √©crit pour du code MK plus compliqu√© que ¬´clignoter une lumi√®re¬ª, le d√©veloppeur est confront√© aux limitations inh√©rentes √† la programmation...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Syst√®me d'exploitation en temps r√©el AQUA RTOS pour MK AVR dans l'environnement BASCOM AVR</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/453708/"> Lorsqu'il √©crit pour du code MK plus compliqu√© que ¬´clignoter une lumi√®re¬ª, le d√©veloppeur est confront√© aux limitations inh√©rentes √† la programmation lin√©aire dans le style de ¬´supercycle plus interruptions¬ª.  Le traitement des interruptions n√©cessite de la rapidit√© et de la concision, ce qui conduit √† ajouter des indicateurs au code et √† rendre le style de projet ¬´super-cycle avec interruptions et indicateurs¬ª. <br><br>  Si la complexit√© du syst√®me augmente, le nombre de drapeaux interd√©pendants augmente exponentiellement et le projet se transforme rapidement en un ¬´code de p√¢tes¬ª mal lisible et g√©rable. <br><br>  L'utilisation de syst√®mes d'exploitation en temps r√©el permet de se d√©barrasser du "code des p√¢tes" et de rendre la flexibilit√© et la g√©rabilit√© √† un projet MK complexe. <br>  Plusieurs syst√®mes d'exploitation coop√©ratifs en temps r√©el ont √©t√© d√©velopp√©s et tr√®s appr√©ci√©s des microcontr√¥leurs AVR.  Cependant, ils sont tous √©crits en C ou Assembleur et ne conviennent pas √† ceux qui programment MK dans l'environnement BASCOM AVR, les privant d'un outil aussi utile pour √©crire des applications s√©rieuses. <br><br>  Pour corriger cette lacune, j'ai d√©velopp√© un RTOS simple pour l'environnement de programmation BASCOM AVR, que je porte √† l'attention des lecteurs. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/cd6/0be/c64/cd60bec64b2a0b96ed562770a9063355.jpg" alt="image"><br><a name="habracut"></a><br>  Pour beaucoup, le style de programmation MK familier est le soi-disant  <i>supercycle</i> .  Dans ce cas, le code se compose d'un ensemble de fonctions, proc√©dures et descripteurs (constantes, variables), √©ventuellement ceux de biblioth√®que, g√©n√©ralement appel√©s ¬´code d'arri√®re-plan¬ª, ainsi qu'une grande boucle infinie enferm√©e dans une construction <b>do-loop</b> .  Au d√©marrage, l'√©quipement du MK lui-m√™me et des appareils externes est d'abord initialis√©, les constantes et les valeurs initiales des variables sont d√©finies, puis le contr√¥le est transf√©r√© √† ce supercycle infini. <br>  La simplicit√© du supercycle est √©vidente.  La plupart des t√¢ches effectu√©es par MK, parce que d'une mani√®re ou d'une autre cyclique.  Les inconv√©nients sont √©galement √©vidents: si un appareil ou un signal n√©cessite une r√©action imm√©diate, MK le fournira au plus t√¥t lorsque le cycle se retournera.  Si la dur√©e du signal est plus courte que la p√©riode de cycle, un tel signal sera ignor√©. <br><br>  Dans l'exemple ci-dessous, nous voulons v√©rifier si le bouton est <b>enfonc√©</b> : <br><br><pre><code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">' -  if button = 1 then '     '  -  loop</span></span></code> </pre> <br>  √âvidemment, si "un certain code" fonctionne assez longtemps, MK peut ne pas remarquer une courte pression sur un bouton. <br><br>  Heureusement, MK est √©quip√© d'un syst√®me d'interruption qui peut r√©soudre ce probl√®me: tous les signaux critiques peuvent √™tre ¬´suspendus¬ª aux interruptions et un gestionnaire peut √™tre √©crit pour chacun.  Le niveau suivant appara√Æt donc: un <i>supercycle avec des interruptions</i> . <br>  L'exemple ci-dessous montre la structure du programme avec un supercycle et une interruption qui traite un clic de bouton: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  loop end '   button_isr: '  -    return</span></span></code> </pre> <br>  Cependant, l'utilisation d'interruptions pose un nouveau probl√®me: le code du gestionnaire d'interruptions doit √™tre aussi rapide et court que possible;  √† l'int√©rieur des interruptions, la fonctionnalit√© MK est limit√©e.  √âtant donn√© que les AVR MK n'ont pas de syst√®me d'interruption hi√©rarchique, une autre interruption ne peut pas se produire √† l'int√©rieur d'une interruption - ils sont actuellement d√©sactiv√©s sur le plan mat√©riel.  L'interruption doit donc √™tre ex√©cut√©e le plus rapidement possible, sinon les autres interruptions (et √©ventuellement les plus importantes) seront ignor√©es et non trait√©es. <br><br><div class="spoiler">  <b class="spoiler_title">Interrompre la m√©moire</b> <div class="spoiler_text">  En fait, √©tant √† l'int√©rieur de l'interruption, MK est capable de noter le fait d'une autre interruption dans un registre sp√©cial, ce qui permet de la traiter plus tard.  Cependant, cette interruption ne peut pas √™tre trait√©e imm√©diatement. <br></div></div><br>  Par cons√©quent, nous ne pouvons pas √©crire quelque chose de compliqu√© dans le gestionnaire d'interruption, surtout si ce code doit avoir des retards - car jusqu'√† ce que le retard fonctionne, le MK ne reviendra pas au programme principal (supercycle) et sera sourd aux autres interruptions. <br><br>  Pour cette raison, dans le gestionnaire d'interruption, vous n'avez souvent qu'√† signaler le fait de l'√©v√©nement avec un indicateur - le v√¥tre pour chaque √©v√©nement - puis √† v√©rifier et √† traiter les indicateurs √† l'int√©rieur du supercycle.  Bien s√ªr, cela rallonge le temps de r√©action √† l'√©v√©nement, mais au moins nous ne manquons pas quelque chose d'important. <br><br>  Ainsi, le prochain niveau de complexit√© se pose - un <i>supercycle avec des interruptions et des drapeaux</i> . <br><br>  Le code suivant s'affiche: <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">on</span></span> button button_isr <span class="hljs-comment"><span class="hljs-comment">'    enable interrupts ' ***  *** do ' -  if button_flag = 1 then '     button_flag = 0 '     end if '  -  loop end ' ***    *** button_isr: button_flag = 1 return</span></span></code> </pre> <br>  Un nombre consid√©rable de programmes pour MK sont limit√©s par cela.  Cependant, ces programmes sont g√©n√©ralement encore plus ou moins simples.  Si vous √©crivez quelque chose de plus compliqu√©, alors le nombre de drapeaux commence √† cro√Ætre comme une boule de neige, et le code devient de plus en plus confus et illisible.  De plus, dans l'exemple ci-dessus, le probl√®me des retards n'a pas √©t√© r√©solu.  Bien s√ªr, vous pouvez "suspendre" une interruption distincte sur la minuterie, et dans celle-ci ... √©galement contr√¥ler divers drapeaux.  Mais cela rend le programme compl√®tement moche, le nombre de drapeaux interd√©pendants augmente de fa√ßon exponentielle, et m√™me le d√©veloppeur lui-m√™me peut difficilement trouver un tel "code de p√¢tes" assez rapidement.  Essayer de trouver une erreur ou de modifier le code devient souvent √©gal dans les efforts pour d√©velopper un nouveau projet. <br><br>  Comment r√©soudre le probl√®me du "code de p√¢tes" et le rendre plus lisible et g√©rable?  Le <i>syst√®me d'exploitation</i> (OS) vient √† la rescousse.  Dans ce document, la fonctionnalit√© que MK doit impl√©menter est divis√©e en t√¢ches dont le fonctionnement est contr√¥l√© par le syst√®me d'exploitation. <br><br><h2>  Types de syst√®mes d'exploitation pour MK </h2><br>  Les syst√®mes d'exploitation pour MK peuvent √™tre divis√©s en deux grandes classes: OS avec √©viction et OS coop√©ratif.  Dans l'un de ces syst√®mes d'exploitation, les t√¢ches sont contr√¥l√©es par une proc√©dure sp√©ciale appel√©e <i>r√©partiteur</i> .  Dans un OS avec <i>√©viction, le</i> r√©partiteur bascule ind√©pendamment √† tout moment l'ex√©cution d'une t√¢che √† une autre, en allouant √† chacun un certain nombre de cycles d'horloge (√©ventuellement diff√©rents, selon la priorit√© de la t√¢che).  Cette approche dans son ensemble fonctionne tr√®s bien, vous permettant de ne pas regarder du tout le contenu des t√¢ches: vous pouvez √©crire au moins le code de la t√¢che <br><br><pre> <code class="vbscript hljs"><span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">goto</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  - et le reste des t√¢ches (y compris celle-ci) seront toujours ex√©cut√©es.  Cependant, les syst√®mes d'exploitation pr√©emptifs n√©cessitent beaucoup de ressources (m√©moire du processeur et cycles d'horloge), car chaque commutateur doit enregistrer compl√®tement le contexte de la t√¢che √† d√©sactiver et charger le contexte de la reprise.  Le contexte se r√©f√®re ici au contenu des registres de la machine et de la pile (BASCOM utilise deux piles - une mat√©rielle pour les adresses de retour des sous-programmes et une logicielle pour transmettre les arguments).  Non seulement une telle charge n√©cessite beaucoup de cycles de processeur, mais le contexte de chaque t√¢che doit √©galement √™tre stock√© quelque part pendant un certain temps jusqu'√† ce qu'il fonctionne.  Dans les "gros" processeurs, initialement orient√©s vers le multit√¢che, ces fonctions sont souvent prises en charge dans le mat√©riel, et elles ont beaucoup plus de ressources.  Dans AVR MK, il n'y a pas de prise en charge mat√©rielle pour le multit√¢che (tout doit √™tre fait ¬´manuellement¬ª), et la m√©moire disponible est petite.  Par cons√©quent, les OS de d√©placement, bien qu'ils existent, ne conviennent pas trop aux MK simples. <br><br>  Une autre chose est le <i>syst√®me d'exploitation coop√©ratif</i> .  Ici, la t√¢che elle-m√™me contr√¥le √† quel moment transf√©rer le contr√¥le au r√©partiteur, lui permettant de d√©marrer d'autres t√¢ches.  De plus, les t√¢ches ici sont n√©cessaires pour ce faire - sinon l'ex√©cution du code se bloquera.  D'une part, il semble que cette approche r√©duit la fiabilit√© globale: si une t√¢che se bloque, elle n'appellera jamais le r√©partiteur et l'ensemble du syst√®me cessera de r√©pondre.  D'un autre c√¥t√©, un code lin√©aire ou un supercycle n'est pas mieux √† cet √©gard - car ils peuvent geler avec exactement le m√™me risque. <br><br>  Cependant, un OS coop√©ratif a un avantage important.  √âtant donn√© qu'ici le programmeur d√©finit le moment de la commutation lui-m√™me, cela ne peut pas se produire soudainement, par exemple, pendant que la t√¢che travaille avec une ressource ou au milieu du calcul d'une expression arithm√©tique.  Par cons√©quent, dans un syst√®me d'exploitation coop√©ratif, dans la plupart des cas, vous pouvez vous passer du maintien du contexte.  Cela √©conomise consid√©rablement le temps et la m√©moire du processeur, et semble donc beaucoup plus adapt√© √† la mise en ≈ìuvre sur MK AVR. <br><br><h2>  Changement de t√¢che dans BASCOM AVR </h2><br>  Afin d'impl√©menter la commutation de t√¢ches dans l'environnement BASCOM AVR, le code de t√¢che, dont chacune est impl√©ment√©e comme une proc√©dure normale, doit en quelque sorte appeler le r√©partiteur - √©galement impl√©ment√© comme une proc√©dure normale. <br>  Imaginez que nous ayons deux t√¢ches, chacune √† un endroit quelconque de son code √©tant appel√©e par le r√©partiteur. <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> task1() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">'  1 '  loop end sub ' ---------------------------------- sub task2() do '  2 '  loop end sub</span></span></code> </pre> <br>  Supposons que la t√¢che 1 a √©t√© ex√©cut√©e. Voyons ce qui se passe sur la pile lorsqu'elle ex√©cute un ¬´appel de r√©partiteur¬ª: <br><br><blockquote>  adresse de retour au code principal (2 octets) <br>  haut de la pile -&gt; adresse de retour √† la t√¢che 1 qui a appel√© le r√©partiteur (2 octets) </blockquote><br>  Le haut de la pile pointera vers l'adresse de l'instruction de la t√¢che 1, qui suit l'appel du r√©partiteur (l'instruction de <b>boucle</b> dans notre exemple). <br><br>  L'objectif du r√©partiteur dans le cas le plus simple est de transf√©rer le contr√¥le √† la t√¢che 2. La question est de savoir comment proc√©der?  (supposons que le r√©partiteur connaisse d√©j√† l'adresse de la t√¢che 2). <br><br>  Pour ce faire, le r√©partiteur doit extraire l'adresse de retour √† la t√¢che 1 de la pile (et un endroit √† retenir), puis mettre l'adresse de la t√¢che 2 √† cet endroit de la pile, puis donner la commande de retour.  Le processeur extraira l'adresse qui y est plac√©e de la pile et, au lieu de revenir √† la t√¢che 1, proc√©dera √† l'ex√©cution de la t√¢che 2. <br><br>  √Ä son tour, lorsque la t√¢che 2 appelle le r√©partiteur, nous retirons √©galement la pile et enregistrons l'adresse o√π il sera possible de revenir √† la t√¢che 2 et de charger l'adresse de la t√¢che 1 pr√©c√©demment enregistr√©e dans la pile. Donnez la commande de <b>retour</b> et nous serons au point de continuation de la t√¢che 1 . <br><br>  En cons√©quence, nous obtenons un tel g√¢chis: <br><br><blockquote>  T√¢che 1 -&gt; Dispatcher -&gt; T√¢che 2 -&gt; Dispatcher -&gt; T√¢che 1 .... </blockquote><br>  Pas mal!  Et √ßa marche.  Mais, bien s√ªr, cela ne suffit pas pour un syst√®me d'exploitation pratiquement utilisable.  Apr√®s tout, toutes les t√¢ches ne doivent pas toujours fonctionner - par exemple, elles peuvent <i>s'attendre √†</i> quelque chose (l'expiration du d√©lai, l'apparition d'un signal, etc.).  Ainsi, les t√¢ches doivent avoir un <i>statut</i> (TRAVAUX, PR√äT, ATTENDU, etc.).  De plus, il serait bien que les t√¢ches soient <i>prioritaires</i> .  Ensuite, si plusieurs t√¢ches sont pr√™tes √† √™tre ex√©cut√©es, le r√©partiteur poursuivra la t√¢che qui a la priorit√© la plus √©lev√©e. <br><br><h2>  AQUA RTOS </h2><br>  Pour mettre en ≈ìuvre l'id√©e d√©crite, la coop√©rative OS AQUA RTOS a √©t√© d√©velopp√©e, qui fournit les services n√©cessaires aux t√¢ches et permet la mise en ≈ìuvre du multit√¢che coop√©ratif dans l'environnement BASCOM AVR. <br><br><div class="spoiler">  <b class="spoiler_title">Avis important concernant le mode de proc√©dure dans BASCOM AVR</b> <div class="spoiler_text">  Avant de commencer la description de AUQA RTOS, il convient de noter que l'environnement BASCOM AVR prend en charge deux types de proc√©dures d'adressage.  Ceci est r√©gul√© par le sous-mode de configuration = new |  vieux. <br>  Dans le cas de la sp√©cification de l'ancienne option, le compilateur, d'une part, compilera tout le code de mani√®re lin√©aire, qu'il soit utilis√© quelque part ou non, et d'autre part, les proc√©dures sans arguments con√ßus dans le style de sub name / end sub seront per√ßues comme des proc√©dures , dans le style du nom: / return.  Cela nous permet de passer l'adresse de la proc√©dure sous forme d'√©tiquette comme argument √† une autre proc√©dure en utilisant le modificateur bylabel.  Cela s'applique √©galement aux proc√©dures con√ßues dans le style du sous-nom / sous-style de fin (vous devez passer le nom de la proc√©dure sous forme d'√©tiquette). <br>  Dans le m√™me temps, le mode submode = old impose certaines restrictions: les proc√©dures de t√¢che ne doivent pas contenir d'arguments;  le code des fichiers connect√©s via $ include est inclus dans le projet g√©n√©ral de mani√®re lin√©aire, par cons√©quent, le contournement doit √™tre fourni dans les fichiers connect√©s - passez du d√©but √† la fin en utilisant goto et une √©tiquette. <br>  Ainsi, dans AQUA RTOS, l'utilisateur doit soit utiliser uniquement l'ancienne notation de t√¢che dans le style nom_t√¢che: / return pour les t√¢ches, soit utiliser le sous-nom / sous-titre le plus courant, en ajoutant le modificateur submode = old au d√©but de son code, et contourner les fichiers inclus goto label / include file code / label:. <br></div></div><br><h3>  √âtats des t√¢ches AQUA RTOS </h3><br>  Les statuts suivants sont d√©finis pour les t√¢ches dans AQUA RTOS: <br><br><pre> <code class="vbscript hljs">OSTS_UNDEFINE OSTS_READY OSTS_RUN OSTS_DELAY OSTS_STOP OSTS_WAIT OSTS_PAUSE OSTS_RESTART</code> </pre> <br>  Si la t√¢che n'a pas encore √©t√© initialis√©e, elle se voit attribuer le statut <b>OSTS_UNDEFINE</b> . <br>  Apr√®s l'initialisation, la t√¢che a le statut <b>OSTS_STOP</b> . <br>  Si la t√¢che <i>est pr√™te √† √™tre ex√©cut√©e</i> , elle se voit attribuer le statut <b>OSTS_READY</b> . <br>  La t√¢che en cours d'ex√©cution a le statut <b>OSTS_RUN</b> . <br>  De l√†, elle peut aller aux statuts <b>OSTS_STOP, OSTS_READY, OSTS_DELAY, OSTS_WAIT, OSTS_PAUSE</b> . <br>  Le statut <b>OSTS_DELAY</b> a une t√¢che remplissant un <i>d√©lai</i> . <br>  Le statut <b>OSTS_WAIT est</b> affect√© aux t√¢ches qui <i>attendent un s√©maphore, un √©v√©nement ou un message</i> (plus d'informations √† leur sujet ci-dessous). <br><br>  Quelle est la diff√©rence entre les <b>statuts</b> <b>OSTS_STOP</b> et <b>OSTS_PAUSED</b> ? <br>  Si, pour une raison quelconque, la t√¢che re√ßoit le statut <b>OSTS_STOP</b> , la reprise ult√©rieure de la t√¢che (√† la r√©ception du statut <b>OSTS_READY</b> ) sera effectu√©e √† partir de son point d'entr√©e, c'est-√†-dire  d√®s le d√©but.  √Ä partir du statut <b>OSTS_PAUSE, la</b> t√¢che continuera de fonctionner √† l'endroit o√π elle a √©t√© suspendue. <br><br><h3>  Gestion de l'√©tat des t√¢ches </h3><br>  Le syst√®me d'exploitation lui-m√™me peut g√©rer automatiquement les t√¢ches, ainsi que l'utilisateur, en appelant les services du syst√®me d'exploitation.  Il existe plusieurs services de gestion des t√¢ches (les noms de tous les services OS commencent par le pr√©fixe <b>OS_</b> ): <br><br><pre> <code class="vbscript hljs">OS_InitTask(task_label, task_prio) OS_Stop() OS_StopTask(task_label) OS_Pause() OS_PauseTask(task_label) OS_Resume() OS_ResumeTask(task_label) OS_Restart()</code> </pre> <br>  Chacun d'eux a deux options: <b>OS_service</b> et <b>OS_serviceTask</b> (√† l'exception du service <b>OS_InitTask</b> , qui n'a qu'une seule option; le service <b>OS_Init</b> initialise le syst√®me d'exploitation lui-m√™me). <br><br>  Quelle est la diff√©rence entre <b>OS_service</b> et <b>OS_serviceTask</b> ?  La premi√®re m√©thode agit sur la t√¢che elle-m√™me qui l'a provoqu√©e;  la seconde vous permet de d√©finir comme argument un pointeur vers une autre t√¢che et donc d'en g√©rer une autre √† partir d'une t√¢che. <br><br><div class="spoiler">  <b class="spoiler_title">√Ä propos d'OS_Resume</b> <div class="spoiler_text">  Tous les services de gestion des t√¢ches, √† l'exception de OS_Resume et OS_ResumeTask, appellent automatiquement le gestionnaire de t√¢ches apr√®s le traitement.  En revanche, les services OS_Resume * d√©finissent uniquement l'√©tat de la t√¢che sur OSTS_READY.  Ce statut sera trait√© uniquement lorsque le r√©partiteur est explicitement appel√©. <br></div></div><br><h3>  Priorit√© et file d'attente des t√¢ches </h3><br>  Comme mentionn√© ci-dessus, dans un syst√®me r√©el, certaines t√¢ches peuvent √™tre plus importantes, tandis que d'autres peuvent √™tre secondaires.  Par cons√©quent, une fonctionnalit√© utile du syst√®me d'exploitation est la possibilit√© d'attribuer une priorit√© aux t√¢ches.  Dans ce cas, s'il y a plusieurs t√¢ches pr√©d√©finies en m√™me temps, le syst√®me d'exploitation s√©lectionnera d'abord la t√¢che avec la priorit√© la plus √©lev√©e.  Si <b>toutes les</b> t√¢ches pr√©d√©finies ont une priorit√© √©gale, le syst√®me d'exploitation les mettra √† ex√©cution dans un cercle, dans un ordre appel√© "carrousel" ou round-robin. <br><br>  Dans AQUA RTOS, la priorit√© est affect√©e √† une t√¢che lorsqu'elle est <i>initialis√©e</i> via un appel au service <b>OS_InitTask</b> , qui <b>re√ßoit l'</b> adresse de la t√¢che comme premier argument et un nombre compris entre 1 et 15 comme deuxi√®me argument. <i>Un nombre inf√©rieur signifie une priorit√© plus √©lev√©e</i> .  Pendant le fonctionnement de l'OS, aucune modification de la priorit√© affect√©e √† la t√¢che n'est fournie. <br><br><h3>  Retards </h3><br>  Dans chaque t√¢che, le retard est trait√© ind√©pendamment des autres t√¢ches. <br>  Ainsi, pendant que le syst√®me d'exploitation calcule le retard d'une t√¢che, d'autres peuvent √™tre ex√©cut√©es. <br>  Pour l'organisation des retards fournis les services <b>OS_Delay |</b>  <b>OS_DelayTask</b> .  L'argument est le nombre de millisecondes pendant lequel la t√¢che est <i>retard√©e</i> .  La dimension de l'argument √©tant <b>dword</b> , le d√©lai maximum est de 4294967295 ms, soit environ 120 heures, ce qui semble suffisant pour la plupart des applications.  Apr√®s avoir appel√© le service de retard, le r√©partiteur est automatiquement appel√©, ce qui transf√®re le contr√¥le √† d'autres t√¢ches pendant la dur√©e du retard. <br><br><h3>  S√©maphores </h3><br>  Les s√©maphores dans AQUA RTOS sont quelque chose comme des indicateurs et des variables disponibles pour les t√¢ches.  Ils sont de deux types - binaires et d√©nombrables.  Les premiers n'ont que deux √©tats: libre et ferm√©.  Le second est un compteur d'octets (le service de comptage des s√©maphores dans la version actuelle d'AQUA RTOS n'est pas impl√©ment√© (je suis un paresseux), donc tout ce qui est dit ci-dessous ne s'applique qu'aux s√©maphores binaires). <br><br>  La diff√©rence entre un s√©maphore et un simple indicateur est que la t√¢che peut √™tre effectu√©e pour <i>attendre la lib√©ration du</i> s√©maphore sp√©cifi√©.  √Ä certains √©gards, l'utilisation de s√©maphores ressemble vraiment √† un chemin de fer: en atteignant le s√©maphore, la composition (t√¢che) v√©rifiera le s√©maphore, et s'il n'est pas ouvert, il attendra que le signal d'activation apparaisse pour aller plus loin.  √Ä ce moment, d'autres trains (t√¢ches) peuvent continuer √† se d√©placer (rouler). <br><br>  Dans ce cas, tout le travail noir est affect√© au r√©partiteur.  D√®s qu'il est demand√© √† la t√¢che d'attendre le s√©maphore, le contr√¥le est automatiquement transf√©r√© au r√©partiteur et il peut d√©marrer d'autres t√¢ches - jusqu'√† ce que le s√©maphore sp√©cifi√© soit lib√©r√©.  D√®s que l'√©tat du s√©maphore devient <i>libre</i> , le r√©partiteur affecte √† toutes les t√¢ches qui attendaient ce s√©maphore l'√©tat <i>pr√™t</i> ( <b>OSTS_READY</b> ), et elles seront ex√©cut√©es dans l'ordre de priorit√© et de priorit√©. <br>  Au total, AQUA RTOS fournit 16 s√©maphores binaires (ce nombre peut, en principe, √™tre augment√© en modifiant la dimension de la variable dans l'unit√© de contr√¥le des t√¢ches, car √† l'int√©rieur, ils sont impl√©ment√©s sous forme de drapeaux binaires). <br>  Les s√©maphores binaires fonctionnent via les services suivants: <br><br><pre> <code class="vbscript hljs">hBSem OS_CreateBSemaphore() OS_WaitBSemaphore(hBSem) OS_WaitBSemaphoreTask(task_label, hBSem) OS_BusyBSemaphore(hBSem) OS_FreeBSemaphore(hBSem)</code> </pre> <br>  Avant d'utiliser un s√©maphore doit √™tre <i>cr√©√©</i> .  Cela se fait en appelant le service <b>OS_CreateBSemaphore</b> , qui renvoie l'identificateur d'octet unique (handle) du s√©maphore <b>hBSem</b> cr√©√©, ou via le gestionnaire d√©fini par l'utilisateur g√©n√®re une erreur <b>OSERR_BSEM_MAX_REACHED</b> , indiquant que le nombre maximal possible de s√©maphores binaires a √©t√© atteint. <br><br>  Vous pouvez travailler avec l'identifiant re√ßu en le passant comme argument √† d'autres services de s√©maphore. <br><br>  Service <b>OS_WaitBSemaphore |</b>  <b>OS_WaitBSemaphoreTask</b> met la t√¢che (actuelle | sp√©cifi√©e) dans un √©tat pour <i>attendre la lib√©ration du s√©maphore</i> <b>hBSem</b> si ce s√©maphore est occup√©, puis transf√®re le contr√¥le au r√©partiteur afin qu'il puisse d√©marrer d'autres t√¢ches.  Si le s√©maphore est libre, le transfert de contr√¥le ne se produit pas et la t√¢che se poursuit simplement. <br><br>  Les <b>services</b> <b>OS_BusyBSemaphore</b> et <b>OS_FreeBSemaphore</b> d√©finissent le s√©maphore <b>hBSem</b> sur <i>occup√©</i> ou <i>libre,</i> respectivement. <br><br>  La destruction des s√©maphores afin de simplifier le syst√®me d'exploitation et de r√©duire la quantit√© de code n'est pas fournie.  Ainsi, tous les s√©maphores cr√©√©s sont statiques. <br><br><h3>  Les √©v√©nements </h3><br>  En plus des s√©maphores, les t√¢ches peuvent √™tre pilot√©es par des √©v√©nements.  Une t√¢che peut √™tre charg√©e d' <i>attendre un certain √©v√©nement</i> , et une autre t√¢che (ainsi que le code d'arri√®re-plan) peut <i>signaler</i> cet √©v√©nement.  Dans le m√™me temps, toutes les t√¢ches qui attendaient cet √©v√©nement recevront le statut <i>pr√™t pour l'ex√©cution</i> ( <b>OSTS_READY</b> ) et seront d√©finies par le r√©partiteur pour ex√©cution dans l'ordre de priorit√© et de priorit√©. <br><br>  √Ä quels √©v√©nements la t√¢che peut-elle r√©pondre?  Eh bien, par exemple: <br><ul><li>  interruption; </li><li>  occurrence d'une erreur; </li><li>  lib√©ration de la ressource (il est parfois plus pratique d'utiliser un s√©maphore pour cela); </li><li>  changer l'√©tat de la ligne d'E / S ou appuyer sur une touche du clavier; </li><li>  recevoir ou envoyer un caract√®re via RS-232; </li><li>  transfert d'informations d'une partie de l'application √† une autre (voir aussi messages). </li></ul><br>  Le syst√®me d'√©v√©nements est impl√©ment√© via les services suivants: <br><br><pre> <code class="vbscript hljs">hEvent OS_CreateEvent() OS_WaitEvent(hEvent) OS_WaitEventTask(task_label, hEvent) OS_WaitEventTO(hEvent, dwTimeout) OS_SignalEvent(hEvent)</code> </pre> <br>  Avant d'utiliser un √©v√©nement, vous devez <i>le cr√©er</i> .  Cela se fait en appelant la fonction <b>OS_CreateEvent</b> , qui renvoie un identifiant d'octet unique (handle) pour l'√©v√©nement <b>hEvent</b> , ou renvoie une erreur <b>OSERR_EVENT_MAX_REACHED</b> via le gestionnaire d√©fini par l'utilisateur, indiquant que la limite du nombre d'√©v√©nements pouvant √™tre g√©n√©r√©s dans le syst√®me d'exploitation a √©t√© atteinte (255 √©v√©nements diff√©rents maximum). <br><br>  Pour faire attendre une t√¢che √† un √©v√©nement <b>hEvent</b> , appelez <b>OS_WaitEvent</b> dans son code, en passant le <b>descripteur d'</b> √©v√©nement comme argument.  Apr√®s avoir appel√© ce service, le contr√¥le sera automatiquement transf√©r√© au r√©partiteur. <br><br>  Contrairement au service de s√©maphore, le service d'√©v√©nements fournit une option pour attendre un √©v√©nement avec un <i>d√©lai d'expiration</i> .  Pour ce faire, utilisez le service <b>OS_WaitEventTO</b> .  Le deuxi√®me argument ici, vous pouvez sp√©cifier le nombre de millisecondes pendant lequel la t√¢che peut attendre l'√©v√©nement.  Si le d√©lai sp√©cifi√© a expir√©, la t√¢che recevra le statut <i>pr√™t √† √™tre ex√©cut√©</i> comme si l'√©v√©nement s'√©tait produit et sera d√©finie par le r√©partiteur pour poursuivre l'ex√©cution dans l'ordre de priorit√© et de priorit√©.  La t√¢che peut d√©couvrir qu'il ne s'agissait pas d'un √©v√©nement, mais d'un d√©lai d'expiration, que la t√¢che pouvait v√©rifier en v√©rifiant l' <b>indicateur</b> global <b>OS_TIMEOUT</b> . <br><br> <i></i>             <b>OS_SignalEvent</b> ,       .    ,   ,    <i>  </i> ,           . <br><br><h3>  Des messages </h3><br>        ,       :         ,           ‚Äì   . <br>     : <br><br><pre> <code class="vbscript hljs">hTopic OS_CreateMessage() OS_WaitMessage(hTopic) OS_WaitMessageTask(task_label, hTopic) OS_WaitMessageTO(hTopic, dwTimeout) OS_SendMessage(hTopic, wMessage) word_ptr OS_GetMessage(hTopic) word_ptr OS_PeekMessage(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_GetMessageString(hTopic) <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> OS_PeekMessageString(hTopic)</code> </pre> <br>    ,    <i> </i> .     <b>OS_CreateMessage</b> ,      <b>hTopic</b> ,       <b>OSERR_TOPIC_MAX_REACHED</b> ,   ,       ,     . <br><br>        <b>hTopic</b> ,      <b>OS_WaitMessage</b> ,      .          .  ,        <i>    <b>hTopic</b></i> . <br><br>     <b>OS_WaitMessageTO</b>    <b>OS_WaitEventTO</b>  . <br><br>      <b>OS_SendMessage</b> .     ,     ,   ‚Äì   <b>word</b> .      ,   <i>  </i> , ,   ,    . <br><br>    ,     BASCOM  <b>varptr</b> , , : <br><br><pre> <code class="vbscript hljs">strMessage = <span class="hljs-string"><span class="hljs-string">"Hello, world!"</span></span> OS_SendMessage hTopic, varptr (strMessage)</code> </pre> <br>     <b>OS_WaitMessage</b> ,  ,    ,          ,     ‚Äî      .        .      <b>word</b> ,      ,    ,   .   <b>OS_GetMessage</b>   ,  <b>OS_PeekMessage</b>  . <br><br>     ,   ,    <b>OS_GetMessageString</b>  <b>OS_PeekMessageString</b> ,     ,   ,     . <br><br><h3>    </h3><br>        AQUA RTOS       <b>TIMER0</b> .  ,   (  )     .      , ..          .    1 . <br><br><h2>    AQUA RTOS </h2><br><h3>   </h3><br>       ,           .   <b>OS_SIM = TRUE | FALSE</b> ,    . <br><br>  ,      <b>OS_MAX_TASK</b> ,       .    ,     (  ),      .        ,   . <i>    ,    .</i> <br><br><h3>   </h3><br>    AQUA RTOS   .      <b>OS_Init</b> .      .    ,     ‚Äì     .  ,   ,    ‚Äì  . <br><br>         (    ) ‚Äì      ,            .          ,      -    . <br><br> ,     AQUA RTOS            : <br><br><pre> <code class="vbscript hljs">OS_Init my_err_trap <span class="hljs-comment"><span class="hljs-comment">'... '... '... sub my_err_trap(err_code as byte) print err_code end sub</span></span></code> </pre> <br><h3>   </h3><br>     ,     : <br><br><pre> <code class="vbscript hljs">OS_InitTask task_1, <span class="hljs-number"><span class="hljs-number">1</span></span> OS_InitTask task_2 , <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-comment"><span class="hljs-comment">'... OS_InitTask task_N , 1</span></span></code> </pre> <br><h2>   </h2><br><h3>   </h3><br> ,    ,       Arduino Nano V3.       -  (, test),     bas-: <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() '       led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output ' ***    *** '   OS_Init my_err_trap '   OS_InitTask task_1, 1 OS_InitTask task_2 , 1 '      ¬´¬ª (OSTS_STOP) '    ,     ' ¬´  ¬ª (OSTS_READY)   OS_ResumeTask OS_ResumeTask task_1 OS_ResumeTask task_2 '      OS_Sheduler end ' ***  *** sub task_1 () do toogle led_1 '   1 OS_delay 1000 '   1000  loop end sub sub task_2 () do toogle led_2 '   2 OS_delay 333 '   333  loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br>      <b>D4</b>  <b>D5</b>  Arduino (   ,   -  ).     100...500     <b>GND</b> .      .       2  0,66 . <br><br>   . ,     (  ,      aliases),  ‚Äì  ,   ‚Äì . <br><br>         ¬´¬ª,     ¬´  ¬ª (,       ‚Äì  -           ,        ,      ;          ).        <b>OS_ResumeTask</b> . <br><br>     ,    .    ? , !          . ,    ,      ,         <b>end</b> . <br><br>    .    ,         <b>do ‚Äì loop</b> .    ‚Äì            ,   ,      ‚Äì       ,      .       <b>OS_Delay</b> .        ,       . <br><br>       <b>OS_SIM = TRUE</b>       ,   ,   ,   . <br><br> ,   , ,      ¬´  ¬ª,       .   ,    ¬´   ¬ª,         . <br><br>  ,    (, <b>task_1</b> ),       (     <b>end</b>   )     <b>task_1</b> ,       ,    <b>return</b> ,             ‚Äì  ,    <b>task_1</b> ( <b>do</b>   <b>task_1</b> ). <br><br>  <b>task_1</b> ,   ,   <b>OS_delay</b> , ,   ,   . <br><br>   ,    ,     <b>task_1</b> (  ,    <b>OS_delay</b> , ..  <b>loop</b> ),  , ¬´ ¬ª, ,      <b>task_2</b> .       <b>task_2</b> (      <b>do</b>    <b>task_2</b> )    <b>return</b> ,             ‚Äì  ,    <b>task_2</b> . <br><br>  <b>task_2</b> ,   ,   <b>OS_delay</b> , ,   ,   . <br><br>   ,    ,     <b>task_1</b> (  ,    <b>OS_delay</b> , ..  <b>loop</b> ),  , ¬´ ¬ª, ,      <b>task_2</b> .       ,       <b>task_1</b>     ,   ,      .  (  <b>loop</b>    <b>task_1</b> ),    . <br><br>  <b>task_1</b>   <b>loop</b> ,     ¬´ 1 ‚Äì  ‚Äì  2 ‚Äì ¬ª   . <br><br><h3>   </h3><br>         . <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_1() declare sub task_2() const OS_SIM = TURE '       '   dim hTopic as byte '     dim task_1_cnt as byte '    1 dim strMessage as string * 16 '  ' ***    *** OS_CreateMessage hTopic OS_Init my_err_trap OS_InitTask task_1 , 1 OS_InitTask task_2 , 1 OS_ResumeTask task_1 OS_ResumeTask task_2 OS_Sheduler end ' ***  *** sub task_1() do print "task 1" OS_Sheduler incr task_1_cnt '    1 if task_1_cnt &gt; 3 then print "task 1 is sending message to task 2" strMessage = "Hello, task 2!" '    2 OS_SendMessage hTopic , varptr(strMessage) task_1_cnt = 0 end if loop end sub sub task_2() do print "task 2 is waiting messages..." '      1 OS_WaitMessage hTopic print "message recieved: " ; OS_GetMessageString (hTopic) loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br>           : <br><br><blockquote> task 1 <br> task 2 is waiting messages‚Ä¶ <br> task 1 <br> task 1 <br> task 1 <br> task 1 is sending message to task 2 <br> task 1 <br> message recieved: Hello, task 2! <br> task 2 is waiting messages‚Ä¶ <br> task 1 <br> task 1 <br>  ... <br></blockquote><br>  ,        .    1  <b>task 1</b> ,     ,      .  2  <b>task 2 is waiting messages...</b> ,        <b>hTopic</b> ,     ,     1.    <b>task 1</b>     . ,   ,   2   ,     1   <b>incr</b> ,    . <br>   <b>task_1_cnt</b>   1   ,   ,    ‚Äì   <b>loop</b>    <b>task 1</b> .     ,   ,    2  ,    .    . <br><br><h3>   </h3><br>             : <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $regfile = "m328pdef.dat" $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 '   declare sub my_err_trap (byval err_code as byte) declare sub task_scankeys() declare sub task_led_1() declare sub task_led_2() '        led_1 alias portd.4 led_2 alias portd.5 config portd.4 = output config portd.5 = output button_1 alias pind.6 button_2 alias pind.7 config portd.6 = input config portd.7 = input '   dim eventButton_1 as byte dim eventButton_2 as byte ' ***    *** eventButton_1 = OS_CreateEvent '       eventButton_2 = OS_CreateEvent OS_Init my_err_trap OS_InitTask task_scankeys , 1 OS_InitTask task_led_1 , 1 OS_InitTask task_led_2 , 1 OS_ResumeTask task_scankeys OS_ResumeTask task_led_1 OS_ResumeTask task_led_2 OS_Sheduler end ' ***  *** sub task_scankeys() do debounce button_1 , 0 , btn_1_click , sub debounce button_2 , 0 , btn_2_click , sub OS_Sheduler loop btn_1_click: OS_SignalEvent eventButton_1 return btn_2_click: OS_SignalEvent eventButton_2 return end sub sub task_led_1() do OS_WaitEvent eventButton_1 toggle led_1 loop end sub sub task_led_2() do OS_WaitEvent eventButton_2 toggle led_2 loop end sub ' **************************************************** '   sub my_err_trap(err_code as byte) print "OS Error: "; err_code end sub</span></span></code> </pre> <br><h2>     AQUA RTOS </h2><br><br>   ,         .           ;     ,   ,  .  ,     : ,      95‚Ä¶97¬∞;               (,  GSM-),      . <br><br><h3>    </h3><br>         ¬´ +  + ¬ª  ,     .     ,    . <br>        : <br><br><ul><li>     ‚Äì <b>ControlHeater()</b> </li><li>      ‚Äì <b>ShowGoods()</b> </li><li>  /    ‚Äì <b>AcceptMoney()</b> </li><li>   ‚Äì <b>ScanKeys()</b> </li><li>   ‚Äì <b>MakeChange()</b> </li><li>   ‚Äì <b>ReleaseCoffee()</b> </li><li>    ‚Äì <b>Alarm()</b> </li></ul><br>        . <br> <b>ControlHeater()</b>  ,        .       ,      ,    .      .     5. <br> <b>ShowGoods()</b>   .       ,   -   .      8,             . <br> <b>ScanKeys()</b>     ,       .     3,      40 . <br> <b>AcceptMoney()</b>     .      ,   <b>ScanKeys(),</b>     20 . <br> <b>MakeChange ()</b>     .     <b>ReleaseCoffee()</b>    10. <br> <b>ReleaseCoffee()</b>   ,           .       2. <br>   ‚Äì    ,  <b>Alarm()</b>      ‚Äì 1,     ,      . <br><br>  ,       .  ,      EEPROM   ,       . <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    declare sub ControlHeater() declare sub ShowGoods() declare sub AcceptMoney() declare sub ScanKeys() declare sub MakeChange () declare sub ReleaseCoffee() declare sub Alarm()</span></span></code> </pre> <br>     RTOS      :          (  ,    ) ‚Äì      . <br><br> , <b>ReleaseCoffee()</b>    : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> ReleaseCoffee() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> OS_WaitMessage bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) Release wItem <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre> <br>  <b>ReleaseCoffee</b>        <b>bCoffeeSelection</b>    ,     (   ,      ).    , <b>ReleaseCoffee()</b>    ,    ,     (  ) <b>wItem</b>    <b>OS_GetMessage</b>    .  <b>ReleaseCoffee()</b>   ,       : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage()</code> </pre> <br>    , <b>ShowGoods()</b>            .       <b>ReleaseCoffee()</b> ,   .       : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">dim</span></span> bGoodsReliased as byte bGoodsReliased = OS_CreateEvent()</code> </pre> <br>    <b>ReleaseCoffee()</b>   <b>Release wItem</b>     <b>bGoodsReliased</b> : <br><br><pre> <code class="vbscript hljs">OS_SignalEvent bGoodsReliased</code> </pre> <br><h3>   </h3><br>  ,     ,    ,      ,     .      <b>OS_Init</b> : <br><br><pre> <code class="vbscript hljs">OS_Init Mailfuncion</code> </pre> <br>       ‚Äì ,      : <br><br><pre> <code class="vbscript hljs"><span class="hljs-keyword"><span class="hljs-keyword">sub</span></span> Mailfuncion (bCoffeeErr) print <span class="hljs-string"><span class="hljs-string">"Mailfunction! Error #: "</span></span>; bCoffeeErr <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isErrCritical (bCoffeeErr) = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> CallService(bCoffeeErr) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sub</span></span></code> </pre><br>      (    -  :  ,  GSM-  ..),   ,   ,    . <br><br><h3>   </h3><br>   ,  ,   ..     ,   .  ,           <b>OS_InitTask</b> : <br><br><pre> <code class="vbscript hljs">OS_InitTask ControlHeater , <span class="hljs-number"><span class="hljs-number">5</span></span> OS_InitTask ShowGoods , <span class="hljs-number"><span class="hljs-number">8</span></span> OS_InitTask AcceptMoney , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask ScanKeys , <span class="hljs-number"><span class="hljs-number">3</span></span> OS_InitTask MakeChange, <span class="hljs-number"><span class="hljs-number">10</span></span> OS_InitTask ReleaseCoffee , <span class="hljs-number"><span class="hljs-number">2</span></span> OS_InitTask Alarm , <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>      , ,    , ,         .          .     ,      <b>OS_ResumeTask</b>    ¬´  ¬ª: <br><br><pre> <code class="vbscript hljs">OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm</code> </pre> <br>   ,         ;          ¬´¬ª       .  <b>OS_ResumeTask</b>           (  ),    . ,  ,    ,   . <br><br><h3>   </h3><br>     ,   .     : <br><br><pre> <code class="vbscript hljs">OS_Sheduler</code> </pre> <br>          <b>end</b> ‚Äì         . <br><br>     : <br><br><pre> <code class="vbscript hljs"><span class="hljs-comment"><span class="hljs-comment">'    config submode = old $include "..\aquaRTOS_1.05.bas" $include "coffee_hardware.bas" '      '       Coffee_ $regfile = "m328pdef.dat" ' Arduino Nano v3 $crystal = 16000000 $hwstack = 48 $swstack = 48 $framesize = 64 Coffee_InitHardware '    '   declare sub Mailfuncion (byval bCoffeeErr as byte) '   declare sub ControlHeater () '   declare sub ShowGoods () '    declare sub AcceptMoney () '   declare sub ScanKeys () '   declare sub MakeChange () '      declare sub ReleaseCoffee () '   declare sub Alarm () '    '     Coffee_InitHardware () '   dim wMoney as long '    dim wGoods as long '   ' ***    *** '   OS_Init Mailfuncion '       dim bCoffeeSelection as byte bCoffeeSelection = OS_CreateMessage() '     dim bGoodsReliased as byte bGoodsReliased = OS_CreateEvent() '   OS_InitTask ControlHeater , 5 OS_InitTask ShowGoods , 8 OS_InitTask AcceptMoney , 3 OS_InitTask ScanKeys , 3 OS_InitTask MakeChange, 10 OS_InitTask ReleaseCoffee , 2 OS_InitTask Alarm , 1 '     OS_ResumeTask ControlHeater OS_ResumeTask ShowGoods OS_ResumeTask AcceptMoney OS_ResumeTask ScanKeys OS_ResumeTask MakeChange OS_ResumeTask ReleaseCoffee OS_ResumeTask Alarm '   OS_Sheduler end ' ***   *** ' ----------------------------------- sub ControlHeater() do select case GetWaterTemp() case is &gt; 97 Coffee_HeaterOff '   case is &lt; 95 Coffee_HeaterOn '   case is &lt; 5 CallServce (WARNING_WATER_FROZEN) '   end select OS_Delay 60000 '  1  loop end sub ' ----------------------------------- sub ShowGoods() do LEDS = Coffee_GetDrinkSupplies() '    D, '         '   LEDS OS_WaitEvent bGoodsReliased '   " " loop end sub ' ----------------------------------- sub AcceptMoney() do wMoney = wMoney + ReadMoneyAcceptor() OS_Delay 20 loop end sub ' ----------------------------------- sub ScanKeys() do wGoods = ButtonPressed() if wMoney &gt;= GostOf(wGoods) then OS_SendMessage bCoffeeSelection, wGoods '     bCoffeeSelection,  '     end if OS_Delay 40 loop end sub ' ----------------------------------- sub MakeChange() do OS_WaitEvent bGoodsReliased '   " " Refund wMoney loop end sub ' ----------------------------------- sub ReleaseCoffee() do OS_WaitMessage bCoffeeSelection '  bCoffeeSelection wItem = OS_GetMessage(bCoffeeSelection) '   Release wItem '    wMoney = wMoney ‚Äì CostOf (wItem) '     OS_SignalEvent bGoodsReliased '     '  ,       : ' MakeChange  ShowGoods '  ,  ,     loop end sub ' ----------------------------------- sub Alarm() do OS_Delay 1000 if Hijack() = 1 then CallPolice() end if loop end sub ' ----------------------------------- ' ***    *** sub Mailfuncion (bCoffeeErr) print "Mailfunction! Error #: "; bCoffeeErr if isErrCritical (bCoffeeErr) = 1 then CallService() end if end sub</span></span></code> </pre> <br> ,             ,    .              <b>OS_SendMessage()</b>  ,        /.     .  ,   ,  ,  ,     . <br><br><h2>   AQUA RTOS </h2><br> <a href=""><b>   1.05     </b></a> <br><br><h2>  </h2><br> <i>Q:  AQUA?</i> <br> A: ,    ,   ¬´ ¬ª,   ,   .   ,   ,     ,  ,  ¬´ ¬ª   WiFi-.   ,  ,  ,     EEPROM  ,  , - .            .      ‚Äì       ¬´ ¬ª,    ,  .    ,    .    AQUA. <br><br> <i>Q:        ?</i> <br> A: . ,  ,          ,      ,    ,    .   ,        .    ,   ,      ,       ,    ,  , -,  .   ,         . , -     ( ? ‚Äì   )    .         . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453708/">https://habr.com/ru/post/fr453708/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453694/index.html">Connectez-vous √† Windows via SSH comme sous Linux</a></li>
<li><a href="../fr453696/index.html">Reliure angulaire bidirectionnelle, un peu plus de compr√©hension</a></li>
<li><a href="../fr453698/index.html">L'information quantique dans la conscience quantique</a></li>
<li><a href="../fr453700/index.html">Le√ßons sur SDL 2: Le√ßon 1 - Bonjour, SDL 2</a></li>
<li><a href="../fr453706/index.html">Comment j'ai r√©ussi l'examen de certification Google Cloud Professional Data Engineer</a></li>
<li><a href="../fr453710/index.html">Pratique de d√©veloppement dans les grands projets: mitap SberPractice iOS # 1</a></li>
<li><a href="../fr453712/index.html">Comment eBay a fait un scanner de codes-barres sur WebAssembly</a></li>
<li><a href="../fr453714/index.html">Client de test TON (Telegram Open Network) et le nouveau langage Fift pour les contrats intelligents</a></li>
<li><a href="../fr453716/index.html">Coworking √† la campagne pour les informaticiens familiaux - y a-t-il quelqu'un?</a></li>
<li><a href="../fr453720/index.html">Subtilit√©s d'expressions lambda en C #</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>