<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©üèª‚Äçüî¨ üë®üèø üç£ 6 histoires pratiques de nos jours de semaine SRE üëâüèø üë®üèΩ‚Äçüî¨ üïñ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="L'infrastructure Web moderne se compose de nombreux composants √† des fins diverses, √©vidents et peu interconnect√©s. Cela devient particuli√®rement √©vid...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>6 histoires pratiques de nos jours de semaine SRE</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/flant/blog/471892/"><img src="https://habrastorage.org/webt/7_/c-/_w/7_c-_wura080ohc4zdfyq6ummtw.png"><br><br>  L'infrastructure Web moderne se compose de nombreux composants √† des fins diverses, √©vidents et peu interconnect√©s.  Cela devient particuli√®rement √©vident lors de l'exploitation d'applications qui utilisent diff√©rentes piles de logiciels, ce qui, avec l'av√®nement des microservices, a commenc√© √† se produire litt√©ralement √† chaque √©tape.  Des facteurs externes (API tierces, services, etc.) s'ajoutent au ¬´plaisir¬ª g√©n√©ral, ce qui complique une image d√©j√† difficile. <br><br>  En g√©n√©ral, m√™me si ces applications seront unies par des id√©es et des solutions architecturales communes, pour √©liminer les probl√®mes inhabituels, elles doivent souvent se frayer un chemin dans les prochains espaces sauvages inconnus.  Que de tels probl√®mes surviennent n'est qu'une question de temps.  Ce sont les exemples de notre derni√®re pratique auxquels cet article est consacr√©.  Distribution: Golang, Sentry, RabbitMQ, nginx, PostgreSQL et autres. <a name="habracut"></a><br><br><h2>  Histoire n ¬∞ 1.  Golang et HTTP / 2 </h2><br>  L'ex√©cution d'un benchmark qui ex√©cute de nombreuses requ√™tes HTTP vers une application Web a conduit √† des r√©sultats inattendus.  Une simple application Go dans le processus de r√©f√©rence va √† une autre application Go situ√©e derri√®re l'entr√©e / openresty.  Lorsque HTTP / 2 est activ√©, nous obtenons des erreurs avec le code 400 pour certaines demandes. Pour comprendre la raison de ce comportement, nous avons supprim√© l'application Go √† l'extr√©mit√© de la cha√Æne et cr√©√© un emplacement simple dans Ingress, qui renvoie toujours 200. Le comportement n'a pas chang√©! <cut></cut><br><br>  Il a ensuite √©t√© d√©cid√© de reproduire le script en dehors de l'environnement Kubernetes - sur un autre mat√©riel.  Le r√©sultat a √©t√© un Makefile, √† l'aide duquel deux conteneurs sont lanc√©s: dans l'un - les benchmarks qui vont √† nginx, dans l'autre - dans Apache.  Les deux √©coutent HTTP / 2 avec un certificat auto-sign√©.  Le temps de fonctionnement final voir dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=https://github.com/flant/examples/tree/master/2019/09-">ce r√©f√©rentiel</a> . <br><br>  Ex√©cutez les benchmarks avec <code>concurrency=200</code> : <br><br>  1.1.  Nginx: <br><br><pre> <code class="plaintext hljs">Completed 0 requests Completed 1000 requests Completed 2000 requests Completed 3000 requests Completed 4000 requests Completed 5000 requests Completed 6000 requests Completed 7000 requests Completed 8000 requests Completed 9000 requests ----- Bench results begin ----- Requests per second: 10336.09 Failed requests: 1623 ----- Bench results end -----</code> </pre> <br>  1.2.  Apache: <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11427.60 Failed requests: 0 ----- Bench results end -----</code> </pre> <br>  Nous supposons que le point ici est une impl√©mentation moins stricte de HTTP / 2 dans Apache. <br><br>  Essayons avec <code>concurrency=1000</code> : <br><br>  2.1.  Nginx: <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11274.92 Failed requests: 4205 ----- Bench results end -----</code> </pre> <br>  2.2.  Apache: <br><br><pre> <code class="plaintext hljs">‚Ä¶ ----- Bench results begin ----- Requests per second: 11211.48 Failed requests: 5 ----- Bench results end -----</code> </pre> <br>  En m√™me temps, on constate que les r√©sultats <i>ne</i> sont <i>pas reproduits √† chaque fois</i> : certains lancements passent sans probl√®me. <br><br>  Une recherche de probl√®mes sur le github du projet Golang a conduit √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># 25009</a> et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="># 32441</a> .  Gr√¢ce √† eux, nous sommes pass√©s au <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">PR 903</a> : d√©sactiver HTTP / 2 dans Go par d√©faut! <br><br>  L'interpr√©tation des r√©sultats de r√©f√©rence sans plonger profond√©ment dans l'architecture des serveurs Web ci-dessus est assez difficile.  Dans un cas sp√©cifique, il suffisait de d√©sactiver HTTP / 2 pour le service sp√©cifi√©. <br><br><h2>  Histoire n ¬∞ 2.  Vieux symfony et sentinelle </h2><br>  Dans l'un des projets, une tr√®s ancienne version du framework PHP symfony (v2.3) fonctionne toujours.  Un ancien client Raven et une classe auto-√©crite en PHP lui sont attach√©s ¬´dans le kit¬ª, ce qui complique un peu le d√©bogage. <br><br>  Apr√®s le transfert de l'un des services de Kubernetes √† Sentry, utilis√© pour suivre les erreurs dans l'application de ce projet, les √©v√©nements ont soudainement cess√© de se produire.  Pour reproduire ce comportement, nous avons utilis√© des exemples du site Web Sentry, en prenant deux options et en copiant le DSN √† partir des param√®tres Sentry.  Visuellement, tout fonctionnait: des messages d'erreur (pr√©tendument) √©taient envoy√©s les uns apr√®s les autres. <br><br>  Option de v√©rification JavaScript: <br><br><pre> <code class="javascript hljs">&lt;!DOCTYPE html&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"https://browser.sentry-cdn.com/5.6.3/bundle.min.js"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">integrity</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"sha384-/Cqa/8kaWn7emdqIBLk3AkFMAHBk0LObErtMhO+hr52CntkaurEnihPmqYj3uJho"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">crossorigin</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"anonymous"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"><span class="xml"><span class="undefined"> </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">JavaScript in Body</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"demo"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">A Paragraph.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">p</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"button"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"myFunction()"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Try it</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="javascript"><span class="xml"><span class="javascript"> Sentry.init({ </span></span><span class="hljs-attr"><span class="xml"><span class="javascript"><span class="hljs-attr">dsn</span></span></span></span><span class="xml"><span class="javascript">: </span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12'</span></span></span></span><span class="xml"><span class="javascript"> }); </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">try</span></span></span></span><span class="xml"><span class="javascript"> { </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">throw</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">new</span></span></span></span><span class="xml"><span class="javascript"> </span></span><span class="hljs-built_in"><span class="xml"><span class="javascript"><span class="hljs-built_in">Error</span></span></span></span><span class="xml"><span class="javascript">(</span></span><span class="hljs-string"><span class="xml"><span class="javascript"><span class="hljs-string">'Caught'</span></span></span></span><span class="xml"><span class="javascript">); } </span></span><span class="hljs-keyword"><span class="xml"><span class="javascript"><span class="hljs-keyword">catch</span></span></span></span><span class="xml"><span class="javascript"> (err) { Sentry.captureException(err); } </span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">body</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">html</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  De m√™me en Python: <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sentry_sdk <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> init, capture_message init(<span class="hljs-string"><span class="hljs-string">"http://33dddd76e9f0c4ddcdb51@sentry.kube-dev.test//12"</span></span>) capture_message(<span class="hljs-string"><span class="hljs-string">"Hello World"</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Will create an event. raise ValueError()</span></span></code> </pre> <br>  Cependant, ils ne sont pas entr√©s dans Sentry.  Lors de l'envoi d'un message, l'illusion est cr√©√©e que le message a √©t√© envoy√©, car les clients g√©n√®rent imm√©diatement un hachage pour le probl√®me. <br><br>  En cons√©quence, le probl√®me a √©t√© r√©solu tr√®s simplement: l'envoi d'√©v√©nements est all√© √† HTTP et le service Sentry n'a √©cout√© que HTTPS.  Une redirection de HTTP vers HTTPS a √©t√© fournie, mais l'ancien client (le code du c√¥t√© symfony) n'a pas pu suivre les redirections, ce qui n'est pas pr√©vu par d√©faut de nos jours. <br><br><h2>  Histoire n ¬∞ 3.  RabbitMQ et proxy tiers </h2><br>  Dans un projet, le cloud Evotor est utilis√© pour connecter les caisses enregistreuses.  En fait, cela fonctionne comme un proxy: les requ√™tes POST d'Evotor vont directement √† RabbitMQ - via le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">plugin STOMP</a> impl√©ment√© via les connexions WebSocket. <br><br>  L'un des d√©veloppeurs a fait des demandes de test √† l'aide de Postman et a re√ßu les r√©ponses attendues de <code>200 OK</code> , cependant, les demandes via le cloud ont conduit √† une <code>405 Method Not Allowed</code> inattendue <code>405 Method Not Allowed</code> . <br><br><div class="spoiler">  <b class="spoiler_title">200 OK</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-2 pod_name: nginx-2bpt7 container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:42:50+00:00 request_id: 1271dba228f0943ab2df0196ff0d7f67 user: client address: 100.200.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.eeeeffff111:1.onlinecassa:55556666/get request_query: referrer: user_agent: Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/65.0.3325.181 Safari/537.36 content_kind: cacheable namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 2538 nginx_upstream_response_time: 0.008 nginx_upstream_status: 200 bytes_received: 757 bytes_sent: 1254 request_time: 0 status: 200 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">405 M√©thode non autoris√©e</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">source: kubernetes namespace: kube-nginx-ingress host: kube-node-1 pod_name: nginx-4xx6h container_name: nginx stream: stdout app: nginx controller-revision-hash: 5bdbfd564 pod-template-generation: 25 time: 2019-09-10T09:46:26+00:00 request_id: b8dd789604864c95b4af499ed6805630 user: client address: 200.100.300.400 protocol: HTTP/1.1 scheme: http method: POST host: rmq-review.kube-dev.client.domain path: /api/queues/vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get request_query: referrer: user_agent: ru.evotor.proxy/37 content_kind: cache-headers-not-present namespace: review ingress: stomp-ws service: rabbitmq service_port: stats vhost: rmq-review.kube-dev.client.domain location: / nginx_upstream_addr: 10.127.1.1:15672 nginx_upstream_bytes_received: 134 nginx_upstream_response_time: 0.004 nginx_upstream_status: 405 bytes_received: 878 bytes_sent: 137 request_time: 0 status: 405 upstream_response_time: 0 upstream_retries: 0</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Demande Tcpdump d'Evotor</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">200.100.300.400.21519 &gt; 100.200.400.300: Flags [P.], cksum 0x8e29 (correct), seq 1:879, ack 1, win 221, options [nop,nop,TS val 2313007107 ecr 79097074], length 878: HTTP, length: 878 POST /api/queues//vhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 device-model: ST-5 device-os: android Accept-Encoding: gzip content-type: application/json; charset=utf-8 connection: close accept: application/json x-original-forwarded-for: 10.11.12.13 originhost: rmq-review.kube-dev.client.domain x-original-uri: /api/v2/apps/e114-aaef-bbbb-beee-abadada44ae/requests x-scheme: https accept-encoding: gzip user-agent: ru.evotor.proxy/37 Authorization: Basic X-Evotor-Store-Uuid: 20180417-73DC-40C9-80B7-00E990B77D2D X-Evotor-Device-Uuid: 20190909-A47B-40EA-806A-F7BC33833270 X-Evotor-User-Id: 01-000000000147888 Content-Length: 58 Host: rmq-review.kube-dev.client.domain {"count":1,"encoding":"auto","ackmode":"ack_requeue_true"}[!http] 12:53:30.095385 IP (tos 0x0, ttl 64, id 5512, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [.], cksum 0xfa81 (incorrect -&gt; 0x3c87), seq 1, ack 879, win 60, options [nop,nop,TS val 79097122 ecr 2313007107], length 0 12:53:30.096876 IP (tos 0x0, ttl 64, id 5513, offset 0, flags [DF], proto TCP (6), length 189) 100.200.400.300:80 &gt; 200.100.300.400.21519: Flags [P.], cksum 0xfb0a (incorrect -&gt; 0x03b9), seq 1:138, ack 879, win 60, options [nop,nop,TS val 79097123 ecr 2313007107], length 137: HTTP, length: 137 HTTP/1.1 405 Method Not Allowed Date: Tue, 10 Sep 2019 10:53:30 GMT Content-Length: 0 Connection: close allow: HEAD, GET, OPTIONS</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">Tcpdump demande faite par curl</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">777.10.74.11.61211 &gt; 100.200.400.300:80: Flags [P.], cksum 0x32a8 (correct), seq 1:397, ack 1, win 2052, options [nop,nop,TS val 734012594 ecr 4012360530], length 396: HTTP, length: 396 POST /api/queues/%2Fvhost/queue.gen.ef7fb93387ca9b544fc1ecd581cad4a9:1.onlinecassa:55556666/get HTTP/1.1 Host: rmq-review.kube-dev.client.domain User-Agent: curl/7.54.0 Authorization: Basic = Content-Type: application/json Accept: application/json Content-Length: 58 {"count":1,"ackmode":"ack_requeue_true","encoding":"auto"}[!http] 12:40:11.001442 IP (tos 0x0, ttl 64, id 50844, offset 0, flags [DF], proto TCP (6), length 52) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [.], cksum 0x2d01 (incorrect -&gt; 0xfa25), seq 1, ack 397, win 59, options [nop,nop,TS val 4012360590 ecr 734012594], length 0 12:40:11.017065 IP (tos 0x0, ttl 64, id 50845, offset 0, flags [DF], proto TCP (6), length 2621) 100.200.400.300:80 &gt; 777.10.74.11.61211: Flags [P.], cksum 0x370a (incorrect -&gt; 0x6872), seq 1:2570, ack 397, win 59, options [nop,nop,TS val 4012360605 ecr 734012594], length 2569: HTTP, length: 2569 HTTP/1.1 200 OK Date: Tue, 10 Sep 2019 10:40:11 GMT Content-Type: application/json Content-Length: 2348 Connection: keep-alive Vary: Accept-Encoding cache-control: no-cache vary: accept, accept-encoding, origin</code> </pre> </div></div><br>  L'≈ìil exerc√© d'un ing√©nieur voit imm√©diatement la diff√©rence: <br><br><ul><li>  curl: <code>POST /api/queues/%2Fclient‚Ä¶</code> </li><li>  Evotor: <code>POST /api/queues//client‚Ä¶</code> </li></ul><br>  Le fait est que dans un cas, un <code>//vhost</code> incompr√©hensible (pour RabbitMQ) <code>//vhost</code> , et dans l'autre - <code>%2Fvhost</code> , ce qui est le comportement attendu lorsque: <br><br><pre> <code class="plaintext hljs"># rabbitmqctl list_vhosts Listing vhosts ... /vhost</code> </pre> <br>  Dans le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">num√©ro</a> du projet RabbitMQ sur ce sujet, le d√©veloppeur explique: <br><br><blockquote>  Nous ne remplacerons pas% -encoding.  C'est un moyen standard de codage de chemin URL et cela depuis des si√®cles.  Supposer que% -encoding dans les outils HTTP dispara√Ætra en raison m√™me du cadre le plus populaire en supposant que ces chemins URL sont "malveillants" est √† courte vue et na√Øf.  Le nom d'h√¥te virtuel par d√©faut peut √™tre <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">modifi√© en n'importe quelle valeur</a> (telle que celle qui n'utilise pas de barres obliques ou tout autre caract√®re n√©cessitant un codage%) et au moins avec la version Pivotal BOSH de RabbitMQ, l'h√¥te virtuel par d√©faut est supprim√© de toute fa√ßon au moment du d√©ploiement . </blockquote><br>  Le probl√®me a √©t√© r√©solu sans implication suppl√©mentaire de nos ing√©nieurs (c√¥t√© Evotor apr√®s les avoir contact√©s). <br><br><h2>  Histoire n ¬∞ 4.  G√®ne dans PostgreSQL </h2><br>  PostgreSQL a un index tr√®s utile, qui est souvent oubli√©.  Cette histoire a commenc√© par des plaintes concernant les freins de l'application.  Dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article r√©cent,</a> nous avons d√©j√† donn√© un exemple de flux de travail approximatif lors de l'analyse de telles situations.  Et ici, notre APM - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Atatus</a> - a montr√© l'image suivante: <br><br><img src="https://habrastorage.org/webt/t9/yy/gz/t9yygzwma4valcmjnpt-lbfxpdi.png"><br><br>  √Ä 10 heures du matin, le temps que l'application passe √† travailler avec la base de donn√©es augmente.  Comme pr√©vu, la raison r√©side dans les r√©ponses lentes du SGBD.  Pour nous, analyser les requ√™tes, identifier les zones probl√©matiques et ¬´suspendre¬ª les index est une routine compr√©hensible.  L' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">okm√®tre que</a> nous utilisons y contribue <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">beaucoup</a> : il existe √† la fois des panneaux standard pour surveiller l'√©tat des serveurs et la possibilit√© de cr√©er <i>rapidement le</i> n√¥tre - avec la sortie de mesures probl√©matiques: <br><br><img src="https://habrastorage.org/webt/5r/8h/2p/5r8h2pfgbo_rxewvzgf_3jyjcii.png"><br><br>  Les graphiques de charge du processeur indiquent que l'une des bases de donn√©es est charg√©e √† 100%.  Pourquoi?  Les nouveaux panneaux PostgreSQL vous demanderont: <br><br><img src="https://habrastorage.org/webt/i0/pq/de/i0pqdejoizrp518mnsnguoljkdg.png"><br><br>  La cause des probl√®mes est imm√©diatement apparente - le principal consommateur du CPU: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> u.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">users</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> u.id = ? &amp; u.field_1 = ? <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> u.field_2 <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> <span class="hljs-string"><span class="hljs-string">'%somestring%'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> u.id <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> ?</code> </pre> <br>  Compte tenu du plan de travail de la requ√™te probl√®me, nous avons constat√© que le filtrage par champs index√©s de la table donne une s√©lection trop grande: la base de donn√©es re√ßoit plus de 70 000 lignes par <code>id</code> et <code>field_1</code> , puis recherche une sous-cha√Æne parmi elles.  Il s'av√®re que <code>LIKE</code> sur une sous-cha√Æne it√®re sur une grande quantit√© de donn√©es texte, ce qui conduit √† un s√©rieux ralentissement de l'ex√©cution des requ√™tes et √† une augmentation de la charge du processeur. <br><br>  <i>Ici, vous pouvez √† juste titre remarquer qu'un probl√®me architectural n'est pas exclu (une correction de la logique d'application ou m√™me un moteur de texte int√©gral est requis ...), mais il n'y a pas de temps pour le retravailler, mais il aurait d√ª fonctionner rapidement il y a 15 minutes.</i>  <i>En m√™me temps, le mot recherch√© est en fait un identifiant (et pourquoi pas dans un champ s√©par√©? ..), qui produit des unit√©s de lignes.</i>  <i>En fait, si nous pouvions composer un index sur ce champ de texte, tous les autres deviendraient inutiles.</i> <br><br>  La derni√®re solution actuelle consiste √† ajouter un index GIN pour <code>field_2</code> .  C‚Äôest le h√©ros du jour - ce m√™me ¬´g√©nie¬ª.  En bref, GIN est une sorte d'index qui fonctionne tr√®s bien dans la recherche en texte int√©gral, l'acc√©l√©rant qualitativement.  Vous pouvez en savoir plus √† ce sujet, par exemple, dans <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ce merveilleux mat√©riel</a> . <br><br><img src="https://habrastorage.org/webt/sm/lw/qd/smlwqdjwdystzwexf0rfz-hk6qq.png"><br><br>  Comme vous pouvez le voir, cette op√©ration simple a permis de supprimer la charge suppl√©mentaire, et avec elle - et d'√©conomiser de l'argent pour le client. <br><br><h2>  Histoire n ¬∞ 5.  Mise en cache S3 dans Nginx </h2><br>  Le stockage cloud compatible S3 figure depuis longtemps sur la liste des technologies utilis√©es par de nombreux projets.  Si vous avez besoin d'un stockage d'images fiable pour votre site ou pour des donn√©es de r√©seau neuronal, Amazon S3 est un excellent choix.  La fiabilit√© du stockage et la haute disponibilit√© des donn√©es (et l'absence de la n√©cessit√© de ¬´cl√¥turer le jardin¬ª) sont captivantes. <br><br>  Cependant, parfois pour √©conomiser de l'argent - car g√©n√©ralement le paiement pour S3 va pour les demandes et pour le trafic - une bonne solution consiste √† installer un serveur proxy de mise en cache devant le stockage.  Cette m√©thode r√©duira les co√ªts en ce qui concerne, par exemple, les avatars des utilisateurs, qui sont nombreux sur chaque page. <br><br>  Il semblerait que c'est plus facile que de prendre nginx et de configurer des proxys avec mise en cache, revalidation, mise √† jour en arri√®re-plan et autres blackjack?  Cependant, comme ailleurs, il y a quelques nuances ... <br><br>  La configuration approximative d'un tel proxy avec mise en cache ressemblait √† ceci: <br><br><pre> <code class="plaintext hljs">proxy_cache_key $uri; proxy_cache_methods GET HEAD; proxy_cache_lock on; proxy_cache_revalidate on; proxy_cache_background_update on; proxy_cache_use_stale updating error timeout invalid_header http_500 http_502 http_503 http_504; proxy_cache_valid 200 1h; location ~ ^/(?&lt;bucket&gt;avatars|images)/(?&lt;filename&gt;.+)$ { set $upstream $bucket.s3.amazonaws.com; proxy_pass http://$upstream/$filename; proxy_set_header Host $upstream; proxy_cache aws; proxy_cache_valid 200 1h; proxy_cache_valid 404 60s; }</code> </pre> <br>  Et en g√©n√©ral, cela a fonctionn√©: les images √©taient affich√©es, tout allait bien avec le cache ... cependant, des probl√®mes avec les clients AWS S3 sont apparus.  En particulier, le client de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">aws-sdk-php a</a> cess√© de fonctionner.  L'analyse des journaux nginx a montr√© que le code en amont renvoyait 403 pour les requ√™tes HEAD, et la r√©ponse contenait une erreur sp√©cifique: <code>SignatureDoesNotMatch</code> .  Lorsque nous avons vu que nginx fait une demande GET en amont, tout s'est mis en place. <br><br>  Le fait est que le client S3 signe chaque demande et que le serveur v√©rifie cette signature.  Dans le cas d'un proxy simple, tout fonctionne bien: la requ√™te parvient au serveur sans changement.  Cependant, lorsque la mise en cache est activ√©e, nginx commence √† optimiser le travail avec le backend et remplace les requ√™tes HEAD par GET.  La logique est simple: il est pr√©f√©rable de r√©cup√©rer et d'enregistrer l'int√©gralit√© de l'objet, puis toutes les requ√™tes HEAD du cache √©galement.  Cependant, dans notre cas, la demande ne peut pas √™tre modifi√©e - elle est sign√©e. <br><br>  Il existe essentiellement deux solutions: <br><br><ol><li>  Ne conduisez pas les clients S3 via des proxys; </li><li>  s'il est "n√©cessaire", d√©sactivez l'option <code>proxy_cache_convert_head</code> et ajoutez <code>$request_method</code> √† la cl√© de mise en cache.  Dans ce cas, nginx envoie les demandes HEAD ¬´en l'√©tat¬ª et met en cache les r√©ponses s√©par√©ment. </li></ol><br><h2>  Histoire n ¬∞ 6.  DDoS et contenu utilisateur Google </h2><br>  Le dimanche soir n'a laiss√© pr√©sager de probl√®mes que - du coup!  - La file d'attente d'invalidation du cache sur les serveurs de p√©riph√©rie n'a pas augment√©, ce qui donne du trafic aux utilisateurs r√©els.  C'est un sympt√¥me tr√®s √©trange: apr√®s tout, le cache est impl√©ment√© en m√©moire et n'est pas li√© aux disques durs.  Vider le cache dans l'architecture utilis√©e est une op√©ration bon march√©, donc cette erreur ne peut appara√Ætre que dans le cas d'une charge vraiment √©lev√©e.  Cela a √©t√© confirm√© par le fait que les m√™mes serveurs ont commenc√© √† signaler l'apparition de 500 erreurs <i>(pointes de ligne rouges dans le graphique ci-dessous)</i> . <br><br><img src="https://habrastorage.org/webt/3-/cr/ec/3-crecmpt9kbmt7o_6gujxwiru0.png"><br><br>  Une telle forte augmentation a entra√Æn√© des d√©passements de CPU: <br><br><img src="https://habrastorage.org/webt/2t/vn/cw/2tvncw9vkrti9ysqmil7bmcztk0.png"><br><br>  Une analyse rapide a montr√© que les demandes ne provenaient pas des domaines principaux, mais √† partir des journaux, il est devenu clair qu'elles √©taient en vhost par d√©faut.  En cours de route, il s'est av√©r√© que de nombreux utilisateurs am√©ricains sont venus √† la ressource russe.  De telles circonstances soul√®vent toujours imm√©diatement des questions. <br><br>  Apr√®s avoir collect√© des donn√©es √† partir des journaux nginx, nous avons r√©v√©l√© que nous avons affaire √† un certain botnet: <br><br><pre> <code class="plaintext hljs">35.222.30.127 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?ITPDH=XHJI" HTTP/1.1 301 178 "http://example.ru/ORQHYGJES" "Mozilla/5.0 (Windows; U; Windows NT 5.2; en-US; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?ITPDH=XHJI" "redirect=http://www.example.ru/?ITPDH=XHJI" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?REVQSD=VQPYFLAJZ" HTTP/1.1 301 178 "http://www.usatoday.com/search/results?q=MLAJSBZAK" "Mozilla/5.0 (Windows; U; MSIE 7.0; Windows NT 6.0; en-US)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?REVQSD=VQPYFLAJZ" "redirect=http://www.example.ru/?REVQSD=VQPYFLAJZ" ancient=1 cipher=- "LM=-;EXP=-;CC=-" 107.178.215.0 US [15/Sep/2019:21:40:00 +0300] GET "http://example.ru/?MPYGEXB=OMJ" HTTP/1.1 301 178 "http://engadget.search.aol.com/search?q=MIWTYEDX" "Mozilla/5.0 (Windows; U; Windows NT 6.1; en; rv:1.9.1.3) Gecko/20090824 Firefox/3.5.3 (.NET CLR 3.5.30729)" "-" "upcache=-" "upaddr=-" "upstatus=-" "uplen=-" "uptime=-" spdy="" "loc=wide-closed.example.ru.undef" "rewrited=/?MPYGEXB=OMJ" "redirect=http://www.example.ru/?MPYGEXB=OMJ" ancient=1 cipher=- "LM=-;EXP=-;CC=-"</code> </pre> <br>  Un mod√®le compr√©hensible est trac√© dans les journaux: <br><br><ul><li>  v√©ritable user-agent; </li><li>  une requ√™te √† l'URL racine avec un argument GET al√©atoire pour √©viter d'entrer dans le cache; </li><li>  r√©f√©rent indique que la demande provient d'un moteur de recherche. </li></ul><br>  Nous collectons les adresses et v√©rifions leur affiliation - elles appartiennent toutes √† <code>googleusercontent.com</code> , avec deux sous-r√©seaux (107.178.192.0/18 et 34.64.0.0/10).  Ces sous-r√©seaux contiennent des machines virtuelles GCE et divers services, tels que la traduction de pages. <br><br>  Heureusement, l'attaque n'a pas dur√© si longtemps (environ une heure) et a progressivement diminu√©.  Il semble que les algorithmes de protection √† l'int√©rieur de Google aient fonctionn√©, donc le probl√®me a √©t√© r√©solu "par lui-m√™me". <br><br>  Cette attaque n'a pas √©t√© destructrice, mais a soulev√© des questions utiles pour l'avenir: <br><br><ul><li>  Pourquoi les anti-ddos n'ont-ils pas fonctionn√©?  Un service externe est utilis√©, auquel nous avons envoy√© une demande correspondante.  Cependant, il y avait beaucoup d'adresses ... </li><li>  Comment vous en prot√©ger √† l'avenir?  Dans notre cas, m√™me des options de fermeture d'acc√®s sur une base g√©ographique sont possibles. </li></ul><br><h2>  PS </h2><br>  Lisez aussi dans notre blog: <br><br><ul><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">De la vie avec Kubernetes: comment les Espagnols ne se sont pas plaints du serveur HTTP</a> ¬ª; </li><li>  ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">6 bugs syst√®me divertissants dans le fonctionnement de Kubernetes [et leur solution]</a> ¬ª; </li><li>  " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">3 cas inhabituels concernant le sous-syst√®me r√©seau Linux</a> ." </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr471892/">https://habr.com/ru/post/fr471892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr471880/index.html">Id√©e pour Geek Halloween, ou le temps de choisir GeekMask</a></li>
<li><a href="../fr471882/index.html">Une liste ouverte d'√©v√©nements PHP, de conf√©renciers et d'organisateurs sur GitHub</a></li>
<li><a href="../fr471884/index.html">10 utilitaires ApexSQL gratuits pour g√©rer les bases de donn√©es Microsoft SQL Server</a></li>
<li><a href="../fr471886/index.html">VMmanager 6: pr√©sentation de la box et comparaison avec la g√©n√©ration pr√©c√©dente</a></li>
<li><a href="../fr471890/index.html">Inf√©rence variationnelle - qu'est-ce que c'est et que mange-t-elle?</a></li>
<li><a href="../fr471896/index.html">Le livre de jeu int√©rieur. Fonctionnalit√©s r√©seau dans le nouveau moteur Ansible 2.9</a></li>
<li><a href="../fr471904/index.html">Planificateur de ressources chez HPE InfoSight</a></li>
<li><a href="../fr471906/index.html">Les dangers des optimisations incorrectes</a></li>
<li><a href="../fr471908/index.html">La beaut√© inattendue des nombres premiers</a></li>
<li><a href="../fr471912/index.html">Apprendre l'anglais: 7 fa√ßons pratiques d'√©largir votre vocabulaire</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>