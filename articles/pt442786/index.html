<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📡 🔦 👨🏾‍🤝‍👨🏽 7 dicas úteis para usar o quarto 🎈 🛀🏾 👩🏻‍✈️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Room é uma camada de abstração em cima do SQLite que simplifica o armazenamento. Se você é novo no Room, confira este artigo introdutório: 
 7 etapas ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>7 dicas úteis para usar o quarto</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442786/"><p><img src="https://habrastorage.org/getpro/habr/post_images/67f/9e9/00f/67f9e900f75e27bf3453979d40ea4ef1.jpg" alt="7 dicas úteis para usar o quarto"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Room</a> é uma camada de abstração em cima do SQLite que simplifica o armazenamento.  Se você é novo no Room, confira este artigo introdutório: </p><br><blockquote>  <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">7 etapas para usar o Room.</a></em>  <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Passo a passo para migrar seu aplicativo para o Room</a></em> </blockquote><p>  E neste artigo, gostaria de compartilhar algumas dicas sobre como usar o Room da maneira mais eficiente possível. </p><a name="habracut"></a><br><h2 id="1-predvaritelnoe-zapolnenie-bazy-dannyh">  1. Pré-preenchendo o Banco de Dados </h2><br><p> Você precisa adicionar dados padrão ao seu banco de dados imediatamente após sua criação ou no momento do primeiro acesso a ele?  Use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">RoomDatabase # Callback</a> .  Chame o método <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">addCallback</a> ao criar seu banco de dados e substitua <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">onCreate</a> ou <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">onOpen</a> . </p><br><p> <code>onCreate</code> será chamado quando o banco de dados for criado, imediatamente após a criação das tabelas.  <code>onOpen</code> é chamado quando o banco de dados é aberto.  Como o acesso ao DAO é possível somente após a conclusão desses métodos, criamos um novo fluxo no qual obtemos um link para o banco de dados, obtemos o DAO e inserimos os dados necessários. </p><br><pre> <code class="kotlin hljs">Room.databaseBuilder(context.applicationContext, DataDatabase::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">"Sample.db") // prepopulate the database after onCreate was called .addCallback</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : Callback() { <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(db: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">SupportSQLiteDatabase</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(db) <span class="hljs-comment"><span class="hljs-comment">// moving to a new thread ioThread { getInstance(context).dataDao() .insert(PREPOPULATE_DATA) } } }) .build()</span></span></code> </pre> <br><p>  Veja o exemplo completo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  <strong>Nota:</strong> se você usar a abordagem <code>ioThread</code> e o aplicativo travar na primeira vez em que iniciar, entre a criação do banco de dados e a inserção, os dados nunca serão inseridos. </p><br><h2 id="2-ispolzovanie-vozmozhnostey-nasledovaniya-dao">  2. Usando recursos de herança do DAO </h2><br><p>  Você possui várias tabelas no seu banco de dados e copia os mesmos métodos de <strong>inserção</strong> , <strong>atualização</strong> e <strong>exclusão</strong> ?  Os DAOs suportam herança, portanto, crie uma <code>BaseDao&lt;T&gt;</code> e defina seus métodos comuns <code>@Insert</code> , <code>@Update</code> e <code>@Delete</code> .  Deixe cada DAO estender o <code>BaseDao</code> e adicionar métodos específicos para cada um deles. </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Insert</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">vararg</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> } <span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DataDao</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Data</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Query(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"SELECT * FROM Data"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: List&lt;Data&gt; }</code> </pre> <br><p>  Veja detalhes <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  Os DAOs devem ser interfaces ou classes abstratas porque o Room gera sua implementação em tempo de compilação, incluindo métodos do <code>BaseDao</code> . </p><br><h2 id="3-vypolnenie-zaprosov-v-tranzakciyah-bez-shablonnogo-koda">  3. Executando consultas em transações sem código clichê </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Anotar um</a> método usando <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Transaction</a> garante que todas as operações do banco de dados que você executa neste método sejam executadas na mesma transação.  Uma transação não será executada se ocorrer uma exceção no corpo do método. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(users: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">List</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> { deleteAllUsers() insertAll(users) } <span class="hljs-meta"><span class="hljs-meta">@Insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insertAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(users: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">List</span></span></span></span><span class="hljs-function"><span class="hljs-params">&lt;</span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">User</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;)</span></span></span></span> <span class="hljs-meta"><span class="hljs-meta">@Query(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"DELETE FROM Users"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteAllUsers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> }</code> </pre> <br><p>  Convém usar a anotação <code>@Transaction</code> para métodos <code>@Transaction</code> que usam a instrução <code>select</code> nos casos: </p><br><ul><li>  Quando o resultado da consulta é bastante grande.  Ao fazer uma solicitação em uma transação, você garante que, se o resultado da solicitação não couber em uma "parte" do cursor, ele não será danificado devido a alterações no banco de dados entre as <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">permutações do cursor</a> . </li><li>  Quando o resultado da consulta é um POJO com campos <code>@Relation</code> .  Cada campo é uma solicitação em si, portanto, executá-los em uma transação garante resultados consistentes entre as solicitações. </li></ul><br><p>  Os <code>@Delete</code> , <code>@Update</code> e <code>@Insert</code> , que possuem vários parâmetros, são iniciados automaticamente dentro da transação. </p><br><h2 id="4-chtenie-tolko-togo-chto-vam-nuzhno">  4. Lendo apenas o que você precisa </h2><br><p>  Ao fazer uma solicitação ao banco de dados, você usa todos os campos que obtém na resposta?  Cuide da quantidade de memória usada pelo seu aplicativo e faça o download apenas dos campos que você usará.  Também aumentará a velocidade de suas solicitações, reduzindo o custo de E / S.  O quarto fará o mapeamento entre as colunas e o objeto para você. </p><br><p>  Considere este objeto de <code>User</code> complexo: </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity(tableName = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"users"</span></span></span><span class="hljs-meta">)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span></span>(<span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> id: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> firstName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lastName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> email: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> dateOfBirth: Date, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> registrationDate: Date)</code> </pre> <br><p>  Em algumas telas, não precisamos exibir todas essas informações.  Assim, em vez disso, podemos criar um objeto <code>UserMinimal</code> que contém apenas os dados necessários. </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserMinimal</span></span></span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> userId: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> firstName: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> lastName: String)</code> </pre> <br><p>  Na classe DAO, definimos a consulta e selecionamos as colunas corretas da tabela de <code>users</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Query(“SELECT userId, firstName, lastName FROM Users)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUsersMinimal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: List&lt;UserMinimal&gt; }</code> </pre> <br><h2 id="5-kontrol-zavisimostey-mezhdu-suschnostyami-s-vneshnimi-klyuchami">  5. Controle de dependências entre entidades com chaves estrangeiras </h2><br><p>  Mesmo que o Room <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">não suporte diretamente</a> relacionamentos entre entidades, ele permite definir dependências entre objetos usando chaves estrangeiras. </p><br><p>  A sala possui a anotação <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@ForeignKey</a> , que faz parte da anotação <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Entity</a> .  Na funcionalidade, é semelhante às <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">chaves estrangeiras no SQLite</a> .  Garante a preservação dos relacionamentos entre as entidades quando são feitas alterações no banco de dados.  Para adicioná-lo, defina o objeto a ser referenciado, bem como as colunas no objeto atual e o volume ao qual você está se referindo. </p><br><p>  Considere a classe <code>User</code> e <code>Pet</code> .  <code>Pet</code> possui um proprietário - o ID do usuário referenciado pela chave estrangeira. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Entity(tableName = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pets"</span></span></span><span class="hljs-meta">, foreignKeys = arrayOf( ForeignKey(entity = User::class, parentColumns = arrayOf(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"userId"</span></span></span><span class="hljs-meta">)</span></span>, childColumns = arrayOf(<span class="hljs-string"><span class="hljs-string">"owner"</span></span>)))) <span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Pet</span></span></span></span>(<span class="hljs-meta"><span class="hljs-meta">@PrimaryKey</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> petId: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> name: String, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> owner: String)</code> </pre> <br><p>  Se desejar, você pode determinar que ação tomar quando o pai for excluído ou atualizado no banco de dados.  Você pode escolher uma das seguintes opções: <code>NO_ACTION</code> , <code>RESTRICT</code> , <code>SET_NULL</code> , <code>SET_DEFAULT</code> ou <code>CASCADE</code> , que se comportam da mesma forma que no <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">SQLite</a> . </p><br><p>  <strong>Nota:</strong> na sala, <code>SET_DEFAULT</code> funciona como <code>SET_NULL</code> , porque  A sala ainda não permite definir valores padrão para colunas. </p><br><h2 id="6-uproschenie-zaprosov-odin-ko-mnogim-s-pomoschyu-relation">  6. Simplifique as consultas um para muitos com o @Relation </h2><br><p>  No exemplo anterior <code>User</code> - <code>Pet</code> , podemos dizer que existe um relacionamento <strong>um para muitos</strong> : o usuário pode ter vários animais de estimação.  Suponha que desejemos obter uma lista de usuários com seus animais de estimação: <code>List&lt;UserAndAllPets&gt;</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-keyword"><span class="hljs-keyword">data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserAndAllPets</span></span></span><span class="hljs-class"> </span></span>(<span class="hljs-keyword"><span class="hljs-keyword">val</span></span> user: User, <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> pets: List&lt;Pet&gt; = ArrayList())</code> </pre> <br><p>  Para fazer isso manualmente, precisamos de 2 consultas: uma para obter uma lista de todos os usuários e a outra para obter uma lista de animais de estimação com base no ID do usuário. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Query(“SELECT * FROM Users”)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;User&gt; getUsers(); <span class="hljs-meta"><span class="hljs-meta">@Query(“SELECT * FROM Pets where owner = :userId”)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Pet&gt; getPetsForUser(String userId);</code> </pre> <br><p>  Em seguida, percorreremos a lista de usuários e acessaremos a tabela <code>Pets</code> sempre. </p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">A</a> anotação <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">@Relation</a> facilitará nossa vida: ela solicitará automaticamente objetos relacionados.  <code>@Relation</code> só pode ser aplicada a <code>List</code> ou <code>Set</code> .  Atualize a classe UserAndAllPets: </p><br><pre> <code class="kotlin hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserAndAllPets</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Embedded</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user: User? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-meta"><span class="hljs-meta">@Relation(parentColumn = “userId”, entityColumn = “owner”)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> pets: List&lt;Pet&gt; = ArrayList() }</code> </pre> <br><p>  No DAO, definimos uma consulta e o Room consultará as tabelas <code>Users</code> e <code>Pets</code> e mapeará os objetos por conta própria. </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Transaction</span></span> <span class="hljs-meta"><span class="hljs-meta">@Query(“SELECT * FROM Users”)</span></span> List&lt;UserAndAllPets&gt; getUsers();</code> </pre> <br><h2 id="7-izbezhanie-lozhnyh-uvedomleniy-observable-zaprosov">  7. Evitar notificações falsas para solicitações observáveis </h2><br><p>  Suponha que você queira obter um usuário por seu identificador usando uma solicitação observável: </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Query(“SELECT * FROM Users WHERE userId = :id)</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: LiveData&lt;User&gt; <span class="hljs-comment"><span class="hljs-comment">// or @Query(“SELECT * FROM Users WHERE userId = :id) fun getUserById(id: String): Flowable&lt;User&gt;</span></span></code> </pre> <br><p>  Você receberá um novo objeto <code>User</code> cada vez que for atualizado.  Mas você também receberá esse objeto quando outras alterações ocorrerem na tabela <code>Users</code> (exclusões, atualizações ou inserções) que nada têm a ver com o usuário em que você está interessado, o que levará a notificações falsas.  Além disso, se sua consulta incluir várias tabelas, você receberá novas mensagens sempre que algo mudar em alguma delas. </p><br><p>  Aqui está o que acontece nos bastidores: </p><br><ol><li>  O SQLite possui <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">gatilhos</a> que disparam sempre que <code>DELETE</code> , <code>UPDATE</code> ou <code>INSERT</code> ocorre em uma tabela. </li><li>  Room cria um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">InvalidationTracker</a> que usa <code>Observers</code> que rastreiam todas as alterações nas tabelas observadas. </li><li>  As solicitações <code>LiveData</code> e <code>LiveData</code> contam com a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">notificação InvalidationTracker.Observer # onInvalidated</a> .  Quando é recebido, ocorre uma solicitação repetida. </li></ol><br><p>  A sala sabe apenas que a tabela foi alterada, mas não sabe por que e o que mudou.  Portanto, após uma segunda solicitação, o resultado da solicitação é transmitido usando <code>LiveData</code> ou <code>LiveData</code> .  Porque  O quarto não armazena nenhum dado na memória, não pode determinar se são os mesmos dados ou não. </p><br><p>  Você deve verificar se o seu DAO <strong>filtra solicitações</strong> e responde apenas aos objetos necessários. </p><br><p>  Se a consulta observável for implementada usando <code>Flowables</code> , use <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Flowable # diverUntilChanged</a> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-comment"><span class="hljs-comment">/** * Get a user by id. * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> the user from the table with a specific id. */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Query(“SELECT * FROM Users WHERE userid = :id”)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Flowable&lt;User&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistinctUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: Flowable&lt;User&gt; = getUserById(id) .distinctUntilChanged() }</code> </pre> <br><p>  Se sua consulta retornar o <code>LiveData</code> , você poderá usar o <code>MediatorLiveData</code> , que receberá apenas os objetos desejados da origem. </p><br><pre> <code class="kotlin hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function"> LiveData</span><span class="hljs-type"><span class="hljs-function"><span class="hljs-type">&lt;T&gt;</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistinct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>: LiveData&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> distinctLiveData = MediatorLiveData&lt;T&gt;() distinctLiveData.addSource(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> : Observer&lt;T&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> initialized = <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lastObj: T? = <span class="hljs-literal"><span class="hljs-literal">null</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChanged</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(obj: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">T</span></span></span></span><span class="hljs-function"><span class="hljs-params">?)</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!initialized) { initialized = <span class="hljs-literal"><span class="hljs-literal">true</span></span> lastObj = obj distinctLiveData.postValue(lastObj) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((obj == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; lastObj != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) || obj != lastObj) { lastObj = obj distinctLiveData.postValue(lastObj) } } }) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> distinctLiveData }</code> </pre> <br><p>  Nos seus DAOs, o método que retorna o <code>LiveData</code> é <code>public</code> e o método que consulta o banco de dados é <code>protected</code> . </p><br><pre> <code class="kotlin hljs"><span class="hljs-meta"><span class="hljs-meta">@Dao</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UserDao</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BaseDao</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">User</span></span></span><span class="hljs-class">&gt;</span></span>() { <span class="hljs-meta"><span class="hljs-meta">@Query(“SELECT * FROM Users WHERE userid = :id”)</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: LiveData&lt;User&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDistinctUserById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id: </span></span><span class="hljs-type"><span class="hljs-function"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>: LiveData&lt;User&gt; = getUserById(id).getDistinct() }</code> </pre> <br><p>  Veja o exemplo de código completo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aqui</a> . </p><br><p>  <strong>Nota:</strong> se você estiver solicitando uma lista para exibição, preste atenção na <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Paging Library</a> , que retornará um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">LivePagedListBuilder</a> .  A biblioteca ajudará você a calcular automaticamente a diferença entre os itens da lista e atualizar sua interface com o usuário. </p><br><blockquote>  <em>Consulte também: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">7 etapas para usar o Room.</a></em>  <em><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Passo a passo para migrar seu aplicativo para o Room</a></em> </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt442786/">https://habr.com/ru/post/pt442786/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt442776/index.html">Índices no PostgreSQL - 3 (Hash)</a></li>
<li><a href="../pt442778/index.html">Learning Go: uma seleção de relatórios de vídeo</a></li>
<li><a href="../pt442780/index.html">Equívocos mais comuns na física popular</a></li>
<li><a href="../pt442782/index.html">VShard - escala horizontal em Tarantool</a></li>
<li><a href="../pt442784/index.html">Seqüestro de BGP adicionando a vítima AS ao AS-SET do atacante</a></li>
<li><a href="../pt442788/index.html">Por que precisamos de um sistema de monitoramento em um chip</a></li>
<li><a href="../pt442790/index.html">As inscrições estão abertas para o Allure Server Meetup em São Petersburgo</a></li>
<li><a href="../pt442794/index.html">Convidamos você para a conferência “arquiteto (TI) em projetos e organizações de TI”</a></li>
<li><a href="../pt442796/index.html">Pesquisa: Tecnologias em nuvem em serviços de GIS e dados geográficos</a></li>
<li><a href="../pt442798/index.html">Monitorar pings entre hosts Kubernetes é a nossa receita</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>