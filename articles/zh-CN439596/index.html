<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ¿â€ğŸ“ â˜ºï¸ ğŸŒ€ æˆ‘å¦‚ä½•åœ¨Androidä¸ŠåŠ é€Ÿå›¾åƒå¤„ç†15æ¬¡ ğŸ¤¹ğŸ» ğŸ˜‘ ğŸ¦</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å½“éœ€è¦åˆ›å»º6å¼ å›¾åƒï¼ˆæ¯ä¸ªå›¾åƒç”±15-16ä¸ªPNGé¡ºåºè¦†ç›–ï¼‰è€Œåˆæ²¡æœ‰åœ¨é€”ä¸­æ”¶åˆ°OutOfMemoryExceptionæ—¶ï¼Œå¦‚ä½•åœ¨è¿è¡Œæ—¶ä¼˜åŒ–å›¾åƒå¤„ç†ï¼Ÿ 





 åœ¨å¼€å‘å® ç‰©åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘é‡åˆ°äº†å›¾åƒå¤„ç†é—®é¢˜ã€‚ æˆ‘æ— æ³•ä¸ºGoogleæä¾›ä¼˜è´¨çš„Google Casesï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸é è€™å­èµ°è·¯ï¼Œè‡ªå·±å‘æ˜è‡ªè¡Œ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘å¦‚ä½•åœ¨Androidä¸ŠåŠ é€Ÿå›¾åƒå¤„ç†15æ¬¡</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/439596/"><p> å½“éœ€è¦åˆ›å»º6å¼ å›¾åƒï¼ˆæ¯ä¸ªå›¾åƒç”±15-16ä¸ªPNGé¡ºåºè¦†ç›–ï¼‰è€Œåˆæ²¡æœ‰åœ¨é€”ä¸­æ”¶åˆ°OutOfMemoryExceptionæ—¶ï¼Œå¦‚ä½•åœ¨è¿è¡Œæ—¶ä¼˜åŒ–å›¾åƒå¤„ç†ï¼Ÿ </p><br><p><img src="https://habrastorage.org/webt/n4/ir/yg/n4irygl0boui-gzrxl1lolvdezg.jpeg" alt="å›¾ç‰‡"></p><a name="habracut"></a><br><p> åœ¨å¼€å‘å® ç‰©åº”ç”¨ç¨‹åºæ—¶ï¼Œæˆ‘é‡åˆ°äº†å›¾åƒå¤„ç†é—®é¢˜ã€‚ æˆ‘æ— æ³•ä¸ºGoogleæä¾›ä¼˜è´¨çš„Google Casesï¼Œå› æ­¤æˆ‘ä¸å¾—ä¸é è€™å­èµ°è·¯ï¼Œè‡ªå·±å‘æ˜è‡ªè¡Œè½¦ã€‚ <br> åŒæ ·åœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œä»Javaè¿ç§»åˆ°Kotlinï¼Œå› æ­¤ä»£ç å°†åœ¨æŸä¸ªæ—¶å€™è¿›è¡Œç¿»è¯‘ã€‚ </p><br><h4 id="zadacha"> æŒ‘æˆ˜èµ› </h4><br><p> <em>åœ¨ä½“è‚²é¦†è®­ç»ƒçš„ç”³è¯·ã€‚</em>  <em>å¿…é¡»åŸºäºåº”ç”¨ç¨‹åºè¿è¡Œæ—¶ä¸­çš„è®­ç»ƒç»“æœæ¥æ„å»ºè‚Œè‚‰å·¥ä½œå›¾ã€‚</em> <em><br></em>  <em>æœ‰ä¸¤ä¸ªæ€§åˆ«ï¼šMå’ŒGã€‚è€ƒè™‘é€‰é¡¹Mï¼Œå› ä¸ºå¯¹äºMæ¥è¯´ï¼Œæ‰€æœ‰äº‹ç‰©éƒ½æ˜¯ç›¸åŒçš„ã€‚</em> <em><br></em>  <em>åº”åŒæ—¶åˆ¶ä½œ6å¼ å›¾åƒï¼š3ä¸ªæ—¶æ®µï¼ˆæ¯å‘¨ä¸€æ¬¡ï¼Œæ¯æœˆä¸€æ¬¡ï¼Œä¸€æ¬¡åŸ¹è®­ï¼‰x 2æ¬¡è§‚çœ‹ï¼ˆæ­£é¢ï¼ŒèƒŒé¢ï¼‰</em> </p><br><p><img src="https://habrastorage.org/webt/ad/i1/2_/adi12_wz_nqagmag3vg2qxfvgta.jpeg" alt="å›¾ç‰‡"></p><br><p> æ¯ä¸ªè¿™æ ·çš„å›¾åƒåŒ…æ‹¬15ä¸ªè‚Œè‚‰ç»„å›¾åƒï¼ˆæ­£è§†å›¾ï¼‰å’Œ14ä¸ªåè§†å›¾åƒã€‚ åŠ ä¸Š1å¼ ç²‰åº•å›¾åƒï¼ˆå¤´éƒ¨ï¼Œæ‰‹å’Œè„šï¼‰ã€‚ æ€»ä½“ä¸Šï¼Œè¦æ”¶é›†å‰è§†å›¾ï¼Œæ‚¨éœ€è¦ä»èƒŒé¢å åŠ 16å¼ å›¾åƒ-15ã€‚ </p><br><p> ä¸¤ä¾§åªæœ‰23ä¸ªè‚Œè‚‰ç¾¤ï¼ˆå¯¹äº15 + 14ï¼= 23çš„è‚Œè‚‰ç¾¤ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå°çš„è§£é‡Š-ä¸¤ä¾§çš„æŸäº›è‚Œè‚‰éƒ½æ˜¯â€œå¯è§çš„â€ï¼‰ã€‚ </p><br><p> ä¸€é˜¶è¿‘ä¼¼ç®—æ³•ï¼š </p><br><ol><li> æ ¹æ®å®Œæˆçš„é”»ç‚¼çš„æ•°æ®ï¼Œæ„å»ºHashMap &lt;Stringï¼ŒFloat&gt;ï¼ŒStringæ˜¯è‚Œè‚‰ç»„çš„åç§°ï¼ŒFloatæ˜¯ä»0åˆ°10çš„è´Ÿé‡ç¨‹åº¦ã€‚ </li><li> å°†23å—è‚Œè‚‰ä¸­çš„æ¯ä¸€ä¸ªéƒ½é‡æ–°æ¶‚ä¸Šé¢œè‰²ï¼ˆä»0ï¼ˆä¸æ¶‰åŠï¼‰åˆ°10ï¼ˆæœ€å¤§è´Ÿè½½ï¼‰ï¼‰ã€‚ </li><li> åœ¨ä¸¤ä¸ªå›¾åƒï¼ˆæ­£é¢ï¼ŒèƒŒé¢ï¼‰ä¸Šè¦†ç›–é‡æ–°ç»˜åˆ¶çš„è‚Œè‚‰å›¾åƒã€‚ </li><li> æˆ‘ä»¬ä¿å­˜æ‰€æœ‰6å¼ å›¾åƒã€‚ </li></ol><br><p><img src="https://habrastorage.org/webt/rg/d-/s-/rgd-s-voieskh-uscrujasgqvte.jpeg" alt="å›¾ç‰‡"></p><br><p> è¦ä»¥24ä½æ¨¡å¼å­˜å‚¨31ï¼ˆ16 + 15ï¼‰ä¸ªå¤§å°ä¸º1500x1500 pxçš„å›¾åƒï¼Œåˆ™éœ€è¦31x1500x1500x24bit = 199 MBçš„RAMã€‚ å½“æ‚¨è¶…è¿‡ã€œ30-40 MBæ—¶ï¼Œæ‚¨å°†æ”¶åˆ°OutOfMemoryExceptionã€‚ ç›¸åº”åœ°ï¼Œæ‚¨ä¸èƒ½åŒæ—¶ä»èµ„æºåŠ è½½æ‰€æœ‰å›¾åƒï¼Œå› ä¸ºæ‚¨éœ€è¦é‡Šæ”¾èµ„æºä»¥ä¸æ¥æ”¶æ¥æ”¶ä¿¡æ¯ã€‚ è¿™æ„å‘³ç€æ‚¨éœ€è¦é¡ºåºè¦†ç›–å›¾åƒã€‚ è¯¥ç®—æ³•è½¬æ¢ä¸ºä»¥ä¸‹å†…å®¹ï¼š </p><br><p> æ ¹æ®å®Œæˆçš„é”»ç‚¼ä¸­çš„æ•°æ®ï¼Œæ„å»ºHashMap &lt;Stringï¼ŒFloat&gt;ï¼ŒString-è‚Œè‚‰ï¼ŒFloat-è´Ÿè½½çº§åˆ«ï¼ˆä»0åˆ°10ï¼‰ã€‚ </p><br><p>  6ä¸ªå›¾åƒä¸­æ¯ä¸ªå›¾åƒçš„å¾ªç¯ï¼š </p><br><ol><li> è·å¾—äº†BitmapFactory.decodeResourceï¼ˆï¼‰èµ„æºã€‚ </li><li> å°†23å—è‚Œè‚‰ä¸­çš„æ¯ä¸€ä¸ªéƒ½é‡æ–°æ¶‚ä¸Šé¢œè‰²ï¼ˆä»0ï¼ˆä¸æ¶‰åŠï¼‰åˆ°10ï¼ˆæœ€å¤§è´Ÿè½½ï¼‰ï¼‰ã€‚ </li><li> åœ¨ä¸€å¼ ç”»å¸ƒä¸Šè¦†ç›–é‡æ–°ç»˜åˆ¶çš„è‚Œè‚‰å›¾åƒã€‚ </li><li>  Bitmap.recycleï¼ˆï¼‰é‡Šæ”¾äº†èµ„æºã€‚ </li></ol><br><p> æˆ‘ä»¬ä½¿ç”¨AsyncTaskåœ¨å•ç‹¬çš„çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ã€‚ åœ¨æ¯ä¸ªä»»åŠ¡ä¸­ï¼Œå°†é¡ºåºåˆ›å»ºä¸¤ä¸ªå›¾åƒï¼šå‰è§†å›¾å’Œåè§†å›¾ã€‚ </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BitmapMusclesTask</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AsyncTask</span></span></span><span class="hljs-class">&lt;Void, Void, DoubleMusclesBitmaps&gt; {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> final WeakReference&lt;HashMap&lt;String, Float&gt;&gt; musclesMap; BitmapMusclesTask(HashMap&lt;String, Float&gt; musclesMap) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.musclesMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WeakReference&lt;&gt;(musclesMap); } @<span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> DoubleMusclesBitmaps </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Void... voids)</span></span></span><span class="hljs-function"> </span></span>{ DoubleMusclesBitmaps bitmaps = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DoubleMusclesBitmaps(); bitmaps.bitmapBack = createBitmapMuscles(musclesMap.get(), <span class="hljs-literal"><span class="hljs-literal">false</span></span>); bitmaps.bitmapFront = createBitmapMuscles(musclesMap.get(), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmaps; } @<span class="hljs-function"><span class="hljs-function">Override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onPostExecute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DoubleMusclesBitmaps bitmaps)</span></span></span><span class="hljs-function"> </span></span>{ super.onPostExecute(bitmaps); Uri uriBack = saveBitmap(bitmaps.bitmapBack); Uri uriFront = saveBitmap(bitmaps.bitmapFront); bitmaps.bitmapBack.recycle(); bitmaps.bitmapFront.recycle(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (listener != null) listener.onUpdate(uriFront, uriBack); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DoubleMusclesBitmaps</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Bitmap bitmapFront; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Bitmap bitmapBack; }</code> </pre> <br><p> ä»…éœ€è¦è¾…åŠ©ç±»DoubleMusclesBitmapså³å¯è¿”å›ä¸¤ä¸ªBitmapå˜é‡ï¼šå‰è§†å›¾å’Œåè§†å›¾ã€‚ å±•æœ›æœªæ¥ï¼ŒKotlinä¸­çš„Double &lt;Bitmapï¼ŒBitmap&gt;å°†æ›¿æ¢DoubleMusclesBitmaps Javaç±»ã€‚ </p><br><h3 id="risovanie"> ç”»å›¾ </h3><br><p> åœ¨å€¼èµ„æºä¸­ä¸ºcolors.xmlç€è‰²ã€‚ </p><br><pre> <code class="css hljs">&lt;?<span class="hljs-selector-tag"><span class="hljs-selector-tag">xml</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">version</span></span>="1<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span>" <span class="hljs-selector-tag"><span class="hljs-selector-tag">encoding</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">utf-8</span></span>"?&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">resources</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color0</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#BBBBBB</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color1</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#ffb5cf</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color2</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#fda9c6</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color3</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#fa9cbe</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color4</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f890b5</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color5</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f583ac</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color6</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f377a4</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color7</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#f06a9b</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color8</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#ee5e92</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color9</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#eb518a</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">name</span></span>="<span class="hljs-selector-tag"><span class="hljs-selector-tag">muscles_color10</span></span>"&gt;<span class="hljs-selector-id"><span class="hljs-selector-id">#e94581</span></span>&lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">color</span></span>&gt; &lt;/<span class="hljs-selector-tag"><span class="hljs-selector-tag">resources</span></span>&gt;</code> </pre> <br><p> åˆ›å»ºä¸€ä¸ªè§†å›¾ </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createBitmapMuscles</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HashMap&lt;String, Float&gt; musclesMap, Boolean isFront)</span></span></span><span class="hljs-function"> </span></span>{ Bitmap musclesBitmap = Bitmap.createBitmap(<span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, Bitmap.Config.ARGB_8888); Canvas resultCanvas = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Canvas(musclesBitmap); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (HashMap.Entry entry : musclesMap.entrySet()) { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> color = Math.round((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) entry.getValue()); <span class="hljs-comment"><span class="hljs-comment">//         color = context.getResources().getColor(context.getResources() .getIdentifier("muscles_color" + color, "color", context.getPackageName())); drawMuscleElement(resultCanvas, entry.getKey(), color); } return musclesBitmap; }</span></span></code> </pre> <br><p> å•å±‚è‚Œè‚‰è¦†ç›– </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawMuscleElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Canvas resultCanvas, String drawableName, @ColorInt </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> color)</span></span></span><span class="hljs-function"> </span></span>{ PorterDuff.Mode mode = PorterDuff.Mode.SRC_IN; Paint paint = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Paint(Paint.ANTI_ALIAS_FLAG); Bitmap bitmapDst = BitmapFactory.decodeResource(context.getResources(), context.getResources().getIdentifier(drawableName, <span class="hljs-string"><span class="hljs-string">"drawable"</span></span>, context.getPackageName())); bitmapDst = Bitmap.createScaledBitmap(bitmapDst, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); paint.setColorFilter(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PorterDuffColorFilter(color, mode)); resultCanvas.drawBitmap(bitmapDst, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, paint); bitmapDst.recycle();<span class="hljs-comment"><span class="hljs-comment">//  }</span></span></code> </pre> <br><p> æˆ‘ä»¬å¼€å§‹ç”Ÿæˆ3å¯¹å›¾åƒã€‚ </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskLast; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskWeek; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BitmapMusclesTask taskMonth; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startImageGenerating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ taskLast = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapLast); taskLast.execute(); taskWeek = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapWeek); taskWeek.execute(); taskMonth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapMusclesTask(mapMonth); taskMonth.execute(); }</code> </pre> <br><p> æˆ‘ä»¬å¼€å§‹startImageGeneratingï¼ˆï¼‰ï¼š </p><br><pre> <code class="plaintext hljs">&gt; start 1549350950177 &gt; finish 1549350959490 diff=9313 ms</code> </pre> <br><p> åº”è¯¥æ³¨æ„çš„æ˜¯ï¼Œé˜…è¯»èµ„æºè¦èŠ±è´¹å¾ˆå¤šæ—¶é—´ã€‚ å¯¹äºæ¯å¯¹å›¾åƒï¼Œå¯¹èµ„æºä¸­çš„29ä¸ªPNGæ–‡ä»¶è¿›è¡Œè§£ç ã€‚ å°±æˆ‘è€Œè¨€ï¼Œåœ¨åˆ›å»ºå›¾åƒçš„æ€»æˆæœ¬ä¸­ï¼ŒBitmapFactory.decodeResourceï¼ˆï¼‰å‡½æ•°èŠ±è´¹çš„æ—¶é—´çº¦ä¸º75ï¼…ï¼šçº¦6960æ¯«ç§’ã€‚ </p><br><p> ç¼ºç‚¹ï¼š </p><br><ol><li> æˆ‘ä¸æ—¶æ”¶åˆ°OutOfMemoryExceptionã€‚ </li><li> å¤„ç†è¿‡ç¨‹éœ€è¦9ç§’é’Ÿä»¥ä¸Šï¼Œå¹¶ä¸”åœ¨æ¨¡æ‹Ÿå™¨ä¸Šï¼ˆï¼ï¼‰ã€‚åœ¨â€œ averageâ€ï¼ˆæ—§çŸ¿äº•ï¼‰ç”µè¯ä¸­ï¼Œå®ƒè¾¾åˆ°äº†20ç§’ã€‚ </li><li>  AsyncTaskä¸æ‰€æœ‰å¯¼è‡´çš„[å†…å­˜]æ³„æ¼ã€‚ </li></ol><br><p> ä¼˜ç‚¹ï¼š <br> ä»¥æ¦‚ç‡ï¼ˆ1-OutOfMemoryExceptionï¼‰ç»˜åˆ¶å›¾åƒã€‚ </p><br><h3 id="asynctask-v-intentservice">  IntentServiceä¸­çš„AsyncTask </h3><br><p> ä¸ºäº†ç¦»å¼€AsyncTaskï¼Œå†³å®šåˆ‡æ¢åˆ°IntentServieï¼Œåœ¨å…¶ä¸­æ‰§è¡Œåˆ›å»ºå›¾åƒçš„ä»»åŠ¡ã€‚ æœåŠ¡å®Œæˆåï¼Œå¦‚æœBroadcastReceiveræ­£åœ¨è¿è¡Œï¼Œæˆ‘ä»¬å°†è·å–æ‰€æœ‰ç”Ÿæˆçš„å…­ä¸ªå›¾åƒçš„Uriï¼Œå¦åˆ™å°†ä»…ä¿å­˜å›¾åƒï¼Œä»¥ä¾¿ä¸‹æ¬¡ç”¨æˆ·æ‰“å¼€åº”ç”¨ç¨‹åºæ—¶ï¼Œæ— éœ€ç­‰å¾…åˆ›å»ºè¿‡ç¨‹ã€‚ åŒæ—¶ï¼Œæ“ä½œæ—¶é—´æ²¡æœ‰æ”¹å˜ï¼Œä½†æ˜¯å‡å»äº†ä¸€ä¸ªè´Ÿå·ï¼ˆç®—å‡ºå†…å­˜æ³„æ¼ï¼‰ï¼Œè¿˜æœ‰ä¸¤ä¸ªè´Ÿå·ã€‚ </p><br><p> å½“ç„¶ï¼Œå¼ºè¿«ç”¨æˆ·æœŸæœ›åœ¨å¦‚æ­¤é•¿çš„æ—¶é—´å†…åˆ›å»ºå›¾åƒæ˜¯ä¸å¯èƒ½çš„ã€‚ éœ€è¦ä¼˜åŒ–ã€‚ </p><br><p> æ¦‚è¿°ä¼˜åŒ–æ–¹å¼ï¼š </p><br><ol><li> å›¾åƒå¤„ç†ã€‚ </li><li> æ·»åŠ LruCacheã€‚ </li></ol><br><h3 id="obrabotka-izobrazheniy"> å½±åƒå¤„ç† </h3><br><p> æ‰€æœ‰æºPNGèµ„æºçš„å¤§å°å‡ä¸º1500x1500åƒç´ ã€‚ å°†å…¶é™ä½ä¸º1080x1080ã€‚ <br> å¦‚æ‚¨åœ¨ç¬¬äºŒå¼ ç…§ç‰‡ä¸­æ‰€è§ï¼Œæ‰€æœ‰æºä»£ç éƒ½æ˜¯æ­£æ–¹å½¢çš„ï¼Œè‚Œè‚‰å°±ä½äº†ï¼ŒçœŸæ­£æœ‰ç”¨çš„åƒç´ å æ®äº†å¾ˆå°çš„é¢ç§¯ã€‚ æ‰€æœ‰è‚Œè‚‰ç»„éƒ½å·²ç»å°±ä½çš„äº‹å®å¯¹äºç¨‹åºå‘˜æ¥è¯´å¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯å¯¹äºè¡¨ç°å´ä¸åˆç†ã€‚ æˆ‘ä»¬è£å‰ªï¼ˆå‰ªåˆ‡ï¼‰æ‰€æœ‰æºä»£ç ä¸­çš„å¤šä½™éƒ¨åˆ†ï¼Œè®°å½•æ¯ä¸ªè‚Œè‚‰ç»„çš„ä½ç½®ï¼ˆxï¼Œyï¼‰ï¼Œä»¥ä¾¿éšåå°†å…¶åº”ç”¨äºæ­£ç¡®çš„ä½ç½®ã€‚ </p><br><p> åœ¨ç¬¬ä¸€ç§æ–¹æ³•ä¸­ï¼Œå°†æ‰€æœ‰29ç»„è‚Œè‚‰å›¾åƒé‡æ–°ç²‰åˆ·å¹¶å åŠ åœ¨åº•åº§ä¸Šã€‚ åº•åº§ä»…åŒ…æ‹¬å¤´éƒ¨ï¼Œæ‰‹å’Œè…¿éƒ¨ã€‚ æˆ‘ä»¬æ”¹å˜äº†åŸºç¡€ï¼šç°åœ¨ï¼Œé™¤äº†å¤´éƒ¨ï¼Œæ‰‹è‡‚å’Œè…¿éƒ¨ä¹‹å¤–ï¼Œå®ƒè¿˜åŒ…æ‹¬æ‰€æœ‰å…¶ä»–è‚Œè‚‰ç»„ã€‚ æˆ‘ä»¬å°†æ‰€æœ‰å†…å®¹éƒ½æ¶‚æˆç°è‰²color_muscle0ã€‚ è¿™å°†å…è®¸ä¸é‡æ–°ç²‰åˆ·å’Œä¸æ–½åŠ ä¸å‚ä¸çš„é‚£äº›è‚Œè‚‰ç¾¤ã€‚ </p><br><p> ç°åœ¨æ‰€æœ‰æ¥æºçœ‹èµ·æ¥åƒè¿™æ ·ï¼š </p><br><p><img src="https://habrastorage.org/webt/ya/zy/c3/yazyc3i8kbg590hw4qquapexzic.jpeg" alt="å›¾ç‰‡"></p><br><h3 id="lrucache">  Lrucache </h3><br><p> åœ¨å¯¹åŸå§‹å›¾åƒè¿›è¡Œäº†é¢å¤–çš„å¤„ç†ä¹‹åï¼Œä¸€äº›å›¾åƒå¼€å§‹å ç”¨ä¸€äº›å†…å­˜ï¼Œè¿™å¯¼è‡´äº†ä½¿ç”¨LruCacheè¿›è¡Œé‡ç”¨ï¼ˆåœ¨æ¯æ¬¡ä½¿ç”¨.recycleï¼ˆï¼‰æ–¹æ³•è¦†ç›–åä¸é‡Šæ”¾å®ƒä»¬ï¼‰çš„æƒ³æ³•ã€‚ æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç”¨äºå­˜å‚¨æºå›¾åƒçš„ç±»ï¼Œè¯¥ç±»åŒæ—¶æ‰¿æ‹…è¯»å–èµ„æºçš„åŠŸèƒ½ï¼š </p><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LruCacheBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val context: Context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val lruCache: LruCache&lt;String, Bitmap&gt; init { val maxMemory = (Runtime.getRuntime().maxMemory() / <span class="hljs-number"><span class="hljs-number">1024</span></span>).toInt() val cacheSize = maxMemory / <span class="hljs-number"><span class="hljs-number">4</span></span> lruCache = object : LruCache&lt;String, Bitmap&gt;(cacheSize) { override fun sizeOf(key: String, bitmap: Bitmap): Int { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap.byteCount } } } fun getBitmap(drawableName: String): Bitmap? { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (lruCache.get(drawableName) != null) lruCache.get(drawableName) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> decodeMuscleFile(drawableName) } fun clearAll() { lruCache.evictAll() } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> fun decodeMuscleFile(drawableName: String): Bitmap? { val bitmap = BitmapFactory.decodeResource(context.resources, context.resources.getIdentifier(drawableName, <span class="hljs-string"><span class="hljs-string">"drawable"</span></span>, context.packageName)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bitmap != null) { lruCache.put(drawableName, bitmap) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap } }</code> </pre> <br><p> å‡†å¤‡å›¾åƒï¼Œä¼˜åŒ–èµ„æºè§£ç ã€‚ <br> æˆ‘ä»¬ä¸ä¼šè®¨è®ºä»Javaåˆ°Kotlinçš„å¹³ç¨³è¿‡æ¸¡ï¼Œä½†æ˜¯ç¡®å®å‘ç”Ÿäº†ã€‚ </p><br><h2 id="korutiny"> åç¨‹ </h2><br><p> ä½¿ç”¨IntentServiceçš„ä»£ç å¯ä»¥å·¥ä½œï¼Œä½†æ˜¯å¸¦æœ‰å›è°ƒçš„ä»£ç çš„å¯è¯»æ€§ä¸èƒ½ç§°ä¸ºæ„‰æ‚¦ã€‚ </p><br><p> æ¸´æœ›äº†è§£å·¥ä½œä¸­çš„Kotlinåç¨‹ã€‚ æˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªç†è§£ï¼Œå³å‡ ä¸ªæœˆåï¼Œä¸æ‚¨å¯»æ‰¾è¿”å›ç”Ÿæˆçš„å›¾åƒçš„Uriæ–‡ä»¶çš„ä½ç½®ç›¸æ¯”ï¼Œé˜…è¯»åŒæ­¥ä»£ç ä¼šæ›´åŠ ä»¤äººæ„‰å¿«ã€‚ </p><br><p> åŒæ ·ï¼Œå›¾åƒå¤„ç†çš„åŠ é€Ÿä¿ƒä½¿äººä»¬åœ¨åº”ç”¨ç¨‹åºä¸­çš„å¤šä¸ªæ–°ä½ç½®ï¼ˆç‰¹åˆ«æ˜¯åœ¨ç»ƒä¹ è¯´æ˜ä¸­ï¼‰ä½¿ç”¨æ­¤åŠŸèƒ½ï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨åŸ¹è®­ä¹‹åã€‚ </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val errorHandler = CoroutineExceptionHandler { _, e -&gt; e.printStackTrace()} <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val job = SupervisorJob() <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> val scope = CoroutineScope(Dispatchers.Main + job + errorHandler) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> var uries: HashMap&lt;String, Uri?&gt; = HashMap() fun startImageGenerating() = scope.launch { ... val imgMuscle = ImgMuscle() uries = withContext(Dispatchers.IO) { imgMuscle.createMuscleImages() } ... }</code> </pre><br><p> å¦‚æœåç¨‹ä¸­æ–­ï¼Œåˆ™æ ‡å‡†çš„errorHandlerï¼Œjobå’Œscopeæ†ç»‘æ˜¯scout coroutineå’Œé”™è¯¯å¤„ç†ç¨‹åºã€‚ </p><br><p>  uries-HashMapï¼ŒHashMapæœ¬èº«å­˜å‚¨6å¼ å›¾åƒï¼Œä»¥ä¾¿éšåè¾“å‡ºåˆ°UIï¼š <br>  uries [â€œ last_backâ€] =ä¹Œé‡Œï¼Ÿ <br>  uries [â€œ last_frontâ€] =ä¹Œé‡Œï¼Ÿ <br>  uries [â€œ week_backâ€] =ä¹Œé‡Œï¼Ÿ <br>  uries [â€œ week_frontâ€] =ä¹Œé‡Œï¼Ÿ <br>  uries [â€œ month_backâ€] =ä¹Œé‡Œï¼Ÿ <br>  uries [â€œ month_frontâ€] =ä¹Œé‡Œï¼Ÿ </p><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImgMuscle</span></span></span><span class="hljs-class"> {</span></span> val lruBitmap: <span class="hljs-function"><span class="hljs-function">LruCacheBitmap suspend fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createMuscleImages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: HashMap&lt;String, Uri?&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> suspendCoroutine { continuation -&gt; val resultUries = HashMap&lt;String, Uri?&gt;() ... <span class="hljs-comment"><span class="hljs-comment">//    continuation.resume(resultUries) } } }</span></span></code> </pre><br><p> æˆ‘ä»¬æµ‹é‡å¤„ç†æ—¶é—´ã€‚ </p><br><pre> <code class="plaintext hljs">&gt;start 1549400719844 &gt;finish 1549400720440 diff=596 ms</code> </pre> <br><h4 id="s-9313-ms-obrabotka-umenshilas-do-596-ms"> ä»9313æ¯«ç§’å‡å°‘åˆ°596æ¯«ç§’ã€‚ </h4><br><p> å¦‚æœæ‚¨æœ‰å…¶ä»–ä¼˜åŒ–çš„æƒ³æ³•ï¼Œè¯·éšæ—¶å‘è¡¨è¯„è®ºã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN439596/">https://habr.com/ru/post/zh-CN439596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN439586/index.html">SPBmåè®®æ˜¯æç«¯è‡ªåŠ¨åŒ–æ ¡å›­çš„åŸºç¡€</a></li>
<li><a href="../zh-CN439588/index.html">ESETå‘ç°äº†DanaBotæœ¨é©¬çš„æ–°ç‰ˆæœ¬</a></li>
<li><a href="../zh-CN439590/index.html">è´¨é‡ï¼šæ²™ç‰¹å’Œé˜¿æ›¼å›½å®¶ç½‘ç»œå®‰å…¨CTF2019ã€‚WriteUp</a></li>
<li><a href="../zh-CN439592/index.html">é“å¾·æ´»åŠ¨è‡ªåŠ¨åŒ–</a></li>
<li><a href="../zh-CN439594/index.html">æ˜¥å­£æ³¨é‡Šï¼šAOP Magic</a></li>
<li><a href="../zh-CN439598/index.html">å¾®è½¯è°ˆè®ºäº†Windows 7ä»˜è´¹æ”¯æŒçš„æˆæœ¬</a></li>
<li><a href="../zh-CN439600/index.html">èŠ¬å…°æ€»ç»“äº†ä¿è¯åŸºæœ¬æ”¶å…¥çš„å®éªŒåˆæ­¥ç»“æœ</a></li>
<li><a href="../zh-CN439602/index.html">æ•°å­—ç©ºé—´ä¸­çš„ä¼¦ç†-å›½é™…æ•°å­—å…³ç³»çš„åŸºæœ¬è§„åˆ™</a></li>
<li><a href="../zh-CN439604/index.html">æ¡å½¢ç å¦‚ä½•æ’åˆ—ï¼Ÿ</a></li>
<li><a href="../zh-CN439606/index.html">ä»¥æœ€ä½ä»·æ ¼è¯•ç”Ÿäº§ç”µå­äº§å“</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>