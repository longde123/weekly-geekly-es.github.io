<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üñïüèº ü§üüèΩ üë©üèº‚ÄçüöÄ MVCC-4. Instantan√©s de donn√©es ‚úäüèΩ üë®üèø‚ÄçüöÄ üî£</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Apr√®s avoir examin√© les probl√®mes li√©s √† l' isolement et fait une digression sur l' organisation des donn√©es √† un bas niveau , la derni√®re fois que no...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>MVCC-4. Instantan√©s de donn√©es</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/postgrespro/blog/446652/">  Apr√®s avoir examin√© les probl√®mes li√©s √† l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">isolement</a> et fait une digression sur l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">organisation des donn√©es √† un bas niveau</a> , la derni√®re fois que nous avons parl√© en d√©tail des <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">versions de ligne</a> et trac√© comment les informations de service dans l'en-t√™te de version ont chang√© au cours de diverses op√©rations. <br><br>  Aujourd'hui, nous examinons comment des versions coh√©rentes des donn√©es sont obtenues √† partir des versions de ligne. <br><br><h1>  Qu'est-ce qu'un instantan√© de donn√©es </h1><br>  Physiquement, les pages de donn√©es peuvent contenir plusieurs versions de la m√™me ligne.  De plus, chaque transaction ne devrait voir qu'une seule (ou pas une seule) version de chaque ligne afin qu'elles forment ensemble une image coh√©rente avec ACID des donn√©es √† un certain moment. <br><br>  L'isolement dans PostgreSQL est construit sur la base d'instantan√©s: chaque transaction fonctionne avec son propre instantan√© de donn√©es, qui "contient" les donn√©es qui ont √©t√© enregistr√©es avant la cr√©ation de l'instantan√© et ne "contient" pas les donn√©es non encore fix√©es √† ce moment.  Nous <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">avons d√©j√† vu</a> que l'isolement dans ce cas est plus rigoureux que ne l'exige la norme, mais pas sans anomalies. <br><a name="habracut"></a><br>  Au niveau d'isolement de Read Committed, un instantan√© est cr√©√© au d√©but de chaque instruction de transaction.  Un tel instantan√© est actif pendant l'ex√©cution de l'instruction.  Sur la figure, le moment de la cr√©ation de l'instantan√© (qui, comme nous le rappelons, est d√©termin√© par le num√©ro de transaction) est indiqu√© en bleu. <br><br><img src="https://habrastorage.org/webt/5g/nz/nj/5gnznjhyp869w4ls01o0wy5kxlo.png"><br><br>  Aux niveaux de lecture r√©p√©table et de s√©rialisation, un instantan√© est cr√©√© une fois au d√©but de la premi√®re instruction de transaction.  Un tel instantan√© reste actif jusqu'√† la fin de la transaction. <br><br><img src="https://habrastorage.org/webt/ff/dp/17/ffdp17xhiqemal2dj8k6a21ql38.png"><br><br><h1>  Visibilit√© des versions de ligne dans l'instantan√© </h1><br><h2>  R√®gles de visibilit√© </h2><br>  Bien s√ªr, un instantan√© n'est pas une copie physique de toutes les versions de ligne requises.  En fait, un instantan√© est sp√©cifi√© par plusieurs nombres et la visibilit√© des versions de ligne dans l'instantan√© est d√©termin√©e par les r√®gles. <br><br>  La visibilit√© ou non de cette version de la ligne dans l'instantan√© d√©pend des deux champs de son en-t√™te - xmin et xmax - c'est-√†-dire du nombre de transactions qui les ont cr√©√©es et supprim√©es.  Ces intervalles ne se croisent pas, par cons√©quent, une ligne est repr√©sent√©e dans une image par un maximum de l'une de ses versions. <br><br>  Les r√®gles exactes de visibilit√© sont assez complexes et prennent en compte de nombreuses situations diff√©rentes et des cas extr√™mes. <br><blockquote>  Cela peut √™tre facilement v√©rifi√© en consultant src / backend / utils / time / tqual.c (dans la version 12, la v√©rification a √©t√© d√©plac√©e vers src / backend / access / heap / heapam_visibility.c). <br></blockquote><br>  Pour simplifier, nous pouvons dire que la version de la ligne est visible lorsque les modifications apport√©es par la transaction xmin sont visibles dans l'image, et les modifications apport√©es par la transaction xmax ne sont pas visibles (en d'autres termes, il est d√©j√† visible que la version de la ligne est apparue, mais il n'est pas encore visible qu'elle a √©t√© supprim√©e). <br><br>  √Ä leur tour, les modifications de transaction sont visibles dans l'instantan√©, si c'est la m√™me transaction qui a cr√©√© l'instantan√© (elle voit ses propres modifications), ou la transaction a √©t√© valid√©e avant la cr√©ation de l'instantan√©. <br><br>  Il est possible de repr√©senter graphiquement les transactions sous forme de segments (du d√©but au moment de la validation): <br><br><img src="https://habrastorage.org/webt/w2/cq/yr/w2cqyrzhqwmzzenek8ski3mhbzo.png"><br><br>  Ici: <br><br><ul><li>  les modifications apport√©es √† la transaction 2 seront visibles, car elles se sont termin√©es avant la cr√©ation de l'instantan√©, </li><li>  les modifications apport√©es √† la transaction 1 ne seront pas visibles car elle √©tait active au moment de la prise de l'instantan√©, </li><li>  les modifications apport√©es √† la transaction 3 ne seront pas visibles car elles ont commenc√© apr√®s la prise de l'instantan√© (peu importe si elle s'est termin√©e ou non). </li></ul><br>  Malheureusement, le moment de la validation des transactions est inconnu du syst√®me.  Seul le moment de son d√©but est connu (il est d√©termin√© par le num√©ro de transaction et est indiqu√© par une ligne pointill√©e sur les figures ci-dessus), mais le fait de l'ach√®vement n'est enregistr√© nulle part. <br><br>  Tout ce que nous pouvons faire est de conna√Ætre l'√©tat <em>actuel</em> des transactions lors de la cr√©ation d'un instantan√©.  Ces informations se trouvent dans la m√©moire partag√©e du serveur dans la structure ProcArray, qui contient une liste de toutes les sessions actives et de leurs transactions. <br><br>  Et apr√®s coup, nous ne pourrons plus comprendre si une transaction √©tait active au moment de l'instantan√© ou non.  Par cons√©quent, la liste de toutes les transactions actuellement actives doit √™tre m√©moris√©e dans l'image. <br><br>  Il d√©coule de ce qui pr√©c√®de que dans PostgreSQL, vous ne pouvez pas cr√©er un instantan√© montrant des donn√©es coh√©rentes √† une date arbitraire, <em>m√™me si</em> toutes les versions n√©cessaires des lignes existent dans les pages du tableau.  On entend souvent la question de savoir pourquoi il n'y a pas de requ√™tes r√©trospectives (ou temporelles; dans Oracle, cela s'appelle une requ√™te flashback) dans PostgreSQL - c'est l'une des raisons. <br><blockquote>  C'est dr√¥le qu'au d√©part, il y avait une telle fonctionnalit√©, mais plus tard, elle a √©t√© supprim√©e du SGBD.  Vous pouvez lire √† ce sujet dans un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article de Joseph Hellerstein</a> . <br></blockquote>  Ainsi, un instantan√© de donn√©es est d√©termin√© par plusieurs param√®tres: <br><br><ul><li>  le moment de la cr√©ation de l'instantan√©, √† savoir le num√©ro de la prochaine transaction qui n'existe pas dans le syst√®me ( <strong>snapshot.xmax</strong> ); </li><li>  une liste des transactions actives au moment de la prise de l'instantan√© ( <strong>snapshot.xip</strong> ). </li></ul><br>  Pour plus de commodit√© et d'optimisation, le num√©ro de la premi√®re transaction active ( <strong>snapshot.xmin</strong> ) est √©galement stock√© s√©par√©ment.  Cette valeur a une signification importante, que nous discuterons ci-dessous. <br><br>  De plus, quelques param√®tres suppl√©mentaires sont enregistr√©s dans l'image, mais ils ne sont pas importants pour nous. <br><br><img src="https://habrastorage.org/webt/-r/8v/aa/-r8vaa6fvrltfpd4tjjnv_zxnk4.png"><br><br><h2>  Exemple </h2><br>  Pour voir comment la visibilit√© est d√©termin√©e par l'instantan√©, nous reproduisons la situation avec les trois transactions d√©crites ci-dessus.  Le tableau comportera trois lignes, avec: <br><br><ul><li>  le premier a √©t√© ajout√© par une transaction qui a commenc√© avant la cr√©ation de l'instantan√©, mais s'est termin√©e plus tard, </li><li>  le second est ajout√© par une transaction qui a commenc√© et s'est termin√©e avant la cr√©ation de l'instantan√©, </li><li>  le troisi√®me a √©t√© ajout√© apr√®s avoir pris la photo. </li></ul><br><pre><code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">TRUNCATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> accounts;</code> </pre> <br>  Premi√®re transaction (pas encore termin√©e): <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> accounts <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'1001'</span></span>, <span class="hljs-string"><span class="hljs-string">'alice'</span></span>, <span class="hljs-number"><span class="hljs-number">1000.00</span></span>); =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> txid_current();</code> </pre><pre> <code class="plaintext hljs">=&gt; SELECT txid_current(); txid_current -------------- 3695 (1 row)</code> </pre><br>  La deuxi√®me transaction (termin√©e avant la cr√©ation de l'instantan√©): <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> accounts <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'2001'</span></span>, <span class="hljs-string"><span class="hljs-string">'bob'</span></span>, <span class="hljs-number"><span class="hljs-number">100.00</span></span>); | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> txid_current();</code> </pre><pre> <code class="plaintext hljs">| txid_current | -------------- | 3696 | (1 row)</code> </pre><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br>  Cr√©ez un instantan√© dans une transaction dans une autre session. <br><br><pre> <code class="pgsql hljs">|| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPEATABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span>; || =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> xmin, xmax, * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts;</code> </pre><pre> <code class="plaintext hljs">|| xmin | xmax | id | number | client | amount || ------+------+----+--------+--------+-------- || 3696 | 0 | 2 | 2001 | bob | 100.00 || (1 row)</code> </pre><br>  Nous terminons la premi√®re transaction apr√®s la cr√©ation de l'instantan√©: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br>  Et la troisi√®me transaction (apparue plus tard sur l'instantan√©): <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> accounts <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'2002'</span></span>, <span class="hljs-string"><span class="hljs-string">'bob'</span></span>, <span class="hljs-number"><span class="hljs-number">900.00</span></span>); | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> txid_current();</code> </pre><pre> <code class="plaintext hljs">| txid_current | -------------- | 3697 | (1 row)</code> </pre><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br>  De toute √©vidence, une ligne est toujours visible dans notre image: <br><br><pre> <code class="pgsql hljs">|| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> xmin, xmax, * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts;</code> </pre><pre> <code class="plaintext hljs">|| xmin | xmax | id | number | client | amount || ------+------+----+--------+--------+-------- || 3696 | 0 | 2 | 2001 | bob | 100.00 || (1 row)</code> </pre><br>  La question est de savoir comment PostgreSQL comprend cela. <br><br>  Tout est d√©termin√© par l'image.  Regardons √ßa: <br><br><pre> <code class="pgsql hljs">|| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> txid_current_snapshot();</code> </pre><pre> <code class="plaintext hljs">|| txid_current_snapshot || ----------------------- || 3695:3697:3695 || (1 row)</code> </pre><br>  Ici, les deux points r√©pertorient snapshot.xmin, snapshot.xmax et snapshot.xip (dans ce cas, un num√©ro, mais en g√©n√©ral - une liste). <br><br>  Selon les r√®gles √©nonc√©es ci-dessus, l'image doit montrer les modifications apport√©es par les transactions avec les nombres snapshot.xmin &lt;= xid &lt;snapshot.xmax, √† l'exception de snapshot.xip.  Regardons toutes les lignes du tableau (dans une nouvelle image): <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> xmin, xmax, * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> id;</code> </pre><pre> <code class="plaintext hljs"> xmin | xmax | id | number | client | amount ------+------+----+--------+--------+--------- 3695 | 0 | 1 | 1001 | alice | 1000.00 3696 | 0 | 2 | 2001 | bob | 100.00 3697 | 0 | 3 | 2002 | bob | 900.00 (3 rows)</code> </pre><br>  La premi√®re ligne n'est pas visible - elle a √©t√© cr√©√©e par une transaction, qui est incluse dans la liste des actifs (xip). <br>  La deuxi√®me ligne est visible - elle est cr√©√©e par une transaction qui se situe dans la plage de l'image. <br>  La troisi√®me ligne n'est pas visible - elle a √©t√© cr√©√©e par une transaction qui n'est pas dans la plage de l'instantan√©. <br><br><pre> <code class="pgsql hljs">|| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br><h1>  Propres changements </h1><br>  Un peu complique l'image est le cas de d√©terminer la visibilit√© de vos propres changements de transaction.  Ici, vous devrez peut-√™tre voir uniquement une partie de ces modifications.  Par exemple, un curseur ouvert √† un moment particulier ne devrait pas voir les modifications apport√©es apr√®s ce moment √† n'importe quel niveau d'isolement. <br><br>  Pour ce faire, dans l'en-t√™te de la version de ligne, il y a un champ sp√©cial (qui est affich√© dans les pseudo-colonnes cmin et cmax), montrant le num√©ro de s√©quence de l'op√©ration √† l'int√©rieur de la transaction.  Cmin repr√©sente le nombre √† ins√©rer, cmax repr√©sente le nombre √† supprimer, mais pour √©conomiser de l'espace dans l'en-t√™te de ligne, il s'agit en fait d'un champ, pas de deux diff√©rents.  On pense que l'insertion et la suppression de la m√™me ligne dans une seule transaction est rare. <br><br>  Si cela se produit toujours, un num√©ro sp√©cial "combo" est ins√©r√© dans le m√™me champ, √† propos duquel le processus de service se souvient des cmin et cmax r√©els.  Mais c'est compl√®tement exotique. <br><br>  Un exemple simple.  Nous commen√ßons la transaction et ajoutons la ligne au tableau: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> txid_current();</code> </pre><pre> <code class="plaintext hljs"> txid_current -------------- 3698 (1 row)</code> </pre><pre> <code class="pgsql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> accounts(id, number, client, amount) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">4</span></span>, <span class="hljs-number"><span class="hljs-number">3001</span></span>, <span class="hljs-string"><span class="hljs-string">'charlie'</span></span>, <span class="hljs-number"><span class="hljs-number">100.00</span></span>);</code> </pre><br>  Nous afficherons le contenu du tableau avec le champ cmin (mais uniquement pour les lignes ajout√©es par notre transaction - pour d'autres cela n'a pas de sens): <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> xmin, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> xmin = <span class="hljs-number"><span class="hljs-number">3698</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> cmin <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> cmin, * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts;</code> </pre><pre> <code class="plaintext hljs"> xmin | cmin | id | number | client | amount ------+------+----+--------+---------+--------- 3695 | | 1 | 1001 | alice | 1000.00 3696 | | 2 | 2001 | bob | 100.00 3697 | | 3 | 2002 | bob | 900.00 3698 | 0 | 4 | 3001 | charlie | 100.00 (4 rows)</code> </pre><br>  Ouvrez maintenant le curseur de la requ√™te qui renvoie le nombre de lignes de la table. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts;</code> </pre><br>  Et apr√®s cela, ajoutez une autre ligne: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> accounts(id, number, client, amount) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">3002</span></span>, <span class="hljs-string"><span class="hljs-string">'charlie'</span></span>, <span class="hljs-number"><span class="hljs-number">200.00</span></span>);</code> </pre><br>  La demande renverra 4 - la ligne ajout√©e apr√®s l'ouverture du curseur ne tombera pas dans l'instantan√© des donn√©es: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">FETCH</span></span> c;</code> </pre><pre> <code class="plaintext hljs"> count ------- 4 (1 row)</code> </pre><br>  Pourquoi?  Parce que dans l'instantan√©, seules les versions de ligne avec cmin &lt;1 sont prises en compte. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> xmin, <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> xmin = <span class="hljs-number"><span class="hljs-number">3698</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> cmin <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> cmin, * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts;</code> </pre><pre> <code class="plaintext hljs"> xmin | cmin | id | number | client | amount ------+------+----+--------+---------+--------- 3695 | | 1 | 1001 | alice | 1000.00 3696 | | 2 | 2001 | bob | 100.00 3697 | | 3 | 2002 | bob | 900.00 3698 | 0 | 4 | 3001 | charlie | 100.00 3698 | 1 | 5 | 3002 | charlie | 200.00 (5 rows)</code> </pre><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">ROLLBACK</span></span>;</code> </pre><br><h1>  Horizon de l'√©v√©nement </h1><br>  Le num√©ro de la premi√®re transaction active (snapshot.xmin) a une signification importante - il d√©finit ¬´l'horizon des √©v√©nements¬ª de la transaction.  A savoir, au-del√† de son horizon, une transaction ne voit toujours que les versions actuelles des lignes. <br><br>  En effet, une version non pertinente n'a besoin d'√™tre vue que si la version actuelle a √©t√© cr√©√©e par une transaction qui n'a pas encore √©t√© finalis√©e et n'est donc pas encore visible.  Mais au-del√† de ¬´l'horizon¬ª, toutes les transactions sont d√©j√† garanties d'√™tre r√©alis√©es. <br><br><img src="https://habrastorage.org/webt/8z/vp/oo/8zvpoocv891hhtnv9lcs6j7g4ry.png"><br><br>  L'horizon des √©v√©nements de la transaction est visible dans le r√©pertoire syst√®me: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> backend_xmin <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pid = pg_backend_pid();</code> </pre><pre> <code class="plaintext hljs"> backend_xmin -------------- 3699 (1 row)</code> </pre><br>  Vous pouvez √©galement d√©finir un ¬´horizon d'√©v√©nement¬ª au niveau de la base de donn√©es.  Pour ce faire, prenez tous les instantan√©s actifs et trouvez parmi eux le xmin le plus ancien.  Il d√©terminera l'horizon au-del√† duquel les versions non pertinentes des lignes de cette base de donn√©es ne seront jamais visibles pour aucune transaction.  <em>De telles versions de cha√Ænes peuvent √™tre effac√©es</em> - c'est pourquoi le concept d'horizon est si important d'un point de vue pratique. <br><br>  Si une transaction contient un instantan√© pendant une longue p√©riode, elle contiendra √©galement l'horizon des √©v√©nements de la base de donn√©es.  De plus, une transaction inachev√©e tiendra l'horizon par le fait m√™me de son existence, m√™me si aucun instantan√© n'y figure. <br><br>  Et cela signifie que les versions non pertinentes des lignes de cette base de donn√©es ne peuvent pas √™tre effac√©es.  Dans le m√™me temps, une transaction ¬´longue dur√©e¬ª peut ne pas chevaucher d'autres transactions dans les donn√©es - ce n'est absolument pas important, l'horizon de la base de donn√©es est le m√™me pour tout le monde. <br><br>  Si maintenant, pas une transaction, mais les instantan√©s (de snapshot.xmin √† snapshot.xmax) sont repr√©sent√©s comme un segment, alors la situation peut √™tre imagin√©e comme suit: <br><br><img src="https://habrastorage.org/webt/nd/ve/wi/ndvewikoeiljposax85zp7mmmn8.png"><br><br>  Dans cette figure, l'instantan√© le plus bas se r√©f√®re √† une transaction incompl√®te et dans les instantan√©s snapshot.xmin restants ne peut pas √™tre sup√©rieur √† son nombre. <br><br>  Dans notre exemple, une transaction avec le niveau d'isolement Read Committed a √©t√© d√©marr√©e.  M√™me s'il ne contient aucun instantan√© de donn√©es actif, il continue de tenir l'horizon: <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span>; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> accounts <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> amount = amount + <span class="hljs-number"><span class="hljs-number">1.00</span></span>; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> backend_xmin <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pid = pg_backend_pid();</code> </pre><pre> <code class="plaintext hljs"> backend_xmin -------------- 3699 (1 row)</code> </pre><br>  Et seulement une fois la transaction termin√©e, l'horizon avance, vous permettant d'effacer les versions non pertinentes des lignes: <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> backend_xmin <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_stat_activity <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> pid = pg_backend_pid();</code> </pre><pre> <code class="plaintext hljs"> backend_xmin -------------- 3700 (1 row)</code> </pre><br>  Si la situation d√©crite cr√©e vraiment des probl√®mes et qu'il n'y a aucun moyen de l'√©viter au niveau de l'application, alors, √† partir de la version 9.6, deux options sont disponibles: <br><br><ul><li>  <em>old_snapshot_threshold</em> d√©finit la dur√©e de vie maximale d'un instantan√©.  Pass√© ce d√©lai, le serveur obtient le droit de supprimer les versions non pertinentes des lignes, et s'il a besoin d'une transaction ¬´longue dur√©e¬ª, mais il recevra un instantan√© d'une erreur trop ancienne. </li><li>  <em>idle_in_transaction_session_timeout</em> d√©finit la dur√©e de vie maximale d'une transaction inactive.  Pass√© ce d√©lai, la transaction est abandonn√©e. </li></ul><br><h1>  Exporter un instantan√© de donn√©es </h1><br>  Il existe des situations o√π plusieurs transactions simultan√©es doivent √™tre garanties pour voir la m√™me image de donn√©es.  Par exemple, nous pouvons utiliser l'utilitaire pg_dump, qui peut fonctionner en mode parall√®le: tous les processus de travail doivent voir la base de donn√©es dans le m√™me √©tat afin que la copie de sauvegarde soit coh√©rente. <br><br>  Bien s√ªr, vous ne pouvez pas vous fier au fait que les mod√®les de donn√©es co√Øncident simplement parce que les transactions sont lanc√©es ¬´simultan√©ment¬ª.  Il existe un m√©canisme pour exporter et importer un instantan√© pour cela. <br><br>  La fonction pg_export_snapshot renvoie l'identifiant d'un instantan√© qui peut √™tre transf√©r√© (par des moyens externes au SGBD) vers une autre transaction. <br><br><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPEATABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts; <span class="hljs-comment"><span class="hljs-comment">--  </span></span></code> </pre><pre> <code class="plaintext hljs"> count ------- 3 (1 row)</code> </pre><pre> <code class="pgsql hljs">=&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> pg_export_snapshot();</code> </pre><pre> <code class="plaintext hljs"> pg_export_snapshot --------------------- 00000004-00000E7B-1 (1 row)</code> </pre><br>  Une autre transaction peut importer l'instantan√© √† l'aide de la commande SET TRANSACTION SNAPSHOT avant d'y ex√©cuter la premi√®re demande.  Vous devez d'abord d√©finir le niveau d'isolement comme Lecture r√©p√©table ou S√©rialisable, car au niveau de lecture valid√©e, les op√©rateurs utiliseront leurs propres instantan√©s. <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISOLATION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPEATABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">READ</span></span>; | =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRANSACTION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SNAPSHOT</span></span> <span class="hljs-string"><span class="hljs-string">'00000004-00000E7B-1'</span></span>;</code> </pre><br>  Maintenant, la deuxi√®me transaction fonctionnera avec un instantan√© de la premi√®re et, en cons√©quence, affichera trois lignes (et non z√©ro): <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> count(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> accounts;</code> </pre><pre> <code class="plaintext hljs">| count | ------- | 3 | (1 row)</code> </pre><br>  La dur√©e de vie de l'instantan√© export√© est la dur√©e de vie de la transaction d'exportation. <br><br><pre> <code class="pgsql hljs">| =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>; =&gt; <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span>;</code> </pre><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">√Ä suivre</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr446652/">https://habr.com/ru/post/fr446652/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr446640/index.html">20 projets, 20 langues, date limite hier. 2e partie</a></li>
<li><a href="../fr446642/index.html">Liste de contr√¥le pour la cr√©ation et la publication d'applications Web</a></li>
<li><a href="../fr446646/index.html">InterSystems IRIS 2019.1 Release</a></li>
<li><a href="../fr446648/index.html">D√©veloppement d'op√©rateurs Kubernetes avec Operator Framework</a></li>
<li><a href="../fr446650/index.html">Combien co√ªtent les testeurs et de quoi d√©pendent leurs salaires? Construire le portrait d'un sp√©cialiste en AQ performant</a></li>
<li><a href="../fr446656/index.html">Codage de la parole √† 1600 bits / s avec vocodeur neuronal LPCNet</a></li>
<li><a href="../fr446658/index.html">Entretien avec Andrei Stankevich sur la programmation sportive</a></li>
<li><a href="../fr446662/index.html">Transactions et m√©canismes de contr√¥le</a></li>
<li><a href="../fr446666/index.html">Tirez le meilleur parti des calculatrices graphiques: jeux sur la TI-83</a></li>
<li><a href="../fr446668/index.html">Python pour le web: ce qu'un junior doit savoir pour travailler et grandir</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>