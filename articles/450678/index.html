<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÖüèΩ üë®üèø‚Äç‚öñÔ∏è üçπ Citymobil: un manual para mejorar la disponibilidad en medio del crecimiento del negocio para las nuevas empresas. Parte 4 üë©üèΩ‚Äç‚öïÔ∏è üë©üèª‚ÄçüöÄ üêç</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este es el pr√≥ximo art√≠culo de la serie que describe c√≥mo estamos aumentando la disponibilidad de nuestro servicio en Citymobil (puede leer las partes...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Citymobil: un manual para mejorar la disponibilidad en medio del crecimiento del negocio para las nuevas empresas. Parte 4</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/mailru/blog/450678/"><img src="https://habrastorage.org/getpro/habr/post_images/93a/7be/c0a/93a7bec0ab381cc190b92debaab2c494.png"><br><br>  Este es el pr√≥ximo art√≠culo de la serie que describe c√≥mo estamos aumentando la disponibilidad de nuestro servicio en Citymobil (puede leer las partes anteriores aqu√≠: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 1</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">parte 3</a> ).  En otras partes, hablar√© sobre los accidentes e interrupciones en detalle. <br><br><h2>  1. Mala versi√≥n: sobrecarga de la base de datos </h2><br>  Perm√≠tanme comenzar con un ejemplo espec√≠fico de este tipo de interrupci√≥n.  Implementamos una optimizaci√≥n: agregamos USE INDEX en una consulta SQL;  tanto durante las pruebas como en la producci√≥n, aceler√≥ las consultas cortas, pero las largas, disminuyeron.  La desaceleraci√≥n de las consultas largas solo se not√≥ en la producci√≥n.  Como resultado, muchas consultas paralelas largas provocaron que la base de datos permaneciera inactiva durante una hora.  Estudiamos a fondo la forma en que funcionaba USE INDEX;  lo describimos en el archivo Do's and Dont's y advertimos a los ingenieros contra el uso incorrecto.  Tambi√©n analizamos la consulta y nos dimos cuenta de que recupera principalmente datos hist√≥ricos y, por lo tanto, puede ejecutarse en una r√©plica separada para solicitudes hist√≥ricas.  Incluso si esta r√©plica se cae debido a una sobrecarga, el negocio seguir√° funcionando. <br><a name="habracut"></a><br>  Seguimos tropezando con los mismos problemas despu√©s, y en alg√∫n momento, decidimos abordar este asunto.  Hab√≠amos estudiado el c√≥digo y movido todas las consultas que pudimos sin comprometer nuestro servicio a las r√©plicas.  Las r√©plicas se dividieron en funci√≥n de su nivel de criticidad, de modo que ninguna de ellas pod√≠a fallar y detener el servicio.  Como resultado, se nos ocurri√≥ una arquitectura con las siguientes bases de datos: <br><br><ul><li>  base de datos maestra: para operaciones de escritura y consultas que son muy sensibles a la actualizaci√≥n de datos; <br></li><li>  r√©plicas de producci√≥n: para consultas cortas que son menos sensibles a la actualizaci√≥n de datos; <br></li><li>  r√©plicas de coeficientes de aumento de precios.  Estas r√©plicas pueden tener 30-60 segundos de retraso;  eso no es crucial ya que los coeficientes no cambian con tanta frecuencia y si esta r√©plica se cae, el servicio no dejar√° de funcionar;  los precios simplemente no coincidir√°n completamente con el saldo de oferta y demanda; <br></li><li>  r√©plica para la configuraci√≥n operativa y el centro de llamadas.  Si falla, la empresa seguir√° funcionando pero sin el soporte del cliente y del controlador, y no podremos alterar temporalmente algunas configuraciones; <br></li><li>  muchas r√©plicas para an√°lisis y paneles de control ad hoc; <br></li><li>  Base de datos MPP (procesamiento masivo paralelo) para algunos an√°lisis masivos con cortes completos en los datos hist√≥ricos. <br></li></ul><br>  Esta arquitectura nos proporcion√≥ un amplio espacio para el crecimiento y redujo una serie de bloqueos debido a consultas SQL no √≥ptimas.  Pero a√∫n est√° lejos de ser perfecto.  Estamos planeando implementar fragmentaci√≥n, de modo que podamos escalar actualizaciones y eliminaciones y ser extremadamente sensibles a las consultas de actualizaci√≥n de datos.  El margen de seguridad de MySQL no es infinito.  Pronto necesitaremos artiller√≠a pesada en forma de una base de datos en memoria (por ejemplo, Tarantool).  Definitivamente voy a hablar de eso en mis pr√≥ximos art√≠culos. <br><br>  Mientras est√°bamos lidiando con el c√≥digo y las consultas no √≥ptimas, entendimos lo siguiente: cualquier no √≥ptimo deber√≠a eliminarse antes de que se haya lanzado y no despu√©s.  Esto disminuye el riesgo de interrupciones y esfuerzos de los equipos de ingenier√≠a para la optimizaci√≥n.  Si el c√≥digo ya se ha implementado con algunas nuevas versiones adem√°s, es mucho m√°s dif√≠cil optimizarlo.  Como resultado, introdujimos una revisi√≥n de c√≥digo obligatoria para la optimizaci√≥n.  Lo llevan a cabo nuestros ingenieros m√°s experimentados, nuestra fuerza de √©lite. <br><br>  Tambi√©n comenzamos a recopilar los mejores m√©todos de optimizaci√≥n de c√≥digo adecuados para nuestra realidad en Do's y Dont's.  Se enumeran a continuaci√≥n.  Por favor, no tome estas pr√°cticas como una verdad innegable y no intente replicarlas ciegamente.  Cada m√©todo tiene sentido solo para una situaci√≥n espec√≠fica y un negocio espec√≠fico.  Este es solo un ejemplo para aclarar los detalles: <br><br><ul><li>  Si una consulta SQL no depende del usuario (por ejemplo, el mapa de demanda del conductor con tarifas m√°ximas y coeficientes de sobretensi√≥n; este mapa es el mismo para cualquier usuario de la aplicaci√≥n del controlador), entonces esta consulta debe realizarse en un script cron con alguna frecuencia espec√≠fica (una vez por minuto es suficiente en ese caso).  El resultado debe escribirse en un cach√© (Memcached o Redis) que debe usarse en el c√≥digo de producci√≥n. <br></li><li>  Si una consulta SQL opera con los datos cuyo retraso no es crucial para el negocio, entonces su resultado debe colocarse en un cach√© con algo de TTL (30 segundos, por ejemplo) y luego leerse del cach√© por c√≥digo de producci√≥n. <br></li><li>  Si en una implementaci√≥n de un m√©todo de servidor espec√≠fico (en PHP u otro lenguaje del lado del servidor) decide realizar una consulta SQL, debe asegurarse de que los datos que necesita no hayan llegado con alguna otra consulta SQL o est√©n por llegar Su c√≥digo a continuaci√≥n. <br></li><li> Igual que el anterior va a las solicitudes a un cach√©.  Un cach√© es r√°pido pero sigue siendo una base de datos.  Por lo tanto, tambi√©n se puede sobrecargar.  Un error com√∫n es que usted piensa que un cach√© es una especie de variable en memoria normal y lo usa como una variable.  Pero el acceso a √©l implica un viaje de ida y vuelta a la red y genera una carga de trabajo para Redis o Memcached.  Por lo tanto, si los datos ya han llegado del cach√©, entonces no solo tome del cach√© lo que ya se ha tomado. <br></li><li>  Si durante el procesamiento de una solicitud web (nuevamente en PHP o en cualquier otro lenguaje) necesita llamar a una funci√≥n, debe asegurarse de que no se realizar√°n consultas SQL adicionales ni acceso a la memoria cach√©.  Si tal llamada a la funci√≥n es inevitable, debe asegurarse de que no se pueda modificar o que su l√≥gica no se haya roto para evitar consultas innecesarias en la base de datos / cach√©. <br></li><li>  Si es necesario realizar una consulta SQL, debe estar absolutamente seguro de que los campos que necesita no se pueden agregar a consultas ya existentes en su c√≥digo arriba o abajo. <br></li></ul><br><h2>  2. Mala operaci√≥n manual </h2><br>  Ejemplos de estos accidentes: <br><br><ul><li>  ALTER incorrecto que sobrecarg√≥ la base de datos o caus√≥ demoras en la r√©plica; <br></li><li>  DROP incorrecto (p. ej., encontramos un error en MySQL que bloque√≥ la base de datos al soltar una tabla); <br></li><li>  una consulta pesada en un maestro, hecha manualmente por error; <br></li><li>  se estaba configurando un servidor web a pesar de que estaba bajo la carga de trabajo real, mientras que pens√°bamos que estaba fuera de servicio. <br></li></ul><br>  Para minimizar las interrupciones debido a estas razones, tenemos que investigar la naturaleza de un accidente cada vez que ocurre.  Todav√≠a no hemos descubierto una regla general.  Nuevamente, veamos algunos ejemplos espec√≠ficos.  Los coeficientes de sobretensi√≥n (la tarifa del taxi en el momento y el lugar de alta demanda se multiplica por ellos) dejaron de funcionar en alg√∫n momento.  La raz√≥n fue que hab√≠a un script de Python trabajando en un servidor de r√©plica de base de datos de donde se tomaron los datos para el c√°lculo de coeficientes y el script us√≥ toda la memoria y la r√©plica se cay√≥.  El gui√≥n hab√≠a estado ejecut√°ndose por un tiempo;  estaba funcionando directamente en la r√©plica por conveniencia.  El problema se resolvi√≥ reiniciando el script.  Se sacaron las siguientes conclusiones: no ejecute scripts extranjeros en un servidor de base de datos (fue escrito en Do's and Don't's; de lo contrario, ser√≠a un tiro vac√≠o), Supervise el uso de memoria en un servidor de base de datos y alerta por SMS si ese servidor est√° a punto de quedarse sin memoria. <br><br>  Siempre es esencial sacar conclusiones y no sentirse c√≥modo en el tipo de situaci√≥n "vi el problema, lo arregl√©, lo olvid√©".  El servicio de calidad solo se puede ofrecer si uno se va con una conclusi√≥n.  Adem√°s de eso, las alertas por SMS son cr√≠ticas: aumentan el nivel de calidad del servicio, no lo dejan caer y nos permiten aumentar su confiabilidad.  Como un alpinista que llega a una posici√≥n estable y luego se levanta a otra posici√≥n estable, pero esta vez solo m√°s alto. <br><br>  El monitoreo y las alertas no son visibles, pero act√∫an como ganchos de hierro que cortan la roca de lo desconocido y nos impiden caer por debajo de nuestro acuerdo de nivel de servicio de que estamos aumentando continuamente. <br><br><h2>  3. huevo de pascua </h2><br>  Lo que llamamos "un huevo de Pascua" es una mina de acci√≥n retardada que a√∫n no hemos tropezado, a pesar de que existe desde hace un tiempo.  Fuera de este art√≠culo, este t√©rmino se usa para las caracter√≠sticas no documentadas creadas a prop√≥sito.  En nuestro caso, no es una caracter√≠stica en absoluto, sino m√°s bien un error que act√∫a como una bomba de tiempo y aparece como un efecto secundario de alguna actividad bien intencionada. <br><br>  Por ejemplo: <br><br><ul><li> sobrellenado de <code>auto_increment</code> de 32 bits; <br></li><li>  no optimismo del c√≥digo / configuraci√≥n, desencadenado por una alta carga de trabajo; <br></li><li>  r√©plica retrasada por una consulta no √≥ptima provocada por un nuevo patr√≥n de uso o por una carga de trabajo m√°s pesada; <br></li><li>  r√©plica retrasada por una operaci√≥n ACTUALIZACI√ìN no √≥ptima en el maestro que fue causada por un nuevo patr√≥n de carga de trabajo y retras√≥ la replicaci√≥n. <br></li></ul><br>  Otro tipo popular de huevo de Pascua es el c√≥digo no √≥ptimo;  para ser m√°s espec√≠fico: consulta SQL no √≥ptima.  La tabla sol√≠a ser m√°s peque√±a y la carga de trabajo era m√°s ligera: la consulta funcion√≥ bien.  Con el crecimiento lineal en la tabla de tiempos y el aumento de la carga de trabajo lineal en el tiempo, el consumo de recursos por parte de un sistema de gesti√≥n de bases de datos creci√≥ de forma cuadr√°tica.  Por lo general, eso lleva a un efecto negativo dr√°stico: es como si todo estuviera bien y de repente, ¬°vaya! <br><br>  Escenarios m√°s raros: combinaci√≥n de errores y huevos de Pascua.  Un lanzamiento con un error condujo a la ampliaci√≥n de una tabla de base de datos y aument√≥ un n√∫mero de filas de tabla de un tipo espec√≠fico, mientras que un huevo de Pascua ya existente caus√≥ la sobrecarga de la base de datos debido a las consultas m√°s lentas a esta tabla expandida. <br><br>  Sin embargo, sol√≠amos tener algunos huevos de Pascua no relacionados con la carga de trabajo.  Por ejemplo, un campo de <code>auto_increment</code> 32 bits en MYSQL.  Despu√©s de un poco m√°s de 2 mil millones de filas, los insertos fallan.  Por lo tanto, en el mundo moderno, debemos usar solo campos de <code>auto_increment</code> 64 bits.  Aprendimos bien esa lecci√≥n. <br><br>  ¬øC√≥mo lidiar con los huevos de Pascua?  La respuesta suena sencilla: a) busca los huevos viejos, b) no permitas que aparezcan los nuevos.  Estamos tratando de hacer las dos cosas.  La b√∫squeda de los viejos huevos va de la mano con nuestra optimizaci√≥n continua del c√≥digo.  Designamos a dos de los ingenieros m√°s experimentados para realizar la optimizaci√≥n casi a tiempo completo.  Encuentran consultas en slow.log que utilizan m√°s los recursos de bases de datos;  optimizan estas consultas y el c√≥digo que las rodea.  Disminuimos la posibilidad de que surjan nuevos huevos a trav√©s de la prueba de cada compromiso de optimizaci√≥n realizado por los ingenieros de sensei mencionados anteriormente.  Su tarea es se√±alar los errores que afectan el rendimiento, sugerir la forma de mejorar las cosas y transmitir este conocimiento a otros ingenieros. <br><br>  En alg√∫n momento, justo despu√©s de encontrar otro huevo de Pascua, nos dimos cuenta de que era bueno buscar consultas lentas, pero tambi√©n deber√≠amos haber buscado las consultas que parecen ser lentas pero funcionan r√°pido.  Estos son los pr√≥ximos contendientes por estrellar todo en caso de otra tabla de crecimiento explosivo.  El ejemplo est√∫pido pero obvio aqu√≠ es una consulta que escanea por completo una tabla de 10 filas sin usar √≠ndices en absoluto.  Funcionar√° r√°pido por el momento.  Sin embargo, cuando la tabla es lo suficientemente grande, la consulta eliminar√° la base de datos.  Ese es el huevo de Pascua. <br><br><h2>  4. Causas externas </h2><br>  Estas son las causas que parecemos incapaces de controlar muy bien.  Dicho de otra manera, esas son las causas que solo pueden mitigarse pero no eliminarse.  Por ejemplo: <br><br><ul><li>  Limitando nuestras solicitudes por un proveedor de servicios de mapas.  Se puede mitigar mediante el control de uso del servicio, el cumplimiento de un nivel de carga de trabajo espec√≠fico, la planificaci√≥n del aumento de la carga de trabajo de antemano y la compra de la expansi√≥n del servicio.  Sin embargo, no podemos prescindir de los mapas. <br></li><li>  Falla de red en un centro de datos.  Se puede mitigar colocando la copia del servicio en un centro de datos de respaldo.  Sin embargo, no podemos prescindir de un centro de datos f√≠sico o en la nube. <br></li><li>  Servicio de pago inicial.  Se puede mitigar mediante servicios de pago de respaldo.  Sin embargo, no podemos prescindir de los pagos. <br></li><li>  Bloqueo errante del tr√°fico por un servicio de protecci√≥n DDoS.  Puede mitigarse desactivando el servicio de protecci√≥n DDoS de forma predeterminada, activ√°ndolo solo en caso de un ataque DDoS.  Sin embargo, no podemos prescindir de la protecci√≥n DDoS. <br></li></ul><br>  Dado que incluso la mitigaci√≥n de una causa externa es un esfuerzo largo y costoso, comenzamos a recopilar estad√≠sticas de accidentes causados ‚Äã‚Äãpor razones externas y esperamos la acumulaci√≥n de masa cr√≠tica.  No tenemos una receta para definir una masa cr√≠tica.  Se trata de mera intuici√≥n.  Por ejemplo, si estuvi√©ramos completamente ca√≠dos cinco veces debido, por ejemplo, a los problemas del servicio de protecci√≥n DDoS, entonces con cada tiempo de inactividad posterior, la necesidad de una alternativa se volver√≠a cada vez m√°s aguda. <br><br>  Por otro lado, si de alguna manera podemos hacer que todo funcione con un servicio externo no disponible, definitivamente lo haremos.  El an√°lisis post mortem de cada corte nos ayuda aqu√≠.  Siempre debe haber una conclusi√≥n.  Lo que significa que nos guste o no, siempre encontramos una soluci√≥n. <br><br><hr><br>  En la parte final, voy a hablar sobre un tipo m√°s de interrupciones y las conclusiones que hicimos sobre ellas, c√≥mo modificamos el proceso de desarrollo, qu√© automatizaci√≥n introdujimos.  Est√©n atentos! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450678/">https://habr.com/ru/post/450678/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450662/index.html">Migraci√≥n perfecta de RabbitMQ a Kubernetes</a></li>
<li><a href="../450666/index.html">¬øReact tiene un efecto negativo en Angular?</a></li>
<li><a href="../450672/index.html">Construcci√≥n de un sitio de metal sobre una base de pilotes en SPDS</a></li>
<li><a href="../450674/index.html">Reubicaci√≥n a Armenia</a></li>
<li><a href="../450676/index.html">Metalworking 2019: soluciones 3D avanzadas para empresas</a></li>
<li><a href="../450680/index.html">"Al prestar atenci√≥n a los problemas de accesibilidad, obtienes usuarios extremadamente leales". Entrevista con John Fox (Netflix)</a></li>
<li><a href="../450682/index.html">El libro "CSS para profesionales"</a></li>
<li><a href="../450684/index.html">Cool Smart Jumps: Tangram Smart Rope Smart Rope Review</a></li>
<li><a href="../450686/index.html">Otras tres caracter√≠sticas no obvias de Zimbra Collaboration Suite que ayudar√°n a aumentar la productividad de los empleados</a></li>
<li><a href="../450692/index.html">C√≥mo las corporaciones usan 7 pecados capitales en la venta de productos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>