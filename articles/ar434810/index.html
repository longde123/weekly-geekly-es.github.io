<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👸🏾 ™️ 🔌 بداية للعمل مع Spring Cloud ⛹🏻 🤴🏾 🌸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="مرحبا بالجميع! 


 في هذه المقالة ، سأوضح المكونات الأساسية لإنشاء خدمات الخلاط التفاعلي المتفاعل باستخدام Spring WebFlux ، Spring Security ، Spring C...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>بداية للعمل مع Spring Cloud</h1><div class="post__body post__body_full" style=";text-align:right;direction:rtl"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/434810/" style=";text-align:right;direction:rtl"><p style=";text-align:right;direction:rtl">  مرحبا بالجميع! </p><br><p style=";text-align:right;direction:rtl">  في هذه المقالة ، سأوضح المكونات الأساسية لإنشاء خدمات الخلاط التفاعلي المتفاعل باستخدام Spring WebFlux ، Spring Security ، Spring Cloud Netflix Eureka (اكتشاف الخدمة) ، Hystrix (Circuit Breaker) ، Ribbon (Client Load Balancer) ، التكوين الخارجي (عبر مستودع git) ، ربيع سحابة Sleuth ، بوابة سحابة الربيع ، التمهيد الربيع رد الفعل MongoDB.  وكذلك Spring Boot Admin و Zipkin للمراقبة. </p><a name="habracut"></a><br><p style=";text-align:right;direction:rtl"> تم إجراء هذه المراجعة بعد دراسة كتب Spring Microservices أثناء العمل والتدريب العملي على تطبيق Spring 5 Security للتطبيقات التفاعلية. </p><br><p style=";text-align:right;direction:rtl">  في هذه المقالة ، سننشئ تطبيقًا أوليًا يحتوي على ثلاثة استعلامات: الحصول على قائمة بالألعاب ، والحصول على قائمة باللاعبين ، وإنشاء لعبة من معرف اللاعبين ، وطلب التحقق من الاستعادة (Hystrix fallback) في حالة انتظار طويل للحصول على إجابة.  وتنفيذ المصادقة من خلال الرمز المميز JWT استنادا إلى كتاب التدريب العملي على الأمن الربيع للتطبيقات التفاعلية. </p><br><p style=";text-align:right;direction:rtl">  لن أصف كيف يتم إنشاء كل تطبيق في IDE ، لأن هذه المقالة مخصصة لمستخدم ذي خبرة. </p><br><h1 id="struktura-proekta" style=";text-align:right;direction:rtl">  هيكل المشروع </h1><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/157/13f/e68/15713fe681fb005e4b94a75bae127f40.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl"> يتكون المشروع من وحدتين.  يمكن نسخ وحدة <code>spring-servers</code> بأمان من مشروع إلى آخر.  هناك تقريبا أي رمز وتكوينات.  تحتوي وحدة <code>tictactoe-services</code> على وحدات و microservices من تطبيقنا.  سألاحظ على الفور أن إضافة <code>auth-module</code> <code>domain-module</code> إلى الخدمات ، ينتهك أحد مبادئ هندسة الخدمات المصغرة حول استقلالية الخدمات الصغيرة.  لكن في مرحلة تطوير هذه الوحدات ، أعتقد أن هذا هو الحل الأفضل. </p><br><h1 id="konfiguraciya-gradle" style=";text-align:right;direction:rtl">  التكوين المهد </h1><br><p style=";text-align:right;direction:rtl">  يعجبني عندما يكون تكوين Gradle بالكامل في ملف واحد ، لذلك قمت بتكوين المشروع بالكامل في <code>build.gradle</code> واحد. </p><br><div class="spoiler" style=";text-align:right;direction:rtl">  <b class="spoiler_title">بناء</b> <div class="spoiler_text" style=";text-align:right;direction:rtl"><pre style=";text-align:right;direction:rtl"> <code class="java hljs">buildscript { ext { springBootVersion = <span class="hljs-string"><span class="hljs-string">'2.1.1.RELEASE'</span></span> gradleDockerVersion = <span class="hljs-string"><span class="hljs-string">'0.20.1'</span></span> } repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">"https://plugins.gradle.org/m2/"</span></span> } } dependencies { classpath(<span class="hljs-string"><span class="hljs-string">"org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}"</span></span>) classpath(<span class="hljs-string"><span class="hljs-string">"gradle.plugin.com.palantir.gradle.docker:gradle-docker:${gradleDockerVersion}"</span></span>) } } allprojects { group = <span class="hljs-string"><span class="hljs-string">'com.tictactoe'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'java'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'eclipse'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'org.springframework.boot'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'io.spring.dependency-management'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.palantir.docker'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.palantir.docker-run'</span></span> apply plugin: <span class="hljs-string"><span class="hljs-string">'com.palantir.docker-compose'</span></span> } docker.name = <span class="hljs-string"><span class="hljs-string">'com.tictactoe'</span></span> bootJar.enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> sourceCompatibility = <span class="hljs-number"><span class="hljs-number">11</span></span> repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">"https://repo.spring.io/milestone"</span></span> } } subprojects { ext[<span class="hljs-string"><span class="hljs-string">'springCloudVersion'</span></span>] = <span class="hljs-string"><span class="hljs-string">'Greenwich.M3'</span></span> sourceSets.configureEach { sourceSet -&gt; tasks.named(sourceSet.compileJavaTaskName, { options.annotationProcessorGeneratedSourcesDirectory = file(<span class="hljs-string"><span class="hljs-string">"$buildDir/generated/sources/annotationProcessor/java/${sourceSet.name}"</span></span>) }) } repositories { mavenCentral() maven { url <span class="hljs-string"><span class="hljs-string">"https://repo.spring.io/milestone"</span></span> } } dependencyManagement { imports { mavenBom <span class="hljs-string"><span class="hljs-string">"org.springframework.cloud:spring-cloud-dependencies:${springCloudVersion}"</span></span> } } dependencies { <span class="hljs-function"><span class="hljs-function">compile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fileTree</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(include: [</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'*.jar'</span></span></span></span><span class="hljs-function"><span class="hljs-params">], dir: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'libs'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileOnly</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'org.projectlombok:lombok'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">annotationProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'org.projectlombok:lombok'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> } } </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">project</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">':spring-servers'</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ bootJar.enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> task cleanAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'clean'</span></span>) } task buildAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'build'</span></span>) } dockerCompose { template <span class="hljs-string"><span class="hljs-string">'docker-compose.spring-servers.template.yml'</span></span> dockerComposeFile <span class="hljs-string"><span class="hljs-string">'docker-compose.spring-servers.yml'</span></span> } } project(<span class="hljs-string"><span class="hljs-string">':tictactoe-services'</span></span>) { bootJar.enabled = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> task cleanAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'clean'</span></span>) } task buildAll { dependsOn subprojects*.tasks*.findByName(<span class="hljs-string"><span class="hljs-string">'build'</span></span>) } } <span class="hljs-comment"><span class="hljs-comment">// Tictactoe Modules project(':tictactoe-services:domain-module') { bootJar.enabled = false jar { enabled = true group 'com.tictactoe' baseName = 'domain-module' version = '1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.boot:spring-boot-starter-data-mongodb-reactive') implementation('org.springframework.boot:spring-boot-starter-validation') implementation('com.fasterxml.jackson.core:jackson-annotations:2.9.3') implementation 'com.intellij:annotations:+@jar' compileOnly('org.projectlombok:lombok') testCompile group: 'junit', name: 'junit', version: '4.12' } } project(':tictactoe-services:auth-module') { bootJar.enabled = false jar { enabled = true baseName = 'auth-module' version = '1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation('org.springframework.boot:spring-boot-starter-webflux') implementation('org.springframework.boot:spring-boot-starter-data-mongodb-reactive') implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.cloud:spring-cloud-starter-netflix-ribbon') implementation('org.springframework.security:spring-security-oauth2-core') implementation('org.springframework.security:spring-security-oauth2-jose') implementation 'com.intellij:annotations:+@jar' testImplementation('org.springframework.boot:spring-boot-starter-test') testImplementation('io.projectreactor:reactor-test') testImplementation('org.springframework.security:spring-security-test') } } project(':tictactoe-services:user-service') { bootJar { launchScript() baseName = 'user-service' version = '0.1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation project(':tictactoe-services:auth-module') } } project(':tictactoe-services:game-service') { bootJar { launchScript() baseName = 'game-service' version = '0.1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation project(':tictactoe-services:auth-module') } } project(':tictactoe-services:webapi-service') { bootJar { launchScript() baseName = 'webapi-service' version = '0.1.0' } dependencies { implementation project(':tictactoe-services:domain-module') implementation project(':tictactoe-services:auth-module') } } // Spring Servers project(':spring-servers:discovery-server') { bootJar { launchScript() baseName = 'discovery-server' version = '0.1.0' } dependencies { implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-server') implementation('org.springframework.boot:spring-boot-starter-security') compile('javax.xml.bind:jaxb-api:2.3.0') compile('javax.activation:activation:1.1') compile('org.glassfish.jaxb:jaxb-runtime:2.3.0') testImplementation('org.springframework.boot:spring-boot-starter-test') } } project(':spring-servers:config-server') { bootJar { launchScript() baseName = 'config-server' version = '0.1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.cloud:spring-cloud-config-server') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') testImplementation('org.springframework.boot:spring-boot-starter-test') } } project(':spring-servers:gateway-server') { bootJar { launchScript() baseName = 'gateway-server' version = '0.1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-webflux') implementation('org.springframework.boot:spring-boot-starter-actuator') implementation('org.springframework.cloud:spring-cloud-starter-gateway') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-ribbon') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') testImplementation('org.springframework.boot:spring-boot-starter-test') } } project(':spring-servers:admin-server') { ext['springBootAdminVersion'] = '2.1.1' bootJar { launchScript() baseName = 'admin-server' version = '0.1.0' } dependencies { implementation('org.springframework.boot:spring-boot-starter-web') implementation('org.springframework.boot:spring-boot-starter-security') implementation('de.codecentric:spring-boot-admin-starter-server') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') testImplementation('org.springframework.boot:spring-boot-starter-test') testImplementation('org.springframework.security:spring-security-test') } dependencyManagement { imports { mavenBom "de.codecentric:spring-boot-admin-dependencies:${springBootAdminVersion}" } } } subprojects { subproject -&gt; if (file("${subproject.projectDir}/docker/Dockerfile").exists()) { docker { // workingbit - replace with your dockerhub's username name "workingbit/${subproject.group}.${subproject.bootJar.baseName}" tags 'latest' dockerfile file("${subproject.projectDir}/docker/Dockerfile") files tasks.bootJar.archivePath, 'docker/run.sh' buildArgs "JAR_FILE": "${subproject.bootJar.baseName}-${subproject.bootJar.version}.jar", "RUN_SH": "run.sh" } } else { docker.name = 'noop' } if (subproject.name.endsWith('service')) { dependencies { implementation('org.springframework.boot:spring-boot-starter-actuator') implementation('org.springframework.boot:spring-boot-starter-webflux') implementation('org.springframework.boot:spring-boot-starter-data-mongodb-reactive') implementation('org.springframework.boot:spring-boot-starter-security') implementation('org.springframework.security:spring-security-oauth2-core') implementation('org.springframework.security:spring-security-oauth2-jose') implementation('org.springframework.cloud:spring-cloud-starter-config') implementation('org.springframework.cloud:spring-cloud-starter-netflix-eureka-client') implementation('org.springframework.cloud:spring-cloud-starter-netflix-hystrix') implementation('org.springframework.cloud:spring-cloud-starter-netflix-ribbon') implementation('org.springframework.cloud:spring-cloud-starter-sleuth') implementation('org.springframework.cloud:spring-cloud-starter-zipkin') implementation('org.springframework.security:spring-security-rsa') implementation('com.intellij:annotations:+@jar') implementation('org.apache.commons:commons-lang3:3.8.1') runtimeOnly('org.springframework.boot:spring-boot-devtools') testImplementation('org.springframework.boot:spring-boot-starter-test') testImplementation('de.flapdoodle.embed:de.flapdoodle.embed.mongo') testImplementation('io.projectreactor:reactor-test') } } }</span></span></code> </pre> </div></div><br><p style=";text-align:right;direction:rtl">  يتيح لك استخدام ملف تكوين شائع جعل التبعيات مشتركة بين خدمات microservices ، وفي هذه الحالة ، يكون للخدمات اسم ينتهي بـ "service" ، في مكان واحد.  ولكن ، هذا ينتهك مرة أخرى مبدأ استقلالية الخدمات المجهرية.  بالإضافة إلى التبعيات الشائعة ، يمكنك إضافة المهام إلى المشاريع الفرعية.  أضفت <code>gradle.plugin.com.palantir.gradle.docker:gradle-docker</code> مهام البرنامج المساعد <code>gradle.plugin.com.palantir.gradle.docker:gradle-docker</code> للعمل مع <code>Docker</code> . </p><br><h1 id="modul-auth-module" style=";text-align:right;direction:rtl">  وحدة المصادقة </h1><br><p style=";text-align:right;direction:rtl">  الآن ، النظر في وحدة المصادقة JWT.  يمكن العثور على وصف لحزمة <code>auth</code> في هذه الوحدة في دفتر المصادقة التفاعلي الذي ذكرته أعلاه. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/777/df9/da5/777df9da5df30a97673493012008377c.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl">  آه ، <code>config</code> حزمة <code>config</code> بمزيد من التفاصيل. </p><br><h1 id="klass-slozhnyh-svoystv-applicationclientspropertiesjava" style=";text-align:right;direction:rtl">  فئة من الخصائص "المعقدة" ApplicationClientsProperties.java </h1><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Data @Component @ConfigurationProperties("appclients") public class ApplicationClientsProperties { private List&lt;ApplicationClient&gt; clients = new ArrayList&lt;&gt;(); @Data public static class ApplicationClient { private String username; private String password; private String[] roles; } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  تحتوي هذه الفئة على خصائص "معقدة" لتكوين قاعدة بيانات inMemory. </p><br><h1 id="klass-konfiguracii-modulya-authmoduleconfigjava" style=";text-align:right;direction:rtl">  فئة تكوين الوحدة النمطية AuthModuleConfig.java </h1><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Data @Configuration @PropertySource("classpath:moduleConfig.yml") public class AuthModuleConfig { @Value("${tokenExpirationMinutes:60}") private Integer tokenExpirationMinutes; @Value("${tokenIssuer:workingbit-example.com}") private String tokenIssuer; @Value("${tokenSecret:secret}") // length minimum 256 bites private String tokenSecret; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  في ملف المورد ، يجب عليك تحديد هذه المتغيرات.  في التكوين الخاص بي ، الرمز المميز ينتهي بعد 10 ساعات. </p><br><h1 id="klass-konfiguracii-matcherov-filtrov-microserviceservicejwtauthwebfilterjava" style=";text-align:right;direction:rtl">  MicroserviceServiceJwtAuthWebFilter.java تصفية تكوين فئة المطابقة </h1><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">public class MicroserviceServiceJwtAuthWebFilter extends JwtAuthWebFilter { private final String[] matchersStrings; public MicroserviceServiceJwtAuthWebFilter(JwtService jwtService, String[] matchersStrings) { super(jwtService); this.matchersStrings = matchersStrings; } @Override protected ServerWebExchangeMatcher getAuthMatcher() { List&lt;ServerWebExchangeMatcher&gt; matchers = Arrays.stream(this.matchersStrings) .map(PathPatternParserServerWebExchangeMatcher::new) .collect(Collectors.toList()); return ServerWebExchangeMatchers.matchers(new OrServerWebExchangeMatcher(matchers)); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  أثناء الإنشاء ، يقوم عامل التصفية هذا بتمرير الخدمة للعمل مع JWT وقائمة المسارات التي سيعالجها هذا المرشح. </p><br><h1 id="klass-konfiguracii-reactive-spring-boot-security-microservicespringsecuritywebfluxconfigjava" style=";text-align:right;direction:rtl">  فئة رد الفعل على تأمين التمهيد الربيعي MicroserviceSpringSecurityWebFluxConfig.java فئة التكوين </h1><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@ConditionalOnProperty(value = "microservice", havingValue = "true") @EnableReactiveMethodSecurity @PropertySource(value = "classpath:/application.properties") public class MicroserviceSpringSecurityWebFluxConfig { @Value("${whiteListedAuthUrls}") private String[] whiteListedAuthUrls; @Value("${jwtTokenMatchUrls}") private String[] jwtTokenMatchUrls; /** * Bean which configures whiteListed and JWT filter urls * Also it configures authentication for Actuator. Actuator takes configured AuthenticationManager automatically * which uses MapReactiveUserDetailsService to configure inMemory users */ @Bean public SecurityWebFilterChain springSecurityFilterChain( ServerHttpSecurity http, JwtService jwtService ) { MicroserviceServiceJwtAuthWebFilter userServiceJwtAuthWebFilter = new MicroserviceServiceJwtAuthWebFilter(jwtService, jwtTokenMatchUrls); http.csrf().disable(); http .authorizeExchange() .pathMatchers(whiteListedAuthUrls) .permitAll() .and() .authorizeExchange() .pathMatchers("/actuator/**").hasRole("SYSTEM") .and() .httpBasic() .and() .addFilterAt(userServiceJwtAuthWebFilter, SecurityWebFiltersOrder.AUTHENTICATION); return http.build(); } }</code> </pre> <br><p style=";text-align:right;direction:rtl">  هناك ثلاثة تعليقات توضيحية مثيرة للاهتمام هنا. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@ConditionalOnProperty(value = "microservice", havingValue = "true")</code> </pre> <br><p style=";text-align:right;direction:rtl">  تعليق توضيحي يصل هذه الوحدة بالاعتماد على متغير microservice في ملف التكوين المحدد في التعليق التوضيحي.  يعد ذلك ضروريًا لتعطيل التحقق من الرمز المميز العام في بعض الوحدات النمطية.  في هذا التطبيق ، هذه <code>webapi-service</code> لها تطبيق خاص بها <code>webapi-service</code> <code>SecurityWebFilterChain</code> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@PropertySource(value = "classpath:/application.properties")</code> </pre> <br><p style=";text-align:right;direction:rtl">  يسمح لك هذا التعليق التوضيحي أيضًا بأخذ خصائص من الخدمة الرئيسية التي يتم استيراد هذه الوحدة إليها.  بمعنى آخر ، المتغيرات </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Value("${whiteListedAuthUrls}") private String[] whiteListedAuthUrls; @Value("${jwtTokenMatchUrls}") private String[] jwtTokenMatchUrls;</code> </pre> <br><p style=";text-align:right;direction:rtl">  تأخذ قيمها من تكوين microservice من السليل. </p><br><p style=";text-align:right;direction:rtl">  بالإضافة إلى تعليق توضيحي يتيح لك إرفاق تعليقات توضيحية <code>@PreAuthorize(“hasRole('MY_ROLE')”)</code> مثل <code>@PreAuthorize(“hasRole('MY_ROLE')”)</code> </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@EnableReactiveMethodSecurity</code> </pre> <br><p style=";text-align:right;direction:rtl">  وفي هذه الوحدة النمطية ، يتم إنشاء فول <code>SecurityWebFilterChain</code> ، الذي يقوم بتكوين الوصول إلى المشغل وعنوان url المسموح به وعنوان url الذي تم التحقق من الرمز المميز JWT عليه.  تجدر الإشارة إلى أن الوصول إلى عامل تصفية الرمز المميز JWT يجب أن يكون مفتوحًا. </p><br><h1 id="konfiguraciya-springwebfluxconfigjava" style=";text-align:right;direction:rtl">  تكوين SpringWebFluxConfig.java </h1><br><p style=";text-align:right;direction:rtl">  في هذا التكوين ، يتم إنشاء <code>MapReactiveUserDetailsService</code> لتكوين المشغل ومستخدمي النظام الآخرين في الذاكرة. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Bean @Primary public MapReactiveUserDetailsService userDetailsRepositoryInMemory() { List&lt;UserDetails&gt; users = applicationClients.getClients() .stream() .map(applicationClient -&gt; User.builder() .username(applicationClient.getUsername()) .password(passwordEncoder().encode(applicationClient.getPassword())) .roles(applicationClient.getRoles()).build()) .collect(toList()); return new MapReactiveUserDetailsService(users); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  <code>ReactiveUserDetailsService</code> وهو أمر ضروري لخياطة مستودع المستخدم لدينا مع <code>Spring Security</code> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Bean public ReactiveUserDetailsService userDetailsRepository(UserRepository users) { return (email) -&gt; users.findByEmail(email).cast(UserDetails.class); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  فاصوليا لإنشاء عميل <code>WebClient</code> لتنفيذ طلبات رد الفعل. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Bean public WebClient loadBalancedWebClientBuilder(JwtService jwtService) { return WebClient.builder() .filter(lbFunction) .filter(authorizationFilter(jwtService)) .build(); } private ExchangeFilterFunction authorizationFilter(JwtService jwtService) { return ExchangeFilterFunction .ofRequestProcessor(clientRequest -&gt; ReactiveSecurityContextHolder.getContext() .map(securityContext -&gt; ClientRequest.from(clientRequest) .header(HttpHeaders.AUTHORIZATION, jwtService.getHttpAuthHeaderValue(securityContext.getAuthentication())) .build())); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  أثناء الإنشاء ، تتم إضافة مرشحين.  <code>LoadBalancer</code> والمرشح الذي يأخذ مثيل <code>Authentication</code> من سياق <code>ReactiveSecurityContext</code> ويقوم بإنشاء رمز مميز منه بحيث تتم مصادقة عامل التصفية بواسطة الخادم الهدف ويتم اعتماده وفقًا لذلك. </p><br><p style=";text-align:right;direction:rtl">  ولراحة العمل مع نوع وتواريخ MongoDB <code>ObjectId</code> ، أضفت صندوق إنشاء objectMapper: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Bean @Primary ObjectMapper objectMapper() { Jackson2ObjectMapperBuilder builder = new Jackson2ObjectMapperBuilder(); builder.serializerByType(ObjectId.class, new ToStringSerializer()); builder.deserializerByType(ObjectId.class, new JsonDeserializer() { @Override public Object deserialize(JsonParser p, DeserializationContext ctxt) throws IOException { Map oid = p.readValueAs(Map.class); return new ObjectId( (Integer) oid.get("timestamp"), (Integer) oid.get("machineIdentifier"), ((Integer) oid.get("processIdentifier")).shortValue(), (Integer) oid.get("counter")); } }); builder.featuresToDisable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS); return builder.build(); }</code> </pre> <br><h1 id="mikroservis-game-service" style=";text-align:right;direction:rtl">  خدمة لعبة Microservice </h1><br><p style=";text-align:right;direction:rtl">  خدمة لعبة microservice لها البنية التالية: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/4d8/c3c/e15/4d8c3ce15b22736bff0eda748f2a215e.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl">  كما ترون فيه ، ملف تكوين ApplicationConfig واحد فقط </p><br><h1 id="konfigurator-applicationconfigjava" style=";text-align:right;direction:rtl">  Configurator ApplicationConfig.java </h1><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Data @Configuration @EnableReactiveMongoRepositories("com.tictactoe.gameservice.repository") @Import({ApplicationClientsProperties.class, SpringWebFluxConfig.class, MicroserviceSpringSecurityWebFluxConfig.class}) public class ApplicationConfig { @Value("${userserviceUrl}") private String userServiceUrl; }</code> </pre> <br><p style=";text-align:right;direction:rtl">  يحتوي على متغير مع عنوان <code>user-service</code> ، وهناك شروحان مهمتان: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@EnableReactiveMongoRepositories("com.tictactoe.gameservice.repository")</code> </pre> <br><p style=";text-align:right;direction:rtl">  هذا التعليق التوضيحي مطلوب للإشارة إلى مستودع MongoDB للمكون. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Import({ApplicationClientsProperties.class, SpringWebFluxConfig.class, MicroserviceSpringSecurityWebFluxConfig.class})</code> </pre> <br><p style=";text-align:right;direction:rtl">  يستورد هذا التعليق التوضيحي التكوينات من <code>auth-module</code> . </p><br><h1 id="servis-gameservicejava" style=";text-align:right;direction:rtl">  خدمة GameService.java </h1><br><p style=";text-align:right;direction:rtl">  تحتوي هذه الخدمة فقط على الرمز المثير للاهتمام التالي: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@HystrixCommand public Flux&lt;Game&gt; getAllGames() { return gameRepository.findAll(); } @HystrixCommand(fallbackMethod = "buildFallbackAllGames", threadPoolKey = "licenseByOrgThreadPool", threadPoolProperties = {@HystrixProperty(name = "coreSize", value = "30"), @HystrixProperty(name = "maxQueueSize", value = "10")}, commandProperties = { @HystrixProperty(name = "circuitBreaker.requestVolumeThreshold", value = "10"), @HystrixProperty(name = "circuitBreaker.errorThresholdPercentage", value = "75"), @HystrixProperty(name = "circuitBreaker.sleepWindowInMilliseconds", value = "7000"), @HystrixProperty(name = "metrics.rollingStats.timeInMilliseconds", value = "15000"), @HystrixProperty(name = "metrics.rollingStats.numBuckets", value = "5")} ) public Flux&lt;Game&gt; getAllGamesLong() { // logger.debug("LicenseService.getLicensesByOrg Correlation id: {}", UserContextHolder.getContext().getCorrelationId()); randomlyRunLong(); return gameRepository.findAll(); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  يطرح هذا الأسلوب استثناءً عشوائيًا وتقوم Hystrix وفقًا للتعليق التوضيحي بإرجاع نتيجة الطريقة التالية: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">private Flux&lt;Game&gt; buildFallbackAllGames() { User fakeUserBlack = new User("fakeUserBlack", "password", Collections.emptyList()); User fakeUserWhite = new User("fakeUserBlack", "password", Collections.emptyList()); Game game = new Game(fakeUserBlack, fakeUserWhite); List&lt;Game&gt; games = List.of(game); return Flux.fromIterable(games); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  كما هو مذكور في الكتاب المذكور أعلاه ، إذا ما تم كسر شيء ما ، فدعونا نعرض البيانات المخزنة مؤقتًا أو البديلة أفضل من لا شيء. </p><br><h1 id="mikroservis-webapi-service" style=";text-align:right;direction:rtl">  Microservice webapi الخدمة </h1><br><p style=";text-align:right;direction:rtl">  هذا نوع من البرامج الوسيطة بين Gateway والأجهزة الصغيرة الداخلية غير المرئية من الخارج.  الغرض من هذه الخدمة هو الحصول على اختيار من خدمات أخرى وتشكيل استجابة للمستخدم على أساسها. </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/35c/a1f/773/35ca1f77332fc0a78566650549a9b625.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl">  نبدأ الاستعراض مع التكوين. </p><br><h1 id="konfiguraciya-springsecuritywebfluxconfigjava" style=";text-align:right;direction:rtl">  تكوين SpringSecurityWebFluxConfig.java </h1><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@Configuration @EnableReactiveMethodSecurity public class SpringSecurityWebFluxConfig { private static final String AUTH_TOKEN_PATH = "/auth/token"; @Value("${whiteListedAuthUrls}") private String[] whiteListedAuthUrls; @Value("${jwtTokenMatchUrls}") private String[] jwtTokenMatchUrls; @Bean @Primary public SecurityWebFilterChain systemSecurityFilterChain( ServerHttpSecurity http, JwtService jwtService, @Qualifier("userDetailsRepository") ReactiveUserDetailsService userDetailsService ) {</code> </pre> <br><p style=";text-align:right;direction:rtl">  هنا نقوم بإنشاء مدير مصادقة من خدمات <code>userDetailsService</code> ، التي حددناها مسبقًا في <code>auth-module</code> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> UserDetailsRepositoryReactiveAuthenticationManager authenticationManager = new UserDetailsRepositoryReactiveAuthenticationManager(userDetailsService);</code> </pre> <br><p style=";text-align:right;direction:rtl">  كما نقوم بإنشاء مرشح مع هذا المدير ، ونضيف أيضًا محول مثيل المصادقة من أجل الحصول على بيانات المستخدم بترميز <code>x-www-form-urlencoded</code> . </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> AuthenticationWebFilter tokenWebFilter = new AuthenticationWebFilter(authenticationManager); tokenWebFilter.setServerAuthenticationConverter(exchange -&gt; Mono.justOrEmpty(exchange) .filter(ex -&gt; AUTH_TOKEN_PATH.equalsIgnoreCase(ex.getRequest().getPath().value())) .flatMap(ServerWebExchange::getFormData) .filter(formData -&gt; !formData.isEmpty()) .map((formData) -&gt; { String email = formData.getFirst("email"); String password = formData.getFirst("password"); return new UsernamePasswordAuthenticationToken(email, password); }) );</code> </pre> <br><p style=";text-align:right;direction:rtl">  نضيف معالج تفويض ناجح ، يتمثل جوهره في وضع الرمز المميز لـ JWT في رأس الطلب الذي تم إنشاؤه من <code>Authentication</code> بحيث لا يمكن إجراء المصادقة إلا باستخدام رمز ضيف صالح. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> tokenWebFilter.setAuthenticationSuccessHandler(new JwtAuthSuccessHandler(jwtService)); MicroserviceServiceJwtAuthWebFilter webApiJwtServiceWebFilter = new MicroserviceServiceJwtAuthWebFilter(jwtService, jwtTokenMatchUrls); http.csrf().disable(); http .authorizeExchange()</code> </pre> <br><p style=";text-align:right;direction:rtl">  نحل عناوين من القائمة البيضاء.  كما كتبت سابقًا ، يجب أيضًا فتح العناوين التي ستتم معالجتها بواسطة مرشح JWT </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> .pathMatchers(whiteListedAuthUrls) .permitAll() .and() .authorizeExchange()</code> </pre> <br><p style=";text-align:right;direction:rtl">  نحن نحمي المشغل وبعض العناوين بالمصادقة الأساسية </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> .pathMatchers("/actuator/**").hasRole("SYSTEM") .pathMatchers(HttpMethod.GET, "/url-protected/**").hasRole("GUEST") .pathMatchers(HttpMethod.POST, "/url-protected/**").hasRole("USER") .and() .httpBasic() .and() .authorizeExchange()</code> </pre> <br><p style=";text-align:right;direction:rtl">  جعل مصادقة رمزية الوصول إلزامية </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> .pathMatchers(AUTH_TOKEN_PATH).authenticated() .and()</code> </pre> <br><p style=";text-align:right;direction:rtl">  إضافة المرشحات.  لمصادقة والتحقق من الرمز المميز JWT. </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs"> .addFilterAt(webApiJwtServiceWebFilter, SecurityWebFiltersOrder.AUTHENTICATION) .addFilterAt(tokenWebFilter, SecurityWebFiltersOrder.AUTHENTICATION); return http.build(); }</code> </pre> <br><p style=";text-align:right;direction:rtl">  وكما كتبت أعلاه ، تعمل هذه الخدمة على تعطيل التحقق من الرمز المميز JWT الشائع للخدمات الأخرى عن طريق تحديد قيمة <code>micoservice=false</code> المتغير <code>micoservice=false</code> في ملف <code>application.properites</code> . </p><br><h1 id="kontroller-vydachi-tokenov-registracii-i-avtorizacii-authcontrollerjava" style=";text-align:right;direction:rtl">  إصدار الرمز ، وحدة تحكم التسجيل والتخويل AuthController.java </h1><br><p style=";text-align:right;direction:rtl">  لن أصف وحدة التحكم هذه ، لأنها محددة تمامًا. </p><br><h1 id="servis-webapiservicejava" style=";text-align:right;direction:rtl">  خدمة WebApiService.java </h1><br><p style=";text-align:right;direction:rtl">  تسمى هذه الخدمة في <code>WebApiMethodProtectedController.jav</code> تحكم ولها تعليق توضيحي مثير للاهتمام: </p><br><pre style=";text-align:right;direction:rtl"> <code class="plaintext hljs">@PreAuthorize("hasRole('GUEST')") public Flux&lt;User&gt; getAllUsers() { }</code> </pre> <br><p style=";text-align:right;direction:rtl">  يسمح هذا التعليق التوضيحي بالوصول إلى الأساليب فقط للمستخدمين المصرح لهم الذين لديهم دور الضيف. </p><br><h1 id="kak-testirovat" style=";text-align:right;direction:rtl">  كيفية الاختبار </h1><br><p style=";text-align:right;direction:rtl">  خلق بيئة: </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/c5e/88b/2c9/c5e88b2c9aa336ef901f6bef678b94e5.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl">  الحصول على رمزية </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/02f/19f/a7a/02f19fa7a858e41b9db8ca658f3e66d4.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl">  تحديث المتغير TOKEN في البيئة باستخدام الرمز المميز المستلم. </p><br><p style=";text-align:right;direction:rtl">  تسجيل مستخدم جديد </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/d78/f70/77b/d78f7077b7e224ff394def349446a322.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl">  بعد التسجيل ، سوف تتلقى رمز المستخدم.  تنتهي في 10 ساعات.  عندما تنتهي صلاحيتها تحتاج إلى الحصول على واحدة جديدة.  للقيام بذلك ، اطلب الرمز المميز للضيف مرة أخرى ، وقم بتحديث البيئة وتنفيذ الطلب </p><br><p style=";text-align:right;direction:rtl"><img src="https://habrastorage.org/getpro/habr/post_images/e68/b1f/e2d/e68b1fe2da20635e8cdd7eabfcd1a420.png" alt="نص بديل"></p><br><p style=";text-align:right;direction:rtl">  بعد ذلك ، يمكنك الحصول على قائمة المستخدمين أو الألعاب أو إنشاء لعبة جديدة.  وأيضاً اختبار Hystrix ، راجع تكوينات الخدمة وتشفير المتغيرات لمستودع git. </p><br><h1 id="ssylki" style=";text-align:right;direction:rtl">  المراجع </h1><br><ul style=";text-align:right;direction:rtl"><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">مستودع جيثب</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">مستودع التكوين</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">الربيع microservices في العمل</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">التدريب العملي على ربيع 5 الأمن للتطبيقات التفاعلية</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">رمز كتاب Spring Microservices in Action</a> </li><li style=";text-align:right;direction:rtl">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=ar&amp;u=">رمز للكتاب العملي Spring Spring Security للتطبيقات التفاعلية</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/ar434810/">https://habr.com/ru/post/ar434810/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../ar434798/index.html">Swagger - وثائق ذكية لواجهة برمجة تطبيقات RESTful الخاصة بك - مراجعة مطور للناشئين الجدد للمبتدئين</a></li>
<li><a href="../ar434800/index.html">(5-2) طرق لترحيل جدول SQL كبير</a></li>
<li><a href="../ar434802/index.html">"لن أعطي حجرًا" أو كيف يتم ترتيب موارد لعبة "الأراضي الملعونة"</a></li>
<li><a href="../ar434804/index.html">Fintech-startup تعذر على Robinhood إطلاق نظير للحسابات المصرفية</a></li>
<li><a href="../ar434806/index.html">العام الجديد تفكيك مع الزورق</a></li>
<li><a href="../ar434812/index.html">إدارة وقت المشروع</a></li>
<li><a href="../ar434816/index.html">التخلص من السموم و Appium: اختبار واجهة الآلي في رد الفعل الأصلي</a></li>
<li><a href="../ar434818/index.html">تسبب الحادث في مركز بيانات CenturyLink في انقطاع خدمة 911</a></li>
<li><a href="../ar434822/index.html">برنامج لجان المقاومة الشعبية "سيارات بمصادر طاقة جديدة". ما يمكن توقعه في 2019</a></li>
<li><a href="../ar434824/index.html">بوليت الهندسة الكهربائية. نمذجة العمليات الاجتماعية السياسية بواسطة الدوائر الكهربائية</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>