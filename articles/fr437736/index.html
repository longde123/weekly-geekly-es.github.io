<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👷🏼 ⭐️ 🖐🏼 Comment nous avons automatisé le lancement des tests Selenium via Moon et OpenShift 🍵 🌸 👩🏿‍🤝‍👨🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le 14 décembre, lors d'un rassemblement à Saint-Pétersbourg, moi (Artem Sokovets), avec mon collègue Dmitry Markelov, avons parlé de l'infrastructure ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons automatisé le lancement des tests Selenium via Moon et OpenShift</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/sberbank/blog/437736/">  Le 14 décembre, lors d'un rassemblement à Saint-Pétersbourg, moi (Artem Sokovets), avec mon collègue Dmitry Markelov, avons parlé de l'infrastructure actuelle pour les autotests dans SberTech.  Un récit de notre discours est dans ce post. <br><br><img src="https://habrastorage.org/webt/iu/ip/yi/iuipyifyxjogygipvmf7czx5w-a.png"><br><a name="habracut"></a><br><h2>  Qu'est-ce que le sélénium </h2><br>  Selenium est un outil d'automatisation de navigateur Web.  Aujourd'hui, cet outil est la norme pour l'automatisation WEB. <br><img src="https://habrastorage.org/webt/zc/h0/hs/zch0hsfpfzmu24_fqa-azm7biuu.png"><br><br>  Il existe de nombreux clients pour différents langages de programmation qui prennent en charge l'API Selenium Webdriver.  Grâce à l'API WebDriver, via le protocole JSON Wire, une interaction se produit avec le pilote du navigateur sélectionné, qui, à son tour, fonctionne avec un navigateur déjà réel, effectuant les actions dont nous avons besoin. <br>  Aujourd'hui, la version stable du client est Selenium 3.X. <br><br><img src="https://habrastorage.org/webt/lr/vi/cm/lrvicmxpizxyijy0fn_3mfvmi0w.png"><br>  Soit dit en passant, Simon Stewart a promis de présenter Selenium 4.0 lors de la conférence <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">SeleniumConf Japan</a> . <br><br><h2>  Sélénium GRID </h2><br>  En 2008, Philippe Hanrigou a annoncé le Selenium GRID pour construire une infrastructure d'autotests avec prise en charge de différents navigateurs. <br><br><img src="https://habrastorage.org/webt/ik/cb/gn/ikcbgnbwepodl4nagjkf_j2yknw.png"><br><br>  Selenium GRID se compose d'un concentrateur et de nœuds (nœuds).  Le nœud est juste un processus java.  Il peut être sur la même machine avec le Hub, il peut être sur une autre machine, il peut être dans le conteneur Docker.  Un concentrateur est essentiellement un équilibreur pour les autotests, qui détermine le nœud auquel l'exécution d'un test particulier doit être envoyée.  Vous pouvez y connecter des émulateurs mobiles. <br><br>  Selenium GRID vous permet d'exécuter des tests sur différents systèmes d'exploitation et différentes versions de navigateurs.  Cela permet également de gagner beaucoup de temps lors de l'exécution d'un grand nombre d'autotests, si, bien sûr, les autotests sont exécutés en parallèle à l'aide du plug-in maven-surfire ou d'un autre mécanisme de parallélisation. <br><br>  Bien sûr, Selenium GRID a ses inconvénients.  Lors de l'utilisation de l'implémentation standard, il faut faire face aux problèmes suivants: <br><br><ul><li>  redémarrage constant du concentrateur et du nœud.  Si le concentrateur et le nœud ne sont pas utilisés pendant une longue période, alors avec une connexion ultérieure, des situations sont possibles lorsque, lors de la création d'une session sur un nœud, cette même session tombe en timeout.  Pour restaurer le travail, un redémarrage est nécessaire; </li><li>  limite sur le nombre de nœuds.  Dépend fortement des tests et des paramètres de la grille.  Sans danser avec un tambourin, il commence à ralentir avec plusieurs dizaines de nœuds connectés; </li><li>  maigre fonctionnalité; </li><li>  l'impossibilité de mise à jour sans arrêt complet du service. </li></ul><br><h2>  Infrastructure initiale d'AutoTest chez SberTech </h2><br>  Plus tôt dans SberTech, il y avait l'infrastructure suivante pour les tests UI-auto.  L'utilisateur a démarré l'assemblage sur Jenkins, qui, à l'aide du plugin, s'est tourné vers OpenStack pour allouer la machine virtuelle.  Les VM ont été sélectionnées avec une «image» spéciale et le navigateur souhaité, et ce n'est qu'alors que des autotests ont été effectués sur cette VM. <br><br>  Si vous vouliez exécuter des tests dans les navigateurs Chrome ou FireFox, les conteneurs Docker se démarquaient.  Mais lorsque vous travaillez avec IE, vous avez dû générer une machine virtuelle «propre», ce qui a pris jusqu'à 5 minutes.  Malheureusement, Internet Explorer est un navigateur prioritaire dans notre entreprise. <br><br><img src="https://habrastorage.org/webt/hd/au/xe/hdauxedvhrlfxri3fmboujhmfwq.png"><br><br>  Le principal problème était que cette approche prenait beaucoup de temps lors de l'exécution d'autotests dans IE.  J'ai dû séparer les tests sur les suites et démarrer les assemblages en parallèle pour obtenir au moins une certaine réduction de temps.  Nous avons commencé à penser à la modernisation. <br><br><h2>  Nouvelles exigences d'infrastructure </h2><br>  En visitant diverses conférences sur l'automatisation, le développement et DevOps (Heisenbug, SQA Days, CodeOne, SeleniumConf et autres), nous avons progressivement constitué une liste d'exigences pour la nouvelle infrastructure: <br><br><ul><li>  Réduisez le temps d'exécution des tests de régression; </li><li>  Fournir un point d'entrée unique pour les autotests, ce qui facilitera leur débogage pour un spécialiste de l'automatisation.  Il n'y a pas de rares cas où tout fonctionne localement, et dès que les tests entrent dans le pipeline - chutes continues. </li><li>  Fournir une compatibilité entre navigateurs et une automatisation mobile (tests Appium). </li><li>  Restez fidèle à l'architecture cloud de la banque: les conteneurs Docker doivent être gérés dans OpenShift. </li><li>  Réduisez la mémoire et la consommation du processeur. </li></ul><br><h2>  Un bref aperçu des solutions existantes </h2><br>  Après avoir défini les tâches, nous avons analysé les solutions existantes sur le marché.  Les principales choses que nous avons examinées étaient les produits de l'équipe <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Aerokube</a> (Selenoid et Moon), les solutions Alfalab (Alpha Laboratory), <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JW-Grid</a> (Avito) et <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Zalenium</a> . <br><br>  Le principal inconvénient de Selenoid était le manque de support pour OpenShift (un wrapper sur Kubernetes).  À propos de la décision Alfalab, il y a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">un article sur Habré</a> .  Il s'est avéré qu'il s'agissait de la même grille de sélénium.  La solution d'Avito est décrite dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article</a> .  Nous avons vu le rapport à ce sujet lors de la conférence de Heisenbug.  Il y avait aussi des inconvénients que nous n'aimions pas.  Zalenium est un projet open source, non seulement sans problème. <br><br>  Les avantages et les inconvénients des solutions que nous considérons sont résumés dans le tableau: <br><br><img src="https://habrastorage.org/webt/cq/go/5h/cqgo5hznnv7540kfutmf_nuyk9i.png"><br><br>  En conséquence, nous avons opté pour un produit d'Aerokube - Selenoid. <br><br><h2>  Selenoid vs Moon </h2><br>  Pendant quatre mois, nous avons utilisé Selenoid pour automatiser l'écosystème Sberbank.  C'est une bonne solution, mais la Banque s'oriente vers OpenShift, et le déploiement de Selenoid dans OpenShift n'est pas une tâche triviale.  La subtilité est que Selenoid dans Kubernetes gère le docker de ce dernier, et Kubernetes n'en sait rien et ne peut pas plaisanter correctement les autres nœuds.  De plus, Selenoid dans Kubernetes nécessite un GGR (Go Grid Router) dans lequel l'équilibrage de charge est boiteux. <br><br>  Après avoir expérimenté avec Selenoid, nous nous sommes intéressés à l'outil Moon payant, qui se concentre spécifiquement sur le travail avec Kubernetes et présente plusieurs avantages par rapport au Selenoid gratuit.  Il se développe depuis deux ans maintenant et vous permet de déployer l'infrastructure pour l'interface utilisateur de test Selenium sans dépenser d'argent pour les ingénieurs DevOps qui ont des connaissances secrètes sur la façon de déployer Selenoid dans Kubernetes.  Il s'agit d'un avantage important - essayez de mettre à niveau le cluster Selenoid sans temps d'arrêt et de réduire la capacité lors de l'exécution des tests? <br><br><img src="https://habrastorage.org/webt/ii/md/l_/iimdl_ci4dv-wh88mzansqxdmm8.png"><br><br>  La lune n'était pas la seule option.  Par exemple, vous pouvez prendre le Zalenium mentionné ci-dessus, mais en fait c'est la même grille de sélénium.  Il a une liste complète des sessions à l'intérieur du concentrateur stockées à l'intérieur, et si le concentrateur se bloque, les tests se terminent.  Dans ce contexte, la Lune gagne du fait qu'elle n'a pas d'état interne, donc la chute d'une de ses répliques est généralement imperceptible.  La Lune a tout "gracieusement" - elle peut être redémarrée sans crainte, sans attendre la fin de la session. <br><br>  Le zalénium a d'autres limites.  Par exemple, il ne prend pas en charge Quota.  Vous ne pouvez pas en mettre deux copies pour un équilibreur de charge, car il ne sait pas comment répartir son état entre deux ou plusieurs «têtes».  Et en général, il est difficile de démarrer sur son cluster.  Zalenium utilise PersistentVolume pour stocker des données: journaux et tests vidéo enregistrés, mais cela concerne principalement les disques dans les nuages, et non le S3 plus tolérant aux pannes. <br><br><h2>  Infrastructure de test automatique </h2><br>  L'infrastructure actuelle utilisant Moon et OpenShift est la suivante: <br><br><img src="https://habrastorage.org/webt/yk/2y/1p/yk2y1pr_bt-tcndrgra-y4yjmpq.png"><br><br>  L'utilisateur peut exécuter des tests à la fois localement et en utilisant un serveur CI (dans notre cas, Jenkins, mais il peut y en avoir d'autres).  Dans les deux cas, nous utilisons RemoteWebDriver pour accéder à OpenShift, dans lequel le service avec plusieurs répliques Moon est déployé.  De plus, la demande dans laquelle le navigateur dont nous avons besoin est indiqué est traitée dans Moon, à la suite de quoi l'API Kubernetes lance la création d'un foyer avec ce navigateur.  Ensuite, Moon envoie directement les requêtes au conteneur, où les tests réussissent. <br><br>  À la fin de l'exécution, la session se termine, sous sont supprimés, les ressources sont libérées. <br><br><h2>  Lancer Internet Explorer </h2><br>  Bien sûr, il y a eu quelques difficultés.  Comme mentionné précédemment, le navigateur cible pour nous est Internet Explorer - la plupart de nos applications utilisent des composants ActiveX.  Depuis que nous utilisons OpenShift, nos conteneurs Docker fonctionnent sur RedHat Enterprise Linux.  Ainsi, la question se pose: comment démarrer Internet Explorer dans le conteneur Docker lorsque la machine hôte est sous Linux? <br><br>  Les gars de l'équipe de développement Moon ont partagé leur décision de lancer Internet Explorer et Microsoft Edge. <br><br>  L'inconvénient de cette solution est que le conteneur Docker doit s'exécuter en mode privilégié.  Ainsi, il faut 10 secondes pour initialiser le conteneur avec Internet Explorer après le démarrage du test, ce qui est 30 fois plus rapide que l'utilisation de l'infrastructure précédente. <br><br><h2>  Dépannage </h2><br>  En conclusion, nous aimerions partager avec vous des solutions à certains des problèmes que nous avons rencontrés lors du déploiement et de la configuration du cluster. <br><br>  Le premier problème est la distribution des images de service.  Lorsque la lune lance la création du navigateur, en plus du conteneur avec le navigateur, des conteneurs de services supplémentaires sont lancés - un enregistreur, un défenseur, un enregistreur vidéo. <br><br><img src="https://habrastorage.org/webt/vg/c0/yw/vgc0yw47ez0wxtd70dvbrg6znrc.png"><br><br>  Tout cela est lancé dans un seul pod.  Et si les images de ces conteneurs ne sont pas mises en cache sur les nœuds, elles seront fournies à partir du hub Docker.  A ce stade, tout est tombé pour nous, car le réseau interne a été utilisé.  Par conséquent, les gars d'Aerokube ont rapidement mis ce paramètre dans la configuration de la carte.  Si vous utilisez également un réseau interne, nous vous conseillons de vider ces images dans votre registre et de spécifier le chemin d'accès à celles-ci dans la carte de configuration moon-config.  Dans le fichier service.json, vous devez ajouter la section images: <br><br><pre><code class="plaintext hljs">"images": { "videoRecorder": "ufs-selenoid-cluster/moon-video-recorder:latest", "defender": "ufs-selenoid-cluster/defender:latest", "logger": "ufs-selenoid-cluster/logger:latest" }</code> </pre> <br>  Le problème suivant a déjà été identifié au début des tests.  L'infrastructure entière a été créée dynamiquement, mais le test s'est écrasé après 30 secondes avec l'erreur suivante: <br><br><pre> <code class="plaintext hljs">Driver info: org.openqa.selenium.remote.RemoteWebDriver Org.openqa.selenium.WebDriverException: &lt;html&gt;&lt;body&gt;&lt;h1&gt;504 Gateway Time-out&lt;/h1&gt; The server didn't respond in time.</code> </pre><br>  Pourquoi est-ce arrivé?  Le fait est que le test via RemoteWebDriver se réfère initialement à la couche de routage OpenShift, qui est chargée d'interagir avec l'environnement externe.  Le rôle de cette couche est Haproxy, qui redirige les demandes vers les conteneurs dont nous avons besoin.  En pratique, le test s'est tourné vers cette couche, elle a été redirigée vers notre container, qui devait créer un navigateur.  Mais il n'a pas pu le créer, car les ressources étaient épuisées.  Par conséquent, le test est entré dans la file d'attente, et après 30 secondes, le serveur proxy l'a supprimé par timeout, car par défaut, c'était cet intervalle de temps. <br><br><img src="https://habrastorage.org/webt/uw/q5/ig/uwq5ig93jvcqkxvpwbdwex4lqdk.png"><br><br>  Comment résoudre ça?  Tout s'est avéré assez simple - il vous suffit de redéfinir l'annotation haproxy.router.openshift.io/timeout pour le routeur de notre conteneur. <br><br><pre> <code class="plaintext hljs">$oc annotate route moon --overwrite haproxy.router.openshift.io/timeout=10m</code> </pre><br>  Le cas suivant est un travail avec un stockage compatible S3.  Moon est capable d'enregistrer ce qui se passe dans le conteneur avec le navigateur.  Sur un nœud, les conteneurs de services montent avec le navigateur, dont l'un est un enregistreur vidéo.  Il enregistre tout ce qui se passe dans le conteneur et après la fin de la session envoie des données au stockage compatible S3.  Pour envoyer des données vers un tel stockage, vous devez spécifier l'URL, les mots de passe de participation et le nom du panier dans les paramètres. <br><br>  Il semble que tout soit simple.  Nous avons entré les données et commencé à exécuter les tests, mais il n'y avait aucun fichier dans le référentiel.  Après avoir analysé les journaux, nous avons réalisé que le client avait l'habitude d'interagir avec S3 juré par le manque de certificats, car dans le champ url, nous avions spécifié l'adresse de S3 avec https.  La solution consiste à spécifier un mode http non protégé ou à ajouter vos certificats au conteneur.  Cette dernière option est plus difficile si vous ne savez pas ce qui se trouve dans le conteneur et comment tout cela fonctionne. <br><br><h3>  Et enfin ... </h3><br>  Chaque conteneur de navigateur peut être configuré indépendamment - tous les paramètres disponibles sont dans la documentation de Moon.  Prenons attention aux paramètres personnalisés tels que privileged et nodeSelector. <br><br>  Ils sont nécessaires pour cela.  Un conteneur avec Internet Explorer, comme mentionné ci-dessus, ne doit s'exécuter qu'en mode privilégié.  Le fonctionnement dans le mode requis est fourni par l'indicateur privilégié avec la délivrance de droits pour lancer de tels conteneurs sur le compte de service. <br><br>  Pour exécuter sur des nœuds distincts, vous devez enregistrer nodeSelector: <br><br><pre> <code class="plaintext hljs">"internet explorer": { "default": "latest", "versions": { "latest": { "image": "docker-registry.default.svc:5000/ufs-selenoid-cluster/windows:7", "port": "4444", "path": "/wd/hub", "nodeSelector": { "kubernetes.io/hostname": "nirvana5.ca.sbrf.ru" }, "volumes": ["/var/lib/docker/selenoid:/image"], "privileged": true } } }</code> </pre><br>  Dernier conseil.  Gardez une trace du nombre de sessions en cours.  Nous affichons tous les lancements à Grafana: <br><br><img src="https://habrastorage.org/webt/5t/_b/5x/5t_b5xujirnywt2prkzhngarlfk.png"><br><br><h2>  Où allons nous </h2><br>  Nous ne sommes pas satisfaits de tout dans l'infrastructure actuelle et la solution ne peut pas encore être qualifiée de complète.  Dans un avenir proche, nous prévoyons de stabiliser IE dans Docker, d'obtenir une interface utilisateur «riche» dans Moon et de tester également Appium pour les autotests mobiles. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr437736/">https://habr.com/ru/post/fr437736/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr437724/index.html">OpenSceneGraph: Animation procédurale des attributs de géométrie et d'état</a></li>
<li><a href="../fr437726/index.html">Sérialisation de Kotlin avec Kotlinx.</a></li>
<li><a href="../fr437730/index.html">Comment nous avons résolu le problème de mémoire dans PostgreSQL sans ajouter d'octet</a></li>
<li><a href="../fr437732/index.html">Présentation de l'imprimante MakeX M-One Pro 70 DLP</a></li>
<li><a href="../fr437734/index.html">Configuration de l'IPTV depuis Rostelecom sur les routeurs MikroTik</a></li>
<li><a href="../fr437738/index.html">Notes d'un phytochimiste. La pomme de terre. Deuxième partie Une histoire sur la graisse de pomme de terre ou «Raw Food Eater Day»</a></li>
<li><a href="../fr437740/index.html">Haxe: le grand secret du développement multiplateforme</a></li>
<li><a href="../fr437742/index.html">Événements numériques à Moscou du 28 janvier au 3 février</a></li>
<li><a href="../fr437744/index.html">Nouvelles applications vocales en C # dans 3CX v16</a></li>
<li><a href="../fr437746/index.html">SpaceX et la NASA se rapprochent de l'envoi d'un vaisseau spatial habité</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>