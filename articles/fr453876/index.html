<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüè≠ ü§öüèΩ ‚ôëÔ∏è Comme dans Yandex.Practicum, le front desync a gagn√©: un num√©ro acrobatique avec Redux-Saga, postMessage et Jupyter ü§ôüèº üçº üë®üèø‚Äçü§ù‚Äçüë®üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Je m'appelle Artyom Nesmiyanov, je suis d√©veloppeur full-stack chez Yandex. Pratique, je m'occupe principalement du frontend. Nous pensons qu'il est p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comme dans Yandex.Practicum, le front desync a gagn√©: un num√©ro acrobatique avec Redux-Saga, postMessage et Jupyter</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/yandex/blog/453876/">  Je m'appelle Artyom Nesmiyanov, je suis d√©veloppeur full-stack chez Yandex. Pratique, je m'occupe principalement du frontend.  Nous pensons qu'il est possible et n√©cessaire d'√©tudier avec plaisir la programmation, l'analyse de donn√©es et d'autres m√©tiers num√©riques.  Et commencez √† apprendre et continuez.  Tout d√©veloppeur qui n'a pas renonc√© √† lui-m√™me ¬´continue¬ª toujours.  Nous aussi.  Par cons√©quent, nous percevons les t√¢ches professionnelles comme un format d'apprentissage.  Et l'un des r√©cents m'a aid√©, moi et les gars, √† mieux comprendre dans quelle direction d√©velopper notre pile frontale. <br><br><img src="https://habrastorage.org/webt/u2/uh/nx/u2uhnxzsc0hv3v7clkqskbzwnc0.png"><br><br><h3>  De qui et de quoi l'atelier est fait </h3><br>  Notre √©quipe de d√©veloppement est extr√™mement compacte.  Il n'y a que deux personnes sur le backend, sur le front-end - quatre, compte tenu de moi, une pile compl√®te.  De temps en temps, des gars de Yandex.Tutorial nous rejoignent en renfort.  Nous travaillons sur Scrum avec des sprints de deux semaines. <br><a name="habracut"></a><br>  Notre frontend est bas√© sur React.js en collaboration avec Redux / Redux-Saga, nous utilisons Express pour communiquer avec le backend.  La partie backend de la pile est en Python (plus pr√©cis√©ment, Django), la base de donn√©es est PostgreSQL, et pour certaines t√¢ches, Redis.  En utilisant Redux, nous stockons des stockages d'informations, envoyons des actions qui sont trait√©es par Redux et Redux-Saga.  Tous les effets secondaires, tels que les demandes de serveur, les appels √† Yandex.Metrica et les redirections, sont trait√©s uniquement dans Redux-Saga.  Et toutes les modifications de donn√©es se produisent dans les r√©ducteurs Redux. <br><br><h3>  Comment ne pas oublier un journal dans votre iframe </h3><br>  D√©sormais sur notre plateforme, la formation est ouverte dans trois m√©tiers: d√©veloppeur front-end, d√©veloppeur web, analyste de donn√©es.  Et nous scions activement des outils pour chaque cours. <br><br>  Pour le cours de six mois ¬´ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Data Analyst</a> ¬ª, nous avons cr√©√© un simulateur interactif, o√π nous enseignons aux utilisateurs <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">comment utiliser le bloc-notes Jupyter</a> .  Il s'agit d'une coquille cool pour l'informatique interactive, qui est appr√©ci√©e √† juste titre par les scientifiques des donn√©es.  Toutes les op√©rations dans l'environnement sont effectu√©es √† l'int√©rieur du bloc-notes, mais d'une mani√®re simple - un bloc-notes (comme je l'appellerai plus tard). <br><br>  L'exp√©rience vous invite, et nous en sommes s√ªrs: il est important que les t√¢ches de formation soient proches de la r√©alit√©.  Y compris en termes d'environnement de travail.  Par cons√©quent, il √©tait n√©cessaire de s'assurer qu'√† l'int√©rieur de la le√ßon, tout le code pouvait √™tre √©crit, ex√©cut√© et v√©rifi√© directement dans le cahier. <br><br>  Avec la mise en ≈ìuvre de base des difficult√©s ne se posent pas.  Le bloc-notes lui-m√™me a √©t√© install√© dans un iframe s√©par√©, la logique de v√©rification a √©t√© prescrite sur le backend. <br><br><img src="https://habrastorage.org/webt/2z/_9/iy/2z_9iyuj7pmha0ielvj4evuyhic.png"><br>  <i>Le cahier de l'√©l√®ve lui-m√™me (√† droite) n'est qu'un iframe dont l'URL m√®ne √† un cahier sp√©cifique dans JupyterHub.</i> <br><br>  En premi√®re approximation, tout fonctionnait sans accroc, sans accroc.  Cependant, lors des tests, des absurdit√©s sont apparues.  Par exemple, vous √™tes assur√© de conduire la bonne version du code dans un ordinateur portable, cependant, apr√®s avoir cliqu√© sur le bouton "T√¢che de test", le serveur r√©pond que la r√©ponse est suppos√©e incorrecte.  Et pourquoi - un myst√®re. <br><br>  Eh bien, ce qui se passe, nous nous sommes rendu compte le m√™me jour quand nous avons trouv√© un bug: il s'est av√©r√© que la solution qui ne volait pas √©tait la solution actuelle, la solution vient d'√™tre introduite dans le formulaire Jupyter Notebook, mais la pr√©c√©dente avait d√©j√† √©t√© effac√©e.  L'ordinateur portable lui-m√™me n'a pas eu le temps de survivre, et nous avons ralenti le backend pour qu'il v√©rifie la t√¢che qu'il contient.  Ce qu'il ne pouvait bien s√ªr pas faire. <br><br>  Nous avons d√ª nous d√©barrasser du rassinhron entre l'enregistrement du portable et l'envoi d'une demande au serveur pour le v√©rifier.  Le hic, c'√©tait qu'il fallait faire communiquer l'iframe du cahier avec la fen√™tre parent, c'est-√†-dire avec le frontend sur lequel la le√ßon dans son ensemble tournait.  Bien s√ªr, il √©tait impossible de transmettre directement un √©v√©nement entre eux: ils vivent sur des domaines diff√©rents. <br><br>  √Ä la recherche d'une solution, j'ai d√©couvert que Jupyter Notebook permet de connecter ses plugins.  Il existe un objet Jupiter - un cahier - avec lequel vous pouvez op√©rer.  Travailler avec elle implique des √©v√©nements, y compris la pr√©servation du cahier, ainsi que l'appel √† l'action appropri√©e.  Apr√®s avoir compris l'int√©rieur de Jupyter (je devais: il n'y a pas de documentation normale), les gars et moi l'avons fait - nous avons construit notre propre plug-in pour cela et, en utilisant le m√©canisme postMessage, nous avons r√©alis√© le travail coordonn√© des √©l√©ments √† partir desquels la le√ßon de l'atelier a √©t√© assembl√©e. <br><br>  Nous avons √©labor√© une solution de contournement en tenant compte du fait que notre pile inclut initialement le Redux-Saga d√©j√† mentionn√© - pour le dire simplement, un middleware sur Redux, ce qui permet de travailler de mani√®re plus flexible avec des effets secondaires.  Par exemple, l'enregistrement d'un ordinateur portable est quelque chose comme cet effet secondaire.  Nous envoyons quelque chose au backend, attendons quelque chose, obtenons quelque chose.  Tout ce mouvement est trait√© dans Redux-Saga: il envoie les √©v√©nements au frontend, lui dictant comment afficher quoi dans l'interface utilisateur. <br><br>  Quel est le r√©sultat?  PostMessage est cr√©√© et envoy√© √† l'iframe avec un bloc-notes.  Lorsqu'un iframe voit que quelque chose est venu de l'ext√©rieur, il analyse la cha√Æne re√ßue.  Conscient qu'il doit garder le cahier, il effectue cette action et, √† son tour, envoie une r√©ponse postMessage sur l'ex√©cution de la demande. <br><br>  Lorsque nous cliquons sur le bouton "V√©rifier la t√¢che", l'√©v√©nement correspondant est envoy√© au magasin Redux: "Telle et telle, nous sommes all√©s √™tre v√©rifi√©s."  Redux-Saga voit l'action arriver et faire un postMessage dans un iframe.  Maintenant, elle attend la r√©ponse de l'iframe.  En attendant, notre √©l√®ve voit l'indicateur de t√©l√©chargement sur le bouton "V√©rifier la t√¢che" et comprend que le simulateur ne se bloque pas, mais "r√©fl√©chit".  Et seulement lorsque postMessage revient en disant que la sauvegarde est termin√©e, Redux-Saga continue de fonctionner et envoie une demande au backend.  Sur le serveur, la t√¢che est v√©rifi√©e - la bonne solution ou non, si des erreurs sont commises, lesquelles, etc., et ces informations sont soigneusement stock√©es dans le magasin Redux.  Et √† partir de l√†, le script frontal le tire dans l'interface de la le√ßon. <br><br>  Voici le sch√©ma qui est finalement sorti: <br><br><img src="https://habrastorage.org/webt/ks/gc/eu/ksgceup6hokoh9jtvqoajegbjfc.png"><br><br>  <i>(1) Nous appuyons sur le bouton "V√©rifier la t√¢che" (V√©rifier) ‚Äã‚Äã‚Üí (2) Nous envoyons l'action CHECK_NOTEBOOK_REQUEST ‚Üí (3) Nous envoyons l'action du contr√¥le ‚Üí (2) Nous envoyons l'action SAVE_NOTEBOOK_REQUEST ‚Üí (3) Nous capturons l'action et envoyons un message dans l'iframe ‚Üí enregistrer l'√©v√©nement (4) Recevoir le message ‚Üí (5) Le bloc-notes est enregistr√© ‚Üí (4) Recevoir l'√©v√©nement de l'API Jupyter que le bloc-notes a √©t√© enregistr√© et envoyer postMessage enregistr√© sur le bloc-notes ‚Üí (1) Recevoir l'√©v√©nement ‚Üí (2) Envoyer l'action SAVE_NOTEBOOK_SUCCESS ‚Üí (3) Nous interceptons l'action et envoyer une demande pour v√©rifier le cahier ‚Üí (6) ‚Üí (7) V√©rifier que ce cahier est dans la base de donn√©es ‚Üí (8) ‚Üí (7) Rechercher le code du cahier ‚Üí (5) Renvoyer le code ‚Üí (7) Lancer la v√©rification du code ‚Üí (9 ) ‚Üí (7) Nous obtenons une coupe</i>  <i>tat contr√¥le ‚Üí (6) ‚Üí (3) nous envoyons</i> une <i>action CHECK_NOTEBOOK_SUCCESS ‚Üí (2) vers</i> le <i>bas pour v√©rifier</i> la <i>r√©ponse face ‚Üí (1) tirage</i> au <i>r√©sultat</i> <br><br>  Voyons comment tout cela fonctionne dans le contexte du code. <br><br>  Nous avons √† l'avant trainer_type_jupyter.jsx - le script de la page o√π notre cahier est dessin√©. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"trainer__right-column"</span></span></span><span class="hljs-tag">&gt;</span></span> {notebookLinkIsLoading ? ( <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">className</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"trainer__jupiter-frame"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{this.onIframeRef}</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">{notebookLink}</span></span></span><span class="hljs-tag"> /&gt;</span></span> ) : ( <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Spin</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"l"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mix</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"trainer__jupiter-spin"</span></span></span><span class="hljs-tag"> /&gt;</span></span> )} <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Apr√®s avoir cliqu√© sur le bouton "V√©rifier le travail", la m√©thode handleCheckTasks est appel√©e. <br><br><pre> <code class="xml hljs">handleCheckTasks = () =&gt; { const {checkNotebook, lesson} = this.props; checkNotebook({id: lesson.id, iframe: this.iframeRef}); };</code> </pre> <br>  En fait, handleCheckTasks sert √† appeler l'action Redux avec les param√®tres pass√©s. <br><br><pre> <code class="xml hljs">export const checkNotebook = getAsyncActionsFactory(CHECK_NOTEBOOK).request;</code> </pre> <br>  Il s'agit d'une action courante con√ßue pour Redux-Saga et les m√©thodes asynchrones.  Ici, getAsyncActionsFactory g√©n√®re trois actions: <br><br>  // utils / store-helpers / async.js <br><br><pre> <code class="xml hljs">export function getAsyncActionsFactory(type) { const ASYNC_CONSTANTS = getAsyncConstants(type); return { request: payload =&gt; ({type: ASYNC_CONSTANTS.REQUEST, payload}), error: (response, request) =&gt; ({type: ASYNC_CONSTANTS.ERROR, response, request}), success: (response, request) =&gt; ({type: ASYNC_CONSTANTS.SUCCESS, response, request}), } }</code> </pre> <br>  En cons√©quence, getAsyncConstants g√©n√®re trois constantes de la forme * _REQUEST, * _SUCCESS et * _ERROR. <br><br>  Voyons maintenant comment notre Redux-Saga va g√©rer toute cette √©conomie: <br><br>  // trainer.saga.js <br><br><pre> <code class="xml hljs">function* watchCheckNotebook() { const watcher = createAsyncActionSagaWatcher({ type: CHECK_NOTEBOOK, apiMethod: Api.checkNotebook, preprocessRequestGenerator: function* ({id, iframe}) { yield put(trainerActions.saveNotebook({iframe})); yield take(getAsyncConstants(SAVE_NOTEBOOK).SUCCESS); return {id}; }, successHandlerGenerator: function* ({response}) { const {completed_tests: completedTests} = response; for (let id of completedTests) { yield put(trainerActions.setTaskSolved(id)); } }, errorHandlerGenerator: function* ({response: error}) { yield put(appActions.setNetworkError(error)); } }); yield watcher(); }</code> </pre> <br>  La magie?  Rien d'extraordinaire.  Comme vous pouvez le voir, createAsyncActionSagaWatcher cr√©e simplement un filigrane qui peut pr√©traiter les donn√©es entrant dans l'action, faire une demande √† une URL sp√©cifique, envoyer l'action * _REQUEST et envoyer * _SUCCESS et * _ERROR apr√®s une r√©ponse r√©ussie du serveur.  De plus, bien entendu, pour chaque option, des gestionnaires sont fournis √† l'int√©rieur de la montre. <br><br>  Vous avez probablement remarqu√© que dans le pr√©processeur de donn√©es, nous appelons un autre Redux-Saga, attendons qu'il se termine avec SUCCESS, puis continuez √† travailler.  Et bien s√ªr, les iframes n'ont pas besoin d'√™tre envoy√©s au serveur, nous ne donnons donc que l'identifiant. <br><br>  Examinez de plus pr√®s la fonction saveNotebook: <br><br><pre> <code class="xml hljs">function* saveNotebook({payload: {iframe}}) { iframe.contentWindow.postMessage(JSON.stringify({ type: 'save-notebook' }), '*'); yield; }</code> </pre> <br>  Nous avons atteint le m√©canisme le plus important dans l'interaction des iframes avec le frontend - postMessage.  Le fragment de code donn√© envoie une action avec le type save-notebook, qui est trait√©e √† l'int√©rieur de l'iframe. <br><br>  J'ai d√©j√† mentionn√© que nous devions √©crire un plug-in pour le bloc-notes Jupyter, qui serait charg√© √† l'int√©rieur du bloc-notes.  Ces plugins ressemblent √† ceci: <br><br><pre> <code class="xml hljs">define([ 'base/js/namespace', 'base/js/events' ], function( Jupyter, events ) {...});</code> </pre><br>  Pour cr√©er de telles extensions, vous devez traiter avec l'API Jupyter Notebook elle-m√™me.  Malheureusement, il n'y a pas de documentation claire √† ce sujet.  Mais les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">codes sources</a> sont disponibles et je les ai explor√©s.  C'est bien que le code soit lisible l√†-bas. <br><br>  Le plugin doit apprendre √† communiquer avec la fen√™tre parent dans le front de la le√ßon: apr√®s tout, la d√©synchronisation entre eux est la cause du bug avec la v√©rification des t√¢ches.  Tout d'abord, nous souscrivons √† tous les messages que nous recevons: <br><br><pre> <code class="xml hljs">window.addEventListener('message', actionListener);</code> </pre> <br>  Nous allons maintenant fournir leur traitement: <br><br><pre> <code class="xml hljs">function actionListener({data: eventString}) { let event = ''; try { event = JSON.parse(eventString); } catch(e) { return; } switch (event.type) { case 'save-notebook': Jupyter.actions.call('jupyter-notebook:save-notebook'); Break; ... default: break; } }</code> </pre> <br>  Tous les √©v√©nements qui ne correspondent pas √† notre format sont hardiment ignor√©s. <br><br>  Nous voyons que l'√©v√©nement save-notebook nous arrive, et nous appelons l'action pour enregistrer le notebook.  Il ne reste plus qu'√† renvoyer un message que le carnet a √©t√© conserv√©: <br><br><pre> <code class="xml hljs">events.on('notebook_saved.Notebook', actionDispatcher); function actionDispatcher(event) { switch (event.type) { case 'select': const selectedCell = Jupyter.notebook.get_selected_cell(); dispatchEvent({ type: event.type, data: {taskId: getCellTaskId(selectedCell)} }); return; case 'notebook_saved': default: dispatchEvent({type: event.type}); } } function dispatchEvent(event) { return window.parent.postMessage( typeof event === 'string' ? event : JSON.stringify(event), '*' ); }</code> </pre><br>  En d'autres termes, envoyez simplement {type: 'notebook_saved'}.  Cela signifie que le carnet a √©t√© conserv√©. <br><br>  Revenons √† notre composante: <br><br>  //trainer_type_jupyter.jsx <br><br><pre> <code class="xml hljs">componentDidMount() { const {getNotebookLink, lesson} = this.props; getNotebookLink({id: lesson.id}); window.addEventListener('message', this.handleWindowMessage); }</code> </pre> <br>  Lors du montage du composant, nous demandons au serveur un lien vers le notebook et souscrivons √† toutes les actions qui peuvent nous parvenir: <br><br><pre> <code class="xml hljs">handleWindowMessage = ({data: eventString}) =&gt; { const {activeTaskId, history, match: {params}, setNotebookSaved, tasks} = this.props; let event = null; try { event = JSON.parse(eventString); } catch(e) { return; } const {type, data} = event; switch (type) { case 'app_initialized': this.selectTaskCell({taskId: activeTaskId}) return; case 'notebook_saved': setNotebookSaved(); return; case 'select': { const taskId = data &amp;&amp; data.taskId; if (!taskId) { return } const task = tasks.find(({id}) =&gt; taskId === id); if (task &amp;&amp; task.status === TASK_STATUSES.DISABLED) { this.selectTaskCell({taskId: null}) return; } history.push(reversePath(urls.trainerTask, {...params, taskId})); return; } default: break; } };</code> </pre> <br>  C'est l√† que la r√©partition de l'action setNotebookSaved est appel√©e, ce qui permettra √† Redux-Saga de continuer √† travailler et √† sauvegarder le bloc-notes. <br><br><h3>  Glitches de choix </h3><br>  Nous avons r√©solu le bogue de conservation des cahiers.  Et imm√©diatement pass√© √† un nouveau probl√®me.  Il fallait apprendre √† bloquer des t√¢ches (t√¢ches), auxquelles l'√©l√®ve n'avait pas encore atteint.  En d'autres termes, il √©tait n√©cessaire de synchroniser la navigation entre notre simulateur interactif et le cahier Jupyter: dans une le√ßon, nous avions un cahier avec plusieurs t√¢ches assis dans l'iframe, dont les transitions devaient √™tre coordonn√©es avec les changements dans l'interface de la le√ßon dans son ensemble.  Par exemple, de sorte qu'en cliquant sur la deuxi√®me t√¢che dans l'interface de la le√ßon dans le bloc-notes, le passage √† la cellule correspondant √† la deuxi√®me t√¢che a lieu.  Et vice versa: si dans le cadre Jupyter Notebook vous s√©lectionnez une cellule li√©e √† la troisi√®me t√¢che, alors l'URL dans la barre d'adresse du navigateur doit imm√©diatement changer et, en cons√©quence, le texte d'accompagnement avec la th√©orie de la troisi√®me t√¢che doit √™tre affich√© dans l'interface de la le√ßon. <br><br>  Il y avait une t√¢che plus difficile.  Le fait est que notre programme de formation est con√ßu pour le passage coh√©rent des le√ßons et des travaux.  Pendant ce temps, par d√©faut, dans le bloc-notes Jupiter, rien n'emp√™che l'utilisateur d'ouvrir une cellule.  Et dans notre cas, chaque cellule est une t√¢che distincte.  Il s'est av√©r√© que vous pouvez r√©soudre les premi√®re et troisi√®me t√¢ches et ignorer la seconde.  Le risque de passage non lin√©aire de la le√ßon devait √™tre √©limin√©. <br><br>  La solution √©tait bas√©e sur le m√™me postMessage.  Seulement, nous avons d√ª approfondir l'API Jupyter Notebook, plus pr√©cis√©ment, ce que l'objet Jupiter lui-m√™me peut faire.  Et trouvez un m√©canisme pour v√©rifier √† quelle t√¢che la cellule est attach√©e.  Dans sa forme la plus g√©n√©rale, elle est la suivante.  Dans la structure du cahier, les cellules vont s√©quentiellement les unes apr√®s les autres.  Ils peuvent avoir des m√©tadonn√©es.  Le champ "Balises" est fourni dans les m√©tadonn√©es, et les balises ne sont que des identificateurs de t√¢ches √† l'int√©rieur de la le√ßon.  De plus, en utilisant des cellules de marquage, vous pouvez d√©terminer si elles doivent √™tre bloqu√©es par l'√©tudiant jusqu'√† pr√©sent.  En cons√©quence, conform√©ment au mod√®le actuel du simulateur, en cliquant sur la cellule, nous commen√ßons √† envoyer postMessage de l'iframe √† notre frontend, qui, √† son tour, va au magasin Redux et v√©rifie, en fonction des propri√©t√©s de la t√¢che, s'il est disponible pour nous maintenant.  S'il n'est pas disponible, nous basculons vers la cellule active pr√©c√©dente. <br><br>  Nous avons donc r√©alis√© qu'il √©tait impossible de s√©lectionner une cellule dans un cahier qui ne devrait pas √™tre accessible par la chronologie de la formation.  Certes, cela a donn√© lieu √† un bug non critique, mais: vous essayez de cliquer sur une cellule avec une t√¢che inaccessible, et elle "clignote" rapidement: il est clair qu'elle a √©t√© activ√©e pendant un moment, mais a √©t√© imm√©diatement bloqu√©e.  Bien que nous n'ayons pas √©limin√© cette rugosit√©, cela n'interf√®re pas avec la prise de le√ßons, mais en arri√®re-plan, nous continuons √† penser comment y faire face (en passant, y a-t-il des pens√©es?). <br><br>  Un peu sur la fa√ßon dont nous avons modifi√© notre interface pour r√©soudre le probl√®me.  Passons √† nouveau √† trainer_type_jupyter.jsx - nous allons nous concentrer sur app_initialized et s√©lectionner. <br><br>  Avec app_initialized, tout est √©l√©mentaire: le bloc-notes est charg√© et nous voulons faire quelque chose.  Par exemple, s√©lectionnez la cellule actuelle en fonction de la t√¢che s√©lectionn√©e.  Le plugin est d√©crit afin que vous puissiez passer taskId et basculer vers la premi√®re cellule correspondant √† ce taskId. <br><br>  √Ä savoir: <br><br>  // trainer_type_jupyter.jsx <br><br><pre> <code class="xml hljs">selectTaskCell = ({taskId}) =&gt; { const {selectCell} = this.props; if (!this.iframeRef) { return; } selectCell({iframe: this.iframeRef, taskId}); };</code> </pre> <br>  // trainer.actions.js <br><br><pre> <code class="xml hljs">export const selectCell = ({iframe, taskId}) =&gt; ({ type: SELECT_CELL, iframe, taskId });</code> </pre> <br>  // trainer.saga.js <br><br><pre> <code class="xml hljs">function* selectCell({iframe, taskId}) { iframe.contentWindow.postMessage(JSON.stringify({ type: 'select-cell', data: {taskId} }), '*'); yield; } function* watchSelectCell() { yield takeEvery(SELECT_CELL, selectCell); }</code> </pre> <br>  // custom.js (plugin Jupyter) <br><br><pre> <code class="xml hljs">function getCellTaskId(cell) { const notebook = Jupyter.notebook; while (cell) { const tags = cell.metadata.tags; const taskId = tags &amp;&amp; tags[0]; if (taskId) { return taskId; } cell = notebook.get_prev_cell(cell); } return null; } function selectCell({taskId}) { const notebook = Jupyter.notebook; const selectedCell = notebook.get_selected_cell(); if (!taskId) { selectedCell.unselect(); return; } if (selectedCell &amp;&amp; selectedCell.selected &amp;&amp; getCellTaskId(selectedCell) === taskId) { return; } const index = notebook.get_cells() .findIndex(cell =&gt; getCellTaskId(cell) === taskId); if (index <span class="hljs-tag"><span class="hljs-tag">&lt; </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag">) { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">return</span></span></span><span class="hljs-tag">; } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">notebook.select</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">const</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cell</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">notebook.get_cell(index);</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cell.element</span></span></span><span class="hljs-tag">[</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">0</span></span></span><span class="hljs-tag">]</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">.scrollIntoView</span></span></span><span class="hljs-tag">({ </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">behavior:</span></span></span><span class="hljs-tag"> '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">smooth</span></span></span><span class="hljs-tag">', </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">block:</span></span></span><span class="hljs-tag"> '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">start</span></span></span><span class="hljs-tag">' }); } </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">function</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">actionListener</span></span></span><span class="hljs-tag">({</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">eventString</span></span></span><span class="hljs-tag">}) { </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">case</span></span></span><span class="hljs-tag"> '</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">select-cell</span></span></span><span class="hljs-tag">'</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">selectCell</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">event.data</span></span></span><span class="hljs-tag">); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">break</span></span></span><span class="hljs-tag">;</span></span></code> </pre> <br>  Vous pouvez maintenant changer de cellule et apprendre de l'iframe que la cellule a √©t√© chang√©e. <br><br>  Lors du changement de cellule, nous changeons l'URL et tombons dans une autre t√¢che.  Il ne reste plus qu'√† faire le contraire - lors du choix d'une autre t√¢che dans l'interface, changez de cellule.  Facile: <br><br><pre> <code class="xml hljs">componentDidUpdate({match: {params: {prevTaskId}}) { const {match: {params: {taskId}}} = this.props; if (taskId !== prevTaskId) { this.selectTaskCell({taskId});</code> </pre> <br><h3>  Chaudi√®re s√©par√©e pour perfectionnistes </h3><br>  Ce serait cool de se vanter de notre bien-√™tre.  La solution en fin de compte est efficace, m√™me si elle semble un peu d√©sordonn√©e: pour r√©sumer, nous avons une m√©thode qui traite tout message provenant de l'ext√©rieur (dans notre cas, √† partir d'un iframe).  Mais dans le syst√®me que nous avons nous-m√™mes construit, il y a des choses que moi et mes coll√®gues n'aimons pas vraiment. <br><br>  ‚Ä¢ Il n'y a pas de flexibilit√© dans l'interaction des √©l√©ments: chaque fois que nous voulons ajouter de nouvelles fonctionnalit√©s, nous devrons changer le plugin afin qu'il supporte √† la fois l'ancien et le nouveau format de communication.  Il n'y a pas de m√©canisme isol√© unique pour travailler entre l'iframe et notre composant frontal, ce qui rend le bloc-notes Jupyter dans l'interface de la le√ßon et fonctionne avec nos t√¢ches.  Globalement - il existe un souhait de rendre un syst√®me plus flexible, de sorte qu'√† l'avenir, il soit facile d'ajouter de nouvelles actions, de nouveaux √©v√©nements et de les traiter.  Et dans le cas non seulement du portable Jupiter, mais aussi de tout iframe dans les simulateurs.  Nous cherchons donc √† passer le code du plugin via postMessage et √† le rendre (eval) √† l'int√©rieur du plugin. <br><br>  ‚Ä¢ Les fragments de code qui r√©solvent les probl√®mes sont dispers√©s tout au long du projet.  La communication avec les iframes s'effectue √† la fois depuis Redux-Saga et depuis le composant, ce qui n'est certainement pas optimal. <br><br>  ‚Ä¢ Iframe lui-m√™me avec le rendu Jupyter Notebook est assis sur un autre service.  Le modifier est l√©g√®rement probl√©matique, notamment dans le respect du principe de compatibilit√© descendante.  Par exemple, si nous voulons changer une logique sur le frontend et dans le notebook lui-m√™me, nous devons faire un double travail. <br><br>  ‚Ä¢ Beaucoup aimeraient mettre en ≈ìuvre plus facilement.  Prenez au moins React.  Il a une tonne de m√©thodes de cycle de vie, et chacune d'elles doit √™tre trait√©e.  De plus, je suis confus par la liaison √† React lui-m√™me.  Id√©alement, j'aimerais pouvoir travailler avec nos iframes, quel que soit votre framework frontal.  En g√©n√©ral, l'intersection des technologies que nous avons choisies impose des limites: la m√™me Redux-Saga attend de nous des actions Redux, pas postMessage. <br><br>  Nous ne nous arr√™terons donc certainement pas sur ce qui a √©t√© accompli.  Un dilemme des manuels: vous pouvez aller du c√¥t√© de la beaut√©, mais sacrifier l'optimalit√© de la performance, ou vice versa.  Nous n'avons pas encore trouv√© la meilleure solution. <br><br>  Peut-√™tre que des id√©es vous viennent? </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr453876/">https://habr.com/ru/post/fr453876/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr453866/index.html">Demande d'API avec React Hooks, HOC ou Render Prop</a></li>
<li><a href="../fr453868/index.html">Mini interrupteur tactile avec panneau en verre sur nRF52832</a></li>
<li><a href="../fr453870/index.html">Nous √©crivons le proxy Reverse socks5 sur PowerShell. Partie 1</a></li>
<li><a href="../fr453872/index.html">Restauration de photos √† l'aide de r√©seaux de neurones</a></li>
<li><a href="../fr453874/index.html">De la roulette russe au LOTO s√©curis√©: comment prot√©ger le personnel du centre de donn√©es</a></li>
<li><a href="../fr453882/index.html">Un excellent guide sur le m√©tier d'architecte de solutions (+ liste de liens utiles)</a></li>
<li><a href="../fr453884/index.html">Remplacement de la cam√©ra HYIP ou du reflex num√©rique?</a></li>
<li><a href="../fr453886/index.html">Le programme fonctionne</a></li>
<li><a href="../fr453890/index.html">R√™ves sovi√©tiques de l'avenir</a></li>
<li><a href="../fr453892/index.html">Certification ISTQB. Partie 2: Comment se pr√©parer √† la certification ISTQB? Histoires de pratique</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>