<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚴🏾 🎑 👨🏿‍⚖️ Realistische Schatten für Roguelike 🕯️ ☝🏾 🕷️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Gute Zeit, Habr Gemeinschaft. 

 Vor vielen Jahren bin ich auf einen Beitrag gestoßen (1) . Dann war ich verwirrt über die Möglichkeit, interessante E...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Realistische Schatten für Roguelike</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/430438/"><img src="https://habrastorage.org/webt/it/n0/_j/itn0_jvk5dkjqc4db9ipac5f5fs.png" alt="Bild"><br><br>  Gute Zeit, Habr Gemeinschaft. <br><br>  Vor vielen Jahren bin ich auf einen Beitrag gestoßen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(1)</a> .  Dann war ich verwirrt über die Möglichkeit, interessante Elemente für das Gameplay in Roguelike <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(2)</a> zu erstellen.  Angenommen, ein Gegner kann sich hinter einer Mauer befinden. Wir sehen ihn erst, wenn wir ihn in Sichtweite treffen.  Aber ich bevorzuge die Situation, in der wir, wenn wir durch die Korridore des Verlieses reisen, die Merkmale der Position von Objekten nach und nach anhand des Sichtbereichs aufdecken. <br><a name="habracut"></a><br>  Später in den Beiträgen: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(3)</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(4)</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(5)</a> wurden die Fragen des Schattenwerfens in 2D-Spielen behandelt.  Wie sowohl von den Autoren selbst als auch in den Kommentaren festgestellt, ist die Berechnung von Schatten ziemlich umfangreich und keine leichte Aufgabe, sowohl für den Taschenrechner als auch für das Design. <br><br>  Irgendwie hatte ich einige freie Tage und beschloss, auf die Frage nach vielversprechenderen Schatten zurückzukommen.  Es ist klar, dass die Grafikkarte erfolgreich und schnell mit Schatten umgeht, aber in diesem Fall wollte ich die Schatten für ein 2D-Spiel verarbeiten, und es schien überflüssig, Berechnungen auf die Grafikkarte zu übertragen.  Ja, und die Prozessorleistung ist in den letzten Jahren insgesamt gewachsen, eigentlich ein Beitrag darüber, was am Ende passiert ist. <br><br>  Das Programm wurde in Pascal geschrieben, einfach weil ich es gut kenne, und Lazarus ist eine offene IDE mit einer Vielzahl von Komponenten. <br><br>  Die ursprüngliche Idee war, vom Betrachter Linien durch jede der Ecken der Kachel zu ziehen und dann die resultierende Figur abzudunkeln. <br><br><img src="https://habrastorage.org/webt/1l/gv/wz/1lgvwzunexn88op34oew0fiwfgg.png" alt="Bild"><br><br>  Ein solcher Schatten sieht jedoch etwas unnatürlich aus, wenn sich der Blickwinkel ändert.  Die Schatten sind jetzt breiter, jetzt schmaler. <br><br><img src="https://habrastorage.org/webt/b8/h0/fo/b8h0fobism0heacye71gua3xv_0.png" alt="Bild"><br><br>  Der Schatten eines runden Objekts sieht viel besser aus.  Um einen solchen Schatten zu erzeugen, müssen Sie zwei Tangenten vom Beobachtungspunkt zum Kreis und zu den Rändern des Bildschirms zeichnen.  Der Durchmesser des Kreises entspricht der Größe der Fliese. <br><br>  In meinem Programm habe ich folgende Funktion verwendet: <br><br><pre><code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//       function tangent_to_circle(x1,y1,x2,y2,r:Single; var x3,y3,x4,y4:Single):Boolean; var l,dx,dy,i,ii,ij:Single; begin dx := x1 - x2; dy := y1 - y2; l := Sqrt(dx*dx + dy*dy); if l&lt;=r then begin tangent_to_circle:=false; exit; end; i := r/l; ii := i*i; ij := i * Sqrt(1 - ii); x3 := x2 + dx*ii - dy*ij; y3 := y2 + dx*ij + dy*ii; x4 := x2 + dx*ii + dy*ij; y4 := y2 - dx*ij + dy*ii; tangent_to_circle:=true; end;</span></span></code> </pre> <br>  Wobei (x1, y1) der Beobachtungspunkt ist, (x2, y2) der Mittelpunkt des Kreises ist, ® sein Radius ist und (x3, y3) und (x4, y4) die Schnittpunkte der Linien und des Kreises sind.  Die Funktion gibt nur dann true zurück, wenn sich der Beobachter außerhalb des Kreises befindet. <br><br>  Da der Prozessor nicht sehr trigonometrisch ist, habe ich versucht, ihn auf ein Minimum zu beschränken.  Experten, die sich auf eine einfache Regel (grobes Modell) stützen, werden Ihnen sagen, warum. <br><br>  <b>(Schlecht) SIN, COS ..&gt; '/', SQRT&gt; 'DIV', 'MOD'&gt; 'SHR', 'SHL'&gt; '*'&gt; ': =', '+', '-', 'AND ',' XOR '.. (Gut)</b> <br><br>  Es ist eine Freude, den grafischen Teil von Grundelementen auf der Leinwand zu implementieren. Es gibt viele Bibliotheken und Engines, die die Arbeit erleichtern.  Bei der Entwicklung auf Delphi musste ich die Agg2D-Bibliothek verwenden, auf Lazarus gibt es ihren Port <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(6)</a> , und darauf habe ich beschlossen, die Idee zu verwirklichen.  Tatsächlich besteht der Vorteil der Bibliothek darin, dass den RGB-Farben ein Alphakanal hinzugefügt wird und die Grundelemente geglättet werden. Aufgrund des direkten Zugriffs auf Pixel und verschiedener Tricks ist die Verarbeitung viel schneller als die Leinwand. <br><br>  Beim Zeichnen des Schattens der Kachel wollte ich den Sektor ursprünglich mit Schatten füllen, aber dann war das Bild innerhalb der Kachel schlecht unterscheidbar (der betreffende Sektor in Abbildung 3 ist mit Grün gefüllt).  Nachdem ich mit verschiedenen Optionen experimentiert hatte, hörte ich auf, einen Sektor aus dem Schattenbereich auszuwählen. <br><br>  Um den Sektor zu zeichnen, benötigen wir einen Winkel im Bogenmaß, aber die Trigonometrie konnte dies immer noch nicht.  (arctan2 - Funktion der Mathematikmodulbibliothek) <br><br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">//     function alpha_angle(x1,y1,x2,y2:Single):Single; begin alpha_angle := arctan2(y1 - y2, x1 - x2); end;</span></span></code> </pre><br>  Eigentlich ist alles bereit für die Bildmontage.  Wir nehmen eine Karte mit Kacheln und wenden nacheinander nacheinander Schatten an.  Bei Bäumen sind die Schatten dunkler, bei anderen Objekten sind die Schatten transparenter. <br><br><img src="https://habrastorage.org/webt/uc/wx/uc/ucwxucbzum2mqeexhvhx1nfoz74.png" alt="Bild"><br><br>  Das fertige Bild wird auf die Hauptschicht der Kacheln angewendet.  Ein bisschen Hintergrunddesign und allgemeinere Kachelsätze.  Eigentlich habe ich zwei Tage gebraucht, um nach geeigneten Kachelsätzen zu suchen, die gemeinfrei oder von sehr geringer Qualität sind oder Geld kosten.  Infolgedessen zeichnete er die Bäume selbst und lieh sich andere Elemente vom Benutzer Joe Williamson <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">(7)</a> (ausgezeichneter Stil). <br><br><img src="https://habrastorage.org/webt/fi/np/nz/finpnzmqhc_jx9qhwgubnx8x9sa.png" alt="Bild"><br><br>  Das wäre alles vorbei, aber die Leistung war etwas sedimentär.  Mit der Anzahl der Objekte beginnt ungefähr fünfhundert Drawdown.  Verschiedene Optimierungsmethoden wurden in Betracht gezogen, und die Aufteilung in Kernel und die Beschränkung des Zeichenbereichs auf einen bestimmten Radius, die Änderung der Form des Schattens (auf einen günstigeren Wert als Bögen). Ich dachte sogar daran, die Berechnung auf Video zu übertragen. <br><br>  Infolgedessen kam ich zu dem Schluss, dass die beste Option darin besteht, die Abtastung des als Schattenmaske dienenden Bildes zu reduzieren.  Da die Anzahl der Berechnungen erheblich reduziert wird, sowie der unerwartete Effekt der Pixelung der Schattenkonturen, was einen gewissen Charme der alten Schule verleiht. <br><br><img src="https://habrastorage.org/webt/ue/uv/rl/ueuvrlwsgp9zfa82re0upf8s-dm.png" alt="Bild"><br><br>  Der Effekt hat mir so gut gefallen, dass ich die Skalierung durch einen bestimmten Multiplizitätsparameter zu einem dynamischen Prozess machen musste. <br><br><img src="https://habrastorage.org/webt/dr/nz/nj/drnznjjm9iqbsxstlso17uh8kuo.png" alt="Bild"><br><br>  Alles, was blieb, war, undurchsichtige Wände zu schaffen und das Ergebnis der Gemeinde zu präsentieren. <br><br><img src="https://habrastorage.org/webt/61/ai/wf/61aiwfqtgba4k2cyvmgc1atua5k.png" alt="Bild"><br><br>  Ich freue mich auf neue Spiele mit diesem Effekt oder seiner Entwicklung. <br>  Vielen Dank! <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Demo,</a> in der Sie die Griffe berühren können (exe für Windows). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 2</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Teil 3</a> <br><br><div class="spoiler">  <b class="spoiler_title">Referenzen:</b> <div class="spoiler_text">  1) habr.com/post/16927/ <br>  2) en.wikipedia.org/wiki/Roguelike <br>  3) habr.com/post/204782/ <br>  4) habr.com/post/305252/ <br>  5) habr.com/post/319530/ <br>  6) wiki.freepascal.org/BGRABitmap <br>  7) twitter.com/joecreates <br></div></div></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de430438/">https://habr.com/ru/post/de430438/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de430428/index.html">Die Seite "Escher II" in der Nominierung "People's Internet Project" Runet Prizes 2018</a></li>
<li><a href="../de430430/index.html">Fullstack - warum ist es cool oder wie man Freude an der Arbeit hat</a></li>
<li><a href="../de430432/index.html">Das modale Fenster, auf das Sie gewartet haben. Oder wie man ein Popup von verschiedenen Schaltflächen auf reinem JS aufruft</a></li>
<li><a href="../de430434/index.html">Starten des Bildbetrachters unter Windows XP unter modernen Windows</a></li>
<li><a href="../de430436/index.html">Auf dem Weg zu QUIC: Was liegt unter HTTP / 3?</a></li>
<li><a href="../de430446/index.html">Noch einmal über die Profis der "mobilen Sklaverei"</a></li>
<li><a href="../de430448/index.html">Was gibt maschinelles Lernen im Einzelhandel: ein Projektbeispiel</a></li>
<li><a href="../de430450/index.html">Entwicklungsmodell am Beispiel einer stapelbasierten CPU</a></li>
<li><a href="../de430452/index.html">Feuer, Wasser und feines Spray. Wie Bewohner und Besucher des Lakhta Centers vor Feuer geschützt werden</a></li>
<li><a href="../de430454/index.html">Ich bin umgeben von Idioten oder wie man in einem Team arbeitet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>