<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõÄüèø üöØ üë®üèæ‚Äçüöí Como criar um aplicativo multilocat√°rio de um aplicativo n√£o-inquilino üåó üïπÔ∏è üë®üèΩ‚Äçüéì</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="N√£o darei uma defini√ß√£o de multiloca√ß√£o, eles j√° escreveram sobre isso v√°rias vezes aqui e aqui . E √© melhor ir direto ao t√≥pico do artigo e come√ßar c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Como criar um aplicativo multilocat√°rio de um aplicativo n√£o-inquilino</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/directum/blog/483784/"><p><img src="https://habrastorage.org/webt/-8/wa/hf/-8wahfnvtijn8bqkeopcgo0an1g.png" alt="imagem"></p><br><p>  N√£o darei uma defini√ß√£o de multiloca√ß√£o, eles j√° escreveram sobre isso v√°rias vezes <a href="https://habr.com/ru/company/microsoft/blog/145027/">aqui</a> e <a href="https://habr.com/ru/company/1c/blog/326654/">aqui</a> .  E √© melhor ir direto ao t√≥pico do artigo e come√ßar com as seguintes perguntas: </p><br><h2 id="pochemu-prilozhenie-ne-delayut-srazu-multitenantnym">  Por que o aplicativo n√£o √© multitenant imediatamente? </h2><br><p>  Acontece que o aplicativo foi desenvolvido inicialmente para instala√ß√£o apenas no lado do cliente.  Voc√™ pode chamar esse aplicativo em caixa ou <i>software como um produto</i> .  Um cliente compra uma caixa e implanta o aplicativo em seus servidores (h√° muitos exemplos desses aplicativos). </p><br><p>  Por√©m, com o tempo, a empresa desenvolvedora pode pensar que seria bom colocar o aplicativo na nuvem para que ele seja alugado (software como servi√ßo).  Esse m√©todo de implanta√ß√£o possui vantagens para os clientes e a empresa desenvolvedora.  Os clientes podem obter rapidamente um sistema operacional e n√£o se preocupar com implanta√ß√£o e administra√ß√£o.  Ao alugar um aplicativo, voc√™ n√£o precisa de grandes investimentos √∫nicos. </p><br><p>  E a empresa desenvolvedora receber√° novos clientes, bem como novas tarefas: implantar o aplicativo na nuvem, administrar, atualizar para novas vers√µes, migrar dados durante a atualiza√ß√£o, backup de dados, monitorar velocidade e erros, corrigir problemas, se ocorrerem. </p><a name="habracut"></a><br><h2 id="pochemu-prilozhenie-v-oblake-dolzhno-byt-multitenantnym">  Por que o aplicativo na nuvem deve ser multilocat√°rio? </h2><br><p>  Para colocar um aplicativo na nuvem, n√£o √© necess√°rio torn√°-lo multilocat√°rio.  Por√©m, haver√° o seguinte problema: para cada cliente, voc√™ precisar√° implantar um suporte dedicado na nuvem com o aplicativo concedido, e isso j√° √© caro, tanto em termos do consumo de recursos do suporte em nuvem quanto em termos de administra√ß√£o.  √â mais lucrativo implementar a multiloca√ß√£o no aplicativo para que uma inst√¢ncia possa atender a v√°rios clientes (organiza√ß√µes). </p><br><p>  Se o aplicativo atrair 1000 usu√°rios trabalhando simultaneamente, √© vantajoso agrupar clientes (organiza√ß√µes) para que, no total, eles ofere√ßam a carga desejada de 1.000 usu√°rios por inst√¢ncia do aplicativo.  E haver√° o consumo ideal de recursos da nuvem. </p><br><p>  Suponha que o aplicativo seja alugado por uma organiza√ß√£o para 20 usu√°rios (funcion√°rios da organiza√ß√£o).  Ent√£o voc√™ precisa agrupar 50 dessas organiza√ß√µes para alcan√ßar a carga certa.  √â importante isolar as organiza√ß√µes umas das outras.  Uma organiza√ß√£o aluga um aplicativo, deixa apenas seus funcion√°rios irem para l√°, armazena apenas seus dados e n√£o v√™ que outras organiza√ß√µes tamb√©m sejam atendidas pelo mesmo aplicativo. </p><br><p>  A implementa√ß√£o da multiloca√ß√£o n√£o significa que o aplicativo n√£o pode mais ser implantado localmente no servidor da organiza√ß√£o.  Voc√™ pode suportar dois m√©todos de implanta√ß√£o ao mesmo tempo: </p><br><ul><li>  aplicativo multilocat√°rio na nuvem; </li><li>  aplicativo de inquilino √∫nico no servidor do cliente. </li></ul><br><p>  Nosso aplicativo foi de maneira semelhante: de n√£o-inquilino a multi-inquilino.  E neste artigo, compartilharei algumas abordagens no desenvolvimento da multiloca√ß√£o. </p><br><h2 id="kak-realizovat-multitenantnost-v-prilozhenii-kotoroe-sproektirovano-kak-ne-tenantnoe">  Como implementar a multiloca√ß√£o em um aplicativo projetado como n√£o-inquilino? </h2><br><p>  Limitaremos imediatamente o t√≥pico, consideraremos apenas o desenvolvimento, n√£o abordaremos quest√µes de teste, lan√ßamento de vers√£o, implanta√ß√£o e administra√ß√£o.  Em todas essas √°reas, o surgimento da multiloca√ß√£o tamb√©m deve ser levado em considera√ß√£o, mas, por enquanto, falaremos apenas sobre desenvolvimento. </p><br><p>  Para entender o que √© um aplicativo que n√£o era arrendat√°rio e se tornou multilocat√°rio, descreverei seu objetivo, uma lista de servi√ßos e tecnologias utilizadas. </p><br><p>  Este √© um sistema ECM (DirectumRX), que consiste em 10 servi√ßos (5 servi√ßos monol√≠ticos e 5 microsservi√ßos).  Todos esses servi√ßos podem ser colocados em um servidor poderoso ou em v√°rios servidores. </p><br><div class="spoiler">  <b class="spoiler_title">Os servi√ßos s√£o</b> <div class="spoiler_text"><ul><li>  Servi√ßo da Web - para atender clientes da Web (navegadores). </li><li>  Servi√ßo WCF - para atender clientes de desktop (aplicativos WPF). </li><li>  Servi√ßo para aplicativos m√≥veis. </li><li>  Servi√ßo para executar processos em segundo plano. </li><li>  Servi√ßo para o planejamento de processos em segundo plano. </li><li>  Servi√ßo de execu√ß√£o de esquema de fluxo de trabalho </li><li>  Servi√ßo de Execu√ß√£o de Bloco de Fluxo de Trabalho </li><li>  Servi√ßo de armazenamento de documentos (dados bin√°rios). </li><li>  Servi√ßo para converter documentos em html (visualiza√ß√£o em um navegador). </li><li>  Servi√ßo para armazenar resultados de convers√£o em html </li></ul></div></div><br><p>  Pilha de tecnologias utilizadas: <br>  .NET + SQLServer / Postgres + NHibernate + IIS + RabbitMQ + Redis </p><br><p> Ent√£o, o que fazer com que os servi√ßos se tornem multilocat√°rios?  Para fazer isso, voc√™ precisa refinar os seguintes mecanismos nos servi√ßos, a saber, adicionar conhecimento sobre inquilinos a: </p><br><ul><li>  armazenamento de dados; </li><li>  ORM; </li><li>  cache de dados; </li><li>  solicita√ß√£o de processamento; </li><li>  processamento de mensagens na fila; </li><li>  configura√ß√£o; </li><li>  registro; </li><li>  executando tarefas em segundo plano; </li><li>  intera√ß√£o com microsservi√ßos; </li><li>  intera√ß√£o com o intermedi√°rio de mensagens. </li></ul><br><p>  No caso de nossa aplica√ß√£o, esses foram os principais locais que exigiram melhorias.  Vamos consider√°-los separadamente. </p><br><h2 id="vybor-sposoba-hraneniya-dannyh">  Escolhendo um m√©todo de armazenamento de dados </h2><br><p>  Quando voc√™ l√™ artigos sobre multiloca√ß√£o, a primeira coisa que eles resolvem √© como organizar o armazenamento de dados.  De fato, o ponto √© importante. </p><br><p>  Para o nosso sistema ECM, o armazenamento principal √© um banco de dados relacional, que possui cerca de 100 tabelas.  Como organizar o armazenamento de dados de muitas organiza√ß√µes para que a organiza√ß√£o A n√£o veja de forma alguma os dados da organiza√ß√£o B? </p><br><p>  V√°rios esquemas s√£o conhecidos (muito j√° foi escrito sobre esses esquemas): </p><br><ul><li>  crie seu pr√≥prio banco de dados para cada organiza√ß√£o (para cada inquilino); </li><li>  use um banco de dados para todas as organiza√ß√µes, mas para cada organiza√ß√£o fa√ßa seu pr√≥prio esquema no banco de dados; </li><li>  use um banco de dados para todas as organiza√ß√µes, mas adicione uma coluna "chave de inquilino / organiza√ß√£o" em cada tabela. </li></ul><br><p>  A escolha do esquema n√£o √© acidental.  No nosso caso, basta considerar os casos de administra√ß√£o do sistema para entender a op√ß√£o preferida.  Os casos s√£o os seguintes: </p><br><ul><li>  adicionar inquilino (uma nova organiza√ß√£o aluga um sistema); </li><li>  remover inquilino (a organiza√ß√£o se recusou a alugar); </li><li>  transferir inquilino para outro estande de nuvem (redistribua a carga entre os estandes de nuvem quando um deles parar de lidar com a carga). </li></ul><br><p>  Considere um caso de transfer√™ncia de inquilino.  A principal tarefa da transfer√™ncia √© transferir os dados da organiza√ß√£o para outro estande.  A transfer√™ncia n√£o √© dif√≠cil de fazer se o inquilino tiver seu pr√≥prio banco de dados, mas ser√° uma dor de cabe√ßa se voc√™ misturar os dados de diferentes organiza√ß√µes em 100 tabelas.  Tente extrair apenas os dados necess√°rios das tabelas, transfira-os para outro banco de dados, onde j√° existem dados de outros inquilinos e para que seus identificadores n√£o se cruzem. </p><br><p>  O pr√≥ximo caso √© a adi√ß√£o de um novo inquilino.  O caso tamb√©m n√£o √© simples.  A adi√ß√£o de inquilino √© a necessidade de preencher diret√≥rios, usu√°rios, direitos do sistema, para que voc√™ possa efetuar login no sistema.  Essa tarefa √© melhor resolvida pela clonagem de um banco de dados de refer√™ncia, que j√° possui tudo o que voc√™ precisa. </p><br><p>  O caso de remo√ß√£o de inquilino √© resolvido com muita facilidade desativando o banco de dados do inquilino. </p><br><p>  Por esses motivos, escolhemos um esquema: <strong>um inquilino - um banco de dados</strong> . </p><br><h2 id="orm">  ORM </h2><br><p>  Escolhemos o m√©todo de armazenamento de dados, a pr√≥xima pergunta: como ensinar o ORM a trabalhar com o esquema selecionado? </p><br><p>  N√≥s usamos o Nhibernate.  Era necess√°rio que o Nhibernate trabalhasse com v√°rios bancos de dados e alternasse periodicamente para o correto, por exemplo, dependendo da solicita√ß√£o http.  Se processarmos a solicita√ß√£o da organiza√ß√£o A, o banco de dados A foi usado e, se a solicita√ß√£o for da organiza√ß√£o B, o banco de dados B. </p><br><p>  O NHibernate tem essa oportunidade.  Voc√™ precisa substituir a implementa√ß√£o do <em>NHibernate.Connection.DriverConnectionProvider</em> .  Sempre que o NHibernate deseja abrir uma conex√£o com o banco de dados, ele chama <em>DriverConnectionProvider</em> para obter uma cadeia de conex√£o.  Aqui vamos substitu√≠-lo pelo necess√°rio: </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MyDriverConnectionProvider</span></span> : <span class="hljs-title"><span class="hljs-title">DriverConnectionProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ConnectionString =&gt; TenantRegistry.Instance.CurrentTenant.ConnectionString; }</code> </pre> <br><p>  O que √© <em>TenantRegistry.Instance.CurrentTenant</em> Vou contar um pouco mais tarde. </p><br><h2 id="keshirovanie-dannyh">  Armazenamento em cache de dados </h2><br><p>  Os servi√ßos geralmente armazenam em cache os dados para minimizar as consultas ao banco de dados ou n√£o calcular a mesma coisa v√°rias vezes.  O problema √© que os caches devem ser divididos por inquilinos se os dados do inquilino forem armazenados em cache.  N√£o √© aceit√°vel que o cache de dados de uma organiza√ß√£o seja usado ao processar uma solicita√ß√£o de outra organiza√ß√£o.  A solu√ß√£o mais simples √© adicionar um identificador de inquilino √† chave de cada cache: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> tenantCacheKey = cacheKey + TenantRegistry.Instance.CurrentTenant.Id;</code> </pre> <br><p>  Esse problema deve ser lembrado ao criar cada cache.  Existem muitos caches em nossos servi√ßos.  Para n√£o esquecer de levar em considera√ß√£o o identificador de inquilino em cada um, √© melhor unificar o trabalho com caches.  Por exemplo, crie um mecanismo de armazenamento em cache geral que ser√° armazenado em cache imediatamente no contexto dos inquilinos. </p><br><h2 id="logirovanie">  Registo </h2><br><p>  Cedo ou tarde, algo dar√° errado no sistema, voc√™ precisar√° abrir o arquivo de log e come√ßar a estud√°-lo.  A primeira pergunta √©: em nome de qual usu√°rio e qual organiza√ß√£o essas a√ß√µes foram cometidas? </p><br><p>  √â conveniente quando em cada linha do log h√° um identificador de inquilino e um nome de usu√°rio de inquilino.  Essas informa√ß√µes se tornam t√£o necess√°rias quanto, por exemplo, o tempo da mensagem: </p><br><pre> <code class="plaintext hljs">2019-05-24 17:05:27.985 &lt;message&gt; [User2 :Tenant1] 2019-05-24 17:05:28.126 &lt;message&gt; [User3 :Tenant2] 2019-05-24 17:05:28.173 &lt;message&gt; [User4 :Tenant3]</code> </pre> <br><p>  O desenvolvedor n√£o deve pensar em qual inquilino gravar no log, ele deve ser automatizado, oculto "sob o cap√¥" do sistema de log. </p><br><p>  N√≥s usamos o NLog, ent√£o eu darei um exemplo.  A maneira mais f√°cil de proteger o identificador de inquilino √© criar <em>NLog.LayoutRenderers.LayoutRenderer</em> , que permite obter identificador de inquilino para cada entrada de log: </p><br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">LayoutRenderer(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"tenant"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TenantLayoutRenderer</span></span> : <span class="hljs-title"><span class="hljs-title">LayoutRenderer</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Append</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StringBuilder builder, LogEventInfo logEvent</span></span></span><span class="hljs-function">)</span></span> { builder.Append(TenantRegistry.Instance.CurrentTenant.Id); } }</code> </pre> <br><p>  E use este LayoutRenderer no modelo de log: </p><br><pre> <code class="plaintext hljs">&lt;target layout="${odate} ${message} [${user} :${tenant}]"/&gt;</code> </pre> <br><h2 id="vypolnenie-koda">  Execu√ß√£o de c√≥digo </h2><br><p>  Nos exemplos acima, eu costumava usar o seguinte c√≥digo: </p><br><pre> <code class="cs hljs">TenantRegistry.Instance.CurrentTenant</code> </pre> <br><p>  √â hora de dizer o que isso significa.  Mas primeiro voc√™ precisa entender a abordagem que seguimos nos servi√ßos: </p><br><blockquote>  Qualquer execu√ß√£o de c√≥digo (processando uma solicita√ß√£o http, processando uma mensagem na fila, executando uma tarefa em segundo plano em um encadeamento separado) deve estar associada a algum inquilino. </blockquote><p>  Isso significa que, em qualquer local da execu√ß√£o do c√≥digo, √© poss√≠vel perguntar: "Para qual inquilino esse encadeamento funciona?"  ou de outra maneira: "Qual √© o inquilino atual?" </p><br><p>  <em>TenantRegistry.Instance.CurrentTenant</em> √© o inquilino atual do fluxo atual.  Stream e inquilino podem ser vinculados em nossos aplicativos.  Eles est√£o conectados temporariamente, por exemplo, ao processar uma solicita√ß√£o http ou ao processar uma mensagem da fila.  Uma maneira de vincular o inquilino a um fluxo √© feita assim: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . using (TenantRegistry.Instance.SwitchTo(tenantId)) { // ,     . var tenant = TenantRegistry.Instance.CurrentTenant; //     . var connectionString = tenant.ConnectionString; //  . var id = tenant.Id; }</span></span></code> </pre> <br><p>  Um inquilino vinculado a um encadeamento pode ser obtido em qualquer lugar do c√≥digo, entrando em contato com <em>TenantRegistry</em> - este √© um singleton, um ponto de acesso para trabalhar com inquilinos.  Portanto, Nhibernate e NLog podem acessar esse singleton (nos pontos de extens√£o) para descobrir a cadeia de conex√£o ou o identificador de inquilino. </p><br><h2 id="fonovye-zadachi">  Tarefas em segundo plano </h2><br><p>  Os servi√ßos geralmente t√™m tarefas em segundo plano que precisam ser executadas em um cron√¥metro.  As tarefas em segundo plano podem acessar o banco de dados da organiza√ß√£o e, em seguida, a tarefa em segundo plano deve ser executada para cada inquilino.  Para fazer isso, n√£o √© necess√°rio iniciar um cron√¥metro ou thread separado para cada inquilino.  √â poss√≠vel executar uma tarefa em diferentes inquilinos em um √∫nico encadeamento / cron√¥metro.  Para fazer isso, no manipulador de timer, classificamos os inquilinos, associamos cada inquilino a um fluxo e executamos uma tarefa em segundo plano: </p><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//    . foreach (var tenant in TenantRegistry.Instance.Tenants) { //    . using (TenantRegistry.Instance.SwitchTo(tenant.Id)) { //     . } }</span></span></code> </pre> <br><p>  Dois inquilinos n√£o podem ser conectados ao fluxo ao mesmo tempo; se anexarmos um, o outro ser√° desconectado do fluxo.  Utilizamos ativamente essa abordagem para n√£o produzir threads / temporizadores para tarefas em segundo plano. </p><br><h2 id="kak-sootnesti-http-zapros-c-tenantom">  Como correlacionar uma solicita√ß√£o http com um inquilino </h2><br><p>  Para processar a solicita√ß√£o http do cliente, voc√™ precisa saber de qual organiza√ß√£o ele veio.  Se o usu√°rio j√° estiver autenticado, o identificador de inquilino poder√° ser armazenado no cookie de autentica√ß√£o (se o trabalho com o aplicativo for realizado por meio do navegador) ou no token JWT.  Mas e se o usu√°rio ainda n√£o tiver se autenticado?  Por exemplo, um usu√°rio an√¥nimo abriu um site de aplicativo e deseja se autenticar.  Para fazer isso, ele envia uma solicita√ß√£o com um login e senha.  No banco de dados de qual organiza√ß√£o procurar esse usu√°rio? </p><br><p>  Al√©m disso, ser√£o recebidas solicita√ß√µes an√¥nimas para obter a p√°gina de logon no aplicativo e isso pode ser diferente para diferentes organiza√ß√µes, por exemplo, o idioma da localiza√ß√£o. </p><br><p>  Para resolver o problema de correla√ß√£o entre solicita√ß√£o e organiza√ß√£o an√¥nima de http (inquilino), usamos subdom√≠nios para organiza√ß√µes.  O nome do subdom√≠nio √© formado pelo nome da organiza√ß√£o.  Os usu√°rios devem usar o subdom√≠nio para trabalhar com o sistema: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  O mesmo servi√ßo da web multilocat√°rio est√° dispon√≠vel nesses endere√ßos.  Mas agora o servi√ßo entende de qual organiza√ß√£o uma solicita√ß√£o HTTP an√¥nima vir√°, com foco no nome de dom√≠nio. <br>  A liga√ß√£o do nome do dom√≠nio e do inquilino √© realizada no arquivo de configura√ß√£o do servi√ßo da web: </p><br><pre> <code class="json hljs">&lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company1"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company1.service.com"</span></span> /&gt; &lt;tenant name=<span class="hljs-string"><span class="hljs-string">"company2"</span></span> db=<span class="hljs-string"><span class="hljs-string">"database2"</span></span> host=<span class="hljs-string"><span class="hljs-string">"company2.service.com"</span></span> /&gt;</code> </pre> <br><p>  Sobre a configura√ß√£o de servi√ßos ser√° descrito abaixo. </p><br><h2 id="mikroservisy-hranenie-dannyh">  Microsservi√ßos.  Armazenamento de dados </h2><br><p>  Quando eu disse que o sistema ECM precisa de 100 tabelas, falei sobre servi√ßos monol√≠ticos.  Mas acontece que um microsservi√ßo requer um armazenamento relacional, no qual s√£o necess√°rias 2-3 tabelas para armazenar seus dados.  Idealmente, cada microsservi√ßo possui seu pr√≥prio armazenamento, ao qual somente ele tem acesso.  E o microsservi√ßo decide como armazenar dados no contexto dos inquilinos. </p><br><p>  Mas seguimos o outro caminho: decidimos armazenar todos os dados da organiza√ß√£o em um banco de dados.  Se um microsservi√ßo exigir armazenamento relacional, ele usar√° o banco de dados da organiza√ß√£o existente para que os dados n√£o sejam espalhados por diferentes armazenamentos, mas sejam coletados em um banco de dados.  Servi√ßos monol√≠ticos usam o mesmo banco de dados. </p><br><p>  Os microsservi√ßos funcionam apenas com suas tabelas no banco de dados e n√£o tentam trabalhar com tabelas de um mon√≥lito ou outro microsservi√ßo.  Existem pr√≥s e contras nessa abordagem. </p><br><p>  Pr√≥s: </p><br><ul><li>  dados da organiza√ß√£o em um s√≥ lugar; </li><li>  f√°cil de fazer backup e restaurar dados da organiza√ß√£o; </li><li>  No backup, os dados de todos os servi√ßos s√£o consistentes. </li></ul><br><p>  Contras: </p><br><ul><li>  um banco de dados para todos os servi√ßos √© muito restrito ao escalar (os requisitos para os recursos do DBMS aumentam); </li><li>  os microsservi√ßos t√™m acesso f√≠sico √†s tabelas uns dos outros, mas n√£o usam esse recurso. </li></ul><br><h2 id="mikroservisy-znanie-o-tenantah-ne-vsegda-trebuetsya">  Microsservi√ßos.  Nem sempre √© necess√°rio o conhecimento dos inquilinos. </h2><br><p>  Um microsservi√ßo pode n√£o saber que funciona em um ambiente de multilocat√°rio.  Considere um de nossos servi√ßos, que est√° envolvido na convers√£o de documentos em html. </p><br><p>  O que o servi√ßo faz: </p><br><ol><li>  Leva uma mensagem de uma fila RabbitMQ para converter um documento. <br><ul><li>  recupera o identificador de documento e o inquilino da mensagem </li></ul></li><li>  Baixe um documento de um servi√ßo de armazenamento de documentos. <br><ul><li>  pois isso gera uma solicita√ß√£o na qual transmite o identificador do documento e o identificador do inquilino </li></ul></li><li>  Converte um documento em html. </li><li>  Fornece html ao servi√ßo para armazenar resultados de convers√£o. </li></ol><br><p>  O servi√ßo n√£o armazena documentos e n√£o armazena resultados de convers√£o.  Ele tem conhecimento indireto dos inquilinos: o identificador do inquilino passa pelo servi√ßo em tr√¢nsito. </p><br><h2 id="mikroservisy-poddomeny-ne-nuzhny">  Microsservi√ßos.  Subdom√≠nios n√£o s√£o necess√°rios </h2><br><p>  Eu escrevi acima que subdom√≠nios ajudam a resolver o problema de solicita√ß√µes HTTP an√¥nimas: </p><br><pre> <code class="plaintext hljs">https://company1.service.com https://company2.service.com</code> </pre> <br><p>  Mas nem todos os servi√ßos funcionam com solicita√ß√µes an√¥nimas, a maioria exige autentica√ß√£o j√° aprovada.  Portanto, os microsservi√ßos que funcionam via http geralmente n√£o se importam com o nome de host da solicita√ß√£o, eles recebem todas as informa√ß√µes sobre o inquilino do token JWT ou do cookie de autentica√ß√£o que acompanha cada solicita√ß√£o. </p><br><h2 id="konfigurirovanie">  Configura√ß√£o </h2><br><p>  Os servi√ßos precisam ser configurados para que eles saibam sobre os inquilinos.  Ou seja: </p><br><ul><li>  especifique as strings para conectar-se ao banco de dados de inquilinos; </li><li>  vincular nomes de dom√≠nio a inquilinos; </li><li>  especifique o idioma e o fuso hor√°rio padr√£o do inquilino. </li></ul><br><p>  Os inquilinos podem ter muitas configura√ß√µes.  Para nossos servi√ßos, definimos as configura√ß√µes de inquilino nos arquivos de configura√ß√£o xml.  Este n√£o √© o web.config e n√£o o app.config.  Esse √© um arquivo xml separado, cujas altera√ß√µes devem poder ser capturadas sem a reinicializa√ß√£o dos servi√ßos, para que a adi√ß√£o de um novo inquilino n√£o reinicie o sistema inteiro. </p><br><p>  A lista de configura√ß√µes √© mais ou menos assim: </p><br><pre> <code class="xml hljs"><span class="hljs-comment"><span class="hljs-comment">&lt;!--  . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"TENANTS"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".jupiter"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://jupiter-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@jupiter-company.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tenant</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">db</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"DirectumRX_Mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">login</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"admin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">password</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkUriScheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkFileExtension</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".mars"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">hyperlinkServer</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">helpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">devHelpAddress</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://mars-rx.directum.ru/Sungero/dev_help"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">language</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Ru-ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isAttributesSignatureAbsenceAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">endorsingSignatureLocksSignedProperties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">administratorEmail</span></span></span><span class="hljs-tag"> =</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"root@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">feedbackEmail</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"support@mars-ooo.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isSendFeedbackAllowed</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">serviceUserPassword</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">utcOffset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"-1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">collaborativeEditingForced</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">block</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Quando uma nova organiza√ß√£o aluga um servi√ßo, ela precisa adicionar um novo inquilino ao arquivo de configura√ß√£o.  E √© desej√°vel que outras organiza√ß√µes n√£o sintam isso.  Idealmente, n√£o deve haver uma reinicializa√ß√£o dos servi√ßos. </p><br><p>  Em n√≥s, nem todos os servi√ßos s√£o capazes de pegar uma configura√ß√£o sem reiniciar, mas os servi√ßos mais cr√≠ticos (mon√≥litos) s√£o capazes de fazer isso. </p><br><h2 id="itog">  Sum√°rio </h2><br><p>  Quando um aplicativo se torna multilocat√°rio, parece que a complexidade do desenvolvimento aumentou dramaticamente.  Mas ent√£o voc√™ se acostuma √† multitenalidade e trata seu suporte como um requisito normal. </p><br><p>  Tamb√©m √© importante lembrar que a multiloca√ß√£o n√£o √© apenas desenvolvimento, mas tamb√©m testes, administra√ß√£o, implanta√ß√£o, atualiza√ß√£o, backups, migra√ß√µes de dados.  Mas melhor sobre eles outra vez. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt483784/">https://habr.com/ru/post/pt483784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt483770/index.html">Rumo √† automa√ß√£o SSL</a></li>
<li><a href="../pt483774/index.html">Resumo de eventos para profissionais de RH em TI para janeiro de 2020</a></li>
<li><a href="../pt483776/index.html">Introdu√ß√£o ao m√©todo diferencial sem√¢ntico em 5 minutos</a></li>
<li><a href="../pt483778/index.html">Semana 03 de seguran√ßa: princ√≠pios respons√°veis ‚Äã‚Äãde relat√≥rios de erros</a></li>
<li><a href="../pt483780/index.html">O que √© o Slack e como ele funciona?</a></li>
<li><a href="../pt483786/index.html">Classifica√ß√£o h√≠brida</a></li>
<li><a href="../pt483788/index.html">Pequena na√ß√£o insular ganha gra√ßas ao Twitch</a></li>
<li><a href="../pt483790/index.html">Notas do provedor de IoT. Tecnologia e economia LoRaWAN em ilumina√ß√£o urbana</a></li>
<li><a href="../pt483794/index.html">Partindo: por que voc√™ n√£o deve tomar kontroffer</a></li>
<li><a href="../pt483796/index.html">Par√¢metros opcionais nos reposit√≥rios de dados do Spring</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>