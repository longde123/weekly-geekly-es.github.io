<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☝🏾 🤵🏼 👆🏼 第5/2部分建筑。 1：RocketChip大道和湿滑的仪器仪表跑道的十字路口 🎳 🏹 💐</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在前面的四个部分中，已为使用RISC-V RocketChip内核进行实验做准备，即将RISC-V RocketChip内核通过Altera FPGA（现在为Intel）移植到“非标准”电路板上。 最后，在最后一部分中 ，结果证明可以在此板上运行Linux。 你知道这一切使我感到有趣吗？ 我必须同时...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>第5/2部分建筑。 1：RocketChip大道和湿滑的仪器仪表跑道的十字路口</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461577/"><p> 在前面的四个部分中，已为使用RISC-V RocketChip内核进行实验做准备，即将RISC-V RocketChip内核通过Altera FPGA（现在为Intel）移植到“非标准”电路板上。 最后，在<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">最后一部分中</a> ，结果证明可以在此板上运行Linux。 你知道这一切使我感到有趣吗？ 我必须同时使用RISC-V，C和Scala的汇编程序，而在所有这些程序中，Scala是最低级别的语言（因为在上面编写了处理器）。 </p><br><p> 让我们在本文中也不要让C令人反感。 此外，如果Scala + Chisel捆绑包仅用作<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">特定领域的语言</a>来对硬件进行明确描述，那么今天我们将学习如何以指令形式将简单的C函数“拉”入处理器。 </p><br><p>最终目标是通过类似于<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">QInst的方式</a>实现琐碎的类似于AFL的仪器的实现，而单独的指令的实现只是副产品。 </p><a name="habracut"></a><br><p> 显然，有（没有一个）商业OpenCL到RTL转换器。 我还遇到了有关某个RISC-V的COPILOT项目的信息，该项目具有相似的目标（更为先进），但是搜索结果非常糟糕，此外，它很有可能也是商业产品。 我主要对OpenSource解决方案感兴趣，但是即使有，也可以尝试自己实现，仍然很有趣-至少作为一个简化的培训示例，然后了解它的发展方式... </p><br><p>  <strong>免责声明</strong> （除了关于“用灭火器跳舞”的常规警告之外）：我强烈建议您不要鲁applying地应用生成的软件核心，尤其是对不受信任的数据-到目前为止，我没有那么大的信心，甚至不理解为什么要处理的数据不能流程和/或核心之间的某些边界情况下的“流程”。 好吧，关于数据可能“跳动”的事实，我认为是显而易见的。 一般来说，仍然存在验证和验证... </p><br><p> 首先，我怎么称呼“简单功能”？ 出于本文的目的，这意味着一个函数，其中所有转换（有条件的和无条件的）仅将指令计数器增加一个恒定值。 也就是说，所有可能的过渡图都是（有向的）无环的，没有“动态”边缘。 本文框架的最终目标是能够从程序中获得一个简单的功能，并用汇编程序插件代替它，然后在合成阶段将其“缝”入处理器，可以选择使其成为另一条指令的副作用。  <em>具体来说，本文中不会显示分支，但是在最简单的情况下，创建分支并不困难。</em> </p><br><h2 id="uchimsya-ponimat-c-na-samom-dele-net"> 学习理解C（实际上不是） </h2><br><p>首先，您需要了解我们将如何解析C？ 没错，没办法-我学会<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">解析ELF文件</a>并没有白费：您只需要将C / Rust /其他代码编译成eBPF字节码，然后就已经对其进行了解析。 某些困难是由于以下事实造成的：在Scala中，您不能仅连接<code>elf.h</code>并读取结构字段。 当然，您可以尝试使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">JNAerator-</a>如有必要，它们可以对库进行绑定-不仅可以结构，还可以生成通过JNA工作的代码（不要与JNI混淆）。 作为一名真正的程序员，我将编写自行车，并仔细地编写头文件中的枚举和偏移量常量。 结果和中间结构由案例类的以下结构描述： </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegularSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SymtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StrtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RelSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Header</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> sectionHeaders: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">], sectionStringTableIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Section</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> data: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">, linkIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, infoIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, kind: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">SectionKind</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Symbol</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, size: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, shndx: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, isInstrumenter: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Relocation</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> relocatedSection: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, symbol: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfInsn</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> opcode: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, dst: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, src: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, imm: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Either</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfProg</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, insns: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">BpfInsn</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p> 我不会特别描述解析过程-这只是从<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u="><code>java.nio.ByteBuffer</code></a>进行的无聊字节传输-所有有趣的事情已经<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">在解析ELF文件</a>的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">文章中进行</a>了描述。 我只能说您需要仔细处理<code>opcode == 0x18</code> （将64位立即数加载到寄存器中），因为它一次占用两个8字节的字（也许还有其他此类操作码，但我还没有遇到它们） ，并且这并不总是加载与重定位相关的内存地址，就像我最初想的那样。 例如， <code>0x0101010101010101</code>诚实地使用64位<strong>常量</strong> <code>0x0101010101010101</code> 。 为什么我不对补丁下载的文件进行“诚实”重定位-因为我想查看符号形式的字符（对双关语很抱歉），因此以后可以用寄存器替换<code>COMMON</code>部分中的字符，而无需使用带有特殊处理地址类型的拐杖（和这意味着，即使在具有恒定/非恒定<code>UInt</code>舞蹈中也是如此。 </p><br><h2 id="stroim-hardware-po-naboru-instrukciy"> 我们根据一组说明来构建硬件 </h2><br><p> 因此，通过假设，所有可能的执行路径都排在指令列表的下方，这意味着数据沿着定向的非循环图流动，并且其所有边缘都是静态定义的。 同时，我们具有纯粹的组合逻辑（即，途中没有寄存器），这些逻辑是通过寄存器上的操作获得的，以及使用内存进行加载/存储操作期间的延迟。 因此，在一般情况下，可能无法在一个时钟周期内完成操作。 我们将做简单的事情：我们将以<code>UInt</code>的形式将值传输到，但是就像<code>(UInt, Bool)</code> ：对中的第一个元素是值，第二个是其正确性的标志。 也就是说，只要地址不正确，从内存中读取就没有多大意义，并且一般而言是不可能的。 </p><br><p>  eBPF字节码执行模型假定某种类型的RAM具有64位寻址，以及一组16个（甚至10个）64位寄存器。 提出了一种原始的递归算法： </p><br><ul><li> 我们从上下文中开始，在该上下文中，指令的操作数位于<code>r1</code>和<code>r2</code>中，其余为零，都有效（更确切地说，有效性等于协处理器指令的“就绪”） </li><li> 如果看到算术逻辑指令，则从上下文中提取其操作数寄存器，调用自身作为列表的尾部，并在上下文中将输出操作数替换为一对<code>(data1 op data2, valid1 &amp;&amp; valid2)</code> </li><li> 如果遇到分支，我们只需递归地构建两个分支：如果分支发生，否则 </li><li> 如果遇到加载或保存到内存的问题，我们就会以某种方式摆脱困境：我们执行已传输的回调，并假设在执行该指令期间一旦<code>valid</code>语句无法被调用的不变性。 保存操作的有效性由我们与<code>globalValid</code>标志进行AND运算，该标志必须在返回控件之前进行设置。 同时，我们必须沿线进行读写，以正确处理增量和其他修改。 </li></ul><br><p> 因此，将尽可能并行地而不是逐步地执行操作。 同时，请您注意，对内存特定字节的所有操作自然应该完全排序，否则结果是不可预测的，UB。 即  <code>*addr += 1</code>这是正常现象，直到读取完成（直到现在我们仍然不知道要写什么），才会真正开始写入，但是<code>*addr += 1; return *addr;</code> <code>*addr += 1; return *addr;</code> 我通常会安全地给出<strong>零</strong>或类似的值。 也许值得调试（也许它隐藏了一些更棘手的问题），但是无论如何，这种吸引力本身就是一个主意，因为您必须跟踪工作已经完成的内存地址，但是我有一个愿望<code>valid</code>可能，请静态验证值。 这正是固定大小的全局变量将要执行的操作。 </p><br><p> 结果是一个抽象类<code>BpfCircuitConstructor</code> ，它没有实现的方法<code>doMemLoad</code> ， <code>doMemStore</code>和<code>resolveSymbol</code> ： </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... sealed abstract class LdStType(val lgsize: Int) { val byteSize = 1 &lt;&lt; lgsize val bitSize = byteSize * 8 val mask: UInt = if (bitSize == 64) mask64 else ((1l &lt;&lt; bitSize) - 1).U } case object u8 extends LdStType(0) case object u16 extends LdStType(1) case object u32 extends LdStType(2) case object u64 extends LdStType(3) def doMemLoad(addr: UInt, tpe: LdStType, valid: Bool): (UInt, Bool) def doMemStore(addr: UInt, tpe: LdStType, data: UInt, valid: Bool): Bool sealed trait Resolved { def asPlainValue: UInt def load(ctx: Context, offset: Int, tpe: LdStType, valid: Bool): LazyData def store(offset: Int, tpe: LdStType, data: UInt, valid: Bool): Bool } def resolveSymbol(sym: BpfLoader.Symbol): Resolved // ... }</span></span></code> </pre> <br><h2 id="integraciya-s-processornym-yadrom">  CPU核心整合 </h2><br><p> 对于初学者，我决定采用一种简单的方法：使用标准的RoCC（火箭定制协处理器）协议连接到处理器内核。 据我了解，这不是对所有RISC-V兼容内核的常规扩展，而是仅对Rocket和BOOM（伯克利<code>custom0</code>计算机）的扩展，因此，当在编译器上拖动上游工作时，汇编器<code>custom0</code>助记符被排除在外- <code>custom3</code>负责加速器命令。 </p><br><p> 通常，每个Rocket / BOOM处理器内核最多可以通过配置添加四个RoCC加速器，还有实现示例： </p><br><p>  <strong>Configs.scala：</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithRoccExample</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(site, here, up</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BuildRoCC</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>( (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> accumulator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AccumulatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom0, n = <span class="hljs-number"><span class="hljs-number">4</span></span>)(p)) accumulator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> translator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">TranslatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom1)(p)) translator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> counter = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">CharacterCountExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom2)(p)) counter }) })</code> </pre> <br><p> 相应的实现在<code>LazyRoCC.scala</code>文件中。 </p><br><p> 加速器实现表示内存控制器已经熟悉的两个类：在这种情况下，其中一个是从<code>LazyRoCC</code>继承的， <code>LazyRoCC</code>是从<code>LazyRoCC</code>继承的。 第二类具有<code>RoCCIO</code>类型的<code>io</code>端口，其中包含<code>cmd</code>请求端口， <code>resp</code>响应端口，mem访问L1D高速缓存端口， <code>busy</code>和<code>interrupt</code>输出以及<code>exception</code>输入。 还有一个似乎不需要的页表浏览器端口和FPU（无论如何，eBPF中没有真正的算法）。 到目前为止，我想尝试使用这种方法做点什么，所以我不会碰到<code>interrupt</code> 。 另外，据我了解，有一个TileLink接口可用于非缓存的内存访问，但是现在我也不会碰它。 </p><br><h2 id="uporyadochivatel-zaprosov"> 查询组织者 </h2><br><p> 因此，我们有一个用于访问缓存的端口，但是只有一个。 同时，一个函数可以例如增加一个变量（至少可以将其变成单个原子操作），甚至可以通过加载，更新和保存它来进行不平凡的转换。 最后，一条指令可以发出几个不相关的请求。 就性能而言，这也许不是最好的主意，但是，另一方面，为什么不加载三个单词（很有可能已经在缓存中），以某种方式与组合逻辑<strong>并行</strong>处理它们（然后一拍）并保存结果。 因此，我们需要某种方案来有效地“解决”并行访问单个缓存端口的尝试。 </p><br><p> 逻辑将类似于以下内容：在特定子注入的实现的生成的开始（就RoCC而言为7位<code>funct</code>字段），将创建查询序列化程序的实例（使一个全局变量对我来说似乎非常有害，因为它在请求之间创建了一堆额外的依赖关系，这些依赖关系永远无法同时执行，并且最有可能浪费Fmax）。 接下来，在序列化器中注册每个创建的“保存程序” /“加载程序”。 可以这么说，在现场队列中。 在每种措施下，都会选择注册顺序中的第一个请求- <strong>在下一项措施中</strong>会授予他许可。 自然地，这种逻辑需要适当地与测试重叠（尽管我没有太多的逻辑，所以不是验证，而是至少可以理解的最低要求）。 我使用了来自或多或少官方组件的标准<code>PeekPokeTester</code>来测试Chisel设计。 我已经<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">描述过一次</a> 。 </p><br><p> 结果就是这样一个怪诞的事情： </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializer</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">isComputing: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span><span class="hljs-class"><span class="hljs-params">, next: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">monotonic</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = <span class="hljs-type"><span class="hljs-type">WireInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> prevRes = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) prevRes := res &amp;&amp; isComputing res := (x || prevRes) &amp;&amp; isComputing res } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noone</span></span></span></span>(bs: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = !bs.foldLeft(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>)(_ || _) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> previousReqs = <span class="hljs-type"><span class="hljs-type">ArrayBuffer</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextReq</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">Bool</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> enable = monotonic(x) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> retired = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doRetire = result &amp;&amp; next <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> thisReq = enable &amp;&amp; !retired &amp;&amp; !doRetire <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> reqWon = thisReq &amp;&amp; noone(previousReqs) when (isComputing) { when(reqWon) { result := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } when(doRetire) { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } } otherwise { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } previousReqs += thisReq (result, previousReqs.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br><p> 请注意，在创建数字电路的过程中，Scala代码是安全执行的。 如果您仔细观察，您甚至会注意到一个<code>ArrayBuffer</code> ，电路的各个部分都堆叠在其中（ <code>Boolean</code>是Scala的类型， <code>Bool</code>是表示带电设备的Chisel类型，而不是运行时已知的布尔）。 </p><br><h2 id="rabota-s-l1d-keshom"> 使用L1D缓存 </h2><br><p> 使用缓存的工作主要是通过<code>io.mem.req</code>请求<code>io.mem.req</code>和<code>io.mem.resp</code>响应<code>io.mem.resp</code> 。 同时，请求端口配备了传统的<code>ready</code>和<code>valid</code>信号：第一个告诉您已准备好接受请求，第二个告诉您请求已准备好并且已经具有正确的结构，沿着前面， <code>valid &amp;&amp; resp</code>响应被视为已接受。 在某些此类接口中，要求从设置为<code>true</code>到<code>valid &amp;&amp; resp</code>的后续上升沿都对信号“无响应” <code>fire()</code>为方便起见，可以使用<code>fire()</code>方法构造此表达式）。 </p><br><p>  <code>resp</code> ， <code>resp</code>响应端口只有一个<code>valid</code>符号，这是处理器在一个时钟周期内耙回答案的问题：假设它“始终准备就绪”，而<code>fire()</code>返回的则是<code>valid</code> 。 </p><br><p> 另外，正如我已经说过的，您无法在可怕的情况下提出请求：您不能写东西，我不知道什么，然后再读一遍，根据减去的值以后将被覆盖的内容也有些奇怪。 但是<code>Serializer</code>类已经理解了这一点，但是我们只给它一个信号，即当前请求已经进入缓存： <code>next = io.mem.req.fire()</code> 。 所有可以做的就是确保答案在“阅读器”中仅在真正出现时才更新-不早也不晚。  <code>holdUnless</code>有一个方便的<code>holdUnless</code>方法。 结果大约是以下实现： </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constructor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Serializer</span></span>(isComputing, io.mem.req.fire()) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemLoad</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">UInt</span></span>, <span class="hljs-type"><span class="hljs-type">Bool</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doResp = isComputing &amp;&amp; serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) &amp;&amp; io.mem.resp.valid &amp;&amp; io.mem.resp.bits.tag === thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> &amp;&amp; io.mem.resp.bits.cmd === <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> (io.mem.resp.bits.data holdUnless doResp, serializer.monotonic(doResp)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemStore</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, data: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XWR</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := data io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveSymbol</span></span></span></span>(sym: <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>): <span class="hljs-type"><span class="hljs-type">Resolved</span></span> = sym <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>(symName, _, size, <span class="hljs-type"><span class="hljs-type">ElfConstants</span></span>.<span class="hljs-type"><span class="hljs-type">Elf64_Shdr</span></span>.<span class="hljs-type"><span class="hljs-type">SHN_COMMON</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> size &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">RegisterReference</span></span>(regs.getOrElseUpdate(symName, <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>(<span class="hljs-number"><span class="hljs-number">64.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)))) } }</code> </pre> <br><p> 将为每个生成的子指令创建此类的实例。 </p><br><h2 id="ne-vsyo-to-v-kuche-chto-globalnaya-peremennaya"> 并非堆上的全部都是全局变量 </h2><br><p> 嗯，什么是模型示例？ 我想确保什么性能？ 当然是AFL仪器！ 它在经典版本中看起来像这样： </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; extern uint8_t *__afl_area_ptr; extern uint64_t prev; void inst_branch(uint64_t tag) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; }</span></span></span></span></code> </pre> <br><p> 如您所见，它或多或少地从<code>__afl_area_ptr</code>逻辑加载和保存（在它们之间为增量）一个字节，但是这里的寄存器要求起<code>prev</code>作用！ </p><br><p> 这就是为什么需要<code>Resolved</code>接口的原因：它可以包装常规内存地址或作为寄存器引用。 同时，到目前为止，我仅考虑大小为1、2、4或8字节的标量寄存器，这些标量寄存器始终以零偏移量读取，因此对于寄存器，您可以相对平静地实现调用顺序。 在这种情况下，知道必须先减去<code>prev</code>并用于计算索引，然后才进行重写，这非常有用。 </p><br><h2 id="a-teper-instrumentaciya"> 现在仪表 </h2><br><p> 在某个时候，我们有了带有RoCC接口的独立的或多或少可以使用的加速器。 现在怎么办 重新实现都一样，是否通过处理器管道？ 在我看来，如果与已安装的指令并行地，简单地激活具有自动发布的实用价值函数的协处理器，则将需要更少的拐杖。 原则上，我还为此感到痛苦：我什至学会了使用SignalTap，因为调试几乎是盲目的，甚至在稍作更改后（即使更改bootrom除外-一切都很快），即使重新编译五分钟也是如此-这已经太多了。 </p><br><p> 结果，对命令解码器进行了调整，流水线稍微“变直了”，以考虑到无论解码器对原始指令说什么，突然激活的RoCC本身并不意味着对输出寄存器的写入将有很长的延迟，就像在除法运算期间那样并错过了数据缓存。 </p><br><p> 通常，指令的描述是一对（[用于识别指令的模式]，[配置处理器核的数据路径块的值的集合]）。 例如， <code>default</code> （无法识别的指令）如下所示（从<code>IDecode.scala</code>中获取，坦白地说，在桌面Habr中看起来很丑）： </p><br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">default</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// jal renf1 fence.i // val | jalr | renf2 | // | fp_val| | renx2 | | renf3 | // | | rocc| | | renx1 s_alu1 mem_val | | | wfd | // | | | br| | | | s_alu2 | imm dw alu | mem_cmd mem_type| | | | mul | // | | | | | | | | | | | | | | | | | | | | | div | fence // | | | | | | | | | | | | | | | | | | | | | | wxd | | amo // | | | | | | | | scie | | | | | | | | | | | | | | | | | dp List(N,X,X,X,X,X,X,X,X,A2_X, A1_X, IMM_X, DW_X, FN_X, N,M_X, MT_X, X,X,X,X,X,X,X,CSR.X,X,X,X,X)</span></span></code> </pre> <br><p>  ...，而Rocket核心<em>扩展之一的</em>典型描述是这样实现的： </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDecode</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecodeConstants</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> table: <span class="hljs-type"><span class="hljs-type">Array</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = <span class="hljs-type"><span class="hljs-type">Array</span></span>( <span class="hljs-type"><span class="hljs-type">BNE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SNE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BEQ</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SEQ</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLT</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLT</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLTU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLTU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGEU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGEU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p> 事实是，在RISC-V（不仅在RocketChip中，而且在原则上在命令架构中），ISA分为强制性子集I（整数运算）和可选的M（整数乘法和除法），还定期支持A（原子）等 </p><br><p> 结果，原来的方法 </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs = <span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> <br><p> 已被取代 </p><br><div class="spoiler">  <b class="spoiler_title">相同，但是带有解码器，用于仪器化和阐明rocc激活的原因</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])], handlers: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs=<span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc_explicit, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handlers.isEmpty) { handler_rocc := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> handler_rocc_funct := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = handlers.map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>(pattern, funct) =&gt; pattern -&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(funct.<span class="hljs-type"><span class="hljs-type">U</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerDecoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">N</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>)), handlerTable) <span class="hljs-type"><span class="hljs-type">Seq</span></span>(handler_rocc, handler_rocc_funct) zip handlerDecoder map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (s,d) =&gt; s:=d } } rocc := rocc_explicit || handler_rocc <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> </div></div><br><p> 在处理器管道的变化中，最明显的也许是： </p><br><pre> <code class="diff hljs"> io.rocc.exception := wb_xcpt &amp;&amp; csr.io.status.xs.orR io.rocc.cmd.bits.status := csr.io.status io.rocc.cmd.bits.inst := new RoCCInstruction().fromBits(wb_reg_inst) + when (wb_ctrl.handler_rocc) { + io.rocc.cmd.bits.inst.opcode := 0x0b.U // custom0 + io.rocc.cmd.bits.inst.funct := wb_ctrl.handler_rocc_funct + io.rocc.cmd.bits.inst.xd := false.B + io.rocc.cmd.bits.inst.rd := 0.U + } io.rocc.cmd.bits.rs1 := wb_reg_wdata io.rocc.cmd.bits.rs2 := wb_reg_rs2</code> </pre> <br><p> 显然，对加速器的请求的某些参数需要更正：没有响应写入寄存器，并且<code>funct</code>等于解码器返回的内容。 但是有一点不太明显的变化：事实是该命令并不直接传递给加速器（其中四个-哪个？），而是传递给路由器，因此您需要假装该命令的<code>opcode == custom0</code> （是的，过程，而这恰恰是零加速器！）。 </p><br><h2 id="proverka"> 检查一下 </h2><br><p> 实际上，本文假设将继续进行尝试，以使这种方法达到或多或少的生产水平。 切换任务时，至少必须学会保存和还原上下文（协处理器寄存器的状态）。 同时，我将检查它是否可以在温室条件下正常工作： </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; uint64_t counter; uint64_t funct1(uint64_t x, uint64_t y) { return __builtin_popcountl(x); } uint64_t funct2(uint64_t x, uint64_t y) { return (x + y) * (x - y); } uint64_t instMUL() { counter += 1; *((uint64_t *)0x81005000) = counter; return 0; }</span></span></span></span></code> </pre> <br><p> 现在在<code>main</code>行中添加到<code>bootrom/sdboot/sd.c</code> </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/path/to/freedom-u-sdk/riscv-pk/machine/encoding.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// ... ////    -   RoCC #define STR1(x) #x #define STR(x) STR1(x) #define EXTRACT(a, size, offset) (((~(~0 &lt;&lt; size) &lt;&lt; offset) &amp; a) &gt;&gt; offset) #define CUSTOMX_OPCODE(x) CUSTOM_##x #define CUSTOM_0 0b0001011 #define CUSTOM_1 0b0101011 #define CUSTOM_2 0b1011011 #define CUSTOM_3 0b1111011 #define CUSTOMX(X, rd, rs1, rs2, funct) \ CUSTOMX_OPCODE(X) | \ (rd &lt;&lt; (7)) | \ (0x7 &lt;&lt; (7+5)) | \ (rs1 &lt;&lt; (7+5+3)) | \ (rs2 &lt;&lt; (7+5+3+5)) | \ (EXTRACT(funct, 7, 0) &lt;&lt; (7+5+3+5+5)) #define CUSTOMX_R_R_R(X, rd, rs1, rs2, funct) \ asm ("mv a4, %[_rs1]\n\t" \ "mv a5, %[_rs2]\n\t" \ ".word "STR(CUSTOMX(X, 15, 14, 15, funct))"\n\t" \ "mv %[_rd], a5" \ : [_rd] "=r" (rd) \ : [_rs1] "r" (rs1), [_rs2] "r" (rs2) \ : "a4", "a5"); int main(void) { // ... //  RoCC extension write_csr(mstatus, MSTATUS_XS &amp; (MSTATUS_XS &gt;&gt; 1)); //   bootrom       uint64_t res; CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 2); // ...     uint64_t x = 1; for (int i = 0; i &lt; 123; ++i) x *= *(volatile uint8_t *)0x80000000; kputc('0' + x % 10); //   !!! // ... }</span></span></span></span></code> </pre> <br><p>  <code>write_csr</code> ,     <code>custom0</code> - <code>custom3</code> .      ,   illegal instruction,  ,  , ,   .   <code>define</code> -     - ,   «» binutils  <code>customX</code>      RocketChip,  ,   ,   . </p><br><p>     sdboot  ,       ,      . </p><br><p>  : </p><br><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000000000 in ?? () (gdb) x/d 0x81005000 0x81005000: 123 (gdb) set variable $pc=0x10000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x0000000000010488 in crc16_round (data=&lt;optimized out&gt;, crc=&lt;optimized out&gt;) at sd.c:151 151 crc ^= data; (gdb) x/d 0x81005000 0x81005000: 246</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"> funct1</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000010194 in main () at sd.c:247 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); (gdb) set variable $a5=0 (gdb) set variable $pc=0x10194 (gdb) set variable $a4=0xaa (gdb) display/10i $pc-10 1: x/10i $pc-10 0x1018a &lt;main+46&gt;: sw a3,124(a3) 0x1018c &lt;main+48&gt;: addiw a0,a0,1110 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 =&gt; 0x10194 &lt;main+56&gt;: 0x2f7778b 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; (gdb) display/x $a5 2: /x $a5 = 0x0 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x4 (gdb) set variable $a4=0xaabc (gdb) set variable $pc=0x10194 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x9</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">源代码</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN461577/">https://habr.com/ru/post/zh-CN461577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN461565/index.html">TypeScript开发人员的5条诫命</a></li>
<li><a href="../zh-CN461567/index.html">的SQL 有趣的难题</a></li>
<li><a href="../zh-CN461569/index.html">前端注意事项：测试前要检查的内容</a></li>
<li><a href="../zh-CN461571/index.html">现实生活中的SVG。 Yandex报告</a></li>
<li><a href="../zh-CN461575/index.html">在任何Openstack兼容主机上创建基于3CX云的PBX</a></li>
<li><a href="../zh-CN461579/index.html">WebMoney引入了新的WMP钱包并更改了游戏规则</a></li>
<li><a href="../zh-CN461583/index.html">Python帮助测试结构产品</a></li>
<li><a href="../zh-CN461587/index.html">10个步骤本地化应用程序</a></li>
<li><a href="../zh-CN461589/index.html">井字游戏：内容周期</a></li>
<li><a href="../zh-CN461593/index.html">F＃上的API。 基于访问角色的应用程序模块</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>