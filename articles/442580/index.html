<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë≤üèº üëçüèº üßó Ingenier√≠a inversa de formato binario utilizando archivos Korg .SNG como ejemplo üí¨ üëéüèΩ üóìÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Vivimos en un tiempo asombroso. A nuestro alrededor hay una abundancia de tecnolog√≠a: tel√©fonos, computadoras, relojes inteligentes y otros dispositiv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ingenier√≠a inversa de formato binario utilizando archivos Korg .SNG como ejemplo</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/442580/"><img src="https://habrastorage.org/webt/ve/-p/e3/ve-pe3tgqlv4dwca26xozjh6t2s.jpeg"><br><br>  Vivimos en un tiempo asombroso.  A nuestro alrededor hay una abundancia de tecnolog√≠a: tel√©fonos, computadoras, relojes inteligentes y otros dispositivos.  Todos los d√≠as, los fabricantes lanzan cada vez m√°s dispositivos al mercado.  La mayor√≠a de ellos est√°n destinados a una vida corta y brillante (o no tan): una poderosa compa√±√≠a de marketing en el momento del lanzamiento, 1-2 a√±os de soporte completo por parte del fabricante y luego olvido lento.  Los dispositivos simples pueden funcionar durante a√±os despu√©s del final del per√≠odo de soporte oficial.  Con los dispositivos inteligentes, cada vez es m√°s dif√≠cil.  Es bueno si el gadget al menos contin√∫a funcionando despu√©s de desconectar los servidores / servicios del fabricante.  Y es una suerte que la pr√≥xima actualizaci√≥n del sistema operativo, los controladores u otro software no supere la compatibilidad. <br><a name="habracut"></a><br>  Desafortunadamente, los eventos se desarrollan cada vez m√°s de acuerdo con un escenario pesimista.  Y entre 5 y 10 a√±os despu√©s de la compra, tenemos dispositivos t√©cnicamente s√≥lidos en nuestras manos, que, sin embargo, no pueden utilizarse debido a la falta de soporte de software.  Por supuesto, un dispositivo roto es desagradable.  Pero mucho m√°s desagradable si hay datos de usuario en un formato incompatible con cualquier cosa.  Estos datos pueden considerarse perdidos si el dispositivo deja de funcionar.  En mi caso, lo peor a√∫n no ha sucedido, pero las alarmas ya est√°n sonando. <br><br>  Entonces, est√° la famosa empresa Korg, que produce equipos musicales de muy alta calidad.  En 2010, compr√© un sintetizador de esta compa√±√≠a para practicar m√∫sica como hobby.  La microestacion de Korg es un modelo bastante avanzado.  Entre otras cosas, tiene un secuenciador integrado para grabar sus pistas y puede escribir datos en una tarjeta de memoria en el formato SNG patentado.  Es posible exportar a un formato midi com√∫n, pero casi todos los metadatos se pierden: informaci√≥n sobre efectos y filtros superpuestos, diversas configuraciones de instrumentos virtuales, etc.  El principal problema para m√≠ personalmente es la velocidad de transici√≥n para grabar ideas musicales.  La musa es una creaci√≥n caprichosa, y la mayor√≠a de las veces me encuentro con una idea interesante simplemente improvisando o tocando algo sin complicaciones.  Cuanto m√°s r√°pido presione el bot√≥n de grabaci√≥n sin deambular por el men√∫, es m√°s probable que pueda repetir y grabar un fragmento interesante, que en el futuro puede convertirse en parte de un trabajo completo.  Por supuesto, este enfoque es imperfecto, pero estamos hablando de un pasatiempo.  De una forma u otra, durante casi diez a√±os, he acumulado alrededor de mil bocetos musicales y bocetos en formato SNG. <br><br>  La campana son√≥ en forma de una serie de problemas t√©cnicos del sintetizador, que requieren un parpadeo del dispositivo.  Y pens√© en convertir todos mis datos acumulados al formato Midi, m√°s a√∫n, ya que har√° que sea mucho m√°s f√°cil almacenarlos, organizarlos y editarlos.  La b√∫squeda del convertidor en Google no dio nada.  Hay muchas solicitudes en todo tipo de foros, la historia ha estado sucediendo durante 20 a√±os, si no m√°s.  Todo lo que encontr√© fue la antigua utilidad de Windows de otra persona, naturalmente incompatible con mis archivos. <br><br>  ¬øY luego decid√≠ tratar de ver de qu√© se trata este formato SNG?  ¬øQuiz√°s en alg√∫n lugar dentro hay datos MIDI normales que puede extraer y guardar f√°cilmente? <br><br><h3>  Un intento de resolver el problema "frente" </h3><br>  Entonces, a partir de las instrucciones para el sintetizador, puede descubrir que el formato SNG es un contenedor en el que se almacenan las llamadas "canciones".  Cada canci√≥n contiene 16 pistas de secuenciador con datos de m√∫sica, as√≠ como configuraciones para sonidos y efectos.  Al exportar a formato Midi a trav√©s del men√∫ del sintetizador, cada "canci√≥n" se exporta a un archivo .MID separado, y se pierden todos los ajustes de sonidos y efectos.  Porque  Reproduzco mis ideas de la forma m√°s simple y sin efectos, el problema es precisamente una gran cantidad de archivos SNG y las molestias del proceso de conversi√≥n manual.  Veamos si este proceso puede ser acelerado o automatizado. <br><br>  Primero, recordemos qu√© son los datos MIDI.  En pocas palabras, esta es una secuencia de eventos musicales: presionar y soltar una tecla, presionar y soltar un pedal de sostenido, cambiar el tempo, el parche (instrumento virtual) y otros par√°metros.  Cada evento contiene un delta de tiempo desde el momento del evento anterior y datos, por ejemplo, intensidad de nota y tono.  El formato de archivo midi es muy simple: adem√°s de los encabezados y los datos en s√≠, pr√°cticamente no hay nada all√≠. <br><img src="https://habrastorage.org/webt/va/4r/jr/va4rjrzdye1cuhhufe1j5nvfdqk.jpeg"><br>  <i>El rosa es una nota sobre el evento.</i>  <i>El amarillo p√°lido es un delta del tiempo.</i>  <i>Azul: evento Note Off.</i> <br><br>  Intentemos buscar nuestros datos midi en el archivo SNG.  Para hacer esto, escriba una secuencia de varias notas en el sintetizador y exp√≥rtela a ambos formatos.  Porque  Como no sabemos d√≥nde est√°n exactamente los datos musicales en los archivos binarios, intentaremos repetir el proceso con diferentes secuencias de notas. <br><br>  En lo sucesivo, uso el editor hexadecimal Synalyze It!  Sus capacidades en el futuro nos ser√°n muy √∫tiles.  Mientras tanto, solo use la funci√≥n de comparaci√≥n binaria. <br><img src="https://habrastorage.org/webt/ap/rc/um/aprcumsiubha7hfzvasa3cbsxd0.jpeg"><br>  De hecho, solo el nombre de la "canci√≥n" coincidi√≥.  Comparando dos archivos SNG con diferentes secuencias de notas, podemos adivinar aproximadamente d√≥nde se almacenan exactamente los datos musicales, pero por ahora esto no nos ayudar√° de ninguna manera: el formato de datos es diferente.  El archivo en s√≠ es diez veces m√°s grande que el archivo Midi y parece contener mucha informaci√≥n adicional.  Puede ver la firma KORG en los primeros cuatro bytes y algunas otras l√≠neas, incluido el nombre de la "canci√≥n" y los nombres de los parches (tonos) asignados a las pistas. <br><br><h3>  Analizando la estructura de bloques de datos </h3><br>  Esto podr√≠a completarse si, afortunadamente, no hubiera herramientas que hicieran relativamente f√°cil analizar y comprender la estructura de los datos binarios.  El mismo programa Synalaze It! Nos ayudar√° con esto, que le permite crear y aplicar una "gram√°tica" para analizar archivos binarios. <br><br>  La gram√°tica es una estructura descriptiva jer√°rquica que le permite representar datos binarios en una forma legible para humanos.  El programa te permite descargar gram√°tica para algunos formatos.  Por ejemplo, para el mismo midi: <br><img src="https://habrastorage.org/webt/5j/fh/f1/5jfhf1mz0twm0_8pajoitnmcvxe.jpeg"><br>  Para el formato SNG, no se esperaba una gram√°tica preparada.  Bueno, veamos qu√© podemos extraer del archivo por nuestra cuenta. <br><br>  Comencemos con el titular.  Por lo general, esta parte contiene la firma del archivo, la informaci√≥n de la versi√≥n, los tama√±os y las compensaciones de los bloques de datos.  Despu√©s de comparar varios archivos SNG diferentes, encontramos las partes invariables y prestamos m√°s atenci√≥n a las que cambian <br><img src="https://habrastorage.org/webt/xp/dc/1i/xpdc1inosnksf1cl567lhuef62w.jpeg"><br>  Crea una estructura de t√≠tulo en el editor de gram√°tica.  Los primeros 4 bytes son obviamente la firma del archivo.  Suponga que los siguientes 4 bytes est√°n versionados.  Las siguientes decenas de bytes no cambian y no contienen nada interesante: crearemos para ellos datos binarios del tama√±o apropiado.  Pero entonces comienza la diversi√≥n.  Puede observar algunos patrones en el comportamiento de los bytes en las compensaciones 0x13 y 0x1b.  El segundo parece corresponder al n√∫mero de "canciones" en nuestro archivo.  Y el primero tambi√©n crece con la cantidad de datos en el encabezado: este parece ser el tama√±o, solo la cuenta regresiva no proviene del comienzo del archivo, sino del siguiente byte 0x14.  En esta etapa, solo podemos adivinar sobre el tipo de datos num√©ricos.  Supongamos que el tama√±o es del tipo UInt32, es decir  Toma 4 bytes.  Agr√©guelos a nuestra estructura.  Ahora podemos establecer el tama√±o de la estructura del encabezado (tama√±o + 20). <br><img src="https://habrastorage.org/webt/av/ad/kt/avadkttmovx2nj_aj1gqdlnvvsk.jpeg"><br><div class="spoiler">  <b class="spoiler_title">Gram√°tica con estructura de encabezado de archivo agregada</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ol/xd/lw/olxdlwqbmnyjybfbcrsvujibxta.jpeg"><br></div></div><br>  Veamos que viene despu√©s.  Si observa detenidamente, notar√° que las abreviaturas de tres letras est√°n dispersas por todo el archivo: SNG1, SDK1, SGS1, etc.  Estos caracteres se encuentran en todos los archivos SNG, por lo que podemos suponer que son firmas de ciertos bloques.  Adem√°s, nuestro t√≠tulo termin√≥ con mucho √©xito justo antes de una de estas firmas.  Compare el comportamiento de los siguientes 4 bytes en archivos de diferentes tama√±os.  Se puede ver que los valores aumentan con la cantidad creciente de datos. <br><img src="https://habrastorage.org/webt/kb/w-/4k/kbw-4kahz2btt_qwz-wd37pb-gu.jpeg"><br>  Algunos experimentos, an√°lisis y c√°lculos m√°s, y la siguiente imagen comienza a surgir: <br><br><img src="https://habrastorage.org/webt/ld/jn/iy/ldjniyrqi4s8a_n_unggs2-b0sq.jpeg"><br><br><div class="spoiler">  <b class="spoiler_title">Vista alternativa del gr√°fico</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/gj/tn/bv/gjtnbvwnqv4yr2nz0zdrl9irupg.jpeg"><br></div></div><br>  Por lo tanto, nuestro archivo consiste en una jerarqu√≠a de bloques bastante simple.  Hay bloques principales que pueden contener m√∫ltiples bloques secundarios.  Hay bloques de hojas (en la terminolog√≠a de los √°rboles binarios) que no contienen otros bloques. <br><br>  Entonces comienza la magia.  <b>Con solo unas pocas estructuras gramaticales, podemos analizar completamente la estructura del archivo de bloque</b> <br><br>  Por lo tanto, cree una estructura de plantilla DataChunk con los siguientes campos (el tama√±o se indica entre corchetes): <br><br>  id: cadena [4] <br>  tama√±o: Int [4] <br>  jerarqu√≠a: Int [4] <br>  datos: estructura <br><br>  Ahora cree una estructura parentChunk que herede DataChunk.  En la propiedad de la jerarqu√≠a, especifique el Valor fijo 0x400; este es un signo del bloque principal.  Aseg√∫rese de marcar la casilla Debe coincidir. <br><br>  Del mismo modo, crea childChunk.  La jerarqu√≠a en este caso tendr√° dos valores: 0x240100 y 0x100 <br><br>  Agregue referencias a las estructuras parentChunk y childChunk a la estructura de datos parentChunk, de esta manera creamos recursividad. <br><br>  Finalmente, agregue una referencia a la estructura parentChunk en el nodo principal. <br><img src="https://habrastorage.org/webt/jj/d3/gq/jjd3gq-5q330yazk-6q8fl1naa8.jpeg"><br>  El orden de los elementos en la estructura de datos de parentChunk debe ser Variable, tambi√©n es necesario establecer el n√∫mero m√≠nimo y m√°ximo de elementos secundarios de esta estructura: 0 e Ilimitado, respectivamente. <br><br>  Apliquemos los cambios y listo, nuestro archivo est√° muy bien analizado en los bloques principales. <br><img src="https://habrastorage.org/webt/ny/qx/pz/nyqxpztkqdknd1scoh63o28ezkq.jpeg"><br>  Todav√≠a no sabemos nada sobre los datos en s√≠, pero ahora podemos navegar mucho m√°s f√°cilmente en el archivo y centrarnos en encontrar la informaci√≥n que necesitamos. <br><br><h3>  Analizar un bloque que contiene una tabla de contenido de un archivo </h3><br>  Para el entrenamiento, intentemos analizar un bloque simple, por ejemplo, SDK1.  Aparentemente, contiene algo as√≠ como una tabla de contenido: una lista de canciones y probablemente algunos desplazamientos / tama√±os. <br><img src="https://habrastorage.org/webt/zr/-r/dq/zr-rdqiljqlnsflxebu5e2nx8q0.jpeg"><br>  Cree una estructura sdk1Chunk que herede childChunk.  Editaremos el campo ID, indicando la firma de nuestro bloque en el campo Valores fijos.  No se olvide de la casilla de verificaci√≥n Debe coincidir.  En los datos del bloque, se puede observar un patr√≥n repetitivo bastante obvio: el nombre de la "canci√≥n" y hasta ahora datos desconocidos.  Tenga en cuenta que el tama√±o de los fragmentos repetidos es de 64 bytes.  Adem√°s, al comparar las versiones de archivo con un n√∫mero diferente de "canciones", puede determinar que el n√∫mero se almacena en los primeros cuatro bytes.  Usando c√°lculos simples y haciendo varias suposiciones, obtenemos la siguiente versi√≥n de la estructura en la gram√°tica: <br><img src="https://habrastorage.org/webt/oo/mh/p3/oomhp3mjkz5pymbcxksszwdrn8w.jpeg"><br>  Aqu√≠ cre√© una estructura secundaria SongInfo de 64 bytes e indiqu√© la capacidad de repetir numSongs veces.  Aqu√≠ est√° el resultado de aplicar la gram√°tica: <br><img src="https://habrastorage.org/webt/0w/bi/th/0wbithoju1jbjec30hjxmo7tiwu.jpeg"><br>  El an√°lisis posterior de los archivos sigue siendo una cuesti√≥n t√©cnica.  Cambi√© la configuraci√≥n general de la "canci√≥n" y los par√°metros de pistas individuales en el sintetizador.  Al comparar versiones de archivos con varios cambios, puede mejorar y refinar la gram√°tica.  Despu√©s de un n√∫mero suficientemente grande de tales iteraciones, casi no hay datos no reconocidos en el archivo.  Me dej√© llevar por el proceso y resolv√≠ casi todas las secciones del archivo, aunque esto no era necesario para la tarea original. <br><br><div class="spoiler">  <b class="spoiler_title">Una peque√±a porci√≥n de la gram√°tica de un archivo SNG despu√©s de 8 horas de an√°lisis</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/td/zt/2b/tdzt2btswihzm3dxjubmbztvaa0.jpeg"><br></div></div><br>  Extra√±ar√© los detalles de este proceso; en el futuro nos centraremos en el an√°lisis de los datos musicales directamente. <br><br>  Pero m√°s sobre eso en la siguiente parte.  All√≠ nos encontraremos con una tarea interesante de conversi√≥n de datos (es bastante adecuada para entrevistas), trataremos de resolverla con un peque√±o script y escucharemos un resultado de conversi√≥n de prueba bastante inusual. <br><br><h3>  Resultados preliminares </h3><br>  La necesidad de ingenier√≠a inversa de archivos binarios puede ocurrir inesperadamente.  Por ejemplo, para analizar el firmware del dispositivo, convertir desde formatos de datos raros, analizar amenazas digitales o incluso modificar trivialmente los juegos guardados.  Las herramientas modernas le permiten resolver estos problemas de forma r√°pida y eficiente.  Hace unos 10 a√±os, estaba investigando el firmware de la computadora port√°til y este proceso podr√≠a llevar varias semanas.  Luego se requer√≠a escribir scripts manualmente para analizar bloques de datos y dise√±ar estructuras.  Con un nuevo enfoque parcialmente automatizado, cre√© una gram√°tica de archivo casi completa en solo un par de d√≠as. <br><br>  Puede comenzar el an√°lisis del archivo binario buscando cadenas: pueden dar las primeras pistas y acelerar el proceso de an√°lisis.  A menudo, los archivos binarios consisten en bloques de datos que est√°n organizados en una estructura jer√°rquica o lineal.  Si trata con esta estructura, un an√°lisis m√°s detallado ser√° mucho m√°s f√°cil.  El encabezado del archivo puede dar pistas sobre los desplazamientos / tama√±os de los bloques de datos.  En las primeras etapas, tiene sentido centrarse en la descripci√≥n de estructuras y bloques obvios.  La tarea de an√°lisis se simplifica enormemente por la capacidad de crear nuevas versiones de archivos con diferentes configuraciones, par√°metros, datos.  Hay una serie de dificultades asociadas con los tipos de datos desconocidos y el orden de los bytes en su representaci√≥n binaria (Endianness).  Nos referiremos a estas preguntas en la siguiente parte. <br><br><h3>  Lectura recomendada </h3><br>  Andreas Pehnack.  C√≥mo abordar el an√°lisis de formato de archivo binario </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/442580/">https://habr.com/ru/post/442580/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../442570/index.html">Sigma gobierna. Arte o nuevo est√°ndar para SOC</a></li>
<li><a href="../442572/index.html">Usar la herramienta de configuraci√≥n de Datapath</a></li>
<li><a href="../442574/index.html">Se crea la base para una teor√≠a generalizada de las redes neuronales.</a></li>
<li><a href="../442576/index.html">Larga vida a los overclockers: c√≥mo la refrigeraci√≥n l√≠quida comenz√≥ a dominar en los centros de datos</a></li>
<li><a href="../442578/index.html">Lanzamiento de Linux 5.0</a></li>
<li><a href="../442582/index.html">C√≥mo tratamos de mobbing</a></li>
<li><a href="../442584/index.html">Documentos sobre el edificio: peque√±as alegr√≠as de la automatizaci√≥n en el ejemplo de la Torre Oscura</a></li>
<li><a href="../442586/index.html">La vulnerabilidad en Telegram permite omitir la contrase√±a del c√≥digo local de cualquier longitud</a></li>
<li><a href="../442588/index.html">Haz una pregunta al autor de Lua</a></li>
<li><a href="../442590/index.html">Consejos y trucos forenses digitales: c√≥mo encontrar una conexi√≥n VPN activa en el volcado de memoria</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>