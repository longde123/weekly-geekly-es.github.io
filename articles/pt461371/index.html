<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèª‚Äç‚öñÔ∏è ü•ã üò∞ M√¥nada "Reader" atrav√©s de ass√≠ncrona / espera em C # üöì üôèüèº üìÖ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="No meu artigo anterior , descrevi como obter o comportamento da m√¥nada "Talvez" usando operadores async / wait . Desta vez, vou mostrar como implement...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>M√¥nada "Reader" atrav√©s de ass√≠ncrona / espera em C #</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461371/"><div style="text-align:center;"><img src="https://habrastorage.org/webt/jb/8f/kq/jb8fkqbv4lkkzgyy4j-66ykf9nu.jpeg"></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">No meu artigo anterior</a> , descrevi como obter o comportamento da m√¥nada "Talvez" usando operadores <strong>async / wait</strong> .  Desta vez, vou mostrar como implementar outro padr√£o de design popular "Reader Monad" usando as mesmas t√©cnicas. </p><br><p>  Esse padr√£o permite a passagem impl√≠cita de algum contexto para alguma fun√ß√£o sem o uso de par√¢metros de fun√ß√£o ou objetos globais compartilhados e pode ser considerado como mais uma maneira de implementar a inje√ß√£o de depend√™ncia.  Por exemplo: </p><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Config</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Template; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-keyword"><span class="hljs-keyword">await</span></span> GreetGuys().Apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Config {Template = <span class="hljs-string"><span class="hljs-string">"Hi, {0}!"</span></span>})); <span class="hljs-comment"><span class="hljs-comment">//(Hi, John!, Hi, Jose!) Console.WriteLine(await GreetGuys().Apply(new Config {Template = "¬°Hola, {0}!" })); //(¬°Hola, John!, ¬°Hola, Jose!) } //These functions do not have any link to any instance of the Config class. public static async Reader&lt;(string gJohn, string gJose)&gt; GreetGuys() =&gt; (await Greet("John"), await Greet("Jose")); static async Reader&lt;string&gt; Greet(string name) =&gt; string.Format(await ExtractTemplate(), name); static async Reader&lt;string&gt; ExtractTemplate() =&gt; await Reader&lt;string&gt;.Read&lt;Config&gt;(c =&gt; c.Template);</span></span></code> </pre> <a name="habracut"></a><br><h2 id="classic-reader">  "Leitor" cl√°ssico </h2><br><p>  Primeiro, vamos dar uma olhada em como a m√¥nada pode ser implementada sem operadores <strong>ass√≠ncronos / aguardados</strong> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Config</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Template; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ClassicReader</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> greeter = GreetGuys(); Console.WriteLine(greeter.Apply(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Config{Template = <span class="hljs-string"><span class="hljs-string">"Hello, {0}"</span></span>})); <span class="hljs-comment"><span class="hljs-comment">//(Hello, John, Hello, Jose) Console.WriteLine(greeter.Apply(new Config{Template = "¬°Hola, {0}!" })); //(¬°Hola, John!, ¬°Hola, Jose!) } public static Reader&lt;(string gJohn, string gJose), Config&gt; GreetGuys() =&gt; from toJohn in Greet("John") from toJose in Greet("Jose") select (toJohn, toJose); //Without using the query notation the code would look like this: //Greet("John") // .SelectMany( // toJohn =&gt; Greet("Jose"), // (toJohn, toJose) =&gt; (toJohn, toJose)) public static Reader&lt;string, Config&gt; Greet(string name) =&gt; new Reader&lt;string, Config&gt;(cfg =&gt; string.Format(cfg.Template, name)); }</span></span></code> </pre> <br><p>  <em>(Leitor)</em> </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>, <span class="hljs-title"><span class="hljs-title">TCtx</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;TCtx, T&gt; _exec; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Reader</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Func&lt;TCtx, T&gt; exec</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._exec = exec; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TCtx ctx</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._exec(ctx); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reader&lt;TJoin, TCtx&gt; SelectMany&lt;TIn, TOut, TCtx, TJoin&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> Reader&lt;TIn, TCtx&gt; source, Func&lt;TIn, Reader&lt;TOut, TCtx&gt;&gt; bind, Func&lt;TIn, TOut, TJoin&gt; <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>) =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader&lt;TJoin, TCtx&gt;(ctx =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> inValue = source.Apply(ctx); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outValue = bind(inValue).Apply(ctx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">join</span></span>(inValue, outValue); }); }</code> </pre> <br><p>  O c√≥digo funciona, mas n√£o parece natural para desenvolvedores de C #.  N√£o √© de admirar, porque as m√¥nadas vieram de linguagens funcionais, onde um c√≥digo semelhante pode ser escrito de uma maneira mais concisa.  No entanto, a implementa√ß√£o cl√°ssica ajuda a subestimar a ess√™ncia do padr√£o - em vez da execu√ß√£o imediata de algum c√≥digo, ele √© colocado em uma fun√ß√£o que ser√° chamada quando seu contexto estiver pronto. </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Reader&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">, Config&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Greet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Reader&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, Config&gt;(cfg =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(cfg.Template, name)); <span class="hljs-comment"><span class="hljs-comment">//That is how the code would look like with explicit passing of context: //public static string Greet(string name, Config cfg) // =&gt; string.Format(cfg.Template, name);</span></span></code> </pre> <br><p>  <strong>O SelectMany</strong> pode combinar v√°rias dessas fun√ß√µes em uma √∫nica, para que voc√™ possa criar uma sub-rotina cuja execu√ß√£o ser√° adiada at√© que seu contexto seja aplicado.  Por outro lado, essa abordagem se assemelha √† escrita de c√≥digo ass√≠ncrono em que a execu√ß√£o do programa √© interrompida se alguma opera√ß√£o ass√≠ncrona estiver em execu√ß√£o.  Quando um resultado da opera√ß√£o estiver pronto, a execu√ß√£o do programa continuar√°.  Sup√µe-se que a infraestrutura C # projetada para trabalhar com opera√ß√µes ass√≠ncronas ( <em><strong>ass√≠ncrona / aguardar</strong></em> ) possa ser de alguma forma utilizada na implementa√ß√£o da m√¥nada "Reader" e ... a suposi√ß√£o est√° correta! </p><br><h2 id="async-reader">  "Leitor" ass√≠ncrono </h2><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">No meu artigo anterior</a> , demonstrei como obter controle sobre operadores <strong>ass√≠ncronos / esperados</strong> usando <strong>tipos de retorno ass√≠ncrono generalizado</strong> .  A mesma t√©cnica ser√° usada dessa vez.  Vamos come√ßar com a classe "Reader", que ser√° usada como resultado do tipo de opera√ß√µes ass√≠ncronas: </p><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">AsyncMethodBuilder(typeof(ReaderTaskMethodBuilder&lt;&gt;))</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">INotifyCompletion</span></span>, <span class="hljs-title"><span class="hljs-title">IReader</span></span> { ...</code> </pre> <br><p>  A turma tem duas responsabilidades diferentes (teoricamente, poder√≠amos criar duas turmas): </p><br><ol><li>  Extrair algum valor de um contexto quando o contexto √© aplicado </li><li>  Cria√ß√£o de uma lista vinculada de inst√¢ncias do <strong>Reader</strong> que ser√£o usadas para distribuir um contexto por uma hierarquia de chamadas. </li></ol><br><p>  Para cada responsabilidade, usaremos um construtor separado: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> Func&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>, T&gt; _extractor; <span class="hljs-comment"><span class="hljs-comment">//1. Used to extract some value from a context public static Reader&lt;T&gt; Read&lt;TCtx&gt;(Func&lt;TCtx, T&gt; extractor) =&gt; new Reader&lt;T&gt;(ctx =&gt; extractor((TCtx)ctx)); private Reader(Func&lt;object, T&gt; exec) =&gt; this._extractor = exec; //2. Used by ReaderTaskMethodBuilder in a compiler generated code internal Reader() { }</span></span></code> </pre> <br><p>  Quando uma inst√¢ncia da classe <strong>Reader</strong> √© usada como argumento do operador <strong>wait</strong> , a inst√¢ncia receber√° um link para um delegado de continua√ß√£o, que deve ser chamado apenas quando um contexto de execu√ß√£o for resolvido e podemos extrair (do contexto) alguns dados que ser√£o usado na continua√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/8q/k2/u3/8qk2u3lwleoo6hfd55fzclhz1sa.png"></p><br><p>  Para criar conex√µes entre os "leitores" pai e filho, vamos criar o m√©todo: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IReader _child; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetChild</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IReader reader</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child = reader; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child.SetCtx(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx); } }</code> </pre> <br><p>  que ser√° chamado dentro do <strong>ReaderTaskMethodBuilder</strong> : </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReaderTaskMethodBuilder</span></span>&lt;<span class="hljs-title"><span class="hljs-title">T</span></span>&gt; { ... <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> GenericAwaitOnCompleted&lt;TAwaiter, TStateMachine&gt;( <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TAwaiter awaiter, <span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> TStateMachine stateMachine) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TAwaiter : INotifyCompletion <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TStateMachine : IAsyncStateMachine { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (awaiter <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> IReader reader) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Task.SetChild(reader); } awaiter.OnCompleted(stateMachine.MoveNext); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Reader&lt;T&gt; Task { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } }</code> </pre> <br><p>  Dentro do m√©todo <strong>SetChild</strong> , chamamos <strong>SetCtx,</strong> que propaga um contexto para uma hierarquia e chama um extrator, se definido: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCtx</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ctx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx = ctx; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._child?.SetCtx(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._extractor != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetResult(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._extractor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._ctx)); } } }</code> </pre> <br><p>  <strong>SetResult</strong> armazena um valor extra√≠do de um contexto e chama uma continua√ß√£o: </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">T result</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._result = result; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.IsCompleted = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>._continuation?.Invoke(); }</code> </pre> <br><p>  No caso em que uma inst√¢ncia do <strong>Reader</strong> n√£o possui um "extrator" inicializado, ent√£o <strong>SetResult</strong> deve ser chamado pelo <strong>ReaderTaskMethodBuilder</strong> quando uma m√°quina de estado gerada chega ao seu estado final. </p><br><p>  <strong>O</strong> m√©todo <strong>Apply</strong> chama apenas <strong>SetCtx</strong> </p><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Reader&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Apply</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> ctx</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.SetCtx(ctx); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; }</code> </pre> <br><p>  <a href="">Voc√™ pode encontrar todo o c√≥digo no github ( <em>se ainda n√£o estiver bloqueado</em> )</a> </p><br><p>  Agora, quero mostrar um exemplo mais realista de como o <strong>Reader</strong> ass√≠ncrono pode ser usado: </p><br><div class="spoiler">  <b class="spoiler_title">Clique para expandir o exemplo</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReaderTest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Configuration</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> DataBaseId; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> GreetingTemplate; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NameFormat; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Configuration</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> dataBaseId, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> greetingTemplate, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nameFormat</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.DataBaseId = dataBaseId; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.GreetingTemplate = greetingTemplate; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.NameFormat = nameFormat; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[] ids = { <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span> }; Configuration[] configurations = { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"Congratulations, {0}! You won {1}$!"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0} {1}"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Configuration(<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">"¬°Felicidades, {0}! Ganaste {1} $"</span></span>, <span class="hljs-string"><span class="hljs-string">"{0}"</span></span>), }; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configuration <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> configurations) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userId <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ids) { <span class="hljs-comment"><span class="hljs-comment">//The logic receives only a single explicit parameter - userId var logic = GetGreeting(userId); //The rest of parameters (database Id, templates) can be passed implicitly var greeting = await logic.Apply(configuration); Console.WriteLine(greeting) } } //Congratulations, John Smith! You won 110$! //Congratulations, Mary Louie! You won 30$! //Congratulations, Louis Slaughter! You won 47$! //¬°Felicidades, John! Ganaste 110 $ //¬°Felicidades, Mary! Ganaste 30 $ //¬°Felicidades, Louis! Ganaste 47 $ } private static async Reader&lt;string&gt; GetGreeting(int userId) { var template = await Reader&lt;string&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.GreetingTemplate); var fullName = await GetFullName(userId); var win = await GetWin(userId); return string.Format(template, fullName, win); } private static async Reader&lt;string&gt; GetFullName(int userId) { var template = await Reader&lt;string&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.NameFormat); var firstName = await GetFirstName(userId); var lastName = await GetLastName(userId); return string.Format(template, firstName, lastName); } private static async Reader&lt;string&gt; GetFirstName(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetFirstName(userId); } private static async Reader&lt;string&gt; GetLastName(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetLastName(userId); } private static async Reader&lt;int&gt; GetWin(int userId) { var dataBase = await GetDataBase(); return await dataBase.GetWin(userId); } private static async Reader&lt;Database&gt; GetDataBase() { var dataBaseId = await Reader&lt;int&gt;.Read&lt;Configuration&gt;(cfg =&gt; cfg.DataBaseId); return Database.ConnectTo(dataBaseId); } } public class Database { public static Database ConnectTo(int id) { if (id == 100) { return new Database(); } throw new Exception("Wrong database"); } private Database() { } private static readonly (int Id, string FirstName, string LastName, int Win)[] Data = { (1, "John","Smith", 110), (2, "Mary","Louie", 30), (3, "Louis","Slaughter", 47), }; public async Task&lt;string&gt; GetFirstName(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).FirstName; } public async Task&lt;string&gt; GetLastName(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).LastName; } public async Task&lt;int&gt; GetWin(int id) { await Task.Delay(50); return Data.Single(i =&gt; i.Id == id).Win; } }</span></span></code> </pre> </div></div><br><p>  O programa mostra cumprimentos para alguns usu√°rios, mas n√£o sabemos seus nomes com anteced√™ncia, pois temos apenas seus IDs; portanto, precisamos ler essas informa√ß√µes em um "banco de dados".  Para conectar-se ao banco de dados, precisamos conhecer algum identificador de conex√£o e, para criar uma sauda√ß√£o, precisamos de seu modelo e ... todas as informa√ß√µes s√£o passadas implicitamente atrav√©s do <strong>leitor</strong> ass√≠ncrono. </p><br><h2 id="dependency-injection-with-async-reader">  Inje√ß√£o de depend√™ncia com o "Leitor" ass√≠ncrono </h2><br><p>  Em compara√ß√£o com a implementa√ß√£o cl√°ssica, o leitor ass√≠ncrono tem uma falha - n√£o podemos especificar um tipo de contexto passado.  Essa limita√ß√£o vem do fato de o compilador C # esperar apenas um √∫nico par√¢metro de tipo gen√©rico em uma classe de construtor de m√©todo ass√≠ncrono (talvez seja corrigido no futuro). </p><br><p>  Por outro lado, n√£o acho que seja cr√≠tico, pois na vida real, provavelmente, algum cont√™iner de inje√ß√£o de depend√™ncia ser√° passado como um contexto: </p><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Reader</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Reader&lt;TService&gt; GetService&lt;TService&gt;() =&gt; Reader&lt;TService&gt;.Read&lt;IServiceProvider&gt;(serviceProvider =&gt; (TService)serviceProvider .GetService(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(TService))); }</code> </pre> <br><pre> <code class="cs hljs">... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Reader&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Greet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> userName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> service = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Reader.GetService&lt;IGreater&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> service.GreetUser(userName); } ...</code> </pre> <br><p>  <a href="">( <em>aqui voc√™ pode encontrar um exemplo completo ...</em> )</a> </p><br><p>  Diferente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ass√≠ncrono "Talvez"</a> , que eu n√£o recomendo usar em nenhum c√≥digo de produ√ß√£o (por causa do problema com <strong>finalmente os</strong> blocos), consideraria o uso do <strong>leitor</strong> ass√≠ncrono em projetos reais como uma substitui√ß√£o (ou "al√©m de") do abordagem tradicional de inje√ß√£o de depend√™ncia (quando todas as depend√™ncias s√£o passadas para um construtor de classe), pois o <strong>Reader</strong> tem algumas vantagens: </p><br><ol><li>  N√£o h√° necessidade nas propriedades de classe que armazenam links para recursos injetados.  Na verdade, n√£o h√° necessidade de classes - toda a l√≥gica pode ser implementada em m√©todos est√°ticos. </li><li>  O uso do <strong>Reader</strong> incentivar√° a cria√ß√£o de c√≥digo sem bloqueio, pois todos os m√©todos ser√£o ass√≠ncronos e nada impedir√° que os desenvolvedores usem vers√µes sem bloqueio de opera√ß√µes de entrada / sa√≠da. </li><li>  O c√≥digo ser√° um pouco mais "leg√≠vel" - sempre que virmos o <strong>Reader</strong> como resultado de algum m√©todo, saberemos que ele requer acesso a algum contexto impl√≠cito. </li><li>  O <strong>leitor</strong> ass√≠ncrono n√£o usa reflex√£o. </li></ol><br><p>  √â claro que pode haver alguns argumentos contra o uso do <strong>Reader,</strong> mas, de qualquer forma, o principal objetivo desses artigos √© mostrar como os padr√µes, que foram inicialmente projetados para linguagens funcionais, podem ser adotados para o estilo imperativo de codifica√ß√£o, que se acredita ser mais simples. entender pela maioria das pessoas. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt461371/">https://habr.com/ru/post/pt461371/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt461359/index.html">Localiza√ß√£o geogr√°fica e geolocaliza√ß√£o: mega-ferramenta</a></li>
<li><a href="../pt461361/index.html">Maior e mais poderoso: como garantimos a opera√ß√£o de novos equipamentos no data center MediaTek</a></li>
<li><a href="../pt461363/index.html">Chaleira e assistentes de voz. O come√ßo de uma grande amizade</a></li>
<li><a href="../pt461365/index.html">Dominar a vis√£o computacional - 8 etapas b√°sicas</a></li>
<li><a href="../pt461367/index.html">Como um graduado em Fiztekh abriu a maior escola de programa√ß√£o na Arm√™nia</a></li>
<li><a href="../pt461373/index.html">GoLand 2019.2: suporte para chamadas de fun√ß√£o durante a depura√ß√£o, esquemas de cores aprimorados, conclus√£o personalizada do Postfix</a></li>
<li><a href="../pt461379/index.html">Museum DataArt. Modems da US Robotics</a></li>
<li><a href="../pt461381/index.html">O anonimato √© uma ilus√£o. De acordo com dados de conjuntos de dados an√¥nimos, voc√™ pode identificar pessoas reais</a></li>
<li><a href="../pt461385/index.html">Vinho e ratos: o uso do resveratrol para restaurar m√∫sculos sob a gravidade marciana</a></li>
<li><a href="../pt461387/index.html">Do cl√°ssico e modernismo √† fantasia e steampunk - o que os administradores de sistema leem</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>