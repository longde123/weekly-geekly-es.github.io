<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë©‚Äçüë¶ ü§æ ü§≥üèæ Reverse Engineering Fantastic Dizzy ü§∏üèº üí¥ ü§ûüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Fantastic Dizzy est un jeu de plateforme puzzle cr√©√© en 1991 par Codemasters. Elle fait partie de la s√©rie Dizzy . Malgr√© le fait que la s√©rie Dizzy s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Reverse Engineering Fantastic Dizzy</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436674/">  Fantastic Dizzy est un jeu de plateforme puzzle cr√©√© en 1991 par Codemasters.  Elle fait partie de la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">s√©rie Dizzy</a> .  Malgr√© le fait que la s√©rie Dizzy soit toujours populaire et qu'elle cr√©e des jeux amateurs ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Dizzy Age</a> ), il semble que personne n'ait √©t√© impliqu√© dans le d√©veloppement inverse des jeux originaux. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/466/2bd/953/4662bd9537c41cceb388a841523b8669.png"></div><br>  J'ai √©crit quelques outils simples pour extraire, visualiser et empaqueter les ressources du jeu original.  Outils publi√©s sur <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GitHub</a> . <br><br><h2>  D√©ballage EXE </h2><br>  Le fichier binaire PCDIZZY.EXE est conditionn√© au format Microsoft <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">EXEPack</a> .  Bien qu'il existe de nombreux outils Linux capables de d√©compresser de tels ex√©cutables, aucun ne semble prendre en charge la version utilis√©e pour Fantastic Dizzy.  Par cons√©quent, pour d√©compresser le fichier ex√©cutable, j'ai utilis√© la version DOS d' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">UNP</a> .  Apr√®s avoir d√©ball√© le fichier ex√©cutable, il pourrait √™tre t√©l√©charg√© sur l'IDA.  De mani√®re pratique, la version d√©compress√©e du fichier binaire fonctionnait toujours bien, elle pouvait donc √™tre d√©bogu√©e √† l'aide du d√©bogueur DOSBox. <br><a name="habracut"></a><br><h2>  Fichiers de donn√©es </h2><br>  Il y a deux fichiers de donn√©es dans le jeu: DIZZY.NDX et DIZZY.RES.  Les extensions, ainsi que la taille des fichiers, nous donnent un indice sur ce qu'elles peuvent contenir.  Le fichier NDX est d'environ 8 Ko et le fichier RES d'environ 800 Ko.  Puisque le jeu est √©crit en C, nous pouvons rechercher des appels fopen dans l'IDA pour voir o√π les fichiers de donn√©es s'ouvrent.  Dans les jeux DOS √©crits en assembleur, vous devez pour cela rechercher les instructions en 21h (pour ouvrir le fichier ah = 3d).  Le binaire Dizzy contient une fonction wrapper autour de fopen qui vous permet de sp√©cifier le nom principal et l'extension de fichier.  Cela nous am√®ne au bloc de code suivant: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d50/2a5/cdc/d502a5cdc3e09675a1edf6aac432ecc5.png"></div><br>  Il charge les fichiers DIZZY.RES et DIZZY.NDX et enregistre √©galement les pointeurs de fichier dans des variables globales.  Lors de l'ing√©nierie inverse des binaires DOS, un probl√®me g√™nant se pose: les registres qu'ils contiennent sont de 16 bits, mais les pointeurs dans certains cas peuvent √™tre de 32 bits.  Ici, les pointeurs FILE * ont une taille de 32 bits et sont renvoy√©s de do_open_file √† ax: dx.  Notez que les cha√Ænes sont √©galement des pointeurs 32 bits et dizzy_basename est pass√© √† la fonction appelante sur la pile (et cette auto-analyse IDA confuse - elle √©tait consid√©r√©e comme un argument de mode pour fopen). <br><br>  En recherchant les occurrences de g_dizzy_res / ndx dans les xr√©fs, vous pouvez trouver o√π les fichiers sont lus.  √Ä ce stade, le d√©bogueur DOSBox est utile car il existe une forte probabilit√© de nombreuses op√©rations de lecture de fichiers al√©atoires, et l'utilisation d'un IDA pour d√©terminer les d√©calages de lecture serait un processus assez monotone.  De bons conseils sur la construction et l'utilisation du d√©bogueur DOSBox peuvent √™tre trouv√©s <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">ici</a> . <br><br>  Lorsque vous utilisez l'IDA et le d√©bogueur DOSBox ensemble, il devient √©vident que le fichier NDX est utilis√© comme index pour le fichier RES.  Chaque entr√©e du fichier NDX prend 16 octets;  il stocke l'identifiant du fragment, sa taille et son d√©calage dans le fichier RES.  En regardant comment les donn√©es RES sont lues, vous pouvez voir que l'octet d'indicateur est d'abord v√©rifi√© dans le fichier NDX.  Si le bit 0x80 n'est pas d√©fini, les donn√©es sont lues directement √† partir du fichier RES, sinon un chemin de code plus complexe est ex√©cut√©.  L'indicateur est d√©fini pour la plupart des fragments, donc avec un haut degr√© de probabilit√©, nous pouvons supposer qu'il d√©note une sorte de compression utilis√©e pour ces fragments. <br><br><h2>  La compression </h2><br>  Le chemin de compression commence par lire dans la base du fragment RES deux mots de 32 bits indiquant les tailles initiale et finale, puis la fonction de d√©compression est appel√©e.  En 1991, l'encodage de longueur simple (RLE) et la compression de dictionnaire √©taient populaires, comme divers algorithmes Liv-Zempel.  Le d√©but du cycle de d√©ballage ressemble √† ceci: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/244/d0e/e15/244d0ee1533c6191ad5b6aed18b97081.png"></div><br>  Les jetons de d√©compression sont obtenus √† l'aide de la fonction get_next_token, qui lit la partie suivante des donn√©es source dans ax: dx avec un d√©calage de cl.  Le registre cl est utilis√© comme position du d√©calage binaire, revenant √† z√©ro apr√®s avoir atteint huit.  Au d√©but du cycle, le jeton est lu et le bit inf√©rieur est v√©rifi√©.  Si l'indicateur est d√©fini, le code est simple: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c43/1cb/a2b/c431cba2b710290e6dab47b4b711b6d1.png"></div><br>  Il enregistre simplement l'octet en cours, re√ßoit le jeton suivant et continue de fonctionner.  Si l'indicateur est effac√©, un chemin de code plus long est s√©lectionn√©, qui se termine par l'instruction rep movsb.  Cela indique qu'une sorte de dictionnaire est utilis√© en compression. <br><br>  L'algorithme de compression est int√©ressant pour plusieurs raisons.  Premi√®rement, il utilise un codage √† longueur de bit variable.  La valeur absolue est cod√©e sous la forme d'un indicateur et d'une valeur de donn√©es de 8 bits.  Curieusement, le train de bits est cod√© comme un petit endian.  Cela complique un peu l'analyse de la d√©compression en observant le fichier RES dans un √©diteur hexad√©cimal.  Par exemple, si les trois premiers octets d'un fragment sont cod√©s en valeurs absolues, les donn√©es sont organis√©es comme suit: <br><br><pre> <code class="hljs">: AAAAAAAA BBBBBBBB CCCCCCCC DDDDDDDD  1: 6543210F 7  2: 543210F 76  3: 43210F 765</code> </pre> <br>  De plus, le d√©compresseur peut sauter l'octet lors de la lecture, si le compteur cl revient √† z√©ro lors de la r√©ception du jeton suivant.  Je ne sais pas s'il s'agit d'optimisation, ou d'un bug, ou d'un hack cr√©√© par le d√©veloppeur du jeu pour r√©soudre le probl√®me avec mes outils. <br><br>  Si l'indicateur est effac√©, le d√©compresseur effectue une copie √† partir de la partie initiale des donn√©es d√©compress√©es.  Dans ce cas, les bits suivants codent la longueur et le d√©calage √† partir desquels copier.  Le d√©calage est cod√© en 10 ou 13 bits, et l'option souhait√©e indique le drapeau.  Cela semble √™tre un choix tr√®s √©trange, car cela complique un peu le code et, au mieux, enregistre seulement 2 bits. <br><br>  Encoder la longueur de la s√©rie semble un peu √©trange.  Le d√©compresseur lit les bits jusqu'√† ce qu'il atteigne le bit z√©ro.  Ensuite, le nombre de bits utilis√©s pour coder la longueur est de deux plus le nombre de bits non nuls.  Par exemple, lors du codage d'une longueur de 58 (0x3a), le flux binaire ressemble √† ceci: <br><br><pre> <code class="hljs">11110 111010</code> </pre> <br>  Le codage n√©cessite 11 bits.  Les petites longueurs sont mieux cod√©es car la longueur minimale des bits est 2. La copie de longueurs jusqu'√† 3 ne n√©cessite que 3 bits pour coder, jusqu'√† 7 n√©cessite 5 bits, etc.  Je ne sais pas avec certitude si ce type de codage est une technique courante. <br><br>  Le d√©bogueur DOSBox est √©galement tr√®s utile pour reconstruire l'algorithme de d√©compression.  Si vous ne savez pas √† quoi devraient ressembler les donn√©es d√©compress√©es, il est difficile de comprendre si le d√©compresseur fonctionne correctement.  √Ä l'aide du d√©bogueur, vous pouvez parcourir l'int√©gralit√© de l'algorithme de d√©compression et enregistrer un vidage de la m√©moire non compress√©e pour comparaison. <br><br>  Une autre fonctionnalit√© utile est l'indicateur dans le fichier NDX, indiquant que la ressource est compress√©e.  √âtant donn√© que le jeu original prend en charge les ressources non compress√©es, nous pouvons reconditionner le fichier RES sans avoir besoin d'un algorithme de compression.  La modification et le reconditionnement de fragments avec le lancement ult√©rieur du jeu est un bon moyen de tester nos hypoth√®ses sur les formats de donn√©es. <br><br><h2>  Niveaux </h2><br>  Fantastic Dizzy est un jeu avec un monde ouvert.  Les niveaux sont des zones avec d√©filement vertical ou horizontal.  Le joueur se d√©place entre les niveaux, atteignant la fin du niveau ou entrant et sortant des b√¢timents.  Bien que les r√©f√©rences aux fragments dans le fichier RES soient faites via des identifiants (ID) 16 bits, le fichier binaire du jeu contient en fait une table de noms de niveaux correspondants avec des identifiants de fragments.  Chaque niveau se compose de plusieurs fragments: un titre, une ou plusieurs couches, un jeu de tuiles et une palette.  Il y a peu de redondance ici, car certains niveaux utilisent la m√™me palette et le m√™me jeu de tuiles, mais ne r√©utilisent pas les m√™mes fragments, de sorte que le fichier RES contient de nombreuses ressources en double. <br><br>  Les couches codent les tuiles pour un niveau.  Pour diff√©rentes parties du monde ou pour les calques d'arri√®re-plan, vous pouvez utiliser des calques suppl√©mentaires.  Par exemple, au niveau de tree1.stg, il existe huit couches pour diff√©rentes parties de la cime des arbres et une couche d'arri√®re-plan commune.  Cependant, les niveaux sous-marins sont divis√©s en sea1.stg et sea2.stg, chacun ayant une couche de premier plan et une couche d'arri√®re-plan. <br><br>  Les couches d'arri√®re-plan sont des arri√®re-plans √† largeur fixe sans d√©filement, par exemple, une for√™t dans une partie d'un jeu avec des cimes d'arbre.  Les tuiles de premier plan et d'arri√®re-plan, situ√©es devant et derri√®re le personnage, sont encod√©es dans le m√™me calque que les tuiles sur lesquelles vous pouvez marcher.  Par exemple, la capture d'√©cran montre le niveau depuis le sommet des arbres depuis le d√©but du jeu: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/466/2bd/953/4662bd9537c41cceb388a841523b8669.png"></div><br>  <i>Niveau de la cime des arbres</i> <br><br>  Il s'agit de la septi√®me couche de tree1.stg: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f5b/240/54a/f5b24054aa7e9ff6abb055a47c069109.png"></div><br>  <i>Arbre de niveau septi√®me couche1.stg</i> <br><br>  Il est √† noter que le joueur peut passer devant la cabane, mais derri√®re deux arbres.  Toutes les informations sur les tuiles sont contenues dans un tableau de cartes de tuiles situ√© dans une couche.  Les tuiles dans les fragments de la couche sont cod√©es sur deux octets, et les 9 bits inf√©rieurs sont utilis√©s pour l'index des tuiles.  Je n'ai pas bien compris les bits sup√©rieurs, mais au moins ils contiennent des informations sur le d√©calage de la palette pour la tuile et, probablement, des informations sur les collisions. <br><br>  En tant que niveaux dans le jeu, des cin√©matiques, des portraits de personnages et un √©cran de contr√¥le d'inventaire sont √©galement stock√©s.  Il semble que cette technique soit standard pour les jeux DOS, probablement parce qu'elle minimise la quantit√© de code n√©cessaire. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/39a/4f6/1e9/39a4f61e972a82f34d44f5d5781345ad.png"></div><br>  <i>"Niveau" de gestion des stocks</i> <br><br><h2>  Sprites </h2><br>  Le format sprite n'est pas particuli√®rement int√©ressant.  Chaque image-objet est une image bitmap avec un octet par pixel, mais avec seulement 16 couleurs par image-objet.  L'utilisation d'un nombre limit√© de couleurs √©tait une technique courante √† l'√®re du VGA 256 couleurs, car pour les sprites, il √©tait facile d'effectuer un changement de palette ou de les utiliser √† des niveaux avec d'autres palettes;  en outre, il a √©conomis√© l'espace allou√© aux sprites. <br><br>  Les sprites ont des tailles diff√©rentes, donc un fragment s√©par√© contient des informations sur la taille du sprite et leurs d√©placements en x et y.  Les sprites sont regroup√©s en ensembles, mais le regroupement semble assez arbitraire.  Par exemple, un ensemble de sprites contient des graphiques d'√©conomiseur d'√©cran, des objets d'inventaire, ainsi que certains personnages non joueurs.  Cela rend la visualisation des ensembles de sprites un peu d√©licate car la palette n'est pas la m√™me pour tous les sprites. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/107/fa0/1a2/107fa01a2c5bbd0ecd53df2ba4e70b43.png"></div><br>  <i>Sprites de personnage de joueur</i> <br><br><h2>  Que reste-t-il? </h2><br>  Il reste √† inverser l'ing√©nierie de quelques autres choses.  La plupart du temps, je m'int√©resse aux formats de fichiers de donn√©es, mais il y a certains aspects que je ne comprends pas: <br><br><ul><li>  O√π sont les emplacements des objets (cl√©s, fruits, etc.).  Il semble qu'ils ne soient pas √©crits en fragments de niveau.  Peut-√™tre qu'ils sont stock√©s dans le fichier binaire du jeu, car le joueur peut ramasser un objet sur un niveau et le lancer sur un autre. </li><li>  Fonctionnement des collisions de niveau.  Un joueur peut marcher devant ou derri√®re certaines tuiles, et les sols peuvent √™tre plats ou en pente. </li><li>  Comment les niveaux sont connect√©s.  Ces informations peuvent √™tre stock√©es dans le binaire du jeu. </li><li>  Le d√©calage de la palette des tuiles aux niveaux n'est pas enti√®rement correct.  Certaines tuiles affichent des couleurs incorrectes. </li><li>  Chaque ensemble de sprites a trois fragments: en-t√™te, table et donn√©es.  Les fragments avec une table et des donn√©es sont clairs pour moi, mais certaines informations sur les sprites sont incluses dans l'en-t√™te, par exemple, le d√©calage par x et y.  Je n'ai pas compl√®tement compris son format. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr436674/">https://habr.com/ru/post/fr436674/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr436660/index.html">La feuille de route VS Code 2019 - PROJET</a></li>
<li><a href="../fr436662/index.html">1er f√©vrier 2019, votre site peut cesser de fonctionner</a></li>
<li><a href="../fr436664/index.html">Pr√©sentation de la s√©rie .NET Community Standup</a></li>
<li><a href="../fr436668/index.html">Les statistiques peuvent-elles √™tre lues avec une petite quantit√© de donn√©es?</a></li>
<li><a href="../fr436670/index.html">Comment rouler automatiquement les mises √† jour en production</a></li>
<li><a href="../fr436676/index.html">Comment faire DDoS dans tout le pays</a></li>
<li><a href="../fr436682/index.html">Ne cr√©ez pas votre propre JL (DSL) pour √©tendre les fonctionnalit√©s de l'application</a></li>
<li><a href="../fr436684/index.html">Anniversaire Android 10 (Q). Que sait-on maintenant?</a></li>
<li><a href="../fr436686/index.html">JPEG du monde 3D. Qu'est-ce que glTF?</a></li>
<li><a href="../fr436688/index.html">Le g√©ant informatique quitte le march√© des puces pour les centres de donn√©es - dites-nous ce que cela signifie pour l'industrie</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>