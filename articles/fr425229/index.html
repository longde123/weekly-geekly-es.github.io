<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏝️ 👩🏾‍🏫 🎞️ Comment nous avons aidé CDN MegaFon.TV à ne pas participer à la Coupe du monde 2018 👨🏿‍💼 🚴🏻 👃🏻</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="En 2016, nous avons parlé de la façon dont MegaFon.TV a fait face à tous ceux qui voulaient regarder la nouvelle saison de Game of Thrones. Le dévelop...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment nous avons aidé CDN MegaFon.TV à ne pas participer à la Coupe du monde 2018</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/megafon/blog/425229/">  En 2016, nous avons parlé de la façon dont MegaFon.TV a fait face à tous ceux qui voulaient regarder la nouvelle saison de Game of Thrones.  Le développement du service ne s'est pas arrêté là, et à la mi-2017, nous devions faire face à des charges plusieurs fois plus.  Dans cet article, nous expliquerons comment une croissance aussi rapide nous a inspiré à changer radicalement l'approche de l'organisation du CDN et comment cette nouvelle approche a été testée par la Coupe du monde. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a42/af2/54b/a42af254b7c4d8528fb0d495c27ab6d9.png"><br><a name="habracut"></a><br><h2>  En bref sur MegaFon.TV </h2><br>  MegaFon.TV est un service OTT pour visualiser divers contenus vidéo - films, émissions de télévision, chaînes de télévision et programmes enregistrés.  Grâce à MegaFon.TV, l'accès au contenu peut être obtenu sur pratiquement n'importe quel appareil: sur les téléphones et tablettes avec iOS et Android, sur les téléviseurs intelligents LG, Samsung, Philips, Panasonic de différentes années de sortie, avec tout un zoo OS (Apple TV, Android TV), dans navigateurs de bureau sous Windows, MacOS, Linux, dans les navigateurs mobiles sur iOS et Android, et même sur des appareils exotiques tels que STB et les projecteurs Android pour enfants.  Il n'y a pratiquement aucune restriction sur les appareils - seule la disponibilité d'Internet avec une bande passante de 700 Kbps est importante.  À propos de la façon dont nous avons organisé la prise en charge de tant d'appareils, il y aura un article distinct à l'avenir. <br>  La plupart des utilisateurs du service sont des abonnés MegaFon, ce qui s’explique par des offres rentables (et le plus souvent même gratuites) incluses dans le plan tarifaire de l’abonné.  Bien que nous notons également une augmentation significative du nombre d'utilisateurs d'autres opérateurs.  Conformément à cette distribution, 80% du trafic MegaFon.TV est consommé au sein du réseau MegaFon. <br><br>  Sur le plan architectural, depuis le lancement du service, le contenu a été distribué via CDN.  Nous avons un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">poste</a> séparé dédié au travail de ce CDN.  Dans ce document, nous avons expliqué comment cela nous a permis de gérer le trafic de pointe qui est allé au service fin 2016, lors de la sortie de la nouvelle saison de Game of Thrones.  Dans cet article, nous parlerons du développement ultérieur de MegaFon.TV et des nouvelles aventures qui sont tombées sur le service avec la Coupe du Monde 2018. <br><br><h2>  Croissance des services.  Et des problèmes </h2><br>  Par rapport aux événements du dernier message, fin 2017, le nombre d'utilisateurs de Megafon.TV a augmenté à plusieurs reprises, les films et les séries sont également devenus un ordre de grandeur plus important.  De nouvelles fonctionnalités ont été lancées, de nouveaux packages sont apparus, disponibles «par abonnement».  Les pics de trafic depuis le «Game of Thrones» que nous voyons aujourd'hui chaque jour, la proportion de films et d'émissions de télévision dans le flux total n'a cessé d'augmenter. <br><br>  Parallèlement à cela, des problèmes ont commencé avec la redistribution du trafic.  Notre surveillance, configurée pour télécharger des segments pour différents types de trafic dans différents formats, a de plus en plus commencé à produire des erreurs lors du téléchargement de segments vidéo par timeout.  Dans le service MegaFon.TV, la longueur du morceau est de 8 secondes.  Si le bloc n'a pas le temps de se charger en 8 secondes, des erreurs peuvent se produire. <br><br>  Le pic d'erreurs devait survenir aux heures les plus chargées.  Comment cela devrait-il affecter les utilisateurs?  Au minimum, ils ont pu observer une détérioration de la qualité vidéo.  Il n'est pas toujours perceptible à l'œil nu, en raison d'un nombre suffisamment important de profils multi-bitrate.  Dans le pire des cas, la vidéo se fige. <br><br>  La recherche du problème a commencé.  Presque immédiatement, il est devenu clair qu'une erreur de rebond se produit sur les serveurs EDGE de CDN.  Ici, nous devons faire une petite digression et dire comment les serveurs fonctionnent avec le trafic en direct et VOD.  Le schéma est un peu différent.  Un utilisateur qui vient sur le serveur EDGE pour du contenu (une liste de lecture ou un morceau), s'il y a du contenu dans le cache, le récupère à partir de là.  Sinon, le serveur EDGE recherche du contenu sur Origin, en chargeant le canal principal.  Avec une liste de lecture ou un morceau, l'en <b>-</b> tête <b>Cache-Control: max-age</b> est donné, qui indique au serveur EDGE combien de cache une unité de contenu particulière.  La différence entre LIVE et VOD réside dans le temps nécessaire pour mettre en cache des morceaux.  Pour les morceaux en direct, une courte durée de mise en cache est définie, généralement de 30 secondes à plusieurs minutes - cela est dû au court temps de pertinence du contenu en direct.  Ce cache est stocké dans la RAM, car vous devez constamment donner des morceaux et réécrire le cache.  Pour les morceaux VOD, plus de temps est défini, de plusieurs heures à des semaines et même des mois - en fonction de la taille de la bibliothèque de contenu et de la répartition de ses vues entre les utilisateurs.  Quant aux listes de lecture, elles sont généralement mises en cache en moins de deux secondes, ou elles ne le sont pas du tout.  Il convient de préciser que nous ne parlons que du soi-disant mode PULL de CDN, dans lequel nos serveurs fonctionnaient.  L'utilisation du mode PUSH dans notre cas ne serait pas entièrement justifiée. <br><br>  Mais revenons à trouver le problème.  Comme nous l'avons déjà remarqué, tous les serveurs ont simultanément travaillé sur le retour des deux types de contenus.  Dans le même temps, les serveurs eux-mêmes avaient une configuration différente.  En conséquence, certaines machines ont été surchargées à l'aide d'IOPS.  Les morceaux n'ont pas eu le temps d'écrire / lire en raison des faibles performances, de la quantité, du volume des disques et de la grande bibliothèque de contenu.  D'un autre côté, les machines plus puissantes qui ont reçu plus de trafic ont commencé à échouer lors de l'utilisation du processeur.  Les ressources CPU ont été dépensées pour la maintenance du trafic SSL et des morceaux fournis via https, tandis que les IOPS sur les disques ont à peine atteint 35%. <br><br>  Ce qu'il fallait, c'était un schéma qui, à moindre coût, permettrait d'utiliser de façon optimale les capacités disponibles.  De plus, six mois plus tard, la Coupe du monde devait commencer, et selon les calculs préliminaires, les pics de trafic en direct auraient dû être multipliés par six ... <br><br><h2>  Nouvelle approche de CDN </h2><br>  Après avoir analysé le problème, nous avons décidé de séparer la VOD et le trafic en direct selon différents PAD composés de serveurs avec différentes configurations.  Et créez également une fonction de distribution du trafic et de son équilibrage entre différents groupes de serveurs.  Il y avait au total trois de ces groupes: <br><br><ul><li>  Serveurs avec un grand nombre de disques hautes performances les mieux adaptés à la mise en cache du contenu VOD.  En fait, les disques SSD RI de la capacité maximale seraient les mieux adaptés, mais il n'y en avait pas, et il faudrait trop de budget pour acheter la bonne quantité.  Finalement, il a été décidé d'utiliser le meilleur qui soit.  Chaque serveur contenait huit disques SAS 1 To 10 000 en RAID5.  A partir de ces serveurs, VOD_PAD a été compilé. <br></li><li>  Serveurs avec une grande quantité de RAM pour mettre en cache tous les formats possibles pour la livraison de morceaux en direct, avec des processeurs capables de gérer le trafic SSL et des interfaces réseau "épaisses".  Nous avons utilisé la configuration suivante: 2 processeurs de 8 cœurs / 192 Go de RAM / 4 interfaces de 10 Go.  À partir de ces serveurs, EDGE_PAD a été compilé. <br></li><li>  Le groupe de serveurs restant n'est pas en mesure de gérer le trafic VOD, mais convient aux petits volumes de contenu en direct.  Ils peuvent être utilisés comme réserve.  À partir des serveurs, RESERVE_PAD a été compilé. <br></li></ul><br>  La répartition était la suivante: <br><img src="https://habrastorage.org/getpro/habr/post_images/3ed/17c/dbf/3ed17cdbf13920eae4c06067e2edd296.png"><br>  Un module logique spécial était chargé de choisir le PAD dont l'utilisateur était censé recevoir le contenu.  Voici ses tâches: <br><ul><li>  Analysez l'URL, appliquez le schéma ci-dessus pour chaque demande de flux et émettez le PAD requis <br></li><li>  Pour supprimer la charge des interfaces EDGE_PAD toutes les 5 minutes ( <i>et c'était notre erreur</i> ), et lorsque la limite est atteinte, basculez le trafic excédentaire sur RESERVE_PAD.  Pour soulager la charge, un petit script perl a été écrit qui a renvoyé les données suivantes: <br>  - <b>horodatage</b> - date et heure de mise à jour des données de chargement (au format RFC 3339); <br>  - <b>total_bandwidth</b> - charge d'interface actuelle (total), Kbps; <br>  - <b>rx_bandwidth</b> - charge d'interface actuelle (trafic entrant), Kbps; <br>  - <b>tx_badwidth</b> - charge d'interface actuelle (trafic sortant), Kbps. <br></li><li>  Dirigez le trafic en mode manuel vers n'importe quel serveur PAD ou Origin en cas de situations imprévues, ou si nécessaire, travaillez sur l'un des PAD.  La configuration était sur le serveur au format yaml et permettait de prendre tout le trafic vers le PAD souhaité, ou le trafic selon l'un des paramètres: <br>  - Type de contenu <br>  - cryptage du trafic <br>  - Trafic payant <br>  - type d'appareil <br>  - Type de liste de lecture <br>  - Région <br></li></ul><br>  Les serveurs d'origine ont un SSD en sous-effectif.  Malheureusement, lors du basculement du trafic vers Origin, HIT_RATE sur les morceaux VOD laissait beaucoup à désirer (environ 30%), mais ils ont accompli leur tâche, nous n'avons donc observé aucun problème avec les conditionneurs de paquets dans CNN. <br><br>  Comme il y avait peu de serveurs pour la configuration EDGE_PAD, il a été décidé de les allouer dans les régions avec la plus grande part de trafic - Moscou et la région de la Volga.  Avec l'aide de GeoDNS, le trafic a été envoyé à la région de la Volga à partir des régions des districts fédéraux de la Volga et de l'Oural.  Le hub de Moscou a servi le reste.  Nous n'aimions pas vraiment l'idée de livrer du trafic vers la Sibérie et l'Extrême-Orient depuis Moscou, mais au total, ces régions représentent environ 1/20 de tout le trafic, et les canaux de MegaFon se sont avérés assez larges pour de tels volumes. <br>  Après l'élaboration du plan, les travaux suivants ont été effectués: <br><br><ul><li>  En deux semaines, développé la fonctionnalité de commutation de CDN <br></li><li>  Il a fallu un mois pour installer et configurer les serveurs EDGE_PAD, ainsi que pour étendre les canaux pour eux <br></li><li>  Il a fallu deux semaines pour diviser le groupe de serveurs actuel en deux parties, plus deux semaines supplémentaires pour appliquer les paramètres à tous les serveurs du réseau et à l'équipement du serveur <br></li><li>  Et, enfin, la semaine a été consacrée aux tests (malheureusement pas sous charge, ce qui a ensuite affecté) <br></li></ul><br>  Il s'est avéré paralléliser une partie du travail, et finalement cela a pris six semaines. <br><br><h2>  Premiers résultats et plans futurs </h2><br>  Après réglage, les performances globales du système étaient de 250 Go / s.  La solution avec le transfert du trafic VOD vers des serveurs séparés a immédiatement montré son efficacité après son déploiement en production.  Depuis le début de la Coupe du monde, il n'y a eu aucun problème de trafic VOD.  Plusieurs fois, pour diverses raisons, j'ai dû basculer le trafic VOD vers Origin, mais en principe, ils ont également fait face.  Ce schéma n'est peut-être pas très efficace en raison de la très faible utilisation du cache, car nous forçons les SSD à écraser constamment le contenu.  Mais le circuit fonctionne. <br><br>  Quant au trafic en direct, les volumes correspondants pour tester notre décision sont apparus avec le début de la Coupe du Monde.  Les problèmes ont commencé lorsque la deuxième fois que nous avons dû faire face à un changement de trafic lorsque nous avons atteint la limite lors du match Russie-Egypte.  Lorsque la commutation du trafic a fonctionné, tout s'est déversé sur le PAD de sauvegarde.  Au cours de ces cinq minutes, le nombre de demandes (courbe de croissance) a été si élevé que le CDN de sauvegarde s'est bouché complètement et a commencé à verser des erreurs.  Dans le même temps, le PAD principal a été libéré pendant cette période et a commencé à rester un peu inactif: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae7/5a6/804/ae75a68044b8150556324ccfbde19827.png"><br><br>  3 conclusions en ont été tirées: <br><br><ol><li>  Cinq minutes, c'est encore trop.  Il a été décidé de réduire la période de déchargement à 30 secondes.  Par conséquent, le trafic sur le PAD de secours a cessé d'augmenter de façon spasmodique: <br><img src="https://habrastorage.org/getpro/habr/post_images/f73/e8d/47a/f73e8d47a26d62c8fc6d82f88d442fad.png"><br></li><li>  Il est nécessaire au minimum de transférer les utilisateurs entre les PAD chaque fois que le commutateur est déclenché.  Cela devrait fournir une fluidité supplémentaire de commutation.  Nous avons décidé d'attribuer un cookie à chaque utilisateur (ou plutôt à l'appareil), selon lequel le module responsable de la distribution comprend si l'utilisateur doit rester sur le PAD actuel ou si un changement doit être effectué.  Ici, la technologie peut être à la discrétion de celui qui la met en œuvre.  Par conséquent, nous ne perdons pas de trafic sur le PAD principal. <br></li><li>  Le seuil de commutation a été défini trop bas, en conséquence, le trafic sur le PAD de secours a augmenté comme une avalanche.  Dans notre cas, il s'agissait d'une réassurance - nous n'étions pas complètement sûrs d'avoir fait le bon réglage du serveur (l'idée pour laquelle, soit dit en passant, a été empruntée à Habr).  Le seuil a été augmenté pour les performances physiques des interfaces réseau. <br></li></ol><br>  Les améliorations ont pris trois jours, et déjà lors du match Russie-Croatie, nous avons vérifié si notre optimisation fonctionnait.  En général, le résultat nous a plu.  À son apogée, le système a traité 215 Gbit / s de trafic mixte.  Ce n'était pas une limite théorique sur les performances du système - nous avions encore une marge substantielle.  Si nécessaire, nous pouvons maintenant connecter n'importe quel CDN externe, si nécessaire, et y "éliminer" le trafic excédentaire.  Un tel modèle est bon lorsque vous ne voulez pas payer de l'argent solide chaque mois pour utiliser le CDN de quelqu'un d'autre. <br><br>  Nos plans comprennent la poursuite du développement de CDN.  Pour commencer, je voudrais étendre le schéma EDGE_PAD à tous les districts fédéraux - cela conduira à une moindre utilisation des canaux.  Des tests de circuit de redondance VOD_PAD sont également en cours, et certains des résultats semblent maintenant assez impressionnants. <br><br>  En général, tout ce qui a été fait au cours de la dernière année m'amène à penser que le CDN du service qui distribue du contenu vidéo est un must have.  Et même pas parce qu'il vous permet d'économiser beaucoup d'argent, mais plutôt parce que le CDN devient une partie du service lui-même, affecte directement la qualité et la fonctionnalité.  Dans de telles circonstances, le donner entre de mauvaises mains est au moins déraisonnable. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr425229/">https://habr.com/ru/post/fr425229/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr425219/index.html">Qu'est-ce que la santé mentale: une perspective de la psychologie / psychothérapie</a></li>
<li><a href="../fr425221/index.html">Comment fabriquer du plastique pour l'impression 3D</a></li>
<li><a href="../fr425223/index.html">Applications Android JPHP</a></li>
<li><a href="../fr425225/index.html">Comment voir les liens à l'intérieur de votre module PowerShell</a></li>
<li><a href="../fr425227/index.html">Les chercheurs ont trouvé un moyen de détecter et de contourner les clés Honeytoken dans un certain nombre de services Amazon.</a></li>
<li><a href="../fr425231/index.html">FAQ sur le travail d'une hôtesse de l'air</a></li>
<li><a href="../fr425233/index.html">Python 3 sur Facebook</a></li>
<li><a href="../fr425235/index.html">Un peu plus sur les graphiques, ou comment détecter les dépendances entre vos applications</a></li>
<li><a href="../fr425237/index.html">Mesure du temps avec une précision en nanosecondes</a></li>
<li><a href="../fr425241/index.html">Développeur 20 ans plus tard: Vasily Lebedev sur ICRE, l'éducation, son livre et sa programmation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>