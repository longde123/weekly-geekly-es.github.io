<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üôà üïé üö£üèª Crie uma plataforma kubernetes no Pinterest üÄÑÔ∏è üìÉ üñêüèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Ao longo dos anos de exist√™ncia do Pinterest, 300 milh√µes de usu√°rios do servi√ßo criaram mais de 200 bilh√µes de pinos em mais de 4 bilh√µes de placas. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crie uma plataforma kubernetes no Pinterest</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/465487/">  <i>Ao longo dos anos de exist√™ncia do Pinterest, 300 milh√µes de usu√°rios do servi√ßo criaram mais de 200 bilh√µes de pinos em mais de 4 bilh√µes de placas.</i>  <i>Para atender a esse ex√©rcito de usu√°rios e uma extensa base de conte√∫do, o portal desenvolveu milhares de servi√ßos, variando de microsservi√ßos que v√°rias CPUs podem suportar e terminando com mon√≥litos gigantes que rodam em toda uma frota de m√°quinas virtuais.</i>  <i>E ent√£o chegou o momento em que os olhos da empresa ca√≠ram nos k8s.</i>  <i>O que o "cubo" parecia "Interesse"?</i>  <i>Voc√™ aprender√° sobre isso na nossa tradu√ß√£o da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">publica√ß√£o</a> mais recente do <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">blog de engenharia do Pinterest</a> .</i> <br><br><img src="https://habrastorage.org/webt/ns/nd/tz/nsndtzsnqp6b0zn8ir1zrlzok28.png"><br><br>  Portanto, centenas de milh√µes de usu√°rios e centenas de bilh√µes de pinos.  Para atender esse ex√©rcito de usu√°rios e uma extensa base de conte√∫do, desenvolvemos milhares de servi√ßos, desde microsservi√ßos que podem ser manipulados por v√°rias CPUs a mon√≥litos gigantes que rodam em uma frota inteira de m√°quinas virtuais.  Al√©m disso, temos uma variedade de estruturas que tamb√©m podem exigir recursos da CPU, mem√≥ria ou acesso a E / S. <br><br>  Para apoiar esse zool√≥gico de ferramentas, a equipe de desenvolvimento enfrenta v√°rios desafios: <br><a name="habracut"></a><br><ul><li>  Os engenheiros n√£o t√™m uma maneira unificada de executar um ambiente de trabalho.  Servi√ßos sem estado, servi√ßos com estado e projetos em desenvolvimento ativo s√£o baseados em pilhas de tecnologia completamente diferentes.  Isso levou √† cria√ß√£o de todo um curso de treinamento para engenheiros e tamb√©m complica seriamente o trabalho de nossa equipe de infraestrutura. </li><li>  Os desenvolvedores com sua pr√≥pria frota de m√°quinas virtuais criam uma enorme carga sobre os administradores internos.  Como resultado, opera√ß√µes simples como atualizar o SO ou AMI duram semanas e meses.  Isso leva a um aumento da carga de trabalho em situa√ß√µes aparentemente absolutamente cotidianas. </li><li>  Dificuldades na cria√ß√£o de ferramentas globais de gerenciamento de infraestrutura em cima das solu√ß√µes existentes.  A situa√ß√£o √© complicada pelo fato de n√£o ser f√°cil encontrar os propriet√°rios de m√°quinas virtuais.  Ou seja, n√£o sabemos se √© seguro extrair essas capacidades para trabalhar em outras partes de nossa infraestrutura. </li></ul><br>  Os sistemas de orquestra√ß√£o de cont√™ineres s√£o uma maneira de unificar o gerenciamento de carga de trabalho.  Eles abrem o caminho para voc√™ aumentar a velocidade de desenvolvimento e simplificar o gerenciamento da infraestrutura, pois todos os recursos envolvidos no projeto s√£o gerenciados por um sistema centralizado. <br><br><img src="https://habrastorage.org/webt/6l/eq/7l/6leq7lajojjwmt1mg2hlobt4uce.png"><br><br>  <i>Figura 1: Prioridades da infraestrutura (confiabilidade, produtividade do desenvolvedor e efici√™ncia).</i> <br><br>  A equipe da Cloud Management Platform no Pinterest conheceu o K8s em 2017.  No primeiro semestre de 2017, documentamos a maioria de nossas instala√ß√µes de produ√ß√£o, incluindo a API e todos os nossos servidores web.  Depois disso, avaliamos cuidadosamente os v√°rios sistemas de orquestra√ß√£o de solu√ß√µes de cont√™ineres, construindo clusters e trabalhando com eles.  At√© o final de 2017, decidimos usar o Kubernetes.  Era flex√≠vel o suficiente e com amplo suporte na comunidade de desenvolvedores. <br><br>  At√© o momento, criamos nossas pr√≥prias ferramentas de autoinicializa√ß√£o de cluster baseadas no Kops e transferimos para os componentes de infraestrutura existentes do Kubernetes, como rede, seguran√ßa, m√©tricas, registro, gerenciamento de identidade e tr√°fego.  Tamb√©m implementamos um sistema de modelagem de carga de trabalho para o nosso recurso, cuja complexidade est√° oculta aos desenvolvedores.  Agora, estamos focados em garantir a estabilidade do cluster, seu dimensionamento e conex√£o de novos clientes. <br><br><h4>  Kubernetes: maneira do Pinterest </h4><br>  A introdu√ß√£o ao Kubernetes em uma escala do Pinterest como uma plataforma que nossos engenheiros v√£o adorar √© impressionante. <br><br>  Como uma grande empresa, investimos fortemente em ferramentas de infraestrutura.  Os exemplos incluem ferramentas de seguran√ßa que processam certificados e distribuem chaves, componentes de controle de tr√°fego, sistemas de descoberta de servi√ßos, visibilidade e envio de logs e m√©tricas.  Tudo isso foi coletado por um motivo: seguimos o caminho normal de tentativa e erro e, portanto, quer√≠amos integrar toda essa economia na nova infraestrutura do Kubernetes, em vez de reinventar a bicicleta velha em uma nova plataforma.  Essa abordagem geralmente simplifica a migra√ß√£o, j√° que todo o suporte a aplicativos j√° existe, n√£o precisa ser criado do zero. <br><br>  Por outro lado, os modelos de previs√£o de carga no pr√≥prio Kubernetes (por exemplo, implanta√ß√µes, tarefas e kits Daemon) n√£o s√£o suficientes para o nosso projeto.  Esses problemas de usabilidade s√£o enormes barreiras para mudar para o Kubernetes.  Por exemplo, ouvimos os desenvolvedores de servi√ßos reclamarem de uma configura√ß√£o de login ausente ou incorreta.  Tamb√©m encontramos o uso inadequado de mecanismos de modelo quando centenas de c√≥pias foram criadas com a mesma especifica√ß√£o e tarefa, o que resultou em problemas de pesadelo com a depura√ß√£o. <br><br>  Tamb√©m era muito dif√≠cil oferecer suporte a vers√µes diferentes no mesmo cluster.  Imagine a complexidade do suporte ao cliente se precisar trabalhar imediatamente em v√°rias vers√µes do mesmo tempo de execu√ß√£o, com todos os seus problemas, bugs e atualiza√ß√µes. <br><br><h4>  Recursos e controladores personalizados do Pinterest </h4><br>  Para facilitar a implementa√ß√£o do Kubernetes para nossos engenheiros, al√©m de simplificar e acelerar a infraestrutura, desenvolvemos nossas pr√≥prias defini√ß√µes de recursos personalizados (CRD). <br><br>  Os CRDs fornecem os seguintes recursos: <br><br><ol><li>  Combinando v√°rios recursos nativos do Kubernetes para faz√™-los funcionar como um √∫nico carregamento.  Por exemplo, o recurso PinterestService inclui uma implanta√ß√£o, servi√ßo de login e mapa de configura√ß√£o.  Isso permite que os desenvolvedores n√£o se preocupem com a configura√ß√£o do DNS. </li><li>  Implemente o suporte necess√°rio ao aplicativo.  O usu√°rio deve se concentrar apenas na especifica√ß√£o do cont√™iner de acordo com sua l√≥gica de neg√≥cios, enquanto o controlador CRD implementa todos os cont√™ineres init necess√°rios, vari√°veis ‚Äã‚Äãde ambiente e especifica√ß√µes de pod.  Isso fornece um n√≠vel de conforto fundamentalmente diferente para os desenvolvedores. </li><li>  Os controladores CRD tamb√©m gerenciam o ciclo de vida de seus pr√≥prios recursos e aumentam a disponibilidade de depura√ß√£o.  Isso inclui concordar com as especifica√ß√µes desejadas e reais, atualizar o status do CRD e manter logs de eventos e muito mais.  Sem o CRD, os desenvolvedores seriam for√ßados a gerenciar um grande conjunto de recursos, o que aumentaria apenas a probabilidade de erro. </li></ol><br>  Aqui est√° um exemplo do PinterestService e o recurso interno controlado por nosso controlador: <br><br><img src="https://habrastorage.org/webt/o8/nh/oh/o8nhohmr-jzi5lzoqpapflkbwdi.png"><br><br>  Como voc√™ pode ver acima, para oferecer suporte a um cont√™iner personalizado, precisamos integrar um cont√™iner de inicializa√ß√£o e v√°rios complementos a ele para garantir seguran√ßa, visibilidade e trabalhar com o tr√°fego da rede.  Al√©m disso, criamos modelos de mapa de configura√ß√£o e implementamos suporte para modelos de PVC para tarefas em lote, al√©m de rastrear uma variedade de vari√°veis ‚Äã‚Äãde ambiente para rastrear a identifica√ß√£o, consumo de recursos e coleta de lixo. <br><br>  √â dif√≠cil imaginar que os desenvolvedores desejem gravar esses arquivos de configura√ß√£o manualmente sem o suporte a CRD, sem mencionar o suporte adicional e a depura√ß√£o de configura√ß√µes. <br><br><h4>  Implanta√ß√£o de aplicativo de fluxo de trabalho </h4><br><img src="https://habrastorage.org/webt/ia/s1/ak/ias1akn3t5xtlubqimuo5apiaci.png"><br><br>  A figura acima mostra como implantar um recurso personalizado do Pinterest em um cluster Kubernetes: <br><br><ol><li>  Os desenvolvedores interagem com nosso cluster Kubernetes por meio da CLI e da interface do usu√°rio. </li><li>  As ferramentas da CLI / UI extraem os arquivos YAML de configura√ß√£o do fluxo de trabalho e outras propriedades de montagem (o mesmo identificador de vers√£o) do Artifactory e os enviam para o Servi√ßo de Envio de Tarefas.  Esta etapa garante que apenas as vers√µes de produ√ß√£o sejam entregues ao cluster. </li><li>  JSS √© a porta de entrada para v√°rias plataformas, incluindo Kubernetes.  √â aqui que ocorre a autentica√ß√£o do usu√°rio, a emiss√£o de cotas e a verifica√ß√£o parcial de nossa configura√ß√£o de CRD. </li><li>  Ap√≥s verificar o CRD no lado JSS, as informa√ß√µes s√£o enviadas para a API da plataforma k8s. </li><li>  Nosso controlador CRD monitora eventos em todos os recursos do usu√°rio.  Ele converte o CR em recursos nativos do k8s, adiciona os m√≥dulos necess√°rios, define as vari√°veis ‚Äã‚Äãde ambiente apropriadas e executa outros trabalhos auxiliares, o que garante aos aplicativos de usu√°rio do cont√™iner suporte de infraestrutura suficiente. </li><li>  Em seguida, o controlador CRD transfere os dados recebidos para a API do Kubernetes, para que sejam processados ‚Äã‚Äãpelo planejador e colocados em opera√ß√£o. </li></ol><br>  <b>Nota</b> : essa implanta√ß√£o de fluxo de trabalho de pr√©-lan√ßamento foi criada para os primeiros usu√°rios da nova plataforma k8s.  Agora estamos finalizando esse processo para integrar-se totalmente ao nosso novo IC / CD.  Isso significa que n√£o podemos contar tudo relacionado ao Kubernetes.  Esperamos compartilhar nossa experi√™ncia e informar a equipe sobre esse progresso em nossa pr√≥xima postagem no blog ‚ÄúConstruindo uma plataforma de CI / CD para o Pinterest‚Äù. <br><br><h4>  Tipos de Recursos Especiais </h4><br>  Com base nas necessidades espec√≠ficas do Pinterest, desenvolvemos os seguintes CRDs adequados para uma variedade de fluxos de trabalho: <br><br><ul><li>  O PinterestService √© um servi√ßo sem estado de longa dura√ß√£o.  Muitos de nossos principais sistemas s√£o baseados em um conjunto de tais servi√ßos. </li><li>  O JobSet modela trabalhos em lote de ciclo completo.  O Pinterest tem um cen√°rio comum, segundo o qual v√°rias tarefas executam os mesmos cont√™ineres em paralelo e independentemente de outros processos semelhantes. </li><li>  O PinterestCronJob √© amplamente utilizado em conjunto com pequenas cargas peri√≥dicas.  Este √© um shell nativo cron com mecanismos de suporte do Pinterest respons√°veis ‚Äã‚Äãpela seguran√ßa, tr√°fego, logs e m√©tricas. </li><li>  O PinterestDaemon inclui a infraestrutura do Daemon.  Essa fam√≠lia continua a crescer √† medida que adicionamos mais suporte aos nossos clusters. </li><li>  O PinterestTrainingJob se estende aos processos Tensorflow e Pytorch, fornecendo o mesmo n√≠vel de suporte on-line de todos os outros CRDs.  Como o Pinterest est√° usando ativamente o Tensorflow e outros sistemas de aprendizado de m√°quina, tivemos um motivo para criar um CRD separado em torno deles. </li></ul><br>  Tamb√©m estamos trabalhando no PinterestStatefulSet, que em breve ser√° adaptado para data warehouses e outros sistemas com estado. <br><br><h4>  Suporte de tempo de execu√ß√£o </h4><br>  Quando o m√≥dulo do aplicativo √© executado no Kubernetes, ele recebe automaticamente um certificado para se identificar.  Este certificado √© usado para acessar o armazenamento secreto ou se comunicar com outros servi√ßos atrav√©s do mTLS.  Enquanto isso, o configurador de inicializa√ß√£o do cont√™iner e o Daemon far√£o o download de todas as depend√™ncias necess√°rias antes de iniciar o aplicativo de cont√™iner.  Quando tudo estiver pronto, o tr√°fego do side-car e o Daemon registrar√£o o endere√ßo IP do m√≥dulo em nosso Zookeeper para que os clientes possam encontr√°-lo.  Tudo isso funcionar√°, pois o m√≥dulo de rede foi configurado antes do lan√ßamento do aplicativo. <br><br>  A seguir, exemplos t√≠picos de suporte √† carga de trabalho em tempo de execu√ß√£o.  Para outros tipos de cargas de trabalho, pode ser necess√°rio um suporte ligeiramente diferente, mas todos eles s√£o apresentados como m√°quinas virtuais no n√≠vel do pod de side-car, nodal ou no Daemon.  Garantimos que tudo isso seja implantado na estrutura da infraestrutura de gerenciamento e coordenado entre aplicativos, o que reduz significativamente a carga em termos de trabalho t√©cnico e suporte ao cliente. <br><br><h4>  Teste e controle de qualidade </h4><br>  Reunimos um pipeline de teste de ponta a ponta sobre a infraestrutura de teste existente do Kubernetes.  Esses testes se aplicam a todos os nossos clusters.  Nosso pipeline passou por muitas mudan√ßas antes de se tornar parte do cluster de produtos. <br><br>  Al√©m dos sistemas de teste, temos sistemas de monitoramento e aviso que monitoram constantemente o status dos componentes do sistema, consumo de recursos e outros indicadores importantes, notificando-nos apenas quando √© necess√°ria a interven√ß√£o humana. <br><br><h4>  Alternativas </h4><br>  Examinamos algumas alternativas para recursos personalizados, como controladores de acesso mutacional e sistemas de modelos.  No entanto, todos eles est√£o repletos de s√©rias dificuldades no trabalho, por isso escolhemos o caminho da DRC. <br><br>  Um controlador de toler√¢ncia √† muta√ß√£o foi usado para inserir carros laterais, uma vari√°vel de ambiente e outro suporte ao tempo de execu√ß√£o.  No entanto, ele enfrentou v√°rios problemas, por exemplo, com liga√ß√£o de recursos e gerenciamento de seu ciclo de vida, quando esses problemas n√£o surgem na DRC. <br><br>  <b>Nota:</b> Os sistemas de gabarito, como os diagramas Helm, tamb√©m s√£o amplamente utilizados para executar aplicativos com configura√ß√µes semelhantes.  No entanto, nossos aplicativos de produ√ß√£o s√£o muito diversos para gerenci√°-los com modelos.  Al√©m disso, durante a implanta√ß√£o cont√≠nua, o uso de modelos gerar√° muitos erros. <br><br><h4>  Trabalho futuro </h4><br>  Agora, estamos lidando com uma carga mista em todos os nossos clusters.  Para dar suporte a processos semelhantes de diferentes tipos e tamanhos, trabalhamos nas seguintes √°reas: <br><br><ul><li>  Um cluster de clusters distribui grandes aplicativos entre clusters para fornecer escalabilidade e estabilidade. </li><li>  Garantir estabilidade, escalabilidade e visibilidade do cluster para criar a conex√£o do aplicativo e seu SLA. </li><li>  Gerenciamento de recursos e cotas para que os aplicativos n√£o entrem em conflito entre si e a escala do cluster seja controlada por n√≥s. </li><li>  Nova plataforma de CI / CD para suportar e implantar aplicativos no Kubernetes. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt465487/">https://habr.com/ru/post/pt465487/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt465475/index.html">Mini-entrevista com Oleg Anastasiev: toler√¢ncia a falhas em Apache Cassandra</a></li>
<li><a href="../pt465477/index.html">Como eu ensinei uma cobra a se jogar usando o Q-Network</a></li>
<li><a href="../pt465479/index.html">Lo-fi de pixel no Unity</a></li>
<li><a href="../pt465483/index.html">Antiguidades: Windows 3.1 e vida sem um bot√£o Iniciar</a></li>
<li><a href="../pt465485/index.html">Imprimir tape√ßaria Game of Thrones em uma impressora fiscal usando Python</a></li>
<li><a href="../pt465489/index.html">Lista de verifica√ß√£o de prontid√£o para produ√ß√£o</a></li>
<li><a href="../pt465491/index.html">Zabbix + Voximplant: monitoramento com chamadas ou como parar de se preocupar e configur√°-lo rapidamente</a></li>
<li><a href="../pt465493/index.html">Linguagem de programa√ß√£o r√°pida no Raspberry Pi</a></li>
<li><a href="../pt465495/index.html">Como n√£o perder tr√°fego ao mudar para um novo dom√≠nio: caso "Vse10"</a></li>
<li><a href="../pt465497/index.html">Mensagens secretas atrav√©s dos logs do servidor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>