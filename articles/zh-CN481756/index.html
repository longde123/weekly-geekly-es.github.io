<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📽️ 💆🏻 🤦🏿 如何为良好目的组织DDoS？ 🤞🏽 🌤️ 👨🏽‍✈️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="在发布新服务之前，很高兴确保它能够按照我们的期望运行并且无论有多少客户同时使用它都可以使用。 


 如果针对它组织了分布式DoS攻击，该服务将如何反应？ 资源是否受到潜在攻击者的保护？ 


 为了评估可能的风险并提高安全性，在尚未启动用于大规模使用的资源时，独立执行模拟DDoS攻击的措施是有意义...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>如何为良好目的组织DDoS？</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ntc-vulkan/blog/481756/"><p><img src="https://habrastorage.org/webt/qa/gk/up/qagkupe_y5cx7thbrqpj4aynn1y.png" alt="图片"></p><br><p> 在发布新服务之前，很高兴确保它能够按照我们的期望运行并且无论有多少客户同时使用它都可以使用。 </p><br><p> 如果针对它组织了分布式DoS攻击，该服务将如何反应？ 资源是否受到潜在攻击者的保护？ </p><br><p> 为了评估可能的风险并提高安全性，在尚未启动用于大规模使用的资源时，独立执行模拟DDoS攻击的措施是有意义的。 </p><br><p> 在本文中，我们将讨论组织DNS和HTTP服务的负载测试的经验。 </p><a name="habracut"></a><br><h1> 准备工作 </h1><br><p> 为了在监视的资源上产生大量的网络流量，您需要使用许多虚拟机，每个虚拟机都会向服务发送最大数量的请求。 如果您没有功能强大的数据中心，则可以在云中临时租用虚拟机。 这个想法具有一个特征：您需要确保云不会爬网，将您的活动用于攻击者的行为。 </p><br><p> 比较使用其功能进行负载测试的各种云服务的策略（无情地禁止某个帐户，该帐户可能导致资源失败），我们决定停止使用<a href="https://aws.amazon.com/">Amazon Web Services</a> （AWS）。 他们的<a href="https://aws.amazon.com/ru/ec2/testing/">文件</a>表明AWS允许进行负载测试，但通过将电子邮件发送到特定地址来请求批准。 </p><br><h1> 压力测试的协调 </h1><br><p> 我们发送一条消息，在其中简要讨论我们的意图，并获得必须填写的表格： </p><br><pre><code class="plaintext hljs">Customer ID: Customer Name: Email Address: AWS Account ID load test will be performed from: Does the customer have an NDA? Target Data EC2 Resources: Cloudfront Distribution: API Gateway / Lambda ID: ELB Names: Non-AWS Target: Region (please list all regions in scope for testing): Source Data: IP Addresses: Source Account ID: Regions involved: Testing Parameters: How much traffic do you plan to generate by region during testing? What is your expected peak load from source by region? (ie xx Gbps) What is your expected peak load at destination? (ie xx Gbps) Are you testing traffic outbound from EC2, inbound into EC2, or both? Are you testing traffic outbound (egress) from EC2, inbound (ingress) into EC2, or both: Egress. What is your expected peak load from source by region? (ie xx Gbps) Ingress. What is your expected peak load from source by region? (ie xx Gbps) Start Date: End Date: Finite testing details including timeline of testing: Summary of Test: Testing Timelines by phase including rps, pps, and Gbps: Peak bandwidth for each source IP: Tools Used for each phase of test: Types of testing to be performed for each phase of the request: What criteria/metrics will you monitor to ensure the success of this test? Who is performing the Load Test? (Please provide contact details): Does the tester have an NDA? Testing Security Do you have a way to monitor the data traffic for the duration of the test to verify bandwidth limits do not exceed approved rates? Do you have a way to immediately stop the traffic if we/you discover any issue? 2 Emergency contact names and phone numbers:</code> </pre> <br><p> 有几个细微差别： </p><br><ol><li><p> 他们问我们谁将“晒黑”。 我们对此有权利吗？ 我们说这是我们的资源（显然，没有人检查是否如此），并且测试是完全一致的。 </p><br></li><li><p> 我们需要指定将在每个区域中创建多少流量。 在通信过程中，我们发现每个区域都有自己的网络流量限制。 总共允许他们请求645 Gb / s。 我们考虑了攻击所需的数量，然后选择区域以获取必要的值。 </p><br></li><li><p> 需要描述攻击将在什么时间进行，持续多长时间以及其功率将如何增长。 我们以自由形式，但有足够的细节谈论我们的计划。 攻击是在逐渐增加功率的情况下进行的，因此我们绘制了测试将进行的阶段以及每个阶段预期的最大功率。 攻击日期最多可以省略一天；很可能会指出两到三周的范围。 </p><br></li><li><p> 毫无疑问，我们将竭尽所能，以确保我们表现良好，仔细监控测试进度，并在必要时在首次提出要求时停止测试。 </p><br></li></ol><br><p> 在完成表格后，他们很可能会要求您做一些澄清，因此我们会回信并回答问题，直到获得测试许可。 </p><br><p> 如果及时回答，则大约需要三个工作日才能完成批准过程。 </p><br><h1> 基础设施准备 </h1><br><p> 批准后，我们​​面临准备测试基础架构的需求。 事实是，在检查过程中，我们需要及时： </p><br><p>  •包含一个实例； </p><br><p>  •发起测试攻击； </p><br><p>  •收集进度统计信息； </p><br><p>  •停止测试攻击； </p><br><p>  •更改IP地址； </p><br><p>  •关闭实例。 </p><br><h2> 创建实例映像 </h2><br><h3> 选择实例类型 </h3><br><p> 首先，让我们构建一个AWS映像，其中将包含用于管理的必要工具和脚本。 第一步是选择要租用的实例。 我们研究了不同类型实例的特征：我们查看价格，最大流量，CPU能力（后者很重要，因为流量毕竟是由处理器的容量创建的），然后我们测试实际性能和最大请求​​数。 根据我们的估计， <code>t3.small</code>实例最方便测试，但是每个人都可以选择自己的口味。 </p><br><p> 实例的特征可以在<a href="https://aws.amazon.com/ec2/instance-types/">这里</a>找到。 您也可以<a href="https://www.ec2instances.info/">在此处</a>选择和比较实例。 </p><br><h3> 限制要求 </h3><br><p> 您需要事先考虑多少个实例将参与测试。 事实是，Amazon为每个区域提供了实例数量的限制。 如果您感觉需要的实例数将超过默认情况下的实例数，那么您应该尽早请求增加限制。 为此，请转到“ <a href="https://console.aws.amazon.com/support/cases">支持”</a>部分，创建“服务限额增加”类型的呼叫。 请求的处理时间可能有所不同：某人第二天回答，提供了所请求的尽可能多的实体，某人说他最多允许运行N个实例。 有一些地区对请求的回应大约一个月。 </p><br><h3> 性能调优 </h3><br><p> 接下来，您需要创建一个在测试期间启动的实例映像。 为此，我们打开选定类型的实例，对其进行所有设置，然后将发生的情况保存为图像（在“动作”菜单中，您可以在其中启用该实例，以及创建图像的功能创建图像）。 </p><br><p> 我们需要从每个实例获得最大的传出流量，因此首先我们针对实例上的任务优化网络和内存设置。 </p><br><p> 为此，请在<code>/etc/sysctl.conf</code>文件中进行设置： </p><br><p>  •增加本地端口的范围并减少处于FIN_WAIT状态的套接字所花费的时间： </p><br><pre> <code class="plaintext hljs">net.ipv4.ip_local_port_range = 1024-65535 ( : 32768-61000) net.ipv4.tcp_fin_timeout = 10 ( : 60)</code> </pre> <br><p> 本地端口范围确定主机可以从特定IP创建的最大出站套接字数。 </p><br><p> 使用默认设置（61,000–32,768），可获得28,233个套接字。 使用新设置-64500。 </p><br><p>  Fin_timeout定义传出套接字可以处于FIN_WAIT状态的最短时间。 </p><br><p> 如果指定了默认值，则系统每秒最多只能提供（61,000–32,768）/ 60 = 470个套接字。 </p><br><p> 通过增加port_range和减少fin_timeout，我们可以影响系统生成更多传出连接的能力。 </p><br><p>  •让我们在空闲的套接字结束时重用处于TIME_WAIT状态的套接字： </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_tw_reuse = 1</code> </pre> <br><p> 设置以上选项（默认情况下处于禁用状态）有助于最大程度地减少已实现的“空闲”连接的丢失。 </p><br><p> 本文介绍了有关TIME_WAIT的非常详细的信息。 </p><br><p>  •打开tcp_timestamps选项以使上述tcp_tw_reuse选项起作用： </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_timestamps = 1 –   `tcp_timestamps`     tcp_tw_reuse</code> </pre> <br><p>  •其他选项： </p><br><pre> <code class="plaintext hljs">net.ipv4.tcp_max_tw_buckets = 720000 –       TIME_WAIT net.ipv4.tcp_keepalive_time = 600 –  - keepalive- net.ipv4.tcp_keepalive_probes = 3 –   keepalive- net.ipv4.tcp_keepalive_intvl = 10 –     keepalive- net.ipv4.tcp_window_scaling = 1 –   TCP- net.ipv4.tcp_mem = 8192 131072 196304 –     TCP- net.ipv4.udp_mem = 8192 131072 196304 –     udp- net.ipv4.tcp_slow_start_after_idle=0 –  Slow-Start Restart net.core.wmem_default = 31457280 –         net.core.wmem_max = 33554432 –        net.core.somaxconn = 65535 –        net.core.netdev_max_backlog = 65535 –          vm.swappiness = 30 –    vm.dirty_ratio = 50 –     50 %  vm.pagecache = 90 –    </code> </pre> <br><h3> 测试攻击脚本 </h3><br><p>  <strong>1. DNS攻击</strong> </p><br><p> 测试的主要任务之一是评估DNS服务器的性能。 也就是说，DNS服务器可能成为站点容错的瓶颈，因为即使DNS存在问题，即使最稳定的服务也无法使用。 为了在DNS服务器上创建负载，我们将生成许多不同的DNS查询。 请求必须有效，并且需要DNS服务器提供最大可能和最长响应。 </p><br><p>  <a href="https://www.dns-oarc.net/tools/dnsperf">DNSPerf</a>实用程序适用于生成此类流量。 </p><br><p>  DNSPerf是一种简单，灵活且免费的DNS性能测试工具。 它主要是为权威DNS服务器设计的，但也可以用于衡量缓存服务器的性能。 </p><br><p> 在我们的情况下，将加载服务于一个区域（example.com）的权威DNS服务器。 </p><br><p> 对于DNSPerf，我们首先准备一个带有<code>dns_queries.txt</code>请求的文件（主要是ANY，以增加来自DNS服务器的响应的时间和大小）： </p><br><pre> <code class="plaintext hljs">#dns_queries.txt example.com ANY www.example.com ANY test.example.com ANY static.example.com ANY example.com  www.example.com  test.example.com MX</code> </pre> <br><p> 运行该实用程序的示例： </p><br><pre> <code class="plaintext hljs">dnsperf -s TARGET_IP -d dns_queries.txt -c 100 -n 100 -s =  IP- -d =      .   – stdin -c =   .         -n =  «»   .</code> </pre> <br><p>  <strong>2.攻击ICMP</strong> </p><br><p> 下一步测试是评估对大量ICMP流量的抵抗力。 由于出于技术原因，服务器通常需要能够响应ping请求，因此存在使用ping请求进行DDoS攻击的可能性。 除了指定排除<code>ping-to-death</code>可能性的设置外，您还需要确保服务器能够抵抗峰值ICMP负载。 要创建此类负载，最好使用众所周知的<a href="https://linux.die.net/man/8/hping3">hping3</a>实用程序，该实用程序可让您调整请求数，发送间隔和数据包大小。 </p><br><p> 运行该实用程序的示例： </p><br><pre> <code class="plaintext hljs">hping3 -i u1000 -d 1500 -c 100000 -1 TARGET_IP -i u100 =     (uX for X microseconds) -d 1500 =    -c 1000000 =     -1 =  ICMP</code> </pre> <br><p>  <strong>3. HTTP攻击</strong> </p><br><p> 现在，我们检查压力的主要功能是服务的主要功能-处理HTTP（S）流量。  <a href="https://linux.die.net/man/1/siege">围攻</a>是产生HTTP流量的最灵活和最简单的工具之一。  Siege是一个开源多线程实用程序，旨在测试Web资源的性能。 </p><br><p> 与DNSPerf一样，siege允许您向服务器加载来自给定数量的虚拟用户的请求（用户仿真是使用单独的端口进行的），以及使用一组预定义的请求。 这非常方便，因为您可以在测试中包括最耗费资源的查询。 </p><br><p> 运行该实用程序的示例： </p><br><pre> <code class="plaintext hljs">siege -b -c 100 -f test_urls.txt -b =   ( benchmark) -c =   .         -f =   </code> </pre> <br><p> 内容格式<code>test_urls.txt</code> ： </p><br><pre> <code class="plaintext hljs">http://example.com/site/login POST login=username&amp;password=test http://example.com/site/client POST useragent=Mozilla&amp;version=123&amp;date=24May http://example.com/site/order POST user=username&amp;company=ooo&amp;phone=812345678</code> </pre> <br><p> 如您所见，测试主要是使用POST请求执行的，与其他类型的请求相比，这些请求需要在服务器端进行处理并占用最多的资源。 </p><br><p> 所有选项均不使用IP欺骗，因为Amazon不允许这样做。 无论软件包中指定了什么src_IP，它都将在从实例退出时更改为正确的src_IP。 </p><br><p> 所有生成的请求都必须是合法的-没有任何待解决的外向流量-因为Amazon的DDoS策略非常严格。 即使是经过协调的压力测试，也至少需要几天才能与技术支持进行沟通，并且在第一个“恶意”行动中，我们禁止了流量从该港口驶出，并立即解释了这一要求。 </p><br><h3> 发起攻击的脚本 </h3><br><p> 对于远程测试管理，我们将准备启动所需攻击类型的bash脚本（dns.sh，ping.sh，http.sh）和有效负载文件（test_urls.txt，valid_dns_queries.txt）。 </p><br><p> 当我们将所有这些都上传到AWS映像（从中将创建所有实例）时，可以使用以下格式的命令远程运行每个测试： </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo &lt;stress-script&gt;.sh start &lt;params&gt; &amp;&gt;&gt;stress.log &amp;'</code> </pre> <br><p> 所需类型的脚本被指定为Stress-script.sh，而params是相应的参数。 在Stress.log文件中，我们将跟踪正在运行的实用程序的输出。 为了方便起见，我们将为不同的实用程序使用不同的日志：dns.log，ping.log，http.log。 </p><br><p>  <code>dns.sh</code>脚本示例： </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash if [[ ! "$1" =~ ^(start|stop|status)$ ]]; then echo "nothing to do: need argument for stop,start or status" exit 1 fi if [[ "$1" = "start" ]]; then shift dnsperf $@ fi if [[ "$1" = "stop" ]]; then kill $(pidof dnsperf) fi if [[ "$1" = "status" ]]; then if [[ ! "$(pidof dnsperf)" = "" ]]; then echo "dnperf is running with PID $(pidof dnsperf)" ps aux | grep dnsperf else echo "dnsperf is not running" fi fi</span></span></code> </pre> <br><p> 从代码中可以看出，脚本可以启动和停止，以及检查状态（运行/不运行）。 </p><br><p> 用于ICMP和HTTP测试的脚本以相同的方式构造，分别通过传递给参数的参数字符串开始hping3和siege。 </p><br><p> 命令示例： </p><br><pre> <code class="plaintext hljs">ssh instance-amazon 'sudo dns.sh start -s TARGET_IP -d valid_dns_queries.txt -c 1 -n 100 &amp;&gt;&gt;dns.log &amp;' ssh instance-amazon 'sudo ping.sh start -i u1000 -d 1500 -c 100000 -1 TARGET_IP &amp;&gt;&gt;ping.log &amp;' ssh instance-amazon 'sudo http.sh start -b -c 100 -f test_urls.txt &amp;&gt;&gt; http.log &amp;'</code> </pre> <br><h3> 监控脚本 </h3><br><p> 要评估传出的流量和测试基础结构的状态，我们需要一个监视工具。 为了简单和节省资源，我们使用iptables。 为此，我们将编写一个脚本来计算发送的MB数，并将其放在AWS映像上： </p><br><pre> <code class="plaintext hljs">#iptables.sh sudo iptables -N TRAFFIC_OUT sudo iptables -A TRAFFIC_OUT -p tcp sudo iptables -A TRAFFIC_OUT -p udp sudo iptables -A TRAFFIC_OUT -p icmp sudo iptables -A OUTPUT -j TRAFFIC_OUT sudo iptables-save</code> </pre> <br><p> 该脚本会创建一个新链TRAFFIC_OUT，并为必要的协议（tcp，udp，icmp）添加过滤器。 </p><br><p> 数据包转发到TRAFFIC_OUT已添加到OUTPUT链中。 </p><br><p> 可以通过以下命令找到传输的数据量： </p><br><pre> <code class="plaintext hljs"># iptables -L TRAFFIC_OUT -v -n -x | tail -n 3 | awk '{print $2/1024/1024,"Mb\t\t\t",$3}' : 2.2 Mb tcp 4.4 Mb udp 3.2 Mb icmp</code> </pre> <br><p> 将脚本作为服务安装。 为此，创建一个monitoring.service文件并将其移动到我们映像的<code>/etc/systemd/system</code>目录中： </p><br><pre> <code class="plaintext hljs"># /etc/systemd/system/monitoring.service [Unit] After=network.target [Service] ExecStart=/usr/local/bin/monitoring.sh [Install] WantedBy=default.target</code> </pre> <br><p> 现在，您可以将服务添加到启动中： </p><br><pre> <code class="plaintext hljs">systemctl enable monitoring.service systemctl start monitoring.service</code> </pre> <br><h2> 实例管理 </h2><br><p> 现在让我们处理远程（尽可能自动化）的实例管理。 </p><br><p> 为此，您可以使用<a href="https://aws.amazon.com/ru/cli/">AWS CLI</a>机制-控制台管理。 </p><br><p> 创建一个<a href="https://console.aws.amazon.com/iam/home%3Fnc2%3Dh_m_sc">秘密密钥</a> （访问密钥（访问密钥ID和秘密访问密钥））并配置控制台。 </p><br><p> 现在，我们可以访问该帐户的所有功能。 </p><br><p> 使用AWS的独特之处在于，所有操作都是针对特定区域执行的，如果涉及多个区域，则必须重复执行所有操作。 </p><br><p> 要从上面构建的图像创建一个新实例（假设脚本中使用了公共ami-ID），我们将执行以下操作： </p><br><ul><li> 创建一个SSH密钥并将其添加到AWS： </li></ul><br><pre> <code class="bash hljs">yes n |ssh-keygen -q -t rsa -f <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> -m pem -N <span class="hljs-string"><span class="hljs-string">""</span></span> &gt; /dev/null chmod 400 <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> aws ec2 import-key-pair --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --public-key-material file:///$(<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>)/<span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span>.pub</code> </pre> <br><ul><li> 创建一个安全组，该安全组允许通过SSH访问计算机。 否则，传入的SSH连接将被拒绝： </li></ul><br><pre> <code class="bash hljs">SECURITY=<span class="hljs-string"><span class="hljs-string">"ssh-group"</span></span> aws ec2 create-security-group --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --description <span class="hljs-string"><span class="hljs-string">"Just ssh. Nothing more"</span></span> IP_RANGE=<span class="hljs-string"><span class="hljs-string">"0.0.0.0/24"</span></span> aws ec2 authorize-security-group-ingress --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --group-name <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> --protocol tcp --port 22 --cidr <span class="hljs-variable"><span class="hljs-variable">$IP_RANGE</span></span></code> </pre> <br><ul><li> 使用先前创建的密钥和安全组创建一个实例，并指定映像ID。 一次创建的实例数可以是任意的： </li></ul><br><pre> <code class="bash hljs">IMG=<span class="hljs-string"><span class="hljs-string">'ami-0d0eaed20348a3389'</span></span> NUM=1 aws ec2 run-instances --region <span class="hljs-variable"><span class="hljs-variable">$REGION</span></span> --image-id <span class="hljs-variable"><span class="hljs-variable">$IMG</span></span> --count <span class="hljs-variable"><span class="hljs-variable">$NUM</span></span> --instance-type t2.micro --key-name <span class="hljs-variable"><span class="hljs-variable">$KEYNAME</span></span> --security-groups default <span class="hljs-variable"><span class="hljs-variable">$SECURITY</span></span> &gt; instances.json</code> </pre> <br><ul><li> 等待机器初始化。 这需要一些时间：首先我们获得成功响应（instances.json），但是那时机器只是创建但尚未启动（例如，尚未分配IP地址）。 必须等待启动完成（通常一分钟就足够了）。 </li></ul><br><p> 然后，如果我们知道IP地址，则可以通过SSH连接。 只需索取当前正在运行的计算机的列表即可。 在它们的参数中，我们找到PublicDnsName或PublicIpAddress。 </p><br><pre> <code class="bash hljs">aws ec2 describe-instances --region</code> </pre> <br><p> 接下来，我们执行SSH命令，指示上面创建的SSH密钥： </p><br><pre> <code class="plaintext hljs">ssh -I $KEYNAME -oStrictHostKeyChecking=no ubuntu''+ins_dns echo''O''</code> </pre> <br><p>  SSH命令使您可以控制攻击并获取有关攻击状态的所有信息，因为我们为实例提供了所有必需的脚本和工具。 </p><br><p> 您需要了解，大多数针对拒绝服务攻击的防御措施都会阻止从异常地接收到许多请求的IP地址。 因此，虚拟机的IP地址必须不断更改，以保持攻击能力。 </p><br><p> 每次机器启动时，AWS都会分配一个新的IP地址。 因此，要更改IP，您需要先关闭机器然后再打开（无需将其删除！）。 </p><br><p> 关闭和删除之间的区别在于我们发送不同的信号。 停止-关闭，终止-关闭并立即删除。 </p><br><p> 为了监视实例的传入流量，我们使用以下带有实例ID的命令：流量测量开始时，测量结束时，将值累加多少时间： </p><br><pre> <code class="bash hljs">aws cloudwatch get-metric-statistics --region REGION --namespace AWS/EC2 \ --statistics Sum --metric-name NetworkIn --start-time <span class="hljs-variable"><span class="hljs-variable">$STARTTIME</span></span> --end-time <span class="hljs-variable"><span class="hljs-variable">$FINISHTIME</span></span> --period <span class="hljs-variable"><span class="hljs-variable">$PERIOD</span></span> --dimensions Name=InstanceId,Value=<span class="hljs-variable"><span class="hljs-variable">$INCTANCEID</span></span></code> </pre> <br><h1> 服务可用性监控 </h1><br><p> 此外，要进行攻击，您将需要观察我们正在测试的服务是否仍然有效。 </p><br><p> 我们创建并运行最简单的“ ping”脚本来监视目标端口的可用性（在本例中为53和80）。 </p><br><p> 自动执行可用性检查的示例Python代码： </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">http</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(url)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'curl'</span></span>, <span class="hljs-string"><span class="hljs-string">'-w'</span></span>, <span class="hljs-string"><span class="hljs-string">'"%{time_total}"'</span></span>, <span class="hljs-string"><span class="hljs-string">'-o'</span></span>, <span class="hljs-string"><span class="hljs-string">'/dev/null'</span></span>, <span class="hljs-string"><span class="hljs-string">'-s'</span></span>, url] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = float(json.loads(result)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result * <span class="hljs-number"><span class="hljs-number">1000000</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dns</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ip, domain)</span></span></span><span class="hljs-function">:</span></span> cmd = [<span class="hljs-string"><span class="hljs-string">'dig'</span></span>, <span class="hljs-string"><span class="hljs-string">'any'</span></span>, <span class="hljs-string"><span class="hljs-string">'@'</span></span>+ip, domain ] result = check_output(cmd).decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>) result = int(result.split(<span class="hljs-string"><span class="hljs-string">'Query time:'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>].split(<span class="hljs-string"><span class="hljs-string">'msec'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result</code> </pre> <br><p> 接收到的信息存储在日志文件中，在此文件的基础上，根据攻击结果，可以构建资源可用性图。 </p><br><p> 在测试过程中，有必要不断检查“ ping”日志，以免完全和不可挽回地杀死资源。 一旦出现严重降级并且对请求的响应花费了太多时间，就必须停止攻击。 </p><br><p> 如果速度下降不明显，并且攻击强度已达到既定的最大值，则等待一两分钟是有意义的；如果服务继续正常运行而没有中断，则认为检查成功。 </p><br><h1> 财务问题 </h1><br><p> 值得讨论与测试组织有关的另一个问题-整个事件的成本。 </p><br><p> 亚马逊提供了详细的价格信息，但您需要了解您几乎必须支付所有费用。 但是，许多计算可以忽略。 首先，值得计算流量成本（取决于区域和要传输的信息总量）和租用实例的成本（每分钟支付）。 这些物品约占整个攻击成本的99％。 </p><br><p> 因此，根据[敌对规模]最大攻击力和计划发射的次数，分别计算攻击成本。 </p><br><p> 从简化计算的角度来看，最好使用不超过一年前注册的亚马逊帐户。 然后，部分操作将是免费的。  <a href="https://aws.amazon.com/ru/free/%3Fall-free-tier.sort-by%3Ditem.additionalFields.SortRank%26all-free-tier.sort-order%3Dasc">在此处</a>阅读有关免费使用限制的更多信息。 </p><br><p> 为了说明进行负载测试的成本的计算方式，假设我们要检查DNS服务器在10 Gb / s负载下的稳定性。 </p><br><p> 我们知道，在孟买启动的t3.small实例使用的工具和功能使您可以从一个正在运行的实例发出500 Mb / s的速度。 租用实体的价格为每小时$ 0.0224，用于流量-1 GB为$ 0.01093。 即，攻击高峰意味着同时运行20个实体。 </p><br><p> 我们将逐渐增加攻击力，为此，我们首先发射一个实体，然后每60秒增加一个实体。 </p><br><p> 计算成本的公式采用以下形式： </p><br><pre> <code class="plaintext hljs">60  * (   ) + 60  * 0,5 /c * (  ) =       60 . 1 * (    ) + 2 * (    ) + ... + 20 * (    ) =   </code> </pre> <br><p> 事实证明，对DNS服务器进行容量为10 Gb / s的攻击的成本约为70美元。 请注意，这是一个粗略的估计，因为无法准确预测流量。      <a href="https://aws.amazon.com/ru/ec2/pricing/on-demand/"></a> .  ,   –    ,     . </p><br><p>       .          . </p><cut></cut></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN481756/">https://habr.com/ru/post/zh-CN481756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN481746/index.html">在CLI中设置环境。 WSL / Windows终端</a></li>
<li><a href="../zh-CN481748/index.html">亚美尼亚的福利待遇：从保险和推荐奖金到按摩和贷款</a></li>
<li><a href="../zh-CN481750/index.html">任务编号3。 数据转换并上传到第三方服务</a></li>
<li><a href="../zh-CN481752/index.html">语言调查结果</a></li>
<li><a href="../zh-CN481754/index.html">我的机器人和锥子</a></li>
<li><a href="../zh-CN481758/index.html">国际空间站的建造，供应和参观统计</a></li>
<li><a href="../zh-CN481762/index.html">圣诞树下厨房的方程式</a></li>
<li><a href="../zh-CN481764/index.html">为什么绿色能源的前途艰难？</a></li>
<li><a href="../zh-CN481768/index.html">我们在1C中处理WebKit，例如，将TinyMCE集成到UT 11.4中的托管形式中</a></li>
<li><a href="../zh-CN481774/index.html">安全备忘单：虚拟补丁程序</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>