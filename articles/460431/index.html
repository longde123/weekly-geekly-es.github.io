<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üïü ü§≤üèø üèº Creaci√≥n de una canalizaci√≥n de pruebas automatizada en Azure DevOps üê≠ üè§ ‚õπÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recientemente, me encontr√© con una bestia no tan popular en el mundo de DevOps, las tuber√≠as de Azure DevOps. Inmediatamente sent√≠ la ausencia de inst...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Creaci√≥n de una canalizaci√≥n de pruebas automatizada en Azure DevOps</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/460431/">  Recientemente, me encontr√© con una bestia no tan popular en el mundo de DevOps, las tuber√≠as de Azure DevOps.  Inmediatamente sent√≠ la ausencia de instrucciones o art√≠culos claros sobre el tema, no s√© con qu√© est√° conectado, pero Microsoft claramente tiene algo en qu√© trabajar en t√©rminos de popularizaci√≥n de la herramienta.  Hoy construiremos una tuber√≠a para pruebas automatizadas dentro de la nube de Azure. <a name="habracut"></a><br><br>  Entonces, la tarea: <br>  Hay un software que se construye con el mismo Azure DevOps, se ensambla a partir de un proyecto en WIX.  Si hay inter√©s, escribir√© sobre esta herramienta.  De hecho, esta es una forma m√°s automatizada de construir instaladores de Windows, que reemplaza el InstallShield est√°ndar.  Por lo tanto, nuestro software crea y genera con √©xito un artefacto, un determinado setup.exe, que coloca la aplicaci√≥n en un sistema Windows.  Es necesario poner esta aplicaci√≥n en una m√°quina virtual similar a un producto, copiar las pruebas automatizadas preparadas por el equipo de prueba all√≠, ejecutarlas y recopilar los resultados para considerar que la rama es buena o mala antes de fusionarse.  Todo es como en GitLab, <s>solo a trav√©s de w ...</s> <br><br>  Como un entorno de virtualizaci√≥n donde ejecutaremos nuestras pruebas, obviamente usamos Azure DevTest Labs, una entidad en las suscripciones de Azure, que fue creada para torcer todo tipo de tonter√≠as de prueba por dinero razonable. <br><br><h1>  1. Integraci√≥n del lado de la nube </h1><br>  Primero, necesitamos integrar nuestros DevTest Labs con Azure DevOps, para lo cual necesitamos un Service Principal, esencialmente una cuenta de servicio que le permita ir a las tuber√≠as en la nube y crear / eliminar recursos all√≠ para nosotros mismos. <br><br>  Vaya a la suscripci√≥n y busque el servicio Azure Active Directory <br><br><img src="https://habrastorage.org/webt/cf/fn/bq/cffnbqsgvtmscikoypqdftkarpg.jpeg"><br><br>  Encontramos registros de aplicaciones y hacemos clic en Nuevo registro, esto crear√° nuestro principal de servicio.  No repasar√© qu√© configuraci√≥n elegir√© al crear, esto puede diferir para diferentes suscripciones. <br><br><img src="https://habrastorage.org/webt/ns/4a/jq/ns4ajqbtui4oz51gruhl84gejac.jpeg"><br><br>  Ahora debemos otorgar derechos a nuestro director de servicio.  Para hacer esto, vaya al icono de suscripci√≥n con una clave.  Elige nuestra suscripci√≥n. <br><br><img src="https://habrastorage.org/webt/-p/tj/te/-ptjtehk7ftpdtlf4op0dwlqj9g.jpeg"><br><br>  A continuaci√≥n, en Control de acceso, haga clic en Asignaci√≥n de roles y busque esta cuenta en la b√∫squeda por el nombre que acaba de crear.  Le damos el rol de Colaborador, esto es suficiente. <br><br><img src="https://habrastorage.org/webt/pr/nq/s_/prnqs_0culpmj9xrudzptpv4mc0.jpeg"><br><br>  Luego, regrese a nuestro Service Principal en Azure AD y abra sus propiedades.  M√°s tarde, necesitaremos todas las ID que est√©n all√≠, las guardaremos. <br><br>  Aqu√≠ es donde termina la configuraci√≥n de nuestro portal y vamos a Azure DevOps. <br><br><h1>  2. Integraci√≥n del lado de Azure DevOps </h1><br>  En primer lugar, vamos a la configuraci√≥n del proyecto y seleccionamos Conexiones de servicio.  Cree un nuevo elemento de tipo Azure Resource Manager. <br><br><img src="https://habrastorage.org/webt/ct/hc/7c/cthc7c3qagkfuyxa3_6fyod5k90.jpeg"><br><br>  Ahora necesitamos todas las ID que grabamos.  Haga clic en usar la versi√≥n completa del cuadro de di√°logo de conexi√≥n de servicio.  E ingrese todos los datos que recibimos del Director del Servicio.  Haga clic en verificar y si todo est√° bien, mantenga la conexi√≥n.  Ahora nuestras tuber√≠as pueden usarlo para conectarse a la nube. <br><br><img src="https://habrastorage.org/webt/it/7s/as/it7sas1cjqbrwt58uncazzfp4ee.jpeg"><br><br><h1>  3. Crear una tuber√≠a </h1><br>  Ahora procedemos a lo m√°s interesante, la construcci√≥n de la tuber√≠a en s√≠.  Abra el men√∫ de construcci√≥n de tuber√≠as <br><br><img src="https://habrastorage.org/webt/et/wd/h5/etwdh5romudzssphyz-hmliq2bw.jpeg"><br><br>  Nos recibe un men√∫ para crear una nueva compilaci√≥n, que por defecto intentar√° crear un archivo YAML para nosotros con una configuraci√≥n adecuada.  Rechazamos cort√©smente esto y elegimos la versi√≥n cl√°sica.  El deseo de Microsoft de hacer todo como las personas y dar la oportunidad de personalizar las canalizaciones a trav√©s de YAML tanto como sea posible, pero la escasa documentaci√≥n y la inoperancia pr√°ctica de muchos m√≥dulos nos dice que es demasiado pronto para usar esta funcionalidad. <br><br><img src="https://habrastorage.org/webt/it/at/gu/itatgu_alr1efjbtvlr6rin5e9i.jpeg"><br><br>  De la variedad de plantillas, necesitamos una tuber√≠a vac√≠a simple.  Despu√©s de su creaci√≥n, nos recibe una ventana de edici√≥n vac√≠a, en la que pasaremos mucho tiempo. <br><br><img src="https://habrastorage.org/webt/0t/g0/0h/0tg00hw3ojp3plkvochf9-skdac.jpeg"><br><br>  Por lo tanto, haga clic en + y acceda a una determinada tienda de m√≥dulos, desde donde necesitaremos los siguientes componentes de la lista. <br><br><img src="https://habrastorage.org/webt/9q/2l/ud/9q2ludjenipcm_m8oteqerfseoe.jpeg"><br><br>  Antes de continuar con la configuraci√≥n de la tarea de canalizaci√≥n, necesitamos crear y poner varios archivos en el proyecto.  Esta ser√° la plantilla ARM de nuestra m√°quina virtual, que generaremos en Azure DevTest Labs, el script para obtener la m√°quina IP despu√©s de que se haya creado y, si lo desea, los scripts de nuestras pruebas o lo que queremos ejecutar en el host. <br><br><h1>  4. Generaci√≥n de plantillas ARM </h1><br>  Para crear una m√°quina virtual, primero tendremos que generar una plantilla para ella, un archivo json, que colocamos en el c√≥digo del proyecto para que pueda ser le√≠do desde all√≠ por la tuber√≠a. <br><br>  Vamos a nuestro laboratorio y buscamos el men√∫ F√≥rmulas (bases reutilizables), hacemos clic para crear uno nuevo. <br><br><img src="https://habrastorage.org/webt/8w/rc/-l/8wrc-lfvdcettljp5-j7iclsz1u.jpeg"><br><br>  Seremos recibidos por una larga lista de im√°genes como base, la elecci√≥n del tama√±o de la m√°quina, todo lo mismo que cuando se crea una m√°quina virtual.  En esta etapa, no nos detendremos, pasaremos de inmediato al √∫ltimo elemento de las propiedades de la m√°quina, a saber, los artefactos.  Puede usar cualquier configuraci√≥n que sea necesaria para su entorno.  Por ejemplo, agrego una m√°quina al dominio y le agrego una cuenta de servicio como administrador para que la tuber√≠a pueda acceder a esta m√°quina con esta cuenta.  Todo esto puede variar, pero para una prueba exitosa del c√≥digo necesitamos un artefacto, en el que nos detendremos con m√°s detalle.  Para poner la √∫ltima versi√≥n del software que probamos en nuestra m√°quina, utilizaremos el artefacto Descargar Azure Pipelines Artifact y Run Script.  ¬øRecuerdas que al principio dije que en alg√∫n lugar una compilaci√≥n va con el instalador de la aplicaci√≥n?  Ahora necesitamos decirle a la m√°quina virtual, o m√°s bien a la plantilla, para que vaya y tome este artefacto.  Y no solo lo recog√≠, sino que tambi√©n lo configur√©, para lo cual completamos campos especiales que indican el proyecto, el nombre de la compilaci√≥n y la clave secreta.  La clave secreta, como en todos los sistemas de este tipo, se genera en la cuenta, en este caso en Azure DevOps y se almacena en Secretos en su laboratorio.  Hay una peque√±a advertencia, en Secrets la guardaremos, pero no est√° fr√≠a ni caliente, se lanzar√° desde otro usuario como parte de la tuber√≠a, por lo tanto, tendremos que ingresar manualmente la clave secreta en la plantilla nuevamente. <br><br>  Otro artefacto que debe incluirse es "Configurar WinRM", lo necesitaremos para el acceso posterior a la m√°quina.  Solo hay un par√°metro, nombre de host.  Como no lo sabemos de antemano, utilizaremos la variable% COMPUTERNAME%. <br><br><img src="https://habrastorage.org/webt/ve/46/ps/ve46psila9wlzhoh9hiiwatcvxe.jpeg"><br><br>  As√≠ que hemos agregado todos los artefactos necesarios, pasaremos a por qu√© vinimos aqu√≠.  Obtenemos la plantilla ARM generada en la pesta√±a Avanzado de la misma ventana de creaci√≥n de f√≥rmulas. <br><br><img src="https://habrastorage.org/webt/bj/ly/ae/bjlyaelkb2okdk8cvk3xvtjhrm0.jpeg"><br><br>  Copie el contenido de la p√°gina en el archivo VMtemplate.json y p√≥ngalo en la ra√≠z del proyecto.  Ya no necesitamos la nube, estamos regresando a la tuber√≠a. <br><br><h1>  5. Configuraci√≥n de tuber√≠a </h1><br>  Comencemos con lo m√°s importante e interesante, crear una m√°quina virtual, por eso hicimos todas estas integraciones y plantillas.  En la suscripci√≥n de Azure RM, seleccionamos nuestra conexi√≥n de servicio, que configuramos en el p√°rrafo 2. A continuaci√≥n, aparecer√° el entorno de laboratorio disponible.  Luego seleccionamos json que generamos y definimos algunas variables obligatorias.  El nombre de usuario y la contrase√±a del autom√≥vil se pueden configurar directamente o con variables, pero no estoy seguro de que funcione, sea lo que sea que escriba all√≠, no podr√≠a ingresar al autom√≥vil con estos cr√©ditos, lo principal es configurar el nombre del autom√≥vil para que siempre sea posible √önico  Para esto, uso la variable de entorno de compilaci√≥n. <br><br><img src="https://habrastorage.org/webt/cx/nw/gv/cxnwgvb73r6yougop6htozc6g3c.jpeg"><br><br>  A continuaci√≥n, establecemos otro punto importante.  Despu√©s de que el auto despegue, tambi√©n necesitamos conocer sus par√°metros de alguna manera, y es mejor no para nosotros sino para la l√≠nea de pago.  Para hacer esto, creamos un script, por ejemplo GetLabVMParams.ps1 y lo ponemos all√≠, en el proyecto.  Tom√© el texto del script en el sitio web de Microsoft, pero lo correg√≠ ligeramente para mi entorno, porque  tom√≥ m√°quinas PublicIP y FQDN.  No tengo ninguno, pero hay PrivateIP que no es tan f√°cil de obtener, as√≠ que agregu√© una pieza. <br><br><pre><code class="plaintext hljs">Param( [string] $labVmId) $labVmComputeId = (Get-AzureRmResource -Id $labVmId).Properties.ComputeId # Get lab VM resource group name $labVmRgName = (Get-AzureRmResource -Id $labVmComputeId).ResourceGroupName # Get the lab VM Name $labVmName = (Get-AzureRmResource -Id $labVmId).Name # Get lab VM public IP address # $labVMIpAddress = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName -Name $labVmName).IpAddress # Get lab VM FQDN # $labVMFqdn = (Get-AzureRmPublicIpAddress -ResourceGroupName $labVmRgName -Name $labVmName).DnsSettings.Fqdn # Get lab VM private IP address $VmNetworkdetails= (((Get-AzureRmVM -ResourceGroupName $labVmRgName -Name $labVmName).NetworkProfile).NetworkInterfaces).Id $nicname = $VmNetworkdetails.substring($VmNetworkdetails.LastIndexOf("/")+1) $labVMnetwork = (Get-AzureRmNetworkInterface -Name $nicname -ResourceGroupName $labVmRgName)|Select-Object -ExpandProperty IPConfigurations $labVMIpAddress = $labVMnetwork.PrivateIpAddress # Set a variable labVmRgName to store the lab VM resource group name Write-Host "##vso[task.setvariable variable=labVmRgName;]$labVmRgName" # Set a variable labVMIpAddress to store the lab VM Ip address Write-Host "##vso[task.setvariable variable=labVMIpAddress;]$labVMIpAddress" # Set a variable labVMFqdn to store the lab VM FQDN name Write-Host "##vso[task.setvariable variable=labVMFqdn;]$labVMFqdn" Write-Output $labVMIpAddress Set-Item wsman:\localhost\client\trustedhosts * -Force</code> </pre> <br>  De todo lo que lee el script, solo necesitamos la variable labVMIpAddress.  Bueno, esto es para m√≠, tal vez necesites algo m√°s, para esto no elimin√© nada y solo coment√© el exceso. <br><br>  Tambi√©n explicar√© la √∫ltima l√≠nea del script, permite que nuestro equipo de compilaci√≥n acceda a cualquier host a trav√©s de WinRM. <br><br>  El siguiente paso, ejecutamos nuestro maravilloso script.  Necesitar√° la misma conexi√≥n a la nube, la variable de entrada con la ID de la m√°quina, que para ese momento ya se conocer√° del paso anterior.  Como?  Aqu√≠ es necesario mencionar algo tan maravilloso como Variables de salida.  Cada paso puede tener una lista de variables que se pasan a los siguientes pasos de canalizaci√≥n.  En consecuencia, para nuestro s√∫per script, dicha variable ser√° labVMIpAddress, no olvide indicar esto. <br><br><img src="https://habrastorage.org/webt/yu/va/m7/yuvam7x2ikxspc7ucohyp5oivq4.jpeg"><br><br>  Adem√°s, hago cosas bastante simples que, adem√°s, pueden variar de un caso a otro.  Ejecuto un script remoto con la creaci√≥n de bolas, en el que luego cargar√© mis scripts. <br><br><pre> <code class="plaintext hljs">New-Item ‚ÄúC:\test" ‚Äìtype directory New-SMBShare ‚ÄìName ‚Äútest‚Äù ‚ÄìPath ‚ÄúC:\test‚Äù ‚ÄìFullAccess everyone</code> </pre> <br>  Por el nombre de las coles, est√° claro que luego copiamos alg√∫n script de muestra a la m√°quina y lo ejecutamos en un paso m√°s.  Como la direcci√≥n de la m√°quina remota, nuestra variable $ (labVMIpAddress) es √∫til para nosotros.  A continuaci√≥n, usamos la tarea "recoger el artefacto de las bolas" y copiamos los resultados del script a nuestro entorno de compilaci√≥n, luego guardamos estos archivos en el artefacto de compilaci√≥n con la misma tarea est√°ndar.  Despu√©s de que ya no necesitamos el autom√≥vil, lo matamos con el √∫ltimo paso.  La principal dificultad, como se puede ver en el volumen del art√≠culo, es integrarse con la nube y establecer contacto con la m√°quina virtual que cre√≥, entonces ya puede divertirse tanto como sea necesario. <br><br>  Este es mi primer art√≠culo, as√≠ que no juzgues estrictamente, los comentarios son bienvenidos. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460431/">https://habr.com/ru/post/460431/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460415/index.html">Apple Watch 4 (44 mm, 2019) vs Pebble Steel Classic (2014)</a></li>
<li><a href="../460419/index.html">Recuperaci√≥n de calor de gases de combusti√≥n: respetuoso con el medio ambiente</a></li>
<li><a href="../460421/index.html">Interruptor √≥ptico TP-Link T2600G-28SQ para proveedores de servicios: una revisi√≥n detallada</a></li>
<li><a href="../460423/index.html">WAL en PostgreSQL: 3. Punto de control</a></li>
<li><a href="../460425/index.html">Fr√≠o infernal, levitaci√≥n y plasma: pasado, presente y futuro de la superconductividad</a></li>
<li><a href="../460433/index.html">Riesgos y amenazas en Internet de las cosas.</a></li>
<li><a href="../460435/index.html">Petty little joy # 8: peque√±os placeres por trabajar con la base de datos</a></li>
<li><a href="../460437/index.html">C√≥mo sacamos una bicicleta de soporte t√©cnico</a></li>
<li><a href="../460439/index.html">Lenguaje de programaci√≥n P4</a></li>
<li><a href="../460441/index.html">Gleb Nitzman: "Encontr√© el final de una era en la que la gente a√∫n no hab√≠a perseguido el oro contenido en elementos de radio"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>