<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßùüèø üßëüèΩ‚Äçü§ù‚Äçüßëüèª üìå Ist es in 1C m√∂glich, die Technologie externer Komponenten nicht zu beobachten? Oder wie man Kollegen mit 1C gratuliert? üì¶ üë¥üèΩ üéÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es gab hier die Idee, unserer Hauptbuchhalterin mehr oder weniger originell zu gratulieren, zum Beispiel mit Hilfe ihres Lieblingsprogramms 1C? Aber w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ist es in 1C m√∂glich, die Technologie externer Komponenten nicht zu beobachten? Oder wie man Kollegen mit 1C gratuliert?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466713/">  Es gab hier die Idee, unserer Hauptbuchhalterin mehr oder weniger originell zu gratulieren, zum Beispiel mit Hilfe ihres Lieblingsprogramms 1C?  Aber wie? <br><br>  Nach einigem √úberlegen kam die Idee, das Hintergrundbild im Clientbereich herk√∂mmlicher Formulare f√ºr Konfigurationen auf 1C77-1C82 oder in einem externen Fenster f√ºr verwaltete Formulare 1C82 und in allen F√§llen f√ºr 1C83 als Hintergrundgl√ºckwunsch zu verwenden.  Zeigen Sie darauf die gew√ºnschte Nachricht an und geben Sie Links zum Gl√ºckwunschvideo an, wie in der Abbildung gezeigt. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a77/0bd/055/a770bd055ca43fdb5ad8d6f1f124253b.jpg" alt="Gl√ºckwunsch in 1C"><br><a name="habracut"></a><br><h2>  Erster Teil - Ergebnis </h2><br>  Offensichtlich ist diese Idee nicht neu.  Daher wurde 2011 <b>von <i>Aleksey Fedorov alias ALF</i></b> eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">√§hnliche L√∂sung</a> basierend auf <b>FormEx.dll</b> vorgeschlagen.  Und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wie dies erreicht werden kann,</a> wurden bereits 2008 gestellt. <br><br>  Zu einer Zeit haben wir diese Komponente auch verwendet, um das Hintergrundbild in 1C77 zu laden.  Das Herunterladen gro√üer BMP-Dateien (und anderer konnte nicht verwendet werden) war jedoch langsam (aus diesem Grund wurden kleine Bilder mit Kacheln verwendet), sodass der Wunsch bestand, eine eigene externe Komponente (VK) zu schreiben, die nur die erforderlichen Bilder herunterl√§dt und nichts weiter, es sei denn Was gibt es sonst noch als Testgel√§nde f√ºr Experimente? <br><br>  Eine solche Komponente wurde geschrieben (auch nur f√ºr BMP-Dateien, ggf. mit Kacheln).  Dort wurde die Funktion <b>WinAPI LoadImage ()</b> verwendet.  Diese DLL stand nicht in Konflikt mit FormEx.dll, sie war einfach, schnell genug und diente lange Zeit. <br><br>  All dies war wunderbar, aber es war Zeit, seine F√§higkeiten zu erweitern, und hier war ein anderer Ansatz erforderlich. <br><br>  In diesem Artikel werden die Probleme beim Erstellen von Multimediadateien nicht behandelt.  Dies ist nicht unsere Spezialit√§t.  Wir beschr√§nken uns nur auf einige Nuancen der Programmierung externer Komponenten f√ºr 1C. <br><br><h3>  1C77 </h3><br>  Da die Versionen der 1C-Plattform unterschiedlich sein k√∂nnen, kann es mehrere L√∂sungen geben.  In unserem Fall waren dies Konfigurationen auf 1C77 (Abb. 1). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b4/611/4ad/8b46114ad1ae83e57667cc4bb84aae7e.jpg" alt="Abb. 1. Gl√ºckwunschbild in der Testkonfiguration auf 1C77"><br>  Abb.  1. Gl√ºckwunschbild in der Testkonfiguration auf 1C77. <br><br>  Das Video hier ist zwar ein eigenes, aber die Idee seiner Entstehung stammt von <b><i>Anna Shiyanova unter dem Spitznamen "Special Case"</i></b> .  Dieses M√§dchen hat Talent, sie kann nachgeahmt werden, aber es ist kaum m√∂glich, den Stil vollst√§ndig zu wiederholen.  In diesem Fall wollte ich zumindest ein Element der Kreativit√§t. <br><br>  Wenn einer der Kollegen es bereits satt hat, die Gl√ºckw√ºnsche anderer zu betrachten, kann er das Bild mit ‚Äû <b>Alt + I</b> ‚Äú √ºberladen (Abb. 2-3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01a/8c1/200/01a8c120008b72dd648b7c8697298d65.jpg" alt="Abb. 2. W√§hlen Sie ein anderes Hintergrundbild im Men√º ‚ÄûDatei / Hintergrund ausw√§hlen‚Äú oder mit ‚ÄûAlt + I‚Äú."><br>  Abb.  2. W√§hlen Sie ein anderes Hintergrundbild im Men√º "Datei / Hintergrund ausw√§hlen" oder mit "Alt + I". <br><br>  Gleichzeitig finden Sie Informationen zu dem von " <b>Alt + L</b> " verwendeten Modul (Abb. 3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/499/499/f23/499499f23ec33734bd6a5068f5d493b8.jpg" alt="Abb. 3. √úberladenes Hintergrundbild mit Informationen zum Programm (&quot;Hilfe / Informationen zum LionExt32.dll-Modul&quot; oder &quot;Alt + L&quot;)"><br>  Abb.  3. √úberladenes Hintergrundbild mit Informationen zum Programm (‚ÄûHilfe / Informationen zum LionExt32.dll-Modul‚Äú oder ‚ÄûAlt + L‚Äú). <br><br><h3>  1C82 konventionelle Formen </h3><br>  Nat√ºrlich orientiert sich die Mehrheit jetzt am G8 (1C8x).  Das Arbeiten mit dem Hintergrundbild in 1C ist jedoch nur auf normalen Formularen in Version 8.2 und weniger m√∂glich. Wenn Sie keine Verarbeitung verwenden, die im Desktop-Modus beginnt, √ºberlappt sich unser Hintergrund einfach vollst√§ndig (Abb. 4). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/390/123/bfd/390123bfd2ef88bfbc108dbe44c70835.jpg" alt="Abb. 4. Gl√ºckwunschbild in der Testkonfiguration auf gew√∂hnlichen Formularen 1C82"><br>  Abb.  4. Gl√ºckwunschbild in der Testkonfiguration zu den √ºblichen Formularen 1C82. <br><br>  Beachten Sie, dass die Links zu Abb.  4 zeigen nicht unser Video an.  Sie werden nur f√ºr den Test angezeigt. <br><br>  In gew√∂hnlichen Formen bietet 1C82 nicht mehr die Standardmethode f√ºr den Zugriff auf das Men√º, da es dort nicht systemisch ist, wie bei den "sieben", sondern "eigenen" (obwohl das System erstellt werden kann, aber warum ben√∂tigen wir zwei Hauptmen√ºs?).  Es k√∂nnen jedoch Hotkeys verwendet werden.  Aus dem gleichen Grund rufen wir in unserer Komponente ‚ÄûAlt + I‚Äú einen Dialog wie in Abb. 2 auf und laden einen weiteren Hintergrund (Abb. 5). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3f/535/deb/c3f535deb522e2ae7ad8937ce31b1188.jpg" alt="Abb. 5. √úberladenes Hintergrundbild in ‚Äûdicken‚Äú 1C82-Formularen"><br>  Abb.  5. √úberladenes Hintergrundbild in ‚Äûdicken‚Äú 1C82-Formularen. <br><br>  Ebenso k√∂nnen Sie Informationen √ºber das Modul erhalten, indem Sie die Taste "Alt + L" dr√ºcken, wie in Abb.  3. <br><br><h3>  1C82 verwaltete Formulare </h3><br>  F√ºr verwaltete Formulare in 1C82 finden Sie immer noch das Fenster, das wir auf der siebten Verschachtelungsebene ben√∂tigen, z. B. " <b>V8FormElement</b> ", und zeichnen darauf, aber irgendwie ist es nicht interessant. <br><br>  Aus diesen √úberlegungen folgt f√ºr uns, dass es einfacher ist, ein externes Fenster mit einer Gl√ºckwunschbotschaft zu erstellen (Abb. 6), als jeden Einzelfall zu behandeln.  Das Fenster selbst kann durch " <b>Esc</b> ", " <b>Strg + F4</b> ", " <b>Alt + F4</b> " oder durch Klicken auf das " <b>Kreuz</b> " geschlossen oder vielmehr minimiert werden. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/790/cd9/79d/790cd979df8a4d97ff5488c50fa4bd6c.jpg" alt="Abb. 6. Gl√ºckwunschbild in einer Testkonfiguration auf verwalteten Formularen 1C82"><br>  Abb.  6. Gl√ºckwunschbild in einer Testkonfiguration auf verwalteten Formularen 1C82. <br><br>  Dar√ºber hinaus kann das minimierte Fenster (Abb. 7) wieder erweitert werden. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66c/1a7/c7f/66c1a7c7f725404604318cdcde3a9915.jpg" alt="Abb. 7. Das minimierte Bild des externen Fensters in verwalteten Formularen 1C82"><br>  Abb.  7. Ein minimiertes Bild des externen Fensters in verwalteten Formularen 1C82. <br><br>  Die Abmessungen und die relative Position des Au√üenfensters k√∂nnen ge√§ndert werden, hier ist alles wie gewohnt (siehe vergr√∂√üerte Bilder der Au√üenfenster in Abb. 6 und Abb. 10).  Beachten Sie, dass Hotkeys nur funktionieren, wenn das externe Fenster aktiv ist. <br><br><h3>  1C83 herk√∂mmliche Formen </h3><br>  In 1C83 gibt es √ºberhaupt keine untergeordneten Fenster mehr, die als Kriterium f√ºr Version 1C in unserer DLL dienen k√∂nnen.  Dar√ºber hinaus sind ‚Äûdicke‚Äú Formulare ein Rahmenfenster (Abb. 8) und verwaltete Formulare rahmenlos (Abb. 9).  Das hei√üt, alles, was kein Rahmen ist, kann neu gezeichnet werden.  Ein Frame kann auch neu gezeichnet werden, jedoch nur als Systemelement. <br><div class="scrollable-table"><table><tbody><tr><th><img src="https://habrastorage.org/getpro/habr/post_images/f9c/35e/0da/f9c35e0da01025306525d14f700d22a4.jpg" alt="Abb. 8. Rahmenfenster in ‚Äûdicken‚Äú Formen 1C83"></th><th><img src="https://habrastorage.org/getpro/habr/post_images/962/5f9/e7c/9625f9e7c28fed4c9226ee73d8126ed8.jpg" alt="Abb. 9. Rahmenloses Fenster in verwalteten Formularen 1C83"></th></tr><tr><th>  Abb.  8. Rahmenfenster in ‚Äûdicken‚Äú Formen 1C83. </th><th>  Abb.  9. Rahmenloses Fenster in kontrollierten Formen 1C83. </th></tr></tbody></table></div>  Hier haben wir ein Testfenster mit einer dynamischen Bibliothek erstellt und es dem 1C-Hauptfenster untergeordnet.  Der Unterschied im Verhalten ist in den Figuren zu sehen. <br><br><h3>  1C83 verwaltete Formulare </h3><br>  Im Fall von 1C83, wie in den verwalteten Formularen 1C82, werden wir unsere Gl√ºckw√ºnsche nicht vor dem Hintergrund, sondern in einem separaten Fenster ziehen, dessen Prototyp in Abb. 1 dargestellt ist.  8-9.  Als Ergebnis <b>liefert</b> die gew√ºnschte Komponente ( <b>LionExt32.dll</b> oder <b>LionExt64.dll</b> ) das folgende Ergebnis (Abb. 10-12). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/104/cf1/f10/104cf1f10c6ae652d24edea7082c7e6c.jpg" alt="Abb. 10. Das Hintergrundbild im externen Fenster f√ºr herk√∂mmliche Formulare 1C83"><br>  Abb.  10. Das Hintergrundbild im externen Fenster f√ºr herk√∂mmliche Formulare 1C83. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56a/03f/fc7/56a03ffc7fe1f2bfee6358ecb81af9fa.jpg" alt="Abb. 11. Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 14, 64-Bit-Version"><br>  Abb.  11. Das Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 14, 64-Bit-Version. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/05e/12f/71c/05e12f71ccfb9212b96bc3db92630869.jpg" alt="Abb. 12. Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 15, 64-Bit-Version"><br>  Abb.  12. Das Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 15, 64-Bit-Version. <br><br><h3>  Vorl√§ufige Ergebnisse </h3><br>  Diese Komponente wurde tats√§chlich in der Praxis eingesetzt (Abb. 1), der Hauptbuchhalter war zufrieden, alles lief wunderbar.  Dabei stellte sich heraus, dass Benutzer gerne ihre eigenen Hintergrundbilder ausw√§hlen, in diesem Fall um an den "Sieben" zu arbeiten.  F√ºr den G8 ist unsere Komponente mit einer Reserve f√ºr die Zukunft angepasst, w√§hrend sie als Demoversion betrachtet werden sollte. <br><br>  Das Interesse hierbei war, dass f√ºr <b><i>diese Komponente keine Konformit√§t mit der Technologie zur Erstellung externer Komponenten aus 1C erforderlich war</i></b> .  Vielleicht entstehen zus√§tzliche Ideen, um seine F√§higkeiten zu erweitern.  Beispielsweise m√∂chten Sie f√ºr Konfigurationen, die vollst√§ndig unterst√ºtzt werden, keine √Ñnderungen am 1C-Code ohne besondere Notwendigkeit vornehmen.  In diesem Fall k√∂nnte man die M√∂glichkeit bieten, eine beliebige DLL extern in den Adressraum 1C zu laden.  Dies ist jedoch das Thema eines anderen Artikels. <br><br>  Bei technischen Neuerungen wurde ein Schloss verwendet, um unsere Komponente mit der 1C-Plattform zu entladen (da sie nicht dem VK-Format entspricht).  Ein weiterer Trick erm√∂glichte es au√üerdem, dem untergeordneten Fenster ein <b>lokales Men√º</b> zuzuweisen, da das Windows-Betriebssystem die Erstellung eines solchen Men√ºs f√ºr untergeordnete Fenster blockiert.  Daher werden lokale Men√ºs nirgendwo im selben <b>MDI</b> (Multi Document Interface) angezeigt.  Er wird durch Befehlsfelder, Symbolleisten und ein Kontextmen√º ersetzt.  Es gibt noch einen Moment zum Aktualisieren von Fenstern.  Manchmal kommt es vor, dass weder <b>UpdateWindow ()</b> noch <b>InvalidateRect ()</b> ordnungsgem√§√ü funktionieren.  In diesem Fall sind jedoch einige Funktionen erfolgreich: <br><br><pre><code class="cpp hljs">ShowWindow(hWnd, SW_HIDE); ShowWindow(hWnd, SW_SHOW);</code> </pre> <br>  Es sollte auch beachtet werden, dass unsere Komponente m√∂glicherweise mit anderen in Konflikt steht, z. B. mit FormEx.dll f√ºr 1C77.  In diesem Fall muss es zuletzt geladen werden. <br><br>  √úbrigens wird bemerkt, dass beim Erstellen einer Konfiguration in Version 1C-8.3.14 und h√∂her die Komponente nicht regelm√§√üig geladen wird.  Wenn die Datenbank jedoch in einer fr√ºheren Version von 1C erstellt und in den neuesten Versionen ge√∂ffnet wurde, gibt es keine Probleme beim Laden unserer VK.  Dies weist erneut auf die Notwendigkeit hin, einen externen Bootloader zu erstellen. <br><br>  Dieses Projekt verwendet das <b>WinAPI GDI +</b> -Subsystem.  Mit ihm k√∂nnen Sie Bilder in verschiedenen Formaten anzeigen: <b>bmp, jpg, gif, png, tif</b> und andere.  In derselben Reihenfolge versucht die Komponente, die erste verf√ºgbare <b>Main. *</b> -Datei aus dem lokalen <b>Pics-</b> Verzeichnis in der aktuellen Konfiguration zu laden.  Wenn keine dieser Dateien gefunden wird, wird ein einfaches Hintergrundbild aus Komponentenressourcen verwendet.  In Abb.  Abbildung 13 zeigt dieses Hintergrundbild f√ºr die √ºblichen Formen von 64-Bit 1C83, Version 15. Zur √Ñnderung wurde das externe Fenster des Slang vergr√∂√üert und ein weiteres Bild aus der Datei <b>Main1.png</b> , das ‚Äûgekachelt‚Äú wurde, zu seinem Hintergrund hinzugef√ºgt. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/71c/80a/48a/71c80a48a18236e495a1d62b0f316e11.jpg" alt="Abb. 13. Das Standard-Hintergrundbild f√ºr regul√§re Formulare 64-Bit 1C83, Version 15"><br>  Abb.  13. Das Standard-Hintergrundbild f√ºr die √ºblichen Formen von 64-Bit-1C83, Version 15. Au√üerdem wurde ein weiteres Bild aus der Datei Main1.png hinzugef√ºgt, das als ‚ÄûKacheln‚Äú ausgelegt ist. <br><br>  Es gibt keinen Unterschied in der Funktionsweise der Komponente in verschiedenen Bitmodi. <br><br>  Es kann auch angemerkt werden, dass unsere Komponente das Hauptfenster von 1C und gegebenenfalls dessen MDI-Client unterklassifiziert.  Dies dient anscheinend als Konfliktquelle f√ºr FormEx.dll, wenn es zuletzt geladen wird (in 1C77). <br><br><h2>  Zweiter Teil - Technisch </h2><br>  Das Projekt selbst finden Sie unter folgenden Links: <br><br><ul><li>  <a href="">Testkonfiguration auf 1C77</a> </li><li>  <a href="">Testkonfiguration auf 1C82</a> </li><li>  <a href="">Testkonfiguration auf 1C83</a> </li><li>  <a href="">Projekt auf MS VS C ++, v.</a>  <a href="">13</a> </li></ul><br>  Ein <b>C ++ -</b> Projekt kann problemlos f√ºr Version <b>10</b> angepasst werden, wenn die Zeichenfolge " <b>v120</b> <b>"</b> in den Konfigurationsdateien durch " <b>v100</b> " und " <b>ToolsVersion =" 12.0</b> "durch" <b>ToolsVersion = "4.0" ersetzt wird</b> . <br><br>  Der Code f√ºr die <b>32-</b> Bit- und <b>64-</b> Bit-Versionen von <b>1C ist</b> derselbe und kann gleichzeitig kompiliert werden. <br><br>  Version 1C77 wird in der externen Komponente durch das Funktionshandle GetMenu <b>()</b> ungleich Null und Version 1C83 durch das Fehlen von untergeordneten Fenstern im Hauptfenster bestimmt, deren Handle durch die Funktion <b>GetForegroundWindow () bestimmt</b> wird. <br><br><h3>  Informationen zur Technologie zum Erstellen externer Komponenten f√ºr 1C </h3><br>  Auf den ITS-Discs der Firma 1C und im Internet finden Sie leicht Informationen zur Erstellung von VC und den entsprechenden Vorlagen in verschiedenen Programmiersprachen.  In den Zeiten von 1C77 erf√ºllten diese Muster jedoch "nicht nur alle". <br><br>  Wenn Sie sich einige weit verbreitete Komponenten ansehen, insbesondere f√ºr 1C77, werden Sie feststellen, dass ihre Autoren h√§ufig spezielle Programmiermethoden verwendeten, um die Funktionen ihrer Designs zu erweitern. <br><br>  M√∂glicherweise war eine der ersten derartigen externen Komponenten <b><i>"RAINBOW ADDIN 2000 f√ºr 1C: Enterprise 7.7".</i></b>  Das vielleicht wichtigste war hier ein tieferes Eindringen in die Eingeweide der ‚ÄûSieben‚Äú, als es die offizielle VK-Technologie erlaubte, obwohl sie dem VK-Format folgte.  Dies wurde aufgrund der empfangenen, m√∂glicherweise nicht standardm√§√üigen Methoden, Header (* .h-Dateien) von 1C77-Bibliotheksdateien erreicht, die in anderen weithin bekannten Projekten verwendet wurden. <br><br>  Wenn 1C-Funktionen wie <b>LoadExternalComponent ()</b> und <b>ConnectExternalComponent ()</b> es Ihnen erm√∂glichen, <b>externe DLLs</b> in Ihren eigenen Adressraum einzubetten (zun√§chst einmal, die das VK-Technologieformat erf√ºllen), warum erliegen Benutzerprogramme dann nicht der Versuchung und versuchen, auf andere verborgene zuzugreifen sie, Prozeduren und andere Objekte der Zielplattform?  Dieser Ansatz wurde von der <b>Rainbow.dll-</b> Komponente erfolgreich demonstriert. <br><br>  Sp√§ter wurde ein √§hnlicher Mechanismus von anderen Autoren der Komponente 1C Version 7.7 √ºbernommen.  Besonders hervorzuheben ist die Komponente f√ºr die "sieben" <b>1C ++. Dll</b> und <b>sozusagen</b> ein Sonderfall von <b>FormEx.dll</b> . <br><br>  Der nicht triviale Ansatz f√ºr das Design externer Komponenten f√ºr 1C77 endete jedoch nicht dort.  Anscheinend h√§tte jemand sagen sollen: ‚ÄûWarum brauchen wir einen Schmied?  Wir brauchen keinen Schmied! "  Mit ‚ÄûSchmied‚Äú meinen wir hier die COM-Technologie von MicroSoft, auf die gewisserma√üen die VK-Technologie f√ºr die ‚ÄûSieben‚Äú folgte.  Nein, wirklich, warum brauchen wir eine Registrierung, wenn wir unsere VK direkt herunterladen?  Dies mag f√ºr Webbrowser, die mit dem Internet arbeiten, sinnvoll sein, f√ºr den lokalen Betrieb ist die Verwendung der Registrierung jedoch eindeutig redundant.  Zumindest sollte dies keine Voraussetzung sein.  Dar√ºber hinaus ben√∂tigen Sie zum Bearbeiten der Registrierung Administratorrechte. <br><br>  Beachten Sie, dass 1C diese Technologie sehr mochte (zumindest bis zur Portierung von 1C auf Linux).  Wir behandeln sie ziemlich cool.  COM ist praktisch f√ºr die Verwendung der ActiveX-Komponente, und dies ist nat√ºrlich, da letztere urspr√ºnglich f√ºr das Internet entwickelt wurden. <br><br>  In den neuesten Versionen hat 1C jedoch die M√∂glichkeit hinzugef√ºgt, die <b>native API-</b> Technologie zu verwenden, sodass keine Registrierung erforderlich ist.  Im Prinzip ist dies das, was wir brauchen, au√üer dass diese Technologie in den "Sieben" nicht anwendbar ist und f√ºr einige immer noch relevant ist. <br><br>  Manchmal treten jedoch relativ einfache Aufgaben auf, wenn Sie keinen Haufen Boilerplate-Code f√ºr VK verwenden m√∂chten und es ratsam ist, mit 1C nur von der Seite der externen Komponente aus zu arbeiten.  Wie in unserem Fall beispielsweise die Demonstration eines Gl√ºckwunschbildes im Kundenbereich oder, falls erforderlich, in einem separaten Fenster, Konfiguration 1C. <br><br>  Mit anderen Worten, wenn wir keine Daten direkt zwischen 1C und VK austauschen wollen, werden wir mit einer einfacheren und universelleren Version der externen Komponente f√ºr 1C sehr zufrieden sein.  Einfachheit wird hier aufgrund des Fehlens von Boilerplate-Code erreicht. <br><br><h3>  Alternative Technologie zum Erstellen von VK f√ºr 1C </h3><br>  Da VK f√ºr 1C ein Sonderfall eines <b>COM-Servers ist</b> (vor der <b>Native API-</b> Technologie), gab es VK-Entwickler, die sagten: ‚ÄûCOM - nein!‚Äú.  Besonders auff√§llig ist die T√§tigkeit von <b><i>Alexander Orefkov</i></b> in dieser Richtung.  Die Komponenten " <b>1sqlite.dll</b> ", " <b>TurboMD.dll</b> " und m√∂glicherweise andere verwenden COM aus dem Wort "vollst√§ndig" nicht.  Auf diesem Weg entwickelt sich auch die <b>Yoksel-</b> Komponente (" <b>SpreadSheet.dll</b> "). <br><br>  Aber wie l√§dt dann der VK-Lader von 1C77 diese Komponenten?  Schlie√ülich versuchen sie dort nicht einmal, eine Art COM nachzuahmen.  Wenn wir versuchen, eine Standard-DLL, die beispielsweise vom <b>MS VC ++ -</b> Assistenten generiert wurde, unverbl√ºmt in die <b>LoadExternalComponent ()</b> -Funktion zu verschieben, haben wir einen Mist. <br><br>  In der "Sieben" erhalten wir eine Nachricht wie: <blockquote>  Beim Erstellen eines Objekts aus der DLL-Komponente &lt;Vollst√§ndiger Pfad \ Komponentenname&gt; ist ein Fehler aufgetreten (CLSID fehlt). </blockquote><br>  Im "dicken" 32-Bit-Client ist die "Acht" -Nachricht √§hnlich.  Dieselbe DLL verursacht ein √§hnliches Fluchen (Abb. 15): <blockquote>  Fehler beim Aufrufen der Kontextmethode (Externe Komponente laden): Fehler beim Laden der externen Komponente </blockquote><br>  Wie l√∂sen die genannten Bibliotheken dieses Problem?  Wenn wir die Texte der Programme Orefkov und Yoksel studieren, kommen wir letztendlich zu dem Schluss, dass die folgenden ‚Äû <b>magischen Linien</b> ‚Äú in der Ressourcendatei (* .rc oder * .rc2) ‚Äûschuld‚Äú sind: <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0sd" // 1sqlite.dll 100 "\0tmd" // TurboMD.dll 100 "\0f" // SpreadSheet.dll END</code> </pre> <br>  Das hei√üt,  In den Programmressourcen gibt es eine Zeile mit dem Bezeichner <b>100</b> und einem Zeichenfolgenwert, dessen erstes Zeichen Null ist.  Sie k√∂nnen mit Variationen solcher Zeichenfolgen experimentieren, aber die Zeichenfolge " <b>\ 0L</b> " ist f√ºr mich in Ordnung.  Daher erstellen wir eine Ressourcendatei und schreiben Zeilen wie folgt: <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0L" //    1     ! END</code> </pre> <br>  Wir verbinden diese Datei mit unserem einfachsten DLL-Projekt, das vom MS C ++ - Assistenten generiert wurde. F√ºgen Sie den folgenden Code hinzu: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: MessageBox(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">",  DllMain()!"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, MB_OK); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_ATTACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  und beobachten (Abb. 14). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/715/a71/7f7/715a717f7ee778dd219e79e5fbd43e97.jpg" alt="Abb. 14. Verwendung des einfachsten ‚ÄûVK‚Äú in 1C82"><br>  Abb.  14. Verwendung des einfachsten ‚ÄûVK‚Äú in 1C82. <br><br>  Ohne "magische Linien" in der Ressourcendatei wird unsere DLL nach dem Anzeigen von MessageBox sofort mit einem Fluch von 1C entladen (Abb. 15). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/cec/432/a98cec4326033180917940aa248dbc96.jpg" alt="Abb. 15. Fehler beim Laden der regul√§ren DLL in 1C82"><br>  Abb.  15. Fehler beim Laden der regul√§ren DLL in 1C82. <br><br>  Das hei√üt, diese Leitungen haben wirklich einen magischen Effekt auf den Lader externer 1C-Komponenten. <br><br>  Der erste, wie es scheint, "magische Linien" wurde in seinem alten Artikel von <b><i>Alexei Fedorov (ALF) beschrieben</i></b> , aber der Link dazu ist nicht mehr verf√ºgbar, und der Autor sieht den Punkt in seiner Neuver√∂ffentlichung nicht.  Dar√ºber hinaus hat <b><i>Alexander Orefkov</i></b> sie am intensivsten genutzt, und anscheinend war der Autor nach seiner Vorlage <b><i>Yoksel</i></b> .  Deshalb werden wir √ºber die <b><i>‚Äûmagischen‚Äú Linien von Fedorov-Orefkov sprechen</i></b> .  Ihre Bedeutung ist es, das Entladen von nicht standardm√§√üigen (aus Sicht von 1C) DLL-Dateien durch die Funktion <b>LoadExternalComponent () zu blockieren</b> .  Dar√ºber hinaus funktioniert diese Technik, wie wir sehen, nicht nur in 1C77, sondern auch in ‚Äûdicken‚Äú 1C82-Formen. <br><br>  In den verwalteten Formularen 1C82 und in allen Versionen von 1C83 wurde diese Funktion jedoch bereits vollst√§ndig unterbrochen (ein weiterer Loader wurde ebenfalls angezeigt - <b>ConnectExternalComponent ()</b> ). <br><br>  In modernen Versionen von 1C m√ºssen Sie daher nach anderen einfachen Alternativen zu den ‚Äûmagischen‚Äú Linien von Fedorov-Orefkov suchen. <br><br>  Und eine solche Alternative ist einfach anzubieten.  Der Punkt ist einfach.  Der 1C-Loader entl√§dt die "falsche" Komponente, wenn er eine Ausnahme ausl√∂st, wenn er versucht, mit dem angegebenen Protokoll darauf zuzugreifen, z. B. wenn er die Version der Komponente anfordert.  Nat√ºrlich haben wir nichts dergleichen, was als Grundlage f√ºr das Entladen einer nicht standardm√§√üigen DLL dient.  Die Anforderung von 1C, dass das Betriebssystem diese dynamische Bibliothek entl√§dt, kann vom System ignoriert werden, wenn diese VK noch irgendwo verwendet wird.  Anstelle des L√∂schens selbst reduziert das System einfach den Nutzungsz√§hler des gew√ºnschten Moduls.  Und physisch nicht fr√ºher l√∂schen, als dieser Z√§hler zur√ºckgesetzt wird.  Daher ist es unsere Aufgabe, diesen Z√§hler k√ºnstlich zu erh√∂hen. <br><br>  Dazu k√∂nnen Sie unsere DLL-Funktion WinAPI <b>LoadLibrary ()</b> im Abschnitt <b>DLL_THREAD_ATTACH</b> erneut <b>aufrufen</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: { WCHAR szDllName[_MAX_PATH] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-comment"><span class="hljs-comment">//     dll GetModuleFileName(hModule, szDllName, _MAX_PATH); //MessageBox(NULL, szDllName, L"Info", MB_OK); //    dll (     183), //      DLL_PROCESS_ATTACH HMODULE hDll = LoadLibrary(szDllName); break; } // case DLL_PROCESS_ATTACH case DLL_THREAD_ATTACH: break; case DLL_THREAD_DETACH: break; case DLL_PROCESS_DETACH: break; } // switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  Das ist alles!  Das Problem ist gel√∂st.  Durch das Abrufen derselben dynamischen Bibliothek wird der Nutzungsz√§hler um eins erh√∂ht, und das Entladen (mit vorl√§ufigem Zugriff auf den Abschnitt <b>DLL_THREAD_DETACH</b> ) wird um eins verringert.  Insgesamt haben wir <b>2 - 1 = 1&gt; 0</b> , daher wird das Betriebssystem unsere DLL nicht entladen.  Dar√ºber hinaus wird eine <b>Neuinitialisierung des</b> Abschnitts <b>DLL_PROCESS_ATTACH</b> nicht durchgef√ºhrt. <br><br>  Daraus l√§sst sich √ºbrigens ersehen, wie 1C in seinen neuesten Versionen mit einem √§hnlichen Trick umgehen kann (und dies anscheinend bereits in den in 1C-8.3.14 und h√∂her erstellten Konfigurationen).  Es kann die Funktion <b>LoadLibraryEx ()</b> mit einem Parameter verwenden, der die Ausf√ºhrung des Initialisierungsabschnitts <b>DLL_PROCESS_ATTACH</b> blockiert. <b>Danach</b> werden sofort die erforderlichen exportierten Funktionen aufgerufen.  Wenn Sie sich den Code des VK-Beispiels f√ºr die native API ansehen, sehen Sie, dass der Initialisierungscode nicht aufgerufen werden muss, da er im VK-Format leer sein muss. <br><br>  In Bezug auf die Beispiele f√ºr die Verwendung der COM-Technologie ist es offensichtlich, dass die Ausf√ºhrung des Initialisierungsabschnitts <b>DLL_PROCESS_ATTACH</b> dort erforderlich ist. Daher ist in nicht zu neuen Versionen von 1C, genauer gesagt in den Konfigurationen in 1C-8.3.13 und darunter, der 1C-Loader f√ºr uns geeignet: <br><br><pre> <code class="plaintext hljs">(, , .COM);</code> </pre> <br>  Hier kann der letzte Parameter entfernt werden, da er standardm√§√üig impliziert ist.  Gleichzeitig k√∂nnen sie in jeder h√∂heren Version normal ge√∂ffnet werden.  In den Versionen 1C83 passt der vorherige Bootloader <b>LoadExternalComponent (Component Address)</b> nicht mehr zu uns (bzw. die ‚Äûmagischen Linien‚Äú von Fedorov-Orefkov funktionieren dort nicht). <br><br>  Im allgemeinen Fall kann das Problem, wie bereits erw√§hnt, mit einem externen Bootloader gel√∂st werden.  Oder, was ganz nat√ºrlich ist, die Technologie der externen Komponenten von 1C auf die eine oder andere Weise zu beobachten. <br><br>  Es sollte auch beachtet werden, dass die Experimente in Dateiversionen von 1C mit unterschiedlichen Bittiefen durchgef√ºhrt wurden.  Um unsere Komponente herunterzuladen, m√ºssen Sie m√∂glicherweise die Eigenschaft " <b>Synchronous Call Usage Mode</b> " in der Konfiguration auf " <b>Use</b> " setzen. <br><br>  Es versteht sich auch, dass Sie die Verwendung einer solchen Technik auf eigenes Risiko durchf√ºhren, im Voraus mit Testkonfigurationen oder Kopien von Arbeitern experimentieren, um m√∂gliche Probleme in den Hauptprogrammen zu vermeiden. <br><br><h3>  Update vom 11.09.2019 </h3><br>  Es stellte sich heraus, dass ich vergeblich besorgt war: ‚ÄûIn den Versionen 1C-8.3.14 und h√∂her wird der Initialisierungsabschnitt in der externen Komponente nicht mehr mit dem Wort‚Äû vollst√§ndig ‚Äúausgef√ºhrt.‚Äú <br><br>  Es stellt sich heraus, dass nur die R√ºckmeldung in der Funktion <b>ConnectExternalComponent ()</b> nicht verarbeitet werden muss.  Unabh√§ngig davon, welchen Komponententyp wir angeben: <b>COM</b> oder <b>native API</b> . <br><br>  Sie k√∂nnen also eine Konfiguration in allen derzeit verf√ºgbaren Versionen von 1C erstellen. Unsere Komponente sollte √ºberall einwandfrei funktionieren. Das Erstellen eines externen Bootloaders ist relevant, es sei denn, Sie m√∂chten die Konfiguration nicht √§ndern, was vollst√§ndig unterst√ºtzt wird. <br><br>  In dieser Hinsicht wird der Code in den Testkonfigurationen f√ºr 1C82 und 1C83 geringf√ºgig ge√§ndert, obwohl die Unterschiede zwischen ihnen nicht mehr grundlegend sind. <br><br>  Gleichzeitig bleibt unsere Bemerkung, dass das 1C-Unternehmen die Ausf√ºhrung des Initialisierungscodes in jedem VK leicht blockieren kann, zumindest f√ºr externe Komponenten wie die <b>native API</b> , offensichtlich g√ºltig, da dies nach ihrer Vorlage nicht erforderlich ist.  F√ºr einen <b>COM vom</b> Typ VK <b>besteht bisher ein</b> solcher Bedarf, aber was verhindert, dass er beseitigt wird?  Mal sehen, ob diese Informationen ber√ºcksichtigt werden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de466713/">https://habr.com/ru/post/de466713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de466699/index.html">Z√§hmen von Vertrauensprotokollen - OAuth-Authentifizierung mit InterSystems IRIS</a></li>
<li><a href="../de466701/index.html">Let's Encrypt bedient fast 30% der Domains</a></li>
<li><a href="../de466705/index.html">Vivaldi Beta f√ºr Android - Echter Browser</a></li>
<li><a href="../de466709/index.html">Entwicklung einer monolithischen Unix-√§hnlichen OS-C-Bibliothek (2)</a></li>
<li><a href="../de466711/index.html">Sicherheitsl√ºcke DaOffice darf jeden Benutzer aus dem sozialen Netzwerk entfernen</a></li>
<li><a href="../de466719/index.html">Superlight Velocity Profiling: Theorie und Praxis. Teil 1</a></li>
<li><a href="../de466721/index.html">[Ekaterinburg, Ank√ºndigung] java.ural.Meetup @ 3 - Ank√ºndigung der dritten Java Mitap + Video-Berichte von java.ural.Meetup @ 2</a></li>
<li><a href="../de466723/index.html">Apple Text Broadcast - 10. September 2019</a></li>
<li><a href="../de466725/index.html">Dolch 2 ist elementar (Teil 1)</a></li>
<li><a href="../de466727/index.html">Lazy Upgrade: Wie PostgreSQL 12 die Leistung verbessert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>