<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🧝🏿 🧑🏽‍🤝‍🧑🏻 📌 Ist es in 1C möglich, die Technologie externer Komponenten nicht zu beobachten? Oder wie man Kollegen mit 1C gratuliert? 📦 👴🏽 🎮</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es gab hier die Idee, unserer Hauptbuchhalterin mehr oder weniger originell zu gratulieren, zum Beispiel mit Hilfe ihres Lieblingsprogramms 1C? Aber w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ist es in 1C möglich, die Technologie externer Komponenten nicht zu beobachten? Oder wie man Kollegen mit 1C gratuliert?</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/466713/">  Es gab hier die Idee, unserer Hauptbuchhalterin mehr oder weniger originell zu gratulieren, zum Beispiel mit Hilfe ihres Lieblingsprogramms 1C?  Aber wie? <br><br>  Nach einigem Überlegen kam die Idee, das Hintergrundbild im Clientbereich herkömmlicher Formulare für Konfigurationen auf 1C77-1C82 oder in einem externen Fenster für verwaltete Formulare 1C82 und in allen Fällen für 1C83 als Hintergrundglückwunsch zu verwenden.  Zeigen Sie darauf die gewünschte Nachricht an und geben Sie Links zum Glückwunschvideo an, wie in der Abbildung gezeigt. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a77/0bd/055/a770bd055ca43fdb5ad8d6f1f124253b.jpg" alt="Glückwunsch in 1C"><br><a name="habracut"></a><br><h2>  Erster Teil - Ergebnis </h2><br>  Offensichtlich ist diese Idee nicht neu.  Daher wurde 2011 <b>von <i>Aleksey Fedorov alias ALF</i></b> eine <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">ähnliche Lösung</a> basierend auf <b>FormEx.dll</b> vorgeschlagen.  Und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">wie dies erreicht werden kann,</a> wurden bereits 2008 gestellt. <br><br>  Zu einer Zeit haben wir diese Komponente auch verwendet, um das Hintergrundbild in 1C77 zu laden.  Das Herunterladen großer BMP-Dateien (und anderer konnte nicht verwendet werden) war jedoch langsam (aus diesem Grund wurden kleine Bilder mit Kacheln verwendet), sodass der Wunsch bestand, eine eigene externe Komponente (VK) zu schreiben, die nur die erforderlichen Bilder herunterlädt und nichts weiter, es sei denn Was gibt es sonst noch als Testgelände für Experimente? <br><br>  Eine solche Komponente wurde geschrieben (auch nur für BMP-Dateien, ggf. mit Kacheln).  Dort wurde die Funktion <b>WinAPI LoadImage ()</b> verwendet.  Diese DLL stand nicht in Konflikt mit FormEx.dll, sie war einfach, schnell genug und diente lange Zeit. <br><br>  All dies war wunderbar, aber es war Zeit, seine Fähigkeiten zu erweitern, und hier war ein anderer Ansatz erforderlich. <br><br>  In diesem Artikel werden die Probleme beim Erstellen von Multimediadateien nicht behandelt.  Dies ist nicht unsere Spezialität.  Wir beschränken uns nur auf einige Nuancen der Programmierung externer Komponenten für 1C. <br><br><h3>  1C77 </h3><br>  Da die Versionen der 1C-Plattform unterschiedlich sein können, kann es mehrere Lösungen geben.  In unserem Fall waren dies Konfigurationen auf 1C77 (Abb. 1). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8b4/611/4ad/8b46114ad1ae83e57667cc4bb84aae7e.jpg" alt="Abb. 1. Glückwunschbild in der Testkonfiguration auf 1C77"><br>  Abb.  1. Glückwunschbild in der Testkonfiguration auf 1C77. <br><br>  Das Video hier ist zwar ein eigenes, aber die Idee seiner Entstehung stammt von <b><i>Anna Shiyanova unter dem Spitznamen "Special Case"</i></b> .  Dieses Mädchen hat Talent, sie kann nachgeahmt werden, aber es ist kaum möglich, den Stil vollständig zu wiederholen.  In diesem Fall wollte ich zumindest ein Element der Kreativität. <br><br>  Wenn einer der Kollegen es bereits satt hat, die Glückwünsche anderer zu betrachten, kann er das Bild mit „ <b>Alt + I</b> “ überladen (Abb. 2-3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/01a/8c1/200/01a8c120008b72dd648b7c8697298d65.jpg" alt="Abb. 2. Wählen Sie ein anderes Hintergrundbild im Menü „Datei / Hintergrund auswählen“ oder mit „Alt + I“."><br>  Abb.  2. Wählen Sie ein anderes Hintergrundbild im Menü "Datei / Hintergrund auswählen" oder mit "Alt + I". <br><br>  Gleichzeitig finden Sie Informationen zu dem von " <b>Alt + L</b> " verwendeten Modul (Abb. 3). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/499/499/f23/499499f23ec33734bd6a5068f5d493b8.jpg" alt="Abb. 3. Überladenes Hintergrundbild mit Informationen zum Programm (&quot;Hilfe / Informationen zum LionExt32.dll-Modul&quot; oder &quot;Alt + L&quot;)"><br>  Abb.  3. Überladenes Hintergrundbild mit Informationen zum Programm („Hilfe / Informationen zum LionExt32.dll-Modul“ oder „Alt + L“). <br><br><h3>  1C82 konventionelle Formen </h3><br>  Natürlich orientiert sich die Mehrheit jetzt am G8 (1C8x).  Das Arbeiten mit dem Hintergrundbild in 1C ist jedoch nur auf normalen Formularen in Version 8.2 und weniger möglich. Wenn Sie keine Verarbeitung verwenden, die im Desktop-Modus beginnt, überlappt sich unser Hintergrund einfach vollständig (Abb. 4). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/390/123/bfd/390123bfd2ef88bfbc108dbe44c70835.jpg" alt="Abb. 4. Glückwunschbild in der Testkonfiguration auf gewöhnlichen Formularen 1C82"><br>  Abb.  4. Glückwunschbild in der Testkonfiguration zu den üblichen Formularen 1C82. <br><br>  Beachten Sie, dass die Links zu Abb.  4 zeigen nicht unser Video an.  Sie werden nur für den Test angezeigt. <br><br>  In gewöhnlichen Formen bietet 1C82 nicht mehr die Standardmethode für den Zugriff auf das Menü, da es dort nicht systemisch ist, wie bei den "sieben", sondern "eigenen" (obwohl das System erstellt werden kann, aber warum benötigen wir zwei Hauptmenüs?).  Es können jedoch Hotkeys verwendet werden.  Aus dem gleichen Grund rufen wir in unserer Komponente „Alt + I“ einen Dialog wie in Abb. 2 auf und laden einen weiteren Hintergrund (Abb. 5). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3f/535/deb/c3f535deb522e2ae7ad8937ce31b1188.jpg" alt="Abb. 5. Überladenes Hintergrundbild in „dicken“ 1C82-Formularen"><br>  Abb.  5. Überladenes Hintergrundbild in „dicken“ 1C82-Formularen. <br><br>  Ebenso können Sie Informationen über das Modul erhalten, indem Sie die Taste "Alt + L" drücken, wie in Abb.  3. <br><br><h3>  1C82 verwaltete Formulare </h3><br>  Für verwaltete Formulare in 1C82 finden Sie immer noch das Fenster, das wir auf der siebten Verschachtelungsebene benötigen, z. B. " <b>V8FormElement</b> ", und zeichnen darauf, aber irgendwie ist es nicht interessant. <br><br>  Aus diesen Überlegungen folgt für uns, dass es einfacher ist, ein externes Fenster mit einer Glückwunschbotschaft zu erstellen (Abb. 6), als jeden Einzelfall zu behandeln.  Das Fenster selbst kann durch " <b>Esc</b> ", " <b>Strg + F4</b> ", " <b>Alt + F4</b> " oder durch Klicken auf das " <b>Kreuz</b> " geschlossen oder vielmehr minimiert werden. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/790/cd9/79d/790cd979df8a4d97ff5488c50fa4bd6c.jpg" alt="Abb. 6. Glückwunschbild in einer Testkonfiguration auf verwalteten Formularen 1C82"><br>  Abb.  6. Glückwunschbild in einer Testkonfiguration auf verwalteten Formularen 1C82. <br><br>  Darüber hinaus kann das minimierte Fenster (Abb. 7) wieder erweitert werden. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/66c/1a7/c7f/66c1a7c7f725404604318cdcde3a9915.jpg" alt="Abb. 7. Das minimierte Bild des externen Fensters in verwalteten Formularen 1C82"><br>  Abb.  7. Ein minimiertes Bild des externen Fensters in verwalteten Formularen 1C82. <br><br>  Die Abmessungen und die relative Position des Außenfensters können geändert werden, hier ist alles wie gewohnt (siehe vergrößerte Bilder der Außenfenster in Abb. 6 und Abb. 10).  Beachten Sie, dass Hotkeys nur funktionieren, wenn das externe Fenster aktiv ist. <br><br><h3>  1C83 herkömmliche Formen </h3><br>  In 1C83 gibt es überhaupt keine untergeordneten Fenster mehr, die als Kriterium für Version 1C in unserer DLL dienen können.  Darüber hinaus sind „dicke“ Formulare ein Rahmenfenster (Abb. 8) und verwaltete Formulare rahmenlos (Abb. 9).  Das heißt, alles, was kein Rahmen ist, kann neu gezeichnet werden.  Ein Frame kann auch neu gezeichnet werden, jedoch nur als Systemelement. <br><div class="scrollable-table"><table><tbody><tr><th><img src="https://habrastorage.org/getpro/habr/post_images/f9c/35e/0da/f9c35e0da01025306525d14f700d22a4.jpg" alt="Abb. 8. Rahmenfenster in „dicken“ Formen 1C83"></th><th><img src="https://habrastorage.org/getpro/habr/post_images/962/5f9/e7c/9625f9e7c28fed4c9226ee73d8126ed8.jpg" alt="Abb. 9. Rahmenloses Fenster in verwalteten Formularen 1C83"></th></tr><tr><th>  Abb.  8. Rahmenfenster in „dicken“ Formen 1C83. </th><th>  Abb.  9. Rahmenloses Fenster in kontrollierten Formen 1C83. </th></tr></tbody></table></div>  Hier haben wir ein Testfenster mit einer dynamischen Bibliothek erstellt und es dem 1C-Hauptfenster untergeordnet.  Der Unterschied im Verhalten ist in den Figuren zu sehen. <br><br><h3>  1C83 verwaltete Formulare </h3><br>  Im Fall von 1C83, wie in den verwalteten Formularen 1C82, werden wir unsere Glückwünsche nicht vor dem Hintergrund, sondern in einem separaten Fenster ziehen, dessen Prototyp in Abb. 1 dargestellt ist.  8-9.  Als Ergebnis <b>liefert</b> die gewünschte Komponente ( <b>LionExt32.dll</b> oder <b>LionExt64.dll</b> ) das folgende Ergebnis (Abb. 10-12). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/104/cf1/f10/104cf1f10c6ae652d24edea7082c7e6c.jpg" alt="Abb. 10. Das Hintergrundbild im externen Fenster für herkömmliche Formulare 1C83"><br>  Abb.  10. Das Hintergrundbild im externen Fenster für herkömmliche Formulare 1C83. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56a/03f/fc7/56a03ffc7fe1f2bfee6358ecb81af9fa.jpg" alt="Abb. 11. Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 14, 64-Bit-Version"><br>  Abb.  11. Das Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 14, 64-Bit-Version. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/05e/12f/71c/05e12f71ccfb9212b96bc3db92630869.jpg" alt="Abb. 12. Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 15, 64-Bit-Version"><br>  Abb.  12. Das Hintergrundbild im externen Fenster der verwalteten Formulare 1C83, Version 15, 64-Bit-Version. <br><br><h3>  Vorläufige Ergebnisse </h3><br>  Diese Komponente wurde tatsächlich in der Praxis eingesetzt (Abb. 1), der Hauptbuchhalter war zufrieden, alles lief wunderbar.  Dabei stellte sich heraus, dass Benutzer gerne ihre eigenen Hintergrundbilder auswählen, in diesem Fall um an den "Sieben" zu arbeiten.  Für den G8 ist unsere Komponente mit einer Reserve für die Zukunft angepasst, während sie als Demoversion betrachtet werden sollte. <br><br>  Das Interesse hierbei war, dass für <b><i>diese Komponente keine Konformität mit der Technologie zur Erstellung externer Komponenten aus 1C erforderlich war</i></b> .  Vielleicht entstehen zusätzliche Ideen, um seine Fähigkeiten zu erweitern.  Beispielsweise möchten Sie für Konfigurationen, die vollständig unterstützt werden, keine Änderungen am 1C-Code ohne besondere Notwendigkeit vornehmen.  In diesem Fall könnte man die Möglichkeit bieten, eine beliebige DLL extern in den Adressraum 1C zu laden.  Dies ist jedoch das Thema eines anderen Artikels. <br><br>  Bei technischen Neuerungen wurde ein Schloss verwendet, um unsere Komponente mit der 1C-Plattform zu entladen (da sie nicht dem VK-Format entspricht).  Ein weiterer Trick ermöglichte es außerdem, dem untergeordneten Fenster ein <b>lokales Menü</b> zuzuweisen, da das Windows-Betriebssystem die Erstellung eines solchen Menüs für untergeordnete Fenster blockiert.  Daher werden lokale Menüs nirgendwo im selben <b>MDI</b> (Multi Document Interface) angezeigt.  Er wird durch Befehlsfelder, Symbolleisten und ein Kontextmenü ersetzt.  Es gibt noch einen Moment zum Aktualisieren von Fenstern.  Manchmal kommt es vor, dass weder <b>UpdateWindow ()</b> noch <b>InvalidateRect ()</b> ordnungsgemäß funktionieren.  In diesem Fall sind jedoch einige Funktionen erfolgreich: <br><br><pre><code class="cpp hljs">ShowWindow(hWnd, SW_HIDE); ShowWindow(hWnd, SW_SHOW);</code> </pre> <br>  Es sollte auch beachtet werden, dass unsere Komponente möglicherweise mit anderen in Konflikt steht, z. B. mit FormEx.dll für 1C77.  In diesem Fall muss es zuletzt geladen werden. <br><br>  Übrigens wird bemerkt, dass beim Erstellen einer Konfiguration in Version 1C-8.3.14 und höher die Komponente nicht regelmäßig geladen wird.  Wenn die Datenbank jedoch in einer früheren Version von 1C erstellt und in den neuesten Versionen geöffnet wurde, gibt es keine Probleme beim Laden unserer VK.  Dies weist erneut auf die Notwendigkeit hin, einen externen Bootloader zu erstellen. <br><br>  Dieses Projekt verwendet das <b>WinAPI GDI +</b> -Subsystem.  Mit ihm können Sie Bilder in verschiedenen Formaten anzeigen: <b>bmp, jpg, gif, png, tif</b> und andere.  In derselben Reihenfolge versucht die Komponente, die erste verfügbare <b>Main. *</b> -Datei aus dem lokalen <b>Pics-</b> Verzeichnis in der aktuellen Konfiguration zu laden.  Wenn keine dieser Dateien gefunden wird, wird ein einfaches Hintergrundbild aus Komponentenressourcen verwendet.  In Abb.  Abbildung 13 zeigt dieses Hintergrundbild für die üblichen Formen von 64-Bit 1C83, Version 15. Zur Änderung wurde das externe Fenster des Slang vergrößert und ein weiteres Bild aus der Datei <b>Main1.png</b> , das „gekachelt“ wurde, zu seinem Hintergrund hinzugefügt. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/71c/80a/48a/71c80a48a18236e495a1d62b0f316e11.jpg" alt="Abb. 13. Das Standard-Hintergrundbild für reguläre Formulare 64-Bit 1C83, Version 15"><br>  Abb.  13. Das Standard-Hintergrundbild für die üblichen Formen von 64-Bit-1C83, Version 15. Außerdem wurde ein weiteres Bild aus der Datei Main1.png hinzugefügt, das als „Kacheln“ ausgelegt ist. <br><br>  Es gibt keinen Unterschied in der Funktionsweise der Komponente in verschiedenen Bitmodi. <br><br>  Es kann auch angemerkt werden, dass unsere Komponente das Hauptfenster von 1C und gegebenenfalls dessen MDI-Client unterklassifiziert.  Dies dient anscheinend als Konfliktquelle für FormEx.dll, wenn es zuletzt geladen wird (in 1C77). <br><br><h2>  Zweiter Teil - Technisch </h2><br>  Das Projekt selbst finden Sie unter folgenden Links: <br><br><ul><li>  <a href="">Testkonfiguration auf 1C77</a> </li><li>  <a href="">Testkonfiguration auf 1C82</a> </li><li>  <a href="">Testkonfiguration auf 1C83</a> </li><li>  <a href="">Projekt auf MS VS C ++, v.</a>  <a href="">13</a> </li></ul><br>  Ein <b>C ++ -</b> Projekt kann problemlos für Version <b>10</b> angepasst werden, wenn die Zeichenfolge " <b>v120</b> <b>"</b> in den Konfigurationsdateien durch " <b>v100</b> " und " <b>ToolsVersion =" 12.0</b> "durch" <b>ToolsVersion = "4.0" ersetzt wird</b> . <br><br>  Der Code für die <b>32-</b> Bit- und <b>64-</b> Bit-Versionen von <b>1C ist</b> derselbe und kann gleichzeitig kompiliert werden. <br><br>  Version 1C77 wird in der externen Komponente durch das Funktionshandle GetMenu <b>()</b> ungleich Null und Version 1C83 durch das Fehlen von untergeordneten Fenstern im Hauptfenster bestimmt, deren Handle durch die Funktion <b>GetForegroundWindow () bestimmt</b> wird. <br><br><h3>  Informationen zur Technologie zum Erstellen externer Komponenten für 1C </h3><br>  Auf den ITS-Discs der Firma 1C und im Internet finden Sie leicht Informationen zur Erstellung von VC und den entsprechenden Vorlagen in verschiedenen Programmiersprachen.  In den Zeiten von 1C77 erfüllten diese Muster jedoch "nicht nur alle". <br><br>  Wenn Sie sich einige weit verbreitete Komponenten ansehen, insbesondere für 1C77, werden Sie feststellen, dass ihre Autoren häufig spezielle Programmiermethoden verwendeten, um die Funktionen ihrer Designs zu erweitern. <br><br>  Möglicherweise war eine der ersten derartigen externen Komponenten <b><i>"RAINBOW ADDIN 2000 für 1C: Enterprise 7.7".</i></b>  Das vielleicht wichtigste war hier ein tieferes Eindringen in die Eingeweide der „Sieben“, als es die offizielle VK-Technologie erlaubte, obwohl sie dem VK-Format folgte.  Dies wurde aufgrund der empfangenen, möglicherweise nicht standardmäßigen Methoden, Header (* .h-Dateien) von 1C77-Bibliotheksdateien erreicht, die in anderen weithin bekannten Projekten verwendet wurden. <br><br>  Wenn 1C-Funktionen wie <b>LoadExternalComponent ()</b> und <b>ConnectExternalComponent ()</b> es Ihnen ermöglichen, <b>externe DLLs</b> in Ihren eigenen Adressraum einzubetten (zunächst einmal, die das VK-Technologieformat erfüllen), warum erliegen Benutzerprogramme dann nicht der Versuchung und versuchen, auf andere verborgene zuzugreifen sie, Prozeduren und andere Objekte der Zielplattform?  Dieser Ansatz wurde von der <b>Rainbow.dll-</b> Komponente erfolgreich demonstriert. <br><br>  Später wurde ein ähnlicher Mechanismus von anderen Autoren der Komponente 1C Version 7.7 übernommen.  Besonders hervorzuheben ist die Komponente für die "sieben" <b>1C ++. Dll</b> und <b>sozusagen</b> ein Sonderfall von <b>FormEx.dll</b> . <br><br>  Der nicht triviale Ansatz für das Design externer Komponenten für 1C77 endete jedoch nicht dort.  Anscheinend hätte jemand sagen sollen: „Warum brauchen wir einen Schmied?  Wir brauchen keinen Schmied! "  Mit „Schmied“ meinen wir hier die COM-Technologie von MicroSoft, auf die gewissermaßen die VK-Technologie für die „Sieben“ folgte.  Nein, wirklich, warum brauchen wir eine Registrierung, wenn wir unsere VK direkt herunterladen?  Dies mag für Webbrowser, die mit dem Internet arbeiten, sinnvoll sein, für den lokalen Betrieb ist die Verwendung der Registrierung jedoch eindeutig redundant.  Zumindest sollte dies keine Voraussetzung sein.  Darüber hinaus benötigen Sie zum Bearbeiten der Registrierung Administratorrechte. <br><br>  Beachten Sie, dass 1C diese Technologie sehr mochte (zumindest bis zur Portierung von 1C auf Linux).  Wir behandeln sie ziemlich cool.  COM ist praktisch für die Verwendung der ActiveX-Komponente, und dies ist natürlich, da letztere ursprünglich für das Internet entwickelt wurden. <br><br>  In den neuesten Versionen hat 1C jedoch die Möglichkeit hinzugefügt, die <b>native API-</b> Technologie zu verwenden, sodass keine Registrierung erforderlich ist.  Im Prinzip ist dies das, was wir brauchen, außer dass diese Technologie in den "Sieben" nicht anwendbar ist und für einige immer noch relevant ist. <br><br>  Manchmal treten jedoch relativ einfache Aufgaben auf, wenn Sie keinen Haufen Boilerplate-Code für VK verwenden möchten und es ratsam ist, mit 1C nur von der Seite der externen Komponente aus zu arbeiten.  Wie in unserem Fall beispielsweise die Demonstration eines Glückwunschbildes im Kundenbereich oder, falls erforderlich, in einem separaten Fenster, Konfiguration 1C. <br><br>  Mit anderen Worten, wenn wir keine Daten direkt zwischen 1C und VK austauschen wollen, werden wir mit einer einfacheren und universelleren Version der externen Komponente für 1C sehr zufrieden sein.  Einfachheit wird hier aufgrund des Fehlens von Boilerplate-Code erreicht. <br><br><h3>  Alternative Technologie zum Erstellen von VK für 1C </h3><br>  Da VK für 1C ein Sonderfall eines <b>COM-Servers ist</b> (vor der <b>Native API-</b> Technologie), gab es VK-Entwickler, die sagten: „COM - nein!“.  Besonders auffällig ist die Tätigkeit von <b><i>Alexander Orefkov</i></b> in dieser Richtung.  Die Komponenten " <b>1sqlite.dll</b> ", " <b>TurboMD.dll</b> " und möglicherweise andere verwenden COM aus dem Wort "vollständig" nicht.  Auf diesem Weg entwickelt sich auch die <b>Yoksel-</b> Komponente (" <b>SpreadSheet.dll</b> "). <br><br>  Aber wie lädt dann der VK-Lader von 1C77 diese Komponenten?  Schließlich versuchen sie dort nicht einmal, eine Art COM nachzuahmen.  Wenn wir versuchen, eine Standard-DLL, die beispielsweise vom <b>MS VC ++ -</b> Assistenten generiert wurde, unverblümt in die <b>LoadExternalComponent ()</b> -Funktion zu verschieben, haben wir einen Mist. <br><br>  In der "Sieben" erhalten wir eine Nachricht wie: <blockquote>  Beim Erstellen eines Objekts aus der DLL-Komponente &lt;Vollständiger Pfad \ Komponentenname&gt; ist ein Fehler aufgetreten (CLSID fehlt). </blockquote><br>  Im "dicken" 32-Bit-Client ist die "Acht" -Nachricht ähnlich.  Dieselbe DLL verursacht ein ähnliches Fluchen (Abb. 15): <blockquote>  Fehler beim Aufrufen der Kontextmethode (Externe Komponente laden): Fehler beim Laden der externen Komponente </blockquote><br>  Wie lösen die genannten Bibliotheken dieses Problem?  Wenn wir die Texte der Programme Orefkov und Yoksel studieren, kommen wir letztendlich zu dem Schluss, dass die folgenden „ <b>magischen Linien</b> “ in der Ressourcendatei (* .rc oder * .rc2) „schuld“ sind: <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0sd" // 1sqlite.dll 100 "\0tmd" // TurboMD.dll 100 "\0f" // SpreadSheet.dll END</code> </pre> <br>  Das heißt,  In den Programmressourcen gibt es eine Zeile mit dem Bezeichner <b>100</b> und einem Zeichenfolgenwert, dessen erstes Zeichen Null ist.  Sie können mit Variationen solcher Zeichenfolgen experimentieren, aber die Zeichenfolge " <b>\ 0L</b> " ist für mich in Ordnung.  Daher erstellen wir eine Ressourcendatei und schreiben Zeilen wie folgt: <br><br><pre> <code class="plaintext hljs">STRINGTABLE DISCARDABLE BEGIN 100 "\0L" //    1     ! END</code> </pre> <br>  Wir verbinden diese Datei mit unserem einfachsten DLL-Projekt, das vom MS C ++ - Assistenten generiert wurde. Fügen Sie den folgenden Code hinzu: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: MessageBox(<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">",  DllMain()!"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, MB_OK); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_ATTACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_THREAD_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_DETACH: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  und beobachten (Abb. 14). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/715/a71/7f7/715a717f7ee778dd219e79e5fbd43e97.jpg" alt="Abb. 14. Verwendung des einfachsten „VK“ in 1C82"><br>  Abb.  14. Verwendung des einfachsten „VK“ in 1C82. <br><br>  Ohne "magische Linien" in der Ressourcendatei wird unsere DLL nach dem Anzeigen von MessageBox sofort mit einem Fluch von 1C entladen (Abb. 15). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a98/cec/432/a98cec4326033180917940aa248dbc96.jpg" alt="Abb. 15. Fehler beim Laden der regulären DLL in 1C82"><br>  Abb.  15. Fehler beim Laden der regulären DLL in 1C82. <br><br>  Das heißt, diese Leitungen haben wirklich einen magischen Effekt auf den Lader externer 1C-Komponenten. <br><br>  Der erste, wie es scheint, "magische Linien" wurde in seinem alten Artikel von <b><i>Alexei Fedorov (ALF) beschrieben</i></b> , aber der Link dazu ist nicht mehr verfügbar, und der Autor sieht den Punkt in seiner Neuveröffentlichung nicht.  Darüber hinaus hat <b><i>Alexander Orefkov</i></b> sie am intensivsten genutzt, und anscheinend war der Autor nach seiner Vorlage <b><i>Yoksel</i></b> .  Deshalb werden wir über die <b><i>„magischen“ Linien von Fedorov-Orefkov sprechen</i></b> .  Ihre Bedeutung ist es, das Entladen von nicht standardmäßigen (aus Sicht von 1C) DLL-Dateien durch die Funktion <b>LoadExternalComponent () zu blockieren</b> .  Darüber hinaus funktioniert diese Technik, wie wir sehen, nicht nur in 1C77, sondern auch in „dicken“ 1C82-Formen. <br><br>  In den verwalteten Formularen 1C82 und in allen Versionen von 1C83 wurde diese Funktion jedoch bereits vollständig unterbrochen (ein weiterer Loader wurde ebenfalls angezeigt - <b>ConnectExternalComponent ()</b> ). <br><br>  In modernen Versionen von 1C müssen Sie daher nach anderen einfachen Alternativen zu den „magischen“ Linien von Fedorov-Orefkov suchen. <br><br>  Und eine solche Alternative ist einfach anzubieten.  Der Punkt ist einfach.  Der 1C-Loader entlädt die "falsche" Komponente, wenn er eine Ausnahme auslöst, wenn er versucht, mit dem angegebenen Protokoll darauf zuzugreifen, z. B. wenn er die Version der Komponente anfordert.  Natürlich haben wir nichts dergleichen, was als Grundlage für das Entladen einer nicht standardmäßigen DLL dient.  Die Anforderung von 1C, dass das Betriebssystem diese dynamische Bibliothek entlädt, kann vom System ignoriert werden, wenn diese VK noch irgendwo verwendet wird.  Anstelle des Löschens selbst reduziert das System einfach den Nutzungszähler des gewünschten Moduls.  Und physisch nicht früher löschen, als dieser Zähler zurückgesetzt wird.  Daher ist es unsere Aufgabe, diesen Zähler künstlich zu erhöhen. <br><br>  Dazu können Sie unsere DLL-Funktion WinAPI <b>LoadLibrary ()</b> im Abschnitt <b>DLL_THREAD_ATTACH</b> erneut <b>aufrufen</b> <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">BOOL APIENTRY </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DllMain</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HANDLE hModule, DWORD dwReason, LPVOID lpReserved)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(dwReason) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DLL_PROCESS_ATTACH: { WCHAR szDllName[_MAX_PATH] = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; <span class="hljs-comment"><span class="hljs-comment">//     dll GetModuleFileName(hModule, szDllName, _MAX_PATH); //MessageBox(NULL, szDllName, L"Info", MB_OK); //    dll (     183), //      DLL_PROCESS_ATTACH HMODULE hDll = LoadLibrary(szDllName); break; } // case DLL_PROCESS_ATTACH case DLL_THREAD_ATTACH: break; case DLL_THREAD_DETACH: break; case DLL_PROCESS_DETACH: break; } // switch(dwReason) return TRUE; } // DllMain()</span></span></code> </pre> <br>  Das ist alles!  Das Problem ist gelöst.  Durch das Abrufen derselben dynamischen Bibliothek wird der Nutzungszähler um eins erhöht, und das Entladen (mit vorläufigem Zugriff auf den Abschnitt <b>DLL_THREAD_DETACH</b> ) wird um eins verringert.  Insgesamt haben wir <b>2 - 1 = 1&gt; 0</b> , daher wird das Betriebssystem unsere DLL nicht entladen.  Darüber hinaus wird eine <b>Neuinitialisierung des</b> Abschnitts <b>DLL_PROCESS_ATTACH</b> nicht durchgeführt. <br><br>  Daraus lässt sich übrigens ersehen, wie 1C in seinen neuesten Versionen mit einem ähnlichen Trick umgehen kann (und dies anscheinend bereits in den in 1C-8.3.14 und höher erstellten Konfigurationen).  Es kann die Funktion <b>LoadLibraryEx ()</b> mit einem Parameter verwenden, der die Ausführung des Initialisierungsabschnitts <b>DLL_PROCESS_ATTACH</b> blockiert. <b>Danach</b> werden sofort die erforderlichen exportierten Funktionen aufgerufen.  Wenn Sie sich den Code des VK-Beispiels für die native API ansehen, sehen Sie, dass der Initialisierungscode nicht aufgerufen werden muss, da er im VK-Format leer sein muss. <br><br>  In Bezug auf die Beispiele für die Verwendung der COM-Technologie ist es offensichtlich, dass die Ausführung des Initialisierungsabschnitts <b>DLL_PROCESS_ATTACH</b> dort erforderlich ist. Daher ist in nicht zu neuen Versionen von 1C, genauer gesagt in den Konfigurationen in 1C-8.3.13 und darunter, der 1C-Loader für uns geeignet: <br><br><pre> <code class="plaintext hljs">(, , .COM);</code> </pre> <br>  Hier kann der letzte Parameter entfernt werden, da er standardmäßig impliziert ist.  Gleichzeitig können sie in jeder höheren Version normal geöffnet werden.  In den Versionen 1C83 passt der vorherige Bootloader <b>LoadExternalComponent (Component Address)</b> nicht mehr zu uns (bzw. die „magischen Linien“ von Fedorov-Orefkov funktionieren dort nicht). <br><br>  Im allgemeinen Fall kann das Problem, wie bereits erwähnt, mit einem externen Bootloader gelöst werden.  Oder, was ganz natürlich ist, die Technologie der externen Komponenten von 1C auf die eine oder andere Weise zu beobachten. <br><br>  Es sollte auch beachtet werden, dass die Experimente in Dateiversionen von 1C mit unterschiedlichen Bittiefen durchgeführt wurden.  Um unsere Komponente herunterzuladen, müssen Sie möglicherweise die Eigenschaft " <b>Synchronous Call Usage Mode</b> " in der Konfiguration auf " <b>Use</b> " setzen. <br><br>  Es versteht sich auch, dass Sie die Verwendung einer solchen Technik auf eigenes Risiko durchführen, im Voraus mit Testkonfigurationen oder Kopien von Arbeitern experimentieren, um mögliche Probleme in den Hauptprogrammen zu vermeiden. <br><br><h3>  Update vom 11.09.2019 </h3><br>  Es stellte sich heraus, dass ich vergeblich besorgt war: „In den Versionen 1C-8.3.14 und höher wird der Initialisierungsabschnitt in der externen Komponente nicht mehr mit dem Wort„ vollständig “ausgeführt.“ <br><br>  Es stellt sich heraus, dass nur die Rückmeldung in der Funktion <b>ConnectExternalComponent ()</b> nicht verarbeitet werden muss.  Unabhängig davon, welchen Komponententyp wir angeben: <b>COM</b> oder <b>native API</b> . <br><br>  Sie können also eine Konfiguration in allen derzeit verfügbaren Versionen von 1C erstellen. Unsere Komponente sollte überall einwandfrei funktionieren. Das Erstellen eines externen Bootloaders ist relevant, es sei denn, Sie möchten die Konfiguration nicht ändern, was vollständig unterstützt wird. <br><br>  In dieser Hinsicht wird der Code in den Testkonfigurationen für 1C82 und 1C83 geringfügig geändert, obwohl die Unterschiede zwischen ihnen nicht mehr grundlegend sind. <br><br>  Gleichzeitig bleibt unsere Bemerkung, dass das 1C-Unternehmen die Ausführung des Initialisierungscodes in jedem VK leicht blockieren kann, zumindest für externe Komponenten wie die <b>native API</b> , offensichtlich gültig, da dies nach ihrer Vorlage nicht erforderlich ist.  Für einen <b>COM vom</b> Typ VK <b>besteht bisher ein</b> solcher Bedarf, aber was verhindert, dass er beseitigt wird?  Mal sehen, ob diese Informationen berücksichtigt werden. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de466713/">https://habr.com/ru/post/de466713/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de466699/index.html">Zähmen von Vertrauensprotokollen - OAuth-Authentifizierung mit InterSystems IRIS</a></li>
<li><a href="../de466701/index.html">Let's Encrypt bedient fast 30% der Domains</a></li>
<li><a href="../de466705/index.html">Vivaldi Beta für Android - Echter Browser</a></li>
<li><a href="../de466709/index.html">Entwicklung einer monolithischen Unix-ähnlichen OS-C-Bibliothek (2)</a></li>
<li><a href="../de466711/index.html">Sicherheitslücke DaOffice darf jeden Benutzer aus dem sozialen Netzwerk entfernen</a></li>
<li><a href="../de466719/index.html">Superlight Velocity Profiling: Theorie und Praxis. Teil 1</a></li>
<li><a href="../de466721/index.html">[Ekaterinburg, Ankündigung] java.ural.Meetup @ 3 - Ankündigung der dritten Java Mitap + Video-Berichte von java.ural.Meetup @ 2</a></li>
<li><a href="../de466723/index.html">Apple Text Broadcast - 10. September 2019</a></li>
<li><a href="../de466725/index.html">Dolch 2 ist elementar (Teil 1)</a></li>
<li><a href="../de466727/index.html">Lazy Upgrade: Wie PostgreSQL 12 die Leistung verbessert</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>