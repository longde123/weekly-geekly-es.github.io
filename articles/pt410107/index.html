<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üßòüèΩ üë©üèΩ‚Äçü§ù‚Äçüë©üèº üï∂Ô∏è Gerenciando retransmiss√µes da Internet a partir do RouterOS Mikrotik via API üò® ‚òùÔ∏è üçÆ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma ferramenta √∫til para gerenciar PDUs em roteadores MikroTik 
 O MikroTik √© conhecido como um fabricante de equipamentos de rede com alta confiabili...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Gerenciando retransmiss√µes da Internet a partir do RouterOS Mikrotik via API</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/410107/"><img src="https://habrastorage.org/webt/ip/ds/cs/ipdscs4kq9sanmqsyphzumdxvck.png" alt="MikroTik RODOS-8/9/10" align="left"><br><br><h2>  Uma ferramenta √∫til para gerenciar PDUs em roteadores MikroTik </h2><br>  <b>O MikroTik √©</b> conhecido como um fabricante de equipamentos de rede com alta confiabilidade a um pre√ßo baixo e funcionalidade rica.  A base do software para os produtos MikroTik √© o <b>RouterOS</b> , um sistema operacional de rede baseado em Linux.  √â executado no <b>RouterBOARD</b> , uma grande linha de solu√ß√µes de hardware que inclui equipamentos puros do operador e plataformas para uso dom√©stico.  O RouterOS fornece ao administrador / usu√°rio √≥timas op√ß√µes para configurar e gerenciar o roteador, permitindo que voc√™ opere n√£o apenas com a funcionalidade interna do sistema, mas tamb√©m crie suas pr√≥prias op√ß√µes para praticamente qualquer solu√ß√£o atrav√©s da programa√ß√£o de scripts. <br><br>  Neste artigo, discutirei como voc√™ pode usar a funcionalidade avan√ßada dos roteadores MikroTik para emitir comandos de gerenciamento de energia usando <b>PDUs (rel√©s da Internet)</b> diretamente do roteador por meio de fun√ß√µes de script. <a name="habracut"></a>  Como PDU, usei o rel√© Ethernet RODOS-8/9/10 da empresa OLIMP (os dispositivos s√£o absolutamente id√™nticos em termos de controle), que permaneceram ap√≥s v√°rios projetos e estavam "√† m√£o". <br><br><h2>  Recursos do RouterOS para gerenciamento de PDU </h2><br>  A funcionalidade avan√ßada do RouterOS pode permitir: <br><br><ul><li>  Ligar / desligar remotamente a energia dos dispositivos conectados √† PDU </li><li>  Controlar remotamente a PDU ap√≥s a ocorr√™ncia de v√°rios eventos na rede (por exemplo, se n√£o houver resposta de nenhum dispositivo para efetuar ping, quando um cliente VPN espec√≠fico, um cliente de rede wifi etc. estiver conectado ao roteador), dependendo da hora (agendado) </li><li>  Notifique o administrador ou os usu√°rios sobre a altera√ß√£o no estado da retransmiss√£o na PDU por e-mail ou n√∫mero de telefone (via SMS) </li></ul><br>  Assim, √© poss√≠vel organizar, por exemplo, o controle do equipamento do servidor, ligar / desligar / reiniciar o equipamento de rede ‚Äútravado‚Äù, ligar o resfriamento ou o aquecimento, a ilumina√ß√£o, gerenciar quaisquer cargas aceit√°veis ‚Äã‚Äãpara a pot√™ncia nominal como parte do Smart Home e muito mais que possam permitir Sua imagina√ß√£o. <br><br>  A capacidade de controlar uma retransmiss√£o da Internet a partir do RouterOS √© fornecida pelo comando <b>fetch</b> router, cuja sintaxe √© descrita em detalhes no link no final do artigo. <br><br><h2>  Gerenciando PDUs atrav√©s do comando "buscar" do roteador </h2><br>  As PDUs RODOS-8/9/10 suportam o seguinte formato de URL: <br><br><div class="spoiler">  <b class="spoiler_title">http: // [login]: [Senha] @ [endere√ßo IP] [/ protect] / rb [X-1] [action] .cgi</b> <div class="spoiler_text"><ul><li>  Login e senha - dados relevantes para acessar o dispositivo em "modo protegido" (proteger) </li><li>  Endere√ßo IP - endere√ßo IP do dispositivo na rede </li><li>  / protect - a tecla de acesso no "modo protegido".  Se o acesso ‚Äúaberto‚Äù estiver instalado no dispositivo, / protect n√£o for especificado, o login e a senha tamb√©m n√£o ser√£o especificados </li><li>  [a√ß√£o] - a a√ß√£o tomada no rel√©: n-ligar, f-desligar, s-emitir um pulso com dura√ß√£o de 1 segundo </li><li>  X √© o n√∫mero do rel√© que est√° sendo acessado; os valores poss√≠veis dependem do modelo do dispositivo: <br><ol><li>  RODOS-8 - n√£o indicado, como  o dispositivo possui um √∫nico rel√© </li><li>  RODOS-9 - X = 1 ou X = 2 </li><li>  RODOS-10 - X = [1-4] </li></ol></li></ul><br>  Todos os par√¢metros especificados s√£o passados ‚Äã‚Äãsem colchetes []. </div></div><br>  Assim, para resolver nosso problema no RouterOS, para habilitar o primeiro rel√© da nossa PDU, basta a seguinte entrada: <br><br><pre><code class="hljs pgsql">/tool <span class="hljs-keyword"><span class="hljs-keyword">fetch</span></span> url="http://[:]@192.168.1.20/protect/rb0n"</code> </pre> <br>  Se queremos uma resposta do dispositivo, devemos usar: <br><br><pre> <code class="hljs powershell">/tool fetch url=<span class="hljs-string"><span class="hljs-string">"http://[:]@192.168.1.20/protect/rb0n"</span></span> mode=http dst<span class="hljs-literal"><span class="hljs-literal">-path</span></span>=<span class="hljs-string"><span class="hljs-string">"Rodosanswer.txt"</span></span>; :local Rodosanswer [/<span class="hljs-type"><span class="hljs-type">file</span></span> <span class="hljs-type"><span class="hljs-type">get</span></span> <span class="hljs-type"><span class="hljs-type">Rodosanswer.txt</span></span> <span class="hljs-type"><span class="hljs-type">contents</span></span>];</code> </pre> <br>  A resposta da PDU no nosso caso √© retornada usando o mecanismo <b>json</b> para a vari√°vel <b>Rodosanswer</b> da seguinte forma: <br><br><ul><li>  ‚ÄúSucesso!  ¬ª- em caso de conclus√£o bem sucedida </li><li>  ‚ÄúFalha‚Äù - se o comando n√£o for executado (como regra, ao acessar sem indicar o login e a senha da PDU na linha da URL, se a PDU estiver no modo ‚Äúprotegido‚Äù) </li></ul><br><h2>  Criamos a fun√ß√£o de gerenciamento Rodos PDU no reposit√≥rio do roteador Mikrotik </h2><br>  Ent√£o, vamos come√ßar.  Vamos criar uma fun√ß√£o de controle de retransmiss√£o usando o exemplo de controle RODOS-10 no reposit√≥rio de scripts do roteador MikroTik sob o nome "Func_RODOS10rele": <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo "Func_RODOS10rele"</b> <div class="spoiler_text"><pre> <code class="hljs mel">################ FuncRODOS10rele ###################### #     PDU RODOS<span class="hljs-number"><span class="hljs-number">-10</span></span> # by Sergej Serkov <span class="hljs-number"><span class="hljs-number">23.12</span></span><span class="hljs-number"><span class="hljs-number">.2017</span></span> ####################################################### #  ,   :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncRODOS10rele <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local Sport <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([:len $Rport]=<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Sport <span class="hljs-string"><span class="hljs-string">"80"</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={:set Sport $Rport;} :<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncPing; :local PingAnswer [$FuncPing PingAdr=$Radr]; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($PingAnswer=<span class="hljs-string"><span class="hljs-string">"OK"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local Rprotect; :local Wprotect; :local Rmode <span class="hljs-string"><span class="hljs-string">"0"</span></span>; :local Nrele <span class="hljs-number"><span class="hljs-number">0</span></span>; :local Act; :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (([:len $Rlogin]=<span class="hljs-number"><span class="hljs-number">0</span></span>) and ([:len $Rpass]=<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rprotect <span class="hljs-string"><span class="hljs-string">""</span></span>; set Wprotect <span class="hljs-string"><span class="hljs-string">""</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={:set Rprotect (<span class="hljs-string"><span class="hljs-string">"$Rlogin"</span></span>.<span class="hljs-string"><span class="hljs-string">":"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rpass"</span></span>.<span class="hljs-string"><span class="hljs-string">"@"</span></span>); set Wprotect <span class="hljs-string"><span class="hljs-string">"/protect"</span></span>;} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"on"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"n"</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"off"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"f"</span></span>} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rstatus=<span class="hljs-string"><span class="hljs-string">"inv"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={:set Rmode <span class="hljs-string"><span class="hljs-string">"1"</span></span>; :set Act <span class="hljs-string"><span class="hljs-string">"s"</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={} :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($Rmode=<span class="hljs-string"><span class="hljs-string">"1"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set Nrele ([:tonum $Rrele] - <span class="hljs-number"><span class="hljs-number">1</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (($Nrele &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> and ($Nrele &lt; <span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local StrFetchRodos; :set StrFetchRodos (<span class="hljs-string"><span class="hljs-string">"http://"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rprotect"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Radr"</span></span>.<span class="hljs-string"><span class="hljs-string">":"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Sport"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect"</span></span>.<span class="hljs-string"><span class="hljs-string">"/rb"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Nrele"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Act"</span></span>.<span class="hljs-string"><span class="hljs-string">".cgi"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { [/tool fetch url=$StrFetchRodos mode=http dst-path=<span class="hljs-string"><span class="hljs-string">"Rodosanswer.txt"</span></span>;]; } on-<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>={: <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"Call ERROR function &lt;RODOS10rele&gt; ERROR fetch command"</span></span>); :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: command ROS &lt;fetch&gt;"</span></span>; : <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer} :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">warning</span></span> (<span class="hljs-string"><span class="hljs-string">"all "</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele #"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele "</span></span>.<span class="hljs-string"><span class="hljs-string">"is ["</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rstatus"</span></span>.<span class="hljs-string"><span class="hljs-string">"]"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :delay <span class="hljs-number"><span class="hljs-number">2</span></span>s; :local Rodosanswer [/<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> get Rodosanswer.txt contents]; /<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> remove Rodosanswer.txt; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele#"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele"</span></span>.<span class="hljs-string"><span class="hljs-string">" but NUMBER RELE MISMATCH"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: rele range mismath"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; set rele#"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Rrele"</span></span>.<span class="hljs-string"><span class="hljs-string">" but RELE REGIME SET MISMATCH"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: rele regime set mismatch"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>={ :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> (<span class="hljs-string"><span class="hljs-string">"all ERROR"</span></span>.<span class="hljs-string"><span class="hljs-string">"$Wprotect "</span></span>.<span class="hljs-string"><span class="hljs-string">"function &lt;RODOS10rele&gt; but DEVICE NOT RESPONDED"</span></span>); :<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> info <span class="hljs-string"><span class="hljs-string">""</span></span>; :local Rodosanswer <span class="hljs-string"><span class="hljs-string">"ERROR: device not responded"</span></span>; :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $Rodosanswer;} }</code> </pre></div></div><br>  A fun√ß√£o FuncRODOS10rele tamb√©m utiliza em seu trabalho outra pequena fun√ß√£o de verificar o endere√ßo de rede para ping - <b>FuncPing</b> , que deve estar presente no ambiente das vari√°veis ‚Äã‚Äãdo reposit√≥rio do roteador durante a opera√ß√£o da fun√ß√£o principal. <br><br><div class="spoiler">  <b class="spoiler_title">C√≥digo "Func_Ping"</b> <div class="spoiler_text"><pre> <code class="hljs mel">:<span class="hljs-keyword"><span class="hljs-keyword">global</span></span> FuncPing <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :local PingCount <span class="hljs-number"><span class="hljs-number">3</span></span>; #  ; :local Result [/ping $PingAdr count=$PingCount]; :delay <span class="hljs-number"><span class="hljs-number">2</span></span>s; :local PingAnswer <span class="hljs-string"><span class="hljs-string">""</span></span>; :local MainIfInetOk false; :set MainIfInetOk ((<span class="hljs-number"><span class="hljs-number">3</span></span>*$Result) &gt;= (<span class="hljs-number"><span class="hljs-number">2</span></span> * $PingCount)) :put <span class="hljs-string"><span class="hljs-string">"MainIfInetOk=$MainIfInetOk"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$MainIfInetOk) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set PingAnswer <span class="hljs-string"><span class="hljs-string">"ERROR"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($MainIfInetOk) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>={ :set PingAnswer <span class="hljs-string"><span class="hljs-string">"OK"</span></span> } :<span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $PingAnswer;}</code> </pre></div></div><br><h2>  Aplica√ß√£o da fun√ß√£o de controle de rel√© </h2><br>  O seguinte deve ser passado como par√¢metros para a fun√ß√£o FuncRODOS10rele: <br><br><ul><li>  Radr - endere√ßo IP do dispositivo </li><li>  Rport - porta http.  Se a porta padr√£o para http (80) estiver configurada, este par√¢metro poder√° ser omitido </li><li>  Rrele - o n√∫mero do rel√© sobre o qual executamos uma a√ß√£o (para RODOS-10 [1-4]), <br>  para o RODOS-9 [1-2], para o RODOS-8 n√£o √© transmitido) </li><li>  Rstatus - a√ß√£o sendo executada ("off" - desativar; "on" - ativar; "inv" - dar um impulso) </li><li>  Rlogin - login, Rpass - senha de acesso ao dispositivo <br>  (se n√£o estiverem definidas, a chamada de comando ser√° usada sem "/ protect") <br></li></ul><br><div class="spoiler">  <b class="spoiler_title">Exemplo 1: chamando uma fun√ß√£o com acesso √† PDU atrav√©s da porta http padr√£o quando o "modo protegido" est√° desativado no m√≥dulo, ativando o rel√© n¬∫ 2:</b> <div class="spoiler_text"><pre> <code class="hljs powershell">[<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"on"</span></span>]</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Exemplo 2: chamando uma fun√ß√£o com acesso √† PDU atrav√©s da porta http 8021 configurada com o "modo protegido" configurado, desativando o rel√© n¬∫ 2</b> <div class="spoiler_text"><pre> <code class="hljs powershell">[<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rport</span></span>=<span class="hljs-string"><span class="hljs-string">"8021"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"2"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"off"</span></span> <span class="hljs-type"><span class="hljs-type">Rlogin</span></span>=<span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-type"><span class="hljs-type">Rpass</span></span>=<span class="hljs-string"><span class="hljs-string">"password"</span></span>]</code> </pre> </div></div><br>  A resposta da fun√ß√£o pode ser retornada √† vari√°vel de sequ√™ncia <b>Rodosanswer</b> . <br><br><div class="spoiler">  <b class="spoiler_title">Rodosanswer pode conter o seguinte texto:</b> <div class="spoiler_text"><pre>  ‚Ä¢ "Sucesso!" - no caso de uma chamada e execu√ß√£o bem-sucedida de uma equipe

  ‚Ä¢ "Falha" - no caso de manipula√ß√£o incorreta e n√£o execu√ß√£o de um comando

  ‚Ä¢ "ERRO: incompatibilidade de faixa de refer√™ncia" - se um n√∫mero de rel√© inv√°lido for especificado 
	 no par√¢metro da fun√ß√£o Rrele para esta vers√£o do dispositivo

  ‚Ä¢ "ERRO: incompatibilidade de conjunto de regime rele" - no caso de n√£o especificado ou incorreto 
     o par√¢metro especificado da fun√ß√£o Rstatus ("on", "off", "inv")

  ‚Ä¢ "ERRO: dispositivo n√£o respondeu" - se n√£o houver resposta do dispositivo 
     pingar

  ‚Ä¢ "ERRO: comando ROS &lt;busca&gt;" - no caso de um erro diretamente
     ao executar o comando RouterOS buscar URL (geralmente se n√£o
     o n√∫mero da porta especificado em Rport, par√¢metros Rlogine especificados incorretamente
     e / ou Rpass)
</pre></div></div><br>  Voc√™ pode chamar a fun√ß√£o de controle de retransmiss√£o na PDU a partir de qualquer outro script, da seguinte maneira: <br><br><ol><li>  Primeiro, voc√™ precisa executar scripts que colocam as fun√ß√µes necess√°rias no ambiente das vari√°veis ‚Äã‚Äãdo reposit√≥rio do roteador.  Isso pode ser feito uma vez, por exemplo, ao iniciar o roteador a partir do RouterOS Scheduler ( <b>/ system scheduler</b> ) <br><br><pre> <code class="hljs pgsql">#          /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> script run Func_RODOS10rele; #      ¬´FuncPing¬ª # (  FuncRODOS10rele) /<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> script run Func_Ping;</code> </pre> </li><li>  Depois que as fun√ß√µes s√£o definidas, voc√™ pode us√°-las (em particular, chamar FuncRODOS10rele) <br><br>  Como exemplo, chamamos nossa fun√ß√£o aplicando um pulso ao rel√© n ¬∞ 4 da PDU RODOS-10: <br><br><pre> <code class="hljs powershell">:global FuncRODOS10rele; :local Rodosanswer [<span class="hljs-variable"><span class="hljs-variable">$FuncRODOS10rele</span></span> <span class="hljs-type"><span class="hljs-type">Radr</span></span>=<span class="hljs-string"><span class="hljs-string">"192.168.1.20"</span></span> <span class="hljs-type"><span class="hljs-type">Rport</span></span>=<span class="hljs-string"><span class="hljs-string">"8021"</span></span> <span class="hljs-type"><span class="hljs-type">Rrele</span></span>=<span class="hljs-string"><span class="hljs-string">"4"</span></span> <span class="hljs-type"><span class="hljs-type">Rstatus</span></span>=<span class="hljs-string"><span class="hljs-string">"inv"</span></span> <span class="hljs-type"><span class="hljs-type">Rlogin</span></span>=<span class="hljs-string"><span class="hljs-string">"login"</span></span> <span class="hljs-type"><span class="hljs-type">Rpass</span></span>=<span class="hljs-string"><span class="hljs-string">"password"</span></span>]; :log info <span class="hljs-variable"><span class="hljs-variable">$Rodosanswer</span></span>;</code> </pre><br>  A resposta ser√° retornada √† vari√°vel <b>Rodosanswer</b> e, nesse caso, exibida no log do roteador. <br><br><h2>  Biblioteca de fun√ß√µes pronta para trabalhar com PDUs </h2><br>  Para facilitar o uso, criei uma biblioteca de fun√ß√µes para PDUs Rodos dos modelos 8, 9, 10 e 10 de execu√ß√£o DIN (biblioteca vers√£o 1.0 de 25 de dezembro de 2017).  Os scripts da biblioteca s√£o combinados no arquivo Func_RODOS.rsc, que pode ser importado para o RouterOS pelo seguinte comando do terminal do utilit√°rio WINBOX: <br><br><pre> <code class="hljs swift">/<span class="hljs-keyword"><span class="hljs-keyword">import</span></span> file= Func_RODOS.rsc</code> </pre> <br>  O processo de importa√ß√£o pode levar de 20 segundos a 1 minuto, dependendo do modelo do roteador Mikrotik (sua velocidade). <br>  Nesse caso, todos os scripts que estavam anteriormente dispon√≠veis no roteador n√£o s√£o afetados, as fun√ß√µes e os scripts da biblioteca Func_RODOS s√£o adicionados aos scripts de reposit√≥rio existentes. <br><br><div class="spoiler">  <b class="spoiler_title">A vers√£o 1.0 da biblioteca Rodos.rsc cont√©m os seguintes scripts:</b> <div class="spoiler_text"><ul><li>  start_RODOS - a execu√ß√£o desse script define todas as fun√ß√µes para vari√°veis ‚Äã‚Äãde ambiente </li><li>  Func_Ping - a fun√ß√£o de verificar o endere√ßo para "ping" </li><li>  Func_Mail - fun√ß√£o para enviar uma mensagem arbitr√°ria para o email do administrador </li><li>  Func_RODOS8rele - fun√ß√£o de controle de rel√© RODOS-8 PDU </li><li>  Func_RODOS8reset - fun√ß√£o de reset ("reset") do rel√© PDU RODOS-8 </li><li>  Func_RODOS9rele - ... da mesma forma para os modelos indicados ... </li><li>  Func_RODOS9reset </li><li>  Func_RODOS10rele </li><li>  Func_RODOS10reset </li><li>  call_example [...] - exemplos de chamadas de fun√ß√£o de biblioteca </li><li>  Func_RODOS_lib - todas as fun√ß√µes da PDU (exceto Ping e Mail) em um arquivo de script </li></ul></div></div><br>  Ap√≥s importar a biblioteca, voc√™ pode remover fun√ß√µes e scripts desnecess√°rios do reposit√≥rio, deixando apenas as fun√ß√µes do modelo e scripts da PDU com as fun√ß√µes FuncMail e FuncPing. <br><br>  Na biblioteca, para cada um dos modelos de PDU suportados, tamb√©m existem fun√ß√µes convenientes de redefini√ß√£o ("redefini√ß√£o") (marcadas nos nomes como "~ redefini√ß√£o").  Os par√¢metros das fun√ß√µes de redefini√ß√£o s√£o semelhantes aos par√¢metros das fun√ß√µes de instala√ß√£o do rel√©, com exce√ß√£o do par√¢metro ‚ÄúRstatus‚Äù, que n√£o √© usado durante a ‚Äúredefini√ß√£o‚Äù e o par√¢metro opcional opcional Rtime, que define o tempo em segundos entre desligar e ligar novamente o rel√© (se o Rtime n√£o for passado para a fun√ß√£o, √© usado por padr√£o 5 segundos). <br><br>  As fun√ß√µes de reinicializa√ß√£o funcionam da seguinte maneira: <br><ol><li>  O rel√© especificado recebe um comando de desligamento </li><li>  Em seguida, aguarda Rtime segundos com o comando de inclus√£o subsequente.  Nesse caso, as fun√ß√µes de redefini√ß√£o se referem √†s fun√ß√µes correspondentes de instala√ß√£o do rel√©, que devem ser determinadas antes da </li></ol><br>  Portanto, se antes de chamar a fun√ß√£o de redefini√ß√£o, um determinado rel√© foi ativado, ele ser√° desligado e ap√≥s um tempo especificado ser√° novamente ativado (e a carga conectada a ele ser√° "redefinida").  Uma opera√ß√£o semelhante √© realizada em um rel√© desligado e, ap√≥s a fun√ß√£o ser ativada, o rel√© √© ligado (ou seja, neste caso, a fun√ß√£o se cumpre como uma fun√ß√£o de comuta√ß√£o de rel√©).  √â conveniente usar as fun√ß√µes de redefini√ß√£o para reiniciar o equipamento de rede ‚Äútravado‚Äù conectado √†s PDUs Rodos (pontos de acesso, roteadores, comutadores, v√°rios servidores, etc. ...). <br><br>  Os c√≥digos-fonte da biblioteca Rodos.rsc (fun√ß√µes e scripts, exemplos de acesso a eles) s√£o ‚Äúcomentados‚Äù em detalhes suficientes, o que pode ser √∫til para quem deseja entender a biblioteca em detalhes (ou talvez modific√°-los ou escrever sua pr√≥pria vers√£o). <br><br>  Nos exemplos de chamadas para as fun√ß√µes de reinicializa√ß√£o, ap√≥s a conclus√£o da fun√ß√£o, √© poss√≠vel enviar mensagens para o endere√ßo de email do administrador do roteador (nas configura√ß√µes de vari√°vel de script, voc√™ pode especificar seu endere√ßo de email).  Nesse caso, os scripts usam o servi√ßo de email do RouterOS em <b>/ tool email</b> , cujos par√¢metros devem ser corretamente configurados com anteced√™ncia por voc√™. <br><br><h2>  Planos futuros </h2><br>  No futuro, a biblioteca de scripts para PDUs Rodos ser√° expandida - est√° planejado criar fun√ß√µes para a esta√ß√£o meteorol√≥gica da Internet RODOS-16, que possui "on board", al√©m de rel√©s, linhas de entrada / sa√≠da e sensores de temperatura / umidade / press√£o atmosf√©rica.  Tamb√©m est√° planejado implementar o registro das fun√ß√µes n√£o apenas no log e no correio do roteador, mas tamb√©m no n√∫mero de telefone especificado da escolha do usu√°rio (enviando mensagens SMS atrav√©s do modem do roteador). <br><br>  Talvez, no processo de uso da biblioteca pelos usu√°rios (incluindo os leitores deste material), alguns erros sejam revelados, os quais, em regra, s√£o inevit√°veis ‚Äã‚Äãdurante qualquer desenvolvimento.  Por favor, informe-me de quaisquer erros, coment√°rios e sugest√µes para sua corre√ß√£o. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link para a descri√ß√£o do comando Buscar para roteadores MikroTik</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link para documenta√ß√£o para PDUs usadas</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Link para a biblioteca de fun√ß√µes de script da PDU Rodos</a> <br><br>  Serkov Sergey Vladimirovich, 26 de dezembro de 2017 </li></ol></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt410107/">https://habr.com/ru/post/pt410107/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt410093/index.html">Quadrocopter canadense obedece √†s caretas do operador</a></li>
<li><a href="../pt410095/index.html">Entusiasta do computador montou um processador de 8 bits a partir dos materiais dispon√≠veis</a></li>
<li><a href="../pt410099/index.html">O MIT explicou como os h√°bitos s√£o formados</a></li>
<li><a href="../pt410103/index.html">DNA atrav√©s dos olhos de um programador</a></li>
<li><a href="../pt410105/index.html">Interface DALI e Arduino. Surrealismo real</a></li>
<li><a href="../pt410109/index.html">A botnet Smominru ajuda os invasores a ganhar mais de US $ 3,6 milh√µes</a></li>
<li><a href="../pt410111/index.html">Candidato a membranas celulares encontradas em Tit√£</a></li>
<li><a href="../pt410113/index.html">O menor ve√≠culo de lan√ßamento lan√ßou com sucesso um sat√©lite em √≥rbita</a></li>
<li><a href="../pt410115/index.html">Sexto Mitap DIY no Grupo Mail.Ru (18/02/2018)</a></li>
<li><a href="../pt410117/index.html">Os pesquisadores sugeriram como rastrear um smartphone com o GPS desligado.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>