<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸŒ¨ï¸ â›¹ğŸ¼ ğŸˆ Linux Kernel 5.0-åœ¨blk-mqä¸‹ç¼–å†™ç®€å•å—è®¾å¤‡ ğŸ’¿ â˜ğŸ» ğŸ‘²ğŸ»</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å¤§å®¶å¥½æ¶ˆæ¯ï¼ 

 Linuxå†…æ ¸5.0å·²ç»åœ¨è¿™é‡Œå¹¶å‡ºç°åœ¨å®éªŒå‘è¡Œç‰ˆä¸­ï¼Œä¾‹å¦‚Archï¼ŒopenSUSE Tumbleweedï¼ŒFedoraã€‚ 



 è€Œä¸”ï¼Œå¦‚æœæ‚¨æŸ¥çœ‹Ubuntu Disko Dingoå’ŒRed Hat 8çš„RCå‘è¡Œç‰ˆï¼Œåˆ™å¾ˆæ¸…æ¥šï¼šå¾ˆå¿«å†…æ ¸5.0ä¹Ÿå°†ä»é£æ‰‡å°å¼æœºè½¬ç§»åˆ°é‡è¦çš„æœåŠ¡å™¨ä¸Šã€‚...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Linux Kernel 5.0-åœ¨blk-mqä¸‹ç¼–å†™ç®€å•å—è®¾å¤‡</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/veeam/blog/446148/"> å¤§å®¶å¥½æ¶ˆæ¯ï¼ <br><br>  Linuxå†…æ ¸5.0å·²ç»åœ¨è¿™é‡Œå¹¶å‡ºç°åœ¨å®éªŒå‘è¡Œç‰ˆä¸­ï¼Œä¾‹å¦‚Archï¼ŒopenSUSE Tumbleweedï¼ŒFedoraã€‚ <br><br><img src="https://habrastorage.org/webt/me/zn/aq/meznaq4kak63su90hds63zvj1tq.png"><br><br> è€Œä¸”ï¼Œå¦‚æœæ‚¨æŸ¥çœ‹Ubuntu Disko Dingoå’ŒRed Hat 8çš„RCå‘è¡Œç‰ˆï¼Œåˆ™å¾ˆæ¸…æ¥šï¼šå¾ˆå¿«å†…æ ¸5.0ä¹Ÿå°†ä»é£æ‰‡å°å¼æœºè½¬ç§»åˆ°é‡è¦çš„æœåŠ¡å™¨ä¸Šã€‚ <br> æœ‰äººä¼šè¯´-é‚£ä¹ˆã€‚ ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚ æ‰€ä»¥è±çº³æ–¯Â·æ‰˜ç“¦å°”å…¹æœ¬äººè¯´ï¼š <blockquote> æˆ‘æƒ³å†æ¬¡æŒ‡å‡ºï¼Œæˆ‘ä»¬ä¸è¿›è¡ŒåŸºäºåŠŸèƒ½çš„å‘è¡Œï¼Œâ€œ 5.0â€çš„å«ä¹‰ä¸å¤–ä¹æ˜¯4.xæ•°å­—å¼€å§‹å˜å¾—è¶³å¤Ÿå¤§ï¼Œä»¥è‡³äºæˆ‘ç­‹ç–²åŠ›å°½å’Œè„šè¶¾ã€‚ <br><br>  ï¼ˆ <i>æˆ‘å†è¯´ä¸€é-æˆ‘ä»¬çš„å‘è¡Œç‰ˆä¸ä¸ä»»ä½•ç‰¹å®šåŠŸèƒ½ç»‘å®šï¼Œå› æ­¤æ–°ç‰ˆæœ¬5.0çš„ç¼–å·ä»…æ„å‘³ç€å¯¹4.xç‰ˆæœ¬ç¼–å·ï¼Œæˆ‘å·²ç»æ²¡æœ‰è¶³å¤Ÿçš„æ‰‹æŒ‡å’Œè„šè¶¾äº†</i> ï¼‰ <br></blockquote><br> ä½†æ˜¯ï¼Œç”¨äºè½¯ç›˜çš„æ¨¡å—ï¼ˆä¸çŸ¥é“-è¿™äº›æ˜¯å¤§å°ä¸ºå‰èƒ¸å£è¢‹è¡¬è¡«çš„ç£ç›˜ï¼Œå®¹é‡ä¸º1.44 MBï¼‰-å·²æ›´æ­£... <br> è¿™å°±æ˜¯ä¸ºä»€ä¹ˆï¼š <br><a name="habracut"></a><br> è¿™éƒ½æ˜¯å…³äºå¤šé˜Ÿåˆ—å—å±‚ï¼ˆblk-mqï¼‰çš„ã€‚ äº’è”ç½‘ä¸Šæœ‰å¾ˆå¤šå…³äºä»–çš„ä»‹ç»æ€§æ–‡ç« ï¼Œæ‰€ä»¥è®©æˆ‘ä»¬ç›´æ¥è®²ä¸€ä¸‹ã€‚ å‘blk-mqçš„è¿‡æ¸¡å¾ˆä¹…ä»¥å‰å°±å¼€å§‹äº†ï¼Œå¹¶æ­£åœ¨ç¼“æ…¢åœ°å‘å‰å‘å±•ã€‚ å¤šé˜Ÿåˆ—scsiï¼ˆå†…æ ¸å‚æ•°scsi_mod.use_blk_mqï¼‰å‡ºç°äº†ï¼Œæ–°çš„è°ƒåº¦ç¨‹åºmq-deadlineï¼Œbfqç­‰å‡ºç°äº†â€¦â€¦ <br><br><pre><code class="dos hljs">[root@fedora-<span class="hljs-number"><span class="hljs-number">29</span></span> sblkdev]# cat /sys/block/sda/queue/scheduler [mq-deadline] none</code> </pre> <br> é¡ºä¾¿é—®ä¸€ä¸‹ï¼Œä½ æ˜¯ä»€ä¹ˆäººï¼Ÿ <br><br> å‡å°‘äº†ä½¿ç”¨æ—§ç‰ˆæœ¬çš„å—è®¾å¤‡é©±åŠ¨ç¨‹åºçš„æ•°é‡ã€‚ åœ¨5.0ä¸­ï¼Œblk_init_queueï¼ˆï¼‰å‡½æ•°è¢«ä¸å¿…è¦åœ°åˆ é™¤äº†ã€‚ ç°åœ¨ï¼Œ2003å¹´çš„æ—§å…‰è£ä»£ç <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">lwn.net/Articles/58720</a>ä¸ä»…ä¸å¯ç”¨ï¼Œè€Œä¸”å¤±å»äº†ç›¸å…³æ€§ã€‚ æ­¤å¤–ï¼Œå‡†å¤‡åœ¨ä»Šå¹´å‘å¸ƒçš„æ–°å‘è¡Œç‰ˆåœ¨é»˜è®¤é…ç½®ä¸­ä½¿ç”¨äº†å¤šé˜Ÿåˆ—å—å±‚ã€‚ ä¾‹å¦‚ï¼Œåœ¨ç¬¬18ä¸ªManjaroä¸Šï¼Œå†…æ ¸ï¼ˆå°½ç®¡ç‰ˆæœ¬ä¸º4.19ï¼‰é»˜è®¤ä¸ºblk-mqã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾å†…æ ¸5.0ä¸­å‘blk-mqçš„è¿‡æ¸¡å·²ç»å®Œæˆã€‚ å¯¹æˆ‘æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªé‡è¦äº‹ä»¶ï¼Œéœ€è¦é‡å†™ä»£ç å’Œè¿›è¡Œå…¶ä»–æµ‹è¯•ã€‚ å®ƒæœ¬èº«æ‰¿è¯ºä¼šå‡ºç°å¤§å°ä¸ä¸€çš„é”™è¯¯ä»¥åŠå‡ ä¸ªå´©æºƒçš„æœåŠ¡å™¨ï¼ˆè¿™æ˜¯å¿…è¦çš„ï¼ŒFedyaï¼Œè¿™æ˜¯å¿…é¡»çš„ï¼ï¼ˆCï¼‰ï¼‰ã€‚ <br><br> é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¦‚æœæœ‰äººè®¤ä¸ºå¯¹äºrhel8æ¥è¯´ï¼Œè¿™ä¸ªä¸´ç•Œç‚¹æ²¡æœ‰åˆ°æ¥ï¼Œå› ä¸ºé‚£é‡Œçš„å†…æ ¸æ˜¯ç”±4.18ç‰ˆâ€œåˆ·æ–°â€çš„ï¼Œé‚£ä¹ˆæ‚¨å°±é”™äº†ã€‚ åœ¨rhel8ä¸Šçš„æœ€æ–°RCä¸­ï¼Œå·²ç»ç§»æ¤äº†5.0ä»¥åçš„æ–°äº§å“ï¼Œå¹¶ä¸”blk_init_queueï¼ˆï¼‰å‡½æ•°ä¹Ÿå·²è¢«åˆ é™¤ï¼ˆå¯èƒ½æ˜¯åœ¨å°†å¦ä¸€ä¸ªç­¾å…¥ä»github.com/torvalds/linuxæ‹–åˆ°å…¶æºæ—¶ï¼‰ã€‚ <br> é€šå¸¸ï¼Œé•¿æœŸä»¥æ¥ï¼ŒLinuxå‘è¡Œå•†ï¼ˆå¦‚SUSEå’ŒRed Hatï¼‰çš„å†…æ ¸çš„â€œå†»ç»“â€ç‰ˆæœ¬ã€‚ ä¾‹å¦‚ï¼Œç³»ç»ŸæŠ¥å‘Šç‰ˆæœ¬ä¸º4.4ï¼Œå®é™…ä¸Šè¯¥åŠŸèƒ½æ¥è‡ªæ–°çš„4.8 vanillaã€‚ åŒæ—¶ï¼Œåœ¨å®˜æ–¹ç½‘ç«™ä¸Šæ ‡æœ‰ä¸€ä¸ªé¢˜è¯ï¼Œä¾‹å¦‚ï¼šâ€œåœ¨æ–°å‘è¡Œç‰ˆä¸­ï¼Œæˆ‘ä»¬ä¸ºæ‚¨ä¿ç•™äº†ç¨³å®šçš„4.4å†…æ ¸ã€‚â€ <br><br> ä½†æ˜¯æˆ‘ä»¬åˆ†å¿ƒäº†... <br><br> æ‰€ä»¥åœ¨è¿™é‡Œã€‚ æˆ‘ä»¬éœ€è¦ä¸€ä¸ªæ–°çš„ç®€å•å—è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œä»¥ä½¿å…¶æ›´æ¸…æ¥šåœ°å·¥ä½œã€‚ <br> å› æ­¤ï¼Œæºä»£ç åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github.com/CodeImp/sblkdevä¸Š</a> ã€‚ æˆ‘å»ºè®®è®¨è®ºï¼Œæå‡ºæ‹‰åŠ¨è¯·æ±‚ï¼Œå¼€å§‹å‘è¡Œ-æˆ‘å°†è§£å†³å®ƒã€‚ è´¨é‡æ£€æŸ¥å°šæœªæµ‹è¯•ã€‚ <br><br> åœ¨æœ¬æ–‡çš„åé¢ï¼Œæˆ‘å°†å°è¯•æè¿°åŸå› ã€‚ å› æ­¤ï¼Œæœ‰å¾ˆå¤šä»£ç ã€‚ <br> æˆ‘å¾ˆæŠ±æ­‰æ²¡æœ‰å®Œå…¨å°Šé‡Linuxå†…æ ¸ç¼–ç é£æ ¼ï¼Œæ˜¯çš„-æˆ‘ä¸å–œæ¬¢gotoã€‚ <br><br> å› æ­¤ï¼Œè®©æˆ‘ä»¬ä»å…¥å£ç‚¹å¼€å§‹ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> __<span class="hljs-function"><span class="hljs-function">init </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SUCCESS; _sblkdev_major = register_blkdev(_sblkdev_major, _sblkdev_name); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_sblkdev_major &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: unable to get major number\n"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -EBUSY; } ret = sblkdev_add_device(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ret) unregister_blkdev(_sblkdev_major, _sblkdev_name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ret; } <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> __<span class="hljs-function"><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-built_in">exit</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_exit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ sblkdev_remove_device(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_sblkdev_major &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) unregister_blkdev(_sblkdev_major, _sblkdev_name); } module_init(sblkdev_init); module_exit(sblkdev_exit);</code> </pre><br> æ˜¾ç„¶ï¼Œåœ¨åŠ è½½æ¨¡å—æ—¶ï¼Œå°†åœ¨å¸è½½sblkdev_exitï¼ˆï¼‰æ—¶å¯åŠ¨sblkdev_initï¼ˆï¼‰å‡½æ•°ã€‚ <br>  register_blkdevï¼ˆï¼‰å‡½æ•°æ³¨å†Œä¸€ä¸ªå—è®¾å¤‡ã€‚ ä»–è¢«åˆ†é…äº†ä¸€ä¸ªä¸»è¦å·ç ã€‚  unregister_blkdevï¼ˆï¼‰-é‡Šæ”¾æ­¤æ•°å­—ã€‚ <br><br> æˆ‘ä»¬æ¨¡å—çš„å…³é”®ç»“æ„æ˜¯sblkdev_device_tã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// The internal representation of our device typedef struct sblkdev_device_s { sector_t capacity; // Device size in bytes u8* data; // The data aray. u8 - 8 bytes atomic_t open_counter; // How many openers struct blk_mq_tag_set tag_set; struct request_queue *queue; // For mutual exclusion struct gendisk *disk; // The gendisk structure } sblkdev_device_t;</span></span></code> </pre><br> å®ƒåŒ…å«æœ‰å…³å†…æ ¸æ¨¡å—å¿…éœ€çš„è®¾å¤‡çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå°¤å…¶æ˜¯ï¼šå—è®¾å¤‡çš„å®¹é‡ï¼Œæ•°æ®æœ¬èº«ï¼ˆè¿™å¾ˆç®€å•ï¼‰ï¼ŒæŒ‡å‘ç£ç›˜çš„æŒ‡é’ˆå’Œé˜Ÿåˆ—ã€‚ <br><br> æ‰€æœ‰å—è®¾å¤‡åˆå§‹åŒ–éƒ½åœ¨sblkdev_add_deviceï¼ˆï¼‰å‡½æ•°ä¸­æ‰§è¡Œã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_add_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SUCCESS; <span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>* dev = kzalloc(<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>), GFP_KERNEL); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: unable to allocate %ld bytes\n"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -ENOMEM; } _sblkdev_device = dev; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span>{ ret = sblkdev_allocate_buffer(dev); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ret) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> 0 </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">//simply variant with helper function blk_mq_init_sq_queue. It`s available from kernel 4.20 (vanilla). {//configure tag_set struct request_queue *queue; dev-&gt;tag_set.cmd_size = sizeof(sblkdev_cmd_t); dev-&gt;tag_set.driver_data = dev; queue = blk_mq_init_sq_queue(&amp;dev-&gt;tag_set, &amp;_mq_ops, 128, BLK_MQ_F_SHOULD_MERGE | BLK_MQ_F_SG_MERGE); if (IS_ERR(queue)) { ret = PTR_ERR(queue); printk(KERN_WARNING "sblkdev: unable to allocate and initialize tag set\n"); break; } dev-&gt;queue = queue; } #else // more flexible variant {//configure tag_set dev-&gt;tag_set.ops = &amp;_mq_ops; dev-&gt;tag_set.nr_hw_queues = 1; dev-&gt;tag_set.queue_depth = 128; dev-&gt;tag_set.numa_node = NUMA_NO_NODE; dev-&gt;tag_set.cmd_size = sizeof(sblkdev_cmd_t); dev-&gt;tag_set.flags = BLK_MQ_F_SHOULD_MERGE | BLK_MQ_F_SG_MERGE; dev-&gt;tag_set.driver_data = dev; ret = blk_mq_alloc_tag_set(&amp;dev-&gt;tag_set); if (ret) { printk(KERN_WARNING "sblkdev: unable to allocate tag set\n"); break; } } {//configure queue struct request_queue *queue = blk_mq_init_queue(&amp;dev-&gt;tag_set); if (IS_ERR(queue)) { ret = PTR_ERR(queue); printk(KERN_WARNING "sblkdev: Failed to allocate queue\n"); break; } dev-&gt;queue = queue; } #endif dev-&gt;queue-&gt;queuedata = dev; {// configure disk struct gendisk *disk = alloc_disk(1); //only one partition if (disk == NULL) { printk(KERN_WARNING "sblkdev: Failed to allocate disk\n"); ret = -ENOMEM; break; } disk-&gt;flags |= GENHD_FL_NO_PART_SCAN; //only one partition //disk-&gt;flags |= GENHD_FL_EXT_DEVT; disk-&gt;flags |= GENHD_FL_REMOVABLE; disk-&gt;major = _sblkdev_major; disk-&gt;first_minor = 0; disk-&gt;fops = &amp;_fops; disk-&gt;private_data = dev; disk-&gt;queue = dev-&gt;queue; sprintf(disk-&gt;disk_name, "sblkdev%d", 0); set_capacity(disk, dev-&gt;capacity); dev-&gt;disk = disk; add_disk(disk); } printk(KERN_WARNING "sblkdev: simple block device was created\n"); }while(false); if (ret){ sblkdev_remove_device(); printk(KERN_WARNING "sblkdev: Failed add block device\n"); } return ret; }</span></span></span></span></code> </pre><br> æˆ‘ä»¬ä¸ºç»“æ„åˆ†é…å†…å­˜ï¼Œä¸ºå­˜å‚¨æ•°æ®åˆ†é…ç¼“å†²åŒºã€‚ è¿™é‡Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ã€‚ <br> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªblk_mq_init_sq_queueï¼ˆï¼‰å‡½æ•°æˆ–ä¸€æ¬¡ä¸¤ä¸ªblk_mq_alloc_tag_setï¼ˆï¼‰+ blk_mq_init_queueï¼ˆï¼‰å‡½æ•°æ¥åˆå§‹åŒ–è¯·æ±‚å¤„ç†é˜Ÿåˆ—ã€‚ <br><br> é¡ºä¾¿è¯´ä¸€å¥ï¼Œå¦‚æœæŸ¥çœ‹blk_mq_init_sq_queueï¼ˆï¼‰å‡½æ•°çš„æºä»£ç ï¼Œæ‚¨ä¼šå‘ç°è¿™åªæ˜¯å¯¹4.20å†…æ ¸ä¸­å‡ºç°çš„blk_mq_alloc_tag_setï¼ˆï¼‰å’Œblk_mq_init_queueï¼ˆï¼‰å‡½æ•°çš„åŒ…è£…ã€‚ å¦å¤–ï¼Œå®ƒä¸ºæˆ‘ä»¬éšè—äº†é˜Ÿåˆ—çš„è®¸å¤šå‚æ•°ï¼Œä½†çœ‹èµ·æ¥å´ç®€å•å¾—å¤šã€‚ æ‚¨å¿…é¡»é€‰æ‹©æ›´å¥½çš„é€‰æ‹©ï¼Œä½†æ˜¯æˆ‘æ›´å–œæ¬¢ä¸€ä¸ªæ›´æ˜ç¡®çš„é€‰æ‹©ã€‚ <br><br> æ­¤ä»£ç ä¸­çš„å…³é”®æ˜¯å…¨å±€å˜é‡_mq_opsã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blk_mq_ops</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mq_ops</span></span></span><span class="hljs-class"> = {</span></span> .queue_rq = queue_rq, };</code> </pre><br> è¿™æ˜¯æä¾›è¯·æ±‚å¤„ç†çš„åŠŸèƒ½æ‰€åœ¨çš„ä½ç½®ï¼Œä½†ç¨åä¼šå¯¹æ­¤è¿›è¡Œæ›´å¤šä»‹ç»ã€‚ æœ€ä¸»è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å·²å°†å…¥å£ç‚¹æŒ‡å®šç»™è¯·æ±‚å¤„ç†ç¨‹åºã€‚ <br><br> ç°åœ¨æˆ‘ä»¬å·²ç»åˆ›å»ºäº†é˜Ÿåˆ—ï¼Œæˆ‘ä»¬â€‹â€‹å¯ä»¥åˆ›å»ºç£ç›˜çš„å®ä¾‹ã€‚ <br><br> æ²¡æœ‰é‡å¤§å˜åŒ–ã€‚ åˆ†é…ç£ç›˜ï¼Œè®¾ç½®å‚æ•°å¹¶å°†ç£ç›˜æ·»åŠ åˆ°ç³»ç»Ÿä¸­ã€‚ æˆ‘æƒ³è§£é‡Šä¸€ä¸‹å‚æ•°disk-&gt;æ ‡å¿—ã€‚ å®ƒä½¿æ‚¨å¯ä»¥å‘Šè¯‰ç³»ç»Ÿè¯¥ç£ç›˜æ˜¯å¯ç§»åŠ¨çš„ï¼Œæˆ–è€…ä¾‹å¦‚ï¼Œå®ƒä¸åŒ…å«åˆ†åŒºï¼Œå¹¶ä¸”æ‚¨æ— éœ€åœ¨é‚£é‡Œå¯»æ‰¾å®ƒä»¬ã€‚ <br><br> æœ‰ä¸€ä¸ªç”¨äºç£ç›˜ç®¡ç†çš„_fopsç»“æ„ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">block_device_operations</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fops</span></span></span><span class="hljs-class"> = {</span></span> .owner = THIS_MODULE, .open = _open, .release = _release, .ioctl = _ioctl, #ifdef CONFIG_COMPAT .compat_ioctl = _compat_ioctl, #endif };</code> </pre><br> å¯¹äºæˆ‘ä»¬æ¥è¯´ï¼Œç”¨äºç®€å•å—è®¾å¤‡æ¨¡å—çš„å…¥å£_openå’Œ_releaseè¿˜ä¸æ˜¯å¾ˆæœ‰è¶£ã€‚ é™¤äº†åŸå­é€’å¢å’Œé€’å‡è®¡æ•°å™¨å¤–ï¼Œæ²¡æœ‰ä»»ä½•å…¶ä»–å†…å®¹ã€‚ æˆ‘ä¹Ÿæ²¡æœ‰æ‰§è¡Œcompat_ioctlï¼Œå› ä¸ºå¯¹æˆ‘æ¥è¯´ï¼Œå…·æœ‰64ä½å†…æ ¸å’Œ32ä½ç”¨æˆ·ç©ºé—´ç¯å¢ƒçš„ç³»ç»Ÿç‰ˆæœ¬ä¼¼ä¹å¹¶ä¸ç†æƒ³ã€‚ <br><br> ä½†æ˜¯_ioctlå…è®¸æ‚¨å¤„ç†è¯¥é©±åŠ¨å™¨çš„ç³»ç»Ÿè¯·æ±‚ã€‚ å‡ºç°ç£ç›˜æ—¶ï¼Œç³»ç»Ÿå°†å°è¯•äº†è§£æ›´å¤šä¿¡æ¯ã€‚ æ‚¨å¯ä»¥è‡ªè¡Œå†³å®šå›ç­”ä¸€äº›æŸ¥è¯¢ï¼ˆä¾‹å¦‚ï¼Œå‡è£…æ˜¯ä¸€å¼ æ–°CDï¼‰ï¼Œä½†æ˜¯ä¸€èˆ¬è§„åˆ™æ˜¯ï¼šå¦‚æœæ‚¨ä¸æƒ³å›ç­”æ‚¨ä¸æ„Ÿå…´è¶£çš„æŸ¥è¯¢ï¼Œåªéœ€è¿”å›é”™è¯¯ä»£ç -ENOTTYã€‚ é¡ºä¾¿è¯´ä¸€ä¸‹ï¼Œå¦‚æœ‰å¿…è¦ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤å¤„æ·»åŠ æœ‰å…³æ­¤ç‰¹å®šé©±åŠ¨å™¨çš„è¯·æ±‚å¤„ç†ç¨‹åºã€‚ <br><br> å› æ­¤ï¼Œæˆ‘ä»¬æ·»åŠ äº†è®¾å¤‡-æˆ‘ä»¬éœ€è¦æ³¨æ„èµ„æºçš„é‡Šæ”¾ã€‚  Rustä¸åœ¨<s>è¿™é‡Œ</s> ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sblkdev_remove_device</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span>* dev = _sblkdev_device; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;disk) del_gendisk(dev-&gt;disk); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>) { blk_cleanup_queue(dev-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span>); dev-&gt;<span class="hljs-built_in"><span class="hljs-built_in">queue</span></span> = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;tag_set.tags) blk_mq_free_tag_set(&amp;dev-&gt;tag_set); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dev-&gt;disk) { put_disk(dev-&gt;disk); dev-&gt;disk = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; } sblkdev_free_buffer(dev); kfree(dev); _sblkdev_device = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: simple block device was removed\n"</span></span>); } }</code> </pre><br> åŸåˆ™ä¸Šï¼Œæ‰€æœ‰äº‹æƒ…éƒ½æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼šæˆ‘ä»¬ä»ç³»ç»Ÿä¸­åˆ é™¤ç£ç›˜å¯¹è±¡å¹¶é‡Šæ”¾é˜Ÿåˆ—ï¼Œç„¶åé‡Šæ”¾ç¼“å†²åŒºï¼ˆæ•°æ®åŒºåŸŸï¼‰ã€‚ <br><br> ç°åœ¨ï¼Œæœ€é‡è¦çš„æ˜¯queue_rqï¼ˆï¼‰å‡½æ•°ä¸­çš„æŸ¥è¯¢å¤„ç†ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> blk_status_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queue_rq</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct blk_mq_hw_ctx *hctx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct blk_mq_queue_data* bd)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">blk_status_t</span></span> status = BLK_STS_OK; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rq</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bd</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rq</span></span></span><span class="hljs-class">;</span></span> blk_mq_start_request(rq); <span class="hljs-comment"><span class="hljs-comment">//we cannot use any locks that make the thread sleep { unsigned int nr_bytes = 0; if (do_simple_request(rq, &amp;nr_bytes) != SUCCESS) status = BLK_STS_IOERR; printk(KERN_WARNING "sblkdev: request process %d bytes\n", nr_bytes); #if 0 //simply and can be called from proprietary module blk_mq_end_request(rq, status); #else //can set real processed bytes count if (blk_update_request(rq, status, nr_bytes)) //GPL-only symbol BUG(); __blk_mq_end_request(rq, status); #endif } return BLK_STS_OK;//always return ok }</span></span></code> </pre><br> é¦–å…ˆï¼Œè€ƒè™‘å‚æ•°ã€‚ ç¬¬ä¸€ä¸ªæ˜¯struct blk_mq_hw_ctx * hctx-ç¡¬ä»¶é˜Ÿåˆ—çš„çŠ¶æ€ã€‚ åœ¨æˆ‘ä»¬çš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ²¡æœ‰ç¡¬ä»¶é˜Ÿåˆ—ï¼Œå› æ­¤æ²¡æœ‰ä½¿ç”¨ã€‚ <br><br> ç¬¬äºŒä¸ªå‚æ•°æ˜¯const struct blk_mq_queue_data * bd-å…·æœ‰éå¸¸ç®€æ´çš„ç»“æ„çš„å‚æ•°ï¼Œæˆ‘ä¸æ€•å°†å…¶å®Œæ•´åœ°ä»‹ç»ç»™æ‚¨ï¼š <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">blk_mq_queue_data</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rq</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> last; };</code> </pre><br> äº‹å®è¯æ˜ï¼Œä»æœ¬è´¨ä¸Šè®²ï¼Œè¿™ä¸ç¼–å¹´å²å®¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">elixir.bootlin.com</a>ä¸å†è®°å¾—çš„æ—¶ä»£æ‰€æå‡ºçš„è¦æ±‚ç›¸åŒã€‚ å› æ­¤ï¼Œæˆ‘ä»¬æ¥å—äº†è¯·æ±‚å¹¶å¼€å§‹å¤„ç†å®ƒï¼Œç„¶åæˆ‘ä»¬é€šè¿‡è°ƒç”¨blk_mq_start_requestï¼ˆï¼‰é€šçŸ¥å†…æ ¸ã€‚ å®Œæˆè¯·æ±‚å¤„ç†åï¼Œæˆ‘ä»¬å°†é€šè¿‡è°ƒç”¨blk_mq_end_requestï¼ˆï¼‰å‡½æ•°æ¥é€šçŸ¥å†…æ ¸ã€‚ <br><br> è¿™é‡Œæœ‰ä¸ªå°æç¤ºï¼šblk_mq_end_requestï¼ˆï¼‰å‡½æ•°æœ¬è´¨ä¸Šæ˜¯å¯¹blk_update_requestï¼ˆï¼‰+ __blk_mq_end_requestï¼ˆï¼‰çš„è°ƒç”¨çš„åŒ…è£…ã€‚ ä½¿ç”¨blk_mq_end_requestï¼ˆï¼‰å‡½æ•°æ—¶ï¼Œæ‚¨æ— æ³•æŒ‡å®šå®é™…å¤„ç†çš„å­—èŠ‚æ•°ã€‚ ç›¸ä¿¡ä¸€åˆ‡éƒ½å·²å¤„ç†ã€‚ <br><br> æ›¿ä»£é€‰é¡¹å…·æœ‰å¦ä¸€ä¸ªåŠŸèƒ½ï¼šä»…é’ˆå¯¹ä»…GPLæ¨¡å—å¯¼å‡ºblk_update_requestå‡½æ•°ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¦åˆ›å»ºä¸“æœ‰çš„å†…æ ¸æ¨¡å—ï¼ˆè®©PMä»è¿™ä¸ªæ£˜æ‰‹çš„è·¯å¾„ä¸­è§£æ•‘å‡ºæ¥ï¼‰ï¼Œåˆ™ä¸èƒ½ä½¿ç”¨blk_update_requestï¼ˆï¼‰ã€‚ æ‰€ä»¥é€‰æ‹©æ˜¯æ‚¨çš„ã€‚ <br><br> å°†å­—èŠ‚ç›´æ¥ä»è¯·æ±‚ç§»åˆ°ç¼“å†²åŒºï¼Œåä¹‹äº¦ç„¶ï¼Œæˆ‘å°†å…¶æ”¾å…¥do_simple_requestï¼ˆï¼‰å‡½æ•°ä¸­ã€‚ <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do_simple_request</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(struct request *rq, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">unsigned</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *nr_bytes)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ret = SUCCESS; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bio_vec</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bvec</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">req_iterator</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">iter</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sblkdev_device_t</span></span> *dev = rq-&gt;q-&gt;queuedata; <span class="hljs-keyword"><span class="hljs-keyword">loff_t</span></span> pos = blk_rq_pos(rq) &lt;&lt; SECTOR_SHIFT; <span class="hljs-keyword"><span class="hljs-keyword">loff_t</span></span> dev_size = (<span class="hljs-keyword"><span class="hljs-keyword">loff_t</span></span>)(dev-&gt;capacity &lt;&lt; SECTOR_SHIFT); printk(KERN_WARNING <span class="hljs-string"><span class="hljs-string">"sblkdev: request start from sector %ld \n"</span></span>, blk_rq_pos(rq)); rq_for_each_segment(bvec, rq, iter) { <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> b_len = bvec.bv_len; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>* b_buf = page_address(bvec.bv_page) + bvec.bv_offset; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((pos + b_len) &gt; dev_size) b_len = (<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span>)(dev_size - pos); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rq_data_dir(rq))<span class="hljs-comment"><span class="hljs-comment">//WRITE memcpy(dev-&gt;data + pos, b_buf, b_len); else//READ memcpy(b_buf, dev-&gt;data + pos, b_len); pos += b_len; *nr_bytes += b_len; } return ret; }</span></span></code> </pre><br> æ²¡æœ‰ä»€ä¹ˆæ–°å†…å®¹ï¼šrq_for_each_segmentéå†æ‰€æœ‰bioï¼Œå®ƒä»¬éƒ½å…·æœ‰bio_vecç»“æ„ï¼Œä½¿æˆ‘ä»¬èƒ½å¤Ÿè®¿é—®å¸¦æœ‰è¯·æ±‚æ•°æ®çš„é¡µé¢ã€‚ <br><br> æ‚¨çš„å°è±¡å¦‚ä½•ï¼Ÿ ä¸€åˆ‡çœ‹èµ·æ¥éƒ½å¾ˆç®€å•ï¼Ÿ é€šå¸¸ï¼Œè¯·æ±‚å¤„ç†åªæ˜¯åœ¨è¯·æ±‚çš„é¡µé¢å’Œå†…éƒ¨ç¼“å†²åŒºä¹‹é—´å¤åˆ¶æ•°æ®ã€‚ éå¸¸å€¼å¾—ä¸€ä¸ªç®€å•çš„å—è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œå¯¹å—ï¼Ÿ <br><br> ä½†æ˜¯æœ‰ä¸€ä¸ªé—®é¢˜ï¼š <b>è¿™ä¸æ˜¯çœŸæ­£çš„ç”¨é€”ï¼</b> <br><br> é—®é¢˜çš„å®è´¨æ˜¯åœ¨å¤„ç†åˆ—è¡¨ä¸­è¯·æ±‚çš„å¾ªç¯ä¸­è°ƒç”¨äº†queue_rqï¼ˆï¼‰è¯·æ±‚å¤„ç†å‡½æ•°ã€‚ æˆ‘ä¸çŸ¥é“è¯¥åˆ—è¡¨ä½¿ç”¨äº†å“ªä¸ªé”ï¼ŒSpinæˆ–RCUï¼ˆæˆ‘ä¸æƒ³è¯´è°-è°çŸ¥é“ï¼Œè¯·çº æ­£æˆ‘ï¼‰ï¼Œä½†æ˜¯ä¾‹å¦‚ï¼Œå½“æ‚¨å°è¯•åœ¨è¯·æ±‚å¤„ç†åŠŸèƒ½ä¸­ä½¿ç”¨äº’æ–¥é”æ—¶ï¼Œè°ƒè¯•å†…æ ¸ä¼šå‘èª“å¹¶è­¦å‘Šï¼šæ‰“zeç¡åœ¨è¿™é‡Œæ˜¯ä¸å¯èƒ½çš„ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œç”±äºè¿›ç¨‹æ— æ³•è¿›å…¥å¾…æœºçŠ¶æ€ï¼Œå› æ­¤æ— æ³•ä½¿ç”¨å¸¸è§„çš„åŒæ­¥å·¥å…·æˆ–è™šæ‹Ÿè¿ç»­å†…å­˜ï¼ˆä½¿ç”¨vmallocåˆ†é…çš„è™šæ‹Ÿå†…å­˜ï¼Œå¹¶ä¸”å¯ä»¥ä¸å…¶æ‰€æš—ç¤ºçš„æ‰€æœ‰å†…å®¹è¿›è¡Œäº¤æ¢ï¼‰ã€‚ <br><br> å› æ­¤ï¼Œå¦‚.. \ linux \ drivers \ block \ brd.cä¸­å®ç°çš„é‚£æ ·ï¼Œåªæœ‰Spinæˆ–RCUé”ä»¥åŠé¡µé¢ï¼Œåˆ—è¡¨æˆ–æ ‘å½¢å¼çš„ç¼“å†²åŒºï¼ˆå¦‚åœ¨.. \ linux \ drivers \ block \ brd.cä¸­å®ç°ï¼‰ï¼Œæˆ–åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„å»¶è¿Ÿå¤„ç†ï¼ˆå¦‚åœ¨.. \ linuxä¸­å®ç°ï¼‰ã€‚ \ linux \é©±åŠ¨ç¨‹åº\å—\ loop.c. <br><br> æˆ‘è®¤ä¸ºæ— éœ€æè¿°å¦‚ä½•ç»„è£…æ¨¡å—ï¼Œå¦‚ä½•å°†å…¶åŠ è½½åˆ°ç³»ç»Ÿä¸­ä»¥åŠå¦‚ä½•å¸è½½ã€‚ è¿™æ–¹é¢æ²¡æœ‰æ–°äº§å“ï¼Œè°¢è°¢æ‚¨ï¼š)å› æ­¤ï¼Œå¦‚æœæœ‰äººæƒ³å°è¯•ä¸€ä¸‹ï¼Œæˆ‘ä¸€å®šä¼šå¼„æ¸…æ¥šçš„ã€‚  <b>åªæ˜¯ä¸è¦ç«‹å³åœ¨æ‚¨å–œæ¬¢çš„ç¬”è®°æœ¬ç”µè„‘ä¸Šåšï¼</b> ä¸¾èµ·virtualochkaæˆ–è‡³å°‘åœ¨çƒä¸Šåšä¸ªå¤‡ä»½ã€‚ <br><br> é¡ºä¾¿è¯´ä¸€å¥ï¼Œé€‚ç”¨äºLinuxçš„Veeam Backup 3.0.1.1046å·²ç»å¯ç”¨ã€‚ åªæ˜¯ä¸è¦å°è¯•åœ¨å†…æ ¸5.0æˆ–æ›´é«˜ç‰ˆæœ¬ä¸Šè¿è¡ŒVAL 3.0.1.1046ã€‚  veeamsnapæ— æ³•ç»„è£…ã€‚ è€Œä¸”ä¸€äº›å¤šé˜Ÿåˆ—åˆ›æ–°ä»å¤„äºæµ‹è¯•é˜¶æ®µã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN446148/">https://habr.com/ru/post/zh-CN446148/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN446134/index.html">Flutterä¸­çš„ä¾èµ–æ³¨å…¥</a></li>
<li><a href="../zh-CN446136/index.html">æˆ‘çš„å¤§ç†çŸ³æœº3Dæ‰“å°</a></li>
<li><a href="../zh-CN446138/index.html">ä»¥ç®€å•çš„åˆä¼™å…³ç³»å½¢å¼åˆæ³•åœ°ç»„ç»‡æ‚¨çš„åˆ›ä¸šå…¬å¸æœ‰å¤šå®¹æ˜“</a></li>
<li><a href="../zh-CN446142/index.html">å¹³å¦çš„åœ°çƒï¼šå®éªŒå’Œè¯æ®</a></li>
<li><a href="../zh-CN446144/index.html">é¢å‘292å·ç§»åŠ¨å¼€å‘äººå‘˜çš„æœ‰è¶£ææ–™çš„æ‘˜è¦ï¼ˆ3æœˆ25æ—¥è‡³3æœˆ31æ—¥ï¼‰</a></li>
<li><a href="../zh-CN446150/index.html">æ— éœ€Pythonï¼ŒAnacondaå’Œå…¶ä»–çˆ¬è¡ŒåŠ¨ç‰©çš„æœºå™¨å­¦ä¹ </a></li>
<li><a href="../zh-CN446152/index.html">Commando VM-Windowsçš„Kali Linuxæ›¿ä»£å“</a></li>
<li><a href="../zh-CN446162/index.html">å¦‚ä½•æˆä¸ºâ€œæ™ºèƒ½å¤§ä¸‰â€ã€‚ ä¸ªäººç»å†</a></li>
<li><a href="../zh-CN446172/index.html">é™åˆ¶æ¶ˆæ¯API VK-æ€ä¹ˆåŠ</a></li>
<li><a href="../zh-CN446174/index.html">PHPä¸­çš„Yandex.Aliceå’ŒTelegramæœºå™¨äººå…·æœ‰å•ä¸€åŠŸèƒ½</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>