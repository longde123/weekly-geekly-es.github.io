<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüéì üö∞ üôÜüèº Es da√±ino para la luz o para mantener la carga de la bater√≠a de un autom√≥vil. ‚ûø ü•® ‚¨õÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Contin√∫o la serie de art√≠culos sobre la construcci√≥n de bicicletas en el campo de la administraci√≥n de circuitos de energ√≠a de bajo voltaje. Esta vez ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Es da√±ino para la luz o para mantener la carga de la bater√≠a de un autom√≥vil.</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/446956/">  Contin√∫o la serie de art√≠culos sobre la construcci√≥n de bicicletas en el campo de la administraci√≥n de circuitos de energ√≠a de bajo voltaje.  Esta vez hablar√© sobre un dispositivo que evita la descarga profunda de la bater√≠a de un autom√≥vil por parte de varios consumidores secundarios. <br><br><img src="https://habrastorage.org/webt/_p/pt/zv/_pptzvndfwivnln2xsqz7aae224.jpeg"><br>  <i>Una de las posibles consecuencias de una descarga no controlada.</i> <br><a name="habracut"></a><br>  Comprar el primer autom√≥vil o motocicleta es un hito importante en la vida de cada persona, y especialmente de un ingeniero.  Despu√©s de todo, ¬øqui√©n m√°s adem√°s de las obvias ventajas de su nuevo caballo de hierro presta atenci√≥n inmediata a sus desventajas no obvias?  ¬øQui√©n inmediatamente comienza a pensar en las mejoras y adiciones al est√°ndar?  Por supuesto, si se trata de un autom√≥vil del segmento superior, e incluso de una marca "de moda", al principio puede parecer que tiene absolutamente todo.  Pero, como muestra la pr√°ctica, en este caso, el tiempo refuta las primeras impresiones.  Si compra un autom√≥vil de clase econ√≥mica, ¬°sus manos comienzan a picar literalmente el primer d√≠a! <br><br>  El deseo de "rellenar" su autom√≥vil con varios dispositivos electr√≥nicos auxiliares es bastante natural.  Sin embargo, poco despu√©s de la implementaci√≥n de todos estos planes, la vida enfrenta al propietario del autom√≥vil con una dura realidad.  Resulta que incluso los dispositivos m√°s modernos construidos sobre la base elemental m√°s reciente siguen ansiosos por la electricidad.  Y una bater√≠a de autom√≥vil que parece tan grande no es un reactor nuclear en absoluto, y puede "sentarse" f√°cilmente bajo el peso de todos estos consumidores aparentemente inofensivos en cuesti√≥n de d√≠as. <br><br>  Para no avanzar m√°s en situaciones abstractas e hipot√©ticas, ir√© directamente a mi historia.  Despu√©s de comprar un autom√≥vil, el primero fue el deseo de poner un registrador en √©l.  Esto se hizo en el menor tiempo posible, dictado casi por completo por la velocidad de entrega del paquete desde AliExpress.  Est√° claro que el suministro de energ√≠a regular del encendedor de cigarrillos era extremadamente inconveniente, y la grabadora r√°pidamente obtuvo una conexi√≥n estacionaria a la l√≠nea m√°s cercana de la red a trav√©s de un convertidor de pulso de 12 / 5v.  Y desde  fue, por decirlo suavemente, no ayer, este convertidor ni siquiera era moderno, para sus propias necesidades, como result√≥ m√°s tarde, consum√≠a hasta 21 mA de corriente.  Ahora, calculemos cu√°nto podr√≠a alimentar este convertidor solo con una bater√≠a nueva y completamente cargada con una capacidad de 60 Ah.  La aritm√©tica es extremadamente simple y decepcionante. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/lj/kz/tb/ljkztbra63ol-bs6xwdpdxd4xjg.png"></div><br>  Entonces, en menos de cuatro meses, un convertidor que no est√© cargado con nada aterrizar√° la bater√≠a literalmente "a cero".  Si tenemos en cuenta que una bater√≠a que no est√° completamente nueva puede resultar f√°cilmente viuda, y la carga despu√©s de que el pokatushki de la ciudad est√© lejos del 100%, un d√≠a lluvioso comienza f√°cilmente dentro de un mes con un gancho. <br><br>  Y eso es todo, repito, solo un convertidor de voltaje.  S√≠, hoy puede comprar un convertidor que solo necesita medio miliamperio para sus propias necesidades, pero di este ejemplo solo para mostrar cu√°n lenta y confiable es el <s>agua que afila una piedra,</s> incluso sin importancia, pero actuando constantemente, el consumidor extrae energ√≠a de lo que parece ser tan enorme. bater√≠a <br><br>  Vamos m√°s all√°, la grabadora en el modo de grabaci√≥n FHD @ 30fps consume casi 300 mA de la fuente + 5v, que despu√©s de la conversi√≥n teniendo en cuenta la eficiencia proporciona aproximadamente 150 mA de corriente de la red a bordo.  Supongamos que el convertidor se reemplaza por uno moderno, y calculamos el tiempo de descarga solo con esta corriente. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/uf/p8/fl/ufp8fldn4t5bfzpl8u8udb6fd3o.png"></div><br>  Poco m√°s de dos semanas, pero en la pr√°ctica, diez d√≠as.  Ahora se avecina la posibilidad de encender (y posiblemente cambiar la bater√≠a) despu√©s de las pr√≥ximas vacaciones o viaje de negocios. <br><br>  Y as√≠ me sucedi√≥: cuando me fui de vacaciones cortas y forzadas, no pens√© que en una semana m√°s o menos una cerradura central no podr√≠a abrirme la puerta. <br><br>  Muchos dir√°n que es su culpa, que todo debe estar desenergizado, o al menos dejar de grabar, y tendr√°n raz√≥n.  Pero la vida es vida, y el recuerdo no es el mismo, y no siempre es posible saber de antemano cu√°nto dura la baja por enfermedad.  Por lo tanto, la idea de un interruptor autom√°tico surgi√≥ de inmediato. <br><br>  Existe, por supuesto, una opci√≥n para alimentar la grabadora desde el interruptor de encendido para que solo funcione mientras viaja, pero esta opci√≥n tampoco es muy buena, porque  Si el auto choca en el estacionamiento, me gustar√≠a tener la oportunidad de ver al culpable.  Adem√°s, despu√©s de poco tiempo despu√©s de instalar la grabadora, el autom√≥vil no contaba con varios dispositivos m√°s, incluido un rastreador GPS oculto, que deber√≠a funcionar, si no hasta el final, al menos hasta que "casi todo" ya est√© all√≠. <br><br>  En general, durante varias semanas de reflexi√≥n pasiva, la idea de un dispositivo que debe controlar el voltaje de la red a bordo y basarse en estos datos para controlar el suministro de energ√≠a a dos grupos de consumidores: secundario (grabador, toma USB) y b√°sico (rastreador GPS y algunos que) <br><br><h3>  ¬øC√≥mo podr√≠a hacerse esto? </h3><br>  Los primeros prototipos virtuales del dispositivo se "construyeron" sobre la base de los comparadores anal√≥gicos LM393N y fueron capaces de recibir todo lo que originalmente se plane√≥ recibir del dispositivo.  El esquema abstracto era algo como esto. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/cf/la/yb/cflaybsmn6m3e6o7mshcfb_1j20.png"></div><br>  Aqu√≠ se usan dos comparadores para cambiar cargas.  Un generador de voltaje de referencia com√∫n, dos divisores que determinan los umbrales para la operaci√≥n, comparadores de flejes, dos interruptores de potencia.  La uni√≥n externa del dispositivo terminado se planifica de la siguiente manera. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/0m/77/ew/0m77ewzvozy52h6zr-fg7uaivg0.png"></div><br>  La clave primaria permanece encendida durante m√°s tiempo que la secundaria, por lo que el convertidor reductor se alimenta a trav√©s de ella.  Las cargas primarias est√°n conectadas directamente al convertidor.  El interruptor secundario conmuta las cargas secundarias que ya est√°n en el circuito de + 5v en la salida del inversor. <br><br><h3>  Lo que sali√≥ al final </h3><br>  Parece ser todo lo que se necesita, pero, como sucede a menudo, con el pensamiento de los detalles, aparecieron ideas de implementaciones alternativas.  En primer lugar, el circuito anal√≥gico conten√≠a una monta√±a decente de elementos discretos que proporcionan modos de operaci√≥n de comparaci√≥n, y en segundo lugar, se supone que los umbrales de disparo se establecen utilizando resistencias de compensaci√≥n, lo que complica la configuraci√≥n y crea la probabilidad de "alejarse" de las sacudidas y el tiempo.  Por lo tanto, al final, se decidi√≥ hacer hincapi√© en una implementaci√≥n digital, que result√≥ ser mucho m√°s simple tanto esquem√°ticamente como en configuraci√≥n, al tiempo que abri√≥ enormes oportunidades para mejorar el algoritmo de control y, lo m√°s importante, en este contexto, result√≥ ser un orden de magnitud m√°s econ√≥mico en t√©rminos de consumo actual. <br><br>  El controlador ATtiny13A simplemente solicit√≥ el coraz√≥n del dispositivo, que, adem√°s de su facilidad de uso y bajo costo, todav√≠a est√° disponible en un estuche DIP de tubo c√°lido y c√°lido para oldfag.  Inicialmente, las capacidades de incluso un controlador tan peque√±o parec√≠an redundantes en todos los frentes, desde la cantidad de entradas / salidas hasta la cantidad de programa y RAM, sin embargo, como saben, el apetito viene con una comida.  Como resultado, mirando hacia el futuro, dir√© que la versi√≥n final del caso result√≥ ser todas las conclusiones del microcircuito, y la memoria del software libre no dej√≥ m√°s de dos docenas de bytes. <br><br>  Para medir el voltaje de la red a bordo, el microcontrolador requiri√≥ solo una entrada, que est√° vinculada al ADC.  Dos resultados l√≥gicos m√°s fueron administrar a los consumidores.  En primer lugar, despu√©s de la transici√≥n mental final a lo "digital", hab√≠a un deseo de adaptar dos GPIO gratuitos al negocio, y la decisi√≥n no se hizo esperar.  Cuando, una vez m√°s, en el fr√≠o, el motor de arranque gir√≥ el motor con una l√°grima mal oculta, la presencia de un sensor de temperatura en el circuito y el algoritmo parec√≠an muy √∫tiles.  Como resultado, se us√≥ el segundo ADC para medir la temperatura.  Y para que el termistor consuma corriente solo cuando sea necesario, se decidi√≥ alimentarlo desde la √∫ltima salida l√≥gica restante. <br><br>  Como resultado, el diagrama del dispositivo ha adquirido esa forma final. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/jh/ct/dt/jhctdt_pol1pk6xum1wwn_n7jzo.png"></div><br>  Aqu√≠ vemos el m√≠nimo de detalles, y entre ellos nada est√° sujeto a ning√∫n tipo de "torsi√≥n".  Repasemos brevemente los puntos principales. <br><br>  Para la fuente de alimentaci√≥n, el controlador necesita un voltaje estable de 1.8 a 5.5 V, lo que significa que debe haber un estabilizador en el circuito que disminuya el voltaje de la red a bordo al nivel requerido.  Desde el punto de vista del ahorro de energ√≠a, puede parecer que hay un lugar para un convertidor reductor de pulsos exclusivamente, pero esto es solo a primera vista.  El hecho es que ATtiny13A, incluso en el modo de operaci√≥n con mayor consumo de energ√≠a (frecuencia 8 MHz, ejecuci√≥n de c√≥digo activo) no consume m√°s de 6 mA.  En este esquema, el controlador el 99% del tiempo est√° en modo de reposo profundo y tambi√©n funciona a una frecuencia de 1.2 MHz, lo que resulta en un consumo promedio de aproximadamente menos de 15 ¬µA.  Adem√°s, aproximadamente 80 ¬µA a las corrientes de base de los transistores de control (si ambas cargas est√°n encendidas).  Bueno, por una peque√±a fracci√≥n de segundo, se activa la potencia del termistor, que agrega aproximadamente 25 microamperios a la corriente promedio.  Y aqu√≠ est√° la respuesta a la pregunta "¬øVale la pena cargar un convertidor de pulso en aras de una carga con un consumo de no m√°s de 120 ¬µA?  Parece no tan sencillo.  Y si consideramos que estamos tratando con mediciones anal√≥gicas, definitivamente no vale la pena.  Por lo tanto, se utiliz√≥ el estabilizador lineal LP2950, ‚Äã‚Äãun an√°logo funcional del popular 78L05, pero mucho m√°s econ√≥mico.  Este convertidor puede proporcionar hasta 100 mA de corriente en la salida, mientras no consume m√°s de 75 ¬µA para el ser querido. <br><br>  El divisor de voltaje de la red a bordo, protegido por un diodo zener y un condensador, le permite medir voltajes de hasta 15 V. <br><br><blockquote>  S√© que ahora una ola de cr√≠ticas me golpear√° por tal decisi√≥n, pero seremos objetivos.  En primer lugar, no estoy desarrollando un sat√©lite, y en segundo lugar, no existe un factor √∫nico que pueda conducir al desastre.  La resistencia del hombro es alta, el diodo zener puede desviar mucha m√°s corriente que la que puede fluir a trav√©s del divisor, incluso en el escenario m√°s pesimista.  De los pulsos de alta frecuencia, cuando el diodo zener no tiene suficiente velocidad, el condensador C2 proteger√° (con una resistencia R7 crea un filtro de paso bajo con una frecuencia de corte de solo 7 Hz).  D1 y R6 aseguran en cierta medida que el esquema no se caiga entre s√≠.  Y uno no debe olvidarse de la linealidad, cualquier m√©todo de aislamiento galv√°nico en ese lugar har√° que el c√°lculo te√≥rico de las cantidades sea completamente irreal, tendremos que calibrar al menos el prototipo, pero no lo necesitamos. </blockquote><br>  La resistencia de salida del divisor es diez veces mayor que los 10 kOhm recomendados para la fuente de se√±al ADC, pero gracias al condensador C2 no hay problemas de medici√≥n. <br><br><blockquote>  En general, la impedancia de entrada de los circuitos ADC de los controladores AVR de acuerdo con la hoja de datos se declara al menos 100 megaohmios.  Sin embargo, sin embargo, la misma hoja de datos recomienda utilizar fuentes con resistencia interna de hasta 10 kOhm.  Por qu√©  El punto es el principio de funcionamiento de este ADC en s√≠.  El convertidor funciona seg√∫n el principio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aproximaci√≥n secuencial</a> , y su circuito de entrada es un filtro de paso bajo de una resistencia y un condensador.  La obtenci√≥n de una muestra de 10 bits es iterativa, y es necesario que el condensador se cargue al voltaje medido completo durante todo el tiempo de medici√≥n.  Si la impedancia de salida de la fuente es demasiado grande, el condensador continuar√° carg√°ndose directamente durante el proceso de conversi√≥n y el resultado ser√° inexacto.  En nuestro caso, la capacitancia C2 es m√°s de siete mil veces la capacidad del filtro ADC, lo que significa que cuando la carga se redistribuye entre estos condensadores cuando se encienden en el momento de la medici√≥n, el voltaje de entrada disminuir√° en no m√°s de 1/7000, que es siete veces menos que la precisi√≥n m√°xima de un ADC de 10 bits.  Es cierto que debe tener en cuenta que este truco solo funciona para mediciones individuales con pausas significativas entre ellas, por lo que no debe "mejorar" el programa de control agregando un ciclo para varias mediciones consecutivas con un promedio del resultado. </blockquote><br>  El divisor con un termistor debido a la presencia de una fuente de energ√≠a controlada se construye utilizando las clasificaciones recomendadas.  NTCLE100E3 se usa como sensor, pero no hay restricciones, puede usar cualquier termistor de aproximadamente la misma clasificaci√≥n, lo principal es hacer las correcciones correspondientes a su caracter√≠stica en las constantes del c√≥digo fuente para que el voltaje del divisor se convierta al valor de temperatura correcto. <br><br>  Como teclas de control, los MOSFET de canal P de potencia de cualquier tipo se utilizan con una resistencia de canal abierto aceptable y un voltaje de fuente de drenaje m√°ximo de al menos 30 voltios.  El circuito anterior usa diferentes transistores.  Esto se hace porque tienen que cambiar diferentes voltajes y el tipo de cada uno de ellos fue seleccionado para condiciones de trabajo espec√≠ficas.  El transistor superior debe ser de m√°s alto voltaje, y el inferior debe, si es posible, tener una resistencia m√≠nima de canal abierto.  Pero, repito, esta decisi√≥n est√° dictada por el circuito de conmutaci√≥n del dispositivo (ver arriba), con otra inclusi√≥n, los requisitos para el transistor inferior pueden ser diferentes. <br><br>  Para controlar los interruptores de alimentaci√≥n, se usa un par de transistores bipolares id√©nticos.  Al principio puede parecer que estos transistores son superfluos, pero aqu√≠ no es tan simple.  Los transistores de efecto de campo con una puerta aislada comienzan a abrirse no desde cualquier voltaje de la polaridad requerida en la puerta, sino solo despu√©s de alcanzar un cierto nivel de umbral, que aparece en las hojas de datos bajo el nombre "voltaje de umbral de puerta a fuente" y generalmente es igual a 2..4 V. Ahora vamos a solo cuenta.  El circuito de salida del controlador puede formar dos niveles l√≥gicos: "0" l√≥gico con un voltaje que tiende a cero;  y l√≥gico "1" con voltaje que tiende a suministrar.  Cuando se alimenta con 5 voltios, estos ser√°n voltajes alrededor de 0 y 5 V, respectivamente.  Como resultado, al cambiar una fuente de 12 voltios, un "0" l√≥gico en la puerta crear√° una diferencia de voltaje de la puerta de la fuente de 12 - 0 = 12 voltios, el transistor de potencia est√° abierto.  Todo parece ser normal, pero el "1" l√≥gico con su voltaje de 5 V crear√° un voltaje entre 12 - 5 = 7 voltios entre la fuente y la puerta, y el transistor de potencia seguir√° abierto.  Por lo tanto, la se√±al de control de cinco voltios no puede controlar la tecla, que conmuta el voltaje por encima de 7..9 voltios.  Por lo tanto, los transistores bipolares de control en realidad no funcionan tanto con las teclas de se√±al como con los amplificadores que elevan el voltaje de control de 5 voltios al voltaje de la red a bordo. <br><br>  La resistencia en el circuito base de cada uno de los transistores de control simplemente limita la corriente de las salidas del controlador a un nivel suficiente para controlarlo.  Sus clasificaciones se pueden reducir dos o tres veces sin consecuencias para el funcionamiento del circuito. <br><br><blockquote>  Es f√°cil ver que los transistores de control no estaban en el circuito anal√≥gico basado en el LM393N.  La cuesti√≥n es que la etapa de salida del comparador seleccionado se construye de acuerdo con el circuito de colector abierto, es decir, su salida es simplemente la salida del colector del transistor terminal.  Este principio de construcci√≥n requiere que se cuelguen piezas adicionales en el chip para crear la carga de la etapa de salida, pero, por otro lado, hace que el chip sea muy flexible.  Un colector abierto permite que el comparador controle cualquier fuente de corriente aceptable, y no solo compatible con la que proporciona energ√≠a al comparador mismo. </blockquote><br>  Debo decir que limitar el voltaje umbral de un MOSFET de potencia funciona no solo hacia voltajes altos, como se mencion√≥ anteriormente, sino tambi√©n hacia los bajos.  Despu√©s de todo, si el voltaje de apertura m√≠nimo del transistor es, digamos, 4 voltios, cuando se cambia la fuente de 3.3 V, incluso conectar la puerta a tierra no crear√° la diferencia de voltaje deseada entre la fuente y la puerta, y el transistor permanecer√° cerrado.  Entonces, 5 voltios es, quiz√°s, el voltaje m√≠nimo que los transistores seleccionados pueden conmutar de manera confiable. <br><br><h3>  Personalizaci√≥n </h3><br>  Configurar un dispositivo es una conversaci√≥n separada.  Por un lado, no hay un solo elemento de sintonizaci√≥n en el circuito, pero por el otro, estamos lidiando con la medici√≥n de voltajes con una precisi√≥n no inferior a 0.1 V. ¬øC√≥mo vincular todo esto?  Hay dos formas  El primero es usar resistencias R6, R7 y R8 con una tolerancia de al menos 1% (o mejor 0.1%).  El segundo implica el uso de resistencias convencionales con medici√≥n de sus resistencias reales y correcci√≥n de coeficientes en el c√≥digo fuente del programa. <br><br>  El primer m√©todo es bueno para la producci√≥n en masa, pero es mucho m√°s atractivo para nosotros no molestarnos en la b√∫squeda de los valores de alta precisi√≥n necesarios, as√≠ que vamos a la segunda.  La resistencia se puede medir con un mult√≠metro ordinario, su precisi√≥n aqu√≠ es suficiente.  Otro objeto de medici√≥n ser√° el voltaje del estabilizador que alimenta el circuito.  El ADC del controlador puede funcionar en diferentes modos, pero por varias razones es m√°s conveniente para nosotros usar uno en el que el resultado de la conversi√≥n digital se cuente en relaci√≥n con el voltaje de suministro.  Por eso es importante saberlo con la mayor precisi√≥n posible. <br><br>  El c√°lculo es extremadamente simple y consiste en calcular el coeficiente de divisi√≥n del divisor resistivo y la proporci√≥n de la traducci√≥n del resultado en LSB durante la conversi√≥n de anal√≥gico a digital. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/s-/-q/vf/s--qvfm_z0imo_xg5r7tnskhze0.png"></div><br>  Ux es el voltaje de entrada del divisor; <br>  Ru es la resistencia del brazo superior del divisor (al que se suministra Ux); <br>  Rd es la resistencia del brazo inferior del divisor (que est√° conectado al suelo); <br>  Uref - voltaje de referencia del ADC (es decir, voltaje de alimentaci√≥n del controlador); <br>  1024 - el n√∫mero de valores discretos en la salida de un ADC de 10 bits; <br>  LSB es el valor num√©rico obtenido por el programa del ADC. <br><br>  Comencemos con el divisor de voltaje R6-R7.          .     5.0 .      13.5 : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/nr/ic/a2/nrica2q5vtygw-ck3mstvspkm4y.png"></div><br>      ,      ,       ,    . <br><br>   ,  ,     ,      Ru,  Ux    Uref.     : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zv/t7/qi/zvt7qi05g21ecwvaquqnjdbhjli.png"></div><br>     R8  ,  R9    NTCLE100E3   0‚Å∞C: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/j5/gp/_k/j5gp_kzjcx3buv0ayejxoazlwcu.png"></div><br><blockquote>   ,        R8  R9      ,  , ,  . .       ,    R9   ,        0.5 m,       .   ,            ,   0.01 . </blockquote><br>         ,  , ,   .     ,                         .    -     ,        . <br><br> ,         ,      ,           . <br><br><h3>  Firmware </h3><br>     AtmelStudio ( gcc-avr 5.4.0)   <a href=""></a> ,     <a href="">hex</a> .      ,    . <br><br><div class="spoiler"> <b class="spoiler_title"></b> <div class="spoiler_text"><pre><code class="cpp">//#define F_CPU 1200000UL //    

#include &lt;avr/io.h&gt;
#include &lt;avr/wdt.h&gt;
#include &lt;avr/sleep.h&gt;
#include &lt;avr/interrupt.h&gt; 
#include &lt;util/delay.h&gt;

//#define DBG

#define TEMPERATURE_OVERHEAT 753 // LSB-  +50‚Å∞C
#define TEMPERATURE_GIST     8   //    ( LSB)     
#define VOLTAGE_GIST         3   //    ( LSB)     

#define INTERVAL             WDTO_1S //     (1 )
#ifndef DBG
#define CELL_CHANGE_TIMEOUT  90  //      (  INTERVAL,   254)
#define OVERHEAT_TIMEOUT     300 //      "" (  INTERVAL)
#else
#define CELL_CHANGE_TIMEOUT  2
#define OVERHEAT_TIMEOUT     3
#endif

typedef unsigned char bool; //    
#define true  0 == 0        //     
#define false 0 != 0        //      

typedef enum {st_none = 0b00, st_primary = 0b01, st_secondary = 0b10, st_both = 0b11} t_states; //    
                                                                                                //       ,      
typedef enum {adc_temperature, adc_voltage} t_measure;                                          //   
typedef enum {move_null, move_up, move_down} t_movement;                                        //      

//    
struct t_coordidates {
  signed char row, col;
};

//       
struct t_correction {
  t_movement voltage, temperature;
};

#define CELLS_ROWS 3 //      ( )
#define CELLS_COLS 5 //      ( )

//  
const t_states CELLS[CELLS_ROWS][CELLS_COLS] = {
  {st_both, st_both,    st_both,    st_primary, st_none},
  {st_both, st_both,    st_primary, st_none,    st_none},
  {st_both, st_primary, st_none,    st_none,    st_none}
};

// LSB- ,      
const unsigned int ROWS_EDGES[CELLS_ROWS - 1] = {
  241, // 0‚Å∞C
  157  // -10‚Å∞C
};

// LSB- ,      
const unsigned int COLS_EDGES[CELLS_COLS - 1] = {
  864, // 13.5V
  800, // 12.5V
  787, // 12.3V
  768  // 12.0V
};

unsigned int overheat_rest_time = 0; //       ""
unsigned char cell_change_time  = 0; //      
unsigned char no_cur_cell_time  = 0; //  ,            

#define NULL_CELL (struct t_coordidates){.col = -1, .row = -1} // ,   
#define NULL_CORRECTION (struct t_correction){.voltage = move_null, .temperature = move_null} // ,   

struct t_correction moved_from = NULL_CORRECTION; //       
struct t_coordidates cur_cell  = NULL_CELL,       //      
                     next_cell = NULL_CELL;       //  -   

//  
static void init_pins() {
  DDRB |= (1 &lt;&lt; PB0) | (1 &lt;&lt; PB1) | (1 &lt;&lt; PB3);     //   2 (PB3), 5 (PB0)  6 (PB1)  
  PORTB &amp;= ~(1 &lt;&lt; PB0) &amp; ~(1 &lt;&lt; PB1) &amp; ~(1 &lt;&lt; PB3); //      2 (PB3), 5 (PB0)  6 (PB1)
}

// /    
static void toggle_thermal_sensor(bool state) {
  if(state) {
    PORTB |= (1 &lt;&lt; PB1);  //  state ,      6 (PB1)

    _delay_ms(5); //    
  } else {
    PORTB &amp;= ~(1 &lt;&lt; PB1); //  state  ,      6 (PB1)
  }
}

//   
static unsigned int measure_adc(t_measure measure) {
  if(measure == adc_temperature) {
    toggle_thermal_sensor(true); //    ,    

    ADMUX = 0b10; //      -   3 (PB4)
  } else {
    ADMUX = 0b01; //      -   7 (PB2)
  }

  ADCSRA = (1 &lt;&lt; ADPS2) | //       = 16 (75 )
           (1 &lt;&lt; ADIE) |  //    
           (1 &lt;&lt; ADEN);   //  

  set_sleep_mode(SLEEP_MODE_ADC); //   "" 
  do {
    sleep_cpu(); //      ,      ,   
  } while(ADCSRA &amp; (1 &lt;&lt; ADSC)); //        ,  

  ADCSRA = 0; //  

  toggle_thermal_sensor(false); //     

  return ADC; //  10-  
}

//    watchdog
static void init_interrupts(void) {
  sleep_enable(); //   

  WDTCR = (1 &lt;&lt; WDCE) | (1 &lt;&lt; WDE); //  watchdog
  WDTCR = (1 &lt;&lt; WDTIE) | INTERVAL; // watchdog      ,  1 

  sei(); //  
}

//          
static void toggle_loads(t_states states) {
  unsigned char port = PORTB &amp; ~((1 &lt;&lt; PB3) | (1 &lt;&lt; PB0)),     //           ,   
                bits = (((states &amp; st_primary) &gt;&gt; 0) &lt;&lt; PB3) | //        
                       (((states &amp; st_secondary) &gt;&gt; 1) &lt;&lt; PB0);

  PORTB = port | bits; //    
}

//     t_coordidates
static bool cells_equal(struct t_coordidates cell1, struct t_coordidates cell2) {
  return cell1.row == cell2.row &amp;&amp; cell1.col == cell2.col;
}

//          LSB- 
static signed char get_cell_row(unsigned int temperature) {
  signed char row = 0;

  while(row &lt; CELLS_ROWS - 1) {          //          
    if(temperature &gt;= ROWS_EDGES[row]) { //  temperature     ,    
      return row;
    } else {
      ++row;
    }
  }

  return CELLS_ROWS - 1; //  temperature         ,       
}

//          LSB- 
static signed char get_cell_col(unsigned int voltage) {
  signed char col = 0;

  while(col &lt; CELLS_COLS - 1) {      //          
    if(voltage &gt;= COLS_EDGES[col]) { //  voltage     ,    
      return col;
    } else {
      ++col;
    }
  }

  return CELLS_COLS - 1; //  voltage         ,       
}

//    ,       
static void get_row_edges(signed char row, unsigned int *upper, unsigned int *lower) {
  *upper = row &gt; 0 ? ROWS_EDGES[row - 1] : 0xffff - TEMPERATURE_GIST; //       ,    
  *lower = row &lt; CELLS_ROWS - 1 ? ROWS_EDGES[row] : TEMPERATURE_GIST; //       ,    
}

//    ,       
static void get_col_edges(signed char col, unsigned int *upper, unsigned int *lower) {
  *upper = col &gt; 0 ? COLS_EDGES[col - 1] : 0xffff - VOLTAGE_GIST; //      (  )  ,    
  *lower = col &lt; CELLS_COLS - 1 ? COLS_EDGES[col] : VOLTAGE_GIST; //      (  )  ,    
}

//    -              
static void gisteresis_correction(struct t_coordidates* new_cell, unsigned int temperature, unsigned int voltage) {
  unsigned int upper_edge, lower_edge;

  get_row_edges(cur_cell.row, &amp;upper_edge, &amp;lower_edge); //    
  if(new_cell-&gt;row &gt; cur_cell.row &amp;&amp; moved_from.temperature == move_up &amp;&amp; temperature &gt;= lower_edge - TEMPERATURE_GIST) {
    --new_cell-&gt;row; //   -   ,    ,        ,    
  }

  if(new_cell-&gt;row &lt; cur_cell.row &amp;&amp; moved_from.temperature == move_down &amp;&amp; temperature &lt;= upper_edge + TEMPERATURE_GIST) {
    ++new_cell-&gt;row; //   -   ,    ,        ,    
  }

  get_col_edges(cur_cell.col, &amp;upper_edge, &amp;lower_edge); //    
  if(new_cell-&gt;col &gt; cur_cell.col &amp;&amp; moved_from.voltage == move_up &amp;&amp; voltage &gt;= lower_edge - VOLTAGE_GIST) {
    --new_cell-&gt;col; //   -   ,     (  ),        ,    
  }

  if(new_cell-&gt;col &lt; cur_cell.col &amp;&amp; moved_from.voltage == move_down &amp;&amp; voltage &lt;= upper_edge + VOLTAGE_GIST) {
    ++new_cell-&gt;col; //   -   ,     (  ),        ,    
  }
}

//       stdlib::abs()
 static unsigned char absolute(signed char value) {
  return value &gt;= 0 ? value : -value;
}

//      -
static void calc_movement(struct t_coordidates new_cell) {
  moved_from = NULL_CORRECTION;                                                   // -   
  if(!cells_equal(new_cell, NULL_CELL) &amp;&amp; !cells_equal(cur_cell, NULL_CELL)) {    //         ,  -
    if(absolute(new_cell.row - cur_cell.row) == 1) {                              //      
      moved_from.temperature = new_cell.row &lt; cur_cell.row ? move_up : move_down; //   
    }

    if(absolute(new_cell.col - cur_cell.col) == 1) {                              //      
      moved_from.voltage = new_cell.col &lt; cur_cell.col ? move_up : move_down;     //   
    }
  }
}

//   -
static void set_next_cell(struct t_coordidates cell) {
  next_cell = cell;
  cell_change_time = 0; //    
}

//    
static void set_cur_cell(struct t_coordidates cell) {
  cur_cell = cell;
  no_cur_cell_time = 0; //        
  set_next_cell(NULL_CELL); //  -
}

// ,      
static void change_cell(struct t_coordidates new_cell) {
  if(cells_equal(new_cell, NULL_CELL)) { //         
    toggle_loads(st_none);
  } else {
    toggle_loads(CELLS[new_cell.row][new_cell.col]); //         
  }

  calc_movement(new_cell); //     
  set_cur_cell(new_cell);  //   
}

//  
static void main_proc(void) {
  unsigned int temperature, voltage; // 10- LSB-    
  struct t_coordidates cell;         //      -

  if(overheat_rest_time) { //      ""  ,          
    --overheat_rest_time;
  } else {
    temperature = measure_adc(adc_temperature); //  
    if(temperature &gt;= TEMPERATURE_OVERHEAT) {   //      +50C,  :
      change_cell(NULL_CELL);                   //      (   )
      overheat_rest_time = OVERHEAT_TIMEOUT;    //        
    } else {
      voltage = measure_adc(adc_voltage);   //  

      cell.col = get_cell_col(voltage);     //    -  
      cell.row = get_cell_row(temperature); //    -  

      if(cells_equal(cur_cell, NULL_CELL)) { //        ,         
        change_cell(cell);
      } else {
        gisteresis_correction(&amp;cell, temperature, voltage); //              

        if(cells_equal(cell, cur_cell)) { //   -   ,      
          set_next_cell(NULL_CELL);
          no_cur_cell_time = 0; //    ,  
        } else {
          if(no_cur_cell_time++ &gt; CELL_CHANGE_TIMEOUT) { //    CELL_CHANGE_TIMEOUT+1        cur_cell,      
            change_cell(cell); //    ,     
          } else {
            if(cells_equal(next_cell, NULL_CELL) || !cells_equal(next_cell, cell)) { //  -       ,   
              set_next_cell(cell);
            } else {
              if(++cell_change_time &gt;= CELL_CHANGE_TIMEOUT) { //   ,       , ,    
                change_cell(cell);
              }
            }
          }
        }
      }
    }
  }
}

//    watchdog
ISR(WDT_vect) {
  WDTCR |= (1 &lt;&lt; WDTIE); //    watchdog   ""    
}

//    ,        ADSC  measure_adc()
EMPTY_INTERRUPT(ADC_vect);

//  
int main(void) {
  init_pins();       //  
  init_interrupts(); //    watchdog
	
  while(true) {                          //  ,       
    set_sleep_mode(SLEEP_MODE_PWR_DOWN); //        
    sleep_cpu();                         //        watchdog 

    main_proc();                         //          
  }
}
</code></pre><br>
<br>
    : L:0x6A, H:0xFF.<br>
</div></div><br>
   .    ,     ‚Äì  ,    ‚Äì .            ,    .     :<br>
<br>
<a href=""><div style="text-align:center;"><img src="https://habrastorage.org/webt/0j/wx/ez/0jwxezo197qadbln8crg05zwlhq.png"></div></a><br>
          ,      .<br>
<br>
,           .        ,        .   ,        ,       .<br>
<br>
<blockquote>,  -      ,       .                ,    ,      . , - ,  ,    ,   ,                .  ..  -   ,           ,      .    .         .      ,      ,     .</blockquote><br>
        ,                  .  ,  , ,  12.5   ,      ,      12.4 .                . ,             .<br>
<br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/_o/d5/9e/_od59e61ylpgaqhsrwwlwsro3dw.png"></div><br>
<div style="text-align:center;"><img src="https://habrastorage.org/webt/lo/bu/uu/lobuuuqhkbahdsyinpg5hhokeyw.png"></div><br>
 ,               , ,   .            ,    .           ¬´¬ª 8-9 .<br>
<br>
<blockquote>         ,     .        ¬´¬ª    ,          .   ,      ,    ¬´¬ª ,     -    (,   ,   ,    ,  ,     -  ).</blockquote><br>
      ,        +50‚Å∞C  ,     .        ,  ,  ,       .                 .<br>
<br>
  ¬´¬ª,   ,    (watchdog).                    .<br>
<br>
<blockquote> ,          ‚Äì  .       . Watchdog   ,  ,     ,     .  ,    ,         ,     watchdog.   ,      ,        .</blockquote><br>
           .       1006 ,      -  .<br>
<br>
<blockquote>,       ,  .   ,        O2,   ,       Os  ,      1024 .             -,      .</blockquote><br>
                       .<br>
<br>
<div class="spoiler"><b class="spoiler_title">    </b><div class="spoiler_text"><div style="text-align:center;"><img src="https://habrastorage.org/webt/1b/gg/nv/1bggnvmw6h-x7nab-h9ljuag1lq.png"></div><br>
     Eagle  <a href=""></a>.<br>
</div></div></div>
      
    </div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/446956/">https://habr.com/ru/post/446956/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../446942/index.html">Servidor, ¬øme oyes? Ataque BROP en el ejemplo de la tarea NeoQUEST-2019</a></li>
<li><a href="../446944/index.html">¬øPor qu√© invertir en empresas no rentables?</a></li>
<li><a href="../446948/index.html">C√≥mo el troyano Gustuff de Android elimina la crema (fiat y cripto) de sus cuentas</a></li>
<li><a href="../446950/index.html">El 76% de los fabricantes no tienen experiencia en la implementaci√≥n de aditivos. ¬øPor qu√© es bueno?</a></li>
<li><a href="../446952/index.html">Crea histogramas animados usando R</a></li>
<li><a href="../446958/index.html">Complicado perl quine</a></li>
<li><a href="../446960/index.html">La casa que construy√≥ Jack</a></li>
<li><a href="../446962/index.html">Phishing y sin qu√≠mica</a></li>
<li><a href="../446964/index.html">Integraci√≥n con SAP ERP. Implementaci√≥n de un comprobador de precios m√≥vil en una tienda.</a></li>
<li><a href="../446966/index.html">Noticias de la semana: principales eventos en inform√°tica y ciencia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>