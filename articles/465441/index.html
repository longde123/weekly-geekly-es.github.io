<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üî∑ ü§£ üõåüèæ LuaVela: implementaci√≥n de Lua 5.1 basada en LuaJIT 2.0 üë®üèæ‚Äçü§ù‚Äçüë®üèª üì∑ üíÖüèΩ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hace alg√∫n tiempo, anunciamos un lanzamiento p√∫blico y abrimos bajo la licencia MIT el c√≥digo fuente de LuaVela , una implementaci√≥n de Lua 5.1, basad...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>LuaVela: implementaci√≥n de Lua 5.1 basada en LuaJIT 2.0</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/iponweb/blog/465441/">  Hace alg√∫n tiempo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">anunciamos un</a> lanzamiento p√∫blico y abrimos bajo la licencia MIT el c√≥digo fuente de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">LuaVela</a> , una implementaci√≥n de Lua 5.1, basada en LuaJIT 2.0.  Comenzamos a trabajar en √©l en 2015 y, a principios de 2017, se utiliz√≥ en m√°s del 95% de los proyectos de la compa√±√≠a.  Ahora quiero mirar hacia atr√°s en el camino recorrido.  ¬øQu√© circunstancias nos llevaron a desarrollar nuestra propia implementaci√≥n de un lenguaje de programaci√≥n?  ¬øQu√© problemas encontramos y c√≥mo los resolvimos?  ¬øEn qu√© se diferencia LuaVela de otras horquillas LuaJIT? <br><a name="habracut"></a><br><h1>  Antecedentes </h1><br>  Esta secci√≥n se basa en nuestro <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">informe</a> sobre HighLoad ++.  Comenzamos a usar activamente Lua para escribir la l√≥gica comercial de nuestros productos en 2008.  Al principio fue Lua de vainilla, y desde 2009 - LuaJIT.  El protocolo RTB tiene un marco estricto para procesar la solicitud, por lo que cambiar a una implementaci√≥n m√°s r√°pida del lenguaje fue una soluci√≥n l√≥gica y, desde alg√∫n punto, necesaria. <br><br>  Con el tiempo, nos dimos cuenta de que hab√≠a ciertas limitaciones en la arquitectura de LuaJIT.  Lo m√°s importante para nosotros fue que LuaJIT 2.0 utiliza estrictamente punteros de 32 bits.  Esto nos llev√≥ a una situaci√≥n en la que la ejecuci√≥n en Linux de 64 bits limit√≥ el tama√±o del espacio de direcciones virtuales de la memoria de proceso a un gigabyte (en versiones posteriores del kernel de Linux, este l√≠mite se elev√≥ a dos gigabytes): <br><br><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* MAP_32BIT    4  x86-64: */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *ptr = mmap((<span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *)MMAP_REGION_START, size, MMAP_PROT, MAP_32BIT | MMAP_FLAGS, <span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre> <br>  Esta limitaci√≥n se convirti√≥ en un gran problema: en 2015, 1-2 gigabytes de memoria dejaron de ser suficientes para que muchos proyectos cargaran los datos con los que funcionaba la l√≥gica.  Vale la pena se√±alar que cada instancia de la m√°quina virtual Lua es de un solo subproceso y no sabe c√≥mo compartir datos con otras instancias; esto significa que, en la pr√°ctica, cada m√°quina virtual podr√≠a reclamar un tama√±o de memoria que no exceda los 2 GB / n, donde n es el n√∫mero de flujos de trabajo de nuestro servidor aplicaciones. <br><br>  Revisamos varias soluciones al problema: redujimos el n√∫mero de subprocesos en nuestro servidor de aplicaciones, intentamos organizar el acceso a los datos a trav√©s de LuaJIT FFI, probamos la transici√≥n a LuaJIT 2.1.  Desafortunadamente, todas estas opciones eran econ√≥micamente desventajosas o no escalaban bien a largo plazo.  Lo √∫nico que nos quedaba era arriesgarnos y bifurcar a LuaJIT.  En este momento, tomamos decisiones que determinaron en gran medida el destino del proyecto. <br><br>  Primero, inmediatamente decidimos no hacer ning√∫n cambio en la sintaxis y la sem√°ntica del lenguaje, enfoc√°ndonos en eliminar las restricciones arquitect√≥nicas de LuaJIT, que resultaron ser un problema para la compa√±√≠a.  Por supuesto, a medida que el proyecto se desarroll√≥, comenzamos a agregar extensiones (discutiremos esto a continuaci√≥n), pero aislamos todas las API nuevas de la biblioteca de idiomas est√°ndar. <br><br>  Adem√°s, abandonamos la plataforma cruzada en favor de admitir solo Linux x86-64, nuestra √∫nica plataforma de producci√≥n.  Desafortunadamente, no ten√≠amos suficientes recursos para probar adecuadamente la cantidad gigantesca de cambios que √≠bamos a hacer a la plataforma. <br><br><h1>  Un vistazo r√°pido debajo del cap√≥ de la plataforma </h1><br>  Veamos de d√≥nde proviene la restricci√≥n en el tama√±o de los punteros.  Para empezar, el tipo de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">n√∫mero</a> en Lua 5.1 es (con algunas advertencias menores) el tipo C doble, que a su vez corresponde al tipo de precisi√≥n doble definido por el est√°ndar IEEE 754. En la codificaci√≥n de este tipo de 64 bits, el rango de valores se resalta para la presentaci√≥n NaN.  En particular, c√≥mo cualquier valor en el rango [0xFFF8000000000000;  0xFFFFFFFFFFFFFFFF]. <br><br>  Por lo tanto, podemos empaquetar en un solo valor de 64 bits, ya sea un n√∫mero de doble precisi√≥n "real", o alguna entidad, que desde el punto de vista del tipo doble se interpretar√° como NaN, y desde el punto de vista de nuestra plataforma ser√° algo m√°s significativo, por ejemplo, por el tipo de objeto (alto 32 bits) y un puntero a su contenido (bajo 32 bits): <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> TValue { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> n; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *payload; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> type; } o; };</code> </pre><br>  Esta t√©cnica a veces se llama etiquetado NaN (o boxeo NaN), y TValue b√°sicamente describe c√≥mo LuaJIT representa valores variables en Lua.  TValue tambi√©n tiene una tercera hip√≥stasis utilizada para almacenar un puntero a una funci√≥n e informaci√≥n para rebobinar la pila Lua, es decir, en el an√°lisis final, la estructura de datos se ve as√≠: <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> TValue { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> n; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *payload; <span class="hljs-keyword"><span class="hljs-keyword">uint32_t</span></span> type; } o; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frame</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *func; <span class="hljs-keyword"><span class="hljs-keyword">uintptr_t</span></span> link; } f; };</code> </pre><br>  El campo frame.link en la definici√≥n anterior es del tipo uintptr_t, porque en algunos casos almacena un puntero y en otros es un n√∫mero entero.  El resultado es una representaci√≥n muy compacta de la pila de la m√°quina virtual; de hecho, es una matriz TValue, y cada elemento de la matriz se interpreta situacionalmente como un n√∫mero, luego como un puntero escrito a un objeto o como datos sobre el marco de la pila Lua. <br><br>  Veamos un ejemplo.  Imagine que comenzamos con LuaJIT este c√≥digo Lua y establecimos un punto de interrupci√≥n dentro de la funci√≥n de impresi√≥n: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x)</span></span></span></span> <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"Hello, "</span></span> .. x) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bar</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(a, b)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> n = <span class="hljs-built_in"><span class="hljs-built_in">math</span></span>.<span class="hljs-built_in"><span class="hljs-built_in">pi</span></span> foo(b) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> bar({}, <span class="hljs-string"><span class="hljs-string">"Lua"</span></span>)</code> </pre><br>  La pila Lua en este punto se ver√° as√≠: <br><br><img src="https://habrastorage.org/webt/1n/av/hn/1navhnm8vbz-inawirkvewxppme.png" alt="Lua stack usando LuaJIT 2.0"><br><br>  Y todo estar√≠a bien, pero esta t√©cnica comienza a fallar tan pronto como intentamos comenzar en x86-64.  Si ejecutamos en modo de compatibilidad para aplicaciones de 32 bits, descansamos en contra de la restricci√≥n mmap ya mencionada anteriormente.  Y los punteros de 64 bits no funcionar√°n en absoluto.  Que hacer  Para solucionar el problema tuve que: <br><br><ol><li>  Extienda TValue de 64 a 128 bits: de esta manera obtenemos un vac√≠o * honesto * en una plataforma de 64 bits. </li><li>  Corrija el c√≥digo de la m√°quina virtual en consecuencia. </li><li>  Realice cambios en el compilador JIT. </li></ol><br>  El volumen total de cambios result√≥ ser muy significativo y nos alej√≥ bastante del LuaJIT original.  Vale la pena se√±alar que la extensi√≥n TValue no es la √∫nica forma de resolver el problema.  En LuaJIT 2.1, fuimos al rev√©s implementando el modo LJ_GC64.  Peter Cawley, quien hizo una enorme contribuci√≥n al desarrollo de este modo de operaci√≥n, ley√≥ sobre esto en una reuni√≥n en Londres.  Bueno, en el caso de LuaVela, la pila para el mismo ejemplo se ve as√≠: <br><br><img src="https://habrastorage.org/webt/ar/rj/yv/arrjyvsnfyixhd8haufn95nhgu8.png" alt="Lua stack cuando se usa LuaVela"><br><br><h1>  Primeros √©xitos y estabilizaci√≥n del proyecto. </h1><br>  Despu√©s de meses de desarrollo activo, es hora de probar LuaVela en la batalla.  Como experimental, elegimos los proyectos m√°s problem√°ticos en t√©rminos de consumo de memoria: la cantidad de datos con los que tuvieron que trabajar, obviamente excedi√≥ 1 gigabyte, por lo que se vieron obligados a usar varias soluciones.  Los primeros resultados fueron alentadores: LuaVela fue estable y mostr√≥ un mejor rendimiento en comparaci√≥n con la configuraci√≥n de LuaJIT utilizada en estos mismos proyectos. <br><br>  Al mismo tiempo, surgi√≥ la cuesti√≥n de las pruebas.  Afortunadamente, no tuvimos que comenzar desde cero, ya que desde el primer d√≠a de desarrollo, adem√°s de los servidores provisionales, ten√≠amos a nuestra disposici√≥n: <br><br><ul><li>  Pruebas funcionales y de integraci√≥n de un servidor de aplicaciones que ejecuta la l√≥gica empresarial de todos los proyectos de la empresa. </li><li>  Pruebas de proyectos individuales. </li></ul><br>  Como se ha demostrado en la pr√°ctica, estos recursos fueron suficientes para depurar y llevar el proyecto a un estado estable m√≠nimo (hicieron un ensamblaje de desarrollo, implementado para la puesta en escena, funciona y no se bloquea).  Por otro lado, tales pruebas a trav√©s de otros proyectos fueron completamente inadecuadas a largo plazo: un proyecto de tal nivel de complejidad como la implementaci√≥n de un lenguaje de programaci√≥n no puede tener sus propias pruebas.  Adem√°s, la falta de pruebas directamente en el proyecto complicaba puramente t√©cnicamente la b√∫squeda y correcci√≥n de errores. <br><br>  En un mundo ideal, quer√≠amos probar no solo nuestra implementaci√≥n, sino tambi√©n tener un conjunto de pruebas que nos permitieran validarla contra la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">sem√°ntica del lenguaje</a> .  Lamentablemente, nos esperaba algo de decepci√≥n en este asunto.  A pesar del hecho de que la comunidad Lua voluntariamente crea tenedores de implementaciones existentes, hasta hace poco, faltaba un conjunto similar de pruebas de validaci√≥n.  La situaci√≥n mejor√≥ cuando, a finales de 2018, Fran√ßois Perrad <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">anunci√≥</a> el proyecto lua-Harness. <br><br>  Al final, cerramos el problema de las pruebas integrando las suites de pruebas m√°s completas y representativas del ecosistema Lua en nuestro repositorio: <br><br><ul><li>  <a href="">Pruebas</a> escritas por los creadores del lenguaje para su implementaci√≥n de Lua 5.1. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Pruebas</a> proporcionadas por la comunidad por el autor de LuaJIT Mike Pall. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">arn√©s lua</a> </li><li>  Un subconjunto de las pruebas del proyecto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">MAD</a> desarrollado por el CERN. </li><li>  Dos conjuntos de pruebas que hemos creado en IPONWEB y que seguimos reponiendo hasta ahora: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">uno</a> para pruebas funcionales de la plataforma, el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">otro</a> usando el marco <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">cmocka</a> para probar la API de C y todo lo que carece de pruebas en el nivel de c√≥digo Lua. </li></ul><br>  La introducci√≥n de cada lote de pruebas nos permiti√≥ detectar y corregir 2-3 errores cr√≠ticos, por lo que es obvio que nuestros esfuerzos dieron resultado.  Aunque el tema de probar los tiempos de ejecuci√≥n y los compiladores del lenguaje (tanto est√°ticos como din√°micos) es realmente ilimitado, creemos que hemos establecido una base bastante s√≥lida para el desarrollo estable del proyecto.  Hablamos sobre los problemas de probar nuestra propia implementaci√≥n de Lua (incluidos temas como trabajar con bancos de prueba y depuraci√≥n post mortem) dos veces, en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Lua en Mosc√∫ 2017</a> y en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HighLoad ++ 2018</a> : todos los que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">est√©n</a> interesados ‚Äã‚Äãen los detalles pueden ver un video de estos informes.  Bueno, mira el directorio de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">pruebas</a> en nuestro repositorio, por supuesto. <br><br><h1>  Nuevas caracter√≠sticas </h1><br>  Por lo tanto, ten√≠amos a nuestra disposici√≥n una implementaci√≥n estable de Lua 5.1 para Linux x86-64, desarrollada por las fuerzas de un peque√±o equipo, que gradualmente "domin√≥" la herencia de LuaJIT y la experiencia acumulada.  En tales condiciones, el deseo de expandir la plataforma y agregar funciones que no est√°n en Vanilla Lua ni en LuaJIT, pero que nos ayudar√≠an a resolver otros problemas apremiantes, se volvi√≥ bastante natural. <br><br>  Se proporciona una descripci√≥n detallada de todas las extensiones en la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">documentaci√≥n</a> en formato RST (use cmake. &amp;&amp; make docs para crear una copia local en formato HTML).  Puede encontrar una descripci√≥n completa de las extensiones de la API de Lua <a href="">en este enlace</a> , y la API de C <a href="">en este</a> .  Desafortunadamente, en un art√≠culo de revisi√≥n es imposible hablar de todo, as√≠ que aqu√≠ hay una lista de las funciones m√°s importantes: <br><br><ul><li>  DataState: la capacidad de organizar el acceso compartido a un objeto desde varias instancias independientes de m√°quinas virtuales Lua. </li><li>  La capacidad de establecer <a href="">un tiempo de espera para la rutina</a> e interrumpir la ejecuci√≥n de aquellos que corren m√°s tiempo. </li><li>  Un conjunto de optimizaciones del compilador JIT dise√±ado para combatir el aumento exponencial en el n√∫mero de trazas al copiar datos entre objetos: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">hablamos</a> de esto en HighLoad ++ 2017, pero hace solo un par de meses ten√≠amos nuevas ideas de trabajo que a√∫n no se han documentado. </li><li>  Nuevo kit de herramientas: perfilador de muestreo.  analizador de salida de depuraci√≥n del compilador <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">dumpanalyze</a> , etc. </li></ul><br>  Cada una de estas caracter√≠sticas merece un art√≠culo separado: escriba en los comentarios sobre cu√°l le gustar√≠a leer m√°s. <br><br>  Aqu√≠ quiero hablar un poco m√°s sobre c√≥mo redujimos la carga en el recolector de basura.  <a href="">El sellado le</a> permite hacer que un objeto sea inaccesible para el recolector de basura.  En nuestro proyecto t√≠pico, la mayor√≠a de los datos (hasta el 80%) dentro de la m√°quina virtual Lua ya son reglas comerciales, que son una tabla Lua compleja.  La vida √∫til de esta tabla (minutos) es mucho m√°s larga que la vida √∫til de las solicitudes procesadas (decenas de milisegundos), y los datos que contiene no cambian durante el procesamiento de la consulta.  En tal situaci√≥n, no tiene sentido obligar al recolector de basura a recurrir alrededor de esta enorme estructura de datos una y otra vez.  Para hacer esto, "sellamos" recursivamente el objeto y reordenamos los datos de tal manera que el recolector de basura nunca llegue ni al objeto "sellado" ni a su contenido.  En Vanilla Lua 5.4, este problema se <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">resolver√° al</a> admitir generaciones de objetos en la recolecci√≥n de basura generacional. <br><br>  Es importante tener en cuenta que los objetos "sellados" no deben poder escribirse.  La no observancia de esta invariante conduce a la aparici√≥n de punteros colgantes: por ejemplo, un objeto "sellado" se refiere a uno normal, y un recolector de basura, omitiendo un objeto "sellado" cuando va alrededor de un mont√≥n, omite uno normal, con la diferencia de que un objeto "sellado" no puede liberarse, y el habitual puede.  Habiendo implementado el soporte para este invariante, esencialmente obtenemos soporte de <a href="">inmunidad</a> gratuito <a href="">para los</a> objetos, cuya ausencia a menudo se lamenta en Lua.  Insisto en que los objetos inmutables y "sellados" no son lo mismo.  La segunda propiedad implica la primera, pero no al rev√©s. <br><br>  Tambi√©n noto que en Lua 5.1 la inmunidad se puede implementar usando metatablas: la soluci√≥n funciona bastante, pero no es la m√°s rentable en t√©rminos de rendimiento.  En <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">este</a> informe se puede encontrar m√°s informaci√≥n sobre "sellado", inmunidad y c√≥mo los usamos en la vida cotidiana. <br><br><h1>  Conclusiones </h1><br>  Por el momento, estamos satisfechos con la estabilidad y el conjunto de oportunidades para nuestra implementaci√≥n.  Y aunque debido a las limitaciones iniciales, nuestra implementaci√≥n es significativamente inferior a Vanilla Lua y LuaJIT en t√©rminos de portabilidad, resuelve muchos de nuestros problemas: esperamos que estas soluciones sean √∫tiles para otra persona. <br><br>  Adem√°s, incluso si LuaVela no es adecuado para la producci√≥n, lo invitamos a usarlo como punto de entrada para comprender c√≥mo funciona LuaJIT o su tenedor.  Adem√°s de resolver problemas y ampliar la funcionalidad, a lo largo de los a√±os hemos refactorizado una parte significativa de la base del c√≥digo y hemos escrito <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">art√≠culos de capacitaci√≥n</a> sobre la estructura interna del proyecto; muchos de ellos son aplicables no solo a LuaVela, sino tambi√©n a LuaJIT. <br><br>  Gracias por su atenci√≥n, estamos esperando solicitudes de extracci√≥n. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/465441/">https://habr.com/ru/post/465441/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../465429/index.html">Sin embargo, C es un lenguaje de bajo nivel.</a></li>
<li><a href="../465431/index.html">An√°lisis del c√≥digo fuente RPC del framework Apache Dubbo con el analizador est√°tico PVS-Studio</a></li>
<li><a href="../465433/index.html">Robots de trabajo - hombre feliz</a></li>
<li><a href="../465435/index.html">¬øQu√© distribuci√≥n es mejor para su sistema integrado?</a></li>
<li><a href="../465437/index.html">Por qu√© me negu√© a trabajar en AWS</a></li>
<li><a href="../465445/index.html">Notas del proveedor de IoT. Maldici√≥n de salida de impulso</a></li>
<li><a href="../465449/index.html">C√≥mo se forjaron los problemas de Mail.ru y el FSB por la reputaci√≥n de Pavel Durov y la fe en Telegram</a></li>
<li><a href="../465453/index.html">3 de septiembre - D√≠a de la CTO en San Petersburgo</a></li>
<li><a href="../465455/index.html">Trabaje con incidentes, mejorando la respuesta a incidentes y el valor t√©cnico de la deuda. Backend United 4 materiales de mitap: Okroshka</a></li>
<li><a href="../465457/index.html">Sobre PBR en los dedos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>