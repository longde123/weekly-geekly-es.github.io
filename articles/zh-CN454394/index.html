<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>â†©ï¸ ğŸš© ğŸ˜’ ç®€çº¦çš„å››éƒ¨åˆ†MIDIæ’­æ”¾å™¨ ğŸ•‹ ğŸ’µ ğŸ˜²</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="å»ºè®®çš„æ’­æ”¾å™¨ä¸éœ€è¦å­˜å‚¨å¡ï¼›å®ƒç›´æ¥åœ¨ATtiny85å¾®æ§åˆ¶å™¨ä¸­å­˜å‚¨é•¿è¾¾6,000å­—èŠ‚çš„MIDIæ–‡ä»¶ï¼ˆä¸æ’­æ”¾WAVæ–‡ä»¶çš„ç»å…¸è®¾è®¡ä¸åŒï¼Œå®ƒè‡ªç„¶éœ€è¦å­˜å‚¨å¡ï¼‰ã€‚ ä½¿ç”¨PWMå®ç°å…·æœ‰è¡°å‡çš„å››è·¯å›æ”¾ã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªå‘å£°çš„ä¾‹å­ã€‚ 

 è¯¥è®¾å¤‡æ˜¯æ ¹æ®æ–¹æ¡ˆåˆ¶é€ çš„ï¼š 



 å¦‚æœç”±äºè½¯ä»¶æ•…éšœè€Œåœ¨PB4çš„è¾“å‡ºç«¯å‡ºç°é€»è¾‘å•å…ƒ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>ç®€çº¦çš„å››éƒ¨åˆ†MIDIæ’­æ”¾å™¨</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/454394/"><img src="https://habrastorage.org/webt/wy/qv/ce/wyqvcexiheyxhiuc2lspo3iz7jm.jpeg"><br><br> å»ºè®®çš„æ’­æ”¾å™¨ä¸éœ€è¦å­˜å‚¨å¡ï¼›å®ƒç›´æ¥åœ¨ATtiny85å¾®æ§åˆ¶å™¨ä¸­å­˜å‚¨é•¿è¾¾6,000å­—èŠ‚çš„MIDIæ–‡ä»¶ï¼ˆä¸æ’­æ”¾WAVæ–‡ä»¶çš„ç»å…¸è®¾è®¡ä¸åŒï¼Œå®ƒè‡ªç„¶éœ€è¦å­˜å‚¨å¡ï¼‰ã€‚ ä½¿ç”¨PWMå®ç°å…·æœ‰è¡°å‡çš„å››è·¯å›æ”¾ã€‚  <a href="">è¿™é‡Œæœ‰</a>ä¸€ä¸ªå‘å£°çš„ä¾‹å­ã€‚ <a name="habracut"></a><br><br> è¯¥è®¾å¤‡æ˜¯æ ¹æ®æ–¹æ¡ˆåˆ¶é€ çš„ï¼š <br><br><img src="https://habrastorage.org/webt/qs/h8/uz/qsh8uzrueecz-x4c-pxv5webr7o.gif"><br><br> å¦‚æœç”±äºè½¯ä»¶æ•…éšœè€Œåœ¨PB4çš„è¾“å‡ºç«¯å‡ºç°é€»è¾‘å•å…ƒï¼Œåˆ™å¾®æ§åˆ¶å™¨å’ŒåŠ¨æ€ç£å¤´ä¹‹é—´çš„ç”µè§£ç”µå®¹å™¨å°†ä¸ä¼šä¸¢å¤±å¸¸æ•°ç»„ä»¶ã€‚ ç£å¤´çš„ç”µæ„Ÿä¸è¶…è¿‡PWMé¢‘ç‡ã€‚ å¦‚æœå†³å®šå°†è®¾å¤‡è¿æ¥åˆ°æ”¾å¤§å™¨ï¼Œä¸ºäº†é¿å…åè€…å› PWMä¿¡å·è€Œè¿‡è½½ï¼Œæ‚¨éœ€è¦æ·»åŠ ä¸€ä¸ªä½é€šæ»¤æ³¢å™¨ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ <br><br>  MIDIæ–‡ä»¶å¿…é¡»ä»¥ä»¥ä¸‹å½¢å¼çš„æ•°ç»„æ”¾ç½®åœ¨å›ºä»¶æºä¸­ï¼š <br><br><pre><code class="plaintext hljs">const uint8_t Tune[] PROGMEM = { 0x4d, 0x54, 0x68, 0x64, 0x00, 0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x01, 0x03, 0xc0, 0x4d, 0x54, 0x72, 0x6b, 0x00, 0x00, 0x0a, 0x7e, 0x00, 0xff, ... 0x50, 0xb0, 0x5b, 0x00, 0x00, 0xff, 0x2f, 0x00 };</code> </pre> <br> æœ‰ä¸€ä¸ªç°æˆçš„è§£å†³æ–¹æ¡ˆå¯å°†æ–‡ä»¶è½¬æ¢ä¸ºç±»ä¼¼UNIXçš„æ“ä½œç³»ç»Ÿä¸Šçš„è¿™ç§æ ¼å¼-xxdå®ç”¨ç¨‹åºã€‚ æˆ‘ä»¬è·å–MIDIæ–‡ä»¶ï¼Œå¹¶é€šè¿‡ä»¥ä¸‹å®ç”¨ç¨‹åºè¿›è¡Œä¼ é€’ï¼š <br><br><pre> <code class="plaintext hljs">xxd -i musicbox.mid</code> </pre> <br> æ§åˆ¶å°å°†æ˜¾ç¤ºå¦‚ä¸‹å†…å®¹ï¼š <br><br><pre> <code class="plaintext hljs">unsigned char musicbox_mid[] = { 0x4d, 0x54, 0x68, 0x64, 0x00, 0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x01, 0x03, 0xc0, 0x4d, 0x54, 0x72, 0x6b, 0x00, 0x00, 0x0a, 0x7e, 0x00, 0xff, ... 0x50, 0xb0, 0x5b, 0x00, 0x00, 0xff, 0x2f, 0x00 }; unsigned int musicbox_mid_len = 2708;</code> </pre> <br>  2708æ˜¯å­—èŠ‚é•¿åº¦ã€‚ åŸæ¥å°‘äº6000-è¿™æ„å‘³ç€å®ƒé€‚åˆã€‚ é€šè¿‡å‰ªè´´æ¿çš„åå…­è¿›åˆ¶æ•°å­—åºåˆ—å°†ä¼ è¾“åˆ°è‰å›¾ï¼ˆè¯·è®°ä½ï¼š <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨æ§åˆ¶å°ä¸­ï¼Œæ²¡æœ‰Ctrl + C</a> ï¼‰ï¼Œè€Œä¸æ˜¯é»˜è®¤æ•°ç»„ã€‚ æˆ–è€…ï¼Œå¦‚æœæˆ‘ä»¬å¸Œæœ›ç¦»å¼€ï¼Œåˆ™ä¸è¦æ‰§è¡Œæ‰€æœ‰è¿™äº›æ“ä½œã€‚ <br><br> è®¡æ—¶å™¨è®¡æ•°å™¨1å°†ä»PLLä»¥64 MHzçš„é¢‘ç‡å·¥ä½œï¼š <br><br><pre> <code class="plaintext hljs"> PLLCSR = 1&lt;&lt;PCKE | 1&lt;&lt;PLLE;</code> </pre> <br> æˆ‘ä»¬å°†æ­¤å®šæ—¶å™¨è½¬æ¢ä¸ºPWMæ¨¡å¼ä»¥ç”¨ä½œDACï¼›å ç©ºæ¯”å–å†³äºOCR1Bçš„å€¼ï¼š <br><br><pre> <code class="plaintext hljs"> TIMSK = 0; // Timer interrupts OFF TCCR1 = 1&lt;&lt;CS10; // 1:1 prescale GTCCR = 1&lt;&lt;PWM1B | 2&lt;&lt;COM1B0; // PWM B, clear on match OCR1B = 128; DDRB = 1&lt;&lt;DDB4; // Enable PWM output on pin 4</code> </pre> <br> çŸ©å½¢è„‰å†²çš„é¢‘ç‡å–å†³äºOCR1Cçš„å€¼ï¼Œæˆ‘ä»¬å°†å…¶è®¾ä¸º255ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼‰ï¼Œç„¶åå°†64 MHzçš„é¢‘ç‡é™¤ä»¥256ï¼Œå¾—åˆ°250 kHzã€‚ <br><br> è®¡æ—¶å™¨è®¡æ•°å™¨0å°†äº§ç”Ÿä¸­æ–­ï¼š <br><br><pre> <code class="plaintext hljs"> TCCR0A = 3&lt;&lt;WGM00; // Fast PWM TCCR0B = 1&lt;&lt;WGM02 | 2&lt;&lt;CS00; // 1/8 prescale OCR0A = 19; // Divide by 20 TIMSK = 1&lt;&lt;OCIE0A; // Enable compare match, disable overflow</code> </pre> <br>  16 MHzçš„æ—¶é’Ÿé¢‘ç‡ç”±8åˆ†é¢‘å™¨åˆ†é¢‘ï¼Œç„¶åç”±19 + 1çš„OCR0Aå€¼åˆ†é¢‘ï¼Œå¾—åˆ°100 kHzã€‚ æ’­æ”¾å™¨ä¸ºå››å£°ï¼Œæ¯ä¸ªå£°éŸ³è·å¾—25 kHzã€‚ ä¸­æ–­åï¼Œå°†è°ƒç”¨ISRå¤„ç†ä¾‹ç¨‹ï¼ˆTIMER0_COMPA_vectï¼‰ï¼Œè¯¥ä¾‹ç¨‹è®¡ç®—å¹¶è¾“å‡ºå£°éŸ³ã€‚ <br><br> çœ‹é—¨ç‹—å®šæ—¶å™¨é…ç½®ä¸ºæ¯16 msäº§ç”Ÿä¸€æ¬¡ä¸­æ–­ï¼Œæ¥æ”¶ä¸­æ–­é¢‘ç‡æ˜¯å¿…éœ€çš„ï¼š <br><br><pre> <code class="plaintext hljs">WDTCR = 1&lt;&lt;WDIE | 0&lt;&lt;WDP0; // Interrupt every 16ms</code> </pre> <br> ä¸ºäº†è·å¾—ç»™å®šå½¢çŠ¶çš„æŒ¯è¡ï¼Œä½¿ç”¨ç›´æ¥æ•°å­—åˆæˆã€‚  ATtiny85ä¸­æ²¡æœ‰ç¡¬ä»¶ä¹˜æ³•ï¼Œå› æ­¤æˆ‘ä»¬é‡‡ç”¨çŸ©å½¢è„‰å†²å¹¶å°†åŒ…ç»œçš„å¹…åº¦ä¹˜ä»¥1æˆ–-1ã€‚ å¹…åº¦çº¿æ€§å‡å°ï¼Œå¹¶ä¸”ä¸ºäº†åœ¨ç»™å®šçš„æ—¶é—´ç‚¹è¿›è¡Œè®¡ç®—ï¼Œè¶³ä»¥çº¿æ€§å‡å°ä»ªè¡¨è¯»æ•°ã€‚ <br><br> ä¸ºæ¯ä¸ªé€šé“æä¾›ä¸‰ä¸ªå˜é‡ï¼šé¢‘ç‡[]-é¢‘ç‡ï¼ŒåŠ é€Ÿåº¦[]-ç›¸ç”µæ± ï¼Œç”µæµ[]ï¼ŒåŒ…ç»œå¹…åº¦å€¼ã€‚  Freq []å’ŒAcc []çš„å€¼ç›¸åŠ ã€‚ é«˜é˜¶ä½Acc []ç”¨äºè·å¾—çŸ©å½¢è„‰å†²ã€‚  Freq []è¶Šå¤šï¼Œé¢‘ç‡è¶Šé«˜ã€‚ å®Œæˆçš„æ³¢å½¢ä¹˜ä»¥åŒ…ç»œçº¿Amp []ã€‚ æ‰€æœ‰å››ä¸ªé€šé“éƒ½è¢«å¤šè·¯å¤ç”¨å¹¶é¦ˆé€åˆ°æ¨¡æ‹Ÿè¾“å‡ºã€‚ <br><br> è¯¥ç¨‹åºçš„é‡â€‹â€‹è¦éƒ¨åˆ†æ˜¯å¤„ç†æ¥è‡ªå®šæ—¶å™¨0çš„ä¸­æ–­çš„è¿‡ç¨‹ï¼Œè¯¥è¿‡ç¨‹å°†æŒ¯è¡è¾“å‡ºåˆ°æ¨¡æ‹Ÿè¾“å‡ºã€‚ ä»¥å¤§çº¦95 kHzçš„é¢‘ç‡è°ƒç”¨æ­¤è¿‡ç¨‹ã€‚ å¯¹äºå½“å‰é€šé“cï¼Œå®ƒæ›´æ–°Acc [c]å’ŒAmp [c]çš„å€¼ï¼Œå¹¶è®¡ç®—å½“å‰éŸ³ç¬¦çš„å€¼ã€‚ ç»“æœè¢«å‘é€åˆ°OCR1Bè®¡æ—¶å™¨çš„OCR1Bæ¯”è¾ƒå¯„å­˜å™¨ï¼Œä»¥åœ¨å¼•è„š4ä¸Šè·å¾—æ¨¡æ‹Ÿä¿¡å·ï¼š <br><br><pre> <code class="plaintext hljs">ISR(TIMER0_COMPA_vect) { static uint8_t c; signed char Temp, Mask, Env, Note; Acc[c] = Acc[c] + Freq[c]; Amp[c] = Amp[c] - (Amp[c] != 0); Temp = Acc[c] &gt;&gt; 8; Temp = Temp &amp; Temp&lt;&lt;1; Mask = Temp &gt;&gt; 7; Env = Amp[c] &gt;&gt; Volume; Note = (Env ^ Mask) + (Mask &amp; 1); OCR1B = Note + 128; c = (c + 1) &amp; 3; }</code> </pre> <br> å¼¦ä¹ <br><br><pre> <code class="plaintext hljs">Acc[c] = Acc[c] + Freq[c];</code> </pre> <br> å°†é¢‘ç‡freq [c]æ·»åŠ åˆ°ç”µæ± Acc [c]ã€‚ é¢‘ç‡[c]è¶Šå¤§ï¼ŒAcc [c]å€¼å˜åŒ–å¾—è¶Šå¿«ã€‚ ç„¶åè¡Œ <br><br><pre> <code class="plaintext hljs">Amp[c] = Amp[c] - (Amp[c] != 0);</code> </pre> <br> é™ä½ç»™å®šé€šé“çš„å¹…åº¦å€¼ã€‚ éœ€è¦ç‰‡æ®µï¼ˆAmp [c]ï¼= 0ï¼‰ï¼Œä»¥ä¾¿åœ¨æŒ¯å¹…è¾¾åˆ°é›¶åä¸ä¼šè¿›ä¸€æ­¥å‡å°ã€‚ ç°åœ¨è¡Œ <br><br><pre> <code class="plaintext hljs">Temp = Acc[c] &gt;&gt; 8;</code> </pre> <br> å°†Acc [c]çš„é«˜9ä½ä¼ é€åˆ°Tempã€‚ å’Œçº¿ <br><br><pre> <code class="plaintext hljs">Temp = Temp &amp; Temp&lt;&lt;1;</code> </pre> <br> å¦‚æœä¸¤ä¸ªé«˜é˜¶ä½ç­‰äº1ï¼Œåˆ™ä½¿æ­¤å˜é‡çš„é«˜é˜¶ä½ç­‰äº1ï¼›å¦‚æœä¸ç›¸åŒï¼Œåˆ™å°†å…¶è®¾ç½®ä¸ºé›¶ã€‚ ç»“æœæ˜¯å¼€/å…³æ¯”ä¸º25/75çš„çŸ©å½¢è„‰å†²ã€‚ åœ¨ä»¥å‰çš„ä¸€ç§æ„é€ ä¸­ï¼Œä½œè€…æ–½åŠ äº†æ›²æŠ˜ï¼Œè€Œé‡‡ç”¨æ–°æ–¹æ³•æ—¶ï¼Œè°æ³¢å¾—åˆ°äº†æ›´å¤šã€‚ å¼¦ä¹ <br><br><pre> <code class="plaintext hljs">Mask = Temp &gt;&gt; 7;</code> </pre> <br> å°†æœ€é«˜æœ‰æ•ˆä½çš„å€¼ä¼ è¾“åˆ°å­—èŠ‚çš„å…¶ä½™ä½ï¼Œä¾‹å¦‚ï¼Œå¦‚æœæœ€é«˜æœ‰æ•ˆä½ä¸º0ï¼Œåˆ™å°†è·å¾—0x00ï¼Œå¦‚æœä¸º1-åˆ™ä¸º0xFFã€‚ å¼¦ä¹ <br><br><pre> <code class="plaintext hljs">Env = Amp[c] &gt;&gt; Volume;</code> </pre> <br> ç”±äºVolume = 8ï¼Œå› æ­¤å°†Volumeå€¼æŒ‡å®šçš„Amp [c]ä½ä¼ è¾“åˆ°Envï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯ä¼˜å…ˆçº§1ã€‚ <br><br><pre> <code class="plaintext hljs">Note = (Env ^ Mask) + (Mask &amp; 1);</code> </pre> <br> æ‰€æœ‰è¿™äº›ç»“åˆåœ¨ä¸€èµ·ã€‚ å¦‚æœMask = 0x00ï¼Œåˆ™ä¸ºNoteåˆ†é…å€¼Envã€‚ å¦‚æœMask = 0xFFï¼Œåˆ™ä¸ºNoteåˆ†é…Env +1ä»¥å¤–çš„å€¼ï¼Œå³å¸¦æœ‰è´Ÿå·çš„Envã€‚ ç°åœ¨æ³¨æ„åŒ…å«ç”µæµæ³¢å½¢ï¼Œç”µæµæ³¢å½¢ä»æ­£å€¼å˜ä¸ºè´Ÿå€¼ã€‚ å¼¦ä¹ <br><br><pre> <code class="plaintext hljs">OCR1B = Note + 128;</code> </pre> <br> å°†128åŠ åˆ°Noteå¹¶å°†ç»“æœå†™å…¥OCR1Bã€‚ å¼¦ä¹ <br><br><pre> <code class="plaintext hljs">c = (c + 1) &amp; 3;</code> </pre> <br> æ ¹æ®ç›¸åº”çš„ä¸­æ–­è¾“å‡ºå››ä¸ªé€šé“ï¼Œå¤šè·¯å¤ç”¨è¾“å‡ºç«¯çš„å£°éŸ³ã€‚ <br><br> æ•°ç»„ä¸­ç»™å‡ºäº†åäºŒä¸ªéŸ³ç¬¦é¢‘ç‡ï¼š <br><br><pre> <code class="plaintext hljs">unsigned int Scale[] = { 10973, 11626, 12317, 13050, 13826, 14648, 15519, 16442, 17419, 18455, 19552, 20715};</code> </pre> <br> å…¶ä»–å…«åº¦éŸ³é˜¶çš„éŸ³ç¬¦é¢‘ç‡é€šè¿‡é™¤ä»¥2 <sup>nè·å¾—</sup> ã€‚ ä¾‹å¦‚ï¼Œå°†10973é™¤ä»¥2 <sup>4</sup>å¾—åˆ°686ã€‚é«˜ä½Acc [c]å°†ä»¥25000 /ï¼ˆ65536/685ï¼‰= 261.7 Hzçš„é¢‘ç‡è¿›è¡Œåˆ‡æ¢ã€‚ <br><br> æœ‰ä¸¤ä¸ªå˜é‡ä¼šå½±å“å£°éŸ³ï¼šéŸ³é‡-éŸ³é‡ï¼ˆä»7åˆ°9ï¼‰å’Œè¡°å‡-è¡°å‡ï¼ˆä»12åˆ°14ï¼‰ã€‚â€œè¡°å‡â€å€¼è¶Šé«˜ï¼Œè¡°å‡è¶Šæ…¢ã€‚ <br><br> æœ€ç®€å•çš„MIDIè§£é‡Šå™¨ä»…å…³æ³¨éŸ³ç¬¦ï¼Œé€Ÿåº¦å’Œé™¤æ³•ç³»æ•°çš„å€¼ï¼Œè€Œå¿½ç•¥å…¶ä»–æ•°æ®ã€‚  readIgnoreï¼ˆï¼‰ä¾‹ç¨‹è·³è¿‡ä»æ–‡ä»¶æ¥æ”¶çš„æ•°ç»„ä¸­æŒ‡å®šæ•°é‡çš„å­—èŠ‚ï¼š <br><br><pre> <code class="plaintext hljs">void readIgnore (int n) { Ptr = Ptr + n; }</code> </pre> <br>  readNumberï¼ˆï¼‰ä¾‹ç¨‹ä»ç»™å®šçš„å­—èŠ‚æ•°ä¸­è¯»å–ä¸€ä¸ªæ•°å­—ï¼Œç²¾åº¦ä¸º4ï¼š <br><br><pre> <code class="plaintext hljs">unsigned long readNumber (int n) { long result = 0; for (int i=0; i&lt;n; i++) result = (result&lt;&lt;8) + pgm_read_byte(&amp;Tune[Ptr++]); return result; }</code> </pre> <br>  readVariableï¼ˆï¼‰ä¾‹ç¨‹è¯»å–MIDIå˜é‡ç²¾åº¦çš„æ•°å­—ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­—èŠ‚æ•°å¯ä»¥ä¸º1åˆ°4ï¼š <br><br><pre> <code class="plaintext hljs">unsigned long readVariable () { long result = 0; uint8_t b; do { b = pgm_read_byte(&amp;Tune[Ptr++]); result = (result&lt;&lt;7) + (b &amp; 0x7F); } while (b &amp; 0x80); return result; }</code> </pre> <br> æ¯ä¸ªå­—èŠ‚å–7ä½ï¼Œå¦‚æœéœ€è¦è¿›ä¸€æ­¥è¯»å–å¦ä¸€ä¸ªå­—èŠ‚ï¼Œåˆ™ç¬¬å…«ä½ç­‰äº1ï¼›å¦åˆ™ï¼Œåˆ™ç­‰äº0ã€‚ <br><br> è§£é‡Šå™¨è°ƒç”¨noteOnï¼ˆï¼‰ä¾‹ç¨‹åœ¨ä»¥ä¸‹å¯ç”¨é€šé“ä¸­æ’­æ”¾ç¬”è®°ï¼š <br><br><pre> <code class="plaintext hljs">void noteOn (uint8_t number) { uint8_t octave = number/12; uint8_t note = number%12; unsigned int freq = Scale[note]; uint8_t shift = 9-octave; Freq[Chan] = freq&gt;&gt;shift; Amp[Chan] = 1&lt;&lt;Decay; Chan = (Chan + 1) &amp; 3; }</code> </pre> <br>  Ptrå˜é‡æŒ‡ç¤ºè¦è¯»å–çš„ä¸‹ä¸€ä¸ªå­—èŠ‚ï¼š <br><br><pre> <code class="plaintext hljs">void playMidiData () { Ptr = 0; // Begin at start of file</code> </pre> <br>  MIDIæ–‡ä»¶ä¸­çš„ç¬¬ä¸€ä¸ªå—æ˜¯æ ‡å¤´ï¼Œå®ƒæŒ‡ç¤ºéŸ³è½¨çš„æ•°é‡ï¼Œé€Ÿåº¦å’Œåˆ†å‰²æ¯”ç‡ï¼š <br><br><pre> <code class="plaintext hljs">// Read header chunk unsigned long type = readNumber(4); if (type != MThd) error(1); unsigned long len = readNumber(4); unsigned int format = readNumber(2); unsigned int tracks = readNumber(2); unsigned int division = readNumber(2); // Ticks per beat TempoDivisor = (long)division*16000/Tempo;</code> </pre> <br> é™¤æ³•ç³»æ•°é€šå¸¸ç­‰äº960ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬è¯»å–ç»™å®šçš„å—æ•°ï¼š <br><br><pre> <code class="plaintext hljs"> // Read track chunks for (int t=0; t&lt;tracks; t++) { type = readNumber(4); if (type != MTrk) error(2); len = readNumber(4); EndBlock = Ptr + len;</code> </pre> <br> è¯»å–é¡ºåºäº‹ä»¶ï¼Œç›´åˆ°å—ç»“æŸï¼š <br><br><pre> <code class="plaintext hljs"> // Parse track while (Ptr &lt; EndBlock) { unsigned long delta = readVariable(); uint8_t event = readNumber(1); uint8_t eventType = event &amp; 0xF0; if (delta &gt; 0) Delay(delta/TempoDivisor);</code> </pre> <br> åœ¨æ¯ä¸ªäº‹ä»¶ä¸­ï¼Œéƒ½æŒ‡å®šäº†å¢é‡-ç”±é™¤æ³•ç³»æ•°ç¡®å®šçš„æ—¶é—´å•ä½çš„å»¶è¿Ÿï¼Œè¯¥å»¶è¿Ÿå¿…é¡»åœ¨æ­¤äº‹ä»¶ä¹‹å‰å‘ç”Ÿã€‚ å¯¹äºåº”è¯¥åœ¨æ­¤å¤„å‘ç”Ÿçš„äº‹ä»¶ï¼Œdeltaä¸ºé›¶ã€‚ <br><br> å…ƒäº‹ä»¶æ˜¯ç±»å‹ä¸º0xFFçš„äº‹ä»¶ï¼š <br><br><pre> <code class="plaintext hljs"> // Meta event if (event == 0xFF) { uint8_t mtype = readNumber(1); uint8_t mlen = readNumber(1); // Tempo if (mtype == 0x51) { Tempo = readNumber(mlen); TempoDivisor = (long)division*16000/Tempo; // Ignore other meta events } else readIgnore(mlen);</code> </pre> <br> æˆ‘ä»¬æ„Ÿå…´è¶£çš„å”¯ä¸€å…ƒäº‹ä»¶ç±»å‹æ˜¯Tempoï¼Œå³æ‹é€Ÿçš„å€¼ï¼ˆä»¥å¾®ç§’ä¸ºå•ä½ï¼‰ã€‚ é»˜è®¤æƒ…å†µä¸‹ä¸º500,000ï¼Œå³åŠç§’ï¼Œç›¸å½“äºæ¯åˆ†é’Ÿ120æ¬¡ã€‚ <br><br> å…¶ä½™äº‹ä»¶æ˜¯ç”±å…¶ç±»å‹çš„ç¬¬ä¸€ä¸ªåå…­è¿›åˆ¶æ•°å­—å®šä¹‰çš„MIDIäº‹ä»¶ã€‚ æˆ‘ä»¬åªå¯¹0x90æ„Ÿå…´è¶£-æ³¨æ„å¼€å¯ï¼Œåœ¨ä»¥ä¸‹å¯ç”¨é¢‘é“ä¸Šæ’­æ”¾ç¬”è®°ï¼š <br><br><pre> <code class="plaintext hljs"> // Note off - ignored } else if (eventType == 0x80) { uint8_t number = readNumber(1); uint8_t velocity = readNumber(1); // Note on } else if (eventType == 0x90) { uint8_t number = readNumber(1); uint8_t velocity = readNumber(1); noteOn(number); // Polyphonic key pressure } else if (eventType == 0xA0) readIgnore(2); // Controller change else if (eventType == 0xB0) readIgnore(2); // Program change else if (eventType == 0xC0) readIgnore(1); // Channel key pressure else if (eventType == 0xD0) readIgnore(1); // Pitch bend else if (eventType == 0xD0) readIgnore(2); else error(3); } } }</code> </pre> <br> æˆ‘ä»¬å¿½ç•¥äº†åŠ›åº¦å€¼ï¼Œä½†æ˜¯å¦‚æœæ‚¨æ„¿æ„ï¼Œå¯ä»¥åœ¨å…¶ä¸Šè®¾ç½®éŸ³ç¬¦çš„åˆå§‹å¹…åº¦ã€‚ æˆ‘ä»¬è·³è¿‡å…¶ä½™äº‹ä»¶ï¼Œå®ƒä»¬çš„é•¿åº¦å¯ä»¥ä¸åŒã€‚ å¦‚æœMIDIæ–‡ä»¶ä¸­å‘ç”Ÿé”™è¯¯ï¼Œåˆ™LEDç‚¹äº®ã€‚ <br><br> å¾®æ§åˆ¶å™¨çš„å·¥ä½œé¢‘ç‡ä¸º16 MHzï¼Œå› æ­¤ä¸éœ€è¦çŸ³è‹±ï¼Œæ‚¨éœ€è¦æ­£ç¡®é…ç½®å†…ç½®PLLã€‚ ä¸ºäº†ä½¿å¾®æ§åˆ¶å™¨å˜å¾—ä¸Arduinoå…¼å®¹ï¼Œåº”ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">äº†</a> Spence Kondeçš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™ç§ç»éªŒ</a> ã€‚ åœ¨Boardèœå•ä¸­ï¼Œé€‰æ‹©ATtinyCoreå­èœå•ï¼Œç„¶åæ˜¾ç¤ºATtiny25 / 45/85ã€‚ åœ¨ä»¥ä¸‹èœå•ä¸­ï¼Œé€‰æ‹©ï¼šè®¡æ—¶å™¨1æ—¶é’Ÿï¼šCPUï¼Œç¦ç”¨BODï¼ŒATtiny85ã€16 MHzï¼ˆPLLï¼‰ã€‚ ç„¶åé€‰æ‹©Burn Bootloaderï¼Œç„¶åå¡«å†™ç¨‹åºã€‚ åƒSpinyFunçš„Tiny AVRç¼–ç¨‹å™¨æ¿ä¸€æ ·ä½¿ç”¨è¯¥ç¼–ç¨‹å™¨ã€‚ <br><br>  CC-BY 4.0çš„å›ºä»¶åœ¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">è¿™é‡Œ</a> ï¼Œå·²ç»åœ¨Då°è°ƒä¸­å…·æœ‰å·´èµ«èµ‹æ ¼äº†ï¼ŒåŸå§‹MIDIæ–‡ä»¶<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨è¿™é‡Œè·å–</a> ã€‚ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN454394/">https://habr.com/ru/post/zh-CN454394/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN454378/index.html">Rogozinæ¼”è®²ï¼šåˆ°2030å¹´ï¼Œä¿„ç½—æ–¯å®‡èˆªå‘˜å°†ç™»ä¸Šæœˆçƒ</a></li>
<li><a href="../zh-CN454382/index.html">ä¼Šä¸‡ï¼ˆIvan Uglyanskyï¼‰å’Œå¼—æ‹‰åŸºç±³å°”ï¼ˆVladimir Sitnikovï¼‰åœ¨jug.msk.ruä¸Š</a></li>
<li><a href="../zh-CN454384/index.html">æ¿€å…‰è§†åŠ›çŸ«æ­£-Smileæ–¹æ³•çœŸçš„æœ‰æ•ˆå—ï¼Ÿ</a></li>
<li><a href="../zh-CN454386/index.html">AvaloniaUIçš„MessageBox</a></li>
<li><a href="../zh-CN454388/index.html">ARAï¼šç”¨äºæŸ¥æ‰¾ç›´çº¿ä¸Šæœ€å¤§ç‚¹æ•°çš„ç®—æ³•</a></li>
<li><a href="../zh-CN454396/index.html">åœ¨ä¸»è¦å‘è¡Œç‰ˆä¸Šå®‰è£…sdl2</a></li>
<li><a href="../zh-CN454398/index.html">ä»è¯„è®ºå®¶åˆ°ç®—æ³•ï¼šæ°‘ä¸»å’ŒæŠ€æœ¯ä¸“å®¶å¦‚ä½•è¿›å…¥éŸ³ä¹è¡Œä¸š</a></li>
<li><a href="../zh-CN454400/index.html">ä½¿ç”¨Rå’ŒPowerShellçš„è™šæ‹ŸæœºçŠ¶æ€æ¯æ—¥æŠ¥å‘Š</a></li>
<li><a href="../zh-CN454402/index.html">ç”¨äºç»„ç»‡å•å…ƒè¡Œä¸ºçš„UnityçŠ¶æ€æœºæ¶æ„</a></li>
<li><a href="../zh-CN454404/index.html">åŸ¹è®­Cisco 200-125 CCNA v3.0ã€‚ ç¬¬6å¤©ã€‚å¡«å†™ç©ºç™½ï¼ˆDHCPï¼ŒTCPï¼Œâ€œæ¡æ‰‹â€ï¼Œé€šç”¨ç«¯å£å·ï¼‰</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>