<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏕️ 🦕 ⛹🏼 介绍InterSystems API Manager 💆🏿 👆🏾 🚵🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="最近，我们发布了InterSystems API Manager（IAM），它是InterSystems IRIS数据平台的新组件，可为IT基础架构内的Web API提供监视，控制和流量控制。 


 在本文中，我将向您展示如何配置IAM，并演示IAM可用的许多功能。 InterSystems AP...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>介绍InterSystems API Manager</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/intersystems/blog/475670/"><p> 最近，我们发布了InterSystems API Manager（IAM），它是InterSystems IRIS数据平台的新组件，可为IT基础架构内的Web API提供监视，控制和流量控制。 </p><br><p> 在本文中，我将向您展示如何配置IAM，并演示IAM可用的许多功能。  InterSystems API Manager允许您： </p><br><ul><li> 观看API，了解谁在使用API​​，哪些API最受欢迎，哪些需要改进。 </li><li> 控制谁使用API​​，并根据要求将API的使用范围从简单的访问限制限制为限制-您具有可自定义的控件，并且可以快速响应API使用模式的变化。 </li><li> 使用集中式安全性机制（例如OAuth2.0，LDAP或密钥令牌身份验证）保护API。 </li><li> 通过为开发人员打开特殊的门户，简化第三方开发人员的工作，并为他们提供出色的API体验。 </li><li> 扩展API并确保最小的响应延迟。 </li></ul><br><p>  API的管理对于过渡到SOA或微服务体系结构是必要的，从而简化了各个（微）服务之间的集成，使所有外部和内部使用者都可以访问它们。 结果，新的API变得更易于创建，维护和使用。 </p><a name="habracut"></a><br><p> 如果您已经在使用InterSystems IRIS，则可以将IAM选项添加到许可证中。  IAM选项对于InterSystems IRIS客户是免费的，但是要开始使用IAM，您需要从InterSystems请求新的许可证密钥。 </p><br><p> 如果您尚未使用InterSystems IRIS，并且仅打算试用InterSystems API Manager，请与InterSystems联系。 </p><br><h1 id="nachalo-raboty-i-ustanovka"> 入门和安装 </h1><br><p>  InterSystems IAM客户可以从<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">WRC</a>站点下载“软件分发”部分，并将其作为Docker容器运行。 最低系统要求： </p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Docker</a> 04.17.0+。 </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Docker Compose</a> 1.12.0+。 </li><li>  InterSystems IRIS 2019.1.1以上版本。 </li></ul><br><p> 最初，您需要下载Docker映像（重要！带有WRC的存档不是Docker映像，您需要在Docker映像内将其解压缩）： </p><br><pre><code class="plaintext hljs">docker load -i iam_image.tar</code> </pre> <br><p> 此命令将使IAM映像可供以后在服务器上使用。  IAM是一个单独的容器，因此您可以独立于InterSystems IRIS进行缩放。 要运行IAM，您需要访问InterSystems IRIS以下载许可证。 </p><br><p> 配置InterSystems IRIS： </p><br><ul><li> 开启网路应用程式<code>/api/IAM</code> </li><li> 启用<code>IAM</code>用户 </li><li> 更改<code>IAM</code>用户密码 </li></ul><br><p> 现在运行IAM容器。 在档案中，您将找到Windows和Unix（以及Mac）的<code>iam-setup</code>脚本。 这些脚本将帮助您正确设置环境变量，从而允许IAM容器连接到InterSystems IRIS。 这是Mac上脚本的示例： </p><br><pre> <code class="plaintext hljs">source ./iam-setup.sh Welcome to the InterSystems IRIS and InterSystems API Manager (IAM) setup script. This script sets the ISC_IRIS_URL environment variable that is used by the IAM container to get the IAM license key from InterSystems IRIS. Enter the full image repository, name and tag for your IAM docker image: intersystems/iam:0.34-1-1 Enter the IP address for your InterSystems IRIS instance. The IP address has to be accessible from within the IAM container, therefore, do not use "localhost" or "127.0.0.1" if IRIS is running on your local machine. Instead use the public IP address of your local machine. If IRIS is running in a container, use the public IP address of the host environment, not the IP address of the IRIS container. xxx.xxx.xxx.xxx Enter the web server port for your InterSystems IRIS instance: 52773 Enter the password for the IAM user for your InterSystems IRIS instance: Re-enter your password: Your inputs are: Full image repository, name and tag for your IAM docker image: intersystems/iam:0.34-1-1 IP address for your InterSystems IRIS instance: xxx.xxx.xxx.xxx Web server port for your InterSystems IRIS instance: 52773 Would you like to continue with these inputs (y/n)? y Getting IAM license using your inputs... Successfully got IAM license! The ISC_IRIS_URL environment variable was set to: http://IAM:****************@xxx.xxx.xxx.xxx:52773/api/iam/license WARNING: The environment variable is set for this shell only! To start the services, run the following command in the top level directory: docker-compose up -d To stop the services, run the following command in the top level directory: docker-compose down URL for the IAM Manager portal: http://localhost:8002</code> </pre> <br><p> 如您所见，IAM用户的完整映像名称，IP地址，InterSystems IRIS端口和密码就是开始所需要的。 </p><br><p> 您可以手动设置环境变量，而不是运行脚本： </p><br><pre> <code class="plaintext hljs">ISC_IAM_IMAGE=intersystems/iam:0.34-1-1 ISC_IRIS_URL=http://IAM:&lt;PASS&gt;@&lt;IP&gt;:&lt;PORT&gt;/api/iam/license</code> </pre> <br><h1 id="zapusk"> 发射 </h1><br><p> 现在，通过运行以下命令来运行IAM： </p><br><pre> <code class="plaintext hljs">docker-compose up -d</code> </pre> <br><p> 此命令组织IAM容器并确保正确启动所有内容。 使用以下命令检查容器的状态： </p><br><pre> <code class="plaintext hljs">docker ps</code> </pre> <br><p> 在浏览器中打开<code>localhost:8002</code>管理界面。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/feb/7c8/83c/feb7c883ce4240a907f3a16e40c5bd37.png"></p><br><p> 到目前为止，它是空的，因为它是一个全新的网站。 让我们改变它。  IAM支持将API分为模块和/或团队的工作区的概念。 转到我们将用于实验的“默认”工作区。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/92a/89f/ec2/92a89fec21308f5a8818a667f74124a4.png" alt="默认工作区工具栏"></p><br><p> 该工作空间的请求数量仍然为零，但是您将在左侧菜单中了解IAM的基本概念。 前两个元素：服务和路由是最重要的： </p><br><ul><li> 服务-我们希望向消费者提供访问权限的API。 因此，如果要使用InterSystems IRIS中的REST API，则它是一种服务，例如Google API。 </li><li> 路由决定应将传入请求重定向到哪个服务。 每个路由都有一组特定的条件，如果满足，则将请求发送到相应的服务。 例如，路由可能与IP，发送者的域，HTTP方法，URI的一部分或这些示例的组合匹配。 </li></ul><br><h2 id="servis"> 服务专区 </h2><br><p> 让我们创建具有以下值的InterSystems IRIS服务： </p><br><div class="scrollable-table"><table><thead><tr><th> 领域 </th><th> 价值 </th><th> 内容描述 </th></tr></thead><tbody><tr><td> 名 </td><td> 虹膜 </td><td> 服务名称 </td></tr><tr><td> 主持人 </td><td> 知识产权 </td><td>  InterSystems IRIS服务器主机或IP </td></tr><tr><td> 港口 </td><td>  52773 </td><td>  InterSystems IRIS服务器Web端口 </td></tr><tr><td> 路径 </td><td>  / api /工作室 </td><td> 根路径 </td></tr><tr><td> 协议 </td><td>  http </td><td> 协议书 </td></tr></tbody></table></div><br><p> 默认保留其余值。 单击<code>Create</code>按钮，并记下创建的服务的ID。 </p><br><h2 id="marshrut"> 路线 </h2><br><p> 现在让我们创建一条路线： </p><br><div class="scrollable-table"><table><thead><tr><th> 领域 </th><th> 价值 </th><th> 内容描述 </th></tr></thead><tbody><tr><td> 路径 </td><td>  / api /工作室 </td><td> 根路径 </td></tr><tr><td> 协议 </td><td>  http </td><td> 协议书 </td></tr><tr><td>  service.id </td><td>  guid从3 </td><td> 服务（上一步的ID） </td></tr></tbody></table></div><br><p> 默认保留其余值。 单击<code>Create</code>按钮，并记下创建的路线的ID。 默认情况下，IAM在端口8000上侦听传入的请求。现在，发送到<code>http://localhost:8000</code>并以<code>/api/atelier</code>开头的请求将重定向到InterSystems IRIS。 </p><br><h2 id="testirovanie"> 测试中 </h2><br><p> 让我们尝试在REST客户端中创建一个请求（我使用<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Postman</a> ）。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b83/f1c/480/b83f1c4808a89dc680168ae06248aefe.png" alt="邮递员中的REST请求"></p><br><p> 我们将GET请求发送到<code>http://localhost:8000/api/atelier/</code> （不要忘了<code>/</code>最后），并从InterSystems IRIS获得响应。 每个请求都会通过一个IAM来收集指标： </p><br><ul><li>  HTTP状态代码。 </li><li> 延误 </li><li> 监视（如果已配置）。 </li></ul><br><p> 我又提出了几个请求（包括对不存在的端点的两个请求，例如/ api / atelier / est /），结果在仪表板上立即可见： </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/a88/413/318/a88413318fa2bfe01827af2d6ee3d925.png" alt="带有一些指标的仪表板"></p><br><h1 id="rabota-s-plaginami"> 使用插件 </h1><br><p> 既然已经配置了Route，就可以控制我们的API。 我们可以添加补充我们服务的功能。 </p><br><p> 更改API行为的最常见方法是添加插件。 插件隔离各个功能，并且可以全局连接到IAM，并且只能连接到单个实体，例如用户（用户组），服务或路由。 我们将从在路线中添加“ Rate Limiting”插件开始。 为了在插件和路由之间建立连接，我们需要路由的唯一标识符（ID）。 </p><br><h2 id="ogranichenie-kolichestva-zaprosov"> 要求限制 </h2><br><p> 点击左侧栏中菜单中的插件。 您会在此屏幕上看到所有活动的插件，但是由于此IAM服务器是新的，因此尚无活动的插件。 因此，通过单击“新插件”继续进行下一步。 </p><br><p> 我们需要的插件位于“流量控制”类别中，称为“速率限制”。 选择它。 您可以在此处设置很多设置，但是我们只关心两个字段： </p><br><div class="scrollable-table"><table><thead><tr><th> 领域 </th><th> 价值 </th><th> 内容描述 </th></tr></thead><tbody><tr><td>  route_id </td><td> 编号 </td><td> 路线编号 </td></tr><tr><td>  config.minute </td><td>  5 </td><td> 每分钟的请求数 </td></tr></tbody></table></div><br><p> 仅此而已。 该插件已配置并处于活动状态。 我注意到我们可以选择不同的时间间隔，例如分钟，小时或天。 可以组合设置（例如，每小时1000个请求，同时每分钟100个请求）。 我选择了分钟，因为这很容易检查插件。 </p><br><p> 如果您再次将相同的请求发送给Postman，您将看到返回的响应包含两个额外的标头： </p><br><ul><li>  XRateLimit-Limit分钟：5 </li><li>  XRateLimit剩余分钟数：4 </li></ul><br><p> 这告诉客户，他每分钟最多可以发出5个请求，并且在当前时间间隔内，他可以发出另外4个请求。 </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/78b/0af/c02/78b0afc0269baad6b56ea4059dbdefe7.png" alt="限速"></p><br><p> 如果您一次又一次地发出相同的请求，最后您将用尽可用配额，而将收到带有以下响应正文的HTTP状态代码429： </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dcb/421/6bc/dcb4216bcf373f51ffe49d56d8bef8b4.png" alt="超出API"></p><br><p> 请稍等，您将能够再次发送请求。 </p><br><p> 这是一种方便的机制，可让您执行以下操作： </p><br><ul><li> 保护后端免受负载浪涌的影响。 </li><li> 告诉客户他们可以提出多少个要求。 </li><li> 通过API获利。 </li></ul><br><p> 您可以为不同的时间间隔设置值，从而在一定时间内平滑API流量。 假设您在特定路由上每小时允许600个请求。 每分钟平均有10个请求。 但是没有什么可以阻止客户在小时的第一分钟内完成所有600个请求。 也许这就是您所需要的。 您可能希望在一小时内达到更均匀的负载。 通过将<code>config.minute</code>字段的值设置为20，可以保证用户每分钟发出的请求不超过20个，每小时发出的请求不超过600个。 与每分钟10个请求的完全平均流相比，这允许在分钟间隔内进行较小的跳跃，但是用户不能在1分钟内使用每小时配额。 现在，他们至少需要30分钟才能使用所有查询。 在每个给定的时间间隔内，客户端将收到其他标头，例如： </p><br><div class="scrollable-table"><table><thead><tr><th>  HTTP头 </th><th> 价值 </th></tr></thead><tbody><tr><td>  X-RateLimit-Limit小时 </td><td>  600 </td></tr><tr><td>  X-RateLimit剩余时间 </td><td>  595 </td></tr><tr><td>  X-RateLimit-Limit分钟 </td><td>  20 </td></tr><tr><td>  X-RateLimit剩余分钟 </td><td>  16 </td></tr></tbody></table></div><br><p> 当然，根据您要实现的目标，有很多不同的方法来自定义查询限制。 </p><br><h1 id="vyvody"> 结论 </h1><br><p> 这是我要结束的地方，我认为有关第一本有关InterSystems API Manager的文章的材料已经足够了。 我们只使用了40多个插件中的一个。 您可以使用IAM做更多有趣的事情： </p><br><ul><li> 为您的所有API添加中央身份验证机制。 </li><li> 使用平衡器将负载扩展到多个服务。 </li><li> 在全面升级之前，为测试对象添加新功能和错误修复。 </li><li> 为内部和外部开发人员提供记录所有API的专用Web门户。 </li><li> 缓存请求以减少响应延迟并减少系统后端负载。 </li></ul><br><h1 id="ssylki"> 参考文献 </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">新闻发布</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">介绍视频</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">更详细的视频</a> </li><li>  <a href="">该文件</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">配置负载均衡器</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">录制有关API管理的网络研讨会</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN475670/">https://habr.com/ru/post/zh-CN475670/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN475656/index.html">2019年10月移动设备的病毒活动回顾</a></li>
<li><a href="../zh-CN475658/index.html">为什么要去DevOpsDays？ 为什么这不是另一个DevOps会议</a></li>
<li><a href="../zh-CN475662/index.html">我目前作为程序员的职业中最可耻的错误</a></li>
<li><a href="../zh-CN475666/index.html">虚拟现实中的50个UX技巧</a></li>
<li><a href="../zh-CN475668/index.html">烧光 恢复。 重新开始。 还是不行</a></li>
<li><a href="../zh-CN475672/index.html">用Python和Django编写聊天</a></li>
<li><a href="../zh-CN475674/index.html">关于没有海滩照片的完全远程工作市场</a></li>
<li><a href="../zh-CN475676/index.html">洞察力驱动：机器学习模型的高级分析和生命周期管理</a></li>
<li><a href="../zh-CN475678/index.html">我们如何教计算机素养牛奶供应商</a></li>
<li><a href="../zh-CN475684/index.html">@Pythonetc编译，2019年10月</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>