<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üõ∂ üßïüèø üéôÔ∏è [Fran√ßais] Comment Graal - Java JVM JVM Compiler Works üë®üèæ‚Äç‚úàÔ∏è ‚ÅâÔ∏è üôáüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Je vous pr√©sente la traduction de l'article " Comprendre le fonctionnement de Graal - un compilateur Java JIT √©crit en Java ". 
 Pr√©sen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>[Fran√ßais] Comment Graal - Java JVM JVM Compiler Works</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/419637/"><p> Bonjour, Habr!  Je vous pr√©sente la traduction de l'article " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Comprendre le fonctionnement de Graal - un compilateur Java JIT √©crit en Java</a> ". </p><br><h2 id="vvedenie">  Pr√©sentation </h2><br><p>  L'une des raisons pour lesquelles je suis devenu chercheur en langages de programmation est que, dans une grande communaut√© de personnes impliqu√©es dans la technologie informatique, presque tout le monde utilise des langages de programmation, et beaucoup sont int√©ress√©s par leur fonctionnement.  Quand j'ai d√©couvert la programmation quand j'√©tais enfant et que je me suis familiaris√© avec un langage de programmation, la premi√®re chose que je voulais savoir √©tait comment cela fonctionnait, et la toute premi√®re chose que je voulais faire √©tait de cr√©er mon propre langage. </p><br><p>  Dans cette pr√©sentation, je vais vous montrer certains des m√©canismes de travail du langage que vous utilisez tous - Java.  La particularit√© est que j'utiliserai un projet appel√© <em>Graal</em> , qui impl√©mente le concept de <em>Java en Java</em> . </p><a name="habracut"></a><br><p>  Graal n'est qu'un des composants du travail de Java - c'est un compilateur <em>juste √† temps</em> .  Il s'agit de la partie de la machine virtuelle Java qui convertit le bytecode Java en code machine pendant l'ex√©cution du programme, et est l'un des facteurs qui garantissent des performances √©lev√©es de la plate-forme.  C‚Äôest aussi, il me semble, ce que la plupart des gens consid√®rent comme l‚Äôune des parties les plus complexes et les plus vagues de la JVM, ce qui est au-del√† de leur compr√©hension.  Changer cette opinion est le but de ce discours. </p><br><p>  Si vous savez ce qu'est une JVM;  comprendre g√©n√©ralement ce que signifient les termes <em>bytecode</em> et <em>code machine</em> ;  et capable de lire du code √©crit en Java, alors, j'esp√®re, ce sera suffisant pour comprendre le mat√©riel pr√©sent√©. </p><br><p>  Je commencerai par expliquer pourquoi nous pourrions vouloir un nouveau compilateur JIT pour la machine virtuelle Java √©crit en Java, et apr√®s cela, je montrerai qu'il n'y a rien de sp√©cial √† cela, comme vous pourriez le penser, en d√©composant la t√¢che en assembleur, utilisation et d√©monstration du compilateur. que son code est le m√™me que dans toute autre application. </p><br><p>  J'aborderai un peu la th√©orie, puis je montrerai comment elle est appliqu√©e pendant tout le processus de compilation, du bytecode au code machine.  Je vais √©galement montrer quelques d√©tails, et √† la fin, nous parlerons des avantages de cette fonctionnalit√© en plus d'impl√©menter <em>Java en Java</em> pour lui-m√™me. </p><br><p>  J'utiliserai les captures d'√©cran du code dans Eclipse, au lieu de les lancer lors de la pr√©sentation, pour √©viter les in√©vitables probl√®mes de codage en direct. </p><br><h2 id="chto-takoe-jit-kompilyator">  Qu'est-ce qu'un compilateur JIT? </h2><br><p>  Je suis s√ªr que beaucoup d‚Äôentre vous savent ce qu‚Äôest un compilateur JIT, mais je vais quand m√™me aborder les principes de base afin que personne ne reste assis ici sans avoir peur de poser cette question principale. </p><br><p> Lorsque vous ex√©cutez la commande <code>javac</code> ou <em>compile-on-save</em> dans l'EDI, votre programme Java compile du code Java vers le bytecode JVM, qui est la repr√©sentation binaire du programme.  Il est plus compact et simple que le code source Java.  Cependant, le processeur standard de votre ordinateur portable ou serveur ne peut pas simplement ex√©cuter le bytecode JVM. </p><br><p>  Pour le fonctionnement de votre programme, la JVM interpr√®te ce bytecode.  Les interpr√®tes sont g√©n√©ralement beaucoup plus lents que le code machine ex√©cut√© sur le processeur.  Pour cette raison, la JVM, pendant l'ex√©cution du programme, peut lancer un autre compilateur qui convertit votre bytecode en code machine, que le processeur est d√©j√† capable d'ex√©cuter. </p><br><p>  Ce compilateur, g√©n√©ralement beaucoup plus sophistiqu√© que <code>javac</code> , effectue des optimisations complexes pour produire un code machine de haute qualit√©. </p><br><h2 id="zachem-pisat-jit-kompilyator-na-java">  Pourquoi √©crire un compilateur JIT en Java? </h2><br><p>  √Ä ce jour, une impl√©mentation JVM appel√©e <em>OpenJDK</em> comprend deux principaux compilateurs JIT.  Le compilateur client, appel√© <em>C1</em> , est con√ßu pour un fonctionnement plus rapide, mais produit en m√™me temps un code moins optimis√©.  Le compilateur de serveur, appel√© <em>opto</em> ou <em>C2</em> , n√©cessite un peu plus de temps pour fonctionner, mais produit un code plus optimis√©. </p><br><p>  L'id√©e √©tait que le compilateur client √©tait mieux adapt√© aux applications de bureau, o√π de longues pauses dans le compilateur JIT n'√©taient pas souhaitables, et le compilateur de serveur pour les applications de serveur √† longue dur√©e de jeu, qui pouvaient passer plus de temps √† compiler. </p><br><p>  Aujourd'hui, ils peuvent √™tre combin√©s pour que le code soit d'abord compil√© par C1, puis, s'il continue d'√™tre ex√©cut√© intensivement et qu'il est logique de passer du temps suppl√©mentaire, - C2.  C'est ce qu'on appelle la <em>compilation √† plusieurs niveaux</em> . </p><br><p>  Arr√™tons-nous sur C2, le compilateur de serveur qui effectue plus d'optimisations. </p><br><p>  Nous pouvons cloner OpenJDK depuis le miroir sur <em>GitHub</em> , ou simplement ouvrir l'arborescence du projet sur le site. </p><br><pre> <code class="hljs ruby">$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/dmlloyd</span></span><span class="hljs-regexp"><span class="hljs-regexp">/openjdk.git</span></span></code> </pre> <br><p>  Le code C2 se trouve dans <em>openjdk / hotspot / src / share / vm / opto</em> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/c2.png" alt="Source de code C2"></p><br><p>  Tout d'abord, il convient de noter que C2 est √©crit en <em>C ++</em> .  Bien s√ªr, ce n'est pas quelque chose de mauvais, mais il y a certains inconv√©nients.  C ++ est un langage dangereux.  Cela signifie que les erreurs en C ++ peuvent planter la machine virtuelle.  La raison en est probablement l'√¢ge du code, mais le code C2 C ++ est devenu tr√®s difficile √† maintenir et √† d√©velopper. </p><br><p>  L'une des figures cl√©s du compilateur C2, Cliff Click, a d√©clar√© qu'il n'√©crirait plus jamais de machine virtuelle en C ++, et nous avons entendu l'√©quipe <em>Twitter</em> JVM dire que C2 stagne et doit √™tre remplac√© pour une raison difficult√©s de d√©veloppement ult√©rieur. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-1.jpeg" alt="Pr√©sentation falaise click"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/click-2.png" alt="Ce que Cliff Click ne veut plus refaire"></p><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.youtube.com/watch?v=Hqw57GJSrac</a> </p><br><p>  Donc, revenons √† la question, qu'est-ce que c'est en Java qui peut aider √† r√©soudre ces probl√®mes?  La m√™me chose qui donne l'√©criture d'un programme en Java au lieu de C ++.  Il s'agit probablement de s√©curit√© (exceptions au lieu de plantages, pas de v√©ritable fuite de m√©moire ou pointeurs pendants), de bons <em>assistants</em> (d√©bogueurs, profileurs et outils comme <em>VisualVM</em> ), un bon support IDE, etc. </p><br><p>  Vous pourriez penser: <em>Comment puis-je √©crire quelque chose comme un compilateur Java JIT?</em>  , et que cela n'est possible que dans un langage de programmation syst√®me de bas niveau tel que C ++.  Dans cette pr√©sentation, j'esp√®re vous convaincre que ce n'est pas du tout!  Essentiellement, le compilateur JIT devrait simplement accepter le bytecode JVM et donner le code machine - vous lui donnez l' <code>byte[]</code> √† l'entr√©e, et vous voulez aussi r√©cup√©rer l' <code>byte[]</code> .  Cela prend beaucoup de travail complexe pour ce faire, mais cela n'affecte pas le niveau du syst√®me et ne n√©cessite donc pas un langage <em>syst√®me</em> tel que C ou C ++. </p><br><h2 id="nastroyka-graal">  Configuration de Graal </h2><br><p>  La premi√®re chose dont nous avons besoin est Java 9. L'interface Graal utilis√©e, appel√©e <em>JVMCI, a</em> √©t√© ajout√©e √† Java dans le cadre de l' <em>interface du compilateur JVM de niveau Java JEP 243</em> et la premi√®re version qui l'inclut est Java 9. J'utilise <em>9 + 181</em> .  En cas d'exigences particuli√®res, il existe des ports (backports) pour Java 8. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> export JAVA_HOME=`pwd`/jdk9 <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=<span class="hljs-variable"><span class="hljs-variable">$JAVA_HOME</span></span>/bin:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> java <span class="hljs-literal"><span class="hljs-literal">-version</span></span> java version <span class="hljs-string"><span class="hljs-string">"9"</span></span> Java(TM) SE Runtime Environment (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>) Java HotSpot(TM) <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-Bit</span></span> Server VM (build <span class="hljs-number"><span class="hljs-number">9</span></span>+<span class="hljs-number"><span class="hljs-number">181</span></span>, mixed mode)</code> </pre> <br><p>  La prochaine chose dont nous avons besoin est un syst√®me de construction appel√© <code>mx</code> .  C'est un peu comme <em>Maven</em> ou <em>Gradle</em> , mais vous ne le choisiriez probablement pas pour votre application.  Il impl√©mente certaines fonctionnalit√©s pour prendre en charge certains cas d'utilisation complexes, mais nous ne l'utiliserons que pour des assemblys simples. </p><br><p>  Vous pouvez cloner <code>mx</code> avec GitHub.  J'utilise le commit <code>#7353064</code> .  Maintenant, ajoutez simplement l'ex√©cutable au chemin. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/mx.git <span class="hljs-variable"><span class="hljs-variable">$</span></span> cd mx; git checkout <span class="hljs-number"><span class="hljs-number">7353064</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> export PATH=`pwd`/mx:<span class="hljs-variable"><span class="hljs-variable">$PATH</span></span></code> </pre> <br><p>  Maintenant, nous devons cloner Graal lui-m√™me.  J'utilise une distribution appel√©e <em>GraalVM</em> version <em>0.28.2</em> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> git clone https://github.com/graalvm/graal.git -<span class="hljs-literal"><span class="hljs-literal">-branch</span></span> vm<span class="hljs-literal"><span class="hljs-literal">-enterprise</span></span><span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span></code> </pre> <br><p>  Ce r√©f√©rentiel contient d'autres projets qui ne nous int√©ressent pas, nous allons donc simplement dans le sous-projet du <em>compilateur</em> , qui est le compilateur Graal JIT, et le compilons en utilisant <code>mx</code> . </p><br><pre> <code class="hljs ruby">$ cd graal/compiler $ mx build</code> </pre> <br><p>  Pour travailler avec le code Graal, j'utiliserai l' <em>IDE Eclipse</em> .  J'utilise Eclipse 4.7.1.  <code>mx</code> peut g√©n√©rer des fichiers de projet Eclipse pour nous. </p><br><pre> <code class="hljs ruby">$ mx eclipseinit</code> </pre> <br><p>  Pour ouvrir le r√©pertoire <em>graal en</em> tant <em>qu'espace</em> de <em>travail,</em> vous devez ex√©cuter <em>Fichier, Importer ..., G√©n√©ral, Projets existants</em> et s√©lectionner √† <em>nouveau le</em> r√©pertoire <em>graal</em> .  Si vous n'avez pas ex√©cut√© Eclipse sur Java 9, vous devrez peut-√™tre √©galement attacher les sources JDK. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/eclipse.png" alt="Graal dans eclipse"></p><br><p>  Bon.  Maintenant que tout est pr√™t, voyons comment cela fonctionne.  Nous utiliserons ce code tr√®s simple. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Demo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { workload(<span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; } }</code> </pre> <br><p>  Tout d'abord, nous compilons ce code <code>javac</code> , puis ex√©cutons la JVM.  Tout d'abord, je vais vous montrer comment fonctionne le compilateur C2 JIT standard.  Pour ce faire, nous indiquerons plusieurs indicateurs: <code>-XX:+PrintCompilation</code> , qui est n√©cessaire pour que la machine <code>-XX:+PrintCompilation</code> √©crive un journal lors de la compilation de la m√©thode, et <code>-XX:CompileOnly=Demo::workload</code> , de sorte que seule cette m√©thode soit compil√©e.  Si nous ne le faisons pas, alors trop d'informations seront affich√©es, et la JVM sera plus intelligente que n√©cessaire, et optimisera le code que nous voulons voir. </p><br><pre> <code class="hljs ruby">$ javac Demo.java $ java \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>+PrintCompilation \ -<span class="hljs-symbol"><span class="hljs-symbol">XX:</span></span>CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">113</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><p>  Je n'expliquerai pas cela en d√©tail, mais je dirai seulement qu'il s'agit d'une sortie de journal qui montre que la m√©thode de <code>workload</code> √©t√© compil√©e. </p><br><p>  Maintenant, en tant que compilateur JIT de notre JVM Java 9, nous utilisons le Graal fra√Æchement compil√©.  Pour ce faire, ajoutez quelques indicateurs suppl√©mentaires. </p><br><p>  <code>--module-path=...</code> et <code>--upgrade-module-path=...</code> ajoutez Graal au <em>chemin</em> du <em>module</em> .  Permettez-moi de vous rappeler que le <em>chemin du module</em> est apparu dans Java 9 dans le cadre du syst√®me de modules <em>Jigsaw</em> , et pour nos besoins, nous pouvons le consid√©rer par analogie avec <em>classpath</em> . </p><br><p>  Nous avons besoin de l' <code>-XX:+UnlockExperimentalVMOptions</code> car JVMCI (l'interface utilis√©e par Graal) dans cette version est une fonctionnalit√© exp√©rimentale. </p><br><p>  L'indicateur <code>-XX:+EnableJVMCI</code> n√©cessaire pour dire que nous voulons utiliser JVMCI, et <code>-XX:+UseJVMCICompiler</code> - pour activer et installer un nouveau compilateur JIT. </p><br><p>  Afin de ne pas compliquer l'exemple et, au lieu d'utiliser C1 en conjonction avec le JVMCI, d'avoir uniquement le compilateur JVMCI, sp√©cifiez l'indicateur <code>-XX:-TieredCompilation</code> , qui d√©sactivera la compilation pas √† pas. </p><br><p>  Comme pr√©c√©demment, nous <code>-XX:+PrintCompilation</code> les indicateurs <code>-XX:+PrintCompilation</code> et <code>-XX:CompileOnly=Demo::workload</code> . </p><br><p>  Comme dans l'exemple pr√©c√©dent, nous voyons qu'une m√©thode a √©t√© compil√©e.  Mais, cette fois, pour la compilation, nous avons utilis√© Graal juste assembl√©.  Pour l'instant, prenez ma parole. </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo ... <span class="hljs-number"><span class="hljs-number">583</span></span> <span class="hljs-number"><span class="hljs-number">25</span></span> Demo::workload (<span class="hljs-number"><span class="hljs-number">4</span></span> bytes) ...</code> </pre> <br><h2 id="interfeys-kompilyatora-jvm">  Interface du compilateur JVM </h2><br><p>  Ne pensez-vous pas que nous avons fait quelque chose d'assez inhabituel?  Nous avons une JVM install√©e et nous avons remplac√© le compilateur JIT par le nouveau juste compil√© sans rien changer dans la JVM elle-m√™me.  Cette fonctionnalit√© est fournie par une nouvelle interface JVM appel√©e JVMCI, l' <em>interface du compilateur JVM</em> , qui, comme je l'ai dit ci-dessus, √©tait <em>JEP 243</em> et est venue en Java 9. </p><br><p>  L'id√©e est similaire √† certaines autres technologies JVM existantes. </p><br><p>  Vous avez peut-√™tre d√©j√† rencontr√© du traitement de code source suppl√©mentaire dans <code>javac</code> √† l'aide de l' <em>API de traitement d'annotations Java</em> .  Ce m√©canisme permet d'identifier les annotations et le mod√®le de code source dans lequel elles sont utilis√©es, et de cr√©er de nouveaux fichiers √† partir de celles-ci. </p><br><p>  De plus, vous avez peut-√™tre utilis√© un traitement suppl√©mentaire de bytecode dans la JVM √† l'aide d' <em>agents Java</em> .  Ce m√©canisme vous permet de modifier le bytecode Java en l'interceptant au d√©marrage. </p><br><p>  L'id√©e de JVMCI est similaire.  Il vous permet de connecter votre propre compilateur Java JIT √©crit en Java. </p><br><p>  Maintenant, je veux dire quelques mots sur la fa√ßon dont je vais montrer le code lors de cette pr√©sentation.  Tout d'abord, pour comprendre l'id√©e, je vais montrer des identificateurs et une logique simplifi√©s sous forme de texte sur des diapositives, puis je passerai aux captures d'√©cran d'Eclipse et afficherai le vrai code, ce qui peut √™tre un peu plus compliqu√©, mais l'id√©e principale restera la m√™me.  La partie principale de cette pr√©sentation est destin√©e √† montrer qu'il est vraiment possible de travailler avec le vrai code du projet, et donc je ne veux pas le cacher, m√™me si cela peut √™tre quelque peu compliqu√©. </p><br><p>  A partir de maintenant, je commence √† dissiper l'opinion que vous pourriez avoir que le compilateur JIT est tr√®s compliqu√©. </p><br><p>  Qu'est-ce que le compilateur JIT accepte en entr√©e?  Il accepte le bytecode de la m√©thode √† compiler.  Et le bytecode, comme son nom l'indique, n'est qu'un tableau d'octets. </p><br><p>  Qu'est-ce que le compilateur JIT produit en cons√©quence?  Il donne le code machine de la m√©thode.  Le code machine n'est √©galement qu'un tableau d'octets. </p><br><p>  Par cons√©quent, l'interface qui doit √™tre impl√©ment√©e lors de l'√©criture d'un nouveau compilateur JIT pour l'incorporer dans la JVM ressemblera √† ceci. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] compileMethod(<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] bytecode); }</code> </pre> <br><p>  Par cons√©quent, si vous ne pouviez pas imaginer comment Java peut faire quelque chose d'aussi bas niveau que la compilation JIT dans le code machine, vous pouvez maintenant voir que ce n'est pas un travail de si bas niveau.  Non?  C'est juste une fonction de l' <code>byte[]</code> √† l' <code>byte[]</code> . </p><br><p>  En r√©alit√©, tout est un peu plus compliqu√©.  Le simple bytecode ne suffit pas - nous avons √©galement besoin de plus d'informations, telles que le nombre de variables locales, la taille de pile requise et les informations collect√©es par le profileur d'interpr√©teur pour comprendre comment le code est ex√©cut√© en fait.  Par cons√©quent, imaginez l'entr√©e sous la forme de <code>CompilationRequest</code> , qui nous renseignera sur la <code>JavaMethod</code> qui doit √™tre compil√©e et fournira toutes les informations n√©cessaires. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilationRequest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">JavaMethod </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaMethod</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getCode(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxLocals</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMaxStackSize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ProfilingInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProfilingInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; ... }</code> </pre> <br><p>  De plus, l'interface ne n√©cessite pas le retour de code compil√©.  Au lieu de cela, une autre API est utilis√©e pour installer le code machine dans la JVM. </p><br><pre> <code class="java hljs">HotSpot.installCode(targetCode);</code> </pre> <br><p>  Maintenant, pour √©crire un nouveau compilateur JIT pour la JVM, il vous suffit d'impl√©menter cette interface.  Nous obtenons des informations sur la m√©thode qui doit √™tre compil√©e, et nous devons la compiler en code machine et appeler <code>installCode</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ HotSpot.installCode(...); } }</code> </pre> <br><p>  Passons √† l'IDE Eclipse avec Graal et jetons un ≈ìil √† certaines interfaces et classes r√©elles.  Comme mentionn√© pr√©c√©demment, ils seront un peu plus compliqu√©s, mais pas de beaucoup. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/jvmci-compiler-interface.png" alt="JVMCICompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-1.png" alt="HotSpotGraalCompiler"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-2.png" alt="compileMethod"></p><br><p>  Maintenant, je veux montrer que nous pouvons apporter des modifications √† Graal et les utiliser imm√©diatement en Java 9. J'ajouterai un nouveau message de journal qui sera affich√© lors de la compilation de la m√©thode √† l'aide de Graal.  Ajoutez-le √† la m√©thode d'interface impl√©ment√©e, qui est appel√©e par le JVMCI. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(<span class="hljs-string"><span class="hljs-string">"Going to compile "</span></span> + request.getMethod().getName()); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/hotspot-graal-compiler-3.png" alt="Compilation"></p><br><p>  Pour l'instant, d√©sactivez la journalisation de la compilation dans HotSpot.  Nous pouvons maintenant voir notre message depuis la version modifi√©e du compilateur. </p><br><pre> <code class="java hljs">$ java \ --<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ --upgrade-<span class="hljs-keyword"><span class="hljs-keyword">module</span></span>-path=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ -XX:+UnlockExperimentalVMOptions \ -XX:+EnableJVMCI \ -XX:+UseJVMCICompiler \ -XX:-TieredCompilation \ -XX:CompileOnly=Demo::workload \ Demo Going to compile workload</code> </pre> <br><p>  Si vous essayez de r√©p√©ter cela vous-m√™me, vous remarquerez que vous n'avez m√™me pas besoin d'ex√©cuter notre syst√®me de construction - <code>mx build</code> .  Assez, normal pour Eclipse, <em>compilez lors de la sauvegarde</em> .  Et nous n'avons certainement pas besoin de reconstruire la JVM elle-m√™me.  Nous int√©grons simplement le compilateur modifi√© dans la JVM existante. </p><br><h2 id="graf-graal">  Comte Graal </h2><br><p>  Eh bien, nous savons que Graal convertit un <code>byte[]</code> en un autre <code>byte[]</code> .  Parlons maintenant de la th√©orie et des structures de donn√©es qu'il utilise, car  ils sont un peu inhabituels m√™me pour le compilateur. </p><br><p>  Essentiellement, le compilateur g√®re votre programme.  Pour cela, le programme doit √™tre pr√©sent√© sous la forme d'une sorte de structure de donn√©es.  Une option est le bytecode et les listes d'instructions similaires, mais elles ne sont pas tr√®s expressives. </p><br><p>  Au lieu de cela, Graal utilise un graphique pour repr√©senter votre programme.  Si nous prenons un op√©rateur d'addition simple qui r√©sume deux variables locales, le graphique comprendra un n≈ìud pour le chargement de chaque variable, un n≈ìud pour la somme et deux ar√™tes qui montrent que le r√©sultat du chargement des variables locales est entr√© dans l'op√©rateur d'addition. </p><br><p>  Ceci est parfois appel√© un <em>graphique de d√©pendance de programme</em> . </p><br><p>  Ayant une expression de la forme <code>x + y</code> on obtient des n≈ìuds pour les variables locales <code>x</code> et <code>y</code> , et un n≈ìud de leur somme. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/data-graph.png" alt="Graphique de flux de donn√©es"></p><br><p>  Les bords bleus de ce graphique indiquent la direction du flux de donn√©es, de la lecture des variables locales √† la sommation. </p><br><p>  De plus, nous pouvons utiliser des bords pour refl√©ter l'ordre d'ex√©cution du programme.  Si, au lieu de lire des variables locales, nous appelons des m√©thodes, alors nous devons nous souvenir de l'ordre de l'appel, et nous ne pouvons pas les r√©organiser (sans conna√Ætre le code √† l'int√©rieur).  Pour ce faire, des ar√™tes suppl√©mentaires d√©finissent cet ordre.  Ils sont affich√©s en rouge. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/control-graph.png" alt="Graphique de flux de contr√¥le"></p><br><p>  Ainsi, le graal graal, en fait, est deux graphiques combin√©s en un seul.  Les n≈ìuds sont les m√™mes, mais certains bords indiquent la direction du flux de donn√©es, tandis que d'autres montrent le transfert de contr√¥le entre eux. </p><br><p>  Pour voir le graphique Graal, vous pouvez utiliser un outil appel√© <em>IdealGraphVisualiser</em> ou <em>IGV</em> .  Le d√©marrage est effectu√© √† l'aide de la <code>mx igv</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/igv.png" alt="IdealGraphVisualiser"></p><br><p>  Apr√®s cela, ex√©cutez la machine <code>-Dgraal.Dump</code> avec l'indicateur <code>-Dgraal.Dump</code> . </p><br><p>  Un flux de donn√©es simple peut √™tre vu en √©crivant une expression simple. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) / <span class="hljs-number"><span class="hljs-number">2</span></span>; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average.png" alt="Moyenne arithm√©tique igv"></p><br><p>  Vous pouvez voir comment les param√®tres <code>0</code> ( <code>P(0</code> ) et <code>1</code> ( <code>P(1)</code> ) vont √† l'entr√©e de l'op√©ration d'addition, qui, avec la constante <code>2</code> ( <code>C(2)</code> ) va √† l'entr√©e de l'op√©ration de division, apr√®s quoi cette valeur est retourn√©e. </p><br><p>  Afin d'examiner un flux de donn√©es et de contr√¥le plus complexe, nous introduisons un cycle. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">average</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] values)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sum = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> n = <span class="hljs-number"><span class="hljs-number">0</span></span>; n &lt; values.length; n++) { sum += values[n]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sum / values.length; }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop.png" alt="Moyenne arithm√©tique igv avec cycle"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/average-loop-detail.png" alt="Igv moyen arithm√©tique d√©taill√© avec boucle"></p><br><p>  Dans ce cas, nous avons des n≈ìuds du d√©but et de la fin de la boucle, lisant les √©l√©ments du tableau et lisant la longueur du tableau.  Comme pr√©c√©demment, les lignes bleues indiquent la direction du flux de donn√©es et les lignes rouges indiquent le flux de contr√¥le. </p><br><p>  Vous pouvez maintenant voir pourquoi cette structure de donn√©es est parfois appel√©e la <em>mer de n≈ìuds</em> ou la <em>soupe de n≈ìuds</em> . </p><br><p>  Je veux dire que C2 utilise une structure de donn√©es tr√®s similaire, et, en fait, c'est C2 qui a popularis√© l'id√©e d'un compilateur d'une <em>mer de n≈ìuds</em> , donc ce n'est pas une innovation de Graal. </p><br><p>  Je ne montrerai pas le processus de construction de ce graphique jusqu'√† la prochaine partie de la pr√©sentation, mais lorsque Graal re√ßoit le programme dans ce format, l'optimisation et la compilation sont effectu√©es en modifiant cette structure de donn√©es.  Et c'est l'une des raisons pour lesquelles l'√©criture d'un compilateur JIT en Java est logique.  Java est un langage orient√© objet, et un graphe est une collection d'objets reli√©s par des bords sous forme de liens. </p><br><h2 id="ot-baytkoda-k-mashinnomu-kodu">  Du bytecode au code machine </h2><br><p>  Voyons √† quoi ces id√©es ressemblent dans la pratique et suivons quelques √©tapes du processus de compilation. </p><br><h3 id="poluchenie-baytkoda">  Obtenir le Bytecode </h3><br><p>  La compilation commence par le bytecode.  Revenons √† notre petit exemple de sommation. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + b; }</code> </pre> <br><p>  Nous afficherons le bytecode re√ßu √† l'entr√©e juste avant le d√©but de la compilation. </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationRequestResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CompilationRequest request)</span></span></span><span class="hljs-function"> </span></span>{ System.err.println(request.getMethod().getName() + <span class="hljs-string"><span class="hljs-string">" bytecode: "</span></span> + Arrays.toString(request.getMethod().getCode())); ... } }</code> </pre> <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">workload</span></span> bytecode: [<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>]</code> </pre> <br><p>  Comme vous pouvez le voir, l'entr√©e du compilateur est du bytecode. </p><br><h3 id="parser-baytkoda-i-postroitel-grafa">  Analyseur de bytecode et g√©n√©rateur de graphiques </h3><br><p>  <em>Le g√©n√©rateur</em> , percevant ce tableau d'octets comme le bytecode JVM, le convertit en graal graal.  Il s'agit d'une sorte d' <em>interpr√©tation abstraite</em> - le g√©n√©rateur interpr√®te le bytecode Java, mais, au lieu de transmettre des valeurs, manipule les extr√©mit√©s libres des bords et les connecte progressivement les unes aux autres. </p><br><p>  Profitons du fait que Graal est √©crit en Java et voyons comment cela fonctionne √† l'aide des outils de navigation Eclipse.  Nous savons que dans notre exemple, il y a un n≈ìud d'addition, alors trouvons o√π il est cr√©√©. </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-1.png" alt="Addnode"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-2.png" alt="Rechercher des appels AddNode.create"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/parser-3.png" alt="Analyseur"></p><br><p>  On peut voir qu'ils sont cr√©√©s par l'analyseur de bytecode, et cela nous a conduit au <code>IADD</code> traitement <code>IADD</code> ( <code>96</code> , que nous avons vu dans le tableau d'entr√©e imprim√©). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">genArithmeticOp</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(JavaKind kind, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> opcode)</span></span></span><span class="hljs-function"> </span></span>{ ValueNode y = frameState.pop(kind); ValueNode x = frameState.pop(kind); ValueNode v; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (opcode) { ... <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> LADD: v = genIntegerAdd(x, y); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; ... } frameState.push(kind, append(v)); }</code> </pre> <br><p>  J'ai dit plus haut qu'il s'agit d'une interpr√©tation abstraite, car  tout cela est tr√®s similaire √† un interpr√©teur de bytecode.  S'il s'agissait d'un v√©ritable interpr√©teur JVM, il faudrait alors retirer deux valeurs de la pile, effectuer un ajout et remettre le r√©sultat.  Dans ce cas, nous supprimons deux n≈ìuds de la pile, qui, au d√©marrage du programme, seront des calculs, ajouterons, qui est le r√©sultat de la sommation, un nouveau n≈ìud √† ajouter et le placerons sur la pile. </p><br><p>  Ainsi le graphe est construit Graal. </p><br><h3 id="poluchenie-mashinnogo-koda">  Obtention du code machine </h3><br><p>  Pour convertir un graphique Graal en code machine, vous devez g√©n√©rer des octets pour tous ses n≈ìuds.  Cela se fait s√©par√©ment pour chaque n≈ìud en appelant sa m√©thode <code>generate</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Generator gen)</span></span></span><span class="hljs-function"> </span></span>{ gen.emitAdd(a, b); }</code> </pre> <br><p>  Je le r√©p√®te, nous travaillons ici √† un niveau d'abstraction tr√®s √©lev√©.  Nous avons une classe avec laquelle nous √©mettons des instructions de code machine sans entrer dans les d√©tails de la fa√ßon dont cela fonctionne. </p><br><p>  <code>emitAdd</code>       ,          , ,  ,       .      . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> a + <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>       ,        . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">incl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Register dst)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> encode = prefixAndEncode(dst.encoding); emitByte(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); emitByte(<span class="hljs-number"><span class="hljs-number">0xC0</span></span> | encode); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">emitByte</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ data.put((<span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>) (b &amp; <span class="hljs-number"><span class="hljs-number">0xFF</span></span>)); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/incl.png" alt="Instruction de montage dans l'assembleur"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-byte.png" alt="Sortie d'octets"></p><br><p>  ,    ,     <code>ByteBuffer</code> ‚Äî    . </p><br><h3 id="vyhodnoy-mashinnyy-kod">    </h3><br><p>               ‚Äî       . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HotSpotGraalCompiler</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JVMCICompiler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">CompilationResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">compileHelper</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... System.err.println(method.getName() + <span class="hljs-string"><span class="hljs-string">" machine code: "</span></span> + Arrays.toString(result.getTargetCode())); ... } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/machine-code.png" alt="Code machine d'impression"></p><br><p>           .    HotSpot.     .     OpenJDK, , -,     JVM,      . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cd openjdk/hotspot/src/share/tools/hsdis <span class="hljs-variable"><span class="hljs-variable">$</span></span> curl <span class="hljs-literal"><span class="hljs-literal">-O</span></span> http://ftp.heanet.ie/mirrors/gnu/binutils/binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> tar <span class="hljs-literal"><span class="hljs-literal">-xzf</span></span> binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span>.tar.gz <span class="hljs-variable"><span class="hljs-variable">$</span></span> make BINUTILS=binutils<span class="hljs-literal"><span class="hljs-literal">-2</span></span>.<span class="hljs-number"><span class="hljs-number">24</span></span> ARCH=amd64 CFLAGS=<span class="hljs-literal"><span class="hljs-literal">-Wno</span></span><span class="hljs-literal"><span class="hljs-literal">-error</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> cp build/macosx<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>/hsdis<span class="hljs-literal"><span class="hljs-literal">-amd64</span></span>.dylib ../../../../../..</code> </pre> <br><p>      : <code>-XX:+UnlockDiagnosticVMOptions</code>  <code>-XX:+PrintAssembly</code> . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> java \ -<span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/sdk/mxbuild/modules/org.graalvm.graal_sdk.jar:graal/truffle/mxbuild/modules/com.oracle.truffle.truffle_api.jar \ -<span class="hljs-literal"><span class="hljs-literal">-upgrade</span></span><span class="hljs-literal"><span class="hljs-literal">-module</span></span><span class="hljs-literal"><span class="hljs-literal">-path</span></span>=graal/compiler/mxbuild/modules/jdk.internal.vm.compiler.jar \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockExperimentalVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+EnableJVMCI \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UseJVMCICompiler \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:<span class="hljs-literal"><span class="hljs-literal">-TieredCompilation</span></span> \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintCompilation \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+UnlockDiagnosticVMOptions \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:+PrintAssembly \ <span class="hljs-literal"><span class="hljs-literal">-XX</span></span>:CompileOnly=Demo::workload \ Demo</code> </pre> <br><p>             . </p><br><pre> <code class="hljs perl">workload machine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] ... <span class="hljs-number"><span class="hljs-number">0x000000010f71cda0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda5</span></span>: add %edx,%esi ;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x000000010f71cda9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0xcba8da9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x0000000102b74006 ; {poll_return} 0x000000010f71cdaf: vzeroupper 0x000000010f71cdb2: retq</span></span></code> </pre> <br><p> .  ,           .    <code>generate</code>   ,         . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AddNode</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">generate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span><span class="hljs-function"> </span></span>{ ... gen.emitSub(op1, op2, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>) ... <span class="hljs-comment"><span class="hljs-comment">// changed from emitAdd } }</span></span></code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/emit-add.png" alt="Probl√®me de l'instruction AddNode"></p><br><p>    ,  ,      ,      . </p><br><pre> <code class="hljs perl">workload mechine code: [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, ...] <span class="hljs-number"><span class="hljs-number">0x0000000107f451a0</span></span>: nopl <span class="hljs-number"><span class="hljs-number">0x0</span></span>(%rax,%rax,<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a5</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> %</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edx</span></span></span><span class="hljs-function">,%</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">esi</span></span></span><span class="hljs-function"> </span></span>;\*iadd {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@2 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a7</span></span>: mov %esi,%eax ;\*ireturn {reexecute=<span class="hljs-number"><span class="hljs-number">0</span></span> rethrow=<span class="hljs-number"><span class="hljs-number">0</span></span> return_oop=<span class="hljs-number"><span class="hljs-number">0</span></span>} ; - Demo::workload@3 (line <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-number"><span class="hljs-number">0x0000000107f451a9</span></span>: test %eax,-<span class="hljs-number"><span class="hljs-number">0x1db81a9</span></span>(%rip) <span class="hljs-comment"><span class="hljs-comment"># 0x000000010618d006 ; {poll_return} 0x0000000107f451af: vzeroupper 0x0000000107f451b2: retq</span></span></code> </pre> <br><p> ,   ? Graal     ;         ;       ;    .  ,       Graal. </p><br><pre> <code class="hljs powershell">[<span class="hljs-number"><span class="hljs-number">26</span></span>, <span class="hljs-number"><span class="hljs-number">27</span></span>, <span class="hljs-number"><span class="hljs-number">96</span></span>, -<span class="hljs-number"><span class="hljs-number">84</span></span>] ‚Üí [<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-number"><span class="hljs-number">68</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">43</span></span>, -<span class="hljs-number"><span class="hljs-number">14</span></span>, -<span class="hljs-number"><span class="hljs-number">117</span></span>, -<span class="hljs-number"><span class="hljs-number">58</span></span>, -<span class="hljs-number"><span class="hljs-number">123</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-type"><span class="hljs-type">...</span></span>]</code> </pre> <br><h2 id="optimizaciya">  </h2><br><p>  ,     ,        .       Graal  ,    . </p><br><p> <em> </em> ‚Äî          .      . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Phase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Graph graph)</span></span></span></span>; }</code> </pre> <br><h3 id="kanonikalizaciya-canonicalisation">  (canonicalisation) </h3><br><p> <em></em>      .       ,       ,      <em> </em> ( <em>constant folding</em> )   . </p><br><p>       ‚Äî       <code>canonical</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><p> ,  ,    ,      .                  ‚Äî    .    <code>-(-x)</code>  <code>x</code> . </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NegateNode</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Node</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">Node </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">canonical</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> NegateNode) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((NegateNode) value).getValue(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/negate-node.png" alt="findSynonym dans NegateNode"></p><br><p>       Graal   . ,       . </p><br><p>           Java,       <code>canonical</code> . </p><br><h3 id="global-value-numbering"> Global value numbering </h3><br><p> <em>Global value numbering (GVN)</em> ‚Äî       .    <code>a + b</code>    ,   ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (a + b) * (a + b); }</code> </pre> <br><p> Graal     .   ‚Äî        .   GVN         .        <em>hash map</em>  ,  ,  . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn.png" alt="Num√©rotation de valeur globale"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-1.png" alt="Graphique de num√©rotation de la valeur globale"></p><br><p>    ,   <em></em> ‚Äî  ,      ,     -  .  ,  ,  ,       ,      ‚Äî . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (getA() + getB()) * (getA() + getB()); }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/gvn-igv-2.png" alt="Un graphique qui ne peut pas √™tre num√©rot√© en valeur globale"></p><br><h3 id="ukrupnenie-blokirovok-lock-coarsening">   (lock coarsening) </h3><br><p>     .               <em></em> . ,     ,      ,   <em></em> ( <em>inlining</em> ). </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } <span class="hljs-keyword"><span class="hljs-keyword">synchronized</span></span> (monitor) { counter++; } }</code> </pre> <br><p>   ,   , , , . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; monitor.exit(); monitor.enter(); counter++; monitor.exit(); }</code> </pre> <br><p>                    .    <em> </em> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter++; counter++; monitor.exit(); }</code> </pre> <br><p>  Graal       <code>LockEliminationPhase</code> .   <code>run</code>      ,         .  ,        ,           . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(StructuredGraph graph)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (monitorExitNode monitorExitNode : graph.getNodes(MonitorExitNode.class)) { FixedNode next = monitorExitNode.next(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (next <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> monitorEnterNode) { AccessmonitorNode monitorEnterNode = (AccessmonitorNode) next; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (monitorEnterNode.object() ## monitorExitNode.object()) { monitorExitNode.remove(); monitorEnterNode.remove(); } } } }</code> </pre> <br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination.png" alt="Simplification du verrouillage"></p><br><p>            , , ,      ,          <code>2</code> . </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">workload</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ monitor.enter(); counter += <span class="hljs-number"><span class="hljs-number">2</span></span>; monitor.exit(); }</code> </pre> <br><p>    IGV   .  ,   ,       \   ,  , ,        <code>2</code> . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-before.png" alt="Simplifiez les verrous pour"></p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/lock-elimination-after.png" alt="Simplifiez les verrous apr√®s"></p><br><h2 id="ne-zatronutye-prakticheskie-aspekty">     </h2><br><p>   Graal   ,  ,      ,          . , , ,          . </p><br><p>       Graal   ,  , ,         ,    ,  ,    . </p><br><h3 id="naznachenie-registrov">   </h3><br><p>    Graal      ,   ,  .        ?          ,      ? </p><br><p> ,  ,    .      .       ,      , ,   ,    .        ,  ,  ,             , ,  . </p><br><p>        <em> </em> ( <em>register allocation</em> ). Graal ,    JIT-,    ‚Äî <em>  </em> ( <em>linear scan algorithm</em> ). </p><br><h3 id="dispetcherizaciya">  </h3><br><p>    ,     ,   ,        -    ,         . </p><br><p> ,       ,   , ,         (..     ),        . ,    ,     . </p><br><p>    <em> </em> ( <em>graph scheduling</em> ).       .       ,          .       ,      , ,        . </p><br><p>                ,     . </p><br><h2 id="v-kakih-sluchayah-ispolzovat-graal">     Graal? </h2><br><p>        , ,   , Graal ‚Äî   ,       <em>Oracle</em> .      ,    Graal? </p><br><h3 id="kompilyator-nizhnego-urovnya-final-tier-compiler">    (final-tier compiler) </h3><br><p> C  JVMCI Graal    <em>  </em>  HotSpot ‚Äî ,     .     (   HotSpot)   Graal    ,    . </p><br><p> <em>Twitter</em>       Graal   ,    Java 9           .       : <code>-XX:+UseJVMCICompiler</code>  . </p><br><p>    JVMCI   ,      Graal   JVM.    (deploy) -  JVM,      Graal.      Java-,   Graal,       JVM. </p><br><p>  OpenJDK   <em>Metropolis</em>       JVM   Java. Graal        . </p><br><p><img src="https://chrisseaton.com/truffleruby/jokerconf17/metropolis.png" alt="Projet Metropolis"></p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">http://cr.openjdk.java.net/\~jrose/metropolis/Metropolis-Proposal.html</a> </p><br><h3 id="polzovatelskie-optimizacii">   </h3><br><p> Graal    .    Graal   JVM,     Graal   .           ,  Graal       . ,     -     ,    ,                 JNI. </p><br><p> Charles Nutter      <em>JRuby</em>         Graal       Ruby. ,        - . </p><br><h3 id="aot-ahead-of-time-kompilyaciya"> AOT (ahead-of-time)  </h3><br><p> Graal ‚Äî    Java. JVMCI  ,  Graal,    ,     ,    Graal     .  ,     Graal    ,     JIT-. </p><br><p>     JIT-  AOT-      ,  Graal     .       AOT   Graal. </p><br><p> Java 9              JIT-,     .        JVM,          . </p><br><p> AOT Java 9     Graal,       Linux.            ,  ,            . </p><br><p>    . <em>SubstrateVM</em> ‚Äî  AOT-,   Java-    JVM  . ,     - (statically linked)  .    JVM  ,         .     SubstrateVM  Graal.          ( <em>just-in-time</em> ) SubstrateVM, ,   Graal  .   Graal AOT-  . </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> javac Hello.java <span class="hljs-variable"><span class="hljs-variable">$</span></span> graalvm<span class="hljs-literal"><span class="hljs-literal">-0</span></span>.<span class="hljs-number"><span class="hljs-number">28.2</span></span>/bin/native<span class="hljs-literal"><span class="hljs-literal">-image</span></span> Hello classlist: <span class="hljs-number"><span class="hljs-number">966.44</span></span> ms (cap): <span class="hljs-number"><span class="hljs-number">804.46</span></span> ms setup: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">514.31</span></span> ms (typeflow): <span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">580.70</span></span> ms (objects): <span class="hljs-number"><span class="hljs-number">719.04</span></span> ms (features): <span class="hljs-number"><span class="hljs-number">16.27</span></span> ms analysis: <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">422.58</span></span> ms universe: <span class="hljs-number"><span class="hljs-number">262.09</span></span> ms (parse): <span class="hljs-number"><span class="hljs-number">528.44</span></span> ms (inline): <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">259.94</span></span> ms (compile): <span class="hljs-number"><span class="hljs-number">6</span></span>,<span class="hljs-number"><span class="hljs-number">716.20</span></span> ms compile: <span class="hljs-number"><span class="hljs-number">8</span></span>,<span class="hljs-number"><span class="hljs-number">817.97</span></span> ms image: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">070.29</span></span> ms debuginfo: <span class="hljs-number"><span class="hljs-number">672.64</span></span> ms write: <span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">797.45</span></span> ms [<span class="hljs-type"><span class="hljs-type">total</span></span>]: <span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">907.56</span></span> ms <span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-literal"><span class="hljs-literal">-lh</span></span> hello <span class="hljs-literal"><span class="hljs-literal">-rwxr</span></span><span class="hljs-literal"><span class="hljs-literal">-xr</span></span><span class="hljs-literal"><span class="hljs-literal">-x</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> chrisseaton staff <span class="hljs-number"><span class="hljs-number">6.6</span></span>M <span class="hljs-number"><span class="hljs-number">4</span></span> Oct <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> hello <span class="hljs-variable"><span class="hljs-variable">$</span></span> file ./hello ./hellojava: Mach<span class="hljs-literal"><span class="hljs-literal">-O</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span><span class="hljs-literal"><span class="hljs-literal">-bit</span></span> executable x86_64 <span class="hljs-variable"><span class="hljs-variable">$</span></span> time ./hello Hello! real <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">010</span></span>s user <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0.<span class="hljs-number"><span class="hljs-number">003</span></span>s</code> </pre> <br><h3 id="truffle"> Truffle </h3><br><p>     Graal      <em>Truffle</em> . Truffle ‚Äî         JVM. </p><br><p>  ,   JVM,  ,   JIT-   (,    ,   ,  JIT- JVM    ,        ). Truffle    ‚Äî       ,   ,  Truffle, ,              <em> </em> ( <em>partial evaluation</em> ). </p><br><p>         ,             <em> </em> ( <em>inlining</em> )  <em> </em> ( <em>constant folding</em> )      . Graal       ,  Truffle       . </p><br><p>       Graal ‚Äî  Truffle.       Ruby,   <em>TruffleRuby</em>    Truffle , , Graal. TruffleRuby ‚Äî     Ruby,   10   , ,  ,        . </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/graalvm/truffleruby</a> </p><br><h2 id="vyvody">  Conclusions </h2><br><p>  ,      ,   ,   JIT- Java         . JIT-   ,          , , -           . ,  ,   .   JIT-    ,   <code>byte[]</code>  JVM  <code>byte[]</code>  . </p><br><p>  ,       Java.           ,   C++. </p><br><p> Java- Graal   - .   ,    ,            . </p><br><p>          .        ,        Eclipse     .           (definitions),     ..    . </p><br><p>          JIT      JIT- JVM,   <em>JITWatch</em> ,   ,        Graal     ,   . ,   ,  -       ,     Graal     JVM.         IDE,       <em>hello-world</em> . </p><br><p>         SubstrateVM  Truffle,   Graal,     ,     Java  .     ,   Graal    Java.  ,    ,   -  <em>LLVM</em> ,    , ,   ,     . </p><br><p> , ,       Graal      JVM.  Parce que JVMCI   Java 9, Graal      ,  ,    Java-. </p><br><p> Graal ‚Äî        .    ,      Graal.    ,      ! </p><br><hr><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">More information about TruffleRuby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Low Overhead Polling For Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Top 10 Things To Do With GraalVM</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Ruby Objects as C Structs and Vice Versa</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Understanding How Graal Works ‚Äî a Java JIT Compiler Written in Java</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Flip-Flops ‚Äî the 1-in-10-million operator</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Deoptimizing Ruby</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Very High Performance C Extensions For JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Optimising Small Data Structures in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Pushing Pixels with JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Tracing With Zero Overhead in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">How Method Dispatch Works in JRuby+Truffle</a> </p><br><p> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">A Truffle/Graal High Performance Backend for JRuby</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr419637/">https://habr.com/ru/post/fr419637/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr419623/index.html">"ELLE": comment nous avons cr√©√© des images d'intelligence artificielle</a></li>
<li><a href="../fr419625/index.html">Aper√ßu de mes fonctionnalit√©s PHP7 pr√©f√©r√©es</a></li>
<li><a href="../fr419627/index.html">Nous recherchons des conf√©renciers √† Moscou Data Science Major</a></li>
<li><a href="../fr419633/index.html">Maintenant, toutes les principales listes de certificats racine sont approuv√©es par Let's Encrypt</a></li>
<li><a href="../fr419635/index.html">Sortie de la version stable de Dart 2.0 et Dart Web Platform</a></li>
<li><a href="../fr419641/index.html">Cr√©ation d'une IA C # simple dans Unity</a></li>
<li><a href="../fr419643/index.html">Conf√©rence de Minsk EPAM sur l'ing√©nierie logicielle: Make it Real</a></li>
<li><a href="../fr419647/index.html">S√©minaire ¬´Black Friday dans le commerce √©lectronique. Secrets of Survival, 16 ao√ªt, Moscou</a></li>
<li><a href="../fr419649/index.html">Un peu sur les chats, ou quel CAT nous avons choisi pour les podcasts de synchronisation</a></li>
<li><a href="../fr419651/index.html">Ni GA ni YM. Comment nous avons cr√©√© notre propre flux de clics</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>