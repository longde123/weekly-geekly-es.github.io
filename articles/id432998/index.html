<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘¨ğŸ»â€ğŸ”§ ğŸ” ğŸ‘¦ğŸ½ Cerita natal ğŸ‘©â€â¤ï¸â€ğŸ‘© ğŸ‘©â€â¤ï¸â€ğŸ’‹â€ğŸ‘© â›©ï¸</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kami ingin berbagi kisah yang terjadi di salah satu proyek kami untuk Tahun Baru. Inti dari proyek ini adalah mengotomatiskan pekerjaan dokter di lemb...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Cerita natal</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/simbirsoft/blog/432998/">  Kami ingin berbagi kisah yang terjadi di salah satu proyek kami untuk Tahun Baru.  Inti dari proyek ini adalah mengotomatiskan pekerjaan dokter di lembaga medis.  Selama kunjungan pasien, dokter menulis informasi ke perekam, kemudian audio ditranskripsikan.  Setelah proses transkripsi - mis.  mengubah rekaman audio menjadi teks - dokumen medis dibentuk sesuai dengan standar yang relevan dan dikirim kembali ke klinik, dari mana rekaman audio berasal, di mana dokter pengirim menerimanya, memeriksa dan menyetujuinya.  Setelah melewati pemeriksaan wajib, dokumen dikirim ke pasien akhir. <br><a name="habracut"></a><br>  Semua lembaga medis yang menggunakan produk secara kondisional dapat dibagi menjadi dua kelompok besar: <br><br><ul><li>  Hosting di pusat data klien kami, yang bertanggung jawab penuh atas fungsionalitas aplikasi, baik untuk perangkat lunak maupun perangkat keras.  Misalnya, jika ruang disk habis, atau tidak ada kinerja server yang cukup pada CPU; </li><li>  Diinstal sendiri: mereka menempatkan semua peralatan langsung di rumah dan bertanggung jawab atas kinerjanya sendiri.  Klien kami memberi mereka aplikasi dan dukungannya. </li></ul><br>  Ini adalah cara tim kami berinteraksi dengan server akhir yang dihosting langsung di cloud klien kami. <br><br><img src="https://habrastorage.org/webt/fu/dh/qb/fudhqbrny8p_r3wcs4swokhglqw.png"><br><br>  Kami memiliki akses ke server ini untuk melakukan semua pekerjaan dan pemeliharaan terjadwal yang diperlukan. <br><br>  Grup kedua - klien yang di-host-sendiri - untuk mereka, cloud klien bertindak sebagai gateway yang melaluinya kami terhubung ke server ini.  Dalam hal ini, kami memiliki hak terbatas, seringkali kami tidak dapat melakukan operasi apa pun karena pengaturan keamanan.  Kami terhubung ke server melalui RDP, Remote Desktop Protocol pada OS Windows.  Secara alami, ini semua bekerja melalui VPN. <br><br>  Harus diingat bahwa setiap server yang diwakili dalam diagram sebenarnya adalah kombinasi dari server aplikasi dan server database.  Pada server database, masing-masing, MS SQL Server DBMS dan layanan pelaporan SSR diinstal.  Selain itu, versi MSSQL Server berbeda di semua klinik: 2008, 2012, 2014. Selain versi itu sendiri, Paket Layanan dan tambalan yang berbeda diinstal di mana-mana.  Secara umum, kebun binatang lengkap. <br><br>  Di server aplikasi kami telah menginstal server web IIS dan ElasticSearch.  ElasticSearch adalah mesin pencari yang juga mengimplementasikan pencarian teks lengkap. <br>  Esensi utama dalam hal produk kami adalah "pekerjaan".  Pekerjaan adalah entitas abstrak yang menghubungkan semua informasi yang terkait dengan penerimaan pasien tertentu.  Informasi ini meliputi: <br><br><ul><li>  data tentang dokter; </li><li>  data pasien; </li><li>  data tentang kunjungan; </li><li>  file audio (pidato dokter); </li><li>  dokumen (beberapa versi); </li><li>  riwayat pemrosesan pekerjaan; </li><li>  informasi cabang, dll. </li></ul><br>  Diagram ini menunjukkan skema database yang disederhanakan dari mana Anda dapat melihat hubungan antara tabel utama.  Ini hanya bagian dasar, pada kenyataannya, database memiliki lebih dari 200 tabel. <br><br><img src="https://habrastorage.org/webt/sc/ke/hl/sckehlss-czi3bz2kagmfecrroy.png"><br><br>  Sedikit tentang klinik tempat kejadian itu terjadi: <br><br><ul><li>  1500-2000 pekerjaan per hari; </li><li>  1000+ pengguna aktif (dokter + sekretaris); </li><li>  Diinangi sendiri. </li></ul><br>  DB: <br><br><ul><li>  Ukuran: 800+ Gb (750K + karya, 2M + dokumen); </li><li>  DBMS: MS SQL Server 2008 R2; </li><li>  Model Pemulihan: Sederhana. </li></ul><br>  Di sini saya ingin membuat sedikit penjelasan.  Ada 3 model pemulihan di SQL Server: sederhana, log-massal, dan penuh.  Saya tidak akan berbicara tentang yang ketiga sekarang, saya akan menjelaskan tentang yang pertama dan yang kedua.  Perbedaan utama adalah bahwa dalam model sederhana kami tidak menyimpan riwayat transaksi dalam log - segera setelah transaksi dilakukan, catatan dari log transaksi akan dihapus.  Saat menggunakan mode pemulihan penuh, seluruh riwayat perubahan data disimpan dalam log transaksi.  Apa yang ini berikan pada kita?  Jika terjadi situasi yang tidak terduga, ketika kita perlu memutar kembali basis data dari cadangan, kita dapat kembali tidak hanya ke cadangan tertentu, tetapi dapat kembali ke titik waktu tertentu, hingga ke transaksi tertentu, mis., Kami telah menyimpan dalam cadangan, tidak hanya keadaan tertentu dari database pada saat cadangan, tetapi juga ada seluruh sejarah perubahan data. <br><br>  Saya pikir itu tidak layak menjelaskan bahwa mode sederhana hanya digunakan dalam pengembangan, pada server pengujian dan penggunaannya dalam produksi tidak dapat diterima.  Tidak mungkin sama sekali. <br><br>  Tetapi klinik, tampaknya, memiliki pemikiran sendiri tentang hal ini;) <br><br><h3>  Mulai </h3><br>  Beberapa hari kemudian Tahun Baru, semua orang bersiap untuk liburan, membeli hadiah, menghias pohon Natal, menghabiskan pesta perusahaan dan menunggu akhir pekan yang panjang. <br><br><h6>  22 Desember (Jumat) 1 hari </h6><br>  <strong>14:31</strong> Klien mengatakan bahwa ia tidak menerima laporan harian berikutnya.  Laporan tiba melalui pos dua kali sehari sesuai jadwal, diperlukan untuk mengontrol pengiriman data ke sistem integrasi eksternal, yang tidak terlalu kritis. <br><br>  Mungkin ada beberapa alasan: <br><br><ol><li>  Masalah dengan SMTP, surat-surat tidak disampaikan (mereka mengubah kata sandi, misalnya, dan mereka tidak memberi tahu siapa pun); </li><li>  Masalah di sisi server dari laporan; </li><li>  Sesuatu terjadi pada basis data. </li></ol><br>  <strong>16:03</strong> Klinik terkadang mengubah kata sandi menjadi SMTP, tanpa memperingatkan siapa pun tentang hal itu, oleh karena itu, setelah menyelesaikan tugas saat ini, kami dengan tenang memeriksa laporan secara manual dengan meluncurkannya melalui antarmuka web - kami mendapatkan kesalahan yang menunjukkan masalah dalam database. <br><br>  Contoh kesalahan yang kami terima saat memulai laporan. <br><br><pre><code class="plaintext hljs">SQL Server detected a logical consistency-based I/O error: incorrect checksum (expected: 0x9876641f; actual: 0xa3255fbf). It occurred during a read of page (1:876) in database ID 7 at offset 0x000000006d8000 in file 'D:\Program Files\Microsoft SQL Server\MSSQL10_50.MSSQLSERVER\MSSQL\DATA\ServerLive.mdf'.</code> </pre> <br>  Ini menunjukkan bahwa database memiliki halaman yang rusak.  Kami memiliki sedikit rasa cemas. <br><br>  <strong>20:53</strong> Untuk menilai tingkat kerusakan, kami menjalankan pemeriksaan basis data menggunakan perintah <strong><em>DBCC CHECKDB</em></strong> khusus.  Tergantung pada ukuran kerusakannya, perintah tes dapat memakan waktu cukup lama, jadi kami menjalankan perintah di malam hari.  Di sini kita beruntung bahwa ini terjadi pada hari Jumat sore, yaitu, kita memiliki setidaknya semua hari libur untuk menyelesaikan masalah ini. <br><br>  Pada saat itu, situasinya adalah sebagai berikut: <br><br><img src="https://habrastorage.org/webt/dp/nq/jm/dpnqjm7rvkmtjtxoc534js439zq.png"><br><br><h6>  23 Desember (Sabtu) hari ke-2 </h6><br>  <strong>10:02</strong> Di pagi hari, kami menemukan bahwa memeriksa basis data dengan CHECKDB adalah disket - ini disebabkan oleh kurangnya ruang diska bebas, karena  selama proses verifikasi, basis data tempdb sementara aktif digunakan, dan pada titik tertentu ruang disk kosong habis. <br><br>  Oleh karena itu, kami memutuskan daripada memeriksa seluruh database untuk segera meluncurkan pemindaian tabel.  Untuk melakukan ini, gunakan perintah <strong><em>DBCC CHECKTABLE</em></strong> . <br><br>  <strong>10:46</strong> Kami memutuskan untuk memulai dengan tabel JobHistory, yang mungkin rusak, karena itu yang digunakan untuk menghasilkan laporan.  Tabel ini, sesuai namanya, mempertahankan sejarah semua karya, mis., Transisi kerja antar tahap. <br><br>  Jalankan <strong><em>DBCC CHECKTABLE ('dbo.JobHistory')</em></strong> . <br><br>  Memeriksa tabel ini mengungkapkan tabel yang rusak dalam database, yang pada prinsipnya diharapkan. <br><br>  <strong>12:00</strong> Saat ini, jika basis data menggunakan model pemulihan penuh, kami dapat memulihkan halaman yang rusak dari cadangan, dan semuanya akan berakhir, tetapi basis data kami berada dalam mode sederhana.  Oleh karena itu, satu-satunya pilihan untuk memperbaiki kerusakan tetap menjalankan perintah yang sama dengan parameter khusus <strong><em>REPAIR_ALLOW_DATA_LOSS</em></strong> .  Ini dapat menyebabkan hilangnya data. <br><br>  Kita mulai.  Pemeriksaan lagi diakhiri dengan kesalahan - kami mendapatkan kesalahan bahwa pemulihan tabel ini tidak mungkin sampai tabel terkait dipulihkan.  Tabel riwayat mengacu pada tabel kerja (Pekerjaan) oleh kunci asing, oleh karena itu, kami menyimpulkan bahwa ada juga kerusakan di tabel kerja utama (Pekerjaan). <br><br>  <strong>13:30</strong> Langkah selanjutnya adalah memeriksa tabel Pekerjaan, pada saat yang sama - kami berharap bahwa kerusakan ada dalam indeks, dan bukan dalam data.  Dalam hal ini, cukup bagi kita untuk membangun kembali indeks untuk pemulihan data. <br><br>  <strong>17:33</strong> Setelah beberapa saat, kami menemukan bahwa server kami tidak tersedia melalui RDP.  Mungkin dimatikan, cek tidak selesai, pekerjaan ditangguhkan.  Kami memberi tahu klinik bahwa server tidak tersedia, tolong angkat. <br><br>  Kecemasan ringan mengambil bentuk yang sangat spesifik. <br><br><h6>  24 Desember (Minggu) hari ke-3 </h6><br>  <strong>14:31</strong> Menjelang makan malam, server dinaikkan, kami menjalankan kembali pemeriksaan tabel Jobs. <br>  <strong><em>DBCC CHECKTABLE ('dbo.Jobs')</em></strong> <br><br>  <strong>16:05</strong> Verifikasi tidak selesai, server tidak tersedia.  Lagi <br><br>  Setelah beberapa waktu, server tidak tersedia lagi, sebelum kami berhasil menyelesaikan memeriksa tabel.  Pada titik ini, layanan TI klinik melakukan serangkaian pemeriksaan server.  Kami menunggu selesainya pekerjaan. <br><br>  Karena liburan, komunikasi antara kami dan klien lambat - kami mengharapkan jawaban atas pertanyaan selama beberapa jam. <br><br><h6>  25 Desember (Senin - Natal) hari ke-4 </h6><br>  <strong>16:00</strong> Hari berikutnya server dinaikkan, klien memiliki Natal, dan kami kembali mulai memeriksa tabel, tetapi kali ini kami mengecualikan indeks dari pemindaian, dan kami hanya meninggalkan pemeriksaan data.  Dan setelah beberapa waktu server tidak tersedia lagi. <br><br>  Apa yang sedang terjadi <br><br>  Pada saat ini, pikiran mulai merayap masuk, bahwa ini bukan hanya kebetulan, dan ada kecurigaan bahwa itu bisa menjadi kerusakan pada tingkat besi (hard disk jatuh).  Kami berasumsi bahwa ada sektor buruk pada disk dan ketika pemindaian mencoba membaca data dari sektor ini, sistem macet.  Kami memberi tahu klien kami tentang asumsi kami. <br><br>  Klien menjalankan pemeriksaan disk pada mesin host. <br><br>  <strong>17:19</strong> Klinik IT service melaporkan bahwa file mesin virtual rusak - ini buruk! ( <br>  Kami belum bisa bekerja, dan kami sedang menunggu sinyal ketika mereka memperbaiki masalah dan kami dapat melanjutkan pekerjaan kami. <br><br><h6>  26 Desember (Selasa) Hari 5 </h6><br>  <strong>14:05</strong> Layanan klinik TI meluncurkan proses pemulihan disk lainnya.  Kami diberitahu bahwa kami dapat menjalankan CHECKTABLE secara paralel untuk memeriksa tabel.  Kami memulai pengujian lagi - mesin virtual mogok lagi, kami memberi tahu klien bahwa file mesin virtual masih rusak. <br><br>  Hari-hari ini, semua komunikasi dengan pelanggan sangat lambat dengan jeda waktu yang sangat besar karena liburan. <br><br><h6>  27 Desember (Rabu) Hari 6 </h6><br>  <strong>14:00</strong> Kami memulai pemeriksaan disk menggunakan Windows - <strong>checkdisk</strong> di dalam mesin virtual - tidak ada masalah yang terdeteksi. <br>  Basis data berada dalam mode Sederhana, sehingga kemungkinan memperbaiki basis data saat ini dengan alat DBMS cenderung nol, karena  kami tidak dapat memulihkan halaman yang rusak secara individual. <br>  Kami mulai mempertimbangkan opsi untuk memutar kembali dan memulihkan basis data dari cadangan. <br>  Kami memeriksa cadangan basis data dan menemukan bahwa cadangan tersebut tidak dibuat menggunakan sarana DBMS, cadangan terakhir adalah pada tahun 2014, mis.  Tidak ada cadangan dari database.  Mengapa mereka tidak melakukannya adalah masalah terpisah, merupakan tanggung jawab klinik untuk memastikan pengoperasian dan keamanan basis data. <br><br>  Ada kemungkinan besar bahwa itu tidak akan berfungsi untuk mengembalikan database saat ini, kami mulai mempertimbangkan opsi lain untuk rollback. <br><br>  Mari kita bahas lebih rinci tentang situasi dengan cadangan di klinik. <br><br>  Situasi dengan cadangan: <br><br><ul><li>  Tidak ada cadangan basis data (!!!) </li><li>  Tidak ada snapshot dari mesin virtual (!?) </li><li>  Tetapi ada cadangan disk (full + inc) </li></ul><br>  Basis data ada di disk D, masing-masing, mereka melakukan backup penuh mingguan dan backup inkremental harian. <br><br><ul><li>  setiap Jumat pukul 20:00 cadangan penuh </li><li>  cadangan tambahan setiap hari </li><li>  ada cadangan lengkap dari tanggal 15 dan 22 </li><li>  ada cadangan harian hingga tanggal 21 </li></ul><br>  Yaitu  pada prinsipnya, kita dapat kembali ke keadaan sebelum masalah terjadi. <br>  Kami sedang menunggu pembaruan dari klinik untuk memulai rollback database dari cadangan. <br><br>  Pada saat yang sama, klinik mengirimkan permintaan kepada pemasok besi (HP) bertanda â€œmendesakâ€. <br><br><h6>  28 Desember (Kamis) Hari 7 </h6><br>  <strong>13:13</strong> Klinik Layanan TI mulai menyiapkan mesin virtual baru, seperti  Tidak mungkin untuk memperbaiki kerusakan pada file mesin virtual lama. <br><br>  <strong>19:09 Mesin</strong> virtual baru tersedia dengan SQL Server diinstal. <br>  Langkah selanjutnya adalah mengembalikan database dari cadangan disk.  Untuk memulainya, kami memutuskan untuk kembali ke hari ke-22, jika masalahnya masih ada, kemudian kembali ke tanggal 21, 20, dan seterusnya, hingga kami tiba di kondisi kerja. <br><br>  Itu adalah hari ke-28 di halaman, kami berada di pesta perusahaan, dan di sini mereka memberi tahu kami bahwa klinik memiliki masalah dengan memulihkan cadangan, karena CADANGAN KOSONG! <br><br>  Inilah beritanya! <br><br>  Saat mengembalikan cadangan drive D dari tanggal 21, ternyata kosong, seperti yang lainnya.  Backup shredder langsung diperoleh - mereka tampaknya ada di sana, tetapi pada saat yang sama mereka tidak.  Tidak sepenuhnya jelas bagaimana ini terjadi sama sekali, tetapi, sejauh yang dapat kami pahami, intinya adalah ruang disk tidak mencukupi untuk menyimpan cadangan disk.  Mereka mengalokasikan 500 Gb cadangan untuk penyimpanan, tetapi pada saat kejadian, database sudah berbobot 800 Gb, oleh karena itu, pada prinsipnya, cadangan tidak dapat berhasil.  Yaitu  backup secara teratur dilakukan sesuai dengan jadwal, tetapi karena kurangnya ruang, mereka berakhir dengan kesalahan dan, karenanya, kosong, dan layanan TI klinik tidak memiliki ide untuk memeriksa bahwa semuanya baik-baik saja dengan mereka.  Jangan lakukan itu. <br><br><h6>  29 Desember (Jumat) Hari 8 </h6><br>  <strong>13:11</strong> Diskusi tindakan selanjutnya.  Opsi yang memungkinkan: <br><br><ul><li>  Mencoba untuk menyalin file basis data (.ldf + .two file) - peluang keberhasilan sangat rendah; </li><li>  Mencoba membuat cadangan basis data sekali lagi sangat kecil peluangnya; </li><li>  Konfigurasikan replikasi - dapat berfungsi. </li></ul><br>  Drive 1 Tb dialokasikan pada server baru, yang jelas tidak cukup jika kita mencoba membuat cadangan dan memulihkannya, karena  dalam kasus terburuk, tanpa kompresi, cadangan akan mengambil ruang sebanyak database asli, mis.  800 Gb. <br>  Silakan tambahkan tempat di server baru dan lanjutkan menyalin file database. <br>  Database dibuat di server baru dan skema database dipulihkan - ini akan memungkinkan setidaknya memproses pekerjaan baru.  Klinik setidaknya akan dapat menerima pasien baru menggunakan sistem seperti itu. <br><br>  <strong>14:36</strong> Karenanya, kami melanjutkan ke opsi nomor satu, meskipun kami tidak berharap banyak kesuksesan. <br>  Hentikan SQL Server, mulai menyalin file data (mdf) dan log (ldf). <br><br>  <strong>16:13</strong> Setelah setengah dari file log, itu berhasil disalin (48 Gb), dan 50 GB file data sudah disalin (795 dari 846 GB tersisa).  Pada kecepatan ini, akan dibutuhkan sekitar 12 jam untuk menyelesaikan salinan. <br><br>  <strong>16:30</strong> Server database lama dimatikan saat menyalin file, yang sangat diharapkan. <br><br>  <strong>17:09</strong> Oleh karena itu, kita beralih ke opsi berikutnya - mengatur replikasi, sementara kita dapat menentukan data apa yang akan direplikasi, yaitu, pertama-tama kita dapat mengecualikan tabel yang sengaja rusak dan terlebih dahulu menyalin data yang tidak rusak, dan kemudian mentransfer tabel yang bermasalah di beberapa bagian.  Tetapi opsi ini, sayangnya, tidak berfungsi dengan baik, karena kami bahkan tidak dapat membuat publikasi dengan tabel tertentu karena kerusakan basis data. <br>  Kami juga mempertimbangkan opsi transfer data. <br><br>  <strong>20:01</strong> Sebagai hasilnya, kami mulai hanya mentransfer data dari yang lama ke server baru dengan mengimpor dan mengekspor dalam urutan prioritas. <br><br>  <strong>21:35</strong> Pertama, data paling kritis, lalu arsip dan kurang kritis (~ 300 GB).  Dalam gelombang ekspor pertama, kurang dari 300 GB data tetap ada.  Tabel Dokumen (300GB) juga dikecualikan.  Kami memulai proses penyalinan di malam hari. <br><br><h6>  30 Desember (Sabtu) Hari 9 </h6><br>  <strong>15:00 Kami</strong> terus mentransfer data.  Tabel Pekerjaan tidak tersedia sama sekali.  Sebagian besar tabel disalin saat ini. <br>  Tapi tanpa <strong>Jobs,</strong> itu semua tidak berguna, karena itu adalah tautan utama antara semua data dan memberi mereka makna dan nilai dari sudut pandang bisnis.  Tanpa itu, kita hanya memiliki dataset yang berbeda yang tidak bisa kita gunakan. <br><br>  Juga, pada titik ini, pemulihan skema basis data telah selesai. <br><br>  <strong>Konsekuensi dari kejadian tersebut:</strong> <br><br>  Pada titik ini, kami memiliki banyak kehilangan data langsung. <br>  Yaitu  secara formal, kami memiliki beberapa data dalam basis data, tetapi, pada kenyataannya, tidak ada cara untuk menggunakan atau menghubungkannya, sehingga kami dapat berbicara tentang hilangnya data secara lengkap. <br>  Kehilangan data pada lebih dari 750.000 penerimaan pasien. <br><br>  Ini sungguh menyedihkan! <br><br><ul><li>  Ini merupakan pukulan besar bagi reputasi klien kami, yang dapat berubah menjadi masalah besar bagi mereka dalam bisnis ketika membuat kontrak baru dan menemukan pelanggan baru. </li><li>  Kehilangan begitu banyak data untuk klinik dapat menyebabkan masalah serius dan denda, karena  Ini adalah data rahasia yang mengandung kerahasiaan medis dan, dalam arti harfiah, tergantung pada kehidupan orang. </li></ul><br>  Kami mulai berpikir apa yang bisa kami lakukan dalam situasi ini.  Mereka mulai memilah-milah sistem dengan tulang untuk menemukan petunjuk. <br><br>  <strong>15:16</strong> Menganalisis semua aspek sistem, kami memahami bahwa kami dapat mencoba mengekstraksi data yang hilang dari indeks ElasticSearch.  Masalahnya adalah bahwa karena konfigurasi yang salah dari indeks ElasticSearch, itu tidak hanya menyimpan bidang di mana pencarian teks lengkap dilakukan, tetapi secara umum semuanya, yaitu, sebenarnya ada salinan lengkap dari data dan kita secara teoritis dapat mengekstrak data dari sana tentang karya dan mengembalikannya ke database kami.  Diharapkan bahwa data akan tetap dapat dipulihkan. <br><br>  Bug di mana Anda bisa meletakkan monumen! <br><br><img src="https://habrastorage.org/webt/oy/62/nt/oy62ntr-iiercftfvwmd_gzoide.png"><br><br>  <strong>18:00</strong> Utilitas ditulis dengan cepat untuk mengekstraksi data, dan setelah beberapa jam kami memastikan bahwa pendekatannya berhasil dan data dapat dipulihkan. <br><br>  <strong>20:00</strong> Pemulihan pekerjaan dari ElasticSearch dengan bantuan utilitas tertulis telah dimulai.  Pendekatan berhasil, kita dapat mengembalikan data pada pekerjaan.  Secara paralel, kami mulai mengekstraksi versi terbaru dokumen untuk setiap pekerjaan. <br><br><h6>  31 Desember (Minggu - Tahun Baru) Hari 10 </h6><br>  <strong>14:09</strong> Pada malam hari, 188 811 karya dipulihkan. <br><br>  <strong>20:13</strong> Melihat kesuksesan kami, klinik memutuskan untuk menunda transfer server ke layanan HP untuk memberi kami waktu untuk mengekstrak data maksimum dari server lama. <br>  Dengan berita seperti itu, kami merayakan Tahun Baru)) <br><br><h6>  01 Januari (Senin) 11 hari </h6><br>  <strong>11:23</strong> Bersiap untuk memulai sistem setelah kejadian: <br><br><ul><li>  IIS yang dikonfigurasi ulang pada server Aplikasi; </li><li>  mengkonfigurasi ulang semua layanan yang diperlukan untuk bekerja dengan server database baru; </li><li>  pemicu, prosedur tersimpan, fungsi dipulihkan. </li></ul><br>  <strong>14:28</strong> Kemudian mereka mulai menyalin tabel dokumen, yang dilewati karena ukurannya yang besar selama transfer awal. <br>  - Server DB lama dimatikan lagi.  Jelas, tabel Dokumen juga rusak, dengan itu semua informasi pasien disimpan.  Untungnya, itu tidak sepenuhnya rusak, kami dapat membuat permintaan untuk itu, dan ketika permintaan kepada kami mengembalikan catatan yang rusak, pada saat itu server crash dan dimatikan.  Kami dapat mengekstrak beberapa data. <br><br>  Oleh karena itu, kami memberi sinyal kepada klien, mereka meningkatkan server, dan secara paralel kami terus menyiapkan database baru untuk peluncuran sistem. <br><br>  <strong>18:01</strong> Pemulihan semua kendala integritas setelah transfer bagian utama data. <br><br>  <strong>22:02</strong> Pemulihan pembatasan selesai.  Kami hanya mentransfer data mentah ke maksimum.  Kehadiran kendala integritas akan sangat menyulitkan tugas kami. <br><br><h6>  02 Januari (Selasa) Hari 12 </h6><br>  <strong>05:52</strong> Server DB lama dimatikan lagi saat menyalin dokumen.  Dia segera diangkat sehingga kita dapat terus bekerja. <br><br>  <strong>09:00</strong> Sangat mungkin untuk memulihkan kumpulan sekitar 200.000 dokumen (sekitar 20%) <br>  Kami mulai menggunakan metode pemulihan yang berbeda: mengurutkan berdasarkan kolom yang berbeda untuk mendapatkan data dari akhir atau awal tabel, hingga kami menemukan beberapa bagian tabel yang rusak. <br><br>  <strong>13:42</strong> Mulai menyalin karya arsip di meja - untungnya, tidak rusak. <br><br>  <strong>17:08</strong> Memulihkan semua karya kearsipan (491.380 lembar). <br><br>  Sistem siap diluncurkan: pengguna dapat membuat dan memproses pekerjaan baru. <br><br>  Sayangnya, karena kerusakan sebagian pada tabel dokumen, Anda tidak bisa hanya mentransfer semua data dari itu, seperti halnya dengan tabel lainnya, karena  meja rusak sebagian.  Karenanya, saat mencoba mengambil semua data, permintaan macet saat mencoba membaca halaman yang rusak.  Oleh karena itu, kami mengekstrak data secara langsung menggunakan berbagai jenis dan ukuran sampel: <br><br><ul><li>  Menyortir berdasarkan bidang yang berbeda (ID, DateTime); </li><li>  Sortir naik, turun; </li><li>  Bekerja dengan kelompok garis kecil (1000, 100); </li><li>  Mengambil pekerjaan berdasarkan ID. </li></ul><br><br><h6>  03 Januari (Rabu) Hari 13 </h6><br>  <strong>08:58</strong> Melanjutkan proses pengembalian dokumen.  Dokumen dipulihkan hanya untuk pekerjaan aktif dan tidak lengkap.  Pada titik ini, 1000 bekerja (aktif) tanpa dokumen. <br><br>  <strong>11:38</strong> Memigrasi semua Pekerjaan SQL <br><br>  <strong>13:17</strong> 5 berfungsi tanpa dokumen, 231 tidak berfungsi, tetapi ada file audio, Anda perlu melakukan sinkronisasi ulang. <br><br><h6>  04 Januari (Kamis) Hari 14 </h6><br>  Pemulihan manual dan verifikasi pekerjaan yang tersisa telah dimulai. <br>  Sistem bekerja, memonitor dan memperbaiki kesalahan secara online. <br><br><h6>  05 Januari (Jumat) Hari 15 </h6><br>  Laporkan migrasi ke SSR yang direncanakan. <br>  Transfer ke server baru tidak dimungkinkan, karena  klinik menginstal versi SQL Server yang lebih lama dan itu tidak akan berfungsi untuk mentransfer database dari server lama. <br><br>  Opsi: <br><br><ul><li>  Tingkatkan SQL Server dari 2008 ke 2008 R2; </li><li>  Konfigurasikan semuanya dari awal. </li></ul><br>  Diputuskan untuk menunggu pembaruan SQL Server. <br><br>  <strong>09:21</strong> Latar belakang pemulihan dokumen untuk pekerjaan yang diselesaikan telah dimulai - prosesnya panjang dan akan memakan waktu beberapa hari. <br><br>  <strong>13:28</strong> Perubahan prioritas restorasi dokumen oleh departemen. <br><br>  <strong>18:18</strong> Klinik memberi akses ke SMTP, pengaturan surat <br><br><h3>  Hasil: </h3><br><ul><li>  Hampir semua data dipulihkan (hanya 5 pekerjaan yang hilang); </li><li>  Rekomendasi tentang pemeliharaan basis data dikeluarkan untuk mencegah situasi seperti itu; </li><li>  Cadangan basis data dikonfigurasikan menggunakan SQL Server; </li><li>  Pemantauan tambahan cadangan di pihak kami, peringatan jika terjadi kegagalan. </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id432998/">https://habr.com/ru/post/id432998/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id432988/index.html">Webmaster kedelapan. Langsung di HabrÃ©</a></li>
<li><a href="../id432990/index.html">Lampu Kayu Edison yang Diaktifkan Suara. Harga masalah $ 5</a></li>
<li><a href="../id432992/index.html">Dia memakai headphone dan mati: kita berurusan dengan kematian aneh seorang anak sekolah di Rimbau</a></li>
<li><a href="../id432994/index.html">Vivaldi 2.2 - Kuantitas Mengubah ke Kualitas</a></li>
<li><a href="../id432996/index.html">Sedikit kamus internal di CPython (dan PyPy)</a></li>
<li><a href="../id433000/index.html">Kompilasi Kotlin: JetBrains VS ANTLR VS JavaCC</a></li>
<li><a href="../id433002/index.html">Ayo dirimu sendiri ... atau aturan komunikasi dalam tim</a></li>
<li><a href="../id433004/index.html">Strategi migrasi awan yang kuat untuk tips 2019: 7</a></li>
<li><a href="../id433008/index.html">Perangkat USB adalah ancaman "mendadak"</a></li>
<li><a href="../id433010/index.html">Punya ide: sistem izin untuk paket npm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>