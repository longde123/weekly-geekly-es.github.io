<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>👛 👩🏾‍💼 👨🏾‍💻 Crea un juego web multijugador .io 🧘🏻 👩🏽‍🍳 🧝🏿</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Lanzado en 2015, Agar.io se convirtió en el progenitor del nuevo género de juegos .io , cuya popularidad ha crecido significativamente desde entonces....">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Crea un juego web multijugador .io</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450574/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c7c/405/7a7/c7c4057a7ab7333ee3cb9aba5ecc8c37.jpg" alt="imagen"></div><br>  Lanzado en 2015, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">Agar.io se</a> convirtió en el progenitor del nuevo género de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer"><strong>juegos .io</strong></a> , cuya popularidad ha crecido significativamente desde entonces.  El crecimiento de la popularidad de los juegos .io que he experimentado en mí mismo: en los últimos tres años he <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">creado y vendido dos juegos de este género.</a>  . <br><br>  En caso de que nunca antes hayas oído hablar de estos juegos: estos son juegos web gratuitos para varios jugadores en los que es fácil participar (no se requiere cuenta).  Por lo general, empujan a muchos jugadores opuestos en la misma arena.  Otros juegos famosos del género .io son: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">Slither.io</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">Diep.io.</a> <br><br>  En esta publicación, descubriremos cómo <strong>crear un juego .io desde cero</strong> .  Para esto, solo el conocimiento de Javascript será suficiente: debe comprender cosas como la sintaxis de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">ES6</a> , la <code>this</code> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">Promises</a> .  Incluso si conoces Javascript no perfectamente, aún puedes descifrar la mayor parte de la publicación. <br><a name="habracut"></a><br><h2>  Ejemplo de juego .io </h2><br>  Para ayudarlo a aprender, nos referiremos a <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">un ejemplo de juego .io</a> .  ¡Intenta jugarlo! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/um/yq/qj/umyqqjon22wmshrz8o8wtyeaxl0.png"></div><br>  El juego es bastante simple: controlas un barco en una arena donde hay otros jugadores.  Tu nave dispara proyectiles automáticamente e intentas golpear a otros jugadores, mientras evitas sus proyectiles. <br><br><h2>  1. Descripción general / estructura del proyecto </h2><br><blockquote>  Recomiendo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer"><strong>descargar el código fuente de un</strong></a> juego de ejemplo para que pueda seguirme. </blockquote><br>  El ejemplo usa lo siguiente: <br><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">Express</a> es el marco web más popular para Node.js que administra el servidor web del juego. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">socket.io</a> : una biblioteca websocket para intercambiar datos entre un navegador y un servidor. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Webpack</a> es un administrador de módulos.  Puede leer sobre por qué usar Webpack <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">aquí</a> . </li></ul><br>  Así es como se ve la estructura de directorios del proyecto: <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span>/ assets/ ... src/ <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>/ css/ ... html/ <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html <span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.js ... <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>/ <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.js ... shared/ constants.js</code> </pre> <br><h3>  público / </h3><br>  Todo en la carpeta <code>public/</code> será transmitido estáticamente por el servidor.  <code>public/assets/</code> contiene las imágenes utilizadas por nuestro proyecto. <br><br><h3>  src / </h3><br>  Todo el código fuente está en la carpeta <code>src/</code> .  Los nombres <code>client/</code> y <code>server/</code> hablan por sí mismos, y <code>shared/</code> contiene un archivo constante importado tanto por el cliente como por el servidor. <br><br><h2>  2. Asambleas / parámetros del proyecto </h2><br>  Como se indicó anteriormente, utilizamos el <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">administrador del</a> módulo <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Webpack</a> para construir el proyecto.  Echemos un vistazo a nuestra configuración de Webpack: <br><br><h5>  webpack.common.js: </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> path = require(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> MiniCssExtractPlugin = require(<span class="hljs-string"><span class="hljs-string">'mini-css-extract-plugin'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = { entry: { game: <span class="hljs-string"><span class="hljs-string">'./src/client/index.js'</span></span>, }, output: { filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].js'</span></span>, path: path.resolve(__dirname, <span class="hljs-string"><span class="hljs-string">'dist'</span></span>), }, <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>: { rules: [ { test: /\.js$/, exclude: /node_modules/, use: { loader: <span class="hljs-string"><span class="hljs-string">"babel-loader"</span></span>, options: { presets: [<span class="hljs-string"><span class="hljs-string">'@babel/preset-env'</span></span>], }, }, }, { test: /\.css$/, use: [ { loader: MiniCssExtractPlugin.loader, }, <span class="hljs-string"><span class="hljs-string">'css-loader'</span></span>, ], }, ], }, plugins: [ <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MiniCssExtractPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'[name].[contenthash].css'</span></span>, }), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HtmlWebpackPlugin({ filename: <span class="hljs-string"><span class="hljs-string">'index.html'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>: <span class="hljs-string"><span class="hljs-string">'src/client/html/index.html'</span></span>, }), ], };</code> </pre> <br>  Las más importantes aquí son las siguientes líneas: <br><br><ul><li>  <code>src/client/index.js</code> es el punto de entrada al cliente Javascript (JS).  Webpack comenzará desde aquí y buscará recursivamente otros archivos importados. </li><li>  La salida JS de nuestro ensamblaje Webpack se ubicará en el directorio <code>dist/</code> .  Llamaré a este archivo nuestro <strong>paquete JS</strong> . </li><li>  Usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">Babel</a> , y en particular la configuración <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">@ babel / preset-env</a> para transpilar nuestro código JS para navegadores más antiguos. </li><li>  Usamos el complemento para extraer todo el CSS al que hacen referencia los archivos JS y combinarlos en un solo lugar.  Lo llamaré nuestro <strong>paquete CSS</strong> . </li></ul><br>  Es posible que haya notado nombres de archivos de paquetes extraños <code>'[name].[contenthash].ext'</code> .  Contienen la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">sustitución de los nombres de los archivos</a> Webpack: <code>[name]</code> será reemplazado por el nombre del punto de entrada (en nuestro caso, este es un <code>game</code> ), y <code>[contenthash]</code> será reemplazado por un hash del contenido del archivo.  Hacemos esto para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">optimizar el proyecto para el hash</a> : puede decirle a los navegadores que almacenen en caché nuestros paquetes JS de forma indefinida, porque <strong>si el paquete cambia, entonces su nombre de archivo</strong> cambia ( <code>contenthash</code> cambia).  El resultado final será un nombre de archivo del formulario <code>game.dbeee76e91a97d0c7207.js</code> . <br><br>  El archivo <code>webpack.common.js</code> es el archivo de configuración base que importamos en las configuraciones de desarrollo y proyecto finalizado.  Por ejemplo, una configuración de desarrollo: <br><br><h5>  webpack.dev.js </h5><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> merge = require(<span class="hljs-string"><span class="hljs-string">'webpack-merge'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> common = require(<span class="hljs-string"><span class="hljs-string">'./webpack.common.js'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">module</span></span>.exports = merge(common, { mode: <span class="hljs-string"><span class="hljs-string">'development'</span></span>, });</code> </pre> <br>  Para mayor eficiencia, utilizamos <code>webpack.dev.js</code> en el <code>webpack.dev.js</code> desarrollo y <code>webpack.prod.js</code> a <code>webpack.prod.js</code> para optimizar el tamaño de los paquetes cuando se implementan en producción. <br><br><h3>  Entorno local </h3><br>  Recomiendo instalar el proyecto en una máquina local para que pueda seguir los pasos enumerados en esta publicación.  La configuración es simple: primero, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Node</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">NPM</a> deben instalarse en el sistema.  Luego debes realizar <br><br><pre> <code class="cpp hljs">$ git clone https:<span class="hljs-comment"><span class="hljs-comment">//github.com/vzhou842/example-.io-game.git $ cd example-.io-game $ npm install</span></span></code> </pre> <br>  y ya estas listo!  Para iniciar el servidor de desarrollo, simplemente ejecute <br><br><pre> <code class="cpp hljs">$ npm run develop</code> </pre> <br>  y acceda al <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">localhost: 3000</a> en un navegador web.  El servidor de desarrollo reconstruirá automáticamente los paquetes JS y CSS a medida que cambie el código, ¡simplemente actualice la página para ver todos los cambios! <br><br><h2>  3. Puntos de entrada del cliente </h2><br>  Vayamos al código del juego en sí.  Primero, necesitamos la página <code>index.html</code> , cuando visite el sitio, el navegador la cargará primero.  Nuestra página será bastante simple: <br><br><h5>  index.html </h5><br><pre>  &lt;! DOCTYPE html&gt;
 &lt;html&gt;
 &lt;head&gt;
   &lt;title&gt; Un ejemplo de juego .io &lt;/title&gt;
   &lt;link type = "text / css" rel = "stylesheet" href = "/ game.bundle.css"&gt;
 &lt;/head&gt;
 &lt;cuerpo&gt;
   &lt;canvas id = "game-canvas"&gt; &lt;/canvas&gt;
   &lt;script async src = "/ game.bundle.js"&gt; &lt;/script&gt;
   &lt;div id = "play-menu" class = "hidden"&gt;
     &lt;input type = "text" id = "username-input" placeholder = "Nombre de usuario" /&gt;
     &lt;button id = "play-button"&gt; PLAY &lt;/button&gt;
   &lt;/div&gt;
 &lt;/body&gt;
 &lt;/html&gt; </pre><br>  <i>Este ejemplo de código está ligeramente simplificado para mayor claridad, haré lo mismo con muchos otros ejemplos de la publicación.</i>  <i>El código completo siempre se puede ver en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Github</a> .</i> <br><br>  Tenemos: <br><br><ul><li>  <code>&lt;canvas&gt;</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HTML5 Canvas</a> ( <code>&lt;canvas&gt;</code> ) que usaremos para representar el juego. </li><li>  <code>&lt;link&gt;</code> para agregar nuestro paquete CSS. </li><li>  <code>&lt;script&gt;</code> para agregar nuestro paquete Javascript. </li><li>  El menú principal con el nombre de usuario <code>&lt;input&gt;</code> y el botón "PLAY" ( <code>&lt;button&gt;</code> ). </li></ul><br>  Después de cargar la página de inicio, el código Javascript comenzará a ejecutarse en el navegador, comenzando con el archivo JS del punto de entrada: <code>src/client/index.js</code> . <br><br><h5>  index.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { connect, play } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startRendering, stopRendering } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./render'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { startCapturingInput, stopCapturingInput } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./input'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { downloadAssets } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { initState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { setLeaderboardHidden } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./leaderboard'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'./css/main.css'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playMenu = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-menu'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> playButton = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'play-button'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> usernameInput = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'username-input'</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all([ connect(), downloadAssets(), ]).then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { playMenu.classList.remove(<span class="hljs-string"><span class="hljs-string">'hidden'</span></span>); usernameInput.focus(); playButton.onclick = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Play! play(usernameInput.value); playMenu.classList.add('hidden'); initState(); startCapturingInput(); startRendering(); setLeaderboardHidden(false); }; });</span></span></code> </pre> <br>  Esto puede parecer complicado, pero en realidad no hay muchas acciones sucediendo aquí: <br><br><ol><li>  Importe varios otros archivos JS. </li><li>  Importar CSS (por lo que Webpack sabe incluirlos en nuestro paquete CSS). </li><li>  Ejecutando <code>connect()</code> para establecer una conexión con el servidor y ejecutando <code>downloadAssets()</code> para descargar las imágenes necesarias para representar el juego. </li><li>  <em>Después de completar el paso 3</em> , se <code>playMenu</code> el menú principal ( <code>playMenu</code> ). </li><li>  Configuración del controlador para presionar el botón PLAY.  Cuando se presiona el botón, el código inicializa el juego y le dice al servidor que estamos listos para jugar. </li></ol><br>  La "carne" principal de nuestra lógica cliente-servidor está en aquellos archivos que fueron importados por el archivo <code>index.js</code> .  Ahora los consideraremos todos en orden. <br><br><h2>  4. Intercambio de datos del cliente. </h2><br>  En este juego usamos la conocida biblioteca <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">socket.io</a> para comunicarnos con el servidor.  Socket.io tiene soporte incorporado para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">WebSockets</a> , que son muy adecuados para la comunicación bidireccional: podemos enviar mensajes al servidor <em>y el</em> servidor puede enviarnos mensajes a través de la misma conexión. <br><br>  Tendremos un archivo <code>src/client/networking.js</code> que manejará <strong>todas las</strong> comunicaciones con el servidor: <br><br><h5>  networking.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> io <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'socket.io-client'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { processGameUpdate } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socket = io(<span class="hljs-string"><span class="hljs-string">`ws://</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${</span></span><span class="hljs-built_in"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-built_in">window</span></span></span></span><span class="hljs-string"><span class="hljs-subst">.location.host}</span></span></span><span class="hljs-string">`</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connectedPromise = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { socket.on(<span class="hljs-string"><span class="hljs-string">'connect'</span></span>, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Connected to server!'</span></span>); resolve(); }); }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> connect = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">onGameOver</span></span></span><span class="hljs-function"> =&gt;</span></span> ( connectedPromise.then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-comment"><span class="hljs-comment">// Register callbacks socket.on(Constants.MSG_TYPES.GAME_UPDATE, processGameUpdate); socket.on(Constants.MSG_TYPES.GAME_OVER, onGameOver); }) ); export const play = username =&gt; { socket.emit(Constants.MSG_TYPES.JOIN_GAME, username); }; export const updateDirection = dir =&gt; { socket.emit(Constants.MSG_TYPES.INPUT, dir); };</span></span></code> </pre> <br>  <i>Este código también se reduce ligeramente para mayor claridad.</i> <br><br>  Hay tres acciones principales en este archivo: <br><br><ul><li>  Estamos intentando conectarnos al servidor.  <code>connectedPromise</code> solo está permitido cuando hemos establecido una conexión. </li><li>  Si la conexión se establece con éxito, registramos las funciones de devolución de llamada ( <code>processGameUpdate()</code> y <code>onGameOver()</code> ) para los mensajes que podemos recibir del servidor. </li><li>  Exportamos <code>play()</code> y <code>updateDirection()</code> para que otros archivos puedan usarlos. </li></ul><br><h2>  5. Representación del cliente </h2><br>  ¡Es hora de mostrar una imagen en la pantalla! <br><br>  ... pero antes de que podamos hacer esto, necesitamos descargar todas las imágenes (recursos) que se necesitan para esto.  Escribamos un administrador de recursos: <br><br><h5>  assets.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ASSET_NAMES = [<span class="hljs-string"><span class="hljs-string">'ship.svg'</span></span>, <span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> assets = {}; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadPromise = <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>.all(ASSET_NAMES.map(downloadAsset)); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">downloadAsset</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Promise</span></span>(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resolve</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> asset = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); asset.onload = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">`Downloaded </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>); assets[assetName] = asset; resolve(); }; asset.src = <span class="hljs-string"><span class="hljs-string">`/assets/</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${assetName}</span></span></span><span class="hljs-string">`</span></span>; }); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> downloadAssets = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> =&gt;</span></span> downloadPromise; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> getAsset = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">assetName</span></span></span><span class="hljs-function"> =&gt;</span></span> assets[assetName];</code> </pre> <br>  ¡La gestión de recursos no es tan difícil de implementar!  El punto principal es almacenar el objeto <code>assets</code> , que vinculará la clave del nombre del archivo con el valor del objeto <code>Image</code> .  Cuando se carga el recurso, lo guardamos en el objeto de <code>assets</code> para una recuperación rápida en el futuro.  Cuando se permitirá la descarga para cada recurso individual (es decir, se descargarán <strong>todos los</strong> recursos), habilitamos <code>downloadPromise</code> . <br><br>  Después de descargar los recursos, puede comenzar a renderizar.  Como se indicó anteriormente, usamos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">HTML5 Canvas</a> ( <code>&lt;canvas&gt;</code> ) para dibujar en la página web.  Nuestro juego es bastante simple, por lo que es suficiente para nosotros dibujar solo lo siguiente: <br><br><ol><li>  Antecedentes </li><li>  Nave del jugador </li><li>  Otros jugadores en el juego. </li><li>  Conchas </li></ol><br>  Estos son los fragmentos importantes de <code>src/client/render.js</code> que representan exactamente los cuatro puntos enumerados anteriormente: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getAsset } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./assets'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { PLAYER_RADIUS, PLAYER_MAX_HP, BULLET_RADIUS, MAP_SIZE } = Constants; <span class="hljs-comment"><span class="hljs-comment">// Get the canvas graphics context const canvas = document.getElementById('game-canvas'); const context = canvas.getContext('2d'); // Make the canvas fullscreen canvas.width = window.innerWidth; canvas.height = window.innerHeight; function render() { const { me, others, bullets } = getCurrentState(); if (!me) { return; } // Draw background renderBackground(me.x, me.y); // Draw all bullets bullets.forEach(renderBullet.bind(null, me)); // Draw all players renderPlayer(me, me); others.forEach(renderPlayer.bind(null, me)); } // ... Helper functions here excluded let renderInterval = null; export function startRendering() { renderInterval = setInterval(render, 1000 / 60); } export function stopRendering() { clearInterval(renderInterval); }</span></span></code> </pre> <br>  <i>Este código también se acorta para mayor claridad.</i> <br><br>  <code>render()</code> es la función principal de este archivo.  <code>startRendering()</code> y <code>stopRendering()</code> controlan la activación del ciclo de renderizado a 60 FPS. <br><br>  Las implementaciones específicas de las funciones de representación auxiliares individuales (por ejemplo, <code>renderBullet()</code> ) no son tan importantes, pero aquí hay un ejemplo simple: <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">renderBullet</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">me, bullet</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { x, y } = bullet; context.drawImage( getAsset(<span class="hljs-string"><span class="hljs-string">'bullet.svg'</span></span>), canvas.width / <span class="hljs-number"><span class="hljs-number">2</span></span> + x - me.x - BULLET_RADIUS, canvas.height / <span class="hljs-number"><span class="hljs-number">2</span></span> + y - me.y - BULLET_RADIUS, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, BULLET_RADIUS * <span class="hljs-number"><span class="hljs-number">2</span></span>, ); }</code> </pre> <br>  ¡Observe que usamos el método <code>getAsset()</code> que se vio anteriormente en <code>asset.js</code> ! <br><br><blockquote>  Si está interesado en explorar otras funciones auxiliares de representación, lea el resto de <a href="">src / client / render.js</a> . </blockquote><br><h2>  6. Aporte del cliente </h2><br>  ¡Es hora de hacer que el juego sea <em>jugable</em> !  El esquema de control será muy simple: puede usar el mouse (en la computadora) o tocar la pantalla (en el dispositivo móvil) para cambiar la dirección del movimiento.  Para implementar esto, registraremos <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">oyentes de eventos</a> para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">eventos</a> de Mouse y Touch. <br>  <code>src/client/input.js</code> hará todo esto: <br><br><h5>  input.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { updateDirection } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./networking'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onMouseInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ handleInput(e.clientX, e.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onTouchInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> touch = e.touches[<span class="hljs-number"><span class="hljs-number">0</span></span>]; handleInput(touch.clientX, touch.clientY); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dir = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.atan2(x - <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerWidth / <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerHeight / <span class="hljs-number"><span class="hljs-number">2</span></span> - y); updateDirection(dir); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.addEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stopCapturingInput</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'mousemove'</span></span>, onMouseInput); <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.removeEventListener(<span class="hljs-string"><span class="hljs-string">'touchmove'</span></span>, onTouchInput); }</code> </pre> <br>  <code>onMouseInput()</code> y <code>onTouchInput()</code> son oyentes de eventos que llaman a <code>updateDirection()</code> (desde <code>networking.js</code> ) cuando ocurre un evento de entrada (por ejemplo, al mover el mouse).  <code>updateDirection()</code> participa en la mensajería con un servidor que procesa el evento de entrada y actualiza el estado del juego en consecuencia. <br><br><h2>  7. Condición del cliente </h2><br><blockquote>  Esta sección es la más difícil en la primera parte de la publicación.  ¡No se desanime si no lo comprende desde la primera lectura!  Incluso puede omitirlo y volver a él más tarde. </blockquote><br>  La última pieza del rompecabezas que se necesita para completar el código cliente-servidor es el <strong>estado</strong> .  ¿Recuerdas el fragmento de código de la sección Representación del cliente? <br><br><h5>  render.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { getCurrentState } <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">'./state'</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { me, others, bullets } = getCurrentState(); <span class="hljs-comment"><span class="hljs-comment">// Do the rendering // ... }</span></span></code> </pre> <br>  <code>getCurrentState()</code> debería poder proporcionarnos el estado actual del juego en el cliente <strong>en cualquier momento en</strong> función de las actualizaciones recibidas del servidor.  Aquí hay un ejemplo de una actualización del juego que un servidor puede enviar: <br><br><pre> <code class="cpp hljs">{ <span class="hljs-string"><span class="hljs-string">"t"</span></span>: <span class="hljs-number"><span class="hljs-number">1555960373725</span></span>, <span class="hljs-string"><span class="hljs-string">"me"</span></span>: { <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2213.8050880413657</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1469.370893425012</span></span>, <span class="hljs-string"><span class="hljs-string">"direction"</span></span>: <span class="hljs-number"><span class="hljs-number">1.3082443894581433</span></span>, <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"AhzgAtklgo2FJvwWAADO"</span></span>, <span class="hljs-string"><span class="hljs-string">"hp"</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span> }, <span class="hljs-string"><span class="hljs-string">"others"</span></span>: [], <span class="hljs-string"><span class="hljs-string">"bullets"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"RUJfJ8Y18n"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2354.029197099604</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1431.6848318262666</span></span> }, { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"ctg5rht5s"</span></span>, <span class="hljs-string"><span class="hljs-string">"x"</span></span>: <span class="hljs-number"><span class="hljs-number">2260.546457727445</span></span>, <span class="hljs-string"><span class="hljs-string">"y"</span></span>: <span class="hljs-number"><span class="hljs-number">1456.8088728920968</span></span> } ], <span class="hljs-string"><span class="hljs-string">"leaderboard"</span></span>: [ { <span class="hljs-string"><span class="hljs-string">"username"</span></span>: <span class="hljs-string"><span class="hljs-string">"Player"</span></span>, <span class="hljs-string"><span class="hljs-string">"score"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span> } ] }</code> </pre> <br>  Cada actualización del juego contiene cinco campos idénticos: <br><br><ul><li>  <strong>t</strong> : marca de tiempo del servidor para el momento en que se creó esta actualización. </li><li>  <strong>yo</strong> : información sobre el jugador que recibe esta actualización. </li><li>  <strong>otros</strong> : un conjunto de información sobre otros jugadores que participan en el mismo juego. </li><li>  <strong>viñetas</strong> : una serie de información sobre los shells en el juego. </li><li>  <strong>tabla de clasificación</strong> : datos actuales de la tabla de clasificación.  En esta publicación no los tendremos en cuenta. </li></ul><br><h3>  7.1 El estado ingenuo del cliente </h3><br>  La implementación ingenua de <code>getCurrentState()</code> solo puede devolver datos directamente de la actualización de juego más reciente recibida. <br><br><h5>  ingenuo-estado.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> lastGameUpdate = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-comment"><span class="hljs-comment">// Handle a newly received game update. export function processGameUpdate(update) { lastGameUpdate = update; } export function getCurrentState() { return lastGameUpdate; }</span></span></code> </pre> <br>  Hermoso y claro!  Pero si todo fuera tan simple.  Una de las razones por las que esta implementación es problemática: <strong>limita la velocidad de cuadros del render a la frecuencia del reloj del servidor</strong> . <br><br><blockquote>  <strong>Velocidad de fotogramas</strong> : el número de fotogramas (es decir, llamadas de <code>render()</code> ) por segundo, o FPS.  Los juegos generalmente tienden a alcanzar al menos 60 FPS. </blockquote><br><blockquote>  <strong>Tick ​​Rate</strong> : la frecuencia con la que el servidor envía actualizaciones del juego a los clientes.  <strong>A menudo es inferior a la velocidad de fotogramas</strong> .  En nuestro juego, el servidor funciona a una frecuencia de 30 ciclos por segundo. </blockquote><br>  Si solo presentamos la última actualización del juego, entonces FPS nunca podrá superar los 30, porque <em>nunca recibimos más de 30 actualizaciones por segundo del servidor</em> .  Incluso si llamamos <code>render()</code> 60 veces por segundo, la mitad de estas llamadas simplemente redibujarán lo mismo, esencialmente sin hacer nada.  Otro problema de la implementación ingenua es que es <strong>propenso a retrasos</strong> .  Con una velocidad de Internet ideal, el cliente recibirá una actualización del juego exactamente cada 33 ms (30 por segundo): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc3/815/7c9/bc38157c91d436b5fedf948b60c8a213.svg"></div><br>  Lamentablemente, nada es perfecto.  Una imagen más realista sería: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/836/45f/75e/83645f75e556bc5c1c38111a69510734.svg"></div><br>  Una implementación ingenua es prácticamente el peor de los casos cuando se trata de retrasos.  Si la actualización del juego se recibe con un retraso de 50 ms, el <strong>cliente se ralentiza</strong> 50 ms adicionales, ya que aún representa el estado del juego de la actualización anterior.  Puedes imaginar lo inconveniente que es para un jugador: debido al frenado arbitrario, el juego parecerá nervioso e inestable. <br><br><h3>  7.2 Estado del cliente mejorado </h3><br>  Haremos algunas mejoras a la implementación ingenua.  Primero, usamos <strong>un retraso de renderizado de</strong> 100 ms.  Esto significa que el estado "actual" del cliente siempre se retrasará 100 ms respecto del estado del juego en el servidor.  Por ejemplo, si el tiempo en el servidor es <strong>150</strong> , el estado en el que el servidor estaba en el momento <strong>50</strong> se representará en el cliente: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/788/1b5/c78/7881b5c789321648ff1ff70d15b881d4.svg"></div><br>  Esto nos da un búfer de 100 ms, lo que nos permite sobrevivir al tiempo impredecible para recibir actualizaciones del juego: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/c1e/494/615/c1e4946159c599c7a2a9196968755e4b.svg"></div><br>  Pagar por esto será un <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">retraso de entrada</a> constante <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">(retraso de entrada) de</a> 100 ms.  Este es un sacrificio menor para un juego fluido: la mayoría de los jugadores (especialmente los casuales) ni siquiera notarán este retraso.  Es mucho más fácil para las personas adaptarse a un retraso constante de 100 ms que jugar con un retraso impredecible. <br><br><blockquote>  Podemos usar otra técnica llamada <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">"pronóstico del lado del cliente",</a> que hace un buen trabajo al reducir los retrasos percibidos, pero no se considerará en esta publicación. </blockquote><br>  Otra mejora que utilizamos es <strong>la interpolación lineal</strong> .  Debido a retrasos en el procesamiento, generalmente superamos el tiempo actual en el cliente con al menos una actualización.  Cuando se llama a <code>getCurrentState()</code> , podemos realizar <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" rel="noopener noreferrer">una interpolación lineal</a> entre las actualizaciones del juego inmediatamente antes y después de la hora actual en el cliente: <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br>  Esto resuelve el problema con la velocidad de cuadros: ¡ahora podemos renderizar cuadros únicos con cualquier frecuencia que necesitemos! <br><br><h3>  7.3 Implementación del estado mejorado del cliente </h3><br>  Un ejemplo de implementación en <code>src/client/state.js</code> utiliza tanto el retraso de representación como la interpolación lineal, pero esto no es por mucho tiempo.  Dividamos el código en dos partes.  Aquí está el primero: <br><br><h5>  state.js parte 1 </h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> RENDER_DELAY = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> gameUpdates = []; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ gameStart = <span class="hljs-number"><span class="hljs-number">0</span></span>; firstServerTimestamp = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processGameUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">update</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { firstServerTimestamp = update.t; gameStart = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); } gameUpdates.push(update); <span class="hljs-comment"><span class="hljs-comment">// Keep only one game update before the current server time const base = getBaseUpdate(); if (base &gt; 0) { gameUpdates.splice(0, base); } } function currentServerTime() { return firstServerTimestamp + (Date.now() - gameStart) - RENDER_DELAY; } // Returns the index of the base update, the first game update before // current server time, or -1 if N/A. function getBaseUpdate() { const serverTime = currentServerTime(); for (let i = gameUpdates.length - 1; i &gt;= 0; i--) { if (gameUpdates[i].t &lt;= serverTime) { return i; } } return -1; }</span></span></code> </pre> <br>  El primer paso es descubrir qué hace <code>currentServerTime()</code> .  Como vimos anteriormente, se incluye una marca de tiempo del servidor en cada actualización del juego.  Queremos usar el retraso de representación para representar la imagen 100 ms detrás del servidor, pero <strong>nunca sabremos la hora actual en el servidor</strong> , porque no podemos saber cuánto tiempo nos llevó alguna de las actualizaciones.  ¡Internet es impredecible y su velocidad puede variar mucho! <br><br>  Para solucionar este problema, puede usar una aproximación razonable: <strong>fingiremos que la primera actualización llegó instantáneamente</strong> .  Si esto fuera cierto, entonces sabríamos la hora del servidor en este momento en particular.  Guardamos la marca de tiempo del servidor en <code>firstServerTimestamp</code> y <code>firstServerTimestamp</code> nuestra marca de tiempo <strong>local</strong> (cliente) al mismo tiempo en <code>gameStart</code> . <br><br>  Oh espera  <b>¿No debería haber tiempo en el servidor = tiempo en el cliente?</b>  ¿Por qué distinguimos entre "marca de tiempo del servidor" y "marca de tiempo del cliente"?  Esta es una gran pregunta!  Resulta que esto no es lo mismo.  <code>Date.now()</code> devolverá diferentes marcas de tiempo en el cliente y el servidor, y esto depende de factores locales para estas máquinas.  <strong>Nunca suponga que las marcas de tiempo son las mismas en todas las máquinas.</strong> <br><br>  Ahora entendemos lo que hace <code>currentServerTime()</code> : devuelve la <strong>marca de tiempo del servidor para el tiempo de representación actual</strong> .<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En otras palabras, esta es la hora actual del servidor ( </font></font><code>firstServerTimestamp &lt;+ (Date.now() - gameStart)</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">) menos el retraso de representación ( </font></font><code>RENDER_DELAY</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ahora veamos cómo manejamos las actualizaciones del juego. Cuando se recibe una actualización del servidor, se llama </font></font><code>processGameUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y guardamos la nueva actualización en una matriz </font></font><code>gameUpdates</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. Luego, para verificar el uso de la memoria, eliminamos todas las actualizaciones antiguas de la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">actualización base</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , porque ya no las necesitamos. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Qué es una "actualización básica"? Esta es la </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">primera actualización que encontramos retrocediendo desde la hora actual del servidor</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . ¿Recuerdas este circuito?</font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/2ca/1c8/91c/2ca1c891ce7db0341dc78c2f88e16ce4.svg"></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La actualización del juego directamente a la izquierda de Client Render Time es una actualización básica. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Para qué se usa la actualización básica? </font><font style="vertical-align: inherit;">¿Por qué podemos descartar actualizaciones a la base? </font><font style="vertical-align: inherit;">Para entender esto, </font></font><em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">finalmente</font></font></em><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> veamos la implementación </font></font><code>getCurrentState()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> state.js parte 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!firstServerTimestamp) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {}; } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> base = getBaseUpdate(); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> serverTime = currentServerTime(); <span class="hljs-comment"><span class="hljs-comment">// If base is the most recent update we have, use its state. // Else, interpolate between its state and the state of (base + 1). if (base &lt; 0) { return gameUpdates[gameUpdates.length - 1]; } else if (base === gameUpdates.length - 1) { return gameUpdates[base]; } else { const baseUpdate = gameUpdates[base]; const next = gameUpdates[base + 1]; const r = (serverTime - baseUpdate.t) / (next.t - baseUpdate.t); return { me: interpolateObject(baseUpdate.me, next.me, r), others: interpolateObjectArray(baseUpdate.others, next.others, r), bullets: interpolateObjectArray(baseUpdate.bullets, next.bullets, r), }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Manejamos tres casos: </font></font><br><br><ol><li> <code>base &lt; 0</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">significa que no hay actualizaciones en el tiempo de representación actual (ver implementación anterior </font></font><code>getBaseUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Esto puede suceder justo al comienzo del juego debido a retrasos en el procesamiento. </font><font style="vertical-align: inherit;">En este caso, utilizamos la actualización más reciente.</font></font></li><li> <code>base</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esta es la última actualización que tenemos. </font><font style="vertical-align: inherit;">Esto puede deberse a la latencia de la red o la mala conexión a Internet. </font><font style="vertical-align: inherit;">En este caso, también utilizamos la última actualización que tenemos.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tenemos una actualización tanto antes como después del tiempo de representación actual, para que pueda </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">interpolar</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo lo que queda </font></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es la implementación de la interpolación lineal, que es una matemática simple (pero aburrida). </font><font style="vertical-align: inherit;">Si quieres aprenderlo tú mismo, </font><a href="" rel="noopener noreferrer"><font style="vertical-align: inherit;">ábrelo</font></a></font><code>state.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> en </font></font><a href="" rel="noopener noreferrer"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Parte 2. Servidor de fondo </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En esta parte, veremos el backend Node.js que ejecuta nuestro </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ejemplo de juego .io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 1. Punto de entrada del servidor </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para controlar el servidor web, utilizaremos el popular marco web para Node.js llamado </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Express</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Será configurado por nuestro archivo de punto de entrada del servidor </font></font><code>src/server/server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, parte 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpack = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackDevMiddleware = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'webpack-dev-middleware'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> webpackConfig = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../../webpack.dev.js'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup an Express server const app = express(); app.use(express.static('public')); if (process.env.NODE_ENV === 'development') { // Setup Webpack for development const compiler = webpack(webpackConfig); app.use(webpackDevMiddleware(compiler)); } else { // Static serve the dist/ folder in production app.use(express.static('dist')); } // Listen on port const port = process.env.PORT || 3000; const server = app.listen(port); console.log(`Server listening on port ${port}`);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Recuerdas que en la primera parte hablamos de Webpack? </font><font style="vertical-align: inherit;">Aquí es donde usaremos nuestras configuraciones de Webpack. </font><font style="vertical-align: inherit;">Los aplicaremos de dos maneras:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Utilice </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">webpack-dev-middleware</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para reconstruir automáticamente nuestros paquetes de desarrollo, o</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Transfiera estáticamente la carpeta </font></font><code>dist/</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en la que Webpack escribirá nuestros archivos después del ensamblaje de producción.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Otra tarea importante </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es configurar el servidor </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">socket.io</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> , que simplemente se conecta al servidor Express:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, parte 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> socketio = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Setup Express // ... const server = app.listen(port); console.log(`Server listening on port ${port}`); // Setup socket.io const io = socketio(server); // Listen for socket.io connections io.on('connection', socket =&gt; { console.log('Player connected!', socket.id); socket.on(Constants.MSG_TYPES.JOIN_GAME, joinGame); socket.on(Constants.MSG_TYPES.INPUT, handleInput); socket.on('disconnect', onDisconnect); });</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Después de establecer con éxito una conexión socket.io con el servidor, configuramos controladores de eventos para el nuevo socket. </font><font style="vertical-align: inherit;">Los controladores de eventos procesan los mensajes recibidos de los clientes por delegación en el objeto singleton </font></font><code>game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> server.js, parte 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Game = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./game'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// ... // Setup the Game const game = new Game(); function joinGame(username) { game.addPlayer(this, username); } function handleInput(dir) { game.handleInput(this, dir); } function onDisconnect() { game.removePlayer(this); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creamos un juego del género .io, por lo que solo necesitamos una instancia </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">("Juego"): ¡todos los jugadores juegan en la misma arena! </font><font style="vertical-align: inherit;">En la siguiente sección, veremos cómo funciona esta clase </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 2. Servidor de juegos </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La clase </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">contiene la lógica más importante del lado del servidor. </font><font style="vertical-align: inherit;">Tiene dos tareas principales: </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">gestión de jugadores</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> y </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">simulación de juegos</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Comencemos con la primera tarea: con la gestión de jugadores.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, parte 1 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Player = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./player'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.players = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.bullets = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.lastUpdateTime = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.shouldSendUpdate = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; setInterval(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.update.bind(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>), <span class="hljs-number"><span class="hljs-number">1000</span></span> / <span class="hljs-number"><span class="hljs-number">60</span></span>); } addPlayer(socket, username) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sockets[socket.id] = socket; <span class="hljs-comment"><span class="hljs-comment">// Generate a position to start this player at. const x = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); const y = Constants.MAP_SIZE * (0.25 + Math.random() * 0.5); this.players[socket.id] = new Player(socket.id, username, x, y); } removePlayer(socket) { delete this.sockets[socket.id]; delete this.players[socket.id]; } handleInput(socket, dir) { if (this.players[socket.id]) { this.players[socket.id].setDirection(dir); } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">En este juego, identificaremos a los jugadores por el campo de </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">su socket socket.io (si está confundido, vuelva a </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">). </font><font style="vertical-align: inherit;">Socket.io asigna a cada socket uno único </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, por lo que no debemos preocuparnos por esto. </font><font style="vertical-align: inherit;">Llamaré a su </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ID de jugador</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Con esto en mente, examinemos las variables de instancia en la clase </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><ul><li> <code>sockets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es un objeto que une la identificación del jugador al zócalo que está asociado con el jugador. </font><font style="vertical-align: inherit;">Nos permite obtener acceso a los sockets mediante sus ID de jugador durante un tiempo constante.</font></font></li><li> <code>players</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Es un objeto que une una ID de jugador a un código&gt; Objeto de jugador </font></font></li></ul><br> <code>bullets</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es una matriz de objetos </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que no tiene un orden específico. </font></font><br> <code>lastUpdateTime</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">- Esta es la marca de tiempo de la última actualización del juego. </font><font style="vertical-align: inherit;">Pronto veremos cómo se usa. </font></font><br> <code>shouldSendUpdate</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Es una variable auxiliar. </font><font style="vertical-align: inherit;">Veremos su uso pronto también. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Métodos </font></font><code>addPlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, </font></font><code>removePlayer()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">y </font></font><code>handleInput()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">no es necesario explicar, se utilizan en </font></font><code>server.js</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. </font><font style="vertical-align: inherit;">Si necesita actualizar su memoria, retroceda un poco más. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">La última línea </font></font><code>constructor()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">comienza </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el ciclo de actualización del</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> juego (con una frecuencia de 60 actualizaciones / s):</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, parte 2 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // Calculate time elapsed const now = Date.now(); const dt = (now - this.lastUpdateTime) / 1000; this.lastUpdateTime = now; // Update each bullet const bulletsToRemove = []; this.bullets.forEach(bullet =&gt; { if (bullet.update(dt)) { // Destroy this bullet bulletsToRemove.push(bullet); } }); this.bullets = this.bullets.filter( bullet =&gt; !bulletsToRemove.includes(bullet), ); // Update each player Object.keys(this.sockets).forEach(playerID =&gt; { const player = this.players[playerID]; const newBullet = player.update(dt); if (newBullet) { this.bullets.push(newBullet); } }); // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // Check if any players are dead Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; if (player.hp &lt;= 0) { socket.emit(Constants.MSG_TYPES.GAME_OVER); this.removePlayer(socket); } }); // Send a game update to each player every other time if (this.shouldSendUpdate) { const leaderboard = this.getLeaderboard(); Object.keys(this.sockets).forEach(playerID =&gt; { const socket = this.sockets[playerID]; const player = this.players[playerID]; socket.emit( Constants.MSG_TYPES.GAME_UPDATE, this.createUpdate(player, leaderboard), ); }); this.shouldSendUpdate = false; } else { this.shouldSendUpdate = true; } } // ... }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El método </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">probablemente contiene la parte más importante de la lógica del lado del servidor. </font><font style="vertical-align: inherit;">En orden, enumeramos todo lo que hace:</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Calcula cuánto tiempo </font></font><code>dt</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ha pasado desde la última </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li><li>        .      .    ,  <code>bullet.update()</code> <strong> <code>true</code> ,     </strong> (    ). </li><li>        .       — <code>player.update()</code> <strong>   <code>Bullet</code></strong> . </li><li>         <code>applyCollisions()</code> ,    ,    .        ,    (  <code>player.onDealtDamage()</code> ),       <code>bullets</code> . </li><li>      . </li><li>      <strong> </strong>    <code>update()</code> .         <code>shouldSendUpdate</code> .   <code>update()</code>  60 /,     30 /.  , <strong> </strong>   30 / (       ). </li></ol><br><blockquote> <strong>     <em> </em> ?</strong>   . 30     –   ! </blockquote><br><blockquote> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¿Por qué simplemente no llamar </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">30 veces por segundo? </font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Para mejorar la simulación del juego. </font><font style="vertical-align: inherit;">Cuanto más se llame </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, más precisa será la simulación del juego. </font><font style="vertical-align: inherit;">Pero no se deje llevar por la cantidad de llamadas </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, porque es una tarea computacionalmente costosa: 60 por segundo es suficiente.</font></font></blockquote><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">El resto de la clase </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">consiste en métodos auxiliares utilizados en </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js, parte 3 </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... getLeaderboard() { return Object.values(this.players) .sort((p1, p2) =&gt; p2.score - p1.score) .slice(0, 5) .map(p =&gt; ({ username: p.username, score: Math.round(p.score) })); } createUpdate(player, leaderboard) { const nearbyPlayers = Object.values(this.players).filter( p =&gt; p !== player &amp;&amp; p.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); const nearbyBullets = this.bullets.filter( b =&gt; b.distanceTo(player) &lt;= Constants.MAP_SIZE / 2, ); return { t: Date.now(), me: player.serializeForUpdate(), others: nearbyPlayers.map(p =&gt; p.serializeForUpdate()), bullets: nearbyBullets.map(b =&gt; b.serializeForUpdate()), leaderboard, }; } }</span></span></code> </pre> <br> <code>getLeaderboard()</code>   –      ,           . <br><br> <code>createUpdate()</code>   <code>update()</code>    ,   .        <code>serializeForUpdate()</code> ,    <code>Player</code>  <code>Bullet</code> . ,         <strong></strong>    –       ,    ! <br><br><h2> 3.     </h2><br>           :      .       ,       <code>Object</code> : <br><br><h5> object.js </h5><br><pre> <code class="javascript hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Object</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, x, y, dir, speed) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id = id; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = y; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed = speed; } update(dt) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x += dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y -= dt * <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.speed * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction); } distanceTo(object) { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dx = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x - object.x; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> dy = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y - object.y; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(dx * dx + dy * dy); } setDirection(dir) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.direction = dir; } serializeForUpdate() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y, }; } }</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Aquí no pasa nada complicado. </font><font style="vertical-align: inherit;">Esta clase será un buen punto de referencia para la expansión. </font><font style="vertical-align: inherit;">Veamos cómo </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">usa </font><font style="vertical-align: inherit;">la clase </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> bullet.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> shortid = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'shortid'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Bullet</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(parentID, x, y, dir) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(shortid(), x, y, dir, Constants.BULLET_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parentID = parentID; } <span class="hljs-comment"><span class="hljs-comment">// Returns true if the bullet should be destroyed update(dt) { super.update(dt); return this.x &lt; 0 || this.x &gt; Constants.MAP_SIZE || this.y &lt; 0 || this.y &gt; Constants.MAP_SIZE; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡La implementación es </font></font><code>Bullet</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">muy corta! </font><font style="vertical-align: inherit;">Agregamos </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">solo las siguientes extensiones:</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Usando un paquete </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shortid</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> para generar aleatoriamente un </font></font><code>id</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">proyectil.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregar un campo </font></font><code>parentID</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">para que pueda rastrear al jugador que creó este proyectil.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Agregar un valor de retorno a </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, que es igual </font></font><code>true</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">si el proyectil está fuera de la arena (recuerde, ¿hablamos de esto en la última sección?).</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pasemos a </font></font><code>Player</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> player.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ObjectClass = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./object'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Bullet = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./bullet'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Player</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ObjectClass</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">constructor</span></span>(id, username, x, y) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(id, x, y, <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * <span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI, Constants.PLAYER_SPEED); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.username = username; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hp = Constants.PLAYER_MAX_HP; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.fireCooldown = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.score = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Returns a newly created bullet, or null. update(dt) { super.update(dt); // Update score this.score += dt * Constants.SCORE_PER_SECOND; // Make sure the player stays in bounds this.x = Math.max(0, Math.min(Constants.MAP_SIZE, this.x)); this.y = Math.max(0, Math.min(Constants.MAP_SIZE, this.y)); // Fire a bullet, if needed this.fireCooldown -= dt; if (this.fireCooldown &lt;= 0) { this.fireCooldown += Constants.PLAYER_FIRE_COOLDOWN; return new Bullet(this.id, this.x, this.y, this.direction); } return null; } takeBulletDamage() { this.hp -= Constants.BULLET_DAMAGE; } onDealtDamage() { this.score += Constants.SCORE_BULLET_HIT; } serializeForUpdate() { return { ...(super.serializeForUpdate()), direction: this.direction, hp: this.hp, }; } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Los jugadores son más complejos que los proyectiles, por lo que deberían almacenarse algunos campos más en esta clase. Su método </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">hace mucho trabajo, en particular, devuelve el shell recién creado si no se deja </font></font><code>fireCooldown</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">(recuerde, ¿hablamos de esto en la sección anterior?). También amplía el método </font></font><code>serializeForUpdate()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, porque necesitamos incluir campos adicionales para el jugador en la actualización del juego. </font></font><br><br> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tener una clase base </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">es un paso importante para evitar la repetibilidad del código</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . Por ejemplo, sin una clase, </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">cada objeto del juego debería tener la misma implementación </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, y la sincronización de copiar y pegar todas estas implementaciones en varios archivos sería una pesadilla. </font></font><strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Esto se vuelve especialmente importante para proyectos grandes</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> cuando </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">crece </font><font style="vertical-align: inherit;">el número de </font><font style="vertical-align: inherit;">clases </font><font style="vertical-align: inherit;">de extensión </font><font style="vertical-align: inherit;">.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 4. Reconocimiento de conflictos </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Lo único que nos queda es reconocer cuándo los proyectiles golpean a los jugadores! </font><font style="vertical-align: inherit;">Recuerde este fragmento de código de un método </font></font><code>update()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">en una clase </font></font><code>Game</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">:</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> game.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> applyCollisions = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./collisions'</span></span>); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Game</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... update() { // ... // Apply collisions, give players score for hitting bullets const destroyedBullets = applyCollisions( Object.values(this.players), this.bullets, ); destroyedBullets.forEach(b =&gt; { if (this.players[b.parentID]) { this.players[b.parentID].onDealtDamage(); } }); this.bullets = this.bullets.filter( bullet =&gt; !destroyedBullets.includes(bullet), ); // ... } }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Necesitamos implementar un método </font></font><code>applyCollisions()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que devuelva todos los proyectiles que golpean a los jugadores. </font><font style="vertical-align: inherit;">Afortunadamente, esto no es tan difícil de hacer, porque</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Todos los objetos que colisionan son círculos, y esta es la figura más simple para implementar el reconocimiento de colisión. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ya tenemos un método </font></font><code>distanceTo()</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">que implementamos en la sección anterior de la clase </font></font><code>Object</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">.</font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Así es como se ve nuestra implementación de reconocimiento de colisión: </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> collisions.js </font></font></h5><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Constants = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'../shared/constants'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// Returns an array of bullets to be destroyed. function applyCollisions(players, bullets) { const destroyedBullets = []; for (let i = 0; i &lt; bullets.length; i++) { // Look for a player (who didn't create the bullet) to collide each bullet with. // As soon as we find one, break out of the loop to prevent double counting a bullet. for (let j = 0; j &lt; players.length; j++) { const bullet = bullets[i]; const player = players[j]; if ( bullet.parentID !== player.id &amp;&amp; player.distanceTo(bullet) &lt;= Constants.PLAYER_RADIUS + Constants.BULLET_RADIUS ) { destroyedBullets.push(bullet); player.takeBulletDamage(); break; } } } return destroyedBullets; }</span></span></code> </pre> <br>        ,  <strong>  ,         </strong> .  ,           : <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/63f/e73/2c8/63fe732c87ed1872522787e3cc4d5ab2.svg"></div><br>        : <br><br><ul><li>        .   ,  <code>bullet.parentID</code>  <code>player.id</code> . </li><li>              .        <code>break</code> :    ,   ,        . </li></ul><br><h2>  </h2><br>   !   ,      -  .io.  Que sigue <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¡Crea tu propio juego .io! </font></font></strong> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo el código de muestra es de código abierto y publicado en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/450574/">https://habr.com/ru/post/450574/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450556/index.html">Índice de válvulas: revisión del nuevo conjunto VR</a></li>
<li><a href="../450564/index.html">Brillo y pobreza: cómo la revolución digital empobreció a los músicos</a></li>
<li><a href="../450566/index.html">OutOfMemory y el uso de imágenes vectoriales en Android Studio</a></li>
<li><a href="../450568/index.html">Cada veneno tiene su propio antídoto. Cómo guardar o al menos intentar (upd: sobre antídotos para envenenamiento doméstico)</a></li>
<li><a href="../450572/index.html">Samba DC como segundo controlador en el dominio AD de Windows 2012R2 y carpetas móviles para clientes en Windows y Linux</a></li>
<li><a href="../450576/index.html">Nuevas reglas para el anonimato del mensajero</a></li>
<li><a href="../450578/index.html">¿Qué se escucha en el aire? Recibimos y decodificamos las señales más interesantes. Parte 2, VHF</a></li>
<li><a href="../450582/index.html">Principios de PIM</a></li>
<li><a href="../450586/index.html">Fish Redux - Nueva Biblioteca Redux para Flutter</a></li>
<li><a href="../450592/index.html">En Alemania, el costo de viajar en un automóvil eléctrico puede ser mayor que en un automóvil diesel</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>