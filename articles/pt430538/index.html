<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèΩ‚Äçüé® üõ•Ô∏è ‚óªÔ∏è Voc√™ l√™ o Scaladoc para m√©todos de coleta "√≥bvios"? Ou por que a pregui√ßa nem sempre √© boa üñäÔ∏è üö≥ üë∂üèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Se voc√™ n√£o sabe como eles diferem 


someMap.map{ case (k, v) => k -> foo(v)}  


 e 


 someMap.mapValues(foo)  


 exceto pela sintaxe, ou voc√™ duv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Voc√™ l√™ o Scaladoc para m√©todos de coleta "√≥bvios"? Ou por que a pregui√ßa nem sempre √© boa</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/inforion/blog/430538/"><p>  Se voc√™ n√£o sabe como eles diferem </p><br><pre><code class="scala hljs">someMap.map{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (k, v) =&gt; k -&gt; foo(v)}</code> </pre> <br><p>  e </p><br><pre> <code class="scala hljs">someMap.mapValues(foo)</code> </pre> <br><p>  exceto pela sintaxe, ou voc√™ duvida / n√£o sabe a quais conseq√º√™ncias ruins essa diferen√ßa pode levar e onde a <code>identity</code> √© esse artigo √© para voc√™. </p><br><p>  Caso contr√°rio, participe da pesquisa localizada no final do artigo. </p><a name="habracut"></a><br><h2 id="nachnem-s-prostogo">  Vamos come√ßar com um simples </h2><br><p>  Vamos tentar estupidamente pegar um exemplo localizado antes do kat e ver o que acontece: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> someMap = <span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">"key1"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"value1"</span></span>, <span class="hljs-string"><span class="hljs-string">"key2"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"value2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span></span>(value: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">String</span></span> = value + <span class="hljs-string"><span class="hljs-string">"_changed"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resultMap = someMap.map{<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (k,v) =&gt; k -&gt; foo(v)} <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resultMapValues = someMap.mapValues(foo) println(<span class="hljs-string"><span class="hljs-string">s"resultMap: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMap</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"equality: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resultMap == resultMapValues}</span></span></span><span class="hljs-string">"</span></span>)</code> </pre> <br><p>  Este c√≥digo deve imprimir </p><br><pre> <code class="plaintext hljs">resultMap: Map(key1 -&gt; value1_changed, key2 -&gt; value2_changed) resultMapValues: Map(key1 -&gt; value1_changed, key2 -&gt; value2_changed) equality: true</code> </pre> <br><p>  E nesse n√≠vel, a compreens√£o do m√©todo <code>mapValues</code> √© <code>mapValues</code> nos est√°gios iniciais do aprendizado do Scala: bem, sim, existe esse m√©todo, √© conveniente alterar valores no <code>Map</code> quando as chaves n√£o s√£o alteradas.  E realmente, o que mais h√° para pensar?  Pelo nome do m√©todo, tudo √© √≥bvio, o comportamento √© claro. </p><br><h2 id="primery-poslozhnee">  Exemplos mais complicados </h2><br><p>  Vamos modificar um pouco o nosso exemplo (vou escrever explicitamente tipos para que voc√™ n√£o pense que h√° algum tipo de trouxa com impl√≠citos): </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueHolder</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">someMap</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">String</span></span>] = <span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">"key1"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"value1"</span></span>, <span class="hljs-string"><span class="hljs-string">"key2"</span></span> -&gt; <span class="hljs-string"><span class="hljs-string">"value2"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span></span>(value: <span class="hljs-type"><span class="hljs-type">String</span></span>): <span class="hljs-type"><span class="hljs-type">ValueHolder</span></span> = <span class="hljs-type"><span class="hljs-type">ValueHolder</span></span>(value) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resultMap: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">ValueHolder</span></span>] = someMap.map{<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (k,v) =&gt; k -&gt; foo(v)} <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resultMapValues: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">ValueHolder</span></span>] = someMap.mapValues(foo) println(<span class="hljs-string"><span class="hljs-string">s"resultMap: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMap</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"equality: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resultMap == resultMapValues}</span></span></span><span class="hljs-string">"</span></span>)</code> </pre> <br><p>  E esse c√≥digo ser√° produzido ap√≥s o lan√ßamento </p><br><pre> <code class="plaintext hljs">resultMap: Map(key1 -&gt; ValueHolder(value1), key2 -&gt; ValueHolder(value2)) resultMapValues: Map(key1 -&gt; ValueHolder(value1), key2 -&gt; ValueHolder(value2)) equality: true</code> </pre> <br><p>  √â bastante l√≥gico e √≥bvio.  "Cara, √© hora de chegar ao final do artigo!"  - o leitor dir√°.  Vamos tornar a cria√ß√£o de nossa classe dependente de condi√ß√µes externas e adicionar algumas verifica√ß√µes simples de idiotice: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValueHolder</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, seed: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">foo</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span></span><span class="hljs-class">)</span></span>: <span class="hljs-type"><span class="hljs-type">ValueHolder</span></span> = <span class="hljs-type"><span class="hljs-type">ValueHolder</span></span>(value, <span class="hljs-type"><span class="hljs-type">Random</span></span>.nextInt()) ... println(<span class="hljs-string"><span class="hljs-string">s"simple assert for resultMap: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resultMap.head == resultMap.head}</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"simple assert for resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resultMapValues.head == resultMapValues.head}</span></span></span><span class="hljs-string">"</span></span>)</code> </pre> <br><p>  Na sa√≠da, obtemos: </p><br><pre> <code class="plaintext hljs">resultMap: Map(key1 -&gt; ValueHolder(value1,1189482436), key2 -&gt; ValueHolder(value2,-702760039)) resultMapValues: Map(key1 -&gt; ValueHolder(value1,-1354493526), key2 -&gt; ValueHolder(value2,-379389312)) equality: false simple assert for resultMap: true simple assert for resultMapValues: false</code> </pre> <br><p>  √â l√≥gico que os resultados agora n√£o sejam iguais, mas aleat√≥rios.  Mas espere, por que a segunda afirma√ß√£o deu <code>false</code> ?  Realmente os valores em <code>resultMapValues</code> mudaram, mas n√£o fizemos nada com eles?  Vamos verificar se tudo dentro √© igual ao que era: </p><br><pre> <code class="scala hljs">println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>)</code> </pre> <br><p>  E na sa√≠da temos: </p><br><pre> <code class="plaintext hljs">resultMapValues: Map(key1 -&gt; ValueHolder(value1,1771067356), key2 -&gt; ValueHolder(value2,2034115276)) resultMapValues: Map(key1 -&gt; ValueHolder(value1,-625731649), key2 -&gt; ValueHolder(value2,-1815306407))</code> </pre> <br><p><img src="https://habrastorage.org/webt/q8/mu/fq/q8mufqtncnwg0ttpmvrcl6p4zxo.jpeg" alt="imagem"></p><br><h2 id="pochemu-eto-proizoshlo">  Por que isso aconteceu? </h2><br><p>  Por <code>println</code> altera o valor do <code>Map</code> ? <br>  Chegou a hora de entrar na documenta√ß√£o para o m√©todo <code>mapValues</code> : </p><br><pre> <code class="scala hljs"> <span class="hljs-comment"><span class="hljs-comment">/** Transforms this map by applying a function to every retrieved value. * @param f the function used to transform values of this map. * @return a map view which maps every key of this map * to `f(this(key))`. The resulting map wraps the original map without copying any elements. */</span></span></code> </pre> <br><p>  A primeira linha nos diz o que pens√°vamos - altera o <code>Map</code> , aplicando a fun√ß√£o passada nos argumentos a cada valor.  Mas se voc√™ ler com muito cuidado e at√© o fim, verifica-se que n√£o √© o <code>Map</code> que √© retornado, mas a "visualiza√ß√£o do mapa" (visualiza√ß√£o).  E essa n√£o √© uma visualiza√ß√£o normal ( <code>View</code> ), que voc√™ pode obter usando o m√©todo de <code>view</code> e que possui um m√©todo de <code>force</code> para c√°lculo expl√≠cito.  Uma classe especial (o c√≥digo √© da vers√£o 2.12.7 do Scala, mas para a 2.11 existe quase a mesma coisa): </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MappedValues</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">W</span></span></span><span class="hljs-class">](</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">f: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">V</span></span></span></span><span class="hljs-class"><span class="hljs-params"> =&gt; </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">W</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractMap</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">W</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DefaultMap</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">K</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">W</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foreach</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">U</span></span>](g: ((<span class="hljs-type"><span class="hljs-type">K</span></span>, <span class="hljs-type"><span class="hljs-type">W</span></span>)) =&gt; <span class="hljs-type"><span class="hljs-type">U</span></span>): <span class="hljs-type"><span class="hljs-type">Unit</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ((k, v) &lt;- self) g((k, f(v))) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iterator</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ((k, v) &lt;- self.iterator) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> (k, f(v)) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">size</span></span></span><span class="hljs-function"> </span></span>= self.size <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">contains</span></span></span></span>(key: <span class="hljs-type"><span class="hljs-type">K</span></span>) = self.contains(key) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get</span></span></span></span>(key: <span class="hljs-type"><span class="hljs-type">K</span></span>) = self.get(key).map(f) }</code> </pre> <br><p>  Se voc√™ ler este c√≥digo, ver√° que nada √© armazenado em cache e cada vez que acessar os valores, eles ser√£o recalculados.  O que observamos em nosso exemplo. </p><br><p>  Se voc√™ trabalha com fun√ß√µes puras e tudo √© imut√°vel, n√£o notar√° nenhuma diferen√ßa.  Bem, talvez o desempenho seja prejudicado.  Infelizmente, por√©m, nem tudo em nosso mundo √© limpo e perfeito, e usando esses m√©todos, voc√™ pode entrar no rake (o que aconteceu em um de nossos projetos, caso contr√°rio, este artigo n√£o teria sido). </p><br><p>  Obviamente, n√£o somos os primeiros a se deparar com isso.  J√° em 2011, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">grande erro</a> foi aberto nesta ocasi√£o (e, no momento da reda√ß√£o deste documento, est√° marcado como aberto).  Ele tamb√©m menciona o m√©todo <code>filterKeys</code> , que tem exatamente os mesmos problemas, porque √© implementado com o mesmo princ√≠pio. </p><br><p>  Al√©m disso, desde 2015, um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ticket</a> est√° pendurado para adicionar inspe√ß√µes ao IntelliJ Idea. </p><br><h2 id="chto-delat">  O que fazer </h2><br><p>  A solu√ß√£o mais simples √© estupidamente n√£o usar esses m√©todos, porque  pelo nome, o comportamento deles, na minha opini√£o, √© muito √≥bvio. </p><br><p>  Uma op√ß√£o um pouco melhor √© chamar o <code>map(identity)</code> . <br>  <code>identity</code> , se algu√©m n√£o souber, esta √© uma fun√ß√£o da biblioteca padr√£o que simplesmente retorna seu argumento de entrada.  Nesse caso, o trabalho principal √© realizado pelo m√©todo <code>map</code> , que cria explicitamente um <code>Map</code> normal.  Vamos verificar apenas no caso de: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resultMapValues: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">ValueHolder</span></span>] = someMap.mapValues(foo).map(identity) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"simple assert for resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${resultMapValues.head == resultMapValues.head}</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>)</code> </pre> <br><p>  Na sa√≠da, obtemos </p><br><pre> <code class="plaintext hljs">resultMapValues: Map(key1 -&gt; ValueHolder(value1,333546604), key2 -&gt; ValueHolder(value2,228749608)) simple assert for resultMapValues: true resultMapValues: Map(key1 -&gt; ValueHolder(value1,333546604), key2 -&gt; ValueHolder(value2,228749608)) resultMapValues: Map(key1 -&gt; ValueHolder(value1,333546604), key2 -&gt; ValueHolder(value2,228749608))</code> </pre> <br><p>  Est√° tudo bem :) </p><br><p>  Se voc√™ ainda deseja deixar a pregui√ßa, √© melhor alterar o c√≥digo para que fique √≥bvio.  Voc√™ pode criar uma classe impl√≠cita com um m√©todo de wrapper para <code>mapValues</code> e <code>filterKeys</code> , que fornece um novo nome que seja compreens√≠vel para eles.  Ou use explicitamente <code>.view</code> e trabalhe com um iterador de pares. </p><br><p>  Al√©m disso, vale a pena adicionar inspe√ß√£o ao ambiente / regra de desenvolvimento em um analisador est√°tico / em outro lugar, que alerta sobre o uso desses m√©todos.  Porque √© melhor gastar um pouco de tempo nisso agora do que pisar no ancinho e colher as consequ√™ncias por um longo tempo depois. </p><br><h2 id="kak-vy-esche-mozhete-nastupit-na-grabli-i-kak-nastupili-na-nih-my">  De que outra forma voc√™ pode pisar no rake e como pisamos neles </h2><br><p>  Al√©m do caso da depend√™ncia de condi√ß√µes externas, que observamos nos exemplos acima, existem outras op√ß√µes. </p><br><p>  Por exemplo, um valor mut√°vel (observe, aqui, superficialmente, tudo √© "imut√°vel"): </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">val</span></span> someMap1 = <span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">"key1"</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">"key2"</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> someMap2 = <span class="hljs-type"><span class="hljs-type">Map</span></span>(<span class="hljs-string"><span class="hljs-string">"key1"</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-string"><span class="hljs-string">"key2"</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increment</span></span></span></span>(value: <span class="hljs-type"><span class="hljs-type">AtomicInteger</span></span>): <span class="hljs-type"><span class="hljs-type">Int</span></span> = value.incrementAndGet() <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resultMap: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>] = someMap1.map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (k, v) =&gt; k -&gt; increment(v) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> resultMapValues: <span class="hljs-type"><span class="hljs-type">Map</span></span>[<span class="hljs-type"><span class="hljs-type">String</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>] = someMap2.mapValues(increment) println(<span class="hljs-string"><span class="hljs-string">s"resultMap (1): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMap</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues (1): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMap (2): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMap</span></span></span><span class="hljs-string">"</span></span>) println(<span class="hljs-string"><span class="hljs-string">s"resultMapValues (2): </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">$resultMapValues</span></span></span><span class="hljs-string">"</span></span>)</code> </pre> <br><p>  Este c√≥digo produzir√° este resultado: </p><br><pre> <code class="plaintext hljs">resultMap (1): Map(key1 -&gt; 1, key2 -&gt; 1) resultMapValues (1): Map(key1 -&gt; 1, key2 -&gt; 1) resultMap (2): Map(key1 -&gt; 1, key2 -&gt; 1) resultMapValues (2): Map(key1 -&gt; 2, key2 -&gt; 2)</code> </pre> <br><p>  Quando <code>someMap2</code> novamente, obtivemos um resultado engra√ßado. </p><br><p>  Os problemas que podem surgir quando os <code>mapValues</code> e as <code>filterKeys</code> s√£o usados ‚Äã‚Äãde maneira <code>mapValues</code> podem ser adicionados √† degrada√ß√£o do desempenho, aumento do consumo de mem√≥ria e / ou aumento da carga no GC, mas isso depende mais de casos espec√≠ficos e pode n√£o ser t√£o cr√≠tico. </p><br><p>  Voc√™ tamb√©m deve adicionar o m√©todo <code>toSeq</code> do iterador ao cofrinho de rakes semelhantes, que retorna um <code>Stream</code> lento. </p><br><p>  <code>mapValues</code> acidente.  Foi usado em um m√©todo que, usando reflex√£o, criou um conjunto de manipuladores a partir da configura√ß√£o: as chaves eram os identificadores dos manipuladores e o valor eram suas configura√ß√µes, que foram ent√£o convertidas nos pr√≥prios manipuladores (a inst√¢ncia da classe foi criada).  Como os manipuladores consistiam apenas em fun√ß√µes puras, tudo funcionava sem problemas, e notavelmente n√£o afetava o desempenho (depois de fazer o rake, fizemos as medi√ß√µes). </p><br><p>  Mas uma vez eu tive que criar um sem√°foro em um dos manipuladores para que apenas um manipulador desempenhasse uma fun√ß√£o pesada, cujo resultado √© armazenado em cache e usado por outros manipuladores.  E ent√£o os problemas come√ßaram no ambiente de teste - o c√≥digo v√°lido que funcionava bem localmente come√ßou a falhar devido a problemas com o sem√°foro.  Obviamente, o primeiro pensamento com a inoperabilidade da nova funcionalidade √© que os problemas est√£o associados a ela mesma.  Ficamos com isso por um longo tempo at√© chegarmos √† conclus√£o "algum jogo, por que diferentes inst√¢ncias de manipuladores s√£o usadas?"  e foi apenas no rastreamento da pilha que eles nos encontraram para <code>mapValues</code> o <code>mapValues</code> . </p><br><p>  Se voc√™ estiver trabalhando com o Apache Spark, poder√° encontrar um problema semelhante quando descobrir repentinamente que, para algum trecho de c√≥digo elementar com <code>.mapValues</code> √© poss√≠vel detectar </p><br><pre> <code class="plaintext hljs">java.io.NotSerializableException: scala.collection.immutable.MapLike$$anon$2</code> </pre> <br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://stackoverflow.com/questions/32900862/map-can-not-be-serializable-in-scala</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">https://issues.scala-lang.org/browse/SI-7005</a> <br>  Mas o <code>map(identity)</code> resolve o problema e, geralmente, n√£o h√° motiva√ß√£o / tempo para aprofundar. </p><br><h2 id="zaklyuchenie">  Conclus√£o </h2><br><p>  Os erros podem estar ocultos nos lugares mais inesperados - mesmo nos m√©todos que parecem 100% √≥bvios.  Especificamente, esse problema, na minha opini√£o, est√° associado a um nome de m√©todo ruim e a um tipo de retorno insuficientemente rigoroso. </p><br><p>  Obviamente, √© importante estudar a documenta√ß√£o de todos os m√©todos usados ‚Äã‚Äãna biblioteca padr√£o, mas nem sempre √© √≥bvio e, francamente, nem sempre h√° motiva√ß√£o suficiente para ler sobre as "coisas √≥bvias". </p><br><p>  A computa√ß√£o pregui√ßosa sozinha √© uma piada bacana, e o artigo n√£o os encoraja a abandonar.  No entanto, quando a pregui√ßa n√£o √© √≥bvia - isso pode levar a problemas. </p><br><p>  Para ser <code>mapValues</code> , o problema com <code>mapValues</code> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">j√° apareceu em Habr√©</a> na tradu√ß√£o, mas, pessoalmente, aquele artigo que eu coloquei muito mal na minha cabe√ßa, porque  j√° havia muitas coisas b√°sicas / conhecidas e n√£o estava completamente claro qual poderia ser o perigo de usar essas fun√ß√µes: </p><br><blockquote>  O m√©todo filterKeys quebra a tabela de origem sem copiar nenhum elemento.  N√£o h√° nada errado com isso, mas voc√™ dificilmente espera esse comportamento das filterKeys </blockquote><p>  Ou seja, h√° uma observa√ß√£o sobre comportamento inesperado e, ao mesmo tempo, voc√™ tamb√©m pode pisar um pouco no rake, aparentemente, √© considerado improv√°vel. </p><br><p>  ‚Üí Todo o c√≥digo do artigo est√° nesta <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ess√™ncia</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt430538/">https://habr.com/ru/post/pt430538/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt430528/index.html">Programando com PyUSB 1.0</a></li>
<li><a href="../pt430530/index.html">Servidor simulado para automa√ß√£o de teste m√≥vel</a></li>
<li><a href="../pt430532/index.html">Seguran√ßa em aplicativos iOS</a></li>
<li><a href="../pt430534/index.html">Criando um modelo para o Zabbix usando o DVR Trassir SDK como exemplo</a></li>
<li><a href="../pt430536/index.html">Projetar fun√ß√µes da janela resumidas em uma unidade com um determinado n√≠vel de sobreposi√ß√£o</a></li>
<li><a href="../pt430542/index.html">Semin√°rio on-line aberto ‚ÄúInfraestrutura como um c√≥digo‚Äù</a></li>
<li><a href="../pt430546/index.html">"Acreditava-se que o c√≥digo seria substitu√≠do por diagramas UML, mas n√£o h√° necessidade de testar": uma entrevista com Alexei Barantsev</a></li>
<li><a href="../pt430548/index.html">Interrompe dispositivos externos em um sistema x86. Parte 1. A evolu√ß√£o dos controladores de interrup√ß√£o</a></li>
<li><a href="../pt430550/index.html">Construindo um sistema de componentes reativos com o Kotlin</a></li>
<li><a href="../pt430552/index.html">Inicializa√ß√£o do dia (setembro a outubro de 2018)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>