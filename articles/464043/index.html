<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üçß üíÜüèº üë©üèΩ‚Äç‚öïÔ∏è Historia del convertidor Ethernet-CAN üë©üèº‚Äçüöí üõ∏ üßîüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Un d√≠a claro y soleado para el trabajo necesitaba un convertidor de interfaz CAN a Ethernet econ√≥mico. Naturalmente, la b√∫squeda comenz√≥ con solucione...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Historia del convertidor Ethernet-CAN</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/464043/">  Un d√≠a claro y soleado para el trabajo necesitaba un convertidor de interfaz CAN a Ethernet econ√≥mico.  Naturalmente, la b√∫squeda comenz√≥ con soluciones listas para usar, pero, como suele suceder, al final se decidi√≥ desarrollar su propia muestra.  Naturalmente, el entusiasmo del autor no pudo resistirse y se limit√≥ a una funcionalidad tan "truncada".  Lo que surgi√≥, c√≥mo y por qu√©, debajo del corte. <br><br><img src="https://habrastorage.org/webt/9c/j9/x_/9cj9x_lrqkpkajyzd6irhhqkfmu.jpeg" alt="imagen"><br><a name="habracut"></a><br>  <b>Resumen general</b>  La foto de arriba muestra un modelo 3D de la placa que desarroll√© usando CAD Altium Designer.  Caracter√≠sticas y funcionalidad clave: <br><br><ul><li>  Ethernet de 10 \ 100 Mb </li><li>  Rtc </li><li>  MicroSD (FAT12, FAT16, FAT32) 4GB </li><li>  RS232 \ RS485 </li><li>  PUEDE </li><li>  Zumbador </li><li>  3 LED de usuario </li><li>  GPIO </li><li>  EEPROM 32 KB </li><li>  FLASH 2 MB </li><li>  I2C </li><li>  SPI </li><li>  UART </li><li>  SW \ JTAG </li><li>  USB serie (puerto COM) </li><li>  Potencia: miniUSB 5V \ Externo 9..24V </li></ul><br>  El costo del tablero recolectado es ~ 5000 R. El proyecto es de c√≥digo abierto en la naturaleza, las fuentes se pueden encontrar en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><b><u>github</u></b></a> .  Lo que result√≥ al final, adem√°s de la funcionalidad principal, puede considerarse una buena placa de depuraci√≥n para trabajar con el microcontrolador STM32. <br><br>  Y ahora a los detalles de la creaci√≥n. <br><br><h3>  <b>Hardware</b> </h3><br>  El estudio de este problema comenz√≥ con la b√∫squeda y evaluaci√≥n de soluciones preparadas.  Los requisitos principales fueron: <br><br><ol><li>  conversi√≥n de tramas entrantes CAN2.0B a paquetes TCP \ IP y viceversa; </li><li>  bajo costo, como resultado, la implementaci√≥n de un dispositivo basado en un microcontrolador. </li></ol><br>  Los colegas de China tienen varias soluciones industriales, pero no econ√≥micas, por lo que un representante del convertidor de interfaz PIRS CAN-Ethernet de producci√≥n nacional fue entregado a nuestra oficina para una prueba.  De acuerdo con las capacidades y caracter√≠sticas descritas, el dispositivo satisfizo la modesta T.Z., solo qued√≥ verificar el rendimiento en la pr√°ctica, lo que hice, armado con Wireshark y el osciloscopio.  Por una raz√≥n desconocida, al enviar paquetes al dispositivo TCP en la salida del dispositivo, donde se supon√≠a que deb√≠an aparecer tramas CAN, se escuchan secuencias con niveles f√≠sicos de CAN (par diferencial) pero protocolo l√≥gico de interfaz UART (con bits de inicio y parada).  Al abrir la caja, abrir la documentaci√≥n de los microcircuitos y hacer sonar las pistas de la placa, descubr√≠ que, de hecho, los pines RX y TX (UART) del microcontrolador est√°n conectados al transceptor CAN y est√°n conectados a un conector externo.  Por lo tanto, no se esperaba soporte de hardware para el est√°ndar CAN2.0B. <br><br>  Esto es lo que vi en la salida CANL de "PIRS CAN-Ethernet" al enviar dos bytes de datos [ <b>0xF0</b> ] y [ <b>0x0A</b> ] a trav√©s de TCP \ IP: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/6db/dca/c5a/6dbdcac5aec7d91503f4a5f86e28c42b.jpg" alt="imagen"><br><br>  El orden de los bits est√° al rev√©s, pero puede manejarlo mediante programaci√≥n, pero ya es m√°s dif√≠cil hacer algo a nivel de aplicaci√≥n con los bits de inicio y parada a trav√©s de cada byte, porque  Se insertan en el hardware. <br><br>  Y as√≠ es como deber√≠a verse la trama CAN2.0B "verdadera" con los mismos dos bytes de datos: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/674/9b2/244/6749b2244e3b9aa0b7564701f285131a.jpg" alt="imagen"><br><br>  Como puede ver en el oscilograma, adem√°s de los bytes de datos, la trama contiene muchos bits de servicio del protocolo m√°s bits de relleno, y lo m√°s importante, ¬°van continuamente sin ning√∫n bit de inicio y parada!  (Para aquellos que est√©n interesados, debajo del spoiler, una descripci√≥n detallada de este paquete). <br><br><div class="spoiler">  <b class="spoiler_title">Spoiler</b> <div class="spoiler_text"><img src="https://habrastorage.org/getpro/habr/post_images/54b/834/618/54b8346189dcb5ecdd01f83bcaab0e1b.jpg" alt="imagen"><br><br>  Los primeros 4 bytes son el identificador de trama.  Puede obtener m√°s informaci√≥n sobre el formato CAN en <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[1]</a> <br></div></div><br>  Por lo tanto, no me fue posible resolver el problema de incompatibilidad de los marcos CAN y UART con un m√©todo de software y, al observar los resultados de la investigaci√≥n intermedia con una mirada decepcionada, se decidi√≥ desarrollar nuestro propio prototipo del dispositivo requerido. <br><br>  Debido al hecho de que ahora era posible tomar el control de una gama m√°s amplia de caracter√≠sticas t√©cnicas del dispositivo, se agregaron los siguientes requisitos: <br><br>  3. La capacidad de alimentar de 12-24 V en sistemas de transporte; <br>  4. La presencia de memoria externa para almacenar registros; <br>  5. Las dimensiones de la placa no son m√°s de 86x80 mm. <br>  6. Rango de temperatura de funcionamiento -40..85 ¬∞  <br><br>  La conocida plataforma <b>STM32F407VET6</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[2]</a> fue seleccionada como el cerebro del nuevo dispositivo, que tiene soporte de hardware para todas las interfaces necesarias y un buen suministro de memoria RAM y FLASH.  Despu√©s de pulir Internet, el transceptor <b>DP83848IVV</b> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[3]</a> fue elegido como PHY Ethernet, que tiene, en mi opini√≥n, buena documentaci√≥n y suficientes ejemplos de esquemas de conexi√≥n y enrutamiento.  Como memoria externa no vol√°til para almacenar registros, eleg√≠ SPI FLASH 2 MB y SPI EEPROM para almacenar una variedad de configuraciones.  Adem√°s, se agreg√≥ protecci√≥n de energ√≠a contra sobretensi√≥n, inversi√≥n de polaridad.  Despu√©s de N noches y M fines de semana, se compil√≥ un diagrama de circuito y un rastro de la placa de circuito impreso del dispositivo de la primera versi√≥n.  Porque  hab√≠a suficiente espacio en el tablero, pero no quer√≠a dejar las patas MK inactivas, adem√°s de la funcionalidad principal, se agreg√≥ el tablero: <br><br><ul><li>  herramientas de depuraci√≥n SW, JTAG; </li><li>  Interruptor 8-DIP; </li><li>  micro-USB (serie USB); </li><li>  RS-232; </li><li>  UART </li><li>  I2C; </li><li>  GPIO </li></ul><br>  La idea era que, si fuera necesario, la placa estuviera lista para ampliar la funcionalidad mediante la instalaci√≥n de componentes adicionales.  Adem√°s, los asientos de repuesto no afectan el costo de producci√≥n.  Por un lado, desafortunadamente, debido a esto, no fue posible ajustar todo, por lo que el tablero result√≥ ser bilateral 86x80mm, min.  ancho de v√≠a 0.25 mm, di√°metro m√≠nimo del agujero 0.6 mm. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1da/700/38b/1da70038b98ca9c7019df4d0f984d5d2.jpg" alt="imagen"><br>  <i>La primera versi√≥n del dise√±o de PCB</i> <br><br>  M√°s tarde, se ordenaron dos muestras de prueba y se ensamblaron con un conjunto completo de perif√©ricos para investigaci√≥n.  Para ahorrar dinero, el tablero se hizo sin m√°scara y, por lo tanto, tiene un color tan inusual. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/db9/db1/5e4/db9db15e4cc7c7e0b2da0ed782d4a28b.jpg" alt="imagen"><br><br>  Con la ayuda de STM32CubeMX, esboc√© un firmware de prueba con una prueba de operatividad de los principales m√≥dulos perif√©ricos del dispositivo y, como primera aproximaci√≥n, todo funcion√≥, excepto para iniciar el MC desde un cuarzo externo de 8 MHz.  Result√≥ que, debido a mi error al elaborar la especificaci√≥n, se soldaron los condensadores de carga incorrectos.  Pero esto no impidi√≥ que el STM32F407 funcionara con un generador RC interno.  Cuando pude hacer ping a mi dispositivo, no hubo alegr√≠a alentadora.  He tomado m√°s tiempo con el rastreo PHY Ethernet.  Luego, en el navegador, vi mi p√°gina http de prueba y me tranquilic√© con las pruebas. <br><br>  La producci√≥n de las primeras muestras de tableros se orden√≥ en Zelenograd.  Y, a pesar del hecho de que el costo de "con" la m√°scara y "sin" fue casi dos veces diferente, no recomiendo hacerlo incluso en la etapa de prototipo, porque, por regla general, es en esta etapa donde aparecen los errores de rastreo y sucede algo soldadura  Pero emborracharse en las pistas "desnudas" es extremadamente desagradable, ahorrar dinero, pero casi ning√∫n nervio.  S√≠, y adivinar si hubo un breve descanso en alguna parte o si la traza es incorrecta, es un placer.  Debido a mi inexperiencia, soldando un resonador de cuarzo y condensadores de carga, mat√© una muestra. <br><br>  En ese momento, en el trabajo, en los contenedores hab√≠a una pieza de hierro capaz de resolver la tarea de conversi√≥n en el proyecto actual, pero, adem√°s del gran tama√±o y costo, al tener un firmware escrito, me encontr√© con problemas relacionados con el tama√±o de RAM y la funcionalidad truncada de la pila TCP \ IP MK LPC2368.  Entonces, el deseo de hacer que su dispositivo solo se intensifique. <br>  Despu√©s de estudiar cuidadosamente las deficiencias de la primera versi√≥n, yo, sin pensarlo dos veces, pas√© a la segunda.  Y de nuevo, quer√≠a agregar un "trabajo atrasado para el futuro", incorporando los siguientes componentes en el factor de forma anterior: <br><br><ul><li>  Soporte RTC con bater√≠a; </li><li>  RS-485; </li><li>  micro-SD; </li><li>  zumbador tweeter; </li><li>  la capacidad de alimentar desde USB; </li><li>  SPI al conector externo; </li><li>  Alimentaci√≥n de 5V y 3.3V a un conector externo. </li></ul><br>  Entre otras cosas, se agregaron protecci√≥n de corriente y diodos TVS en los conectores de usuario. <br><br>  El resultado es una especie de placa de desarrollo con la capacidad de conectar m√≥dulos externos.  Esta vez ped√≠ una tabla en China.  La asamblea se llev√≥ a cabo con nosotros. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/924/1b4/c09/9241b4c09c97f002b49cd58dab0ab45b.jpg" alt="imagen"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/bde/d6e/f48/bded6ef48b3f6910968a1ae26c7500f4.jpg" alt="imagen"><br>  <i>La segunda versi√≥n del tablero.</i> <br><br>  En la segunda versi√≥n, descubr√≠ el modelado 3D en Altium Designer, que ayud√≥ mucho a evitar errores en el posicionamiento relativo de los componentes en dos lados (result√≥ que Internet ya est√° llena de modelos listos para usar de componentes SMD <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[4]</a> ).  Por lo tanto, todos los errores de la primera versi√≥n fueron corregidos, las innovaciones mostraron su eficiencia, lo que me hizo muy feliz. <br><br><h3>  Firmware </h3><br>  La descripci√≥n del c√≥digo est√° m√°s all√° del alcance de esta parte, sin embargo, me gustar√≠a decir algunas palabras sobre el componente de software.  En mi dispositivo, decid√≠ usar la pila FreeRTOS + LwIP.  Hay un n√∫mero suficiente de art√≠culos sobre ellos, por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[5]</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">[6]</a> , por lo que no deber√≠a ser dif√≠cil vincularlos a su proyecto.  En resumen, LwIP es una pila TCP \ IP para sistemas embebidos, caracterizada por un bajo consumo de RAM y una API conveniente (incluso hay un shell de socket BCD).  Us√© la API de netconn.  Por medio de FreeRTOS, todo el trabajo de la pila TCP \ IP se coloca en una secuencia separada de la aplicaci√≥n.  Adem√°s del trabajo principal (conectar un servidor TCP externo al bus CAN), un servidor web independiente gira en una secuencia independiente para acceder a la configuraci√≥n del dispositivo.  Dicha interfaz web est√° dise√±ada para monitorear y configurar los ajustes del dispositivo, estableciendo diferentes modos de operaci√≥n, velocidades de transmisi√≥n, direcciones, etc.  Todav√≠a no s√© si ser√° posible realizar una actualizaci√≥n de firmware a trav√©s de √©l. <br><br><h3>  Conclusi√≥n </h3><br>  Este fue mi primer (y espero que no el √∫ltimo) proyecto de hardware de tanta complejidad y, a pesar de los errores cometidos, creo que la segunda versi√≥n del tablero puede considerarse exitosa.  En cada iteraci√≥n, hab√≠a muchas dudas, pero, sin embargo, una vez m√°s, estoy convencido de que si no lo intentas, seguramente nada resultar√°. <br><br><h3>  Fuentes utilizadas </h3><br>  1. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Wikipedia / Controller_Area_Network</a> <br>  2. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hoja de datos STM32F407VET6</a> <br>  3. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Hoja de datos DP83848</a> <br>  4. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Modelos 3D</a> <br>  5. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Introducci√≥n a FreeRTOS</a> <br>  6. <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Introducci√≥n a LwIP</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/464043/">https://habr.com/ru/post/464043/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../464027/index.html">C√≥mo sobrevivir al contenido en la era de la explosi√≥n de informaci√≥n</a></li>
<li><a href="../464031/index.html">"Finds of an Audiomaniac": tarjetas de sonido como una forma de sumergirse en la atm√≥sfera de una ciudad desconocida</a></li>
<li><a href="../464037/index.html">Noticias del mundo de OpenStreetMap No. 472 (30/07/2019 - 05.08.2019)</a></li>
<li><a href="../464039/index.html">Redes neuronales y aprendizaje profundo: un tutorial en l√≠nea, cap√≠tulo 6, parte 2: progreso reciente en el reconocimiento de im√°genes</a></li>
<li><a href="../464041/index.html">¬øPor qu√© los mejores pilotos de combate suelen meterse en grandes problemas?</a></li>
<li><a href="../464045/index.html">C√≥mo casi recorr√≠ carreras en tiempo real en 1997</a></li>
<li><a href="../464053/index.html">Nota: Selecci√≥n de pista y algoritmo de rotaci√≥n</a></li>
<li><a href="../464055/index.html">Estudiamos los datos recopilados por Xiaomi Mi Band para el a√±o</a></li>
<li><a href="../464057/index.html">Hilbert, Lebesgue ... y el vac√≠o</a></li>
<li><a href="../464063/index.html">Cortando el cable en 2019</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>