<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥀 👨‍👧 🦄 我们没有邮件和注册即可领取邮件 🈵 💃🏻 🤦🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="不到一个月后，我们决定是时候根据我们在OFFZONE-2018的演出结果来撰写文章。 第一篇文章将根据FastTrack的报告“没有短信和注册的MS Exchange中继攻击”执行。 

 进行RedTeam时，必须强制使用网络钓鱼-您可以在外围建立出色的防护，但是某些用户会导致网络钓鱼，并给攻击者...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>我们没有邮件和注册即可领取邮件</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432182/"> 不到一个月后，我们决定是时候根据我们在OFFZONE-2018的演出结果来撰写文章。 第一篇文章将根据FastTrack的报告“没有短信和注册的MS Exchange中继攻击”执行。 <br><br> 进行RedTeam时，必须强制使用网络钓鱼-您可以在外围建立出色的防护，但是某些用户会导致网络钓鱼，并给攻击者提供了立即进入网络的机会。 每个人都知道，对于网络钓鱼，他们主要使用指向用户需要单击的第三方站点的链接或带有宏的文档。 安全服务受到制裁的威胁会“培训”用户，他们说，在任何情况下都不要单击“启用内容”按钮。 原则上，成功是成功的-使用这种邮件的用户越来越少。 但是攻击者也不会停滞不前-网络钓鱼正变得越来越有趣。 客户还需要我们提供一些有趣的网络钓鱼邮件。 我们自己也对客户的员工被诱骗到网络钓鱼这一事实很感兴趣，我们可以向他们解释在收到信件时要寻找什么。 <br><a name="habracut"></a><br><h3> 为什么要使用这些网络钓鱼方法？ </h3><br> 许多公司将MS Exchange用作公司邮件服务器。 这对公司来说很方便，但对攻击者也很方便。 攻击者有兴趣从受害者的邮件发送消息，以及下载任何信件。 作为RedTeam，我们希望完全模仿攻击者的行为，并且我们希望对邮件执行相同的操作。 当然，在我们的情况下，邮件下载不完整，并且事先已通知客户。 对于机密信息，所有事物。 <br><br> 要执行这种操作，我们需要一个用户邮件会话。 首先要考虑的是如何拦截这样的会话。 我们决定使用较旧的NTLM中继（因为大多数公司仍在使用NTLM）。 是的，在Kerberos的情况下，它将无法正常工作-您可以关闭本文而不进一步阅读。 <br><br>  NTLM中继早已为人所知，并且有足够的实现方式。 我们也没有发明自行车，而是从Arno0x0x获得了GitHub的一种实现。 但是，一切并不是那么简单，我不得不添加一些内容。 即： <br><br><ul><li> 使所有东西都可以与所有现代版本的Windows OS一起使用（不适用于win10和win server2016）； </li><li> 使它与最后一个Impacket一起使用； </li><li> 添加方便的日志记录系统。 </li></ul><br> 可以在我们的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">github</a>上找到修改后的版本。 <br><br> 选择Microsoft Office文档作为传递容器，因为它们通常是通过公司邮件发送的，并且用户可以打开它们。 并且决定使用子文档（SubDocument），因为这是对文档的合法操作，并且没有防病毒软件会对此文件做出响应。 作为嵌套链接，您可以同时包含smb和http资源。 细节将在后面讨论。 <br><br><h3> 如何创建网络钓鱼文档？ </h3><br> 例如，考虑完全“干净”的文档mydoc3.docx，这是最常见的Microsoft Word文档。 <br><br><img src="https://habrastorage.org/webt/qh/fz/u4/qhfzu4immrvbunyhhtkquijf_6w.jpeg"><br><br> 任何Microsoft Office文档都是由xml组成的zip存档，最终形成了漂亮的文档。 为了制作附件文档，我们需要对扩展名为.rels的文件进行更改。 根据MS Office的版本，必须在document.xml.rels或settings.xml.rels中进行更改。 本文讨论Office 365并更改settings.xml.rels。 <br><br><img src="https://habrastorage.org/webt/gv/l_/el/gvl_el9spieruf3-oi7ebyn8kum.jpeg"><br><br> 作为附件，我们提供了指向该附件的资源的链接。 在我们的示例中，附件文档位于smb资源\\ 127.0.0.1 \ subdoctest \ <br><br><img src="https://habrastorage.org/webt/vo/8e/k6/vo8ek6cjbb3ujb25muzizw3dsis.jpeg"><br><br> 我们保存更改并打开收到的文档。 如果成功，文档将如下所示： <br><br><img src="https://habrastorage.org/webt/5s/rd/r6/5srdr6cwcqyckb-wa2hx5fdxfue.jpeg"><br><br> 但是，以这种形式，它引起用户的怀疑。 您需要对其进行一些更改，然后尝试使用各种样式和白色字体颜色隐藏链接。 <br><br><img src="https://habrastorage.org/webt/ss/xx/9q/ssxx9qy8acppddbgoxee3bjoi3q.jpeg"><br><br> 如此一来，我们收到了一个完全非可疑的文档，打开该文档时，Word本身将转到该资源，并随其注册为附件。 <br><br><h3> 一切都会到哪里来？ </h3><br> 该文档将在您的服务器上被敲（实际上，他们应该提供链接）。 该服务器可以是SMB服务器或HTTP服务器（请参见下面的情况）。 本文仅考虑从我们拦截了会话的用户的邮件发送消息的示例。 <br><br> 为了开始一切，最小的设置就足够了-最后的<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">Impacket</a> ， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">MSExchangeRelay</a>和Python2.7。 <br> 我们从以下命令开始一切： <br><br><pre><code class="plaintext hljs">python MsExchangeRelay.py -v -t https://exchange_addr/ews/exchange.asmx -r sendMail -d "example@email.com" -s Hello -m sampleMsg.html -o out.txt</code> </pre> <br><pre> <code class="plaintext hljs">exchange_addr –  exchange   example@email.com –           . -s Hello –   -m sampleMsg.html –  ,    -o out.txt –    .</code> </pre><br> 启动后，SMB和HTTP服务器在服务器上上升，它们正在等待与它们的连接。 <br><br><img src="https://habrastorage.org/webt/fb/v_/gd/fbv_gdeuf-sslphsu7dgwcolhym.jpeg"><br><br> 成功建立连接后，您可以查看用户登录时使用的登录名和IP地址： <br><br><img src="https://habrastorage.org/webt/b5/ql/nc/b5qlncntglraiglm3ssvhtdactc.jpeg"><br><br><h3> 现在如何申请？ </h3><br> 您可以在不同情况下使用此方法。 <br><br>  <b>情况1。外部入侵者，客户有一个传出的445端口</b> <br><br> 在这种情况下，您可以使用指向smb资源的链接。 这种链接的全部魅力在于，Windows不想再次打扰用户，只要她可以自己处理。 因此，当您打开带有smb-resource的链接的文档时，Windows本身会将用户的域信用发送给该资源。 即，用户什么也没有发生。 用户打开文档。 仅此而已。 怀疑不会引起任何后果。 而且我们已经有一个自定义的电子邮件会话。 <br> 仍然发现开放端口445（尽管很少见）。 因此，我们也考虑并保留它。 <br><br>  <b>案例2.内部入侵者</b> <br><br><img src="https://habrastorage.org/webt/ua/-n/rt/ua-nrturlt8wmhhttmjpxmtozgq.jpeg" align="left" width="300" height="1000"><br> 在这里，我们还将链接应用于smb资源。 如果成功拦截了会话，我们指示的信件将被发送到指示的邮寄地址。 <br><br>  <b>情况3。外部入侵者和传出端口445已关闭</b> <br><br><img src="https://habrastorage.org/webt/rk/hj/z7/rkhjz7iomq_a6g5wbtqeq65eh4q.jpeg" align="left" width="300" height="1000"><br> 我们可以使用指向HTTP服务器的链接。 但是，在这种情况下，一切对用户而言都不是那么透明。 当您打开文档时，用户将在Windows中看到一个标准窗口，要求您输入用户名和密码。 可能会使用户感到困惑的时刻是evil_http_server域名-它应与客户的交换域名尽可能相似。 <br><br><img src="https://habrastorage.org/webt/qg/mu/q1/qgmuq1qmzgin7fjeiwcrwjh-lug.jpeg" align="left" width="300"> 用户输入其积分后，我们得到他的会话并发送一封信。 <br><br><br><br><br><br><br><br><h3> 而不是结论 </h3><br>  NTLMRelay可以包装在不同的容器中，并提供完全不同的网络钓鱼用户方法。 尽管NTLM仍然存在，但这种攻击也仍然存在。 如此实验！ <br><br>  PS感谢OFFZONE-2018的组织者出色的会议！ </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN432182/">https://habr.com/ru/post/zh-CN432182/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN432172/index.html">危险邀请，或网络钓鱼电子邮件的战斗负荷如何工作</a></li>
<li><a href="../zh-CN432174/index.html">如何胜任和有效地开发软件产品</a></li>
<li><a href="../zh-CN432176/index.html">我们如何在Mono中使用Float的速度提高一倍</a></li>
<li><a href="../zh-CN432178/index.html">...以及对投影仪的保证-增加</a></li>
<li><a href="../zh-CN432180/index.html">如何通过GitHub促进职业发展</a></li>
<li><a href="../zh-CN432184/index.html">测试人员之间的问题身份</a></li>
<li><a href="../zh-CN432186/index.html">使用STP创建p2p通道</a></li>
<li><a href="../zh-CN432188/index.html">APT28黑客攻击了数百名捷克政府部门员工的电子邮件箱</a></li>
<li><a href="../zh-CN432190/index.html">Unity中的客户端物理预测</a></li>
<li><a href="../zh-CN432192/index.html">4个迹象表明您尚未准备好实施项目管理解决方案</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>