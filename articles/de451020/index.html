<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🥃 👨🏼‍🚒 🏁 Die Geschichte einer MySQL-Optimierung 🌝 👩🏼‍🤝‍👨🏽 📊</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Es geht um die Optimierung in der MySQL-Datenbank. 

 Dies geschah, als wir ein System für E-Mail-Newsletter erstellten. Unser System sollte täglich z...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Die Geschichte einer MySQL-Optimierung</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/451020/"> Es geht um die Optimierung in der MySQL-Datenbank. <br><br>  Dies geschah, als wir ein System für E-Mail-Newsletter erstellten.  Unser System sollte täglich zig Millionen Briefe senden.  Das Senden eines Briefes ist keine leichte Aufgabe, obwohl alles ziemlich primitiv aussieht: <br><br><ol><li>  Sammeln Sie einen Brief von HTML Creative und ersetzen Sie personalisierte Daten. </li><li>  Fügen Sie ein Pixel zum Anzeigen von Nachrichten hinzu und ersetzen Sie alle Links in der Nachricht durch Ihre eigenen, um Klicks zu verfolgen. </li><li>  Überprüfen Sie vor dem Senden, ob die E-Mail nicht auf der schwarzen Liste steht. </li><li>  Senden Sie eine E-Mail an einen bestimmten Pool. </li></ol><br>  Ich werde Ihnen mehr über den zweiten Absatz erzählen: <a name="habracut"></a><br>  Microservice Mail-Builder bereitet einen Brief zum Senden vor: <br><br><ul><li>  findet alle Links im Brief; </li><li>  Für jeden Link wird eine eindeutige UUID mit 32 Zeichen generiert. </li><li>  Ersetzt den ursprünglichen Link durch einen neuen und speichert die Daten in der Datenbank. </li></ul><br>  Daher werden alle Quelllinks durch uuid ersetzt und die Domain wird in unsere geändert.  Wenn Sie über diesen Link eine GET-Anfrage erhalten, stellen wir das Originalbild als Proxy zur Verfügung oder leiten zum Originallink weiter.  Das Speichern erfolgt in der MySQL-Datenbank. Wir speichern die generierte UUID zusammen mit dem ursprünglichen Link und einigen Metainformationen (Benutzer-E-Mail, Mailing-ID und andere Daten).  Die Denormalisierung hilft uns bei einer Anfrage, alle erforderlichen Daten zum Speichern von Statistiken abzurufen oder eine Art Trigger-Kette zu starten. <br><br><h4>  Problem Nummer 1 </h4><br>  Die Erzeugung von UUID in uns hing vom Zeitstempel ab. <br><br>  Da Mailings normalerweise in einem bestimmten Zeitraum stattfinden und viele Instanzen von Microservice zum Zusammenstellen eines Briefes gestartet werden, stellte sich heraus, dass einige der Benutzeroberflächen sehr ähnlich waren.  <s>Dies ergab eine geringe Selektivität.</s>  UPD: Da die Daten ähnlich waren, war die Arbeit mit dem Bi-Tree nicht sehr effektiv. <br><br>  Wir haben dieses Problem mit dem uuid-Modul in Python gelöst, bei dem keine Zeitabhängigkeit besteht. <br>  Solch eine implizite Sache reduzierte die Geschwindigkeit von Indizes. <br><br>  Wie läuft die Lagerung? <br><br>  Die Struktur der Tabelle war wie folgt: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`Messages`</span></span> ( <span class="hljs-string"><span class="hljs-string">`UUID`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`Message`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`Inserted`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`UUID`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br>  Zum Zeitpunkt der Erstellung sah alles logisch aus: <br>  UUID ist ein Primärschlüssel und auch ein Clustered-Index.  Wenn wir in diesem Feld eine Auswahl treffen, wählen wir einfach den Datensatz aus, da alle Werte genau dort gespeichert sind.  Dies war eine bewusste Entscheidung.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Erfahren Sie mehr über den Clustered-Index.</a> <br><br>  Alles war großartig, bis der Tisch wuchs. <br><br><h4>  Problem Nummer 2 </h4><br>  Wenn Sie mehr über den Cluster-Index lesen, können Sie sich über diese Nuance informieren: <br><blockquote>  Wenn Sie der Tabelle eine neue Zeile hinzufügen, wird diese nicht am Ende der Datei, nicht am Ende der flachen Liste, sondern durch Sortieren zu dem gewünschten Zweig der ihr entsprechenden Baumstruktur hinzugefügt. </blockquote>  Somit nahm mit zunehmender Last die Einführzeit zu. <br><br>  Die Lösung bestand darin, eine andere Tabellenstruktur zu verwenden. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> <span class="hljs-string"><span class="hljs-string">`Messages`</span></span> ( <span class="hljs-string"><span class="hljs-string">`ID`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>(<span class="hljs-number"><span class="hljs-number">11</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> AUTO_INCREMENT, <span class="hljs-string"><span class="hljs-string">`UUID`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">32</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`Message`</span></span> <span class="hljs-keyword"><span class="hljs-keyword">json</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-string"><span class="hljs-string">`Inserted`</span></span> <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> (<span class="hljs-string"><span class="hljs-string">`ID`</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">UNIQUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> <span class="hljs-string"><span class="hljs-string">`UUID`</span></span> (<span class="hljs-string"><span class="hljs-string">`UUID`</span></span>, <span class="hljs-string"><span class="hljs-string">`Inserted`</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">ENGINE</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">InnoDB</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CHARSET</span></span>=utf8;</code> </pre> <br>  Da der Primärschlüssel jetzt automatisch inkrementiert wird und MySQL den Cache der letzten Einfügestelle speichert, erfolgt die Einfügung jetzt immer am Ende, d. H. Innodb ist für das Schreiben von sequentiell ansteigenden Werten optimiert. <br><br>  Die Details dieser Optimierung habe ich im <a href="">Postgres-Quellcode gefunden.</a>  MySQL implementiert eine sehr ähnliche Optimierung. <br>  Natürlich musste ich einen eindeutigen Schlüssel hinzufügen, damit es keine Konflikte gab, aber wir haben die Einfügegeschwindigkeit erhöht. <br><br>  Da die Basis noch weiter wächst, haben wir darüber nachgedacht, alte Daten zu löschen.  Die Verwendung von DELETE für das Feld Inserted ist absolut nicht optimal - dies ist eine sehr lange Zeit, und der Platz wird erst freigegeben, wenn wir den Befehl <i>optimize table</i> ausführen.  Diese Operation blockiert übrigens den Tisch komplett - das hat uns überhaupt nicht gepasst. <br><br>  Aus diesem Grund haben wir beschlossen, unsere Tabelle in Partitionen aufzuteilen. <br>  1 Tag - 1 Partition, die alten werden automatisch gelöscht, wenn die Zeit gekommen ist. <br><br><h4>  Problem Nummer 3 </h4><br>  Wir hatten die Möglichkeit, die alten Daten zu löschen, aber wir hatten nicht die Möglichkeit, aus der gewünschten Partition auszuwählen, da mysql mit select`e nur uuid angibt, nicht weiß, in welcher Partition wir danach suchen sollen, und in allen sucht. <br><br>  Die Lösung wurde aus Problem 1 geboren - fügen Sie der generierten UUID einen Zeitstempel hinzu.  Nur diesmal haben wir etwas anders gemacht: Wir haben einen Zeitstempel an einer zufälligen Stelle in der Zeile eingefügt, nicht am Anfang oder am Ende;  vorher und nachher haben sie <i>ein Strichsymbol</i> hinzugefügt, damit es mit einem regulären Ausdruck erhalten werden kann. <br><br>  Mit dieser Optimierung konnten wir das Datum abrufen, an dem die UUID generiert wurde, und bereits eine Auswahl treffen, die den spezifischen Wert des Felds Einfügen angibt.  Jetzt lesen wir die Daten sofort von der Partition, die wir benötigen. <br><br>  Dank Dingen wie <i>ROW_FORMAT = COMPRESSED</i> und der Änderung der Codierung in <i>latin1</i> konnten wir noch mehr Speicherplatz auf der Festplatte sparen. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de451020/">https://habr.com/ru/post/de451020/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de451008/index.html">End2End-Ansatz zum Verständnis der gesprochenen Sprache</a></li>
<li><a href="../de451010/index.html">Oh ätzend und nicht sehr</a></li>
<li><a href="../de451012/index.html">Zufällige Permutationen und zufällige Partitionen</a></li>
<li><a href="../de451014/index.html">Ansturm, Drang oder Durchbruch? Wir sagen die ganze Wahrheit über den größten Hackathon des Landes</a></li>
<li><a href="../de451018/index.html">Geh dorthin - ich weiß nicht wo</a></li>
<li><a href="../de451026/index.html">Warum haben wir so wenig vom frühen Internet übrig?</a></li>
<li><a href="../de451028/index.html">Leitfaden: Arten von Aufsätzen in englischer Sprache und Tipps zum Schreiben</a></li>
<li><a href="../de451032/index.html">Schreiben von HTTP / 1.1- und HTTP / 2-Clients und -Servern in Golang</a></li>
<li><a href="../de451034/index.html">Phantom-SQL-Abfragen</a></li>
<li><a href="../de451040/index.html">Runaway Fun im Mai oder Standoff Approaching</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>