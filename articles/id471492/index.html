<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🐃 👰🏽 🤰 Bagaimana cara memeriksa ketersediaan penawaran pengantar di iOS 👷🏻 ⛎ 🚜</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Jika Anda menggunakan penawaran pengantar dalam aplikasi berlangganan Anda (uji coba, membayar sesuai penggunaan atau prabayar), maka sebelum Anda men...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Bagaimana cara memeriksa ketersediaan penawaran pengantar di iOS</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/apphud/blog/471492/"><p>  Jika Anda menggunakan penawaran pengantar dalam aplikasi berlangganan Anda (uji coba, membayar sesuai penggunaan atau prabayar), maka sebelum Anda menunjukkan harga pada layar pembayaran, Anda perlu menentukan ketersediaan penawaran pengantar kepada pengguna.  Jika pengguna telah menyusun uji coba, maka Anda harus menampilkan harga penuh untuk itu. </p><br><p><img src="https://habrastorage.org/webt/if/dt/bv/ifdtbvunalbndzwrl1uesyv9-9m.png" alt="gambar"></p><br><p>  Hai semuanya, saya menghubungi Renat dari <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apphud</a> - layanan yang menyederhanakan pekerjaan dengan langganan di aplikasi iOS.  Hari ini saya akan memberi tahu Anda cara menentukan apakah pengguna tunggal memiliki hak untuk mengaktifkan kalimat pengantar atau tidak. <a name="habracut"></a></p><br><p>  Tawaran pengantar valid dalam kelompok berlangganan yang sama.  Ini berarti bahwa pengguna dapat mengeluarkan langganan mingguan reguler tanpa uji coba, berhenti berlangganan, dan kemudian menerbitkan uji coba untuk berlangganan bulanan. </p><br><p>  Dokumentasi Apple memiliki diagram yang menunjukkan kapan kalimat pengantar tersedia untuk pengguna: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/370/0fb/494/3700fb494140a08886656f52e6c8f493.png"></p><br><p>  Ternyata pengguna dapat menggunakan kalimat pengantar jika: </p><br><ul><li>  dia belum pernah menggunakan kalimat pengantar sebelumnya </li></ul><br><p>  <strong>Dan</strong> </p><br><ul><li>  berlangganan belum diterbitkan atau telah kedaluwarsa </li></ul><br><p>  Untuk memeriksa ketersediaan kalimat pengantar, Anda perlu melakukan 3 langkah: </p><br><p>  1) Validasi App Store-cek dan tarik keluar array transaksi.  Jika tidak ada transaksi, maka kami tidak memeriksa apa pun, tersedia kalimat pengantar.  Jika ada transaksi, maka lakukan dua langkah berikut. </p><br><p>  2) Periksa apakah kalimat pengantar sebelumnya digunakan </p><br><p>  3) Periksa status berlangganan saat ini </p><br><p>  Mari kita pertimbangkan langkah-langkah ini secara lebih rinci. </p><br><h3 id="1-validaciya-app-store-cheka">  1. Validasi cek App Store </h3><br><p> Untuk memvalidasi cek, Anda harus mengirim permintaan ke Apple, melewati <code>receiptData</code> dan <code>sharedSecret</code> .  Ganti nilai <code>sharedSecret</code> dengan milik Anda.  Jika Anda tidak tahu <code>sharedSecret</code> Anda, maka dijelaskan di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> tempat untuk mendapatkannya. </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isEligibleForIntroductory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(callback: @escaping </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">(Bool)</span></span></span></span></span></span> -&gt; <span class="hljs-type"><span class="hljs-type">Void</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">guard</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> receiptUrl = <span class="hljs-type"><span class="hljs-type">Bundle</span></span>.main.appStoreReceiptURL <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { callback(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } #<span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-type"><span class="hljs-type">DEBUG</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> urlString = <span class="hljs-string"><span class="hljs-string">"https://sandbox.itunes.apple.com/verifyReceipt"</span></span> #<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> urlString = <span class="hljs-string"><span class="hljs-string">"https://buy.itunes.apple.com/verifyReceipt"</span></span> #endif <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> receiptData = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>? <span class="hljs-type"><span class="hljs-type">Data</span></span>(contentsOf: receiptUrl).base64EncodedString() <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> sharedSecret = <span class="hljs-string"><span class="hljs-string">"YOUR_SHARED_SECRET"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> requestData = [<span class="hljs-string"><span class="hljs-string">"receipt-data"</span></span> : receiptData ?? <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span> : sharedSecret, <span class="hljs-string"><span class="hljs-string">"exclude-old-transactions"</span></span> : <span class="hljs-literal"><span class="hljs-literal">false</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> [<span class="hljs-type"><span class="hljs-type">String</span></span> : <span class="hljs-type"><span class="hljs-type">Any</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-type"><span class="hljs-type">URLRequest</span></span>(url: <span class="hljs-type"><span class="hljs-type">URL</span></span>(string: urlString)!) request.httpMethod = <span class="hljs-string"><span class="hljs-string">"POST"</span></span> request.setValue(<span class="hljs-string"><span class="hljs-string">"Application/json"</span></span>, forHTTPHeaderField: <span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">let</span></span> httpBody = <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>? <span class="hljs-type"><span class="hljs-type">JSONSerialization</span></span>.data(withJSONObject: requestData, options: []) request.httpBody = httpBody <span class="hljs-type"><span class="hljs-type">URLSession</span></span>.shared.dataTask(with: request) { (data, response, error) <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-comment"><span class="hljs-comment">// continue here }.resume() }</span></span></code> </pre> <br><blockquote>  Contoh di atas menggunakan makro <code>#if DEBUG</code> untuk menentukan jenis langganan: <code>sandbox</code> atau <code>production</code> .  Jika Anda menggunakan makro lain, maka Anda harus memperbarui kode di tempat ini. </blockquote><br><h3 id="2-proverka-ispolzovalos-li-vvodnoe-predlozhenie-ranee">  2. Periksa apakah kalimat pengantar telah digunakan sebelumnya </h3><br><p>  Setelah menerima respons dari Apple, kami menerjemahkannya ke dalam <code>Dictionary</code> dan mendapatkan berbagai transaksi: </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// paste this code after "continue here" comment guard let data = data, let json = try? JSONSerialization.jsonObject(with: data, options: .allowFragments) as? [String : AnyHashable], let receipts_array = json["latest_receipt_info"] as? [[String : AnyHashable]] else { callback(true) return } // continue here</span></span></code> </pre> <br><p>  Kami pergi melalui array transaksi dan melihat nilai-nilai <code>is_trial_period</code> dan <code>is_in_intro_offer_period</code> .  Jika salah satu dari nilai-nilai itu <code>true</code> , maka pengguna telah menyusun kalimat pengantar.  Nilai-nilai ini datang sebagai string, jadi untuk keandalan kami akan mencoba untuk mengkonversi nilai di Bool dan string. </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// paste this code after "continue here" comment var latestExpiresDate = Date(timeIntervalSince1970: 0) let formatter = DateFormatter() for receipt in receipts_array { let used_trial : Bool = receipt["is_trial_period"] as? Bool ?? false || (receipt["is_trial_period"] as? NSString)?.boolValue ?? false let used_intro : Bool = receipt["is_in_intro_offer_period"] as? Bool ?? false || (receipt["is_in_intro_offer_period"] as? NSString)?.boolValue ?? false if used_trial || used_intro { callback(false) return } // continue here</span></span></code> </pre> <br><h3 id="3-proverka-tekuschego-statusa-podpiski">  3. Memeriksa status langganan saat ini </h3><br><p>  Untuk mengetahui status langganan saat ini, kami perlu menemukan tanggal <code>expires_date</code> terbaru dan bandingkan dengan tanggal saat ini.  Jika langganan belum kedaluwarsa, penawaran pengantar tidak tersedia: </p><br><pre> <code class="swift hljs"><span class="hljs-comment"><span class="hljs-comment">// paste this code after "continue here" comment formatter.dateFormat = "yyyy-MM-dd HH:mm:ss VV" if let expiresDateString = receipt["expires_date"] as? String, let date = formatter.date(from: expiresDateString) { if date &gt; latestExpiresDate { latestExpiresDate = date } } } if latestExpiresDate &gt; Date() { callback(false) } else { callback(true) }</span></span></code> </pre> <br><p>  Anda dapat menemukan tautan ke kode lengkap metode ini di akhir artikel, namun, ada banyak "Tapi" dalam metode ini. </p><br><h2 id="podvodnye-kamni">  Perangkap </h2><br><ul><li><p>  Dalam contoh ini, kami hanya melihat kasus satu grup berlangganan.  Jika Anda menggunakan lebih dari satu grup berlangganan dalam aplikasi, maka Anda harus memberikan pengenal grup berlangganan ke metode ini dan memverifikasinya dengan nilai <code>subscription_group_identifier</code> sebagai <code>receipt</code> . </p><br></li><li><p>  Dalam contoh ini, kasus pengembalian uang berlangganan tidak diperhitungkan.  Untuk melakukan ini, periksa keberadaan bidang <code>cancellation_date</code> : </p><br><pre> <code class="swift hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> receipt[<span class="hljs-string"><span class="hljs-string">"cancellation_date"</span></span>] != <span class="hljs-literal"><span class="hljs-literal">nil</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// if user made a refund, no need to check for eligibility callback(false) return }</span></span></code> </pre> <br></li><li><p>  Dan di sini masa tenggang (Billing Grace Period) tidak diperhitungkan.  Jika pengguna dalam masa tenggang pada saat cek divalidasi, maka <code>pending_renewal_info</code> akan memiliki bidang <code>grace_period_expires_date</code> .  Dalam hal ini, Anda sebagai pengembang harus memberikan fungsionalitas premium kepada pengguna tanpa menampilkan layar pembayaran.  Dan karenanya, tidak masuk akal untuk memeriksa ketersediaan kalimat pengantar. </p><br></li><li><p>  Ada masalah dengan memeriksa tanggal kedaluwarsa.  Waktu sistem pada perangkat iOS dapat dibuka dan kemudian kode kami akan memberikan hasil yang salah: langganan akan dianggap aktif. </p><br></li><li><p>  Validasi cek pada perangkat itu sendiri tidak direkomendasikan oleh Apple.  Mereka berbicara tentang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">ini</a> beberapa kali <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">di WWDC</a> (dari 5:50) dan ini ditunjukkan dalam <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dokumentasi</a> .  Ini tidak aman karena penyerang dapat mencegat data menggunakan serangan man-in-the-middle.  Apple merekomendasikan penggunaan server Anda untuk memvalidasi cek. </p><br></li></ul><br><h2 id="proverka-dostupnosti-promo-predlozheniya">  Memeriksa ketersediaan penawaran promosi </h2><br><p>  Syarat untuk ketersediaan penawaran promosi lebih sederhana - yang utama adalah bahwa pengguna memiliki langganan aktif atau kedaluwarsa.  Untuk melakukan ini, cari keberadaan <code>pending_renewal_info</code> untuk grup berlangganan Anda. </p><br><h2 id="kak-eto-realizovano-v-apphud-sdk">  Bagaimana itu diterapkan dalam Apphud SDK </h2><br><p>  Cukup memanggil satu metode, meneruskan <code>product</code> Anda ke dalamnya, yang akan mengembalikan hasilnya kepada Anda: </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Apphud</span></span>.checkEligibilityForIntroductoryOffer(product: myProduct) { result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result { <span class="hljs-comment"><span class="hljs-comment">// User is eligible to purchase introductory offer } }</span></span></code> </pre> <br><p>  Dan juga untuk penawaran promosi: </p><br><pre> <code class="swift hljs"><span class="hljs-type"><span class="hljs-type">Apphud</span></span>.checkEligibilityForPromotionalOffer(product: myProduct) { result <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> result { <span class="hljs-comment"><span class="hljs-comment">// User is eligible to purchase promotional offer } }</span></span></code> </pre> <br><p>  Ada juga metode untuk memeriksa ketersediaan beberapa produk sekaligus dalam satu panggilan: </p><br><pre> <code class="swift hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkEligibilitiesForIntroductoryOffers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(products: [SKProduct], callback: ApphudEligibilityCallback)</span></span></span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkEligibilitiesForPromotionalOffers</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(products: [SKProduct], callback: ApphudEligibilityCallback)</span></span></span></span></code> </pre> <br><h2 id="zaklyuchenie">  Kesimpulan </h2><br><p>  Kode metode lengkap dapat diunduh di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">sini</a> . </p><br><blockquote>  Kami di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apphud</a> telah menerapkan pemeriksaan pada ketersediaan penawaran pengantar dan promosi di SDK open-source yang nyaman.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">Apphud juga</a> membantu Anda melacak status berlangganan, menganalisis metrik kunci, secara otomatis menawarkan diskon kepada pengguna yang tidak berlangganan, dan banyak lagi.  Jika Anda mengalami sakit saat bekerja dengan langganan, cobalah <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">solusi kami</a> secara gratis. </blockquote></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id471492/">https://habr.com/ru/post/id471492/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id471472/index.html">Security Week 42: backdoors hardware, kerentanan di Intel NUC</a></li>
<li><a href="../id471474/index.html">Life hack - menulis dan meng-host situs web dengan buku tamu di cloud secara gratis</a></li>
<li><a href="../id471480/index.html">Bagaimana cara menciptakan tim produk yang efektif?</a></li>
<li><a href="../id471482/index.html">CLRium # 6: Concurrency & Parallelism. Dua hari: dari prosesor ke async / menunggu</a></li>
<li><a href="../id471484/index.html">Model transfer sepakbola: menggali lebih dalam</a></li>
<li><a href="../id471496/index.html">Sedikit tentang model berlangganan di App Store</a></li>
<li><a href="../id471498/index.html">Peta kamera fiksasi jalan dibuat publik: bersukacita atau menangis?</a></li>
<li><a href="../id471500/index.html">Callback atau “Meningkatkan loyalitas pelanggan”</a></li>
<li><a href="../id471502/index.html">Pertanian Ide</a></li>
<li><a href="../id471504/index.html">Duet dua dimensi: pembuatan heterostruktur borofen-graphene</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>