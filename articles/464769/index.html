<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üà∑Ô∏è üòï üßëüèæ‚Äçü§ù‚Äçüßëüèª C√≥mo Badoo hizo posible entregar 200k fotos por segundo üë©üèø‚Äçü§ù‚Äçüë®üèΩ üëßüèΩ ‚≠êÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="La web moderna es casi impensable sin contenido de medios: casi todas nuestras abuelas tienen tel√©fonos inteligentes, todos se sientan en las redes so...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo Badoo hizo posible entregar 200k fotos por segundo</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/itsumma/blog/464769/"><img src="https://habrastorage.org/webt/nb/5y/nk/nb5ynk5k1etitvy2atx-ucuvovo.jpeg"><br><br>  <i>La web moderna es casi impensable sin contenido de medios: casi todas nuestras abuelas tienen tel√©fonos inteligentes, todos se sientan en las redes sociales y el tiempo de inactividad del servicio es costoso para las empresas.</i>  <i>Para su atenci√≥n, hay una transcripci√≥n de la historia de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Badoo</a> sobre c√≥mo organiz√≥ la entrega de fotos usando una soluci√≥n de hardware, qu√© problemas de rendimiento encontr√≥ en el proceso, qu√© los caus√≥ y c√≥mo se resolvieron estos problemas usando una soluci√≥n de software basada en Nginx, al tiempo que garantiza tolerancia a fallas en todos los niveles ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">video</a> ).</i>  <i>Agradecemos a los autores de la historia Oleg <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Sannis</a> Efimov y Alexander Dymov, quienes compartieron su experiencia en la conferencia del <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">d√≠a 4 de tiempo de actividad</a> .</i> <br><br>  - Comencemos con una breve introducci√≥n sobre c√≥mo almacenamos y almacenamos en cach√© las fotos.  Tenemos una capa en la que los almacenamos, y una capa donde almacenamos las fotos en cach√©.  Al mismo tiempo, si queremos lograr un gran √©xito y reducir la carga en cientos, es importante para nosotros que cada foto de un usuario individual se encuentre en un servidor de almacenamiento en cach√©.  De lo contrario, tendr√≠amos que poner tantas veces m√°s discos, cu√°ntos servidores m√°s tenemos.  Tenemos una tasa de √©xito de alrededor del 99%, es decir, reducimos la carga en nuestro almacenamiento 100 veces, y para hacer esto, incluso hace 10 a√±os, cuando todo esto se construy√≥, ten√≠amos 50 servidores.  En consecuencia, para dar estas fotos, necesit√°bamos esencialmente 50 dominios externos a los que sirven estos servidores. <br><br>  Naturalmente, la pregunta surgi√≥ de inmediato: si un servidor cae, no estar√° disponible, ¬øqu√© parte del tr√°fico estamos perdiendo?  Analizamos lo que hay en el mercado y decidimos comprar una pieza de hierro para resolver todos nuestros problemas.  La elecci√≥n recay√≥ en la decisi√≥n de la compa√±√≠a de la red F5 (que, por cierto, recientemente compr√≥ NGINX, Inc): BIG-IP Local Traffic Manager. <br><br><a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/gl/lt/x_/glltx_2wbktn7afopuptee7te3i.jpeg"><br><br>  Lo que hace esta pieza de hardware (LTM): es un enrutador de hierro que hace la redundancia de hierro de sus puertos externos y le permite enrutar el tr√°fico en funci√≥n de la topolog√≠a de la red, en algunas configuraciones, y realiza comprobaciones de estado.  Para nosotros era importante que esta pieza de hierro se pueda programar.  En consecuencia, podr√≠amos describir la l√≥gica de c√≥mo se proporcionaron las fotograf√≠as de un usuario espec√≠fico desde un cach√© en particular.  ¬øC√≥mo se ve?  Hay una pieza de hierro que se ve en Internet en un dominio, una ip, descarga ssl, analiza las solicitudes http, desde IRule selecciona el n√∫mero de cach√© a d√≥nde ir y deja que el tr√°fico vaya all√≠.  Al mismo tiempo, realiza comprobaciones de estado y, si alguna m√°quina no est√° disponible, la realizamos en ese momento para que el tr√°fico fuera a un servidor de respaldo.  Desde el punto de vista de la configuraci√≥n, hay, por supuesto, algunos matices, pero en general todo es bastante simple: prescribimos una tarjeta, hacemos coincidir alg√∫n n√∫mero con nuestra IP en la red, decimos que escucharemos en los puertos 80 y 443, decimos, que si el servidor no est√° disponible, debe iniciar el tr√°fico en la copia de seguridad, en este caso el 35, y describimos un mont√≥n de l√≥gica sobre c√≥mo se debe desmontar esta arquitectura.  El √∫nico problema era que el lenguaje que programaba la pieza de hardware era Tcl.  Si alguien recuerda esto ... este lenguaje es m√°s de solo escritura que un lenguaje conveniente para la programaci√≥n: <br><br><img src="https://habrastorage.org/webt/xf/gy/ue/xfgyueega0zhzhix25pnjakfjfu.jpeg"><br><br>  Que conseguimos  Obtuvimos un hardware que brinda alta disponibilidad de nuestra infraestructura, enruta todo nuestro tr√°fico, brinda cuidados de salud y simplemente funciona.  Adem√°s, ha estado funcionando durante bastante tiempo: en los √∫ltimos 10 a√±os no ha habido quejas al respecto.  A principios de 2018, ya est√°bamos entregando unas 80k fotos por segundo.  Esto es alrededor de 80 gigabits de tr√°fico de nuestros dos centros de datos. <br><br>  Sin embargo ... <br><br>  A principios de 2018, vimos una imagen fea en las listas: el tiempo de respuesta de las fotos aument√≥ claramente.  Y ha dejado de satisfacernos.  El problema es que este comportamiento solo era visible en el pico del tr√°fico; para nuestra compa√±√≠a, esta es la noche de domingo a lunes.  Pero el resto del tiempo, el sistema se comport√≥ como de costumbre, sin signos de da√±o. <br><br><img src="https://habrastorage.org/webt/ww/1t/tz/ww1ttzampqzhtb1mvscc2ib3pfm.jpeg"><br><br>  Sin embargo, el problema tuvo que ser resuelto.  Identificamos posibles cuellos de botella y comenzamos a eliminarlos.  En primer lugar, por supuesto, ampliamos los enlaces ascendentes externos, realizamos una auditor√≠a completa de los enlaces ascendentes internos, encontramos todos los posibles cuellos de botella.  Pero todo esto no dio un resultado obvio, el problema no desapareci√≥. <br><br>  Otro posible cuello de botella fue el rendimiento de las fotos en cach√©.  Y decidimos que quiz√°s el problema descansa en ellos.  Bueno, ampliamos el rendimiento, principalmente puertos de red en cach√©s de fotos.  Pero, de nuevo, no se observ√≥ una mejora aparente.  Al final, prestamos mucha atenci√≥n al rendimiento de LTM en s√≠, y aqu√≠ vimos una imagen triste en los gr√°ficos: la carga de todas las CPU comienza a funcionar sin problemas, pero luego se apoya bruscamente en el estante.  Al mismo tiempo, LTM deja de responder adecuadamente a las comprobaciones de estado y enlaces ascendentes y comienza a apagarlos al azar, lo que conduce a una grave degradaci√≥n del rendimiento. <br><br>  Es decir, identificamos la fuente del problema, identificamos el cuello de botella.  Queda por decidir qu√© haremos. <br><br><img src="https://habrastorage.org/webt/60/ag/ol/60agoludj9nti0oablc3dagetji.jpeg"><br><br>  Lo primero que sugiere que podr√≠amos tomar es actualizar de alguna manera LTM.  Pero hay algunos matices, porque este hierro es bastante √∫nico, no ir√°s al supermercado m√°s cercano y no lo comprar√°s.  Este es un contrato por separado, un contrato de licencia por separado, y tomar√° mucho tiempo.  La segunda opci√≥n es comenzar a pensar en usted mismo, idear su propia soluci√≥n en sus componentes, preferiblemente utilizando un programa de acceso abierto.  Solo queda decidir qu√© elegiremos exactamente para esto y cu√°nto tiempo dedicaremos a resolver este problema, porque los usuarios no han recibido fotos.  Por lo tanto, todo esto debe hacerse muy, muy r√°pido, se podr√≠a decir, ayer. <br><br>  Dado que la tarea sonaba como "hacer algo lo m√°s r√°pido posible y usar el hardware que tenemos", lo primero que pensamos fue simplemente eliminar algunas de las m√°quinas que no son las m√°s potentes del frente, poner Nginx con el que sabemos c√≥mo trabajar e intentamos implementar toda la l√≥gica que sol√≠a hacer la pieza de hierro.  De hecho, dejamos nuestro hardware, configuramos 4 servidores m√°s que tuvimos que configurar, creamos dominios externos para ellos, de forma similar a como era hace 10 a√±os ... Perdimos un poco de disponibilidad si estas m√°quinas fallaban, pero menos resuelto el problema de nuestros usuarios a nivel local. <br><br>  En consecuencia, la l√≥gica sigue siendo la misma: ponemos Nginx, puede hacer una descarga SSL, de alguna manera podemos programar la l√≥gica de enrutamiento, verificar el estado de las configuraciones y simplemente duplicar la l√≥gica que ten√≠amos antes. <br><br>  Nos sentamos a escribir configuraciones.  Al principio parec√≠a que todo era muy simple, pero, desafortunadamente, es muy dif√≠cil encontrar manuales para cada tarea.  Por lo tanto, no recomendamos solo google "c√≥mo configurar Nginx para fotos": es mejor consultar la documentaci√≥n oficial, que mostrar√° qu√© configuraciones vale la pena tocar.  Pero es mejor elegir un par√°metro espec√≠fico usted mismo.  Bueno, entonces todo es simple: describimos los servidores que tenemos, describimos los certificados ... Pero lo m√°s interesante es, de hecho, la l√≥gica del enrutamiento en s√≠. <br><br>  Al principio, nos pareci√≥ que simplemente describimos nuestra ubicaci√≥n, igualamos el n√∫mero de nuestro cach√© de fotos, describimos con nuestras manos o el generador cu√°ntos aguas arriba necesitamos, en cada flujo ascendente indicamos el servidor al que debe ir el tr√°fico y un servidor de respaldo en caso de que el servidor principal no disponible: <br><br><img src="https://habrastorage.org/webt/qz/xv/7u/qzxv7u3owy_y3d2ylx_guhnvl6w.jpeg"><br><br>  Pero, probablemente, si todo fuera tan simple, simplemente ir√≠amos a casa y no dir√≠amos nada.  Desafortunadamente, con la configuraci√≥n predeterminada de Nginx, que, en general, se realiz√≥ durante muchos a√±os de desarrollo y no del todo para este caso ... la configuraci√≥n se ve as√≠: si alg√∫n servidor ascendente tiene un error de solicitud o tiempo de espera, Nginx siempre cambia el tr√°fico al siguiente.  Al mismo tiempo, despu√©s del primer archivo, el servidor tambi√©n se apagar√° durante 10 segundos, tanto por error como por tiempo de espera; esto ni siquiera se puede configurar.  Es decir, si eliminamos o restablecemos la opci√≥n de tiempo de espera en la directiva ascendente, aunque Nginx no procesar√° esta solicitud y responder√° con alg√∫n error no tan bueno, el servidor se cerrar√°. <br><br><img src="https://habrastorage.org/webt/2j/tt/gq/2jttgqtmewa17wepwzu9_ncnbay.jpeg"><br><br>  Para evitar esto, hicimos dos cosas: <br><br>  a) le prohibieron a Nginx hacer esto a mano, y desafortunadamente, la √∫nica forma de hacerlo es simplemente establecer la configuraci√≥n m√°xima de fallas. <br><br>  b) record√≥ que en otros proyectos usamos un m√≥dulo que le permite realizar verificaciones de antecedentes; en consecuencia, realizamos verificaciones de salud con bastante frecuencia para tener un m√≠nimo en caso de accidente. <br><br>  Desafortunadamente, esto no es todo, porque literalmente las primeras dos semanas de este esquema mostraron que la comprobaci√≥n de estado de TCP tambi√©n es algo poco confiable: ni Nginx ni Nginx en el estado D se pueden generar en el servidor ascendente, en este caso el n√∫cleo aceptar√° la conexi√≥n, pasar√° la comprobaci√≥n de estado, pero no funcionar√°.  Por lo tanto, de inmediato lo reemplazamos con el estado de comprobaci√≥n http'shny, hicimos uno espec√≠fico, que si devuelve 200, entonces todo funciona en este script.  Puede hacer una l√≥gica adicional; por ejemplo, en el caso de servidores de almacenamiento en cach√©, verifique que el sistema de archivos est√© montado correctamente: <br><br><img src="https://habrastorage.org/webt/aj/oq/8v/ajoq8vcwccoojjld4g_mdvs82nk.jpeg"><br><br>  Y nos convendr√≠a, excepto que en este momento el circuito repiti√≥ por completo lo que hizo la pieza de hierro.  Pero quer√≠amos hacerlo mejor.  Anteriormente, ten√≠amos un servidor de respaldo, y probablemente esto no sea muy bueno, porque si tiene cien servidores, entonces, cuando varios bloqueos a la vez, es poco probable que un servidor de respaldo haga frente a la carga.  Por lo tanto, decidimos distribuir la reserva en todos los servidores: acabamos de hacer otro flujo ascendente separado, escribimos todos los servidores con ciertos par√°metros all√≠ de acuerdo con el tipo de carga que pueden manejar, agregamos las mismas comprobaciones de estado que ten√≠amos antes : <br><br><img src="https://habrastorage.org/webt/v1/rs/en/v1rsenvhquikqrrbbv9cfpse0am.jpeg"><br><br>  Dado que es imposible ir a otro flujo ascendente dentro de un flujo ascendente, fue necesario asegurarse de que, en caso de que el flujo ascendente principal no estuviera disponible, en el que simplemente se escribi√≥ el cach√© de fotos correcto, simplemente fuimos a fallback v√≠a error_page, desde donde fuimos a la copia de seguridad de abril: <br><br><img src="https://habrastorage.org/webt/fz/np/9k/fznp9kvowmowpnfctwrukqgrtzu.jpeg"><br><br>  Y, literalmente, agregando cuatro servidores, obtuvimos esto: reemplazamos parte de la carga, se elimin√≥ de LTM a estos servidores, implementamos la misma l√≥gica all√≠ usando hardware y software est√°ndar, e inmediatamente obtuvimos la ventaja de que estos servidores se pueden escalar porque pueden ser simplemente pon todo lo que necesites.  Bueno, lo √∫nico negativo es que hemos perdido alta disponibilidad para usuarios externos.  Pero en ese momento tuve que sacrificar esto, porque ten√≠a que resolver el problema de inmediato.  Entonces, eliminamos una parte de la carga, esto es alrededor del 40% en ese momento, LTM se sinti√≥ bien y, literalmente, dos semanas despu√©s del inicio del problema, comenzamos a enviar no 45 mil solicitudes por segundo, sino 55 mil.  De hecho, crecimos en un 20%, este es claramente el tr√°fico que no le dimos al usuario.  Y despu√©s de eso comenzaron a pensar c√≥mo resolver el problema restante: proporcionar una alta accesibilidad externa. <br><br><img src="https://habrastorage.org/webt/8n/sg/2d/8nsg2dss1acxsqfczqsemtigela.jpeg"><br><br>  Tuvimos una pausa durante la cual discutimos qu√© soluci√≥n usaremos para esto.  Hubo sugerencias para garantizar la confiabilidad usando DNS, usando algunos scripts auto-escritos, protocolos de enrutamiento din√°mico ... hab√≠a muchas opciones, pero qued√≥ claro que para una salida de fotos verdaderamente confiable necesitas introducir otra capa que monitorear√° esto.  Llamamos a estas m√°quinas directores de fotograf√≠a.  Como el software en el que confiamos, eleg√≠ Keepalived: <br><br><img src="https://habrastorage.org/webt/pc/zw/a-/pczwa-t_tfsivnovri7qtkjm3k4.jpeg"><br><br>  Para empezar, en qu√© consiste Keepalived.  El primero es el protocolo VRRP, ampliamente conocido por los networkers, ubicado en equipos de red que proporciona tolerancia a fallas para la direcci√≥n IP externa a la que se conectan los clientes.  La segunda parte es IPVS, servidor virtual IP, para equilibrar entre enrutadores de fotos y garantizar la tolerancia a fallas en este nivel.  Y el tercero son los controles de salud. <br><br>  Comencemos con la primera parte: VRRP: ¬øc√≥mo se ve?  Hay una cierta IP virtual en la que hay una entrada en dns badoocdn.com donde los clientes est√°n conectados.  En alg√∫n momento, tenemos una direcci√≥n IP en un servidor.  Los paquetes de Keepalived se ejecutan entre los servidores usando el protocolo VRRP, y si el asistente desaparece del radar (el servidor se reinicia o algo m√°s, el servidor de respaldo autom√°ticamente levanta esta direcci√≥n IP de s√≠ mismo), no son necesarios pasos manuales.  El maestro y la copia de seguridad difieren, principalmente la prioridad: cuanto m√°s alto sea, m√°s probable es que la m√°quina se convierta en un maestro.  Una gran ventaja es que no es necesario configurar las direcciones IP en el servidor, es suficiente describirlas en la configuraci√≥n, y si al mismo tiempo las direcciones IP necesitan algunas reglas de enrutamiento personalizadas, esto se describe directamente en la configuraci√≥n, la misma sintaxis como se describe en paquete VRRP.  No encontrar√°s cosas desconocidas. <br><br><img src="https://habrastorage.org/webt/iy/n4/k_/iyn4k_uxkg7-zul_qwhopnkirz8.jpeg"><br><br>  ¬øC√≥mo se ve en la pr√°ctica?  ¬øQu√© sucede si uno de los servidores se cae?  Tan pronto como el maestro desaparece, nuestro respaldo deja de recibir anuncios y autom√°ticamente se convierte en maestro.  Despu√©s de un tiempo, arreglamos el Keepalived maestro, reiniciado y levantado: las aventuras tienen una prioridad m√°s alta que la copia de seguridad, y la copia de seguridad vuelve autom√°ticamente, elimina las direcciones IP, no se requieren acciones manuales. <br><br><img src="https://habrastorage.org/webt/za/r2/iw/zar2iwr1wsldusl1yujwwpp40g0.jpeg"><br><br>  Por lo tanto, garantizamos la tolerancia a fallos de la direcci√≥n IP externa.  La siguiente parte es equilibrar de alguna manera el tr√°fico a los enrutadores de fotos que ya lo terminan desde una direcci√≥n IP externa.  Con los protocolos de equilibrio, todo est√° bastante claro.  Este es un simple round-robin, o cosas un poco m√°s complejas, wrr, conexi√≥n de lista, etc.  Esto se describe en principio en la documentaci√≥n, no hay nada especial.  Pero el m√©todo de entrega ... Aqu√≠ nos detenemos en m√°s detalles: por qu√© eligieron uno de ellos.  Estos son NAT, enrutamiento directo y TUN.  El hecho es que inmediatamente establecimos el retorno de 100 gigabits de tr√°fico de los sitios.  Si esto se estima, necesita tarjetas de 10 gigabits, ¬øverdad?  Tarjetas de 10 gigabits en un servidor: esto ya est√° fuera del alcance de al menos nuestro concepto de "equipo est√°ndar".  Y luego recordamos que no solo estamos regalando algo de tr√°fico, estamos dando fotos. <br><br>  ¬øCu√°l es la caracter√≠stica?  - La gran diferencia entre el tr√°fico entrante y saliente.  El tr√°fico entrante es muy peque√±o, el saliente es muy grande: <br><br><img src="https://habrastorage.org/webt/wj/vb/rd/wjvbrdh1xyk1bneap9fjiuwxss4.jpeg"><br><br>  Si observa estos gr√°ficos, puede ver que en este momento le llegan al director unos 200 MB por segundo, este es el d√≠a m√°s com√∫n.  Estamos devolviendo 4.500 MB por segundo, la relaci√≥n es de aproximadamente 1/22.  Ya est√° claro que para garantizar completamente el tr√°fico saliente a 22 servidores en funcionamiento, uno que acepte esta conexi√≥n es suficiente.  Aqu√≠ el algoritmo de enrutamiento directo, el algoritmo de enrutamiento, viene en nuestra ayuda. <br><br>  ¬øC√≥mo se ve?  Seg√∫n nuestra tabla, el director de fotos transfiere las conexiones a los enrutadores de fotos.  Pero los enrutadores de fotos env√≠an el tr√°fico de retorno directamente a Internet, lo env√≠an al cliente, no regresa a trav√©s del director de fotograf√≠a, por lo tanto, con el n√∫mero m√≠nimo de m√°quinas, brindamos tolerancia completa a fallas y bombeamos todo el tr√°fico.  En las configuraciones se ve as√≠: especificamos el algoritmo, en nuestro caso es un simple rr, proporcionamos un m√©todo de enrutamiento directo y luego comenzamos a enumerar todos los servidores reales, cu√°ntos tenemos.  Lo que determinar√° este tr√°fico.  En caso de que tengamos uno o dos servidores m√°s all√≠, surge tal necesidad: solo agregamos esta secci√≥n en la configuraci√≥n y no nos preocupamos realmente.  Por parte de los servidores reales, por parte del enrutador de fotos, este m√©todo requiere una configuraci√≥n muy m√≠nima, se describe perfectamente en la documentaci√≥n y no hay trampas all√≠. <br><br>  Lo que es especialmente bueno: tal soluci√≥n no implica una alteraci√≥n radical de la red local, fue importante para nosotros, tuvimos que resolverla con gastos m√≠nimos.  Si observa el <a href="">resultado del comando de administraci√≥n IPVS</a> , veremos c√≥mo se ve.  Aqu√≠ tenemos un servidor virtual, en el puerto 443, escucha, acepta la conexi√≥n, se enumeran todos los servidores de trabajo y est√° claro que la conexi√≥n es la misma, m√°s o menos.  Si miramos las estad√≠sticas en el mismo servidor virtual, tenemos paquetes entrantes, conexiones entrantes, pero absolutamente ninguna saliente.  Las conexiones salientes van directamente al cliente.  Bueno, pudimos desequilibrarnos.  Ahora, ¬øqu√© sucede si uno de los enrutadores de fotos falla?  Despu√©s de todo, el hierro es hierro.  Puede ir al p√°nico del n√∫cleo, puede romperse, la fuente de alimentaci√≥n puede quemarse.  Cualquier cosa  Para esto, se necesitan controles de salud.  Pueden ser los m√°s simples, verificando c√≥mo se abre el puerto con nosotros, o algunos m√°s complejos, hasta algunos scripts autoescritos que incluso verificar√°n la l√≥gica comercial. <br><br>  Nos detuvimos en alg√∫n punto intermedio: tenemos una solicitud https para una ubicaci√≥n espec√≠fica, se llama a un script si responde con la respuesta n√∫mero 200, creemos que todo es normal con este servidor, que est√° en vivo y que puede encenderlo con bastante calma. <br><br>  C√≥mo, de nuevo, se ve en la pr√°ctica.  Apague el servidor, digamos para el servicio: BIOS parpadeante, por ejemplo.  En los registros, inmediatamente tenemos un tiempo de espera, vemos la primera l√≠nea, luego, despu√©s de tres intentos, se marca como "invertida", y simplemente se elimina de la lista. <br><br><img src="https://habrastorage.org/webt/ae/ej/df/aeejdfudalsue7fppoxgwm20imq.jpeg"><br><br>  Hay un segundo comportamiento posible cuando simplemente VS se establece en cero, pero si se devuelve la foto, no funciona bien.  El servidor se eleva, Nginx comienza all√≠, all√≠ mismo, las comprobaciones de estado comprenden que la conexi√≥n pasa, que todo est√° bien, que el servidor aparece en nuestra lista y que la carga comienza a aplicarse autom√°ticamente.  Al mismo tiempo, no se requieren acciones manuales del administrador de turno.  Por la noche, el servidor se reinici√≥; el departamento de monitoreo no nos llama sobre esto por la noche.  Informan que tal fue, todo es normal. <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Entonces, de una manera bastante simple, utilizando una peque√±a cantidad de servidores, resolvimos el problema de la tolerancia a fallas externas. </font></font><br><br>  ,   ,  ,  .   ,  Keepalivede,     ,     ,      DBus, SMTP, SNMP,    Zabbix'. ,           ,   ,   -    ,           , ,   IP-   . ,   ,      .    nginx  -,      .  , ,    :  -,  health-check' ,      ,   , ,     -      -  .    -   ,  amazon   -,  ,      ,      anomaly detection,  ,     machine learning,   ,    ,  ,    ,  , .   . <br><br>  : ,  ,   ,   -    ,   ,     ,     HTTPS        health-check'.     ,           ,     ,         ,        ,          . <br><br>     ?        2018-.          ,     ,      LTM,        -  40   60 ,      2018-           . <br><br><img src="https://habrastorage.org/webt/8n/5t/ft/8n5tftzahwei4_yfs9nl4cjte40.jpeg"></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/464769/">https://habr.com/ru/post/464769/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../464757/index.html">Mejora tu perfil de LinkedIn antes de encontrar un trabajo</a></li>
<li><a href="../464759/index.html">Docenas de libros √°giles que el gerente del proyecto necesitar√° en 2020</a></li>
<li><a href="../464761/index.html">Un peque√±o mod convierte a Tesla en una estaci√≥n de video vigilancia</a></li>
<li><a href="../464763/index.html">Benchmarks para servidores en Linux: una selecci√≥n de herramientas abiertas</a></li>
<li><a href="../464765/index.html">Configurando FreePBX + GoIP</a></li>
<li><a href="../464773/index.html">Mecanografiado asincr√≥nico en una rica aplicaci√≥n de Internet y decoradores para combatirlo</a></li>
<li><a href="../464775/index.html">21 de septiembre Badoo PHP Meetup # 3: Rendimiento</a></li>
<li><a href="../464777/index.html">¬øPor qu√© const no acelera el c√≥digo C / C ++?</a></li>
<li><a href="../464779/index.html">Sobre las abejas hedonistas, la forma en que las personas las hacen trabajar y los drones</a></li>
<li><a href="../464781/index.html">Televisores inteligentes: CRT a HDR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>