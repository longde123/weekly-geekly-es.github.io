<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🍔 👩🏻‍⚕️ 🏴󠁧󠁢󠁥󠁮󠁧󠁿 Teste automatizado com Pytest 🙅🏻 🌁 🧒🏼</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma tradução do artigo foi preparada especificamente para os alunos do curso Python QA Engineer . 



 Vivemos uma época em que o software está se mov...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Teste automatizado com Pytest</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/otus/blog/480186/">  <i>Uma tradução do artigo foi preparada especificamente para os alunos do curso <a href="https://otus.pw/Jfm1/">Python QA Engineer</a> .</i> <br><br><img src="https://habrastorage.org/webt/_k/t8/za/_kt8zaspxac9im8vyh9zca-r3zm.png"><br><hr><br>  Vivemos uma época em que o software está se movendo muito rapidamente para o mercado.  Por isso, o processo de desenvolvimento se torna muito estressante.  Altas taxas de implementação de software e entrega rápida parecem uma boa parte do modelo de negócios, mas surge a questão aqui sobre como fornecer software da qualidade certa. <a name="habracut"></a><br><br><h4>  Por que precisamos de testes automatizados </h4><br>  Existem muitas vantagens nos testes automatizados, eis três principais: <br>  <b>Reutilização:</b> Não há necessidade de escrever novos scripts sempre, mesmo quando uma nova versão do sistema operacional é lançada, a menos que haja uma necessidade urgente. <br>  <b>Confiabilidade: as</b> pessoas tendem a cometer erros e os carros as tornam menos prováveis.  E eles funcionam mais rápido ao executar etapas / testes repetidos que precisam ser executados continuamente. <br>  <b>Trabalho 24/7:</b> você pode começar a testar a qualquer hora do dia, mesmo que remotamente.  Se você começar a testar à noite, ele será executado mesmo enquanto você dorme. <br><br><h4>  Desenvolvida a ferramenta de teste pytest com recursos completos em Python </h4><br>  Atualmente, existem muitas estruturas e ferramentas para teste.  Existem diferentes tipos de estruturas, por exemplo, orientada a dados, orientada a palavras-chave, híbrida, BDD etc.  Você pode escolher o que melhor se adapte às suas necessidades. <br><br>  Devo dizer que Python e <code>pytest</code> ocupam um nicho enorme nesse assunto.  O Python e suas ferramentas relacionadas são amplamente utilizados, provavelmente porque são mais acessíveis para pessoas com pouca experiência em programação em comparação com outras linguagens. <br><br>  A estrutura <code>pytest</code> facilita a gravação de pequenos testes, mas também é dimensionada para oferecer suporte a testes funcionais sofisticados de aplicativos e bibliotecas. <br><br>  Alguns recursos principais do <code>pytest</code> : <br><br><ul><li>  Detecção automática de módulos e funções de teste; </li><li>  CLI eficaz para melhorar o controle sobre o que você deseja executar ou pular; </li><li>  Grande ecossistema de plugins de terceiros; </li><li>  Luminárias - tipos diferentes, aplicações diferentes; </li><li>  Trabalhe com a estrutura tradicional de teste de unidade. </li></ul><br><h4>  Detecção de teste automática e configurável </h4><br>  Por padrão, o <code>pytest</code> espera encontrar testes nos módulos Python cujos nomes começam com <code>test_</code> ou terminam com <code>_test.py</code> .  Além disso, por padrão, espera que os nomes das funções de teste iniciem com o prefixo <code>test_</code> .  No entanto, esse protocolo de detecção de teste pode ser alterado adicionando sua própria configuração a um dos <code>pytest</code> configuração <code>pytest</code> . <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># content of pytest.ini # Example 1: have pytest look for "check" instead of "test" # can also be defined in tox.ini or setup.cfg file, although the section # name in setup.cfg files should be "tool:pytest" [pytest] python_files = check_*.py python_classes = Check python_functions = *_check</span></span></code> </pre> <br>  Vejamos uma função de teste muito simples: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CheckClass</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">one_check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> x = <span class="hljs-string"><span class="hljs-string">"this"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> <span class="hljs-string"><span class="hljs-string">'h'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> x <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">two_check</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> x = <span class="hljs-string"><span class="hljs-string">"hello"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> hasattr(x, <span class="hljs-string"><span class="hljs-string">'check'</span></span>)</code> </pre> <br>  Você notou alguma coisa?  Não existe <code>assertEqual</code> ou <code>assertDictEqual</code> , apenas uma <code>assert</code> acessível e compreensível.  Não há necessidade de importar essas funções para simplesmente comparar dois objetos.  Afirmar é o que o Python já possui e não há necessidade de reinventar a roda. <br><br><h4>  Código do modelo?  Não se preocupe, os equipamentos correm para o resgate! </h4><br>  Veja as funções de teste que testam as operações básicas no programa Wallet: <br><br><pre> <code class="python hljs">// test_wallet.py <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> wallet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Wallet <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_default_initial_amount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> wallet = Wallet() <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> wallet.balance == <span class="hljs-number"><span class="hljs-number">0</span></span> wallet.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_setting_initial_amount</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> wallet = Wallet(initial_amount=<span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> wallet.balance == <span class="hljs-number"><span class="hljs-number">100</span></span> wallet.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_wallet_add_cash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> wallet = Wallet(initial_amount=<span class="hljs-number"><span class="hljs-number">10</span></span>) wallet.add_cash(amount=<span class="hljs-number"><span class="hljs-number">90</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> wallet.balance == <span class="hljs-number"><span class="hljs-number">100</span></span> wallet.close() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test_wallet_spend_cash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> wallet = Wallet(initial_amount=<span class="hljs-number"><span class="hljs-number">20</span></span>) wallet.spend_cash(amount=<span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">assert</span></span> wallet.balance == <span class="hljs-number"><span class="hljs-number">10</span></span> wallet.close()</code> </pre> <br>  Ah, interessante!  Você já reparou?  Há muito código padrão.  Outra coisa que vale a pena notar é que esse teste faz outra coisa além de testar a parte funcional, por exemplo, criar uma carteira e fechá-la com <code>wallet.close()</code> . <br><br>  Agora vamos ver como você pode se livrar do código padrão usando os <code>pytest</code> pytest. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> _pytest.fixtures <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SubRequest <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> wallet <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Wallet <span class="hljs-comment"><span class="hljs-comment">#==================== fixtures @pytest.fixture def wallet(request: SubRequest): param = getattr(request, 'param', None) if param: prepared_wallet = Wallet(initial_amount=param[0]) else: prepared_wallet = Wallet() yield prepared_wallet prepared_wallet.close() #==================== tests def test_default_initial_amount(wallet): assert wallet.balance == 0 @pytest.mark.parametrize('wallet', [(100,)], indirect=True) def test_setting_initial_amount(wallet): assert wallet.balance == 100 @pytest.mark.parametrize('wallet', [(10,)], indirect=True) def test_wallet_add_cash(wallet): wallet.add_cash(amount=90) assert wallet.balance == 100 @pytest.mark.parametrize('wallet', [(20,)], indirect=True) def test_wallet_spend_cash(wallet): wallet.spend_cash(amount=10) assert wallet.balance == 10</span></span></code> </pre> <br>  Legal, não é?  As funções de teste agora são compactas e fazem exatamente o que devem fazer.  A carteira é configurada, instalada e fechada usando o <code>wallet</code> da <code>wallet</code> .  As luminárias não apenas ajudam a escrever códigos reutilizáveis, mas também adicionam o conceito de compartilhamento de dados.  Se você observar atentamente, a quantidade na <code>wallet</code> faz parte dos dados de teste fornecidos externamente pela lógica do teste e não é rigidamente fixada dentro da função. <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.mark.parametrize('wallet', [(10,)], indirect=True)</span></span></code> </pre> <br>  Em um ambiente mais controlado, você pode ter um arquivo com dados de teste, por exemplo <code>test-data.ini</code> em seu repositório ou shell, que pode lê-lo, enquanto sua função de teste pode chamar vários shells para ler dados de teste. <br><br>  No entanto, é recomendável colocar todos os seus equipamentos em um arquivo <code>conftest.py</code> especial.  Este é um arquivo especial no pytest que permite ao teste detectar equipamentos globais. <br><br><h4>  Mas tenho casos de teste que quero executar em diferentes conjuntos de dados! </h4><br>  Não se preocupe, o <code>pytest</code> possui um recurso interessante para parametrizar seu equipamento.  Vejamos um exemplo. <br><br>  Suponha que seu produto tenha uma CLI gerenciada localmente.  Além disso, seu produto possui muitos parâmetros padrão definidos na inicialização e você deseja verificar todos os valores desses parâmetros. <br><br>  Você pode escrever um caso de teste separado para cada um desses parâmetros, mas com o <code>pytest</code> tudo é muito mais simples! <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@pytest.mark.parametrize(“setting_name, setting_value”, [('qdb_mem_usage', 'low'), ('report_crashes', 'yes'), ('stop_download_on_hang', 'no'), ('stop_download_on_disconnect', 'no'), ('reduce_connections_on_congestion', 'no'), ('global.max_web_users', '1024'), ('global.max_downloads', '5'), ('use_kernel_congestion_detection', 'no'), ('log_type', 'normal'), ('no_signature_check', 'no'), ('disable_xmlrpc', 'no'), ('disable_ntp', 'yes'), ('ssl_mode', 'tls_1_2'),])def test_settings_defaults(self, setting_name, setting_value): assert product_shell.run_command(setting_name) == \ self.”The current value for \'{0}\' is \'{1}\'.”.format(setting_name, setting_value), \ 'The {} default should be {}'.format(preference_name, preference_value)</span></span></code> </pre> <br>  Legal, não é?  Você acabou de escrever 13 casos de teste (cada um define um valor de configuração diferente) e, no futuro, se você adicionar um novo parâmetro ao seu produto, tudo o que você precisa fazer é adicionar outra tupla. <br><br><h4>  Como o pytest se integra aos testes de interface do usuário com os testes Selenium e API? </h4><br>  Bem, seu produto pode ter várias interfaces.  CLI - como dissemos acima.  Semelhante à GUI e API.  Antes de implantar seu produto de software, é importante testar todos eles.  No software corporativo, onde vários componentes estão interconectados e dependem um do outro, uma mudança em uma parte pode afetar todas as outras. <br><br>  Lembre-se de que o <code>pytest</code> é apenas uma estrutura para testes fáceis, não um tipo específico de teste.  Ou seja, você pode criar testes para a GUI usando o Selenium ou, por exemplo, testes para a API com a biblioteca de <code>requests</code> do Python e executá-los com o <code>pytest</code> . <br><br>  Por exemplo, em um nível alto, isso pode ser uma verificação da estrutura do repositório. <br><br><img src="https://habrastorage.org/webt/js/lt/jn/jsltjnxnjm3z0_nyylpwnz29ouy.png"><br><br>  Como você pode ver na imagem acima, é uma boa oportunidade para separar os componentes: <br><br>  <b>apiobjects</b> : um bom lugar para criar wrappers para chamar pontos de extremidade da API.  Você pode ter um <code>BaseAPIObject</code> e uma classe derivada que atenda aos seus requisitos. <br><br>  <b>ajudantes</b> : você pode adicionar seus métodos auxiliares aqui. <br><br>  <b>lib</b> : arquivos de biblioteca que podem ser usados ​​por vários componentes, por exemplo, seus <code>conftest</code> em <code>conftest</code> , <code>pageobjects</code> , etc. <br><br>  <b>pageobjects</b> : O <code>PageObjects</code> arquitetura <b>PageObjects</b> pode ser usado para criar classes para várias páginas da GUI.  Usamos o <a href="https://github.com/wgnet/webium">Webium</a> , que é uma biblioteca de implementações de modelos de objeto de página para Python. <br><br>  <b>suites</b> : você pode escrever seus próprios conjuntos de verificações pylint para obter códigos, eles ajudarão você a ganhar mais confiança na qualidade do seu código. <br><br>  <b>testes</b> : você pode catalogar testes com base em suas preferências.  Isso facilitará o gerenciamento e a revisão de seus testes. <br><br>  Trouxe-o apenas para referência, a estrutura do repositório e as dependências podem ser organizadas de acordo com suas necessidades pessoais. <br><br><h4>  Eu tenho muitos casos de teste e quero que eles sejam executados em paralelo </h4><br>  Você pode ter muitos casos de teste em seu conjunto, e acontece que é necessário executá-los em paralelo e reduzir o tempo geral de execução do teste. <br><br>  O Pytest oferece um incrível plugin de execução de teste paralelo chamado <code>pytest-xdist</code> , que adiciona vários modos de execução exclusivos ao pytest de base.  Instale este plugin usando <code>pip</code> . <br><br><pre> <code class="python hljs">pip install pytest-xdist</code> </pre> <br>  Vamos ver como isso funciona com um exemplo. <br><br>  Eu tenho um repositório de testes automatizados do CloudApp para meus testes da GUI do Selenium.  Além disso, está em constante crescimento e atualização com novos testes e agora possui centenas de testes.  O que eu quero fazer é executá-los em paralelo e reduzir o tempo geral de execução do teste. <br><br>  No terminal, basta digitar <code>pytest</code> na pasta raiz do projeto / pasta de teste.  Isso permitirá que você execute todos os testes. <br><br><pre> <code class="python hljs">pytest -s -v -n=<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre> <br><img src="https://habrastorage.org/webt/sa/qj/s-/saqjs-_lfhrtekg0ljaw57lbvkg.jpeg"><br><br>  <code>pytest-xdist</code> irá executar todos os testes em paralelo! <br><br>  Dessa forma, você também pode executar vários navegadores em paralelo. <br><br><h4>  Relatórios </h4><br>  O Pytest vem com suporte interno para a criação de arquivos de resultados de teste que podem ser abertos usando Jenkins, Bamboo ou outros servidores de integração contínua.  Use o seguinte: <br><br><pre> <code class="python hljs">pytest test/file/path — junitxml=path</code> </pre> <br>  Isso ajudará a gerar um ótimo arquivo XML que pode ser aberto com muitos analisadores. <br><br><h3>  Conclusão </h3><br>  A popularidade do Pytest está crescendo a cada ano.  Além disso, possui um poderoso suporte da comunidade, que permite acessar muitas extensões, como <i><a href="https://pypi.org/project/pytest-django/">pytest-django</a></i> , que o ajudará a escrever testes para aplicativos da web no Django.  Lembre-se de que o pytest suporta casos de teste mais unittest; portanto, se você usar o <code>unittest</code> , o pytest deve ser considerado com mais detalhes. <br><br><h4>  Fontes </h4><br><ul><li>  <a href="https://docs.pytest.org/en/latest/">docs.pytest.org/en/latest</a> </li><li>  <a href="http://pythontesting.net/framework/pytest/pytest-introduction/">pythontesting.net/framework/pytest/pytest-introduction</a> </li></ul><br>  Só isso.  Vejo você no <a href="https://otus.pw/Jfm1/">curso</a> ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt480186/">https://habr.com/ru/post/pt480186/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt480176/index.html">[Tradução] Da pirataria ao código aberto: minha história</a></li>
<li><a href="../pt480178/index.html"># manorOpenSource</a></li>
<li><a href="../pt480180/index.html">Os resultados da semana: Rambler reivindica direitos à Nginx, a Microsoft cria um novo PL e, na Rússia, fecha o projeto Taigafon</a></li>
<li><a href="../pt480182/index.html">Guia para freelancers: as perguntas mais comuns sobre o trabalho de SP</a></li>
<li><a href="../pt480184/index.html">Uma seleção de fatos estatísticos divertidos</a></li>
<li><a href="../pt480188/index.html">Desenvolvido por NGINX</a></li>
<li><a href="../pt480194/index.html">Arquitetura de soluções em nuvem. Novo curso da OTUS</a></li>
<li><a href="../pt480196/index.html">Como responder à ilegalidade? Baseado em eventos com Nginx</a></li>
<li><a href="../pt480200/index.html">Como desenvolver o design e o código de um site pessoal</a></li>
<li><a href="../pt480204/index.html">Apagão de 30 minutos em apoio ao autor do Nginx - Igor Sysoev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>