<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💻 👩🏾‍✈️ 🔛 Partie 5/2 Bldg. 1: Carrefour de l'avenue RocketChip et piste d'instrumentation glissante ⚒️ 🚉 👍🏽</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dans les quatre parties précédentes, des préparatifs ont été faits pour des expériences avec le noyau RISC-V RocketChip, à savoir le portage de ce noy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Partie 5/2 Bldg. 1: Carrefour de l'avenue RocketChip et piste d'instrumentation glissante</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461577/"><p>  Dans les quatre parties précédentes, des préparatifs ont été faits pour des expériences avec le noyau RISC-V RocketChip, à savoir le portage de ce noyau sur une carte «non standard» pour celui-ci avec des FPGA Altera (maintenant Intel).  Enfin, dans la <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dernière partie</a> , il s'est avéré exécuter Linux sur cette carte.  Savez-vous ce qui m'a amusé à propos de tout cela?  C'est en même temps que je devais travailler avec l'assembleur RISC-V, C et Scala, et de tous, Scala était le langage de niveau le plus bas (parce que le processeur est écrit dessus). </p><br><p>  Faisons en sorte que C ne soit pas offensant dans cet article non plus.  De plus, si le bundle Scala + Chisel a été utilisé uniquement en tant que <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">langage spécifique au domaine</a> pour une description explicite du matériel, nous allons aujourd'hui apprendre à "tirer" des fonctions C simples dans le processeur sous la forme d'instructions. </p><br><p> Le but ultime est la mise en œuvre triviale d'instruments triviaux de type AFL par analogie avec <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">QInst</a> , et la mise en œuvre d'instructions distinctes n'est qu'un sous-produit. </p><a name="habracut"></a><br><p>  Il est clair qu'il existe (et pas un) convertisseur OpenCL vers RTL commercial.  J'ai également rencontré des informations sur un certain projet COPILOT pour RISC-V avec des objectifs similaires (beaucoup plus avancés), mais quelque chose va mal sur Google, et en plus, il s'agit très probablement d'un produit commercial.  Je suis principalement intéressé par les solutions OpenSource, mais même si elles le sont, c'est toujours amusant d'essayer de l'implémenter vous-même - au moins comme un exemple de formation simplifié, puis comment ça se passe ... </p><br><p>  <strong>Clause de non-responsabilité</strong> (en plus de l'avertissement habituel de «danser avec un extincteur»): je déconseille fortement d'appliquer le noyau logiciel résultant, en particulier avec des données non fiables - jusqu'à présent, je n'ai pas tellement confiance que de comprendre pourquoi les données traitées ne peuvent pas «Flow» dans certains cas limites entre les processus et / ou le cœur.  Eh bien, à propos du fait que les données peuvent "battre", je pense, et c'est donc clair.  En général, il y a encore validation et validation ... </p><br><p>  Pour commencer, comment appeler une "fonction simple"?  Aux fins du présent article, cela signifie une fonction dans laquelle toutes les transitions (conditionnelles et inconditionnelles) n'augmentent le compteur d'instructions que d'une valeur constante.  Autrement dit, le graphique de toutes les transitions possibles est (dirigé) acyclique, sans arêtes "dynamiques".  Le but ultime dans le cadre de cet article est de pouvoir prendre une fonction simple du programme et, en la remplaçant par un plug-in d'assembleur, de la «coudre» dans le processeur au stade de la synthèse, ce qui en fait éventuellement un effet secondaire d'une autre instruction.  <em>Plus précisément, la ramification ne sera pas présentée dans cet article, mais dans le cas le plus simple, il ne sera pas difficile de les créer.</em> </p><br><h2 id="uchimsya-ponimat-c-na-samom-dele-net">  Apprendre à comprendre C (en fait, non) </h2><br><p> Vous devez d'abord comprendre comment nous analyserons C?  C'est vrai, pas du tout - ce n'est pas en vain que j'ai appris à <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">analyser les fichiers ELF</a> : il vous suffit de compiler notre code en C / Rust / quelque chose d'autre dans un bytecode eBPF, et de l'analyser déjà.  Certaines difficultés sont dues au fait que dans Scala, vous ne pouvez pas simplement connecter <code>elf.h</code> et lire les champs de structure.  Vous pouvez, bien sûr, essayer d'utiliser <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">JNAerator</a> - si nécessaire, ils peuvent <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">créer des liens</a> vers la bibliothèque - non seulement des structures, mais aussi générer du code pour travailler via JNA (à ne pas confondre avec JNI).  En tant que vrai programmeur, j'écrirai mon vélo et j'écrirai soigneusement les constantes d'énumération et de décalage à partir du fichier d'en-tête.  Le résultat et les structures intermédiaires sont décrits par la structure suivante des classes de cas: </p><br><pre> <code class="scala hljs"><span class="hljs-keyword"><span class="hljs-keyword">sealed</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RegularSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SymtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StrtabSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RelSection</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SectionKind</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Header</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> sectionHeaders: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">], sectionStringTableIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Elf64Section</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> data: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">ByteBuffer</span></span></span></span><span class="hljs-class"><span class="hljs-params">, linkIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, infoIndex: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, kind: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">SectionKind</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Symbol</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, value: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, size: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, shndx: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, isInstrumenter: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Boolean</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Relocation</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> relocatedSection: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, symbol: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params"> </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfInsn</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> opcode: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, dst: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, src: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, offset: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span><span class="hljs-class"><span class="hljs-params">, imm: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Either</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Long</span></span></span></span><span class="hljs-class"><span class="hljs-params">, </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Symbol</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">final</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">case</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfProg</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params"> name: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">String</span></span></span></span><span class="hljs-class"><span class="hljs-params">, insns: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Seq</span></span></span></span><span class="hljs-class"><span class="hljs-params">[</span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">BpfInsn</span></span></span></span><span class="hljs-class"><span class="hljs-params">] </span></span></span><span class="hljs-class">)</span></span></code> </pre> <br><p>  Je ne décrirai pas particulièrement le processus d'analyse - il s'agit juste d'un transfert d'octets ennuyeux de <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u="><code>java.nio.ByteBuffer</code></a> - toutes les choses intéressantes ont déjà été décrites dans l' <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">article sur l'analyse des fichiers ELF</a> .  Je peux seulement dire que vous devez gérer soigneusement l' <code>opcode == 0x18</code> (chargement de valeurs immédiates 64 bits dans le registre), car il prend deux mots de 8 octets à la fois (peut-être qu'il existe d'autres opcodes de ce type, mais je ne les ai pas encore rencontrés) , et cela ne charge pas toujours l'adresse mémoire associée à la relocalisation, comme je le pensais initialement.  Par exemple, <code>__builtin_popcountl</code> utilise honnêtement la <strong>constante</strong> 64 bits <code>0x0101010101010101</code> .  Pourquoi ne fais-je pas une relocalisation «honnête» en corrigeant le fichier téléchargé - parce que je veux voir les caractères sous forme symbolique (désolé pour le jeu de mots), afin que plus tard les caractères de la section <code>COMMON</code> puissent être remplacés par des registres sans utiliser de béquilles avec un traitement spécial des adresses d'un type spécial (et cela signifie, même avec des danses avec <code>UInt</code> constant / non constant). </p><br><h2 id="stroim-hardware-po-naboru-instrukciy">  Nous construisons du matériel selon un ensemble d'instructions </h2><br><p>  Ainsi, par hypothèse, tous les chemins d'exécution possibles descendent exclusivement dans la liste d'instructions, ce qui signifie que les données circulent le long d'un graphe acyclique orienté, et que tous ses bords sont définis statiquement.  Dans le même temps, nous avons une logique purement combinatoire (c'est-à-dire sans registres en cours), obtenue à partir d'opérations sur les registres, ainsi que des retards lors des opérations de chargement / stockage avec de la mémoire.  Ainsi, dans le cas général, l'opération peut ne pas être possible de se terminer en un cycle d'horloge.  Nous ferons simple: nous transférerons la valeur à sous la forme de <code>UInt</code> , mais comme <code>(UInt, Bool)</code> : le premier élément de la paire est la valeur, et le second est un signe de son exactitude.  Autrement dit, il n'est pas très logique de lire de la mémoire, tant que l'adresse est incorrecte et que l'écriture en général est impossible. </p><br><p>  Le modèle d'exécution de bytecode eBPF suppose une sorte de RAM avec un adressage 64 bits, ainsi qu'un ensemble de 16 (voire dix) registres 64 bits.  Un algorithme récursif primitif est proposé: </p><br><ul><li>  nous commençons par le contexte dans lequel les opérandes de l'instruction se trouvent dans <code>r1</code> et <code>r2</code> , dans le reste - zéros, tous valides (plus précisément, la validité est égale à la "préparation" de l'instruction coprocesseur) </li><li>  si nous voyons une instruction arithmétique et logique, nous extrayons ses registres d'opérandes du contexte, nous appelons pour la fin de la liste et le contexte dans lequel l'opérande de sortie est remplacé par une paire <code>(data1 op data2, valid1 &amp;&amp; valid2)</code> </li><li>  si nous rencontrons une branche, nous construisons simplement les deux branches récursivement: si la branche se produit, et sinon </li><li>  si nous rencontrons un chargement ou une sauvegarde en mémoire, nous en sortons: nous exécutons le rappel transféré, en supposant l'invariant qu'une fois l'instruction <code>valid</code> ne peut pas être rappelée lors de l'exécution de cette instruction.  La validité de l'opération de sauvegarde est ET par nous avec l'indicateur <code>globalValid</code> , qui doit être défini avant de retourner le contrôle.  En même temps, nous devons faire de la lecture et de l'écriture sur le devant afin de traiter correctement les incréments et autres modifications. </li></ul><br><p>  Ainsi, les opérations seront effectuées le plus parallèlement possible, et non pas par étapes.  Dans le même temps, je vous demande de faire attention à ce que toutes les opérations sur un octet de mémoire spécifique soient naturellement complètement ordonnées, sinon le résultat est imprévisible, UB.  C'est-à-dire  <code>*addr += 1</code> - c'est normal, l'écriture ne commencera pas exactement jusqu'à la fin de la lecture (ringard parce que nous ne savons toujours pas quoi écrire), mais <code>*addr += 1; return *addr;</code> <code>*addr += 1; return *addr;</code>  J'ai généralement donné <strong>zéro</strong> ou quelque chose comme ça en toute sécurité.  Peut-être que cela vaudrait la peine d'être débogué (peut-être que cela cache un problème plus délicat), mais un tel appel en soi est en tout cas une idée médiocre, car vous devez garder une trace des adresses de mémoire où le travail a déjà été fait, mais j'ai un désir Validez les valeurs <code>valid</code> possible statiquement.  C'est exactement ce qui sera fait pour les variables globales de taille fixe. </p><br><p>  Le résultat est une classe abstraite <code>BpfCircuitConstructor</code> , qui n'a aucune méthode implémentée <code>doMemLoad</code> , <code>doMemStore</code> et <code>resolveSymbol</code> : </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... sealed abstract class LdStType(val lgsize: Int) { val byteSize = 1 &lt;&lt; lgsize val bitSize = byteSize * 8 val mask: UInt = if (bitSize == 64) mask64 else ((1l &lt;&lt; bitSize) - 1).U } case object u8 extends LdStType(0) case object u16 extends LdStType(1) case object u32 extends LdStType(2) case object u64 extends LdStType(3) def doMemLoad(addr: UInt, tpe: LdStType, valid: Bool): (UInt, Bool) def doMemStore(addr: UInt, tpe: LdStType, data: UInt, valid: Bool): Bool sealed trait Resolved { def asPlainValue: UInt def load(ctx: Context, offset: Int, tpe: LdStType, valid: Bool): LazyData def store(offset: Int, tpe: LdStType, data: UInt, valid: Bool): Bool } def resolveSymbol(sym: BpfLoader.Symbol): Resolved // ... }</span></span></code> </pre> <br><h2 id="integraciya-s-processornym-yadrom">  Intégration au cœur du processeur </h2><br><p>  Pour commencer, j'ai décidé de suivre la voie la plus simple: se connecter au cœur du processeur en utilisant le protocole standard RoCC (Rocket Custom Coprocessor).  D'après ce que je comprends, il s'agit d'une extension régulière non pas pour tous les noyaux compatibles RISC-V, mais uniquement pour Rocket et BOOM (Berkeley Out-of-Order Machine), par conséquent, lorsque vous <code>custom0</code> glisser le travail en amont sur les compilateurs, l'assembleur <code>custom0</code> mnémoniques a été jeté hors d'eux - <code>custom3</code> responsable des commandes d'accélérateur. </p><br><p>  En général, chaque noyau de processeur Rocket / BOOM peut avoir jusqu'à quatre accélérateurs RoCC ajoutés via la configuration, il existe également des exemples d'implémentation: </p><br><p>  <strong>Configs.scala:</strong> </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WithRoccExample</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Config</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(site, here, up</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">=&gt;</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BuildRoCC</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>( (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> accumulator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">AccumulatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom0, n = <span class="hljs-number"><span class="hljs-number">4</span></span>)(p)) accumulator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> translator = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">TranslatorExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom1)(p)) translator }, (p: <span class="hljs-type"><span class="hljs-type">Parameters</span></span>) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> counter = <span class="hljs-type"><span class="hljs-type">LazyModule</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">CharacterCountExample</span></span>(<span class="hljs-type"><span class="hljs-type">OpcodeSet</span></span>.custom2)(p)) counter }) })</code> </pre> <br><p>  L'implémentation correspondante se trouve dans le fichier <code>LazyRoCC.scala</code> . </p><br><p>  L'implémentation de l'accélérateur représente deux classes déjà familières du contrôleur de mémoire: l'une dans ce cas est héritée de <code>LazyRoCC</code> , l'autre de <code>LazyRoCCModuleImp</code> .  La deuxième classe a un port <code>io</code> de type <code>RoCCIO</code> , qui contient le port de demande <code>cmd</code> , le port de réponse <code>resp</code> , le port de cache d'accès L1D mem, <code>busy</code> sorties <code>busy</code> et d' <code>interrupt</code> et l'entrée d' <code>exception</code> .  Il y a aussi un port de marcheur de table de pages et des FPU dont nous ne semblons pas encore avoir besoin (de toute façon, il n'y a pas de véritable arithmétique dans eBPF).  Jusqu'à présent, je veux essayer de faire quelque chose avec cette approche, donc je ne toucherai pas à l' <code>interrupt</code> .  Aussi, si je comprends bien, il existe une interface TileLink pour l'accès à la mémoire non mise en cache, mais pour l'instant je n'y toucherai pas non plus. </p><br><h2 id="uporyadochivatel-zaprosov">  Organisateur de requête </h2><br><p>  Nous avons donc un port pour accéder au cache, mais un seul.  Dans le même temps, une fonction peut, par exemple, incrémenter une variable (qui, à tout le moins, peut être transformée en une seule opération atomique) ou même la transformer d'une manière ou d'une autre d'une manière non triviale en la chargeant, la mettant à jour et l'enregistrant.  Au final, une seule instruction peut faire plusieurs requêtes indépendantes.  Ce n'est peut-être pas la meilleure idée en termes de performances, mais, d'autre part, pourquoi ne pas, disons, charger trois mots (qui, très probablement, sont déjà dans le cache), les traiter en quelque sorte <strong>en parallèle</strong> avec la logique combinatoire (alors un battement) et enregistrez le résultat.  Par conséquent, nous avons besoin d'une sorte de schéma qui «résout» efficacement les tentatives d'accès parallèle à un seul port de cache. </p><br><p>  La logique sera quelque chose comme ceci: au début de la génération de la mise en œuvre d'une sous-injection spécifique (un champ de <code>funct</code> 7 bits en termes de RoCC), une instance du sérialiseur de requêtes est créée (ce qui rend un global me semble assez dangereux, car cela crée un tas de dépendances supplémentaires entre les requêtes qui ne peuvent jamais être exécutées simultanément, et gaspilleur Fmax sera très probablement).  Ensuite, chaque «économiseur» / «chargeur» créé est enregistré dans le sérialiseur.  Dans une file d'attente en direct, pour ainsi dire.  À chaque mesure, la première demande dans l'ordre d'enregistrement est sélectionnée - il est autorisé <strong>à la mesure suivante</strong> .  Naturellement, une telle logique doit être bien couverte de tests (je n'en ai vraiment pas encore beaucoup, donc ce n'est pas seulement une vérification, mais l'ensemble minimum nécessaire pour obtenir au moins quelque chose d'intelligible).  J'ai utilisé le <code>PeekPokeTester</code> standard à partir d'un composant plus ou moins officiel pour tester les conceptions de ciseaux.  Je l'ai déjà <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">décrit une fois</a> . </p><br><p>  Le résultat était un tel engin: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serializer</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">isComputing: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span><span class="hljs-class"><span class="hljs-params">, next: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Bool</span></span></span></span></span><span class="hljs-class">) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">monotonic</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> res = <span class="hljs-type"><span class="hljs-type">WireInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> prevRes = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) prevRes := res &amp;&amp; isComputing res := (x || prevRes) &amp;&amp; isComputing res } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noone</span></span></span></span>(bs: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = !bs.foldLeft(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>)(_ || _) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> previousReqs = <span class="hljs-type"><span class="hljs-type">ArrayBuffer</span></span>[<span class="hljs-type"><span class="hljs-type">Bool</span></span>]() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextReq</span></span></span></span>(x: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">Bool</span></span>, <span class="hljs-type"><span class="hljs-type">Int</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> enable = monotonic(x) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> result = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> retired = <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doRetire = result &amp;&amp; next <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> thisReq = enable &amp;&amp; !retired &amp;&amp; !doRetire <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> reqWon = thisReq &amp;&amp; noone(previousReqs) when (isComputing) { when(reqWon) { result := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } when(doRetire) { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } } otherwise { result := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> retired := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } previousReqs += thisReq (result, previousReqs.length - <span class="hljs-number"><span class="hljs-number">1</span></span>) } }</code> </pre> <br><p>  Veuillez noter qu'ici dans le processus de création d'un circuit numérique, le code Scala est exécuté en toute sécurité.  Si vous y regardez de plus près, vous pouvez même remarquer un <code>ArrayBuffer</code> dans lequel les pièces du circuit sont empilées ( <code>Boolean</code> est un type de Scala, <code>Bool</code> est un type Chisel représentant un équipement en direct, et pas un booléen connu au moment de l'exécution). </p><br><h2 id="rabota-s-l1d-keshom">  Travailler avec le cache L1D </h2><br><p>  Le travail avec le cache s'effectue principalement via le <code>io.mem.req</code> demande <code>io.mem.req</code> et le <code>io.mem.resp</code> réponse <code>io.mem.resp</code> .  Dans le même temps, le port de demande est équipé des signaux traditionnels <code>ready</code> et <code>valid</code> : le premier vous indique qu'il est prêt à accepter la demande, le second nous disons que la demande est prête et a déjà la structure correcte, le long du front, <code>valid &amp;&amp; resp</code> demande est considérée comme acceptée.  Dans certaines de ces interfaces, il existe une exigence de «non-réponse» des signaux à partir du moment de la définition de <code>true</code> et jusqu'au bord positif suivant de <code>valid &amp;&amp; resp</code> (cette expression peut être construite en utilisant la méthode <code>fire()</code> pour plus de commodité). </p><br><p>  Le port de réponse <code>resp</code> , à son tour, n'a qu'un signe <code>valid</code> , et c'est le problème du processeur pour ratisser les réponses en un cycle d'horloge: il est "toujours prêt" par hypothèse, et <code>fire()</code> retourne juste <code>valid</code> . </p><br><p>  De plus, comme je l'ai déjà dit, vous ne pouvez pas faire de demande quand c'est horrible: vous ne pouvez pas écrire quelque chose, je ne sais pas quoi, et relire ce qui sera écrasé plus tard sur la base de la valeur soustraite est également quelque peu étrange.  Mais la classe <code>Serializer</code> comprend déjà cela, mais nous lui donnons seulement un signe que la requête actuelle a déjà été <code>next = io.mem.req.fire()</code> dans le cache: <code>next = io.mem.req.fire()</code> .  Tout ce qui peut être fait est de s'assurer que dans le «lecteur», la réponse n'est mise à jour que lorsqu'elle est vraiment venue - pas plus tôt et plus tard.  Il existe une méthode <code>holdUnless</code> pratique pour <code>holdUnless</code> .  Le résultat est approximativement l'implémentation suivante: </p><br><pre> <code class="scala hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Constructor</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BpfCircuitConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> serializer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">Serializer</span></span>(isComputing, io.mem.req.fire()) <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemLoad</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): (<span class="hljs-type"><span class="hljs-type">UInt</span></span>, <span class="hljs-type"><span class="hljs-type">Bool</span></span>) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> doResp = isComputing &amp;&amp; serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) &amp;&amp; io.mem.resp.valid &amp;&amp; io.mem.resp.bits.tag === thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> &amp;&amp; io.mem.resp.bits.cmd === <span class="hljs-type"><span class="hljs-type">M_XRD</span></span> (io.mem.resp.bits.data holdUnless doResp, serializer.monotonic(doResp)) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doMemStore</span></span></span></span>(addr: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, tpe: <span class="hljs-type"><span class="hljs-type">LdStType</span></span>, data: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, valid: <span class="hljs-type"><span class="hljs-type">Bool</span></span>): <span class="hljs-type"><span class="hljs-type">Bool</span></span> = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> (doReq, thisTag) = serializer.nextReq(valid) when (doReq) { io.mem.req.bits.addr := addr require((<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; io.mem.req.bits.tag.getWidth) &gt; thisTag) io.mem.req.bits.tag := thisTag.<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.cmd := <span class="hljs-type"><span class="hljs-type">M_XWR</span></span> io.mem.req.bits.typ := (<span class="hljs-number"><span class="hljs-number">4</span></span> | tpe.lgsize).<span class="hljs-type"><span class="hljs-type">U</span></span> io.mem.req.bits.data := data io.mem.req.valid := <span class="hljs-literal"><span class="hljs-literal">true</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> } serializer.monotonic(doReq &amp;&amp; io.mem.req.fire()) } <span class="hljs-keyword"><span class="hljs-keyword">override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resolveSymbol</span></span></span></span>(sym: <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>): <span class="hljs-type"><span class="hljs-type">Resolved</span></span> = sym <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">BpfLoader</span></span>.<span class="hljs-type"><span class="hljs-type">Symbol</span></span>(symName, _, size, <span class="hljs-type"><span class="hljs-type">ElfConstants</span></span>.<span class="hljs-type"><span class="hljs-type">Elf64_Shdr</span></span>.<span class="hljs-type"><span class="hljs-type">SHN_COMMON</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> size &lt;= <span class="hljs-number"><span class="hljs-number">8</span></span> =&gt; <span class="hljs-type"><span class="hljs-type">RegisterReference</span></span>(regs.getOrElseUpdate(symName, <span class="hljs-type"><span class="hljs-type">RegInit</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>(<span class="hljs-number"><span class="hljs-number">64.</span></span><span class="hljs-type"><span class="hljs-type">W</span></span>)))) } }</code> </pre> <br><p>  Une instance de cette classe est créée pour chaque sous-instruction générée. </p><br><h2 id="ne-vsyo-to-v-kuche-chto-globalnaya-peremennaya">  Tout sur le tas n'est pas une variable globale </h2><br><p>  Hmm, qu'est-ce qu'un exemple de modèle?  Quelles performances voudrais-je garantir?  Bien sûr, l'instrumentation AFL!  Il ressemble à la version classique comme ceci: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; extern uint8_t *__afl_area_ptr; extern uint64_t prev; void inst_branch(uint64_t tag) { __afl_area_ptr[((prev &gt;&gt; 1) ^ tag) &amp; 0xFFFF] += 1; prev = tag; }</span></span></span></span></code> </pre> <br><p>  Comme vous pouvez le voir, il a un chargement et une sauvegarde plus ou moins logique (et entre eux un incrément) d'un octet de <code>__afl_area_ptr</code> , mais ici le registre demande le rôle <code>prev</code> ! </p><br><p>  C'est pourquoi l'interface <code>Resolved</code> est nécessaire: elle peut soit encapsuler une adresse mémoire régulière, soit être une référence de registre.  Dans le même temps, jusqu'à présent, je ne considère que les registres scalaires de 1, 2, 4 ou 8 octets, qui sont toujours lus avec un décalage nul, donc pour les registres, vous pouvez implémenter relativement calmement l'ordre des appels.  Dans ce cas, il est très utile de savoir que <code>prev</code> doit d'abord être soustrait et utilisé pour calculer l'indice, puis seulement réécrit. </p><br><h2 id="a-teper-instrumentaciya">  Et maintenant l'instrumentation </h2><br><p>  À un moment donné, nous avons obtenu un accélérateur séparé et plus ou moins fonctionnel avec l'interface RoCC.  Et maintenant?  Réimplémenter tout de même, en poussant à travers le pipeline du processeur?  Il me semblait que moins de béquilles seraient nécessaires si, en parallèle avec l'instruction indiquée, le coprocesseur avec la <code>funct</code> valeur d'utilité émise automatiquement était simplement activé.  En principe, j'ai également dû me tourmenter pour cela: j'ai même appris à utiliser SignalTap, car le débogage est presque aveugle, et même avec une recompilation de cinq minutes après le moindre changement (à l'exception du changement de bootrom - tout est rapide là-bas) - c'est déjà trop. </p><br><p>  En conséquence, le décodeur de commande a été modifié et le pipeline a été légèrement «redressé» pour tenir compte du fait que, peu importe ce que le décodeur a dit à propos de l'instruction d'origine, le RoCC soudainement activé ne signifie pas qu'il y aura une longue écriture de latence dans le registre de sortie, comme pendant l'opération de division et manquer le cache de données. </p><br><p>  En général, une description d'une instruction est une paire ([modèle de reconnaissance d'une instruction], [ensemble de valeurs configurant des blocs de chemin de données du cœur du processeur]).  Par exemple, <code>default</code> (instruction non reconnue) ressemble à ceci (pris tel quel à partir de <code>IDecode.scala</code> , dans le bureau Habr, il semble, franchement, moche): </p><br><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">default</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>] = <span class="hljs-comment"><span class="hljs-comment">// jal renf1 fence.i // val | jalr | renf2 | // | fp_val| | renx2 | | renf3 | // | | rocc| | | renx1 s_alu1 mem_val | | | wfd | // | | | br| | | | s_alu2 | imm dw alu | mem_cmd mem_type| | | | mul | // | | | | | | | | | | | | | | | | | | | | | div | fence // | | | | | | | | | | | | | | | | | | | | | | wxd | | amo // | | | | | | | | scie | | | | | | | | | | | | | | | | | dp List(N,X,X,X,X,X,X,X,X,A2_X, A1_X, IMM_X, DW_X, FN_X, N,M_X, MT_X, X,X,X,X,X,X,X,CSR.X,X,X,X,X)</span></span></code> </pre> <br><p>  ... et une description typique de l' <em>une des extensions</em> de Rocket core est implémentée comme ceci: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IDecode</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">implicit val p: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Parameters</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DecodeConstants</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> table: <span class="hljs-type"><span class="hljs-type">Array</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = <span class="hljs-type"><span class="hljs-type">Array</span></span>( <span class="hljs-type"><span class="hljs-type">BNE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SNE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BEQ</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SEQ</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLT</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLT</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BLTU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SLTU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGE</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGE</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-type"><span class="hljs-type">BGEU</span></span>-&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">Y</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">A2_RS2</span></span>, <span class="hljs-type"><span class="hljs-type">A1_RS1</span></span>, <span class="hljs-type"><span class="hljs-type">IMM_SB</span></span>,<span class="hljs-type"><span class="hljs-type">DW_X</span></span>, <span class="hljs-type"><span class="hljs-type">FN_SGEU</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">M_X</span></span>, <span class="hljs-type"><span class="hljs-type">MT_X</span></span>, <span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">CSR</span></span>.<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>,<span class="hljs-type"><span class="hljs-type">N</span></span>), <span class="hljs-comment"><span class="hljs-comment">// ...</span></span></code> </pre> <br><p>  Le fait est que dans RISC-V (non seulement dans RocketChip, mais dans l'architecture de commande en principe), le fractionnement ISA est régulièrement pris en charge sur le sous-ensemble obligatoire I (opérations entières), ainsi que facultatif M (multiplication et division entières), A (atomique) etc. </p><br><p>  En conséquence, la méthode d'origine </p><br><pre> <code class="scala hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs = <span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> <br><p>  a été remplacé par </p><br><div class="spoiler">  <b class="spoiler_title">le même, mais avec un décodeur pour l'instrumentation et la clarification de la raison de l'activation de rocc</b> <div class="spoiler_text"><pre> <code class="scala hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decode</span></span></span></span>(inst: <span class="hljs-type"><span class="hljs-type">UInt</span></span>, table: <span class="hljs-type"><span class="hljs-type">Iterable</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])], handlers: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[<span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>]) = { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> decoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, table) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> sigs=<span class="hljs-type"><span class="hljs-type">Seq</span></span>(legal, fp, rocc_explicit, branch, jal, jalr, rxs2, rxs1, scie, sel_alu2, sel_alu1, sel_imm, alu_dw, alu_fn, mem, mem_cmd, mem_type, rfs1, rfs2, rfs3, wfd, mul, div, wxd, csr, fence_i, fence, amo, dp) sigs zip decoder map {<span class="hljs-keyword"><span class="hljs-keyword">case</span></span>(s,d) =&gt; s := d} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (handlers.isEmpty) { handler_rocc := <span class="hljs-literal"><span class="hljs-literal">false</span></span>.<span class="hljs-type"><span class="hljs-type">B</span></span> handler_rocc_funct := <span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerTable: <span class="hljs-type"><span class="hljs-type">Seq</span></span>[(<span class="hljs-type"><span class="hljs-type">BitPat</span></span>, <span class="hljs-type"><span class="hljs-type">List</span></span>[<span class="hljs-type"><span class="hljs-type">BitPat</span></span>])] = handlers.map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-type"><span class="hljs-type">OpcodeHandler</span></span>(pattern, funct) =&gt; pattern -&gt; <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">Y</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(funct.<span class="hljs-type"><span class="hljs-type">U</span></span>)) } <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> handlerDecoder = <span class="hljs-type"><span class="hljs-type">DecodeLogic</span></span>(inst, <span class="hljs-type"><span class="hljs-type">List</span></span>(<span class="hljs-type"><span class="hljs-type">N</span></span>, <span class="hljs-type"><span class="hljs-type">BitPat</span></span>(<span class="hljs-number"><span class="hljs-number">0.</span></span><span class="hljs-type"><span class="hljs-type">U</span></span>)), handlerTable) <span class="hljs-type"><span class="hljs-type">Seq</span></span>(handler_rocc, handler_rocc_funct) zip handlerDecoder map { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> (s,d) =&gt; s:=d } } rocc := rocc_explicit || handler_rocc <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> }</code> </pre> </div></div><br><p>  Parmi les changements dans le pipeline du processeur, le plus évident, peut-être, était le suivant: </p><br><pre> <code class="diff hljs"> io.rocc.exception := wb_xcpt &amp;&amp; csr.io.status.xs.orR io.rocc.cmd.bits.status := csr.io.status io.rocc.cmd.bits.inst := new RoCCInstruction().fromBits(wb_reg_inst) + when (wb_ctrl.handler_rocc) { + io.rocc.cmd.bits.inst.opcode := 0x0b.U // custom0 + io.rocc.cmd.bits.inst.funct := wb_ctrl.handler_rocc_funct + io.rocc.cmd.bits.inst.xd := false.B + io.rocc.cmd.bits.inst.rd := 0.U + } io.rocc.cmd.bits.rs1 := wb_reg_wdata io.rocc.cmd.bits.rs2 := wb_reg_rs2</code> </pre> <br><p>  Il est clair que certains paramètres de la demande à l'accélérateur doivent être corrigés: aucune réponse n'est écrite dans le registre, et <code>funct</code> est égal à ce que le décodeur a renvoyé.  Mais il y a un changement un peu moins évident: le fait est que cette commande ne va pas directement à l'accélérateur (quatre d'entre eux - lequel?), Mais au routeur, vous devez donc prétendre que la commande a <code>opcode == custom0</code> (oui, processus, et c'est précisément l'accélérateur zéro!). </p><br><h2 id="proverka">  Vérifier </h2><br><p>  En fait, cet article suppose une suite dans laquelle une tentative sera faite pour amener cette approche à un niveau de production plus ou moins.  Au minimum, vous devez apprendre à enregistrer et à restaurer le contexte (état des registres du coprocesseur) lors du changement de tâche.  En attendant, je vais vérifier que cela fonctionne d'une manière ou d'une autre en serre: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; uint64_t counter; uint64_t funct1(uint64_t x, uint64_t y) { return __builtin_popcountl(x); } uint64_t funct2(uint64_t x, uint64_t y) { return (x + y) * (x - y); } uint64_t instMUL() { counter += 1; *((uint64_t *)0x81005000) = counter; return 0; }</span></span></span></span></code> </pre> <br><p>  Maintenant, ajoutez au <code>bootrom/sdboot/sd.c</code> dans la ligne <code>main</code> </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/path/to/freedom-u-sdk/riscv-pk/machine/encoding.h"</span></span></span><span class="hljs-meta"> </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">// ... ////    -   RoCC #define STR1(x) #x #define STR(x) STR1(x) #define EXTRACT(a, size, offset) (((~(~0 &lt;&lt; size) &lt;&lt; offset) &amp; a) &gt;&gt; offset) #define CUSTOMX_OPCODE(x) CUSTOM_##x #define CUSTOM_0 0b0001011 #define CUSTOM_1 0b0101011 #define CUSTOM_2 0b1011011 #define CUSTOM_3 0b1111011 #define CUSTOMX(X, rd, rs1, rs2, funct) \ CUSTOMX_OPCODE(X) | \ (rd &lt;&lt; (7)) | \ (0x7 &lt;&lt; (7+5)) | \ (rs1 &lt;&lt; (7+5+3)) | \ (rs2 &lt;&lt; (7+5+3+5)) | \ (EXTRACT(funct, 7, 0) &lt;&lt; (7+5+3+5+5)) #define CUSTOMX_R_R_R(X, rd, rs1, rs2, funct) \ asm ("mv a4, %[_rs1]\n\t" \ "mv a5, %[_rs2]\n\t" \ ".word "STR(CUSTOMX(X, 15, 14, 15, funct))"\n\t" \ "mv %[_rd], a5" \ : [_rd] "=r" (rd) \ : [_rs1] "r" (rs1), [_rs2] "r" (rs2) \ : "a4", "a5"); int main(void) { // ... //  RoCC extension write_csr(mstatus, MSTATUS_XS &amp; (MSTATUS_XS &gt;&gt; 1)); //   bootrom       uint64_t res; CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 2); // ...     uint64_t x = 1; for (int i = 0; i &lt; 123; ++i) x *= *(volatile uint8_t *)0x80000000; kputc('0' + x % 10); //   !!! // ... }</span></span></span></span></code> </pre> <br><p>  <code>write_csr</code> ,     <code>custom0</code> - <code>custom3</code> .      ,   illegal instruction,  ,  , ,   .   <code>define</code> -     - ,   «» binutils  <code>customX</code>      RocketChip,  ,   ,   . </p><br><p>     sdboot  ,       ,      . </p><br><p>  : </p><br><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000000000 in ?? () (gdb) x/d 0x81005000 0x81005000: 123 (gdb) set variable $pc=0x10000 (gdb) c Continuing. ^C Program received signal SIGINT, Interrupt. 0x0000000000010488 in crc16_round (data=&lt;optimized out&gt;, crc=&lt;optimized out&gt;) at sd.c:151 151 crc ^= data; (gdb) x/d 0x81005000 0x81005000: 246</code> </pre> <br><div class="spoiler"> <b class="spoiler_title"> funct1</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">$ /hdd/trosinenko/rocket-tools/bin/riscv32-unknown-elf-gdb -q -ex "target remote :3333" -ex "set directories bootrom" builds/zeowaa-e115/sdboot.elf Reading symbols from builds/zeowaa-e115/sdboot.elf...done. Remote debugging using :3333 0x0000000000010194 in main () at sd.c:247 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); (gdb) set variable $a5=0 (gdb) set variable $pc=0x10194 (gdb) set variable $a4=0xaa (gdb) display/10i $pc-10 1: x/10i $pc-10 0x1018a &lt;main+46&gt;: sw a3,124(a3) 0x1018c &lt;main+48&gt;: addiw a0,a0,1110 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 =&gt; 0x10194 &lt;main+56&gt;: 0x2f7778b 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; (gdb) display/x $a5 2: /x $a5 = 0x0 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x4 (gdb) set variable $a4=0xaabc (gdb) set variable $pc=0x10194 (gdb) si 0x0000000000010198 247 CUSTOMX_R_R_R(0, res, 0xabcdef, 0x123456, 1); 1: x/10i $pc-10 0x1018e &lt;main+50&gt;: li a0,25 0x10190 &lt;main+52&gt;: mv a4,s0 0x10192 &lt;main+54&gt;: mv a5,a0 0x10194 &lt;main+56&gt;: 0x2f7778b =&gt; 0x10198 &lt;main+60&gt;: mv s0,a5 0x1019a &lt;main+62&gt;: lbu a5,0(a1) 0x1019e &lt;main+66&gt;: addiw a3,a3,-1 0x101a0 &lt;main+68&gt;: mul a2,a2,a5 0x101a4 &lt;main+72&gt;: bnez a3,0x1019a &lt;main+62&gt; 0x101a6 &lt;main+74&gt;: li a5,10 2: /x $a5 = 0x9</code> </pre> </div></div><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Code source</a> </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr461577/">https://habr.com/ru/post/fr461577/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr461565/index.html">Les 5 commandements du développeur TypeScript</a></li>
<li><a href="../fr461567/index.html">SQL Des puzzles divertissants</a></li>
<li><a href="../fr461569/index.html">Remarque pour le frontal: ce qu'il faut vérifier avant de tester</a></li>
<li><a href="../fr461571/index.html">SVG dans la vraie vie. Rapport Yandex</a></li>
<li><a href="../fr461575/index.html">Création d'un PBX cloud 3CX sur n'importe quel hébergement compatible Openstack</a></li>
<li><a href="../fr461579/index.html">WebMoney présente de nouveaux portefeuilles WMP et change les règles du jeu</a></li>
<li><a href="../fr461583/index.html">Python pour aider à tester les produits structurels</a></li>
<li><a href="../fr461587/index.html">Localisation de l'application en 10 étapes</a></li>
<li><a href="../fr461589/index.html">Tic Tac Toe: Cycle de contenu</a></li>
<li><a href="../fr461593/index.html">API sur F #. Accéder aux modules d'application basés sur les rôles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>