<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🚎 ⚙️ 🙎🏾 恶意软件的创建者如何尝试避免对其进行检测：我们以Spy.GmFUToMitm为例进行分析 ⛹🏾 🖐🏼 👩‍👧‍👧</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="图片：未飞溅 

 积极技术安全中心（PT Expert Security Center）的专家发现了一个有趣的恶意软件样本，该恶意软件在中国Internet领域传播。 除其他事项外，该软件还用于执行MITM攻击，其主要功能是可以避免检测的各种技术的结合。 我们决定解析它们，以显示恶意软件开发人员如...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>恶意软件的创建者如何尝试避免对其进行检测：我们以Spy.GmFUToMitm为例进行分析</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/477916/"> <a href="https://habr.com/ru/company/pt/blog/477916/"><img src="https://habrastorage.org/webt/l6/dn/zu/l6dnzurdqmn2zu0ju-wvz4pesns.png"></a> <br><br>  <i>图片：未<a href="https://unsplash.com/photos/NodtnCsLdTE">飞溅</a></i> <br><br> 积极技术安全中心（PT Expert Security Center）的专家发现了一个有趣的恶意软件样本，该恶意软件在中国Internet领域传播。 除其他事项外，该软件还用于执行MITM攻击，其主要功能是可以避免检测的各种技术的结合。 我们决定解析它们，以显示恶意软件开发人员如何隐藏其活动。 <a name="habracut"></a><br><br><h2> 一切如何开始 </h2><br> 网络流量分析系统已引起我们的注意，即恶意应用程序会定期请求包含其附加内容的图像。 下载是从用于存储图像的合法资源进行的-imgsa.baidu.com。 另外，事实证明，这是一张具有压倒性的可爱程度的图片：)在此之后，攻击者试图用它来隐藏各种恶意负载，这真是亵渎神灵！ <br><br><img src="https://habrastorage.org/webt/0g/w_/1p/0gw_1prxeuv_ebvzulxo9a83uta.png"><br><br>  <i>图</i>  <i>1.用于隐藏有效载荷交付事实的图像</i> <br><br> 首先，为了收集初始数据并比较样本，我们组织了一次搜索以寻找类似样本-并找到了一些样本。 这要归功于网络交互中的特征数据以及我们广泛的恶意流量数据库。 特别是，在网络流量中可以看到清晰的模式，这种模式包括恶意应用程序重复相同的动作。 <br><br><img src="https://habrastorage.org/webt/21/f7/kp/21f7kp37glvn5ukjzkzup1aue-c.png"><br><br>  <i>图</i>  <i>2.具有标记模式的网络流量</i> <br><br> 我们检查了第一个请求，作为响应，服务器返回了一个加密的配置（图3），其中包含包含有效负载的图像的地址。 此数据存储在<code>hxxp://63634[.]top:8081/koded</code> 。 <br><br><img src="https://habrastorage.org/webt/l-/tj/p3/l-tjp3mktcejwhwftjp63l7kvdc.png"><br><br>  <i>图</i>  <i>3.加密配置</i> <br><br><h2> 资料解密 </h2><br> 接收到的数据通过DES算法在电子密码本模式下使用恶意程序主体中包含的密钥0x6a 0x5f 0x6b 0x2a 0x61 0x2d 0x76 0x62解密。 解密后，明文是一个字符串（图4），每个字符串都包含指向图像的链接。 基于MD5哈希的相等性，这是同一张图片。 显然，为了稳定传递方案，攻击者将相同的数据放置在不同的地址。 <br><br><img src="https://habrastorage.org/webt/-_/qm/hk/-_qmhk4timxxqxopfeseq2eqqmq.png"><br><br>  <i>图</i>  <i>4.解密的引导加载程序配置示例</i> <br><br> 使用获得的数据，下一步是恶意下载程序启动图像的下载。 它从中剪切出前5120个字节（鸭子和小狗），仅使用有效载荷（图5），紧随其后的是第5121个字节。 <br><br><img src="https://habrastorage.org/webt/sf/hp/nw/sfhpnw2tf4czpiir9ggptr54wuc.png"><br><br>  <i>图5。</i>  <i>有效负载示例。</i> <br><br> 解密数据后，我们得到了下一个格式配置，类似于第一步中获得的配置。 这是图像链接的另一部分，但是这次所有的MD5哈希值都不同，并且每行末尾都有两个字符后缀： <br><br><img src="https://habrastorage.org/webt/mh/gu/2d/mhgu2dfte_atosffumpnijqheus.png"><br><br>  <i>图</i>  <i>6.第二组链接和可疑后缀</i> <br><br><h2> 恶意算法 </h2><br> 现在，这些是真正的有效负载模块。 事实证明，每行末尾的两个字符用于选择特定的图像，即特定的有效负载。 首先，使用带有后缀“ AD”的行（图7）。 在创建恶意软件的阶段，该选择已经预先确定。 即，加载顺序以两位后缀的形式预定义。 <br><br><img src="https://habrastorage.org/webt/cb/xg/xq/cbxgxqfbq2r64bsmp0il4rmeyyg.png"><br><br>  <i>图</i>  <i>7.选择带有后缀“ AD”的链接</i> <br><br> 下载的图像已经包含恶意模块，至少可以根据其大小来表示。 数据仍被掩盖为图像，并且位于5120字节的相同偏移量处。 丢弃多余的字节后，加载程序将提取，检查哈希量，然后将名为TkRep.dll的模块解密为PE文件。 <br><br><img src="https://habrastorage.org/webt/0d/8s/m2/0d8sm2zxbjxfjps8-8_c_9togmi.png"><br><br>  <i>图</i>  <i>8.图像主体中的加密模块及其散列和的示例</i> <br><br> 这个库被加载到一个恶意进程中，首先检查模块运行的环境： <br><br><img src="https://habrastorage.org/webt/gu/zx/cd/guzxcda-y0-n8zvcpxli8cc_meq.png"><br><br>  <i>图</i>  <i>9.检查虚拟化环境</i> <br><br> 检查正在运行的进程之间是否存在名称为devenv.exe，OLLYDBG.EXE，Dbgview.exe，windbg.exe，MSDEV.exe，Delphi32.exe，E.exe，PCHunter32.exe，PCHunter64.exe的进程以及是否存在防病毒工具。 <br><br><img src="https://habrastorage.org/webt/pn/lp/z1/pnlpz1wsbzcdwrlmzgmmy9lilqu.png"><br><br>  <i>图</i>  <i>10.流程验证</i> <br><br> 进行标准的调试检查。 <br><br><img src="https://habrastorage.org/webt/o9/ym/wb/o9ymwbmgmz_k0fj_chbh9f94f3e.png"><br><br>  <i>图</i>  <i>11.在调试器的上下文中检查过程的开始</i> <br><br> 检查表中列出的打开的管道。 <br><div class="scrollable-table"><table><tbody><tr><td>  \\。\ FltMouseKb </td><td>  \\。\ GameGuard </td><td>  \\。\ GxWfpFlt </td></tr><tr><td>  \\。\ XxGamesFilter </td><td>  \\。\ GpeNetSafe </td><td>  \\。\ TeSafe </td></tr><tr><td>  \\。\驾驶员 </td><td>  \\。\ PowerChange </td><td>  \\。\ xspeed </td></tr><tr><td>  \\。\ gmMemProt </td><td>  \\。\ diafahbb </td><td></td></tr></tbody></table></div><br> 下一步是在恶意服务器上注册受感染的节点，使用POST请求将有关受感染节点的加密信息发送到HTTP协议（图12）。 <br><br><img src="https://habrastorage.org/webt/9v/2y/gb/9v2ygblmrf-6yujlu9jzktmiqtu.png"><br><br>  <i>图</i>  <i>12.请求在网络犯罪分子的服务器上注册</i> <br><br> 值得注意的是，来自服务器的响应始终包含相同的数据，此外，客户端仅考虑服务器的响应代码。 <br><br><h2> 恶意软件如何隐藏其活动 </h2><br> 根据给定的有效载荷序列，我们继续进行以下研究。 后缀为“ AR”。 客户端根据现有方案，从百度图像图像存储服务中下载具有加密负载的图像的下一个串联，解密该模块，并以随机名称在新进程中启动它。 我们认为，此功能可以使恶意应用看起来无害。 通常，这是在线游戏的客户端（图13）。 这是另一种伪装技术。 <br><br><img src="https://habrastorage.org/webt/er/hs/xv/erhsxvplhvtpgvvdtbhjxt5bfcc.png"><br><br>  <i>图</i>  <i>13.在线游戏界面</i> <br><br> 在进行这种分散注意力的操作之后，恶意程序将进入修复受感染节点的阶段。 为此，它使用的功能类似于rootkit程序的功能。 特别是将自己的安全驱动程序引入系统。 <br><br> 这就是它的发生方式。 从解密的配置中，选择带有后缀“ AE”的负载。 这是TaskReportDLL.dll库。 它具有与上一阶段的TkRep.dll库相同的功能-发送有关系统的信息并检查防护设备的可用性。 <br><br> 然后，下载RealWorkDll.dll库。 在RealWorkDll.dll的功能中，重要的是下载受VMPROTECT部分​​保护的驱动程序，以及该驱动程序将安装在系统上的PE文件。 <br><br><img src="https://habrastorage.org/webt/tj/f3/p3/tjf3p3ibgodxrv3ikuq-vwcrh1c.png"><br><br>  <i>图</i>  <i>14.驱动程序数据库的路径</i> <br><br> 然后，将删除用于安装驱动程序的PE文件，并完成此固定阶段。 <br><br> 在驱动程序数据库行中的搜索将我们<a href="https://github.com/bowlofstew/rootkit.com/tree/master/petersilberman/FUTo_enhanced/FUTo/Sys/objfre_wxp_x86">引</a>到rootkit [。] Com资源镜像存储库，在其中找到<a href="https://github.com/bowlofstew/rootkit.com/tree/master/petersilberman/FUTo_enhanced/FUTo/Sys/objfre_wxp_x86">了FUTo rootkit</a>的<a href="https://github.com/bowlofstew/rootkit.com/tree/master/petersilberman/FUTo_enhanced/FUTo/Sys/objfre_wxp_x86">实例，该实例</a>在路径“ objfre_wxp_x86”中具有相应的名称（图14）。 在我们公司的博客中，该rootkit <a href="https://www.securitylab.ru/analytics/270346.php">早在2006年</a>就被<a href="https://www.securitylab.ru/analytics/270346.php">考虑到了</a> 。 <br><br> 让我们更详细地考虑RealWorkDll.dll模块安装的SDriverBlogx86驱动程序在系统中的工作。 在第一阶段，客户的注册数据进入网络。  POST被用作请求，但是现在在端口号8081上（图15）。 显然，如果受感染系统上的活动已达到rootkit“ FUTo”的激活阶段，则此端口用于接收数据。 <br><br><img src="https://habrastorage.org/webt/gs/tr/t9/gstrt9gohlqdronncmcwk6q0hb0.png"><br><br>  <i>图</i>  <i>15.从系统中安装的驱动程序请求C2</i> <br><br> 对网络罪犯服务器的访问以加密形式进行，加密之前的数据是有关系统的信息。 所有模块的数据字段分隔符，表示格式和字段数均相同（图16）。 <br><br><img src="https://habrastorage.org/webt/iy/sf/pr/iysfprhuyq_9vjc-hur6hfdpfy8.png"><br><br>  <i>图</i>  <i>16.识别受感染节点的系统信息</i> <br><br> 此外，嵌入在系统中的驱动程序的操作机制与启动引导加载程序一致-唯一的区别是，这次需要从rootkit端口请求链接到映像，并且配置存储路径从/ koded更改为/ qqwe。 也许这与qq.com和wechat.com服务有关。 <br><br> 进程接收的模块列表包含PE文件列表。 但是在这种情况下，该行的末尾包含一个文件名形式的键，而不是选择负载的两个字母的后缀： <br><br><img src="https://habrastorage.org/webt/n8/xr/51/n8xr51-qz69zri5bwxyvfiu9wgs.png"><br><br>  <i>图</i>  <i>17.由系统中固定的驱动程序接收的配置</i> <br><br> 加载图像后，有效负载也位于5120字节的偏移处。 已安装驱动程序的有效负载结构包括前一个列表中的密钥（文件名形式），然后是PE文件本身。 与前面的步骤不同，有效负载在此处未加密。 <br><br><img src="https://habrastorage.org/webt/zo/vy/my/zovymyyhryi-ihrgfzlgubjta1i.png"><br><br>  <i>图</i>  <i>18.系统中安装的rootkit收到的有效负载</i> <br><br> 在此阶段接收到的所有有效负载中，值得注意的是用于进行MITM攻击的模块。 它的哈希值等于<code>b9fcf48376083c71db0f13c9e344c0383bafa5b116fbf751672d54940082b99a</code> ，带有它的图像存储<a href="">在此地址</a> 。 <br><br> 结果模块会检查名称为devenv.exe，OLLYDBG.EXE，Dbgview.exe，windbg.exe，MSDEV.exe，Delphi32.exe，E.exe，PCHunter32.exe，PCHunter64.exe的进程，以及进程ZhuDongFangYu，360Safe， 360Tray。 <br><br> 在使用GET请求的过程中，将下载证书server.crt，server.key，server.der，startcom.crt。 <br><br><img src="https://habrastorage.org/webt/hd/s8/kr/hds8krd8qzazdej61nnc4gt0lv4.png"><br><br>  <i>图</i>  <i>19.申请证书</i> <br><br> 进行MITM攻击的模块的类名无疑使攻击者的意图毫无疑问（图20）。 <br><br><img src="https://habrastorage.org/webt/s6/_y/w7/s6_yw7bq8p9p2wv1z5m1c9bey04.png"><br><br>  <i>图</i>  <i>20.进行MITM攻击的模块的类名</i> <br><br><h2> 结论 </h2><br> 该恶意软件由引导加载程序，伪装文件，rootkit驱动程序和用于在中间攻击中引导人员的模块组成。 对于隐蔽的有效载荷传递，该软件使用一种将数据与JPEG图像拼接的技术。 对于命令服务器，攻击者在顶级域名，出价和基于云平台的区域中注册名称。 <br><br> 以下是一些掩盖恶意软件开发人员使用的活动的方法： <br><br><ul><li> 伪装成法律申请， </li><li> 屏蔽图片流量 </li><li> 作为rootkit对接。 </li></ul><br> 网络流量分析系统<a href="https://www.ptsecurity.com/ru-ru/products/network-attack-discovery/">PT网络攻击发现</a>将检测到的威胁称为Spy.GmFUToMitm。 <br><br><div class="spoiler">  <b class="spoiler_title">国际奥委会</b> <div class="spoiler_text">  1953db709a96bc70d86f7dfd04527d3d0cb7c94da276ddf8f0ef6c51630a2915 <br>  1ab1b2fe3ce0fd37a0bb0814a2cac7e974f20963800f43d2f5478fc88c83a3da <br>  1c8dbaf0a5045e2b4a6787635ded8f51d8e89a18e398c0dd79b1b82a968df1a0 <br>  9b7082ac4165b25a3b22f2aafdd41ea5f3512a76693f6a6b3101873a9cded961 <br>  9cee3f6d6e39adfa0d4712541c070b9c2423275698be0c6cd6cd8239d8793250 <br>  b9fcf48376083c71db0f13c9e344c0383bafa5b116fbf751672d54940082b99a <br>  df3e7b04d988cf5634ec886321cb1ac364a46181e7a63f41f0788753e52dcf34 <br>  eb67c1d69eb09e195b8333e12c41a0749e7e186c9439f1e2c30f369712ce2c12 <br>  <a href="http://63634.top/">63634.top</a> <br>  <a href="http://anli.bid/">Anli.bid</a> <br>  <a href="http://shangdai.bid/">上标</a> <br>  <a href="http://b-blog.oss-cn-beijing.aliyuncs.com/">b-blog.oss-cn-beijing.aliyuncs.com</a> </div></div><br>  <b>作者</b> ：Dmitry Makarov，Evgeny Ustinov，Positive Technologies </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN477916/">https://habr.com/ru/post/zh-CN477916/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN477904/index.html">使用oEmbed以编程方式搜索通用代码</a></li>
<li><a href="../zh-CN477908/index.html">木偶3：无需一行代码即可进行自动化测试</a></li>
<li><a href="../zh-CN477910/index.html">黑色星期五2019-莫斯科和阿姆斯特丹的VDS，带GPU的服务器</a></li>
<li><a href="../zh-CN477912/index.html">具有E Ink Carta Mobius屏幕的10.3英寸PocketBook X阅读器的第一印象</a></li>
<li><a href="../zh-CN477914/index.html">投影在天花板上：使用投影机一周后的印象，放在“末端”</a></li>
<li><a href="../zh-CN477924/index.html">JavaFX教程：CSS样式</a></li>
<li><a href="../zh-CN477926/index.html">如何使用生成器减少内存使用并加速Python代码</a></li>
<li><a href="../zh-CN477928/index.html">QA-mitap Redmadrobot的报告记录</a></li>
<li><a href="../zh-CN477930/index.html">MVP的最佳体系结构：整体式，SOA，微服务还是无服务器？..第2部分</a></li>
<li><a href="../zh-CN477934/index.html">房东在黑色星期五2019的折扣</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>