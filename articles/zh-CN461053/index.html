<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ¥‘ ğŸ§ ğŸ‘€ æˆ‘ä»¬å°†åœ¨çº¿åœ°å›¾è¿æ¥åˆ°æ™ºèƒ½æ‰‹æœºä¸Šçš„å¯¼èˆªå™¨ã€‚ ç¬¬2éƒ¨åˆ†-çŸ¢é‡å¡ ğŸ‘£ ğŸ‘©ğŸ¼â€ğŸ¤â€ğŸ‘¨ğŸ» âœ‹ğŸ½</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œå®ƒå°†åŸºäºåœ¨çº¿çŸ¢é‡åœ°å›¾ç”ŸæˆPNGæ …æ ¼å›¾å—ã€‚ ä¸Puppeteerä¸€èµ·ä½¿ç”¨ç½‘ç»œæŠ“å–åŠŸèƒ½æ¥è·å–åœ°å›¾æ•°æ®ã€‚ 
 å†…å®¹ï¼š 


 1- ç®€ä»‹ã€‚ æ ‡å‡†æ …æ ¼å›¾ 
 2-ç»§ç»­ã€‚ ä¸ºçŸ¢é‡åœ°å›¾ç¼–å†™ä¸€ä¸ªç®€å•çš„å…‰æ …åŒ–å™¨ 
 3- ç‰¹ä¾‹ã€‚ æˆ‘ä»¬è¿æ¥äº†OverpassTurboå¡ 
 å»¶ç»­æ€§ 
...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>æˆ‘ä»¬å°†åœ¨çº¿åœ°å›¾è¿æ¥åˆ°æ™ºèƒ½æ‰‹æœºä¸Šçš„å¯¼èˆªå™¨ã€‚ ç¬¬2éƒ¨åˆ†-çŸ¢é‡å¡</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/461053/"><p> æˆ‘ä»¬æ­£åœ¨ç¼–å†™ä¸€ä¸ªæœåŠ¡å™¨åº”ç”¨ç¨‹åºï¼Œå®ƒå°†åŸºäºåœ¨çº¿çŸ¢é‡åœ°å›¾ç”ŸæˆPNGæ …æ ¼å›¾å—ã€‚ ä¸Puppeteerä¸€èµ·ä½¿ç”¨ç½‘ç»œæŠ“å–åŠŸèƒ½æ¥è·å–åœ°å›¾æ•°æ®ã€‚ </p><a name="habracut"></a><br><h3 id="soderzhanie"> å†…å®¹ï¼š </h3><br><p> 1- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç®€ä»‹ã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æ ‡å‡†æ …æ ¼å›¾</a> <br>  2-ç»§ç»­ã€‚ ä¸ºçŸ¢é‡åœ°å›¾ç¼–å†™ä¸€ä¸ªç®€å•çš„å…‰æ …åŒ–å™¨ <br>  3- <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ç‰¹ä¾‹ã€‚</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æˆ‘ä»¬è¿æ¥äº†OverpassTurboå¡</a> </p><br><h3 id="prodolzhenie"> å»¶ç»­æ€§ </h3><br><p> å› æ­¤ï¼Œæˆ‘ä»¬æ¥åˆ°äº†æœ€æœ‰è¶£çš„è¯é¢˜ã€‚ æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªå¸¦æœ‰åœ°å›¾çš„ç«™ç‚¹ï¼Œæˆ‘ä»¬ç¡®å®è¦å°†å…¶æ·»åŠ åˆ°å¯¼èˆªå™¨ä¸­ã€‚ æˆ‘ä»¬æŒ‰ç…§<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">ä¸Šä¸€éƒ¨åˆ†</a>çš„è¯´æ˜è¿›è¡Œæ‰€æœ‰æ“ä½œã€‚ æˆ‘ä»¬æ‰“å¼€äº†å¯¹è¯¥ç½‘ç«™å†…å®¹çš„æŸ¥çœ‹ï¼Œæ²¡æœ‰å›¾ç‰‡ï¼ ç»å¯¹æ˜¯ å¥½å§ï¼Œå‡ ä¸ªå›¾æ ‡å°±å¯ä»¥äº†ã€‚ å’Œå…¶ä»–ä¸€äº›å¸¦æœ‰åæ ‡åˆ—è¡¨çš„æ–‡æœ¬æ–‡ä»¶ã€‚ </p><br><p> æ­å–œï¼Œæˆ‘ä»¬æ‰¾åˆ°äº†çŸ¢é‡å›¾ã€‚ ç²—ç•¥åœ°è¯´ï¼Œå®ƒæ˜¯ç”±æµè§ˆå™¨å®æ—¶å‘ˆç°çš„ã€‚ å› æ­¤ï¼Œå¥¹æ ¹æœ¬ä¸éœ€è¦ä»»ä½•å‡†å¤‡å¥½çš„ç“·ç –ã€‚ ä¸€æ–¹é¢ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼Œæ²¡æœ‰å¤ªå¤šçš„çŸ¢é‡åœ°å›¾ã€‚ ä½†æ˜¯è¿™é¡¹æŠ€æœ¯éå¸¸æœ‰å‰é€”ï¼Œéšç€æ—¶é—´çš„æµé€ï¼Œå®ƒä»¬çš„æ•°é‡å¯èƒ½ä¼šå¢åŠ å¾ˆå¤šå€ã€‚ å¥½å§ï¼Œæˆ‘ä»¬çŸ¥é“äº†ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬ç°åœ¨è¯¥æ€ä¹ˆåŠï¼Ÿ </p><br><p> é¦–å…ˆï¼Œæ‚¨å¯ä»¥å°è¯•ä¸‹è½½éå¸¸è€ç‰ˆæœ¬çš„æµè§ˆå™¨ã€‚ ä¸€ç§ä¸æ”¯æŒæ¸²æŸ“åœ°å›¾æ‰€éœ€çš„åŠŸèƒ½ã€‚ å¯èƒ½ä¼šå‘æ‚¨æ˜¾ç¤ºè¯¥ç½‘ç«™çš„å…¶ä»–ç‰ˆæœ¬ã€‚ å¸¦æœ‰æ …æ ¼å›¾ã€‚ å¥½å§ï¼Œæ‚¨å·²ç»çŸ¥é“è¯¥æ€ä¹ˆåšã€‚ </p><br><p> ä½†æ˜¯ï¼Œå¦‚æœè¿™ç§æ–¹æ³•ä¸èµ·ä½œç”¨ï¼Œä½†æ˜¯æ‚¨ä»ç„¶çœŸçš„æƒ³è·å¾—æ­¤å¡ï¼Œè€Œä¸”ä¸æ˜¯åœ¨æ™ºèƒ½æ‰‹æœºçš„æµè§ˆå™¨ä¸­ï¼ˆå³åœ¨æ‚¨çš„å¯¼èˆªå™¨ä¸­ï¼‰ï¼Œé‚£ä¹ˆæœ‰ä¸€ç§æ–¹æ³•ã€‚ </p><br><h3 id="osnovnaya-ideya"> ä¸»è¦æ€æƒ³ </h3><br><p> æˆ‘ä»¬å°†ä»æƒ³è¦è·å¾—å¯ä»¥åœ¨ä»»ä½•å¯¼èˆªå™¨ä¸­æ‰“å¼€çš„åœ°å›¾çš„äº‹å®å‡ºå‘ã€‚ ç„¶åï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªé€‚é…å™¨-ä¸€ç§ä¸­ä»‹ï¼Œå®ƒå°†ä¸ºæˆ‘ä»¬ç”ŸæˆPNGæ ¼å¼çš„å›¾å—ã€‚ </p><br><p> åŸæ¥ä½ éœ€è¦ <del> å‘æ˜è‡ªè¡Œè½¦ </del> å¼€å‘å¦ä¸€ä¸ªç”¨äºå¯è§†åŒ–çŸ¢é‡æ•°æ®çš„å¼•æ“ã€‚ å¥½å§ï¼Œæˆ–è€…æ‚¨å¯ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬ï¼Œè¯¥è„šæœ¬å°†è½¬åˆ°è¯¥ç«™ç‚¹ï¼Œä»è€Œå…è®¸ä»–è‡ªå·±ç»˜åˆ¶è‡ªå·±çš„çŸ¢é‡åœ°å›¾ã€‚ ç„¶åä»–å°†ç­‰å¾…ä¸‹è½½ï¼Œæˆªå±ï¼Œè£å‰ªå¹¶è¿”å›ç»™ç”¨æˆ·ã€‚ ä¹Ÿè®¸æˆ‘ä¼šé€‰æ‹©ç¬¬äºŒä¸ªé€‰é¡¹ã€‚ </p><br><p> è¦è·å–å±å¹•æˆªå›¾ï¼Œæˆ‘å°†ä½¿ç”¨â€œé¥æ§æµè§ˆå™¨â€-æ— å¤´Chromeã€‚ æ‚¨å¯ä»¥ä½¿ç”¨node jsåº“<strong>Puppeteer</strong>å¯¹å…¶è¿›è¡Œæ§åˆ¶ã€‚ æ‚¨å¯ä»¥ä»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">æœ¬æ–‡</a>äº†è§£ä½¿ç”¨æ­¤åº“çš„åŸºç¡€çŸ¥è¯†ã€‚ </p><br><h3 id="hello-world-ili-sozdaem-i-nastraivaem-proekt"> ä¸–ç•Œæ‚¨å¥½ï¼ æˆ–åˆ›å»ºå’Œè‡ªå®šä¹‰é¡¹ç›® </h3><br><p> å¦‚æœå°šæœªå®‰è£…Node.jsï¼Œè¯·è½¬<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">è‡³æ­¤</a>é¡µé¢æˆ–<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">æ­¤</a>é¡µé¢ï¼Œé€‰æ‹©æ“ä½œç³»ç»Ÿï¼Œç„¶åæ ¹æ®è¯´æ˜æ‰§è¡Œå®‰è£…ã€‚ </p><br><p> ä¸ºé¡¹ç›®åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶å¤¹ï¼Œç„¶ååœ¨ç»ˆç«¯ä¸­æ‰“å¼€å®ƒã€‚ </p><br><pre><code class="plaintext hljs">$ cd /Mapshoter_habr</code> </pre> <br><p> æˆ‘ä»¬å¼€å§‹åˆ›å»ºæ–°é¡¹ç›®çš„ç»ç† </p><br><pre> <code class="plaintext hljs">$ npm init</code> </pre> <br><p> åœ¨è¿™é‡Œï¼Œæ‚¨å¯ä»¥æŒ‡å®šé¡¹ç›®çš„åç§°ï¼ˆ <strong>åŒ…åç§°</strong> ï¼‰ï¼Œç”¨äºè¾“å…¥åº”ç”¨ç¨‹åºçš„æ–‡ä»¶çš„åç§°ï¼ˆ <strong>å…¥å£ç‚¹</strong> ï¼‰å’Œä½œè€…çš„åç§°ï¼ˆ <strong>author</strong> ï¼‰ã€‚ å¯¹äºå…¶ä»–æ‰€æœ‰è¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½åŒæ„é»˜è®¤å‚æ•°ï¼šä¸è¾“å…¥ä»»ä½•å†…å®¹ï¼Œåªéœ€æŒ‰<strong>Enterå³å¯</strong> ã€‚ æœ€åï¼ŒæŒ‰<strong>y</strong> ï¼Œç„¶åæŒ‰<strong>Enter</strong> ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œå®‰è£…å¿…è¦çš„å·¥ä½œæ¡†æ¶ã€‚  Expressç”¨äºåˆ›å»ºæœåŠ¡å™¨ï¼ŒPuppeteerç”¨äºä½¿ç”¨æµè§ˆå™¨ã€‚ </p><br><pre> <code class="plaintext hljs">$ npm install express $ npm i puppeteer</code> </pre> <br><p> ç»“æœï¼Œé¡¹ç›®é…ç½®æ–‡ä»¶<strong>package.json</strong>å‡ºç°åœ¨é¡¹ç›®æ–‡ä»¶å¤¹ä¸­ã€‚ å°±æˆ‘è€Œè¨€ï¼š </p><br><pre> <code class="json hljs">{ <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"mapshoter_habr"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"version"</span></span>: <span class="hljs-string"><span class="hljs-string">"1.0.0"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"description"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-attr"><span class="hljs-attr">"main"</span></span>: <span class="hljs-string"><span class="hljs-string">"router.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"author"</span></span>: <span class="hljs-string"><span class="hljs-string">"nnngrach"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"license"</span></span>: <span class="hljs-string"><span class="hljs-string">"ISC"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"dependencies"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"express"</span></span>: <span class="hljs-string"><span class="hljs-string">"^4.17.1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"puppeteer"</span></span>: <span class="hljs-string"><span class="hljs-string">"^1.18.1"</span></span> } }</code> </pre> <br><p> æˆ‘å°†å¼€å§‹è¡Œæ·»åŠ åˆ°è„šæœ¬éƒ¨åˆ†ï¼Œä»¥æ›´æ–¹ä¾¿åœ°å¯åŠ¨æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºã€‚ </p><br><pre> <code class="json hljs"><span class="hljs-string"><span class="hljs-string">"scripts"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"start"</span></span>: <span class="hljs-string"><span class="hljs-string">"node router.js"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"test"</span></span>: <span class="hljs-string"><span class="hljs-string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span></span> },</code> </pre> <br><p> ç°åœ¨åˆ›å»ºå…·æœ‰åŸºæœ¬åŠŸèƒ½å®ç°çš„ä¸¤ä¸ªæ–‡ä»¶ã€‚ ç¬¬ä¸€ä¸ªæ–‡ä»¶æ˜¯åº”ç”¨ç¨‹åºçš„å…¥å£ç‚¹ã€‚ å°±æˆ‘è€Œè¨€ï¼Œæ˜¯<strong>router.js</strong> ã€‚ ä»–å°†åˆ›å»ºæœåŠ¡å™¨å¹¶è¿›è¡Œè·¯ç”±ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//        const express = require( 'express' ) const mapshoter = require( './mapshoter' ) //  ,       const PORT = process.env.PORT || 5000 //     const app = express() app.listen( PORT, () =&gt; { console.log( '    ', PORT ) }) //       // http://siteName.com/x/y/z app.get( '/:x/:y/:z', async ( req, res, next ) =&gt; { //      const x = req.params.x const y = req.params.y const z = req.params.z //      const screenshot = await mapshoter.makeTile( x, y, z ) //        const imageBuffer = Buffer.from( screenshot, 'base64' ) //    res.writeHead( 200, { 'Content-Type': 'image/png', 'Content-Length': imageBuffer.length }) //    res.end( imageBuffer ) })</span></span></code> </pre> <br><p> ç°åœ¨åˆ›å»ºç¬¬äºŒä¸ªæ–‡ä»¶ã€‚ ä»–å°†æ§åˆ¶æµè§ˆå™¨å¹¶æ‹æ‘„å±å¹•æˆªå›¾ã€‚ æˆ‘æŠŠå®ƒå«åš<strong>mapshoter.js</strong> ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> x, y, z </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   const browser = await puppeteer.launch() //       const page = await browser.newPage() await page.goto( 'https://www.google.ru/' ) //    const screenshot = await page.screenshot() //      await browser.close() return screenshot } module.exports.makeTile = makeTile</span></span></code> </pre> <br><p> è¿è¡Œæˆ‘ä»¬çš„è„šæœ¬å¹¶æ£€æŸ¥å…¶æ€§èƒ½ã€‚ ä¸ºæ­¤ï¼Œè¯·åœ¨æ§åˆ¶å°ä¸­è¾“å…¥ï¼š </p><br><p> <code>$ npm start</code> </p> <br><p> å‡ºç°ä¸€æ¡æ¶ˆæ¯ï¼Œè¯´â€œæœåŠ¡å™¨åœ¨ç«¯å£5000ä¸Šåˆ›å»ºâ€ã€‚ ç°åœ¨ï¼Œåœ¨æ‚¨çš„è®¡ç®—æœºä¸Šæ‰“å¼€æµè§ˆå™¨ï¼Œç„¶åè½¬åˆ°æˆ‘ä»¬æœåŠ¡å™¨çš„æœ¬åœ°åœ°å€ã€‚ æ‚¨å¯ä»¥è¾“å…¥ä»»ä½•æ•°å­—æ¥ä»£æ›¿<strong>xï¼Œyï¼Œz</strong>åæ ‡ã€‚ æˆ‘è¾“å…¥äº†1ã€2ã€3ã€‚ </p><br><p> <code>http://localhost:5000/1/2/3</code> </p> <br><p> å¦‚æœä¸€åˆ‡æ“ä½œæ­£ç¡®ï¼Œå°†æ˜¾ç¤ºGoogleç½‘ç«™çš„å±å¹•æˆªå›¾ã€‚ </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/66a/8db/ca5/66a8dbca5b15566f395ec6bf4163279c.png" alt="å›¾ç‰‡"></p><br><p> åœ¨æ§åˆ¶å°ä¸­æŒ‰Ctrl + Cåœæ­¢è„šæœ¬ã€‚ </p><br><p> æ­å–œï¼Œæˆ‘ä»¬çš„ç”³è¯·åŸºç¡€å·²ç»å‡†å¤‡å°±ç»ªï¼ æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæœåŠ¡å™¨ï¼Œè¯¥æœåŠ¡å™¨æ¥å—htmlè¯·æ±‚ï¼Œæˆªå±å¹¶å‘æˆ‘ä»¬è¿”å›å›¾åƒã€‚ ç°åœ¨æ˜¯æ—¶å€™è¿›è¡Œç»†èŠ‚çš„å®ç°äº†ã€‚ </p><br><h3 id="rasschitaem-koordinaty"> è®¡ç®—åæ ‡ </h3><br><p> è¿™ä¸ªæƒ³æ³•æ˜¯æµè§ˆå™¨å°†æ‰“å¼€ä¸€ä¸ªå¸¦æœ‰åœ°å›¾çš„ç«™ç‚¹ï¼Œç„¶ååœ¨æœç´¢æ ä¸­è¾“å…¥æˆ‘ä»¬éœ€è¦çš„åœ°ç‚¹çš„åæ ‡ã€‚ å•å‡»â€œæŸ¥æ‰¾â€æŒ‰é’®åï¼Œè¯¥ä½ç½®å°†æ°å¥½åœ¨å±å¹•ä¸­å¤®ã€‚ å› æ­¤ï¼Œå¾ˆå®¹æ˜“åˆ‡å‡ºæˆ‘ä»¬éœ€è¦çš„åŒºåŸŸã€‚ </p><br><p> ä½†é¦–å…ˆï¼Œæ‚¨éœ€è¦æ ¹æ®å…¶åºåˆ—å·è®¡ç®—å›¾å—ä¸­å¿ƒçš„åæ ‡ã€‚ æˆ‘å°†æ ¹æ®æŸ¥æ‰¾å·¦ä¸Šè§’çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">å…¬å¼</a>è¿›è¡Œæ­¤æ“ä½œã€‚ æˆ‘æŠŠå®ƒæ”¾åœ¨<strong>getCoordinatesï¼ˆï¼‰</strong>å‡½æ•°ä¸­ã€‚ </p><br><p> ç”±äºå¯¹äºæŸäº›ç«™ç‚¹ï¼Œé™¤äº†å›¾å—çš„ä¸­å¿ƒä¹‹å¤–ï¼Œæ‚¨è¿˜éœ€è¦æŒ‡å®šå…¶è¾¹ç•Œï¼Œå› æ­¤æˆ‘ä¹Ÿä¼šå¯»æ‰¾å®ƒä»¬çš„è¾¹ç•Œã€‚ å¥½å§ï¼Œè®©æˆ‘ä»¬ä»¥<strong>geoTools.js</strong>çš„åç§°ä¸ºè¿™äº›è®¡ç®—åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„æ¨¡å—ã€‚ è¿™æ˜¯ä»–çš„ä»£ç ï¼š </p><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   -   function getCoordinates( x, y, z ) { const n = Math.pow( 2, z ) const lon = x / n * 360.0 - 180.0 const lat = 180.0 * ( Math.atan( Math.sinh( Math.PI * ( 1 - 2 * y / n) ) ) ) / Math.PI return { lat: lat, lon: lon } } //          function getCenter( left, rigth, top, bottom ) { let lat = ( left + rigth ) / 2 let lon = ( top + bottom ) / 2 return { lat: lat, lon: lon } } //        function getAllCoordinates( stringX, stringY, stringZ ) { //      const x = Number( stringX ) const y = Number( stringY ) const z = Number( stringZ ) //     //    -  -  const topLeft = getCoordinates( x, y, z ) const bottomRight = getCoordinates( x+1, y+1, z ) //   const center = getCenter( topLeft.lat, bottomRight.lat, topLeft.lon, bottomRight.lon ) //   const bBox = { latMin: bottomRight.lat, lonMin: topLeft.lon, latMax: topLeft.lat, lonMax: bottomRight.lon } return { bBox: bBox, center: center } } module.exports.getAllCoordinates = getAllCoordinates</span></span></code> </pre> <br><p> ç°åœ¨ï¼Œæˆ‘ä»¬å‡†å¤‡å¼€å§‹å®ç°ç”¨äºæµè§ˆå™¨çš„è„šæœ¬ã€‚ è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹å¦‚ä½•åšåˆ°è¿™ä¸€ç‚¹çš„å‡ ç§æ–¹æ¡ˆã€‚ </p><br><h3 id="scenariy-1--poisk-s-pomoschyu-api"> æ–¹æ¡ˆ1-APIæœç´¢ </h3><br><p> è®©æˆ‘ä»¬ä»æœ€ç®€å•çš„æƒ…å†µå¼€å§‹ï¼Œæ‚¨åªéœ€åœ¨åœ°å›¾é¡µé¢çš„URLä¸­è¾“å…¥åæ ‡å³å¯ã€‚ ä¾‹å¦‚ï¼Œåƒè¿™æ ·ï¼š </p><br><p> <code>https://nakarte.me/#m=5/50.28144/89.30666&amp;l=O/Wp</code> </p> <br><p> è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è„šæœ¬ã€‚ åªéœ€æ›¿æ¢ï¼Œåˆ é™¤<strong>mapshoter.js</strong>æ–‡ä»¶çš„å…¨éƒ¨å†…å®¹ï¼Œç„¶åç²˜è´´ä¸‹é¢çš„ä»£ç å³å¯ã€‚ </p><br><p> åœ¨æ­¤ç‰ˆæœ¬ä¸­ï¼Œå¯åŠ¨æµè§ˆå™¨æ—¶ï¼Œæˆ‘ä»¬æŒ‡å®šäº†å…¶ä»–å‚æ•°ï¼Œä½¿å®ƒå¯ä»¥å¯åŠ¨å¹¶åœ¨LinuxæœåŠ¡å™¨ï¼ˆä¾‹å¦‚Herokuï¼‰ä¸Šè¿è¡Œã€‚ åŒæ ·ï¼Œç°åœ¨æˆ‘ä»¬å°†å‡å°çª—å£çš„å¤§å°ï¼Œä»¥ä½¿å±å¹•ä¸Šå°½å¯èƒ½å°‘çš„åœ°å›¾å›¾å—é€‚åˆæ‚¨ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬æé«˜äº†é¡µé¢åŠ è½½é€Ÿåº¦ã€‚ </p><br><p> æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è®¡ç®—æ‰€éœ€å›¾å—ä¸­å¿ƒçš„åæ ‡ã€‚ æˆ‘ä»¬å°†å®ƒä»¬ç²˜è´´åˆ°URLä¸­å¹¶å•å‡»ã€‚ è¯¥å›¾å—æ°å¥½å‡ºç°åœ¨å±å¹•ä¸­å¤®ã€‚ åˆ‡ä¸€å—256x256åƒç´ ã€‚ è¿™å°†æ˜¯æˆ‘ä»¬éœ€è¦çš„ç“·ç –ã€‚ å®ƒä»…ä¿ç•™å°†å…¶è¿”å›ç»™ç”¨æˆ·ã€‚ </p><br><p> åœ¨ç»§ç»­è¿›è¡Œä»£ç ä¹‹å‰ï¼Œæˆ‘æ³¨æ„åˆ°ä¸ºæ¸…æ¥šèµ·è§ï¼Œå·²ä»è„šæœ¬ä¸­åˆ é™¤äº†æ‰€æœ‰é”™è¯¯å¤„ç†ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> geoTools = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'./geoTools'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> x, y, z </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    ,    Heroku const herokuDeploymentParams = {'args' : ['--no-sandbox', '--disable-setuid-sandbox']} const browser = await puppeteer.launch( herokuDeploymentParams ) //        //       const page = await browser.newPage() await page.setViewport( { width: 660, height: 400 } ) //         URL const coordinates = geoTools.getAllCoordinates( x, y, z ) const centerCoordinates = `${z}/${coordinates.center.lat}/${coordinates.center.lon}&amp;l=` const pageUrl = 'https://nakarte.me/#m=' + centerCoordinates + "O/Wp" //   URL  ,    await page.goto( pageUrl, { waitUntil: 'networkidle0', timeout: 20000 } ) //    const cropOptions = { fullPage: false, clip: { x: 202, y: 67, width: 256, height: 256 } } const screenshot = await page.screenshot( cropOptions ) //      await browser.close() return screenshot } module.exports.makeTile = makeTile</span></span></code> </pre><br><p> ç°åœ¨è¿è¡Œæˆ‘ä»¬çš„è„šæœ¬ï¼Œå¹¶æŸ¥çœ‹æ­¤éƒ¨åˆ†çš„åœ°å›¾ã€‚ </p><br><p> <code>http://localhost:5000/24/10/5</code> </p> <br><p> å¦‚æœä¸€åˆ‡éƒ½æ­£ç¡®å®Œæˆï¼Œåˆ™æœåŠ¡å™¨åº”è¿”å›æ­¤ç±»ç£è´´ï¼š </p><br><p><img src="https://habrastorage.org/webt/gg/t5/gr/ggt5grzq5iuw26bjt2zdhckeoic.png"></p><br><p> ä¸ºç¡®ä¿è£å‰ªæ—¶ä¸ä¼šæ··æ·†ä»»ä½•ä¸œè¥¿ï¼Œè¯·å°†æˆ‘ä»¬çš„å›¾å—ä¸OpenStreetMaps.orgä¸­çš„å›¾å—è¿›è¡Œæ¯”è¾ƒ </p><br><p><img src="https://habrastorage.org/webt/32/kp/fs/32kpfsblzjzrx3c16ap3gjpfgx4.png"></p><br><h3 id="scenariy-2--poisk-s-pomoschyu-interfeysa-sayta"> æ–¹æ¡ˆ2-ä½¿ç”¨ç½‘ç«™ç•Œé¢è¿›è¡Œæœç´¢ </h3><br><p> ä½†æ˜¯ï¼Œå¹¶éæ€»æ˜¯å¯ä»¥é€šè¿‡æµè§ˆå™¨è¡Œæ¥æ§åˆ¶å¡ã€‚ å¥½å§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬çš„è„šæœ¬å°†è¡¨ç°å¾—åƒä¸€ä¸ªçœŸå®çš„ç”¨æˆ·ã€‚ ä»–å°†åœ¨æœç´¢æ¡†ä¸­æ‰“å°åæ ‡ï¼Œç„¶åå•å‡»â€œæœç´¢â€æŒ‰é’®ã€‚ ä¹‹åï¼Œä»–å°†åˆ é™¤æ‰¾åˆ°çš„ç‚¹çš„æ ‡è®°ï¼Œè¯¥æ ‡è®°é€šå¸¸å‡ºç°åœ¨å±å¹•ä¸­å¤®ã€‚ ç„¶åï¼Œä»–å°†å•å‡»æŒ‰é’®æ¥å¢å¤§æˆ–å‡å°æ¯”ä¾‹ï¼Œç›´åˆ°è¾¾åˆ°æ‰€éœ€çš„æ¯”ä¾‹ä¸ºæ­¢ã€‚ ç„¶åå°†æˆªå–å±å¹•æˆªå›¾å¹¶å°†å…¶è¿”å›ç»™ç”¨æˆ·ã€‚ </p><br><p> æˆ‘æ³¨æ„åˆ°é€šå¸¸åœ¨æœç´¢åä¼šè®¾ç½®ç›¸åŒçš„æ¯”ä¾‹ã€‚ ä¾‹å¦‚15å·ã€‚ åœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­ï¼Œè¿™å¹¶ä¸æ€»æ˜¯å‘ç”Ÿã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†ä»é¡µé¢ä¸Šhtmlå…ƒç´ çš„å‚æ•°ä¸­è¯†åˆ«ç¼©æ”¾çº§åˆ«ã€‚ </p><br><p> åŒæ ·åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨XPathé€‰æ‹©å™¨æŸ¥æ‰¾æ¥å£å…ƒç´ ã€‚ ä½†æ˜¯æ‚¨å¦‚ä½•è¯†åˆ«å®ƒä»¬ï¼Ÿ </p><br><p> ä¸ºæ­¤ï¼Œè¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ‰€éœ€çš„é¡µé¢ï¼Œç„¶åæ‰“å¼€å¼€å‘äººå‘˜å·¥å…·æ ï¼ˆå¯¹äºChromeæµè§ˆå™¨ï¼Œè¯·å•å‡»<strong>Ctll + Alt + I</strong> ï¼‰ã€‚ æŒ‰ä¸‹æŒ‰é’®é€‰æ‹©é¡¹ç›®ã€‚ æˆ‘ä»¬å•å‡»æ‚¨æ„Ÿå…´è¶£çš„å…ƒç´ ï¼ˆæˆ‘å•å‡»äº†æœç´¢å­—æ®µï¼‰ã€‚ </p><br><p><img src="https://habrastorage.org/webt/rb/wu/37/rbwu37fuodlucpg4q_xqfsfk-my.png"></p><br><p> é¡¹ç›®åˆ—è¡¨æ»šåŠ¨åˆ°æ‚¨å•å‡»çš„é¡¹ç›®ï¼Œå¹¶ä»¥è“è‰²çªå‡ºæ˜¾ç¤ºã€‚ å•å‡»åç§°å·¦ä¾§çš„ä¸‰ä¸ªç‚¹çš„æŒ‰é’®ã€‚ </p><br><p> ä»å¼¹å‡ºèœå•ä¸­ï¼Œé€‰æ‹©â€œå¤åˆ¶â€ã€‚ æ¥ä¸‹æ¥ï¼Œå¦‚æœæ‚¨éœ€è¦å¸¸è§„é€‰æ‹©å™¨ï¼Œè¯·ç‚¹å‡»<strong>å¤åˆ¶é€‰æ‹©å™¨</strong> ã€‚ ä½†æ˜¯å¯¹äºåŒä¸€ç¤ºä¾‹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨â€œ <strong>å¤åˆ¶XPathâ€</strong>é¡¹ã€‚ </p><br><p><img src="https://habrastorage.org/webt/p9/wo/t-/p9wot-lbr6ho7ttgvmsb9yrfica.png"></p><br><p> ç°åœ¨ï¼Œç”¨æ­¤ä»£ç æ›¿æ¢<strong>mapshoter.js</strong>æ–‡ä»¶çš„å†…å®¹ã€‚ åœ¨å…¶ä¸­ï¼Œæˆ‘å·²ç»æ”¶é›†äº†æ‰€æœ‰å¿…è¦æ¥å£å…ƒç´ çš„é€‰æ‹©å™¨ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> geoTools = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'./geoTools'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> x, y, z </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      const searchFieldXPath = '//*[@id="map"]/div[1]/div[1]/div/input' const zoomPlusXPath = '//*[@id="map"]/div[2]/div[2]/div[4]/div[1]/a[1]' const zoomMinusXPath = '//*[@id="map"]/div[2]/div[2]/div[4]/div[1]/a[2]' const directionButonXPath = '//*[@id="gtm-poi-card-get-directions"]' const deletePinButonXPatch = '//*[@id="map"]/div[1]/div/div/div[1]/div[2]/div/div[4]/div/div[4]' //         () const coordinates = geoTools.getAllCoordinates( x, y, z ) const centerCoordinates = `lat=${coordinates.center.lat} lng=${coordinates.center.lon}` //      const herokuDeploymentParams = {'args' : ['--no-sandbox', '--disable-setuid-sandbox']} const browser = await puppeteer.launch( herokuDeploymentParams ) const page = await browser.newPage() await page.setViewport( { width: 1100, height: 450 } ) //         const pageUrl = 'https://www.waze.com/en/livemap?utm_campaign=waze_website' await page.goto( pageUrl, { waitUntil: 'networkidle2', timeout: 10000 } ) //    ,      await click( searchFieldXPath, page ) //        await page.keyboard.type( centerCoordinates ) //  Enter    page.keyboard.press( 'Enter' ); //  500     await page.waitFor( 500 ) //       //       await click( directionButonXPath, page ) await page.waitFor( 100 ) await click( deletePinButonXPatch, page ) await page.waitFor( 100 ) //       //        while( z &gt; await fetchCurrentZoom( page )) { await click( zoomPlusXPath, page ) await page.waitFor( 300 ) } while( z &lt; await fetchCurrentZoom( page )) { await click( zoomMinusXPath, page ) await page.waitFor( 300 ) } //    const cropOptions = { fullPage: false, clip: { x: 422, y: 97, width: 256, height: 256 } } const screenshot = await page.screenshot( cropOptions ) //   await browser.close() return screenshot } //  : //        async function click( xPathSelector, page ) { await page.waitForXPath( xPathSelector ) const foundedElements = await page.$x( xPathSelector ) if ( foundedElements.length &gt; 0 ) { await foundedElements[0].click() } else { throw new Error( "XPath element not found: ", xPathSelector ) } } //         html  async function fetchCurrentZoom( page ) { const xPathSelector = '//*[@id="map"]/div[2]' await page.waitForXPath( xPathSelector ) const elems = await page.$x(xPathSelector) const elementParams = await page.evaluate((...elems) =&gt; { return elems.map(e =&gt; e.className); }, ...elems); const zoom = elementParams[0].split('--zoom-').pop() return zoom } module.exports.makeTile = makeTile</span></span></code> </pre> <br><p> è¿è¡Œæˆ‘ä»¬çš„è„šæœ¬å¹¶ç‚¹å‡»é“¾æ¥ã€‚ å¦‚æœä¸€åˆ‡éƒ½æ­£ç¡®å®Œæˆï¼Œé‚£ä¹ˆè„šæœ¬å°†è¿”å›ç»™æˆ‘ä»¬ç±»ä¼¼æ­¤å›¾å—çš„ä¿¡æ¯ã€‚ </p><br><p> <code>http://localhost:5000/1237/640/11</code> </p> <br><p><img src="https://habrastorage.org/webt/3c/oo/0l/3coo0lmxp12svhu_m16vecfbjsw.png"></p><br><h3 id="optimizaciya"> æœ€ä½³åŒ– </h3><br><p> åŸåˆ™ä¸Šï¼Œä¸Šè¿°ä¸¤ç§æ–¹æ³•è¶³ä»¥è¿æ¥åˆ°å…·æœ‰çŸ¢é‡å›¾çš„è®¸å¤šç«™ç‚¹ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨çªç„¶éœ€è¦è®¿é—®æŸäº›æ–°åœ°å›¾ï¼Œåˆ™åªéœ€ç¨å¾®ä¿®æ”¹mapshoter.jsæ–‡ä»¶ä¸­çš„è„šæœ¬å³å¯ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ­¤æ–¹æ³•ä½¿æ·»åŠ æ–°å¡éå¸¸å®¹æ˜“ã€‚ è¿™æ˜¯å› ä¸ºå®ƒçš„ä¼˜åŠ¿ã€‚ </p><br><p> ä½†æ˜¯ä¹Ÿæœ‰ç¼ºç‚¹ã€‚ æœ€ä¸»è¦çš„æ˜¯å·¥ä½œé€Ÿåº¦ã€‚ åªæ˜¯æ¯”è¾ƒä¸€ä¸‹ã€‚ å¹³å‡è€Œè¨€ï¼Œä¸‹è½½ä¸€ä¸ªå¸¸è§„çš„å…‰æ …å›¾å—å¤§çº¦éœ€è¦0.5ç§’ã€‚ ç›®å‰ä»æˆ‘ä»¬çš„è„šæœ¬æ¥æ”¶ä¸€ä¸ªå›¾å—å¤§çº¦éœ€è¦8ç§’é’Ÿã€‚ </p><br><p> ä½†è¿™è¿˜ä¸æ˜¯å…¨éƒ¨ï¼ æˆ‘ä»¬ä½¿ç”¨å•çº¿ç¨‹èŠ‚ç‚¹jsï¼Œæˆ‘ä»¬çš„é•¿è¯·æ±‚æœ€ç»ˆå°†é˜»å¡ä¸»çº¿ç¨‹ï¼Œä»å¤–éƒ¨çœ‹ï¼Œå®ƒçœ‹èµ·æ¥åƒæ˜¯å¸¸è§„åŒæ­¥é˜Ÿåˆ—ã€‚ è€Œä¸”ï¼Œå½“æˆ‘ä»¬å°è¯•ä¸‹è½½æ•´ä¸ªå±å¹•çš„åœ°å›¾æ—¶ï¼ˆä¾‹å¦‚ï¼Œåœ¨è¯¥åœ°å›¾ä¸Šæ”¾ç½®äº†24ä¸ªå›¾å—ï¼‰ï¼Œå³å­˜åœ¨é‡åˆ°é—®é¢˜çš„é£é™©ã€‚ </p><br><p> è¿˜æœ‰ä¸€ä»¶äº‹ã€‚ ä¸€äº›å¯¼èˆªå™¨è¶…æ—¶ï¼šå®ƒä»¬å°†åœ¨30ç§’ååœæ­¢åŠ è½½ã€‚ è¿™æ„å‘³ç€åœ¨å½“å‰å®æ–½ä¸­ï¼Œåªæœ‰3-4ä¸ªå›¾å—å°†æœ‰æ—¶é—´åŠ è½½ã€‚ å¥½å§ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹æˆ‘ä»¬èƒ½åšäº›ä»€ä¹ˆã€‚ </p><br><p> å¯èƒ½æœ€æ˜æ˜¾çš„æ–¹æ³•æ˜¯ç®€å•åœ°å¢åŠ è¿è¡Œè„šæœ¬çš„æœåŠ¡å™¨æ•°é‡ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰10å°æœåŠ¡å™¨ï¼Œé‚£ä¹ˆä»–ä»¬å°†æœ‰æ—¶é—´åœ¨30ç§’å†…å¤„ç†æ•´ä¸ªå±å¹•çš„å›¾å—ã€‚  ï¼ˆå¦‚æœæ‚¨ä¸æƒ³æ”¯ä»˜å¾ˆå¤šé’±ï¼Œå¯ä»¥é€šè¿‡åœ¨Herokuä¸Šæ³¨å†Œå¤šä¸ªå…è´¹å¸æˆ·æ¥è·å¾—ï¼‰ </p><br><p> å…¶æ¬¡ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">worker_threads</a>æ¨¡å—åœ¨èŠ‚ç‚¹jsä¸Šå®ç°å¤šçº¿ç¨‹ã€‚ æ ¹æ®æˆ‘çš„è§‚å¯Ÿï¼Œåœ¨å…·æœ‰å…è´¹Herokuå¸æˆ·çš„å•æ ¸å¤„ç†å™¨çš„æœåŠ¡å™¨ä¸Šï¼Œæˆ‘è®¾æ³•å¯åŠ¨äº†ä¸‰ä¸ªçº¿ç¨‹ã€‚ ä¸‰ä¸ªæµï¼Œæ¯ä¸ªæµä¸­éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„æµè§ˆå™¨ï¼Œå®ƒä»¬å¯ä»¥åŒæ—¶å·¥ä½œè€Œä¸ä¼šäº’ç›¸é˜»å¡ã€‚ å…¬å¹³åœ°è¯´ï¼Œæˆ‘æ³¨æ„åˆ°ç”±äºå¤„ç†å™¨è´Ÿè½½çš„å¢åŠ ï¼Œä¸€ä¸ªå›¾å—çš„ä¸‹è½½é€Ÿåº¦ç”šè‡³ç•¥æœ‰æé«˜ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‚¨å°è¯•ä¸‹è½½æ•´ä¸ªå±å¹•çš„åœ°å›¾ï¼Œåˆ™30ç§’åï¼Œä¸€åŠä»¥ä¸Šçš„åœ°å›¾å°†æœ‰æ—¶é—´åŠ è½½ã€‚ è¶…è¿‡12ä¸ªç£è´´ã€‚ å·²ç»æ›´å¥½äº†ã€‚ </p><br><p> ç¬¬ä¸‰ã€‚ åœ¨è„šæœ¬çš„å½“å‰å®ç°ä¸­ï¼Œå¯¹äºæ¯ä¸ªè¯·æ±‚ï¼Œæˆ‘ä»¬éƒ½èŠ±æ—¶é—´ä¸‹è½½Chromeæµè§ˆå™¨ï¼Œç„¶åå®Œæˆå®ƒã€‚ ç°åœ¨ï¼Œæˆ‘ä»¬å°†é¢„å…ˆåˆ›å»ºä¸€ä¸ªæµè§ˆå™¨ï¼Œå¹¶å°†åœ¨mapshoter.jsä¸­è½¬ç§»åˆ°å®ƒçš„é“¾æ¥ã€‚ ç»“æœï¼Œå¯¹äºç¬¬ä¸€ä¸ªè¯·æ±‚ï¼Œé€Ÿåº¦å°†ä¸ä¼šæ”¹å˜ã€‚ ä½†æ˜¯å¯¹äºæ‰€æœ‰åç»­çš„ä¸‹è½½ï¼Œä¸€ä¸ªå›¾å—çš„ä¸‹è½½é€Ÿåº¦é™ä½åˆ°4ç§’ã€‚  30ç§’åï¼Œæ•´ä¸ªåœ°å›¾éƒ½æœ‰æ—¶é—´åŠ è½½-æ‰€æœ‰24ä¸ªå›¾å—éƒ½æ”¾ç½®åœ¨æˆ‘çš„å±å¹•ä¸Šã€‚ </p><br><p> å¥½å§ï¼Œå¦‚æœæ‚¨å®ç°äº†æ‰€æœ‰è¿™äº›åŠŸèƒ½ï¼Œé‚£ä¹ˆè„šæœ¬å°†å˜å¾—éå¸¸å¯è¡Œã€‚ å› æ­¤ï¼Œè®©æˆ‘ä»¬å¼€å§‹å§ã€‚ å¯¹äºä½¿ç”¨å¤šçº¿ç¨‹çš„æ›´ç®€å•çš„å·¥ä½œï¼Œæˆ‘å°†ä½¿ç”¨<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">node-worker-threads-pool</a>æ¨¡å—-ä¸€ç§worker_threadsçš„åŒ…è£…å™¨ã€‚ è®©æˆ‘ä»¬å®‰è£…å®ƒã€‚ </p><br><p> <code>$ npm install node-worker-threads-pool --save</code> </p> <br><p> æ›´æ­£router.jsæ–‡ä»¶ã€‚ å‘å…¶æ·»åŠ çº¿ç¨‹æ± çš„åˆ›å»ºã€‚ çº¿ç¨‹å°†æ˜¯3ä»¶ã€‚ ä»–ä»¬çš„ä»£ç å°†åœ¨<strong>worker.js</strong>æ–‡ä»¶ä¸­æè¿°ï¼Œæˆ‘ä»¬å°†åœ¨ä»¥åè¿›è¡Œä»‹ç»ã€‚ åŒæ—¶ï¼Œç›´æ¥åˆ é™¤å±å¹•æˆªå›¾æ¨¡å—çš„å¯åŠ¨ã€‚ ç›¸åï¼Œæˆ‘ä»¬å°†å‘çº¿ç¨‹æ± æ·»åŠ ä¸€ä¸ªæ–°ä»»åŠ¡ã€‚ å½“ä»»ä½•çº¿ç¨‹é‡Šæ”¾æ—¶ï¼Œä»–ä»¬å°†å¼€å§‹å¤„ç†å®ƒã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'express'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> PORT = process.env.PORT || <span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> app = express() app.listen( PORT, () =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log( <span class="hljs-string"><span class="hljs-string">'    '</span></span>, PORT ) }) <span class="hljs-comment"><span class="hljs-comment">//   . const { StaticPool } = require( 'node-worker-threads-pool' ) const worker = "./worker.js" const workersPool = new StaticPool({ size: 3, task: worker, workerData: "no" }) app.get( '/:x/:y/:z', async ( req, res, next ) =&gt; { const x = req.params.x const y = req.params.y const z = req.params.z //       //       const screenshot = await workersPool.exec( { x, y, z } ) const imageBuffer = Buffer.from( screenshot, 'base64' ) res.writeHead( 200, { 'Content-Type': 'image/png', 'Content-Length': imageBuffer.length }) res.end( imageBuffer ) })</span></span></code> </pre> <br><p> ç°åœ¨çœ‹ä¸€ä¸‹<strong>worker.js</strong>æ–‡ä»¶ã€‚ æ¯å½“æ–°ä»»åŠ¡<strong>åˆ°è¾¾æ—¶ï¼Œ</strong>å°±ä¼šå¯åŠ¨<strong>parentPort.onï¼ˆï¼‰</strong>æ–¹æ³•ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œå®ƒæ— æ³•å¤„ç†å¼‚æ­¥/ç­‰å¾…åŠŸèƒ½ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å°†ä»¥<strong>doMyAsyncCodeï¼ˆï¼‰</strong>æ–¹æ³•çš„å½¢å¼ä½¿ç”¨é€‚é…å™¨åŠŸèƒ½ã€‚ </p><br><p> ä»¥ä¸€ç§æ–¹ä¾¿æ˜“è¯»çš„æ ¼å¼å°†å·¥ä½œäººå‘˜çš„é€»è¾‘æ”¾å…¥å…¶ä¸­ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯åŠ¨æµè§ˆå™¨ï¼ˆå¦‚æœå°šæœªè¿è¡Œï¼‰å¹¶æ¿€æ´»ç”¨äºæˆªå±çš„æ–¹æ³•ã€‚ åœ¨å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬å°†ä¼ é€’ä¸€ä¸ªæŒ‡å‘æ­£åœ¨è¿è¡Œçš„æµè§ˆå™¨çš„é“¾æ¥åˆ°æ­¤æ–¹æ³•ä¸­ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> { parentPort, workerData } = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'worker_threads'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> mapshoter = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'./mapshoter'</span></span> ) <span class="hljs-comment"><span class="hljs-comment">//     var browser = "empty" //         //    ,     parentPort.on( "message", ( params ) =&gt; { doMyAsyncCode( params ) .then( ( result) =&gt; { parentPort.postMessage( result ) }) }) //  ,    async/aswit //     async function doMyAsyncCode( params ) { //      await prepareEnviroment() //     const screenshot = await mapshoter.makeTile( params.x, params.y, params.z, browser ) return screenshot } //  .     ,    async function prepareEnviroment( ) { if ( browser === "empty" ) { const herokuDeploymentParams = {'args' : ['--no-sandbox', '--disable-setuid-sandbox']} browser = await puppeteer.launch( herokuDeploymentParams ) } }</span></span></code> </pre> <br><p> ä¸ºäº†æ¸…æ¥šèµ·è§ï¼Œè®©æˆ‘ä»¬è¿”å›<strong>mapshoter.js</strong>çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ã€‚ å®ƒä¸ä¼šæœ‰å¤ªå¤§å˜åŒ–ã€‚ ç°åœ¨ï¼Œåœ¨è¾“å…¥å‚æ•°ä¸­ï¼Œå®ƒå°†æ¥å—åˆ°æµè§ˆå™¨çš„é“¾æ¥ï¼Œå¹¶ä¸”åœ¨è„šæœ¬ç»“æŸæ—¶ï¼Œå®ƒä¸ä¼šå…³é—­æµè§ˆå™¨ï¼Œè€Œåªæ˜¯å…³é—­åˆ›å»ºçš„é€‰é¡¹å¡ã€‚ </p><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> puppeteer = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'puppeteer'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> geoTools = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>( <span class="hljs-string"><span class="hljs-string">'./geoTools'</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">makeTile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> x, y, z, browserLink </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      const browser = await browserLink //      const page = await browser.newPage() await page.setViewport( { width: 660, height: 400 } ) const coordinates = geoTools.getAllCoordinates( x, y, z ) const centerCoordinates = `${z}/${coordinates.center.lat}/${coordinates.center.lon}&amp;l=` const pageUrl = 'https://nakarte.me/#m=' + centerCoordinates + "O/Wp" await page.goto( pageUrl, { waitUntil: 'networkidle0', timeout: 20000 } ) const cropOptions = { fullPage: false, clip: { x: 202, y: 67, width: 256, height: 256 } } const screenshot = await page.screenshot( cropOptions ) //   .   . await page.close() return screenshot } module.exports.makeTile = makeTile</span></span></code> </pre><br><p> åŸåˆ™ä¸Šï¼Œä»…æ­¤è€Œå·²ã€‚ ç°åœ¨ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨ä»»ä½•æ–¹ä¾¿çš„æ–¹å¼å°†ç»“æœä¸Šä¼ åˆ°æœåŠ¡å™¨ã€‚ ä¾‹å¦‚ï¼Œé€šè¿‡dockerã€‚ å¦‚æœè¦æŸ¥çœ‹å®Œæˆçš„ç»“æœï¼Œå¯ä»¥å•å‡»<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">æ­¤é“¾æ¥</a> ã€‚ æ‚¨è¿˜å¯ä»¥åœ¨æˆ‘çš„<a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=" rel="nofollow">GitHubä¸Š</a>æ‰¾åˆ°å®Œæ•´çš„é¡¹ç›®ä»£ç ã€‚ </p><br><h3 id="zaklyuchenie"> ç»“è®º </h3><br><p> ç°åœ¨è®©æˆ‘ä»¬è¯„ä¼°ç»“æœã€‚ ä¸€æ–¹é¢ï¼Œå°½ç®¡å·²å®Œæˆæ‰€æœ‰æŠ€å·§ï¼Œä½†ä¸‹è½½é€Ÿåº¦ä»ç„¶éå¸¸ä½ã€‚ è€Œä¸”ï¼Œç”±äºåˆ¶åŠ¨ï¼Œè¿™ç§å¡æ ¹æœ¬ä¸å®¹æ˜“æ»šåŠ¨ã€‚ </p><br><p> å¦ä¸€æ–¹é¢ï¼Œæ­¤è„šæœ¬ä»ç„¶å¯ä»¥å¤„ç†ä»¥å‰æ— æ³•è¿æ¥åˆ°æ™ºèƒ½æ‰‹æœºä¸Šçš„å¯¼èˆªå™¨çš„å¡ç‰‡ã€‚ è¿™ç§è§£å†³æ–¹æ¡ˆä¸å¯èƒ½ç”¨ä½œè·å–åˆ¶å›¾æ•°æ®çš„ä¸»è¦æ–¹æ³•ã€‚ ä½†æ˜¯è¿™é‡Œæ˜¯å¦å¤–ä¸€ä¸ªï¼Œå¦‚æœæœ‰å¿…è¦çš„è¯ï¼Œæœ‰å¯èƒ½åœ¨å…¶ä¸­å¸®åŠ©ä¸‹æ‰“å¼€ä¸€äº›å¥‡ç‰¹çš„å¡ç‰‡-è¿™æ˜¯å®Œå…¨å¯èƒ½çš„ã€‚ </p><br><p> å¦å¤–ï¼Œæ­¤è„šæœ¬çš„ä¼˜ç‚¹åŒ…æ‹¬æ˜“äºä½¿ç”¨çš„äº‹å®ã€‚ è¿™å¾ˆå®¹æ˜“å†™ã€‚ è€Œä¸”ï¼Œæœ€é‡è¦çš„æ˜¯ï¼Œå¯ä»¥éå¸¸è½»æ¾åœ°é‡åšè¿æ¥ä»»ä½•å…¶ä»–åœ¨çº¿å¡çš„æ“ä½œã€‚ </p><br><p> å¥½å§ï¼Œ <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œ</a>æˆ‘å°†è®¨è®ºè¿™ä¸€ç‚¹ã€‚ æˆ‘å°†è„šæœ¬è½¬æ¢ä¸ºä¸€ç§ä¸OverpassTurboäº¤äº’å¼åœ°å›¾é…åˆä½¿ç”¨çš„APIã€‚ </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN461053/">https://habr.com/ru/post/zh-CN461053/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN461041/index.html">åœ†è§’æˆ–é”è§’ï¼Ÿ</a></li>
<li><a href="../zh-CN461043/index.html">å›¢é˜Ÿä¸­çš„å†²çªç®¡ç†-å¹³è¡¡è¡Œä¸ºè¿˜æ˜¯è‡³å…³é‡è¦çš„éœ€æ±‚ï¼Ÿ</a></li>
<li><a href="../zh-CN461045/index.html">é€šè¿‡FSIS USRNå’Œpythonè·å–Rosreestrçš„æ‘˜å½•ã€‚ ç¬¬ä¸€éƒ¨åˆ†</a></li>
<li><a href="../zh-CN461047/index.html">å†™è¿˜æ˜¯ä¸å†™ã€‚ æ´»åŠ¨æœŸé—´è‡´å½“å±€çš„ä¿¡</a></li>
<li><a href="../zh-CN461051/index.html">æˆ‘åœ¨Goé¡¹ç›®ä¸­é‡åˆ°çš„10ä¸ªæœ€å¸¸è§çš„é”™è¯¯</a></li>
<li><a href="../zh-CN461055/index.html">Rekko Challenge 2019ï¼šæ€ä¹ˆæ ·</a></li>
<li><a href="../zh-CN461057/index.html">æœ‰å…³æ¸¸æˆå¼€å‘çš„ç”µæŠ¥é¢‘é“</a></li>
<li><a href="../zh-CN461059/index.html">ä¸ºç”µå½±è¿·ç¼–å†™ä¸€ä¸ªAndroidåº”ç”¨-ç¬¬1éƒ¨åˆ†ï¼ˆåŸå‹è®¾è®¡ï¼‰</a></li>
<li><a href="../zh-CN461061/index.html">é•åˆé‡‘ï¼ŒåŒæ™¶ç•Œå’Œåæ</a></li>
<li><a href="../zh-CN461063/index.html">Rä¸Microsoft SQL Serverå’Œå…¶ä»–DBMSä¸Šçš„æ•°æ®åº“çš„äº¤äº’</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>