<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§∞üèº ü§¨ üëêüèø En la zona de acceso. Encuentre la distancia desde un punto a un √°rea y reduzca las solicitudes de geocodificaci√≥n inversa ü§Ωüèø ü•ß üßòüèª</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="M√°s de una vez tuve que implementar la funcionalidad de calcular la distancia desde cierto punto geogr√°fico a un √°rea en el mapa, por ejemplo, a la ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>En la zona de acceso. Encuentre la distancia desde un punto a un √°rea y reduzca las solicitudes de geocodificaci√≥n inversa</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/redmadrobot/blog/486066/"><img src="https://habrastorage.org/webt/4-/ec/za/4-ecza20zev4bzwzgyt7zmwygly.png"><br><br>  M√°s de una vez tuve que implementar la funcionalidad de calcular la distancia desde cierto punto geogr√°fico a un √°rea en el mapa, por ejemplo, a la carretera de circunvalaci√≥n de Mosc√∫.  Como resultado, encontr√© dos formas de resolver el problema que mostr√≥ buenos resultados, y ahora los usamos regularmente en la producci√≥n.  Los describir√© en la primera parte del art√≠culo.  Y en el segundo, mostrar√© c√≥mo puede almacenar en cach√© los geodatos para usar menos el geocodificador. <br><a name="habracut"></a><br><h2>  Primera parte  Dos formas de encontrar la distancia de un punto a un √°rea en un mapa </h2><br>  Si su aplicaci√≥n m√≥vil es verdaderamente m√≥vil, funciona con las coordenadas del dispositivo.  La ubicaci√≥n del usuario (y dispositivo) afecta a varios indicadores comerciales de la aplicaci√≥n, como el costo de entrega, el factor de complejidad, etc. <br>  A continuaci√≥n, mostrar√© ejemplos de implementaci√≥n de algoritmos en Python usando las bibliotecas scipy y shapely. <br>  Para la geocodificaci√≥n usamos Google Maps.  Se adapta tanto a la funcionalidad como al costo de uso.  Al momento de escribir este art√≠culo, Google le permite realizar las primeras 20,000 solicitudes de geocodificaci√≥n por mes de forma gratuita. <br><br><h3>  M√©todo 1. Calculamos la ruta en funci√≥n de los v√©rtices del pol√≠gono. </h3><br>  Supongamos que necesitamos encontrar la distancia desde un punto en alg√∫n lugar de la regi√≥n de Mosc√∫ hasta la carretera de circunvalaci√≥n de Mosc√∫.  Se necesita un camino real, no geom√©trico.  Por lo tanto, primero construimos un vertedero desde los puntos de salida de la carretera de circunvalaci√≥n de Mosc√∫, y no coinciden con los v√©rtices del contorno de la carretera en el mapa. <br><br><pre><code class="python hljs">exit_coordinates: List[Tuple[float, float]] latitude: float longitude: float</code> </pre> <br>  Para trabajar con geometr√≠a, utilizamos la biblioteca <a href="https://shapely.readthedocs.io/en/stable/manual.html">bien formada.</a>  Con su ayuda, es f√°cil determinar si el punto de inter√©s para nosotros est√° dentro del pol√≠gono o no.  Si es as√≠, la distancia es obviamente 0. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> shapely.geometry <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Polygon, Point polygon = Polygon(exit_coordinates) polygon.contains(Point(latitude,longitude))</code> </pre> <br>  Estamos interesados ‚Äã‚Äãen el caso cuando el punto est√° fuera del pol√≠gono.  La tarea de encontrar los objetos m√°s cercanos (salidas del MKAD) al punto de partida es bastante t√≠pica en matem√°ticas.  Por lo general, se resuelve usando un √°rbol KD.  Entonces hag√°moslo.  En python, el √°rbol se implementa en la biblioteca <a href="https://pypi.org/project/scipy/">scipy.</a>  Encontraremos los picos m√°s cercanos desde las salidas de la carretera de circunvalaci√≥n de Mosc√∫ hasta nuestro punto. <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> scipy.spatial <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> KDTree kd_tree = KDTree(exits_coordinates) dists, indexes = kd_tree.query((latitude, longitude), k=<span class="hljs-number"><span class="hljs-number">3</span></span>) nearest_coordinates = list() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, index <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> zip(dists, indexes): nearest_coordinates.append(exits_coordinates[index])</code> </pre> <br>  El n√∫mero <i>k</i> , el n√∫mero de picos, no debe ser demasiado peque√±o, porque la salida m√°s cercana de la carretera de circunvalaci√≥n de Mosc√∫ puede estar bloqueada temporalmente.  O puede estar en alg√∫n lugar m√°s all√° del r√≠o y no tener un camino directo a nuestro punto.  Demasiado grande <i>k</i> tambi√©n <i>es</i> in√∫til para nosotros, porque  Una salida adecuada se encuentra en varios picos cercanos.  Ahora pasemos al servicio de Google Maps.  Ya tiene una funcionalidad para encontrar distancias desde una matriz de puntos a un punto espec√≠fico: la API de matriz de distancia. <br>  Upd: el servicio API de distancia de la matriz factura la ruta a cada pico m√°s cercano por separado.  Por lo tanto, este m√©todo es m√°s costoso que el segundo, que se describe a continuaci√≥n.  Gracias <a href="https://habr.com/ru/users/sovetnikov/" class="user_link">sovetnikov</a> <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> googlemaps gmaps_client = googlemaps.Client(key=settings.GOOGLE_MAPS_API_KEY) gmaps_client.distance_matrix( origins=nearest_coordinates, destinations=(latitude, longitude), mode=<span class="hljs-string"><span class="hljs-string">'driving'</span></span>, )</code> </pre> <br>  Solo podemos analizar la respuesta.  Por lo general, tiene varias rutas, y la primera no siempre es la m√°s corta.  Por lo tanto, elegimos el valor apropiado. <br><br><h3>  M√©todo 2. Calculamos la ruta desde el centro del vertedero </h3><br>  Ahora, adem√°s de los v√©rtices del pol√≠gono, definimos alg√∫n punto dentro de √©l, desde el cual construiremos todas las rutas de Google Maps.  Utilizaremos la API de indicaciones, que crear√° rutas para nosotros y elegiremos la m√°s corta. <br><br><pre> <code class="python hljs">start_point: Tuple[float, float], destination: Tuple[float, float] polygon: shapely.geometry.Polygon gmaps_client = googlemaps.Client(key=settings.GOOGLE_MAPS_API_KEY) driving_path = gmaps_client.directions(start_point, destination)</code> </pre> <br>  Comenzamos iterativamente desde el final para agregar las longitudes de los segmentos de ruta hasta que la coordenada del comienzo del segmento est√© dentro del pol√≠gono (se omite el an√°lisis): <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span> step <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> reversed(driving_path): start_point = step[<span class="hljs-string"><span class="hljs-string">'start_location'</span></span>][<span class="hljs-string"><span class="hljs-string">'lat'</span></span>], step[<span class="hljs-string"><span class="hljs-string">'start_location'</span></span>][<span class="hljs-string"><span class="hljs-string">'lng'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> is_inside_polygon(start_point, self.polygon): end_point = step[<span class="hljs-string"><span class="hljs-string">'end_location'</span></span>][<span class="hljs-string"><span class="hljs-string">'lat'</span></span>], step[<span class="hljs-string"><span class="hljs-string">'end_location'</span></span>][<span class="hljs-string"><span class="hljs-string">'lng'</span></span>] distance += get_part_outside_polygon( get_line(start_point, end_point), polygon ) * step[<span class="hljs-string"><span class="hljs-string">'distance'</span></span>][<span class="hljs-string"><span class="hljs-string">'value'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">break</span></span> distance += step[<span class="hljs-string"><span class="hljs-string">'distance'</span></span>][<span class="hljs-string"><span class="hljs-string">'value'</span></span>]</code> </pre> <br>  Solo podemos agregar parte del segmento fuera del pol√≠gono.  Para hacer esto, usando la biblioteca bien formada, construimos una l√≠nea geom√©trica entre las coordenadas del principio y el final de la ruta y encontramos cu√°nto de su longitud se encuentra fuera del pol√≠gono.  El mismo porcentaje de la longitud se calcula para el segmento obtenido de la ruta. <br><blockquote>  Una ruta es una ruta de terreno en carreteras reales con curvatura natural.  Si se trata de una l√≠nea recta larga (avenida o autopista), nuestra aproximaci√≥n nos permitir√° calcular la ruta exactamente en t√©rminos porcentuales. <br>  Si el camino que cruza el vertedero es lo suficientemente curvo, tal aproximaci√≥n ser√° incorrecta.  Pero las partes curvas en la ruta de Google Maps en s√≠ son generalmente cortas, y los errores en su c√°lculo no afectar√°n el resultado. </blockquote><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> shapely.geometry <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> LineString, Polygon line = LineString(point1, point2) part_outside_len = float(line.difference(polygon).length) / float(line.length)</code> </pre> <br>  Para ser sincero, no compar√© estos dos m√©todos.  Los he estado usando por m√°s de un a√±o, ambos funcionan sin fallas.  Decid√≠ no pintar su implementaci√≥n en detalle.  En cambio, abri√≥ el acceso a su <a href="https://github.com/serg-the-engineer/geo-garry">geo biblioteca.</a>  Liba tambi√©n puede usar geocodificaci√≥n regular, incluso con almacenamiento en cach√© eficiente.  ¬°Problemas y solicitudes de extracci√≥n son bienvenidos! <br><br><h2>  Segunda parte  Guardar solicitudes de geocodificaci√≥n inversa </h2><br>  A menudo necesitamos determinar las direcciones de los puntos que est√°n cerca y corresponden a un objeto en el mundo real.  Cada vez, hacer una solicitud a un sistema de geocodificaci√≥n externo no es bueno, y aqu√≠ surge la cuesti√≥n del almacenamiento en cach√©. <br>  Normalmente, el cliente env√≠a las coordenadas con una precisi√≥n excesiva, por ejemplo, 59.80447691, 30.39570337.  Pero, ¬øcu√°ntos signos en la parte fraccionaria ser√°n significativos para nosotros? <br>  Para los flojos y apurados, la respuesta es cuatro.  Para todos los dem√°s, vea la explicaci√≥n a continuaci√≥n. <br><br><h4>  Primero, un poco de geograf√≠a. </h4><br><ul><li>  El ecuador tiene 40,075.696 km de largo y su latitud cero. </li><li>  Los meridianos son l√≠neas de longitud, perpendiculares a las l√≠neas de latitud.  La longitud de cualquier meridiano es 40,008.55 km. </li><li>  Grado de latitud - 40,008.55 km / 360 = 111.134861111 km.  Entonces, una cent√©sima da un cambio de aproximadamente un kil√≥metro, y una d√©cima parte da un cambio de 10 metros. </li><li>  La circunferencia de la l√≠nea de latitud disminuye desde el ecuador y se multiplica por el coseno del √°ngulo de latitud, por lo tanto, para 60 grados de latitud (latitud de San Petersburgo), la longitud es menor que exactamente 2 veces menos.  Entonces el grado de longitud es 40,075.696 * 0.5 / 360 = 55.66066888 km, o una diezmil√©sima es 5 metros. </li></ul><br>  Un error de 1/10000 grados da un rect√°ngulo de error de 5-10 por 10 metros.  Esto nos permitir√° "entrar" exactamente en el edificio, ya que  El edificio es mucho m√°s grande que el punto.  Y si, debido a un error, el punto no cae dentro del edificio, Google a√∫n determinar√° cu√°l es el m√°s cercano. <br>  Redondear hasta tres caracteres es arriesgado, la precisi√≥n ya se reduce significativamente.  Y hasta cinco, no tiene sentido, porque la precisi√≥n de los transmisores GPS no supera los pocos metros. <br><br>  Por lo tanto, si hay un valor en el cach√© con la clave "direcci√≥n: 59.8045,30.3957", entonces todas las coordenadas, cuando se redondea a 4 caracteres, se obtiene la misma clave, corresponde a una direcci√≥n geocodificada.  Hacemos menos solicitudes: trabajamos m√°s r√°pido y pagamos menos por usar el servicio de geocodificaci√≥n.  Beneficio! </div></div><p>Source: <a href="https://habr.com/ru/post/486066/">https://habr.com/ru/post/486066/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../486050/index.html">Biblioteca JavaScript de Webix a trav√©s de los ojos de un principiante. Parte 3. M√≥dulos, diagramas, tablas de √°rbol.</a></li>
<li><a href="../486052/index.html">Scorched Earth es la madre de todos los juegos. Entrevista con el creador.</a></li>
<li><a href="../486056/index.html">De los scripts a nuestra propia plataforma: c√≥mo automatizamos el desarrollo en el Instituto Cyan</a></li>
<li><a href="../486060/index.html">Encuentre el orden en el caos de TI: organice su propio desarrollo</a></li>
<li><a href="../486062/index.html">Representaci√≥n simple de copia cero de video acelerado por hardware en QML</a></li>
<li><a href="../486070/index.html">ACL cambia en detalle</a></li>
<li><a href="../486080/index.html">Perm√≠tanme presentarles: Veeam Availability Suite v10</a></li>
<li><a href="../486084/index.html">Reemplazar discos m√°s peque√±os con discos m√°s grandes en Linux</a></li>
<li><a href="../486094/index.html">Casa dem√≥crata lucha en Silicon Valley</a></li>
<li><a href="../486100/index.html">¬øC√≥mo crear una aplicaci√≥n descentralizada que escala? Usa menos blockchain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>