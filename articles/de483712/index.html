<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🏂🏽 👆🏼 🗜️ HighLoad ++, Yuri Nasretdinov (VK): Wie VK Daten von zehntausenden Servern in ClickHouse einfügt 👰🏼 💄 👊🏾</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="HighLoad ++ Moskau 2018, Kongresshalle. 9. November, 15:00 Uhr 

 Abstracts und Präsentation: http://www.highload.ru/moscow/2018/abstracts/4066 

 Yur...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>HighLoad ++, Yuri Nasretdinov (VK): Wie VK Daten von zehntausenden Servern in ClickHouse einfügt</h1><div class="post__body post__body_full">
      <div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/483712/">  HighLoad ++ Moskau 2018, Kongresshalle.  9. November, 15:00 Uhr <br><br>  Abstracts und Präsentation: <a href="http://www.highload.ru/moscow/2018/abstracts/4066">http://www.highload.ru/moscow/2018/abstracts/4066</a> <br><br>  Yuri Nasretdinov (VKontakte): In dem Bericht wird über die Erfahrungen bei der Implementierung von ClickHouse in unserem Unternehmen berichtet - warum wir es benötigen, wie viele Daten wir speichern, wie wir es schreiben und so weiter. <br><br><img src="https://habrastorage.org/webt/82/hn/hb/82hnhbxzvzseq8_viregjypt_ms.jpeg"><br><br>  Zusätzliche Ressourcen: <a href="https://habr.com/ru/company/ua-hosting/blog/483112/">Verwenden von Clickhouse als Ersatz für ELK, Big Query und TimescaleDB</a> <a name="habracut"></a><br><br>  <b>Yuri Nasretdinov:</b> - Hallo allerseits!  Mein Name ist Yuri Nasretdinov, wie sie mich bereits vorgestellt haben.  Ich arbeite bei VKontakte.  Ich werde darüber sprechen, wie wir Daten von unserer Serverflotte (Zehntausende) in „ClickHouse“ einfügen. <br><br><h3>  Was sind Protokolle und warum werden sie gesammelt? </h3><br>  Worüber wir sprechen werden: Was wir getan haben, warum wir "ClickHouse" brauchten bzw. warum wir es ausgewählt haben, welche Art von Leistung kann man grob erhalten, ohne etwas speziell zu konfigurieren.  Ich erzähle Ihnen mehr über Puffertabellen, über die Probleme, die wir damit hatten, und über unsere Lösungen, die wir aus Open Source entwickelt haben - KittenHouse und Lighthouse. <br><br><img src="https://habrastorage.org/webt/j8/gj/qv/j8gjqvhcihgkbedpsmonpxznjto.jpeg"><br><br>  Warum mussten wir überhaupt etwas tun (auf VKontakte ist immer alles in Ordnung, oder?).  Wir wollten Debug-Protokolle sammeln (und es gab Hunderte von Terabyte an Daten). Vielleicht ist es irgendwie bequemer, die Statistiken zu lesen.  und wir haben Zehntausende von Servern, von denen aus all dies erledigt werden muss. <br><br><img src="https://habrastorage.org/webt/pc/og/3w/pcog3wkh42pnfsdpwshhnu-1xqa.jpeg"><br><br>  Warum haben wir uns entschieden?  Wir hatten wahrscheinlich Lösungen zum Speichern von Protokollen.  Hier - es gibt so ein öffentliches "Backend VK".  Ich kann es nur empfehlen, sich anzumelden. <br><br><img src="https://habrastorage.org/webt/15/xd/b3/15xdb3ma4wv43trpduxyujyo1w0.jpeg"><br><br>  Was sind Protokolle?  Dies ist eine Engine, die leere Arrays zurückgibt.  Motoren in „VK“ sind das, was andere Microservices nennen.  Und so ein Sticker lächelt (ziemlich viele Likes).  Wie so  Hör zu! <br><br><img src="https://habrastorage.org/webt/xm/xr/rf/xmxrrfccutg7p6ylcy9-zoyi8ba.jpeg"><br><br>  Womit können Protokolle im Allgemeinen gespeichert werden?  Es ist unmöglich, den Khadup nicht zu erwähnen.  Dann zum Beispiel Rsyslog (Speicherung in den Dateien dieser Protokolle).  LSD  Wer weiß, was LSD ist?  Nein, nicht dieses LSD.  Dateien werden ebenfalls gespeichert.  ClickHouse ist eine seltsame Version. <br><br><h3>  Clickhouse und Wettbewerber: Anforderungen und Möglichkeiten </h3><br>  Was wollen wir  Wir möchten, dass wir bei der Operation kein spezielles Dampfbad benötigen, damit es mit minimalem Setup möglichst sofort funktioniert.  Wir wollen viel schreiben und schnell schreiben.  Und wir wollen es alle Monate, Jahre, das heißt für eine lange Zeit behalten.  Wir möchten vielleicht ein Problem lösen, mit dem sie zu uns gekommen sind. Sie sagten: "Hier funktioniert etwas nicht für uns", aber das war vor 3 Monaten. Und wir möchten es vor 3 Monaten sehen können ".  Datenkomprimierung - es ist verständlich, warum dies von Vorteil ist - da der belegte Speicherplatz reduziert wird. <br><br><img src="https://habrastorage.org/webt/ho/f7/bs/hof7bsmyf40jzgxireygut6jpks.jpeg"><br><br>  Und wir haben eine so interessante Anforderung: Wir schreiben manchmal die Ausgabe einiger Befehle (z. B. Protokolle), es können ganz ruhig mehr als 4 Kilobyte sein.  Und wenn dieses Ding auf UDP funktioniert, muss es nicht ausgegeben werden ... es wird keinen "Overhead" für die Verbindung haben, und für eine große Anzahl von Servern wird dies ein Plus sein. <br><br><img src="https://habrastorage.org/webt/jh/pj/3i/jhpj3iedzogld0galjmia2npwe4.jpeg"><br><br>  Mal sehen, was Open Source uns bietet.  Erstens haben wir eine Logs Engine - das ist unsere Engine;  Er weiß im Grunde alles, auch lange Zeilen können schreiben.  Nun, die Daten werden nicht transparent komprimiert - wir können große Spalten selbst komprimieren, wenn wir möchten ... wir möchten natürlich nicht (wenn möglich).  Das einzige Problem ist, dass er nur das preisgeben kann, was ihm in Erinnerung bleibt.  Der Rest, um zu lesen, müssen Sie das Binlog dieser Engine erhalten und dementsprechend dauert es eine ganze Weile. <br><br><img src="https://habrastorage.org/webt/ps/uk/f5/psukf5cng6yokwi5cbtvvrfry30.jpeg"><br><br>  Was sind die anderen Optionen?  Zum Beispiel Khadup.  Benutzerfreundlichkeit ... Wer glaubt, dass die Hadoup einfach zu konfigurieren ist?  Bei der Aufnahme gibt es natürlich keine Probleme.  Beim Lesen stellen sich manchmal Fragen.  Im Prinzip würde ich das höchstwahrscheinlich nicht sagen, besonders für die Protokolle.  Langzeitspeicherung - natürlich, Datenkomprimierung - ja, lange Zeilen - es ist klar, dass Sie schreiben können.  Aber um von einer großen Anzahl von Servern aufzunehmen ... Jedenfalls müssen wir etwas selbst tun! <br><br>  Rsyslog.  Tatsächlich haben wir es als Fallback verwendet, sodass ein Binlog ohne Speicherauszug gelesen werden kann, aber nicht in lange Zeilen geschrieben werden kann. Im Prinzip können nicht mehr als 4 Kilobyte geschrieben werden.  Die Datenkomprimierung muss auf die gleiche Weise erfolgen.  Das Lesen erfolgt aus Dateien. <br><br><img src="https://habrastorage.org/webt/nt/xo/k3/ntxok3kz6sqyggmdlctpxrokprs.jpeg"><br><br>  Dann gibt es die "schlechte" Entwicklung von LSD.  Das Gleiche ist im Wesentlichen das Gleiche wie „Rsyslog“: Es unterstützt lange Leitungen, weiß jedoch nicht, wie UDP verwendet wird, und aus diesem Grund müssen dort leider viele Dinge umgeschrieben werden.  LSD muss erneut erstellt werden, damit Sie von Zehntausenden von Servern aufzeichnen können. <br><br><img src="https://habrastorage.org/webt/2s/xr/fw/2sxrfwyzgj72wfqblvhlu8fphf0.jpeg"><br><br>  Oh hier!  Eine lustige Option ist ElasticSearch.  Nun, wie soll ich sagen?  Beim Lesen ist alles in Ordnung, das heißt, er liest schnell, aber beim Schreiben nicht sehr gut.  Erstens sind die Daten sehr schwach, wenn sie komprimiert werden.  Höchstwahrscheinlich erfordert eine umfassende Suche umfangreichere Datenstrukturen als das ursprüngliche Volumen.  Es ist schwer auszunutzen, es treten häufig Probleme auf.  Und wieder ein Eintrag im "Elastic" - das müssen wir alle selbst machen. <br><br><img src="https://habrastorage.org/webt/wb/uv/ik/wbuvikg6tm42r0pjhkrtdrcye08.jpeg"><br><br>  Hier ClickHouse - natürlich die ideale Option.  Die einzige Sache ist, dass die Aufzeichnung von Zehntausenden von Servern ein Problem darstellt.  Aber sie ist mindestens eine, wir können versuchen, es irgendwie zu lösen.  Der Rest des Berichts befasst sich mit diesem Problem.  Welche Gesamtleistung von ClickHouse können Sie erwarten? <br><br><h3>  Wie werden wir einbetten?  MergeTree </h3><br>  Wie viele von Ihnen haben noch nichts von ClickHouse gehört, wissen es nicht?  Müssen Sie sagen, nicht notwendig?  Sehr schnell.  Der Einsatz dort ist 1-2 Gigabit pro Sekunde, Bursts von bis zu 10 Gigabit pro Sekunde können dieser Konfiguration tatsächlich widerstehen - es gibt zwei 6-Core-Xeons (das sind nicht einmal die leistungsstärksten), 256 Gigabyte RAM, 20 Terabyte pro Sekunde RAID (niemand konfiguriert, Standardeinstellungen).  Alexey Milovidov, der Entwickler von ClickHouse, hat wahrscheinlich geweint, dass wir nichts konfiguriert haben (bei uns hat alles so funktioniert).  Dementsprechend kann eine Abtastgeschwindigkeit von beispielsweise ungefähr 6 Milliarden Zeilen pro Sekunde erhalten werden, wenn die Daten gut komprimiert sind.  Wenn Sie% auf einer Textzeile tun möchten - 100 Millionen Zeilen pro Sekunde, das heißt, es scheint sehr schnell. <br><br><img src="https://habrastorage.org/webt/mu/m0/ih/mum0ihdgejlxldsd9id8ijjytx8.jpeg"><br><br>  Wie werden wir einbetten?  Nun, das wissen Sie in "VK" - in PHP.  Wir von jedem PHP-Mitarbeiter werden HTTP in "ClickHouse" einfügen, in die MergeTree-Platte für jeden Eintrag.  Wer sieht das Problem in dieser Schaltung?  Aus irgendeinem Grund hoben nicht alle ihre Hände.  Sagen wir es Ihnen. <br><br>  Erstens gibt es viele Server - dementsprechend gibt es viele Verbindungen (schlecht).  In MergeTree ist es dann besser, Daten nicht mehr als einmal pro Sekunde einzufügen.  Und wer weiß warum?  Ok gut  Ich werde Ihnen etwas mehr darüber erzählen.  Eine weitere interessante Frage ist, dass wir sozusagen keine Analysen durchführen, keine Datenanreicherung vornehmen müssen, keine Zwischenserver benötigen und direkt in „ClickHouse“ eingebettet werden möchten (am besten - je gerader, desto besser). <br><br><img src="https://habrastorage.org/webt/2r/im/hz/2rimhzqo0cxkonc8paf7pi2qae0.jpeg"><br><br>  Wie wird das Einfügen in MergeTree implementiert?  Warum ist es besser, es nicht mehr als einmal pro Sekunde oder weniger einzufügen?  Tatsache ist, dass „ClickHouse“ eine spaltenweise Datenbank ist und die Daten in aufsteigender Reihenfolge des Primärschlüssels sortiert. Beim Einfügen wird die Anzahl der Dateien anhand der Anzahl der Spalten erstellt, in denen die Daten in aufsteigender Reihenfolge des Primärschlüssels sortiert sind. (Es wird ein separates Verzeichnis erstellt.) eine Reihe von Dateien auf der Festplatte für jede Beilage).  Dann geht die nächste Einfügung und im Hintergrund verschmelzen sie zu einer größeren "Partition".  Da die Daten sortiert sind, können Sie zwei sortierte Dateien ohne großen Speicherverbrauch „jonglieren“. <br><br>  Wie Sie sich aber vorstellen können, endet ClickHouse schnell (oder Ihr Server), wenn Sie 10 Dateien für jede Einfügung schreiben. Es wird daher empfohlen, große Bündel einzufügen.  Dementsprechend haben wir nie das erste Schema in der Produktion gestartet.  Wir haben sofort eine gestartet, die hier die Nummer 2 hat: <br><br><img src="https://habrastorage.org/webt/7z/0d/yt/7z0dytuytercg92yrt1nu3tpczw.jpeg"><br><br>  Stellen Sie sich hier vor, dass es ungefähr tausend Server gibt, auf denen wir gestartet haben, es gibt nur PHP.  Und auf jedem Server gibt es unseren lokalen Agenten, den wir "Kittenhouse" nennen, der eine Verbindung zu "ClickHouse" hält und alle paar Sekunden Daten einfügt.  Es werden keine Daten in MergeTree eingefügt, sondern in die Spooler-Tabelle, die dazu dient, nicht sofort direkt in MergeTree einzufügen. <br><br><img src="https://habrastorage.org/webt/zu/ok/g1/zuokg1unbbwdege3mpsckf8npme.jpeg"><br><br><h3>  Mit Puffertabellen arbeiten </h3><br>  Was ist das?  Puffertabellen sind ein Teil des Speichers, der gemischt wird (das heißt, Sie können sie häufig einfügen).  Sie bestehen aus mehreren Teilen, und jedes Teil arbeitet als unabhängiger Puffer und wird unabhängig gespült (wenn sich viele Teile im Puffer befinden, werden viele Einfügungen pro Sekunde vorgenommen).  Sie können aus diesen Tabellen lesen - dann lesen Sie die Vereinigung des Inhalts des Puffers und der übergeordneten Tabelle, aber in diesem Moment ist der Datensatz blockiert, daher ist es besser, nicht von dort zu lesen.  Und sehr gutes QPS zeigen die Puffertabellen, dh bis zu 3.000 QPS haben Sie überhaupt keine Probleme beim Einfügen.  Es ist klar, dass bei einem Stromausfall auf dem Server die Daten verloren gehen können, da sie nur im Speicher abgelegt wurden. <br><br><img src="https://habrastorage.org/webt/4p/rg/l1/4prgl1wcijnrxs6zcgz2gmybvec.jpeg"><br><br>  Gleichzeitig wird das Schema mit dem Puffer durch ALTER kompliziert, da Sie zuerst die alte Puffertabelle mit dem alten Schema löschen müssen (die Daten gehen nicht gleichzeitig verloren, da sie gelöscht werden, bevor die Tabelle gelöscht wird).  Dann "ändern" Sie die benötigte Tabelle und erstellen die Puffertabelle erneut.  Dementsprechend fließen Ihre Daten, obwohl es keine Puffertabelle gibt, nirgendwo hin, aber Sie können sie sogar lokal auf der Festplatte speichern. <br><br><img src="https://habrastorage.org/webt/nv/vx/ek/nvvxekkpy2bcezjpuylifhcworq.jpeg"><br><br><h3>  Was ist Kittenhouse und wie funktioniert es? </h3><br>  Was ist KittenHouse?  Dies ist ein Proxy.  Ratet mal welche Sprache?  Ich habe die meisten Hype-Themen in meinem Bericht gesammelt - das ist "Clickhouse", Go, vielleicht kann ich mich an etwas anderes erinnern.  Ja, es ist in Go geschrieben, da ich nicht wirklich weiß, wie man in C schreibt, ich möchte nicht. <br><br><img src="https://habrastorage.org/webt/6r/1w/th/6r1wthqhe4flw_7t7ww01s5arug.jpeg"><br><br>  Dementsprechend hält es eine Verbindung mit jedem Server, der in den Speicher schreiben kann.  Wenn wir beispielsweise Fehlerprotokolle in „Clickhouse“ schreiben, und „Clickhouse“ keine Zeit zum Einfügen von Daten hat (wenn schließlich zu viele geschrieben werden), schwellen wir nicht aus dem Speicher an - wir werfen den Rest einfach weg.  Denn wenn wir mehrere Gigabit pro Sekunde an Fehlern schreiben, können wir wahrscheinlich einige werfen.  Kittenhouse weiß wie.  Außerdem weiß es, wie es zuverlässig liefert, das heißt, es schreibt auf eine Festplatte auf dem lokalen Computer und versucht von Zeit zu Zeit (dort, alle paar Sekunden), Daten aus dieser Datei zu liefern.  Und zuerst haben wir das übliche Werte-Format verwendet - nicht irgendein Binärformat, sondern Textformat (wie in regulärem SQL). <br><br><img src="https://habrastorage.org/webt/rj/2q/z3/rj2qz3hcwcur_lvha_tc2mxjpwq.jpeg"><br><br>  Aber dann ist das passiert.  Wir haben eine zuverlässige Übermittlung verwendet, Protokolle geschrieben und uns dann entschieden (es war ein so bedingtes Testcluster) ... Sie haben es für ein paar Stunden gelöscht und zurückgenommen, und das Einfügen wurde von Tausenden von Servern gestartet - es stellte sich heraus, dass Klickhouse immer noch einen „Thread on“ hatte connection “- dementsprechend führt die aktive Einfügung bei tausend Verbindungen zu einer durchschnittlichen Auslastung des Servers von etwa eineinhalb Tausend.  Überraschenderweise akzeptierte der Server Anfragen, aber solche Daten wurden dennoch nach einiger Zeit eingefügt;  aber es war sehr schwierig für den Server, es zu warten ... <br><br><h3>  Nginx hinzufügen </h3><br>  Eine solche Lösung für das Thread-per-Connection-Modell ist nginx.  Wir haben nginx vor das Clickhouse gestellt, gleichzeitig den Abgleich auf zwei Replikate eingestellt (wir haben die Einfügungsgeschwindigkeit um das 2-fache erhöht, obwohl dies nicht der Fall sein sollte) und die Anzahl der Verbindungen zum Clickhouse, zum Upstream und entsprechend mehr begrenzt als in 50 Verbindungen scheint es keinen Sinn zu machen, einzufügen. <br><br><img src="https://habrastorage.org/webt/7i/ib/9b/7iib9bduvmhr6taouopwj20zzsu.jpeg"><br><br>  Dann stellten wir fest, dass dieses Schema im Allgemeinen Nachteile hat, weil wir hier einen Nginx haben.  Dementsprechend verlieren wir Daten, wenn dieser Nginx trotz Vorhandensein von Replikaten festlegt, oder schreiben zumindest nirgendwo hin.  Daher haben wir unseren Lastenausgleich durchgeführt.  Wir haben auch verstanden, dass „Clickhouse“ immer noch für Protokolle geeignet ist, und der „Dämon“ begann auch, seine eigenen Protokolle in „Clickhouse“ zu schreiben - sehr praktisch, um ehrlich zu sein.  Wir benutzen es immer noch für andere "Dämonen". <br><br><img src="https://habrastorage.org/webt/px/o4/v3/pxo4v3tnrrxwye_tjavgb2p3kgu.jpeg"><br><br>  Dann entdeckten sie ein so interessantes Problem: Wenn Sie eine nicht ganz standardmäßige Methode zum Einfügen im SQL-Modus verwenden, wird ein vollwertiger AST SQL-basierter Parser erzwungen, der ziemlich langsam ist.  Dementsprechend haben wir Einstellungen hinzugefügt, damit dies nie passiert.  Wir haben Load Balancing und Health Checks durchgeführt, sodass wir nach dem Tod immer noch Daten hinterlassen.  Wir haben genug Tische, so dass wir verschiedene „Clickhouse“ -Cluster benötigen.  Und wir haben angefangen, über andere Verwendungszwecke nachzudenken. Beispielsweise wollten wir Protokolle von Nginx-Modulen schreiben, die nicht über unseren RPC kommunizieren können.  Nun, ich möchte ihnen irgendwie beibringen, wie man sendet - zum Beispiel über UDP, um Ereignisse auf localhost zu empfangen und sie dann an das „Clickhouse“ zu senden. <br><br><h3>  Ein Schritt vor der Entscheidung </h3><br>  Das endgültige Schema sah nun so aus (die vierte Version dieses Schemas): Auf jedem Server vor dem Clickhouse befindet sich Nginx (außerdem auf demselben Server) und es werden lediglich Anforderungen an den lokalen Host weitergeleitet, wobei die Anzahl der Verbindungen auf 50 begrenzt ist.  Und jetzt funktionierte dieses Schema bereits, es war ziemlich gut damit. <br><br><img src="https://habrastorage.org/webt/co/ea/sw/coeaswk1ttzg--hk_nz-exq19l0.jpeg"><br><br>  Wir haben ungefähr einen Monat so gelebt.  Jeder war glücklich darüber, Tabellen hinzuzufügen, hinzuzufügen, hinzuzufügen ... Im Allgemeinen stellte sich heraus, dass die Art und Weise, wie wir Puffertabellen hinzufügten, nicht optimal war (sagen wir mal so).  Wir haben 16 Stücke in jeder Tabelle und ein Blitzintervall für ein paar Sekunden gemacht;  Wir hatten 20 Tische und 8 Beilagen pro Sekunde gingen zu jedem Tisch - und in diesem Moment begann das „Clickhouse“ ... die Aufzeichnungen begannen leer zu werden.  Sie haben nicht einmal bestanden ... Nginx hatte standardmäßig eine so interessante Sache, dass, wenn die Verbindungen im Upstream endeten, es nur "502" für alle neuen Anfragen gibt. <br><br><img src="https://habrastorage.org/webt/wd/b-/ih/wdb-ihhsype-ykkjymstxzlq27q.jpeg"><br><br>  Und hier bei uns (ich habe mir gerade die Protokolle in dem „Clickhouse“ angesehen, das ich mir angesehen habe) schlägt irgendwo ein halbes Prozent der Anfragen fehl.  Entsprechend hoch war die Festplattenauslastung, es gab viele Zusammenschlüsse.  Nun, was habe ich getan?  Natürlich habe ich nicht verstanden, warum die Verbindung und der Upstream enden. <br><br><h3>  Ersetzen von Nginx durch Reverse Proxy </h3><br>  Ich entschied, dass wir dies selbst verwalten müssen, es nicht an nginx weitergeben - nginx weiß nicht, welche Tabellen sich im „Clickhouse“ befinden, und ersetzte nginx durch einen Reverse-Proxy, den ich auch geschrieben habe. <br><br><img src="https://habrastorage.org/webt/7u/pv/ve/7upvvezqfizgs73uazcnuqz8edm.jpeg"><br><br>  Was macht er  Es funktioniert auf der Basis der fasthttp-Bibliothek "goosh", also fast so schnell wie Nginx.  Sorry, Igor, wenn Sie hier sind (Anmerkung: Igor Sysoev ist ein russischer Programmierer, der den Nginx-Webserver erstellt hat).  Er kann verstehen, um welche Art von Abfragen es sich handelt - EINFÜGEN oder AUSWÄHLEN -. Er verwaltet verschiedene Verbindungspools für verschiedene Arten von Abfragen. <br><br><img src="https://habrastorage.org/webt/ub/q1/43/ubq143ugu8fsrxicwobmwn8veni.jpeg"><br><br>  Selbst wenn wir keine Zeit haben, um die Anforderungen abzuschließen, werden die "Auswahlen" bestanden und umgekehrt.  Und es gruppiert die Daten in Puffertabellen - mit einem kleinen Puffer: Wenn es Fehler, Syntaxfehler usw. gab, so dass sie den Rest der Daten geringfügig beeinflussten, da wir beim Einfügen einfach in die Puffertabellen kleine “ bachi ”, und alle Fehler von Syntaxfehlern betrafen nur dieses kleine Stück;  und hier werden sie bereits den großen Puffer beeinflussen.  Klein ist 1 Megabyte, also nicht so klein. <br><br><img src="https://habrastorage.org/webt/16/zx/hh/16zxhh_8qun8kzdyjd3i3ysnxzs.jpeg"><br><br>  Das Einfügen eines Synchron und im Wesentlichen das Ersetzen von Nginx funktioniert im Wesentlichen genauso wie zuvor - das Kittenhouse muss hierfür nicht lokal geändert werden.  Und da es fasthttp verwendet, ist es sehr schnell - Sie können über Reverse-Proxys mehr als 100.000 Anfragen pro Sekunde für einzelne Einfügungen stellen.  Theoretisch können Sie eine Zeile in einen Kittenhouse-Reverse-Proxy einfügen, was wir aber sicherlich nicht tun. <br><br><img src="https://habrastorage.org/webt/dv/u5/w8/dvu5w8totg6sa3wexahrky4xcsu.jpeg"><br><br>  Das Schema begann so auszusehen: Kittenhouse, ein Reverse-Proxy, gruppiert viele Anforderungen in Tabellen und fügt sie wiederum in die Haupttabellen ein. <br><br><h3>  Killer - temporäre Lösung, Kitten - permanent </h3><br>  Es gab so ein interessantes Problem ... Hat jemand von euch FastTTP benutzt?  Wer hat fasthttp bei POST-Anfragen verwendet?  Wahrscheinlich hat sich dies nicht gelohnt, da der Anforderungshauptteil standardmäßig gepuffert wird und wir die Puffergröße auf 16 Megabyte festgelegt haben.  Irgendwann war der Einsatz nicht mehr rechtzeitig, und von allen Zehntausenden von Servern gingen 16-Megabyte-Blöcke ein, die alle im Speicher zwischengespeichert waren, bevor sie an das Clickhouse weitergeleitet wurden.  Entsprechend lief der Speicher aus, der Out-Of-Memory-Killer kam, tötete den Reverse-Proxy (oder „Clickhouse“, der theoretisch mehr „essen“ konnte als der Reverse-Proxy).  Der Zyklus wurde wiederholt.  Kein sehr schönes Problem.  Dies ist uns allerdings erst nach wenigen Betriebsmonaten aufgefallen. <br><br>  Was habe ich gemacht  Auch hier möchte ich nicht wirklich verstehen, was genau passiert ist.  Es scheint mir ziemlich offensichtlich, dass es keine Notwendigkeit gibt, in den Speicher zu puffern.  Ich konnte fasthttp nicht patchen, obwohl ich es versucht habe.  Aber ich habe einen Weg gefunden, es so zu machen, dass es nicht nötig ist, irgendetwas zu patchen, und mir eine eigene Methode in HTTP ausgedacht - KITTEN.  Nun, es ist logisch - "VK", "Kätzchen" ... wie sonst? <br><br><img src="https://habrastorage.org/webt/o9/r5/cu/o9r5cugeck0dm4gc_macqqzymgg.jpeg"><br><br>  Wenn eine Anfrage mit der Kitten-Methode an den Server gesendet wird, sollte der Server logischerweise mit "meow" antworten.  Wenn er darauf antwortet, wird angenommen, dass er dieses Protokoll versteht, und dann fange ich die Verbindung ab (es gibt eine solche Methode in fasthttp), und die Verbindung geht in den "Raw" -Modus.  Warum brauche ich das?  Ich möchte steuern, wie das Lesen von TCP-Verbindungen erfolgt.  TCP hat eine wunderbare Eigenschaft: Wenn niemand von dieser Seite liest, beginnt der Datensatz zu warten, und der Speicher wird nicht speziell dafür ausgegeben. <br><br>  Und so lese ich irgendwo von 50 Klienten gleichzeitig (von fünfzig, weil fünfzig sicherlich genug sein sollten, auch wenn es von einem anderen DC kommt) ... Der Verbrauch ist mit diesem Ansatz mindestens 20 Mal gesunken, aber ich ehrlich Ich konnte nicht genau messen, wie viel, weil es schon sinnlos ist (es ist schon auf der Ebene der Fehler geworden).  Das Protokoll ist binär, dh es gibt einen Tabellennamen und Daten.  Da es keine http-Header gibt, habe ich keinen Web-Socket verwendet (ich muss nicht mit Browsern kommunizieren - ich habe ein Protokoll erstellt, das unseren Anforderungen entspricht).  Und mit ihm war alles in Ordnung. <br><br><h3>  Puffertabelle ist traurig </h3><br>  Kürzlich sind wir auf ein weiteres interessantes Merkmal von Puffertabellen gestoßen.  Und dieses Problem ist schon viel schmerzhafter als der Rest.    :      «»,     «»,      ,     (,  60 );       Alter   …   «»,    «»,     , «»   – , -  ,   «»   .     ?  ? <br><br><img src="https://habrastorage.org/webt/8w/zp/su/8wzpsufzkqmzafrt9vom83joq2i.jpeg"><br><br>  , ,          ,       .  , , ,   «»  (      –   ,   , ), …     ,    «» ( -  «» ) –  ,  -   :      (   ,     ),  «» , - ,         .    ,    «»,          –   . <br><br><img src="https://habrastorage.org/webt/po/om/z0/poomz0as89k3aqxh3pa9xpvrr-4.jpeg"><br><br>     (,   ) –     «» query_thread_log.  ,  -   .    840      (100 ).    ,    (, , ,   ) «» (inserts).    ,   «»  –     «»    . ,    –     ,       .  Warum?      ,    !   . <br><br><img src="https://habrastorage.org/webt/vg/gm/fl/vggmfl00f3pku7iix3k7dfj_-am.jpeg"><br><br>   ,     ?    «».  . <br><br><h3>   «KitttenHouse» </h3><br>    , ?               .   !    :  ,   ,  -      .          ,       . <br><br><img src="https://habrastorage.org/webt/pd/e0/rd/pde0rdcd8h4mquk684qhfkvmpvq.jpeg"><br><br> ,   «»,      –       ,      (, - )     ,   ,  – . <br><br><img src="https://habrastorage.org/webt/k_/f3/ev/k_f3ev78dpgabrqjogevuzmykvw.jpeg"><br><br>     ?    .   , ,    10  ,    –         -,      ,  .  ,    , ,    ,        – ,     «»,    100         - –        ,   ,          ,     .          ,   .     ,    . <br><br>  ,       ,    .    :    ,    - ,  , ,    read only    .   ?   .         –  -  , -      … (   , «»,  ClickHouse)  ? ?   ,    .       .   :      ,        .        ,      .  . <br><br><h3>    </h3><br>      .      .  ,   -   ?..    «»? -    …     «»?  ,   ,        .     ,        .    ,  . <br><br><img src="https://habrastorage.org/webt/qy/ko/ud/qykoudjbl76cbexrko1zcmr_wmy.jpeg"><br><br>    –     .     ,   .    ,   : ,     ,     (   ),      – ,   . <br><br><img src="https://habrastorage.org/webt/gp/xa/1f/gpxa1fqutqdl4zr_ngqko2yjpom.jpeg"><br><br>       Sequel Pro,      «»,   .  : «,     -?»  ? 2018-?  ,       «» (MySQL)        ,      «»,    !       «»,     –  ,  . <br><br><img src="https://habrastorage.org/webt/bj/ei/vf/bjeivfj1rem72hvgi50jemwlwkc.jpeg"><br><br> ,    ,   ,  ,  ,   ,  ,    , affected rows (  ),       .  . <br><br><img src="https://habrastorage.org/webt/gu/qb/d7/guqbd74jb1bppis3vv_nbokkiaq.jpeg"><br><br>   .        «»,   .  - -  .     . <br><br><h3> «»    </h3><br>    ,  «»,     ,     . ,  ,    –         .          ,      … ,    ,     . <br><br><img src="https://habrastorage.org/webt/ty/tn/97/tytn97odgbvky_khyj7abanlhqg.jpeg"><br><br> TCP? ,  «»   UDP.     TCP… , ,   : «,   ! ,  UDP». ,  TCP     . ,       ,     –  -   ;  ,   . <br><br> «»  «»     HighLoad Siberia,       « »…  ,   …    , ,       .  -  , -   ,    – ,  (     ,   , ).   <a href="https://vk.com/vkbackend">   </a> .  Vielen Dank! Github  <a href="https://github.com/VKCOM/"> </a> .  «»      . <br><br><img src="https://habrastorage.org/webt/ai/nd/eu/aindeupigrlmumartzyvealbyj4.jpeg"><br><br> <b>:</b> – ,   .   ,          VHS. <br><br> <b>  ( – ):</b> –         VHS,     ? <br><br><img src="https://habrastorage.org/webt/w0/b6/zx/w0b6zxe9lcu_9gtaoimopvg8eyy.jpeg"><br><br> <b>:</b> –        ,  «» –    ! , 5   ! <br><br><h3>  Fragen </h3><br>  <b>Frage des Publikums (im Folgenden - H):</b> - Guten Tag.  Vielen Dank für den Bericht.  Ich habe zwei Fragen.  Ich beginne mit einem leichtfertigen: Beeinflusst die Anzahl der Buchstaben t im Namen „Kittenhouse“ in den Schemata (3, 4, 7 ...) die Zufriedenheit der Katzen? <br><br>  <b>UN:</b> - Die Menge von was? <br><br>  <b>Z:</b> - Die Buchstaben t.  Es gibt drei t, irgendwo drei t. <br><br>  <b>UN:</b> - Habe ich das wirklich korrigiert?  Na klar tut es das!  Das sind verschiedene Produkte - ich habe dich die ganze Zeit angelogen.  Okay, ich mache Witze - das tut es nicht.  Ah, hier!  Nein, es ist dasselbe, ich bin versiegelt. <br><br><img src="https://habrastorage.org/webt/fm/4c/ju/fm4cju6vnwwqvpm2o0exqllhsra.jpeg"><br><br>  <b>Z:</b> - Danke.  Die zweite Frage ist ernst.  Soweit ich weiß, befinden sich die Puffertabellen in „Clickhouse“ ausschließlich im Arbeitsspeicher, werden nicht auf der Festplatte zwischengespeichert und sind dementsprechend nicht persistent. <br><br>  <b>UN:</b> - Ja. <br><br>  <b>Z:</b> - Gleichzeitig wird auf Ihrem Client eine Pufferung auf der Festplatte durchgeführt, was eine gewisse Garantie für die Zustellung derselben Protokolle impliziert.  Im Clickhouse ist dies jedoch nicht garantiert.  Erklären Sie, wie die Garantie ausgeführt wird, aufgrund welcher Umstände? Dieser Mechanismus ist detaillierter <br><br>  <b>UN:</b> - Ja, theoretisch gibt es keine Widersprüche, denn Sie können in der Realität eine Million verschiedene Wege erkennen, wenn das „Clickhouse“ abstürzt.  Wenn das „Clickhouse“ abstürzt (wenn es nicht korrekt ausgeführt wird), können Sie grob gesagt Ihr Protokoll, das Sie notiert haben, zurückspulen und von dem Moment an beginnen, an dem alles in Ordnung war.  Lass es uns vor einer Minute zurückspulen, das heißt, es wird angenommen, dass alles in einer Minute aufleuchtete. <br><br>  <b>Z:</b> - Das heißt, das Kätzchenhaus hält das Fenster länger und kann es im Falle eines Sturzes erkennen und abwickeln? <br><br>  <b>UNO:</b> - Aber das ist in der Theorie.  In der Praxis tun wir dies nicht und die zuverlässige Lieferung erfolgt von null bis unendlich.  Aber im Durchschnitt eins.  Wir sind zufrieden, dass wir ein wenig verlieren, wenn das Clickhouse aus irgendeinem Grund abstürzt oder die Server neu starten.  In allen anderen Fällen wird nichts passieren. <br><br>  <b>Z:</b> - Hallo.  Von Anfang an kam es mir so vor, als würden Sie UDP von Anfang an verwenden.  Sie haben http, all das ... Und die meisten Probleme, die Sie beschrieben haben, wie ich es verstehe, wurden durch diese spezielle Lösung verursacht ... <br><br>  <b>UN:</b> - Was verwenden wir TCP? <br><br>  <b>Z:</b> - In der Tat ja. <br><br>  <b>UN:</b> - Nein. <br><br>  <b>Z:</b> - Mit fasthttp hattest du Probleme, mit der Verbindung hattest du Probleme.  Wenn Sie nur UDP verwenden, sparen Sie sich Zeit.  Nun, es würde Probleme mit langen Nachrichten oder etwas anderem geben ... <br><br>  <b>UN:</b> - Womit? <br><br><img src="https://habrastorage.org/webt/zl/pe/qj/zlpeqjirfmjnmnfkz-tmzmpnbia.jpeg"><br><br>  <b>Z:</b> - Bei langen Nachrichten, da es möglicherweise nicht in die MTU passt, noch etwas ... Nun, da können deine Probleme auftauchen.  Die Frage ist: Warum ist es nicht UDP? <br><br>  <b>UN:</b> - Ich glaube, dass die Autoren, die TCP / IP entwickelt haben, viel schlauer sind als ich und wissen, wie man Pakete besser serialisiert (so gehen sie), gleichzeitig das Sendefenster anpasst, das Netzwerk nicht überlastet und Feedback darüber gibt, was liest, zählt nicht von der anderen Seite ... Alle diese Probleme wären meiner Meinung nach auch in UDP, nur müsste ich noch mehr Code schreiben, als ich bereits geschrieben habe, um das Gleiche selbst zu implementieren, und höchstwahrscheinlich wäre es schlecht.  Ich schreibe nicht mal gerne in C, nicht so wie dort ... <br><br>  <b>Z:</b> - Einfach praktisch!  Ok gesendet und erwarte nichts - du hast absolut asynchron.  Eine Nachricht kam zurück, dass alles in Ordnung ist - das heißt, es ist gekommen;  kam nicht - es bedeutet schlecht. <br><br>  <b>UN:</b> - Ich brauche beides und ein anderes - Ich muss in der Lage sein, beides mit und ohne Zustellgarantie zu versenden.  Dies sind zwei verschiedene Szenarien.  Einige Protokolle brauche ich nicht zu verlieren oder nicht innerhalb der Vernunft zu verlieren. <br><br>  <b>Z:</b> - Ich werde mir keine Zeit nehmen.  Dies sollte länger diskutiert werden.  Vielen Dank. <br><br>  <b>Moderator:</b> - Wer hat Fragen - Stifte am Himmel! <br><br><img src="https://habrastorage.org/webt/ip/mz/l7/ipmzl72i77pluuukxeyuxpqeob0.jpeg"><br><br>  <b>Z:</b> - Hi, ich bin Sasha.  Irgendwann in der Mitte des Berichts gab es das Gefühl, dass es zusätzlich zu TCP möglich war, eine fertige Lösung zu verwenden - eine Art „Kafka“. <br><br>  <b>UN:</b> "Nun ... ich habe dir gesagt, dass ich keine Zwischenserver verwenden möchte, weil ... für Kafka - es stellt sich heraus, dass wir zehntausend Hosts haben;  In der Tat haben wir mehr - Zehntausende von Hosts.  Bei Kafka ohne Stellvertreter kann es auch weh tun.  Darüber hinaus gibt es vor allem noch "Latenz", gibt die zusätzlichen Hosts, die Sie benötigen.  Und ich will sie nicht haben - ich will ... <br><br>  <b>Z:</b> - Aber am Ende hat es sich trotzdem herausgestellt. <br><br>  <b>UN:</b> - Nein, es gibt keine Gastgeber!  Alles funktioniert auf den Clickhouse-Hosts. <br><br>  <b>Z:</b> - Aber was ist mit dem Kätzchenhaus, dessen Rückseite ist - wo wohnt er? <br><br><img src="https://habrastorage.org/webt/bn/ew/lk/bnewlk0ozew0rhhlgtdwhkhjfcu.jpeg"><br><br>  <b>UN:</b> - Auf dem Host von Klickhouse schreibt er nichts auf die Festplatte. <br><br>  <b>Z:</b> - Sagen wir mal. <br><br>  <b>Moderator:</b> - Zufrieden Sie?  Können wir ein Gehalt geben? <br><br>  <b>Z:</b> - Ja, ja.  Tatsächlich gibt es viele Krücken, um das Gleiche zu erreichen, und jetzt widerspricht die vorherige Antwort zum Thema TCP meiner Meinung nach dieser Situation.  Es fühlt sich einfach so an, als könntest du alles auf deinem Knie in viel kürzerer Zeit machen. <br><br>  <b>UN:</b> - Und warum wollte ich "Kafka" nicht verwenden, weil es im Telegramm "Clickhouse" ziemlich viele Beschwerden gab, dass zum Beispiel Nachrichten von "Kafka" verloren gingen.  Nicht von Kafka selbst, sondern in die Integration von Kafka und Klikhaus;  oder etwas hat dort keine Verbindung hergestellt.  Grob gesagt wäre es dann für den Kunden notwendig, dass Kafka dann schreibt.  Ich glaube nicht, dass eine einfachere und zuverlässigere Lösung erzielt werden würde. <br><br>  <b>Z:</b> - Sag mir, warum hast du nicht einige Linien oder einen solchen gemeinsamen Bus ausprobiert?  Da Sie sagen, dass es bei Ihnen möglich war, die Protokolle selbst asynchron durch die Warteschlange zu fahren und als Antwort auch asynchron durch die Warteschlange zu bekommen? <br><br><img src="https://habrastorage.org/webt/pn/4q/sz/pn4qszihp9ejs5aoua8swthjrqk.jpeg"><br><br>  <b>UN:</b> - Bitte schlagen Sie vor, welche Warteschlangen verwendet werden könnten. <br><br>  <b>Z:</b> - Irgendwelche, auch ohne Garantie, dass sie in Ordnung sind.  Beliebige Redis, RMQ ... <br><br>  <b>UN:</b> - Ich habe das Gefühl, dass Redis höchstwahrscheinlich nicht in der Lage sein wird, ein solches Einfügungsvolumen selbst auf einem Host (im Sinne mehrerer Server) abzurufen, der das Clickhouse abruft.  Ich kann dies nicht mit Beweisen bestätigen (ich habe es nicht bewertet), aber es scheint mir, dass Redis hier nicht die beste Lösung ist.  Grundsätzlich können Sie dieses System als spontane Nachrichtenwarteschlange betrachten, die jedoch nur für "Clickhouse" gilt. <br><br>  <b>Moderator:</b> - Yuri, vielen Dank.  Ich schlage vor, die Fragen und Antworten dazu zu beenden und zu sagen, welche der Personen, die die Frage gestellt haben, uns ein Buch geben werden. <br><br>  <b>UN:</b> - Ich möchte der ersten Person, die eine Frage gestellt hat, ein Buch geben. <br><br>  <b>Moderator:</b> - Großartig!  Großartig!  Großartig!  Vielen Dank! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/pbbcMcrQoXw" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Ein bisschen Werbung :) </h3><br>  Vielen Dank für Ihren Aufenthalt bei uns.  Mögen Sie unsere Artikel?  Möchten Sie weitere interessante Materialien sehen?  Unterstützen Sie uns, indem Sie eine Bestellung <a href="https://habr.com/company/ua-hosting/blog/347386/">aufgeben</a> oder Ihren Freunden <a href="https://ua-hosting.company/cloudvps/nl">Cloud-basiertes VPS für Entwickler ab 4,99 US-Dollar</a> empfehlen, ein <b>einzigartiges Analogon zu Einstiegsservern, das wir für Sie erfunden haben:</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">Die ganze Wahrheit über VPS (KVM) E5-2697 v3 (6 Kerne) 10 GB DDR4 480 GB SSD 1 Gbit / s ab 19 Dollar oder wie teilt man den Server?</a>  (Optionen sind mit RAID1 und RAID10, bis zu 24 Kernen und bis zu 40 GB DDR4 verfügbar). <br><br>  <b>Dell R730xd 2-mal billiger im Equinix Tier IV-Rechenzentrum in Amsterdam?</b>  Nur wir haben <b><a href="https://ua-hosting.company/serversnl">2 x Intel TetraDeca-Core Xeon 2 x E5-2697v3 2,6 GHz 14C 64 GB DDR4 4 x 960 GB SSD 1 Gbit / s 100 TV ab 199 US-Dollar</a> in den Niederlanden!</b>  <b><b>Dell R420 - 2x E5-2430 2,2 GHz 6C 128 GB DDR3 2x960 GB SSD 1 Gbit / s 100 TB - ab 99 US-Dollar!</b></b>  Lesen Sie mehr über <a href="https://habr.com/company/ua-hosting/blog/329618/">das Erstellen von Infrastruktur-Bldg.</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">Klasse mit Dell R730xd E5-2650 v4 Servern für 9.000 Euro für einen Cent?</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de483712/">https://habr.com/ru/post/de483712/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de483688/index.html">Etwa 30x Concurrency Boost in Node.js</a></li>
<li><a href="../de483698/index.html">Wie LoRaWAN zum Aufbau eines modernen Internets der Dinge beiträgt</a></li>
<li><a href="../de483700/index.html">Körperliche Ergebnisse des Jahres - 2019</a></li>
<li><a href="../de483704/index.html">Digitale Veranstaltungen in Moskau vom 13. bis 19. Januar</a></li>
<li><a href="../de483706/index.html">App-Ideen, um Einnahmen für Startups im Jahr 2019 und darüber hinaus zu generieren</a></li>
<li><a href="../de483714/index.html">Preise und Wettbewerbe für innovative Projekte. Erfahrung der Weltverkäufer</a></li>
<li><a href="../de483716/index.html">Verwenden des Vulnerability Scanners in in GitlabCI verwendeten Abhängigkeitsprüfungsbibliotheken</a></li>
<li><a href="../de483718/index.html">Wie VDI die Büroumgebung verändert</a></li>
<li><a href="../de483720/index.html">Was brachte uns Pandas 1.0</a></li>
<li><a href="../de483722/index.html">Geoanalytik für den Einzelhandel, Teil 1: Wir automatisieren den Prozess der Standortwahl für ein Unternehmen. 2GIS + MS Azure + ML</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>