<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëú üì• üåÉ C√≥digo de rede Age of Empires: 1.500 arqueiros por modem de 28,8 kbps üíÖüèæ üèÇüèΩ üìΩÔ∏è</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Nota do tradutor: este artigo j√° tem 17 anos e √© interessante apenas do ponto de vista hist√≥rico. √â interessante aprender como os desenvolvedores cons...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥digo de rede Age of Empires: 1.500 arqueiros por modem de 28,8 kbps</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/417703/"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/eaa/c7f/fd7/eaac7ffd7c6a997f72a9cdd4cf67e982.png" alt="imagem"></div><br>  <i>Nota do tradutor: este artigo j√° tem 17 anos e √© interessante apenas do ponto de vista hist√≥rico.</i>  <i>√â interessante aprender como os desenvolvedores conseguiram um jogo on-line tranquilo na era dos modems de 28.8k e dos primeiros Pentiums.</i> <br><br>  Este artigo fala sobre a arquitetura e implementa√ß√£o, bem como algumas li√ß√µes aprendidas ao criar o c√≥digo multiusu√°rio (rede) para os jogos <em>Age of Empires 1 e 2</em> .  Ele tamb√©m descreve as abordagens atuais e futuras da arquitetura de rede usadas pelo Ensemble Studios em seus mecanismos de jogo. <br><br><h2>  Age of Empires multijogador: requisitos de estrutura </h2><br>  No in√≠cio do trabalho no c√≥digo multiplayer <em>Age of Empires,</em> em 1996, estabelecemos objetivos muito espec√≠ficos, necess√°rios para a implementa√ß√£o da jogabilidade necess√°ria. <br><a name="habracut"></a><br><ul><li>  Batalhas hist√≥ricas em larga escala e √©picas com muitas unidades militares </li><li>  Suporte para at√© 8 jogadores no modo multiplayer </li><li>  Simula√ß√£o de jogabilidade suave pela LAN, via conex√£o direta com o modem e pela Internet </li><li>  Suporte √† plataforma de destino: Pentium 90 com 16 MB de RAM e modem de 28,8 kbps </li><li>  O sistema de comunica√ß√£o deve funcionar com o mecanismo existente (Genie) </li><li>  Est√°vel 15 quadros por segundo em m√°quinas com configura√ß√£o m√≠nima </li></ul><br>  O mecanismo Genie j√° estava pronto e a jogabilidade no modo de usu√°rio √∫nico come√ßou a tomar suas formas.  O mecanismo Genie √© um mecanismo de loop de jogo unidimensional bidimensional.  Sprites s√£o renderizados em 256 cores em um mundo composto por ladrilhos.  Os mapas gerados aleatoriamente s√£o preenchidos com milhares de objetos: de √°rvores que podem ser cortadas a gazelas galopantes.  O detalhamento aproximado (ap√≥s a otimiza√ß√£o) do tempo para a execu√ß√£o de tarefas do mecanismo: 30% para renderiza√ß√£o gr√°fica, 30% para IA e localiza√ß√£o de caminhos, 30% para a realiza√ß√£o de simula√ß√µes e tarefas oficiais. <br><br>  J√° em um est√°gio bastante inicial, o mecanismo era relativamente est√°vel e as comunica√ß√µes para v√°rios usu√°rios tinham que trabalhar com c√≥digo pronto, sem a necessidade de uma mudan√ßa significativa na arquitetura (em funcionamento) existente. <br><br>  Para complicar a tarefa, o tempo necess√°rio para concluir cada etapa da simula√ß√£o poderia variar bastante: o tempo de renderiza√ß√£o dependia de o usu√°rio estar observando as unidades, rolando ou olhando para a √°rea inexplorada, e os caminhos longos ou o planejamento estrat√©gico da IA ‚Äã‚Äãafetarem significativamente o tempo de execu√ß√£o do jogo. : as oscila√ß√µes foram de at√© 200 ms. <br><br>  C√°lculos breves mostraram que a transfer√™ncia de at√© um pequeno conjunto de dados sobre unidades e as tentativas de atualiz√°-las em tempo real limitam bastante o n√∫mero de unidades e objetos com os quais o jogador pode interagir.  Se voc√™ simplesmente transferir as coordenadas X e Y, estado, a√ß√£o, dire√ß√£o da vista e dano, no jogo n√£o poder√° haver mais de 250 unidades m√≥veis. <br><br>  Quer√≠amos que os jogadores pudessem destruir as cidades gregas com catapultas, arqueiros e guerreiros, e ao mesmo tempo travando cercos com trirremes do mar.  Obviamente, precis√°vamos de outra abordagem. <br><br><h2>  Simula√ß√µes simult√¢neas </h2><br>  Em vez de transmitir o estado de cada unidade do jogo, quer√≠amos realizar simula√ß√µes absolutamente id√™nticas em cada m√°quina, passando a cada um o mesmo conjunto de comandos dados pelos jogadores ao mesmo tempo.  Os computadores dos jogadores, em ess√™ncia, tinham que sincronizar a jogabilidade nas melhores tradi√ß√µes dos filmes de guerra, permitindo aos jogadores emitir comandos e depois execut√°-los da mesma maneira e ao mesmo tempo, garantindo a identidade dos jogos. <br><br>  Inicialmente, era dif√≠cil implementar uma sincroniza√ß√£o t√£o complicada, mas, como resultado, trouxe vantagens inesperadas em outras √°reas. <br><br>  <strong>Aprimoramento b√°sico do modelo</strong> <br><br>  No n√≠vel conceitual mais simples, implementar simula√ß√µes simult√¢neas parece muito f√°cil.  Em alguns jogos que usam simula√ß√µes com um passo fixo (lock-step) e tempos constantes, isso pode at√© ser bem poss√≠vel. <br><br>  Como com essa abordagem, ele deve assumir a responsabilidade de mover simultaneamente centenas ou milhares de objetos, o sistema deve permanecer vi√°vel, mesmo com flutua√ß√µes de atraso de 20 a 1000 milissegundos e conseguir processar altera√ß√µes durante o processamento de quadros. <br><br>  Enviar comandos do jogador, confirmar todas as mensagens e depois process√°-las antes de passar para a pr√≥xima jogada seria um pesadelo do ponto de vista do processo do jogo, com espera constante e uma lenta troca de equipes.  Precis√°vamos de um esquema que pudesse continuar processando o jogo em paralelo com o plano de fundo, aguardando a conclus√£o do processo de troca de dados. <br><br>  Mark [Terrano] usou um sistema para marcar comandos que devem ser executados por meio de duas ‚Äúmovimenta√ß√µes de troca de dados‚Äù no futuro (as movimenta√ß√µes de troca de dados no <em>AoE</em> foram separadas dos pr√≥prios quadros de renderiza√ß√£o). <br><br>  Ou seja, os comandos dados durante o curso 1000 s√£o atribu√≠dos para serem executados durante o curso 1002 (veja a Fig. 1).  No decurso de 1001, s√£o executados os comandos dados no decurso de 0999. Isso nos permitiu receber, confirmar e preparar mensagens para processamento, enquanto o jogo continuava desenhando anima√ß√µes e simula√ß√µes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/01d/163/10f/01d16310f6b5958701fbde3e8480790a.jpg"></div><br>  <i>Figura 1. Marca√ß√£o de comandos a serem executados atrav√©s de dois ‚Äúmovimentos de troca de dados‚Äù.</i> <br><br>  Normalmente, os movimentos levavam 200 ms e as equipes eram enviadas durante esse turno.  Ap√≥s 200 ms, a mudan√ßa parou e uma nova mudan√ßa come√ßou.  Em cada momento do jogo, as equipes eram processadas em uma jogada, recebidas e salvas para a pr√≥xima jogada e, em seguida, enviadas para execu√ß√£o duas jogadas depois. <br><br><h2>  "Controle de velocidade" </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fc5/133/4b0/fc51334b03798cffa22b0a18938e9ce3.jpg"></div><br>  <i>Figura 2. Controle de velocidade.</i> <br><br>  Como as simula√ß√µes sempre devem ter exatamente a mesma entrada, um jogo n√£o pode correr mais r√°pido do que a m√°quina mais lenta consegue processar a troca de dados, executar uma jogada e enviar novos comandos.  Chamamos o sistema que altera a dura√ß√£o do golpe para manter anima√ß√µes e jogabilidade suaves sob condi√ß√µes de atraso na troca de dados vari√°veis ‚Äã‚Äãe velocidade de processamento "Speed ‚Äã‚ÄãControl". <br><br>  A jogabilidade pode ser sentida "travando" por duas raz√µes: se a taxa de quadros de uma m√°quina cair (ou for menor que o resto), outras m√°quinas processar√£o seus comandos, renderizar√£o tudo no tempo previsto e, como resultado, ter√£o que esperar pelo pr√≥ximo movimento.  Nesse caso, qualquer pausa imediatamente se torna percept√≠vel.  Al√©m disso, o jogo √© retardado por um atraso na troca de dados - os jogadores precisam esperar at√© que a m√°quina receba dados suficientes para concluir a jogada. <br><br>  Cada cliente calculou a taxa de quadros considerada constantemente alcan√ß√°vel, que foi calculada pela m√©dia do tempo de processamento de v√°rios quadros.  Como esse valor muda durante o jogo, dependendo do escopo, do n√∫mero de unidades, do tamanho do mapa e de outros fatores, ele foi transmitido em cada mensagem sobre a conclus√£o da jogada. <br><br>  Al√©m disso, cada cliente tamb√©m mediu o "tempo de ping" de si mesmo para outros clientes e vice-versa.  Ele tamb√©m enviou o ping m√©dio ao cliente mais longo em uma mensagem sobre a conclus√£o da movimenta√ß√£o (no total, 2 bytes foram usados ‚Äã‚Äãpara controlar a velocidade). <br><br>  Em cada movimento, a m√°quina designada pelo host analisava as mensagens de conclus√£o, calculava a taxa de quadros necess√°ria e a corre√ß√£o para o atraso na transmiss√£o de dados pela Internet.  Em seguida, o host enviou uma nova taxa de quadros e a dura√ß√£o da troca de dados.  As Figuras 3-5 mostram como o fluxo de troca de dados foi dividido em diferentes condi√ß√µes. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/34d/ce4/48d/34dce448d5683dd1e449b7d2cf25d505.jpg"></div><br>  <i>Figura 3. Fluxo t√≠pico de troca de dados.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3b9/6b4/1a8/3b96b41a83ee28f6d94164f87f8a8df6.jpg"></div><br>  <i>Figura 4. Transmiss√£o de dados de alta lat√™ncia pela Internet na velocidade normal da m√°quina.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/645/4d5/bd1/6454d5bd11e1ca0b16971e8a3e27cf9f.jpg"></div><br>  <i>Figura 5. Baixa velocidade da m√°quina com atraso normal na transfer√™ncia de dados.</i> <br><br>  O "progresso da troca de dados", que era aproximadamente igual ao tempo de ping da viagem de ida e volta para a mensagem, foi dividido pelo n√∫mero de quadros de simula√ß√£o que a m√°quina mais lenta poderia executar em m√©dia durante esse tempo. <br><br>  A dura√ß√£o da troca de dados foi ponderada, para que pudesse aumentar rapidamente de acordo com as mudan√ßas na lat√™ncia da transmiss√£o de dados pela Internet e diminuir lentamente para a melhor velocidade m√©dia que pode ser mantida constantemente.  Normalmente, o jogo desacelerava e desacelerava apenas nos momentos dos piores picos - o atraso na transmiss√£o dos comandos aumentava, mas permanecia tranquilo (e aumentava apenas alguns milissegundos por turno), porque o jogo reduzia gradualmente os atrasos √† melhor velocidade poss√≠vel.  Isso criou a maior suavidade poss√≠vel da jogabilidade e, ao mesmo tempo, ajustou as mudan√ßas nas condi√ß√µes. <br><br><h2>  Entrega garantida </h2><br>  O UDP foi usado na camada de rede e cada cliente estava envolvido na ordena√ß√£o de comandos, no reconhecimento de perdas e na retransmiss√£o.  Cada mensagem usava um par de bytes, indicando o curso para o qual a execu√ß√£o dos comandos foi planejada e o n√∫mero de s√©rie da mensagem.  Se uma mensagem foi recebida ap√≥s a movimenta√ß√£o, ela foi rejeitada e as mensagens recebidas foram salvas para execu√ß√£o.  Devido √† natureza do UDP, Mark usou o seguinte princ√≠pio ao receber mensagens: ‚ÄúEm caso de d√∫vida, considere a mensagem perdida.  Se as mensagens forem recebidas fora de ordem, o destinat√°rio envia imediatamente uma solicita√ß√£o de retransmiss√£o de mensagens perdidas.  Se a confirma√ß√£o do recebimento for recebida depois do hor√°rio previsto, o remetente simplesmente envia a mensagem novamente, sem aguardar um sinal sobre sua perda. " <br><br><h2>  Benef√≠cios ocultos </h2><br>  Como os resultados calculados pelo jogo dependiam de todos os usu√°rios realizando simula√ß√µes id√™nticas, era incrivelmente dif√≠cil para um cliente (ou fluxo de dados do cliente) invadir e trapacear.  Qualquer simula√ß√£o realizada de maneira diferente foi marcada como "fora de sincronia" e o jogo parou.  Ainda era poss√≠vel enganar localmente a divulga√ß√£o de informa√ß√µes, mas esses vazamentos eram relativamente f√°ceis de corrigir em patches e revis√µes subsequentes.  A seguran√ßa se tornou nossa maior vit√≥ria. <br><br><h2>  Problemas ocultos </h2><br>  A princ√≠pio, pode parecer que a mesma execu√ß√£o de duas inst√¢ncias do mesmo c√≥digo √© f√°cil de implementar, mas n√£o √©.  Nos est√°gios iniciais do projeto, o gerente de produtos da Microsoft, Tim Znamenachek, disse a Mark: ‚ÄúCada projeto possui um bug persistente que n√£o desiste at√© o final.  Acho que, no nosso caso, estar√° fora de sincronia.  E ele estava certo.  As dificuldades de encontrar erros fora de sincronia se multiplicavam a cada pequena altera√ß√£o.  O cervo, cuja posi√ß√£o √© ligeiramente diferente ao criar um mapa aleat√≥rio, se mover√° um pouco diferente e, minutos depois, o ca√ßador se afastar√° um pouco do caminho ou perder√° uma lan√ßa, como resultado de voltar para casa sem carne.  Portanto, o que √†s vezes parecia ser apenas uma diferen√ßa nas somas de verifica√ß√£o da quantidade de comida tinha motivos muito dif√≠ceis de rastrear. <br><br>  Embora tenhamos verificado o mundo, os objetos, a busca de caminhos, a mira e todos os outros sistemas com somas de verifica√ß√£o, sempre havia algo que n√£o pod√≠amos levar em considera√ß√£o.  Grandes volumes (50 MB cada) de rastreamento de mensagens e despejos de objetos do mundo tornaram o problema ainda mais complicado.  Parte das dificuldades era conceitual - os programadores n√£o estavam acostumados a escrever c√≥digo que usava o mesmo n√∫mero de chamadas de gerador de n√∫meros aleat√≥rios em uma simula√ß√£o (sim, n√∫meros aleat√≥rios tamb√©m eram gerados e sincronizados). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d29/1c3/690/d291c3690fef6c18cc65aec724dafe31.png" alt="imagem"></div><br><h2>  Li√ß√µes aprendidas </h2><br>  Ao desenvolver a parte da rede do <em>Age of Empires,</em> recebemos v√°rias li√ß√µes que podem ser aplicadas ao desenvolvimento de qualquer sistema multiusu√°rio de jogos. <br><br>  <strong><em>Aprenda seu usu√°rio.</em></strong>  Estudar o usu√°rio √© o passo mais importante para entender suas expectativas em rela√ß√£o √† velocidade do multiplayer, aos freios e atrasos percebidos nos comandos de transmiss√£o.  Cada g√™nero √© individual e voc√™ precisa entender o que combina com seu estilo de jogo e gerenciamento. <br><br>  Nos est√°gios iniciais do processo de desenvolvimento, Mark e o designer principal atrasaram a troca de dados com prototipagem (esse prot√≥tipo foi revisado v√°rias vezes durante o processo de desenvolvimento).  Como eles estavam jogando um jogo para um jogador, era muito f√°cil simular diferentes n√≠veis de atrasos na transfer√™ncia de equipes e obter feedback dos jogadores (‚Äúo controle parece bom / lento / tremendo / p√©ssimo‚Äù). <br><br>  Para jogos do g√™nero RTS, os atrasos na transmiss√£o de comandos de 250 milissegundos nem s√£o percept√≠veis, a 250-500 ms a jogabilidade √© bastante jog√°vel e os freios tornam-se vis√≠veis a 500 ms ou mais.  Tamb√©m √© interessante notar que os jogadores est√£o acostumados ao "ritmo do jogo" e √† expectativa mental de um atraso entre os cliques do mouse e as rea√ß√µes da unidade.  Uma resposta atrasada constante era melhor do que saltos em atrasos na transmiss√£o de comandos (por exemplo, de 80 a 500 ms) - nesse caso, atrasos constantes de 500 ms eram percebidos como jog√°veis, e os mut√°veis ‚Äã‚Äãpareciam "tr√™mulos" e complicando o jogo. <br><br>  Isso for√ßou os programadores a direcionar seus esfor√ßos para garantir a suavidade - √© melhor escolher uma dura√ß√£o de curso mais longa e ter certeza de que tudo ser√° suave e constante do que realizar opera√ß√µes o mais r√°pido poss√≠vel, diante de lentid√µes regulares.  Todas as mudan√ßas na velocidade devem ser graduais e a taxa de crescimento deve ser a menor poss√≠vel. <br><br>  Tamb√©m medimos os requisitos do usu√°rio para o sistema - geralmente eles davam comandos (mover, atacar, cortar √°rvores) aproximadamente a cada meio e dois segundos, √†s vezes com picos de 3-4 equipes por segundo durante batalhas ferozes.  Como as a√ß√µes ativas em nosso jogo est√£o em constante crescimento, os mais altos requisitos para troca de dados surgem no meio e perto do final do jogo. <br><br>  Se voc√™ dedicar algum tempo para estudar o comportamento do usu√°rio, notar√° outros recursos de como eles jogam, e isso ajudar√° na configura√ß√£o do jogo em rede.  No <em>AoE,</em> durante os ataques, os usu√°rios clicavam rapidamente no mouse (clique-clique-clique-clique - avan√ßar-avan√ßar-avan√ßar-avan√ßar-avan√ßar!), O que levou a enormes picos no n√∫mero de comandos emitidos.  Al√©m disso, eles enviaram grandes grupos de unidades que precisam abrir o caminho - tamb√©m altos picos nos requisitos de transmiss√£o de dados pela rede.  Um filtro simples, cortando comandos repetidos em um ponto, reduziu significativamente o impacto negativo desse comportamento. <br><br>  Em geral, os usu√°rios de monitoramento permitem: <br><br><ul><li>  Descubra as expectativas dos usu√°rios sobre atrasos nos jogos </li><li>  Prot√≥tipo de aspectos multiplayer nos est√°gios iniciais de desenvolvimento </li><li>  Veja um comportamento prejudicial √† velocidade do modo multiusu√°rio. </li></ul><br>  <strong><em>Medi√ß√£o √© a coisa mais importante.</em></strong>  Se voc√™ introduzir m√©tricas nos est√°gios iniciais do trabalho, aprender√° coisas surpreendentes sobre o seu sistema de troca de dados.  Torne as m√©tricas leg√≠veis para os testadores e use-as para entender o que est√° acontecendo dentro do mecanismo de rede. <br><br>  Li√ß√£o: Parte do problema com a troca de dados no AoE surgiu quando Mark deduziu as m√©tricas muito cedo e n√£o verificou novamente os n√≠veis de mensagens (comprimento e frequ√™ncia) depois de preparar o c√≥digo final.  Coisas inesperadas, como corridas aleat√≥rias entre IAs, caminhos dif√≠ceis de calcular e pacotes de comandos mal estruturados podem causar enormes problemas de desempenho, mesmo quando o sistema est√° funcionando bem. <br><br>  Fa√ßa o sistema notificar testadores e desenvolvedores do que parece ser um excesso de condi√ß√µes de contorno - programadores e testadores ver√£o no processo de desenvolvimento quais tarefas carregam o sistema;  isso resolver√° problemas nos est√°gios iniciais de sua ocorr√™ncia. <br><br>  Reserve um tempo para explicar aos testadores como o sistema de troca de dados funciona, mostrar e explicar m√©tricas para eles - voc√™ pode se surpreender ao perceber que eles ocorrem quando falhas estranhas ocorrem inevitavelmente no c√≥digo da rede. <br><br>  Em geral, as m√©tricas devem ter as seguintes propriedades: <br><br><ul><li>  Seja humano leg√≠vel e compreens√≠vel para os testadores </li><li>  Indicar gargalos, freios e problemas </li><li>  Pouco impacto na execu√ß√£o e constantemente sendo lan√ßado. </li></ul><br>  <strong><em>Treinamento para desenvolvedores.</em></strong>  √â muito dif√≠cil ensinar aos programadores que est√£o acostumados a criar aplicativos de usu√°rio √∫nico a pensar sobre a separa√ß√£o entre dar, receber e processar um comando.  √â f√°cil esquecer que voc√™ pode pedir algo que n√£o aconteceu ou o que poderia acontecer alguns segundos ap√≥s o comando ter sido emitido.  Os comandos devem ser verificados quanto √† corre√ß√£o no envio e no recebimento. <br><br>  Em um modelo s√≠ncrono, os programadores tamb√©m precisam considerar que, dentro da simula√ß√£o, o c√≥digo n√£o deve depender de nenhum fator local (como disponibilidade de tempo livre, equipamento especial ou configura√ß√µes diferentes).  A execu√ß√£o do c√≥digo em todas as m√°quinas deve corresponder.  Por exemplo, a presen√ßa de sons aleat√≥rios do terreno em uma simula√ß√£o pode levar a um comportamento diferente do jogo. <br><br>  <strong><em>Outras li√ß√µes.</em></strong>  Esse deve ser o senso comum comum - mas se voc√™ depende de uma rede de terceiros (no nosso caso, √© o DirectPlay), escreva um aplicativo de teste independente confirmando que, quando os propriet√°rios reivindicam "entrega garantida", as mensagens realmente recebem essa "ordem de pacote garantida" de fato, existe e que o produto n√£o possui gargalos ocultos ou comportamento estranho ao processar os dados transmitidos no seu jogo. <br><br>  Prepare-se para criar aplicativos de simula√ß√£o e simuladores de teste de estresse.  No final, criamos tr√™s aplicativos de teste m√≠nimos diferentes usados ‚Äã‚Äãpara estudar problemas individuais e importantes: inunda√ß√µes de conex√£o, problemas com conex√µes simult√¢neas na sele√ß√£o de oponentes e perda de pacotes garantidos. <br><br>  Teste com modems (e, com sorte, com simuladores de modem) o mais cedo poss√≠vel;  Continue o teste do modem (n√£o importa o qu√£o doloroso possa ser) ao longo do processo de desenvolvimento.     (      ‚Äî , ,  , ,       - ?),        dialup-,     LAN.           ,       LAN. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f4b/f84/6f8/f4bf846f89de72b3374179b174094cc8.jpg" alt="imagem"></div><br><h2>   <em>Age of Empires 2</em> </h2><br>  <em>Age of Empires 2: The Age of Kings</em>     ,   ,         The Zone.      ,    DirectPlay   ,       ,    <em>Age of Empires</em> . <br><br>        ,     ,      ¬´¬ª .      -.        ,      ,    .      .            ,   ,        ,        . <br><br>       ()  The Zone    <em>Age of Empires</em>   .  <em>Age of Kings</em>   ,             .      ,    ,        ,        .         .   The Zone  ,         .              - The Zone. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b89/ec7/ef8/b89ec7ef8b25272c8d6e35e6b1593f7d.jpg" alt="imagem"></div><br><h2>  RTS3:  </h2><br> RTS3 ‚Äî      Ensemble   <i>(. .:     Age of Mythology)</i> .  RTS3     ,     Age of Empires,          . <br><br><ul><li>     <em>Age of Empires 1</em>  <em>2</em> .   ,    ,    ,   . </li><li> 3D: RTS3 ‚Äî             . </li><li>   ‚Äî     . </li><li>  TCP/IP:    ‚Äî - TCP/IP   56 /. </li><li>    ‚Äî     ,      NAT. </li></ul><br>      RTS3         ,    <em>Age of Empires 1</em>  <em>2</em> ‚Äî   ‚Äî    RTS3       .  <em>AOE/AOK</em>         DirectPlay,   RTS3     ,        . <br><br>      ,                  .    ,             ,         .   Genie    ,       ‚Äî  BANG!       ,               . <br><br>   <em>Age of Kings</em> ,       ,             .   ,         ,           . <br><br><h2>    RTS3 </h2><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/66a/92d/4a9/66a92d4a984730fcf03a9a392945afb7.jpg"></div><br> <i> 6.  -   RTS3.</i> <br><br> <strong><em>- .</em></strong>   RTS3   - (.  6).         -,    ,   ,        . <br><br>              .         .          ,       (,    ,         -).     (  Channels, TimeSync  ..)   ,               . <br><br> <strong><em> .</em></strong>  Genie    peer-to-peer,             ¬´¬ª.  RTS3     ,            . <br><br>           ¬´¬ª ( 7).         .      <em>Age 1</em>  <em>2</em> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f35/d91/d21/f35d91d21ae3a744d54db202a3710ed4.jpg"></div><br> <i> 7.  ¬´¬ª    .</i> <br><br>  Peer-to-peer: <br><br><ul><li>       ¬´-¬ª  ¬´--¬ª. </li><li>     ‚Äî   ( )   ,   . </li></ul><br>  Peer-to-peer: <br><br><ul><li>      (  n=0  k-1 (n)),          . </li><li>        NAT. </li></ul><br> <strong><em>Net.lib.</em></strong>      RTS3     ,     ,         ,       ,        .    ,    ,     ,    ,       ,     . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/abf/0cc/057/abf0cc057404cbf9c580d39155c9aff9.jpg"></div><br> <i> 8.      .</i> <br><br> RTS3     BANG!  ,         ,  ,   .      ,     BANG! (     ).        ,  ,   ,      OSI,    (.  8). <br><br> <u>Socks,  1</u> <br><br>  , Socks,   API     C.             .     .  Socks                  . <br><br> <u>Link,  2</u> <br><br>  2, Link,    .    ,   Link, Listener, NetworkAddress  Packet,    ,          (.  9). <br><br><ul><li> <strong>Packet ():</strong>      ‚Äî  ,    / (    )     . </li><li> <strong>Link ():</strong>      .       ,           .  send  receive  ,    ,      void*. </li><li> <strong>Listener ():</strong>  .           . </li><li> <strong>Data stream ( ):</strong>        , , ,   . </li><li> <strong>Net Address ( ):</strong>   ,   . </li><li> <strong>Ping:</strong>   .    ,     . </li><li><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0a4/8a3/f76/0a48a3f7672c524404eab911ebd7d062.jpg"></div><br> <i> 9.  Link.</i> </li></ul><br> <u>Multiplayer,  3</u> <br>   ‚Äî       ,   API net.lib.  ,    RTS3      ,          / ‚Äî ,    . <br><br>       BANG!  ,     .  API   ,      ,        . <br><br><ul><li> <strong>Client ():</strong>      .       ()     (  ).    ,    . </li><li> <strong>Session ():</strong>  ,   ,  ,    .       .        host()  join(),    ,   ,     .       / ,           . </li><li> <strong>Channel  Ordered Channel:</strong>        .              .      TimeSync,            . </li><li> <strong>Shared Data:</strong>        .        ,     ,                . </li><li> <strong>Time Sync:</strong>           . </li></ul><br> <u>Game Communications,  4</u> <br><br>      RTS3.    ,       ,     .               ,       ,    . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ac/d8a/f3b/0acd8af3b2f9d73984b7afda314f0e6e.jpg" alt="imagem"></div><br><h2>      </h2><br>  <strong><em>Sistema de sincroniza√ß√£o aprimorado.</em></strong>  Nenhuma equipe de desenvolvimento do <em>Age of Empires</em> poderia dizer que n√£o precisamos de melhores ferramentas de sincroniza√ß√£o.  Como em qualquer projeto, ao analisar o processo de desenvolvimento post-mortem, verifica-se que a maior parte do tempo foi gasta em algumas √°reas, mas poderia ser muito menor se os abord√°ssemos com anteced√™ncia.  No in√≠cio do desenvolvimento do RTS3, no topo da lista dessas √°reas estava a sincroniza√ß√£o de depura√ß√£o. <br><br>  O sistema de rastreamento de sincroniza√ß√£o RTS3 visa principalmente reconhecer rapidamente erros de sincroniza√ß√£o.  Outras prioridades foram a simplifica√ß√£o do uso, a capacidade de processar arbitrariamente grandes quantidades de dados sincronizados transmitidos pelo sistema, a capacidade de compilar completamente o c√≥digo de sincroniza√ß√£o na compila√ß√£o do release e, finalmente, a capacidade de alterar completamente a configura√ß√£o do teste alterando vari√°veis ‚Äã‚Äãem vez de recompilar completamente. <br><br>  A verifica√ß√£o de sincroniza√ß√£o no RTS3 √© realizada usando dois conjuntos de macros: <br><br> <code>#define syncRandCode(userinfo) <br> gSync-&gt;addCodeSync(cRandSync, userinfo, __FILE__, __LINE__) <br></code> <br><br> <code>#define syncRandData(userinfo, <br> v) gSync-&gt;addDataSync(cRandSync, v, userinfo, __FILE__, __LINE__)</code> <br> <br>  Ambas as macros recebem o par√¢metro de cadeia userinfo, que √© o nome ou a indica√ß√£o de um elemento sincronizado espec√≠fico.  Por exemplo, uma chamada de sincroniza√ß√£o pode ter esta apar√™ncia: <br><br> <code>syncRandCode("syncing the random seed", seed);</code> <br> <br>  <em><strong>Comandos s√≠ncronos do console e vari√°veis ‚Äã‚Äãde configura√ß√£o.</strong></em>  Como qualquer desenvolvedor de mod do <em>Quake</em> pode confirmar, os comandos do console e as vari√°veis ‚Äã‚Äãde configura√ß√£o s√£o muito importantes para o processo de desenvolvimento.  Os comandos do console s√£o simples chamadas de fun√ß√£o feitas usando o arquivo de configura√ß√£o de inicializa√ß√£o, o console do jogo ou a interface do usu√°rio, que invocam a funcionalidade arbitr√°ria do jogo.  As vari√°veis ‚Äã‚Äãde configura√ß√£o s√£o denominadas tipos de dados fornecidos pelas fun√ß√µes simples get, set, define e toggle, que usamos para todos os tipos de teste e defini√ß√£o de par√¢metros de configura√ß√£o. <br><br>  Paul criou vers√µes compat√≠veis com v√°rios jogadores de nossos sistemas de comando do console e configura√ß√µes vari√°veis.  Com a ajuda deles, podemos transformar convenientemente uma vari√°vel de configura√ß√£o regular (por exemplo, enableCheating) em uma vari√°vel de configura√ß√£o multijogador, adicionando um sinalizador √† defini√ß√£o da vari√°vel de configura√ß√£o.  Se esse sinalizador estiver ativado, a vari√°vel de configura√ß√£o √© transferida para o jogo multiplayer e as decis√µes sincronizadas no jogo (por exemplo, na permissibilidade da transfer√™ncia gratuita de recursos) podem ser baseadas em seu valor.  Os comandos do console do multiplayer t√™m um princ√≠pio semelhante - as chamadas para os comandos do console do multiplayer s√£o transmitidas pela rede e executadas de forma s√≠ncrona em todas as m√°quinas clientes. <br><br>  Ao usar essas duas ferramentas, os desenvolvedores podem usar o sistema multiplayer sem escrever c√≥digo.  Eles podem adicionar rapidamente novas ferramentas de teste e configura√ß√£o e integr√°-las facilmente em um ambiente de rede. <br><br><h2>  Resumir </h2><br>  A simula√ß√£o sincronizada e o modelo ponto a ponto foram usados ‚Äã‚Äãcom sucesso na s√©rie de jogos Age of Empires.  Apesar da import√¢ncia cr√≠tica de investir tempo na cria√ß√£o de ferramentas e tecnologias para solucionar os principais problemas dessa abordagem (como sincroniza√ß√£o e m√©tricas de rede), a viabilidade dessa arquitetura no g√™nero de estrat√©gias em tempo real foi comprovada pela experi√™ncia.  As melhorias subsequentes que fizemos no RTS3 levaram ao fato de que a jogabilidade multiplayer √© quase indistingu√≠vel da de usu√°rio √∫nico, mesmo nas condi√ß√µes mais terr√≠veis das conex√µes de rede. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt417703/">https://habr.com/ru/post/pt417703/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt417689/index.html">Mobio fala com o CEO da Appnext sobre o mercado de CPI e tend√™ncias de aplicativos m√≥veis</a></li>
<li><a href="../pt417691/index.html">Nossa estante de livros √© um programador de C #. E voc√™?</a></li>
<li><a href="../pt417697/index.html">Editor de imagens simples no VueJS</a></li>
<li><a href="../pt417699/index.html">Western Digital fecha outra f√°brica de HDD devido √† menor demanda</a></li>
<li><a href="../pt417701/index.html">De scripts simples a aplicativos cliente-servidor fa√ßa voc√™ mesmo no WCF: por que eu gosto de trabalhar no CM</a></li>
<li><a href="../pt417705/index.html">Como um fabricante de placa de v√≠deo afeta a lucratividade da minera√ß√£o de GPU</a></li>
<li><a href="../pt417707/index.html">CSS-in-JS - mitos e realidade (componentes estilizados como exemplo)</a></li>
<li><a href="../pt417709/index.html">Onde e como os desenvolvedores classificam seus empregadores? Servi√ßos de avalia√ß√£o de empresas no setor de TI</a></li>
<li><a href="../pt417711/index.html">O que ler sobre o Swift em russo?</a></li>
<li><a href="../pt417715/index.html">Adeus, Google Maps</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>