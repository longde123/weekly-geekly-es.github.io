<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üï¥üèø ü•ô üëåüèæ Quelle est l'efficacit√© du syst√®me de fichiers virtuel procfs et est-il possible de l'optimiser üíá ‚úäüèø ü•û</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Le syst√®me de fichiers proc (ci-apr√®s simplement procfs) est un syst√®me de fichiers virtuel qui fournit des informations sur les processus. Elle est u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Quelle est l'efficacit√© du syst√®me de fichiers virtuel procfs et est-il possible de l'optimiser</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/virtuozzo/blog/418715/"><p>  Le syst√®me de fichiers proc (ci-apr√®s simplement procfs) est un syst√®me de fichiers virtuel qui fournit des informations sur les processus.  Elle est un ¬´bel¬ª exemple d'interfaces suivant le paradigme ¬´tout est un fichier¬ª.  Procfs a √©t√© d√©velopp√© il y a tr√®s longtemps: √† une √©poque o√π les serveurs desservaient en moyenne des dizaines de processus, l'ouverture d'un fichier et la lecture des informations de processus ne posaient pas de probl√®me.  Cependant, le temps ne s'arr√™te pas, et maintenant les serveurs servent des centaines de milliers, voire plus de processus en m√™me temps.  Dans ce contexte, l'id√©e ¬´d'ouvrir un fichier pour chaque processus afin de soustraire les donn√©es d'int√©r√™t¬ª ne semble plus aussi attrayante, et la premi√®re chose qui vient √† l'esprit pour acc√©l√©rer la lecture est d'obtenir des informations sur un groupe de processus en une seule it√©ration.  Dans cet article, nous allons essayer de trouver des √©l√©ments procfs pouvant √™tre optimis√©s. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/7c7/55c/f6b/7c755cf6b80f5b20ab194e548c3c99be.jpg" alt="image"></p><a name="habracut"></a><br><p>  L'id√©e m√™me d'am√©liorer procfs est n√©e lorsque nous avons d√©couvert que CRIU passe beaucoup de temps √† lire les fichiers procfs.  Nous avons vu comment un probl√®me similaire a √©t√© r√©solu pour les sockets et avons d√©cid√© de faire quelque chose de similaire √† l'interface sock-diag, mais uniquement pour procfs.  Bien s√ªr, nous avons suppos√© combien il serait difficile de changer l'interface de longue date et bien √©tablie dans le noyau, pour convaincre la communaut√© que le jeu en valait la chandelle ... et nous avons √©t√© agr√©ablement surpris par le nombre de personnes qui ont soutenu la cr√©ation de la nouvelle interface.  √Ä strictement parler, personne ne savait √† quoi devrait ressembler la nouvelle interface, mais il ne fait aucun doute que procfs ne r√©pond pas aux exigences de performances actuelles.  Par exemple, ce sc√©nario: le serveur r√©pond aux demandes depuis trop longtemps, vmstat montre que la m√©moire est pass√©e en permutation et "ps ax" est d√©marr√© √† partir de 10 secondes ou plus, top n'affiche rien du tout.  Dans cet article, nous ne consid√©rerons aucune nouvelle interface sp√©cifique; nous essaierons plut√¥t de d√©crire les probl√®mes et leurs solutions. </p><br><p> Chaque processus procfs en cours d'ex√©cution est repr√©sent√© par le r√©pertoire / proc / <code>&lt;pid&gt;</code> . <br>  Dans chacun de ces r√©pertoires, il existe de nombreux fichiers et sous-r√©pertoires qui donnent acc√®s √† certaines informations sur le processus.  Les sous-r√©pertoires regroupent les donn√©es par fonctionnalit√©.  Par exemple ( <code>$$</code> est une variable shell sp√©ciale qui est d√©velopp√©e en pid - l'identifiant du processus en cours): </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ls <span class="hljs-operator"><span class="hljs-operator">-F</span></span> /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span> attr/ exe<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> mounts projid_map status autogroup fd/ mountstats root<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> syscall auxv fdinfo/ net/ sched task/ cgroup gid_map ns/ schedstat timers clear_refs io numa_maps sessionid timerslack_ns cmdline limits oom_adj setgroups uid_map comm loginuid oom_score smaps wchan coredump_filter map_files/ oom_score_adj smaps_rollup cpuset maps pagemap stack cwd<span class="hljs-selector-tag"><span class="hljs-selector-tag">@</span></span> mem patch_state stat environ mountinfo personality statm</code> </pre> <br><p>  Tous ces fichiers produisent des donn√©es dans diff√©rents formats.  La plupart sont en texte au format ASCII facilement perceptible par l'homme.  Eh bien, presque facile: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>/stat <span class="hljs-number"><span class="hljs-number">24293</span></span> (bash) S <span class="hljs-number"><span class="hljs-number">21811</span></span> <span class="hljs-number"><span class="hljs-number">24293</span></span> <span class="hljs-number"><span class="hljs-number">24293</span></span> <span class="hljs-number"><span class="hljs-number">34854</span></span> <span class="hljs-number"><span class="hljs-number">24876</span></span> <span class="hljs-number"><span class="hljs-number">4210688</span></span> <span class="hljs-number"><span class="hljs-number">6325</span></span> <span class="hljs-number"><span class="hljs-number">19702</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">47892016</span></span> <span class="hljs-number"><span class="hljs-number">135487488</span></span> <span class="hljs-number"><span class="hljs-number">3388</span></span> <span class="hljs-number"><span class="hljs-number">18446744073709551615</span></span> <span class="hljs-number"><span class="hljs-number">94447405350912</span></span> <span class="hljs-number"><span class="hljs-number">94447406416132</span></span> <span class="hljs-number"><span class="hljs-number">140729719486816</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">65536</span></span> <span class="hljs-number"><span class="hljs-number">3670020</span></span> <span class="hljs-number"><span class="hljs-number">1266777851</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">94447408516528</span></span> <span class="hljs-number"><span class="hljs-number">94447408563556</span></span> <span class="hljs-number"><span class="hljs-number">94447429677056</span></span> <span class="hljs-number"><span class="hljs-number">140729719494655</span></span> <span class="hljs-number"><span class="hljs-number">140729719494660</span></span> <span class="hljs-number"><span class="hljs-number">140729719494660</span></span> <span class="hljs-number"><span class="hljs-number">140729719496686</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Pour comprendre ce que signifie chaque √©l√©ment de cet ensemble, le lecteur devra ouvrir man proc (5), ou la documentation du noyau.  Par exemple, le deuxi√®me √©l√©ment est le nom du fichier ex√©cutable entre crochets, et le dix-neuvi√®me √©l√©ment est la valeur actuelle de la priorit√© d'ex√©cution (sympa). </p><br><p>  Certains fichiers sont assez lisibles par eux-m√™mes: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> cat /proc/<span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span>/status | head <span class="hljs-literal"><span class="hljs-literal">-n</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> Name: bash Umask: <span class="hljs-number"><span class="hljs-number">0002</span></span> State: S (sleeping) Tgid: <span class="hljs-number"><span class="hljs-number">24293</span></span> Ngid: <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br><p>  Mais √† quelle fr√©quence les utilisateurs lisent-ils les informations directement √† partir des fichiers procfs?  De combien de temps le noyau a-t-il besoin pour convertir des donn√©es binaires au format texte?  Quelle est la surcharge de procfs?  Dans quelle mesure cette interface est-elle pratique pour les programmes de surveillance d'√©tat et combien de temps passent-ils pour traiter ces donn√©es de texte?  Quelle est l'importance d'une mise en ≈ìuvre si lente dans les situations d'urgence? </p><br><p>  Tr√®s probablement, ce ne sera pas une erreur de dire que les utilisateurs pr√©f√®rent des programmes comme top ou ps, au lieu de lire directement les donn√©es de procfs. </p><br><p>  Pour r√©pondre aux questions restantes, nous allons mener plusieurs exp√©riences.  Tout d'abord, trouvez o√π le noyau passe du temps √† g√©n√©rer des fichiers procfs. </p><br><p>  Pour obtenir certaines informations de tous les processus du syst√®me, nous devrons passer par le r√©pertoire / proc / et s√©lectionner tous les sous-r√©pertoires dont le nom est repr√©sent√© par des chiffres d√©cimaux.  Ensuite, dans chacun d'eux, nous devons ouvrir le fichier, le lire et le fermer. </p><br><p>  Au total, nous ferons trois appels syst√®me, dont l'un cr√©era un descripteur de fichier (dans le noyau, un descripteur de fichier est associ√© √† un ensemble d'objets internes pour lesquels de la m√©moire suppl√©mentaire est allou√©e).  Les appels syst√®me open () et close () eux-m√™mes ne nous donnent aucune information, ils peuvent donc √™tre attribu√©s √† la surcharge de l'interface procfs. </p><br><p>  Essayons simplement d'ouvrir () et de fermer () pour chaque processus du syst√®me, mais nous ne lirons pas le contenu des fichiers: </p><br><pre> <code class="hljs go">$ time ./task_proc_all --noread stat tasks: <span class="hljs-number"><span class="hljs-number">50290</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.177s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.012s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.162s</span></span></code> </pre> <br><pre> <code class="hljs go">$ time ./task_proc_all --noread loginuid tasks: <span class="hljs-number"><span class="hljs-number">50289</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.176s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.026s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.145</span></span></code> </pre> <br><p>  <em>task-proc-all - un petit utilitaire, dont le code peut √™tre trouv√© sur le lien ci-dessous</em> </p><br><p>  Peu importe le fichier √† ouvrir, car les donn√©es r√©elles ne sont g√©n√©r√©es qu'au moment de la lecture (). </p><br><p>  Regardez maintenant la sortie du profileur perf core: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 92<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_proc_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[unknown]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 64<span class="hljs-selector-class"><span class="hljs-selector-class">.01</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">GI___libc_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.71</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_sys_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 48<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_filp_open</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">path_openat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 19<span class="hljs-selector-class"><span class="hljs-selector-class">.60</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">link_path_walk</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 14<span class="hljs-selector-class"><span class="hljs-selector-class">.23</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">walk_component</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 13<span class="hljs-selector-class"><span class="hljs-selector-class">.87</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">lookup_fast</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 7<span class="hljs-selector-class"><span class="hljs-selector-class">.55</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">pid_revalidate</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.13</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_pid_task</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.58</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">security_task_to_inode</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_dump_owner</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">d_lookup_rcu</span></span> + 3<span class="hljs-selector-class"><span class="hljs-selector-class">.42</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">security_inode_permission</span></span> + 14<span class="hljs-selector-class"><span class="hljs-selector-class">.76</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pident_lookup</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.39</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">d_alloc_parallel</span></span> + 2<span class="hljs-selector-class"><span class="hljs-selector-class">.93</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">get_empty_filp</span></span> + 2<span class="hljs-selector-class"><span class="hljs-selector-class">.43</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">lookup_fast</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.98</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">do_dentry_open</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.07</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.60</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01b</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.97</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">kmem_cache_alloc</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01e</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 16<span class="hljs-selector-class"><span class="hljs-selector-class">.45</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">getdents64</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 15<span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_getdents</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">iterate_dir</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pid_readdir</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 7<span class="hljs-selector-class"><span class="hljs-selector-class">.18</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_fill_cache</span></span> + 3<span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">d_lookup</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.59</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">filldir</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.82</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">next_tgid</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">snprintf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 9<span class="hljs-selector-class"><span class="hljs-selector-class">.89</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">close</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.03</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.98</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.85</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01b</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.61</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000008a01e</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span></code> </pre> <br><p>  Le noyau passe presque 75% du temps juste pour cr√©er et supprimer le descripteur de fichier, et environ 16% pour lister les processus. </p><br><p>  Bien que nous sachions combien de temps il faut pour les appels open () et close () pour chaque processus, nous ne pouvons toujours pas estimer son importance.  Nous devons comparer les valeurs obtenues avec quelque chose.  Essayons de faire de m√™me avec les fichiers les plus connus.  Habituellement, lorsque vous devez r√©pertorier les processus, l'utilitaire ps ou top est utilis√©.  Ils lisent / proc / <code>&lt;pid&gt;</code> / stat et / proc / <code>&lt;pid&gt;</code> / status pour chaque processus du syst√®me. </p><br><p>  Commen√ßons par / proc / <code>&lt;pid&gt;</code> / status - il s'agit d'un fichier massif avec un nombre fixe de champs: </p><br><pre> <code class="hljs go">$ time ./task_proc_all status tasks: <span class="hljs-number"><span class="hljs-number">50283</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.455s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.033s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.417s</span></span></code> </pre> <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 93<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_proc_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[unknown]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[k]</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x0000000000008000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">x8000</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 61<span class="hljs-selector-class"><span class="hljs-selector-class">.20</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 53<span class="hljs-selector-class"><span class="hljs-selector-class">.06</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 52<span class="hljs-selector-class"><span class="hljs-selector-class">.80</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 52<span class="hljs-selector-class"><span class="hljs-selector-class">.22</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.43</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_single_show</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 50<span class="hljs-selector-class"><span class="hljs-selector-class">.38</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_pid_status</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 11<span class="hljs-selector-class"><span class="hljs-selector-class">.34</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_mem</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.99</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.77</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_put_decimal_ull</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.94</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strlen</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.42</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">num_to_str</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">cpuset_task_status_allowed</span></span> + <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.37</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">render_cap_t</span></span> + 5<span class="hljs-selector-class"><span class="hljs-selector-class">.31</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_printf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 5<span class="hljs-selector-class"><span class="hljs-selector-class">.25</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">render_sigset_t</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_putc</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">task_pid_nr_ns</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">lock_task_sighand</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.53</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">hugetlb_report_usage</span></span> + 0<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span>% _<span class="hljs-selector-tag"><span class="hljs-selector-tag">copy_to_user</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">number</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.05</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">seq_put_decimal_ull</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">vsnprintf</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.79</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">format_decode</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">syscall_return_via_sysret</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.52</span></span>% 0<span class="hljs-selector-tag"><span class="hljs-selector-tag">xfffffe000003201b</span></span> + 20<span class="hljs-selector-class"><span class="hljs-selector-class">.95</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">GI___libc_open</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.44</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">getdents64</span></span> + 4<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">close</span></span></code> </pre> <br><p>  On peut voir que seulement environ 60% du temps pass√© √† l'int√©rieur de l'appel syst√®me read ().  Si vous regardez le profil de plus pr√®s, il s'av√®re que 45% du temps est utilis√© √† l'int√©rieur des fonctions du noyau seq_printf, seq_put_decimal_ull.  Ainsi, la conversion du format binaire au format texte est une op√©ration assez co√ªteuse.  Ce qui pose la question bien fond√©e: avons-nous vraiment besoin d'une interface texte pour extraire les donn√©es du noyau?  √Ä quelle fr√©quence les utilisateurs souhaitent-ils travailler avec des donn√©es brutes?  Et pourquoi les utilitaires top et ps doivent-ils reconvertir ces donn√©es texte en binaire? </p><br><p>  Il serait probablement int√©ressant de savoir √† quel point la sortie serait plus rapide si les donn√©es binaires √©taient utilis√©es directement et si trois appels syst√®me n'√©taient pas n√©cessaires. </p><br><p>  Il y a d√©j√† eu des tentatives de cr√©ation d'une telle interface.  En 2004, nous avons essay√© d'utiliser le moteur netlink. </p><br><pre> <code class="hljs markdown">[<span class="hljs-string"><span class="hljs-string">0/2</span></span>][<span class="hljs-symbol"><span class="hljs-symbol">ANNOUNCE</span></span>] nproc: netlink access to /proc information (https://lwn.net/Articles/99600/) nproc is an attempt to address the current problems with /proc. In short, it exposes the same information via netlink (implemented for a small subset).</code> </pre> <br><p>  Malheureusement, la communaut√© n'a pas montr√© beaucoup d'int√©r√™t pour ce travail.  L'une des derni√®res tentatives pour corriger la situation a eu lieu il y a deux ans. </p><br><pre> <code class="hljs cs">[<span class="hljs-meta"><span class="hljs-meta">PATCH 0/15</span></span>] task_diag: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">add</span></span></span><span class="hljs-function"> a new </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">interface</span></span></span><span class="hljs-function"> to </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">get</span></span></span><span class="hljs-function"> information about </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processes</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">https://lwn.net/Articles/</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">683371</span></span></span></span><span class="hljs-function"><span class="hljs-params">/</span></span></span><span class="hljs-function">)</span></span></code> </pre> <br><p>  L'interface task-diag est bas√©e sur les principes suivants: </p><br><ul><li>  Transaction: envoy√© une demande, re√ßu une r√©ponse; </li><li>  Le format des messages est sous forme de netlink (le m√™me que l'interface sock_diag: binaire et extensible); </li><li>  La possibilit√© de demander des informations sur de nombreux processus en un seul appel; </li><li>  Regroupement optimis√© des attributs (tout attribut du groupe ne doit pas augmenter le temps de r√©ponse). </li></ul><br><p>  Cette interface a √©t√© pr√©sent√©e lors de plusieurs conf√©rences.  Il a √©t√© int√©gr√© dans pstools, les utilitaires CRIU et David Ahern a int√©gr√© task_diag dans perf comme exp√©rience. </p><br><p>  La communaut√© de d√©veloppement du noyau s'est int√©ress√©e √† l'interface task_diag.  Le principal sujet de discussion a √©t√© le choix du transport entre le noyau et l'espace utilisateur.  L'id√©e initiale d'utiliser des sockets netlink a √©t√© rejet√©e.  En partie √† cause de probl√®mes non r√©solus dans le code du moteur netlink lui-m√™me, et en partie parce que beaucoup de gens pensent que l'interface netlink a √©t√© con√ßue exclusivement pour le sous-syst√®me r√©seau.  Ensuite, il a √©t√© propos√© d'utiliser des fichiers transactionnels dans procfs, c'est-√†-dire que l'utilisateur ouvre le fichier, y √©crit la requ√™te, puis lit simplement la r√©ponse.  Comme d'habitude, il y avait des opposants √† cette approche.  Une solution que tout le monde souhaiterait jusqu'√† ce qu'elle soit trouv√©e. </p><br><p>  Comparons les performances de task_diag avec procfs. </p><br><p>  Le moteur task_diag dispose d'un utilitaire de test qui convient bien √† nos exp√©riences.  Supposons que nous voulons demander des identificateurs de processus et leurs droits.  Voici la sortie pour un processus: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> ./task_diag_all one <span class="hljs-literal"><span class="hljs-literal">-c</span></span> <span class="hljs-literal"><span class="hljs-literal">-p</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span><span class="hljs-variable"><span class="hljs-variable">$</span></span> pid <span class="hljs-number"><span class="hljs-number">2305</span></span> tgid <span class="hljs-number"><span class="hljs-number">2305</span></span> ppid <span class="hljs-number"><span class="hljs-number">2299</span></span> sid <span class="hljs-number"><span class="hljs-number">2305</span></span> pgid <span class="hljs-number"><span class="hljs-number">2305</span></span> comm bash uid: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> gid: <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> CapInh: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapPrm: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapEff: <span class="hljs-number"><span class="hljs-number">0000000000000000</span></span> CapBnd: <span class="hljs-number"><span class="hljs-number">0000003</span></span>fffffffff</code> </pre> <br><p>  Et maintenant, pour tous les processus du syst√®me, c'est-√†-dire la m√™me chose que nous avons faite pour l'exp√©rience procfs lorsque nous lisons le fichier / proc / pid / status: </p><br><pre> <code class="hljs pgsql">$ <span class="hljs-type"><span class="hljs-type">time</span></span> ./task_diag_all <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> -c <span class="hljs-type"><span class="hljs-type">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.048</span></span>s <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.001</span></span>s sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.046</span></span>s</code> </pre> <br><p>  Il n'a fallu que 0,05 seconde pour obtenir les donn√©es pour construire l'arborescence des processus.  Et avec procfs, il n'a fallu que 0.177 secondes pour ouvrir un fichier pour chaque processus, et sans lire les donn√©es. </p><br><p>  Sortie Perf pour l'interface task_diag: </p><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 82<span class="hljs-selector-class"><span class="hljs-selector-class">.24</span></span>% 0<span class="hljs-selector-class"><span class="hljs-selector-class">.00</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_diag_all</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[kernel.vmlinux]</span></span> <span class="hljs-selector-attr"><span class="hljs-selector-attr">[k]</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">entry_SYSCALL_64_fastpath</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 81<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">sys_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> __<span class="hljs-selector-tag"><span class="hljs-selector-tag">vfs_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">proc_reg_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">task_diag_read</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">taskdiag_dumpit</span></span> + 33<span class="hljs-selector-class"><span class="hljs-selector-class">.84</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">next_tgid</span></span> 13<span class="hljs-selector-class"><span class="hljs-selector-class">.06</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">task_pid_nr_ns</span></span> + 6<span class="hljs-selector-class"><span class="hljs-selector-class">.63</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">ptrace_may_access</span></span> + 5<span class="hljs-selector-class"><span class="hljs-selector-class">.68</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">from_kuid_munged</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-</span></span> 4<span class="hljs-selector-class"><span class="hljs-selector-class">.19</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">get_task_comm</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.90</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strncpy</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.29</span></span>% _<span class="hljs-selector-tag"><span class="hljs-selector-tag">raw_spin_lock</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.03</span></span>% __<span class="hljs-selector-tag"><span class="hljs-selector-tag">nla_reserve</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.73</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">nla_reserve</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.30</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">skb_copy_datagram_iter</span></span> + 1<span class="hljs-selector-class"><span class="hljs-selector-class">.21</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">from_kgid_munged</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span>% <span class="hljs-selector-tag"><span class="hljs-selector-tag">strncpy</span></span></code> </pre> <br><p>  Il n'y a rien d'int√©ressant dans la liste elle-m√™me, sauf qu'il n'y a pas de fonctions √©videntes adapt√©es √† l'optimisation. </p><br><p>  Examinons la sortie perf lors de la lecture des informations sur tous les processus du syst√®me: </p><br><pre> <code class="hljs pgsql"> $ perf trace -s ./task_diag_all <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> -c -q <span class="hljs-keyword"><span class="hljs-keyword">Summary</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> events: task_diag_all (<span class="hljs-number"><span class="hljs-number">54326</span></span>), <span class="hljs-number"><span class="hljs-number">185</span></span> events, <span class="hljs-number"><span class="hljs-number">95.4</span></span>% syscall calls total min avg max stddev (msec) (msec) (msec) (msec) (%) <span class="hljs-comment"><span class="hljs-comment">--------------- -------- --------- --------- --------- --------- ------ read 49 40.209 0.002 0.821 4.126 9.50% mmap 11 0.051 0.003 0.005 0.007 9.94% mprotect 8 0.047 0.003 0.006 0.009 10.42% openat 5 0.042 0.005 0.008 0.020 34.86% munmap 1 0.014 0.014 0.014 0.014 0.00% fstat 4 0.006 0.001 0.002 0.002 10.47% access 1 0.006 0.006 0.006 0.006 0.00% close 4 0.004 0.001 0.001 0.001 2.11% write 1 0.003 0.003 0.003 0.003 0.00% rt_sigaction 2 0.003 0.001 0.001 0.002 15.43% brk 1 0.002 0.002 0.002 0.002 0.00% prlimit64 1 0.001 0.001 0.001 0.001 0.00% arch_prctl 1 0.001 0.001 0.001 0.001 0.00% rt_sigprocmask 1 0.001 0.001 0.001 0.001 0.00% set_robust_list 1 0.001 0.001 0.001 0.001 0.00% set_tid_address 1 0.001 0.001 0.001 0.001 0.00%</span></span></code> </pre> <br><p>  Pour procfs, nous devons effectuer plus de 150 000 appels syst√®me pour obtenir des informations sur tous les processus, et pour task_diag - un peu plus de 50. </p><br><p>  Regardons les situations r√©elles.  Par exemple, nous voulons afficher un arbre de processus avec des arguments de ligne de commande pour chacun.  Pour ce faire, nous devons extraire le pid du processus, le pid de son parent et les arguments de ligne de commande eux-m√™mes. </p><br><p>  Pour l'interface task_diag, le programme envoie une requ√™te pour obtenir tous les param√®tres √† la fois: </p><br><pre> <code class="hljs go">$ time ./task_diag_all all --cmdline -q <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.096s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.006s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.090s</span></span></code> </pre> <br><p>  Pour les procfs d'origine, nous devons lire / proc // status et / proc // cmdline pour chaque processus: <br></p><pre> <code class="hljs go">$ time ./task_proc_all status tasks: <span class="hljs-number"><span class="hljs-number">50278</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.463s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.030s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.427s</span></span></code> </pre> <br><pre> <code class="hljs go">$ time ./task_proc_all cmdline tasks: <span class="hljs-number"><span class="hljs-number">50281</span></span> <span class="hljs-built_in"><span class="hljs-built_in">real</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.270s</span></span> user <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.028s</span></span> sys <span class="hljs-number"><span class="hljs-number">0</span></span>m0<span class="hljs-number"><span class="hljs-number">.237s</span></span></code> </pre> <br><p>  Il est facile de remarquer que task_diag est 7 fois plus rapide que procfs (0,096 contre 0,27 + 0,46).  Habituellement, une am√©lioration des performances de plusieurs pour cent est d√©j√† un bon r√©sultat, mais ici, la vitesse a augment√© de pr√®s d'un ordre de grandeur. </p><br><p>  Il convient √©galement de mentionner que la cr√©ation d'objets de noyau internes affecte √©galement consid√©rablement les performances.  Surtout lorsque le sous-syst√®me de m√©moire est sous forte charge.  Comparez le nombre d'objets cr√©√©s pour procfs et task_diag: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> ./task_proc_all status <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | grep kmem | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">58184</span></span> <span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> ./task_diag_all all <span class="hljs-literal"><span class="hljs-literal">-q</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | grep kmem | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">188</span></span></code> </pre> <br><p>  Et vous devez √©galement savoir combien d'objets sont cr√©√©s lors du d√©marrage d'un processus simple, par exemple, le v√©ritable utilitaire: </p><br><pre> <code class="hljs powershell"><span class="hljs-variable"><span class="hljs-variable">$</span></span> perf trace -<span class="hljs-literal"><span class="hljs-literal">-event</span></span> <span class="hljs-string"><span class="hljs-string">'kmem:*alloc*'</span></span> true <span class="hljs-number"><span class="hljs-number">2</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">1</span></span> | wc <span class="hljs-literal"><span class="hljs-literal">-l</span></span> <span class="hljs-number"><span class="hljs-number">94</span></span></code> </pre> <br><p>  Procfs cr√©e 600 fois plus d'objets que task_diag.  C'est l'une des raisons pour lesquelles procfs fonctionne si mal lorsque la charge m√©moire est lourde.  Il convient donc au moins de l'optimiser. </p><br><p>  Nous esp√©rons que l'article attirera plus de d√©veloppeurs pour optimiser l'√©tat procfs du sous-syst√®me du noyau. </p><br><p>  Un grand merci √† David Ahern, Andy Lutomirski, Stephen Hemming, Oleg Nesterov, W. Trevor King, Arnd Bergmann, Eric W. Biederman et bien d'autres qui ont aid√© √† d√©velopper et √† am√©liorer l'interface task_diag. </p><br><p>  Merci √† <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">cromer</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=" class="user_link">k001</a> et Stanislav Kinsbursky pour l'aide √† la r√©daction de cet article. </p><br><h1 id="ssylki">  Les r√©f√©rences </h1><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://github.com/avagin/linux-task-diag/tree/v4.16-task-diag-20180427/tools/testing/selftests/task_diag</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://lwn.net/Articles/685791/</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.slideshare.net/KirKolyshkin/time-to-rethink-proc</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://www.slideshare.net/kolyshkin/speeding-up-ps-and-top</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">https://blog.linuxplumbersconf.org/2016/ocw/system/presentations/4599/original/Netlink-issues.pdf</a> </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr418715/">https://habr.com/ru/post/fr418715/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr418705/index.html">Les bases de Futex</a></li>
<li><a href="../fr418707/index.html">KDispatcher - Eventbus l√©ger et pratique pour une utilisation quotidienne</a></li>
<li><a href="../fr418709/index.html">Besoin de vous forcer: pilotes et barri√®res d'interface</a></li>
<li><a href="../fr418711/index.html">Registres g√©r√©s par jeton 1.0</a></li>
<li><a href="../fr418713/index.html">Jeu pour am√©liorer la qualit√© de Wikipedia</a></li>
<li><a href="../fr418717/index.html">Fant√¥mes Unicode</a></li>
<li><a href="../fr418721/index.html">L√©gendes de l'ing√©nierie des virus: le d√©but de la guerre</a></li>
<li><a href="../fr418723/index.html">Patch AndroidX</a></li>
<li><a href="../fr418725/index.html">Constante magique</a></li>
<li><a href="../fr418727/index.html">O√π et comment entrer dans les int√©grations de graphiques</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>