<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>💙 🙋🏻 😜 Ketika variabel lingkungan mempercepat proses hingga 40 kali 🔘 🎵 🕤</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hari ini kami ingin berbicara tentang beberapa pembaruan terbaru dari sistem Sherlock [ini adalah cluster berkinerja tinggi di Universitas Stanford - ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Ketika variabel lingkungan mempercepat proses hingga 40 kali</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/450806/">  Hari ini kami ingin berbicara tentang beberapa pembaruan terbaru dari sistem Sherlock [ini adalah cluster berkinerja tinggi di Universitas Stanford - kira-kira.  per.], yang sangat mempercepat daftar file dalam direktori dengan sejumlah besar entri. <br><br><blockquote>  Tidak seperti artikel biasa, ini lebih merupakan laporan orang dalam tentang bagaimana pekerjaan reguler pada Sherlock berlangsung untuk mempertahankannya dengan cara terbaik untuk pengguna kami.  Kami berharap dapat menerbitkan lebih banyak artikel seperti itu di masa mendatang. </blockquote><br><h1>  Mendaftarkan banyak file membutuhkan waktu </h1><br>  Semuanya dimulai dengan pertanyaan dukungan teknis dari pengguna.  Dia melaporkan masalah bahwa menjalankan <code>ls</code> membutuhkan waktu beberapa menit dalam direktori dengan lebih dari 15.000 entri dalam <code>$SCRATCH</code> [direktori untuk file sementara - kira-kira.  trans.]. <br><a name="habracut"></a><br>  Ribuan file dalam satu direktori biasanya membuat kesulitan untuk sistem file dan ini jelas tidak dianjurkan.  Pengguna tahu ini dan mengakui bahwa itu tidak baik, tetapi menyebutkan bahwa daftar di laptop-nya 1000 kali lebih cepat daripada di Sherlock.  Tentu saja, itu menghantam kita.  Karena itu, kami melihat lebih dalam. <br><br><h1>  Karena dia terlihat cantik </h1><br>  Kami melihat apa yang sebenarnya dilakukan ketika mendaftar direktori, dan mengapa prosesnya begitu lama.  Pada kebanyakan distribusi modern, <code>ls</code> default ke <code>ls --color=auto</code> , karena semua orang suka warna. <br><br>  Tetapi warna-warna indah memiliki harga: untuk setiap file, <code>ls</code> perlu mendapatkan informasi tentang jenis file, izinnya, bendera, atribut lanjutan, dan sejenisnya, untuk memilih warna yang sesuai. <br><br>  Salah satu solusi sederhana untuk masalah ini adalah menonaktifkan warna secara bersamaan, tetapi bayangkan kemarahan pengguna.  Dalam kasus apa pun Anda tidak dapat mengambil output warna, kami bukan monster. <br><br>  Karena itu, kami melihat lebih dalam.  <code>ls</code> mewarnai entri melalui <code>LS_COLORS</code> lingkungan <code>LS_COLORS</code> , yang <code>dircolors(1)</code> ditetapkan berdasarkan pada file konfigurasi <code>dir_colors(5)</code> .  Ya, yang <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dapat dieksekusi membaca file konfigurasi untuk membuat variabel lingkungan yang kemudian digunakan ls</a> (dan jika Anda tidak tahu tentang file <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">pintu</a> (lakukan), maka dir_colors <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">akan berfungsi</a> , apa pun yang terjadi). <br><br><h1>  Kami akan mengerti lebih detail </h1><br>  Untuk menentukan skema pewarnaan mana yang menyebabkan pelambatan, kami membuat lingkungan eksperimental: <br><br><pre> <code class="plaintext hljs">$ mkdir $SCRATCH/dont $ touch $SCRATCH/dont/{1..10000} # don't try this at home! $ time ls --color=always $SCRATCH/dont | wc -l 10000 real 0m12.758s user 0m0.104s sys 0m0.699s</code> </pre> <br>  <b>12,7 detik untuk 10.000 file, tidak terlalu bagus.</b> <br><blockquote>  Ngomong-ngomong, kita memerlukan flag <code>--color=always</code> : meskipun berubah menjadi <code>ls --color=auto</code> , tetapi <code>ls</code> mendeteksi ketika tidak terhubung ke terminal (misalnya, melalui saluran atau dengan redirection output) dan menonaktifkan pewarnaan jika diatur ke <code>auto</code> .  Pria pintar. </blockquote>  Jadi, apa yang begitu lama?  Kami melihat dengan <code>strace</code> : <br><br><pre> <code class="plaintext hljs">$ strace -c ls --color=always $SCRATCH/dont | wc -l 10000 % time seconds usecs/call calls errors syscall ------ ----------- ----------- --------- --------- ---------------- 44.21 0.186617 19 10000 lstat 42.60 0.179807 18 10000 10000 getxattr 12.19 0.051438 5 10000 capget 0.71 0.003002 38 80 getdents 0.07 0.000305 10 30 mmap 0.05 0.000217 12 18 mprotect 0.03 0.000135 14 10 read 0.03 0.000123 11 11 open 0.02 0.000082 6 14 close [...]</code> </pre> <br>  Wow: 10.000 panggilan ke <code>lstat()</code> , 10.000 panggilan ke <code>getxattr()</code> (yang semua orang gagal karena di lingkungan kita tidak ada atribut yang <code>capget()</code> ), 10.000 panggilan untuk <code>capget()</code> . <br><br>  Tentunya ini bisa dioptimalkan. <br><br><h1>  Atribut kemampuan  Tidak </h1><br>  Mengikuti saran <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">bug 10 tahun yang lalu</a> , kami mencoba untuk menonaktifkan pemeriksaan atribut <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kemampuan</a> : <br><br><pre> <code class="plaintext hljs">$ eval $(dircolors -b | sed s/ca=[^:]*:/ca=:/) $ time strace -c ls --color=always $SCRATCH/dont | wc -l 10000 % time seconds usecs/call calls errors syscall ------ ----------- ----------- --------- --------- ---------------- 98.95 0.423443 42 10000 lstat 0.78 0.003353 42 80 getdents 0.04 0.000188 10 18 mprotect 0.04 0.000181 6 30 mmap 0.02 0.000085 9 10 read 0.02 0.000084 28 3 mremap 0.02 0.000077 7 11 open 0.02 0.000066 5 14 close [...] ------ ----------- ----------- --------- --------- ---------------- 100.00 0.427920 10221 6 total real 0m8.160s user 0m0.115s sys 0m0.961s</code> </pre> <br>  Wow, akselerasi hingga 8 detik!  Kami menyingkirkan semua panggilan <code>getxattr()</code> mahal ini, dan panggilan <code>capget()</code> juga menghilang, bagus. <br><br>  Tapi tetap saja panggilan yang mengganggu ini ke <code>lstat()</code> tetap, meskipun ... <br><br><h1>  Berapa banyak bunga yang kamu butuhkan? </h1><br>  Karenanya, kami memeriksa <code>LS_COLORS</code> secara lebih rinci. <br><br>  Pertama, mereka cukup mematikan variabel ini: <br><br><pre>  $ echo $ LS_COLORS
 rs = 0: di = 01; 34: ln = 01; 36: mh = 00: pi = 40; 33: so = 01; 35: do = 01; 35: bd = 40; 33; 01: cd = 40; 33; 01: atau = 40; 31; 01: su = 37; 41: sg = 30; 43: ca =: tw = 30; 42: ow = 34; 42: st = 37; 44: ex = 01; 32 : *. tar = 01; 31: *. tgz = 01; 31: *. arc = 01; 31: *. arj = 01; 31: *. taz = 01; 31: *. lha = 01; 31: * .lz4 = 01; 31: *. lzh = 01; 31: *. lzma = 01; 31: *. tlz = 01; 31: *. txz = 01; 31: *. tzo = 01; 31: *. t7z = 01; 31: *. Zip = 01; 31: *. Z = 01; 31: *. Z = 01; 31: *. Dz = 01; 31: *. Gz = 01; 31: *. Lrz = 01 ; 31: *. Lz = 01; 31: *. Lzo = 01; 31: *. Xz = 01; 31: *. Bz2 = 01; 31: *. Bz = 01; 31: *. Tbz = 01; 31 : *. tbz2 = 01; 31: *. tz = 01; 31: *. deb = 01; 31: *. rpm = 01; 31: *. jar = 01; 31: *. war = 01; 31: * .tahun = 01; 31: *. sar = 01; 31: *. rar = 01; 31: *. alz = 01; 31: * .ce = 01; 31: *. kebun binatang = 01; 31: *. cpio = 01; 31: *. 7z = 01; 31: *. Rz = 01; 31: *. Cab = 01; 31: *. Jpg = 01; 35: *. Jpeg = 01; 35: *. Gif = 01 ; 35: *. Bmp = 01; 35: *. Pbm = 01; 35: *. Pgm = 01; 35: *. Ppm = 01; 35: *. Tga = 01; 35: *. Xbm = 01; 35 : *. xpm = 01; 35: *. tif = 01; 35: *. tiff = 01; 35: *. png = 01; 35: *. svg = 01; 35: *. svgz = 01; 35: * .mng = 01; 35: *. pcx = 01; 35: *. mov = 01; 35: *. mpg = 01; 35: *. mpeg = 01; 35: *. m2v = 01; 35: *. mkv = 01; 35: *. Webm = 01; 35: *. Ogm = 01; 35: *. Mp4 = 01; 35: *. M4v = 01; 35: *. Mp4v = 01; 35: *. Vob = 01 ; 35: *. Qt = 01; 35: *. Nuv = 01; 35: *.  wmv = 01; 35: *. asf = 01; 35: *. rm = 01; 35: *. rmvb = 01; 35: *. flc = 01; 35: *. avi = 01; 35: *. fli = 01; 35: *. Flv = 01; 35: *. Gl = 01; 35: *. Dl = 01; 35: *. Xcf = 01; 35: *. Xwd = 01; 35: *. Yuv = 01; 35: *. Cgm = 01; 35: *. Emf = 01; 35: *. Axv = 01; 35: *. Anx = 01; 35: *. Ogv = 01; 35: *. Ogx = 01; 35: * .aac = 00; 36: *. au = 00; 36: *. flac = 00; 36: *. mid = 00; 36: *. midi = 00; 36: *. mka = 00; 36: *. mp3 = 00; 36: *. mpc = 00; 36: *. ogg = 00; 36: *. ra = 00; 36: *. wav = 00; 36: *. axa = 00; 36: *. oga = 00; 36: *. Spx = 00; 36: *. Xspf = 00; 36:
 $ batalkan LS_COLORS
 $ echo $ LS_COLORS

 $ time ls --color = selalu $ SCRATCH / dont |  wc -l
 10.000

 0m13.037s nyata
 pengguna 0m0.077s
 sys 0m1.092s </pre><br>  Apa!?!  Masih 13 detik? <br><br>  Ternyata ketika <code>LS_COLORS</code> lingkungan <code>LS_COLORS</code> tidak didefinisikan atau jika hanya salah satu elemennya <code>&lt;type&gt;=color:</code> ada, ia menggunakan basis data bawaan secara default dan masih menggunakan warna.  Oleh karena itu, jika Anda ingin menonaktifkan pewarnaan untuk jenis file tertentu, Anda harus <code>DIR_COLORS</code> dengan <code>&lt;type&gt;=:</code> atau <code>&lt;type&gt; 00</code> dalam file <code>DIR_COLORS</code> . <br><br>  Setelah banyak percobaan dan kesalahan, kami mempersempit pencarian kami untuk ini: <br><br><pre> <code class="plaintext hljs">EXEC 00 SETUID 00 SETGID 00 CAPABILITY 00</code> </pre> <br>  apa yang tertulis sebagai <br><br><pre> <code class="plaintext hljs">LS_COLORS='ex=00:su=00:sg=00:ca=00:'</code> </pre> <br>  Ini berarti: jangan mewarnai file dengan <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">kapabilitas</a> atrubut, atau oleh bit <code><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">setuid/setgid</a></code> , atau oleh <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;pto=nl&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">flag yang dapat dieksekusi</a> . <br><br><h1>  Mempercepat <code>ls</code> </h1><br>  Dan jika Anda tidak melakukan pemeriksaan ini, maka panggilan ke <code>lstat()</code> menghilang, dan sekarang masalah yang sama sekali berbeda: <br><br><pre> <code class="plaintext hljs">$ export LS_COLORS='ex=00:su=00:sg=00:ca=00:' $ time strace -c ls --color=always $SCRATCH/dont | wc -l 10000 % time seconds usecs/call calls errors syscall ------ ----------- ----------- --------- --------- ---------------- 63.02 0.002865 36 80 getdents 8.10 0.000368 12 30 mmap 5.72 0.000260 14 18 mprotect 3.72 0.000169 15 11 open 2.79 0.000127 13 10 read [...] ------ ----------- ----------- --------- --------- ---------------- 100.00 0.004546 221 6 total real 0m0.337s user 0m0.032s sys 0m0.029s</code> </pre> <br>  0,3 detik pada daftar 10.000 file, sebuah catatan. <br><br><h1>  Konfigurasikan Sherlock </h1><br>  Dari 13 detik dengan pengaturan default menjadi 0,3 detik dengan pengaturan kecil <code>LS_COLORS</code> berarti akselerasi 40 kali lipat karena kurangnya file <code>setuid</code> / <code>setgid</code> dan berwarna yang dapat dieksekusi.  Bukan kerugian besar. <br><br>  Tentu saja, sekarang ini dikonfigurasi di Sherlock untuk setiap pengguna. <br><br>  Tetapi jika Anda ingin mengembalikan pewarnaan, Anda bisa kembali ke pengaturan default: <br><br><pre> <code class="plaintext hljs">$ unset LS_COLORS</code> </pre> <br>  Tetapi kemudian pada direktori dengan sejumlah besar file, pastikan untuk membuat kopi saat bekerja. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id450806/">https://habr.com/ru/post/id450806/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id450796/index.html">Bagaimana Tesla Mengajarkan Autopilot</a></li>
<li><a href="../id450798/index.html">Pembelajaran Mesin dalam Pengembangan Seluler: Prospek dan Desentralisasi</a></li>
<li><a href="../id450800/index.html">Pengembangan Layanan Mikro dengan BDD dan IOD</a></li>
<li><a href="../id450802/index.html">Pemadaman warisan</a></li>
<li><a href="../id450804/index.html">Pencetakan logam 3D di industri otomotif: mulai dari yang kecil</a></li>
<li><a href="../id450810/index.html">7 cara teratas untuk dengan cepat memeriksa kompetensi spesialis TI sebelum wawancara</a></li>
<li><a href="../id450812/index.html">PSR-14 - acara utama dalam PHP</a></li>
<li><a href="../id450814/index.html">Bagaimana BGP Bekerja</a></li>
<li><a href="../id450816/index.html">Tajuk HTTP untuk pengembang yang bertanggung jawab</a></li>
<li><a href="../id450818/index.html">Dari Latensi Ceph Tinggi ke Patch Kernel dengan eBPF / BCC</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>