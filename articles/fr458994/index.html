<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®‚Äçüë©‚Äçüë¶‚Äçüë¶ üî∫ üàÅ Raspberry Pi + CentOS = point d'acc√®s Wi-Fi (ou routeur Raspberry dans un chapeau rouge) üë®üèø‚Äçüè´ üîï üîê</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Il existe une multitude d'informations sur Internet sur la cr√©ation de points d'acc√®s Wi-Fi bas√©s sur un PC Raspberry √† carte unique. En r√®gle g√©n√©ral...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Raspberry Pi + CentOS = point d'acc√®s Wi-Fi (ou routeur Raspberry dans un chapeau rouge)</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/458994/"> Il existe une multitude d'informations sur Internet sur la cr√©ation de points d'acc√®s Wi-Fi bas√©s sur un PC Raspberry √† carte unique.  En r√®gle g√©n√©rale, cela implique l'utilisation du syst√®me d'exploitation natif pour Raspberry - Raspbian. <br><br>  √âtant un adepte des syst√®mes bas√©s sur RPM, je ne pouvais pas d√©passer ce petit miracle et ne pas essayer mon CentOS pr√©f√©r√© dessus. <br><br>  L'article fournit des instructions pour cr√©er un routeur Wi-Fi 5 GHz / CA √† partir du Raspberry Pi 3 mod√®le B + bas√© sur le syst√®me d'exploitation CentOS.  Il y aura plusieurs astuces standard, mais peu connues, et en bonus - un sch√©ma de connexion √† l'√©quipement Wi-Fi suppl√©mentaire ¬´framboise¬ª, lui permettant de fonctionner simultan√©ment dans plusieurs modes (2,4 + 5 GHz). <br><br><img src="https://habrastorage.org/webt/mp/yb/fz/mpybfz6gzojqkaftnuljhpzx5da.png" alt="image"><br>  <sub><i>(mix d'images en acc√®s libre)</i></sub> <br><a name="habracut"></a><br>  Nous notons imm√©diatement que certaines vitesses cosmiques ne fonctionneront pas.  Je serre un maximum de 100 Mbit hors de ma "framboise" sur les ondes, et cela couvre la vitesse de mon fournisseur Internet.  Pourquoi avons-nous besoin d'un AC aussi lent, si m√™me sur N, en th√©orie, vous pouvez obtenir un demi-gigaoctet?  Si vous avez pos√© cette question, alors allez au magasin pour un vrai routeur avec huit antennes externes. <br><br><h1>  0. Ce qui est n√©cessaire </h1><br><ul><li>  En fait, le ¬´produit framboise¬ª du calibre lui-m√™me: Pi 3 mod√®le B + (pour atteindre les vitesses et canaux convoit√©s de 5 GHz); <br></li><li>  MicroSD solide&gt; = 4 Go; <br></li><li>  Station de travail Linux avec lecteur / enregistreur microSD; <br></li><li>  La pr√©sence de comp√©tences suffisantes sous Linux, l'article est pour le Geek pr√©par√©; <br></li><li>  Connectivit√© au r√©seau c√¢bl√© (eth0) entre Raspberry et Linux, un serveur DHCP op√©rationnel sur le r√©seau local et acc√®s √† Internet √† partir des deux appareils. <br></li></ul><br>  Un petit commentaire sur le dernier point.  "Qu'est-ce qui est arriv√© en premier, un ≈ìuf ou ..." comment faire un routeur Wi-Fi en l'absence de tout √©quipement d'acc√®s √† Internet?  Laissons cet exercice divertissant en dehors de la port√©e de l'article et supposons simplement que Raspberry est connect√© au r√©seau local par fil et dispose d'un acc√®s Internet.  Dans ce cas, nous n'avons pas besoin d'un t√©l√©viseur suppl√©mentaire et d'un manipulateur pour configurer la framboise. <br><br><h1>  1. Installez CentOS </h1><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Page d'accueil du projet</a> <br><br>  Au moment d'√©crire ces lignes, la version de travail de CentOS sur l'appareil est de 32 bits.  Quelque part dans l'immensit√© du World Wide Web, je suis tomb√© sur des opinions concernant la d√©gradation des performances de ces syst√®mes d'exploitation sur l'architecture ARM 64 bits jusqu'√† 20%.  Je laisserai ce point sans commentaire. <br><br>  Sous Linux, t√©l√©chargez l'image minimale avec le noyau " <b>-RaspberryPI-</b> " et √©crivez-la sur microSD: <br><br><pre><code class="plaintext hljs"># xzcat CentOS-Userland-7-armv7hl-RaspberryPI-Minimal-1810-sda.raw.xz | \ dd of=/dev/mmcblk0 bs=4M # sync</code> </pre> <br>  Avant d'utiliser l'image, supprimez-en la section SWAP, d√©veloppez la racine sur tout le volume disponible et d√©barrassez-vous de SELinux.  L'algorithme est simple: nous faisons une copie de la racine sous Linux, supprimons toutes les partitions du microSD sauf la premi√®re (/ boot), cr√©ons une nouvelle racine et retournons son contenu √† partir de la copie. <br><br><div class="spoiler">  <b class="spoiler_title">Exemple d'actions n√©cessaires (sortie console s√©v√®re)</b> <div class="spoiler_text"><pre> <code class="plaintext hljs"># mount /dev/mmcblk0p3 /mnt # cd /mnt # tar cfz ~/pi.tgz . --no-selinux # cd # umount /mnt</code> </pre><br><pre> <code class="plaintext hljs"># parted /dev/mmcblk0 (parted) unit s (parted) print free Model: SD SC16G (sd/mmc) Disk /dev/mmcblk0: 31116288s Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags 63s 2047s 1985s Free Space 1 2048s 1370111s 1368064s primary fat32 boot, lba 2 1370112s 2369535s 999424s primary linux-swap(v1) 3 2369536s 5298175s 2928640s primary ext4 5298176s 31116287s 25818112s Free Space (parted) rm 3 (parted) rm 2 (parted) print free Model: SD SC16G (sd/mmc) Disk /dev/mmcblk0: 31116288s Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags 63s 2047s 1985s Free Space 1 2048s 1370111s 1368064s primary fat32 boot, lba 1370112s 31116287s 29746176s Free Space (parted) mkpart Partition type? primary/extended? primary File system type? [ext2]? ext4 Start? 1370112s End? 31116287s (parted) set Partition number? 2 Flag to Invert? lba New state? on/[off]? off (parted) print free Model: SD SC16G (sd/mmc) Disk /dev/mmcblk0: 31116288s Sector size (logical/physical): 512B/512B Partition Table: msdos Disk Flags: Number Start End Size Type File system Flags 63s 2047s 1985s Free Space 1 2048s 1370111s 1368064s primary fat32 boot, lba 2 1370112s 31116287s 29746176s primary ext4 (parted) quit</code> </pre><br><pre> <code class="plaintext hljs"># mkfs.ext4 /dev/mmcblk0p2 mke2fs 1.44.6 (5-Mar-2019) /dev/mmcblk0p2 contains a swap file system labelled '_swap' Proceed anyway? (y,N) y Discarding device blocks: done Creating filesystem with 3718272 4k blocks and 930240 inodes Filesystem UUID: 6a1a0694-8196-4724-a58d-edde1f189b31 Superblock backups stored on blocks: 32768, 98304, 163840, 229376, 294912, 819200, 884736, 1605632, 2654208 Allocating group tables: done Writing inode tables: done Creating journal (16384 blocks): done Writing superblocks and filesystem accounting information: done # mount /dev/mmcblk0p2 /mnt # tar xfz ~/pi.tgz -C /mnt --no-selinux</code> </pre><br>  Apr√®s avoir d√©ball√© le contenu de la partition racine, il est temps d'y apporter quelques modifications. <br><br>  D√©sactivez SELinux dans <b>/ mnt / etc / selinux / config</b> : <br><br><pre> <code class="plaintext hljs">SELINUX=disabled</code> </pre><br>  Nous √©ditons <b>/ mnt / etc / fstab</b> , ne laissant que deux entr√©es de partition: boot (/ boot, inchang√©) et root (changez la valeur UUID, qui peut √™tre trouv√©e en examinant la sortie de la commande blkid sous Linux): <br><br><pre> <code class="plaintext hljs">UUID=6a1a0694-8196-4724-a58d-edde1f189b31 / ext4 defaults,noatime 0 0 UUID=6938-F4F2 /boot vfat defaults,noatime 0 0</code> </pre><br>  Enfin, nous changeons les param√®tres de d√©marrage du noyau: sp√©cifiez le nouvel emplacement de la partition racine, d√©sactivez la sortie des informations de d√©bogage et (√©ventuellement) interdisez au noyau d'attribuer des adresses IPv6 sur les interfaces r√©seau: <br><br><pre> <code class="plaintext hljs"># cd # umount /mnt # mount /dev/mmcblk0p1 /mnt</code> </pre><br>  Nous <b>apportons le</b> contenu de <b>/mnt/cmdline.txt</b> au <b>format</b> suivant (une ligne sans c√©sure): <br><br><pre> <code class="plaintext hljs">root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline rootwait quiet ipv6.disable_ipv6=1</code> </pre><br>  Termin√©: <br><br><pre> <code class="plaintext hljs"># cd # umount /mnt # sync</code> </pre><br></div></div><br>  Nous r√©organisons la microSD dans le "Malinka", l'ex√©cutons et obtenons l'acc√®s au r√©seau via ssh (root / centos). <br><br><h1>  2. Configuration de CentOS </h1><br>  Les trois premiers mouvements in√©branlables: <b>passwd</b> , <b>mise √† jour yum -y</b> , <b>red√©marrage</b> . <br><br>  Nous <b>confions la</b> gestion du r√©seau √† <b>networkd</b> : <br><br><pre> <code class="plaintext hljs"># yum install systemd-networkd # systemctl enable systemd-networkd # systemctl disable NetworkManager # chkconfig network off</code> </pre><br>  Cr√©ez le fichier (avec les r√©pertoires) <b>/etc/systemd/network/eth0.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] Name=eth0 [Network] DHCP=ipv4</code> </pre><br>  Nous red√©marrons le "raspberry" et nous obtenons √† nouveau un acc√®s r√©seau via ssh (l'adresse IP peut changer).  Notez que <b>/etc/resolv.conf</b> , pr√©c√©demment cr√©√© par Network Manager, est utilis√©.  Par cons√©quent, en cas de probl√®mes de r√©solution, modifiez son contenu.  Nous n'utiliserons pas de <b>r√©solution syst√®me</b> . <br><br>  Nous supprimons le "superflu", r√©parons et acc√©l√©rons le chargement de l'OS: <br><br><pre> <code class="plaintext hljs"># systemctl set-default multi-user.target # yum remove GeoIP Network* aic* alsa* cloud-utils-growpart \ cronie* dhc* firewal* initscripts iwl* kexec* logrotate \ postfix rsyslog selinux-pol* teamd wpa_supplicant</code> </pre><br>  Qui a besoin de <b>cron</b> et qui ne dig√®re pas les <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">temporisateurs systemd</a> int√©gr√©s, peut installer les manquants.  <b>/ var / log -</b> et parcourez <b>journalctl</b> .  Si vous avez besoin d'un historique des journaux (par d√©faut, les informations ne sont stock√©es qu'au moment du d√©marrage du syst√®me): <br><br><pre> <code class="plaintext hljs"># mkdir /var/log/journal # systemd-tmpfiles --create --prefix /var/log/journal # systemctl restart systemd-journald # vi /etc/systemd/journald.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">D√©sactivez l'utilisation d'IPv6 par les services principaux (si n√©cessaire)</b> <div class="spoiler_text">  <b>/ etc / ssh / sshd_config</b> : <br><br><pre> <code class="plaintext hljs">AddressFamily inet</code> </pre><br>  <b>/ etc / sysconfig / chronyd</b> : <br><pre> <code class="plaintext hljs">OPTIONS="-4"</code> </pre><br></div></div><br>  La pertinence du temps sur la "framboise" est une chose importante.  √âtant donn√© que ¬´pr√™t √† l'emploi¬ª, il n'y a pas de capacit√© mat√©rielle pour enregistrer l'√©tat actuel de l'horloge lors du red√©marrage, vous avez besoin d'une synchronisation.  Un d√©mon tr√®s bon et rapide pour cela - <b>chrony</b> - est d√©j√† install√© et d√©marre automatiquement.  Vous pouvez changer les serveurs NTP au suivant. <br><br>  <b>/etc/chrony.conf</b> : <br><br><pre> <code class="plaintext hljs">server 0.ru.pool.ntp.org iburst server 1.ru.pool.ntp.org iburst server 2.ru.pool.ntp.org iburst server 3.ru.pool.ntp.org iburst</code> </pre><br>  Nous allons utiliser l' <b>astuce</b> pour d√©finir le fuseau horaire.  Notre objectif √©tant de cr√©er un routeur Wi-Fi fonctionnant √† des fr√©quences de 5 GHz, nous pr√©parerons √† l'avance les surprises <b>du r√©gulateur</b> : <br><blockquote>  # miam info crda <br>  R√©sum√©: d√©mon de conformit√© r√©glementaire pour les r√©seaux sans fil 802.11 <br></blockquote><br>  Cette conception malveillante, centr√©e, entre autres, sur le fuseau horaire, ¬´interdit¬ª l'utilisation (en Russie) de fr√©quences 5 GHz et de canaux √† ¬´grands¬ª nombres.  L'astuce consiste √† d√©finir le fuseau horaire sans utiliser les noms du continent / de la ville, c'est-√†-dire au lieu de: <br><br><pre> <code class="plaintext hljs"># timedatectl set-timezone Europe/Moscow</code> </pre><br>  Presse: <br><br><pre> <code class="plaintext hljs"># timedatectl set-timezone Etc/GMT-3</code> </pre><br>  Et la touche finale dans la coiffure du syst√®me: <br><br><pre> <code class="plaintext hljs"># hostnamectl set-hostname router</code> </pre><br>  <b>/root/.bash_profile</b> : <br><br><pre> <code class="plaintext hljs">. . . # User specific environment and startup programs export PROMPT_COMMAND="echo -n $(($(&lt;/sys/class/thermal/thermal_zone0/temp) / 1000))\'C\ " export LANG=en_US.UTF-8 export PATH=$PATH:$HOME/bin</code> </pre><br><h1>  3. Modules compl√©mentaires CentOS </h1><br>  Tout ce qui a √©t√© dit ci-dessus peut √™tre consid√©r√© comme des instructions compl√®tes pour l'installation du CentOS ¬´vanille¬ª sur le Raspberry Pi.  Vous devriez avoir un PC qui (re) d√©marre en moins de 10 secondes, utilise moins de 15 m√©gaoctets de RAM et 1,5 gigaoctets de microSD (en fait moins de 1 gigaoctet en raison de incomplet / boot, mais nous serons honn√™tes jusqu'√† la fin): <br><img src="https://habrastorage.org/webt/mu/0g/cf/mu0gcfyiokq0x_2dysrb1ieh0ke.jpeg"><br><br><img src="https://habrastorage.org/webt/xx/l3/_g/xxl3_gukovfw0zawwvvy8ua0dtw.jpeg"><br><br><img src="https://habrastorage.org/webt/wt/yc/-9/wtyc-9erdcdx-rvqnnjite7c9ru.jpeg"><br><br>  Pour installer le logiciel de point d'acc√®s Wi-Fi sur ce syst√®me, vous devrez √©tendre l√©g√®rement les capacit√©s de la distribution CentOS standard.  Tout d'abord, ¬´pompez¬ª le pilote (firmware) de l'adaptateur Wi-Fi int√©gr√©.  La page d'accueil du projet indique: <br><blockquote>  Wifi sur les Raspberry 3B et 3B + <br><br>  Les fichiers du firmware Raspberry PI 3B / 3B + ne sont pas autoris√©s √† √™tre distribu√©s par le projet CentOS.  Vous pouvez utiliser les articles suivants pour comprendre le probl√®me, obtenir le firmware et configurer le wifi. <br></blockquote><br>  Ce que le projet CentOS ne peut pas faire ne nous est pas interdit pour un usage personnel.  Nous rempla√ßons le firmware Wi-Fi de distribution dans CentOS par celui correspondant des d√©veloppeurs Broadcom (ces m√™mes blobs binaires d√©test√©s ...).  Cela, en particulier, permettra l'utilisation de l'AC en mode point d'acc√®s. <br><br><div class="spoiler">  <b class="spoiler_title">Mise √† niveau du firmware Wi-Fi</b> <div class="spoiler_text">  Nous d√©couvrons le mod√®le de l'appareil et la version actuelle du firmware: <br><br><pre> <code class="plaintext hljs"># journalctl | grep $(basename $(readlink /sys/class/net/wlan0/device/driver)) Jan 01 04:00:03 router kernel: brcmfmac: F1 signature read @0x18000000=0x15264345 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_fw_map_chip_to_name: using brcm/brcmfmac43455-sdio.bin for chip 0x004345(17221) rev 0x000006 Jan 01 04:00:03 router kernel: usbcore: registered new interface driver brcmfmac Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: Firmware version = wl0: Mar 1 2015 07:29:38 version 7.45.18 (r538002) FWID 01-6a2c8ad4 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: CLM version = API: 12.2 Data: 7.14.8 Compiler: 1.24.9 ClmImport: 1.24.9 Creation: 2014-09-02 03:05:33 Inc Data: 7.17.1 Inc Compiler: 1.26.11 Inc ClmImport: 1.26.11 Creation: 2015-03-01 07:22:34</code> </pre><br>  Nous voyons que la version du micrologiciel est 7.45.18 dat√©e du 03/01/2015, et nous nous souvenons de l'ensemble de nombres suivant: <b>43455</b> (brcmfmac43455-sdio.bin). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">T√©l√©chargez l'image actuelle de Raspbian</a> .  Les paresseux peuvent √©crire l'image sur microSD et √† partir de l√†, r√©cup√©rer les fichiers avec le firmware.  Et vous pouvez monter la partition racine de l'image sous Linux et copier celle dont vous avez besoin √† partir de l√†: <br><br><pre> <code class="plaintext hljs"># wget https://downloads.raspberrypi.org/raspbian_lite_latest # unzip -p raspbian_lite_latest &gt; raspbian.img # fdisk -l raspbian.img Disk raspbian.img: 2 GiB, 2197815296 bytes, 4292608 sectors Units: sectors of 1 * 512 = 512 bytes Sector size (logical/physical): 512 bytes / 512 bytes I/O size (minimum/optimal): 512 bytes / 512 bytes Disklabel type: dos Disk identifier: 0x17869b7d Device Boot Start End Sectors Size Id Type raspbian.img1 8192 532480 524289 256M c W95 FAT32 (LBA) raspbian.img2 540672 4292607 3751936 1.8G 83 Linux # mount -t ext4 -o loop,offset=$((540672 * 512)) raspbian.img /mnt # cp -fv /mnt/lib/firmware/brcm/*43455* ... '/mnt/lib/firmware/brcm/brcmfmac43455-sdio.bin' -&gt; ... '/mnt/lib/firmware/brcm/brcmfmac43455-sdio.clm_blob' -&gt; ... '/mnt/lib/firmware/brcm/brcmfmac43455-sdio.txt' -&gt; ... # umount /mnt</code> </pre><br>  Les fichiers de micrologiciel r√©sultants pour l'adaptateur Wi-Fi doivent √™tre copi√©s avec le remplacement de "framboise" dans le r√©pertoire <b>/ usr / lib / firmware / brcm /</b> <br><br>  On red√©marre le futur routeur et on sourit plut√¥t: <br><br><pre> <code class="plaintext hljs"># journalctl | grep $(basename $(readlink /sys/class/net/wlan0/device/driver)) Jan 01 04:00:03 router kernel: brcmfmac: F1 signature read @0x18000000=0x15264345 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_fw_map_chip_to_name: using brcm/brcmfmac43455-sdio.bin for chip 0x004345(17221) rev 0x000006 Jan 01 04:00:03 router kernel: usbcore: registered new interface driver brcmfmac Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: Firmware version = wl0: Feb 27 2018 03:15:32 version 7.45.154 (r684107 CY) FWID 01-4fbe0b04 Jan 01 04:00:03 router kernel: brcmfmac: brcmf_c_preinit_dcmds: CLM version = API: 12.2 Data: 9.10.105 Compiler: 1.29.4 ClmImport: 1.36.3 Creation: 2018-03-09 18:56:28</code> </pre><br>  Version: 7.45.154 √† partir du 27.02.2018. <br></div></div><br>  Et bien s√ªr EPEL: <br><br><pre> <code class="plaintext hljs"># cat &gt; /etc/yum.repos.d/epel.repo &lt;&lt; EOF [epel] name=Epel rebuild for armhfp baseurl=https://armv7.dev.centos.org/repodir/epel-pass-1/ enabled=1 gpgcheck=0 EOF # yum clean all # rm -rfv /var/cache/yum # yum update</code> </pre><br><h1>  4. Configuration du r√©seau et d√©fis √† venir </h1><br>  Comme nous l'avons convenu ci-dessus, le "Malinka" est connect√© par un "fil" au r√©seau local.  Supposons qu'un fournisseur fournisse un acc√®s Internet exactement de la m√™me mani√®re: une adresse sur un r√©seau public est √©mise dynamiquement par un serveur DHCP (elle peut √™tre li√©e √† un MAC).  Dans ce cas, apr√®s la configuration finale de la "framboise", il suffit de "brancher" le c√¢ble fournisseur et tout est pr√™t.  L'autorisation utilisant <b>systemd-networkd</b> fait l'objet d'un article s√©par√© et n'est pas consid√©r√©e ici. <br><br>  Les interfaces Wi-Fi de Raspberry sont un r√©seau local et l'adaptateur Ethernet int√©gr√© (eth0) est externe.  Nous num√©rotons le r√©seau local de mani√®re statique, par exemple: 192.168.0.0/24.  Adresse de Malinka: 192.168.0.1.  Dans un r√©seau externe (Internet), un serveur DHCP fonctionnera. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">Le probl√®me de l'uniformit√© des noms</a> et le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">c√©l√®bre programmeur guat√©malt√®que</a> sont deux probl√®mes qui attendent tous ceux qui sont impliqu√©s dans la configuration des interfaces r√©seau et des services dans les distributions systemd. <br><br><div class="spoiler">  <b class="spoiler_title">Chaos parall√®le (digression lyrique)</b> <div class="spoiler_text">  Lennart Pottering a tr√®s bien fait son programme <b>systemd</b> .  Ce <b>syst√®me</b> lance d'autres programmes si rapidement que, n'ayant pas r√©cup√©r√© du coup de sifflet de l'arbitre, ils tr√©buchent et tombent au d√©part sans m√™me commencer leur course d'obstacles. <br><br>  Mais s√©rieusement, la parall√©lisation agressive des processus lanc√©s au d√©but de l'OS systemd est une sorte de ¬´pont d'√¢ne¬ª pour les pilotes LSB s√©rie exp√©riment√©s.  Heureusement, ranger ce ¬´chaos parall√®le¬ª s'av√®re simple, bien que la v√©rit√© ne soit pas toujours √©vidente. <br></div></div><br>  Nous cr√©ons deux interfaces de pont virtuel avec des noms constants: <b>lan</b> et <b>wan</b> .  Nous allons ¬´connecter¬ª les adaptateurs Wi-Fi au premier, et eth0 de la ¬´framboise¬ª au second. <br><br>  <b>/etc/systemd/network/lan.netdev</b> : <br><br><pre> <code class="plaintext hljs">[NetDev] Name=lan Kind=bridge</code> </pre><br>  <b>/etc/systemd/network/lan.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] Name=lan [Network] Address=192.168.0.1/24 IPForward=yes</code> </pre><br>  <b>/etc/systemd/network/wan.netdev</b> : <br><br><pre> <code class="plaintext hljs">[NetDev] Name=wan Kind=bridge #MACAddress=xx:xx:xx:xx:xx:xx</code> </pre><br>  <b>/etc/systemd/network/wan.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] Name=wan [Network] DHCP=ipv4 IPForward=yes</code> </pre><br>  <b>IPForward = yes</b> √©limine le besoin de faire allusion au noyau via sysctl pour activer le routage. <br>  <b>MACAddress =</b> d√©commenter et modifier si n√©cessaire. <br><br>  Tout d'abord, nous connectons eth0.  N'oubliez pas le ¬´probl√®me d'uniformit√©¬ª et utilisez uniquement l'adresse MAC de cette interface, que vous pouvez d√©couvrir, par exemple, comme ceci: <br><br><pre> <code class="plaintext hljs"># cat /sys/class/net/eth0/address</code> </pre><br>  Cr√©ez <b>/etc/systemd/network/eth.network</b> : <br><br><pre> <code class="plaintext hljs">[Match] MACAddress=b8:27:eb:xx:xx:xx [Network] Bridge=wan</code> </pre><br>  Supprimez le fichier de configuration eth0 pr√©c√©dent, red√©marrez le "raspberry" et obtenez un acc√®s r√©seau √† celui-ci (l'adresse IP changera probablement): <br><br><pre> <code class="plaintext hljs"># rm -fv /etc/systemd/network/eth0.network # reboot</code> </pre><br><h1>  5. DNSMASQ </h1><br>  Pour la fabrication de points d'acc√®s Wi-Fi, rien de mieux qu'un <b>joli</b> couple de <b>dnsmasq</b> + <b>hostapd</b> n'a pas encore √©t√© invent√©.  √Ä mon avis. <br><br><div class="spoiler">  <b class="spoiler_title">Si quelqu'un a oubli√©, alors ...</b> <div class="spoiler_text">  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">hostapd</a> est une chose qui g√®re les adaptateurs Wi-Fi (en particulier, il prendra la peine de les connecter au r√©seau virtuel de la framboise), il autorise et enregistre les clients sans fil. <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">dnsmasq</a> - configure la pile r√©seau des clients: fournit des adresses IP, des serveurs DNS, une passerelle par d√©faut, etc. <br></div></div><br>  Nous commen√ßons par dnsmasq: <br><br><pre> <code class="plaintext hljs"># yum install dnsmasq</code> </pre><br>  Mod√®le <b>/etc/resolv.conf</b> : <br><br><pre> <code class="plaintext hljs">nameserver 1.1.1.1 nameserver 1.0.0.1 nameserver 8.8.8.8 nameserver 8.8.4.4 nameserver 77.88.8.8 nameserver 77.88.8.1 domain router.local search router.local</code> </pre><br>  √©ditez-le √† votre convenance. <br><br>  <b>/Etc/dnsmasq.conf</b> minimaliste: <br><br><pre> <code class="plaintext hljs">domain-needed bogus-priv interface=lan bind-dynamic expand-hosts domain=# dhcp-range=192.168.0.100,192.168.0.199,255.255.255.0,24h conf-dir=/etc/dnsmasq.d</code> </pre><br>  La ¬´magie¬ª ici est le param√®tre <b>bind-dynamic</b> , qui dit au d√©mon dnsmasq d'attendre que <b>interface = lan</b> apparaisse dans le syst√®me, et de ne pas s'√©vanouir d'une attaque de fi√®re solitude apr√®s le d√©marrage. <br><br><pre> <code class="plaintext hljs"># systemctl enable dnsmasq # systemctl start dnsmasq; journalctl -f</code> </pre><br><h1>  6. HOSTAPD </h1><br>  Enfin, les configurations magic hostapd.  Je ne doute pas que quelqu'un lise cet article √† la recherche de ces lignes pr√©cieuses. <br><br>  Avant d'installer hostapd, vous devez g√©rer le ¬´probl√®me d'uniformit√©¬ª.  L'adaptateur Wi-Fi wlan0 int√©gr√© peut facilement changer son nom en wlan1 lors de la connexion d'√©quipements Wi-Fi USB suppl√©mentaires.  Par cons√©quent, nous fixerons les noms des interfaces de la mani√®re suivante: nous proposerons des noms uniques d'adaptateurs (sans fil) et les lierons aux adresses MAC. <br><br>  Pour l'adaptateur Wi-Fi int√©gr√©, qui est toujours wlan0: <br><br><pre> <code class="plaintext hljs"># cat /sys/class/net/wlan0/address b8:27:eb:xx:xx:xx</code> </pre><br>  Cr√©ez <b>/etc/systemd/network/wl0.link</b> : <br><br><pre> <code class="plaintext hljs">[Match] MACAddress=b8:27:eb:xx:xx:xx [Link] Name=wl0</code> </pre><br>  Nous allons maintenant √™tre s√ªrs que <b>wl0</b> est le Wi-Fi int√©gr√©.  On red√©marre la "framboise" pour voir √ßa. <br><br>  Installer: <br><br><pre> <code class="plaintext hljs"># yum install hostapd wireless-tools</code> </pre><br>  Fichier de configuration <b>/etc/hostapd/hostapd.conf</b> : <br><br><pre> <code class="plaintext hljs">ssid=rpi wpa_passphrase=1234567890 channel=36 country_code=US interface=wl0 bridge=lan driver=nl80211 auth_algs=1 wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP macaddr_acl=0 hw_mode=a wmm_enabled=1 # N ieee80211n=1 require_ht=1 ht_capab=[MAX-AMSDU-3839][HT40+][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40] # AC ieee80211ac=1 require_vht=1 ieee80211d=0 ieee80211h=0 vht_capab=[MAX-AMSDU-3839][SHORT-GI-80] vht_oper_chwidth=1 vht_oper_centr_freq_seg0_idx=42</code> </pre><br>  Sans oublier le <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=fr&amp;u=">GKChP</a> pendant une minute, nous modifions les param√®tres dont nous avons besoin et v√©rifions manuellement les performances: <br><br><pre> <code class="plaintext hljs"># hostapd /etc/hostapd/hostapd.conf</code> </pre><br>  hostapd d√©marrera de mani√®re interactive, traduisant son √©tat dans la console.  S'il n'y a pas d'erreur, les clients qui prennent en charge le mode AC peuvent d√©j√† √™tre connect√©s au point d'acc√®s.  Pour arr√™ter hostapd - Ctrl-C. <br><br>  Il reste √† inclure hostapd dans le d√©marrage du syst√®me.  Si vous agissez normalement (systemctl enable hostapd), alors apr√®s le prochain red√©marrage, vous pouvez obtenir un "d√©mon dans le sang" d'un d√©mon avec un diagnostic de " <b>interface wl0 introuvable</b> ".  √Ä la suite du ¬´chaos parall√®le¬ª, hostapd s'est termin√© plus rapidement que le noyau n'a trouv√© d'adaptateur sans fil. <br><br>  Internet regorge de rem√®des: du timeout forc√© avant le d√©marrage du d√©mon (pendant quelques minutes), √† un autre d√©mon qui surveille l'apparence de l'interface et (re) d√©marre le pad h√¥te.  Les solutions fonctionnent bien, mais terriblement laides.  Nous appelons √† l'aide le grand <b>systemd</b> avec ses "objectifs" et " <s>t√¢ches</s> " "d√©pendances". <br><br>  Copiez le fichier du service de distribution dans <b>/etc/systemd/system/hostapd.service</b> : <br><br><pre> <code class="plaintext hljs"># cp -fv /usr/lib/systemd/system/hostapd.service /etc/systemd/system</code> </pre><br>  et apporter son contenu sous la forme suivante: <br><br><pre> <code class="plaintext hljs">[Unit] Description=Hostapd IEEE 802.11 AP, IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator After=sys-subsystem-net-devices-wl0.device BindsTo=sys-subsystem-net-devices-wl0.device [Service] Type=forking PIDFile=/run/hostapd.pid ExecStart=/usr/sbin/hostapd /etc/hostapd/hostapd.conf -P /run/hostapd.pid -B [Install] WantedBy=sys-subsystem-net-devices-wl0.device</code> </pre><br>  La magie du fichier de service mis √† jour est de lier dynamiquement hostapd √† une nouvelle cible - l'interface wl0.  Lorsque l'interface appara√Æt, le d√©mon d√©marre; lorsqu'il dispara√Æt, il s'arr√™te.  Et tout est en ligne - sans red√©marrer le syst√®me.  Cette technique sera particuli√®rement utile lors de la connexion √† l'adaptateur Wi-Fi USB "framboise". <br><br>  Vous pouvez maintenant: <br><br><pre> <code class="plaintext hljs"># systemctl enable hostapd # reboot</code> </pre><br><h1>  7. IPTABLES </h1><br>  "Shta ???"  ¬© Oui, oui!  Pas de <b>systemd</b> .  Aucune nouvelle combinaison (sous forme de <b>pare</b> - <b>feu</b> ), qui fait finalement la m√™me chose. <br><br>  Nous utilisons les bons vieux <b>iptables</b> , dont les services, apr√®s leur d√©marrage, t√©l√©chargeront les r√®gles du r√©seau dans le noyau et s'arr√™teront tranquillement sans rester r√©sidents et sans consommer de ressources.  Systemd a une √©l√©gante <b>IPMasquerade =</b> , mais nous confierons toujours √† iptables la traduction d'adresses (NAT) et le pare-feu. <br><br>  Installer: <br><br><pre> <code class="plaintext hljs"># yum install iptables-services # systemctl enable iptables ip6tables</code> </pre><br>  Je pr√©f√®re stocker la configuration iptables sous forme de script (exemple): <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # # Disable IPv6 # ip6tables --flush ip6tables --delete-chain ip6tables --policy INPUT DROP ip6tables --policy FORWARD DROP ip6tables --policy OUTPUT DROP ip6tables-save &gt; /etc/sysconfig/ip6tables systemctl restart ip6tables # # Cleaning # iptables -F iptables -X iptables -t nat -F iptables -t nat -X iptables -t mangle -F iptables -t mangle -X iptables -P INPUT DROP iptables -P OUTPUT ACCEPT iptables -P FORWARD ACCEPT # # Loopback, lan # iptables -A INPUT -i lo -j ACCEPT iptables -A INPUT -i lan -j ACCEPT # # Ping, Established # iptables -A INPUT -p icmp --icmp-type echo-request -j ACCEPT iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT # # NAT # iptables -t nat -A POSTROUTING -o wan -j MASQUERADE # # Saving # iptables-save &gt; /etc/sysconfig/iptables systemctl restart iptables</span></span></code> </pre><br>  Nous ex√©cutons le script ci-dessus et perdons la possibilit√© d'√©tablir de nouvelles connexions ssh c√¢bl√©es avec le "Malinka".  C'est vrai, nous avons cr√©√© un routeur Wi-Fi, dont l'acc√®s "via Internet" est par d√©faut interdit - d√©sormais uniquement "par voie a√©rienne".  Nous connectons le c√¢ble du fournisseur √† Ethernet et commen√ßons √† surfer! <br><br><h1>  8. Bonus: + 2,4 GHz </h1><br>  Lorsque j'ai assembl√© le premier routeur Raspberry selon le dessin d√©crit ci-dessus, j'ai trouv√© dans mon m√©nage un certain nombre de gadgets qui, en raison de leurs limites de conception, le Wi-Fi ne pouvait pas voir du tout la "framboise".  Reconfigurer le routeur pour qu'il fonctionne en 802.11b / g / n √©tait antisportif, car la vitesse maximale "over the air" dans ce cas ne d√©passait pas 40 Mbps, et mon fournisseur Internet pr√©f√©r√© m'en propose 100 (via le c√¢ble). <br><br>  En fait, une solution au probl√®me a d√©j√† √©t√© invent√©e: une deuxi√®me interface Wi-Fi fonctionnant √† 2,4 GHz, et un deuxi√®me point d'acc√®s.  Dans l'√©tal le plus proche, j'ai achet√© non pas le premier, mais le deuxi√®me ¬´sifflet¬ª Wi-Fi USB qui m'est venu.  Le vendeur a √©t√© tourment√© par des questions sur le chipset, la compatibilit√© avec les c≈ìurs Linux ARM et la possibilit√© de travailler en mode AP (il a d'abord commenc√©). <br><br>  Nous configurons le "sifflet" par analogie avec l'adaptateur Wi-Fi int√©gr√©. <br><br>  Tout d'abord, renommez-le en <b>wl1</b> : <br><br><pre> <code class="plaintext hljs"># cat /sys/class/net/wlan0/address b0:6e:bf:xx:xx:xx</code> </pre><br>  <b>/etc/systemd/network/wl1.link</b> : <br><br><pre> <code class="plaintext hljs">[Match] MACAddress=b0:6e:bf:xx:xx:xx [Link] Name=wl1</code> </pre><br>  Nous confierons la gestion de la nouvelle interface Wi-Fi √† un d√©mon hostapd distinct, qui d√©marrera et s'arr√™tera en fonction de la pr√©sence d'un ¬´sifflet¬ª strictement d√©fini dans le syst√®me: wl1. <br><br>  Fichier de configuration <b>/etc/hostapd/hostapd2.conf</b> : <br><br><pre> <code class="plaintext hljs">ssid=rpi2 wpa_passphrase=1234567890 #channel=1 #channel=6 channel=11 interface=wl1 bridge=lan driver=nl80211 auth_algs=1 wpa=2 wpa_key_mgmt=WPA-PSK rsn_pairwise=CCMP macaddr_acl=0 hw_mode=g wmm_enabled=1 # N ieee80211n=1 require_ht=1 ht_capab=[HT40][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40]</code> </pre><br>  Le contenu de ce fichier d√©pend directement du mod√®le de l'adaptateur USB Wi-Fi, donc un simple copier / coller peut vous d√©cevoir. <br><br>  Copiez le fichier du service de distribution dans <b>/etc/systemd/system/hostapd2.service</b> : <br><br><pre> <code class="plaintext hljs"># cp -fv /usr/lib/systemd/system/hostapd.service /etc/systemd/system/hostapd2.service</code> </pre><br>  et apporter son contenu sous la forme suivante: <br><br><pre> <code class="plaintext hljs">[Unit] Description=Hostapd IEEE 802.11 AP, IEEE 802.1X/WPA/WPA2/EAP/RADIUS Authenticator After=sys-subsystem-net-devices-wl1.device BindsTo=sys-subsystem-net-devices-wl1.device [Service] Type=forking PIDFile=/run/hostapd2.pid ExecStart=/usr/sbin/hostapd /etc/hostapd/hostapd2.conf -P /run/hostapd2.pid -B [Install] WantedBy=sys-subsystem-net-devices-wl1.device</code> </pre><br>  Il reste √† inclure une nouvelle instance de hostapd: <br><br><pre> <code class="plaintext hljs"># systemctl enable hostapd2</code> </pre><br>  C'est tout!  Tirez le sifflet et la framboise elle-m√™me, regardez les r√©seaux sans fil autour. <br><br>  Et enfin, je tiens √† mettre en garde contre la qualit√© de l'adaptateur USB Wi-Fi et de l'alimentation Raspberry.  Connect√© "√† un coup de sifflet chaud", il peut parfois provoquer un "coup de framboise" en raison de probl√®mes √©lectriques √† court terme. </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr458994/">https://habr.com/ru/post/fr458994/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr458984/index.html">Comment cr√©er la premi√®re application de trading sur la bourse: 3 √©tapes initiales</a></li>
<li><a href="../fr458986/index.html">Recettes PostgreSQL: Conversion de HTML et d'URL en PDF et PS</a></li>
<li><a href="../fr458988/index.html">Texturation, ou ce que vous devez savoir pour devenir un artiste de surface. Partie 4. Mod√®les, normales et balayage</a></li>
<li><a href="../fr458990/index.html">Arr√™tez de z√®le avec des commentaires dans le code</a></li>
<li><a href="../fr458992/index.html">Attention aux nuls et √† l'impl√©mentation dans Keras</a></li>
<li><a href="../fr458996/index.html">User Inyerface - comment ne pas tourmenter l'utilisateur</a></li>
<li><a href="../fr459000/index.html">Comment j'ai essay√© d'am√©liorer Halo 2, mais je l'ai presque ruin√©</a></li>
<li><a href="../fr459002/index.html">Comment configurer HTTPS - Le g√©n√©rateur de configuration SSL vous aidera</a></li>
<li><a href="../fr459004/index.html">Algorithme cryptographique Grasshopper: √† peu pr√®s le complexe</a></li>
<li><a href="../fr459012/index.html">Cr√©er une application pour Bitrix24 √† partir de z√©ro</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>