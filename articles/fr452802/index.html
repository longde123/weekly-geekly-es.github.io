<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üëåüèª ‚ú® üóúÔ∏è Comment connecter un script √† un site tiers üôéüèª üÄÑÔ∏è üëÑ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Bonjour, Habr! Ceci est le premier article de notre blog. Beaucoup de gens nous connaissent comme un chat pour le site, c'est avec lui que nous avons ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Comment connecter un script √† un site tiers</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/jivosite/blog/452802/">  Bonjour, Habr!  Ceci est le premier article de notre blog.  Beaucoup de gens nous connaissent comme un chat pour le site, c'est avec lui que nous avons commenc√©, et maintenant nous occupons des positions de leader dans le domaine des messagers d'affaires.  Nous sommes progressivement devenus une solution commerciale compl√®te qui offre de nombreuses opportunit√©s aux clients: rappel, communication avec les clients via des messageries instantan√©es, r√©seaux sociaux, applications mobiles, PBX virtuel, fonctions CRM et bien plus encore. <br><br>  Pendant plusieurs ann√©es, nous avons r√©solu avec succ√®s de nombreux probl√®mes techniques, accumul√© beaucoup de choses int√©ressantes et, √† certains endroits, une exp√©rience unique, bien s√ªr, a √©crit nos b√©quilles et nos v√©los.  Avec cet article, nous commen√ßons une s√©rie d'articles dans lesquels nous partagerons notre exp√©rience dans le d√©veloppement, la construction de processus dans une √©quipe compl√®tement distante, parler de notre architecture, des solutions techniques qui nous permettent de servir efficacement des centaines de milliers de clients √† travers le monde. <br><br><img src="https://habrastorage.org/webt/zp/bn/fv/zpbnfvc-9q274ie5wcyhvuo3pma.jpeg" alt="image"><br><br>  <b>Jivosite est aujourd'hui:</b> <br><br><ul><li>  250 000 clients dans le monde; </li><li>  150 millions d'impressions de widgets par jour; </li><li>  3,5 millions de messages par jour; </li><li>  10 millions de chats par mois; </li><li>  1M de connexions simultan√©es; </li><li>  250+ serveurs en production. </li></ul><br>  √âtant donn√© que la plupart des gens nous connaissent comme un chat pour un site, nous allons probablement commencer par celui-ci.  Dans cet article, nous allons montrer comment connecter votre code √† un site tiers et √† quoi vous devez pr√™ter attention en tant qu'exemple de nos nombreuses ann√©es d'exp√©rience dans le chat.  Cet article sera utile √† ceux qui envisagent ou d√©veloppent d√©j√† un service de plug-in, et simplement √† tous ceux qui s'int√©ressent √† ce sujet. <br><br><h3>  <font color="#00bf54">Point d'entr√©e</font> </h3><br>  Le th√©√¢tre commence par un cintre, et le service connect√© avec un code d'insertion.  C'est le point d'entr√©e de tout service ou module sur le site.  En r√®gle g√©n√©rale, il peut √™tre trouv√© dans les instructions d'installation, apr√®s quoi il est n√©cessaire de l'ajouter au code HTML du site, puis il y a la ¬´magie¬ª, qui charge et initialise le script d'une certaine mani√®re. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Il semblerait qu'il serait plus facile de connecter le script au site? <a name="habracut"></a>  Par d√©faut, il vous suffit d'ajouter une balise de script au code HTML de la page.  Mais en fait, c'est une √©tape importante, qui cache de nombreux pi√®ges.  Par exemple, identification de l'utilisateur, impl√©mentation d'un canal de chargement de script de sauvegarde, personnalisation de l'apparence ou de la logique, vitesse de chargement des pages, etc.  Mais parlons de tout dans l'ordre. <br><br><h3>  <font color="#00bf54">Identification</font> </h3><br>  Tout simplement parce qu'il n'est pas tr√®s int√©ressant pour quiconque de connecter un script, c'est s√ªr que le script ex√©cute une sorte de logique, et cette logique est li√©e √† l'utilisateur.  Par exemple, l'ID du compteur, APP_ID du r√©seau social, dans notre cas, c'est l'ID du canal de communication cr√©√©.  Autrement dit, le script doit identifier l'utilisateur dans les demandes adress√©es au serveur.  Pour identifier le client via le code d'insertion, il existe trois options d'impl√©mentation. <br><br>  <b>Option # 1</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Passez l'ID directement dans le lien vers le fichier et c√¥t√© serveur, d'une certaine mani√®re, jetez-le dans le script.  Dans ce cas, le serveur devra √©crire l'ID dans le fichier √† la vol√©e ou former une cha√Æne JS avec l'ID qui chargera file.js.  Cette logique est similaire √† l'impl√©mentation des requ√™tes JSONP. <br><br><img src="https://habrastorage.org/webt/e-/h5/ks/e-h5ks-gi2mnrck3jwkkogy9trk.png"><br>  Pendant longtemps, nous avons travaill√© sur ce principe, mais les inconv√©nients de cette approche sont que la charge ¬´inactive¬ª sur le serveur et la n√©cessit√© d'impl√©menter la mise en cache du serveur sont ajout√©es. <br><br>  <b>Option n ¬∞ 2</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag">]&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtext/javascript‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.serviceNameId = ‚Äú</span><span class="hljs-number"><span class="javascript"><span class="hljs-number">123</span></span></span><span class="javascript">‚Äù; </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// ServiceNameModule.init({id: ‚Äú123‚Äù}); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <i>Attribut Async - indique au navigateur qu'il n'est pas n√©cessaire d'attendre le chargement du script pour construire le DOM, le script doit √™tre ex√©cut√© imm√©diatement apr√®s le chargement.</i>  <i>Cela r√©duit le temps de chargement des pages, mais il y a aussi un revers √† la m√©daille: le script peut √™tre ex√©cut√© avant que le DOM ne soit pr√™t √† fonctionner.</i> <br><br>  L'une des impl√©mentations les plus populaires, y compris les grands services, fait exactement cela, seule la syntaxe est diff√©rente, mais l'essence de tous est la m√™me. <br><br><img src="https://habrastorage.org/webt/ga/9x/as/ga9xasvv7abeeu_f29q-y8zcqze.png"><br>  Cette approche pr√©sente deux inconv√©nients principaux, le premier - le code d'int√©gration est compliqu√©, et le second - l'ordre d'ex√©cution de ce code est tr√®s important, sinon rien ne fonctionnera.  De plus, vous devez faire un choix entre la vitesse (async) et la stabilit√© (sans async), la plupart choisissent la 2e option. <br><br>  <b>Option n ¬∞ 3</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  De la m√™me mani√®re que pour la premi√®re option, transf√©rez l'ID dans le lien vers le fichier, mais r√©cup√©rez-le dans le navigateur et non sur le serveur.  Ce n'est pas aussi simple qu'il y para√Æt, mais c'est possible.  L'API du navigateur poss√®de une propri√©t√© document.currentScript, elle renvoie un lien vers un script charg√© et en cours d'ex√©cution dans le navigateur.  Sachant cela, vous pouvez calculer l'ID, pour cela, vous devez obtenir la propri√©t√© document.currentScript.src et en extraire r√©guli√®rement l'ID. <br><br><img src="https://habrastorage.org/webt/p7/mc/jf/p7mcjfln8bnay8g2myb3289vt8y.png"><br>  Il y a une chose mais: document.currentScript n'est pas pris en charge par tous les navigateurs.  Pour les navigateurs qui ne prennent pas en charge cette propri√©t√©, nous avons trouv√© un hack int√©ressant.  Dans le code file.js, vous pouvez lever une exception "fake" sp√©ciale envelopp√©e dans try / catch, apr√®s quoi l'URL du script dans lequel l'erreur s'est produite dans la pile d'erreurs sera lev√©e.  L'URL contiendra l'ID que nous obtenons avec la m√™me r√©gularit√©. <br><br>  Ce type de magie est obtenu, mais cela fonctionne.  Il n'y a aucun probl√®me avec l'ordre d'ex√©cution, le code d'insertion semble simple et il n'y a pas de surcharge sur le serveur.  Au cours des deux derni√®res ann√©es, nous avons utilis√© une telle approche, bien que le code d'insertion lui-m√™me soit diff√©rent, mais le principe est le m√™me. <br><br><h3>  <font color="#00bf54">Param√®tres</font> </h3><br>  Dans la plupart des cas, les scripts de plug-in ont des param√®tres qui sont responsables de l'apparence ou de la logique du travail.  Ces param√®tres doivent √™tre "jet√©s" dans le script du plug-in, pour cela il existe deux approches fondamentalement diff√©rentes. <br><br>  <b>Approche n ¬∞ 1</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùtext/javascript‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">window</span></span></span><span class="javascript">.serviceName = {</span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">color</span></span></span><span class="javascript">: ‚Äúred‚Äù, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">title</span></span></span><span class="javascript">: ‚Äú‚Äù, ...}; </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">// ServiceNameModule.init({color: ‚Äúred‚Äù, title: ‚Äú‚Äù, ...}); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Cette approche comprend √©galement la transmission des param√®tres des param√®tres GET √† l'URL du script, similaire √† l'option n ¬∞ 1 de la section "Identification".  L'approche est que si le client souhaite modifier les param√®tres, il doit alors modifier le code d'int√©gration et le mettre √† jour sur le site. <br><br><img src="https://habrastorage.org/webt/lo/ua/-n/loua-nwuth3l7a0vbilxtu8ilmk.png"><br>  C'est bien car tous les param√®tres sont stock√©s sur le client et ils n'ont pas besoin d'√™tre stock√©s sur le serveur, d√©veloppez et maintenez toute la logique m√©tier li√©e √† cela.  Le principal inconv√©nient de cette approche est l'inconv√©nient pour le client, il doit tout faire manuellement, et s'il y a beaucoup de param√®tres, le code d'int√©gration se transforme en une feuille difficile √† maintenir, dans laquelle il est facile de faire une erreur.  Et pour que les mises √† jour prennent effet, vous devez mettre √† jour le site, ce sont les gestes suppl√©mentaires des d√©veloppeurs et des administrateurs. <br><br>  <b>Approche n ¬∞ 2</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">async</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://site.com/file.js?id=123"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  La deuxi√®me approche est que s'il est n√©cessaire de modifier les param√®tres, le client n'a pas besoin de modifier le code d'insertion, tous les param√®tres sont stock√©s sur le serveur.  Pour modifier les param√®tres, allez dans le panneau graphique, modifiez les param√®tres n√©cessaires et cliquez sur le bouton "Enregistrer".  Apr√®s cela, les param√®tres seront automatiquement appliqu√©s √† son site! <br><br><img src="https://habrastorage.org/webt/yq/xb/no/yqxbnominbt8r7_sj3ng0mib9wc.png"><br>  Pas besoin de comprendre le code et de faire un d√©ploiement pour cela, cela peut √™tre fait par une personne qui est loin de JavaScript, par exemple, un manager.  Bien s√ªr, cette option est beaucoup plus pratique et plus simple pour les utilisateurs, c'est pourquoi nous l'utilisons.  Mais il faut payer pour la commodit√©, cette approche n√©cessite le d√©veloppement et le support de la logique sur le serveur et implique une charge suppl√©mentaire sur celui-ci.  Dans les articles suivants, nous vous expliquerons certainement comment nous traitons quotidiennement 150 millions de ces demandes. <br><br><h3>  <font color="#00bf54">Compatibilit√© descendante</font> </h3><br>  Il est tr√®s important d'obtenir une version mature du code d'int√©gration le plus rapidement possible.  Parce que la mise √† jour des codes d'insertion d√©j√† install√©s sera extr√™mement difficile.  Un exemple de notre pratique: dans les premi√®res versions, nous utilisions des identifiants num√©riques, mais pour des raisons de s√©curit√©, nous les avons remplac√©s par des identifiants alphanum√©riques.  Il s'est av√©r√© qu'il est tr√®s difficile de modifier le code d'int√©gration d√©j√† install√©.  Beaucoup de gens ne savent m√™me pas ce qu'est le HTML et comment les sites Web sont con√ßus.  Par exemple, un site Web a √©t√© cr√©√© par des pigistes, un studio ou un site Web a √©t√© cr√©√© via un CMS / constructeur, etc. Dans la plupart des cas, nos clients ne travaillent qu'avec le panneau des param√®tres du widget.  Depuis lors, nous avons toujours dans nginx une carte de r√©√©criture des anciens ID vers les nouveaux, qui compte environ 40 000 enregistrements. <br><br><pre> <code class="xml hljs">.... /script/widget/config/15**90 /script/widget/config/bqZB**rjW5; /script/widget/config/15**94 /script/widget/config/qtfx**xnTi; /script/widget/config/15**95 /script/widget/config/fqmpa**4YX; /script/widget/config/15**97 /script/widget/config/Vr21g**nuT; /script/widget/config/15**98 /script/widget/config/8NXL5**F8E; /script/widget/config/15**00 /script/widget/config/Th2HN**6RJ; ....</code> </pre><br>  En raison de cette fonctionnalit√©, nous sommes oblig√©s de maintenir la compatibilit√© descendante du code int√©gr√© pour tous les refactoring, dont il y avait environ 5 dans notre m√©moire. <br><br><h3>  <font color="#00bf54">Isolement du code</font> </h3><br>  √âtant donn√© que le script est connect√© √† un site tiers qui dispose d√©j√† de code JavaScript et CSS pour le site et d'autres services, l'objectif principal n'est pas de nuire au site afin que notre code ne change pas la logique, encore moins de le casser.  Il peut s'agir d'une erreur JavaScript qui arr√™te le flux d'ex√©cution ou de styles qui remplacent les styles de site.  Mais le code du site peut √©galement affecter le script connect√©, par exemple, une biblioth√®que est utilis√©e qui modifie l'API du navigateur, apr√®s quoi le code cesse de fonctionner ou ne fonctionne pas comme pr√©vu. <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//  mootools.js var JSON = new Hash({ encode: function () {}, decode: function () {} // ... }); //    JSON.parse(json); // Uncaught TypeError: JSON.parse is not a function </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> //      body * { padding: 20px; } form input { display: block; border: 2px solid red; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  Il existe diff√©rentes options pour isoler le code.  Par exemple, vous pouvez utiliser des pr√©fixes dans les variables JS, les fermetures, afin de ne pas obstruer le contexte global, utilisez quelque chose comme BEM pour les styles.  Mais le moyen le plus simple consiste √† ex√©cuter le code dans un iframe, il r√©sout la plupart des probl√®mes d'isolement, mais impose certaines restrictions.  Nous utilisons une version hybride, nous vous en dirons plus sur l'isolement du code dans les articles suivants. <br><br><h3>  <font color="#00bf54">Site de chargement de blocs</font> </h3><br><img src="https://habrastorage.org/webt/1l/wr/du/1lwrdup_ictcih9u7ectyzgwsp4.png"><br><br>  √âv√©nement de chargement - se produit apr√®s le chargement complet de la page Web, y compris les images, les styles et les scripts externes.  Une caract√©ristique importante est que sur la plupart des sites, la logique JS, les scripts et les publicit√©s tiers commencent √† fonctionner sur l'occurrence de cet √©v√©nement.  Un point tr√®s important pour tous les scripts connect√©s est d'√©viter un impact n√©gatif sur cet √©v√©nement. <br><br>  Cela se produit dans les cas o√π le serveur √† partir duquel le script est charg√© r√©pond pendant longtemps ou ne r√©pond pas du tout: alors l'√©v√©nement onload est retard√© et le chargement de page suppl√©mentaire est essentiellement bloqu√©.  Dans le cas o√π le serveur n'est pas disponible, l'√©v√©nement onload ne se produit qu'apr√®s expiration du d√©lai de la demande, qui est sup√©rieur √† 60 s.  Ainsi, les probl√®mes sur le serveur de t√©l√©chargement de scripts "cassent" essentiellement les sites, ce qui est inacceptable. <br><br>  <b>Exp√©rience personnelle</b> <br>  Dans le pass√©, j'ai travaill√© pour une entreprise qui avait un site Web avec des rencontres en ligne simultan√©es de 100K.  √Ä cette √©poque, les boutons ¬´Partager sur les r√©seaux sociaux¬ª √©taient populaires.  Pour qu'ils apparaissent sur le site, vous avez d√ª connecter un script (sdk) √† partir des r√©seaux sociaux souhait√©s.  Un jour, des coll√®gues ont couru vers nous et nous ont dit que notre site ne fonctionnait pas!  Nous avons examin√© la surveillance, dans laquelle tout √©tait normal, et au d√©but, nous n'avons pas compris quel √©tait le probl√®me.  Quand ils ont commenc√© √† creuser plus profond√©ment, ils ont r√©alis√© que les serveurs cdn de Twitter √©taient couch√©s et que leur SDK ne pouvait pas se charger, ce qui nous a emp√™ch√© de charger le site pendant environ 1,5 minute.  Autrement dit, apr√®s l'ouverture du site, un peu de HTML a √©t√© charg√© (le reste du SPA) et seulement apr√®s 1,5 minute, tout a √©t√© charg√©, le d√©lai de requ√™te m√™me a fonctionn√©.  Nous avons d√ª de toute urgence organiser un correctif et supprimer leur script du site.  Apr√®s avoir r√©p√©t√© cette situation, nous avons d√©cid√© de supprimer le bloc Partager. <br><br>  Dans les premi√®res versions du code insert, nous n'en avons pas tenu compte, et en cas de probl√®mes techniques de notre c√¥t√©, pour le moins, nous g√™nons nos clients, mais au fil du temps nous l'avons corrig√©. <br><br>  <b>Solution</b> <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'text/javascript'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> (</span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> initCode = </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// insert script tag }; document.readyState === 'complete' ? initCode() : w.addEventListener('load', initCode, false); })(); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  La solution est simple, vous devez vous abonner √† l'√©v√©nement d'une charge compl√®te du site et ensuite seulement charger le script, pour cela vous devez utiliser le code d'int√©gration, pas la balise de script. <br><br><h3>  <font color="#00bf54">Google pagespeed</font> </h3><br><br><img src="https://habrastorage.org/webt/ur/b9/4t/urb94tbcz9obpytp_da8ed27c8s.png"><br>  <i>Analyse de la version mobile de habr.com</i> <br><br>  La plupart d'entre eux pr√™tent attention √† la vitesse de chargement du site, selon de nombreuses √©tudes, cela affecte directement le profit, en outre, les algorithmes de recherche lorsque le classement a commenc√© √† prendre en compte le temps de chargement de la page.  √Ä cet √©gard, les propri√©taires de sites utilisent souvent des outils similaires pour √©valuer les performances du site.  Par cons√©quent, il est tr√®s important de connecter de mani√®re optimale le code au site, car cela affecte directement son temps de t√©l√©chargement. <br><br>  Cela signifie que vous devez utiliser des techniques modernes pour optimiser le chargement des pages.  Par exemple, utilisez Gzip, mettez en cache les fichiers et les requ√™tes statiques, utilisez le chargement de script asynchrone, compressez la statique avec des algorithmes modernes tels que WebP / Brotli / etc et utilisez d'autres optimisations.  Nous effectuons r√©guli√®rement des audits et r√©pondons aux avertissements et recommandations pour r√©pondre aux exigences actuelles. <br><br><h3>  <font color="#00bf54">Cdn</font> </h3><br>  Dans les premi√®res versions, nous avons t√©l√©charg√© des statiques √† partir de serveurs d'applications.  Mais cette approche pr√©sente des inconv√©nients: trafic co√ªteux, √©loignement des visiteurs du site et charge excessive sur le canal du serveur.  Vous pouvez facilement obstruer le canal des serveurs d'applications avec l'effet habr des sites, car le trafic statique est tr√®s "lourd". <br><br>  Afin d'√©conomiser du budget, de la stabilit√© et de r√©duire la latence du r√©seau, il est optimal de charger la statique √† partir de serveurs sp√©cialement con√ßus √† cet effet.  Vous pouvez utiliser des fournisseurs CDN pr√™ts √† l'emploi, mais √† grande √©chelle, ce n'est pas bon march√© et vous devez √™tre limit√© par les capacit√©s offertes par tel ou tel fournisseur. <br><br><img src="https://habrastorage.org/webt/vi/jy/f3/vijyf3bxfqmihwwfswlfqzxtqie.png"><br><br>  Nous l'avons impl√©ment√© simplement, command√© des serveurs bon march√© en Russie, en Europe et en Am√©rique avec un trafic illimit√© et un large canal.  C'est bon march√©, il ne nous impose aucune restriction, nous pouvons tout personnaliser pour nous-m√™mes et la tol√©rance aux pannes est assur√©e par le m√©canisme qui fonctionne dans le navigateur.  Actuellement, 1 To de statique est charg√© quotidiennement √† partir de nos serveurs CDN. <br><br><h3>  <font color="#00bf54">Tol√©rance aux pannes</font> </h3><br>  Malheureusement, le monde n'est pas parfait, des incendies se produisent, des liaisons montantes tombent, les DC se mettent compl√®tement sous l'eau, l'ILV bloque les sous-r√©seaux et les gens font des erreurs.  N√©anmoins, il est n√©cessaire de pouvoir g√©rer de telles situations et de continuer √† travailler. <br><br>  <b>Suivi</b> <br>  Vous devez d'abord comprendre que quelque chose s'est mal pass√©.  Vous pouvez, bien s√ªr, attendre que les utilisateurs viennent se plaindre, mais il est pr√©f√©rable de configurer la surveillance et les alertes, et apr√®s les versions, v√©rifiez si tout est en ordre.  Nous surveillons de nombreux param√®tres diff√©rents, √† la fois sur le serveur et sur le client, et en cas de probl√®me, nous le voyons imm√©diatement.  Par exemple, le nombre de t√©l√©chargements de widgets ou une augmentation anormale du trafic sur les serveurs CDN a diminu√©. <br><br><img src="https://habrastorage.org/webt/z7/kp/dq/z7kpdqcble85t395hv7z_bqt8fg.png"><br>  <i>Le nombre total de t√©l√©chargements de widgets pour chaque version</i> <br><br>  <b>Collecte d'erreurs</b> <br>  JavaScript est un langage tr√®s sp√©cifique et il est facile de se tromper.  De plus, le zoo des navigateurs sur le Web moderne est tr√®s grand;  ce qui fonctionne dans le dernier Chrome n'est pas un fait qui fonctionnera dans Safari ou Firefox.  Par cons√©quent, il est tr√®s important de configurer la collecte des erreurs √† partir du navigateur et de r√©pondre aux pointes dans le temps.  Si votre code fonctionne dans un iframe, vous pouvez le faire en suivant le gestionnaire global window.onerror et, en cas d'erreur, envoyez des donn√©es au serveur.  Si le code fonctionne en dehors de l'iframe, il est tr√®s difficile d'impl√©menter la collecte des erreurs. <br><br><img src="https://habrastorage.org/webt/g-/d6/jd/g-d6jddyvo9gpslniix1ndyvo1y.png"><br>  <i>Le nombre total d'erreurs de tous les sites et navigateurs</i> <br><br><img src="https://habrastorage.org/webt/3w/fp/ju/3wfpjuzxcyzpfervxtkq6o_zx10.png"><br>  <i>Informations d'erreur sp√©cifiques</i> <br><br>  <b>Basculement du CDN</b> <br>  J'ai d√©j√† √©crit ci-dessus que tout a la propri√©t√© de tomber, il est donc important de g√©rer ces situations et mieux - automatiquement.  Nous sommes pass√©s par plusieurs √©tapes de secours des serveurs CDN, en commen√ßant par le manuel, et nous avons finalement trouv√© un moyen de le faire automatiquement et de mani√®re optimale pour le navigateur. <br><br>  En mode manuel, cela a fonctionn√© simplement: SMS a re√ßu des administrateurs disant que le CDN √©tait en panne, ils ont effectu√© certaines manipulations, apr√®s quoi le widget a commenc√© √† se charger √† partir des serveurs d'applications.  Cela peut prendre de 5 minutes √† 2 heures. <br><br>  Pour impl√©menter le repli automatique, vous devez en quelque sorte d√©tecter que le script a commenc√© √† se charger, mais ce n'est pas aussi simple qu'il y para√Æt.  Le navigateur ne permet pas de surveiller les √©tats interm√©diaires du chargement des balises de script, tels que l'√©v√©nement onprogress dans XMLHttpRequest, mais signale uniquement l'√©v√©nement lorsque le script est charg√© et ex√©cut√©.  Il est √©galement impossible pour un temps acceptable de d√©couvrir que le serveur est actuellement indisponible, le seul √©v√©nement onerror se d√©clenche apr√®s l'expiration du d√©lai d'expiration de la demande, plus d'une minute.  Dans une minute, le visiteur peut d√©j√† quitter la page, mais le script ne se charge pas. <br><br>  Nous avons essay√© diff√©rentes options, simples et complexes, mais √† la fin nous avons trouv√© une requ√™te ping pour un serveur CDN.  Cela fonctionne comme ceci: nous envoyons d'abord une requ√™te ping au serveur CDN, s'il r√©pond, puis nous chargeons le widget √† partir de celui-ci.  Pour impl√©menter ce sch√©ma de mani√®re optimale pour le navigateur et nos serveurs, nous utilisons une requ√™te HEAD l√©g√®re (sans corps), et lors des t√©l√©chargements ult√©rieurs, nous ne le faisons que lorsque la version du widget est mise √† jour, car le widget est d√©j√† dans le cache du navigateur. <br><br><img src="https://habrastorage.org/webt/r-/zf/gh/r-zfghwbzyarwvybwbdkbaaz5py.png"><br>  Ainsi, nous avons re√ßu une d√©tection tr√®s rapide et automatique de la disponibilit√© du serveur statique et en cas de chute, nous passons au serveur de sauvegarde presque sans d√©lai. <br><br><h3>  <font color="#00bf54">Chargeur</font> </h3><br>  Pour t√©l√©charger votre script sur un site tiers, vous devez prendre en compte de nombreux points, mais il est difficile d'impl√©menter cette logique dans le code d'int√©gration, car il se transformera simplement en "viande".  Mais vous devez encore le faire, pour cela nous avons cr√©√© un petit module qui g√®re toute cette logique "sous le capot" et charge le code principal du widget.  Il se charge d'abord et impl√©mente le basculement CDN, la mise en cache, la compatibilit√© descendante avec les anciens codes int√©gr√©s, les tests A / B, la mise en place progressive de la nouvelle version du widget et de nombreuses autres fonctions. <br><br><img src="https://habrastorage.org/webt/-e/pj/-j/-epj-jpym6xcdxu9bk7axxtmtsa.png"><br>  Ainsi, par √©tapes, nous sommes arriv√©s √† un sch√©ma qui couvre les principaux cas de chargement et d'initialisation du widget.  Il a fait ses preuves au fil des ann√©es d'utilisation sur un grand nombre de sites diff√©rents.  Dans le m√™me temps, le code d'insertion reste simple et universel, car il ne contient aucune logique et nous pouvons le modifier √† tout moment, sans forcer les utilisateurs √† modifier le code d'insertion. <br><br><h3>  <font color="#00bf54">Services tiers</font> </h3><br>  Et enfin, il convient de mentionner les services tiers qui se connectent au site ou interagissent d'une mani√®re ou d'une autre avec des sites: robots de recherche, analyses, divers analyseurs, etc.  Ces services laissent une empreinte au travail, ne l'oubliez pas non plus.  Je vais vous raconter quelques cas de notre pratique. <br><br>  <b>Googlebot</b> <br>  L'application de notre op√©rateur dispose de la fonction ¬´Visiteurs¬ª, dans laquelle vous pouvez voir les visiteurs qui consultent actuellement le site, et diverses informations √† leur sujet: temps sur le site, page, nombre de pages vues, etc.  √Ä un moment donn√©, les clients ont commenc√© √† se plaindre qu'ils ¬´suspendaient¬ª les visiteurs d'autres sites, c'est-√†-dire sur le site vendant des iPhones, un client qui aurait une page intitul√©e ¬´Acheter une cr√®me pour le visage¬ª.  Quand ils ont commenc√© √† comprendre, il s'est av√©r√© que c'√©tait GoogleBot, qui, lors du passage d'un site √† un autre, a d'abord mis en cache LocalStorage puis transf√©r√© des donn√©es incorrectes vers le serveur. <br><br>  La solution est simple, le serveur a commenc√© √† ignorer les donn√©es de GoogleBot. <br><br>  <b>Yandex.Metrica</b> <br>  Il y a une merveilleuse fonctionnalit√© dans la m√©trique - un navigateur Web, qui vous permet de voir ce que l'utilisateur a vu et fait sous la forme d'un screencast.  Pour ce faire, la m√©trique enregistre toutes les actions de l'utilisateur et, apr√®s qu'un robot de m√©trique sp√©cial parcourt les sites, effectue les m√™mes actions et les enregistre.  Le probl√®me √©tait que pour √©muler le navigateur mobile de l'utilisateur, selon nos donn√©es, Firefox √©tait activ√© en mode d'√©mulation mobile, mais l'agent userAgent dans le bot √©tait de bureau. <br><br>  Cela a conduit au fait que lors de la visualisation des sessions d'utilisateurs mobiles dans le navigateur Web, la version de bureau du widget s'est ouverte sur les enregistrements, bien qu'en fait, les utilisateurs aient ouvert la version mobile.  Nos clients l'ont pens√© et nous ont bombard√©s de plaintes.     ,     , ,      ,        . <br><br>   , , ,      . <br><br><h3> <font color="#00bf54"></font> </h3><br>      ,        .   ,         .                , ,    NodeJS   ,     270         -    ,         . <br><br>   ,        ! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/fr452802/">https://habr.com/ru/post/fr452802/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../fr452792/index.html">Examen SSD SSD pour les utilisateurs d'entreprise Kingston DC500R</a></li>
<li><a href="../fr452794/index.html">A propos de la localisation des produits. Premi√®re partie: par o√π commencer?</a></li>
<li><a href="../fr452796/index.html">Nous vous invitons √† la r√©union du d√©partement de d√©veloppement de jeux GeekUniversity</a></li>
<li><a href="../fr452798/index.html">Stockage et tri automatique des photos et autres fichiers. Travailler avec le stockage de fichiers bas√© sur Synology NAS</a></li>
<li><a href="../fr452800/index.html">Microbiota. Comment les bact√©ries intestinales affectent la maladie</a></li>
<li><a href="../fr452804/index.html">Je quitte mon emploi de r√™ve car je ne supporte pas le d√©veloppement de produits</a></li>
<li><a href="../fr452806/index.html">Interview - 10 questions sur Swift. 2e partie</a></li>
<li><a href="../fr452808/index.html">Management d'une √©quipe de programmeurs: comment et comment les motiver correctement? Deuxi√®me partie</a></li>
<li><a href="../fr452812/index.html">J'ai re√ßu un ch√®que 0x $ 3.00 de Knut</a></li>
<li><a href="../fr452816/index.html">Que se passera-t-il le 1er f√©vrier 2020?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>