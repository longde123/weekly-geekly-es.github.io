<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üéç üöì ü•á Infraestrutura como c√≥digo, ganhamos em escala (Kirill Vetchinkin, TYME) üï§ üèÆ ü§∂üèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="O modelo de infraestrutura como c√≥digo (IaC), √†s vezes chamado de "infraestrutura program√°vel", √© um modelo pelo qual o processo de configura√ß√£o da in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Infraestrutura como c√≥digo, ganhamos em escala (Kirill Vetchinkin, TYME)</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/438748/"><p>  O modelo de infraestrutura como c√≥digo (IaC), √†s vezes chamado de "infraestrutura program√°vel", √© um modelo pelo qual o processo de configura√ß√£o da infraestrutura √© semelhante ao processo de programa√ß√£o de software.  Essencialmente, marcou o in√≠cio da remo√ß√£o dos limites entre a cria√ß√£o de aplicativos e a cria√ß√£o de ambientes para esses aplicativos.  Os aplicativos podem conter scripts que criam e gerenciam suas pr√≥prias m√°quinas virtuais.  Essa √© a base da computa√ß√£o em nuvem e parte integrante do DevOps. </p><br><p>  A infraestrutura como um c√≥digo permite gerenciar m√°quinas virtuais no n√≠vel do software.  Isso elimina a necessidade de configura√ß√£o manual e atualiza√ß√µes para componentes de equipamentos individuais.  A infraestrutura se torna extremamente ‚Äúresiliente‚Äù, ou seja, reproduz√≠vel e escal√°vel.  Um operador pode implantar e gerenciar tanto uma quanto 1000 m√°quinas usando o mesmo conjunto de c√≥digos.  Entre os benef√≠cios garantidos da infraestrutura como c√≥digo est√£o a velocidade, a rela√ß√£o custo-benef√≠cio e a redu√ß√£o de riscos. </p><br><p>  √â exatamente disso que trata a decodifica√ß√£o do relat√≥rio de Kirill Vetchinkin no DevOpsDays Moscow 2018. O relat√≥rio: reutiliza√ß√£o de m√≥dulos Ansible, armazenamento no Git, revis√£o, reconstru√ß√£o, benef√≠cios financeiros, escala horizontal com um clique. </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/mElPCgMl_Wg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  Quem se importa, por favor, debaixo do gato. </p><a name="habracut"></a><br><p>  Ol√° pessoal.  Como j√° foi dito, sou Vetchinkin Kirill.  Eu trabalho na TYME e hoje falaremos sobre infraestrutura como um c√≥digo.  Tamb√©m falaremos sobre como aprendemos a economizar nessa pr√°tica, porque √© muito cara.  Escrever muito c√≥digo √© muito caro para configurar a infraestrutura. </p><br><p>  Vou falar brevemente sobre a empresa.  Eu trabalho na TYME.  Tivemos uma mudan√ßa de nome.  Agora somos chamados PaySystem - como o nome indica, estamos envolvidos em sistemas de pagamento.  Temos nossas pr√≥prias solu√ß√µes - s√£o processamentos e desenvolvimento personalizado.  O desenvolvimento personalizado √© servi√ßos banc√°rios eletr√¥nicos, cobran√ßa e afins.  E como voc√™ sabe, se esse √© um desenvolvimento personalizado, esse √© um grande n√∫mero de projetos a cada ano.  O projeto segue o projeto.  Quanto mais projetos, mais infraestrutura do mesmo tipo precisa ser aumentada.  Como os projetos geralmente s√£o muito carregados, usamos a arquitetura de microsservi√ßo.  Portanto, em um projeto, existem muitos, muitos subprojetos pequenos. </p><br><p><img src="https://habrastorage.org/webt/e2/pn/or/e2pnoryduehiqs7tpmruibojxng.png"></p><br><p>  Portanto, gerenciar esse zool√≥gico inteiro sem um DevOps completo √© muito dif√≠cil.  Portanto, nossa empresa implementou v√°rias pr√°ticas de DevOps.  Naturalmente, trabalhamos no Kanban, no SCRUM, armazenamos tudo no git.  Ap√≥s a confirma√ß√£o, h√° uma integra√ß√£o cont√≠nua, os testes s√£o executados.  Os testadores escrevem testes de ponta a ponta no PyTest que come√ßam todas as noites.  O teste de unidade √© iniciado ap√≥s cada confirma√ß√£o.  Usamos um processo separado de cria√ß√£o e implanta√ß√£o: montado e implantado em v√°rios ambientes v√°rias vezes.  N√≥s est√°vamos nas janelas.  Nas janelas que implantamos usando o Octopus deploy, este ano estamos desenvolvendo no DotNet Core.  Portanto, agora podemos executar software em sistemas Linux.  Deixamos Octopus e chegamos a Ansible.  Hoje falaremos sobre essa parte, que √© uma nova pr√°tica que desenvolvemos este ano, algo que n√£o t√≠nhamos antes.  Quando voc√™ faz testes, quando sabe como construir bem o aplicativo, √© bom implant√°-lo em algum lugar.  Mas se voc√™ tiver dois ambientes configurados de maneira diferente, ainda cair√° e cair√° na produ√ß√£o.  Portanto, gerenciar configura√ß√µes √© uma pr√°tica muito importante.  √â sobre isso que falaremos hoje. </p><br><p><img src="https://habrastorage.org/webt/_u/di/kj/_udikjskq0g3yi48718mjn1hf54.png"><br>  Descreverei brevemente como a economia de trabalho do produto √© constru√≠da: <strong>60</strong> % s√£o gastos em <strong>desenvolvimento</strong> , a <strong>an√°lise</strong> leva em torno de <strong>10</strong> %, o <strong>controle de qualidade</strong> (teste) leva em torno de <strong>20</strong> % e tudo o mais √© atribu√≠do √† configura√ß√£o.  Quando os sistemas entram em pleno fluxo, eles t√™m muitos softwares de terceiros, os pr√≥prios sistemas operacionais s√£o configurados quase da mesma maneira.  Passamos um tempo extra fazendo isso, essencialmente fazendo a mesma coisa.  Havia uma id√©ia para automatizar tudo e reduzir o custo de configura√ß√£o da infraestrutura.  Tarefas semelhantes s√£o automatizadas, bem depuradas e n√£o cont√™m opera√ß√µes manuais. </p><br><p><img src="https://habrastorage.org/webt/zf/vh/wm/zfvhwmb7pvlufeihfrgj0xk6dnq.png"><br>  Cada aplicativo funciona em algum tipo de ambiente.  Vamos ver no que tudo isso consiste.  No m√≠nimo, precisamos ter um <strong>sistema operacional</strong> , ele precisa ser configurado, existem alguns <strong>aplicativos de terceiros</strong> que tamb√©m precisam ser configurados, <strong>o pr√≥prio aplicativo</strong> deve receber as configura√ß√µes, mas, para que todo o produto funcione, √© necess√°rio iniciar o pr√≥prio aplicativo, que opera em todo o sistema.  Tamb√©m h√° uma <strong>rede</strong> que tamb√©m precisa ser configurada, mas n√£o falaremos sobre a rede hoje, porque temos clientes diferentes, dispositivos de rede diferentes.  Tamb√©m tentamos automatizar a configura√ß√£o da rede, mas como os dispositivos s√£o diferentes, n√£o houve nenhum benef√≠cio em particular, gastamos mais recursos nisso.  Mas automatizamos os sistemas operacionais, aplicativos de terceiros e a transfer√™ncia de par√¢metros de configura√ß√£o para os pr√≥prios aplicativos. </p><br><p><img src="https://habrastorage.org/webt/mp/gx/l0/mpgxl0kr4wzjrc9zymbmjn2pk6c.png"></p><br><p>  Existem duas abordagens sobre como voc√™ pode configurar os servidores: manualmente - se voc√™ configur√°-los manualmente, poder√° obter uma situa√ß√£o que configurou a produ√ß√£o de uma maneira, o teste do outro, tudo √© verde no teste, os testes s√£o verdes.  Voc√™ implanta na produ√ß√£o e n√£o h√° estrutura - nada funciona para voc√™.  Outro exemplo: tr√™s servidores de aplicativos s√£o configurados manualmente.  Um servidor de aplicativos foi configurado de uma maneira, outro servidor de aplicativos de uma maneira diferente.  Servidores podem trabalhar de maneiras diferentes.  Outro exemplo: houve uma situa√ß√£o em que um servidor Stage parou de funcionar completamente para n√≥s.  Come√ßamos a criar um novo servidor usando e ap√≥s 30 o servidor estava pronto.  Outro exemplo: o servidor parou de funcionar.  Se voc√™ o configurar com as m√£os, precisar√° procurar uma pessoa que saiba como configur√°-lo, precisar√° levantar a documenta√ß√£o.  Como sabemos, a documenta√ß√£o √© pouco relevante.  Estes s√£o grandes problemas.  E, o mais importante, √© uma auditoria, ou seja, voc√™ tem dez administradores, cada um com algo em m√£os, n√£o est√° muito claro se o configuraram de maneira correta ou incorreta e como entender se ent√£o as configura√ß√µes, eles poderiam colocar algo sup√©rfluo, abrir algumas portas desnecess√°rias. </p><br><p><img src="https://habrastorage.org/webt/uz/pr/be/uzprbex2cscs4xglphdoy_wsenw.png"></p><br><p>  Existe uma op√ß√£o alternativa - √© exatamente disso que estamos falando hoje - essa √© a configura√ß√£o do c√≥digo.  Ou seja, temos um reposit√≥rio git no qual toda a infraestrutura √© armazenada.  Todos os scripts s√£o armazenados l√°, com a ajuda da qual iremos configur√°-lo.  Como tudo isso est√° no git, obtemos todos os benef√≠cios do gerenciamento de c√≥digo, como no desenvolvimento, ou seja, podemos fazer revis√µes, auditorias, hist√≥rico de altera√ß√µes, quem fez, por que fez, coment√°rios, podemos reverter.  Para trabalhar com o c√≥digo, voc√™ precisa usar o pipeline de montagem cont√≠nuo - o pipeline de implanta√ß√£o.  Para que um sistema espec√≠fico fa√ßa altera√ß√µes nos servidores, ou seja, nenhuma pessoa faria algo com as m√£os, mas o sistema faria exclusivamente. </p><br><p><img src="https://habrastorage.org/webt/0r/dj/j_/0rdjj_cdepjplmukudcdg5sbnlo.png"></p><br><p>  Como o sistema que faz as altera√ß√µes, usamos o Ansible.  Como n√£o temos um grande n√∫mero de servidores, √© bastante adequado para n√≥s.  Se voc√™ tiver 100-200 servidores l√°, ter√° pequenos problemas, porque (isto √©, Ansible) ainda se conecta a cada um e os configura por sua vez - isso √© um problema.  √â melhor usar outros meios que n√£o empurram, mas puxam.  Mas para a nossa hist√≥ria, quando temos muitos projetos, mas n√£o mais que 20 servidores, isso √© bastante adequado para n√≥s.  O Ansible tem uma grande vantagem - √© um baixo limite de entrada.  Ou seja, literalmente, qualquer especialista em TI em tr√™s semanas pode domin√°-lo completamente.  Ele tem muitos m√≥dulos.  Ou seja, voc√™ pode gerenciar nuvens, redes, arquivos, instalar programas, implantar - absolutamente tudo.  Se n√£o houver m√≥dulos, voc√™ pode escrever o seu pr√≥prio, pode finalmente escrever algo usando o shell Ansible ou o m√≥dulo de comando. </p><br><p><img src="https://habrastorage.org/webt/y6/2j/vq/y62jvqqmsm9jwm0shngvgrp_5_g.png"></p><br><p>  Em geral, consideraremos brevemente como ela geralmente parece, essa ferramenta.  Ansible tem m√≥dulos que eu j√° falei.  Ou seja, eles podem ser entregues, escritos por eles mesmos, que est√£o fazendo algo.  Existem invent√°rios - √© aqui que iremos fazer as altera√ß√µes, ou seja, esses s√£o os hosts, seus endere√ßos IP, vari√°veis ‚Äã‚Äãespec√≠ficas para esses hosts.  E, consequentemente, o papel.  Fun√ß√µes √© o que vamos lan√ßar nesses servidores.  E tamb√©m nossos hosts s√£o agrupados em grupos, ou seja, nesse caso, vemos que temos dois grupos: o servidor de banco de dados e o servidor de aplicativos.  Em cada grupo, temos tr√™s carros.  Eles est√£o conectados via ssh.  Assim, resolvemos os problemas de que falamos anteriormente, que, em primeiro lugar, nossos servidores s√£o configurados de forma id√™ntica, uma vez que a mesma fun√ß√£o rola para os servidores.  E da mesma maneira, se executarmos essa fun√ß√£o em v√°rias m√°quinas, para cada uma funcionar√° da mesma maneira. </p><br><p><img src="https://habrastorage.org/webt/h2/hr/-t/h2hr-t11qunwpnaa-9ro7wxhfio.png"></p><br><p>  Se examinarmos mais detalhadamente como o projeto Ansible est√° estruturado, vemos aqui que os hosts s√£o aceit√°veis ‚Äã‚Äãpara os estoques de produ√ß√£o.  Este grupo √© indicado e h√° dois servidores nele.  Se formos a um servidor espec√≠fico, veremos que o endere√ßo IP desta m√°quina est√° indicado aqui.  Outros par√¢metros tamb√©m podem ser indicados l√° - vari√°veis ‚Äã‚Äãespec√≠ficas para este ambiente.  Se olharmos para os pap√©is.  Essa fun√ß√£o cont√©m v√°rias tarefas que ser√£o executadas.  Nesse caso, esse √© o papel da instala√ß√£o do PostgreSQL.  Ou seja, instalamos o aplicativo necess√°rio, criamos o banco de dados.  Aqui usamos um loop.  Eles (bancos de dados) ser√£o criados um pouco.  Em seguida, estabelecemos a conex√£o necess√°ria - endere√ßos IP que podem efetuar login neste banco de dados.  E, consequentemente, configuramos no final do firewall.  As configura√ß√µes ser√£o aplicadas a todos os servidores do grupo. </p><br><p><img src="https://habrastorage.org/webt/zg/ia/zo/zgiazoqklptftwwsjnxyqtq-1jc.png"></p><br><p>  Basta abordar o problema em si: aprendemos a configurar o servidor usando o Ansible e tudo estava bem.  Mas, como eu disse, temos muitos projetos.  Eles s√£o quase todos iguais.  Alguns desses sistemas est√£o envolvidos em cada projeto (k8s, RabbitMQ, Vault, ELK, PostgreSQL, HAProxy).  Para cada um, escrevemos um papel.  Podemos rolar a partir do bot√£o. </p><br><p><img src="https://habrastorage.org/webt/c3/ob/ez/c3obezyaxpshu6akdh6_qodbhp4.png"></p><br><p>  Mas temos muitos projetos, e em cada um eles se sobrep√µem.  Ou seja, em um desses conjuntos, no segundo, no terceiro.  Temos pontos de interse√ß√£o nos quais os mesmos pap√©is em diferentes projetos. </p><br><p><img src="https://habrastorage.org/webt/zk/fi/ag/zkfiagc0lsac1-a9tnce_rr7cha.png"></p><br><p>  Temos um reposit√≥rio com uma aplica√ß√£o, temos um reposit√≥rio com infraestrutura para o projeto.  O segundo projeto tem exatamente o mesmo.  Infraestrutura continuada.  E o terceiro.  Se implementarmos a mesma coisa, essencialmente copiar e colar ser√° exibido.  Faremos o mesmo papel em 10 lugares.  Ent√£o, se houver algum erro, n√≥s governaremos em 10 lugares. </p><br><p><img src="https://habrastorage.org/webt/g8/qe/ht/g8qehtvllis6iwedgzaasbu9pe8.png"></p><br><p>  O que fizemos: assumimos todas as fun√ß√µes comuns a todos os projetos e todas as suas configura√ß√µes que v√™m de fora para um reposit√≥rio separado e as colocamos em um git em uma pasta separada - chamamos de Infraestrutura TYME.  L√°, temos uma fun√ß√£o para o PostgreSQL, para o ELK, para a implanta√ß√£o de clusters Kubernetes.  Se precisarmos colocar algum projeto, digamos o mesmo PostgreSQL, basta ativ√°-lo como um subm√≥dulo, reescrever invent√°rios, que √©, grosso modo, a configura√ß√£o em que desempenhar esse papel.  N√£o reescrevemos o papel em si: ele j√° existe.  E com o clique de um bot√£o, o PostgreSQL aparece em todos os novos projetos.  Se voc√™ precisar criar um cluster Kubernetes - a mesma coisa. </p><br><p><img src="https://habrastorage.org/webt/iy/q1/p0/iyq1p0mgtf6vhnk06s4mnirypls.png"></p><br><p>  Assim, acabou por reduzir o custo de escrever pap√©is.  Ou seja, eles escreveram uma vez - usaram 10 vezes.  Quando o projeto segue o projeto - √© muito conveniente.  Mas como agora estamos trabalhando com a infraestrutura como um c√≥digo, naturalmente precisamos dos pipelines sobre os quais falamos.  As pessoas cometem erros no git, elas podem cometer algum tipo de erro - precisamos acompanhar tudo isso.  Portanto, constru√≠mos exatamente esse pipeline.  Ou seja, o desenvolvedor comete scripts Ansible no git.  O Teamity os rastreia e os transfere para o Ansible.  O Teamcity √© necess√°rio aqui por apenas um motivo: em primeiro lugar, ele possui uma interface visual (existe uma vers√£o gratuita do Ansible Tower - AWX, que resolve o mesmo problema - aprox.). Diferentemente do Ansible free e, em princ√≠pio, temos o Teamcity como um √∫nico Ci.  Ent√£o, em princ√≠pio, o Ansible tem um m√≥dulo que pode rastrear o git.  Mas, neste caso, eles fizeram apenas √† imagem e semelhan√ßa.  E assim que ele o rastreia, ele transfere todo o c√≥digo para Ansible e Ansible, respectivamente, executa-os no servidor de integra√ß√£o e altera a configura√ß√£o.  Se esse processo for violado, estamos analisando o que est√° errado, por que os scripts foram mal escritos. </p><br><p><img src="https://habrastorage.org/webt/rj/hc/wj/rjhcwjfpwdf_xwr8vpk4z2se26c.png"></p><br><p>  O segundo ponto √© que existe uma infraestrutura espec√≠fica, aqui temos a infraestrutura implantada separadamente, o aplicativo √© implantado separadamente.  Por√©m, h√° uma infraestrutura espec√≠fica para cada aplicativo, ou seja, que precisa ser implantada antes do lan√ßamento.  Aqui, portanto, √© imposs√≠vel transferi-lo para um pipeline diferente.  Voc√™ deve implant√°-lo no mesmo cont√™iner que o pr√≥prio aplicativo.  Ou seja, digamos, estruturas s√£o uma coisa popular quando voc√™ precisa instalar uma estrutura para um novo aplicativo e colocar outra estrutura para outra.  Aqui est√° como com esta situa√ß√£o.  Ou voc√™ precisa limpar os caches.  Por exemplo, o Ansible tamb√©m pode subir, limpar o cache. </p><br><p><img src="https://habrastorage.org/webt/b5/qj/rf/b5qjrf25y_2k4znz0-zidclu7fi.png"></p><br><p>  Mas aqui usamos o docker em combina√ß√£o com o Ansible.  Ou seja, a infraestrutura espec√≠fica de n√≥s est√° na janela de encaixe, n√£o espec√≠fica na Ansible.  E assim, compartilhamos esse pequeno delta no docker, tudo o mais, fundamental - no Ansible. </p><br><p><img src="https://habrastorage.org/webt/xq/6i/21/xq6i21qkn6l18s8f68becyjgt7y.png"></p><br><p>  Um ponto muito importante - se voc√™ rolar a infraestrutura atrav√©s de algum tipo de script, c√≥digo, se ainda tiver manipula√ß√µes manuais do servidor, essa ser√° uma vulnerabilidade em potencial.  Porque digamos que voc√™ coloque o java no servidor de teste, escreva a fun√ß√£o ELK e fa√ßa a rolagem.  A implanta√ß√£o no teste foi bem-sucedida.  Implante na produ√ß√£o, mas n√£o h√° java.  E voc√™ n√£o especificou java no script - a implanta√ß√£o na produ√ß√£o caiu.  Portanto, voc√™ precisa tirar os direitos de todos os servidores dos administradores para que eles n√£o entrem nele com suas m√£os e fa√ßam todas as altera√ß√µes atrav√©s do git.  Todo esse transportador pelo qual passamos.  H√° uma coisa, mas - n√£o aperte muito as porcas.  Ou seja, √© necess√°rio introduzir esse processo gradualmente.  Porque ainda est√° sem cultivo.  No nosso caso, deixamos o acesso a todos os sistemas na cabe√ßa do administrador principal em caso de incidentes imprevistos.  O acesso √© concedido com a condi√ß√£o de que ele n√£o configure nada manualmente. </p><br><p><img src="https://habrastorage.org/webt/za/ka/i0/zakai07gy34i3f7gjx8d-jtvpfy.png"></p><br><p>  Como o desenvolvimento funciona?  Distribui√ß√£o na prepara√ß√£o, a produ√ß√£o deve estar livre de erros.  Algo poderia quebrar aqui.  Se o lan√ßamento no ambiente de integra√ß√£o cair constantemente em erros, ser√° ruim.  Isso √© semelhante √† depura√ß√£o de aplicativos em uma m√°quina remota.  Quando um desenvolvedor desenvolve tudo em uma m√°quina, compila-o.  Se tudo compilar, envie-o para o reposit√≥rio.  Ele usa a mesma abordagem.  Os desenvolvedores usam o Visual Studio Code com plug-ins Ansible, Vagrant, Docker, etc.  Os desenvolvedores testam seu c√≥digo de infraestrutura em um vagrant local.  Surge um sistema operacional limpo.  Os scripts para elevar essa m√°quina tamb√©m est√£o neste reposit√≥rio com a infraestrutura de que falamos.  O desenvolvedor come√ßa a instalar um servidor FTP nele.  Se algo der errado, ele simplesmente a exclui, recarrega e tenta instalar o software necess√°rio usando scripts de implanta√ß√£o.  Depois de depurar os scripts de implanta√ß√£o, ele faz uma Solicita√ß√£o de Mesclagem na ramifica√ß√£o principal.  Ap√≥s mesclar a solicita√ß√£o de mesclagem, o IC reverte essas altera√ß√µes para o servidor de integra√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/6q/os/qq/6qosqq_jtbghh6dvamxnj1sdvru.png"></p><br><p>  Como todos os scripts s√£o c√≥digo, podemos escrever testes.  Digamos que instalamos o PostgreSQL.  Queremos verificar se funciona ou n√£o.  Para fazer isso, use o m√≥dulo de declara√ß√£o Ansible.  Compare a vers√£o instalada do PostgreSQL com a vers√£o nos scripts.  Assim, entendemos que ele est√° instalado, geralmente est√° em execu√ß√£o, √© a pr√≥pria vers√£o que esper√°vamos. </p><br><p><img src="https://habrastorage.org/webt/fc/3g/lf/fc3glflk8ozxdmpluhltv2a5mye.png"></p><br><p>  Vemos que o teste passou.  Portanto, nosso manual de instru√ß√µes funcionou corretamente.  Voc√™ pode escrever quantos testes quiser.  Eles s√£o idempotentes.  <strong>Idempot√™ncia</strong> (uma opera√ß√£o que, se aplicada a qualquer valor v√°rias vezes, sempre resulta no mesmo valor que em um √∫nico aplicativo).  Se voc√™ escrever scripts gratuitos para instala√ß√£o e configura√ß√£o, certifique-se de que seus scripts sempre obtenham o mesmo valor se forem executados v√°rias vezes. </p><br><p><img src="https://habrastorage.org/webt/cn/tx/zd/cntxzd9yeatgui-yml_a61pegsa.png"></p><br><p>  H√° outro tipo de teste que n√£o se relaciona diretamente ao teste de infraestrutura.  Mas eles parecem afet√°-lo indiretamente.  Estes s√£o testes de ponta a ponta.  Temos a infraestrutura e os pr√≥prios aplicativos s√£o instalados no mesmo servidor, testado pelos testadores.  Se rolamos algum tipo de infraestrutura incorreta, apenas testes complexos n√£o ser√£o aprovados.  Ou seja, nosso aplicativo funcionar√° de alguma maneira incorretamente.  Neste exemplo, instalamos uma nova vers√£o na produ√ß√£o - o aplicativo funciona.  Em seguida, um commit foi feito nos testes git e de ponta a ponta, que ocorrem √† noite, rastreando que aqui n√£o temos um arquivo no ftp.  Desmontamos esse caso e vemos que o problema est√° nas configura√ß√µes de ftp.  Corrigimos os scripts no c√≥digo, implantamos novamente e tudo fica verde.  A mesma hist√≥ria com o c√≥digo.  O c√≥digo de infraestrutura e a infraestrutura s√£o indiretamente testados de uma maneira ou de outra.  Em seguida, podemos implant√°-lo na produ√ß√£o. </p><br><p><img src="https://habrastorage.org/webt/mx/bo/e3/mxboe3llquz_vb46qalw6yir85m.png"></p><br><p>  Quando introduzimos essa abordagem, o CI (Teamcity), que implementou altera√ß√µes no servidor de integra√ß√£o, caiu 8 vezes em 10. Ningu√©m prestou aten√ß√£o a ela porque n√£o havia feedback.  Para os desenvolvedores, esses processos foram implementados por um longo tempo, mas as mensagens n√£o chegaram ao OPS (administradores de sistema).  Portanto, adicionamos um painel com as montagens deste projeto a um monitor grande em um local de destaque no escrit√≥rio.  Nele, v√°rios projetos s√£o destacados em <strong>verde</strong> - isso significa que tudo est√° em ordem com ele.  Se destacado em <strong>vermelho,</strong> significa que tudo est√° ruim com ele.  Vimos que alguns testes falharam.  Na apresenta√ß√£o, no lado esquerdo da segunda, de cima, vemos o resultado das implanta√ß√µes de implanta√ß√£o    .  ,    ,    ,   . :  -    .    .    Slack    ,   - - -    . </p><br><p><img src="https://habrastorage.org/webt/3b/bw/l1/3bbwl1jej_cien9satd3epefgqi.png"></p><br><p> Ok,     ,   ,    -  ,         .   trunk based .   Master  ‚Äî    .    Master  CI  (Teamcity)    integration .    CI  ,           integration .  release candidate.      .        .   ,  end-to-end  ,          staging .     production.         ,  staging     . </p><br><p><img src="https://habrastorage.org/webt/ut/lg/rb/utlgrbwe6gtssxn-ivmxwp3hpuc.png"></p><br><p>         .  ?   ,    PostgreSQL.      5     .    ,  .   1-2 .       .  ,  PostgreSQL      .      PostgreSQL  ,    staging, production 4 .   ,   ,         .          ,      .          - . </p><br><p><img src="https://habrastorage.org/webt/ts/28/cl/ts28clrdqnfeocxls1rudzn0k5i.png"></p><br><p>   git submodule     Ansible .       ,   .  git submodule  Ansible    .   inventories ,    .   30 .    git submodule         . </p><br><p><img src="https://habrastorage.org/webt/qx/y3/_w/qxy3_w7ra6n-35jnlc1oyhy_cew.png"></p><br><p>   :     ,           .   ,     ,     ,   staging    ,   . ,   ,   ,   ,   ,    ,     staging.       ‚Äî    , ,    -  . </p><br><p><img src="https://habrastorage.org/webt/mv/lv/nb/mvlvnbmp76dzsemwy9xdkv8nzda.png"></p><br><p>      6 .  ‚Äî   10  .            .      .    ,   . -    git submodule,         .      .      ,     ,      ,         .  ,       ,    . </p><br><p><img src="https://habrastorage.org/webt/tz/bm/n4/tzbmn4-jneygsmiecrtjudgw5ne.png"><br> . </p><br><p> -,   ,        :        ,   Ansible   git , : ‚Äú ,   - ‚Äù.     ?     git .   ,     .  100%  .  .       . </p><br><p>  ,     .    .   ,      RabbitMQ, ELK,    .     ,   ELK    .         ,  ,     ELK.    ELK,    ,    ELK  . </p><br><p>    ,    ,      ,   ,   .     , , ,   ,  .         ,     .       . </p><br><p>    .   ,    ,     ,  ,   ,  ,   .           git.    ,     ‚Äî    git,   ,  :     ,   -    .     . </p><br><p>   ,       ,    ,     code review.   ,     ,   .  ,    .  ,   , ,  ,  ,   .   ,    :      .   .          .     ,   - - . </p><br><p>    ,    . </p><br><p> :     ,       git submodule,        .     - ,     latest .      inventories.    ‚Äî   ,   .   , ,   ..  .  ‚Äî    .      . </p><br><p> :    -   Ansible          ( A   B, B  C      A,      )?   ,     ? </p><br><p> :      .      .  ,   -    IP  ,       ,   ,     ,      .       . ,      ,    ,    ,     ,  .        ,    -   ,  , , RabbitMQ     RabbitMQ,      . -      ,   . </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">PS: Sugiro que todos os interessados ‚Äã‚Äãem conjunto no github traduzam relat√≥rios interessantes de confer√™ncias para o texto. </font><font style="vertical-align: inherit;">Voc√™ pode formar um grupo no github para tradu√ß√£o. </font><font style="vertical-align: inherit;">At√© agora, estou traduzindo para texto na minha </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conta do github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - voc√™ tamb√©m pode enviar uma solicita√ß√£o Pull para corrigir um artigo l√°.</font></font></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt438748/">https://habr.com/ru/post/pt438748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt438732/index.html">Medi√ß√µes de r√°dio amador: An√°lise de sinal de barramento I2C</a></li>
<li><a href="../pt438734/index.html">Emaranhado de pessoas afins</a></li>
<li><a href="../pt438736/index.html">DevDay for Managers: gerenciar TI</a></li>
<li><a href="../pt438740/index.html">Gerenciando segredos com o HashiCorp Vault</a></li>
<li><a href="../pt438746/index.html">No caminho para os princ√≠pios f√≠sicos da evolu√ß√£o biol√≥gica. Continua√ß√£o</a></li>
<li><a href="../pt438752/index.html">Contabilidade diretamente no banco: como fazer felizes os empreendedores individuais</a></li>
<li><a href="../pt438754/index.html">Como fizemos o monitoramento de rede para 14.000 objetos</a></li>
<li><a href="../pt438756/index.html">Sexta verifica√ß√£o de cromo, posf√°cio</a></li>
<li><a href="../pt438758/index.html">Por que o Google altera a interface de URL padr√£o no navegador</a></li>
<li><a href="../pt438762/index.html">DBX: tente se livrar da compila√ß√£o de consultas MySQL</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>