<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚è≥ ‚öæÔ∏è üõÄüèø Unity3D ECS und Job System üêê üçà üçã</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mit Unity3D wurde es mit der Ver√∂ffentlichung der Version 2018 m√∂glich, das native (f√ºr Unity) ECS-System zu verwenden, das mit Multithreading in Form...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Unity3D ECS und Job System</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413897/"> Mit Unity3D wurde es mit der Ver√∂ffentlichung der Version 2018 m√∂glich, das native (f√ºr Unity) ECS-System zu verwenden, das mit Multithreading in Form eines Jobsystems ausgestattet ist.  Es gibt nicht viele Materialien im Internet (einige Projekte von Unity Technologies selbst und einige Schulungsvideos auf YouTube).  Ich habe versucht, den Umfang und die Bequemlichkeit von ECS zu erkennen und ein kleines Projekt zu erstellen, das nicht aus W√ºrfeln und Kn√∂pfen besteht.  Zuvor hatte ich keine Erfahrung mit dem Entwerfen von ECS, daher dauerte es zwei Tage, um Materialien zu studieren und das Denken mit OOP wieder aufzubauen, einen Tag, um sich an dem Ansatz zu erfreuen, und ein oder zwei Tage, um ein Projekt zu entwickeln, die Einheit zu bek√§mpfen, Haare herauszuziehen und Proben zu rauchen .  Der Artikel enth√§lt ein bisschen Theorie und ein kleines Beispielprojekt. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/wv/hc/vs/wvhcvsphuk6bci024xzqap-_b0y.png"></div><a name="habracut"></a><br>  Die Bedeutung von ECS ist recht einfach - eine Entit√§t ( <b>Entit√§t</b> ) mit ihren Komponenten ( <b>Komponente</b> ), die vom System ( <b>System</b> ) verarbeitet werden. <br><br><h4>  Essenz </h4><br>  Die Entit√§t hat keine Logik und speichert nur Komponenten (sehr √§hnlich zu GameObject im alten CPC-Ansatz).  In Unity ECS existiert hierf√ºr die Entity-Klasse. <br><br><h4>  Komponente </h4><br>  Komponenten speichern nur Daten und enthalten manchmal √ºberhaupt nichts und sind ein einfacher Marker f√ºr die Verarbeitung durch das System.  Aber sie haben keine Logik.  Von ComponentDataWrapper geerbt.  Es kann von einem anderen Thread verarbeitet werden (aber es gibt eine Nuance). <br><br><h4>  Das System </h4><br>  Systeme sind f√ºr die Verarbeitung von Komponenten verantwortlich.  Bei der Eingabe erhalten sie von Unity eine Liste der verarbeiteten Komponenten f√ºr die angegebenen Typen, und bei √ºberladenen Methoden (Analoga von Update, Start, OnDestroy) tritt die Magie der Spielmechanik auf.  Von ComponentSystem oder JobComponentSystem geerbt. <br><br><h2>  Jobsystem </h2><br>  Die Mechanik von Systemen, die die parallele Verarbeitung von Bauteilen erm√∂glichen.  Im OnUpdate-System wird eine Jobstruktur erstellt und der Verarbeitung hinzugef√ºgt.  In einem Moment der Langeweile und der freien Ressourcen wird Unity die Ergebnisse verarbeiten und auf die Komponenten anwenden. <br><br><h3>  Multithreading und Einheit 2018 </h3><br>  Alle Job System-Arbeiten finden in anderen Threads statt, und Standardkomponenten (Transform, Rigidbody usw.) k√∂nnen in keinem Thread au√üer dem Haupt-Thread ge√§ndert werden.  Daher enth√§lt das Standardpaket kompatible Ersatzkomponenten - Positionskomponente, Rotationskomponente, Renderer-Komponente f√ºr Netzinstanzen. <br><br>  Gleiches gilt f√ºr Standardstrukturen wie Vector3 oder Quaternion.  Die Komponenten f√ºr die Parallelisierung verwenden nur die einfachsten Datentypen (float3, float4, das ist alles, Grafikprogrammierer werden sich freuen), die dem Unity.Mathematics-Namespace hinzugef√ºgt wurden. Es gibt auch eine Mathematikklasse, um sie zu verarbeiten.  Keine Strings, keine Referenztypen, nur Hardcore. <br><br><h2>  "Zeig mir den Code" </h2><br>  Also Zeit, etwas zu bewegen! <br><br>  Erstellen Sie eine Komponente, die den Geschwindigkeitswert speichert und gleichzeitig eine der Markierungen f√ºr das System ist, das Objekte bewegt.  Mit dem Attribut Serializable k√∂nnen Sie den Wert im Inspektor festlegen und verfolgen. <br><br><div class="spoiler">  <b class="spoiler_title">Speedcompponent</b> <div class="spoiler_text"><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> SpeedData : IComponentData { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Value; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SpeedComponent</span></span> : <span class="hljs-title"><span class="hljs-title">ComponentDataWrapper</span></span>&lt;<span class="hljs-title"><span class="hljs-title">SpeedData</span></span>&gt; {}</code> </pre> <br></div></div><br>  Mit dem Inject-Attribut erh√§lt das System eine Struktur, die nur Komponenten der Entit√§ten enth√§lt, auf denen alle drei Komponenten vorhanden sind.  Wenn also eine Entit√§t √ºber PositionComponent- und SpeedComponent-Komponenten verf√ºgt, jedoch nicht √ºber RotationComponent, wird diese Entit√§t nicht zur Struktur hinzugef√ºgt, die in das System eintritt.  Somit ist es m√∂glich, Entit√§ten nach dem Vorhandensein einer Komponente zu filtern. <br><br><div class="spoiler">  <b class="spoiler_title">Bewegungssystem</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovementSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ComponentSystem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> ShipsPositions { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Length; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;Position&gt; Positions; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;Rotation&gt; Rotations; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;SpeedData&gt; Speeds; } [Inject] ShipsPositions _shipsMovementData; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _shipsMovementData.Length; i++) { _shipsMovementData.Positions[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Position(_shipsMovementData.Positions[i].Value + math.forward(_shipsMovementData.Rotations[i].Value) * Time.deltaTime * _shipsMovementData.Speeds[i].Value); } } }</code> </pre> <br></div></div><br>  Jetzt bewegen sich alle Objekte, die diese drei Komponenten enthalten, mit einer bestimmten Geschwindigkeit vorw√§rts. <br><br><div class="spoiler">  <b class="spoiler_title">Wiiiii</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/eu/77/w8/eu77w8rnfiar24lcjzttovjf448.gif"><br></div></div><br>  Es war einfach.  Obwohl es einen Tag gedauert hat, √ºber ECS nachzudenken. <br><br>  Aber h√∂r auf.  Wo ist das Jobsystem hier? <br><br>  Tatsache ist, dass nichts kaputt genug ist, um Multithreading zu verwenden.  Zeit zu brechen! <br><br>  Ich habe aus den Proben das System gezogen, aus dem die Fertigh√§user hervorgehen.  Von interessant - hier ist ein St√ºck Code: <br><br><div class="spoiler">  <b class="spoiler_title">Spawner</b> <div class="spoiler_text"><pre> <code class="cs hljs">EntityManager.Instantiate(prefab, entities); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Position { Value = spawnPositions[i] }; EntityManager.SetComponentData(entities[i], position); EntityManager.SetComponentData(entities[i], <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpeedData { Value = Random.Range(<span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-number"><span class="hljs-number">25</span></span>) }); }</code> </pre> <br></div></div><br>  Lassen Sie uns also 1000 Objekte platzieren.  Immer noch zu gut, um Netze auf der GPU zu instanziieren.  5000 - auch ca.  Ich werde zeigen, was mit 50.000 Objekten passiert. <br><br>  Der Entity Debugger wurde in Unity angezeigt und zeigt an, wie viele ms jedes System ben√∂tigt.  Systeme k√∂nnen direkt zur Laufzeit ein- und ausgeschaltet werden, um zu sehen, welche Objekte sie im Allgemeinen verarbeiten, was unersetzlich ist. <br><br><div class="spoiler">  <b class="spoiler_title">Holen Sie sich so einen Raumschiffball</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/0u/it/gc/0uitgcq7f3mwv69-ufrjvqr55ls.gif"><br></div></div><br>  Das Tool zeichnet mit einer Geschwindigkeit von 15 fps auf, sodass der springende Punkt in den Zahlen in der Liste der Systeme liegt.  Unser MovementSystem versucht, alle 50.000 Objekte in jedem Frame zu verschieben, und zwar im Durchschnitt in 60 ms.  Jetzt ist das Spiel also kaputt genug f√ºr die Optimierung. <br>  Wir befestigen das JobSystem am Bewegungssystem. <br><br><div class="spoiler">  <b class="spoiler_title">Modifiziertes Bewegungssystem</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MovementSystem</span></span> : <span class="hljs-title"><span class="hljs-title">JobComponentSystem</span></span> { [ComputeJobOptimization] <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> MoveShipJob : IJobProcessComponentData&lt;Position, Rotation, SpeedData&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Position position, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Rotation rotation, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">ref</span></span></span></span><span class="hljs-function"><span class="hljs-params"> SpeedData speed</span></span></span><span class="hljs-function">)</span></span> { position.Value += math.forward(rotation.Value) * dt * speed.Value; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> JobHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JobHandle inputDeps</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> job = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MoveShipJob { dt = Time.deltaTime }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> job.Schedule(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, inputDeps); } }</code> </pre> <br></div></div><br>  Jetzt erbt das System von JobComponentSystem und erstellt in jedem Frame einen speziellen Handler, an den Unity die gleichen 3 Komponenten und deltaTime vom System √ºbertr√§gt. <br><br><div class="spoiler">  <b class="spoiler_title">Starten Sie das Raumschiff erneut</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/tq/ys/u0/tqysu0ut41v8om_s4ocpg6f1sbc.gif"><br></div></div><br>  0,15 ms (0,4 am Peak, ja) gegen√ºber 50-70!  50.000 Objekte!  Ich gab diese Zahlen in den Taschenrechner ein, als Antwort zeigte er ein gl√ºckliches Gesicht. <br><br><h2>  Management </h2><br>  Sie k√∂nnen endlos einen fliegenden Ball betrachten oder zwischen den Schiffen fliegen. <br>  Ben√∂tigen Sie ein Rollsystem. <br><br>  Die Rotationskomponente befindet sich bereits im Fertighaus. Erstellen Sie eine Komponente zum Speichern von Steuerelementen. <br><br><div class="spoiler">  <b class="spoiler_title">Steuerkomponente</b> <div class="spoiler_text"><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Serializable</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RotationControlData : IComponentData { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> roll; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pitch; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> yaw; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ControlComponent</span></span> : <span class="hljs-title"><span class="hljs-title">ComponentDataWrapper</span></span>&lt;<span class="hljs-title"><span class="hljs-title">RotationControlData</span></span>&gt;{}</code> </pre> <br></div></div><br>  Wir brauchen auch eine Spielerkomponente (obwohl es kein Problem ist, alle 50.000 Schiffe gleichzeitig zu steuern). <br><br><div class="spoiler">  <b class="spoiler_title">PlayerComponent</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> PlayerData : IComponentData { } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">PlayerComponent</span></span> : <span class="hljs-title"><span class="hljs-title">ComponentDataWrapper</span></span>&lt;<span class="hljs-title"><span class="hljs-title">PlayerData</span></span>&gt; { }</code> </pre> <br></div></div><br>  Und sofort ein User Input Reader. <br><br><div class="spoiler">  <b class="spoiler_title">UserControlSystem</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserControlSystem</span></span> : <span class="hljs-title"><span class="hljs-title">ComponentSystem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> InputPlayerData { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Length; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;PlayerData&gt; Data; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;RotationControlData&gt; Controls; } [Inject] InputPlayerData _playerData; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _playerData.Length; i++) { _playerData.Controls[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RotationControlData { roll = Input.GetAxis(<span class="hljs-string"><span class="hljs-string">"Horizontal"</span></span>), pitch = Input.GetAxis(<span class="hljs-string"><span class="hljs-string">"Vertical"</span></span>), yaw = Input.GetKey(KeyCode.Q) ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : Input.GetKey(KeyCode.E) ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span> }; } } }</code> </pre> <br></div></div><br>  Anstelle des Standardeingangs kann es jedes Lieblingsfahrrad oder jede KI geben. <br><br>  Und schlie√ülich die Verarbeitungssteuerung und die Wende selbst.  Ich war mit der Tatsache konfrontiert, dass math.euler noch nicht implementiert wurde, und so rettete mich ein schneller Angriff auf Wikipedia vor der Konvertierung von Eulers Ecken in das Quaternion. <br><br><div class="spoiler">  <b class="spoiler_title">ProcessRotationInputSystem</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProcessRotationInputSystem</span></span> : <span class="hljs-title"><span class="hljs-title">JobComponentSystem</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> LocalRotationSpeedGroup { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;Rotation&gt; rotations; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;RotationSpeedData&gt; rotationSpeeds; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;RotationControlData&gt; controlData; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Length; } [Inject] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> LocalRotationSpeedGroup _rotationGroup; [ComputeJobOptimization] <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> RotateJob : IJobParallelFor { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;Rotation&gt; rotations; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;RotationSpeedData&gt; rotationSpeeds; [ReadOnly] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ComponentDataArray&lt;RotationControlData&gt; controlData; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> dt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> i</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> speed = rotationSpeeds[i].Value; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (speed &gt; <span class="hljs-number"><span class="hljs-number">0.0f</span></span>) { quaternion nRotation = math.normalize(rotations[i].Value); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> yaw = controlData[i].yaw * speed * dt; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> pitch = controlData[i].pitch * speed * dt; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> roll = -controlData[i].roll * speed * dt; quaternion result = math.mul(nRotation, Euler(pitch, roll, yaw)); rotations[i] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rotation { Value = result }; } } <span class="hljs-function"><span class="hljs-function">quaternion </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Euler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> roll, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> yaw, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pitch</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> cy = math.cos(yaw * <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> sy = math.sin(yaw * <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> cr = math.cos(roll * <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> sr = math.sin(roll * <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> cp = math.cos(pitch * <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> sp = math.sin(pitch * <span class="hljs-number"><span class="hljs-number">0.5f</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> qw = cy * cr * cp + sy * sr * sp; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> qx = cy * sr * cp - sy * cr * sp; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> qy = cy * cr * sp + sy * sr * cp; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> qz = sy * cr * cp - cy * sr * sp; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> quaternion(qx, qy, qz, qw); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> JobHandle </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnUpdate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">JobHandle inputDeps</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> job = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RotateJob { rotations = _rotationGroup.rotations, rotationSpeeds = _rotationGroup.rotationSpeeds, controlData = _rotationGroup.controlData, dt = Time.deltaTime }; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> job.Schedule(_rotationGroup.Length, <span class="hljs-number"><span class="hljs-number">64</span></span>, inputDeps); } }</code> </pre> <br></div></div><br>  Sie werden sich wahrscheinlich fragen, warum Sie nicht wie in MovementSystem einfach 3 Komponenten gleichzeitig an Job √ºbergeben k√∂nnen.  Weil.  Ich hatte lange damit zu k√§mpfen, aber ich wei√ü nicht, warum es so nicht funktioniert.  In Beispielen werden Turns √ºber ComponentDataArray implementiert, aber wir werden nicht von den Kanonen zur√ºcktreten. <br><br>  Wir werfen das Fertighaus auf die B√ºhne, h√§ngen die Komponenten auf, binden die Kamera, legen langweilige Tapeten auf und gehen! <br><br><img src="https://habrastorage.org/webt/kq/ui/8b/kqui8b_6g4wyedwa3pv2vcaht_a.png"><br><br><h2>  Fazit </h2><br>  Die Jungs von Unity Technologies haben sich in die richtige Richtung des Multithreading bewegt.  Das Job-System selbst ist noch feucht (die Alpha-Version ist es immerhin), aber es ist ziemlich brauchbar und beschleunigt sich jetzt.  Leider sind die Standardkomponenten nicht mit dem Job-System kompatibel (aber nicht separat mit dem ECS!). Sie m√ºssen also Kr√ºcken formen, um dies zu umgehen.  Beispielsweise implementiert eine Person aus dem Unity-Forum ihr physisches System f√ºr die GPU und macht √§hnliche Fortschritte. <br>  ECS mit Unity wurde schon fr√ºher verwendet, es gibt mehrere wohlhabende Analoga, zum Beispiel <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">einen Artikel mit einem √úberblick √ºber die</a> bekanntesten.  Es beschreibt auch die Vor- und Nachteile dieses Architekturansatzes. <br><br>  Von mir selbst kann ich ein Plus wie die Reinheit des Codes hinzuf√ºgen.  Ich habe zun√§chst versucht, Bewegung in einem System zu implementieren.  Die Anzahl der Abh√§ngigkeitskomponenten wuchs schnell und ich musste den Code in kleine und bequeme Systeme aufteilen.  Und sie k√∂nnen problemlos in einem anderen Projekt wiederverwendet werden. <br><br>  Der Projektcode ist hier: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">GitHub</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de413897/">https://habr.com/ru/post/de413897/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de413885/index.html">Cavium ThunderX2-Evaluierung: Der Arm Server-Traum wird wahr (Teil 1, Einf√ºhrung)</a></li>
<li><a href="../de413889/index.html">Verpasste Frist oder warum mehr als die H√§lfte der Unternehmen nicht f√ºr die DSGVO bereit waren</a></li>
<li><a href="../de413891/index.html">Wie ist das einheitliche staatliche Register der juristischen Personen - ein einheitliches staatliches Register der juristischen Personen?</a></li>
<li><a href="../de413893/index.html">Ein Loch als Sicherheitswerkzeug - 2 oder wie man APT "lebende K√∂der" f√§ngt</a></li>
<li><a href="../de413895/index.html">Ein billiges Fitness-Armband hacken</a></li>
<li><a href="../de413899/index.html">Biometrische personenbezogene Daten von Russen</a></li>
<li><a href="../de413901/index.html">Steuerung des selbstausgleichenden EduMip-Roboters mit dem PS4 Dualshock 4 Joystick √ºber ROS</a></li>
<li><a href="../de413903/index.html">Wie Cambridge Analytica Klicks in Stimmen verwandelt</a></li>
<li><a href="../de413907/index.html">Die Zusammenfassung interessanter Materialien f√ºr den mobilen Entwickler # 256 (4. Juni - 12. Juni)</a></li>
<li><a href="../de413909/index.html">Dort sind deine Kindheitserinnerungen geblieben</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>