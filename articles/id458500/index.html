<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ğŸ‘©ğŸ¾â€ğŸ­ ğŸ¤ğŸ¼ âœ³ï¸ Metamorfosis dari pengujian redux-saga ğŸ ğŸˆ ğŸ‘¨â€â¤ï¸â€ğŸ‘¨</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kerangka kerja redux-saga menyediakan banyak pola menarik untuk bekerja dengan efek samping, tetapi, seperti pengembang perusahaan yang benar-benar be...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Metamorfosis dari pengujian redux-saga</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/dodopizzadev/blog/458500/"> Kerangka kerja <code>redux-saga</code> menyediakan banyak pola menarik untuk bekerja dengan efek samping, tetapi, seperti pengembang perusahaan yang benar-benar berdarah, kita perlu menutupi seluruh kode kita dengan pengujian.  Mari kita cari tahu bagaimana kita akan menguji kisah-kisah kita. <br><br><img src="https://habrastorage.org/webt/bo/ex/ix/boexix6wnmkabte_okdbvippk2i.png"><br><a name="habracut"></a><br>  Ambil clicker paling sederhana sebagai contoh.  Alur data dan makna aplikasi adalah sebagai berikut: <br><br><ol><li>  Pengguna menekan tombol. </li><li>  Permintaan dikirim ke server, menginformasikan bahwa pengguna telah menekan tombol. </li><li>  Server mengembalikan jumlah klik yang dilakukan. </li><li>  Negara mencatat jumlah klik yang dilakukan. </li><li>  UI diperbarui, dan pengguna melihat bahwa jumlah klik telah meningkat. </li><li>  ... </li><li>  KEUNTUNGAN. </li></ol><br>  Dalam pekerjaan kami, kami menggunakan naskah, jadi semua contoh akan ada dalam bahasa ini. <br><br>  Seperti yang mungkin sudah Anda tebak, kami akan menerapkan semua ini dengan <code>redux-saga</code> .  Berikut adalah kode untuk seluruh file kisah: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> call(ServerApi.SendClick) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> put(Actions.clickSuccess(result)) } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">watchClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> takeEvery(ActionTypes.CLICK, processClick) }</code> </pre><br>  Dalam contoh sederhana ini, kami mendeklarasikan saga <code>processClick</code> , yang secara langsung memproses aksi dan saga <code>watchClick</code> , yang membuat loop untuk memproses <code>action'</code> . <br><br><h2>  Generator </h2><br>  Jadi kami memiliki kisah yang paling sederhana.  Ia mengirimkan permintaan ke server <code>( call)</code> , menerima hasilnya dan meneruskannya ke peredam <code>( put)</code> .  Kita perlu entah bagaimana menguji apakah kisah itu mentransmisikan persis apa yang diterimanya dari server.  Mari kita mulai. <br><br>  Untuk pengujian, kita perlu mengunci panggilan server dan entah bagaimana memeriksa apakah persis apa yang datang dari server masuk ke peredam. <br><br>  Karena sagas adalah fungsi generator, metode <code>next()</code> , yang ada dalam prototipe generator, akan menjadi cara yang paling jelas untuk menguji.  Saat menggunakan metode ini, kami memiliki kesempatan untuk menerima nilai berikutnya dari generator dan mentransfer nilai ke generator.  Dengan demikian, kita keluar dari kotak kesempatan untuk mendapatkan panggilan basah.  Tapi apakah semuanya begitu cerah?  Berikut adalah tes yang saya tulis pada generator kosong: <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">'should increment click counter (behaviour test)'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> saga = processClick() expect(saga.next().value).toEqual(call(ServerApi.SendClick)) expect(saga.next(<span class="hljs-number"><span class="hljs-number">10</span></span>).value).toEqual(put(Actions.clickSuccess(<span class="hljs-number"><span class="hljs-number">10</span></span>))) })</code> </pre><br>  Tesnya singkat, tapi apa tesnya?  Bahkan, itu hanya mengulangi kode metode saga, yaitu, dengan perubahan apa pun dalam saga, tes harus diubah. <br><br><blockquote>  Tes semacam itu tidak membantu dalam pengembangan. </blockquote><br><h2>  Rencana uji redux-saga </h2><br>  Setelah menghadapi masalah ini, kami memutuskan untuk mencari di google dan tiba-tiba menyadari bahwa kami bukan satu-satunya dan jauh dari yang pertama.  Langsung <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">dalam dokumentasi</a> untuk <code>redux-saga</code> pengembang menawarkan beberapa perpustakaan yang dibuat khusus untuk memuaskan penggemar pengujian. <br><br>  Dari daftar yang diusulkan kami mengambil perpustakaan <code>redux-saga-test-plan</code> .  Berikut adalah kode untuk versi pertama dari tes yang saya tulis dengannya: <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">'should increment click counter (behaviour test with test-plan)'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expectSaga(processClick) .provide([ call(ServerApi.SendClick), <span class="hljs-number"><span class="hljs-number">2</span></span>] ]) .dispatch(Actions.click()) .call(ServerApi.SendClick) .put(Actions.clickSuccess(<span class="hljs-number"><span class="hljs-number">2</span></span>)) .run() })</code> </pre><br>  Konstruktor tes di <code>redux-saga-test-plan</code> adalah fungsi <code>expectSaga</code> , yang mengembalikan antarmuka yang menggambarkan tes.  Test saga ( <code>processClick</code> dari daftar pertama) diteruskan ke fungsi itu sendiri. <br><br>  Menggunakan metode <code>provide</code> , Anda dapat memblokir panggilan server atau dependensi lainnya.  Array <code>StaticProvider'</code> , yang menggambarkan metode mana yang harus dikembalikan. <br><br>  Di blok <code>Act</code> , kami memiliki satu metode tunggal - <code>dispatch</code> .  Suatu tindakan diberikan padanya, yang akan direspon oleh hikayat tersebut. <br><br>  Blok <code>assert</code> terdiri dari metode <code>call  put</code> , yang memeriksa apakah efek yang sesuai disebabkan selama pekerjaan saga. <br><br>  Semuanya berakhir dengan metode <code>run()</code> .  Metode ini menjalankan tes secara langsung. <br><br><blockquote>  <b>Keuntungan dari pendekatan ini:</b> <br><br><ul><li>  Ia memeriksa apakah metode itu dipanggil, dan bukan urutan panggilan; </li><li>  moki dengan jelas menjelaskan fungsi mana yang basah dan apa yang kembali. </li></ul><br>  <b>Namun, ada pekerjaan yang harus dilakukan:</b> <br><br><ul><li>  ada lebih banyak kode; </li><li>  tesnya sulit dibaca; </li><li>  ini adalah tes untuk perilaku, yang berarti masih terhubung dengan implementasi saga. </li></ul></blockquote><br><h2>  Dua pukulan terakhir </h2><br><h4>  Tes kondisi </h4><br>  Pertama, kami memperbaiki yang terakhir: kami membuat tes keadaan dari tes perilaku.  Fakta bahwa <code>test-plan</code> memungkinkan Anda untuk mengatur <code>state</code> awal dan lulus <code>reducer</code> , yang harus menanggapi efek <code>put</code> dihasilkan oleh saga, akan membantu kami dengan ini.  Ini terlihat seperti ini: <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">'should increment click counter (state test with test-plan)'</span></span>, () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> initialState = { <span class="hljs-attr"><span class="hljs-attr">clickCount</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> expectSaga(processClick) .provide([ call(ServerApi.SendClick), <span class="hljs-number"><span class="hljs-number">14</span></span>] ]) .withReducer(rootReducer, initialState) .dispatch(Actions.click()) .run() .then(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function"> =&gt;</span></span> expect(result.storeState.clickCount).toBe(<span class="hljs-number"><span class="hljs-number">14</span></span>)) })</code> </pre><br>  Dalam tes ini, kami tidak lagi memverifikasi bahwa ada efek yang dipicu.  Kami memeriksa status akhir setelah eksekusi, dan itu tidak masalah. <br><br>  Kami berhasil menyingkirkan implementasi saga, sekarang mari kita coba membuat tes lebih dimengerti.  Ini mudah jika Anda mengganti <code>then()</code> dengan <code>async/await</code> : <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">'should increment click counter (state test with test-plan async-way)'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> initialState = { <span class="hljs-attr"><span class="hljs-attr">clickCount</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> saga = expectSaga(processClick) .provide([ call(ServerApi.SendClick), <span class="hljs-number"><span class="hljs-number">14</span></span>] ]) .withReducer(rootReducer, initialState) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> saga.dispatch(Actions.click()).run() expect(result.storeState.clickCount).toBe(<span class="hljs-number"><span class="hljs-number">14</span></span>) })</code> </pre><br><h4>  Tes integrasi </h4><br>  Tetapi bagaimana jika kita juga mendapatkan operasi klik terbalik (sebut saja batalkan klik), dan sekarang file jebol kami terlihat seperti ini: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> call(ServerApi.SendClick) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> put(Actions.clickSuccess(result)) } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processUnclick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> call(ServerApi.SendUnclick) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> put(Actions.clickSuccess(result)) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">watchClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> takeEvery(ActionTypes.CLICK, processClick) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">watchUnclick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> takeEvery(ActionTypes.UNCLICK, processUnclick) } <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">* </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mainSaga</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> all([watchClick(), watchUnclick()]) }</code> </pre><br>  Misalkan kita perlu menguji bahwa ketika tindakan klik dan hapus klik disebut dalam status, hasil dari perjalanan terakhir ke server ditulis ke status.  Tes semacam itu juga dapat dengan mudah dilakukan dengan <code>redux-saga-test-plan</code> : <br><br><pre> <code class="javascript hljs">it(<span class="hljs-string"><span class="hljs-string">'should change click counter (integration test)'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> () =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> initialState = { <span class="hljs-attr"><span class="hljs-attr">clickCount</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, } <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> saga = expectSaga(mainSaga) .provide([ call(ServerApi.SendClick), <span class="hljs-number"><span class="hljs-number">14</span></span>], call(ServerApi.SendUnclick), <span class="hljs-number"><span class="hljs-number">18</span></span>] ]) .withReducer(rootReducer, initialState) <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> result = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> saga .dispatch(Actions.click()) .dispatch(Actions.unclick()) .run() expect(result.storeState.clickCount).toBe(<span class="hljs-number"><span class="hljs-number">18</span></span>) })</code> </pre><br>  Harap dicatat bahwa sekarang kami sedang menguji <code>mainSaga</code> , dan bukan penangan <code>mainSaga</code> individu. <br><br>  Namun, jika kita menjalankan tes ini apa adanya, kita akan mendapatkan Vorning: <br><br><img src="https://habrastorage.org/webt/j3/-k/fz/j3-kfzdcrzhhsnhlapzuecdts2m.png"><br><br>  Ini karena efek <code>takeEvery</code> - ini adalah loop pemrosesan pesan yang akan berfungsi saat aplikasi kita terbuka.  Oleh karena itu, tes yang disebut <code>takeEvery</code> tidak akan dapat menyelesaikan pekerjaan tanpa bantuan dari luar, dan <code>redux-saga-test-plan</code> secara paksa mengakhiri efek ini setelah 250 ms setelah dimulainya tes.  Waktu habis ini dapat diubah dengan memanggil expectSaga.DEFAULT_TIMEOUT = 50. <br><blockquote>  Jika Anda tidak ingin menerima penilaian seperti itu, satu tes untuk setiap tes dengan efek kompleks, cukup gunakan metode <code>silentRun()</code> alih-alih metode <code>run()</code> . </blockquote><br><hr><br><h2>  Perangkap </h2><br>  Di mana tanpa jebakan ... Pada saat penulisan ini, versi terbaru redux-saga: 1.0.2.  Pada saat yang sama, <code>redux-saga-test-plan</code> hanya dapat bekerja dengannya di JS. <br><br>  Jika Anda ingin TypeScript, Anda harus menginstal versi dari saluran beta: <br> <code>npm install redux-saga-test-plan@beta</code> <br>  dan matikan tes dari build.  Untuk melakukan ini, dalam file tsconfig.json, Anda perlu menentukan path "./src/**/*.spec.ts" di bidang "kecualikan". <br><br>  Meskipun demikian, kami menganggap <code>redux-saga-test-plan</code> pustaka terbaik untuk pengujian <code>redux-saga</code> .  Jika Anda memiliki <code>redux-saga</code> di proyek Anda, mungkin itu akan menjadi pilihan yang baik untuk Anda. <br><br>  Kode sumber contoh di <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=id&amp;u=">GitHub</a> . </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id458500/">https://habr.com/ru/post/id458500/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id458490/index.html">Pegang erat-erat ke roda kemudi ... Proyek kami untuk memantau kondisi pengemudi</a></li>
<li><a href="../id458492/index.html">â€œKami selalu percaya pada kompetisi dan hak untuk memilih penggunaâ€ Â© Yandex</a></li>
<li><a href="../id458494/index.html">Contoh praktis menggunakan fungsi render Vue: membuat kisi tipografi untuk sistem desain</a></li>
<li><a href="../id458496/index.html">Pedoman praktis untuk mengembangkan aplikasi Bereaksi skala besar. Perencanaan, Tindakan, Sumber Data, dan API</a></li>
<li><a href="../id458498/index.html">Pedoman praktis untuk mengembangkan aplikasi Bereaksi skala besar. Bagian 2: manajemen negara, perutean</a></li>
<li><a href="../id458502/index.html">Rahasia utama untuk mengembangkan aplikasi Elektron yang baik</a></li>
<li><a href="../id458504/index.html">Trik 13 npm untuk menghemat waktu</a></li>
<li><a href="../id458506/index.html">Bukan Portal 3, tapi tutup: teleportasi kuantum informasi di dalam berlian</a></li>
<li><a href="../id458508/index.html">Pandangan dari dalam: sekolah pascasarjana di EPFL. Bagian 4.2: sisi keuangan</a></li>
<li><a href="../id458514/index.html">Pelanggaran GDPR dihukum lebih aktif - denda baru dan dampak peraturan di luar UE</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>