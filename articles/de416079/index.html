<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>📎 🧔🏻 🏪 Corona Native für Android - Verwenden von benutzerdefiniertem Java-Code in einem in Corona geschriebenen Spiel 💅🏼 👨🏿‍🤝‍👨🏾 ☝️</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Mit der Corona Game Engine können Sie plattformübergreifende Anwendungen und Spiele erstellen. Aber manchmal reicht die von ihnen bereitgestellte API ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Corona Native für Android - Verwenden von benutzerdefiniertem Java-Code in einem in Corona geschriebenen Spiel</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/416079/"><p>  Mit der Corona Game Engine können Sie plattformübergreifende Anwendungen und Spiele erstellen.  Aber manchmal reicht die von ihnen bereitgestellte API nicht aus.  In solchen Fällen gibt es <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Corona Native</a> , mit dem Sie die Funktionalität mithilfe von nativem Code für jede Plattform erweitern können. </p><br><p>  Dieser Artikel beschreibt die Verwendung von Java in Corona-Projekten für Android </p><br><p>  Um zu verstehen, was in diesem Artikel passiert, benötigen Sie Grundkenntnisse in Java, Lua und der Corona-Engine </p><a name="habracut"></a><br><h1 id="nachalo-raboty">  Erste Schritte </h1><br><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Corona</a> und <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Android Studio</a> müssen auf dem Computer installiert sein </p><br><p>  Der Corona-Installationsordner enthält auch die Projektvorlage: Native \ Projektvorlage \ App.  Kopieren Sie den gesamten Ordner und benennen Sie ihn in den Namen Ihres Projekts um. </p><br><h2 id="nastroyka-shablona">  Vorlagenanpassung </h2><br><p> <em>Hinweis: Ich habe den neuesten öffentlichen Build für Corona verwendet - <strong>2017.3184</strong> .</em>  <em>In neuen Versionen kann sich die Vorlage ändern, und einige Vorbereitungen aus diesem Kapitel sind nicht mehr erforderlich.</em> </p><br><p>  Für Android benötigen wir 2 Ordner: <strong>Corona</strong> und <strong>Android</strong> </p><br><p>  Löschen Sie <strong>Images.xcassets</strong> und <strong>LaunchScreen.storyboardc</strong> aus dem <strong>Corona-</strong> Ordner. Diese Ordner werden nicht benötigt.  In der Datei <strong>main.lua</strong> löschen <strong>wir</strong> auch den gesamten Code - wir beginnen mit der Erstellung des Projekts von Grund auf neu.  <em>Wenn Sie ein vorhandenes Projekt verwenden möchten, ersetzen Sie alle Dateien im Corona-Ordner durch Ihre eigenen</em> </p><br><p>  Der <strong>Android-</strong> Ordner ist ein fertiges Projekt für Android Studio, wir müssen es öffnen.  Die erste Nachricht aus dem Studio lautet "Gradle-Synchronisierung fehlgeschlagen".  Build.gradle muss repariert werden: </p><br><p><img src="https://habrastorage.org/webt/im/qq/2c/imqq2cvcg9ks3eyy6nswk2_k1x0.png" alt="Gradle bauen"></p><br><p>  Fügen Sie einen Link zu Repositorys in Buildscript hinzu, um die Situation zu beheben.  Ich habe auch die Version im Klassenpfad 'com.android.tools.build:gradle' in eine neuere geändert. </p><br><div class="spoiler">  <b class="spoiler_title">Build.gradle-Code</b> <div class="spoiler_text"><pre><code class="hljs pgsql">// Top-<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> build file <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> you can <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">configuration</span></span> <span class="hljs-keyword"><span class="hljs-keyword">options</span></span> common <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> sub-projects/modules. buildscript { dependencies { classpath <span class="hljs-string"><span class="hljs-string">'com.android.tools.build:gradle:3.1.3'</span></span> } repositories { jcenter() google() } } allprojects { repositories { jcenter() google() } } task clean(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">Delete</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> rootProject.buildDir }</code> </pre> </div></div><br><p>  Der nächste Schritt besteht darin, <strong>gradle-wrapper.properties</strong> zu ändern.  Sie können es manuell ändern, indem Sie die Version von gradle in <strong>DistributionUrl</strong> ersetzen.  Oder lassen Sie das Studio alles für Sie tun. </p><br><p><img src="https://habrastorage.org/webt/lp/it/cp/lpitcpjx_z6zlxgrxwdikl4oazo.png" alt="gradle-wrapper.properties"></p><br><p>  Außerdem müssen Sie <strong>build.gradle</strong> für das App-Modul reparieren: In <strong>cleanAssets</strong> müssen Sie die <strong>Löschzeile "$ projectDir / build / intermediates / jniLibs" hinzufügen</strong> , ohne die Sie vor jedem Start ein sauberes Projekt durchführen müssen ( <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">von hier aus</a> ). </p><br><p>  Nachdem die Synchronisierung erfolgreich war, gibt es nur noch wenige Warnungen in Bezug auf die veraltete buildToolsVersion und die alte Syntax in der Konfiguration.  Sie zu korrigieren ist nicht schwierig. </p><br><p>  Jetzt im Studio sehen wir 2 Module: App und Plugin.  Benennen Sie die Anwendung (com.mycompany.app) und das Plugin (plugin.library) um, bevor Sie fortfahren. </p><br><p>  <em>Weiter im Code heißt das Plugin plugin.habrExamplePlugin</em> </p><br><p>  Das Plugin enthält standardmäßig die LuaLoader-Klasse - es ist für die Verarbeitung von Anrufen aus Lua-Code verantwortlich.  Es gibt bereits Code, aber lassen Sie uns ihn löschen. </p><br><div class="spoiler">  <b class="spoiler_title">LuaLoader-Code</b> <div class="spoiler_text"><pre> <code class="lua hljs"><span class="hljs-built_in"><span class="hljs-built_in">package</span></span> plugin.habrExamplePlugin; import com.naef.jnlua.JavaFunction; import com.naef.jnlua.LuaState; @SuppressWarnings({<span class="hljs-string"><span class="hljs-string">"WeakerAccess"</span></span>, <span class="hljs-string"><span class="hljs-string">"unused"</span></span>}) public class LuaLoader implements JavaFunction { @Override public int invoke(LuaState luaState) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> </div></div><br><h1 id="ispolzovanie-koda-plagina-iz-lua-koda">  Verwenden des Plugin-Codes aus dem Lua-Code </h1><br><p>  Corona Native verwendet <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">jnlua</a> zum Binden zwischen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Java-</a> und Lua-Code.  LuaLoader implementiert die Schnittstelle jnlua.JavaFunction, sodass die Aufrufmethode im Lua-Code verfügbar ist.  Um sicherzustellen, dass alles in Ordnung ist, fügen Sie den Protokollierungscode zu LuaLoader.invoke hinzu und erstellen Sie das erforderliche Plugin in main.lua </p><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LuaState luaState)</span></span></span><span class="hljs-function"> </span></span>{ Log.d(<span class="hljs-string"><span class="hljs-string">"Corona native"</span></span>, <span class="hljs-string"><span class="hljs-string">"Lua Loader invoke called"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> habrPlugin = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">"plugin.habrExamplePlugin"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"test:"</span></span>, habrPlugin)</code> </pre> <br><p>  Nach dem Start der Anwendung werden in den Protokollen die folgenden zwei Zeilen angezeigt: </p><br><blockquote>  D / Corona native: Lua Loader Aufruf aufgerufen <br>  Ich / Corona: Test wahr </blockquote><p>  Daher hat unsere Anwendung das Plugin heruntergeladen und erfordert eine Rückgabe von true.  Versuchen wir nun, eine Lua-Tabelle mit Funktionen aus Java-Code zurückzugeben. </p><br><p>  Um dem Modul Funktionen hinzuzufügen, verwenden wir die Schnittstelle jnlua.NamedJavaFunction.  Ein Beispiel für eine einfache Funktion ohne Argumente und ohne Rückgabewert: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HelloHabrFunction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamedJavaFunction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"helloHabr"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LuaState L)</span></span></span><span class="hljs-function"> </span></span>{ Log.d(<span class="hljs-string"><span class="hljs-string">"Corona native"</span></span>, <span class="hljs-string"><span class="hljs-string">"Hello Habr!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> <br><p>  Um unsere neue Funktion in lua zu registrieren, verwenden wir die Methode LuaState.register: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LuaLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JavaFunction</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LuaState luaState)</span></span></span><span class="hljs-function"> </span></span>{ Log.d(<span class="hljs-string"><span class="hljs-string">"Corona native"</span></span>, <span class="hljs-string"><span class="hljs-string">"Lua Loader invoke called"</span></span>); String libName = luaState.toString(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-comment"><span class="hljs-comment">//      (  require) NamedJavaFunction[] luaFunctions = new NamedJavaFunction[]{ new HelloHabrFunction(), //     }; luaState.register(libName, luaFunctions); //   ,     //  1        lua . //     require      , require     return 1; }</span></span></code> </pre> <br><p>  Dieser Code bedarf einer zusätzlichen Erläuterung: </p><br><p>  LuaState, ein Parameter der Aufrufmethode, stellt im Wesentlichen einen Wrapper über die virtuelle Lua-Maschine dar (bitte korrigieren Sie mich, wenn ich etwas falsch mache).  Für diejenigen, die mit der Verwendung von Lua-Code aus C vertraut sind, entspricht LuaState dem Zeiger lua_State in C. </p><br><p>  Für diejenigen, die in den Dschungel der Arbeit mit Lua eintauchen möchten, empfehle ich, das <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Handbuch zu</a> lesen <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">, beginnend mit The Application Program Interface</a> </p><br><p>  Wenn also invoke aufgerufen wird, erhalten wir LuaState.  Es hat einen Stapel, der Parameter enthält, die vom Lua-Code an unsere Funktion übergeben werden.  In diesem Fall ist dies der Name des Moduls, da LuaLoader ausgeführt wird, wenn der Aufruf erforderlich ist ("plugin.habrExamplePlugin"). </p><br><p>  Die vom Aufruf zurückgegebene Anzahl gibt die Anzahl der Variablen vom Stapel an, die an den Lua-Code zurückgegeben werden.  <strong>Im Fall von require hat diese Zahl keine Auswirkung, aber wir werden dieses Wissen später nutzen, indem wir eine Funktion erstellen, die mehrere Werte zurückgibt</strong> </p><br><h1 id="dobavlenie-poley-v-modul">  Hinzufügen von Feldern zum Modul </h1><br><p>  Zusätzlich zu den Funktionen können wir dem Modul auch zusätzliche Felder hinzufügen, z. B. die Version: </p><br><pre> <code class="java hljs"> luaState.register(libName, luaFunctions); <span class="hljs-comment"><span class="hljs-comment">//   ,       luaState.pushString("0.1.2"); //     luaState.setField(-2, "version"); //   version   .</span></span></code> </pre> <br><p>  In diesem Fall haben wir den Index -2 verwendet, um anzuzeigen, dass das Feld für unser Modul festgelegt werden muss.  Ein negativer Index bedeutet, dass die Zählung am Ende des Stapels beginnt.  -1 zeigt auf die Zeichenfolge "0.1.2" (in lua beginnen die Indizes mit eins). </p><br><p>  Um den Stapel nicht zu verstopfen, empfehle ich nach dem Festlegen des Felds, luaState.pop (1) aufzurufen - wirft 1 Element vom Stapel. </p><br><div class="spoiler">  <b class="spoiler_title">Vollständiger LuaLoader-Code</b> <div class="spoiler_text"><pre> <code class="lua hljs">@SuppressWarnings({<span class="hljs-string"><span class="hljs-string">"WeakerAccess"</span></span>, <span class="hljs-string"><span class="hljs-string">"unused"</span></span>}) public class LuaLoader implements JavaFunction { @Override public int invoke(LuaState luaState) { Log.d(<span class="hljs-string"><span class="hljs-string">"Corona native"</span></span>, <span class="hljs-string"><span class="hljs-string">"Lua Loader invoke called"</span></span>); String libName = luaState.toString(<span class="hljs-number"><span class="hljs-number">1</span></span>); //      (  <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>) NamedJavaFunction[] luaFunctions = new NamedJavaFunction[]{ new HelloHabrFunction(), //     }; luaState.register(libName, luaFunctions); //   ,     luaState.register(libName, luaFunctions); //   ,       luaState.pushString(<span class="hljs-string"><span class="hljs-string">"0.1.2"</span></span>); //     luaState.setField(<span class="hljs-number"><span class="hljs-number">-2</span></span>, <span class="hljs-string"><span class="hljs-string">"version"</span></span>); //   version   . //  <span class="hljs-number"><span class="hljs-number">1</span></span>        lua . //     <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>      , <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>     <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre> </div></div><br><h1 id="primery-funkciy">  Funktionsbeispiele </h1><br><div class="spoiler">  <b class="spoiler_title">Ein Beispiel für eine Funktion, die mehrere Zeichenfolgen verwendet und diese über den Zeichenfolgengenerator verkettet</b> <div class="spoiler_text"><p>  Implementierung: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StringJoinFunction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamedJavaFunction</span></span></span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"stringJoin"</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LuaState luaState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> currentStackIndex = <span class="hljs-number"><span class="hljs-number">1</span></span>; StringBuilder stringBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!luaState.isNone(currentStackIndex)){ String str = luaState.toString(currentStackIndex); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (str != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>){ <span class="hljs-comment"><span class="hljs-comment">//toString  null  non-string  non-number,  stringBuilder.append(str); } currentStackIndex++; } luaState.pushString(stringBuilder.toString()); return 1; } }</span></span></code> </pre> <br><p>  Verwendung in Lua: </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> joinedString = habrPlugin.stringJoin(<span class="hljs-string"><span class="hljs-string">"this"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"was"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"concated"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"by"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"Java"</span></span>, <span class="hljs-string"><span class="hljs-string">"!"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"some"</span></span>, <span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">"number"</span></span>, <span class="hljs-string"><span class="hljs-string">" : "</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(joinedString)</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Beispiel für die Rückgabe mehrerer Werte</b> <div class="spoiler_text"><p>  Klasse SumFunction implementiert NamedJavaFunction { <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=" class="user_link">Überschreiben</a> <br>  public String getName () { <br>  return "sum"; <br>  }} </p><br><pre> <code class="hljs java"><span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LuaState luaState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!luaState.isNumber(<span class="hljs-number"><span class="hljs-number">1</span></span>) || !luaState.isNumber(<span class="hljs-number"><span class="hljs-number">2</span></span>)){ luaState.pushNil(); luaState.pushString(<span class="hljs-string"><span class="hljs-string">"Arguments should be numbers!"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> firstNumber = luaState.toInteger(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> secondNumber = luaState.toInteger(<span class="hljs-number"><span class="hljs-number">1</span></span>); luaState.pushInteger(firstNumber + secondNumber); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre> <br><p>  }} </p></div></div><br><h1 id="java-reflection---ispolzovanie-java-klassov-napryamuyu-v-lua">  Java Reflection - Verwenden von Java-Klassen direkt in Lua </h1><br><p>  Die jnlua-Bibliothek verfügt über eine spezielle JavaReflector-Klasse, die für die Erstellung einer lua-Tabelle aus einem Java-Objekt verantwortlich ist.  Auf diese Weise können Sie Klassen in Java schreiben und sie für die zukünftige Verwendung dem Lua-Code übergeben. </p><br><p>  Dies zu tun ist ganz einfach: </p><br><p>  Klassenbeispiel </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>({<span class="hljs-string"><span class="hljs-string">"unused"</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Calculator</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sum</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> number1, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> number2)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> number1 + number2; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">someStaticMethod</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>; } }</code> </pre> <br><p>  Hinzufügen einer Instanz dieser Klasse zu unserem Modul </p><br><pre> <code class="java hljs"> luaState.pushJavaObject(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Calculator()); luaState.setField(-<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">"calc"</span></span>); luaState.pop(<span class="hljs-number"><span class="hljs-number">1</span></span>);</code> </pre> <br><p>  Verwendung in Lua: </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> calc = habrPlugin.calc <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"call method of java object"</span></span>, calc:sum(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"call static method of java object"</span></span>, calc:getClass():someStaticMethod())</code> </pre> <br><p>  Beachten Sie den Doppelpunkt im Klassenmethodenaufruf.  Für statische Methoden müssen Sie auch einen Doppelpunkt verwenden. </p><br><p>  Dann bemerkte ich eine interessante Funktion des Reflektors: Wenn wir nur eine Instanz der Klasse an lua übergeben, ist der Aufruf der statischen Methode über getClass () möglich.  Nach einem Aufruf über getClass () werden jedoch nachfolgende Aufrufe für das Objekt selbst ausgelöst: </p><br><pre> <code class="lua hljs"><span class="hljs-built_in"><span class="hljs-built_in">print</span></span>(<span class="hljs-string"><span class="hljs-string">"call method of java object"</span></span>, calc:sum(<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">4</span></span>)) <span class="hljs-comment"><span class="hljs-comment">-- ok print("exception here", calc:someStaticMethod()) --   "com.naef.jnlua.LuaRuntimeException: no method of class plugin.habrExamplePlugin.Calculator matches 'someStaticMethod()'" print("call static method of java object", calc:getClass():someStaticMethod()) -- ok print("hmm", calc:someStaticMethod()) --    getClass        </span></span></code> </pre> <br><p>  Mit getClass () können wir auch neue Objekte direkt in lua erstellen: </p><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> newInstance = calc:getClass():new()</code> </pre> <br><p>  Leider konnte ich Calculator.class aufgrund von <em>"java.lang.IllegalArgumentException: illegaler Typ"</em> in <strong>setField nicht</strong> im <strong>Modulfeld speichern</strong> . </p><br><h1 id="sozdanie-i-vyzov-lua-funkciy-na-letu">  Erstellen und Aufrufen von Lua-Funktionen im laufenden Betrieb </h1><br><p>  Dieser Abschnitt wurde angezeigt, weil die Krone nicht die Möglichkeit bietet, über ihre API direkt in Java auf Funktionen zuzugreifen.  Mit jnlua.LuaState können Sie jedoch beliebigen Lua-Code laden und ausführen: </p><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CreateDisplayTextFunction</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NamedJavaFunction</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    API  private static String code = "local text = ...;" + "return display.newText({" + "text = text," + "x = 160," + "y = 200," + "});"; @Override public String getName() { return "createText"; } @Override public int invoke(LuaState luaState) { luaState.load(code,"CreateDisplayTextFunction code"); //    ,     luaState.pushValue(1); //        luaState.call(1, 1); //   ,      1 ,    1 return 1; } }</span></span></code> </pre> <br><p>  <em>Denken Sie daran, die Funktion über LuaLoader.invoke zu registrieren, ähnlich wie in den vorherigen Beispielen</em> </p><br><p>  Der Anruf in Lua: </p><br><pre> <code class="lua hljs">habrPlugin.createText(<span class="hljs-string"><span class="hljs-string">"Hello Habr!"</span></span>)</code> </pre> <br><h1 id="zaklyuchenie">  Fazit </h1><br><p>  Somit kann Ihre Android-Anwendung alle nativen Funktionen der Plattform nutzen.  Der einzige Nachteil dieser Lösung besteht darin, dass Sie nicht mehr Corona Simulator verwenden können, was die Entwicklung verlangsamt (ein Neustart des Simulators erfolgt fast sofort, im Gegensatz zum Debuggen auf einem Emulator oder Gerät, für das Build + Install erforderlich ist). </p><br><h1 id="poleznye-ssylki">  Nützliche Links </h1><br><ol><li><p>  Vollständiger Code <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">auf Github verfügbar</a> </p><br></li><li><p>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Corona Native Dokumentation</a> </p><br></li></ol><br><p>  3) <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=de&amp;u=">Eines der Jnlua-Repositories</a> .  Hat mir geholfen, den Zweck einiger Funktionen zu verstehen. </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/de416079/">https://habr.com/ru/post/de416079/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de416069/index.html">Verlustfreie ElasticSearch-Datenmigration</a></li>
<li><a href="../de416071/index.html">Neuronale Netze, grundlegende Funktionsprinzipien, Vielfalt und Topologie</a></li>
<li><a href="../de416073/index.html">Ein einfacher Kryptowährungs-Handelsbot</a></li>
<li><a href="../de416075/index.html">Der FSB möchte die Verantwortung für die versteckte Verwendung von Diktiergeräten und Kameras in Smartphones übernehmen [und nicht nur]</a></li>
<li><a href="../de416077/index.html">PlantUML - Alles, was Business Analysten zum Erstellen von Diagrammen in der Softwaredokumentation benötigen</a></li>
<li><a href="../de416081/index.html">Mit der Rückkehr nach Habr stimmt noch etwas nicht</a></li>
<li><a href="../de416083/index.html">Meine Regeln für Effizienz: Arbeiten mit Aufgaben, Projekten, Büchern und Notizen</a></li>
<li><a href="../de416087/index.html">MTProto Proxy-Statistiksammlung</a></li>
<li><a href="../de416089/index.html">Wie wir eine dieseldynamische unterbrechungsfreie Stromversorgung gewartet haben</a></li>
<li><a href="../de416091/index.html">Wie ich Cottage um 90% automatisiert habe</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>