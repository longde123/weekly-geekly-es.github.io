<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üíÉüèª ü•© ü§ñ Umbral de 32K para datos en ROM de microcontroladores AVR üë®üèª‚Äç‚úàÔ∏è üîå üëèüèæ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="¬øQu√© podr√≠a ser peor que las muletas? Solo muletas incompletamente documentadas. 





 Aqu√≠ hay una captura de pantalla del √∫ltimo entorno de desarro...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Umbral de 32K para datos en ROM de microcontroladores AVR</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/436904/"><p>  ¬øQu√© podr√≠a ser peor que las muletas?  Solo muletas incompletamente documentadas. </p><br><p><img src="https://habrastorage.org/webt/cg/o9/jm/cgo9jmcqnhx5xev3pyizgfemlw4.png" alt="imagen"></p><br><p>  Aqu√≠ hay una captura de pantalla del √∫ltimo entorno de desarrollo integrado oficial para microcontroladores AVR de 8 bits, Atmel Studio 7, el lenguaje de programaci√≥n C.  Como puede ver en la columna Valor, la variable my_array contiene el n√∫mero 0x8089.  En otras palabras, la matriz my_array se encuentra en la memoria que comienza en la direcci√≥n 0x8089. </p><br><p>  Al mismo tiempo, la columna Tipo nos da informaci√≥n ligeramente diferente: my_array es una matriz de 4 elementos de tipo int16_t ubicados en ROM (esto se indica mediante la palabra prog, a diferencia de los datos para RAM), comenzando desde la direcci√≥n 0x18089.  Detente, pero despu√©s de todo 0x8089! = 0x18089.  ¬øCu√°l es la direcci√≥n real de la matriz? </p><a name="habracut"></a><br><h2 id="yazyk-si-i-garvardskaya-arhitektura">  Lenguaje C y arquitectura de Harvard </h2><br><p>  Los microcontroladores AVR de 8 bits fabricados anteriormente por Atmel, y ahora Microchip, son populares, en particular, debido al hecho de que son la base de Arduino, construido en la arquitectura de Harvard, es decir, el c√≥digo y los datos se encuentran en diferentes espacios de direcciones.  La documentaci√≥n oficial contiene ejemplos de c√≥digo en dos idiomas: ensamblador y C.  Anteriormente, el fabricante ofrec√≠a un entorno de desarrollo integrado gratuito que solo admite ensamblador.  Pero, ¬øqu√© pasa con aquellos a quienes les gustar√≠a programar en C, o incluso en C ++?  Hubo soluciones pagas, por ejemplo, IAR AVR y CodeVisionAVR.  Personalmente, nunca lo us√©, porque cuando comenc√© a programar AVR en 2008, ya hab√≠a WinAVR gratuito con la capacidad de integrarse con AVR Studio 4, y simplemente est√° incluido en el Atmel Studio 7 actual. </p><br><p>  El proyecto WinAVR se basa en el compilador GNU GCC, que fue desarrollado para la arquitectura von Neumann, lo que implica un espacio de direcciones √∫nico para c√≥digo y datos.  Al adaptar GCC a AVR, se aplic√≥ la siguiente muleta: las direcciones 0 a 0x007fffff se asignan para el c√≥digo (ROM, flash) y 0x00800100 para 0x0080ffff para datos (RAM, SRAM).  Hubo todo tipo de otros trucos, por ejemplo, las direcciones de 0x00800000 a 0x008000ff representaron registros a los que se puede acceder con los mismos c√≥digos de operaci√≥n que RAM.  En principio, si usted es un programador simple, como un arduino principiante, y no un hacker, mezclador y C / C ++ en el mismo firmware, no necesita saber todo esto. </p><br><p>  Adem√°s del compilador real, WinAVR incluye varias bibliotecas (parte de la biblioteca est√°ndar C y m√≥dulos espec√≠ficos de AVR) en forma del proyecto AVR Libc.  La √∫ltima versi√≥n, 2.0.0, se lanz√≥ hace casi tres a√±os, y la documentaci√≥n est√° disponible no solo en el sitio del proyecto en s√≠, sino tambi√©n en el sitio del fabricante del microcontrolador.  Tambi√©n hay traducciones no oficiales al ruso. </p><br><h2 id="dannye-v-adresnom-prostranstve-koda">  Datos en el espacio de direcciones del c√≥digo </h2><br><p>  A veces, en un microcontrolador, necesita colocar no solo una gran cantidad de datos, sino muchos: simplemente no caben en la RAM.  Adem√°s, estos datos son inmutables, conocidos en el momento del firmware.  Por ejemplo, una imagen r√°ster, una melod√≠a o alg√∫n tipo de tabla.  Al mismo tiempo, el c√≥digo a menudo ocupa solo una peque√±a fracci√≥n de la ROM disponible.  Entonces, ¬øpor qu√© no usar el espacio restante para los datos?  F√°cil!  La documentaci√≥n de avr-libc 2.0.0 cubre un cap√≠tulo completo de 5 datos en el espacio del programa.  Si omite la parte sobre las l√≠neas, entonces todo es extremadamente simple.  Considera un ejemplo.  Para RAM, escribimos as√≠: </p><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> array2d[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">3</span></span>] = {...}; <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> element = array2d[i][j];</code> </pre> <br><p>  Y para ROM como esta: </p><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;avr/pgmspace.h&gt; const unsigned char array2d[2][3] PROGMEM = {...}; unsigned char element = pgm_read_byte(&amp;(array2d[i][j]));</span></span></span></span></code> </pre> <br><p>  Es tan simple que esta tecnolog√≠a se ha cubierto repetidamente incluso en RuNet. </p><br><h2 id="tak-v-chyom-zhe-problema">  Entonces, ¬øcu√°l es el problema? </h2><br><p>  ¬øRecuerdas la afirmaci√≥n de que 640 KB es suficiente para todos?  ¬øRecuerdas c√≥mo cambiaste de la arquitectura de 16 bits a 32 bits y de 32 a 64 bits?  ¬øC√≥mo funcion√≥ Windows 98 de manera inestable en m√°s de 512 MB de RAM mientras estaba dise√±ado para 2 GB?  ¬øAlguna vez ha actualizado el BIOS para que la placa base funcione con discos duros de m√°s de 8 GB?  ¬øRecuerdas los puentes en 80 GB de discos duros, recortando su volumen a 32 GB? </p><br><p>  El primer problema me super√≥ cuando intent√© crear una matriz de al menos 32 KB en ROM.  ¬øPor qu√© en ROM y no en RAM?  Porque en la actualidad, los AVR de 8 bits con m√°s de 32 KB de RAM simplemente no existen.  Y con m√°s de 256 B - existen.  Esta es probablemente la raz√≥n por la cual los creadores del compilador eligieron 16 b (2 B) para los punteros en RAM (y al mismo tiempo para el tipo int), que se puede encontrar en la lectura del p√°rrafo Tipos de datos ubicado en el cap√≠tulo 11.14 ¬øQu√© registros utiliza el compilador C?  Documentaci√≥n de AVR Libc.  Ah, y no √≠bamos a hackear, pero aqu√≠ est√°n los registros ... Pero volvamos a la matriz.  Result√≥ que no puede crear un objeto mayor que 32,767 B (2 ^ (16 - 1) - 1 B).  No s√© por qu√© fue necesario hacer que la longitud del objeto sea significativa, pero esto es un hecho: ning√∫n objeto, incluso una matriz multidimensional, puede tener una longitud de 32.768 B o m√°s.  Un poco como una limitaci√≥n en el espacio de direcciones de las aplicaciones de 32 bits (4 GB) en un sistema operativo de 64 bits, ¬øno? </p><br><p>  Que yo sepa, este problema no tiene soluci√≥n.  Si desea colocar un objeto con una longitud de 32,768 en la ROM, div√≠dalo en objetos m√°s peque√±os. </p><br><p>  Volvemos nuevamente al p√°rrafo Tipos de datos: los punteros son de 16 bits.  Aplicamos este conocimiento al cap√≠tulo 5 de Datos en el espacio del programa.  No, la teor√≠a es indispensable; se necesita pr√°ctica.  Escrib√≠ un programa de prueba, lanc√© un depurador (desafortunadamente, software, no hardware) y vi que la funci√≥n <code>pgm_read_byte</code> solo puede devolver datos cuyas direcciones caben en 16 bits (64 KB; gracias, no 15).  Luego se produce un desbordamiento, la parte m√°s antigua se descarta.  Es l√≥gico, dado que los punteros son de 16 bits.  Pero surgen dos preguntas: por qu√© esto no est√° escrito en el cap√≠tulo 5 (una pregunta ret√≥rica, pero fue √©l quien me impuls√≥ a escribir este art√≠culo) y c√≥mo superar el l√≠mite de ROM de 64 KB sin cambiar al ensamblador. </p><br><p>  Afortunadamente, adem√°s del Cap√≠tulo 5, hay otra 25.18 pgmspace.h File Reference, de la que aprendemos que la familia de funciones <code>pgm_read_*</code> es solo una <code>pgm_read_*_near</code> para <code>pgm_read_*_near</code> , que acepta direcciones de 16 bits, y tambi√©n hay <code>pgm_read_*_far</code> , y puede enviar Direcci√≥n de 32 bits  Eureka! </p><br><p>  Escribimos el c√≥digo: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> element = pgm_read_byte_far(&amp;(array2d[i][j]));</code> </pre> <br><p>  Se compila, pero no funciona como nos gustar√≠a (si array2d se encuentra despu√©s de 32 KB).  Por qu√©  S√≠, porque la operaci√≥n <code>&amp;</code> devuelve un n√∫mero de 16 bits con signo.  Es curioso que la familia <code>pgm_read_*_near</code> acepte direcciones de 16 bits sin firmar, es decir, es capaz de trabajar con 64 KB de datos, y la operaci√≥n <code>&amp;</code> solo es √∫til para 32 KB. </p><br><p>  Sigamos adelante.  ¬øQu√© tenemos en pgmspace.h adem√°s de <code>pgm_read_*</code> ?  La funci√≥n <code>pgm_get_far_address(var)</code> , que ya tiene media p√°gina de descripci√≥n, y reemplaza la operaci√≥n <code>&amp;</code> . </p><br><p>  Probablemente correcto: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> element = pgm_read_byte_far(pgm_get_far_address(array2d[i][j]));</code> </pre> <br><p>  Error de compilaci√≥n  Leemos la descripci√≥n: 'var' debe resolverse en el momento de la vinculaci√≥n como un s√≠mbolo existente, es decir, un nombre de variable de tipo simple, un nombre de matriz (no un elemento indexado de la matriz, si el √≠ndice es una constante, el compilador no se queja pero no puede obtener la direcci√≥n si la optimizaci√≥n est√° habilitada), un nombre de estructura o un nombre de campo de estructura, un identificador de funci√≥n, un identificador definido de enlazador, ... </p><br><p>  Ponemos otra muleta: pasamos de los √≠ndices de matriz a la aritm√©tica del puntero: </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> element = pgm_read_byte_far(pgm_get_far_address(array2d) + i*<span class="hljs-number"><span class="hljs-number">3</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>) + j*<span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>));</code> </pre> <br><p>  Ahora todo funciona. </p><br><h2 id="vyvody">  Conclusiones </h2><br><p>  Si escribe en C / C ++ para microcontroladores AVR de 8 bits utilizando el compilador GCC y almacena los datos en ROM, entonces: </p><br><ul><li>  con un tama√±o de ROM de no m√°s de 32 KB, no tendr√° problemas leyendo solo los datos del Cap√≠tulo 5 en el Espacio del programa; </li><li>  para ROM de m√°s de 32 KB, debe usar la familia de funciones <code>pgm_read_*_far</code> , la funci√≥n <code>pgm_get_far_address</code> lugar de <code>&amp;</code> , la aritm√©tica del puntero en lugar de los √≠ndices de matriz, y el tama√±o de cualquier objeto no puede exceder 32.767 B. </li></ul><br><h2 id="ssylki">  Referencias </h2><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Microchip</a> : fabricante de microcontroladores AVR y desarrollador de IDE Atmel Studio </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">P√°gina de inicio de AVR Libc</a> </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">AVR</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Curso de entrenamiento.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Programaci√≥n C.</a>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Trabajar con memoria, direcciones y punteros</a> : DI HALT no mencion√≥ direcciones grandes en principio, pero en alg√∫n lugar profundo de los comentarios que escribieron sobre <code>pgm_get_far_address</code> , pero la muestra estaba rota </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es436904/">https://habr.com/ru/post/es436904/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es436890/index.html">Tutorial React Parte 10: Taller sobre c√≥mo trabajar con propiedades de componentes y estilo</a></li>
<li><a href="../es436892/index.html">Tutorial React Parte 11: Formaci√≥n de marcado din√°mico y el m√©todo de matriz de mapa</a></li>
<li><a href="../es436894/index.html">Creeping IT Apocalypse. Los nuevos servicios en la nube dejar√°n a algunos ingenieros sin trabajo</a></li>
<li><a href="../es436896/index.html">docker-pretty-ps - finalmente un docker legible ps</a></li>
<li><a href="../es436900/index.html">Encuentro FunTech ML</a></li>
<li><a href="../es436908/index.html">6 formas de ocultar datos en una aplicaci√≥n de Android</a></li>
<li><a href="../es436910/index.html">Consejos para crear flujos de trabajo personalizados en GitLab CI</a></li>
<li><a href="../es436912/index.html">Tendencias de CRM 2019: divertido de leer, peligroso de creer</a></li>
<li><a href="../es436914/index.html">Problemas de crecimiento de inicio - Monitoreo</a></li>
<li><a href="../es436916/index.html">VShard - escala horizontal en Tarantool</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>