<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>☝🏻 👩🏿‍🎨 ⬅️ Java：使用Spring and Logback或Log4j2将多行日志折叠成单行日志 🖕🏾 📤 👨🏽‍🚀</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Logback和Log4j2是一些最著名的JAVA日志记录框架。 Logback框架仅与SLF4J库结合使用，该库是事件日志记录系统的接口。 Log4j2是Log4记录器的第二个改进版本，Log4记录器是一个日志库，其中的API和实现是分开的，它使您可以将Log4j 2 API与另一个记录器的实现结...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Java：使用Spring and Logback或Log4j2将多行日志折叠成单行日志</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/ua-hosting/blog/482804/"> Logback和Log4j2是一些最著名的JAVA日志记录框架。  Logback框架仅与SLF4J库结合使用，该库是事件日志记录系统的接口。  Log4j2是Log4记录器的第二个改进版本，Log4记录器是一个日志库，其中的API和实现是分开的，它使您可以将Log4j 2 API与另一个记录器的实现结合使用。 <br><br>  Spring Music是一个将Cloud Foundry环境数据库服务与Spring Framework和Spring Boot结合使用的应用程序。 它被创建为将相同的域对象存储在许多不同的存储库之一中-对象关系，面向文档或分布式（键值存储）。 <a name="habracut"></a><br><br><img src="https://habrastorage.org/webt/l-/hz/_y/l-hz_yl1hq_kzdyka5tt2vfeac0.jpeg"><br><br> 与Spring / Spring Boot一起使用的两个最常见的记录器是Logback和Log4j2。 直到最近，开发人员在日志格式和用于日志记录的文件本身方面有了更大的行动自由。 但是，在现代的容器实现和扩展世界中，日志记录通常提供需要一定程度的标准化的企业解决方案。 <br><br> 最大的问题之一是Java异常通常会在日志中导致大型的多行堆栈跟踪。 因此，您得到的是100多种不同的日志，而不是单个日志事件指示异常或错误消息，每个日志用于堆栈跟踪的每一行，并散布着来自其他服务或服务实例的其他日志事件。 <br><br> 本文介绍了如何配置Spring Boot应用程序以在一行中折叠Logback记录器和Log4j2的异常。 这使我们可以将异常日志记录和堆栈跟踪视为一个事件日志。 <br><br><img src="https://habrastorage.org/webt/lr/dv/je/lrdvjed8d9tknggbl67_x-1utt4.jpeg"><br>  <i>JAVA中的错误和异常类</i> <br><br><img src="https://habrastorage.org/webt/wp/0t/ea/wp0teazjqbomtgcorljap3bqoig.jpeg"><br>  <i>JAVA已检查和未检查的未检查异常</i> <br><br><h3> 春季音乐应用 </h3><br> 在本文中，对于自定义日志记录，将使用<a href="https://github.com/fabianlee/spring-music">spring-music</a>应用程序的自定义版本，这对于Logback和Log4j2记录器的操作是必需的。 首先，您需要确保我们可以从源代码中重新创建它。 该项目需要Java8，因此第一步是在Ubuntu主机上安装Java8。 <br><br><img src="https://habrastorage.org/webt/wy/ex/md/wyexmd40eutwvvmmwue1w5lek44.jpeg"><br><br> 然后，我们使用<a href="https://github.com/fabianlee/spring-music">github</a>获取项目的源代码，并使用Gradle构建系统的内置脚本创建程序集： <br><br><img src="https://habrastorage.org/webt/cb/sq/z7/cbsqz7dxfedqwrmluhluwjurg6m.jpeg"><br><br><h3> 使用Logback折叠多行异常 </h3><br> 让我们继续使用标准Gradle命令通过Logback记录器的实现创建jar项目的jar归档文件： <br><br><img src="https://habrastorage.org/webt/2j/4a/wp/2j4awpr_x34ktywzv_6ktimg3us.jpeg"><br><br> 文件“ build / libs / spring-music.jar”是自动执行的，并且包含绑定到本地主机的内置Tomcat：8080。 使用以下命令调用jar文件： <br><br><img src="https://habrastorage.org/webt/wk/4c/sj/wk4csj5eugehsudwfdghrilmjrk.jpeg"><br><br> 在浏览器中调用<a href="http://localhost:8080/">http：//本地主机：8080</a>将显示一个带有相册列表的页面，并且将在控制台中显示如下所示的日志行： <br><br><img src="https://habrastorage.org/webt/gz/af/za/gzafzavwxyid2nlhpeqxgygk9kc.jpeg"><br><br> 使用自定义模板在“ <a href="">src / main / resources / logback-spring.xml</a> ”中定义了此日志行语法： <br><br><img src="https://habrastorage.org/webt/w7/px/fv/w7pxfvjh0rbm8adl-ctlhqs8wf8.jpeg"><br><br> 变量$ {...}是从application.properties和系统属性中提取的，可以在页面<a href="http://localhost:8080/env">http：// localhost：8080 / env</a>上查看。 但是，我们需要的部分代码位于消息（％m）之后。 <br><br><img src="https://habrastorage.org/webt/ec/ov/ia/ecoviai9hbwvzt_-bve6nxrq2ps.jpeg"><br><br>  “ MULTIEXCEPTION”一词没有特殊含义，它只是一个独特的字符串标记，使我们能够找出消息的结尾（％m）和异常开始的地方。 如果需要，可以保留此标记。 <br><br> 此外，我们不只是插入会用换行符引发大堆栈跟踪的％xException占位符，而是使用％replace函数转换值并将所有换行符替换为表达式“ \ u2028”，这是<a href="https://en.wikipedia.org/wiki/Newline">Unicode字符串定界符视图</a> 。 <br><br> 从堆栈跟踪中删除字符“ \ n”意味着现在将以单行形式发送堆栈跟踪。 为了证明这一点，请转到<a href="http://localhost:8080/errors/throw">http：// localhost：8080 / errors / throw</a> ，其中有一个<a href="">错误控制器</a>故意使用以下代码抛出NullPointerException： <br><br><img src="https://habrastorage.org/webt/rv/5a/qs/rv5aqssa51ra4h9l1tbuzxiev3o.jpeg"><br><br> 这将在控制台中创建一条日志行，如下所示： <br><br><img src="https://habrastorage.org/webt/rb/cr/zp/rbcrzpn1tbfhmhjvqkcyo5xxrxg.jpeg"><br><br> 在这里可以看出，表达式“ u2028”将堆栈跟踪中的换行符分隔开。 现在，异常消息和堆栈跟踪将作为一个单元发送。 <br><br><img src="https://habrastorage.org/webt/xu/jy/zc/xujyzcqchwq1l0xiu8ekqgvnupo.jpeg"><br><br><h3> 使用Log4j2折叠多行异常 </h3><br> 要覆盖默认的构建脚本并将Log4j2用作该项目的备份实现，您需要使用“ build-log4j2.gradle”文件。 <br><br><img src="https://habrastorage.org/webt/xu/jy/zc/xujyzcqchwq1l0xiu8ekqgvnupo.jpeg"><br><br> 文件“ build / libs / spring-music.jar”是自动执行的，并使用内置于本地主机的Tomcat：8080。 与前面的示例一样，使用以下命令调用jar文件： <br><br><img src="https://habrastorage.org/webt/ya/te/ts/yatetsvficn_m3sqomw1ypprwzq.jpeg"><br><br> 使用浏览器调用<a href="http://localhost:8080/">http：//本地主机：8080</a>将显示一个包含相册列表的页面，并向控制台输出如下日志行： <br><br><img src="https://habrastorage.org/webt/x-/m0/qf/x-m0qfiewf26kw1dax6qusy9zr8.jpeg"><br><br> 使用自定义模板在“ <a href="">src / main / resources / log4j2.xml</a> ”中定义了此日志行语法： <br><br><img src="https://habrastorage.org/webt/xj/4f/tt/xj4fttbx2c8px2rcm8pcswuzbbu.jpeg"><br><br> 变量$ {...}是从application.properties和系统属性中提取的，可以在页面<a href="http://localhost:8080/env">http：// localhost：8080 / env</a>上查看。 但是，我们需要的部分代码位于消息（％m）之后。 <br><br><img src="https://habrastorage.org/webt/ji/js/yw/jijsywze7vx1sfdud20-5dvhezg.jpeg"><br><br>  “ MULTIEXCEPTION”一词没有特殊含义，它只是我们选择的唯一行标记，它使您可以找出消息的结尾（％m）和异常开始的地方。 如果需要，可以将其保留。 <br><br> 但是之后，我们不只是插入会使用换行符引发大堆栈跟踪的％xException占位符，而是使用％replace函数转换该值，该函数将所有换行符替换为表达式“ \ u2028”，这是一个<a href="https://en.wikipedia.org/wiki/Newline">分隔符Unicode字符串</a> 。 <br><br> 从堆栈跟踪中删除字符“ \ n”意味着现在堆栈跟踪将作为一行发送。 为了证明这一点，请转到<a href="http://localhost:8080/errors/throw">http：// localhost：8080 / errors / throw</a> ，其中有一个<a href="">错误控制器</a>故意使用以下代码抛出NullPointerException： <br><br><img src="https://habrastorage.org/webt/f8/28/xx/f828xxcvqh2ps2ubr15aj6dscly.jpeg"><br><br> 这将在控制台中创建一条日志行，如下所示： <br><br><img src="https://habrastorage.org/webt/fl/9g/zg/fl9gzgv2yso3zsvpk2acummun28.jpeg"><br><br> 如您所见，此处的表达式“ u2028”将堆栈跟踪中的换行符分隔开。 现在，异常消息和堆栈跟踪将作为一个单元发送。 <br><br><h3> 结论 </h3><br> 将Java堆栈的多行跟踪折叠为一行的能力意味着该技术可以视为一种集中式日志记录解决方案。 <br> 如果在源端执行此折叠更为有效，则没有理由浪费计算和人力来使用相关标识符，较大的堆栈大小，较高的处理器利用率和智能分析来在目标端还原堆栈跟踪。 <br><br> 在这种情况下，始终可以在收集日志的一侧（例如，在用于收集，过滤和规范化Logstash日志的管道的一侧）替换Unicode字符，以将消息还原为原始格式。 <br><br><h3> 参考资料 </h3><br><ul><li>  <a href="https://docs.cloudfoundry.org/loggregator/architecture.html">https://docs.cloudfoundry.org/loggregator/architecture.html#metron（CF</a>日志记录架构） <br>  <a href="http://docs.pivotal.io/pivotalcf/2-0/devguide/deploy-apps/streaming-logs.html">docs.pivotal.io/pivotalcf/2-0/devguide/deploy-apps/streaming-logs.html#format</a> （流日志的类型） </li><li>  <a href="https://docs.pivotal.io/tiledev/2-0/nozzle.html">https://docs.pivotal.io/tiledev/2-0/nozzle.html#examples（CF</a>组件的日志格式= &lt;$ {PRI}&gt; $ {VERSION} $ {TIMESTAMP} $ {HOST_IP} $ {APP_NAME} $ {PROD_ID} $ {MSG_ID} $ {SD-ELEMENT-instance} $ {MESSAGE}） </li><li>  <a href="http://grokconstructor.appspot.com/do/construction">http://grokconstructor.appspot.com/do/construction（Grok</a>模板的在线版本） </li><li>  <a href="https://github.com/cloudfoundry/dropsonde-protocol">https://github.com/cloudfoundry/dropsonde-protocol</a> （用于结构化数据序列化的Cloud Foundry Dropsonde协议） </li><li>  <a href="https://logback.qos.ch/manual/layouts.html">https://logback.qos.ch/manual/layouts.html</a> （用于将传入消息转换为字符串的组件格式） </li><li>  <a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-protobuf.html">https://www.elastic.co/guide/zh-CN/logstash/current/plugins-codecs-protobuf.html（logstash</a> protobuf输入） </li><li>  <a href="https://github.com/cloudfoundry-community/firehose-to-syslog">https://github.com/cloudfoundry-community/firehose-to-syslog</a> （将Firehose事件从Cloud Foundry发送到syslog） </li><li>  <a href="http://schd.ws/hosted_files/cfsummit2016/f7/MonitoringCloudFoundry-LearningAboutTheFirehose.pdf">http://schd.ws/hosted_files/cfsummit2016/f7/MonitoringCloudFoundry-LearningAboutTheFirehose.pdf</a> （显示UDP和TCP CF日志记录系统的部分内容） </li><li>  <a href="https://github.com/cloudfoundry-community/logsearch-for-cloudfoundry">https://github.com/cloudfoundry-community/logsearch-for-cloudfoundry</a> （用于CF的ELK堆栈） </li><li>  <a href="https://discuss.pivotal.io/hc/en-us/articles/223207207-Why-Loggregator-may-lose-logs">https://discuss.pivotal.io/hc/en-us/articles/223207207-Why-Loggregator-may-lose-logs</a> （味精/秒的损耗预测） </li><li>  <a href="http://scottfrederick.cfapps.io/blog/2014/02/20/cloud-foundry-and-logstash">http://scottfrederick.cfapps.io/blog/2014/02/20/cloud-foundry-and-logstash</a> （如何将syslog 5424事件拆分为多个部分） </li><li>  <a href="https://logz.io/blog/cloud-foundry-elk-stack/">https://logz.io/blog/cloud-foundry-elk-stack/</a> （分离为5424 syslog，这是一种内置服务，例如用于Kibana数据的可视化和分析的平台） </li><li>  <a href="https://docs.cloudfoundry.org/loggregator/cli-plugin.html">https://docs.cloudfoundry.org/loggregator/cli-plugin.html</a> （用于查看Firehost的CF CLI插件） </li><li>  <a href="">https://github.com/cloudfoundry/loggregator-release/blob/develop/docs/java-multi-line-work-around.md</a> （针对多行异常的logback绕过） </li><li>  <a href="https://stackoverflow.com/questions/23096129/make-logback-include-the-t-between-date-and-time-in-its-date-format-for-str">https://stackoverflow.com/questions/23096129/make-logback-include-the-t-between-date-and-time-in-its-date-format-for-str</a> （登录日期和时间格式） </li><li>  <a href="http://cloud.rohitkelapure.com/2016/06/multi-line-java-stack-traces-out-of.html">http://cloud.rohitkelapure.com/2016/06/multi-line-java-stack-traces-out-of.html</a> （用于异常折叠的登录字符串格式） </li><li>  <a href="https://discuss.elastic.co/t/match-and-replace-unicode-characters/56656">https://discuss.elastic.co/t/match-and-replace-unicode-characters/56656</a> （在Mutate无法正常工作的情况下，使用Ruby替换Unicode的想法） </li><li>  <a href="https://www.diycode.cc/projects/cloudfoundry/loggregator">https://www.diycode.cc/projects/cloudfoundry/loggregator</a> （日志记录和BOSH清单） </li><li>  <a href="https://www.elastic.co/guide/en/logstash/5.0/breaking-changes.html">https://www.elastic.co/guide/zh-CN/logstash/5.0/breaking-changes.html</a> （适用于Ruby的关键更改event.get（）） </li><li>  <a href="https://medium.com/%40martatatiana/aws-lambda-in-java-8-log4j2-and-scattered-stacktrace-in-cloudwatch-a4aea2e7bf2a">https://medium.com/@martatatiana/aws-lambda-in-java-8-log4j2-and-scattered-stacktrace-in-cloudwatch-a4aea2e7bf2a（LogEventPatternConverter-</a>自定义log4j2记录器转换器） </li><li>  <a href="https://springframework.guru/using-log4j-2-spring-boot/">https://springframework.guru/using-log4j-2-spring-boot/</a> （在Spring Boot中使用log4j2） </li><li>  <a href="https://www.quickprogrammingtips.com/spring-boot/using-log4j2-with-spring-boot.html">https://www.quickprogrammingtips.com/spring-boot/using-log4j2-with-spring-boot.html</a> （共享log4j2和Spring Boot） </li><li>  <a href="https://logging.apache.org/log4j/2.x/manual/layouts.html">https://logging.apache.org/log4j/2.x/manual/layouts.html（log4j2</a>模板） </li><li>  <a href="http://www.codepreference.com/2016/04/configurable-thread-context-tags-log4j2.html">http://www.codepreference.com/2016/04/configurable-thread-context-tags-log4j2.html</a> （用于流式日志记录的上下文变量） </li><li>  <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html">https://docs.spring.io/spring-boot/docs/current/reference/html/boot-features-external-config.html</a> （外部Spring Boot配置设置） </li><li>  <a href="http://logging.apache.org/log4j/2.x/manual/configuration.html">http://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution</a> （替换log4j2属性） </li></ul><br><h3> 一点广告：） </h3><br> 感谢您与我们在一起。 你喜欢我们的文章吗？ 想看更多有趣的资料吗？ 通过下订单或向您的朋友推荐给<a href="https://ua-hosting.company/cloudvps/nl">开发人员的基于云的VPS，</a> <a href="https://habr.com/company/ua-hosting/blog/347386/">最低</a> <a href="https://ua-hosting.company/cloudvps/nl">价格为4.99美元</a> ， <b>这是我们为您发明的入门级服务器</b>的<b>独特类似物：</b> <a href="https://habr.com/company/ua-hosting/blog/347386/">关于VPS（KVM）E5-2697 v3（6核）的全部真相10GB DDR4 480GB SSD 1Gbps从$ 19还是如何划分服务器？</a>  （RAID1和RAID10提供选件，最多24个内核和最大40GB DDR4）。 <br><br>  <b>阿姆斯特丹的Equinix Tier IV数据中心的戴尔R730xd便宜2倍吗？</b> 只有我们有<b><a href="https://ua-hosting.company/serversnl">2台Intel TetraDeca-Core Xeon 2x E5-2697v3 2.6GHz 14C 64GB DDR4 4x960GB SSD 1Gbps 100电视</a>在荷兰<a href="https://ua-hosting.company/serversnl">起价199美元</a> ！</b>  <b><b>戴尔R420-2x E5-2430 2.2Ghz 6C 128GB DDR3 2x960GB SSD 1Gbps 100TB-$ 99起！</b></b> 阅读有关<a href="https://habr.com/company/ua-hosting/blog/329618/">如何构建基础架构大厦的信息。</a>  <a href="https://habr.com/company/ua-hosting/blog/329618/">使用价格为9000欧元的Dell R730xd E5-2650 v4服务器的上等课程？</a> </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN482804/">https://habr.com/ru/post/zh-CN482804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN482792/index.html">ITER项目在2019年</a></li>
<li><a href="../zh-CN482794/index.html">神经网络。 都去哪儿了</a></li>
<li><a href="../zh-CN482798/index.html">看到树后的森林</a></li>
<li><a href="../zh-CN482800/index.html">我在搜索智能家居的物理控制面板</a></li>
<li><a href="../zh-CN482802/index.html">从Telegram v 2.0远程包含Mikrotik脚本</a></li>
<li><a href="../zh-CN482806/index.html">2019年关于编程的极权主义政权，反犹太主义和同性恋恐惧症的宣传？ -有可能</a></li>
<li><a href="../zh-CN482812/index.html">数学家在“危险”问题的研究上取得了突破</a></li>
<li><a href="../zh-CN482814/index.html">树的一般视图，不仅实现而且</a></li>
<li><a href="../zh-CN482816/index.html">Arthur Khachuyan：市场营销中的人工智能</a></li>
<li><a href="../zh-CN482818/index.html">阅读有关Infostart 2019的1C DSS报告的简要结果</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>