<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü§¶üèø üë©üèæ‚Äçü§ù‚Äçüë©üèº üßö Entidades de estilo DDD con Entity Framework Core üìÖ ‚õπÔ∏è üíÖüèø</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Este art√≠culo trata sobre c√≥mo aplicar los principios del dise√±o controlado por dominio (DDD) a las clases que Entity Framework Core (EF Core) asigna ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Entidades de estilo DDD con Entity Framework Core</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/432410/">  Este art√≠culo trata sobre c√≥mo aplicar los principios del dise√±o controlado por dominio (DDD) a las clases que Entity Framework Core (EF Core) asigna a la base de datos, y por qu√© esto podr√≠a ser √∫til. <br><br><h3>  TLDR </h3><br>  El enfoque DDD tiene muchas ventajas, pero lo principal es que DDD transfiere el c√≥digo de operaciones de creaci√≥n / modificaci√≥n dentro de la clase de entidad.  Esto reduce significativamente las posibilidades de que un desarrollador malinterprete / interprete las reglas para crear, inicializar y usar instancias de clase. <br><a name="habracut"></a><br><ol><li>  El libro de Eric Evans y sus discursos no tienen mucha informaci√≥n sobre este tema: </li><li>  Proporcione al cliente un modelo simple para obtener objetos persistentes (clases) y administrar su ciclo de vida. </li><li>  Las clases de entidad deben indicar expl√≠citamente si se pueden cambiar, c√≥mo y por qu√© reglas. </li><li> En DDD existe el concepto de agregado.  El agregado es un √°rbol de entidades relacionadas.  De acuerdo con las reglas DDD, el trabajo con agregados debe realizarse a trav√©s de la "ra√≠z de agregaci√≥n" (la esencia ra√≠z del √°rbol). </li></ol><br>  Eric menciona repositorios en sus discursos.  No recomiendo implementar un repositorio con EF Core, porque EF ya implementa los patrones de repositorio y unidad de trabajo per se.  Te contar√© m√°s sobre esto en un art√≠culo separado, " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">¬øVale la pena usar un repositorio con EF Core</a> ?" <br><br><h3>  Entidades de estilo DDD </h3><br>  Comenzar√© mostrando el c√≥digo de entidad en estilo DDD y luego compar√°ndolo con la forma en que generalmente se crean las entidades con EF Core (nota del traductor. El autor llama a la palabra "generalmente" un modelo an√©mico). Para este ejemplo, usar√© la base de datos de Internet librer√≠a (una versi√≥n muy simplificada de Amazon ‚Äù. La estructura de la base de datos se muestra en la imagen a continuaci√≥n. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7e3/03d/4be/7e303d4bea08c1f34afa0d9848a2ff72.png" alt="imagen"><br><br>  Las primeras cuatro tablas representan todo sobre los libros: los libros mismos, sus autores, rese√±as.  Las dos tablas siguientes se utilizan en el c√≥digo de l√≥gica de negocios.  Este tema se describe en detalle en un art√≠culo separado. <br><blockquote>  Todo el c√≥digo de este art√≠culo se ha subido al repositorio <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">GenericBizRunner en GitHub</a> .  Adem√°s del c√≥digo de la biblioteca GenericBizRunner, hay otro ejemplo de una aplicaci√≥n ASP.NET Core que usa GenericBizRunner para trabajar con la l√≥gica empresarial.  M√°s sobre esto est√° escrito en el art√≠culo " <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">Biblioteca para trabajar con l√≥gica de negocios y Entity Framework Core</a> ". </blockquote>  Y aqu√≠ est√° el c√≥digo de entidad correspondiente a la estructura de la base de datos. <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> PromotionalTextLength = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> BookId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ all other properties have a private set //These are the DDD aggregate propties: Reviews and AuthorLinks public IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); public IEnumerable&lt;BookAuthor&gt; AuthorsLink =&gt; _authorsLink?.ToList(); //private, parameterless constructor used by EF Core private Book() { } //public constructor available to developer to create a new book public Book(string title, string description, DateTime publishedOn, string publisher, decimal price, string imageUrl, ICollection&lt;Author&gt; authors) { //code left out } //now the methods to update the book's properties public void UpdatePublishedOn(DateTime newDate)‚Ä¶ public IGenericErrorHandler AddPromotion(decimal newPrice, string promotionalText)‚Ä¶ public void RemovePromotion()‚Ä¶ //now the methods to update the book's aggregates public void AddReview(int numStars, string comment, string voterName, DbContext context)‚Ä¶ public void RemoveReview(Review review)‚Ä¶ }</span></span></code> </pre> <br>  Qu√© buscar: <br><br><ol><li>  L√≠nea 5: establece el acceso a todas las propiedades de la entidad declaradas privadas.  Esto significa que los datos se pueden modificar utilizando el constructor o los m√©todos p√∫blicos descritos m√°s adelante en este art√≠culo. </li><li>  L√≠neas 9 y 10. Las colecciones relacionadas (los mismos agregados de DDD) proporcionan acceso p√∫blico a IEnumerable &lt;T&gt;, no ICollection &lt;T&gt;.  Esto significa que no puede agregar o eliminar elementos de la colecci√≥n directamente.  Deber√° utilizar m√©todos especializados de la clase Libro. </li><li>  L√≠nea 13. EF Core requiere un constructor sin par√°metros, pero puede tener acceso privado.  Esto significa que otro c√≥digo de aplicaci√≥n no podr√° evitar la inicializaci√≥n y crear instancias de clases utilizando un constructor sin par√°metros (comentario de un traductor. A menos que, por supuesto, cree entidades utilizando solo reflexi√≥n) </li><li>  L√≠neas 16-20: la √∫nica forma de crear una instancia de la clase Book es usar el constructor p√∫blico.  Este constructor contiene toda la informaci√≥n necesaria para inicializar el objeto.  Por lo tanto, se garantiza que el objeto est√© en un estado v√°lido. </li><li>  L√≠neas 23-25: Estas l√≠neas contienen m√©todos para cambiar el estado de un libro. </li><li>  L√≠neas 28-29: estos m√©todos le permiten cambiar entidades relacionadas (agregados) </li></ol><br>  Los m√©todos en las l√≠neas 23-39, seguir√© llamando a los "m√©todos que proporcionan acceso".  Estos m√©todos son la √∫nica forma de cambiar las propiedades y las relaciones dentro de una entidad.  La conclusi√≥n es que la clase Libro est√° "cerrada".  Se crea a trav√©s de un constructor especial y solo puede modificarse parcialmente a trav√©s de m√©todos especiales con nombres adecuados.  Este enfoque crea un fuerte contraste con el enfoque est√°ndar para crear / modificar entidades en EF Core, en el que todas las entidades contienen un constructor predeterminado vac√≠o y todas las propiedades se declaran p√∫blicas.  La siguiente pregunta es, ¬øpor qu√© es mejor el primer enfoque? <br><br><h3>  Comparaci√≥n de creaci√≥n de entidad </h3><br>  Comparemos el c√≥digo para obtener datos de varios libros de json y crear instancias de las clases de libros sobre la base. <br><br><h3>  a.  Enfoque est√°ndar </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> price = (<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>) (bookInfoJson.saleInfoListPriceAmount ?? DefaultBookPrice) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book { Title = bookInfoJson.title, Description = bookInfoJson.description, PublishedOn = DecodePubishDate(bookInfoJson.publishedDate), Publisher = bookInfoJson.publisher, OrgPrice = price, ActualPrice = price, ImageUrl = bookInfoJson.imageLinksThumbnail }; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; book.AuthorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;BookAuthor&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> author <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> bookInfoJson.authors) { book.AuthorsLink.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor { Book = book, Author = authorDict[author], Order = i++ }); }</code> </pre><br><h3>  b.  Estilo DDD </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authors = bookInfoJson.authors.Select(x =&gt; authorDict[x]).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Book(bookInfoJson.title, bookInfoJson.description, DecodePubishDate(bookInfoJson.publishedDate), bookInfoJson.publisher, ((<span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>?)bookInfoJson.saleInfoListPriceAmount) ?? DefaultBookPrice, bookInfoJson.imageLinksThumbnail, authors);</code> </pre><br>  C√≥digo de constructor de clase de libro <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Book</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> title, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> description, DateTime publishedOn, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> publisher, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> price, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> imageUrl, ICollection&lt;Author&gt; authors</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(title)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(title)); Title = title; Description = description; PublishedOn = publishedOn; Publisher = publisher; ActualPrice = price; OrgPrice = price; ImageUrl = imageUrl; _reviews = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;Review&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (authors == <span class="hljs-literal"><span class="hljs-literal">null</span></span> || !authors.Any()) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException( <span class="hljs-string"><span class="hljs-string">"You must have at least one Author for a book"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(authors)); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> order = <span class="hljs-number"><span class="hljs-number">0</span></span>; _authorsLink = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;BookAuthor&gt;( authors.Select(a =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BookAuthor(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, a, order++))); }</code> </pre><br>  Qu√© buscar: <br><br><ol><li>  L√≠neas 1-2: el constructor lo obliga a pasar todos los datos necesarios para una inicializaci√≥n adecuada. </li><li>  L√≠neas 5, 6 y 17-9: el c√≥digo contiene varias comprobaciones de reglas comerciales.  En este caso particular, una violaci√≥n de las reglas se considera un error en el c√≥digo, por lo tanto, en caso de violaci√≥n, se lanzar√° una excepci√≥n.  Si el usuario pudiera corregir estos errores, quiz√°s usar√≠a una f√°brica est√°tica que devuelve Estado &lt;T&gt; (traductor de comentarios. Usar√≠a la Opci√≥n &lt;T&gt; o Resultado &lt;T&gt;, como un nombre m√°s com√∫n).  El estado es un tipo que devuelve una lista de errores. </li><li>  L√≠neas 21-23: el enlace BookAuthor se crea en el constructor.  El constructor BookAuthor se puede declarar con el nivel de acceso interno.  De esta forma podemos evitar la creaci√≥n de relaciones fuera del DAL. </li></ol><br>  Como habr√°s notado, la cantidad de c√≥digo para crear una entidad es aproximadamente la misma en ambos casos.  Entonces, ¬øpor qu√© es mejor el estilo DDD?  El estilo DDD es mejor en eso: <br><br><ol><li>  Controles de acceso.  Se excluye el cambio accidental de propiedad.  Cualquier cambio se produce a trav√©s del constructor o m√©todo p√∫blico con el nombre correspondiente.  Obviamente lo que est√° pasando. </li><li>  Corresponde a DRY (no te repitas).  Es posible que deba crear instancias de libros en varios lugares.  El c√≥digo de asignaci√≥n est√° en el constructor y no tiene que repetirlo en varios lugares. </li><li>  Oculta la complejidad.  La clase Book tiene dos propiedades: ActualPrice y OrgPrice.  Ambos valores deben ser iguales al crear un nuevo libro.  En un enfoque est√°ndar, cada desarrollador debe ser consciente de esto.  En el enfoque DDD, es suficiente que el desarrollador de la clase Book lo sepa.  El resto aprender√° sobre esta regla porque est√° expl√≠citamente escrita en el constructor. </li><li>  Oculta la creaci√≥n agregada.  En un enfoque est√°ndar, el desarrollador debe crear manualmente una instancia de BookAuthor.  En el estilo DDD, esta complejidad se encapsula para el c√≥digo de llamada. </li><li>  Permite que las propiedades tengan acceso de escritura privado </li><li>  Una de las razones para usar DDD es bloquear la entidad, es decir  No le d√© la posibilidad de cambiar las propiedades directamente.  Comparemos la operaci√≥n de cambio con y sin DDD. </li></ol><br><h3>  Comparaci√≥n de cambio de propiedad </h3><br>  Eric Evans, una de las principales ventajas de las entidades de estilo DDD, dice lo siguiente: "Comunican las decisiones de dise√±o sobre el acceso a objetos". <br><blockquote>  Nota  traductor  La frase original es dif√≠cil de traducir al ruso.  En este caso, las decisiones de dise√±o son decisiones tomadas sobre c√≥mo deber√≠a funcionar el software.  Esto significa que las decisiones fueron discutidas y confirmadas.  El c√≥digo con constructores que inicializan correctamente entidades y m√©todos con nombres correctos que reflejan el significado de las operaciones le dice expl√≠citamente al desarrollador que las asignaciones de ciertos valores se hicieron con intenci√≥n, y no por error, y no son un capricho de otro desarrollador o detalles de implementaci√≥n. </blockquote>  Entiendo esta frase de la siguiente manera. <br><br><ol><li>  Haga obvio c√≥mo modificar los datos dentro de una entidad y qu√© datos deber√≠an cambiar juntos. </li><li>  Haga obvio cu√°ndo no debe modificar ciertos datos en la entidad. </li></ol>  Comparemos los dos enfoques.  El primer ejemplo es simple, y el segundo es m√°s complicado. <br><br><h3>  1. Cambio de fecha de publicaci√≥n </h3><br>  Supongamos que queremos trabajar primero con un borrador de un libro y solo luego publicarlo.  Al momento de escribir el borrador, se establece una fecha de publicaci√≥n estimada, que es muy probable que cambie durante el proceso de edici√≥n.  Para almacenar la fecha de publicaci√≥n, utilizaremos la propiedad Publicada. <br><br><h3>  a.  Entidad con propiedades p√∫blicas </h3><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.PublishedOn = dto.PublishedOn; context.SaveChanges();</code> </pre><br><h3>  b.  Entidad de estilo DDD </h3><br>  En el estilo DDD, el establecedor de la propiedad se declara privado, por lo que utilizaremos un m√©todo de acceso especializado. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); book.UpdatePublishedOn( dto.PublishedOn); context.SaveChanges();</code> </pre><br>  Estos dos casos son casi iguales.  La versi√≥n DDD es incluso un poco m√°s larga.  Pero todav√≠a hay una diferencia.  En el estilo DDD, sabe con certeza que la fecha de publicaci√≥n se puede cambiar porque hay un m√©todo con un nombre obvio.  Tambi√©n sabe que no puede cambiar el editor porque la propiedad del editor no tiene un m√©todo apropiado para cambiar.  Esta informaci√≥n ser√° √∫til para cualquier programador que trabaje con una clase de libros. <br><br><h3>  2. Administrar el descuento para el libro. </h3><br>  Otro requisito es que debemos poder gestionar los descuentos.  El descuento consiste en un nuevo precio y un comentario, por ejemplo, "¬°50% antes del final de esta semana!" <br><br>  La implementaci√≥n de esta regla es simple, pero no demasiado obvia. <br><br><ol><li>  La propiedad OrgPrice es el precio sin descuento. </li><li>  Precio real: el precio actual al que se vende el libro.  Si el descuento es v√°lido, el precio actual diferir√° de OrgPrice por el tama√±o del descuento.  Si no, entonces el valor de las propiedades ser√° igual. </li><li>  La propiedad PromotionText debe contener el texto de descuento si se aplica el descuento o nulo si el descuento no se aplica actualmente. </li></ol><br>  Las reglas son bastante obvias para la persona que las implement√≥.  Sin embargo, para otro desarrollador, por ejemplo, desarrollar una interfaz de usuario para agregar un descuento.  Agregar los m√©todos AddPromotion y RemovePromotion a la clase de entidad oculta los detalles de implementaci√≥n.  Ahora otro desarrollador tiene m√©todos p√∫blicos con los nombres correspondientes.  La sem√°ntica del uso de m√©todos es obvia. <br><br>  Eche un vistazo a la implementaci√≥n de los m√©todos AddPromotion y RemovePromotion. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IGenericErrorHandler </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddPromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> newPrice, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> promotionalText</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericErrorHandler(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(promotionalText)) { status.AddError( <span class="hljs-string"><span class="hljs-string">"You must provide some text to go with the promotion."</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(PromotionalText)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; } ActualPrice = newPrice; PromotionalText = promotionalText; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status; }</code> </pre><br>  Qu√© buscar: <br><br><ol><li>  L√≠neas 4-10: se requiere agregar un comentario de texto promocional.  El m√©todo verifica que el texto no est√© vac√≠o.  Porque  El usuario puede corregir este error. El m√©todo devuelve una lista de errores para su correcci√≥n. </li><li>  L√≠neas 12, 13: el m√©todo establece los valores de las propiedades de acuerdo con la implementaci√≥n que el desarrollador ha elegido.  El usuario del m√©todo AddPromotion no tiene que conocerlos.  Para agregar un descuento, solo escriba: </li></ol><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> book = context.Find&lt;Book&gt;(dto.BookId); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> status = book.AddPromotion(newPrice, promotionText); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!status.HasErrors) context.SaveChanges(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> status;</code> </pre><br>  El m√©todo RemovePromotion es mucho m√°s simple: no implica el manejo de errores.  Por lo tanto, el valor de retorno es nulo. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemovePromotion</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ActualPrice = OrgPrice; PromotionalText = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre><br>  Estos dos ejemplos son muy diferentes entre s√≠.  En el primer ejemplo, cambiar la propiedad PublishOn es tan simple que la implementaci√≥n est√°ndar est√° bien.  En el segundo ejemplo, los detalles de implementaci√≥n no son obvios para alguien que no ha trabajado con la clase Libro.  En el segundo caso, el estilo DDD con m√©todos de acceso especializados oculta los detalles de implementaci√≥n y facilita la vida de otros desarrolladores.  Adem√°s, en el segundo ejemplo, el c√≥digo contiene l√≥gica empresarial.  Si bien la cantidad de l√≥gica es peque√±a, podemos almacenarla directamente en los m√©todos de acceso y devolver una lista de errores si el m√©todo no se usa correctamente. <br><br><h3>  3. Trabajar con el agregado - Colecci√≥n de propiedades Comentarios </h3><br>  DDD ofrece trabajar con la unidad solo a trav√©s de la ra√≠z.  En nuestro caso, la propiedad Comentarios crea problemas.  Incluso si setter se declara privado, el desarrollador puede agregar o eliminar objetos utilizando los m√©todos add y remove, o incluso llamar al m√©todo clear para borrar toda la colecci√≥n.  Aqu√≠, la nueva funci√≥n EF Core, <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">campos de respaldo,</a> nos ayudar√°. <br><br>  El campo de respaldo permite al desarrollador encapsular la colecci√≥n real y proporcionar acceso p√∫blico al enlace de interfaz IEnumerable &lt;T&gt;.  La interfaz IEnumerable &lt;T&gt; no proporciona m√©todos para agregar, quitar o borrar.  En el siguiente c√≥digo se muestra un ejemplo del uso de campos de respaldo. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Book</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> HashSet&lt;Review&gt; _reviews; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IEnumerable&lt;Review&gt; Reviews =&gt; _reviews?.ToList(); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ rest of code not shown }</span></span></code> </pre><br>  Para que esto funcione, debe decirle a EF Core que al leer desde la base de datos, debe escribir en un campo privado, no en una propiedad p√∫blica.  El c√≥digo de configuraci√≥n se muestra a continuaci√≥n. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.Entity&lt;Book&gt;() .FindNavigation(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(Book.Reviews)) .SetPropertyAccessMode(PropertyAccessMode.Field); <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ other non-review configurations left out }</span></span></code> </pre><br>  Para trabajar con revisiones, agregu√© dos m√©todos: AddReview y RemoveReview a la clase de libro.  El m√©todo AddReview es m√°s interesante.  Aqu√≠ est√° su c√≥digo: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddReview</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> numStars, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> comment, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> voterName, DbContext context = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_reviews != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _reviews.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-keyword"><span class="hljs-keyword">nameof</span></span>(context), <span class="hljs-string"><span class="hljs-string">"You must provide a context if the Reviews collection isn't valid."</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (context.Entry(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).IsKeySet) { context.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Review(numStars, comment, voterName, BookId)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> InvalidOperationException(<span class="hljs-string"><span class="hljs-string">"Could not add a new review."</span></span>); } }</code> </pre><br>  Qu√© buscar: <br><br><ol><li>  L√≠neas 4-7: intencionalmente no inicializo el campo _reviews en un constructor privado sin par√°metros que EF Core usa al cargar entidades desde la base de datos.  Esto permite que mi c√≥digo determine si la colecci√≥n se carg√≥ utilizando el m√©todo .Include (p =&gt; p.Reviews).  En el constructor p√∫blico, inicializo el campo, por lo que NRE no suceder√° cuando trabaje con la entidad creada. </li><li>  L√≠neas 8-12: si la colecci√≥n de Revisiones no se carg√≥, el c√≥digo debe usar DbContext para inicializar. </li><li>  L√≠neas 13-16: si el libro se cre√≥ con √©xito y contiene una ID, entonces uso otra t√©cnica para agregar una revisi√≥n: simplemente instalo una clave externa en una instancia de la clase Revisar y la escribo en la base de datos.  Esto se describe con m√°s detalle en la secci√≥n 3.4.5 de mi libro. </li><li>  L√≠nea 19: Si estamos aqu√≠, entonces hay alg√∫n tipo de problema con la l√≥gica del c√≥digo.  Entonces lanzo una excepci√≥n. </li></ol><br>  He dise√±ado todos mis m√©todos de acceso para casos invertidos donde solo se carga la entidad ra√≠z.  La forma de actualizar la unidad queda a criterio de los m√©todos.  Es posible que deba cargar entidades adicionales. <br><br><h3>  Conclusi√≥n </h3><br>  Para crear entidades en estilo DDD con EF Core, debe cumplir con las siguientes reglas: <br><br><ol><li>  Cree constructores p√∫blicos para crear instancias de clase inicializadas correctamente.  Si se pueden producir errores durante el proceso de creaci√≥n que el usuario puede corregir, cree el objeto no utilizando el constructor p√∫blico, sino utilizando el m√©todo de f√°brica que devuelve Estado &lt;T&gt;, donde T es el tipo de entidad que se est√° creando </li><li>  Todas las propiedades son establecedores de propiedades.  Es decir  Todas las propiedades son de solo lectura fuera de la clase. </li><li>  Para las propiedades de navegaci√≥n de la colecci√≥n, declare los campos de respaldo y el tipo de propiedad p√∫blica declare IEnumerable &lt;T&gt;.  Esto evitar√° que otros desarrolladores cambien las colecciones de forma incontrolable. </li><li>  En lugar de establecedores p√∫blicos, cree m√©todos p√∫blicos para todas las operaciones de cambio de objeto permitidas.  Estos m√©todos deben devolver nulo si la operaci√≥n no puede fallar con un error que el usuario puede corregir, o Estado &lt;T&gt; si pueden. </li><li>  El alcance de la responsabilidad de la entidad es importante.  Creo que es mejor limitar las entidades para cambiar la clase en s√≠ y otras clases dentro del agregado, pero no fuera.  Las reglas de validaci√≥n deben limitarse a verificar la correcci√≥n de la creaci√≥n y el cambio de estado de las entidades.  Es decir  No verifico las reglas comerciales como los saldos de acciones.  Hay un c√≥digo especial de l√≥gica de negocios para esto. </li><li>  Los m√©todos de cambio de estado deben suponer que solo se carga la ra√≠z de agregaci√≥n.  Si un m√©todo necesita cargar otros datos, debe cuidarlo solo. </li><li>  Los m√©todos de cambio de estado deben suponer que solo se carga la ra√≠z de agregaci√≥n.  Si un m√©todo necesita cargar otros datos, debe cuidarlo solo.  Este enfoque simplifica el uso de entidades por parte de otros desarrolladores. </li></ol><br><h3>  Pros y contras de las entidades DDD cuando se trabaja con EF Core </h3><br>  Me gusta el enfoque cr√≠tico de cualquier patr√≥n o arquitectura.  Esto es lo que pienso sobre el uso de entidades DDD. <br><br><h3>  Pros </h3><br><ol><li>  Usar m√©todos especializados para cambiar el estado es un enfoque m√°s limpio.  Esta es definitivamente una buena soluci√≥n, simplemente porque los m√©todos nombrados correctamente revelan las intenciones del c√≥digo mucho mejor y hacen obvio lo que se puede y no se puede cambiar.  Adem√°s, los m√©todos pueden devolver una lista de errores si el usuario puede corregirlos. </li><li>  Cambiar agregados solo a trav√©s de la ra√≠z tambi√©n funciona bien </li><li>  Los detalles de la relaci√≥n uno a muchos entre las clases Libro y Revisi√≥n ahora est√°n ocultos para el usuario.  La encapsulaci√≥n es un principio b√°sico de la POO. </li><li>  El uso de constructores especializados le permite asegurarse de que las entidades se crean y se garantiza que se inicializar√°n correctamente. </li><li>  Mover el c√≥digo de inicializaci√≥n al constructor reduce significativamente la probabilidad de que el desarrollador no interprete correctamente c√≥mo se debe inicializar la clase. </li></ol><br><h3>  Contras </h3><br><ol><li>  Mi enfoque contiene dependencias en la implementaci√≥n de EF Core. </li><li>  Algunas personas incluso lo llaman antipatr√≥n.  El problema es que ahora las entidades del modelo sujeto dependen del c√≥digo de acceso a la base de datos.  En t√©rminos de DDD, esto es malo.  Me di cuenta de que si no hubiera hecho esto, habr√≠a tenido que confiar en la persona que llama para saber qu√© deber√≠a cargarse.  Este enfoque rompe el principio de separaci√≥n de preocupaciones. </li><li>  DDD te obliga a escribir m√°s c√≥digo. </li></ol><br>  ¬øRealmente vale la pena en casos simples, como actualizar la fecha de publicaci√≥n de un libro? <br>  Como puede ver, me gusta el enfoque DDD.  Sin embargo, me tom√≥ un tiempo estructurarlo correctamente, pero en este momento el enfoque ya se ha resuelto y lo estoy aplicando en los proyectos en los que estoy trabajando.  Ya logr√© probar este estilo en proyectos peque√±os y estoy satisfecho, pero a√∫n no se han descubierto todos los pros y los contras cuando lo aplico en proyectos grandes. <br><br>  Mi decisi√≥n de permitir el uso de c√≥digo espec√≠fico de EFCore en los argumentos de los m√©todos de entidad del modelo de entidad no fue simple.  Trat√© de evitar esto, pero al final llegu√© a la conclusi√≥n de que el c√≥digo de llamada ten√≠a que cargar muchas propiedades de navegaci√≥n.  Y si esto no se hace, entonces el cambio simplemente no se aplicar√° sin ning√∫n error (especialmente en una relaci√≥n uno a uno).  Esto no era aceptable para m√≠, as√≠ que permit√≠ el uso de EF Core en algunos m√©todos (pero no en los constructores). <br><br>  Otro lado malo es que DDD te obliga a escribir significativamente m√°s c√≥digo para las operaciones CRUD.  Todav√≠a no estoy seguro de si seguir comiendo un cactus y escribir m√©todos separados para todas las propiedades, o en algunos casos vale la pena alejarse de un puritanismo tan radical.  S√© que solo hay un carro y un peque√±o cami√≥n de CRUD aburrido, que es m√°s f√°cil de escribir directamente.  Solo el trabajo en proyectos reales mostrar√° cu√°l es mejor. <br><br><h3>  Otros aspectos DDD no cubiertos en este art√≠culo </h3><br>  El art√≠culo ha resultado ser demasiado largo, as√≠ que voy a terminar aqu√≠.  Pero, esto significa que todav√≠a hay mucho material no revelado.  Ya escrib√≠ sobre algo, sobre algo que escribir√© en el futuro cercano.  Esto es lo que queda por la borda: <br><br><ol><li>  <b>L√≥gica empresarial y DDD.</b>  He estado usando conceptos DDD en c√≥digo de l√≥gica de negocios durante varios a√±os y, usando las nuevas caracter√≠sticas de EF Core, espero poder transferir parte de la l√≥gica al c√≥digo de entidad.  Lea el art√≠culo "Una vez m√°s sobre la arquitectura de la capa de l√≥gica de negocios con Entity Framework (Core y v6)" </li><li>  <b>DDD y el patr√≥n de repositorio.</b>  Eric Evans recomienda utilizar un repositorio para abstraer el acceso a los datos.    ,    ¬´¬ª   EF Core ‚Äì  .  Por qu√©   -  . </li><li> <b> DBContext' /   (bounded contexts).</b>          DbContext'. ,   BookContext      Book        OrderContext,   . ,  ¬´ ¬ª  ,      .         ,         . </li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Todo el c√≥digo para este art√≠culo est√° disponible en </font></font><a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u="><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">el repositorio GenericBizRunner en GitHub</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Este repositorio contiene una aplicaci√≥n ASP.NET Core de ejemplo con m√©todos de acceso especializados para modificar la clase Book. </font><font style="vertical-align: inherit;">Puede clonar el repositorio y ejecutar la aplicaci√≥n localmente. </font><font style="vertical-align: inherit;">Utiliza Sqlite en memoria como base de datos, por lo que debe ejecutarse en cualquier infraestructura. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬°Feliz desarrollo!</font></font></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es432410/">https://habr.com/ru/post/es432410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../de434978/index.html">Einf√ºhrung in HealthKit</a></li>
<li><a href="../es432400/index.html">CS: GO ahora es gratis</a></li>
<li><a href="../es432402/index.html">Hola HR, ¬ød√≥nde est√° mi recuerdo?</a></li>
<li><a href="../es432404/index.html">Backup for Linux no escribe cartas</a></li>
<li><a href="../es432408/index.html">Fintech digest: preparaci√≥n para desconectar bancos peque√±os de Visa y Mastercard, una calculadora de pensiones y no solo</a></li>
<li><a href="../es432412/index.html">Highload ++: C√≥mo ayudar al sistema ERP a hacer frente a 500,000 solicitudes por segundo</a></li>
<li><a href="../es432414/index.html">Viejos secretos para la depuraci√≥n r√°pida: animaci√≥n del c√≥digo fuente</a></li>
<li><a href="../es432416/index.html">Tipos dependientes: el futuro de los lenguajes de programaci√≥n</a></li>
<li><a href="../es432418/index.html">Analizando expresiones lambda en Java</a></li>
<li><a href="../es432420/index.html">Introducci√≥n a Git Merge y Git Rebase: por qu√© y cu√°ndo usarlos</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>