<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶á üéõÔ∏è üë©üèª‚Äçüîß Desenfoque de Laplace: ¬øes posible borrar Laplace en lugar de Gauss, cu√°ntas veces es m√°s r√°pido y vale la pena perder 1/32 de precisi√≥n? üîô ‚ùì üïö</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content=""Desenfoque" en la gente com√∫n es un efecto de desenfoque en el procesamiento de im√°genes digitales. Puede ser muy eficaz en s√≠ mismo y como component...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Desenfoque de Laplace: ¬øes posible borrar Laplace en lugar de Gauss, cu√°ntas veces es m√°s r√°pido y vale la pena perder 1/32 de precisi√≥n?</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/427077/"><img src="https://habrastorage.org/webt/ge/pb/p3/gepbp3bpdluk4yg0-xzbn0via3y.jpeg" alt="imagen"><br><br>  "Desenfoque" en la gente com√∫n es un efecto de desenfoque en el procesamiento de im√°genes digitales.  Puede ser muy eficaz en s√≠ mismo y como componente de animaciones de interfaz o efectos derivados m√°s complejos (bloom / focusBlur / motionBlur).  Con todo esto, los azules honestos en la frente son bastante lentos.  Y a menudo las implementaciones integradas en la plataforma de destino dejan mucho que desear.  O la velocidad es triste, los artefactos lastiman los ojos.  La situaci√≥n da lugar a muchas implementaciones de compromiso que son mejores o peores para ciertas condiciones.  Una implementaci√≥n original con buena calidad de confiabilidad y la velocidad m√°s alta, mientras que la dependencia m√°s baja del hardware lo est√° esperando.  Buen provecho! <br><a name="habracut"></a><br>  (Desenfoque de Laplace - Nombre del algoritmo original propuesto) <br><br>  Hoy, mi demoscene interno me dio una patada y me oblig√≥ a escribir un art√≠culo que ten√≠a que ser escrito hace seis meses.  Como aficionado, durante el tiempo libre, para desarrollar algoritmos de efectos originales, me gustar√≠a ofrecer al p√∫blico un algoritmo de "casi blurah gausiano", caracterizado por el uso de instrucciones de procesador excepcionalmente r√°pidas (cambios y m√°scaras), y por lo tanto accesible para la implementaci√≥n hasta microcontroladores (extremadamente r√°pido en un entorno limitado). <br><br>  De acuerdo con mi tradici√≥n de escribir art√≠culos sobre Habr, dar√© ejemplos en JS como el lenguaje m√°s popular, y lo creas o no, es muy conveniente para la creaci√≥n r√°pida de prototipos de algoritmos.  Adem√°s, la capacidad de implementar esto de manera efectiva en JS vino con matrices escritas.  En mi port√°til no muy potente, la imagen de pantalla completa se procesa a una velocidad de 30 fps (no se incluy√≥ el subprocesamiento m√∫ltiple de los trabajadores). <br><br><div class="spoiler">  <b class="spoiler_title">Descargo de responsabilidad para Cool Maths</b> <div class="spoiler_text">  Dir√© de inmediato que me estoy quitando el sombrero porque considero que no soy lo suficientemente inteligente en matem√°ticas fundamentales.  Sin embargo, siempre me gu√≠a el esp√≠ritu general de un enfoque fundamental.  Por lo tanto, antes de hacer trampa en mi enfoque algo "observacional" de la aproximaci√≥n, tenga cuidado de calcular la complejidad de bits del algoritmo, que, como cree, puede obtenerse mediante m√©todos de aproximaci√≥n polinomiales cl√°sicos.  Supuse que no?  ¬øQuer√≠as aproximarlos r√°pidamente?  Dado que requieren aritm√©tica flotante, ser√°n significativamente m√°s lentos que un solo cambio de bit, lo que explicar√© al final.  En una palabra, no te apresures al fundamentalismo te√≥rico, y no te olvides del contexto en el que resuelvo el problema. <br></div></div><br>  Esta descripci√≥n est√° presente aqu√≠ m√°s bien para explicar el curso de mis pensamientos y conjeturas que me llevaron al resultado.  Para quienes est√©n interesados: <br><br>  Funci√≥n original de Gauss: <br><br><img src="https://habrastorage.org/webt/63/h0/km/63h0kmf5xougnx-tcp05_esii1y.png" alt="imagen"><br><br>  g (x) = a * e ** (- ((xb) ** 2) / c), donde <br>  a es la amplitud (si tenemos ocho bits de color por canal, entonces = 256) <br>  e es la constante de Euler ~ 2.7 <br>  b - cambio de gr√°fico en x (no necesitamos = 0) <br>  c - par√°metro que afecta el ancho del gr√°fico asociado con √©l como ~ w / 2.35 <br><br>  Nuestra funci√≥n privada (menos del exponente eliminado con el reemplazo de la multiplicaci√≥n por divisi√≥n): <br><br><img src="https://habrastorage.org/webt/rj/o-/ns/rjo-nsq8o1nptsuyrbhpit1ozkw.png" alt="imagen"><br><br>  g (x) = 256 / e ** (x * x / c) <br><br>  Que comience la acci√≥n de aproximaci√≥n sucia: <br>  Tenga en cuenta que el par√°metro c est√° muy cerca de la mitad del ancho y establece 8 (esto se debe a cu√°ntos pasos puede cambiar un canal de 8 bits cada uno). <br><br>  Tambi√©n reemplazamos aproximadamente e por 2, sin embargo, notando que esto afecta la curvatura de la "campana" m√°s que sus bordes.  En realidad, afecta 2 / e veces, pero la sorpresa es que este error compensa el par√°metro c, de modo que las condiciones de contorno todav√≠a est√°n en orden, y el error aparece solo en una "distribuci√≥n normal" ligeramente incorrecta, para el gr√°fico algoritmos, esto afectar√° la din√°mica de las transiciones de color de gradiente, pero es casi imposible notarlo a simple vista. <br><br>  Entonces ahora nuestra funci√≥n es la siguiente: <br>  gg (x) = 256/2 ** (x * x / 8) o gg (x) = 2 ** (8 - x * x / 8) <br>  Tenga en cuenta que el exponente (x * x / 8) tiene el mismo rango de valores [0-8] que la funci√≥n de un orden inferior abs (x), por lo tanto, este √∫ltimo es un candidato para el reemplazo.  Comprobaremos r√°pidamente la suposici√≥n observando c√≥mo cambia el gr√°fico con ella gg (x) = 256 / (2 ** abs (x)): <br><br>  GaussBlur vs LaplasBlur: <br><br><img src="https://habrastorage.org/webt/ri/9m/wn/ri9mwnl06vzoim4atrlhnyi5wye.png" alt="imagen"><br><br>  Las desviaciones parecen ser demasiado grandes, adem√°s, la funci√≥n, habiendo perdido su suavidad, ahora tiene un pico.  Pero oye. <br><br>  Primero, no olvidemos que la suavidad de los gradientes obtenidos al difuminar no depende de la funci√≥n de densidad de probabilidad (que es la funci√≥n de Gauss), sino de su integral: la funci√≥n de distribuci√≥n.  En ese momento, no conoc√≠a este hecho, pero de hecho, despu√©s de haber llevado a cabo una aproximaci√≥n "destructiva" con respecto a la funci√≥n de densidad de probabilidad (Gauss), la funci√≥n de distribuci√≥n se mantuvo bastante similar. <br><br>  Fue: <br><br><img src="https://habrastorage.org/webt/gj/nl/_l/gjnl_lzdrv_e_yvi87kxcrnu-e4.png" alt="imagen"><br><br>  Se convirti√≥ en: <br><br><img src="https://habrastorage.org/webt/le/nw/te/lenwteibjhhx9mwosint393sgjo.png" alt="imagen"><br><br>  La prueba, tomada del algoritmo listo para usar, coincide: <br><br><img src="https://habrastorage.org/webt/lg/ly/bm/lglybmx2fx4-rtff1eq_natuodm.png" alt="imagen"><br><br>  (Mirando hacia el futuro, dir√© que el error de desenfoque de mi algoritmo en relaci√≥n con Gausian x5 fue solo del 3%). <br><br>  Entonces, nos hemos acercado mucho m√°s a la funci√≥n de distribuci√≥n de Laplace.  Qui√©n lo hubiera pensado, pero pueden lavar las im√°genes un 97% no peor. <br><br>  Prueba, diferencias Gausian blura x5 y "Laplace blura" x7: <br><br><img src="https://habrastorage.org/webt/qy/1g/z1/qy1gz1d0fahnsbstiqwijj-rb3y.png" alt="imagen"><br><br>  (¬°esto no es una imagen negra! Puedes estudiar en el editor) <br><br>  La suposici√≥n de esta transformaci√≥n nos permiti√≥ pasar a la idea de obtener el valor mediante filtrado iterativo, a lo que plane√© reducir inicialmente. <br><br>  Antes de decir un algoritmo espec√≠fico, ser√° honesto si corro hacia adelante e inmediatamente describo su √∫nico inconveniente (aunque la implementaci√≥n se puede solucionar con una p√©rdida de velocidad).  Pero este algoritmo se implementa usando aritm√©tica de corte, y las potencias de 2 son su limitaci√≥n.  Por lo tanto, el original est√° hecho para difuminar x7 (que en las pruebas es m√°s cercano a Gausian x5).  Esta limitaci√≥n de implementaci√≥n se debe al hecho de que con un color de ocho bits, cambiando el valor en la unidad de filtro en un bit por paso, cualquier acci√≥n desde el punto finaliza en un m√°ximo de 8 pasos.  Tambi√©n implement√© una versi√≥n un poco m√°s lenta a trav√©s de proporciones y adiciones adicionales, que implementa una divisi√≥n r√°pida por 1.5 (resultando en un radio de x15).  Pero con la aplicaci√≥n adicional de este enfoque, el error aumenta y la velocidad disminuye, lo que no permite que se use as√≠.  Por otro lado, vale la pena se√±alar que x15 ya es suficiente para no notar la diferencia, el resultado se obtiene del original o de la imagen muestreada hacia abajo.  Por lo tanto, el m√©todo es bastante adecuado si necesita una velocidad extraordinaria en un entorno limitado. <br><br>  Entonces, el n√∫cleo del algoritmo es simple, se realizan cuatro pases del mismo tipo: <br><br>  1. La mitad del valor de la unidad t (inicialmente igual a cero) se agrega a la mitad del valor del siguiente p√≠xel, el resultado se le asigna.  Contin√∫e de esta manera hasta el final de la l√≠nea de la imagen.  Para todas las lineas. <br><br>  Al completar la primera pasada, la imagen se ve borrosa en una direcci√≥n. <br><br>  2. En la segunda pasada, hacemos lo mismo en la direcci√≥n opuesta para todas las l√≠neas. <br>  Obtenemos una imagen que est√° completamente borrosa horizontalmente. <br><br>  3-4.  Ahora haz lo mismo verticalmente. <br>  Hecho <br><br>  Inicialmente, utilic√© un algoritmo de dos pasadas con la implementaci√≥n de back-blur a trav√©s de la pila, pero es dif√≠cil de entender, no es elegante, y result√≥ ser m√°s lento en las arquitecturas actuales.  Quiz√°s el algoritmo de una pasada sea m√°s r√°pido en los microcontroladores, y la capacidad de generar el resultado progresivamente tambi√©n ser√° una ventaja. <br><br>  El m√©todo actual de implementaci√≥n de cuatro v√≠as, mir√© a Habr√© del gur√∫ anterior sobre algoritmos de desenfoque.  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">habr.com/post/151157</a> Aprovecho esta oportunidad para expresarle mi solidaridad y mi profunda gratitud. <br><br>  Pero los hacks no terminaron all√≠.  ¬°Ahora sobre c√≥mo calcular los tres canales de color en una instrucci√≥n de procesador!  El hecho es que el desplazamiento de bits utilizado como divisi√≥n entre dos le permite controlar muy bien la posici√≥n de los bits de resultado.  El √∫nico problema es que los bits m√°s bajos de los canales se deslizan hacia los canales vecinos m√°s altos, pero simplemente puede restablecerlos, que solucionar el problema, con cierta p√©rdida de precisi√≥n.  Y de acuerdo con la f√≥rmula de filtro descrita, la adici√≥n de la mitad del valor de la unidad con la mitad del valor de la siguiente celda (sujeto a restablecer los bits descargados) nunca conduce al desbordamiento, por lo que no debe preocuparse por eso.  Y la f√≥rmula del filtro para el c√°lculo simult√°neo de todos los d√≠gitos se convierte en esto: <br><br>  buf32 [i] = t = (((t &gt;&gt; 1) &amp; 0x7F7F7F) + ((buf32 [i] &gt;&gt; 1) &amp; 0x7F7F7F); <br><br>  Sin embargo, se requiere una adici√≥n m√°s: se descubri√≥ experimentalmente que la p√©rdida de precisi√≥n en esta f√≥rmula es demasiado significativa, el brillo de la imagen salta visualmente significativamente.  Qued√≥ claro que el bit perdido debe redondearse al entero m√°s cercano y no descartarse.  Una manera f√°cil de hacer esto en aritm√©tica de enteros es agregar la mitad del divisor antes de la divisi√≥n.  Nuestro divisor es dos, por lo que debe agregar uno, en todos los d√≠gitos, la constante 0x010101.  Pero con cualquier adici√≥n, uno debe tener cuidado con el desbordamiento.  Por lo tanto, no podemos usar dicha correcci√≥n para calcular la mitad del valor de la siguiente celda.  (Si hay color blanco, obtendremos un desbordamiento, por lo tanto, no lo corregiremos).  Pero result√≥ que el error principal fue cometido por la divisi√≥n m√∫ltiple de la unidad, que podemos corregir.  Porque, de hecho, incluso con tal correcci√≥n, el valor en la unidad no aumentar√° por encima de 254. Pero cuando se agrega a 0x010101, no se garantizar√° el desbordamiento.  Y la f√≥rmula del filtro con correcci√≥n toma la forma: <br><br>  buf32 [i] = t = (((((0x010101 + t) &gt;&gt; 1) &amp; 0x7F7F7F) + ((buf32 [i] &gt;&gt; 1) &amp; 0x7F7F7F); <br><br>  De hecho, la f√≥rmula realiza la correcci√≥n bastante bien, por lo que cuando aplica repetidamente este algoritmo a la imagen, los artefactos comienzan a ser visibles solo en los segundos diez pases.  (no el hecho de que repetir la blura gausiana no producir√° tales artefactos). <br><br>  Adem√°s, hay una propiedad maravillosa con muchos pases.  (Esto no se debe a mi algoritmo, sino a la "normalidad" de la distribuci√≥n normal).  Ya en el segundo paso de Laplace Blura, la funci√≥n de densidad de probabilidad (si supuse que todo est√° bien) se ver√° as√≠: <br><br><img src="https://habrastorage.org/webt/sl/1m/tk/sl1mtkidvvurt8z7vxiuhjbfzka.png" alt="imagen"><br><br>  Lo cual, ya ves, ya est√° muy cerca del gaussiano. <br><br>  Emp√≠ricamente, descubr√≠ que usar modificaciones con un radio grande es permisible en pares, porque  la propiedad descrita anteriormente compensa los errores si la √∫ltima pasada es m√°s precisa (la m√°s precisa es el algoritmo de desenfoque x7 descrito aqu√≠). <br><br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">demo</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">rap</a> <br>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">codpen</a> <br><br>  Un atractivo para los matem√°ticos geniales: <br>  Lo que ser√≠a interesante saber qu√© tan correcto es usar dicho filtro por separado, no estoy seguro de si hay una imagen de distribuci√≥n sim√©trica.  Aunque la heterogeneidad del ojo no es visible. <br><br>  upd: Aqu√≠ subir√© enlaces √∫tiles, amablemente presentados por comentaristas, y encontrados de otros Khabrovites. <br>  1. C√≥mo funcionan los asistentes de inteligencia basados ‚Äã‚Äãen el poder de SSE - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">software.intel.com/en-us/articles/iir-gaussian-blur-filter-implementation-using-intel-advanced-vector-extensions</a> (gracias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">vladimirovich</a> ) <br>  2. Base te√≥rica sobre el tema "Convoluciones de imagen r√°pidas" + algunas de sus aplicaciones personalizadas en relaci√≥n con el honesto gaussiano azul - <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=">blog.ivank.net/fastest-gaussian-blur.html</a> (gracias <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=es&amp;u=" class="user_link">Grox</a> ) <br><br>  Sugerencias, comentarios, cr√≠ticas constructivas son bienvenidas! </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/es427077/">https://habr.com/ru/post/es427077/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../es427059/index.html">"Humano, demasiado humano". ¬øNo nos convertiremos en rehenes de nuestra mente implementando IA universal?</a></li>
<li><a href="../es427061/index.html">Asistentes de voz al volante del autom√≥vil: para quien el futuro</a></li>
<li><a href="../es427065/index.html">Atributos de clase Metamorfosis</a></li>
<li><a href="../es427069/index.html">Repositorio local de NPM en 5 minutos con sus paquetes y cach√©</a></li>
<li><a href="../es427075/index.html">La historia de un desarrollo.</a></li>
<li><a href="../es427079/index.html">NetApp Insight 2018</a></li>
<li><a href="../es427081/index.html">Criterios de la mente humana, desde el punto de vista de un programador.</a></li>
<li><a href="../es427087/index.html">Curso MIT "Seguridad de sistemas inform√°ticos". Lecci√≥n 12: Seguridad de la red, parte 2</a></li>
<li><a href="../es427091/index.html">Verificaci√≥n num√©rica de la hip√≥tesis abc (s√≠, esa)</a></li>
<li><a href="../es427093/index.html">Curso MIT "Seguridad de sistemas inform√°ticos". Lecci√≥n 12: Seguridad de red, Parte 3</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>