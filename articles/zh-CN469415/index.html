<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>🙅🏽 🛣️ 🏴‍☠️ 最小的事务隔离级别 🚃 🤸🏼 👨🏾‍🚒</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="今天，我想带来一个非常有趣的内容，但是对于数据库（DB）的普通凡人程序员部分来说，它经常包含秘密-事务隔离级别。 正如实践所示，许多与IT相关的人员，尤其是与数据库打交道的人，几乎不了解为什么需要这些级别以及如何将其用于自己的利益。 

 一点理论 
 事务本身不需要特殊说明；事务是对数据库的N（N...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>最小的事务隔离级别</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/469415/"><img src="https://habrastorage.org/webt/v3/-j/65/v3-j65ut9hywvpnw1wmt5q6c2sg.jpeg"><br><br> 今天，我想带来一个非常有趣的内容，但是对于数据库（DB）的普通凡人程序员部分来说，它经常包含秘密-事务隔离级别。 正如实践所示，许多与IT相关的人员，尤其是与数据库打交道的人，几乎不了解为什么需要这些级别以及如何将其用于自己的利益。 <br><br><h3> 一点理论 </h3><br> 事务本身不需要特殊说明；事务是对数据库的N（N≥1）个查询，这些查询将一起成功执行或完全不成功执行。 事务隔离显示了并行事务之间相互影响的程度。 <br> 在选择事务级别时，我们试图在事务之间的数据高度一致性和事务速度之间做出选择上达成共识。 <br> 值得注意的是，最高的执行速度和最低的一致性是<b>未提交的</b> 。 最低的执行速度和最高的一致性是可<b>序列化的</b> 。 <br><a name="habracut"></a><br><h3> 环境准备 </h3><br> 例如，选择了MySQL DBMS。 也可以使用PostgreSQL，但它不支持<b>读取未提交</b>隔离级别， <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=zh-CN&amp;u=">而是使用</a> <b>读取已提交</b>级别。 事实证明，不同的DBMS对隔离级别的理解不同。 他们在确保隔离方面可以有各种细微差别，可以有更多的层次，也可以没有知名度。 <br><br> 使用完成的MySQL映像和Docker Hub创建环境。 并填写数据库。 <br><br><div class="spoiler">  <b class="spoiler_title">docker-compose.yaml</b> <div class="spoiler_text"><pre><code class="xml hljs">version: '3.4' services: db: image: mysql:8 environment: - MYSQL_ROOT_PASSWORD=12345 command: --init-file /init.sql volumes: - data:/var/lib/mysql - ./init.sql:/init.sql expose: - "3306" ports: - "3309:3306" volumes: data:</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">填充数据库</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> bank; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> bank; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> accounts ( <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> auto_increment primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>, login <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">255</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, balance <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>, created_at <span class="hljs-built_in"><span class="hljs-built_in">timestamp</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-keyword"><span class="hljs-keyword">now</span></span>() ) <span class="hljs-keyword"><span class="hljs-keyword">collate</span></span>=utf8mb4_unicode_ci; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> accounts (login, balance) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'petya'</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> accounts (login, balance) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'vasya'</span></span>, <span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> accounts (login, balance) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-string"><span class="hljs-string">'mark'</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>);</code> </pre><br></div></div><br> 让我们考虑关卡的工作方式及其功能。 <br> 我们将在2个同时执行的事务上执行示例。 有条件的，左窗口中的事务将被称为<i>事务1</i> （T1），右窗口中的<i>事务</i>将被称为<i>事务2</i> （T2）。 <br><br><h3> 阅读未提交 </h3><br> 数据一致性最差，但事务处理速度最高的级别。 该级别的名称说明一切-每个事务在另一个事务中都会看到未提交的更改（ <b>脏读</b>现象）。 让我们看看这种交易如何相互影响。 <br><br>  <b>步骤1.</b>我们开始2个并行事务。 <br><br><img src="https://habrastorage.org/webt/df/8n/xl/df8nxlfhhcshcjodtparllhouba.png"><br><br>  <b>第2步。</b>我们首先了解一下我们所拥有的信息。 <br><br><img src="https://habrastorage.org/webt/hd/38/qz/hd38qzflrzu-nnx7hs91yx7zyhm.png"><br><br>  <b>步骤3.</b>现在，我们在T1中执行INSERT，DELETE，UPDATE操作，然后看看另一个事务现在会看到什么。 <br><br><img src="https://habrastorage.org/webt/ey/k2/sd/eyk2sdewgeir6kmpjchumikl8t4.png"><br><br>  T2查看来自另一个尚未提交的事务的数据。 <br><br>  <b>步骤4</b> ，T2可以获得一些数据。 <br><br><img src="https://habrastorage.org/webt/7v/oq/tr/7voqtrzl7ihmkswvkx0tsxao7n8.png"><br><br>  <b>步骤5.</b>当您将更改回滚到T1时，T2接收的数据将是错误的。 <br><br><img src="https://habrastorage.org/webt/zp/4r/ja/zp4rjad7h4w67oozlqjhyo7fp1u.png"><br><br> 在此级别上，不可能根据得出对应用程序重要的结论和关键决策的数据来使用数据，因为这些结论可能与现实相去甚远。 <br> 例如，此级别可用于近似计算。 结果<i>COUNT（*）</i>或<i>MAX（*）</i>可以在某些非严格报告中使用。 <br> 另一个示例是调试模式。 在事务期间，您想查看数据库发生了什么。 <br><br><h3> 阅读已提交 </h3><br> 对于此级别，并发执行的事务仅看到来自其他事务的已提交更改。 因此，该水平提供了防止<b>脏读的</b>保护。 <br><br> 步骤1和步骤2与前面的示例相似。 <br><br> 步骤3.我们还对帐户表（T1）执行3个简单的操作，并在两个事务中对这些表进行完整选择。 <br><br><img src="https://habrastorage.org/webt/5q/v6/oe/5qv6oevjrhcoe2ubmwxvmu5wapy.png"><br><br> 我们将看到在T2中不存在<b>脏读</b>现象。 <br><br> 步骤4.我们修复T1中的更改​​，并检查T2现在看到的内容。 <br><br><img src="https://habrastorage.org/webt/mx/8f/i0/mx8fi0low9lqjenhnl2gx0sg6aq.png"><br><br> 现在，T2可以看到T1所做的一切。 当我们看到更新和删除的行（UPDATE，DELETE）时，这就是所谓的<b>非重复读取</b>现象；当我们看到添加的记录（INSERT）时，这就是<b>读取幻像</b>的现象。 <br><br><h3> 可重复读 </h3><br> 防止<b>非重复阅读</b>现象的水平。 即 我们看不到另一笔交易与另一笔交易中已更改和删除的记录。 但是我们仍然看到来自另一笔交易的插入记录。  <b>阅读幻影</b>不会走开。 <br><br> 再次重复步骤1和步骤2。 <br><br> 步骤3.在T1中，我们执行INSERT，UPDATE和DELETE查询。 之后，在T2中，我们尝试更新在T1中更新的同一行。 <br><br><img src="https://habrastorage.org/webt/ja/w5/oj/jaw5ojjrb1m7bi-9lhbifndcvye.png"><br><br> 我们得到了锁定：T2将等待，直到T1提交更改或回滚。 <br><br> 步骤4.修正T1所做的更改。 并再次从T2的帐户表中读取数据。 <br><br><img src="https://habrastorage.org/webt/75/xu/jj/75xujjftplz_b3r8mhjsqcla7zc.png"><br><br> 如您所见，未观察到<b>非重复阅读</b>和<b>幻象阅读的</b>现象。 默认情况下， <b>可重复读取如何</b>使我们仅阻止<b>非重复读取</b>现象？ <br><br> 实际上，MySQL缺乏为<b>可重复读取</b>级别<b>读取幻像</b>的效果。 在PostgreSQL中，他们也不再使用此级别了。 尽管在此级别的经典表示中，我们必须观察到这种效果。 <br><br> 一个小的抽象示例是生成礼券（代码）及其使用的服务。 例如，攻击者为自己生成了一个证书代码并尝试将其激活，试图连续发送多个请求以激活优惠券。 在这种情况下，我们将使用相同的优惠券开始几个同时执行的交易。 在某些情况下，优惠券可能会发生两次甚至三次激活（用户将获得2倍/ 3倍的奖励）。 使用<b>可重复读取时，</b>在这种情况下，将发生锁定并且激活将发生一次，并且在前两个级别中，可以进行多次激活。 通过使用<i>SELECT FOR UPDATE</i>查询也可以解决类似的问题，该查询也将阻止更新的记录（优惠券）。 <br><br><h3> 可序列化 </h3><br> 交易行为的水平，就好像没有其他事物存在时，彼此之间没有影响。 在经典表示中，该级别消除了<b>阅读幻影</b>的影响。 <br><br>  <b>步骤1.</b>开始交易。 <br><br>  <b>第2步</b> 。T2我们读取帐户表，然后T1我们尝试更新T2读取的数据。 <br><br><img src="https://habrastorage.org/webt/ll/kv/yw/llkvywaijh7l7uyfsnqwy1a6ivm.png"><br><br> 我们被锁住了：我们不能更改在另一个事务中读取的事务中的数据。 <br><br>  <b>步骤3.</b> INSERT和DELETE都将我们引向T1中的锁。 <br><br><img src="https://habrastorage.org/webt/ia/kh/lj/iakhljpnwnxyame2qgxmqrhcyyu.png"><br><br> 在T2完成工作之前，我们将无法使用它读取的数据。 我们获得最大的数据一致性，不会记录额外的数据。 这样做的代价是由于频繁的锁定而导致交易速度变慢，因此，如果应用程序体系结构不佳，这可能会给您带来麻烦。 <br><br><h3> 结论 </h3><br> 在大多数应用程序中，隔离级别很少更改，并且使用默认值（例如，在MySQL中，它是<b>可重复的read</b> ，在PostgreSQL中，它是<b>read commit</b> ）。 <br><br> 但是周期性地存在一些问题，其中在高数据一致性或事务处理速度之间找到更好的平衡可以帮助解决某些应用程序问题。 </div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/zh-CN469415/">https://habr.com/ru/post/zh-CN469415/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../zh-CN469405/index.html">深度学习现已使用Java</a></li>
<li><a href="../zh-CN469407/index.html">ARIES PLC110 [M02] -MS4，HMI，OPC和SCADA，或一个人需要多少甘菊茶。 第一部分</a></li>
<li><a href="../zh-CN469409/index.html">使用Performance Analyzer进行Linux分析</a></li>
<li><a href="../zh-CN469411/index.html">RE：痛苦和眼泪在Svelte 3</a></li>
<li><a href="../zh-CN469413/index.html">上周第382期（2019年9月22日至29日）的前端世界摘要</a></li>
<li><a href="../zh-CN469417/index.html">分布是或否？ 采访六个月找不到开发人员的人</a></li>
<li><a href="../zh-CN469421/index.html">你好自闭症患者</a></li>
<li><a href="../zh-CN469423/index.html">霍利瓦尔 吕内特的历史。 第2部分。反文化：pAdonki，大麻和克里姆林宫</a></li>
<li><a href="../zh-CN469425/index.html">德米特里·马特斯科维奇（Dmitry Matskevich），德布赖恩（Dbrain）（第2部分）：关于神经生物学，内部自由，“廉价多巴胺”和直觉</a></li>
<li><a href="../zh-CN469427/index.html">木制玩具，第四部分-1990年</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>