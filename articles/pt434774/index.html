<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶ä üíü ü§≥üèø 5 li√ß√µes que aprendemos escrevendo mais de 300.000 linhas de c√≥digo de infraestrutura üë©üèø‚Äçüé® üë¥üèæ üéâ</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Uma breve aula sobre desenvolvimento de c√≥digo de infraestrutura 





 Em outubro deste ano, fiz uma apresenta√ß√£o na confer√™ncia HashiConf 2018, onde...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>5 li√ß√µes que aprendemos escrevendo mais de 300.000 linhas de c√≥digo de infraestrutura</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/company/southbridge/blog/434774/"><h3 id="kratkiy-master-klass-po-razrabotke-infrastrukturnogo-koda">  Uma breve aula sobre desenvolvimento de c√≥digo de infraestrutura </h3><br><p><img src="https://habrastorage.org/getpro/habr/post_images/1f2/0b9/17f/1f20b917f7f598d845324b4b8ce18bbf.jpg" alt="imagem"></p><br><p>  Em outubro deste ano, fiz uma apresenta√ß√£o na confer√™ncia HashiConf 2018, onde conversamos sobre as 5 principais li√ß√µes que eu e meus colegas da Gruntwork aprendemos no processo de cria√ß√£o e manuten√ß√£o de uma <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">biblioteca de mais de 300.000 linhas de c√≥digo de infraestrutura</a> usadas por centenas de empresas em sistemas de produ√ß√£o.  Nesta publica√ß√£o, compartilharei v√≠deos e slides da apresenta√ß√£o, bem como uma vers√£o resumida da descri√ß√£o das 5 li√ß√µes principais. </p><br><h3 id="video-i-slaydy">  V√≠deos e slides </h3><br><iframe width="560" height="315" src="https://www.youtube.com/embed/RTEgE2lcyk4" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3 id="vstuplenie-devops-seychas--v-kamennom-veke">  Introdu√ß√£o: DevOps Agora na Idade da Pedra </h3><br><p>  Apesar do setor estar cheio de palavras progressistas da moda: Kubernetes, microsservi√ßos, redes de servi√ßo, infraestrutura imut√°vel, big data, data lake, etc., a realidade √© que, quando voc√™ est√° imerso na cria√ß√£o da infraestrutura, n√£o sente t√£o elegante e progressivo. </p><a name="habracut"></a><br><p>  Pessoalmente, o DevOps me lembra mais disso: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/299/9f7/51e/2999f751eb309e5f9ee967deb56fb907.jpg" alt="imagem"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/2a0/ddc/a9d/2a0ddca9d9f1ee2f83e1130e84788fb2.jpg" alt="imagem"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/9d2/69e/1b4/9d269e1b44d8bd7bc65cc35accd2531f.jpg" alt="imagem"></p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/dad/458/a97/dad458a97d189cfad6ec939a535f1722.jpg" alt="imagem"></p><br><p>  Criar uma infraestrutura no n√≠vel da produ√ß√£o √© dif√≠cil.  Isso √© estresse real.  E come muito tempo.  Muito tempo. </p><br><p>  Mostra quanto tempo levar√° para implementar o pr√≥ximo projeto de infraestrutura.  Contamos com dados emp√≠ricos que coletamos no decorrer do trabalho com centenas de empresas diferentes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e1b/84c/72c/e1b84c72c3dfa22ddbe8653f94e38fa9.png" alt="imagem"></p><br><h3 id="urok-1-cheklist-dlya-infrastruktury-proizvodstvennogo-urovnya">  Li√ß√£o 1. Lista de verifica√ß√£o para infraestrutura de manufatura </h3><br><p>  Os projetos do DevOps sempre demoram mais do que o esperado.  Sempre.  Porque <br>  A primeira raz√£o √© um <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">corte de cabelo de iaque</a> .  Abaixo est√° uma ilustra√ß√£o v√≠vida desse fen√¥meno (este √© um trecho da s√©rie "Malcolm in the Spotlight") </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/https://translate" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  A segunda raz√£o √© que o processo de cria√ß√£o de uma infraestrutura em n√≠vel de produ√ß√£o (por exemplo, a infraestrutura na qual voc√™ colocaria sua empresa) consiste em milhares de pequenas pe√ßas.  A grande maioria dos desenvolvedores n√£o tem conhecimento desses detalhes; portanto, ao avaliar um projeto, geralmente voc√™ esquece muitas tarefas cr√≠ticas (e demoradas). <br>  Para evitar isso, sempre que come√ßar a trabalhar em uma nova se√ß√£o da infraestrutura, use a seguinte lista de verifica√ß√£o: </p><br><p> <a href=""><img src="https://habrastorage.org/webt/o2/xu/wu/o2xuwumkfwrh9epcydpmk-b76ru.jpeg"></a> </p><br><p>  Nem todos os elementos da lista ser√£o necess√°rios para cada parte individual da infraestrutura, mas voc√™ deve documentar consciente e explicitamente quais elementos implementou e quais decidiu ignorar e por qu√™. </p><br><h3 id="urok-2-nabor-instrumentov">  Li√ß√£o 2. Caixa de Ferramentas </h3><br><p>  Listamos as principais ferramentas que usamos na Gruntwork para criar e gerenciar infraestrutura (a partir de 2018): </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/b9c/656/c19/b9c656c197abcd9892102cc947e525fa.png" alt="imagem"></p><br><ul><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Terraform</a> .  Usamos o Terraform para implantar toda a infraestrutura subjacente, incluindo a rede, subsistemas de balanceamento de carga, bancos de dados, ferramentas de gerenciamento de usu√°rios e permiss√µes e todos os nossos servidores. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Packer</a> .  Usamos o Packer para configurar e criar imagens de m√°quinas virtuais executadas em nossos servidores. </li><li>  <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Docker</a> .  Alguns de nossos servidores formam clusters nos quais executamos aplicativos como cont√™ineres do Docker.  Para clusters do Docker, usamos principalmente as seguintes ferramentas: <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Kubernetes</a> , <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">ECS</a> e <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Fargate</a> . </li></ul><br><p>  Todas essas ferramentas s√£o √∫teis, mas esse n√£o √© o ponto.  Voc√™ precisa entender que algumas ferramentas n√£o s√£o suficientes.  Voc√™ tamb√©m deve mudar o comportamento da equipe. </p><br><p>  Em particular, mesmo as melhores ferramentas do mundo n√£o ajudar√£o sua equipe se elas n√£o quiserem us√°-las ou se n√£o tiverem tempo suficiente para aprender a us√°-las.  Portanto, a principal conclus√£o √© que o uso da "infraestrutura como c√≥digo" √© um investimento, ou seja, certos custos iniciais ser√£o exigidos de voc√™.  Se voc√™ investir com sabedoria, receber√° grandes dividendos a longo prazo. </p><br><h3 id="urok-3-bolshie-moduli--eto-zlo">  Li√ß√£o 3. Grandes m√≥dulos s√£o ruins </h3><br><p>  Os rec√©m-chegados √† aplica√ß√£o da ‚Äúinfraestrutura como c√≥digo‚Äù geralmente definem toda a infraestrutura para todos os seus ambientes (ambiente de desenvolvimento, ambiente intermedi√°rio, ambiente de produ√ß√£o etc.) em um √∫nico arquivo ou em um conjunto de arquivos implantados como um todo.  Em v√£o. </p><br><p>  Aqui est√£o apenas algumas das desvantagens dessa abordagem: </p><br><ul><li> <strong>Baixa velocidade</strong>  Se toda a infraestrutura estiver definida em um √∫nico local, a execu√ß√£o de qualquer comando levar√° muito tempo.  Enfrentamos situa√ß√µes nas empresas quando a equipe do <code>terraform plan</code> levou de 5 a 6 minutos para ser conclu√≠da! </li><li>  <strong>Baixa seguran√ßa</strong> .  Se voc√™ gerencia toda a infraestrutura juntos, para alterar algo, voc√™ precisa de permiss√µes para acessar tudo.  Ou seja, quase todo usu√°rio deve ser um administrador, e isso tamb√©m √© muito inconveniente. </li><li>  <strong>Riscos elevados</strong> .  Se voc√™ colocar todos os seus ovos em uma cesta, crie uma situa√ß√£o em que um erro local possa atrapalhar a opera√ß√£o de toda a infraestrutura.  Por exemplo, quando voc√™ faz pequenas altera√ß√µes em um aplicativo externo no ambiente de desenvolvimento, um √∫nico erro de digita√ß√£o ou um comando incorreto pode levar √† exclus√£o do banco de dados de produ√ß√£o. </li><li>  <strong>Dif√≠cil de entender</strong> .  Quanto mais c√≥digo √© colocado em um s√≥ lugar, mais dif√≠cil √© para uma pessoa entender tudo isso.  E quando tudo isso estiver conectado, partes incompreens√≠veis far√£o uma piada cruel com voc√™. </li><li>  <strong>Dif√≠cil de testar</strong> .  Testar o c√≥digo da infraestrutura √© dif√≠cil;  testar grandes quantidades de c√≥digo de infraestrutura √© quase imposs√≠vel.  Voltaremos a isso mais tarde. </li><li>  <strong>Dif√≠cil de analisar</strong> .  A sa√≠da de comandos como o plano de terraform se torna in√∫til, pois ningu√©m se incomoda em visualizar milhares de linhas.  Al√©m disso, a an√°lise de c√≥digo se torna in√∫til. </li></ul><br><p>  Em resumo, voc√™ deve criar seu c√≥digo a partir de m√≥dulos compostos pequenos, independentes e reutiliz√°veis.  Isso n√£o √© novidade nem descoberta.  Voc√™ j√° ouviu isso milhares de vezes, embora em situa√ß√µes ligeiramente diferentes: </p><br><blockquote>  ‚ÄúFa√ßa uma coisa e fa√ßa bem‚Äù - filosofia Unix. <br>  ‚ÄúA primeira regra das fun√ß√µes √© que elas devem ser pequenas.  A segunda regra afirma que as fun√ß√µes devem ser ainda menores ".  - "C√≥digo limpo" </blockquote><br><h3 id="urok-4-infrastrukturnyy-kod-bez-avtomaticheskih-testov-neispraven">  Li√ß√£o 4. O c√≥digo da infraestrutura sem testes autom√°ticos est√° com defeito </h3><br><p>  Se o seu c√≥digo de infraestrutura n√£o tiver testes automatizados, ele n√£o funcionar√° corretamente.  Voc√™ apenas n√£o sabe ainda.  Mas testar o c√≥digo de infraestrutura √© dif√≠cil.  Voc√™ n√£o possui um "host local" (por exemplo, n√£o pode implantar a nuvem privada virtual da AWS VPC em seu laptop), nem "testes de unidade" reais (por exemplo, n√£o √© poss√≠vel isolar o c√≥digo Terraform do mundo "externo", pois √© como vezes e foi projetado para se comunicar com o mundo exterior). </p><br><p>  Portanto, para testar corretamente o c√≥digo de infraestrutura, voc√™ geralmente precisa implant√°-lo em um ambiente real, executar uma infraestrutura real, verificar se o c√≥digo est√° funcionando e quebr√°-lo (para obter uma descri√ß√£o desse estilo de teste: consulte Terratest, esta √© uma biblioteca de c√≥digo aberto que inclui ferramentas para testar o c√≥digo Terraform , Packer e Docker, trabalhando com APIs da AWS, GCP e Kubernetes, executando comandos de shell localmente e em servidores remotos via SSH, al√©m de muitos outros recursos).  Portanto, ao testar a infraestrutura, voc√™ precisa redefinir ligeiramente as condi√ß√µes: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/e38/f8a/24d/e38f8a24dedcc2de2eec19291f885ccd.png" alt="imagem"></p><br><p>  <strong>Os testes de unidade</strong> implantam e testam um ou mais m√≥dulos de infraestrutura intimamente relacionados do mesmo tipo (por exemplo, m√≥dulos para um √∫nico banco de dados). </p><br><p>  <strong>Os testes de integra√ß√£o</strong> implantam e testam v√°rios m√≥dulos de infraestrutura de v√°rios tipos para verificar se eles funcionam juntos (por exemplo, m√≥dulos de banco de dados e m√≥dulos de servi√ßo da web). </p><br><p>  <strong>Os testes de ponta a ponta</strong> (e2e) implantam e testam toda a arquitetura. <br>  Observe que o diagrama √© uma pir√¢mide: temos muitos testes de unidade, menos testes de integra√ß√£o e muito poucos testes e2e.  Porque  Depende da dura√ß√£o de cada tipo de teste: </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/071/040/730/07104073030dd617e05ad563d698e7b5.png" alt="imagem"></p><br><p>  Os testes de infraestrutura levam muito tempo, especialmente nos n√≠veis superiores da pir√¢mide, e, √© claro, voc√™ deseja encontrar e corrigir o m√°ximo de erros poss√≠vel na parte inferior.  Para fazer isso, voc√™ precisa: </p><br><ol><li>  Crie m√≥dulos aut√¥nomos pequenos e simples (consulte Li√ß√£o 3) e escreva v√°rios testes de unidade para eles - verifique se eles funcionam corretamente. </li><li>  Combine esses blocos pequenos, simples e comprovados para criar uma infraestrutura mais sofisticada que voc√™ teste com menos integra√ß√£o e testes E2E. </li></ol><br><h3 id="urok-5-process-reliza">  Li√ß√£o 5. Processo de Libera√ß√£o </h3><br><p>  Para resumir todas as op√ß√µes acima.  Veja como agora voc√™ criar√° e gerenciar√° sua infraestrutura: </p><br><ul><li>  Verifique a lista de verifica√ß√£o para obter <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">a infraestrutura de n√≠vel de produ√ß√£o</a> e verifique se est√° trabalhando na dire√ß√£o certa. </li><li>  Defina sua ‚Äúinfraestrutura como c√≥digo‚Äù com ferramentas como Terraform, Packer e Docker.  Verifique se sua equipe tem tempo suficiente para <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">aprender</a> essas ferramentas (consulte <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Recursos do DevOps</a> ). </li><li>  Crie c√≥digo a partir de m√≥dulos compostos pequenos e independentes (ou use m√≥dulos padr√£o da <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">infraestrutura como biblioteca de c√≥digos</a> ). </li><li>  Prepare testes automatizados para seus m√≥dulos com o <a href="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=pt&amp;u=">Terratest</a> . </li><li>  Conclua a solicita√ß√£o para incluir suas altera√ß√µes para revisar seu c√≥digo. </li><li>  Libere a nova vers√£o do c√≥digo. </li><li>  Copie a nova vers√£o do c√≥digo de um ambiente para outro. </li></ul><br><p><img src="https://habrastorage.org/getpro/habr/post_images/43f/57b/1b6/43f57b1b6721ef8dd14eb583ffca2d66.png" alt="imagem"></p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt434774/">https://habr.com/ru/post/pt434774/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt434756/index.html">O futuro do Kubernetes √© com m√°quinas virtuais</a></li>
<li><a href="../pt434758/index.html">Guia do moderador do Facebook: mais de 1.400 p√°ginas de slides conflitantes</a></li>
<li><a href="../pt434760/index.html">Resumo de not√≠cias do PostgreSQL. Edi√ß√£o de ano novo (abreviada) n√∫mero 13</a></li>
<li><a href="../pt434762/index.html">Notas de um fitoqu√≠mico. Banana verde, ou lembre-se de alimentar a microbiota</a></li>
<li><a href="../pt434770/index.html">Energia renov√°vel: palavras e seu significado</a></li>
<li><a href="../pt434776/index.html">VK calcula sua localiza√ß√£o por IP</a></li>
<li><a href="../pt434780/index.html">Robotiza√ß√£o pode levar √† ditadura</a></li>
<li><a href="../pt434782/index.html">Como escolhi um sistema de CRM</a></li>
<li><a href="../pt434784/index.html">Como priorizar o desenvolvimento. Experi√™ncia na implementa√ß√£o de GIST + ICE no Yandex.Market</a></li>
<li><a href="../pt434786/index.html">Sete plataformas autom√°ticas gratuitas de solu√ß√£o de problemas para nivelar as habilidades de programa√ß√£o</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>