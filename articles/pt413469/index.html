<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ü¶í üå¥ üò∫ Um teste de mem√≥ria matando laptops √© quase uma hist√≥ria de detetive üêè ü§±üèΩ üéí</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="(UPD: al√©m dos esquemas, uma foto do quadro √© adicionada) 
 (UPD2: informa√ß√µes do canal IRC libreboot) 


- O RINKAN possui uma prote√ß√£o atual de 55mA...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Um teste de mem√≥ria matando laptops √© quase uma hist√≥ria de detetive</h1><div class="post__body post__body_full"><div class="post__text post__text-html post__text_v1" id="post-content-body" data-io-article-url="https://habr.com/ru/post/413469/"><p>  <strong>(UPD: al√©m dos esquemas, uma foto do quadro √© adicionada)</strong> <br>  <strong>(UPD2: informa√ß√µes do canal IRC libreboot)</strong> </p><br><ul><li>  O RINKAN possui uma prote√ß√£o atual de 55mA, a funcionalidade pode ser encontrada na descri√ß√£o no TB62501F. </li><li>  O PMH7 √© um conjunto de portas ("a mesma coisa que o FPGA acabou de ser programado com at√© 3 camadas de metal, como o maskrom"), para a Toshiba foi chamado TC-200G </li><li>  O PMH7 √© conectado n√£o apenas ao EC, mas tamb√©m ao ICH atrav√©s do barramento LPC e, do ponto de vista do host, parece um extensor GPIO. </li><li>  Eles t√™m certeza de que os pinos PMH n√£o utilizados realmente ficam no ar, e √© prov√°vel que um fechamento de pinos grave apenas as sa√≠das PMH, mas n√£o o LDO </li><li>  Eles sugerem uma falha espont√¢nea de dois RINKANs por motivos independentes um do outro (possivelmente provocados pelo aquecimento da placa-m√£e durante o teste de mem√≥ria) </li><li>  Eles recomendam mudar o RINKAN para o mesmo chip da ROHM: BD4175KVT-BD4176KVT-BD41760KVT, custa cerca de US $ 2 </li><li>  Concordamos que voc√™ precisa realizar uma experi√™ncia para executar o teste de memtest com um limite atual </li></ul><br><p>  Recentemente, tivemos uma hist√≥ria comovente - dois laptops Lenovo T500 morreram em uma manh√£.  Um teria morrido - ningu√©m sequer come√ßou a entender.  Mas duas em uma manh√£ - isso √© demais!  Al√©m disso, pelo menos um deles (e isso √© confirmado por tr√™s usu√°rios!) Trabalhou normalmente at√© o √∫ltimo minuto, foi desligado pelo bot√£o liga / desliga, transferido 100 metros para a sala de conversa√ß√£o e ... n√£o ligou. </p><br><p>  Naturalmente, em primeiro lugar, todos os m√©todos de ressuscita√ß√£o artesanal foram testados: substitua a bateria, substitua o adaptador de energia ... Remova a bateria e desconecte a energia, redefina o CMOS e assim por diante ... Resultado?  Exatamente zero - os laptops continuaram em estado de alerta. </p><br><p>  Eles come√ßaram a reconstruir a imagem dos eventos, a fim de encontrar pelo menos alguma pista.  O resultado foi o seguinte: </p><a name="habracut"></a><br><ul><li>  No D-1, a mem√≥ria foi adicionada aos dois laptops.  Depois de substituir as ripas de mem√≥ria, as duas ligaram e funcionaram corretamente at√© a noite </li><li>  Na noite do dia D, o memtest foi lan√ßado nos dois computadores (mais precisamente, o memtest86 + 5.01-3 da distribui√ß√£o Debian) </li><li>  De manh√£, no dia "D", os dois computadores foram desligados pelo bot√£o liga / desliga e n√£o ligaram </li><li>  Al√©m disso, eles foram brevemente conectados via conector VGA ao mesmo projetor e ao mesmo adaptador de energia na sala </li></ul><br><p>  Obviamente, a morte de laptops deve estar relacionada a uma das tr√™s coisas: um adaptador de energia, um projetor ou um teste de mem√≥ria.  Mas com o que exatamente? </p><br><p>  Primeiro de tudo, verificamos o projetor.  Eles n√£o encontraram o crime, mas tamb√©m descobriram que naquele dia (mais tarde) outros laptops estavam conectados a ele, que permaneciam vivos e bem.  Em segundo lugar, verificamos o adaptador de energia - ele parecia subestimar a tens√£o e estava em quarentena. </p><br><p>  Os laptops foram entregues ao servi√ßo, que os devolveu com o seguinte resultado: "falha da placa-m√£e, faltam pe√ßas de reposi√ß√£o!".  Eu mesmo tive que abrir a carca√ßa (o benef√≠cio na rede pode ser encontrado nos esquemas e nos manuais de servi√ßo da antiga s√©rie Thinkpad). </p><br><p>  Nesse ponto, todos come√ßaram (por exce√ß√£o) a suspeitar da morte de laptops memtest.  Mas n√£o era completamente √≥bvio - como exatamente?  No final, havia a chance de a morte de laptops ser uma rara, desagrad√°vel, mas ainda uma coincid√™ncia.  Mas n√£o!  Ou sim ... Em geral, ainda n√£o sabemos exatamente. </p><br><p>  Aqui voc√™ deve fazer uma digress√£o sobre a constru√ß√£o do sistema de gerenciamento de energia em faia IBM / Lenovo (pelo menos as s√©ries mais antigas).  Em dispositivos mais simples, o gerenciamento de energia √© concedido ao processador / chipset ou a um controlador especializado da placa-m√£e (System Controller, aka Embedded controller).  Em termos relativos, essa coisa √© respons√°vel pelas fun√ß√µes reflexas e da coluna vertebral de um laptop: alternar fontes de corrente, energia da bateria, identifica√ß√£o da bateria / bloqueio do fornecedor e similares.  Mas n√£o na IBM / Lenovo! </p><br><p>  Os engenheiros da IBM, aparentemente, pensaram que o firmware da EC poderia conter erros ou o pr√≥prio controlador congelaria subitamente.  Obviamente, a CE tem seu pr√≥prio c√£o de guarda, mas tamb√©m n√£o √© uma panac√©ia.  Portanto, a responsabilidade da CE √© apenas gerar sinais de controle de pot√™ncia de alto n√≠vel.  As teclas de for√ßa destrancam e bloqueiam dois microcircuitos especializados (e sem pensar, mas comparando os desejos da CE com as leituras dos sensores de temperatura, a presen√ßa da tens√£o necess√°ria para a pr√≥xima etapa nos pneus, etc.).  Esses chips s√£o: RINKAN (descriptografia desconhecida) e PMH_7 (Power Management Hub rev7) </p><br><div class="spoiler">  <b class="spoiler_title">RINKAN no interior</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/nu/bg/ox/nubgoxpbrihy0iguhtguefcnu44.png" alt="imagem"></p></div></div><br><p>  Observe que o RINKAN n√£o possui sa√≠das para os barramentos da CPU - em princ√≠pio, √© inating√≠vel para o processador.  Uma das fun√ß√µes importantes (e n√£o √≥bvias) do RINKAN √© a gera√ß√£o de uma tens√£o est√°vel de 3,3v para o barramento VCC3SW (vamos cham√°-lo de barramento de partida).  Como n√£o h√° bobinas nas proximidades - pode-se supor que esse regulador seja constru√≠do em um esquema linear simples.  Ou seja, em algum lugar l√° dentro, fica um transistor com uma cinta e, com sua resist√™ncia ativa, planta energia, deixando apenas 3,3v.  Esse regulador √© alimentado pela perna VREGIN20, na qual todas as fontes de energia do laptop (esta√ß√£o de acoplamento, adaptador de energia, bateria principal e bateria ultrabay) s√£o conectadas por diodos.  Ou seja, sempre funciona em geral (portanto, de baixa pot√™ncia - voc√™ precisa de uma corrente muito pequena do seu pr√≥prio consumo!) </p><br><div class="spoiler">  <b class="spoiler_title">PMH_7 no ambiente de trabalho</b> <div class="spoiler_text"><p><img src="https://habrastorage.org/webt/ne/rz/03/nerz03znxcvwq7q6fvmhm7ig5qm.png" alt="imagem"></p></div></div><br><p>  PMH √© um chip mais inteligente.  No m√≠nimo, ela tem uma conex√£o com a CE atrav√©s do barramento SPI.  Al√©m disso, ele liga ou desliga um monte de tens√µes e sinais de rel√≥gio na placa-m√£e do laptop.  Ambos os chips s√£o feitos sob medida, sem folha de dados.  Como a Lenovo / IBM usa os mesmos chips personalizados para diferentes linhas de produtos, algumas das pernas de PMH n√£o s√£o usadas no T500.  No entanto, era improv√°vel que ficassem no ar.  As recomenda√ß√µes t√≠picas sugerem puxar cabos n√£o utilizados, tanto para o circuito de energia quanto para o terra.  Lembre-se disso. </p><br><p>  Apesar da falta de documenta√ß√£o, a equipe do projeto Coreboot (comparando os circuitos de notebook das s√©ries T60, T40 e mais antigas - onde as fun√ß√µes RINKAN / PMH ainda estavam divididas entre os microcircuitos de menor grau de integra√ß√£o) acumulou algo interessante.  O PMH est√° dispon√≠vel no espa√ßo de endere√ßo da CPU. <del>  N√£o diretamente, √© claro, mas atrav√©s da CE - mas ainda dispon√≠vel! </del>  <strong>UPD: conectado ao ICH atrav√©s do barramento LPC (baixa contagem de pinos - an√°logo do ISA).</strong>  Para elevar ou abaixar a perna PMH, eles usam a seguinte sequ√™ncia de opera√ß√µes ( <a href="">pmh7.c</a> ): </p><br><pre><code class="cpp hljs">outb(reg, EC_LENOVO_PMH7_ADDR); val = inb(EC_LENOVO_PMH7_DATA); outb(reg, EC_LENOVO_PMH7_ADDR); outb(val | (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; bit), EC_LENOVO_PMH7_DATA);</code> </pre> <br><p>  Ou seja, primeiro escrevemos o c√≥digo de registro PMH no registro EC (mapeado para o espa√ßo de endere√ßo da CPU) e, em seguida, podemos ler ou escrever seu conte√∫do.  Por exemplo, queremos ativar a luz de fundo (p√© de 55 PMH): escrevemos no registrador 0x55 bit 2 - tudo √© simples. </p><br><p>  <strong>UPD: colegas do projeto Libreboot consideram improv√°vel o cen√°rio de curto-circuito descrito atrav√©s do PMH - a prote√ß√£o atual em RINKAN deveria ter trabalhado a 55mA</strong> </p><br><p>  Infelizmente, o memtest faz aproximadamente a mesma coisa - l√™ e grava valores diferentes em diferentes √°reas da mem√≥ria.  Teoricamente, o BIOS deve descrever as √°reas de mem√≥ria reservadas para dispositivos de E / S.  E o memtest n√£o deve escrever nada l√° em baixo - mas ... escreveu!  E, aparentemente, em algum momento, ele levantou ou abaixou a perna sem sucesso da PMH.  Por conseguinte, atrav√©s do transistor de p√© de sa√≠da PMH, o barramento de for√ßa VCC3SW foi curto-circuito ao terra ... </p><br><p>  O que aconteceu depois?  Ent√£o RINKAN come√ßou a se aquecer.  Como a corrente estava crescendo, o PMH no modo chave a arrastou sem problemas, e o transistor semi-aberto no LDO RINKAN estava piorando.  Mas, externamente, isso n√£o se manifestou de forma alguma: em um laptop ligado, ningu√©m come de uma fonte de baixa pot√™ncia de 3,3v, e a energia √© fornecida por um DC / DC poderoso e especial que fornece os principais barramentos de 3,3 e 5 volts, respectivamente. </p><br><p>  Bem, quando o bot√£o liga / desliga foi pressionado, os barramentos principais foram desenergizados.  N√£o havia mais energia no barramento de partida de 3.3v!  E o laptop virou <del>  ab√≥bora </del>  tijolo. </p><br><p>  <strong>UPD: teoria alternativa (omz + libreboot)</strong> </p><br><p>  Nos centros de servi√ßos, a tend√™ncia de colis√£o do RINKAN √© conhecida.  Os colegas do Libreboot argumentam ainda que isso √© especialmente verdade para os controladores da Toshiba (e o ROHM ser√° melhor).  Consequentemente, o memtest era inocente por todo o caminho e ocorreu uma falha quase simult√¢nea de dois laptops: </p><br><ul><li><p>  Ou por raz√µes independentes umas das outras (possivelmente provocadas pelo aquecimento da placa-m√£e sob um longo teste) </p><br></li><li>  Ou um mau funcionamento (ru√≠do) na sa√≠da de energia do adaptador, ao qual (embora por pouco tempo) os dois laptops foram conectados. </li></ul><br><p>  Resultados de diagn√≥stico: </p><br><p>  O primeiro laptop √© uma placa gr√°fica dual COR5SOPV3.  No barramento VCC3SW em vez de 3,3, apenas 1,2 volts.  A resist√™ncia √† terra √© de cerca de 400 ohms.  Soldou suavemente e aumentou a sa√≠da do conversor de tens√£o RINKAN.  A resist√™ncia do barramento aumentou imediatamente para centenas de quilo-ohms.  Eles aplicaram tens√£o de 3.3V de uma fonte externa - a faia ganhou vida. </p><br><div class="spoiler">  <b class="spoiler_title">Conselho em processo de reparo</b> <div class="spoiler_text"><p>  O chip com um adesivo branco √© um controlador incorporado, no meio com fios - RINKAN, o √∫ltimo sem adesivos - PMH. </p><br><p><img src="https://habrastorage.org/webt/1e/pl/j8/1eplj83_3g7qj5diwndcnm4hawq.jpeg" alt="imagem"></p></div></div><br><p>  Como resultado, selecionamos um LDO externo de baixa pot√™ncia (LP2930-3.3), que alimenta o barramento de partida em vez de RINKAN.  De acordo com os resultados do teste, verificou-se que a morte cl√≠nica adiada deixou uma marca na natureza do dispositivo - o laptop se recusa a ligar se a bateria estiver inserida, mas o adaptador n√£o estiver inserido.  Se voc√™ deseja lig√°-lo - remova a bateria, ligue o adaptador de energia e, depois disso, a bateria poder√° ser inserida novamente.  Todas as outras fun√ß√µes (carga, dura√ß√£o da bateria, suspens√£o, etc.) n√£o s√£o problema e √© a √∫nica maneira de ativar.  Eles n√£o se incomodaram - eles decidiram a quest√£o administrativamente: use suspens√£o ou reinicializa√ß√£o em vez de desligar.  O primeiro sofredor teve sorte! </p><br><p>  E a segunda - n√£o ... Existe uma placa C5ISOVP com gr√°ficos integrados - n√£o h√° voltagem no barramento e a resist√™ncia ao terra √© dezenas de ohms.  Depois de arrancar a perna, o VCC3SW n√£o melhorou - a mesma baixa resist√™ncia de acordo com o VREGIN20.  Eles tamb√©m o retiraram, ligaram a energia externa ao barramento de partida - viram 3,3 e 5 volts no principal.  No entanto, apesar do in√≠cio encorajador, os sinais de economia de energia n√£o apareceram na sa√≠da PMH / RINKAN e o sistema n√£o p√¥de iniciar.  Aparentemente, a l√≥gica interna dos microcircuitos est√° danificada e isso n√£o √© tratado ... </p><br><p><del>  √â muito prov√°vel que o memtest possa matar laptops dessa maneira, da s√©rie T6x √† s√©rie T420 / 520, inclusive.  A partir do T430 / 530, o modo de comunica√ß√£o com a CE foi alterado e a grava√ß√£o nos registros PMH √© imposs√≠vel em princ√≠pio.  Talvez apenas determinadas vers√µes de firmware do BIOS ou EC sejam afetadas.  Um relat√≥rio de bug foi escrito para os mantenedores de pacotes debian, talvez eles possam encontrar algo com o upstream ... </del></p><br><p>  O motivo exato da falha dos dois laptops ap√≥s o in√≠cio do teste √© desconhecido.  Um experimento que pode determinar se o memtest causa um consumo de corrente fora do design do barramento de for√ßa inicial est√° planejado, mas a data ainda n√£o foi determinada.  Relataremos os resultados adicionalmente. </p><br><p>  Ao iniciar o memtest nos laptops da s√©rie Lenovo T6x, inclusive o T420 / 520, voc√™ deve considerar os riscos e benef√≠cios potenciais desse evento.  Caso voc√™ execute o teste e ele n√£o causou (ou fez) o laptop ficar empedrado ou desligado - por favor, escreva um coment√°rio no coment√°rio indicando o modelo do laptop e o tempo de execu√ß√£o do teste. </p><br><p>  Isso √© tudo - boa sorte! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/pt413469/">https://habr.com/ru/post/pt413469/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../pt413459/index.html">O talento de um recrutador de TI - como os criadores diferem dos artes√£os?</a></li>
<li><a href="../pt413461/index.html">O ReactOS se tornou auto-suficiente no ano de seu 21¬∫ anivers√°rio</a></li>
<li><a href="../pt413463/index.html">API REST do Magento 2 usando um m√≥dulo simples como exemplo</a></li>
<li><a href="../pt413465/index.html">AMD anuncia Threadripper 2 de 32 n√∫cleos</a></li>
<li><a href="../pt413467/index.html">Backup de dados r√°pido e confi√°vel na nuvem</a></li>
<li><a href="../pt413471/index.html">Retrospectiva de sexta-feira Mini Toy Tomy</a></li>
<li><a href="../pt413473/index.html">Desenvolvimento de um interruptor Z-Wave de toque na bateria com bot√µes luminosos</a></li>
<li><a href="../pt413479/index.html">Escrevemos nosso protocolo sobre o UDP</a></li>
<li><a href="../pt413481/index.html">Exportar √°rvore de teste do JMeter para texto</a></li>
<li><a href="../pt413485/index.html">Lan√ßamento do GitLab 10.8: espelhamento de push de c√≥digo aberto e implanta√ß√£o incremental</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>