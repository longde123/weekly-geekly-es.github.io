<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134228602-6"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134228602-6');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>üë®üèæ‚Äçüéì üîí üéÅ Hypervisor Steroid: FreeBSD + ZFS + cbsd üîû ü§í üë®üèæ‚Äçüè´</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Dalam tutorial ini, saya ingin menjelaskan betapa mudah dan anggunnya menginstal FreeBSD di lingkungan server - pada perangkat sewaan atau di pusat da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <link href="https://fonts.googleapis.com/css?family=Quicksand&display=swap" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script>document.write('<script src="//pagea' + 'd2.googles' + 'yndication.com/pagea' + 'd/js/a' + 'dsby' + 'google.js"><\/script>')</script>
  <script>
        var superSpecialObject = {};
        superSpecialObject['google_a' + 'd_client'] = 'ca-p' + 'ub-6974184241884155';
        superSpecialObject['enable_page_level_a' + 'ds'] = true;
       (window['a' + 'dsbygoogle'] = window['a' + 'dsbygoogle'] || []).push(superSpecialObject);
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly-es.github.io/index.html"></a>
    <div class="page-header-text">Geekly articles weekly</div>
  </header>
  <section class="page js-page"><h1>Hypervisor Steroid: FreeBSD + ZFS + cbsd</h1><div class="post__body post__body_full"><div class="post__text post__text-html" id="post-content-body" data-io-article-url="https://habr.com/ru/post/479192/"><p>  Dalam tutorial ini, saya ingin menjelaskan betapa mudah dan anggunnya menginstal FreeBSD di lingkungan server - pada perangkat sewaan atau di pusat data Anda sendiri, secara manual atau menggunakan alat orkestrasi seperti Ansible.  Enkripsi disk, manajemen ruang yang nyaman, hypervisor untuk wadah dan VM penuh, firewall yang praktis dan intuitif - ini semua dan tidak hanya tersedia di luar kotak dan membutuhkan sedikit waktu untuk mengonfigurasi dengan pendekatan yang tepat. </p><a name="habracut"></a><br><h4 id="ustanovka">  Instalasi </h4><br><p>  Mari kita mulai dengan skenario paling sederhana.  Kami memiliki sepotong besi atau ada di suatu tempat di luar sana, tetapi kami dapat memberi makan .iso (atau .img) pada CD-ROM atau menggunakan IPMI.  Atau bahkan lebih sederhana - hoster menawarkan gambar mfsbsd langsung dari antarmuka.  Bagaimanapun, boot dari <a href="https://mfsbsd.vx.sk/" rel="nofollow">mfsbsd</a> . </p><br><h4 id="linux-rescue-cd">  CD penyelamatan Linux </h4><br><p>  Kebetulan bahwa hoster tidak memberikan FreeBSD dalam bentuk apa pun, tetapi ia melakukan Linux Rescue.  Kita boot ke Linux, unduh image disk mfsbsd dan putar ke hard: </p><br><p><code>root@rescue:~# wget https://mfsbsd.vx.sk/files/images/12/amd64/mfsbsd-12.1-RELEASE-amd64.img</code> </p> <br><pre> <code class="plaintext hljs">root@rescue:~# dd if=mfsbsd-12.1-RELEASE-amd64.img of=/dev/sda bs=4M 22+1 records in 22+1 records out 92307456 bytes (92 MB) copied, 0.386325 s, 239 MB/s</code> </pre> <br><p> <code>root@rescue:~# reboot</code> </p> <br><h4 id="nastroyka-setevogo-adaptera">  Pengaturan adaptor jaringan </h4><br><p>  Semuanya baik ketika kita memiliki akses langsung ke monitor atau menerima sinyal melalui jaringan melalui IPMI / VNC / web.  Tetapi bagaimana jika tidak ada kemungkinan seperti itu dan hanya koneksi jaringan yang mungkin?  Untuk melakukan ini, kita memerlukan gambar mfsbsd dengan pengaturan jaringan yang sudah ditetapkan.  Mari kita kumpulkan gambar individual kita dengan pengaturan untuk adapter jaringan dan daemon SSH.  Untuk melakukan ini, kita memerlukan semacam host FreeBSD untuk membangun gambar. </p><br><p>  Unduh .iso yang asli </p><br><p> <code>root@ns312777:~ # fetch https://download.freebsd.org/ftp/releases/amd64/amd64/ISO-IMAGES/12.0/FreeBSD-12.0-RELEASE-amd64-dvd1.iso</code> </p> <br><p>  Mountim </p><br><p>  <code>root@ns312777:~ # mount -t cd9660 /dev/</code> mdconfig -f FreeBSD-12.0-RELEASE-amd64-dvd1.iso <code>/root/cd-rom</code> </p><br><p>  Unduh mfsbsd </p><br><p> <code>root@ns312777:~ # fetch https://github.com/mmatuska/mfsbsd/archive/master.zip</code> </p> <br><p> <code>root@ns312777:~ # unzip master.zip &amp;&amp; cd mfsbsd-master</code> </p> <br><p>  Kami mengubah file konfigurasi.  Untuk konfigurasi IP, cukup ubah untuk membuat <code>conf/rc.conf</code> dari <code>conf/rc.conf.sample</code> .  Anda juga harus membuat <code>conf/authorized_keys</code> dan menambahkan kunci Anda. </p><br><p> <code>root@ns312777:~/mfsbsd-master # ls -la conf/</code> </p> <br><pre> <code class="plaintext hljs">total 55 drwxr-xr-x 2 root wheel 13 Dec 8 10:06 . drwxr-xr-x 7 root wheel 13 Dec 8 10:11 .. -rw-r--r-- 1 root wheel 451 Dec 8 10:06 authorized_keys -rw-r--r-- 1 root wheel 50 Nov 30 22:54 authorized_keys.sample -rw-r--r-- 1 root wheel 3 Nov 30 22:54 boot.config.sample -rw-r--r-- 1 root wheel 156 Nov 30 22:54 hosts.sample -rw-r--r-- 1 root wheel 592 Nov 30 22:54 interfaces.conf.sample -rw-r--r-- 1 root wheel 1310 Nov 30 22:54 loader.conf.sample -rw-r--r-- 1 root wheel 739 Dec 8 10:06 rc.conf -rw-r--r-- 1 root wheel 689 Nov 30 22:54 rc.conf.sample -rw-r--r-- 1 root wheel 40 Nov 30 22:54 rc.local.sample -rw-r--r-- 1 root wheel 108 Nov 30 22:54 resolv.conf.sample -rw-r--r-- 1 root wheel 898 Nov 30 22:54 ttys.sample</code> </pre> <br><p>  Ayo pergi! </p><br><p> <code>root@ns312777:~/mfsbsd-master # make BASE=/root/cd-rom/usr/freebsd-dist</code> </p> <br><pre> <code class="plaintext hljs">Extracting base and kernel ... done Removing selected files from distribution ... done Installing configuration scripts and files ... done Generating SSH host keys ... done Configuring boot environment ...x ./ x ./linker.hints x ./kernel done Installing pkgng ... done Compressing usr ... done Creating and compressing mfsroot ... done Creating image file ...87072+0 records in 87072+0 records out 89161728 bytes transferred in 0.905906 secs (98422727 bytes/sec) 87040+0 records in 87040+0 records out 89128960 bytes transferred in 0.877165 secs (101610229 bytes/sec) md3 created md3p1 added partcode written to md3p1 bootcode written to md3 md3p2 added Calculated size of `./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j': 80281600 bytes, 65 inodes Extent size set to 32768 ./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j: 76.6MB (156800 sectors) block size 32768, fragment size 4096 using 1 cylinder groups of 76.56MB, 2450 blks, 256 inodes. super-block backups (for fsck -b #) at: 64, Populating `./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j' Image `./mfsbsd-12.0-RELEASE-p10-amd64.img.a47DUe1j' complete 612+1 records in 612+1 records out 80281600 bytes transferred in 36.018812 secs (2228880 bytes/sec) done</code> </pre><br><h4 id="pochemu-mfsbsd">  Kenapa mfsbsd? </h4><br><p>  Ini adalah rakitan kompak OS FreeBSD yang dimuat langsung ke memori, yang berarti kita dapat dengan bebas melakukan apa yang kita inginkan dengan semua media yang tersedia.  Sesuatu seperti CD penyelamatan Linux.  Seluruh pesona dari majelis ini adalah memungkinkan Anda menginstal FreeBSD secara harfiah dalam satu perintah. </p><br><p>  Setelah Linux menyelamatkan CD atau boot dari .iso / .img kita masuk ke shell mfsbsd. </p><br><p> <code>root@mfsbsd:~ # cd bin/</code> </p> <br><p>  Kami membersihkan disk </p><br><pre> <code class="plaintext hljs">root@mfsbsd:~/bin # gpart destroy -F /dev/ada0 root@mfsbsd:~/bin # gpart destroy -F /dev/ada1</code> </pre> <br><p>  atau </p><br><p> <code>root@mfsbsd:~/bin # ./destroygeom -d /dev/ada0 -d /dev/ada1</code> </p> <br><pre> <code class="plaintext hljs">Destroying geom ada0: Deleting partition 1 ... done Deleting partition 2 ... done Destroying geom ada1: Deleting partition 1 ... done Deleting partition 2 ... done</code> </pre> <br><p>  kemudian instal sistem kami. </p><br><pre> <code class="plaintext hljs">root@mfsbsd:~/bin # ./zfsinstall Usage: ./zfsinstall [-h] -d geom_provider [-d geom_provider ...] [ -u dist_url ] [-r mirror|raidz] [-m mount_point] [-p zfs_pool_name] [-s swap_partition_size] [-z zfs_partition_size] [-c] [-C] [-l] [-4] [-A]</code> </pre> <br><p>  karena  pada host dengan hingga 3 disk, saya lebih suka meletakkan sistem di mirror pada semua disk di partisi kecil.  Berkat ZFS, ruang yang tersisa dapat dikonfigurasikan sesuka Anda, tetapi lebih dari itu nanti.  Di sini dia adalah satu-satunya tim yang menginstal seluruh sistem. </p><br><p> <code>root@mfsbsd:~/bin # ./zfsinstall -d /dev/ada0 -d /dev/ada1 -d /dev/ada2 -r mirror -p zsys -z 25G</code> </p> <br><p>  untuk menginstal sistem pada tiga disk di mirror </p><br><pre> <code class="plaintext hljs">Fetching base files from: ftp://ftp.freebsd.org/pub/FreeBSD/releases/amd64/12.0-RELEASE /tmp/base.txz 147 MB 3670 kBps 41s /tmp/kernel.txz 39 MB 2344 kBps 18s Creating GUID partitions on ada0 ... done Configuring ZFS bootcode on ada0 ... done =&gt; 40 937703008 ada0 GPT (447G) 40 472 1 freebsd-boot (236K) 512 52428800 2 freebsd-zfs (25G) 52429312 885273736 - free - (422G) Creating GUID partitions on ada1 ... done Configuring ZFS bootcode on ada1 ... done =&gt; 40 937703008 ada1 GPT (447G) 40 472 1 freebsd-boot (236K) 512 52428800 2 freebsd-zfs (25G) 52429312 885273736 - free - (422G) Creating GUID partitions on ada2 ... done Configuring ZFS bootcode on ada2 ... done =&gt; 40 937703008 ada2 GPT (447G) 40 472 1 freebsd-boot (236K) 512 52428800 2 freebsd-zfs (25G) 52429312 885273736 - free - (422G) Creating ZFS pool zsys on ada0p2 ada1p2 ada2p2 ... done Creating zsys root partition: ... done Creating zsys partitions: var tmp ... done Setting bootfs for zsys to zsys/root ... done NAME USED AVAIL REFER MOUNTPOINT zsys 712K 23.7G 88K none zsys/root 264K 23.7G 88K /mnt zsys/root/tmp 88K 23.7G 88K /mnt/tmp zsys/root/var 88K 23.7G 88K /mnt/var Extracting FreeBSD distribution ... done Writing /boot/loader.conf... done Writing /etc/fstab...Writing /etc/rc.conf... done Copying /boot/zfs/zpool.cache ... done Installation complete. The system will boot from ZFS with clean install on next reboot You may make adjustments to the installed system using chroot: chroot /mnt Some adjustments may require a mounted devfs: mount -t devfs devfs /mnt/dev WARNING - Don't export ZFS pool "zsys"!</code> </pre><br><p>  Setelah instalasi, sistem file OS yang diinstal tersedia di <code>/mnt/</code> , jadi kami membuat beberapa konfigurasi sebelum masuk ke reboot: </p><br><p>  Salin kunci yang sudah ditambahkan ke gambar mfsbsd ke sistem </p><br><p> <code>root@mfsbsd:~/bin # mkdir /mnt/root/.ssh &amp;&amp; cp /root/.ssh/authorized_keys /mnt/root/.ssh/</code> </p> <br><p>  Kami mengedit konfigurasi SSH (misalnya, mengubah porta dan <del>  izinkan login root </del>  ) </p><br><p> <code>root@mfsbsd:~/bin # ee /mnt/etc/ssh/sshd_config</code> </p> <br><p>  edit file sistem bootloader </p><br><p> <code>root@mfsbsd:~/bin # ee /mnt/etc/rc.conf</code> </p> <br><pre> <code class="plaintext hljs">zfs_enable="YES" sshd_enable="YES" hostname="hyper.bitbsd.org" # # You need a gateway defined for a working network setup defaultrouter="37.79.8.254" ifconfig_em0="inet 37.79.8.111 netmask 255.255.255.0"</code> </pre> <br><p>  <em>Perhatikan produsen mahir jaringan Anda, seperti</em>  <em>nama antarmuka tergantung padanya.</em>  <em>Dalam beberapa kasus, Anda dapat melakukan ini:</em> </p><br><p>  <code>ifconfig_DEFAULT="DHCP"</code> di <code>/etc/rc.conf</code> </p><br><p>  Kami mengekspos DNS </p><br><p> <code>root@mfsbsd:~/bin # ee /mnt/etc/resolv.conf</code> </p> <br><pre> <code class="plaintext hljs">nameserver 8.8.8.8</code> </pre> <br><p>  Nah, secara umum Anda bisa melakukannya </p><br><p> <code>root@mfsbsd:~ # chroot /mnt</code> </p> <br><p>  dan menambahkan pengguna dan umumnya melakukan segalanya dari lingkungan OS yang baru diinstal. </p><br><p>  Yah, kita teruskan </p><br><p> <code>root@mfsbsd:~ # reboot</code> </p> <br><h4 id="bolshe-krasnoglaziya">  Lebih banyak bermata merah </h4><br><p>  Sebelum melanjutkan dengan konfigurasi OS yang diinstal, saya ingin mencatat dua cara lagi untuk boot ke mfsbsd. </p><br><p>  Pemasang FreeBSD Standar: </p><br><p><img src="https://habrastorage.org/webt/kg/kc/em/kgkcemg0hh8naobvnrlk7sipfsg.png"></p><br><p>  Memilih CD Langsung </p><br><p>  Buat <a href="https://www.freebsd.org/doc/handbook/disks-virtual.html" rel="nofollow">disk memori</a> </p><br><pre> <code class="plaintext hljs"># mdconfig -a -t swap -s 2g -u 9 # newfs -U md9 # mount /dev/md9 /tmp # cd /tmp</code> </pre> <br><p>  Disk dalam memori tidak diperlukan untuk bekerja dengan file mfsbsd, apalagi, mfsbsd menggunakan <code>/tmp/</code> selama instalasi, jadi harus ada cukup ruang kosong di sana. </p><br><p> <code># fetch https://github.com/mmatuska/mfsbsd/archive/master.zip</code> </p> <br><p> <code># unzip master.zip &amp;&amp; cd mfsbsd-master/tools</code> </p> <br><p>  Nah, maka hal yang sama - <code>./destroygeom</code> dan <code>./zfsinstall</code> </p><br><p>  Instalasi dari citra Linux yang sudah diinstal: </p><br><p>  Jika penyedia server memberi Anda sudah menginstal Linux, maka kami juga dapat "menginstal" dengan cara kami sendiri dengan <a href="https://forums.freebsd.org/threads/tip-booting-mfsbsd-iso-file-from-grub2-depenguination.46480/" rel="nofollow">mengubah konfigurasi bootloader GRUB</a> .  Untuk melakukan ini, tambahkan baris berikut ke grub.cfg pada sistem saat ini: </p><br><pre> <code class="plaintext hljs">menuentry "mfsbsd-10.0-RELEASE-amd64.iso" { # Path to the iso set isofile=/boot/boot-isos/mfsbsd-12.0-RELEASE-amd64.iso # (hd0,1) here may need to be adjusted of course depending where the partition is loopback loop (hd0,1)$isofile kfreebsd (loop)/boot/kernel/kernel.gz -v # kfreebsd_loadenv (loop)/boot/device.hints # kfreebsd_module (loop)/boot/kernel/geom_uzip.ko kfreebsd_module (loop)/boot/kernel/ahci.ko kfreebsd_module (loop)/mfsroot.gz type=mfs_root set kFreeBSD.vfs.root.mountfrom="ufs:/dev/md0" set kFreeBSD.mfsbsd.autodhcp="YES" # Define a new root password # set kFreeBSD.mfsbsd.rootpw="foobar" # Alternatively define hashed root password # set kFreeBSD.mfsbsd.rootpwhash="" }</code> </pre> <br><p>  Nah, masukkan .iso sesuai di <code>/boot/boot-isos/</code> </p><br><p>  Saya tidak pernah melakukannya sendiri, jadi jika Anda menemukan kesalahan atau cacat pada konfigurasi, beri tahu saya. </p><br><p>  Mungkin bagaimana lagi saya bisa mengelak untuk menginstal FreeBSD, saya tidak tahu. </p><br><h4 id="konfiguraciya-sistemy">  Konfigurasi sistem </h4><br><p>  Yah, kita sudah menginstal semuanya, memuat ... Untuk memulai, kita perlu menginstal dan mengkonfigurasi jaringan - dalam kasus kami, <a href="https://www.freebsd.org/doc/handbook/firewalls-pf.html" rel="nofollow">pf</a> akan memainkan peran utama, saya suka solusi ini karena kesederhanaan dan kejelasannya.  Kita perlu mengkonfigurasi sistem file server - kita menggunakan <a href="https://www.freebsd.org/doc/en_US.ISO8859-1/books/handbook/zfs-quickstart.html" rel="nofollow">ZFS</a> karena ini adalah sistem file yang sangat fleksibel dan efisien.  Ketika jaringan dan FS dikonfigurasi, kami akan menginstal hypervisor.  Jika kita membutuhkan tingkat keamanan yang ditingkatkan, Anda dapat <a href="https://habr.com/ru/post/477124/">mengkonfigurasi utilitas tambahan</a> , saya akan menghilangkan deskripsi mereka dalam tutorial ini.  Sebagai demonstrasi fleksibilitas ZFS, saya akan menjelaskan konfigurasi dua server, satu dengan 2 disk dan satu dengan 3 disk.  Juga, jangan lupa untuk <a href="https://www.freebsd.org/doc/handbook/updating-upgrading-freebsdupdate.html" rel="nofollow">meningkatkan sistem</a> setelah instalasi, kadang-kadang ternyata hanya ada sesuatu yang kuno yang tersedia untuk instalasi. </p><br><p> <code>freebsd-update -r 12.1-RELEASE upgrade</code> </p> <br><p>  <em>Pada saat penulisan ini, 12.1 adalah versi terbaru</em> </p><br><p>  <em>Server disk ganda</em> </p><br><p>  Kami membuatnya dalam konfigurasi berikut: </p><br><pre> <code class="plaintext hljs">root@:~ # gpart show /dev/ada0 =&gt; 40 5860533088 ada0 GPT (2.7T) 40 472 1 freebsd-boot (236K) 512 8388608 2 freebsd-swap (4.0G) 8389120 167772160 3 freebsd-zfs (80G) 176161280 2097152000 4 freebsd-zfs (1.0T) 2273313280 3587219848 5 freebsd-zfs (1.7T) root@:~ # gpart show /dev/ada1 =&gt; 40 5860533088 ada1 GPT (2.7T) 40 472 1 freebsd-boot (236K) 512 8388608 2 freebsd-swap (4.0G) 8389120 167772160 3 freebsd-zfs (80G) 176161280 2097152000 4 freebsd-zfs (1.0T) 2273313280 3587219848 5 freebsd-zfs (1.7T)</code> </pre><br><pre> <code class="plaintext hljs">root@:~ # zpool status pool: appdata state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM appdata ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p4.eli ONLINE 0 0 0 ada1p4.eli ONLINE 0 0 0 errors: No known data errors pool: miscdata state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM miscdata ONLINE 0 0 0 ada0p5.eli ONLINE 0 0 0 ada1p5.eli ONLINE 0 0 0 errors: No known data errors pool: zsys state: ONLINE scan: none requested config: NAME STATE READ WRITE CKSUM zsys ONLINE 0 0 0 mirror-0 ONLINE 0 0 0 ada0p3 ONLINE 0 0 0 ada1p3 ONLINE 0 0 0 errors: No known data errors</code> </pre><br><p>  Apa artinya semua ini?  Kami memiliki sepotong besi dengan dua disk, kedua disk ini memiliki volume 3TB.  Kami akan meluncurkan beberapa aplikasi di server, beberapa di antaranya kritis kondisional, beberapa "untuk bermain-main", jadi tidak sayang kehilangan data.  Untuk konfigurasi ruang disk paling efisien.  Apa yang kita dapatkan sebagai akibat dari manipulasi singkat? </p><br><pre> <code class="plaintext hljs">root@:~ # zfs list NAME USED AVAIL REFER MOUNTPOINT appdata 75.5K 961G 23K /appdata miscdata 75.5K 3.21T 23K /miscdata zsys 2.02G 75.0G 88K none zsys/root 2.02G 75.0G 1.18G / zsys/root/tmp 88K 75.0G 88K /tmp zsys/root/var 862M 75.0G 862M /var</code> </pre><br><p>  Kumpulan appdata (cermin dari bagian /dev/ada0p4.eli dan /dev/ada1p4.eli) untuk data aplikasi penting, kumpulan miscdata ("stripe", yaitu, data di /dev/ada0p5.eli dan / dev / ada1p5.eli) untuk semua omong kosong.  Ada juga pool sistem dan swap, ini juga mirror dari partisi kedua disk. </p><br><p>  Total untuk aplikasi kami, kami memiliki 1TB ruang cermin dan 3,2TB untuk percobaan. </p><br><p>  Bagaimana cara mengaturnya?  Itu mudah.  Setelah instalasi awal, disk kami terlihat seperti ini: </p><br><pre> <code class="plaintext hljs">root@:~ # gpart show /dev/ada0 =&gt; 40 5860533088 ada0 GPT (2.7T) 40 472 1 freebsd-boot (236K) 512 8388608 2 freebsd-swap (4.0G) 8389120 167772160 3 freebsd-zfs (80G) 176161280 684371848 free (2.7T)</code> </pre> <br><p>  Kami menambahkan bagian ke disk, pada awalnya kami akan mirror </p><br><p> <code>root@:~ # gpart add -t freebsd-zfs -s 1000g /dev/ada0</code> </p> <br><p> <code>root@:~ # gpart add -t freebsd-zfs -s 1000g /dev/ada1</code> </p> <br><p>  dan kemudian semuanya </p><br><p> <code>root@:~ # gpart add -t freebsd-zfs /dev/ada0</code> </p> <br><p> <code>root@:~ # gpart add -t freebsd-zfs /dev/ada1</code> </p> <br><p>  kita sekarang memiliki partisi / dev / ada0p4, / dev / ada0p5, / dev / ada1p4, dan / dev / ada0p5.  Karena  kami tidak memiliki akses fisik ke server di hoster di DC, disarankan untuk mengenkripsi bagian dengan data kami. </p><br><p> <code>root@:~ # geli init /dev/ada0p4</code> </p> <br><p> <code>root@:~ # geli init /dev/ada0p5</code> </p> <br><p> <code>root@:~ # geli init /dev/ada1p4</code> </p> <br><p> <code>root@:~ # geli init /dev/ada1p5</code> </p> <br><p>  masukkan kata sandi enkripsi, lalu dekripsi bagian: </p><br><p> <code>root@:~ # geli attach /dev/ada0p4</code> </p> <br><p> <code>root@:~ # geli attach /dev/ada0p5</code> </p> <br><p> <code>root@:~ # geli attach /dev/ada1p4</code> </p> <br><p> <code>root@:~ # geli attach /dev/ada1p5</code> </p> <br><p>  sekarang kita memiliki bagian /dev/ada0p4.eli, /dev/ada0p5.eli, /dev/ada1p4.eli dan /dev/ada0p5.eli, kita dapat <a href="https://www.freebsd.org/doc/handbook/zfs-zpool.html" rel="nofollow">membangun kumpulan</a> dari bagian ini </p><br><p>  Anda dapat menulis ini: </p><br><pre> <code class="plaintext hljs">root@:~ # cat /root/attach_disks.sh #!/bin/sh geli attach /dev/ada0p4 geli attach /dev/ada0p5 geli attach /dev/ada1p4 geli attach /dev/ada1p5</code> </pre> <br><p> <code>root@:~ # zpool create appdata mirror /dev/ada0p4.eli /dev/ada1p4.eli</code> </p> <br><p>  dan untuk data tanpa mirroring </p><br><p> <code>root@:~ # zpool create miscdata /dev/ada0p5.eli /dev/ada1p5.eli</code> </p> <br><p>  Nah, server kami siap untuk berperang.  Kami memiliki kumpulan yang dapat kami kembangkan di masa mendatang dengan menambahkan ekstra.  drive.  Dan ada snapshot, cara menggunakannya saya akan menjelaskan sedikit lebih rendah. </p><br><p>  <em>Server dengan tiga drive</em> </p><br><p>  Di sini konfigurasi yang sedikit berbeda.  Kami memiliki perangkat keras dengan tiga SSD 450GB.  Server ini akan digunakan terutama untuk virtualisasi penuh, jadi kami membutuhkan ruang sebanyak mungkin, tetapi mungkin untuk terus bekerja setelah kehilangan salah satu disk.  Setelah instalasi awal, disk kami terlihat seperti ini: </p><br><p> <code>root@:~ # gpart show /dev/ada[0-9]</code> </p> <br><pre> <code class="plaintext hljs">=&gt; 40 937703008 ada0 GPT (447G) 40 472 1 freebsd-boot (236K) 512 52428800 2 freebsd-zfs (25G) 52429312 885273736 - free - (422G) =&gt; 40 937703008 ada1 GPT (447G) 40 472 1 freebsd-boot (236K) 512 52428800 2 freebsd-zfs (25G) 52429312 885273736 - free - (422G) =&gt; 40 937703008 ada2 GPT (447G) 40 472 1 freebsd-boot (236K) 512 52428800 2 freebsd-zfs (25G) 52429312 885273736 - free - (422G)</code> </pre><br><p>  Kami membuat partisi 420 GB (sampai akhir disk tidak kami buat, karena ketika mengganti disk, ukuran sebenarnya mungkin sedikit berbeda) </p><br><pre> <code class="plaintext hljs">root@hyper:~ # gpart add -t freebsd-zfs -s 420g /dev/ada0 ada0p3 added root@hyper:~ # gpart add -t freebsd-zfs -s 420g /dev/ada1 ada1p3 added root@hyper:~ # gpart add -t freebsd-zfs -s 420g /dev/ada2 ada2p3 added</code> </pre> <br><p>  Kami mengenkripsi </p><br><pre> <code class="plaintext hljs">root@hyper:~ # geli init /dev/ada0p3 Enter new passphrase: Reenter new passphrase: Metadata backup for provider /dev/ada0p3 can be found in /var/backups/ada0p3.eli and can be restored with the following command: # geli restore /var/backups/ada0p3.eli /dev/ada0p3 root@hyper:~ # geli init /dev/ada1p3 Enter new passphrase: Reenter new passphrase: Metadata backup for provider /dev/ada1p3 can be found in /var/backups/ada1p3.eli and can be restored with the following command: # geli restore /var/backups/ada1p3.eli /dev/ada1p3 root@hyper:~ # geli init /dev/ada2p3 Enter new passphrase: Reenter new passphrase: Metadata backup for provider /dev/ada2p3 can be found in /var/backups/ada2p3.eli and can be restored with the following command: # geli restore /var/backups/ada2p3.eli /dev/ada2p3</code> </pre> <br><p>  <em>Apakah cadangan Metadata?</em> </p><br><p>  Ini adalah file yang dengannya Anda dapat mereset kata sandi enkripsi ke yang kami masukkan.  Nah, ini kalau-kalau nanti saya berubah dan lupa.  Bagaimanapun, perlu diingat nuansa ini. </p><br><p>  Pasang disk dan buat pool </p><br><pre> <code class="plaintext hljs">root@hyper:~ # geli attach /dev/ada0p3 Enter passphrase: root@hyper:~ # geli attach /dev/ada1p3 Enter passphrase: root@hyper:~ # geli attach /dev/ada2p3 Enter passphrase: root@hyper:~ # zpool create safestore raidz1 /dev/ada0p3.eli /dev/ada1p3.eli /dev/ada2p3.eli</code> </pre> <br><p>  dan pada output kami mendapatkan kolam dengan 820 GB ruang disk </p><br><pre> <code class="plaintext hljs">root@hyper:~ # zfs list NAME USED AVAIL REFER MOUNTPOINT safestore 89.2K 810G 29.3K /safestore ...</code> </pre> <br><p>  Dimungkinkan untuk mengumpulkan kumpulan ZFS dan disk berbeda dari konfigurasi yang berbeda sesuka Anda.  Ini adalah jenis perancang penyimpanan yang dapat diperluas selamanya.  ZFS menciptakan lapisan abstraksi di atas perangkat yang memungkinkan Anda untuk mencapai konfigurasi yang sangat luar biasa. </p><br><p>  <strong>Instalasi dan konfigurasi hypervisor</strong> </p><br><p>  FreeBSD menawarkan dua solusi OS tamu di luar kotak - penjara dan bhyve.  Ada <a href="https://bsdstore.ru/" rel="nofollow">cbsd</a> , ini adalah pembungkus untuk FreeBSD Jails, bhyve dan XEN.  Dalam panduan ini, saya tidak akan menyentuh yang terakhir, karena  tidak pernah menggunakannya sendiri. </p><br><p>  Sel adalah klon dari sistem FreeBSD.  Alat yang sangat nyaman untuk mengisolasi proses.  Sistem host dapat meng-host sel dari versi apa pun di bawahnya.  Sel dapat ditransfer antar host, snapshot, dan putar kembali dengan cepat.  Sebaiknya gunakan klektki bila memungkinkan, sehingga secara optimal menggunakan sumber daya sistem tanpa menghabiskannya pada virtualisasi penuh. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/95c/817/901/95c8179015447a58c383f4a4a81a510d.gif" alt="gambar"></p><br><p>  bhyve, pada gilirannya, adalah hypervisor lengkap yang dapat digunakan untuk meningkatkan semua jenis Ubuntu dan buruh pelabuhan. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/ffd/cb6/219/ffdcb6219c701e2e114100d9601e9fea.gif" alt="gambar"></p><br><p> <code>root@:~ # pkg install cbsd</code> </p> <br><p>  Perlu dicatat bahwa pada saat penulisan, cbsd hanya menarik 11 dependensi ukuran 35 MB. </p><br><pre> <code class="plaintext hljs">New packages to be INSTALLED: cbsd: 12.1.2 sudo: 1.8.28 gettext-runtime: 0.20.1 indexinfo: 0.3.1 libssh2: 1.8.2,3 ca_root_nss: 3.47.1 rsync: 3.1.3_1 libiconv: 1.14_11 pkgconf: 1.6.3,1 libedit: 3.1.20190324,1 sqlite3: 3.29.0 readline: 8.0.0 Number of packages to be installed: 12 The process will require 33 MiB more space. 8 MiB to be downloaded. Proceed with this action? [y/N]: y</code> </pre><br><p>  buat bagian terpisah di kumpulan sel </p><br><p> <code>root@:~ # zfs create miscdata/jails</code> </p> <br><p>  inisialisasi cbsd </p><br><p> <code>root@:~ # env workdir="/miscdata/jails" /usr/local/cbsd/sudoexec/initenv</code> </p> <br><div class="spoiler">  <b class="spoiler_title">mnogabukaf</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">-------[CBSD v.12.1.2]------- This is install/upgrade scripts for CBSD. Don't forget to backup. ----------------------------- Do you want prepare or upgrade hier environment for CBSD now? [yes(1) or no(0)] 1 &gt;&gt;&gt; Installing or upgrading [Stage 1: account &amp; dir hier] * Check hier and permission... ./.rssh missing (created) ./.ssh missing (created) ./.ssh/sockets missing (created) ./basejail missing (created) ./etc missing (created) ./etc/defaults missing (created) ./export missing (created) ./ftmp missing (created) ./import missing (created) ./jails missing (created) ./jails-data missing (created) ./jails-fstab missing (created) ./jails-rcconf missing (created) ./jails-system missing (created) ./share missing (created) ./share/dialog missing (created) ./share/helpers missing (created) ./share/FreeBSD-jail-puppet-skel missing (created) ./share/FreeBSD-jail-skel missing (created) ./share/FreeBSD-jail-vnet-skel missing (created) ./share/emulators missing (created) ./src missing (created) ./tmp missing (created) ./var missing (created) ./var/cron missing (created) ./var/cron/tabs missing (created) ./var/db missing (created) ./var/log missing (created) ./var/mail missing (created) ./var/run missing (created) ./var/spool missing (created) * write directory id: jaildatadir * write directory id: jailsysdir * write directory id: jailrcconfdir * write directory id: dbdir [Stage 2: build tools] Shall i add cbsd user into /usr/local/etc/sudoers.d/cbsd_sudoers sudo file to obtain root privileges for the most cbsd commands? [yes(1) or no(0)] 1 [Stage 3: local settings] Shall i modify the /etc/rc.conf to sets cbsd_workdir="/miscdata/jails"?: [yes(1) or no(0)] 1 /etc/rc.conf: cbsd_workdir: -&gt; /miscdata/jails [Stage 4: update default skel resolv.conf] [Stage 5: refreshing inventory] nodename: CBSD Nodename for this host eg the hostname. Warning: this operation will recreate the ssh keys in /miscdata/jails/.ssh dir: hostname.org Empty inventory database created: /miscdata/jails/var/db/inv.hostname.org.sqlite nodeip: Node management IPv4 or IPv6 address (used for node interconnection), eg: 151.106.27.106 jnameserver: Jails default DNS name-server (for jails resolv.conf), eg: 9.9.9.9,149.112.112.112 8.8.8.8,8.8.4.4 nodeippool: Jail pool IP address range (networks for jails) Hint: use space as delimiter for multiple networks, eg: 10.0.0.0/16 151.106.27.106/24 192.168.0.0/24 nat_enable: Enable NAT for RFC1918 networks? [yes(1) or no(0)] 0 fbsdrepo: Use official FreeBSD repository? When no (0) the repository of CBSD is preferred (useful for stable=1) for fetching base/kernel? [yes(1) or no(0)] 1 zfsfeat: You are running on a ZFS-based system. Enable ZFS feature? [yes(1) or no(0)] 1 parallel: Parallel mode stop/start ? (0 - no parallel or positive value (in seconds) as timeout for next parallel sequence) eg: 5 0 stable: Use STABLE branch instead of RELEASE by default? Attention: only the CBSD repository has a binary base for STABLE branch ? (STABLE_X instead of RELEASE_X_Y branch for base/kernel will be used), eg: 0 (use release) 0 sqlreplica: Enable sqlite3 replication to remote nodes ? (0 - no replica, 1 - try to replicate all local events to remote nodes) eg: 1 0 statsd_bhyve_enable: Configure CBSD statsd services for collect RACCT bhyve statistics? ? (EXPERIMENTAL FEATURE)? eg: 0 0 statsd_jail_enable: Configure CBSD statsd services for collect RACCT jail statistics? ? (EXPERIMENTAL FEATURE)? eg: 0 0 statsd_hoster_enable: Configure CBSD statsd services for collect RACCT hoster statistics? ? (EXPERIMENTAL FEATURE)? eg: 0 0 [Stage 6: authentication keys] Generating public/private rsa key pair. Your identification has been saved in /miscdata/jails/.ssh/8a3574aa0ec0ad3056e7dcf0f48adb01.id_rsa. Your public key has been saved in /miscdata/jails/.ssh/8a3574aa0ec0ad3056e7dcf0f48adb01.id_rsa.pub. The key fingerprint is: SHA256:bZM/lo6lx40vE48MxZea1KQMKYIBq3HyPWQrF0xn980 root@hostname.org The key's randomart image is: +---[RSA 2048]----+ | ..ooo . . | | +.o....oo . | |oo = . ..+E+ . | | * + o . .* + | |. o = S =o + | | o . ..o+. | | +** | | *Oo | | o..+. | +----[SHA256]-----+ [Stage 7: modules] Installing module pkg.d cmd: pkg Installing module bsdconf.d cmd: tzsetup Installing module bsdconf.d cmd: ssh Installing module bsdconf.d cmd: ftp Installing module bsdconf.d cmd: adduser Installing module bsdconf.d cmd: passwd Installing module bsdconf.d cmd: service Installing module bsdconf.d cmd: sysrc Installing module bsdconf.d cmd: userlist Installing module bsdconf.d cmd: grouplist Installing module bsdconf.d cmd: adduser-tui Installing module bsdconf.d cmd: pw Installing module bsdconf.d cmd: cloudinit Installing module zfsinstall.d cmd: zfsinstall [Stage 9: cleanup] * Remove obsolete files... Configure RSYNC services for jail migration? [yes(1) or no(0)] 0 cbsdrsyncd_enable: -&gt; YES Do you want to enable RACCT feature for resource accounting? [yes(1) or no(0)] 0 Shall i modify the /etc/rc.conf to sets cbsdd_enable=YES ? [yes(1) or no(0)] 0 cbsdd_enable: -&gt; NO Shall i modify the /etc/rc.conf to sets rcshutdown_timeout="900"? [yes(1) or no(0)] 0 rcshutdown_timeout: 90 -&gt; 900 [Stage X: upgrading] * Insert default topology into vm_cpu_topology table * Insert small1 group into vmpackage table &gt;&gt;&gt; Done First CBSD initialization complete. Now your can run: service cbsdd start to run CBSD services. For change initenv settings in next time, use: cbsd initenv-tui Also don't forget to execute: cbsd initenv every time when you upgrade CBSD version. preseedinit: Would you like a config for "cbsd init" preseed to be printed? [yes(1) or no(0)] 0</code> </pre> </div></div><br><p>  Jalankan daemon cbsd.  Kami mulai sejak saat itu  kami tidak menambahkan cbsd ke autorun saat startup sistem, seperti  bagian dengan data OS tamu dienkripsi. </p><br><p> <code>root@:~ # service cbsdd onestart</code> </p> <br><p>  Ketika server melakukan booting, Anda perlu menghubungkannya melalui SSH (itulah sebabnya partisi sistem tidak dienkripsi sehingga sistem berhasil melakukan booting tanpa entri kata sandi VNC / IPMI) dan mendekripsi partisi disk kami dengan skrip <code>./root/attach_disks.sh</code> . </p><br><p>  Saat menginisialisasi cbsd, kami mengindikasikan bahwa 192.168.0.0/24 akan menjadi subnet untuk sel kami.  Saya berencana untuk menggunakan subnet yang sama untuk virtualisasi penuh.  Kami memutar beberapa sel pada host, tetapi sebelum itu kami membuat dinding api sehingga NAT untuk sel bekerja melalui host. </p><br><pre> <code class="plaintext hljs">root@:~ # sysrc pf_enable=YES pf_enable: NO -&gt; YES root@:~ # service pf start /etc/rc.d/pf: WARNING: /etc/pf.conf is not readable.</code> </pre> <br><p>  buat file aturan untuk firewall </p><br><p> <code>root@:~ # ee /etc/pf.conf</code> </p> <br><pre> <code class="plaintext hljs">IF_PUBLIC="igb0" IP_PUBLIC="XXXX" JAIL_IP_POOL="192.168.0.0/24" icmp_types="echoreq" set limit { states 100000, frags 20000, src-nodes 20000 } set skip on lo0 scrub in all #NAT for others nat pass on $IF_PUBLIC from $JAIL_IP_POOL to any -&gt; $IP_PUBLIC ## Jail HTTP/S port forward IP_JAIL="192.168.0.2" PORT_JAIL="{ 80, 443 }" rdr pass on $IF_PUBLIC proto tcp from any to $IP_PUBLIC port $PORT_JAIL -&gt; $IP_JAIL</code> </pre><br><p>  memuat aturan </p><br><pre> <code class="plaintext hljs">root@:~ # service pf start Enabling pf. root@:~ # pfctl -f /etc/pf.conf</code> </pre> <br><p>  Nah, sekarang kita buat sel </p><br><p> <code>root@:~ # cbsd jconstruct-tui</code> </p> <br><p><img src="https://habrastorage.org/webt/md/kz/9x/mdkz9xlo12s5ausfki4zzi3gxzq.png"></p><br><p>  Pilih unduhan dari repositori dasar untuk sel </p><br><p><img src="https://habrastorage.org/webt/1l/iy/om/1liyomcjdsmqvqjn1ged3oztnfo.png"></p><br><p>  dan beberapa sel lagi melalui <code>root@:~ # cbsd jconstruct-tui</code> </p><br><p>  lalu kita mulai sel </p><br><p> <code>root@:~ # cbsd jstart webapp</code> </p> <br><p>  dan di dalam kita sudah melakukan apa yang kita inginkan </p><br><p> <code>root@:~ # cbsd jlogin webapp</code> </p> <br><div class="spoiler">  <b class="spoiler_title">misalnya instal nginx</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">webapp:/root@[12:58] # pkg install nginx Updating FreeBSD repository catalogue... FreeBSD repository is up to date. All repositories are up to date. Updating database digests format: 100% The following 2 package(s) will be affected (of 0 checked): New packages to be INSTALLED: nginx: 1.16.1_4,2 pcre: 8.43_2 Number of packages to be installed: 2 The process will require 8 MiB more space. 2 MiB to be downloaded. Proceed with this action? [y/N]: y [webapp.host.org] [1/2] Fetching nginx-1.16.1_4,2.txz: 100% 442 KiB 452.8kB/s 00:01 [webapp.host.org] [2/2] Fetching pcre-8.43_2.txz: 100% 1 MiB 638.0kB/s 00:02 Checking integrity... done (0 conflicting) [webapp.host.org] [1/2] Installing pcre-8.43_2... [webapp.host.org] [1/2] Extracting pcre-8.43_2: 100% [webapp.host.org] [2/2] Installing nginx-1.16.1_4,2... ===&gt; Creating groups. Using existing group 'www'. ===&gt; Creating users Using existing user 'www'. [webapp.host.org] [2/2] Extracting nginx-1.16.1_4,2: 100% ===== Message from nginx-1.16.1_4,2: -- Recent version of the NGINX introduces dynamic modules support. In FreeBSD ports tree this feature was enabled by default with the DSO knob. Several vendor's and third-party modules have been converted to dynamic modules. Unset the DSO knob builds an NGINX without dynamic modules support. To load a module at runtime, include the new `load_module' directive in the main context, specifying the path to the shared object file for the module, enclosed in quotation marks. When you reload the configuration or restart NGINX, the module is loaded in. It is possible to specify a path relative to the source directory, or a full path, please see https://www.nginx.com/blog/dynamic-modules-nginx-1-9-11/ and http://nginx.org/en/docs/ngx_core_module.html#load_module for details. Default path for the NGINX dynamic modules is /usr/local/libexec/nginx. webapp:/root@[12:59] # sysrc nginx_enable=YES nginx_enable: -&gt; YES webapp:/root@[12:59] # service nginx start Performing sanity check on nginx configuration: nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful Starting nginx. webapp:/root@[DING!] # sockstat -l4 USER COMMAND PID FD PROTO LOCAL ADDRESS FOREIGN ADDRESS www nginx 27982 6 tcp4 192.168.0.2:80 *:* root nginx 27981 6 tcp4 192.168.0.2:80 *:* root sendmail 25361 4 tcp4 192.168.0.2:25 *:* webapp:/root@[13:00] #</code> </pre></div></div><br><p>  Inilah yang terlihat seperti kebun binatang sel: </p><br><pre> <code class="plaintext hljs">root@:~ # jls JID IP Address Hostname Path 1 192.168.0.1 tor.host.org /miscdata/jails/jails/tor 2 192.168.0.2 webapp.host.org /miscdata/jails/jails/webapp 3 192.168.0.3 bitcoind.host.org /miscdata/jails/jails/bitcoind 4 192.168.0.4 ethd.host.org /miscdata/jails/jails/ethd</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Di webapp, sel mendengarkan kami </font></font><code>nginx</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">, tetapi dapat diakses dari luar hanya dengan merekam</font></font><code>/etc/pf.conf</code> </p><br><p> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Virtualisasi penuh</font></font></strong> </p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Untuk virtualisasi penuh, Anda perlu menghubungkan tambahan. </font><font style="vertical-align: inherit;">modul kernel. </font><font style="vertical-align: inherit;">Ambil server kami dengan tiga drive</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The </font></font><code>/etc/rc.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">modus diaktifkan router dan mengkonfigurasi sel IP host dan subnet maya ok</font></font></p><br><pre> <code class="plaintext hljs">ifconfig_igb0_alias="inet 192.168.0.1 netmask 255.255.255.0" gateway_enable="YES"</code> </pre> <br><pre> <code class="plaintext hljs">root@hyper:~ # echo 'vmm_load="YES"' &gt;&gt; /boot/loader.conf root@hyper:~ # echo 'kld_list="vmm if_tap if_bridge nmdm"' &gt;&gt; /etc/rc.conf root@hyper:~ # reboot</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sekarang konfigurasikan firewall, dengan cara yang sama seperti host hanya untuk sel. </font></font></p><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">/etc/pf.conf</font></font></b> <div class="spoiler_text"><p> IF_PUBLIC="igb0" <br> IP_PUBLIC="YYYY" </p><br><p> JAIL_IP_POOL="192.168.0.0/24" </p><br><p> icmp_types="echoreq" </p><br><p> set limit { states 100000, frags 20000, src-nodes 20000 } <br> set skip on lo0 <br> scrub in all </p><br><h1 id="nat-for-others"> NAT for others </h1><br><p> nat pass on $IF_PUBLIC from $JAIL_IP_POOL to any -&gt; $IP_PUBLIC </p><br><h2 id="jail-https-port-forward"> Jail HTTP/S port forward </h2><br><p> IP_JAIL="192.168.0.2" <br> PORT_JAIL="{ 80, 443 }" <br> rdr pass on $IF_PUBLIC proto tcp from any to $IP_PUBLIC port $PORT_JAIL -&gt; $IP_JAIL </p></div></div><br><pre> <code class="plaintext hljs">root@hyper:~ # sysrc pf_enable=YES pf_enable: NO -&gt; YES root@hyper:~ # service pf start Enabling pf.</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Dachshund, sekarang buat mesin virtual </font></font></p><br><p> <code>root@hyper:~ # cbsd bconstruct-tui</code> </p> <br><p><img src="https://habrastorage.org/webt/ik/zb/_e/ikzb_einlgwc9i-tbfl560s03ww.png"></p><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">yah, ayo pergi</font></font></b> <div class="spoiler_text"><p> root@hyper:~ # cbsd bstart debian <br> init_systap: waiting for link: igb0 <br> Looks like /safestore/jails/vm/debian/dsk1.vhd is empty. <br> May be you want to boot from CD? <br> [yes(1) or no(0)] <br>  1 <br> Temporary boot device: cd <br> vm_iso_path: iso-debian-10.1.0-amd64-DVD-1.iso <br> No such media: /safestore/jails/src/iso/cbsd-iso-debian-10.1.0-amd64-DVD-1.iso in /safestore/jails/src/iso <br> Shall i download it from: <a href="https://ftp.acc.umu.se/debian-cd/current/amd64/iso-dvd/" rel="nofollow">https://ftp.acc.umu.se/debian-cd/current/amd64/iso-dvd/</a> <a href="http://debian-cd.repulsive.eu/10.1.0/amd64/iso-dvd/" rel="nofollow">http://debian-cd.repulsive.eu/10.1.0/amd64/iso-dvd/</a> <a href="https://gensho.ftp.acc.umu.se/debian-cd/current/amd64/iso-dvd/" rel="nofollow">https://gensho.ftp.acc.umu.se/debian-cd/current/amd64/iso-dvd/</a> <a href="http://cdimage.debian.org/cdimage/release/10.1.0/amd64/iso-dvd/" rel="nofollow">http://cdimage.debian.org/cdimage/release/10.1.0/amd64/iso-dvd/</a> <a href="http://debian.mirror.cambrium.nl/debian-cd/10.1.0/amd64/iso-dvd/" rel="nofollow">http://debian.mirror.cambrium.nl/debian-cd/10.1.0/amd64/iso-dvd/</a> <a href="http://mirror.overthewire.com.au/debian-cd/10.1.0/amd64/iso-dvd/" rel="nofollow">http://mirror.overthewire.com.au/debian-cd/10.1.0/amd64/iso-dvd/</a> <a href="http://ftp.crifo.org/debian-cd/10.1.0/amd64/iso-dvd/" rel="nofollow">http://ftp.crifo.org/debian-cd/10.1.0/amd64/iso-dvd/</a> <a href="http://debian.cse.msu.edu/debian-cd/10.1.0/amd64/iso-dvd/" rel="nofollow">http://debian.cse.msu.edu/debian-cd/10.1.0/amd64/iso-dvd/</a> ? <br> [yes(1) or no(0)] <br>  1 <br> Download to: /safestore/jails/src/iso/cbsd-iso-debian-10.1.0-amd64-DVD-1.iso <br> Scanning for fastest mirror‚Ä¶ <br> Mirror source: Bytes per 3sec: </p><br><ul><li> [ 1/14 ] <a href="http://cbsd.lifec0re.net/iso/" rel="nofollow">http://cbsd.lifec0re.net/iso/</a> : 8036352 </li></ul></div></div><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Maka kita perlu terhubung melalui VNC ke port host 5900, saya menggunakan penerusan port SSH untuk ini </font></font></p><br><p> <code>ssh hyperhost -L 5900:localhost:5900</code> </p> <br><p><img src="https://habrastorage.org/webt/aq/tr/ll/aqtrllbz9wryvpnsccxxlbiwbei.png"></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Instal sistem. </font><font style="vertical-align: inherit;">Alamat IP dapat dipilih seperti 192.168.0.100.</font></font></p><br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Tambahkan ke </font></font><code>/etc/pf.conf</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Penerusan SSH</font></font></p><br><pre> <code class="plaintext hljs">## VM SSH port forward IP_VM="192.168.0.100" PORT_VM="{ 22100 }" rdr pass on $IF_PUBLIC proto tcp from any to $IP_PUBLIC port $PORT_VM -&gt; $IP_VM port 22</code> </pre> <br><p><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Jadi kita bisa terhubung ke debian kita. </font><font style="vertical-align: inherit;">Tapi sebelum itu, kita akan melakukan satu hal.</font></font></p><br><pre> <code class="plaintext hljs">root@hyper:~ # zfs list NAME USED AVAIL REFER MOUNTPOINT safestore 5.89G 804G 29.3K /safestore safestore/jails 5.89G 804G 4.46G /safestore/jails safestore/jails/debian 920M 804G 208K /safestore/jails/vm/debian safestore/jails/debian/dsk1.vhd 919M 804G 919M - safestore/jails/linuxjail 329M 804G 329M /safestore/jails/jails-data/linuxjail-data safestore/jails/nginx 89.2M 804G 89.2M /safestore/jails/jails-data/nginx-data safestore/jails/tor 117M 804G 117M /safestore/jails/jails-data/tor-data zsystem 1.85G 21.9G 88K none zsystem/root 1.85G 21.9G 1.20G / zsystem/root/tmp 120K 21.9G 120K /tmp zsystem/root/var 662M 21.9G 662M /var</code> </pre><br><p> <code>root@hyper:~ # zfs snap safestore/jails/debian/dsk1.vhd@fresh</code> </p> <br><p>      .    . </p><br><h4 id="chaynaya-pauza---ansible">   ‚Äî Ansible </h4><br><p>          3,   1300 .         . </p><br><div class="spoiler"> <b class="spoiler_title">/etc/ansible/hosts</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">[hyper-debian-group] hyper-debian [hyper-group] hyper [hyper-group:vars] ansible_python_interpreter=/usr/local/bin/python3.7</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">~/.ssh/config</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">Host hyper Hostname YYYY User root Port 33696 Host hyper-debian Hostname YYYY User root Port 22100</code> </pre></div></div><br><div class="spoiler"> <b class="spoiler_title">~/deploy-docker.yml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- hosts: hyper-debian gather_facts: no tasks: - name: Install a list of misc packages apt: update_cache: yes pkg: - apt-transport-https - ca-certificates - curl - gnupg2 - software-properties-common - name: Add Docker repo shell: curl -fsSL https://download.docker.com/linux/debian/gpg | apt-key add - - name: Add Docker repo shell: apt-key fingerprint 0EBFCD88 - name: Do some linux repo magic shell: add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/debian $(lsb_release -cs) stable" - name: Install Docker CE suite &amp; composer apt: update_cache: yes pkg: - docker-ce - docker-ce-cli - containerd.io - docker-compose - name: Update all packages to the latest version apt: upgrade: dist</code> </pre> </div></div><br><div class="spoiler"> <b class="spoiler_title">~/rollback-debian.yml</b> <div class="spoiler_text"><pre> <code class="plaintext hljs">- hosts: hyper gather_facts: no tasks: - name: stop debian shell: cbsd bstop debian - name: list ZFS datasets shell: zfs list | grep debian register: zfslist - debug: var=zfslist.stdout_lines - name: rollback debian shell: zfs rollback safestore/jails/debian/dsk1.vhd@fresh - name: list ZFS datasets shell: zfs list | grep debian register: zfslist - debug: var=zfslist.stdout_lines - name: start debian shell: cbsd bstart debian</code> </pre> </div></div><br><p> <strong>     ,   TerraForm</strong> </p><br><p>        </p><br><pre> <code class="plaintext hljs">[user@localhost ~]$ ansible-playbook deploy-docker.yml PLAY [hyper-debian] ******************************************************************************************************* TASK [Install a list of misc packages] ********************************************************************************************* changed: [hyper-debian] TASK [Add Docker repo] ******************************************************************************************************** changed: [hyper-debian] TASK [Add Docker repo] ******************************************************************************************************** changed: [hyper-debian] TASK [Do some linux repo magic] ********************************************************************************************************changed: [hyper-debian] TASK [Install Docker CE suite &amp; composer] ********************************************************************************************************changed: [hyper-debian] TASK [Update all packages to the latest version] ********************************************************************************************************ok: [hyper-debian] PLAY RECAP ********************************************************************************************************hyper-debian : ok=6 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0</code> </pre><br><p>              ,    iRedMail. </p><br><pre> <code class="plaintext hljs">docker run --privileged -p 80:80 -p 443:443 \ -e "DOMAIN=example.com" -e "HOSTNAME=mail" \ -e "MYSQL_ROOT_PASSWORD=password" \ -e "SOGO_WORKERS=1" \ -e "TIMEZONE=Europe/Prague" \ -e "POSTMASTER_PASSWORD=password" \ -e "IREDAPD_PLUGINS=['reject_null_sender', 'reject_sender_login_mismatch', 'greylisting', 'throttle', 'amavisd_wblist', 'sql_alias_access_policy']" \ -v PATH/mysql:/var/lib/mysql \ -v PATH/vmail:/var/vmail \ -v PATH/clamav:/var/lib/clamav \ --name=iredmail lejmr/iredmail:mysql-latest</code> </pre> <br><p>       ?       -    Debian. </p><br><pre> <code class="plaintext hljs">[user@localhost ~]$ ansible-playbook rollback-debian.yml PLAY [hyper] ******************************************************************************************************** TASK [stop debian] ********************************************************************************************************changed: [hyper] TASK [list ZFS datasets] ********************************************************************************************************changed: [hyper] TASK [debug] ********************************************************************************************************ok: [hyper] =&gt; { "zfslist.stdout_lines": [ "safestore/jails/debian 2.65G 803G 206K /safestore/jails/vm/debian", "safestore/jails/debian/dsk1.vhd 2.65G 803G 2.34G -" ] } TASK [rollback debian] ********************************************************************************************************changed: [hyper] TASK [list ZFS datasets] ********************************************************************************************************changed: [hyper] TASK [debug] ********************************************************************************************************ok: [hyper] =&gt; { "zfslist.stdout_lines": [ "safestore/jails/debian 920M 804G 206K /safestore/jails/vm/debian", "safestore/jails/debian/dsk1.vhd 919M 804G 919M -" ] } TASK [start debian] ********************************************************************************************************changed: [hyper] PLAY RECAP ********************************************************************************************************hyper : ok=7 changed=5 unreachable=0 failed=0 skipped=0 rescued=0 ignored=0</code> </pre><br><p>            ,          . </p><br><p>       ,   ,    <a href="https://sochain.com/address/BTC/1baysxTdXkwZnBosDdL1veb2zWDo6DC5b" rel="nofollow">1baysxTdXkwZnBosDdL1veb2zWDo6DC5b</a> </p><br><p>   ! </p></div></div><p>Source: <a rel="nofollow" href="https://habr.com/ru/post/id479192/">https://habr.com/ru/post/id479192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../id479180/index.html">Pembuatan Perselisihan - bot pada .NET Core dengan penyebaran ke server VPS</a></li>
<li><a href="../id479182/index.html">Praktek mempersiapkan kata-kata asing dengan pengisi suara untuk menghafal dalam program Anki</a></li>
<li><a href="../id479184/index.html">Pemecahan masalah dengan pwnable.kr 26 - ascii_easy. Kami menangani gadget ROP dari awal sekali dan untuk semua</a></li>
<li><a href="../id479186/index.html">Pada struktur komputasi paralel atau argumen terhadap operator "Go"</a></li>
<li><a href="../id479188/index.html">Jumlah dari semua bilangan alami: 1 + 2 + 3 + 4 + .... Bagian 2</a></li>
<li><a href="../id479196/index.html">Kebanyakan superkomputer menjalankan Linux - diskusikan situasinya</a></li>
<li><a href="../id479200/index.html">Kompresi gambar fraktal</a></li>
<li><a href="../id479202/index.html">C ++ dan Metode Numerik: Perkiraan Integrasi Newton-Cotes</a></li>
<li><a href="../id479210/index.html">Apa yang akan terjadi pada pembelian di toko online asing mulai 1 Januari 2020</a></li>
<li><a href="../id479214/index.html">Pilihan acara gratis mendatang untuk pengembang di Moskow # 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter57283870 = new Ya.Metrika({
                  id:57283870,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/57283870" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134228602-6', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

<footer class="page-footer">
  <div class="page-footer-legal-info-container page-footer-element">
    <p>
      Weekly-Geekly ES | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
    </p>
  </div>
  <div class="page-footer-counters-container page-footer-element">
    <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=9uU9J9pq8z7k8xEBHYSfs6DenIBAHs3vLIHcPIJW9d0&co=3a3a3a&ct=ffffff'/></a>
  </div>
</footer>
  
</body>

</html>